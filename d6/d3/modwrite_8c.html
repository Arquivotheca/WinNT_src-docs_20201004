<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: modwrite.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>modwrite.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d7/d2/modwrite_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d7/struct__MMWORK__CONTEXT.html">_MMWORK_CONTEXT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/struct__MM__WRITE__CLUSTER.html">_MM_WRITE_CLUSTER</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a0">ONEMB_IN_PAGES</a>&nbsp;&nbsp;&nbsp;((1024 * 1024) / PAGE_SIZE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a1">MI_PAGEFILE_FULL_CHARGE</a>&nbsp;&nbsp;&nbsp;100</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a2">MINIMUM_PAGE_FILE_SIZE</a>&nbsp;&nbsp;&nbsp;((ULONG)(256*PAGE_SIZE))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a3">ROUND_UP</a>(VALUE, ROUND)</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d6/d3/modwrite_8c.html#a60">_MODIFIED_WRITER_OBJECT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a4">MODIFIED_WRITER_OBJECT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d6/d7/struct__MMWORK__CONTEXT.html">_MMWORK_CONTEXT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a5">MMWORK_CONTEXT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d6/d7/struct__MMWORK__CONTEXT.html">_MMWORK_CONTEXT</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a6">PMMWORK_CONTEXT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d0/struct__MM__WRITE__CLUSTER.html">_MM_WRITE_CLUSTER</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a7">MM_WRITE_CLUSTER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d0/struct__MM__WRITE__CLUSTER.html">_MM_WRITE_CLUSTER</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a8">PMM_WRITE_CLUSTER</a></td></tr>

<tr><td colspan=2><br><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a60">_MODIFIED_WRITER_OBJECT</a> { <a class="el" href="../../d6/d3/modwrite_8c.html#a60a26">NormalCase</a>, 
<a class="el" href="../../d6/d3/modwrite_8c.html#a60a27">MappedPagesNeedWriting</a>, 
<a class="el" href="../../d6/d3/modwrite_8c.html#a60a28">ModifiedWriterMaximumObject</a>
 }</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a29">MiCheckForCrashDump</a> (<a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> <a class="el" href="../../d1/d9/icmui_8def.html#a0">File</a>, IN ULONG FileNumber)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a30">MiCrashDumpWorker</a> (IN PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a31">MiClusterWritePages</a> (IN <a class="el" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1, IN PFN_NUMBER PageFrameIndex, IN <a class="el" href="../../d7/d0/struct__MM__WRITE__CLUSTER.html">PMM_WRITE_CLUSTER</a> WriteCluster, IN ULONG <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a32">MiExtendPagingFileMaximum</a> (IN ULONG PageFileNumber, IN PRTL_BITMAP NewBitmap)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a33">MiCheckPageFileMapping</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> <a class="el" href="../../d1/d9/icmui_8def.html#a0">File</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a34">MiInsertPageFileInList</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a35">MiGatherMappedPages</a> (IN <a class="el" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1, IN PFN_NUMBER PageFrameIndex)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a36">MiGatherPagefilePages</a> (IN <a class="el" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1, IN PFN_NUMBER PageFrameIndex)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a37">MiPageFileFull</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a38">MiCauseOverCommitPopup</a> (IN SIZE_T NumberOfPages, IN ULONG Extension)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a39">MiModifiedPageWriterWorker</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>SIZE_T&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a40">MiAttemptPageFileExtension</a> (IN ULONG PageFileNumber, IN SIZE_T ExtendSize, IN SIZE_T Maximum)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a41">MiCheckPageFilePath</a> (<a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a42">MiReleaseModifiedWriter</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a43">NtCreatePagingFile</a> (IN PUNICODE_STRING PageFileName, IN PLARGE_INTEGER MinimumSize, IN PLARGE_INTEGER MaximumSize, IN ULONG Priority OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a44">MmGetCrashDumpInformation</a> (IN PSYSTEM_CRASH_DUMP_INFORMATION CrashInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a45">MmGetCrashDumpStateInformation</a> (IN PSYSTEM_CRASH_STATE_INFORMATION CrashInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>SIZE_T&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a46">MiExtendPagingFiles</a> (IN <a class="el" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html">PMMPAGE_FILE_EXPANSION</a> PageExpand)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a47">MiContractPagingFiles</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a48">MiAttemptPageFileReduction</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a49">MiWriteComplete</a> (IN PVOID Context, IN PIO_STATUS_BLOCK IoStatus, IN ULONG Reserved)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a50">MiCancelWriteOfMappedPfn</a> (IN PFN_NUMBER PageToStop)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a51">MiModifiedPageWriter</a> (IN PVOID StartContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a52">MiModifiedPageWriterTimerDispatch</a> (IN <a class="el" href="../../d1/d6/struct__KDPC.html">PKDPC</a> Dpc, IN PVOID DeferredContext, IN PVOID SystemArgument1, IN PVOID SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a53">MiMappedPageWriter</a> (IN PVOID StartContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a54">MmDisableModifiedWriteOfSection</a> (IN <a class="el" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html">PSECTION_OBJECT_POINTERS</a> SectionObjectPointer)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a55">MmGetPageFileInformation</a> (OUT PVOID SystemInformation, IN ULONG SystemInformationLength, OUT PULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a56">MiPageFileFull</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a57">MiFlushAllPages</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a58">MiIssuePageExtendRequest</a> (IN <a class="el" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html">PMMPAGE_FILE_EXPANSION</a> PageExtend)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a59">MiIssuePageExtendRequestNoWait</a> (IN PFN_NUMBER SizeInPages)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a9">MmWriteAllModifiedPages</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a10">MiFirstPageFileCreatedAndReady</a> = FALSE</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d8/mi_8h.html#a480">PSECTION</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a11">MmCrashDumpSection</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a12">IoFileObjectType</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HANDLE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a13">PspInitialSystemProcessHandle</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a14">MmMappedPageWriterList</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a15">MmMappedPageWriterEvent</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a16">MmMappedFileIoComplete</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a17">MmSystemShutdown</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>SIZE_T&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a18">MmOverCommit2</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>SIZE_T&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a19">MmPageFileFullExtendPages</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a20">MmPageFileFullExtendCount</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>SIZE_T&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a21">MiPageFileFullCharge</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a22">MmPageFileFullPopupShown</a> = FALSE</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a23">MmModNoWriteInsert</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a24">MmSystemPageFileLocated</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PFN_NUMBER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/modwrite_8c.html#a25">MmMoreThanEnoughFreePages</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a1" doxytag="modwrite.c::MI_PAGEFILE_FULL_CHARGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MI_PAGEFILE_FULL_CHARGE&nbsp;&nbsp;&nbsp;100          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00102">102</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04709">MiPageFileFull()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="modwrite.c::MINIMUM_PAGE_FILE_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MINIMUM_PAGE_FILE_SIZE&nbsp;&nbsp;&nbsp;((ULONG)(256*PAGE_SIZE))          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00151">151</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00297">NtCreatePagingFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="modwrite.c::ONEMB_IN_PAGES" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ONEMB_IN_PAGES&nbsp;&nbsp;&nbsp;((1024 * 1024) / PAGE_SIZE)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00045">45</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l05023">MiIssuePageExtendRequestNoWait()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="modwrite.c::ROUND_UP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ROUND_UP          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VALUE,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ROUND&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>((ULONG)(((ULONG)VALUE + \
                               ((ULONG)ROUND - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>)) &amp; (~((ULONG)ROUND - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>))))
</div></pre>
<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04463">4463</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a7" doxytag="modwrite.c::MM_WRITE_CLUSTER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d7/d0/struct__MM__WRITE__CLUSTER.html">_MM_WRITE_CLUSTER</a>  <a class="el" href="../../d7/d0/struct__MM__WRITE__CLUSTER.html">MM_WRITE_CLUSTER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="modwrite.c::MMWORK_CONTEXT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d6/d7/struct__MMWORK__CONTEXT.html">_MMWORK_CONTEXT</a>  <a class="el" href="../../d6/d7/struct__MMWORK__CONTEXT.html">MMWORK_CONTEXT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="modwrite.c::MODIFIED_WRITER_OBJECT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d6/d3/modwrite_8c.html#a60">_MODIFIED_WRITER_OBJECT</a>  <a class="el" href="../../d6/d3/modwrite_8c.html#a4">MODIFIED_WRITER_OBJECT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="modwrite.c::PMM_WRITE_CLUSTER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d7/d0/struct__MM__WRITE__CLUSTER.html">_MM_WRITE_CLUSTER</a> * <a class="el" href="../../d7/d0/struct__MM__WRITE__CLUSTER.html">PMM_WRITE_CLUSTER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="modwrite.c::PMMWORK_CONTEXT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d6/d7/struct__MMWORK__CONTEXT.html">_MMWORK_CONTEXT</a> * <a class="el" href="../../d6/d7/struct__MMWORK__CONTEXT.html">PMMWORK_CONTEXT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01338">MiCrashDumpWorker()</a>.    </td>
  </tr>
</table>
<hr><h2>Enumeration Type Documentation</h2>
<a class="anchor" name="a60" doxytag="modwrite.c::_MODIFIED_WRITER_OBJECT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d6/d3/modwrite_8c.html#a60">_MODIFIED_WRITER_OBJECT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a60a26" doxytag="NormalCase" ></a>NormalCase</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a60a27" doxytag="MappedPagesNeedWriting" ></a>MappedPagesNeedWriting</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a60a28" doxytag="ModifiedWriterMaximumObject" ></a>ModifiedWriterMaximumObject</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00024">24</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
<pre class="fragment"><div>00024                                      {
00025     <a class="code" href="../../d6/d3/modwrite_8c.html#a60a26">NormalCase</a>,
00026     <a class="code" href="../../d6/d3/modwrite_8c.html#a60a27">MappedPagesNeedWriting</a>,
00027     <a class="code" href="../../d6/d3/modwrite_8c.html#a60a28">ModifiedWriterMaximumObject</a>
00028 } <a class="code" href="../../d6/d3/modwrite_8c.html#a4">MODIFIED_WRITER_OBJECT</a>;
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a40" doxytag="modwrite.c::MiAttemptPageFileExtension" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> SIZE_T MiAttemptPageFileExtension           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PageFileNumber</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>ExtendSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>Maximum</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01485">1485</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d8/icmui_8def-source.html#l00004">File</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02553">_MMPAGING_FILE::FreeSpace</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08683">IoQueryVolumeInformation()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09835">IoSetInformation()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02551">_MMPAGING_FILE::MaximumSize</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l01098">MiUpdateModifiedWriterMdls()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05128">MmMinimumFreeDiskSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05130">MmPageFileExtension</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05083">MmPagingFile</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l01508">RtlClearBits()</a>, <a class="el" href="../../d1/d0/largeic_8c-source.html#l00117">RtlExtendedIntegerMultiply()</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02550">_MMPAGING_FILE::Size</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01681">MiExtendPagingFiles()</a>.
<p>
<pre class="fragment"><div>01493                    :
01494 
01495     This routine attempts to extend <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified page <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> by
01496     ExtendSize.
01497 
01498 Arguments:
01499 
01500     PageFileNumber - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> number to attempt to extend.
01501 
01502     ExtendSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of pages to extend <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> by.
01503 
01504     Maximum - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> should be extended
01505               by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> maximum size possible, but not to exceed
01506               ExtendSize.
01507 
01508 Return Value:
01509 
01510     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>.  <a class="code" href="../../d6/d6/ttime_8c.html#a0">Zero</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> cannot
01511     be extended.
01512 
01513 --*/
01514 
01515 {
01516 
01517     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01518     FILE_FS_SIZE_INFORMATION FileInfo;
01519     FILE_END_OF_FILE_INFORMATION EndOfFileInformation;
01520     KIRQL OldIrql;
01521     ULONG AllocSize;
01522     PFN_NUMBER AdditionalAllocation;
01523     ULONG ReturnedLength;
01524     PFN_NUMBER PagesAvailable;
01525     SIZE_T SizeToExtend;
01526     LARGE_INTEGER BytesAvailable;
01527 
01528     <span class="comment">//</span>
01529     <span class="comment">// Check to see if this page file is at the maximum.</span>
01530     <span class="comment">//</span>
01531 
01532     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a> ==
01533                                     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o1">MaximumSize</a>) {
01534         <span class="keywordflow">return</span> 0;
01535     }
01536 
01537     <span class="comment">//</span>
01538     <span class="comment">// Find out how much free space is on this volume.</span>
01539     <span class="comment">//</span>
01540 
01541     status = <a class="code" href="../../d4/d6/iosubs_8c.html#a91">IoQueryVolumeInformation</a> ( MmPagingFile[PageFileNumber]-&gt;File,
01542                                         FileFsSizeInformation,
01543                                         <span class="keyword">sizeof</span>(FileInfo),
01544                                         &amp;FileInfo,
01545                                         &amp;ReturnedLength
01546                                       );
01547 
01548     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01549 
01550         <span class="comment">//</span>
01551         <span class="comment">// The volume query did not succeed - return 0 indicating</span>
01552         <span class="comment">// the paging file was not extended.</span>
01553         <span class="comment">//</span>
01554 
01555         <span class="keywordflow">return</span> 0;
01556     }
01557 
01558     <span class="comment">//</span>
01559     <span class="comment">// Always attempt to extend by at least megabyte.</span>
01560     <span class="comment">//</span>
01561 
01562     SizeToExtend = ExtendSize;
01563     <span class="keywordflow">if</span> (ExtendSize &lt; <a class="code" href="../../d4/d8/mi_8h.html#a732">MmPageFileExtension</a>) {
01564         SizeToExtend = <a class="code" href="../../d4/d8/mi_8h.html#a732">MmPageFileExtension</a>;
01565     }
01566 
01567     <span class="comment">//</span>
01568     <span class="comment">// Don't go over the maximum size for the paging file.</span>
01569     <span class="comment">//</span>
01570 
01571     <span class="keywordflow">if</span> ((SizeToExtend + <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a>) &gt;
01572                                        <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o1">MaximumSize</a>) {
01573         SizeToExtend = (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o1">MaximumSize</a> -
01574                                 <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a>);
01575     }
01576 
01577     <span class="keywordflow">if</span> ((Maximum == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp; (SizeToExtend &lt; ExtendSize)) {
01578 
01579         <span class="comment">//</span>
01580         <span class="comment">// Can't meet the requirement.</span>
01581         <span class="comment">//</span>
01582 
01583         <span class="keywordflow">return</span> 0;
01584     }
01585     <span class="comment">//</span>
01586     <span class="comment">// See if there is enough space on the volume for the extension.</span>
01587     <span class="comment">//</span>
01588 
01589     AllocSize = FileInfo.SectorsPerAllocationUnit * FileInfo.BytesPerSector;
01590 
01591     BytesAvailable = <a class="code" href="../../d0/d1/largeic_8c.html#a2">RtlExtendedIntegerMultiply</a> (
01592                         FileInfo.AvailableAllocationUnits,
01593                         AllocSize);
01594 
01595     <span class="keywordflow">if</span> ((UINT64)BytesAvailable.QuadPart &gt; (UINT64)<a class="code" href="../../d4/d8/mi_8h.html#a731">MmMinimumFreeDiskSpace</a>) {
01596 
01597         BytesAvailable.QuadPart = BytesAvailable.QuadPart -
01598                                     (LONGLONG)<a class="code" href="../../d4/d8/mi_8h.html#a731">MmMinimumFreeDiskSpace</a>;
01599 
01600         <span class="keywordflow">if</span> ((UINT64)BytesAvailable.QuadPart &gt; (UINT64)(SizeToExtend &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) {
01601             BytesAvailable.QuadPart = (LONGLONG)(SizeToExtend &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
01602         }
01603 
01604         PagesAvailable = (PFN_NUMBER)(BytesAvailable.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
01605 
01606         <span class="keywordflow">if</span> ((Maximum == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp; (PagesAvailable &lt; ExtendSize)) {
01607 
01608             <span class="comment">//</span>
01609             <span class="comment">// Can't satisfy this requirement.</span>
01610             <span class="comment">//</span>
01611 
01612             <span class="keywordflow">return</span> 0;
01613         }
01614 
01615     } <span class="keywordflow">else</span> {
01616 
01617         <span class="comment">//</span>
01618         <span class="comment">// Not enough space is available.</span>
01619         <span class="comment">//</span>
01620 
01621         <span class="keywordflow">return</span> 0;
01622     }
01623 
01624 <span class="preprocessor">#if defined (_WIN64) || defined (_X86PAE_)</span>
01625 <span class="preprocessor"></span>    EndOfFileInformation.EndOfFile.QuadPart =
01626               ((ULONG64)<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a> + PagesAvailable) * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01627 <span class="preprocessor">#else</span>
01628 <span class="preprocessor"></span>    EndOfFileInformation.EndOfFile.LowPart =
01629               (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a> + PagesAvailable) * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01630 
01631     <span class="comment">//</span>
01632     <span class="comment">// Set high part to zero as paging files are limited to 4GB.</span>
01633     <span class="comment">//</span>
01634 
01635     EndOfFileInformation.EndOfFile.HighPart = 0;
01636 <span class="preprocessor">#endif</span>
01637 <span class="preprocessor"></span>
01638     <span class="comment">//</span>
01639     <span class="comment">// Attempt to extend the file by setting the end-of-file position.</span>
01640     <span class="comment">//</span>
01641 
01642     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() &lt; DISPATCH_LEVEL);
01643     status = <a class="code" href="../../d4/d6/iosubs_8c.html#a106">IoSetInformation</a> (MmPagingFile[PageFileNumber]-&gt;File,
01644                                FileEndOfFileInformation,
01645                                <span class="keyword">sizeof</span>(FILE_END_OF_FILE_INFORMATION),
01646                                &amp;EndOfFileInformation
01647                               );
01648 
01649     <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
01650         KdPrint((<span class="stringliteral">"MM MODWRITE: page file extension failed %lx %lx\n"</span>,status));
01651         <span class="keywordflow">return</span> 0;
01652     }
01653 
01654     <span class="comment">//</span>
01655     <span class="comment">// Clear bits within the paging file bitmap to allow the extension</span>
01656     <span class="comment">// to take effect.</span>
01657     <span class="comment">//</span>
01658 
01659     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01660 
01661     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (RtlCheckBit (MmPagingFile[PageFileNumber]-&gt;Bitmap,
01662                          MmPagingFile[PageFileNumber]-&gt;Size) == 1);
01663 
01664     AdditionalAllocation = PagesAvailable;
01665 
01666     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a> (MmPagingFile[PageFileNumber]-&gt;Bitmap,
01667                   (ULONG)MmPagingFile[PageFileNumber]-&gt;Size,
01668                   (ULONG)AdditionalAllocation );
01669 
01670     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a> += AdditionalAllocation;
01671     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> += AdditionalAllocation;
01672 
01673     <a class="code" href="../../d4/d8/mi_8h.html#a890">MiUpdateModifiedWriterMdls</a> (PageFileNumber);
01674 
01675     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01676 
01677     <span class="keywordflow">return</span> AdditionalAllocation;
01678 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a48" doxytag="modwrite.c::MiAttemptPageFileReduction" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiAttemptPageFileReduction           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01940">1940</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02558">_MMPAGING_FILE::Entry</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d8/icmui_8def-source.html#l00004">File</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02553">_MMPAGING_FILE::FreeSpace</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09835">IoSetInformation()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02535">_MMMOD_WRITER_MDL_ENTRY::LastPageToWrite</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02552">_MMPAGING_FILE::MinimumSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04899">MmChargeCommitmentLock</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05132">MmMinimumPageFileReduction</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00056">MmNumberOfPagingFiles</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05083">MmPagingFile</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00041">MmTotalCommitLimit</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00040">MmTotalCommittedPages</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l02305">RtlAreBitsClear()</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l01508">RtlClearBits()</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l01634">RtlSetBits()</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02550">_MMPAGING_FILE::Size</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d6/d4/sectsup_8c-source.html#l00603">MiDereferenceSegmentThread()</a>.
<p>
<pre class="fragment"><div>01946                    :
01947 
01948     This routine attempts to reduce <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> paging files to
01949     their <a class="code" href="../../d0/d4/mrcf_8c.html#a3">minimum</a> levels.
01950 
01951     Note - Page <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> expansion and page <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> reduction are <span class="keyword">synchronized</span>
01952            because a single thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> responsible <span class="keywordflow">for</span> performing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01953            operation.  Hence, <span class="keywordflow">while</span> expansion <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> occurring, a reduction
01954            request will be queued to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread.
01955 
01956 Arguments:
01957 
01958     None.
01959 
01960 Return Value:
01961 
01962     None.
01963 
01964 --*/
01965 
01966 {
01967     BOOLEAN Reduce;
01968     KIRQL OldIrql;
01969     ULONG i;
01970     PFN_NUMBER StartReduction;
01971     PFN_NUMBER ReductionSize;
01972     PFN_NUMBER TryBit;
01973     PFN_NUMBER TryReduction;
01974     SIZE_T MaxReduce;
01975     FILE_ALLOCATION_INFORMATION FileAllocationInfo;
01976     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01977 
01978     Reduce = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01979 
01980     ExAcquireSpinLock (&amp;MmChargeCommitmentLock, &amp;OldIrql);
01981 
01982     <span class="comment">//</span>
01983     <span class="comment">// Make sure the commit limit is greater than the number of committed</span>
01984     <span class="comment">// pages by twice the minimum page file reduction.  Keep the</span>
01985     <span class="comment">// difference between the two at least minimum page file reduction.</span>
01986     <span class="comment">//</span>
01987 
01988     <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> + (2 * <a class="code" href="../../d4/d8/mi_8h.html#a733">MmMinimumPageFileReduction</a>)) &lt;
01989                                                      <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a>) {
01990 
01991         MaxReduce = <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> -
01992                         (<a class="code" href="../../d4/d8/mi_8h.html#a733">MmMinimumPageFileReduction</a> + <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a>);
01993         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)MaxReduce &gt;= 0);
01994 
01995         i = 0;
01996         <span class="keywordflow">do</span> {
01997 
01998             <span class="keywordflow">if</span> (MaxReduce &lt; <a class="code" href="../../d4/d8/mi_8h.html#a733">MmMinimumPageFileReduction</a>) {
01999 
02000                 <span class="comment">//</span>
02001                 <span class="comment">// Don't reduce any more paging files.</span>
02002                 <span class="comment">//</span>
02003 
02004                 <span class="keywordflow">break</span>;
02005             }
02006 
02007             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">MinimumSize</a> != <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a>) {
02008 
02009                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> &gt; <a class="code" href="../../d4/d8/mi_8h.html#a733">MmMinimumPageFileReduction</a>) {
02010 
02011                     <span class="comment">//</span>
02012                     <span class="comment">// Attempt to reduce this paging file.</span>
02013                     <span class="comment">//</span>
02014 
02015                     ExReleaseSpinLock (&amp;MmChargeCommitmentLock, OldIrql);
02016 
02017                     <span class="comment">//</span>
02018                     <span class="comment">// Lock the PFN database and check to see if ample pages</span>
02019                     <span class="comment">// are free at the end of the paging file.</span>
02020                     <span class="comment">//</span>
02021 
02022                     TryBit = <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a> - <a class="code" href="../../d4/d8/mi_8h.html#a733">MmMinimumPageFileReduction</a>;
02023                     TryReduction = <a class="code" href="../../d4/d8/mi_8h.html#a733">MmMinimumPageFileReduction</a>;
02024 
02025                     <span class="keywordflow">if</span> (TryBit &lt;= <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">MinimumSize</a>) {
02026                         TryBit = <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">MinimumSize</a>;
02027                         TryReduction = <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a> -
02028                                                    <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">MinimumSize</a>;
02029                     }
02030 
02031                     StartReduction = 0;
02032                     ReductionSize = 0;
02033 
02034                     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02035 
02036                     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02037 
02038                         <span class="comment">//</span>
02039                         <span class="comment">// Try to reduce.</span>
02040                         <span class="comment">//</span>
02041 
02042                         <span class="keywordflow">if</span> ((ReductionSize + TryReduction) &gt; MaxReduce) {
02043 
02044                             <span class="comment">//</span>
02045                             <span class="comment">// The reduction attempt would remove more</span>
02046                             <span class="comment">// than MaxReduce pages.</span>
02047                             <span class="comment">//</span>
02048 
02049                             <span class="keywordflow">break</span>;
02050                         }
02051 
02052                         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a40">RtlAreBitsClear</a> (MmPagingFile[i]-&gt;Bitmap,
02053                                              (ULONG)TryBit,
02054                                              (ULONG)TryReduction)) {
02055 
02056                             <span class="comment">//</span>
02057                             <span class="comment">// Can reduce it by TryReduction, see if it can</span>
02058                             <span class="comment">// be made smaller.</span>
02059                             <span class="comment">//</span>
02060 
02061                             StartReduction = TryBit;
02062                             ReductionSize += TryReduction;
02063 
02064                             <span class="keywordflow">if</span> (StartReduction == <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">MinimumSize</a>) {
02065                                 <span class="keywordflow">break</span>;
02066                             }
02067 
02068                             TryBit = StartReduction - <a class="code" href="../../d4/d8/mi_8h.html#a733">MmMinimumPageFileReduction</a>;
02069 
02070                             <span class="keywordflow">if</span> (TryBit &lt;= <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">MinimumSize</a>) {
02071                                 TryReduction -=
02072                                         <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">MinimumSize</a> - TryBit;
02073                                 TryBit = <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">MinimumSize</a>;
02074                             } <span class="keywordflow">else</span> {
02075                                 TryReduction = <a class="code" href="../../d4/d8/mi_8h.html#a733">MmMinimumPageFileReduction</a>;
02076                             }
02077                         } <span class="keywordflow">else</span> {
02078 
02079                             <span class="comment">//</span>
02080                             <span class="comment">// Reduction has failed.</span>
02081                             <span class="comment">//</span>
02082 
02083                             <span class="keywordflow">break</span>;
02084                         }
02085                     } <span class="comment">//end while</span>
02086 
02087                     <span class="comment">//</span>
02088                     <span class="comment">// Make sure there are no outstanding writes to</span>
02089                     <span class="comment">// pages within the start reduction range.</span>
02090                     <span class="comment">//</span>
02091 
02092                     <span class="keywordflow">if</span> (StartReduction != 0) {
02093 
02094                         <span class="comment">//</span>
02095                         <span class="comment">// There is an outstanding write past where the</span>
02096                         <span class="comment">// new end of the paging file should be.  This</span>
02097                         <span class="comment">// is a very rare condition, so just punt shrinking</span>
02098                         <span class="comment">// the file.</span>
02099                         <span class="comment">//</span>
02100 
02101                         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o8">Entry</a>[0]-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o6">LastPageToWrite</a> &gt;
02102                                                               StartReduction) ||
02103                             (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o8">Entry</a>[1]-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o6">LastPageToWrite</a> &gt;
02104                                                               StartReduction)) {
02105                             StartReduction = 0;
02106                         }
02107                     }
02108 
02109                     <span class="comment">//</span>
02110                     <span class="comment">// Are there any pages to remove?</span>
02111                     <span class="comment">//</span>
02112 
02113                     <span class="keywordflow">if</span> (StartReduction != 0) {
02114 
02115                         <span class="comment">//</span>
02116                         <span class="comment">// Reduce the paging file's size and free space.</span>
02117                         <span class="comment">//</span>
02118 
02119                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ReductionSize == (MmPagingFile[i]-&gt;Size - StartReduction));
02120 
02121                         <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a> = StartReduction;
02122                         <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> -= ReductionSize;
02123                         MaxReduce -= ReductionSize;
02124                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)MaxReduce &gt;= 0);
02125 
02126                         <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a34">RtlSetBits</a> (MmPagingFile[i]-&gt;Bitmap,
02127                                     (ULONG)StartReduction,
02128                                     (ULONG)ReductionSize );
02129 
02130                         <span class="comment">//</span>
02131                         <span class="comment">// Release the PFN lock now that the size info</span>
02132                         <span class="comment">// has been updated.</span>
02133                         <span class="comment">//</span>
02134 
02135                         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02136 
02137                         <span class="comment">//</span>
02138                         <span class="comment">// Change the commit limit to reflect the returned</span>
02139                         <span class="comment">// page file space.</span>
02140                         <span class="comment">//</span>
02141 
02142                         ExAcquireSpinLock (&amp;MmChargeCommitmentLock, &amp;OldIrql);
02143 
02144                         <span class="comment">//</span>
02145                         <span class="comment">// Now that the commit lock is again held, recheck</span>
02146                         <span class="comment">// the commit to ensure it is still safe to contract</span>
02147                         <span class="comment">// the paging files.</span>
02148                         <span class="comment">//</span>
02149 
02150                         <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> + (2 * <a class="code" href="../../d4/d8/mi_8h.html#a733">MmMinimumPageFileReduction</a>)) &gt;=
02151                                                                          <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a>) {
02152 
02153                             ExReleaseSpinLock (&amp;MmChargeCommitmentLock, OldIrql);
02154                             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02155 
02156                             <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a> = StartReduction + ReductionSize;
02157                             <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> += ReductionSize;
02158                             MaxReduce += ReductionSize;
02159                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)MaxReduce &gt;= 0);
02160     
02161                             <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a> (MmPagingFile[i]-&gt;Bitmap,
02162                                           (ULONG)StartReduction,
02163                                           (ULONG)ReductionSize );
02164 
02165                             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02166 
02167                             ExAcquireSpinLock (&amp;MmChargeCommitmentLock, &amp;OldIrql);
02168                             <span class="keywordflow">break</span>;
02169                         }
02170 
02171                         <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> -= ReductionSize;
02172 
02173                         ExReleaseSpinLock (&amp;MmChargeCommitmentLock, OldIrql);
02174 
02175 <span class="preprocessor">#if defined (_WIN64) || defined (_X86PAE_)</span>
02176 <span class="preprocessor"></span>                        FileAllocationInfo.AllocationSize.QuadPart =
02177                                                    ((ULONG64)StartReduction &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02178 
02179 <span class="preprocessor">#else</span>
02180 <span class="preprocessor"></span>                        FileAllocationInfo.AllocationSize.LowPart =
02181                                                    StartReduction * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02182 
02183                         <span class="comment">//</span>
02184                         <span class="comment">// Set high part to zero, paging files are</span>
02185                         <span class="comment">// limited to 4gb.</span>
02186                         <span class="comment">//</span>
02187 
02188                         FileAllocationInfo.AllocationSize.HighPart = 0;
02189 <span class="preprocessor">#endif</span>
02190 <span class="preprocessor"></span>
02191                         <span class="comment">//</span>
02192                         <span class="comment">// Reduce the allocated size of the paging file</span>
02193                         <span class="comment">// thereby actually freeing the space and</span>
02194                         <span class="comment">// setting a new end of file.</span>
02195                         <span class="comment">//</span>
02196 
02197 
02198                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() &lt; DISPATCH_LEVEL);
02199                         status = <a class="code" href="../../d4/d6/iosubs_8c.html#a106">IoSetInformation</a> (
02200                                         MmPagingFile[i]-&gt;File,
02201                                         FileAllocationInformation,
02202                                         <span class="keyword">sizeof</span>(FILE_ALLOCATION_INFORMATION),
02203                                         &amp;FileAllocationInfo
02204                                        );
02205 <span class="preprocessor">#if DBG</span>
02206 <span class="preprocessor"></span>
02207                         <span class="comment">//</span>
02208                         <span class="comment">// Ignore errors on truncating the paging file</span>
02209                         <span class="comment">// as we can always have less space in the bitmap</span>
02210                         <span class="comment">// than the pagefile holds.</span>
02211                         <span class="comment">//</span>
02212 
02213                         <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
02214                             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM: pagefile truncate status %lx\n"</span>,
02215                                     status);
02216                         }
02217 <span class="preprocessor">#endif</span>
02218 <span class="preprocessor"></span>                    } <span class="keywordflow">else</span> {
02219                         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02220                     }
02221 
02222                     ExAcquireSpinLock (&amp;MmChargeCommitmentLock, &amp;OldIrql);
02223                 }
02224             }
02225             i += 1;
02226         } <span class="keywordflow">while</span> (i &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>);
02227     }
02228 
02229     ExReleaseSpinLock (&amp;MmChargeCommitmentLock, OldIrql);
02230     <span class="keywordflow">return</span>;
02231 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a50" doxytag="modwrite.c::MiCancelWriteOfMappedPfn" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL MiCancelWriteOfMappedPfn           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PFN_NUMBER&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PageToStop</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02579">2579</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00420">_MDL::ByteCount</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02542">_MMMOD_WRITER_MDL_ENTRY::Mdl</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02234">MiWriteComplete()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00088">MmMappedPageWriterList</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">_MMMOD_WRITER_MDL_ENTRY::u</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/flushsec_8c-source.html#l01548">MmPurgeSection()</a>.
<p>
<pre class="fragment"><div>02585                    :
02586 
02587     This routine attempts to stop a pending mapped page writer write <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02588     specified PFN.  Note that <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> write can be stopped, any other pages
02589     that may be clustered with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> write are also stopped.
02590 
02591 Arguments:
02592 
02593     PageToStop - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> frame number that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller wants to stop.
02594 
02595 Return Value:
02596 
02597     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> write was stopped, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> not.
02598 
02599 Environment:
02600 
02601     Kernel mode, PFN lock held.  The PFN lock <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> released and reacquired <span class="keywordflow">if</span>
02602     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> write was stopped.
02603 
02604     N.B.  No other locks may be held as IRQL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> lowered to <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> here.
02605 
02606 --*/
02607 
02608 {
02609     ULONG i;
02610     ULONG PageCount;
02611     KIRQL OldIrql;
02612     PPFN_NUMBER Page;
02613     PLIST_ENTRY NextEntry;
02614     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList;
02615     <a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">PMMMOD_WRITER_MDL_ENTRY</a> ModWriterEntry;
02616 
02617     <span class="comment">//</span>
02618     <span class="comment">// Walk the MmMappedPageWriterList looking for an MDL which contains</span>
02619     <span class="comment">// the argument page.  If found, remove it and cancel the write.</span>
02620     <span class="comment">//</span>
02621 
02622     NextEntry = <a class="code" href="../../d6/d3/modwrite_8c.html#a14">MmMappedPageWriterList</a>.Flink;
02623     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d6/d3/modwrite_8c.html#a14">MmMappedPageWriterList</a>) {
02624 
02625         ModWriterEntry = CONTAINING_RECORD(NextEntry,
02626                                            <a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">MMMOD_WRITER_MDL_ENTRY</a>,
02627                                            Links);
02628 
02629         MemoryDescriptorList = &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>;
02630         PageCount = (MemoryDescriptorList-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02631         Page = (PPFN_NUMBER)(MemoryDescriptorList + 1);
02632 
02633         <span class="keywordflow">for</span> (i = 0; i &lt; PageCount; i += 1) {
02634             <span class="keywordflow">if</span> (*Page == PageToStop) {
02635                 RemoveEntryList (NextEntry);
02636                 <span class="keywordflow">goto</span> CancelWrite;
02637             }
02638             Page += 1;
02639         }
02640 
02641         NextEntry = NextEntry-&gt;Flink;
02642     }
02643 
02644     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02645     
02646 CancelWrite:
02647 
02648     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (APC_LEVEL);
02649 
02650     <span class="comment">//</span>
02651     <span class="comment">// File lock conflict to indicate an error has occurred,</span>
02652     <span class="comment">// but that future I/Os should be allowed.  Keep APCs disabled and</span>
02653     <span class="comment">// call the write completion routine.</span>
02654     <span class="comment">//</span>
02655 
02656     ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.IoStatus.Status = STATUS_FILE_LOCK_CONFLICT;
02657     ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.IoStatus.Information = 0;
02658 
02659     <a class="code" href="../../d6/d3/modwrite_8c.html#a49">MiWriteComplete</a> ((PVOID)ModWriterEntry,
02660                      &amp;ModWriterEntry-&gt;u.IoStatus,
02661                      0 );
02662 
02663     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02664 
02665     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02666 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="modwrite.c::MiCauseOverCommitPopup" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL MiCauseOverCommitPopup           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfPages</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Extension</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00191">MiChargeCommitment()</a>, and <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04709">MiPageFileFull()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="modwrite.c::MiCheckForCrashDump" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiCheckForCrashDump           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>File</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileNumber</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01095">1095</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02554">_MMPAGING_FILE::CurrentUsage</a>, <a class="el" href="../../d5/d8/ex_8h.html#a332a206">DelayedWorkQueue</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00705">_KPROCESS::DirectoryTableBase</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00033">_MMWORK_CONTEXT::Event</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01961">ExInitializeWorkItem</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00375">ExQueueWorkItem()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d8/icmui_8def-source.html#l00004">File</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02553">_MMPAGING_FILE::FreeSpace</a>, <a class="el" href="../../d2/d1/mm_8h.html#a347a183">HighPagePriority</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08509">IoPageRead()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l10957">IoSynchronousPageWrite()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00418">_MDL::MappedSystemVa</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00425">MDL_PAGES_LOCKED</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00416">_MDL::MdlFlags</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01428">MI_SET_PAGING_FILE_INFO</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02486">MI_WRITE_INVALID_PTE</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01338">MiCrashDumpWorker()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l04378">MiGetPageForHeader()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l04501">MiRemoveImageHeaderPage()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l04450">MiUpdateImageHeaderPage()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00083">MmCrashDumpSection</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05852">MmCreateMdl()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00024">MmDynamicMemoryMutex</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01833">MmGetSystemAddressForMdlSafe</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05083">MmPagingFile</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04872">MmPagingFileDebug</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00075">MmPfnDatabase</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00048">MmPhysicalMemoryBlock</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03124">MmUnmapLockedPages()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00039">_PHYSICAL_MEMORY_DESCRIPTOR::NumberOfRuns</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00575">PsActiveProcessHead</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00579">PsInitialSystemProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00582">PsLoadedModuleList</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l01634">RtlSetBits()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00031">_MMWORK_CONTEXT::Size</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02550">_MMPAGING_FILE::Size</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d4/d9/ke_8h.html#a407a207">WrPageIn</a>, and <a class="el" href="../../d4/d9/ke_8h.html#a407a216">WrVirtualMemory</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00297">NtCreatePagingFile()</a>.
<p>
<pre class="fragment"><div>01102                    :
01103 
01104     This routine checks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first page of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to
01105     determine <span class="keywordflow">if</span> a crash dump exists.  If a crash dump <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> found
01106     a section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> created which maps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> crash dump.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> handle
01107     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> created via <a class="code" href="../../d6/d8/sysinfo_8c.html#a49">NtQuerySystemInformation</a> specifying
01108     SystemCrashDumpInformation.
01109 
01110 Arguments:
01111 
01112     <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
01113 
01114     FileNumber - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> index into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> array.
01115 
01116 Return Value:
01117 
01118     Returns STATUS_CRASH_DUMP <span class="keywordflow">if</span> a crash dump exists, success otherwise.
01119 
01120 --*/
01121 
01122 {
01123     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl;
01124     LARGE_INTEGER <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = {0,0};
01125     LARGE_INTEGER DumpSpaceUsed;
01126     PFN_NUMBER DumpSpaceUsedInPages;
01127     PULONG Block;
01128     IO_STATUS_BLOCK IoStatus;
01129     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01130     PFN_NUMBER j;
01131     PPFN_NUMBER Page;
01132     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> FinalStatus;
01133     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01134     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn;
01135     PFN_NUMBER MdlHack[(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>)/<span class="keyword">sizeof</span>(PFN_NUMBER)) + 1];
01136     <a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">WORK_QUEUE_ITEM</a> WorkItem;
01137     <a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html">MMWORK_CONTEXT</a> Context;
01138 
01139     FinalStatus = STATUS_SUCCESS;
01140 
01141     Mdl = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)&amp;MdlHack[0];
01142     <a class="code" href="../../d5/d6/iosup_8c.html#a73">MmCreateMdl</a>( Mdl, NULL, PAGE_SIZE);
01143     Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a13">MDL_PAGES_LOCKED</a>;
01144 
01145     Page = (PPFN_NUMBER)(Mdl + 1);
01146     *Page = <a class="code" href="../../d4/d8/mi_8h.html#a809">MiGetPageForHeader</a> ();
01147     Block = <a class="code" href="../../d2/d1/mm_8h.html#a25">MmGetSystemAddressForMdlSafe</a> (Mdl, HighPagePriority);
01148 
01149     <span class="keywordflow">if</span> (Block == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01150         <a class="code" href="../../d4/d8/mi_8h.html#a810">MiRemoveImageHeaderPage</a>(*Page);
01151         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01152     }
01153 
01154     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;Context.<a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html#o2">Event</a>, NotificationEvent, FALSE);
01155 
01156     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a89">IoPageRead</a> (File,
01157                          Mdl,
01158                          &amp;Offset,
01159                          &amp;Context.<a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html#o2">Event</a>,
01160                          &amp;IoStatus);
01161 
01162     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
01163         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;Context.<a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html#o2">Event</a>,
01164                                WrPageIn,
01165                                KernelMode,
01166                                FALSE,
01167                                (PLARGE_INTEGER)NULL);
01168     }
01169 
01170     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;Context.<a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html#o2">Event</a>);
01171 
01172     DumpSpaceUsed.LowPart = Block[DH_REQUIRED_DUMP_SPACE];
01173     DumpSpaceUsed.HighPart = Block[DH_REQUIRED_DUMP_SPACE + 1];
01174 
01175     DumpSpaceUsedInPages = (PFN_NUMBER)(DumpSpaceUsed.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
01176 
01177     <span class="keywordflow">if</span> ((Block[0] == 'EGAP') &amp;&amp;
01178         (Block[1] == 'PMUD') &amp;&amp;
01179         (DumpSpaceUsedInPages &lt;= <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[FileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a>)) {
01180 
01181         <span class="comment">//</span>
01182         <span class="comment">// A crash dump already exists, don't let pager use</span>
01183         <span class="comment">// it and build named section for it.</span>
01184         <span class="comment">//</span>
01185 
01186         Context.<a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html#o0">Size</a>.QuadPart = DumpSpaceUsed.QuadPart;
01187 
01188         <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>(&amp;WorkItem,
01189                              MiCrashDumpWorker,
01190                              (PVOID)&amp;Context);
01191 
01192         <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>( &amp;WorkItem, DelayedWorkQueue );
01193 
01194         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;Context.<a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html#o2">Event</a>,
01195                                WrPageIn,
01196                                KernelMode,
01197                                FALSE,
01198                                (PLARGE_INTEGER)NULL);
01199 
01200         <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;Context.<a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html#o2">Event</a>);
01201 
01202         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Context.<a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html#o1">Status</a>)) {
01203             <span class="keywordflow">goto</span> Failed;
01204         }
01205 
01206         <span class="comment">//</span>
01207         <span class="comment">// Make the section point to the paging file.</span>
01208         <span class="comment">//</span>
01209 
01210         PointerPte = <a class="code" href="../../d6/d3/modwrite_8c.html#a11">MmCrashDumpSection</a>-&gt;Segment-&gt;PrototypePte;
01211         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, <a class="code" href="../../d6/d3/modwrite_8c.html#a11">MmCrashDumpSection</a>-&gt;Segment-&gt;SegmentPteTemplate);
01212 
01213         Pfn = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (*Page);
01214 <span class="preprocessor">#if PFN_CONSISTENCY</span>
01215 <span class="preprocessor"></span>        MiSetModified (Pfn, 1);
01216 <span class="preprocessor">#else</span>
01217 <span class="preprocessor"></span>        Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 1;
01218 <span class="preprocessor">#endif</span>
01219 <span class="preprocessor"></span>
01220         PointerPte += 1;
01221 
01222         <span class="keywordflow">for</span> (j = 1; j &lt; DumpSpaceUsedInPages; j += 1) {
01223 
01224             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a143">MI_SET_PAGING_FILE_INFO</a> (*PointerPte,
01225                                      <a class="code" href="../../d6/d3/modwrite_8c.html#a11">MmCrashDumpSection</a>-&gt;Segment-&gt;SegmentPteTemplate,
01226                                      FileNumber,
01227                                      j);
01228 
01229 <span class="preprocessor">#if DBG</span>
01230 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((j &lt; 8192) &amp;&amp; (FileNumber == 0)) {
01231                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MmPagingFileDebug[j] &amp; 1) == 0);
01232                 <a class="code" href="../../d4/d8/mi_8h.html#a686">MmPagingFileDebug</a>[j] = (((ULONG_PTR)PointerPte &lt;&lt; 3) | 1);
01233             }
01234 <span class="preprocessor">#endif //DBG</span>
01235 <span class="preprocessor"></span>            PointerPte += 1;
01236         }
01237 
01238         <span class="comment">//</span>
01239         <span class="comment">// Change the original PTE contents to refer to</span>
01240         <span class="comment">// the paging file offset where this was written.</span>
01241         <span class="comment">//</span>
01242 
01243         <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a34">RtlSetBits</a> (MmPagingFile[FileNumber]-&gt;Bitmap,
01244                     1,
01245                     (ULONG)DumpSpaceUsedInPages - 1);
01246 
01247         <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[FileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> -= DumpSpaceUsedInPages;
01248         <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[FileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o4">CurrentUsage</a> += DumpSpaceUsedInPages;
01249         FinalStatus = STATUS_CRASH_DUMP;
01250 
01251 Failed:
01252 
01253         <span class="comment">//</span>
01254         <span class="comment">// Indicate that no crash dump is in file so if system is</span>
01255         <span class="comment">// rebooted the page file is available.</span>
01256         <span class="comment">//</span>
01257 
01258         Block[1] = 'EGAP';
01259     } <span class="keywordflow">else</span> {
01260 
01261         <span class="comment">//</span>
01262         <span class="comment">// Set new pattern into file.</span>
01263         <span class="comment">//</span>
01264 
01265         RtlFillMemoryUlong (Block,
01266                             PAGE_SIZE,
01267                             'EGAP');
01268 
01269 <span class="preprocessor">#if !defined(_WIN64)</span>
01270 <span class="preprocessor"></span>
01271         <span class="comment">//</span>
01272         <span class="comment">// This bit of code does not work on Win64.  Worse, it generates</span>
01273         <span class="comment">// alignment faults.  So, until it (and the other components that</span>
01274         <span class="comment">// deal with crashdump blocks) is fixed, it is disabled for Win64.</span>
01275         <span class="comment">//</span>
01276 
01277         *(PULONG_PTR)(&amp;Block[4]) = <a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o2">DirectoryTableBase</a>[0];
01278         *(PULONG *)(&amp;Block[5]) = (PULONG)<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>;
01279         *(PLIST_ENTRY *)(&amp;Block[6]) = (PLIST_ENTRY)&amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>;
01280         *(PLIST_ENTRY *)(&amp;Block[7]) = (PLIST_ENTRY)&amp;<a class="code" href="../../d1/d9/ps_8h.html#a49">PsActiveProcessHead</a>;
01281 <span class="preprocessor">#endif</span>
01282 <span class="preprocessor"></span>        Block[8] =
01283 <span class="preprocessor">#ifdef _X86_</span>
01284 <span class="preprocessor"></span>                    IMAGE_FILE_MACHINE_I386;
01285 <span class="preprocessor">#endif //_X86_</span>
01286 <span class="preprocessor"></span>
01287 <span class="preprocessor">#ifdef _ALPHA_</span>
01288 <span class="preprocessor"></span>                    IMAGE_FILE_MACHINE_ALPHA;
01289 <span class="preprocessor">#endif //_ALPHA_</span>
01290 <span class="preprocessor"></span>
01291 <span class="preprocessor">#ifdef _IA64_</span>
01292 <span class="preprocessor"></span>                    IMAGE_FILE_MACHINE_IA64;
01293 <span class="preprocessor">#endif //_IA64_</span>
01294 <span class="preprocessor"></span>
01295         ExAcquireFastMutex (&amp;MmDynamicMemoryMutex);
01296 
01297         RtlCopyMemory (&amp;Block[DH_PHYSICAL_MEMORY_BLOCK],
01298                        MmPhysicalMemoryBlock,
01299                        (<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PHYSICAL_MEMORY_DESCRIPTOR</a>) +
01300                         (<span class="keyword">sizeof</span>(<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PHYSICAL_MEMORY_RUN</a>) *
01301                         (<a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> - 1))));
01302 
01303         ExReleaseFastMutex (&amp;MmDynamicMemoryMutex);
01304     }
01305 
01306     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a116">IoSynchronousPageWrite</a> (
01307                            File,
01308                            Mdl,
01309                            &amp;Offset,
01310                            &amp;Context.<a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html#o2">Event</a>,
01311                            &amp;IoStatus );
01312 
01313     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;Context.<a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html#o2">Event</a>,
01314                            WrVirtualMemory,
01315                            KernelMode,
01316                            FALSE,
01317                            (PLARGE_INTEGER)NULL);
01318 
01319     <a class="code" href="../../d5/d6/iosup_8c.html#a56">MmUnmapLockedPages</a> (Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o4">MappedSystemVa</a>, Mdl);
01320     <span class="keywordflow">if</span> (FinalStatus == STATUS_CRASH_DUMP) {
01321 
01322         <span class="comment">//</span>
01323         <span class="comment">// Set the first page to point to the page that was just operated</span>
01324         <span class="comment">// upon.</span>
01325         <span class="comment">//</span>
01326 
01327         <a class="code" href="../../d4/d8/mi_8h.html#a808">MiUpdateImageHeaderPage</a> (<a class="code" href="../../d6/d3/modwrite_8c.html#a11">MmCrashDumpSection</a>-&gt;Segment-&gt;PrototypePte,
01328                                  *Page,
01329                                  <a class="code" href="../../d6/d3/modwrite_8c.html#a11">MmCrashDumpSection</a>-&gt;Segment-&gt;ControlArea);
01330     } <span class="keywordflow">else</span> {
01331         <a class="code" href="../../d4/d8/mi_8h.html#a810">MiRemoveImageHeaderPage</a>(*Page);
01332     }
01333     <span class="keywordflow">return</span> FinalStatus;
01334 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="modwrite.c::MiCheckPageFileMapping" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiCheckPageFileMapping           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>File</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04563">4563</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d2/d8/icmui_8def-source.html#l00004">File</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00297">NtCreatePagingFile()</a>.
<p>
<pre class="fragment"><div>04569                    :
04570 
04571     Non-pagable routine to check to see <span class="keywordflow">if</span> a given <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> has
04572     no sections and therefore <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> eligible to become a paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
04573 
04574 Arguments:
04575 
04576     <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.
04577 
04578 Return Value:
04579 
04580     Returns STATUS_SUCCESS <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> can be used as a paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
04581 
04582 --*/
04583 
04584 {
04585     KIRQL OldIrql;
04586 
04587     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
04588 
04589     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04590         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04591         <span class="keywordflow">return</span> STATUS_SUCCESS;
04592     }
04593 
04594     <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer-&gt;DataSectionObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
04595         (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer-&gt;ImageSectionObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
04596 
04597         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04598         <span class="keywordflow">return</span> STATUS_INCOMPATIBLE_FILE_MAP;
04599     }
04600     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04601     <span class="keywordflow">return</span> STATUS_SUCCESS;
04602 
04603 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="modwrite.c::MiCheckPageFilePath" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiCheckPageFilePath           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>FileObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00166">166</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d0/d5/io_8h.html#a603a418">DeviceUsageTypePaging</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00652">IoAllocateIrp()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08738">IoQueueThreadIrp()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00183">IRP_MN_DEVICE_USAGE_NOTIFICATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01552">IRP_SYNCHRONOUS_API</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o24">_IRP::Overlay</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01641">_IRP::RequestorMode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01189">_DEVICE_OBJECT::StackSize</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>, and <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00297">NtCreatePagingFile()</a>.
<p>
<pre class="fragment"><div>00169 {
00170     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00171     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00172     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00173     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
00174     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00175     IO_STATUS_BLOCK localIoStatus;
00176 
00177     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00178 
00179     <span class="comment">//</span>
00180     <span class="comment">// Reference the file object here so that no special checks need be made</span>
00181     <span class="comment">// in I/O completion to determine whether or not to dereference the file</span>
00182     <span class="comment">// object.</span>
00183     <span class="comment">//</span>
00184 
00185     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( FileObject );
00186 
00187     <span class="comment">//</span>
00188     <span class="comment">// Initialize the local event.</span>
00189     <span class="comment">//</span>
00190 
00191     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event, SynchronizationEvent, FALSE );
00192 
00193     <span class="comment">//</span>
00194     <span class="comment">// Get the address of the target device object.</span>
00195     <span class="comment">//</span>
00196 
00197     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject );
00198 
00199     <span class="comment">//</span>
00200     <span class="comment">// Allocate and initialize the I/O Request Packet (IRP) for this operation.</span>
00201     <span class="comment">//</span>
00202 
00203     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>( deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a>, FALSE );
00204     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( irp != NULL );
00205 
00206     <span class="keywordflow">if</span> (irp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00207 
00208         <span class="comment">//</span>
00209         <span class="comment">// Don't dereference the file object, our caller will take care of that.</span>
00210         <span class="comment">//</span>
00211 
00212         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00213     }
00214 
00215     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = FileObject;
00216     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00217     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>;
00218 
00219     <span class="comment">//</span>
00220     <span class="comment">// Fill in the service independent parameters in the IRP.</span>
00221     <span class="comment">//</span>
00222 
00223     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = &amp;event;
00224     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>;
00225     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = &amp;localIoStatus;
00226     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine = (PIO_APC_ROUTINE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00227 
00228     <span class="comment">//</span>
00229     <span class="comment">// Get a pointer to the stack location for the first driver.  This will be</span>
00230     <span class="comment">// used to pass the original function codes and parameters.</span>
00231     <span class="comment">//</span>
00232 
00233     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
00234     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
00235     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a86">IRP_MN_DEVICE_USAGE_NOTIFICATION</a>;
00236     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = FileObject;
00237     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = STATUS_NOT_SUPPORTED;
00238     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00239     <span class="comment">// irp-&gt;Flags = 0;</span>
00240 
00241     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.UsageNotification.InPath = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00242     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.UsageNotification.Type = <a class="code" href="../../d0/d5/io_8h.html#a603a418">DeviceUsageTypePaging</a>;
00243 
00244     <span class="comment">//</span>
00245     <span class="comment">// Insert the packet at the head of the IRP list for the thread.</span>
00246     <span class="comment">//</span>
00247 
00248     <a class="code" href="../../d4/d6/iosubs_8c.html#a92">IoQueueThreadIrp</a>( irp );
00249 
00250     <span class="comment">//</span>
00251     <span class="comment">// Now simply invoke the driver at its dispatch entry with the IRP.</span>
00252     <span class="comment">//</span>
00253 
00254     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( deviceObject, irp );
00255 
00256     <span class="comment">//</span>
00257     <span class="comment">// Wait for the local event and copy the final status information</span>
00258     <span class="comment">// back to the caller.</span>
00259     <span class="comment">//</span>
00260 
00261     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
00262         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
00263                                       Executive,
00264                                       KernelMode,
00265                                       FALSE,
00266                                       (PLARGE_INTEGER) NULL );
00267         status = localIoStatus.Status;
00268     }
00269 
00270     <span class="keywordflow">return</span> status;
00271 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="modwrite.c::MiClusterWritePages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiClusterWritePages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Pfn1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>PageFrameIndex</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d0/struct__MM__WRITE__CLUSTER.html">PMM_WRITE_CLUSTER</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WriteCluster</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Size</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l03701">MiGatherPagefilePages()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a47" doxytag="modwrite.c::MiContractPagingFiles" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiContractPagingFiles           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01864">1864</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l02211">_MMPAGE_FILE_EXPANSION::DereferenceList</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02553">_MMPAGING_FILE::FreeSpace</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02197">_MMDEREFERENCE_SEGMENT_HEADER::ListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02195">_MMDEREFERENCE_SEGMENT_HEADER::Lock</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02552">_MMPAGING_FILE::MinimumSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04899">MmChargeCommitmentLock</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04944">MmDereferenceSegmentHeader</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05132">MmMinimumPageFileReduction</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00056">MmNumberOfPagingFiles</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05083">MmPagingFile</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00041">MmTotalCommitLimit</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00040">MmTotalCommittedPages</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02212">_MMPAGE_FILE_EXPANSION::RequestedExpansionSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02210">_MMPAGE_FILE_EXPANSION::Segment</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02196">_MMDEREFERENCE_SEGMENT_HEADER::Semaphore</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02550">_MMPAGING_FILE::Size</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/procsup_8c-source.html#l01398">MmDeleteProcessAddressSpace()</a>.
<p>
<pre class="fragment"><div>01870                    :
01871 
01872     This routine checks to see <span class="keywordflow">if</span> ample space <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no longer committed
01873     and <span class="keywordflow">if</span> so, does enough free space exist in any paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  <a class="code" href="../../d2/d0/aw_8h.html#a1">IF</a>
01874     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> answer to both these <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> affirmative, a reduction in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01875     paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> size(s) is attempted.
01876 
01877 Arguments:
01878 
01879     None.
01880 
01881 Return Value:
01882 
01883     None.
01884 
01885 --*/
01886 
01887 {
01888     BOOLEAN Reduce;
01889     <a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html">PMMPAGE_FILE_EXPANSION</a> PageReduce;
01890     KIRQL OldIrql;
01891     ULONG i;
01892 
01893     Reduce = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01894 
01895     ExAcquireSpinLock (&amp;MmChargeCommitmentLock, &amp;OldIrql);
01896 
01897     <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> - <a class="code" href="../../d4/d8/mi_8h.html#a733">MmMinimumPageFileReduction</a>) &gt;
01898                                                        <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a>) {
01899 
01900         <span class="keywordflow">for</span> (i = 0;i &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>; i += 1) {
01901             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a> != <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">MinimumSize</a>) {
01902                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> &gt; <a class="code" href="../../d4/d8/mi_8h.html#a733">MmMinimumPageFileReduction</a>) {
01903                     Reduce = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01904                     <span class="keywordflow">break</span>;
01905                 }
01906             }
01907         }
01908 
01909         ExReleaseSpinLock (&amp;MmChargeCommitmentLock, OldIrql);
01910 
01911         <span class="keywordflow">if</span> (!Reduce) {
01912             <span class="keywordflow">return</span>;
01913         }
01914 
01915         PageReduce = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
01916                                             <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html">MMPAGE_FILE_EXPANSION</a>),
01917                                             '  mM');
01918 
01919         <span class="keywordflow">if</span> (PageReduce == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01920             <span class="keywordflow">return</span>;
01921         }
01922 
01923         PageReduce-&gt;<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o0">Segment</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01924         PageReduce-&gt;<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o2">RequestedExpansionSize</a> = 0xFFFFFFFF;
01925 
01926         ExAcquireSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o0">Lock</a>, &amp;OldIrql);
01927         InsertTailList ( &amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o2">ListHead</a>,
01928                          &amp;PageReduce-&gt;<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o1">DereferenceList</a>);
01929         ExReleaseSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o0">Lock</a>, OldIrql);
01930 
01931         <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o1">Semaphore</a>, 0L, 1L, FALSE);
01932         <span class="keywordflow">return</span>;
01933     }
01934 
01935     ExReleaseSpinLock (&amp;MmChargeCommitmentLock, OldIrql);
01936     <span class="keywordflow">return</span>;
01937 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="modwrite.c::MiCrashDumpWorker" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiCrashDumpWorker           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Context</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01338">1338</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00033">_MMWORK_CONTEXT::Event</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00083">MmCrashDumpSection</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l00390">MmCreateSection()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d3/modwrite_8c.html#a6">PMMWORK_CONTEXT</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00031">_MMWORK_CONTEXT::Size</a>, and <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00032">_MMWORK_CONTEXT::Status</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01095">MiCheckForCrashDump()</a>.
<p>
<pre class="fragment"><div>01344                    :
01345 
01346     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context of a delayed worker thread.
01347     Its function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to create a section which will be used to map <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01348     crash dump in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
01349 
01350 Arguments:
01351 
01352     Context - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context record which contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section's
01353               size, an event to set at completion and a status value
01354               to be returned.
01355 
01356 Return Value:
01357 
01358     None.
01359 
01360 --*/
01361 
01362 {
01363     <a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html">PMMWORK_CONTEXT</a> Work;
01364     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
01365 
01366     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01367 
01368     Work = (<a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html">PMMWORK_CONTEXT</a>)Context;
01369 
01370     InitializeObjectAttributes( &amp;ObjectAttributes,
01371                                 NULL,
01372                                 0,
01373                                 NULL,
01374                                 NULL );
01375 
01376 
01377     Work-&gt;<a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html#o1">Status</a> = <a class="code" href="../../d0/d8/creasect_8c.html#a20">MmCreateSection</a> ( &amp;MmCrashDumpSection,
01378                                SECTION_MAP_READ,
01379                                &amp;ObjectAttributes,
01380                                &amp;Work-&gt;<a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html#o0">Size</a>,
01381                                PAGE_READONLY,
01382                                SEC_COMMIT,
01383                                NULL,
01384                                NULL );
01385 
01386     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;Work-&gt;<a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html#o2">Event</a>, 0, FALSE);
01387     <span class="keywordflow">return</span>;
01388 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="modwrite.c::MiExtendPagingFileMaximum" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiExtendPagingFileMaximum           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PageFileNumber</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PRTL_BITMAP&nbsp;</td>
          <td class="mdname" nowrap> <em>NewBitmap</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01031">1031</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l02559">_MMPAGING_FILE::Bitmap</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02551">_MMPAGING_FILE::MaximumSize</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l01098">MiUpdateModifiedWriterMdls()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05090">MmFreePagingSpaceLow</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05083">MmPagingFile</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00100">MmTotalCommitLimitMaximum</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l00305">RtlSetAllBits()</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00297">NtCreatePagingFile()</a>.
<p>
<pre class="fragment"><div>01038                    :
01039 
01040     This routine switches from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> old bitmap to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> (larger) bitmap.
01041 
01042 Arguments:
01043 
01044     PageFileNumber - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> number to be extended.
01045 
01046     NewBitmap - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> bitmap to use.
01047 
01048 Return Value:
01049 
01050     None.
01051 
01052 Environment:
01053 
01054     Kernel mode, <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, <a class="code" href="../../d4/d8/mi_8h.html#a684">MmPageFileCreationLock</a> held.
01055 
01056 --*/
01057 
01058 {
01059     KIRQL OldIrql;
01060     PRTL_BITMAP OldBitmap;
01061 
01062     OldBitmap = <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o9">Bitmap</a>;
01063 
01064     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a28">RtlSetAllBits</a> (NewBitmap);
01065 
01066     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01067 
01068     <span class="comment">//</span>
01069     <span class="comment">// Copy the bits from the existing map.</span>
01070     <span class="comment">//</span>
01071 
01072     RtlCopyMemory (NewBitmap-&gt;Buffer,
01073                    OldBitmap-&gt;Buffer,
01074                    ((OldBitmap-&gt;SizeOfBitMap + 31) / 32) * sizeof (ULONG));
01075 
01076     <a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a> += (NewBitmap-&gt;SizeOfBitMap - OldBitmap-&gt;SizeOfBitMap);
01077 
01078     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o1">MaximumSize</a> = NewBitmap-&gt;SizeOfBitMap;
01079 
01080     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o9">Bitmap</a> = NewBitmap;
01081 
01082     <span class="comment">//</span>
01083     <span class="comment">// If any MDLs are waiting for space, get them up now.</span>
01084     <span class="comment">//</span>
01085 
01086     <span class="keywordflow">if</span> (!IsListEmpty (&amp;MmFreePagingSpaceLow)) {
01087         <a class="code" href="../../d4/d8/mi_8h.html#a890">MiUpdateModifiedWriterMdls</a> (PageFileNumber);
01088     }
01089 
01090     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01091 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a46" doxytag="modwrite.c::MiExtendPagingFiles" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> SIZE_T MiExtendPagingFiles           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html">PMMPAGE_FILE_EXPANSION</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PageExpand</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01681">1681</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02551">_MMPAGING_FILE::MaximumSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02219">MI_EXTEND_ANY_PAGEFILE</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01485">MiAttemptPageFileExtension()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04899">MmChargeCommitmentLock</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00056">MmNumberOfPagingFiles</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00043">MmPageFileFullExtendPages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05083">MmPagingFile</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00041">MmTotalCommitLimit</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00040">MmTotalCommittedPages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02550">_MMPAGING_FILE::Size</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d4/sectsup_8c-source.html#l00603">MiDereferenceSegmentThread()</a>.
<p>
<pre class="fragment"><div>01687                    :
01688 
01689     This routine attempts to extend <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> paging files to provide
01690     ExtendSize bytes.
01691 
01692     Note - Page <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> expansion and page <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> reduction are <span class="keyword">synchronized</span>
01693            because a single thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> responsible <span class="keywordflow">for</span> performing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01694            operation.  Hence, <span class="keywordflow">while</span> expansion <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> occurring, a reduction
01695            request will be queued to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread.
01696 
01697 Arguments:
01698 
01699     DesiredQuota - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota in pages desired.
01700 
01701     PageFileNumber - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> number to extend.
01702                      MI_EXTEND_ANY_PAGFILE indicates to extend any page <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
01703 
01704 Return Value:
01705 
01706     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>.  <a class="code" href="../../d6/d6/ttime_8c.html#a0">Zero</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page <a class="code" href="../../d7/d1/genuedef_8c.html#a9">file</a>(s) cannot
01707     be extended.
01708 
01709 --*/
01710 
01711 {
01712     SIZE_T DesiredQuota;
01713     ULONG PageFileNumber;
01714     SIZE_T ExtendedSize;
01715     SIZE_T ExtendSize;
01716     ULONG i;
01717     KIRQL OldIrql;
01718     LOGICAL LockHeld;
01719     LOGICAL RealExpansion;
01720 
01721     RealExpansion = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01722     LockHeld = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01723     ExtendedSize = 0;
01724     DesiredQuota = PageExpand-&gt;RequestedExpansionSize;
01725     PageFileNumber = PageExpand-&gt;PageFileNumber;
01726 
01727     PageExpand-&gt;ActualExpansion = 0;
01728 
01729     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PageFileNumber &lt; MmNumberOfPagingFiles || PageFileNumber == MI_EXTEND_ANY_PAGEFILE);
01730 
01731     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a> == 0) {
01732         <span class="keywordflow">goto</span> alldone;
01733     }
01734 
01735     <span class="keywordflow">if</span> (PageFileNumber &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>) {
01736         i = PageFileNumber;
01737         ExtendedSize = <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o1">MaximumSize</a> - <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a>;
01738         <span class="keywordflow">if</span> (ExtendedSize &lt; DesiredQuota) {
01739             ExtendedSize = 0;
01740         }
01741         <span class="keywordflow">else</span> {
01742             ExtendedSize = <a class="code" href="../../d6/d3/modwrite_8c.html#a40">MiAttemptPageFileExtension</a> (i, DesiredQuota, FALSE);
01743         }
01744         <span class="keywordflow">goto</span> alldone;
01745     }
01746 
01747     LockHeld = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01748     ExAcquireSpinLock (&amp;MmChargeCommitmentLock, &amp;OldIrql);
01749 
01750     <span class="comment">//</span>
01751     <span class="comment">// Check to see if ample space already exists now that we have</span>
01752     <span class="comment">// the spinlock.</span>
01753     <span class="comment">//</span>
01754 
01755     ExtendSize = DesiredQuota + <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a>;
01756 
01757     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> &gt;= ExtendSize) {
01758         ExtendedSize = 1;
01759         RealExpansion = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01760         <span class="keywordflow">goto</span> alldone;
01761     }
01762 
01763     <span class="comment">//</span>
01764     <span class="comment">// Calculate the additional pages needed.</span>
01765     <span class="comment">//</span>
01766 
01767     ExtendSize -= <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a>;
01768 
01769     ExReleaseSpinLock (&amp;MmChargeCommitmentLock, OldIrql);
01770     LockHeld = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01771 
01772     <span class="comment">//</span>
01773     <span class="comment">// Make sure ample space exists within the paging files.</span>
01774     <span class="comment">//</span>
01775 
01776     i = 0;
01777 
01778     <span class="keywordflow">do</span> {
01779         ExtendedSize += <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o1">MaximumSize</a> - <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a>;
01780         i += 1;
01781     } <span class="keywordflow">while</span> (i &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>);
01782 
01783     <span class="keywordflow">if</span> (ExtendedSize &lt; ExtendSize) {
01784         ExtendedSize = 0;
01785         <span class="keywordflow">goto</span> alldone;
01786     }
01787 
01788     <span class="comment">//</span>
01789     <span class="comment">// Attempt to extend only one of the paging files.</span>
01790     <span class="comment">//</span>
01791 
01792     i = 0;
01793     <span class="keywordflow">do</span> {
01794         ExtendedSize = <a class="code" href="../../d6/d3/modwrite_8c.html#a40">MiAttemptPageFileExtension</a> (i, ExtendSize, FALSE);
01795         <span class="keywordflow">if</span> (ExtendedSize != 0) {
01796             <span class="keywordflow">goto</span> alldone;
01797         }
01798         i += 1;
01799     } <span class="keywordflow">while</span> (i &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>);
01800 
01801     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ExtendedSize == 0);
01802 
01803     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a> == 1) {
01804 
01805         <span class="comment">//</span>
01806         <span class="comment">// If the attempt didn't succeed for one (not enough disk space free) -</span>
01807         <span class="comment">// don't try to set it to the maximum size.</span>
01808         <span class="comment">//</span>
01809 
01810         <span class="keywordflow">goto</span> alldone;
01811     }
01812 
01813     <span class="comment">//</span>
01814     <span class="comment">// Attempt to extend all paging files.</span>
01815     <span class="comment">//</span>
01816 
01817     i = 0;
01818     <span class="keywordflow">do</span> {
01819         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ExtendSize &gt; ExtendedSize);
01820         ExtendedSize += <a class="code" href="../../d6/d3/modwrite_8c.html#a40">MiAttemptPageFileExtension</a> (i,
01821                                                     ExtendSize - ExtendedSize,
01822                                                     TRUE);
01823         <span class="keywordflow">if</span> (ExtendedSize &gt;= ExtendSize) {
01824             <span class="keywordflow">goto</span> alldone;
01825         }
01826         i += 1;
01827     } <span class="keywordflow">while</span> (i &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>);
01828 
01829     <span class="comment">//</span>
01830     <span class="comment">// Not enough space is available.</span>
01831     <span class="comment">//</span>
01832 
01833     ExtendedSize = 0;
01834 
01835 alldone:
01836 
01837     <span class="keywordflow">if</span> (LockHeld == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01838         ExAcquireSpinLock (&amp;MmChargeCommitmentLock, &amp;OldIrql);
01839     }
01840 
01841     <span class="keywordflow">if</span> ((ExtendedSize != 0) &amp;&amp; (RealExpansion == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
01842         <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> += ExtendedSize;
01843     }
01844     
01845     <span class="comment">//</span>
01846     <span class="comment">// If commit allotments have been temporarily blocked then unblock now.</span>
01847     <span class="comment">//</span>
01848 
01849     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a9">MmPageFileFullExtendPages</a>) {
01850         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MmTotalCommittedPages &gt;= MmPageFileFullExtendPages);
01851         <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> -= <a class="code" href="../../d6/d1/mmquota_8c.html#a9">MmPageFileFullExtendPages</a>;
01852         <a class="code" href="../../d6/d1/mmquota_8c.html#a9">MmPageFileFullExtendPages</a> = 0;
01853     }
01854 
01855     PageExpand-&gt;InProgress = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01856     PageExpand-&gt;ActualExpansion = ExtendedSize;
01857 
01858     ExReleaseSpinLock (&amp;MmChargeCommitmentLock, OldIrql);
01859 
01860     <span class="keywordflow">return</span> ExtendedSize;
01861 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a57" doxytag="modwrite.c::MiFlushAllPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiFlushAllPages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04870">4870</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00217">Mm30Milliseconds</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01087">MmModifiedPageListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05096">MmModifiedPageWriterEvent</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00042">MmWriteAllModifiedPages</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01079">_MMPFNLIST::Total</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l04107">MiAllocateContiguousMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07930">MmGatherMemoryForHibernate()</a>, and <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00437">MmRemovePhysicalMemory()</a>.
<p>
<pre class="fragment"><div>04876                    :
04877 
04878     Forces a write of all modified pages.
04879 
04880 Arguments:
04881 
04882     None.
04883 
04884 Return Value:
04885 
04886     None.
04887 
04888 Environment:
04889 
04890     Kernel mode.  No locks held.  <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or less.
04891 
04892 --*/
04893 
04894 {
04895     ULONG j = 0xff;
04896 
04897     <a class="code" href="../../d6/d3/modwrite_8c.html#a9">MmWriteAllModifiedPages</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04898     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;MmModifiedPageWriterEvent, 0, FALSE);
04899 
04900     <span class="keywordflow">do</span> {
04901         <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (KernelMode, FALSE, &amp;Mm30Milliseconds);
04902         j -= 1;
04903     } <span class="keywordflow">while</span> ((<a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> &gt; 50) &amp;&amp; (j &gt; 0));
04904 
04905     <a class="code" href="../../d6/d3/modwrite_8c.html#a9">MmWriteAllModifiedPages</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04906     <span class="keywordflow">return</span>;
04907 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="modwrite.c::MiGatherMappedPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiGatherMappedPages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Pfn1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>PageFrameIndex</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l03198">3198</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00166">BYTE_OFFSET</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00420">_MDL::ByteCount</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00141">BYTES_TO_PAGES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02540">_MMMOD_WRITER_MDL_ENTRY::ControlArea</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02114">_SUBSECTION::ControlArea</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02539">_MMMOD_WRITER_MDL_ENTRY::File</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02070">_CONTROL_AREA::FilePointer</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02541">_MMMOD_WRITER_MDL_ENTRY::FileResource</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l02064">FsRtlAcquireFileForModWrite()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00934">IoAsynchronousPageWrite()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02531">_MMMOD_WRITER_MDL_ENTRY::IoStatus</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02528">_MMMOD_WRITER_MDL_ENTRY::Links</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02523">_MMMOD_WRITER_LISTHEAD::ListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00469">_MMINFO_COUNTERS::MappedPagesWriteCount</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00470">_MMINFO_COUNTERS::MappedWriteIoCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02542">_MMMOD_WRITER_MDL_ENTRY::Mdl</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00425">MDL_PAGES_LOCKED</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00416">_MDL::MdlFlags</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01430">MI_ADD_LOCKED_PAGE_CHARGE_FOR_MODIFIED_PAGE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02411">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01559">MiGetSubsectionAddress</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01683">MiInsertFrontModifiedNoWrite()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00059">MiInsertPageInList()</a>, <a class="el" href="../../d3/d2/ppc_2hypermap_8c-source.html#l00032">MiMapPageInHyperSpace()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00916">MiStartingOffset()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00667">MiUnlinkPageFromList()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02922">MiUnmapPageInHyperSpace</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02234">MiWriteComplete()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01123">MmEnoughMemoryForWrite</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05120">MmFreeGoal</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00475">MmInfoCounters</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01789">MmInitializeMdl</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05081">MmMappedFileHeader</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00090">MmMappedPageWriterEvent</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00088">MmMappedPageWriterList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05126">MmModifiedWriteClusterSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04575">MmModNoWriteInsert</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04571">MmPageLocationList</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a175">ModifiedNoWritePageList</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a174">ModifiedPageList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02072">_CONTROL_AREA::ModifiedWriteCount</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00048">NT_ERROR</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02062">_CONTROL_AREA::NumberOfMappedViews</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02061">_CONTROL_AREA::NumberOfPfnReferences</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02060">_CONTROL_AREA::NumberOfSectionReferences</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02543">_MMMOD_WRITER_MDL_ENTRY::Page</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00190">PAGE_ALIGN</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02123">_SUBSECTION::PtesInSubsection</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00415">_MDL::Size</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02121">_SUBSECTION::SubsectionBase</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">_MMMOD_WRITER_MDL_ENTRY::u</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html#o10">_CONTROL_AREA::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l02529">_MMMOD_WRITER_MDL_ENTRY::WriteOffset</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02831">MiModifiedPageWriterWorker()</a>.
<p>
<pre class="fragment"><div>03205                    :
03206 
03207     This routine processes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified modified page by examining
03208     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> prototype PTE <span class="keywordflow">for</span> that page and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> adjacent prototype PTEs
03209     building a cluster of modified pages destined <span class="keywordflow">for</span> a mapped <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
03210     Once <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cluster <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> built, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> sent to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapped writer thread
03211     to be processed.
03212 
03213 Arguments:
03214 
03215     Pfn1 - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN element <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding
03216            page.
03217 
03218     PageFrameIndex - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical page frame to write.
03219 
03220 Return Value:
03221 
03222     None.
03223 
03224 Environment:
03225 
03226     PFN lock held.
03227 
03228 --*/
03229 
03230 {
03231     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
03232     <a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">PMMMOD_WRITER_MDL_ENTRY</a> ModWriterEntry;
03233     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
03234     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
03235     PPFN_NUMBER Page;
03236     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
03237     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> BasePte;
03238     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> NextPte;
03239     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03240     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartingPte;
03241     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
03242     KIRQL OldIrql = 0;
03243     KIRQL OldIrql2;
03244 
03245     <span class="comment">//</span>
03246     <span class="comment">// This page is destined for a mapped file, check to see if</span>
03247     <span class="comment">// there are any physically adjacent pages are also in the</span>
03248     <span class="comment">// modified page list and write them out at the same time.</span>
03249     <span class="comment">//</span>
03250 
03251     Subsection = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a148">MiGetSubsectionAddress</a> (&amp;Pfn1-&gt;OriginalPte);
03252     ControlArea = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a>;
03253 
03254     <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.NoModifiedWriting) {
03255 
03256         <span class="comment">//</span>
03257         <span class="comment">// This page should not be written out, add it to the</span>
03258         <span class="comment">// tail of the modified NO WRITE list and get the next page.</span>
03259         <span class="comment">//</span>
03260 
03261         <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
03262         <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[ModifiedNoWritePageList],
03263                             PageFrameIndex);
03264         <span class="keywordflow">return</span>;
03265     }
03266 
03267     <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Image) {
03268 
03269 <span class="preprocessor">#if 0</span>
03270 <span class="preprocessor"></span>        <span class="comment">//</span>
03271         <span class="comment">// Assert that there are no dangling shared global pages</span>
03272         <span class="comment">// for an image section that is not being used.</span>
03273         <span class="comment">//</span>
03274         <span class="comment">// This assert can be re-enabled when the segment dereference</span>
03275         <span class="comment">// thread list re-insertion is fixed.  Note the recovery code is</span>
03276         <span class="comment">// fine, so disabling the assert is benign.</span>
03277         <span class="comment">//</span>
03278 
03279         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> != 0) ||
03280                 (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o2">NumberOfSectionReferences</a> != 0) ||
03281                 (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.FloppyMedia != 0));
03282 <span class="preprocessor">#endif</span>
03283 <span class="preprocessor"></span>
03284         <span class="comment">//</span>
03285         <span class="comment">// This is an image section, writes are not</span>
03286         <span class="comment">// allowed to an image section.</span>
03287         <span class="comment">//</span>
03288 
03289         <span class="comment">//</span>
03290         <span class="comment">// Change page contents to look like it's a demand zero</span>
03291         <span class="comment">// page and put it back into the modified list.</span>
03292         <span class="comment">//</span>
03293 
03294         <span class="comment">//</span>
03295         <span class="comment">// Decrement the count for PfnReferences to the</span>
03296         <span class="comment">// segment as paging file pages are not counted as</span>
03297         <span class="comment">// "image" references.</span>
03298         <span class="comment">//</span>
03299 
03300         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">NumberOfPfnReferences</a> -= 1;
03301         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">NumberOfPfnReferences</a> &gt;= 0);
03302         <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
03303 
03304         Pfn1-&gt;OriginalPte.u.Soft.PageFileHigh = 0;
03305         Pfn1-&gt;OriginalPte.u.Soft.Prototype = 0;
03306         Pfn1-&gt;OriginalPte.u.Soft.Transition = 0;
03307 
03308         <span class="comment">//</span>
03309         <span class="comment">// Insert the page at the tail of the list and get</span>
03310         <span class="comment">// color update performed.</span>
03311         <span class="comment">//</span>
03312 
03313         <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[ModifiedPageList],
03314                             PageFrameIndex);
03315         <span class="keywordflow">return</span>;
03316     }
03317 
03318     <span class="keywordflow">if</span> ((ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.HadUserReference == 0) &amp;&amp;
03319         (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt; (<a class="code" href="../../d4/d8/mi_8h.html#a727">MmFreeGoal</a> + 40)) &amp;&amp;
03320         (<a class="code" href="../../d2/d1/mm_8h.html#a23">MmEnoughMemoryForWrite</a>())) {
03321 
03322         <span class="comment">//</span>
03323         <span class="comment">// This page was modified via the cache manager.  Don't</span>
03324         <span class="comment">// write it out at this time as there are ample pages.</span>
03325         <span class="comment">//</span>
03326 
03327         <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
03328         <a class="code" href="../../d7/d5/pfnlist_8c.html#a16">MiInsertFrontModifiedNoWrite</a> (PageFrameIndex);
03329         <a class="code" href="../../d4/d8/mi_8h.html#a608">MmModNoWriteInsert</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03330         <span class="keywordflow">return</span>;
03331     }
03332 
03333     <span class="comment">//</span>
03334     <span class="comment">// Look at backwards at previous prototype PTEs to see if</span>
03335     <span class="comment">// this can be clustered into a larger write operation.</span>
03336     <span class="comment">//</span>
03337 
03338     PointerPte = Pfn1-&gt;PteAddress;
03339     NextPte = PointerPte - (<a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a> - 1);
03340 
03341     <span class="comment">//</span>
03342     <span class="comment">// Make sure NextPte is in the same page.</span>
03343     <span class="comment">//</span>
03344 
03345     <span class="keywordflow">if</span> (NextPte &lt; (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (PointerPte)) {
03346         NextPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (PointerPte);
03347     }
03348 
03349     <span class="comment">//</span>
03350     <span class="comment">// Make sure NextPte is within the subsection.</span>
03351     <span class="comment">//</span>
03352 
03353     <span class="keywordflow">if</span> (NextPte &lt; Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>) {
03354         NextPte = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>;
03355     }
03356 
03357     <span class="comment">//</span>
03358     <span class="comment">// If the prototype PTEs are not currently mapped,</span>
03359     <span class="comment">// map them via hyperspace.  BasePte refers to the</span>
03360     <span class="comment">// prototype PTEs for nonfaulting references.</span>
03361     <span class="comment">//</span>
03362 
03363     OldIrql2 = 99;
03364     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a> (PointerPte)) {
03365         BasePte = PointerPte;
03366     } <span class="keywordflow">else</span> {
03367         BasePte = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (Pfn1-&gt;PteFrame, &amp;OldIrql2);
03368         BasePte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)((PCHAR)BasePte +
03369                             <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a> (PointerPte));
03370     }
03371 
03372     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE (BasePte) == PageFrameIndex);
03373 
03374     PointerPte -= 1;
03375     BasePte -= 1;
03376 
03377     <span class="comment">//</span>
03378     <span class="comment">// Don't go before the start of the subsection nor cross</span>
03379     <span class="comment">// a page boundary.</span>
03380     <span class="comment">//</span>
03381 
03382     <span class="keywordflow">while</span> (PointerPte &gt;= NextPte) {
03383 
03384         PteContents = *BasePte;
03385 
03386         <span class="comment">//</span>
03387         <span class="comment">// If the page is not in transition, exit loop.</span>
03388         <span class="comment">//</span>
03389 
03390         <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) ||
03391             (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 0) ||
03392             (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1)) {
03393 
03394             <span class="keywordflow">break</span>;
03395         }
03396 
03397         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Trans.PageFrameNumber);
03398 
03399         <span class="comment">//</span>
03400         <span class="comment">// Make sure page is modified and on the modified list.</span>
03401         <span class="comment">//</span>
03402 
03403         <span class="keywordflow">if</span> ((Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified == 0 ) ||
03404             (Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount != 0)) {
03405             <span class="keywordflow">break</span>;
03406         }
03407         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a> (&amp;PteContents);
03408         PointerPte -= 1;
03409         BasePte -= 1;
03410     }
03411 
03412     StartingPte = PointerPte + 1;
03413     BasePte = BasePte + 1;
03414 
03415     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
03416     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StartingPte == Pfn1-&gt;PteAddress);
03417     <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
03418 
03419     <span class="comment">//</span>
03420     <span class="comment">// Get an entry from the list and fill it in.</span>
03421     <span class="comment">//</span>
03422 
03423     ModWriterEntry = (<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">PMMMOD_WRITER_MDL_ENTRY</a>)RemoveHeadList (
03424                                     &amp;<a class="code" href="../../d4/d8/mi_8h.html#a713">MmMappedFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>);
03425 
03426     ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o10">File</a> = ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>;
03427     ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o11">ControlArea</a> = ControlArea;
03428 
03429     <span class="comment">//</span>
03430     <span class="comment">// Calculate the offset to read into the file.</span>
03431     <span class="comment">//  offset = base + ((thispte - basepte) &lt;&lt; PAGE_SHIFT)</span>
03432     <span class="comment">//</span>
03433 
03434     ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o1">WriteOffset</a>.QuadPart = <a class="code" href="../../d4/d8/mi_8h.html#a952">MiStartingOffset</a> (Subsection,
03435                                                               Pfn1-&gt;PteAddress);
03436 
03437     <a class="code" href="../../d2/d1/mm_8h.html#a24">MmInitializeMdl</a>(&amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>,
03438                     (PVOID)ULongToPtr(Pfn1-&gt;u3.e1.PageColor &lt;&lt; PAGE_SHIFT),
03439                     PAGE_SIZE);
03440 
03441     ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>.<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a13">MDL_PAGES_LOCKED</a>;
03442 
03443     ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>.<a class="code" href="../../d6/d7/struct__MDL.html#o1">Size</a> = (CSHORT)(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>) +
03444                       (<span class="keyword">sizeof</span>(PFN_NUMBER) * <a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a>));
03445 
03446     Page = &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o14">Page</a>[0];
03447 
03448     <span class="comment">//</span>
03449     <span class="comment">// Up the reference count for the physical page as there</span>
03450     <span class="comment">// is I/O in progress.</span>
03451     <span class="comment">//</span>
03452 
03453     <a class="code" href="../../d4/d8/mi_8h.html#a187">MI_ADD_LOCKED_PAGE_CHARGE_FOR_MODIFIED_PAGE</a> (Pfn1, 14);
03454     Pfn1-&gt;u3.e2.ReferenceCount += 1;
03455 
03456     <span class="comment">//</span>
03457     <span class="comment">// Clear the modified bit for the page and set the write</span>
03458     <span class="comment">// in progress bit.</span>
03459     <span class="comment">//</span>
03460 
03461     Pfn1-&gt;u3.e1.Modified = 0;
03462     Pfn1-&gt;u3.e1.WriteInProgress = 1;
03463 
03464     <span class="comment">//</span>
03465     <span class="comment">// Put this physical page into the MDL.</span>
03466     <span class="comment">//</span>
03467 
03468     *Page = PageFrameIndex;
03469 
03470     <span class="comment">//</span>
03471     <span class="comment">// See if any adjacent pages are also modified and in</span>
03472     <span class="comment">// the transition state and if so, write them out at</span>
03473     <span class="comment">// the same time.</span>
03474     <span class="comment">//</span>
03475 
03476 
03477     <span class="comment">//</span>
03478     <span class="comment">// Look at the previous PTE, ensuring a page boundary is</span>
03479     <span class="comment">// not crossed.</span>
03480     <span class="comment">//</span>
03481 
03482     LastPte = StartingPte + <a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a>;
03483 
03484     <span class="comment">//</span>
03485     <span class="comment">// If BasePte is not in the same page as LastPte,</span>
03486     <span class="comment">// set last pte to be the last PTE in this page.</span>
03487     <span class="comment">//</span>
03488 
03489     <span class="keywordflow">if</span> (StartingPte &lt; (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(LastPte)) {
03490         LastPte = ((<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(LastPte)) - 1;
03491     }
03492 
03493     <span class="comment">//</span>
03494     <span class="comment">// Make sure LastPte is within the subsection.</span>
03495     <span class="comment">//</span>
03496 
03497     <span class="keywordflow">if</span> (LastPte &gt; &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[
03498                                 Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>]) {
03499         LastPte = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[
03500                                 Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>];
03501     }
03502 
03503     <span class="comment">//</span>
03504     <span class="comment">// Look forwards.</span>
03505     <span class="comment">//</span>
03506 
03507     NextPte = BasePte + 1;
03508     PointerPte = StartingPte + 1;
03509 
03510     <span class="comment">//</span>
03511     <span class="comment">// Loop until an MDL is filled, the end of a subsection</span>
03512     <span class="comment">// is reached, or a page boundary is reached.</span>
03513     <span class="comment">// Note, PointerPte points to the PTE. NextPte points</span>
03514     <span class="comment">// to where it is mapped in hyperspace (if required).</span>
03515     <span class="comment">//</span>
03516 
03517     <span class="keywordflow">while</span> (PointerPte &lt; LastPte) {
03518 
03519         PteContents = *NextPte;
03520 
03521         <span class="comment">//</span>
03522         <span class="comment">// If the page is not in transition, exit loop.</span>
03523         <span class="comment">//</span>
03524 
03525         <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) ||
03526             (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 0) ||
03527             (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1)) {
03528 
03529             <span class="keywordflow">break</span>;
03530         }
03531 
03532         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Trans.PageFrameNumber);
03533 
03534         <span class="keywordflow">if</span> ((Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified == 0 ) ||
03535             (Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount != 0)) {
03536 
03537             <span class="comment">//</span>
03538             <span class="comment">// Page is not dirty or not on the modified list,</span>
03539             <span class="comment">// end clustering operation.</span>
03540             <span class="comment">//</span>
03541 
03542             <span class="keywordflow">break</span>;
03543         }
03544         Page += 1;
03545 
03546         <span class="comment">//</span>
03547         <span class="comment">// Add physical page to MDL.</span>
03548         <span class="comment">//</span>
03549 
03550         *Page = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a> (&amp;PteContents);
03551         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte == Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>);
03552         <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn2);
03553 
03554         <span class="comment">//</span>
03555         <span class="comment">// Up the reference count for the physical page as there</span>
03556         <span class="comment">// is I/O in progress.</span>
03557         <span class="comment">//</span>
03558 
03559         <a class="code" href="../../d4/d8/mi_8h.html#a187">MI_ADD_LOCKED_PAGE_CHARGE_FOR_MODIFIED_PAGE</a> (Pfn2, 14);
03560         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
03561 
03562         <span class="comment">//</span>
03563         <span class="comment">// Clear the modified bit for the page and set the</span>
03564         <span class="comment">// write in progress bit.</span>
03565         <span class="comment">//</span>
03566 
03567         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 0;
03568         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress = 1;
03569 
03570         ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>.<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
03571 
03572         NextPte += 1;
03573         PointerPte += 1;
03574 
03575     } <span class="comment">//end while</span>
03576 
03577     <span class="keywordflow">if</span> (OldIrql2 != 99) {
03578         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
03579     }
03580 
03581     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (BYTES_TO_PAGES (ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>.<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a>) &lt;= MmModifiedWriteClusterSize);
03582 
03583     ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.LastByte.QuadPart = ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o1">WriteOffset</a>.QuadPart +
03584                         ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>.<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a>;
03585 
03586     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Image == 0);
03587 
03588 <span class="preprocessor">#if DBG</span>
03589 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((ULONG)ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>.<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> &gt;
03590                                 ((1+<a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a>)*<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) {
03591         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Mdl %p, MDL End Offset %lx %lx Subsection %p\n"</span>,
03592             ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>,
03593             ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.LastByte.LowPart,
03594             ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.LastByte.HighPart,
03595             Subsection);
03596         DbgBreakPoint();
03597     }
03598 <span class="preprocessor">#endif //DBG</span>
03599 <span class="preprocessor"></span>
03600     <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o12">MappedWriteIoCount</a> += 1;
03601     <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o11">MappedPagesWriteCount</a> +=
03602                                 (ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>.<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
03603 
03604     <span class="comment">//</span>
03605     <span class="comment">// Increment the count of modified page writes outstanding</span>
03606     <span class="comment">// in the control area.</span>
03607     <span class="comment">//</span>
03608 
03609     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o13">ModifiedWriteCount</a> += 1;
03610 
03611     <span class="comment">//</span>
03612     <span class="comment">// Increment the number of PFN references.  This allows the file</span>
03613     <span class="comment">// system to purge (i.e. call MmPurgeSection) modified writes.</span>
03614     <span class="comment">//</span>
03615 
03616     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">NumberOfPfnReferences</a> += 1;
03617 
03618     ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o12">FileResource</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03619 
03620     <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingPurged == 1) {
03621         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03622         ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.IoStatus.Status = STATUS_FILE_LOCK_CONFLICT;
03623         ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.IoStatus.Information = 0;
03624         <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (APC_LEVEL, &amp;OldIrql);
03625         <a class="code" href="../../d6/d3/modwrite_8c.html#a49">MiWriteComplete</a> ((PVOID)ModWriterEntry,
03626                          &amp;ModWriterEntry-&gt;u.IoStatus,
03627                          0 );
03628         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
03629         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03630         <span class="keywordflow">return</span>;
03631     }
03632 
03633     <span class="comment">//</span>
03634     <span class="comment">// Send the entry for the MappedPageWriter.</span>
03635     <span class="comment">//</span>
03636 
03637     InsertTailList (&amp;MmMappedPageWriterList,
03638                     &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o0">Links</a>);
03639 
03640     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;MmMappedPageWriterEvent, 0, FALSE);
03641 
03642 
03643 <span class="preprocessor">#if 0</span>
03644 <span class="preprocessor"></span>
03645     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03646 
03647     ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o12">FileResource</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03648 
03649     <span class="keywordflow">if</span> (ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o11">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.FailAllIo == 1) {
03650         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
03651 
03652     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a103">FsRtlAcquireFileForModWrite</a> (ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o10">File</a>,
03653                                             &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.LastByte,
03654                                             &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o12">FileResource</a>)) {
03655 
03656         <span class="comment">//</span>
03657         <span class="comment">// Issue the write request.</span>
03658         <span class="comment">//</span>
03659 
03660         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a20">IoAsynchronousPageWrite</a> (
03661                                ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o10">File</a>,
03662                                &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>,
03663                                &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o1">WriteOffset</a>,
03664                                MiWriteComplete,
03665                                (PVOID)ModWriterEntry,
03666                                &amp;ModWriterEntry-&gt;IoStatus,
03667                                &amp;ModWriterEntry-&gt;Irp );
03668     } <span class="keywordflow">else</span> {
03669 
03670         <span class="comment">//</span>
03671         <span class="comment">// Unable to get the file system resources, set error status</span>
03672         <span class="comment">// to lock conflict (ignored by MiWriteComplete) so the APC</span>
03673         <span class="comment">// routine is explicitly called.</span>
03674         <span class="comment">//</span>
03675 
03676         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_FILE_LOCK_CONFLICT;
03677     }
03678 
03679     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>(Status)) {
03680 
03681         <span class="comment">//</span>
03682         <span class="comment">// An error has occurred, disable APCs and</span>
03683         <span class="comment">// call the write completion routine.</span>
03684         <span class="comment">//</span>
03685 
03686         ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o2">IoStatus</a>.Status = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03687         ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o2">IoStatus</a>.Information = 0;
03688         <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (APC_LEVEL, &amp;OldIrql);
03689         <a class="code" href="../../d6/d3/modwrite_8c.html#a49">MiWriteComplete</a> ((PVOID)ModWriterEntry,
03690                          &amp;ModWriterEntry-&gt;IoStatus,
03691                          0 );
03692         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
03693     }
03694 
03695     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03696 <span class="preprocessor">#endif //0</span>
03697 <span class="preprocessor"></span>    <span class="keywordflow">return</span>;
03698 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="modwrite.c::MiGatherPagefilePages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiGatherPagefilePages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Pfn1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>PageFrameIndex</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l03701">3701</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02559">_MMPAGING_FILE::Bitmap</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00420">_MDL::ByteCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02537">_MMMOD_WRITER_MDL_ENTRY::CurrentList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02554">_MMPAGING_FILE::CurrentUsage</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00467">_MMINFO_COUNTERS::DirtyPagesWriteCount</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00468">_MMINFO_COUNTERS::DirtyWriteIoCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02524">_MMMOD_WRITER_LISTHEAD::Event</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02560">_MMPAGING_FILE::File</a>, <a class="el" href="../../d2/d8/icmui_8def-source.html#l00004">File</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02553">_MMPAGING_FILE::FreeSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02556">_MMPAGING_FILE::Hint</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02564">_MMPAGING_FILE::HintSetToZero</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00934">IoAsynchronousPageWrite()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02535">_MMMOD_WRITER_MDL_ENTRY::LastPageToWrite</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02528">_MMMOD_WRITER_MDL_ENTRY::Links</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02523">_MMMOD_WRITER_LISTHEAD::ListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02542">_MMMOD_WRITER_MDL_ENTRY::Mdl</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00425">MDL_PAGES_LOCKED</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00416">_MDL::MdlFlags</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01430">MI_ADD_LOCKED_PAGE_CHARGE_FOR_MODIFIED_PAGE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01196">MI_GET_MODIFIED_PAGE_BY_COLOR</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01141">MI_GET_NEXT_COLOR</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01428">MI_SET_PAGING_FILE_INFO</a>, <a class="el" href="../../d6/d3/modwrite_8c.html#a31">MiClusterWritePages()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02552">_MMPAGING_FILE::MinimumSize</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04709">MiPageFileFull()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00667">MiUnlinkPageFromList()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02234">MiWriteComplete()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00217">Mm30Milliseconds</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00169">MM_DBG_MOD_WRITE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00107">MM_EMPTY_LIST</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00102">MM_IO_IN_PROGRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05090">MmFreePagingSpaceLow</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00475">MmInfoCounters</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01789">MmInitializeMdl</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05126">MmModifiedWriteClusterSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05092">MmNumberOfActiveMdlEntries</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04872">MmPagingFileDebug</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05079">MmPagingFileHeader</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00048">NT_ERROR</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02543">_MMMOD_WRITER_MDL_ENTRY::Page</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02562">_MMPAGING_FILE::PageFileNumber</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02538">_MMMOD_WRITER_MDL_ENTRY::PagingFile</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02536">_MMMOD_WRITER_MDL_ENTRY::PagingListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02555">_MMPAGING_FILE::PeakUsage</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l01508">RtlClearBits()</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l01382">RtlFindClearBitsAndSet()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00415">_MDL::Size</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">_MMMOD_WRITER_MDL_ENTRY::u</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, and <a class="el" href="../../d4/d9/ke_8h.html#a407a217">WrPageOut</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02831">MiModifiedPageWriterWorker()</a>.
<p>
<pre class="fragment"><div>03708                    :
03709 
03710     This routine processes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified modified page by getting
03711     that page and gather any other pages on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> modified list destined
03712     <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> in a large write cluster.  This cluster <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
03713     then written to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
03714 
03715 Arguments:
03716 
03717     Pfn1 - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN element <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding page.
03718 
03719     PageFrameIndex - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical page frame to write.
03720 
03721 Return Value:
03722 
03723     None.
03724 
03725 Environment:
03726 
03727     PFN lock held.
03728 
03729 --*/
03730 
03731 {
03732     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>;
03733     <a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">PMMMOD_WRITER_MDL_ENTRY</a> ModWriterEntry;
03734     <a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html">PMMPAGING_FILE</a> CurrentPagingFile;
03735     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03736     PPFN_NUMBER Page;
03737     ULONG StartBit;
03738     LARGE_INTEGER StartingOffset;
03739     PFN_NUMBER ClusterSize;
03740     PFN_NUMBER ThisCluster;
03741     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> LongPte;
03742     KIRQL OldIrql;
03743     ULONG NextColor;
03744     LOGICAL PageFileFull;
03745     <span class="comment">//MM_WRITE_CLUSTER WriteCluster;</span>
03746 
03747     OldIrql = 0;
03748 
03749     <span class="keywordflow">if</span> (IsListEmpty(&amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>)) {
03750 
03751         <span class="comment">//</span>
03752         <span class="comment">// Reset the event indicating no paging files MDLs in</span>
03753         <span class="comment">// the list, drop the PFN lock and wait for an</span>
03754         <span class="comment">// I/O operation to complete.</span>
03755         <span class="comment">//</span>
03756 
03757         <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o1">Event</a>);
03758         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03759         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o1">Event</a>,
03760                                WrPageOut,
03761                                KernelMode,
03762                                FALSE,
03763                                &amp;Mm30Milliseconds);
03764         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03765 
03766         <span class="comment">//</span>
03767         <span class="comment">// Don't go on as the old PageFrameIndex at the</span>
03768         <span class="comment">// top of the ModifiedList may have changed states.</span>
03769         <span class="comment">//</span>
03770 
03771         <span class="keywordflow">return</span>;
03772     }
03773 
03774     <span class="comment">//</span>
03775     <span class="comment">// Page is destined for the paging file.</span>
03776     <span class="comment">// Find the paging file with the most free space and get a cluster.</span>
03777     <span class="comment">//</span>
03778 
03779     NextColor = Pfn1-&gt;u3.e1.PageColor;
03780 
03781     ModWriterEntry = (<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">PMMMOD_WRITER_MDL_ENTRY</a>)RemoveHeadList (
03782                                     &amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>);
03783 <span class="preprocessor">#if DBG</span>
03784 <span class="preprocessor"></span>    ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o0">Links</a>.Flink = <a class="code" href="../../d4/d8/mi_8h.html#a23">MM_IO_IN_PROGRESS</a>;
03785 <span class="preprocessor">#endif</span>
03786 <span class="preprocessor"></span>    CurrentPagingFile = ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o9">PagingFile</a>;
03787 
03788     <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> = ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o9">PagingFile</a>-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o10">File</a>;
03789     ThisCluster = <a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a>;
03790 
03791     PageFileFull = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03792 
03793     <span class="keywordflow">do</span> {
03794         <span class="comment">//</span>
03795         <span class="comment">// Attempt to cluster MmModifiedWriteClusterSize pages</span>
03796         <span class="comment">// together.  Reduce by one half until we succeed or</span>
03797         <span class="comment">// can't find a single page free in the paging file.</span>
03798         <span class="comment">//</span>
03799 
03800         <span class="keywordflow">if</span> (((CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o6">Hint</a> + <a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a>) &gt;
03801                                 CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">MinimumSize</a>)
03802              &amp;&amp;
03803             (CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o14">HintSetToZero</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
03804 
03805             CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o14">HintSetToZero</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03806             CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o6">Hint</a> = 0;
03807         }
03808 
03809         StartBit = <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a31">RtlFindClearBitsAndSet</a> (CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o9">Bitmap</a>,
03810                                            (ULONG)ThisCluster,
03811                                            (ULONG)CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o6">Hint</a>);
03812 
03813         <span class="keywordflow">if</span> (StartBit != 0xFFFFFFFF) {
03814             <span class="keywordflow">break</span>;
03815         }
03816         <span class="keywordflow">if</span> (CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o6">Hint</a> != 0) {
03817 
03818             <span class="comment">//</span>
03819             <span class="comment">// Start looking from front of the file.</span>
03820             <span class="comment">//</span>
03821 
03822             CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o6">Hint</a> = 0;
03823         } <span class="keywordflow">else</span> {
03824             ThisCluster = ThisCluster &gt;&gt; 1;
03825             PageFileFull = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03826         }
03827 
03828     } <span class="keywordflow">while</span> (ThisCluster != 0);
03829 
03830     <span class="keywordflow">if</span> (StartBit == 0xFFFFFFFF) {
03831 
03832         <span class="comment">//</span>
03833         <span class="comment">// Paging file must be full.</span>
03834         <span class="comment">//</span>
03835 
03836         KdPrint((<span class="stringliteral">"MM MODWRITE: page file full\n"</span>));
03837         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> == 0);
03838 
03839         <span class="comment">//</span>
03840         <span class="comment">// Move this entry to the not enough space list,</span>
03841         <span class="comment">// and try again.</span>
03842         <span class="comment">//</span>
03843 
03844         InsertTailList (&amp;MmFreePagingSpaceLow,
03845                         &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o0">Links</a>);
03846         ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o8">CurrentList</a> = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a716">MmFreePagingSpaceLow</a>;
03847         <a class="code" href="../../d4/d8/mi_8h.html#a717">MmNumberOfActiveMdlEntries</a> -= 1;
03848         <a class="code" href="../../d6/d3/modwrite_8c.html#a56">MiPageFileFull</a> ();
03849         <span class="keywordflow">return</span>;
03850     }
03851 
03852     CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> -= ThisCluster;
03853     CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o4">CurrentUsage</a> += ThisCluster;
03854     <span class="keywordflow">if</span> (CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> &lt; 32) {
03855         PageFileFull = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03856     }
03857 
03858     StartingOffset.QuadPart = (UINT64)StartBit &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
03859 
03860     <a class="code" href="../../d2/d1/mm_8h.html#a24">MmInitializeMdl</a>(&amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>,
03861                     (PVOID)ULongToPtr(Pfn1-&gt;u3.e1.PageColor &lt;&lt; PAGE_SHIFT),
03862                     PAGE_SIZE);
03863 
03864     ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>.<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a13">MDL_PAGES_LOCKED</a>;
03865 
03866     ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>.<a class="code" href="../../d6/d7/struct__MDL.html#o1">Size</a> = (CSHORT)(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>) +
03867                     <span class="keyword">sizeof</span>(PFN_NUMBER) * <a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a>);
03868 
03869     Page = &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o14">Page</a>[0];
03870 
03871     ClusterSize = 0;
03872 
03873     <span class="comment">//</span>
03874     <span class="comment">// Search through the modified page list looking for other</span>
03875     <span class="comment">// pages destined for the paging file and build a cluster.</span>
03876     <span class="comment">//</span>
03877 
03878     <span class="keywordflow">while</span> (ClusterSize != ThisCluster) {
03879 
03880         <span class="comment">//</span>
03881         <span class="comment">// Is this page destined for a paging file?</span>
03882         <span class="comment">//</span>
03883 
03884         <span class="keywordflow">if</span> (Pfn1-&gt;OriginalPte.u.Soft.Prototype == 0) {
03885 
03886 <span class="preprocessor">#if 0  //********* commented out</span>
03887 <span class="preprocessor"></span>
03888             <a class="code" href="../../d6/d3/modwrite_8c.html#a31">MiClusterWritePages</a> (Pfn1,
03889                                  PageFrameIndex,
03890                                  &amp;WriteCluster,
03891                                  ThisCluster - ClusterSize);
03892             <span class="keywordflow">do</span> {
03893 
03894                 PageFrameIndex = WriteCluster.Cluster[WriteCluster.StartIndex];
03895                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
03896 <span class="preprocessor">#endif //0</span>
03897 <span class="preprocessor"></span>                *Page = PageFrameIndex;
03898 
03899                 <span class="comment">//</span>
03900                 <span class="comment">// Remove the page from the modified list. Note that</span>
03901                 <span class="comment">// write-in-progress marks the state.</span>
03902                 <span class="comment">//</span>
03903 
03904                 <span class="comment">//</span>
03905                 <span class="comment">// Unlink the page so the same page won't be found</span>
03906                 <span class="comment">// on the modified page list by color.</span>
03907                 <span class="comment">//</span>
03908 
03909                 <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
03910                 NextColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a129">MI_GET_NEXT_COLOR</a>(NextColor);
03911 
03912                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a133">MI_GET_MODIFIED_PAGE_BY_COLOR</a> (PageFrameIndex,
03913                                                NextColor);
03914 
03915                 <span class="comment">//</span>
03916                 <span class="comment">// Up the reference count for the physical page as there</span>
03917                 <span class="comment">// is I/O in progress.</span>
03918                 <span class="comment">//</span>
03919 
03920                 <a class="code" href="../../d4/d8/mi_8h.html#a187">MI_ADD_LOCKED_PAGE_CHARGE_FOR_MODIFIED_PAGE</a> (Pfn1, 16);
03921                 Pfn1-&gt;u3.e2.ReferenceCount += 1;
03922 
03923                 <span class="comment">//</span>
03924                 <span class="comment">// Clear the modified bit for the page and set the</span>
03925                 <span class="comment">// write in progress bit.</span>
03926                 <span class="comment">//</span>
03927 
03928                 Pfn1-&gt;u3.e1.Modified = 0;
03929                 Pfn1-&gt;u3.e1.WriteInProgress = 1;
03930                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;OriginalPte.u.Soft.PageFileHigh == 0);
03931 
03932                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a143">MI_SET_PAGING_FILE_INFO</a> (LongPte,
03933                                          Pfn1-&gt;OriginalPte,
03934                                          CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o12">PageFileNumber</a>,
03935                                          StartBit);
03936 
03937 <span class="preprocessor">#if DBG</span>
03938 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ((StartBit &lt; 8192) &amp;&amp;
03939                     (CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o12">PageFileNumber</a> == 0)) {
03940                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MmPagingFileDebug[StartBit] &amp; 1) == 0);
03941                     <a class="code" href="../../d4/d8/mi_8h.html#a686">MmPagingFileDebug</a>[StartBit] =
03942                         (((ULONG_PTR)Pfn1-&gt;PteAddress &lt;&lt; 3) |
03943                             ((ClusterSize &amp; 0xf) &lt;&lt; 1) | 1);
03944                 }
03945 <span class="preprocessor">#endif //DBG</span>
03946 <span class="preprocessor"></span>
03947                 <span class="comment">//</span>
03948                 <span class="comment">// Change the original PTE contents to refer to</span>
03949                 <span class="comment">// the paging file offset where this was written.</span>
03950                 <span class="comment">//</span>
03951 
03952                 Pfn1-&gt;OriginalPte = LongPte;
03953 
03954                 ClusterSize += 1;
03955                 Page += 1;
03956                 StartBit += 1;
03957 <span class="preprocessor">#if 0 // COMMENTED OUT</span>
03958 <span class="preprocessor"></span>                WriteCluster.Count -= 1;
03959                 WriteCluster.StartIndex += 1;
03960 
03961             } <span class="keywordflow">while</span> (WriteCluster.Count != 0);
03962 <span class="preprocessor">#endif //0</span>
03963 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> {
03964 
03965             <span class="comment">//</span>
03966             <span class="comment">// This page was not destined for a paging file,</span>
03967             <span class="comment">// get another page.</span>
03968             <span class="comment">//</span>
03969             <span class="comment">// Get a page of the same color as the one which</span>
03970             <span class="comment">// was not usable.</span>
03971             <span class="comment">//</span>
03972 
03973             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a133">MI_GET_MODIFIED_PAGE_BY_COLOR</a> (PageFrameIndex,
03974                                            NextColor);
03975         }
03976 
03977         <span class="keywordflow">if</span> (PageFrameIndex == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
03978             <span class="keywordflow">break</span>;
03979         }
03980 
03981         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
03982 
03983     } <span class="comment">//end while</span>
03984 
03985     <span class="keywordflow">if</span> (ClusterSize != ThisCluster) {
03986 
03987         <span class="comment">//</span>
03988         <span class="comment">// A complete cluster could not be located, free the</span>
03989         <span class="comment">// excess page file space that was reserved and adjust</span>
03990         <span class="comment">// the size of the packet.</span>
03991         <span class="comment">//</span>
03992 
03993         <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a> (CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o9">Bitmap</a>,
03994                       StartBit,
03995                       (ULONG)(ThisCluster - ClusterSize));
03996 
03997         CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> += ThisCluster - ClusterSize;
03998         CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o4">CurrentUsage</a> -= ThisCluster - ClusterSize;
03999 
04000         <span class="comment">//</span>
04001         <span class="comment">// If their are no pages to write, don't issue a write</span>
04002         <span class="comment">// request and restart the scan loop.</span>
04003         <span class="comment">//</span>
04004 
04005         <span class="keywordflow">if</span> (ClusterSize == 0) {
04006 
04007             <span class="comment">//</span>
04008             <span class="comment">// No pages to write.  Inset the entry back in the</span>
04009             <span class="comment">// list.</span>
04010             <span class="comment">//</span>
04011 
04012             <span class="keywordflow">if</span> (IsListEmpty (&amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o7">PagingListHead</a>-&gt;<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>)) {
04013                 <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o7">PagingListHead</a>-&gt;<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o1">Event</a>,
04014                             0,
04015                             FALSE);
04016             }
04017 
04018             InsertTailList (&amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o7">PagingListHead</a>-&gt;<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>,
04019                             &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o0">Links</a>);
04020 
04021             <span class="keywordflow">return</span>;
04022         }
04023     }
04024 
04025     <span class="keywordflow">if</span> (CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o5">PeakUsage</a> &lt;
04026                                 CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o4">CurrentUsage</a>) {
04027         CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o5">PeakUsage</a> =
04028                                 CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o4">CurrentUsage</a>;
04029     }
04030 
04031     ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>.<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> = (ULONG)(ClusterSize * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
04032     ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o6">LastPageToWrite</a> = StartBit - 1;
04033 
04034     <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o10">DirtyWriteIoCount</a> += 1;
04035     <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o9">DirtyPagesWriteCount</a> += (ULONG)ClusterSize;
04036 
04037     <span class="comment">//</span>
04038     <span class="comment">// For now release the PFN lock and wait for the write to complete.</span>
04039     <span class="comment">//</span>
04040 
04041     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04042 
04043 <span class="preprocessor">#if DBG</span>
04044 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a61">MM_DBG_MOD_WRITE</a>) {
04045         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM MODWRITE: modified page write begun @ %08lx by %08lx\n"</span>,
04046                 StartingOffset.LowPart, ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>.<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a>);
04047     }
04048 <span class="preprocessor">#endif</span>
04049 <span class="preprocessor"></span>
04050     <span class="comment">//</span>
04051     <span class="comment">// Issue the write request.</span>
04052     <span class="comment">//</span>
04053 
04054     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a20">IoAsynchronousPageWrite</a> ( File,
04055                            &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>,
04056                            &amp;StartingOffset,
04057                            MiWriteComplete,
04058                            (PVOID)ModWriterEntry,
04059                            &amp;ModWriterEntry-&gt;u.IoStatus,
04060                            &amp;ModWriterEntry-&gt;Irp );
04061 
04062     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>(Status)) {
04063         KdPrint((<span class="stringliteral">"MM MODWRITE: modified page write failed %lx\n"</span>, Status));
04064 
04065         <span class="comment">//</span>
04066         <span class="comment">// An error has occurred, disable APCs and</span>
04067         <span class="comment">// call the write completion routine.</span>
04068         <span class="comment">//</span>
04069 
04070         ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.IoStatus.Status = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04071         ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.IoStatus.Information = 0;
04072         <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (APC_LEVEL, &amp;OldIrql);
04073         <a class="code" href="../../d6/d3/modwrite_8c.html#a49">MiWriteComplete</a> ((PVOID)ModWriterEntry,
04074                          &amp;ModWriterEntry-&gt;u.IoStatus,
04075                          0 );
04076         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
04077     }
04078 
04079     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
04080 
04081     <span class="keywordflow">if</span> (PageFileFull == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
04082         <a class="code" href="../../d6/d3/modwrite_8c.html#a56">MiPageFileFull</a> ();
04083     }
04084 
04085     <span class="keywordflow">return</span>;
04086 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="modwrite.c::MiInsertPageFileInList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiInsertPageFileInList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04607">4607</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02537">_MMMOD_WRITER_MDL_ENTRY::CurrentList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02558">_MMPAGING_FILE::Entry</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02524">_MMMOD_WRITER_LISTHEAD::Event</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02553">_MMPAGING_FILE::FreeSpace</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02523">_MMMOD_WRITER_LISTHEAD::ListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02551">_MMPAGING_FILE::MaximumSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04899">MmChargeCommitmentLock</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05092">MmNumberOfActiveMdlEntries</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00056">MmNumberOfPagingFiles</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00076">MmOverCommit</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00096">MmOverCommit2</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05083">MmPagingFile</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05079">MmPagingFileHeader</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00041">MmTotalCommitLimit</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00100">MmTotalCommitLimitMaximum</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00297">NtCreatePagingFile()</a>.
<p>
<pre class="fragment"><div>04613                    :
04614 
04615     Non-pagable routine to add a page <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list
04616     of system wide page files.
04617 
04618 Arguments:
04619 
04620     None, implicitly found through page <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> structures.
04621 
04622 Return Value:
04623 
04624     None.  Operation cannot fail.
04625 
04626 --*/
04627 
04628 {
04629     KIRQL OldIrql;
04630     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
04631 
04632     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
04633 
04634     <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a> += 1;
04635     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>;
04636 
04637     <span class="keywordflow">if</span> (IsListEmpty (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>)) {
04638         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o1">Event</a>, 0, FALSE);
04639     }
04640 
04641     InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>,
04642                     &amp;MmPagingFile[MmNumberOfPagingFiles - 1]-&gt;Entry[0]-&gt;Links);
04643 
04644     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a> - 1]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o8">Entry</a>[0]-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o8">CurrentList</a> =
04645                                                 &amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>;
04646 
04647     InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>,
04648                     &amp;MmPagingFile[MmNumberOfPagingFiles - 1]-&gt;Entry[1]-&gt;Links);
04649 
04650     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a> - 1]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o8">Entry</a>[1]-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o8">CurrentList</a> =
04651                                                 &amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>;
04652 
04653     <a class="code" href="../../d4/d8/mi_8h.html#a717">MmNumberOfActiveMdlEntries</a> += 2;
04654 
04655     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04656 
04657 
04658     ExAcquireSpinLock (&amp;MmChargeCommitmentLock, &amp;OldIrql);
04659 
04660     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> == 1) {
04661 
04662         <span class="comment">//</span>
04663         <span class="comment">// We have just created the first paging file.  Start the</span>
04664         <span class="comment">// modified page writer.</span>
04665         <span class="comment">//</span>
04666 
04667         <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> =
04668                     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a> - 1]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> + <a class="code" href="../../d8/d0/cmdat3_8c.html#a20">MmOverCommit</a>;
04669 
04670         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a> =
04671                     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a> - 1]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o1">MaximumSize</a> + <a class="code" href="../../d8/d0/cmdat3_8c.html#a20">MmOverCommit</a>;
04672 
04673         <span class="comment">//</span>
04674         <span class="comment">// Keep commit limit above 20mb so we can boot with a small paging</span>
04675         <span class="comment">// file and clean things up.</span>
04676         <span class="comment">//</span>
04677 
04678         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> &lt; 5500) {
04679             <a class="code" href="../../d6/d3/modwrite_8c.html#a18">MmOverCommit2</a> = 5500 - <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a>;
04680             <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> = 5500;
04681         }
04682 
04683         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a> &lt; 5500) {
04684             <a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a>;
04685         }
04686 
04687     } <span class="keywordflow">else</span> {
04688 
04689         <span class="comment">//</span>
04690         <span class="comment">// Balance overcommitment in the case an extension was granted.</span>
04691         <span class="comment">//</span>
04692 
04693         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/modwrite_8c.html#a18">MmOverCommit2</a> &gt; <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a> - 1]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a>) {
04694             <a class="code" href="../../d6/d3/modwrite_8c.html#a18">MmOverCommit2</a> -= <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a> - 1]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a>;
04695         } <span class="keywordflow">else</span> {
04696             <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> +=
04697               <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a> - 1]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> - <a class="code" href="../../d6/d3/modwrite_8c.html#a18">MmOverCommit2</a>;
04698             <a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a> +=
04699               <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a> - 1]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o1">MaximumSize</a> - <a class="code" href="../../d6/d3/modwrite_8c.html#a18">MmOverCommit2</a>;
04700             <a class="code" href="../../d6/d3/modwrite_8c.html#a18">MmOverCommit2</a> = 0;
04701         }
04702     }
04703 
04704     ExReleaseSpinLock (&amp;MmChargeCommitmentLock, OldIrql);
04705     <span class="keywordflow">return</span>;
04706 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a58" doxytag="modwrite.c::MiIssuePageExtendRequest" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL MiIssuePageExtendRequest           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html">PMMPAGE_FILE_EXPANSION</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PageExtend</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04911">4911</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02197">_MMDEREFERENCE_SEGMENT_HEADER::ListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02195">_MMDEREFERENCE_SEGMENT_HEADER::Lock</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04944">MmDereferenceSegmentHeader</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00213">MmOneSecond</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00214">MmTwentySeconds</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02196">_MMDEREFERENCE_SEGMENT_HEADER::Semaphore</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00191">MiChargeCommitment()</a>, and <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00297">NtCreatePagingFile()</a>.
<p>
<pre class="fragment"><div>04917                    :
04918 
04919     Queue a message to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> segment dereferencing / pagefile extending
04920     thread to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> can be extended.  Extension <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done
04921     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context of a system thread due to mutexes which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current
04922     thread may be holding.
04923     
04924 Arguments:
04925 
04926     PageExtend - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a> request.
04927 
04928 Return Value:
04929 
04930     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request completed.  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request timed
04931     <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> and was removed.
04932 
04933 Environment:
04934 
04935     Kernel mode.  No locks held.  APC level or less.
04936 
04937 --*/
04938 
04939 {
04940     KIRQL OldIrql;
04941     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04942     PLIST_ENTRY NextEntry;
04943 
04944     ExAcquireFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o0">Lock</a>, &amp;OldIrql);
04945     InsertTailList ( &amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o2">ListHead</a>,
04946                      &amp;PageExtend-&gt;DereferenceList);
04947     ExReleaseFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o0">Lock</a>, OldIrql);
04948 
04949     <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o1">Semaphore</a>,
04950                         0L,
04951                         1L,
04952                         TRUE);
04953 
04954     <span class="comment">//</span>
04955     <span class="comment">// Wait for the thread to extend the paging file.</span>
04956     <span class="comment">//</span>
04957 
04958     status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;PageExtend-&gt;Event,
04959                                     Executive,
04960                                     KernelMode,
04961                                     FALSE,
04962                                     (PageExtend-&gt;RequestedExpansionSize &lt; 10) ?
04963                                         &amp;MmOneSecond : &amp;MmTwentySeconds);
04964 
04965     <span class="keywordflow">if</span> (status == STATUS_TIMEOUT) {
04966 
04967         <span class="comment">//</span>
04968         <span class="comment">// The wait has timed out, if this request has not</span>
04969         <span class="comment">// been processed, remove it from the list and check</span>
04970         <span class="comment">// to see if we should allow this request to succeed.</span>
04971         <span class="comment">// This prevents a deadlock between the file system</span>
04972         <span class="comment">// trying to allocate memory in the FSP and the</span>
04973         <span class="comment">// segment dereferencing thread trying to close a</span>
04974         <span class="comment">// file object, and waiting in the file system.</span>
04975         <span class="comment">//</span>
04976 
04977         KdPrint((<span class="stringliteral">"MiIssuePageExtendRequest: wait timed out, page-extend= %lx, quota = %lx\n"</span>,
04978                    PageExtend, PageExtend-&gt;RequestedExpansionSize));
04979 
04980         ExAcquireFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o0">Lock</a>, &amp;OldIrql);
04981 
04982         NextEntry = <a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o2">ListHead</a>.Flink;
04983 
04984         <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o2">ListHead</a>) {
04985 
04986             <span class="comment">//</span>
04987             <span class="comment">// Check to see if this is the entry we are waiting for.</span>
04988             <span class="comment">//</span>
04989 
04990             <span class="keywordflow">if</span> (NextEntry == &amp;PageExtend-&gt;DereferenceList) {
04991 
04992                 <span class="comment">//</span>
04993                 <span class="comment">// Remove this entry.</span>
04994                 <span class="comment">//</span>
04995 
04996                 RemoveEntryList (&amp;PageExtend-&gt;DereferenceList);
04997                 ExReleaseFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o0">Lock</a>, OldIrql);
04998                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04999             }
05000             NextEntry = NextEntry-&gt;Flink;
05001         }
05002 
05003         ExReleaseFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o0">Lock</a>, OldIrql);
05004 
05005         <span class="comment">//</span>
05006         <span class="comment">// Entry is being processed, wait for completion.</span>
05007         <span class="comment">//</span>
05008 
05009         KdPrint ((<span class="stringliteral">"MiIssuePageExtendRequest: rewaiting...\n"</span>));
05010 
05011         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;PageExtend-&gt;Event,
05012                                Executive,
05013                                KernelMode,
05014                                FALSE,
05015                                NULL);
05016     }
05017 
05018     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05019 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a59" doxytag="modwrite.c::MiIssuePageExtendRequestNoWait" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiIssuePageExtendRequestNoWait           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PFN_NUMBER&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>SizeInPages</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l05023">5023</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02211">_MMPAGE_FILE_EXPANSION::DereferenceList</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02215">_MMPAGE_FILE_EXPANSION::InProgress</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02197">_MMDEREFERENCE_SEGMENT_HEADER::ListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02195">_MMDEREFERENCE_SEGMENT_HEADER::Lock</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05073">MmAttemptForCantExtend</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04899">MmChargeCommitmentLock</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04944">MmDereferenceSegmentHeader</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00045">ONEMB_IN_PAGES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02212">_MMPAGE_FILE_EXPANSION::RequestedExpansionSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02196">_MMDEREFERENCE_SEGMENT_HEADER::Semaphore</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00807">MiAllocatePoolPages()</a>, and <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00589">MmResourcesAvailable()</a>.
<p>
<pre class="fragment"><div>05029                    :
05030 
05031     Queue a message to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> segment dereferencing / pagefile extending
05032     thread to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> can be extended.  Extension <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done
05033     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context of a system thread due to mutexes which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current
05034     thread may be holding.
05035     
05036 Arguments:
05037 
05038     SizeInPages - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size in pages to increase <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page <a class="code" href="../../d7/d1/genuedef_8c.html#a9">file</a>(s) by.
05039                   This is rounded up to a 1MB multiple by this routine.
05040 
05041 Return Value:
05042 
05043     TRUE indicates the request completed.  FALSE indicates the request timed
05044     out and was removed.
05045 
05046 Environment:
05047 
05048     Kernel mode.  No locks held.  APC level or less.
05049 
05050     Note this routine must be very careful to not use any paged
05051     pool as the only reason it is being called is because pool is depleted.
05052 
05053 --*/
05054 
05055 {
05056     KIRQL OldIrql;
05057     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05058     PLIST_ENTRY NextEntry;
05059 
05060     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() &lt; DISPATCH_LEVEL);
05061 
05062     ExAcquireFastLock (&amp;MmChargeCommitmentLock, &amp;OldIrql);
05063 
05064     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a711">MmAttemptForCantExtend</a>.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o5">InProgress</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
05065 
05066         <span class="comment">//</span>
05067         <span class="comment">// An expansion request is already in progress, assume</span>
05068         <span class="comment">// it will help enough (another can always be issued later) and</span>
05069         <span class="comment">// that it will succeed.</span>
05070         <span class="comment">//</span>
05071 
05072         ExReleaseFastLock (&amp;MmChargeCommitmentLock, OldIrql);
05073         <span class="keywordflow">return</span>;
05074     }
05075 
05076     <a class="code" href="../../d4/d8/mi_8h.html#a711">MmAttemptForCantExtend</a>.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o5">InProgress</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05077     ExReleaseFastLock (&amp;MmChargeCommitmentLock, OldIrql);
05078 
05079     SizeInPages = (SizeInPages + <a class="code" href="../../d6/d3/modwrite_8c.html#a0">ONEMB_IN_PAGES</a> - 1) &amp; ~(<a class="code" href="../../d6/d3/modwrite_8c.html#a0">ONEMB_IN_PAGES</a> - 1);
05080 
05081     <a class="code" href="../../d4/d8/mi_8h.html#a711">MmAttemptForCantExtend</a>.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o2">RequestedExpansionSize</a> = SizeInPages;
05082 
05083     ExAcquireFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o0">Lock</a>, &amp;OldIrql);
05084 
05085     InsertTailList ( &amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o2">ListHead</a>,
05086                      &amp;<a class="code" href="../../d4/d8/mi_8h.html#a711">MmAttemptForCantExtend</a>.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o1">DereferenceList</a>);
05087 
05088     ExReleaseFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o0">Lock</a>, OldIrql);
05089 
05090     <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o1">Semaphore</a>,
05091                         0L,
05092                         1L,
05093                         FALSE);
05094 
05095     <span class="keywordflow">return</span>;
05096 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a53" doxytag="modwrite.c::MiMappedPageWriter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiMappedPageWriter           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>StartContext</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04239">4239</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02540">_MMMOD_WRITER_MDL_ENTRY::ControlArea</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02539">_MMMOD_WRITER_MDL_ENTRY::File</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02541">_MMMOD_WRITER_MDL_ENTRY::FileResource</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l02064">FsRtlAcquireFileForModWrite()</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00465">FsRtlSetTopLevelIrpForModWriter</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00934">IoAsynchronousPageWrite()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02531">_MMMOD_WRITER_MDL_ENTRY::IoStatus</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l10957">IoSynchronousPageWrite()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01838">KeSetPriorityThread()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02542">_MMMOD_WRITER_MDL_ENTRY::Mdl</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02234">MiWriteComplete()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00090">MmMappedPageWriterEvent</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00088">MmMappedPageWriterList</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00048">NT_ERROR</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">_MMMOD_WRITER_MDL_ENTRY::u</a>, <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html#o10">_CONTROL_AREA::u</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02529">_MMMOD_WRITER_MDL_ENTRY::WriteOffset</a>, and <a class="el" href="../../d4/d9/ke_8h.html#a407a216">WrVirtualMemory</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02669">MiModifiedPageWriter()</a>.
<p>
<pre class="fragment"><div>04245                    :
04246 
04247     Implements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NT secondary modified page writer thread.
04248     Requests <span class="keywordflow">for</span> writes to mapped files are sent to <span class="keyword">this</span> thread.
04249     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> writing of mapped <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> pages could cause
04250     page faults resulting in requests <span class="keywordflow">for</span> free pages.  But there
04251     could be no free pages - hence a dead lock.  Rather than deadlock
04252     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> whole system waiting on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> modified page writer, creating
04253     a secondary thread allows that thread to block without affecting
04254     on going page <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> writes.
04255 
04256 Arguments:
04257 
04258     StartContext - not used.
04259 
04260 Return Value:
04261 
04262     None.
04263 
04264 Environment:
04265 
04266     Kernel mode.
04267 
04268 --*/
04269 
04270 {
04271     <a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">PMMMOD_WRITER_MDL_ENTRY</a> ModWriterEntry;
04272     KIRQL OldIrql = 0;
04273     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04274     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> TempEvent;
04275 
04276     UNREFERENCED_PARAMETER (StartContext);
04277 
04278     <span class="comment">//</span>
04279     <span class="comment">// Make this a real time thread.</span>
04280     <span class="comment">//</span>
04281 
04282     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d9/d1/thredobj_8c.html#a24">KeSetPriorityThread</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Tcb,
04283                                 LOW_REALTIME_PRIORITY + 1);
04284 
04285     <span class="comment">//</span>
04286     <span class="comment">// Let the file system know that we are getting resources.</span>
04287     <span class="comment">//</span>
04288 
04289     <a class="code" href="../../d1/d8/fsrtl_8h.html#a17">FsRtlSetTopLevelIrpForModWriter</a>();
04290 
04291     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;TempEvent, NotificationEvent, FALSE);
04292 
04293     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
04294         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;MmMappedPageWriterEvent,
04295                                WrVirtualMemory,
04296                                KernelMode,
04297                                FALSE,
04298                                (PLARGE_INTEGER)NULL);
04299 
04300         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
04301         <span class="keywordflow">if</span> (IsListEmpty (&amp;MmMappedPageWriterList)) {
04302             <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;MmMappedPageWriterEvent);
04303             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04304         } <span class="keywordflow">else</span> {
04305 
04306             ModWriterEntry = (<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">PMMMOD_WRITER_MDL_ENTRY</a>)RemoveHeadList (
04307                                                 &amp;MmMappedPageWriterList);
04308 
04309             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04310 
04311 
04312             <span class="keywordflow">if</span> (ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o11">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.FailAllIo == 1) {
04313                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
04314 
04315             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a103">FsRtlAcquireFileForModWrite</a> (ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o10">File</a>,
04316                                                     &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.LastByte,
04317                                                     &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o12">FileResource</a>)) {
04318 
04319                 <span class="comment">//</span>
04320                 <span class="comment">// Issue the write request.</span>
04321                 <span class="comment">//</span>
04322 
04323                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a20">IoAsynchronousPageWrite</a> (
04324                                        ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o10">File</a>,
04325                                        &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>,
04326                                        &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o1">WriteOffset</a>,
04327                                        MiWriteComplete,
04328                                        (PVOID)ModWriterEntry,
04329                                        &amp;ModWriterEntry-&gt;u.IoStatus,
04330                                        &amp;ModWriterEntry-&gt;Irp );
04331             } <span class="keywordflow">else</span> {
04332 
04333                 <span class="comment">//</span>
04334                 <span class="comment">// Unable to get the file system resources, set error status</span>
04335                 <span class="comment">// to lock conflict (ignored by MiWriteComplete) so the APC</span>
04336                 <span class="comment">// routine is explicitly called.</span>
04337                 <span class="comment">//</span>
04338 
04339                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_FILE_LOCK_CONFLICT;
04340             }
04341 
04342             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>(Status)) {
04343 
04344                 <span class="comment">//</span>
04345                 <span class="comment">// An error has occurred, disable APC's and</span>
04346                 <span class="comment">// call the write completion routine.</span>
04347                 <span class="comment">//</span>
04348 
04349                 ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.IoStatus.Status = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04350                 ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.IoStatus.Information = 0;
04351                 <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (APC_LEVEL, &amp;OldIrql);
04352                 <a class="code" href="../../d6/d3/modwrite_8c.html#a49">MiWriteComplete</a> ((PVOID)ModWriterEntry,
04353                                  &amp;ModWriterEntry-&gt;u.IoStatus,
04354                                  0 );
04355                 <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
04356             }
04357 <span class="preprocessor">#if 0</span>
04358 <span class="preprocessor"></span>    <span class="comment">//TEMPORARY code to use synchronous I/O here.</span>
04359 
04360             <span class="comment">//</span>
04361             <span class="comment">// Issue the write request.</span>
04362             <span class="comment">//</span>
04363 
04364             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a116">IoSynchronousPageWrite</a> (
04365                                    ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o10">File</a>,
04366                                    &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>,
04367                                    &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o1">WriteOffset</a>,
04368                                    &amp;TempEvent,
04369                                    &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.IoStatus );
04370 
04371             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>(Status)) {
04372                 ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.IoStatus.Status = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04373                 ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.IoStatus.Information = 0;
04374             }
04375 
04376             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>(ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.IoStatus.Status)) {
04377                 KdPrint((<span class="stringliteral">"MM MODWRITE: modified page write failed %lx\n"</span>, Status));
04378             }
04379 
04380             <span class="comment">//</span>
04381             <span class="comment">// Call the write completion routine.</span>
04382             <span class="comment">//</span>
04383 
04384             <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (APC_LEVEL, &amp;OldIrql);
04385             <a class="code" href="../../d6/d3/modwrite_8c.html#a49">MiWriteComplete</a> ((PVOID)ModWriterEntry,
04386                              &amp;ModWriterEntry-&gt;IoStatus,
04387                              0 );
04388             <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
04389 <span class="preprocessor">#endif //0</span>
04390 <span class="preprocessor"></span>
04391         }
04392 
04393     }
04394 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a51" doxytag="modwrite.c::MiModifiedPageWriter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiModifiedPageWriter           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>StartContext</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02669">2669</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l02524">_MMMOD_WRITER_LISTHEAD::Event</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01838">KeSetPriorityThread()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02528">_MMMOD_WRITER_MDL_ENTRY::Links</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02523">_MMMOD_WRITER_LISTHEAD::ListHead</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04239">MiMappedPageWriter()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02831">MiModifiedPageWriterWorker()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05085">MM_MAPPED_FILE_MDLS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05090">MmFreePagingSpaceLow</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05081">MmMappedFileHeader</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05088">MmMappedFileMdl</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00090">MmMappedPageWriterEvent</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00088">MmMappedPageWriterList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05126">MmModifiedWriteClusterSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05079">MmPagingFileHeader</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00094">MmSystemShutdown</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02538">_MMMOD_WRITER_MDL_ENTRY::PagingFile</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02536">_MMMOD_WRITER_MDL_ENTRY::PagingListHead</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00175">PsCreateSystemThread()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00138">ThreadHandle</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>.
<p>
<pre class="fragment"><div>02675                    :
02676 
02677     Implements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NT modified page writer thread.  When <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> modified
02678     page threshold <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> reached, or memory becomes overcommitted <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02679     modified page writer event <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set, and <span class="keyword">this</span> thread becomes active.
02680 
02681 Arguments:
02682 
02683     StartContext - not used.
02684 
02685 Return Value:
02686 
02687     None.
02688 
02689 Environment:
02690 
02691     Kernel mode.
02692 
02693 --*/
02694 
02695 {
02696     HANDLE <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>;
02697     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
02698     ULONG i;
02699 
02700     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02701 
02702     StartContext;  <span class="comment">//avoid compiler warning.</span>
02703 
02704     <span class="comment">//</span>
02705     <span class="comment">// Initialize listheads as empty.</span>
02706     <span class="comment">//</span>
02707 
02708     <a class="code" href="../../d6/d3/modwrite_8c.html#a17">MmSystemShutdown</a> = 0;
02709     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o1">Event</a>, NotificationEvent, FALSE);
02710     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a713">MmMappedFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o1">Event</a>, NotificationEvent, FALSE);
02711 
02712     InitializeListHead(&amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>);
02713     InitializeListHead(&amp;<a class="code" href="../../d4/d8/mi_8h.html#a713">MmMappedFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>);
02714     InitializeListHead(&amp;MmFreePagingSpaceLow);
02715 
02716     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d4/d8/mi_8h.html#a331">MM_MAPPED_FILE_MDLS</a>; i += 1) {
02717         <a class="code" href="../../d4/d8/mi_8h.html#a715">MmMappedFileMdl</a>[i] = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPoolMustSucceed,
02718                                              <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">MMMOD_WRITER_MDL_ENTRY</a>) +
02719                                                 MmModifiedWriteClusterSize *
02720                                                     <span class="keyword">sizeof</span>(PFN_NUMBER),
02721                                                 '  mM');
02722 
02723         <a class="code" href="../../d4/d8/mi_8h.html#a715">MmMappedFileMdl</a>[i]-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o9">PagingFile</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02724         <a class="code" href="../../d4/d8/mi_8h.html#a715">MmMappedFileMdl</a>[i]-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o7">PagingListHead</a> = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a713">MmMappedFileHeader</a>;
02725 
02726         InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a713">MmMappedFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>,
02727                         &amp;MmMappedFileMdl[i]-&gt;Links);
02728     }
02729 
02730     <span class="comment">//</span>
02731     <span class="comment">// Make this a real time thread.</span>
02732     <span class="comment">//</span>
02733 
02734     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d9/d1/thredobj_8c.html#a24">KeSetPriorityThread</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Tcb,
02735                                 LOW_REALTIME_PRIORITY + 1);
02736 
02737     <span class="comment">//</span>
02738     <span class="comment">// Start a secondary thread for writing mapped file pages.  This</span>
02739     <span class="comment">// is required as the writing of mapped file pages could cause</span>
02740     <span class="comment">// page faults resulting in requests for free pages.  But there</span>
02741     <span class="comment">// could be no free pages - hence a dead lock.  Rather than deadlock</span>
02742     <span class="comment">// the whole system waiting on the modified page writer, creating</span>
02743     <span class="comment">// a secondary thread allows that thread to block without affecting</span>
02744     <span class="comment">// on going page file writes.</span>
02745     <span class="comment">//</span>
02746 
02747     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;MmMappedPageWriterEvent, NotificationEvent, FALSE);
02748     InitializeListHead(&amp;MmMappedPageWriterList);
02749     InitializeObjectAttributes( &amp;ObjectAttributes, NULL, 0, NULL, NULL );
02750 
02751     <a class="code" href="../../d2/d8/ps_2create_8c.html#a11">PsCreateSystemThread</a> (&amp;ThreadHandle,
02752                           THREAD_ALL_ACCESS,
02753                           &amp;ObjectAttributes,
02754                           0L,
02755                           NULL,
02756                           MiMappedPageWriter,
02757                           NULL );
02758     ZwClose (ThreadHandle);
02759     <a class="code" href="../../d6/d3/modwrite_8c.html#a39">MiModifiedPageWriterWorker</a>();
02760 
02761     <span class="comment">//</span>
02762     <span class="comment">// Shutdown in progress, wait forever.</span>
02763     <span class="comment">//</span>
02764 
02765     {
02766         LARGE_INTEGER Forever;
02767 
02768         <span class="comment">//</span>
02769         <span class="comment">// System has shutdown, go into LONG wait.</span>
02770         <span class="comment">//</span>
02771 
02772         Forever.LowPart = 0;
02773         Forever.HighPart = 0xF000000;
02774         <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (KernelMode, FALSE, &amp;Forever);
02775     }
02776 
02777     <span class="keywordflow">return</span>;
02778 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a52" doxytag="modwrite.c::MiModifiedPageWriterTimerDispatch" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiModifiedPageWriterTimerDispatch           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d6/struct__KDPC.html">PKDPC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Dpc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DeferredContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02782">2782</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05138">MiMappedPagesTooOldEvent</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05136">MiTimerPending</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>.
<p>
<pre class="fragment"><div>02791                    :
02792 
02793     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> executed whenever modified mapped pages are waiting to
02794     be written.  Its job <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to signal <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Modified Page <a class="code" href="../../d4/d0/tex_8c.html#a44">Writer</a> to write
02795     these <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>.
02796 
02797 Arguments:
02798 
02799     Dpc - Supplies a pointer to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> DPC.
02800 
02801     DeferredContext - Optional deferred context;  not used.
02802 
02803     SystemArgument1 - Optional argument 1;  not used.
02804 
02805     SystemArgument2 - Optional argument 2;  not used.
02806 
02807 Return Value:
02808 
02809     None.
02810 
02811 --*/
02812 
02813 {
02814     KIRQL OldIrql;
02815 
02816     UNREFERENCED_PARAMETER (Dpc);
02817     UNREFERENCED_PARAMETER (DeferredContext);
02818     UNREFERENCED_PARAMETER (SystemArgument1);
02819     UNREFERENCED_PARAMETER (SystemArgument2);
02820 
02821     <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
02822 
02823     <a class="code" href="../../d4/d8/mi_8h.html#a735">MiTimerPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02824     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;MiMappedPagesTooOldEvent, 0, FALSE);
02825 
02826     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
02827 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="modwrite.c::MiModifiedPageWriterWorker" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiModifiedPageWriterWorker           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02831">2831</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02114">_SUBSECTION::ControlArea</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02524">_MMMOD_WRITER_LISTHEAD::Event</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01081">_MMPFNLIST::Flink</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02564">_MMPAGING_FILE::HintSetToZero</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00285">KeSetTimerEx()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00395">KeWaitForMultipleObjects()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02523">_MMMOD_WRITER_LISTHEAD::ListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d6/d3/modwrite_8c.html#a60a27">MappedPagesNeedWriting</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01227">MI_GET_MODIFIED_PAGE_ANY_COLOR</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00043">MiFirstPageFileCreatedAndReady</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l03198">MiGatherMappedPages()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l03701">MiGatherPagefilePages()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01559">MiGetSubsectionAddress</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00059">MiInsertPageInList()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05138">MiMappedPagesTooOldEvent</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05134">MiModifiedPageLife</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05142">MiModifiedPageWriterTimer</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05140">MiModifiedPageWriterTimerDpc</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05136">MiTimerPending</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00667">MiUnlinkPageFromList()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00217">Mm30Milliseconds</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00107">MM_EMPTY_LIST</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05120">MmFreeGoal</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05081">MmMappedFileHeader</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00084">MmModifiedNoWritePageListHead</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01087">MmModifiedPageListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05096">MmModifiedPageWriterEvent</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04575">MmModNoWriteInsert</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04486">MmMoreThanEnoughFreePages</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00056">MmNumberOfPagingFiles</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05083">MmPagingFile</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05079">MmPagingFileHeader</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00215">MmShortTime</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00094">MmSystemShutdown</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00123">MmTotalPagesForPagingFile</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00042">MmWriteAllModifiedPages</a>, <a class="el" href="../../d6/d3/modwrite_8c.html#a60a28">ModifiedWriterMaximumObject</a>, <a class="el" href="../../d6/d3/modwrite_8c.html#a60a26">NormalCase</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01079">_MMPFNLIST::Total</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html#o10">_CONTROL_AREA::u</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a407a206">WrFreePage</a>, and <a class="el" href="../../d4/d9/ke_8h.html#a407a217">WrPageOut</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02669">MiModifiedPageWriter()</a>.
<p>
<pre class="fragment"><div>02837                    :
02838 
02839     Implements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NT modified page writer thread.  When <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> modified
02840     page threshold <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> reached, or memory becomes overcommitted <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02841     modified page writer event <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set, and <span class="keyword">this</span> thread becomes active.
02842 
02843 Arguments:
02844 
02845     None.
02846 
02847 Return Value:
02848 
02849     None.
02850 
02851 Environment:
02852 
02853     Kernel mode.
02854 
02855 --*/
02856 
02857 {
02858     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
02859     PFN_NUMBER PageFrameIndex;
02860     KIRQL OldIrql;
02861     ULONG NextColor;
02862     ULONG i;
02863     <span class="keyword">static</span> <a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">KWAIT_BLOCK</a> WaitBlockArray[<a class="code" href="../../d6/d3/modwrite_8c.html#a60a28">ModifiedWriterMaximumObject</a>];
02864     PVOID WaitObjects[<a class="code" href="../../d6/d3/modwrite_8c.html#a60a28">ModifiedWriterMaximumObject</a>];
02865     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> WakeupStatus;
02866 
02867     <span class="comment">//</span>
02868     <span class="comment">// Wait for the modified page writer event or the mapped pages event.</span>
02869     <span class="comment">//</span>
02870 
02871     WaitObjects[<a class="code" href="../../d6/d3/modwrite_8c.html#a60a26">NormalCase</a>] = (PVOID)&amp;<a class="code" href="../../d4/d8/mi_8h.html#a719">MmModifiedPageWriterEvent</a>;
02872     WaitObjects[<a class="code" href="../../d6/d3/modwrite_8c.html#a60a27">MappedPagesNeedWriting</a>] = (PVOID)&amp;<a class="code" href="../../d4/d8/mi_8h.html#a736">MiMappedPagesTooOldEvent</a>;
02873 
02874     <span class="keywordflow">for</span> (;;) {
02875 
02876         WakeupStatus = <a class="code" href="../../d1/d7/wait_8c.html#a3">KeWaitForMultipleObjects</a>(ModifiedWriterMaximumObject,
02877                                           &amp;WaitObjects[0],
02878                                           WaitAny,
02879                                           WrFreePage,
02880                                           KernelMode,
02881                                           FALSE,
02882                                           NULL,
02883                                           &amp;WaitBlockArray[0]);
02884 
02885         <span class="comment">//</span>
02886         <span class="comment">// Switch on the wait status.</span>
02887         <span class="comment">//</span>
02888 
02889         <span class="keywordflow">switch</span> (WakeupStatus) {
02890 
02891         <span class="keywordflow">case</span> <a class="code" href="../../d6/d3/modwrite_8c.html#a60a26">NormalCase</a>:
02892                 <span class="keywordflow">break</span>;
02893 
02894         <span class="keywordflow">case</span> <a class="code" href="../../d6/d3/modwrite_8c.html#a60a27">MappedPagesNeedWriting</a>:
02895 
02896                 <span class="comment">//</span>
02897                 <span class="comment">// Our mapped pages DPC went off, only deal with those pages.</span>
02898                 <span class="comment">// Write all the mapped pages (ONLY), then clear the flag</span>
02899                 <span class="comment">// and come back to the top.</span>
02900                 <span class="comment">//</span>
02901 
02902                 <span class="keywordflow">break</span>;
02903 
02904         <span class="keywordflow">default</span>:
02905                 <span class="keywordflow">break</span>;
02906 
02907         }
02908 
02909         <span class="comment">//</span>
02910         <span class="comment">// Indicate that the hint values have not been reset in</span>
02911         <span class="comment">// the paging files.</span>
02912         <span class="comment">//</span>
02913 
02914         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a> != 0) {
02915             i = 0;
02916             <span class="keywordflow">do</span> {
02917                 <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o14">HintSetToZero</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02918                 i += 1;
02919             } <span class="keywordflow">while</span> (i &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>);
02920         }
02921 
02922         NextColor = 0;
02923 
02924         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02925 
02926         <span class="keywordflow">for</span> (;;) {
02927 
02928             <span class="comment">//</span>
02929             <span class="comment">// Modified page writer was signalled.</span>
02930             <span class="comment">//</span>
02931 
02932             <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a727">MmFreeGoal</a>) &amp;&amp;
02933                 (<a class="code" href="../../d4/d8/mi_8h.html#a608">MmModNoWriteInsert</a>)) {
02934 
02935                 <span class="comment">//</span>
02936                 <span class="comment">// Remove pages from the modified no write list</span>
02937                 <span class="comment">// that are waiting for the cache manager to flush them.</span>
02938                 <span class="comment">//</span>
02939 
02940                 i = 0;
02941                 <span class="keywordflow">while</span> ((<a class="code" href="../../d8/d5/kddata_8c.html#a40">MmModifiedNoWritePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> != 0) &amp;&amp;
02942                       (i &lt; 32)) {
02943                     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
02944                     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
02945 
02946                     PageFrameIndex = <a class="code" href="../../d8/d5/kddata_8c.html#a40">MmModifiedNoWritePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a>;
02947                     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
02948                     Subsection = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a148">MiGetSubsectionAddress</a> (&amp;Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
02949                     ControlArea = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a>;
02950                     <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.NoModifiedWriting) {
02951                         <a class="code" href="../../d4/d8/mi_8h.html#a608">MmModNoWriteInsert</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02952                         <span class="keywordflow">break</span>;
02953                     }
02954                     <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
02955                     <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (&amp;MmModifiedPageListHead,
02956                                         PageFrameIndex);
02957                     i += 1;
02958                 }
02959             }
02960 
02961             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> == 0) {
02962 
02963                 <span class="comment">//</span>
02964                 <span class="comment">// No more pages, clear the event(s) and wait again...</span>
02965                 <span class="comment">// Note we can clear both events regardless of why we woke up</span>
02966                 <span class="comment">// since no modified pages of any type exist.</span>
02967                 <span class="comment">//</span>
02968 
02969                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a735">MiTimerPending</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02970                     <a class="code" href="../../d4/d8/mi_8h.html#a735">MiTimerPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02971                     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;MiMappedPagesTooOldEvent);
02972                 }
02973 
02974                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02975 
02976                 <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;MmModifiedPageWriterEvent);
02977 
02978                 <span class="keywordflow">break</span>;
02979             }
02980 
02981             <span class="comment">//</span>
02982             <span class="comment">// If we didn't wake up explicitly to deal with mapped pages,</span>
02983             <span class="comment">// then determine which type of pages are the most popular:</span>
02984             <span class="comment">// page file backed pages, or mapped file backed pages.</span>
02985             <span class="comment">//</span>
02986 
02987             <span class="keywordflow">if</span> (WakeupStatus == <a class="code" href="../../d6/d3/modwrite_8c.html#a60a27">MappedPagesNeedWriting</a>) {
02988                 PageFrameIndex = <a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a>;
02989                 <span class="keywordflow">if</span> (PageFrameIndex == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
02990 
02991                     <span class="comment">//</span>
02992                     <span class="comment">// No more modified mapped pages (there may still be</span>
02993                     <span class="comment">// modified pagefile-destined pages), so clear only the</span>
02994                     <span class="comment">// mapped pages event and check for directions at the top</span>
02995                     <span class="comment">// again.</span>
02996                     <span class="comment">//</span>
02997 
02998                     <a class="code" href="../../d4/d8/mi_8h.html#a735">MiTimerPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02999                     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;MiMappedPagesTooOldEvent);
03000 
03001                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03002 
03003                     <span class="keywordflow">break</span>;
03004                 }
03005             }
03006             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d2/datalpha_8c.html#a23">MmTotalPagesForPagingFile</a> &gt;=
03007                 (<a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> - <a class="code" href="../../d4/d2/datalpha_8c.html#a23">MmTotalPagesForPagingFile</a>)) {
03008 
03009                 <span class="comment">//</span>
03010                 <span class="comment">// More pages are destined for the paging file.</span>
03011                 <span class="comment">//</span>
03012 
03013                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a134">MI_GET_MODIFIED_PAGE_ANY_COLOR</a> (PageFrameIndex, NextColor);
03014 
03015             } <span class="keywordflow">else</span> {
03016 
03017                 <span class="comment">//</span>
03018                 <span class="comment">// More pages are destined for mapped files.</span>
03019                 <span class="comment">//</span>
03020 
03021                 PageFrameIndex = <a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a>;
03022             }
03023 
03024             <span class="comment">//</span>
03025             <span class="comment">// Check to see what type of page (section file backed or page</span>
03026             <span class="comment">// file backed) and write out that page and more if possible.</span>
03027             <span class="comment">//</span>
03028 
03029             <span class="comment">//</span>
03030             <span class="comment">// Check to see if this page is destined for a paging file or</span>
03031             <span class="comment">// a mapped file.</span>
03032             <span class="comment">//</span>
03033 
03034             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
03035 
03036             <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1) {
03037                 <span class="keywordflow">if</span> (IsListEmpty (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a713">MmMappedFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>)) {
03038 
03039                     <span class="comment">//</span>
03040                     <span class="comment">// Make sure page is destined for paging file as there</span>
03041                     <span class="comment">// are no MDLs for mapped writes free.</span>
03042                     <span class="comment">//</span>
03043 
03044                     <span class="keywordflow">if</span> (WakeupStatus != <a class="code" href="../../d6/d3/modwrite_8c.html#a60a27">MappedPagesNeedWriting</a>) {
03045 
03046                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a134">MI_GET_MODIFIED_PAGE_ANY_COLOR</a> (PageFrameIndex, NextColor);
03047 
03048                         <span class="comment">//</span>
03049                         <span class="comment">// No pages are destined for the paging file, get the</span>
03050                         <span class="comment">// first page destined for a mapped file.</span>
03051                         <span class="comment">//</span>
03052 
03053                         <span class="keywordflow">if</span> (PageFrameIndex == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
03054 
03055                             <span class="comment">//</span>
03056                             <span class="comment">// Select the first page from the list anyway.</span>
03057                             <span class="comment">//</span>
03058 
03059                             PageFrameIndex = <a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a>;
03060                         }
03061 
03062                         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
03063                     }
03064                 }
03065             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((IsListEmpty(&amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>)) ||
03066                        (<a class="code" href="../../d6/d3/modwrite_8c.html#a10">MiFirstPageFileCreatedAndReady</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
03067 
03068                 <span class="comment">//</span>
03069                 <span class="comment">// Try for a dirty section-backed page as no paging file MDLs</span>
03070                 <span class="comment">// are available.</span>
03071                 <span class="comment">//</span>
03072 
03073                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a> != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
03074                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MmTotalPagesForPagingFile != <a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a>);
03075                     PageFrameIndex = <a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a>;
03076                     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
03077                 }
03078                 <span class="keywordflow">else</span> {
03079                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MmTotalPagesForPagingFile == <a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a>);
03080                     <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d3/modwrite_8c.html#a10">MiFirstPageFileCreatedAndReady</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
03081                         (<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a> != 0)) {
03082 
03083                         <span class="comment">//</span>
03084                         <span class="comment">// The first paging has been created but the reservation</span>
03085                         <span class="comment">// checking for crashdumps has not finished yet.  Delay</span>
03086                         <span class="comment">// a bit as this will finish shortly and then restart.</span>
03087                         <span class="comment">//</span>
03088 
03089                         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03090                         <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (KernelMode, FALSE, &amp;MmShortTime);
03091                         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03092                         <span class="keywordflow">continue</span>;
03093                     }
03094                 }
03095             }
03096 
03097             <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1) {
03098 
03099                 <span class="keywordflow">if</span> (IsListEmpty(&amp;<a class="code" href="../../d4/d8/mi_8h.html#a713">MmMappedFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>)) {
03100 
03101                     <span class="keywordflow">if</span> (WakeupStatus == <a class="code" href="../../d6/d3/modwrite_8c.html#a60a27">MappedPagesNeedWriting</a>) {
03102 
03103                         <span class="comment">//</span>
03104                         <span class="comment">// Since we woke up only to take care of mapped pages,</span>
03105                         <span class="comment">// don't wait for an MDL below because drivers may take</span>
03106                         <span class="comment">// an inordinate amount of time processing the</span>
03107                         <span class="comment">// outstanding ones.  We might have to wait too long,</span>
03108                         <span class="comment">// resulting in the system running out of pages.</span>
03109                         <span class="comment">//</span>
03110 
03111                         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a735">MiTimerPending</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03112 
03113                             <span class="comment">//</span>
03114                             <span class="comment">// This should be normal case - the reason we must</span>
03115                             <span class="comment">// first check timer pending above is for the rare</span>
03116                             <span class="comment">// case - when this thread first ran for normal</span>
03117                             <span class="comment">// modified page processing and took</span>
03118                             <span class="comment">// care of all the pages including the mapped ones.</span>
03119                             <span class="comment">// Then this thread woke up again for the mapped</span>
03120                             <span class="comment">// reason and here we are.</span>
03121                             <span class="comment">//</span>
03122 
03123                             <a class="code" href="../../d4/d8/mi_8h.html#a735">MiTimerPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03124                             <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;MiMappedPagesTooOldEvent);
03125                         }
03126 
03127                         <a class="code" href="../../d4/d8/mi_8h.html#a735">MiTimerPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03128 
03129                         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d3/d2/timerobj_8c.html#a7">KeSetTimerEx</a>( &amp;MiModifiedPageWriterTimer, MiModifiedPageLife, 0, &amp;MiModifiedPageWriterTimerDpc );
03130                         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03131                         <span class="keywordflow">break</span>;
03132                     }
03133 
03134                     <span class="comment">//</span>
03135                     <span class="comment">// Reset the event indicating no mapped files in</span>
03136                     <span class="comment">// the list, drop the PFN lock and wait for an</span>
03137                     <span class="comment">// I/O operation to complete with a one second</span>
03138                     <span class="comment">// timeout.</span>
03139                     <span class="comment">//</span>
03140 
03141                     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a713">MmMappedFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o1">Event</a>);
03142 
03143                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03144                     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;<a class="code" href="../../d4/d8/mi_8h.html#a713">MmMappedFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o1">Event</a>,
03145                                            WrPageOut,
03146                                            KernelMode,
03147                                            FALSE,
03148                                            &amp;Mm30Milliseconds);
03149                     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03150 
03151                     <span class="comment">//</span>
03152                     <span class="comment">// Don't go on as the old PageFrameIndex at the</span>
03153                     <span class="comment">// top of the ModifiedList may have changed states.</span>
03154                     <span class="comment">//</span>
03155 
03156                     <span class="keywordflow">continue</span>;
03157                 }
03158 
03159                 <a class="code" href="../../d6/d3/modwrite_8c.html#a35">MiGatherMappedPages</a> (Pfn1, PageFrameIndex);
03160 
03161             } <span class="keywordflow">else</span> {
03162 
03163                 <a class="code" href="../../d6/d3/modwrite_8c.html#a36">MiGatherPagefilePages</a> (Pfn1, PageFrameIndex);
03164             }
03165 
03166             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/modwrite_8c.html#a17">MmSystemShutdown</a>) {
03167 
03168                 <span class="comment">//</span>
03169                 <span class="comment">// Shutdown has returned.  Stop the modified page writer.</span>
03170                 <span class="comment">//</span>
03171 
03172                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03173                 <span class="keywordflow">return</span>;
03174             }
03175 
03176             <span class="keywordflow">if</span> (WakeupStatus != <a class="code" href="../../d6/d3/modwrite_8c.html#a60a27">MappedPagesNeedWriting</a> &amp;&amp; !<a class="code" href="../../d6/d3/modwrite_8c.html#a9">MmWriteAllModifiedPages</a>) {
03177                 <span class="keywordflow">if</span> (((<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt; <a class="code" href="../../d4/d8/mi_8h.html#a727">MmFreeGoal</a>) &amp;&amp;
03178                         (<a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a727">MmFreeGoal</a>))
03179                          ||
03180                     (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt; <a class="code" href="../../d4/d8/mi_8h.html#a588">MmMoreThanEnoughFreePages</a>)) {
03181 
03182                     <span class="comment">//</span>
03183                     <span class="comment">// There are ample pages, clear the event and wait again...</span>
03184                     <span class="comment">//</span>
03185 
03186                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03187 
03188                     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;MmModifiedPageWriterEvent);
03189                     <span class="keywordflow">break</span>;
03190                 }
03191             }
03192         } <span class="comment">// end for</span>
03193 
03194     } <span class="comment">// end for</span>
03195 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a56" doxytag="modwrite.c::MiPageFileFull" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiPageFileFull           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04709">4709</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02553">_MMPAGING_FILE::FreeSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02551">_MMPAGING_FILE::MaximumSize</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00102">MI_PAGEFILE_FULL_CHARGE</a>, <a class="el" href="../../d6/d3/modwrite_8c.html#a38">MiCauseOverCommitPopup()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00329">MiChargeCommitmentCantExpand()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00104">MiPageFileFullCharge</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04262">MM_DBG_COMMIT_PAGEFILE_FULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00951">MM_PFN_LOCK_ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04899">MmChargeCommitmentLock</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00056">MmNumberOfPagingFiles</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00100">MmPageFileFullExtendCount</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00043">MmPageFileFullExtendPages</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00106">MmPageFileFullPopupShown</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05083">MmPagingFile</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00041">MmTotalCommitLimit</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00040">MmTotalCommittedPages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02550">_MMPAGING_FILE::Size</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l03701">MiGatherPagefilePages()</a>.
<p>
<pre class="fragment"><div>04714                    :
04715 
04716     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when no space can be found in a paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
04717     It looks through all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> paging files to see <span class="keywordflow">if</span> ample space <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
04718     available and <span class="keywordflow">if</span> not, tries to expand <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> paging files.
04719 
04720     If more than 90% of all paging files <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> commitment limit
04721     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> total and then 100 pages are added.
04722 
04723 Arguments:
04724 
04725     None.
04726 
04727 Return Value:
04728 
04729     None.
04730 
04731 --*/
04732 
04733 {
04734     ULONG i;
04735     PFN_NUMBER Total;
04736     PFN_NUMBER Free;
04737     KIRQL OldIrql;
04738     SIZE_T SizeToExpand;
04739 
04740     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
04741 
04742     Total = 0;
04743     Free = 0;
04744     OldIrql = 0;
04745 
04746     i = 0;
04747     <span class="keywordflow">do</span> {
04748         Total += <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a>;
04749         Free += <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a>;
04750         i += 1;
04751     } <span class="keywordflow">while</span> (i &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>);
04752 
04753     <span class="comment">//</span>
04754     <span class="comment">// Check to see if more than 90% of the total space has been used.</span>
04755     <span class="comment">//</span>
04756 
04757     <span class="keywordflow">if</span> (((Total &gt;&gt; 5) + (Total &gt;&gt; 4)) &gt;= Free) {
04758 
04759         <span class="comment">//</span>
04760         <span class="comment">// Try to expand the paging files.</span>
04761         <span class="comment">//</span>
04762 
04763         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04764 
04765         <span class="comment">//</span>
04766         <span class="comment">// Check commit limits and set the limit to what is now used.</span>
04767         <span class="comment">// If all the pagefiles are already at their maximums, then don't</span>
04768         <span class="comment">// make things worse by setting commit to the maximum - this gives</span>
04769         <span class="comment">// systems with lots of memory a longer lease on life when they have</span>
04770         <span class="comment">// small pagefiles.</span>
04771         <span class="comment">//</span>
04772 
04773         SizeToExpand = 0;
04774         i = 0;
04775 
04776         ExAcquireSpinLock (&amp;MmChargeCommitmentLock, &amp;OldIrql);
04777 
04778         <span class="keywordflow">do</span> {
04779             SizeToExpand += <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o1">MaximumSize</a> - <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a>;
04780             i += 1;
04781         } <span class="keywordflow">while</span> (i &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>);
04782     
04783         <span class="keywordflow">if</span> (SizeToExpand == 0) {
04784             ExReleaseSpinLock (&amp;MmChargeCommitmentLock, OldIrql);
04785 
04786             <span class="comment">//</span>
04787             <span class="comment">// Display a popup once.</span>
04788             <span class="comment">//</span>
04789 
04790             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/modwrite_8c.html#a22">MmPageFileFullPopupShown</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
04791                 <a class="code" href="../../d6/d3/modwrite_8c.html#a22">MmPageFileFullPopupShown</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04792                 <a class="code" href="../../d6/d3/modwrite_8c.html#a38">MiCauseOverCommitPopup</a> (1, 0);
04793             }
04794 
04795             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
04796             <span class="keywordflow">return</span>;
04797         }
04798 
04799         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> &lt;= <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> + 50) {
04800 
04801             <span class="comment">//</span>
04802             <span class="comment">// The total commit limit is less than the number of committed</span>
04803             <span class="comment">// pages + 50. Reset commit limit.</span>
04804             <span class="comment">//</span>
04805 
04806             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> &lt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a>) {
04807 
04808                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a9">MmPageFileFullExtendPages</a>) {
04809                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MmTotalCommittedPages &gt;= MmPageFileFullExtendPages);
04810                     <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> -= <a class="code" href="../../d6/d1/mmquota_8c.html#a9">MmPageFileFullExtendPages</a>;
04811                     <a class="code" href="../../d6/d1/mmquota_8c.html#a9">MmPageFileFullExtendPages</a> = 0;
04812                 }
04813 
04814                 <a class="code" href="../../d6/d1/mmquota_8c.html#a9">MmPageFileFullExtendPages</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> - <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a>;
04815                 <a class="code" href="../../d6/d3/modwrite_8c.html#a20">MmPageFileFullExtendCount</a> += 1;
04816 
04817                 <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a>;
04818             }
04819 
04820             <span class="comment">//</span>
04821             <span class="comment">// Charge 100 pages against the commitment.</span>
04822             <span class="comment">//</span>
04823 
04824             <a class="code" href="../../d6/d3/modwrite_8c.html#a21">MiPageFileFullCharge</a> += <a class="code" href="../../d6/d3/modwrite_8c.html#a1">MI_PAGEFILE_FULL_CHARGE</a>;
04825 
04826             ExReleaseSpinLock (&amp;MmChargeCommitmentLock, OldIrql);
04827 
04828             <a class="code" href="../../d6/d1/mmquota_8c.html#a18">MiChargeCommitmentCantExpand</a> (MI_PAGEFILE_FULL_CHARGE, TRUE);
04829 
04830             <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_PAGEFILE_FULL, 100);
04831 
04832             <span class="comment">//</span>
04833             <span class="comment">// Display a popup once.</span>
04834             <span class="comment">//</span>
04835 
04836             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/modwrite_8c.html#a22">MmPageFileFullPopupShown</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
04837                 <a class="code" href="../../d6/d3/modwrite_8c.html#a22">MmPageFileFullPopupShown</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04838                 <a class="code" href="../../d6/d3/modwrite_8c.html#a38">MiCauseOverCommitPopup</a> (1, 0);
04839             }
04840 
04841             <span class="comment">//</span>
04842             <span class="comment">// Delay a bit before returning the commitment so the segment</span>
04843             <span class="comment">// dereference thread gets a chance to actually grow the pagefile.</span>
04844             <span class="comment">//</span>
04845 
04846             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/modwrite_8c.html#a21">MiPageFileFullCharge</a> &gt;= 5 * <a class="code" href="../../d6/d3/modwrite_8c.html#a1">MI_PAGEFILE_FULL_CHARGE</a>) {
04847                 ExAcquireSpinLock (&amp;MmChargeCommitmentLock, &amp;OldIrql);
04848                 SizeToExpand = <a class="code" href="../../d6/d3/modwrite_8c.html#a21">MiPageFileFullCharge</a>;
04849                 <a class="code" href="../../d6/d3/modwrite_8c.html#a21">MiPageFileFullCharge</a> = 0;
04850                 ExReleaseSpinLock (&amp;MmChargeCommitmentLock, OldIrql);
04851                 <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (SizeToExpand);
04852             }
04853 
04854         }
04855         <span class="keywordflow">else</span> {
04856 
04857             <span class="comment">//</span>
04858             <span class="comment">// Commit limit is lower than the number of committed pages.</span>
04859             <span class="comment">//</span>
04860 
04861             ExReleaseSpinLock (&amp;MmChargeCommitmentLock, OldIrql);
04862         }
04863 
04864         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
04865     }
04866     <span class="keywordflow">return</span>;
04867 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="modwrite.c::MiPageFileFull" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiPageFileFull           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a42" doxytag="modwrite.c::MiReleaseModifiedWriter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiReleaseModifiedWriter           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00275">275</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00043">MiFirstPageFileCreatedAndReady</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00297">NtCreatePagingFile()</a>.
<p>
<pre class="fragment"><div>00281                    :
00282 
00283     Nonpagable wrapper to signal <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> modified writer when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first pagefile
00284     creation has completely finished.
00285 
00286 --*/
00287  
00288 {
00289     KIRQL OldIrql;
00290     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00291     <a class="code" href="../../d6/d3/modwrite_8c.html#a10">MiFirstPageFileCreatedAndReady</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00292     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00293 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a49" doxytag="modwrite.c::MiWriteComplete" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiWriteComplete           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Reserved</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02234">2234</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00420">_MDL::ByteCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02540">_MMMOD_WRITER_MDL_ENTRY::ControlArea</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02537">_MMMOD_WRITER_MDL_ENTRY::CurrentList</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02524">_MMMOD_WRITER_LISTHEAD::Event</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02539">_MMMOD_WRITER_MDL_ENTRY::File</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01534">_FILE_OBJECT::FileName</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02070">_CONTROL_AREA::FilePointer</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02541">_MMMOD_WRITER_MDL_ENTRY::FileResource</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02553">_MMPAGING_FILE::FreeSpace</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l02342">FsRtlReleaseFileForModWrite()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02003">GET_PAGING_FILE_NUMBER</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02026">GET_PAGING_FILE_OFFSET</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08909">IoRaiseInformationalHardError()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00167">KePulseEvent()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02535">_MMMOD_WRITER_MDL_ENTRY::LastPageToWrite</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02528">_MMMOD_WRITER_MDL_ENTRY::Links</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02523">_MMMOD_WRITER_LISTHEAD::ListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00418">_MDL::MappedSystemVa</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02542">_MMMOD_WRITER_MDL_ENTRY::Mdl</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00424">MDL_MAPPED_TO_SYSTEM_VA</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00416">_MDL::MdlFlags</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00934">MI_IS_PFN_DELETED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01470">MI_REMOVE_LOCKED_PAGE_CHARGE</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01823">MiCheckControlArea()</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00167">MiDecrementReferenceCount()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l01014">MiReleasePageFileSpace()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00217">Mm30Milliseconds</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00198">MM_COPY_ON_WRITE_MASK</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00169">MM_DBG_MOD_WRITE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00180">MM_DBG_PRINTS_MODWRITES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00153">MM_PROTECTION_WRITE_MASK</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00092">MM_USABLE_PAGES_FREE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05090">MmFreePagingSpaceLow</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04610">MmMappedFileIoComplete</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05092">MmNumberOfActiveMdlEntries</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04872">MmPagingFileDebug</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05079">MmPagingFileHeader</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03124">MmUnmapLockedPages()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02072">_CONTROL_AREA::ModifiedWriteCount</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00048">NT_ERROR</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02061">_CONTROL_AREA::NumberOfPfnReferences</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02543">_MMMOD_WRITER_MDL_ENTRY::Page</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02538">_MMMOD_WRITER_MDL_ENTRY::PagingFile</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02536">_MMMOD_WRITER_MDL_ENTRY::PagingListHead</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00124">PDE_TOP</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00062">SHORT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html#o10">_CONTROL_AREA::u</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02579">MiCancelWriteOfMappedPfn()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l03198">MiGatherMappedPages()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l03701">MiGatherPagefilePages()</a>, and <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04239">MiMappedPageWriter()</a>.
<p>
<pre class="fragment"><div>02242                    :
02243 
02244     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC write completion <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a>.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked
02245     at <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> when a page write operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> completed.
02246 
02247 Arguments:
02248 
02249     Context - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> MOD_WRITER_MDL_ENTRY which was
02250               used <span class="keywordflow">for</span> <span class="keyword">this</span> I/O.
02251 
02252     IoStatus - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IO_STATUS_BLOCK which was used
02253                <span class="keywordflow">for</span> <span class="keyword">this</span> I/O.
02254 
02255 Return Value:
02256 
02257     None.
02258 
02259 Environment:
02260 
02261     Kernel mode, <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>.
02262 
02263 --*/
02264 
02265 {
02266 
02267     <a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">PMMMOD_WRITER_MDL_ENTRY</a> WriterEntry;
02268     <a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">PMMMOD_WRITER_MDL_ENTRY</a> NextWriterEntry;
02269     PPFN_NUMBER Page;
02270     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
02271     KIRQL OldIrql;
02272     LONG ByteCount;
02273     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02274     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
02275     ULONG FailAllIo;
02276     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject;
02277     <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> FileResource;
02278 
02279     UNREFERENCED_PARAMETER (Reserved);
02280 
02281     FailAllIo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02282 
02283 <span class="preprocessor">#if DBG</span>
02284 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a61">MM_DBG_MOD_WRITE</a>) {
02285         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM MODWRITE: modified page write completed\n"</span>);
02286     }
02287 <span class="preprocessor">#endif</span>
02288 <span class="preprocessor"></span>
02289     <span class="comment">//</span>
02290     <span class="comment">// A page write has completed, at this time the pages are not</span>
02291     <span class="comment">// on any lists, write-in-progress is set in the PFN database,</span>
02292     <span class="comment">// and the reference count was incremented.</span>
02293     <span class="comment">//</span>
02294 
02295     WriterEntry = (<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">PMMMOD_WRITER_MDL_ENTRY</a>)Context;
02296     ByteCount = (LONG)WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>.<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a>;
02297     Page = &amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o14">Page</a>[0];
02298 
02299     <span class="keywordflow">if</span> (WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>.<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a12">MDL_MAPPED_TO_SYSTEM_VA</a>) {
02300         <a class="code" href="../../d5/d6/iosup_8c.html#a56">MmUnmapLockedPages</a> (WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>.<a class="code" href="../../d6/d7/struct__MDL.html#o4">MappedSystemVa</a>,
02301                             &amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>);
02302     }
02303 
02304     <span class="comment">//</span>
02305     <span class="comment">// Get the PFN lock so the PFN database can be manipulated.</span>
02306     <span class="comment">//</span>
02307 
02308     status = IoStatus-&gt;Status;
02309     ControlArea = WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o11">ControlArea</a>;
02310 
02311     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02312 
02313     <span class="comment">//</span>
02314     <span class="comment">// Indicate that the write is complete.</span>
02315     <span class="comment">//</span>
02316 
02317     WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o6">LastPageToWrite</a> = 0;
02318 
02319 
02320     <span class="keywordflow">while</span> (ByteCount &gt; 0) {
02321 
02322         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (*Page);
02323         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress == 1);
02324 <span class="preprocessor">#if DBG</span>
02325 <span class="preprocessor"></span>
02326         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) {
02327 
02328             ULONG <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
02329             <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a170">GET_PAGING_FILE_OFFSET</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
02330             <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &lt; 8192) &amp;&amp;
02331                     (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a169">GET_PAGING_FILE_NUMBER</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>) == 0)) {
02332                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MmPagingFileDebug[Offset] &amp; 1) != 0);
02333                 <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a121">MI_IS_PFN_DELETED</a>(Pfn1)) {
02334                     <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a169">GET_PAGING_FILE_NUMBER</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>)) == 0) {
02335                         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a686">MmPagingFileDebug</a>[<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>] &amp; ~0x1f) !=
02336                                    ((ULONG_PTR)Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> &lt;&lt; 3)) {
02337                             <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PDE_BASE)) {
02338 
02339                                 <span class="comment">//</span>
02340                                 <span class="comment">// Make sure this isn't a PTE that was forked</span>
02341                                 <span class="comment">// during the I/O.</span>
02342                                 <span class="comment">//</span>
02343 
02344                                 <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> &lt; (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a5">PDE_TOP</a>) ||
02345                                     ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection &amp;
02346                                             <a class="code" href="../../d4/d8/mi_8h.html#a84">MM_COPY_ON_WRITE_MASK</a>) ==
02347                                                 <a class="code" href="../../d4/d8/mi_8h.html#a51">MM_PROTECTION_WRITE_MASK</a>)) {
02348                                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MMWRITE: Mismatch Pfn1 %p Offset %lx info %p\n"</span>,
02349                                              Pfn1,
02350                                              Offset,
02351                                              MmPagingFileDebug[Offset]);
02352 
02353                                     DbgBreakPoint();
02354 
02355                                 } <span class="keywordflow">else</span> {
02356                                     <a class="code" href="../../d4/d8/mi_8h.html#a686">MmPagingFileDebug</a>[<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>] &amp;= 0x1f;
02357                                     <a class="code" href="../../d4/d8/mi_8h.html#a686">MmPagingFileDebug</a>[<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>] |=
02358                                         ((ULONG_PTR)Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> &lt;&lt; 3);
02359                                 }
02360                             }
02361 
02362                         }
02363                     }
02364                 }
02365             }
02366         }
02367 <span class="preprocessor">#endif //DBG</span>
02368 <span class="preprocessor"></span>
02369         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress = 0;
02370 
02371         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>(status)) {
02372 
02373             <span class="comment">//</span>
02374             <span class="comment">// If the file object is over the network, assume that this</span>
02375             <span class="comment">// I/O operation can never complete and mark the pages as</span>
02376             <span class="comment">// clean and indicate in the control area all I/O should fail.</span>
02377             <span class="comment">// Note that the modified bit in the PFN database is not set.</span>
02378             <span class="comment">//</span>
02379 
02380             <span class="keywordflow">if</span> (((status != STATUS_FILE_LOCK_CONFLICT) &amp;&amp;
02381                 (ControlArea != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
02382                 (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Networked == 1))
02383                             ||
02384                 (status == STATUS_FILE_INVALID)) {
02385 
02386                 <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.FailAllIo == 0) {
02387                     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.FailAllIo = 1;
02388                     FailAllIo = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02389 
02390                     KdPrint((<span class="stringliteral">"MM MODWRITE: failing all io, controlarea %lx status %lx\n"</span>,
02391                           ControlArea, status));
02392                 }
02393             } <span class="keywordflow">else</span> {
02394 
02395                 <span class="comment">//</span>
02396                 <span class="comment">// The modified write operation failed, SET the modified bit</span>
02397                 <span class="comment">// for each page which was written and free the page file</span>
02398                 <span class="comment">// space.</span>
02399                 <span class="comment">//</span>
02400 
02401 <span class="preprocessor">#if DBG</span>
02402 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ((status != STATUS_FILE_LOCK_CONFLICT) &amp;&amp;
02403                    ((MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a72">MM_DBG_PRINTS_MODWRITES</a>) == 0)) {
02404                     KdPrint((<span class="stringliteral">"MM MODWRITE: modified page write iosb failed - status 0x%lx\n"</span>,
02405                             status));
02406                 }
02407 <span class="preprocessor">#endif</span>
02408 <span class="preprocessor"></span>
02409                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 1;
02410             }
02411         }
02412 
02413         <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified == 1) &amp;&amp;
02414             (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0)) {
02415 
02416             <span class="comment">//</span>
02417             <span class="comment">// This page was modified since the write was done,</span>
02418             <span class="comment">// release the page file space.</span>
02419             <span class="comment">//</span>
02420 
02421             <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
02422             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh = 0;
02423         }
02424 
02425         <a class="code" href="../../d4/d8/mi_8h.html#a189">MI_REMOVE_LOCKED_PAGE_CHARGE</a> (Pfn1, 15);
02426         <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (*Page);
02427 <span class="preprocessor">#if DBG</span>
02428 <span class="preprocessor"></span>        *Page = 0xF0FFFFFF;
02429 <span class="preprocessor">#endif //DBG</span>
02430 <span class="preprocessor"></span>
02431         Page += 1;
02432         ByteCount -= (LONG)<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02433     }
02434 
02435     <span class="comment">//</span>
02436     <span class="comment">// Check to which list to insert this entry into depending on</span>
02437     <span class="comment">// the amount of free space left in the paging file.</span>
02438     <span class="comment">//</span>
02439 
02440     FileObject = WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o10">File</a>;
02441     FileResource = WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o12">FileResource</a>;
02442 
02443     <span class="keywordflow">if</span> ((WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o9">PagingFile</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
02444         (WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o9">PagingFile</a>-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a17">MM_USABLE_PAGES_FREE</a>)) {
02445 
02446         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a717">MmNumberOfActiveMdlEntries</a> == 1) {
02447 
02448             <span class="comment">//</span>
02449             <span class="comment">// If we put this entry on the list, there will be</span>
02450             <span class="comment">// no more paging.  Locate all entries which are non</span>
02451             <span class="comment">// zero and pull them from the list.</span>
02452             <span class="comment">//</span>
02453 
02454             InsertTailList (&amp;MmFreePagingSpaceLow, &amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o0">Links</a>);
02455             WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o8">CurrentList</a> = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a716">MmFreePagingSpaceLow</a>;
02456 
02457             <a class="code" href="../../d4/d8/mi_8h.html#a717">MmNumberOfActiveMdlEntries</a> -= 1;
02458 
02459             <span class="comment">//</span>
02460             <span class="comment">// Try to pull entries off the list.</span>
02461             <span class="comment">//</span>
02462 
02463             WriterEntry = (<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">PMMMOD_WRITER_MDL_ENTRY</a>)<a class="code" href="../../d4/d8/mi_8h.html#a716">MmFreePagingSpaceLow</a>.Flink;
02464 
02465             <span class="keywordflow">while</span> ((PLIST_ENTRY)WriterEntry != &amp;<a class="code" href="../../d4/d8/mi_8h.html#a716">MmFreePagingSpaceLow</a>) {
02466 
02467                 NextWriterEntry =
02468                             (<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">PMMMOD_WRITER_MDL_ENTRY</a>)WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o0">Links</a>.Flink;
02469 
02470                 <span class="keywordflow">if</span> (WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o9">PagingFile</a>-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> != 0) {
02471 
02472                     RemoveEntryList (&amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o0">Links</a>);
02473 
02474                     <span class="comment">//</span>
02475                     <span class="comment">// Insert this into the active list.</span>
02476                     <span class="comment">//</span>
02477 
02478                     <span class="keywordflow">if</span> (IsListEmpty (&amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o7">PagingListHead</a>-&gt;<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>)) {
02479                         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o7">PagingListHead</a>-&gt;<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o1">Event</a>,
02480                                     0,
02481                                     FALSE);
02482                     }
02483 
02484                     InsertTailList (&amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o7">PagingListHead</a>-&gt;<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>,
02485                                     &amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o0">Links</a>);
02486                     WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o8">CurrentList</a> = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>;
02487                     <a class="code" href="../../d4/d8/mi_8h.html#a717">MmNumberOfActiveMdlEntries</a> += 1;
02488                 }
02489 
02490                 WriterEntry = NextWriterEntry;
02491             }
02492 
02493         } <span class="keywordflow">else</span> {
02494 
02495             InsertTailList (&amp;MmFreePagingSpaceLow, &amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o0">Links</a>);
02496             WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o8">CurrentList</a> = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a716">MmFreePagingSpaceLow</a>;
02497             <a class="code" href="../../d4/d8/mi_8h.html#a717">MmNumberOfActiveMdlEntries</a> -= 1;
02498         }
02499     } <span class="keywordflow">else</span> {
02500 
02501         <span class="comment">//</span>
02502         <span class="comment">// Ample space exists, put this on the active list.</span>
02503         <span class="comment">//</span>
02504 
02505         <span class="keywordflow">if</span> (IsListEmpty (&amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o7">PagingListHead</a>-&gt;<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>)) {
02506             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o7">PagingListHead</a>-&gt;<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o1">Event</a>, 0, FALSE);
02507         }
02508 
02509         InsertTailList (&amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o7">PagingListHead</a>-&gt;<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>,
02510                         &amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o0">Links</a>);
02511     }
02512 
02513     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((ULONG_PTR)WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o0">Links</a>.Flink &amp; 1) == 0);
02514 
02515     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02516 
02517     <span class="keywordflow">if</span> (FileResource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02518         <a class="code" href="../../d1/d8/fsrtl_8h.html#a104">FsRtlReleaseFileForModWrite</a> (FileObject, FileResource);
02519     }
02520 
02521     <span class="keywordflow">if</span> (FailAllIo) {
02522 
02523         <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.Length &amp;&amp;
02524             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.MaximumLength &amp;&amp;
02525             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.Buffer) {
02526 
02527             <a class="code" href="../../d4/d6/iosubs_8c.html#a94">IoRaiseInformationalHardError</a>(
02528                 STATUS_LOST_WRITEBEHIND_DATA,
02529                 &amp;ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>,
02530                 NULL
02531                 );
02532         }
02533     }
02534 
02535     <span class="keywordflow">if</span> (ControlArea != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02536 
02537         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02538 
02539         <span class="comment">//</span>
02540         <span class="comment">// A write to a mapped file just completed, check to see if</span>
02541         <span class="comment">// there are any waiters on the completion of this i/o.</span>
02542         <span class="comment">//</span>
02543 
02544         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o13">ModifiedWriteCount</a> -= 1;
02545         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((SHORT)ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o13">ModifiedWriteCount</a> &gt;= 0);
02546         <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.SetMappedFileIoComplete != 0) {
02547             <a class="code" href="../../d2/d8/eventobj_8c.html#a5">KePulseEvent</a> (&amp;MmMappedFileIoComplete,
02548                           0,
02549                           FALSE);
02550         }
02551 
02552         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">NumberOfPfnReferences</a> -= 1;
02553 
02554         <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">NumberOfPfnReferences</a> == 0) {
02555 
02556             <span class="comment">//</span>
02557             <span class="comment">// This routine return with the PFN lock released!.</span>
02558             <span class="comment">//</span>
02559 
02560             <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, NULL, OldIrql);
02561         } <span class="keywordflow">else</span> {
02562             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02563         }
02564     }
02565 
02566     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>(status)) {
02567 
02568         <span class="comment">//</span>
02569         <span class="comment">// Wait for a short time so other processing can continue.</span>
02570         <span class="comment">//</span>
02571 
02572         <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (KernelMode, FALSE, &amp;Mm30Milliseconds);
02573     }
02574 
02575     <span class="keywordflow">return</span>;
02576 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a54" doxytag="modwrite.c::MmDisableModifiedWriteOfSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN MmDisableModifiedWriteOfSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html">PSECTION_OBJECT_POINTERS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>SectionObjectPointer</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04397">4397</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02062">_CONTROL_AREA::NumberOfMappedViews</a>, <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html#o10">_CONTROL_AREA::u</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d6/d7/fssup_8c-source.html#l00387">CcInitializeCacheMap()</a>.
<p>
<pre class="fragment"><div>04403                    :
04404 
04405     This function disables page writing by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> modified page writer <span class="keywordflow">for</span>
04406     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> mapped by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object pointer.
04407 
04408     This should <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> be used <span class="keywordflow">for</span> files which CANNOT be mapped by user
04409     programs, e.g., volume files, directory files, etc.
04410 
04411 Arguments:
04412 
04413     SectionObjectPointer - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section objects
04414 
04415 
04416 Return Value:
04417 
04418     Returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation was a success, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> either
04419     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no section or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section already has a view.
04420 
04421 --*/
04422 
04423 {
04424     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
04425     KIRQL OldIrql;
04426     BOOLEAN state = 1;
04427 
04428     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
04429 
04430     ControlArea = ((<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)(SectionObjectPointer-&gt;DataSectionObject));
04431 
04432     <span class="keywordflow">if</span> (ControlArea != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04433         <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> == 0) {
04434 
04435             <span class="comment">//</span>
04436             <span class="comment">// There are no views to this section, indicate no modified</span>
04437             <span class="comment">// page writing is allowed.</span>
04438             <span class="comment">//</span>
04439 
04440             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.NoModifiedWriting = 1;
04441         } <span class="keywordflow">else</span> {
04442 
04443             <span class="comment">//</span>
04444             <span class="comment">// Return the current modified page writing state.</span>
04445             <span class="comment">//</span>
04446 
04447             state = (BOOLEAN)ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.NoModifiedWriting;
04448         }
04449     } <span class="keywordflow">else</span> {
04450 
04451         <span class="comment">//</span>
04452         <span class="comment">// This file no longer has an associated segment.</span>
04453         <span class="comment">//</span>
04454 
04455         state = 0;
04456     }
04457 
04458     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04459     <span class="keywordflow">return</span> state;
04460 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="modwrite.c::MmGetCrashDumpInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmGetCrashDumpInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSYSTEM_CRASH_DUMP_INFORMATION&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>CrashInfo</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01392">1392</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00083">MmCrashDumpSection</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00941">NtQuerySystemInformation()</a>.
<p>
<pre class="fragment"><div>01398                    :
01399 
01400     This function checks to see <span class="keywordflow">if</span> a crash dump section exists and
01401     <span class="keywordflow">if</span> so creates a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section and returns that value
01402     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CrashDumpInformation structure.  Once <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01403     section has been created, no other references can be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a>
01404     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> crash dump section, and when that handle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> closed, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01405     crash dump section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> deleted and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> space <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01406     available <span class="keywordflow">for</span> reuse.
01407 
01408 Arguments:
01409 
01410     CrashInfo - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> crash dump information
01411                 structure.
01412 
01413 Return Value:
01414 
01415     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> handle value of zero indicates no
01416     crash dump was located.
01417 
01418 --*/
01419 
01420 {
01421     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01422     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
01423 
01424     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01425 
01426     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/modwrite_8c.html#a11">MmCrashDumpSection</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01427         <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = 0;
01428         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01429     } <span class="keywordflow">else</span> {
01430         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a> (MmCrashDumpSection,
01431                                  NULL,
01432                                  SECTION_MAP_READ,
01433                                  0,
01434                                  (PVOID *)NULL,
01435                                  &amp;Handle);
01436         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01437 
01438             <span class="comment">//</span>
01439             <span class="comment">// One shot operation.</span>
01440             <span class="comment">//</span>
01441 
01442             <a class="code" href="../../d6/d3/modwrite_8c.html#a11">MmCrashDumpSection</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01443         }
01444     }
01445 
01446     CrashInfo-&gt;CrashDumpSection = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
01447     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01448 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a45" doxytag="modwrite.c::MmGetCrashDumpStateInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmGetCrashDumpStateInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSYSTEM_CRASH_STATE_INFORMATION&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>CrashInfo</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01452">1452</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00083">MmCrashDumpSection</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00941">NtQuerySystemInformation()</a>.
<p>
<pre class="fragment"><div>01458                    :
01459 
01460     This function checks to see <span class="keywordflow">if</span> a crash dump section exists and
01461     returns a BOOLEAN value in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CrashStateInformation structure
01462     based on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> outcome.
01463 
01464 Arguments:
01465 
01466     CrashInfo - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> crash dump state information
01467                 structure.
01468 
01469 Return Value:
01470 
01471     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> BOOLEAN value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> indicates no
01472     crash dump was located.
01473 
01474 --*/
01475 
01476 {
01477     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01478 
01479     CrashInfo-&gt;ValidCrashDump = (<a class="code" href="../../d6/d3/modwrite_8c.html#a11">MmCrashDumpSection</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01480     <span class="keywordflow">return</span> STATUS_SUCCESS;
01481 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a55" doxytag="modwrite.c::MmGetPageFileInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmGetPageFileInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemInformationLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04466">4466</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l02554">_MMPAGING_FILE::CurrentUsage</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00056">MmNumberOfPagingFiles</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05083">MmPagingFile</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02561">_MMPAGING_FILE::PageFileName</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02555">_MMPAGING_FILE::PeakUsage</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00049">ROUND_UP</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l02550">_MMPAGING_FILE::Size</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00941">NtQuerySystemInformation()</a>.
<p>
<pre class="fragment"><div>04474                    :
04475 
04476     This routine returns information about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> currently active paging
04477     files.
04478 
04479 Arguments:
04480 
04481     SystemInformation - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> information.
04482 
04483     SystemInformationLength - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SystemInformation
04484                               buffer.
04485 
04486     Length - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> information placed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04487              buffer.
04488 
04489 Return Value:
04490 
04491     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
04492 
04493 --*/
04494 
04495 {
04496     PSYSTEM_PAGEFILE_INFORMATION PageFileInfo;
04497     ULONG NextEntryOffset = 0;
04498     ULONG TotalSize = 0;
04499     ULONG i;
04500     UNICODE_STRING UserBufferPageFileName;
04501 
04502     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04503 
04504     *Length = 0;
04505     PageFileInfo = (PSYSTEM_PAGEFILE_INFORMATION)SystemInformation;
04506 
04507     PageFileInfo-&gt;TotalSize = 0;
04508 
04509     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>; i += 1) {
04510         PageFileInfo = (PSYSTEM_PAGEFILE_INFORMATION)(
04511                                 (PUCHAR)PageFileInfo + NextEntryOffset);
04512         NextEntryOffset = <span class="keyword">sizeof</span>(SYSTEM_PAGEFILE_INFORMATION);
04513         TotalSize += <span class="keyword">sizeof</span>(SYSTEM_PAGEFILE_INFORMATION);
04514 
04515         <span class="keywordflow">if</span> (TotalSize &gt; SystemInformationLength) {
04516             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
04517         }
04518 
04519         PageFileInfo-&gt;TotalSize = (ULONG)<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a>;
04520         PageFileInfo-&gt;TotalInUse = (ULONG)<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o4">CurrentUsage</a>;
04521         PageFileInfo-&gt;PeakUsage = (ULONG)<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o5">PeakUsage</a>;
04522 
04523         <span class="comment">//</span>
04524         <span class="comment">// The PageFileName portion of the UserBuffer must be saved locally</span>
04525         <span class="comment">// to protect against a malicious thread changing the contents.  This</span>
04526         <span class="comment">// is because we will reference the contents ourselves when the actual</span>
04527         <span class="comment">// string is copied out carefully below.</span>
04528         <span class="comment">//</span>
04529 
04530         UserBufferPageFileName.Length = <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o11">PageFileName</a>.Length;
04531         UserBufferPageFileName.MaximumLength = <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o11">PageFileName</a>.Length + <span class="keyword">sizeof</span>(WCHAR);
04532         UserBufferPageFileName.Buffer = (PWCHAR)(PageFileInfo + 1);
04533 
04534         PageFileInfo-&gt;PageFileName = UserBufferPageFileName;
04535 
04536         TotalSize += <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a> (UserBufferPageFileName.MaximumLength,
04537                                <span class="keyword">sizeof</span>(ULONG));
04538         NextEntryOffset += <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a> (UserBufferPageFileName.MaximumLength,
04539                                      <span class="keyword">sizeof</span>(ULONG));
04540 
04541         <span class="keywordflow">if</span> (TotalSize &gt; SystemInformationLength) {
04542             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
04543         }
04544 
04545         <span class="comment">//</span>
04546         <span class="comment">// Carefully reference the user buffer here.</span>
04547         <span class="comment">//</span>
04548 
04549         RtlMoveMemory(UserBufferPageFileName.Buffer,
04550                       MmPagingFile[i]-&gt;PageFileName.Buffer,
04551                       MmPagingFile[i]-&gt;PageFileName.Length);
04552         UserBufferPageFileName.Buffer[
04553                     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o11">PageFileName</a>.Length/<span class="keyword">sizeof</span>(WCHAR)] = UNICODE_NULL;
04554         PageFileInfo-&gt;NextEntryOffset = NextEntryOffset;
04555     }
04556     PageFileInfo-&gt;NextEntryOffset = 0;
04557     *Length = TotalSize;
04558     <span class="keywordflow">return</span> STATUS_SUCCESS;
04559 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="modwrite.c::NtCreatePagingFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtCreatePagingFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>PageFileName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>MinimumSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>MaximumSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG Priority&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00297">297</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02559">_MMPAGING_FILE::Bitmap</a>, <a class="el" href="../../d0/d5/io_8h.html#a600a406">CreateFileTypeNone</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01188">_DEVICE_OBJECT::DeviceType</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02558">_MMPAGING_FILE::Entry</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02214">_MMPAGE_FILE_EXPANSION::Event</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02560">_MMPAGING_FILE::File</a>, <a class="el" href="../../d2/d8/icmui_8def-source.html#l00004">File</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02553">_MMPAGING_FILE::FreeSpace</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00243">IO_NO_PARAMETER_CHECKING</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00234">IO_OPEN_PAGING_FILE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l04502">IoCreateFile()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00044">IoFileObjectType</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08468">IoPageFileCreated()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08683">IoQueryVolumeInformation()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00273">MAX_PAGE_FILES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02551">_MMPAGING_FILE::MaximumSize</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00191">MiChargeCommitment()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01095">MiCheckForCrashDump()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04563">MiCheckPageFileMapping()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00166">MiCheckPageFilePath()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02496">MiCreateBitMap</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01031">MiExtendPagingFileMaximum()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04607">MiInsertPageFileInList()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04911">MiIssuePageExtendRequest()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00151">MINIMUM_PAGE_FILE_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02552">_MMPAGING_FILE::MinimumSize</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00275">MiReleaseModifiedWriter()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02505">MiRemoveBitMap</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d4/d8/mi_8h.html#a504">MMMOD_WRITER_MDL_ENTRY</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05126">MmModifiedWriteClusterSize</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00056">MmNumberOfPagingFiles</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04860">MmPageFileCreationLock</a>, <a class="el" href="../../d4/d8/mi_8h.html#a506">MMPAGING_FILE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05083">MmPagingFile</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05079">MmPagingFileHeader</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00110">MmSystemPageFileLocated</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00041">MmTotalCommitLimit</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00100">MmTotalCommitLimitMaximum</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00040">MmTotalCommittedPages</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00367">ObOpenObjectByPointer()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02561">_MMPAGING_FILE::PageFileName</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02562">_MMPAGING_FILE::PageFileNumber</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02216">_MMPAGE_FILE_EXPANSION::PageFileNumber</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02538">_MMMOD_WRITER_MDL_ENTRY::PagingFile</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02536">_MMMOD_WRITER_MDL_ENTRY::PagingListHead</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00579">PsInitialSystemProcess</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00088">PsProcessType</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02212">_MMPAGE_FILE_EXPANSION::RequestedExpansionSize</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00117">ROUND_TO_PAGES</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l01508">RtlClearBits()</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l00305">RtlSetAllBits()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01679">SeCreatePagefilePrivilege</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01521">_FILE_OBJECT::SectionObjectPointer</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02210">_MMPAGE_FILE_EXPANSION::Segment</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00436">SeSinglePrivilegeCheck()</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02550">_MMPAGING_FILE::Size</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00861">ZwSetInformationFile()</a>.
<p>
<pre class="fragment"><div>00306                    :
00307 
00308     This routine opens <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>, attempts to write a page
00309     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>, and creates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> necessary structures to
00310     use <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> as a paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00311 
00312     If <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> modified page writer
00313     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> started.
00314 
00315     This system service requires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller to have <a class="code" href="../../d0/d5/se_8h.html#a88">SeCreatePagefilePrivilege</a>.
00316 
00317 Arguments:
00318 
00319     PageFileName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fully qualified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> name.
00320 
00321     MinimumSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00322                   This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> rounded up to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> host page size.
00323 
00324     MaximumSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> maximum number of bytes to write to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00325                   This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> rounded up to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> host page size.
00326 
00327     Priority - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relative priority of <span class="keyword">this</span> paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00328 
00329 Return Value:
00330 
00331     tbs
00332 
00333 --*/
00334 
00335 {
00336     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>;
00337     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00338     OBJECT_ATTRIBUTES PagingFileAttributes;
00339     HANDLE FileHandle;
00340     IO_STATUS_BLOCK IoStatus;
00341     UNICODE_STRING CapturedName;
00342     PWSTR CapturedBuffer;
00343     LARGE_INTEGER CapturedMaximumSize;
00344     LARGE_INTEGER CapturedMinimumSize;
00345     LARGE_INTEGER SpecifiedSize;
00346     FILE_END_OF_FILE_INFORMATION EndOfFileInformation;
00347     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00348     BOOLEAN Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00349     BOOLEAN HasPrivilege;
00350     HANDLE SystemProcess;
00351     FILE_FS_DEVICE_INFORMATION FileDeviceInfo;
00352     ULONG ReturnedLength;
00353     ULONG FinalStatus;
00354     ULONG PageFileNumber;
00355     ULONG NewMaxSizeInPages;
00356     ULONG NewMinSizeInPages;
00357     <a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html">PMMPAGING_FILE</a> FoundExisting;
00358     PRTL_BITMAP NewBitmap;
00359     PRTL_BITMAP OldBitmap;
00360     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00361     <a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html">MMPAGE_FILE_EXPANSION</a> PageExtend;
00362 
00363     DBG_UNREFERENCED_PARAMETER (Priority);
00364 
00365     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00366 
00367     CapturedBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00368 
00369     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a> == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a48">MAX_PAGE_FILES</a>) {
00370 
00371         <span class="comment">//</span>
00372         <span class="comment">// The maximum number of paging files is already in use.</span>
00373         <span class="comment">//</span>
00374 
00375         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_TOO_MANY_PAGING_FILES;
00376         <span class="keywordflow">goto</span> ErrorReturn0;
00377     }
00378 
00379     PreviousMode = KeGetPreviousMode();
00380 
00381     <span class="keywordflow">try</span> {
00382 
00383         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00384 
00385             <span class="comment">//</span>
00386             <span class="comment">// Make sure the caller has the proper privilege to make</span>
00387             <span class="comment">// this call.</span>
00388             <span class="comment">//</span>
00389 
00390             HasPrivilege = <a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a> (SeCreatePagefilePrivilege,
00391                                                    PreviousMode
00392                                                    );
00393 
00394             <span class="keywordflow">if</span> (!HasPrivilege) {
00395 
00396                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PRIVILEGE_NOT_HELD;
00397                 <span class="keywordflow">goto</span> ErrorReturn0;
00398             }
00399 
00400             <span class="comment">//</span>
00401             <span class="comment">// Probe arguments.</span>
00402             <span class="comment">//</span>
00403 
00404             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( PageFileName, <span class="keyword">sizeof</span>(*PageFileName), <span class="keyword">sizeof</span>(UCHAR));
00405             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( MaximumSize, <span class="keyword">sizeof</span>(LARGE_INTEGER), 4);
00406             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( MinimumSize, <span class="keyword">sizeof</span>(LARGE_INTEGER), 4);
00407         }
00408 
00409         <span class="comment">//</span>
00410         <span class="comment">// Capture arguments.</span>
00411         <span class="comment">//</span>
00412 
00413         CapturedMinimumSize = *MinimumSize;
00414 
00415 <span class="preprocessor">#if defined (_WIN64) || defined (_X86PAE_)</span>
00416 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (CapturedMinimumSize.QuadPart &lt; <a class="code" href="../../d6/d3/modwrite_8c.html#a2">MINIMUM_PAGE_FILE_SIZE</a>) {
00417             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_2;
00418             <span class="keywordflow">goto</span> ErrorReturn0;
00419         }
00420 
00421         SpecifiedSize.QuadPart = (<a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a> (CapturedMinimumSize.QuadPart)) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00422 
00423         <span class="keywordflow">if</span> (SpecifiedSize.HighPart != 0) {
00424             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_2;
00425             <span class="keywordflow">goto</span> ErrorReturn0;
00426         }
00427 <span class="preprocessor">#else</span>
00428 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((CapturedMinimumSize.HighPart != 0) ||
00429             (CapturedMinimumSize.LowPart &lt; <a class="code" href="../../d6/d3/modwrite_8c.html#a2">MINIMUM_PAGE_FILE_SIZE</a>)) {
00430             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_2;
00431             <span class="keywordflow">goto</span> ErrorReturn0;
00432         }
00433 <span class="preprocessor">#endif</span>
00434 <span class="preprocessor"></span>
00435         CapturedMaximumSize = *MaximumSize;
00436 
00437 <span class="preprocessor">#if defined (_WIN64) || defined (_X86PAE_)</span>
00438 <span class="preprocessor"></span>        SpecifiedSize.QuadPart = (<a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a> (CapturedMaximumSize.QuadPart)) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00439 
00440         <span class="keywordflow">if</span> (SpecifiedSize.HighPart != 0) {
00441             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_3;
00442             <span class="keywordflow">goto</span> ErrorReturn0;
00443         }
00444 <span class="preprocessor">#else</span>
00445 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (CapturedMaximumSize.HighPart != 0) {
00446             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_3;
00447             <span class="keywordflow">goto</span> ErrorReturn0;
00448         }
00449 <span class="preprocessor">#endif</span>
00450 <span class="preprocessor"></span>
00451         <span class="keywordflow">if</span> (CapturedMinimumSize.QuadPart &gt; CapturedMaximumSize.QuadPart) {
00452             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_3;
00453             <span class="keywordflow">goto</span> ErrorReturn0;
00454         }
00455 
00456         CapturedName = *PageFileName;
00457         CapturedName.MaximumLength = CapturedName.Length;
00458 
00459         <span class="keywordflow">if</span> ((CapturedName.Length == 0) ||
00460             (CapturedName.Length &gt; MAXIMUM_FILENAME_LENGTH )) {
00461             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_INVALID;
00462             <span class="keywordflow">goto</span> ErrorReturn0;
00463         }
00464 
00465         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00466             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a> (CapturedName.Buffer,
00467                           CapturedName.Length,
00468                           <span class="keyword">sizeof</span>( UCHAR ));
00469         }
00470 
00471         CapturedBuffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (PagedPool,
00472                                                 (ULONG)CapturedName.Length,
00473                                                 '  mM');
00474 
00475         <span class="keywordflow">if</span> (CapturedBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00476             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00477             <span class="keywordflow">goto</span> ErrorReturn0;
00478         }
00479 
00480         <span class="comment">//</span>
00481         <span class="comment">// Copy the string to the allocated buffer.</span>
00482         <span class="comment">//</span>
00483 
00484         RtlMoveMemory (CapturedBuffer,
00485                        CapturedName.Buffer,
00486                        CapturedName.Length);
00487 
00488         <span class="comment">//</span>
00489         <span class="comment">// Point the buffer to the string that was just copied.</span>
00490         <span class="comment">//</span>
00491 
00492         CapturedName.Buffer = CapturedBuffer;
00493 
00494     } except (<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00495 
00496         <span class="comment">//</span>
00497         <span class="comment">// If an exception occurs during the probe or capture</span>
00498         <span class="comment">// of the initial values, then handle the exception and</span>
00499         <span class="comment">// return the exception code as the status value.</span>
00500         <span class="comment">//</span>
00501 
00502         <span class="keywordflow">if</span> (CapturedBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00503             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (CapturedBuffer);
00504         }
00505 
00506         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00507         <span class="keywordflow">goto</span> ErrorReturn0;
00508     }
00509 
00510     <span class="comment">//</span>
00511     <span class="comment">// Open a paging file and get the size.</span>
00512     <span class="comment">//</span>
00513 
00514     InitializeObjectAttributes( &amp;PagingFileAttributes,
00515                                 &amp;CapturedName,
00516                                 OBJ_CASE_INSENSITIVE,
00517                                 NULL,
00518                                 NULL );
00519 
00520 <span class="preprocessor">#if defined (_WIN64) || defined (_X86PAE_)</span>
00521 <span class="preprocessor"></span>    EndOfFileInformation.EndOfFile.QuadPart =
00522                                 <a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a> (CapturedMinimumSize.QuadPart);
00523 <span class="preprocessor">#else</span>
00524 <span class="preprocessor"></span>    EndOfFileInformation.EndOfFile.HighPart = 0;
00525 <span class="preprocessor">#endif</span>
00526 <span class="preprocessor"></span>    EndOfFileInformation.EndOfFile.LowPart = (ULONG)
00527                                 <a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a> (CapturedMinimumSize.LowPart);
00528 
00529     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a46">IoCreateFile</a>( &amp;FileHandle,
00530                            FILE_READ_DATA | FILE_WRITE_DATA | SYNCHRONIZE,
00531                            &amp;PagingFileAttributes,
00532                            &amp;IoStatus,
00533                            &amp;CapturedMinimumSize,
00534                            FILE_ATTRIBUTE_HIDDEN | FILE_ATTRIBUTE_SYSTEM,
00535                            FILE_SHARE_WRITE,
00536                            FILE_SUPERSEDE,
00537                            FILE_NO_INTERMEDIATE_BUFFERING | FILE_NO_COMPRESSION,
00538                            (PVOID) NULL,
00539                            0L,
00540                            CreateFileTypeNone,
00541                            (PVOID) NULL,
00542                            IO_OPEN_PAGING_FILE | IO_NO_PARAMETER_CHECKING );
00543 
00544     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00545 
00546         <span class="comment">//</span>
00547         <span class="comment">// Treat this as an extension of an existing pagefile maximum -</span>
00548         <span class="comment">// and try to open rather than create the paging file specified.</span>
00549         <span class="comment">//</span>
00550 
00551         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a46">IoCreateFile</a>( &amp;FileHandle,
00552                            FILE_WRITE_DATA | SYNCHRONIZE,
00553                            &amp;PagingFileAttributes,
00554                            &amp;IoStatus,
00555                            &amp;CapturedMinimumSize,
00556                            FILE_ATTRIBUTE_HIDDEN | FILE_ATTRIBUTE_SYSTEM,
00557                            FILE_SHARE_READ | FILE_SHARE_WRITE,
00558                            FILE_OPEN,
00559                            FILE_NO_INTERMEDIATE_BUFFERING | FILE_NO_COMPRESSION,
00560                            (PVOID) NULL,
00561                            0L,
00562                            CreateFileTypeNone,
00563                            (PVOID) NULL,
00564                            IO_OPEN_PAGING_FILE | IO_NO_PARAMETER_CHECKING );
00565 
00566         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00567 
00568 <span class="preprocessor">#if DBG</span>
00569 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_DISK_FULL) {
00570                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM MODWRITE: unable to open paging file %wZ - status = %X \n"</span>, &amp;CapturedName, Status);
00571             }
00572 <span class="preprocessor">#endif</span>
00573 <span class="preprocessor"></span>
00574             <span class="keywordflow">goto</span> ErrorReturn1;
00575         }
00576 
00577         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> ( FileHandle,
00578                                              FILE_READ_DATA | FILE_WRITE_DATA,
00579                                              IoFileObjectType,
00580                                              KernelMode,
00581                                              (PVOID *)&amp;File,
00582                                              NULL );
00583 
00584         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00585             <span class="keywordflow">goto</span> ErrorReturn2;
00586         }
00587 
00588         FoundExisting = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00589 
00590         ExAcquireFastMutex (&amp;MmPageFileCreationLock);
00591 
00592         <span class="keywordflow">for</span> (PageFileNumber = 0; PageFileNumber &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>; PageFileNumber += 1) {
00593             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o10">File</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o6">SectionObjectPointer</a> == <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer) {
00594                 FoundExisting = <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber];
00595                 <span class="keywordflow">break</span>;
00596             }
00597         }
00598 
00599         <span class="keywordflow">if</span> (FoundExisting == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00600             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_FOUND;
00601             <span class="keywordflow">goto</span> ErrorReturn4;
00602         }
00603 
00604         <span class="comment">//</span>
00605         <span class="comment">// Check for increases in the minimum or the maximum paging file sizes.</span>
00606         <span class="comment">// Decreasing either paging file size on the fly is not allowed.</span>
00607         <span class="comment">//</span>
00608 
00609         NewMaxSizeInPages = (ULONG)(CapturedMaximumSize.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00610         NewMinSizeInPages = (ULONG)(CapturedMinimumSize.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00611 
00612         <span class="keywordflow">if</span> (FoundExisting-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">MinimumSize</a> &gt; NewMinSizeInPages) {
00613             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_2;
00614             <span class="keywordflow">goto</span> ErrorReturn4;
00615         }
00616 
00617         <span class="keywordflow">if</span> (FoundExisting-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o1">MaximumSize</a> &gt; NewMaxSizeInPages) {
00618             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_3;
00619             <span class="keywordflow">goto</span> ErrorReturn4;
00620         }
00621 
00622         <span class="keywordflow">if</span> (NewMaxSizeInPages &gt; FoundExisting-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o1">MaximumSize</a>) {
00623 
00624             <span class="comment">//</span>
00625             <span class="comment">// Make sure that the pagefile increase doesn't cause the commit</span>
00626             <span class="comment">// limit (in pages) to wrap.  Currently this can only happen on</span>
00627             <span class="comment">// PAE systems where 16 pagefiles of 16TB (==256TB) is greater</span>
00628             <span class="comment">// than the 32-bit commit variable (max is 16TB).</span>
00629             <span class="comment">//</span>
00630 
00631             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a> + (NewMaxSizeInPages - FoundExisting-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o1">MaximumSize</a>) &lt;= <a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a>) {
00632                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_3;
00633                 <span class="keywordflow">goto</span> ErrorReturn4;
00634             }
00635 
00636             <span class="comment">//</span>
00637             <span class="comment">// Handle the increase to the maximum paging file size.</span>
00638             <span class="comment">//</span>
00639 
00640             <a class="code" href="../../d4/d8/mi_8h.html#a233">MiCreateBitMap</a> (&amp;NewBitmap, NewMaxSizeInPages, NonPagedPool);
00641     
00642             <span class="keywordflow">if</span> (NewBitmap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00643                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00644                 <span class="keywordflow">goto</span> ErrorReturn4;
00645             }
00646     
00647             OldBitmap = FoundExisting-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o9">Bitmap</a>;
00648     
00649             <a class="code" href="../../d6/d3/modwrite_8c.html#a32">MiExtendPagingFileMaximum</a> (PageFileNumber, NewBitmap);
00650     
00651             <a class="code" href="../../d4/d8/mi_8h.html#a234">MiRemoveBitMap</a> (&amp;OldBitmap);
00652     
00653             <span class="comment">//</span>
00654             <span class="comment">// We may be low on commitment and/or may have put a temporary</span>
00655             <span class="comment">// stopgate on things.  Clear up the logjam now by forcing an</span>
00656             <span class="comment">// extension and immediately returning it.</span>
00657             <span class="comment">//</span>
00658 
00659             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> + 100 &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a>) {
00660                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a17">MiChargeCommitment</a> (200, NULL) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00661                     <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (200);
00662                 }
00663             }
00664         }
00665     
00666         <span class="keywordflow">if</span> (NewMinSizeInPages &gt; FoundExisting-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">MinimumSize</a>) {
00667 
00668             <span class="comment">//</span>
00669             <span class="comment">// Handle the increase to the minimum paging file size.</span>
00670             <span class="comment">//</span>
00671 
00672             <span class="keywordflow">if</span> (NewMinSizeInPages &gt; FoundExisting-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a>) {
00673 
00674                 <span class="comment">//</span>
00675                 <span class="comment">// Queue a message to the segment dereferencing / pagefile</span>
00676                 <span class="comment">// extending thread to see if the page file can be extended.</span>
00677                 <span class="comment">//</span>
00678         
00679                 PageExtend.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o2">RequestedExpansionSize</a> = NewMinSizeInPages - FoundExisting-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a>;
00680                 PageExtend.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o0">Segment</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00681                 PageExtend.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o6">PageFileNumber</a> = PageFileNumber;
00682                 <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;PageExtend.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o4">Event</a>, NotificationEvent, FALSE);
00683 
00684                 <a class="code" href="../../d6/d3/modwrite_8c.html#a58">MiIssuePageExtendRequest</a> (&amp;PageExtend);
00685             }
00686 
00687             <span class="comment">//</span>
00688             <span class="comment">// The current size is now greater than the new desired minimum.</span>
00689             <span class="comment">// Ensure subsequent contractions obey this new minimum.</span>
00690             <span class="comment">//</span>
00691 
00692             <span class="keywordflow">if</span> (FoundExisting-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a> &gt;= NewMinSizeInPages) {
00693                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FoundExisting-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a> &gt;= FoundExisting-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">MinimumSize</a>);
00694                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NewMinSizeInPages &gt;= FoundExisting-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">MinimumSize</a>);
00695                 FoundExisting-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">MinimumSize</a> = NewMinSizeInPages;
00696             }
00697             <span class="keywordflow">else</span> {
00698 
00699                 <span class="comment">//</span>
00700                 <span class="comment">// The pagefile could not be expanded to handle the new minimum.</span>
00701                 <span class="comment">// No easy way to undo any maximum raising that may have been</span>
00702                 <span class="comment">// done as the space may have already been used, so just set</span>
00703                 <span class="comment">// Status so our caller knows it didn't all go perfectly.</span>
00704                 <span class="comment">//</span>
00705 
00706                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00707             }
00708         }
00709 
00710         <span class="keywordflow">goto</span> ErrorReturn4;
00711     }
00712 
00713     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IoStatus.Status)) {
00714         KdPrint((<span class="stringliteral">"MM MODWRITE: unable to open paging file %wZ - iosb %lx\n"</span>, &amp;CapturedName, IoStatus.Status));
00715         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IoStatus.Status;
00716         <span class="keywordflow">goto</span> ErrorReturn1;
00717     }
00718 
00719     <span class="comment">//</span>
00720     <span class="comment">// Make sure that the pagefile increase doesn't cause the commit</span>
00721     <span class="comment">// limit (in pages) to wrap.  Currently this can only happen on</span>
00722     <span class="comment">// PAE systems where 16 pagefiles of 16TB (==256TB) is greater</span>
00723     <span class="comment">// than the 32-bit commit variable (max is 16TB).</span>
00724     <span class="comment">//</span>
00725 
00726     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a> + (CapturedMaximumSize.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)
00727         &lt;= <a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a>) {
00728         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_3;
00729         <span class="keywordflow">goto</span> ErrorReturn2;
00730     }
00731 
00732     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a39">ZwSetInformationFile</a> (FileHandle,
00733                                    &amp;IoStatus,
00734                                    &amp;EndOfFileInformation,
00735                                    <span class="keyword">sizeof</span>(EndOfFileInformation),
00736                                    FileEndOfFileInformation);
00737 
00738     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00739         KdPrint((<span class="stringliteral">"MM MODWRITE: unable to set length of paging file %wZ status = %X \n"</span>,
00740                  &amp;CapturedName, Status));
00741         <span class="keywordflow">goto</span> ErrorReturn2;
00742     }
00743 
00744     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IoStatus.Status)) {
00745         KdPrint((<span class="stringliteral">"MM MODWRITE: unable to set length of paging file %wZ - iosb %lx\n"</span>,
00746                 &amp;CapturedName, IoStatus.Status));
00747         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IoStatus.Status;
00748         <span class="keywordflow">goto</span> ErrorReturn2;
00749     }
00750 
00751     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> ( FileHandle,
00752                                          FILE_READ_DATA | FILE_WRITE_DATA,
00753                                          IoFileObjectType,
00754                                          KernelMode,
00755                                          (PVOID *)&amp;File,
00756                                          NULL );
00757 
00758     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00759         KdPrint((<span class="stringliteral">"MM MODWRITE: Unable to reference paging file - %wZ\n"</span>,
00760                  &amp;CapturedName));
00761         <span class="keywordflow">goto</span> ErrorReturn2;
00762     }
00763 
00764     <span class="comment">//</span>
00765     <span class="comment">// Get the address of the target device object and ensure</span>
00766     <span class="comment">// the specified file is of a suitable type.</span>
00767     <span class="comment">//</span>
00768 
00769     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a> (File);
00770 
00771     <span class="keywordflow">if</span> ((deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o12">DeviceType</a> != FILE_DEVICE_DISK_FILE_SYSTEM) &amp;&amp;
00772         (deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o12">DeviceType</a> != FILE_DEVICE_NETWORK_FILE_SYSTEM) &amp;&amp;
00773         (deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o12">DeviceType</a> != FILE_DEVICE_DFS_VOLUME) &amp;&amp;
00774         (deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o12">DeviceType</a> != FILE_DEVICE_DFS_FILE_SYSTEM)) {
00775             KdPrint((<span class="stringliteral">"MM MODWRITE: Invalid paging file type - %x\n"</span>,
00776                      deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o12">DeviceType</a>));
00777             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNRECOGNIZED_VOLUME;
00778             <span class="keywordflow">goto</span> ErrorReturn3;
00779     }
00780 
00781     <span class="comment">//</span>
00782     <span class="comment">// Make sure the specified file is not currently being used</span>
00783     <span class="comment">// as a mapped data file.</span>
00784     <span class="comment">//</span>
00785 
00786     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/modwrite_8c.html#a33">MiCheckPageFileMapping</a> (File);
00787     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00788         <span class="keywordflow">goto</span> ErrorReturn3;
00789     }
00790 
00791     <span class="comment">//</span>
00792     <span class="comment">// Make sure the volume is not a floppy disk.</span>
00793     <span class="comment">//</span>
00794 
00795     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a91">IoQueryVolumeInformation</a> ( File,
00796                                         FileFsDeviceInformation,
00797                                         <span class="keyword">sizeof</span>(FILE_FS_DEVICE_INFORMATION),
00798                                         &amp;FileDeviceInfo,
00799                                         &amp;ReturnedLength
00800                                       );
00801 
00802     <span class="keywordflow">if</span> (FILE_FLOPPY_DISKETTE &amp; FileDeviceInfo.Characteristics) {
00803         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_FLOPPY_VOLUME;
00804         <span class="keywordflow">goto</span> ErrorReturn3;
00805     }
00806 
00807     <span class="comment">//</span>
00808     <span class="comment">// Check with all of the drivers along the path to the file to ensure</span>
00809     <span class="comment">// that they are willing to follow the rules required of them and to</span>
00810     <span class="comment">// give them a chance to lock down code and data that needs to be locked.</span>
00811     <span class="comment">// If any of the drivers along the path refuses to participate, fail the</span>
00812     <span class="comment">// pagefile creation.</span>
00813     <span class="comment">//</span>
00814     <span class="comment">// BUGBUG: Failing the pagefile creation is commented out until the</span>
00815     <span class="comment">// storage drivers have been modified to correctly handle this request.</span>
00816     <span class="comment">//</span>
00817 
00818     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d8/sysload_8c.html#a50">MiCheckPageFilePath</a> (File);
00819     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00820         KdPrint(( <span class="stringliteral">"MiCheckPageFilePath(%wZ) FAILED: %x\n"</span>, &amp;CapturedName, Status ));
00821         <span class="comment">//goto ErrorReturn3;</span>
00822     }
00823 
00824     <span class="comment">//</span>
00825     <span class="comment">// Acquire the global page file creation mutex.</span>
00826     <span class="comment">//</span>
00827 
00828     ExAcquireFastMutex (&amp;MmPageFileCreationLock);
00829 
00830     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>] = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
00831                                                         <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html">MMPAGING_FILE</a>),
00832                                                         '  mM');
00833     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00834 
00835         <span class="comment">//</span>
00836         <span class="comment">// Allocate pool failed.</span>
00837         <span class="comment">//</span>
00838 
00839         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00840         <span class="keywordflow">goto</span> ErrorReturn4;
00841     }
00842 
00843     RtlZeroMemory (MmPagingFile[MmNumberOfPagingFiles], <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html">MMPAGING_FILE</a>));
00844     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o10">File</a> = <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>;
00845     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a> = (ULONG)(
00846                                                 CapturedMinimumSize.QuadPart
00847                                                 &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00848 
00849     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">MinimumSize</a> =
00850                                       <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a>;
00851     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> =
00852                                       <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a> - 1;
00853 
00854     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o1">MaximumSize</a> = (PFN_NUMBER)(
00855                                                 CapturedMaximumSize.QuadPart &gt;&gt;
00856                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00857 
00858     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o12">PageFileNumber</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>;
00859 
00860     <span class="comment">//</span>
00861     <span class="comment">// Adjust the commit page limit to reflect the new page file space.</span>
00862     <span class="comment">//</span>
00863 
00864     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o8">Entry</a>[0] = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
00865                                             <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">MMMOD_WRITER_MDL_ENTRY</a>) +
00866                                             MmModifiedWriteClusterSize *
00867                                             <span class="keyword">sizeof</span>(PFN_NUMBER),
00868                                             '  mM');
00869 
00870     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o8">Entry</a>[0] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00871 
00872         <span class="comment">//</span>
00873         <span class="comment">// Allocate pool failed.</span>
00874         <span class="comment">//</span>
00875 
00876         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00877         <span class="keywordflow">goto</span> ErrorReturn5;
00878     }
00879 
00880     RtlZeroMemory (MmPagingFile[MmNumberOfPagingFiles]-&gt;Entry[0],
00881                    <span class="keyword">sizeof</span>(MMMOD_WRITER_MDL_ENTRY));
00882 
00883     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o8">Entry</a>[0]-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o7">PagingListHead</a> =
00884                                           &amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>;
00885     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o8">Entry</a>[0]-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o9">PagingFile</a> =
00886                                           <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>];
00887 
00888     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o8">Entry</a>[1] = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
00889                                             <span class="keyword">sizeof</span>(MMMOD_WRITER_MDL_ENTRY) +
00890                                             MmModifiedWriteClusterSize *
00891                                             <span class="keyword">sizeof</span>(PFN_NUMBER),
00892                                             '  mM');
00893 
00894     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o8">Entry</a>[1] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00895 
00896         <span class="comment">//</span>
00897         <span class="comment">// Allocate pool failed.</span>
00898         <span class="comment">//</span>
00899 
00900         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00901         <span class="keywordflow">goto</span> ErrorReturn6;
00902     }
00903 
00904     RtlZeroMemory (MmPagingFile[MmNumberOfPagingFiles]-&gt;Entry[1],
00905                    <span class="keyword">sizeof</span>(MMMOD_WRITER_MDL_ENTRY));
00906 
00907     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o8">Entry</a>[1]-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o7">PagingListHead</a> =
00908                                           &amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>;
00909     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o8">Entry</a>[1]-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o9">PagingFile</a> =
00910                                           <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>];
00911 
00912     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o11">PageFileName</a> = CapturedName;
00913 
00914     <a class="code" href="../../d4/d8/mi_8h.html#a233">MiCreateBitMap</a> (&amp;MmPagingFile[MmNumberOfPagingFiles]-&gt;Bitmap,
00915                     MmPagingFile[MmNumberOfPagingFiles]-&gt;MaximumSize,
00916                     NonPagedPool);
00917 
00918     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o9">Bitmap</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00919 
00920         <span class="comment">//</span>
00921         <span class="comment">// Allocate pool failed.</span>
00922         <span class="comment">//</span>
00923 
00924         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00925         <span class="keywordflow">goto</span> ErrorReturn7;
00926     }
00927 
00928     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a28">RtlSetAllBits</a> (MmPagingFile[MmNumberOfPagingFiles]-&gt;Bitmap);
00929 
00930     <span class="comment">//</span>
00931     <span class="comment">// Set the first bit as 0 is an invalid page location, clear the</span>
00932     <span class="comment">// following bits.</span>
00933     <span class="comment">//</span>
00934 
00935     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a> (MmPagingFile[MmNumberOfPagingFiles]-&gt;Bitmap,
00936                   1,
00937                   (ULONG)(MmPagingFile[MmNumberOfPagingFiles]-&gt;Size - 1));
00938 
00939     PageFileNumber = <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>;
00940     <a class="code" href="../../d6/d3/modwrite_8c.html#a34">MiInsertPageFileInList</a> ();
00941 
00942     FinalStatus = <a class="code" href="../../d6/d3/modwrite_8c.html#a29">MiCheckForCrashDump</a> (File, PageFileNumber);
00943 
00944     <span class="keywordflow">if</span> (PageFileNumber == 0) {
00945 
00946         <span class="comment">//</span>
00947         <span class="comment">// The first paging file has been created and reservation of any</span>
00948         <span class="comment">// crashdump pages has completed, signal the modified</span>
00949         <span class="comment">// page writer.</span>
00950         <span class="comment">//</span>
00951 
00952         <a class="code" href="../../d6/d3/modwrite_8c.html#a42">MiReleaseModifiedWriter</a> ();
00953     }
00954 
00955     ExReleaseFastMutex (&amp;MmPageFileCreationLock);
00956 
00957     <span class="comment">//</span>
00958     <span class="comment">// Note that the file handle is not closed to prevent the</span>
00959     <span class="comment">// paging file from being deleted or opened again.  (Actually,</span>
00960     <span class="comment">// the file handle is duped to the system process so process</span>
00961     <span class="comment">// termination will not close the handle).</span>
00962     <span class="comment">//</span>
00963 
00964     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a3">ObOpenObjectByPointer</a>(
00965                 PsInitialSystemProcess,
00966                 0,
00967                 NULL,
00968                 0,
00969                 PsProcessType,
00970                 KernelMode,
00971                 &amp;SystemProcess
00972                 );
00973 
00974     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00975         ZwClose (FileHandle);
00976         <span class="keywordflow">return</span> FinalStatus;
00977     }
00978 
00979     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwDuplicateObject(
00980                 NtCurrentProcess(),
00981                 FileHandle,
00982                 SystemProcess,
00983                 NULL,
00984                 0,
00985                 0,
00986                 DUPLICATE_SAME_ATTRIBUTES | DUPLICATE_SAME_ACCESS
00987                 );
00988 
00989     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
00990 
00991     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d3/modwrite_8c.html#a24">MmSystemPageFileLocated</a>) {
00992         <a class="code" href="../../d6/d3/modwrite_8c.html#a24">MmSystemPageFileLocated</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a88">IoPageFileCreated</a>(FileHandle);
00993     }
00994 
00995     ZwClose (SystemProcess);
00996     ZwClose (FileHandle);
00997 
00998     <span class="keywordflow">return</span> FinalStatus;
00999 
01000     <span class="comment">//</span>
01001     <span class="comment">// Error returns:</span>
01002     <span class="comment">//</span>
01003 
01004 ErrorReturn7:
01005     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (MmPagingFile[MmNumberOfPagingFiles]-&gt;Entry[0]);
01006 
01007 ErrorReturn6:
01008     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (MmPagingFile[MmNumberOfPagingFiles]-&gt;Entry[1]);
01009 
01010 ErrorReturn5:
01011     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (MmPagingFile[MmNumberOfPagingFiles]);
01012 
01013 ErrorReturn4:
01014     ExReleaseFastMutex (&amp;MmPageFileCreationLock);
01015 
01016 ErrorReturn3:
01017     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (File);
01018 
01019 ErrorReturn2:
01020     ZwClose (FileHandle);
01021 
01022 ErrorReturn1:
01023     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (CapturedBuffer);
01024 
01025 ErrorReturn0:
01026     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01027 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a12" doxytag="modwrite.c::IoFileObjectType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="el" href="../../d3/d4/vdm_2vdm_8c.html#a2">IoFileObjectType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00085">85</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="modwrite.c::MiFirstPageFileCreatedAndReady" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL <a class="el" href="../../d6/d3/modwrite_8c.html#a10">MiFirstPageFileCreatedAndReady</a> = FALSE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00043">43</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02831">MiModifiedPageWriterWorker()</a>, and <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00275">MiReleaseModifiedWriter()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="modwrite.c::MiPageFileFullCharge" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> SIZE_T <a class="el" href="../../d6/d3/modwrite_8c.html#a21">MiPageFileFullCharge</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00104">104</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04709">MiPageFileFull()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="modwrite.c::MmCrashDumpSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d8/mi_8h.html#a480">PSECTION</a> <a class="el" href="../../d6/d3/modwrite_8c.html#a11">MmCrashDumpSection</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00083">83</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01095">MiCheckForCrashDump()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01338">MiCrashDumpWorker()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01392">MmGetCrashDumpInformation()</a>, and <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01452">MmGetCrashDumpStateInformation()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="modwrite.c::MmMappedFileIoComplete" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="el" href="../../d6/d3/modwrite_8c.html#a16">MmMappedFileIoComplete</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00092">92</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01075">MiCleanSection()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02234">MiWriteComplete()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>, and <a class="el" href="../../d7/d4/flushsec_8c-source.html#l01548">MmPurgeSection()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="modwrite.c::MmMappedPageWriterEvent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="el" href="../../d6/d3/modwrite_8c.html#a15">MmMappedPageWriterEvent</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00090">90</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l03198">MiGatherMappedPages()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04239">MiMappedPageWriter()</a>, and <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02669">MiModifiedPageWriter()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="modwrite.c::MmMappedPageWriterList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d6/d3/modwrite_8c.html#a14">MmMappedPageWriterList</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00088">88</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02579">MiCancelWriteOfMappedPfn()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l03198">MiGatherMappedPages()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04239">MiMappedPageWriter()</a>, and <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02669">MiModifiedPageWriter()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="modwrite.c::MmModNoWriteInsert" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d6/d3/modwrite_8c.html#a23">MmModNoWriteInsert</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00108">108</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l03198">MiGatherMappedPages()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02831">MiModifiedPageWriterWorker()</a>, and <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00336">MiObtainFreePages()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="modwrite.c::MmMoreThanEnoughFreePages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PFN_NUMBER <a class="el" href="../../d5/d0/wsmanage_8c.html#a9">MmMoreThanEnoughFreePages</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00149">149</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="modwrite.c::MmOverCommit2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> SIZE_T <a class="el" href="../../d6/d3/modwrite_8c.html#a18">MmOverCommit2</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00096">96</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04607">MiInsertPageFileInList()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="modwrite.c::MmPageFileFullExtendCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d6/d3/modwrite_8c.html#a20">MmPageFileFullExtendCount</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00100">100</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04709">MiPageFileFull()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="modwrite.c::MmPageFileFullExtendPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> SIZE_T <a class="el" href="../../d6/d3/modwrite_8c.html#a19">MmPageFileFullExtendPages</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00098">98</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/mmquota_8c-source.html#l01001">MiCauseOverCommitPopup()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00191">MiChargeCommitment()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01681">MiExtendPagingFiles()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04709">MiPageFileFull()</a>, and <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="modwrite.c::MmPageFileFullPopupShown" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL <a class="el" href="../../d6/d3/modwrite_8c.html#a22">MmPageFileFullPopupShown</a> = FALSE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00106">106</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04709">MiPageFileFull()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="modwrite.c::MmSystemPageFileLocated" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d6/d3/modwrite_8c.html#a24">MmSystemPageFileLocated</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00110">110</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00297">NtCreatePagingFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="modwrite.c::MmSystemShutdown" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d1/d9/shutdown_8c.html#a0">MmSystemShutdown</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00094">94</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02669">MiModifiedPageWriter()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02831">MiModifiedPageWriterWorker()</a>, and <a class="el" href="../../d2/d8/shutdown_8c-source.html#l00041">MmShutdownSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="modwrite.c::MmWriteAllModifiedPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d6/d3/modwrite_8c.html#a9">MmWriteAllModifiedPages</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00042">42</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04870">MiFlushAllPages()</a>, and <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02831">MiModifiedPageWriterWorker()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="modwrite.c::PspInitialSystemProcessHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HANDLE <a class="el" href="../../d8/d1/psp_8h.html#a28">PspInitialSystemProcessHandle</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00086">86</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00915">PsCreateSystemProcess()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>, and <a class="el" href="../../d1/d0/psinit_8c-source.html#l00181">PspInitPhase0()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:48 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
