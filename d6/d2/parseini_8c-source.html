<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: parseini.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>parseini.c</h1><a href="../../d5/d3/parseini_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1998  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment"></span>
00006 <span class="comment">Module Name:</span>
00007 <span class="comment"></span>
00008 <span class="comment">    parseini.c</span>
00009 <span class="comment"></span>
00010 <span class="comment">Abstract:</span>
00011 <span class="comment"></span>
00012 <span class="comment">    This modules contains routines to parse an inf file. This is based on</span>
00013 <span class="comment">    the code from the osloader. All indices are zero based.</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    Santosh Jodh (santoshj) 08-Aug-1998</span>
00018 <span class="comment"></span>
00019 <span class="comment"></span>
00020 <span class="comment">Environment:</span>
00021 <span class="comment"></span>
00022 <span class="comment">    Kernel mode.</span>
00023 <span class="comment"></span>
00024 <span class="comment">Revision History:</span>
00025 <span class="comment"></span>
00026 <span class="comment">--*/</span>
00027 
00028 <span class="preprocessor">#include "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00029 <span class="preprocessor">#include "string.h"</span>
00030 <span class="preprocessor">#include "ctype.h"</span>
00031 <span class="preprocessor">#include "stdlib.h"</span>
00032 <span class="preprocessor">#include "<a class="code" href="../../d6/d3/parseini_8h.html">parseini.h</a>"</span>
00033 
<a name="l00034"></a><a class="code" href="../../d5/d3/parseini_8c.html#a0">00034</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d5/d5/struct__value.html">_value</a>   VALUE,      *<a class="code" href="../../d5/d3/parseini_8c.html#a0">PVALUE</a>;
<a name="l00035"></a><a class="code" href="../../d5/d3/parseini_8c.html#a1">00035</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d7/d1/struct__line.html">_line</a>    LINE,       *<a class="code" href="../../d5/d3/parseini_8c.html#a1">PLINE</a>;
<a name="l00036"></a><a class="code" href="../../d5/d3/parseini_8c.html#a2">00036</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d4/d0/struct__section.html">_section</a> <a class="code" href="../../d4/d8/mi_8h.html#a479">SECTION</a>,    *<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>;
<a name="l00037"></a><a class="code" href="../../d5/d3/parseini_8c.html#a3">00037</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/d2/struct__inf.html">_inf</a>     INF,        *<a class="code" href="../../d5/d3/parseini_8c.html#a3">PINF</a>;
<a name="l00038"></a><a class="code" href="../../d5/d3/parseini_8c.html#a4">00038</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d7/d1/struct__token.html">_token</a>   <a class="code" href="../../d8/d3/tokenp_8h.html#a14">TOKEN</a>,      *<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>;
<a name="l00039"></a><a class="code" href="../../d5/d3/parseini_8c.html#a5">00039</a> <span class="keyword">typedef</span> <span class="keyword">enum</span> <a class="code" href="../../d5/d3/parseini_8c.html#a47">_tokentype</a> TOKENTYPE,  *<a class="code" href="../../d5/d3/parseini_8c.html#a5">PTOKENTTYPE</a>;
<a name="l00040"></a><a class="code" href="../../d5/d3/parseini_8c.html#a6">00040</a> <span class="keyword">typedef</span> <span class="keyword">enum</span> <a class="code" href="../../d5/d3/parseini_8c.html#a46">_stringsSectionType</a>    <a class="code" href="../../d5/d3/parseini_8c.html#a6">STRINGSSECTIONTYPE</a>;;
00041 
<a name="l00042"></a><a class="code" href="../../d5/d5/struct__value.html">00042</a> <span class="keyword">struct </span><a class="code" href="../../d5/d5/struct__value.html">_value</a>
00043 {
<a name="l00044"></a><a class="code" href="../../d5/d5/struct__value.html#o0">00044</a>     <a class="code" href="../../d5/d3/parseini_8c.html#a0">PVALUE</a>  <a class="code" href="../../d5/d5/struct__value.html#o0">pNext</a>;
<a name="l00045"></a><a class="code" href="../../d5/d5/struct__value.html#o1">00045</a>     PCHAR   <a class="code" href="../../d5/d5/struct__value.html#o1">pName</a>;
<a name="l00046"></a><a class="code" href="../../d5/d5/struct__value.html#o2">00046</a>     BOOLEAN <a class="code" href="../../d5/d5/struct__value.html#o2">Allocated</a>;
00047 };
00048 
<a name="l00049"></a><a class="code" href="../../d7/d1/struct__line.html">00049</a> <span class="keyword">struct </span><a class="code" href="../../d7/d1/struct__line.html">_line</a>
00050 {
<a name="l00051"></a><a class="code" href="../../d7/d1/struct__line.html#o0">00051</a>     <a class="code" href="../../d5/d3/parseini_8c.html#a1">PLINE</a>   <a class="code" href="../../d7/d1/struct__line.html#o0">pNext</a>;
<a name="l00052"></a><a class="code" href="../../d7/d1/struct__line.html#o1">00052</a>     PCHAR   <a class="code" href="../../d7/d1/struct__line.html#o1">pName</a>;
<a name="l00053"></a><a class="code" href="../../d7/d1/struct__line.html#o2">00053</a>     <a class="code" href="../../d5/d3/parseini_8c.html#a0">PVALUE</a>  <a class="code" href="../../d7/d1/struct__line.html#o2">pValue</a>;
<a name="l00054"></a><a class="code" href="../../d7/d1/struct__line.html#o3">00054</a>     BOOLEAN <a class="code" href="../../d7/d1/struct__line.html#o3">Allocated</a>;
00055 };
00056 
<a name="l00057"></a><a class="code" href="../../d4/d0/struct__section.html">00057</a> <span class="keyword">struct </span><a class="code" href="../../d4/d0/struct__section.html">_section</a>
00058 {
<a name="l00059"></a><a class="code" href="../../d4/d0/struct__section.html#o0">00059</a>     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>    <a class="code" href="../../d4/d0/struct__section.html#o0">pNext</a>;
<a name="l00060"></a><a class="code" href="../../d4/d0/struct__section.html#o1">00060</a>     PCHAR       <a class="code" href="../../d4/d0/struct__section.html#o1">pName</a>;
<a name="l00061"></a><a class="code" href="../../d4/d0/struct__section.html#o2">00061</a>     <a class="code" href="../../d5/d3/parseini_8c.html#a1">PLINE</a>       <a class="code" href="../../d4/d0/struct__section.html#o2">pLine</a>;
<a name="l00062"></a><a class="code" href="../../d4/d0/struct__section.html#o3">00062</a>     BOOLEAN     <a class="code" href="../../d4/d0/struct__section.html#o3">Allocated</a>;
00063 };
00064 
<a name="l00065"></a><a class="code" href="../../d0/d2/struct__inf.html">00065</a> <span class="keyword">struct </span><a class="code" href="../../d0/d2/struct__inf.html">_inf</a>
00066 {
<a name="l00067"></a><a class="code" href="../../d0/d2/struct__inf.html#o0">00067</a>     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>            <a class="code" href="../../d0/d2/struct__inf.html#o0">pSection</a>;
<a name="l00068"></a><a class="code" href="../../d0/d2/struct__inf.html#o1">00068</a>     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>            <a class="code" href="../../d0/d2/struct__inf.html#o1">pSectionRecord</a>;
<a name="l00069"></a><a class="code" href="../../d0/d2/struct__inf.html#o2">00069</a>     <a class="code" href="../../d5/d3/parseini_8c.html#a1">PLINE</a>               <a class="code" href="../../d0/d2/struct__inf.html#o2">pLineRecord</a>;
<a name="l00070"></a><a class="code" href="../../d0/d2/struct__inf.html#o3">00070</a>     <a class="code" href="../../d5/d3/parseini_8c.html#a0">PVALUE</a>              <a class="code" href="../../d0/d2/struct__inf.html#o3">pValueRecord</a>;
<a name="l00071"></a><a class="code" href="../../d0/d2/struct__inf.html#o4">00071</a>     <a class="code" href="../../d5/d3/parseini_8c.html#a6">STRINGSSECTIONTYPE</a>  <a class="code" href="../../d0/d2/struct__inf.html#o4">StringsSectionType</a>;
<a name="l00072"></a><a class="code" href="../../d0/d2/struct__inf.html#o5">00072</a>     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>            <a class="code" href="../../d0/d2/struct__inf.html#o5">StringsSection</a>;
00073 };
00074 
00075 <span class="comment">//</span>
00076 <span class="comment">// [Strings] section types.</span>
00077 <span class="comment">//</span>
<a name="l00078"></a><a class="code" href="../../d5/d3/parseini_8c.html#a46">00078</a> <span class="keyword">enum</span> <a class="code" href="../../d5/d3/parseini_8c.html#a46">_stringsSectionType</a>
00079 {
00080     <a class="code" href="../../d5/d3/parseini_8c.html#a46a11">StringsSectionNone</a>,
00081     <a class="code" href="../../d5/d3/parseini_8c.html#a46a12">StringsSectionPlain</a>,
00082     <a class="code" href="../../d5/d3/parseini_8c.html#a46a13">StringsSectionLoosePrimaryMatch</a>,
00083     <a class="code" href="../../d5/d3/parseini_8c.html#a46a14">StringsSectionExactPrimaryMatch</a>,
00084     <a class="code" href="../../d5/d3/parseini_8c.html#a46a15">StringsSectionExactMatch</a>
00085 };
00086 
<a name="l00087"></a><a class="code" href="../../d5/d3/parseini_8c.html#a47">00087</a> <span class="keyword">enum</span> <a class="code" href="../../d5/d3/parseini_8c.html#a47">_tokentype</a>
00088 {
00089     <a class="code" href="../../d5/d3/parseini_8c.html#a47a16">TOK_EOF</a>,
00090     <a class="code" href="../../d5/d3/parseini_8c.html#a47a17">TOK_EOL</a>,
00091     <a class="code" href="../../d5/d3/parseini_8c.html#a47a18">TOK_LBRACE</a>,
00092     <a class="code" href="../../d5/d3/parseini_8c.html#a47a19">TOK_RBRACE</a>,
00093     <a class="code" href="../../d5/d3/parseini_8c.html#a47a20">TOK_STRING</a>,
00094     <a class="code" href="../../d5/d3/parseini_8c.html#a47a21">TOK_EQUAL</a>,
00095     <a class="code" href="../../d5/d3/parseini_8c.html#a47a22">TOK_COMMA</a>,
00096     <a class="code" href="../../d5/d3/parseini_8c.html#a47a23">TOK_ERRPARSE</a>,
00097     <a class="code" href="../../d5/d3/parseini_8c.html#a47a24">TOK_ERRNOMEM</a>
00098 };
00099 
<a name="l00100"></a><a class="code" href="../../d7/d1/struct__token.html">00100</a> <span class="keyword">struct </span><a class="code" href="../../d7/d1/struct__token.html">_token</a>
00101 {
<a name="l00102"></a><a class="code" href="../../d7/d1/struct__token.html#o0">00102</a>     TOKENTYPE   <a class="code" href="../../d7/d1/struct__token.html#o0">Type</a>;
<a name="l00103"></a><a class="code" href="../../d7/d1/struct__token.html#o1">00103</a>     PCHAR       <a class="code" href="../../d7/d1/struct__token.html#o1">pValue</a>;
<a name="l00104"></a><a class="code" href="../../d7/d1/struct__token.html#o2">00104</a>     BOOLEAN     <a class="code" href="../../d7/d1/struct__token.html#o2">Allocated</a>;
00105 };
00106 
00107 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00108 <a class="code" href="../../d5/d3/parseini_8c.html#a25">CmpFreeValueList</a>(
00109     IN PVALUE pValue
00110     );
00111 
00112 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00113 <a class="code" href="../../d5/d3/parseini_8c.html#a26">CmpFreeLineList</a>(
00114     IN PLINE pLine
00115     );
00116 
00117 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00118 <a class="code" href="../../d5/d3/parseini_8c.html#a27">CmpFreeSectionList</a>(
00119     IN PSECTION pSection
00120     );
00121 
00122 PCHAR
00123 <a class="code" href="../../d5/d3/parseini_8c.html#a28">CmpProcessForSimpleStringSub</a>(
00124     IN PINF pInf,
00125     IN PCHAR String
00126     );
00127 
00128 BOOLEAN
00129 <a class="code" href="../../d5/d3/parseini_8c.html#a29">CmpAppendSection</a>(
00130     IN PINF  pInf,
00131     IN PCHAR pSectionName,
00132     IN BOOLEAN Allocated
00133     );
00134 
00135 BOOLEAN
00136 <a class="code" href="../../d5/d3/parseini_8c.html#a30">CmpAppendLine</a>(
00137     IN PINF pInf,
00138     IN PCHAR pLineKey,
00139     IN BOOLEAN Allocated
00140     );
00141 
00142 BOOLEAN
00143 <a class="code" href="../../d5/d3/parseini_8c.html#a31">CmpAppendValue</a>(
00144     IN PINF pInf,
00145     IN PCHAR pValueString,
00146     IN BOOLEAN Allocated
00147     );
00148 
00149 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00150 <a class="code" href="../../d5/d3/parseini_8c.html#a32">CmpGetToken</a>(
00151     IN OUT PCHAR *Stream,
00152     IN PCHAR MaxStream,
00153     IN OUT PULONG LineNumber,
00154     IN OUT PTOKEN Token
00155     );
00156 
00157 <a class="code" href="../../d5/d3/parseini_8c.html#a3">PINF</a>
00158 <a class="code" href="../../d5/d3/parseini_8c.html#a33">CmpParseInfBuffer</a>(
00159     IN PCHAR Buffer,
00160     IN ULONG Size,
00161     IN OUT PULONG ErrorLine
00162     );
00163 
00164 <a class="code" href="../../d5/d3/parseini_8c.html#a0">PVALUE</a>
00165 <a class="code" href="../../d5/d3/parseini_8c.html#a34">CmpSearchValueInLine</a>(
00166     IN PLINE pLine,
00167     IN ULONG ValueIndex
00168     );
00169 
00170 <a class="code" href="../../d5/d3/parseini_8c.html#a1">PLINE</a>
00171 <a class="code" href="../../d5/d3/parseini_8c.html#a35">CmpSearchLineInSectionByIndex</a>(
00172     IN PSECTION pSection,
00173     IN ULONG    LineIndex
00174     );
00175 
00176 <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>
00177 <a class="code" href="../../d5/d3/parseini_8c.html#a36">CmpSearchSectionByName</a>(
00178     IN PINF  pInf,
00179     IN PCHAR SectionName
00180     );
00181 
00182 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00183 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpFreeValueList)</span>
00184 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpFreeLineList)</span>
00185 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpFreeSectionList)</span>
00186 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpProcessForSimpleStringSub)</span>
00187 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpAppendSection)</span>
00188 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpAppendLine)</span>
00189 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpAppendValue)</span>
00190 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpGetToken)</span>
00191 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpParseInfBuffer)</span>
00192 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpSearchValueInLine)</span>
00193 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpSearchLineInSectionByIndex)</span>
00194 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpSearchSectionByName)</span>
00195 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpSearchInfLine)</span>
00196 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpOpenInfFile)</span>
00197 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpCloseInfFile)</span>
00198 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpGetKeyName)</span>
00199 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpSearchInfSection)</span>
00200 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpGetSectionLineIndex)</span>
00201 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpGetSectionLineIndexValueCount)</span>
00202 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpGetIntField)</span>
00203 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpGetBinaryField)</span>
00204 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00205 <span class="preprocessor"></span>
00206 
00207 <span class="comment">//</span>
00208 <span class="comment">// Globals used by the token parser.</span>
00209 <span class="comment">// String terminators are the whitespace characters (isspace: space, tab,</span>
00210 <span class="comment">// linefeed, formfeed, vertical tab, carriage return) or the chars given below.</span>
00211 <span class="comment">//</span>
00212 
<a name="l00213"></a><a class="code" href="../../d5/d3/parseini_8c.html#a7">00213</a> <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>  <a class="code" href="../../d5/d3/parseini_8c.html#a7">StringTerminators</a>[] = <span class="stringliteral">"[]=,\t \"\n\f\v\r"</span>;
<a name="l00214"></a><a class="code" href="../../d5/d3/parseini_8c.html#a8">00214</a> PCHAR <a class="code" href="../../d5/d3/parseini_8c.html#a8">QStringTerminators</a> = <a class="code" href="../../d5/d3/parseini_8c.html#a7">StringTerminators</a> + 6;
<a name="l00215"></a><a class="code" href="../../d5/d3/parseini_8c.html#a9">00215</a> PCHAR <a class="code" href="../../d5/d3/parseini_8c.html#a9">EmptyValue</a>;
<a name="l00216"></a><a class="code" href="../../d5/d3/parseini_8c.html#a10">00216</a> <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>  <a class="code" href="../../d5/d3/parseini_8c.html#a10">DblSpaceSection</a>[] = <span class="stringliteral">"DBLSPACE_SECTION"</span>;
00217 
00218 BOOLEAN
<a name="l00219"></a><a class="code" href="../../d5/d3/parseini_8c.html#a29">00219</a> <a class="code" href="../../d5/d3/parseini_8c.html#a29">CmpAppendSection</a>(
00220     IN PINF  pInf,
00221     IN PCHAR pSectionName,
00222     IN BOOLEAN Allocated
00223     )
00224 
00225 <span class="comment">/*++</span>
00226 <span class="comment"></span>
00227 <span class="comment">    Routine Description:</span>
00228 <span class="comment"></span>
00229 <span class="comment">        This routine creates a new section or merges with an existing section in the inf.</span>
00230 <span class="comment"></span>
00231 <span class="comment">    Input Parameters:</span>
00232 <span class="comment"></span>
00233 <span class="comment">        pInf - Pointer to the inf to be processed.</span>
00234 <span class="comment"></span>
00235 <span class="comment">        pSectionName - Name of the section.</span>
00236 <span class="comment"></span>
00237 <span class="comment">        Allocated - TRUE if memory was allocated for the section name.</span>
00238 <span class="comment"></span>
00239 <span class="comment">    Return Value:</span>
00240 <span class="comment"></span>
00241 <span class="comment">        TRUE iff successful.</span>
00242 <span class="comment"></span>
00243 <span class="comment">--*/</span>
00244 
00245 {
00246     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>            pNewSection;
00247     <a class="code" href="../../d5/d3/parseini_8c.html#a1">PLINE</a>               pLineRecord;
00248     <a class="code" href="../../d5/d3/parseini_8c.html#a6">STRINGSSECTIONTYPE</a>  <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>;
00249     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>              <span class="keywordtype">id</span>;
00250     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>              threadLang;
00251     PCHAR               p;
00252 
00253     <span class="comment">//</span>
00254     <span class="comment">// Check to see if INF initialised and the parameters passed in is valid</span>
00255     <span class="comment">//</span>
00256 
00257     <span class="keywordflow">if</span> (    pInf == (<a class="code" href="../../d5/d3/parseini_8c.html#a3">PINF</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
00258             pSectionName == (PCHAR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00259     {
00260         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00261     }
00262 
00263     <span class="comment">//</span>
00264     <span class="comment">// See if we already have a section by this name. If so we want</span>
00265     <span class="comment">// to merge sections.</span>
00266     <span class="comment">//</span>
00267 
00268     <span class="keywordflow">for</span>(    pNewSection = pInf-&gt;pSection;
00269             pNewSection;
00270             pNewSection = pNewSection-&gt;pNext)
00271     {
00272         <span class="keywordflow">if</span>(pNewSection-&gt;pName &amp;&amp; _stricmp(pNewSection-&gt;pName,pSectionName) == 0)
00273         {
00274             <span class="keywordflow">break</span>;
00275         }
00276     }
00277 
00278     <span class="keywordflow">if</span>(pNewSection)
00279     {
00280         <span class="comment">//</span>
00281         <span class="comment">// Set pLineRecord to point to the last line currently in the section.</span>
00282         <span class="comment">//</span>
00283 
00284         <span class="keywordflow">for</span>(    pLineRecord = pNewSection-&gt;pLine;
00285                 pLineRecord &amp;&amp; pLineRecord-&gt;pNext;
00286                 pLineRecord = pLineRecord-&gt;pNext);
00287 
00288         pInf-&gt;pLineRecord = pLineRecord;
00289     }
00290     <span class="keywordflow">else</span>
00291     {
00292         <span class="comment">//</span>
00293         <span class="comment">// Allocate memory for the new section</span>
00294         <span class="comment">//</span>
00295 
00296         pNewSection = (<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a479">SECTION</a>), CM_PARSEINI_TAG);
00297 
00298         <span class="keywordflow">if</span> (pNewSection == (<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00299         {
00300             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pNewSection);
00301             <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00302         }
00303 
00304         <span class="comment">//</span>
00305         <span class="comment">// Initialize the new section.</span>
00306         <span class="comment">//</span>
00307 
00308         pNewSection-&gt;pNext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00309         pNewSection-&gt;pLine = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00310         pNewSection-&gt;pName = pSectionName;
00311         pNewSection-&gt;Allocated = Allocated;
00312 
00313         <span class="comment">//</span>
00314         <span class="comment">// Link it in.</span>
00315         <span class="comment">//</span>
00316 
00317         pNewSection-&gt;pNext = pInf-&gt;pSection;
00318         pInf-&gt;pSection = pNewSection;
00319 
00320         <span class="keywordflow">if</span>(_strnicmp(pSectionName, <span class="stringliteral">"Strings"</span>, 7) == 0)
00321         {
00322             <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> = <a class="code" href="../../d5/d3/parseini_8c.html#a46a11">StringsSectionNone</a>;
00323 
00324             <span class="keywordflow">if</span>(pSectionName[7] == <span class="charliteral">'.'</span>)
00325             {
00326                 <span class="comment">//</span>
00327                 <span class="comment">// The langid part must be in the form of 4 hex digits.</span>
00328                 <span class="comment">//</span>
00329 
00330                 <span class="keywordtype">id</span> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)strtoul(pSectionName + 8, &amp;p, 16);
00331                 <span class="keywordflow">if</span>(p == (pSectionName + 8 + 5) &amp;&amp; *p == <span class="charliteral">'\0'</span>)
00332                 {
00333                     threadLang = LANGIDFROMLCID(NtCurrentTeb()-&gt;CurrentLocale);
00334 
00335                     <span class="keywordflow">if</span>(threadLang == <span class="keywordtype">id</span>)
00336                     {
00337                         <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> = <a class="code" href="../../d5/d3/parseini_8c.html#a46a15">StringsSectionExactMatch</a>;
00338                     }
00339                     <span class="keywordflow">else</span>
00340                     {
00341                         <span class="keywordflow">if</span>(<span class="keywordtype">id</span> == PRIMARYLANGID(threadLang))
00342                         {
00343                             <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> = <a class="code" href="../../d5/d3/parseini_8c.html#a46a14">StringsSectionExactPrimaryMatch</a>;
00344                         }
00345                         <span class="keywordflow">else</span>
00346                         {
00347                             <span class="keywordflow">if</span>(PRIMARYLANGID(<span class="keywordtype">id</span>) == PRIMARYLANGID(threadLang))
00348                             {
00349                                 <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> = <a class="code" href="../../d5/d3/parseini_8c.html#a46a13">StringsSectionLoosePrimaryMatch</a>;
00350                             }
00351                         }
00352                     }
00353                 }
00354             }
00355             <span class="keywordflow">else</span>
00356             {
00357                 <span class="keywordflow">if</span>(!pSectionName[7])
00358                 {
00359                     <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> = <a class="code" href="../../d5/d3/parseini_8c.html#a46a12">StringsSectionPlain</a>;
00360                 }
00361             }
00362 
00363             <span class="keywordflow">if</span>(<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> &gt; pInf-&gt;StringsSectionType)
00364             {
00365                 pInf-&gt;StringsSection = pNewSection;
00366             }
00367         }
00368 
00369         <span class="comment">//</span>
00370         <span class="comment">// Reset the current line record.</span>
00371         <span class="comment">//</span>
00372 
00373         pInf-&gt;pLineRecord = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00374     }
00375 
00376     pInf-&gt;pSectionRecord = pNewSection;
00377     pInf-&gt;pValueRecord = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00378 
00379     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00380 }
00381 
00382 BOOLEAN
<a name="l00383"></a><a class="code" href="../../d5/d3/parseini_8c.html#a30">00383</a> <a class="code" href="../../d5/d3/parseini_8c.html#a30">CmpAppendLine</a>(
00384     IN PINF pInf,
00385     IN PCHAR pLineKey,
00386     IN BOOLEAN Allocated
00387     )
00388 
00389 <span class="comment">/*++</span>
00390 <span class="comment"></span>
00391 <span class="comment">    Routine Description:</span>
00392 <span class="comment"></span>
00393 <span class="comment">        This routine creates a new line and appends it to the end of the line list.</span>
00394 <span class="comment"></span>
00395 <span class="comment">    Input Parameters:</span>
00396 <span class="comment"></span>
00397 <span class="comment">        pInf - Pointer to the inf to be processed.</span>
00398 <span class="comment"></span>
00399 <span class="comment">        pLineKey - Name of the line.</span>
00400 <span class="comment"></span>
00401 <span class="comment">        Allocated - TRUE if memory was allocated for the line name.</span>
00402 <span class="comment"></span>
00403 <span class="comment">    Return Value:</span>
00404 <span class="comment"></span>
00405 <span class="comment">        TRUE iff successful.</span>
00406 <span class="comment"></span>
00407 <span class="comment">--*/</span>
00408 
00409 {
00410     <a class="code" href="../../d5/d3/parseini_8c.html#a1">PLINE</a> pNewLine;
00411 
00412     <span class="comment">//</span>
00413     <span class="comment">// Check to see if current section initialized.</span>
00414     <span class="comment">//</span>
00415 
00416     <span class="keywordflow">if</span> (pInf-&gt;pSectionRecord == (<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00417     {
00418         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00419     }
00420 
00421     <span class="comment">//</span>
00422     <span class="comment">// Allocate memory for the new Line.</span>
00423     <span class="comment">//</span>
00424 
00425     pNewLine = (<a class="code" href="../../d5/d3/parseini_8c.html#a1">PLINE</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>(LINE), CM_PARSEINI_TAG);
00426     <span class="keywordflow">if</span> (pNewLine == (<a class="code" href="../../d5/d3/parseini_8c.html#a1">PLINE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00427     {
00428         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pNewLine);
00429         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00430     }
00431 
00432     <span class="comment">//</span>
00433     <span class="comment">// Link it in.</span>
00434     <span class="comment">//</span>
00435 
00436     pNewLine-&gt;pNext  = (<a class="code" href="../../d5/d3/parseini_8c.html#a1">PLINE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00437     pNewLine-&gt;pValue = (<a class="code" href="../../d5/d3/parseini_8c.html#a0">PVALUE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00438     pNewLine-&gt;pName  = pLineKey;
00439     pNewLine-&gt;Allocated = Allocated;
00440 
00441     <span class="keywordflow">if</span> (pInf-&gt;pLineRecord == (<a class="code" href="../../d5/d3/parseini_8c.html#a1">PLINE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00442     {
00443         pInf-&gt;pSectionRecord-&gt;pLine = pNewLine;
00444     }
00445     <span class="keywordflow">else</span>
00446     {
00447         pInf-&gt;pLineRecord-&gt;pNext = pNewLine;
00448     }
00449 
00450     pInf-&gt;pLineRecord  = pNewLine;
00451 
00452     <span class="comment">//</span>
00453     <span class="comment">// Reset the current value record</span>
00454     <span class="comment">//</span>
00455 
00456     pInf-&gt;pValueRecord = (<a class="code" href="../../d5/d3/parseini_8c.html#a0">PVALUE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00457 
00458     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00459 }
00460 
00461 BOOLEAN
<a name="l00462"></a><a class="code" href="../../d5/d3/parseini_8c.html#a31">00462</a> <a class="code" href="../../d5/d3/parseini_8c.html#a31">CmpAppendValue</a>(
00463     IN PINF pInf,
00464     IN PCHAR pValueString,
00465     IN BOOLEAN Allocated
00466     )
00467 
00468 <span class="comment">/*++</span>
00469 <span class="comment"></span>
00470 <span class="comment">    Routine Description:</span>
00471 <span class="comment"></span>
00472 <span class="comment">        This routine creates a new value and appends it to the end of the value list.</span>
00473 <span class="comment"></span>
00474 <span class="comment">    Input Parameters:</span>
00475 <span class="comment"></span>
00476 <span class="comment">        pInf - Pointer to the inf to be processed.</span>
00477 <span class="comment"></span>
00478 <span class="comment">        pValueString - Name of the value.</span>
00479 <span class="comment"></span>
00480 <span class="comment">        Allocated - TRUE if memory was allocated for the value name.</span>
00481 <span class="comment"></span>
00482 <span class="comment">    Return Value:</span>
00483 <span class="comment"></span>
00484 <span class="comment">        TRUE iff successful.</span>
00485 <span class="comment"></span>
00486 <span class="comment">--*/</span>
00487 
00488 {
00489     <a class="code" href="../../d5/d3/parseini_8c.html#a0">PVALUE</a> pNewValue;
00490 
00491     <span class="comment">//</span>
00492     <span class="comment">// Check to see if current line record has been initialised and</span>
00493     <span class="comment">// the parameter passed in is valid.</span>
00494     <span class="comment">//</span>
00495 
00496     <span class="keywordflow">if</span> (    pInf-&gt;pLineRecord == (<a class="code" href="../../d5/d3/parseini_8c.html#a1">PLINE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
00497             pValueString == (PCHAR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00498     {
00499         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00500     }
00501 
00502     <span class="comment">//</span>
00503     <span class="comment">// Allocate memory for the new value record.</span>
00504     <span class="comment">//</span>
00505 
00506     pNewValue = (<a class="code" href="../../d5/d3/parseini_8c.html#a0">PVALUE</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>(VALUE), CM_PARSEINI_TAG);
00507 
00508     <span class="keywordflow">if</span> (pNewValue == (<a class="code" href="../../d5/d3/parseini_8c.html#a0">PVALUE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00509     {
00510         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pNewValue);
00511         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00512     }
00513 
00514     <span class="comment">//</span>
00515     <span class="comment">// Link it in.</span>
00516     <span class="comment">//</span>
00517 
00518     pNewValue-&gt;pNext  = (<a class="code" href="../../d5/d3/parseini_8c.html#a0">PVALUE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00519     pNewValue-&gt;pName  = pValueString;
00520     pNewValue-&gt;Allocated = Allocated;
00521 
00522     <span class="keywordflow">if</span> (pInf-&gt;pValueRecord == (<a class="code" href="../../d5/d3/parseini_8c.html#a0">PVALUE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00523     {
00524         pInf-&gt;pLineRecord-&gt;pValue = pNewValue;
00525     }
00526     <span class="keywordflow">else</span>
00527     {
00528         pInf-&gt;pValueRecord-&gt;pNext = pNewValue;
00529     }
00530 
00531     pInf-&gt;pValueRecord = pNewValue;
00532 
00533     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00534 }
00535 
00536 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00537"></a><a class="code" href="../../d5/d3/parseini_8c.html#a32">00537</a> <a class="code" href="../../d5/d3/parseini_8c.html#a32">CmpGetToken</a>(
00538     IN OUT PCHAR *Stream,
00539     IN PCHAR MaxStream,
00540     IN OUT PULONG LineNumber,
00541     IN OUT PTOKEN Token
00542     )
00543 
00544 <span class="comment">/*++</span>
00545 <span class="comment"></span>
00546 <span class="comment">Routine Description:</span>
00547 <span class="comment"></span>
00548 <span class="comment">    This function returns the Next token from the configuration stream.</span>
00549 <span class="comment"></span>
00550 <span class="comment">Arguments:</span>
00551 <span class="comment"></span>
00552 <span class="comment">    Stream - Supplies the address of the configuration stream.  Returns</span>
00553 <span class="comment">        the address of where to start looking for tokens within the</span>
00554 <span class="comment">        stream.</span>
00555 <span class="comment"></span>
00556 <span class="comment">    MaxStream - Supplies the address of the last character in the stream.</span>
00557 <span class="comment"></span>
00558 <span class="comment"></span>
00559 <span class="comment">Return Value:</span>
00560 <span class="comment"></span>
00561 <span class="comment">    None.</span>
00562 <span class="comment"></span>
00563 <span class="comment">--*/</span>
00564 
00565 {
00566 
00567     PCHAR   pch;
00568     PCHAR   pchStart;
00569     PCHAR   pchNew;
00570     ULONG   length;
00571     BOOLEAN done;
00572 
00573     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Allocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00574     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;pValue = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00575 
00576     <span class="keywordflow">do</span>
00577     {
00578         done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00579 
00580         <span class="comment">//</span>
00581         <span class="comment">//  Skip whitespace (except for EOL).</span>
00582         <span class="comment">//</span>
00583 
00584         <span class="keywordflow">for</span> (   pch = *Stream;
00585                 pch &lt; MaxStream &amp;&amp; *pch != <span class="charliteral">'\n'</span> &amp;&amp; isspace(*pch);
00586                 pch++);
00587 
00588         <span class="comment">//</span>
00589         <span class="comment">// Check for comments and remove them.</span>
00590         <span class="comment">//</span>
00591 
00592         <span class="keywordflow">if</span> (    pch &lt; MaxStream &amp;&amp;
00593                 (*pch == <span class="charliteral">'#'</span> || *pch == <span class="charliteral">';'</span>))
00594         {
00595             <span class="keywordflow">while</span> (pch &lt; MaxStream &amp;&amp; *pch != <span class="charliteral">'\n'</span>)
00596             {
00597                 pch++;
00598             }
00599         }
00600 
00601         <span class="comment">//</span>
00602         <span class="comment">// Check to see if EOF has been reached, set the token to the right</span>
00603         <span class="comment">// value.</span>
00604         <span class="comment">//</span>
00605 
00606         <span class="keywordflow">if</span> (pch &gt;= MaxStream || *pch == 26)
00607         {
00608             *Stream = pch;
00609             <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Type  = <a class="code" href="../../d5/d3/parseini_8c.html#a47a16">TOK_EOF</a>;
00610             <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;pValue = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00611 
00612             <span class="keywordflow">return</span>;
00613         }
00614 
00615         <span class="keywordflow">switch</span> (*pch)
00616         {
00617             <span class="keywordflow">case</span> <span class="charliteral">'['</span>:
00618 
00619                 pch++;
00620                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Type  = <a class="code" href="../../d5/d3/parseini_8c.html#a47a18">TOK_LBRACE</a>;
00621                 <span class="keywordflow">break</span>;
00622 
00623             <span class="keywordflow">case</span> <span class="charliteral">']'</span>:
00624 
00625                 pch++;
00626                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Type  = <a class="code" href="../../d5/d3/parseini_8c.html#a47a19">TOK_RBRACE</a>;
00627                 <span class="keywordflow">break</span>;
00628 
00629             <span class="keywordflow">case</span> <span class="charliteral">'='</span>:
00630 
00631                 pch++;
00632                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Type  = <a class="code" href="../../d5/d3/parseini_8c.html#a47a21">TOK_EQUAL</a>;
00633                 <span class="keywordflow">break</span>;
00634 
00635             <span class="keywordflow">case</span> <span class="charliteral">','</span>:
00636 
00637                 pch++;
00638                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Type  = <a class="code" href="../../d5/d3/parseini_8c.html#a47a22">TOK_COMMA</a>;
00639                 <span class="keywordflow">break</span>;
00640 
00641             <span class="keywordflow">case</span> <span class="charliteral">'\n'</span>:
00642 
00643                 pch++;
00644                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Type  = <a class="code" href="../../d5/d3/parseini_8c.html#a47a17">TOK_EOL</a>;
00645                 <span class="keywordflow">break</span>;
00646 
00647             <span class="keywordflow">case</span> <span class="charliteral">'\"'</span>:
00648 
00649                 pch++;
00650 
00651                 <span class="comment">//</span>
00652                 <span class="comment">// Determine quoted string.</span>
00653                 <span class="comment">//</span>
00654 
00655                 <span class="keywordflow">for</span> (   pchStart = pch;
00656                         pch &lt; MaxStream &amp;&amp; (strchr(<a class="code" href="../../d5/d3/parseini_8c.html#a8">QStringTerminators</a>, *pch) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00657                         pch++);
00658 
00659                 <span class="keywordflow">if</span> (pch &gt;= MaxStream || *pch != <span class="charliteral">'\"'</span>)
00660                 {
00661                     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Type   = <a class="code" href="../../d5/d3/parseini_8c.html#a47a23">TOK_ERRPARSE</a>;
00662                 }
00663                 <span class="keywordflow">else</span>
00664                 {
00665 
00666                     <span class="comment">//</span>
00667                     <span class="comment">// We require a quoted string to end with a double-quote.</span>
00668                     <span class="comment">// (If the string ended with anything else, the if() above</span>
00669                     <span class="comment">// would not have let us into the else clause.) The quote</span>
00670                     <span class="comment">// character is irrelevent, however, and can be overwritten.</span>
00671                     <span class="comment">// So we'll save some heap and use the string in-place.</span>
00672                     <span class="comment">// No need to make a copy.</span>
00673                     <span class="comment">//</span>
00674                     <span class="comment">// Note that this alters the image of txtsetup.sif we pass</span>
00675                     <span class="comment">// to setupdd.sys. Thus the inf parser in setupdd.sys must</span>
00676                     <span class="comment">// be able to treat a nul character as if it were a terminating</span>
00677                     <span class="comment">// double quote.</span>
00678                     <span class="comment">//</span>
00679 
00680                     *pch++ = <span class="charliteral">'\0'</span>;
00681                     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Type = <a class="code" href="../../d5/d3/parseini_8c.html#a47a20">TOK_STRING</a>;
00682                     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;pValue = pchStart;
00683                 }
00684                 <span class="keywordflow">break</span>;
00685 
00686             <span class="keywordflow">case</span> <span class="charliteral">'\\'</span>:
00687 
00688                 <span class="keywordflow">for</span> (   pchNew = ++pch;
00689                         pchNew &lt; MaxStream &amp;&amp;
00690                             *pchNew != <span class="charliteral">'\n'</span> &amp;&amp; isspace(*pchNew);
00691                         pchNew++);
00692 
00693                 <span class="keywordflow">if</span> (*pchNew == <span class="charliteral">'\n'</span>)
00694                 {
00695                     pch = pchNew + 1;
00696                     done = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00697                     <span class="keywordflow">break</span>;
00698                 }
00699 
00700             <span class="keywordflow">default</span>:
00701 
00702                 <span class="comment">//</span>
00703                 <span class="comment">// Determine regular string.</span>
00704                 <span class="comment">//</span>
00705 
00706                 <span class="keywordflow">for</span> (   pchStart = pch;
00707                         pch &lt; MaxStream &amp;&amp; (strchr(<a class="code" href="../../d5/d3/parseini_8c.html#a7">StringTerminators</a>, *pch) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00708                         pch++);
00709 
00710                 <span class="keywordflow">if</span> (pch == pchStart)
00711                 {
00712                     pch++;
00713                     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Type  = <a class="code" href="../../d5/d3/parseini_8c.html#a47a23">TOK_ERRPARSE</a>;
00714                 }
00715                 <span class="keywordflow">else</span>
00716                 {
00717                     length = (ULONG)(pch - pchStart);
00718                     pchNew = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, length + 1, CM_PARSEINI_TAG);
00719                     <span class="keywordflow">if</span> (pchNew == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00720                     {
00721                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pchNew);
00722                         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Type = <a class="code" href="../../d5/d3/parseini_8c.html#a47a24">TOK_ERRNOMEM</a>;
00723                     }
00724                     <span class="keywordflow">else</span>
00725                     {
00726                         strncpy(pchNew, pchStart, length);
00727                         pchNew[length] = 0;
00728                         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Type = <a class="code" href="../../d5/d3/parseini_8c.html#a47a20">TOK_STRING</a>;
00729                         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;pValue = pchNew;
00730                         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Allocated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00731                     }
00732                 }
00733                 <span class="keywordflow">break</span>;
00734         }
00735 
00736         *Stream = pch;
00737     }
00738     <span class="keywordflow">while</span> (!done);
00739 
00740     <span class="keywordflow">return</span>;
00741 }
00742 
00743 <a class="code" href="../../d5/d3/parseini_8c.html#a3">PINF</a>
<a name="l00744"></a><a class="code" href="../../d5/d3/parseini_8c.html#a33">00744</a> <a class="code" href="../../d5/d3/parseini_8c.html#a33">CmpParseInfBuffer</a>(
00745     IN PCHAR Buffer,
00746     IN ULONG Size,
00747     IN OUT PULONG ErrorLine
00748     )
00749 
00750 <span class="comment">/*++</span>
00751 <span class="comment"></span>
00752 <span class="comment">Routine Description:</span>
00753 <span class="comment"></span>
00754 <span class="comment">   Given a character buffer containing the INF file, this routine parses</span>
00755 <span class="comment">   the INF into an internal form with Section records, Line records and</span>
00756 <span class="comment">   Value records.</span>
00757 <span class="comment"></span>
00758 <span class="comment">Arguments:</span>
00759 <span class="comment"></span>
00760 <span class="comment">   Buffer - contains to ptr to a buffer containing the INF file</span>
00761 <span class="comment"></span>
00762 <span class="comment">   Size - contains the size of the buffer.</span>
00763 <span class="comment"></span>
00764 <span class="comment">   ErrorLine - if a parse error occurs, this variable receives the line</span>
00765 <span class="comment">        number of the line containing the error.</span>
00766 <span class="comment"></span>
00767 <span class="comment"></span>
00768 <span class="comment">Return Value:</span>
00769 <span class="comment"></span>
00770 <span class="comment">   PVOID - INF handle ptr to be used in subsequent INF calls.</span>
00771 <span class="comment"></span>
00772 <span class="comment">--*/</span>
00773 
00774 {
00775     <a class="code" href="../../d5/d3/parseini_8c.html#a3">PINF</a>        pInf;
00776     ULONG       state;
00777     PCHAR       stream;
00778     PCHAR       maxStream;
00779     PCHAR       pchSectionName;
00780     PCHAR       pchValue;
00781     <a class="code" href="../../d8/d3/tokenp_8h.html#a14">TOKEN</a>       token;
00782     BOOLEAN     done;
00783     BOOLEAN     error;
00784     ULONG       infLine;
00785     BOOLEAN     allocated;
00786 
00787     <span class="comment">//</span>
00788     <span class="comment">// Need EmptyValue to point at a NULL character.</span>
00789     <span class="comment">//</span>
00790 
00791     <a class="code" href="../../d5/d3/parseini_8c.html#a9">EmptyValue</a> = <a class="code" href="../../d5/d3/parseini_8c.html#a7">StringTerminators</a> + <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(<a class="code" href="../../d5/d3/parseini_8c.html#a7">StringTerminators</a>);
00792 
00793     <span class="comment">//</span>
00794     <span class="comment">// Allocate memory for the INF record.</span>
00795     <span class="comment">//</span>
00796 
00797     pInf = (<a class="code" href="../../d5/d3/parseini_8c.html#a3">PINF</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>(INF), CM_PARSEINI_TAG);
00798 
00799     <span class="keywordflow">if</span> (pInf == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00800     {
00801         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pInf);
00802         <span class="keywordflow">return</span> (pInf);
00803     }
00804 
00805     pInf-&gt;pSection = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00806     pInf-&gt;pSectionRecord = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00807     pInf-&gt;pLineRecord = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00808     pInf-&gt;pValueRecord = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00809     pInf-&gt;StringsSectionType = <a class="code" href="../../d5/d3/parseini_8c.html#a46a11">StringsSectionNone</a>;
00810     pInf-&gt;StringsSection = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00811 
00812     <span class="comment">//</span>
00813     <span class="comment">// Set initial state.</span>
00814     <span class="comment">//</span>
00815 
00816     state     = 1;
00817     stream    = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00818     maxStream = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00819     pchSectionName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00820     pchValue = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00821     done      = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00822     error     = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00823     infLine = 1;
00824 
00825     <span class="comment">//</span>
00826     <span class="comment">// Enter token processing loop.</span>
00827     <span class="comment">//</span>
00828 
00829     <span class="keywordflow">while</span> (!done)
00830     {
00831 
00832        <a class="code" href="../../d5/d3/parseini_8c.html#a32">CmpGetToken</a>(&amp;stream, maxStream, &amp;infLine, &amp;token);
00833 
00834         <span class="keywordflow">switch</span> (state)
00835         {
00836             <span class="comment">//</span>
00837             <span class="comment">// STATE1: Start of file, this state remains till first</span>
00838             <span class="comment">//         section is found</span>
00839             <span class="comment">// Valid Tokens: TOK_EOL, TOK_EOF, TOK_LBRACE</span>
00840             <span class="comment">//               TOK_STRING when reading Dblspace.inf</span>
00841             <span class="comment">//</span>
00842 
00843             <span class="keywordflow">case</span> 1:
00844 
00845                 <span class="keywordflow">switch</span> (token.Type)
00846                 {
00847                     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/parseini_8c.html#a47a17">TOK_EOL</a>:
00848 
00849                         <span class="keywordflow">break</span>;
00850 
00851                     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/parseini_8c.html#a47a16">TOK_EOF</a>:
00852 
00853                         done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00854 
00855                         <span class="keywordflow">break</span>;
00856 
00857                     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/parseini_8c.html#a47a18">TOK_LBRACE</a>:
00858 
00859                         state = 2;
00860 
00861                         <span class="keywordflow">break</span>;
00862 
00863                     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/parseini_8c.html#a47a20">TOK_STRING</a>:
00864 
00865                         pchSectionName = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d3/parseini_8c.html#a10">DblSpaceSection</a>), CM_PARSEINI_TAG);
00866                         <span class="keywordflow">if</span> (pchSectionName)
00867                         {
00868                             strcpy(pchSectionName, <a class="code" href="../../d5/d3/parseini_8c.html#a10">DblSpaceSection</a>);
00869                             pchValue = token.pValue;
00870                             allocated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00871                             token.Allocated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00872                             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d3/parseini_8c.html#a29">CmpAppendSection</a>(pInf, pchSectionName, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))
00873                             {
00874                                 pchSectionName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00875                                 state = 6;
00876                             }
00877                             <span class="keywordflow">else</span>
00878                             {
00879                                 error = done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00880                             }
00881                         }
00882                         <span class="keywordflow">else</span>
00883                         {
00884                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pchSectionName);
00885                             error = done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00886                         }
00887 
00888                         <span class="keywordflow">break</span>;
00889 
00890                     <span class="keywordflow">default</span>:
00891 
00892                         error = done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00893 
00894                         <span class="keywordflow">break</span>;
00895                 }
00896 
00897                 <span class="keywordflow">break</span>;
00898 
00899             <span class="comment">//</span>
00900             <span class="comment">// STATE 2: Section LBRACE has been received, expecting STRING</span>
00901             <span class="comment">//</span>
00902             <span class="comment">// Valid Tokens: TOK_STRING, TOK_RBRACE</span>
00903             <span class="comment">//</span>
00904 
00905             <span class="keywordflow">case</span> 2:
00906 
00907                 <span class="keywordflow">switch</span> (token.Type)
00908                 {
00909                     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/parseini_8c.html#a47a20">TOK_STRING</a>:
00910 
00911                         state = 3;
00912                         pchSectionName = token.pValue;
00913                         allocated = token.Allocated;
00914 
00915                         <span class="keywordflow">break</span>;
00916 
00917                     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/parseini_8c.html#a47a19">TOK_RBRACE</a>:
00918 
00919                         token.pValue = <a class="code" href="../../d5/d3/parseini_8c.html#a9">EmptyValue</a>;
00920                         token.Allocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00921                         allocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00922                         state = 4;
00923 
00924                         <span class="keywordflow">break</span>;
00925 
00926                     <span class="keywordflow">default</span>:
00927 
00928                         error = done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00929 
00930                         <span class="keywordflow">break</span>;
00931 
00932                 }
00933 
00934                 <span class="keywordflow">break</span>;
00935 
00936             <span class="comment">//</span>
00937             <span class="comment">// STATE 3: Section Name received, expecting RBRACE</span>
00938             <span class="comment">//</span>
00939             <span class="comment">// Valid Tokens: TOK_RBRACE</span>
00940             <span class="comment">//</span>
00941 
00942             <span class="keywordflow">case</span> 3:
00943 
00944                 <span class="keywordflow">switch</span> (token.Type)
00945                 {
00946                     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/parseini_8c.html#a47a19">TOK_RBRACE</a>:
00947 
00948                         state = 4;
00949 
00950                         <span class="keywordflow">break</span>;
00951 
00952                     <span class="keywordflow">default</span>:
00953 
00954                         error = done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00955 
00956                         <span class="keywordflow">break</span>;
00957                 }
00958 
00959                 <span class="keywordflow">break</span>;
00960 
00961             <span class="comment">//</span>
00962             <span class="comment">// STATE 4: Section Definition Complete, expecting EOL</span>
00963             <span class="comment">//</span>
00964             <span class="comment">// Valid Tokens: TOK_EOL, TOK_EOF</span>
00965             <span class="comment">//</span>
00966 
00967             <span class="keywordflow">case</span> 4:
00968 
00969                 <span class="keywordflow">switch</span> (token.Type)
00970                 {
00971 
00972                     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/parseini_8c.html#a47a17">TOK_EOL</a>:
00973 
00974                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d3/parseini_8c.html#a29">CmpAppendSection</a>(pInf, pchSectionName, allocated))
00975                         {
00976 
00977                             error = done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00978                         }
00979                         <span class="keywordflow">else</span>
00980                         {
00981                             pchSectionName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00982                             state = 5;
00983                         }
00984 
00985                         <span class="keywordflow">break</span>;
00986 
00987                     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/parseini_8c.html#a47a16">TOK_EOF</a>:
00988 
00989                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d3/parseini_8c.html#a29">CmpAppendSection</a>(pInf, pchSectionName, allocated))
00990                         {
00991                             error = done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00992                         }
00993                         <span class="keywordflow">else</span>
00994                         {
00995                             pchSectionName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00996                             done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00997                         }
00998 
00999                         <span class="keywordflow">break</span>;
01000 
01001                     <span class="keywordflow">default</span>:
01002 
01003                         error = done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01004 
01005                         <span class="keywordflow">break</span>;
01006                 }
01007 
01008                 <span class="keywordflow">break</span>;
01009 
01010             <span class="comment">//</span>
01011             <span class="comment">// STATE 5: Expecting Section Lines</span>
01012             <span class="comment">//</span>
01013             <span class="comment">// Valid Tokens: TOK_EOL, TOK_EOF, TOK_STRING, TOK_LBRACE</span>
01014             <span class="comment">//</span>
01015 
01016             <span class="keywordflow">case</span> 5:
01017 
01018                 <span class="keywordflow">switch</span> (token.Type)
01019                 {
01020                     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/parseini_8c.html#a47a17">TOK_EOL</a>:
01021 
01022                         <span class="keywordflow">break</span>;
01023 
01024                     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/parseini_8c.html#a47a16">TOK_EOF</a>:
01025 
01026                         done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01027 
01028                         <span class="keywordflow">break</span>;
01029 
01030                     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/parseini_8c.html#a47a20">TOK_STRING</a>:
01031 
01032                         pchValue = token.pValue;
01033                         allocated = token.Allocated;
01034                         state = 6;
01035 
01036                         <span class="keywordflow">break</span>;
01037 
01038                     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/parseini_8c.html#a47a18">TOK_LBRACE</a>:
01039 
01040                         state = 2;
01041 
01042                         <span class="keywordflow">break</span>;
01043 
01044                     <span class="keywordflow">default</span>:
01045 
01046                         error = done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01047 
01048                         <span class="keywordflow">break</span>;
01049                 }
01050 
01051                 <span class="keywordflow">break</span>;
01052 
01053             <span class="comment">//</span>
01054             <span class="comment">// STATE 6: String returned, not sure whether it is key or value</span>
01055             <span class="comment">//</span>
01056             <span class="comment">// Valid Tokens: TOK_EOL, TOK_EOF, TOK_COMMA, TOK_EQUAL</span>
01057             <span class="comment">//</span>
01058 
01059             <span class="keywordflow">case</span> 6:
01060 
01061                 <span class="keywordflow">switch</span> (token.Type)
01062                 {
01063 
01064                     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/parseini_8c.html#a47a17">TOK_EOL</a>:
01065 
01066                         <span class="keywordflow">if</span> (    !<a class="code" href="../../d5/d3/parseini_8c.html#a30">CmpAppendLine</a>(pInf, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ||
01067                                 !<a class="code" href="../../d5/d3/parseini_8c.html#a31">CmpAppendValue</a>(pInf, pchValue, allocated))
01068                         {
01069                             error = done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01070                         }
01071                         <span class="keywordflow">else</span>
01072                         {
01073                             pchValue = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01074                             state = 5;
01075                         }
01076 
01077                         <span class="keywordflow">break</span>;
01078 
01079                     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/parseini_8c.html#a47a16">TOK_EOF</a>:
01080 
01081                         <span class="keywordflow">if</span> (    !<a class="code" href="../../d5/d3/parseini_8c.html#a30">CmpAppendLine</a>(pInf, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ||
01082                                 !<a class="code" href="../../d5/d3/parseini_8c.html#a31">CmpAppendValue</a>(pInf, pchValue, allocated))
01083                         {
01084                             error = done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01085                         }
01086                         <span class="keywordflow">else</span>
01087                         {
01088                             pchValue = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01089                             done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01090                         }
01091 
01092                         <span class="keywordflow">break</span>;
01093 
01094                     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/parseini_8c.html#a47a22">TOK_COMMA</a>:
01095 
01096                         <span class="keywordflow">if</span> (    !<a class="code" href="../../d5/d3/parseini_8c.html#a30">CmpAppendLine</a>(pInf, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ||
01097                                 !<a class="code" href="../../d5/d3/parseini_8c.html#a31">CmpAppendValue</a>(pInf, pchValue, allocated))
01098                         {
01099                             error = done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01100                         }
01101                         <span class="keywordflow">else</span>
01102                         {
01103                             pchValue = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01104                             state = 7;
01105                         }
01106 
01107                         <span class="keywordflow">break</span>;
01108 
01109                     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/parseini_8c.html#a47a21">TOK_EQUAL</a>:
01110 
01111                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d3/parseini_8c.html#a30">CmpAppendLine</a>(pInf, pchValue, allocated))
01112                         {
01113                             error = done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01114                         }
01115                         <span class="keywordflow">else</span>
01116                         {
01117                             pchValue = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01118                             state = 8;
01119                         }
01120 
01121                         <span class="keywordflow">break</span>;
01122 
01123                     <span class="keywordflow">default</span>:
01124 
01125                         error = done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01126 
01127                         <span class="keywordflow">break</span>;
01128                 }
01129 
01130                 <span class="keywordflow">break</span>;
01131 
01132             <span class="comment">//</span>
01133             <span class="comment">// STATE 7: Comma received, Expecting another string</span>
01134             <span class="comment">//</span>
01135             <span class="comment">// Valid Tokens: TOK_STRING TOK_COMMA</span>
01136             <span class="comment">//   A comma means we have an empty value.</span>
01137             <span class="comment">//</span>
01138 
01139             <span class="keywordflow">case</span> 7:
01140 
01141                 <span class="keywordflow">switch</span> (token.Type)
01142                 {
01143 
01144                     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/parseini_8c.html#a47a22">TOK_COMMA</a>:
01145 
01146                         token.pValue = <a class="code" href="../../d5/d3/parseini_8c.html#a9">EmptyValue</a>;
01147                         token.Allocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01148                         allocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01149                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d3/parseini_8c.html#a31">CmpAppendValue</a>(pInf, token.pValue, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>))
01150                         {
01151                             error = done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01152                         }
01153 
01154                         <span class="comment">//</span>
01155                         <span class="comment">// State stays at 7 because we are expecting a string</span>
01156                         <span class="comment">//</span>
01157 
01158                         <span class="keywordflow">break</span>;
01159 
01160                     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/parseini_8c.html#a47a20">TOK_STRING</a>:
01161 
01162                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d3/parseini_8c.html#a31">CmpAppendValue</a>(pInf, token.pValue, token.Allocated))
01163                         {
01164                             error = done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01165                         }
01166                         <span class="keywordflow">else</span>
01167                         {
01168                             state = 9;
01169                         }
01170 
01171                         <span class="keywordflow">break</span>;
01172 
01173                     <span class="keywordflow">default</span>:
01174 
01175                         error = done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01176 
01177                         <span class="keywordflow">break</span>;
01178                 }
01179 
01180                 <span class="keywordflow">break</span>;
01181 
01182             <span class="comment">//</span>
01183             <span class="comment">// STATE 8: Equal received, Expecting another string</span>
01184             <span class="comment">//          If none, assume there is a single empty string on the RHS</span>
01185             <span class="comment">//</span>
01186             <span class="comment">// Valid Tokens: TOK_STRING, TOK_EOL, TOK_EOF</span>
01187             <span class="comment">//</span>
01188 
01189             <span class="keywordflow">case</span> 8:
01190 
01191                 <span class="keywordflow">switch</span> (token.Type)
01192                 {
01193                     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/parseini_8c.html#a47a16">TOK_EOF</a>:
01194 
01195                         token.pValue = <a class="code" href="../../d5/d3/parseini_8c.html#a9">EmptyValue</a>;
01196                         token.Allocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01197                         allocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01198                         <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d3/parseini_8c.html#a31">CmpAppendValue</a>(pInf, token.pValue, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>))
01199                         {
01200                             error = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01201                         }
01202 
01203                         done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01204 
01205                         <span class="keywordflow">break</span>;
01206 
01207                     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/parseini_8c.html#a47a17">TOK_EOL</a>:
01208 
01209                         token.pValue = <a class="code" href="../../d5/d3/parseini_8c.html#a9">EmptyValue</a>;
01210                         token.Allocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01211                         allocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01212                         <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d3/parseini_8c.html#a31">CmpAppendValue</a>(pInf, token.pValue, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>))
01213                         {
01214                             error = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01215                             done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01216                         }
01217                         <span class="keywordflow">else</span>
01218                         {
01219                             state = 5;
01220                         }
01221 
01222                         <span class="keywordflow">break</span>;
01223 
01224                     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/parseini_8c.html#a47a20">TOK_STRING</a>:
01225 
01226                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d3/parseini_8c.html#a31">CmpAppendValue</a>(pInf, token.pValue, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>))
01227                         {
01228                             error = done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01229                         }
01230                         <span class="keywordflow">else</span>
01231                         {
01232                             state = 9;
01233                         }
01234 
01235                         <span class="keywordflow">break</span>;
01236 
01237                     <span class="keywordflow">default</span>:
01238 
01239                         error = done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01240 
01241                         <span class="keywordflow">break</span>;
01242                 }
01243 
01244                 <span class="keywordflow">break</span>;
01245 
01246             <span class="comment">//</span>
01247             <span class="comment">// STATE 9: String received after equal, value string</span>
01248             <span class="comment">//</span>
01249             <span class="comment">// Valid Tokens: TOK_EOL, TOK_EOF, TOK_COMMA</span>
01250             <span class="comment">//</span>
01251 
01252             <span class="keywordflow">case</span> 9:
01253 
01254                 <span class="keywordflow">switch</span> (token.Type)
01255                 {
01256                     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/parseini_8c.html#a47a17">TOK_EOL</a>:
01257 
01258                         state = 5;
01259 
01260                         <span class="keywordflow">break</span>;
01261 
01262                     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/parseini_8c.html#a47a16">TOK_EOF</a>:
01263 
01264                         done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01265 
01266                         <span class="keywordflow">break</span>;
01267 
01268                     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/parseini_8c.html#a47a22">TOK_COMMA</a>:
01269 
01270                         state = 7;
01271 
01272                         <span class="keywordflow">break</span>;
01273 
01274                     <span class="keywordflow">default</span>:
01275 
01276                         error = done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01277 
01278                         <span class="keywordflow">break</span>;
01279                 }
01280 
01281                 <span class="keywordflow">break</span>;
01282 
01283             <span class="comment">//</span>
01284             <span class="comment">// STATE 10: Value string definitely received</span>
01285             <span class="comment">//</span>
01286             <span class="comment">// Valid Tokens: TOK_EOL, TOK_EOF, TOK_COMMA</span>
01287             <span class="comment">//</span>
01288 
01289             <span class="keywordflow">case</span> 10:
01290 
01291                 <span class="keywordflow">switch</span> (token.Type)
01292                 {
01293                     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/parseini_8c.html#a47a17">TOK_EOL</a>:
01294 
01295                         state =5;
01296 
01297                         <span class="keywordflow">break</span>;
01298 
01299                     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/parseini_8c.html#a47a16">TOK_EOF</a>:
01300 
01301                         done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01302 
01303                         <span class="keywordflow">break</span>;
01304 
01305                     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/parseini_8c.html#a47a22">TOK_COMMA</a>:
01306 
01307                         state = 7;
01308 
01309                         <span class="keywordflow">break</span>;
01310 
01311                     <span class="keywordflow">default</span>:
01312 
01313                         error = done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01314 
01315                         <span class="keywordflow">break</span>;
01316                 }
01317 
01318                 <span class="keywordflow">break</span>;
01319 
01320             <span class="keywordflow">default</span>:
01321 
01322                 error = done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01323 
01324                 <span class="keywordflow">break</span>;
01325 
01326         } <span class="comment">// END switch(state)</span>
01327 
01328 
01329         <span class="keywordflow">if</span> (error)
01330         {
01331             *ErrorLine = infLine;
01332             <span class="keywordflow">if</span> (pchSectionName != (PCHAR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; allocated)
01333             {
01334                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pchSectionName);
01335             }
01336 
01337             <span class="keywordflow">if</span> (pchValue != (PCHAR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; allocated)
01338             {
01339                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pchValue);
01340             }
01341 
01342             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pInf);
01343 
01344             pInf = (<a class="code" href="../../d5/d3/parseini_8c.html#a3">PINF</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01345         }
01346         <span class="keywordflow">else</span>
01347         {
01348             <span class="comment">//</span>
01349             <span class="comment">// Keep track of line numbers for error reporting.</span>
01350             <span class="comment">//</span>
01351 
01352             <span class="keywordflow">if</span> (token.Type == <a class="code" href="../../d5/d3/parseini_8c.html#a47a17">TOK_EOL</a>)
01353             {
01354                 infLine++;
01355             }
01356         }
01357 
01358     } <span class="comment">// END while</span>
01359 
01360     <span class="keywordflow">if</span> (pInf)
01361     {
01362         pInf-&gt;pSectionRecord = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01363     }
01364 
01365     <span class="keywordflow">return</span>(pInf);
01366 }
01367 
01368 PCHAR
<a name="l01369"></a><a class="code" href="../../d5/d3/parseini_8c.html#a28">01369</a> <a class="code" href="../../d5/d3/parseini_8c.html#a28">CmpProcessForSimpleStringSub</a>(
01370     IN PINF pInf,
01371     IN PCHAR String
01372     )
01373 
01374 <span class="comment">/*++</span>
01375 <span class="comment"></span>
01376 <span class="comment">    Routine Description:</span>
01377 <span class="comment"></span>
01378 <span class="comment">        This routine substitutes reference to string in the STRINGS section of the inf.</span>
01379 <span class="comment"></span>
01380 <span class="comment">    Input Parameters:</span>
01381 <span class="comment"></span>
01382 <span class="comment">        pInf - Pointer to the inf to be processed.</span>
01383 <span class="comment"></span>
01384 <span class="comment">        String - String to be substituted.</span>
01385 <span class="comment"></span>
01386 <span class="comment">    Return Value:</span>
01387 <span class="comment"></span>
01388 <span class="comment">        None.</span>
01389 <span class="comment"></span>
01390 <span class="comment">--*/</span>
01391 
01392 {
01393     ULONG       len;
01394     PCHAR       returnString;
01395     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>    pSection;
01396     <a class="code" href="../../d5/d3/parseini_8c.html#a1">PLINE</a>       pLine;
01397 
01398     <span class="comment">//</span>
01399     <span class="comment">// Assume no substitution necessary.</span>
01400     <span class="comment">//</span>
01401 
01402     returnString = <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>;
01403     len = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>);
01404     pSection = pInf-&gt;StringsSection;
01405 
01406     <span class="comment">//</span>
01407     <span class="comment">// If it starts and end with % then look it up in the</span>
01408     <span class="comment">// strings section. Note the initial check before doing a</span>
01409     <span class="comment">// wcslen, to preserve performance in the 99% case where</span>
01410     <span class="comment">// there is no substitution.</span>
01411     <span class="comment">//</span>
01412 
01413     <span class="keywordflow">if</span>( <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>[0] == <span class="charliteral">'%'</span> &amp;&amp;
01414         len &gt; 2 &amp;&amp;
01415         <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>[len - 1] == <span class="charliteral">'%'</span> &amp;&amp;
01416         pSection)
01417     {
01418 
01419         <span class="keywordflow">for</span>(pLine = pSection-&gt;pLine; pLine; pLine = pLine-&gt;pNext)
01420         {
01421             <span class="keywordflow">if</span>( pLine-&gt;pName &amp;&amp;
01422                 _strnicmp(pLine-&gt;pName, <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> + 1, len - 2) == 0 &amp;&amp;
01423                 pLine-&gt;pName[len - 2] == <span class="charliteral">'\0'</span>)
01424             {
01425                 <span class="keywordflow">break</span>;
01426             }
01427         }
01428 
01429         <span class="keywordflow">if</span>(pLine &amp;&amp; pLine-&gt;pValue &amp;&amp; pLine-&gt;pValue-&gt;pName)
01430         {
01431             returnString = pLine-&gt;pValue-&gt;pName;
01432         }
01433     }
01434 
01435     <span class="keywordflow">return</span>(returnString);
01436 }
01437 
01438 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01439"></a><a class="code" href="../../d5/d3/parseini_8c.html#a25">01439</a> <a class="code" href="../../d5/d3/parseini_8c.html#a25">CmpFreeValueList</a>(
01440     IN PVALUE pValue
01441     )
01442 
01443 <span class="comment">/*++</span>
01444 <span class="comment"></span>
01445 <span class="comment">    Routine Description:</span>
01446 <span class="comment"></span>
01447 <span class="comment">        This routine releases memory for the list of values.</span>
01448 <span class="comment"></span>
01449 <span class="comment">    Input Parameters:</span>
01450 <span class="comment"></span>
01451 <span class="comment">        pValue - Pointer to the value list to be freed.</span>
01452 <span class="comment"></span>
01453 <span class="comment">    Return Value:</span>
01454 <span class="comment"></span>
01455 <span class="comment">        None.</span>
01456 <span class="comment"></span>
01457 <span class="comment">--*/</span>
01458 
01459 {
01460     <a class="code" href="../../d5/d3/parseini_8c.html#a0">PVALUE</a> pNext;
01461 
01462     <span class="keywordflow">while</span> (pValue)
01463     {
01464         <span class="comment">//</span>
01465         <span class="comment">// Save the next pointer so we dont access memory after it has</span>
01466         <span class="comment">// been freed.</span>
01467         <span class="comment">//</span>
01468 
01469         pNext = pValue-&gt;<a class="code" href="../../d5/d5/struct__value.html#o0">pNext</a>;
01470 
01471         <span class="comment">//</span>
01472         <span class="comment">// Free any data inside this value.</span>
01473         <span class="comment">//</span>
01474 
01475         <span class="keywordflow">if</span> (pValue-&gt;Allocated &amp;&amp; pValue-&gt;pName)
01476         {
01477             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)pValue-&gt;pName);
01478         }
01479 
01480         <span class="comment">//</span>
01481         <span class="comment">// Free memory for this value.</span>
01482         <span class="comment">//</span>
01483 
01484         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pValue);
01485 
01486         <span class="comment">//</span>
01487         <span class="comment">// Go to the next value.</span>
01488         <span class="comment">//</span>
01489 
01490         pValue = pNext;
01491     }
01492 }
01493 
01494 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01495"></a><a class="code" href="../../d5/d3/parseini_8c.html#a26">01495</a> <a class="code" href="../../d5/d3/parseini_8c.html#a26">CmpFreeLineList</a>(
01496     IN PLINE pLine
01497     )
01498 
01499 <span class="comment">/*++</span>
01500 <span class="comment"></span>
01501 <span class="comment">    Routine Description:</span>
01502 <span class="comment"></span>
01503 <span class="comment">        This routine releases memory for the list of lines and</span>
01504 <span class="comment">        values under it.</span>
01505 <span class="comment"></span>
01506 <span class="comment">    Input Parameters:</span>
01507 <span class="comment"></span>
01508 <span class="comment">        pLine - Pointer to the line list to be freed.</span>
01509 <span class="comment"></span>
01510 <span class="comment">    Return Value:</span>
01511 <span class="comment"></span>
01512 <span class="comment">        None.</span>
01513 <span class="comment"></span>
01514 <span class="comment">--*/</span>
01515 
01516 {
01517     <a class="code" href="../../d5/d3/parseini_8c.html#a1">PLINE</a> pNext;
01518 
01519     <span class="keywordflow">while</span> (pLine)
01520     {
01521         <span class="comment">//</span>
01522         <span class="comment">// Save the next pointer so we dont access memory after it has</span>
01523         <span class="comment">// been freed.</span>
01524         <span class="comment">//</span>
01525 
01526         pNext = pLine-&gt;<a class="code" href="../../d7/d1/struct__line.html#o0">pNext</a>;
01527 
01528         <span class="comment">//</span>
01529         <span class="comment">// Free any data inside this Line.</span>
01530         <span class="comment">//</span>
01531 
01532         <span class="keywordflow">if</span> (pLine-&gt;Allocated &amp;&amp; pLine-&gt;pName)
01533         {
01534             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)pLine-&gt;pName);
01535         }
01536 
01537         <span class="comment">//</span>
01538         <span class="comment">// Free the list of values inside this Line.</span>
01539         <span class="comment">//</span>
01540 
01541         <a class="code" href="../../d5/d3/parseini_8c.html#a25">CmpFreeValueList</a>(pLine-&gt;pValue);
01542 
01543         <span class="comment">//</span>
01544         <span class="comment">// Free memory for this line itself.</span>
01545         <span class="comment">//</span>
01546 
01547         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)pLine);
01548 
01549         <span class="comment">//</span>
01550         <span class="comment">// Go to the next line.</span>
01551         <span class="comment">//</span>
01552 
01553         pLine = pNext;
01554     }
01555 }
01556 
01557 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01558"></a><a class="code" href="../../d5/d3/parseini_8c.html#a27">01558</a> <a class="code" href="../../d5/d3/parseini_8c.html#a27">CmpFreeSectionList</a>(
01559     IN PSECTION pSection
01560     )
01561 
01562 <span class="comment">/*++</span>
01563 <span class="comment"></span>
01564 <span class="comment">    Routine Description:</span>
01565 <span class="comment"></span>
01566 <span class="comment">        This routine releases memory for the list of sections and</span>
01567 <span class="comment">        lines under it.</span>
01568 <span class="comment"></span>
01569 <span class="comment">    Input Parameters:</span>
01570 <span class="comment"></span>
01571 <span class="comment">        pSection - Pointer to the section list to be freed.</span>
01572 <span class="comment"></span>
01573 <span class="comment">    Return Value:</span>
01574 <span class="comment"></span>
01575 <span class="comment">        None.</span>
01576 <span class="comment"></span>
01577 <span class="comment">--*/</span>
01578 
01579 {
01580     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a> pNext;
01581 
01582     <span class="keywordflow">while</span> (pSection)
01583     {
01584         <span class="comment">//</span>
01585         <span class="comment">// Save the next pointer so we dont access memory after it has</span>
01586         <span class="comment">// been freed.</span>
01587         <span class="comment">//</span>
01588 
01589         pNext = pSection-&gt;<a class="code" href="../../d4/d0/struct__section.html#o0">pNext</a>;
01590 
01591         <span class="comment">//</span>
01592         <span class="comment">// Free any data inside this Line.</span>
01593         <span class="comment">//</span>
01594 
01595         <span class="keywordflow">if</span> (pSection-&gt;Allocated &amp;&amp; pSection-&gt;pName)
01596         {
01597             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)pSection-&gt;pName);
01598         }
01599 
01600         <span class="comment">//</span>
01601         <span class="comment">// Free the list of values inside this Line.</span>
01602         <span class="comment">//</span>
01603 
01604         <a class="code" href="../../d5/d3/parseini_8c.html#a26">CmpFreeLineList</a>(pSection-&gt;pLine);
01605 
01606         <span class="comment">//</span>
01607         <span class="comment">// Free memory for this line itself.</span>
01608         <span class="comment">//</span>
01609 
01610         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)pSection);
01611 
01612         <span class="comment">//</span>
01613         <span class="comment">// Go to the next line.</span>
01614         <span class="comment">//</span>
01615 
01616         pSection = pNext;
01617     }
01618 
01619 }
01620 
01621 <a class="code" href="../../d5/d3/parseini_8c.html#a0">PVALUE</a>
<a name="l01622"></a><a class="code" href="../../d5/d3/parseini_8c.html#a34">01622</a> <a class="code" href="../../d5/d3/parseini_8c.html#a34">CmpSearchValueInLine</a>(
01623     IN PLINE pLine,
01624     IN ULONG ValueIndex
01625     )
01626 
01627 <span class="comment">/*++</span>
01628 <span class="comment"></span>
01629 <span class="comment">    Routine Description:</span>
01630 <span class="comment"></span>
01631 <span class="comment">        This routine searches for the specified value in the inf.</span>
01632 <span class="comment"></span>
01633 <span class="comment">    Input Parameters:</span>
01634 <span class="comment"></span>
01635 <span class="comment">        pLine - Pointer to the line to be searched.</span>
01636 <span class="comment"></span>
01637 <span class="comment">        ValueIndex - Index of the value to be searched.</span>
01638 <span class="comment"></span>
01639 <span class="comment">    Return Value:</span>
01640 <span class="comment"></span>
01641 <span class="comment">        Pointer to the value iff found. Else NULL.</span>
01642 <span class="comment"></span>
01643 <span class="comment">--*/</span>
01644 
01645 {
01646     ULONG   i;
01647     <a class="code" href="../../d5/d3/parseini_8c.html#a0">PVALUE</a>  pValue = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01648 
01649     <span class="keywordflow">if</span> (pLine)
01650     {
01651         <span class="keywordflow">for</span> (   i = 0, pValue = pLine-&gt;pValue;
01652                 i &lt; ValueIndex &amp;&amp; pValue;
01653                 i++, pValue = pValue-&gt;pNext);
01654     }
01655 
01656     <span class="keywordflow">return</span> (pValue);
01657 }
01658 
01659 
01660 <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>
<a name="l01661"></a><a class="code" href="../../d5/d3/parseini_8c.html#a36">01661</a> <a class="code" href="../../d5/d3/parseini_8c.html#a36">CmpSearchSectionByName</a>(
01662     IN PINF  pInf,
01663     IN PCHAR SectionName
01664     )
01665 
01666 <span class="comment">/*++</span>
01667 <span class="comment"></span>
01668 <span class="comment">    Routine Description:</span>
01669 <span class="comment"></span>
01670 <span class="comment">        This routine searches for the specified section in the inf.</span>
01671 <span class="comment"></span>
01672 <span class="comment">    Input Parameters:</span>
01673 <span class="comment"></span>
01674 <span class="comment">        pInf - Pointer to the inf to be searched.</span>
01675 <span class="comment"></span>
01676 <span class="comment">        SectionName - Name of the section to be searched.</span>
01677 <span class="comment"></span>
01678 <span class="comment">    Return Value:</span>
01679 <span class="comment"></span>
01680 <span class="comment">        Pointer to the section iff found. Else NULL.</span>
01681 <span class="comment"></span>
01682 <span class="comment">--*/</span>
01683 
01684 {
01685     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>    pSection = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01686     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>    pFirstSearchedSection;
01687 
01688     <span class="comment">//</span>
01689     <span class="comment">// Validate the parameters passed in.</span>
01690     <span class="comment">//</span>
01691 
01692     <span class="keywordflow">if</span> (pInf &amp;&amp; SectionName)
01693     {
01694         <span class="comment">//</span>
01695         <span class="comment">// Traverse down the section list searching each section for the</span>
01696         <span class="comment">// section name mentioned.</span>
01697         <span class="comment">//</span>
01698 
01699         <span class="keywordflow">for</span> (   pSection = pFirstSearchedSection = pInf-&gt;pSectionRecord;
01700                 pSection &amp;&amp; _stricmp(pSection-&gt;pName, SectionName);
01701                 pSection = pSection-&gt;pNext);
01702 
01703         <span class="comment">//</span>
01704         <span class="comment">// If we did not find the section, search from the beginning.</span>
01705         <span class="comment">//</span>
01706 
01707         <span class="keywordflow">if</span> (pSection == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01708         {
01709             <span class="keywordflow">for</span> (   pSection = pInf-&gt;pSection;
01710                     pSection &amp;&amp; pSection != pFirstSearchedSection;
01711                     pSection = pSection-&gt;pNext)
01712             {
01713                 <span class="keywordflow">if</span> (pSection-&gt;pName &amp;&amp; _stricmp(pSection-&gt;pName, SectionName) == 0)
01714                 {
01715                     <span class="keywordflow">break</span>;
01716                 }
01717             }
01718 
01719             <span class="keywordflow">if</span> (pSection == pFirstSearchedSection)
01720             {
01721                 pSection = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01722             }
01723         }
01724 
01725         <span class="keywordflow">if</span> (pSection)
01726         {
01727             pInf-&gt;pSectionRecord = pSection;
01728         }
01729     }
01730 
01731     <span class="comment">//</span>
01732     <span class="comment">// Return the section at which we stopped.</span>
01733     <span class="comment">//</span>
01734 
01735     <span class="keywordflow">return</span> (pSection);
01736 }
01737 
01738 <a class="code" href="../../d5/d3/parseini_8c.html#a1">PLINE</a>
<a name="l01739"></a><a class="code" href="../../d5/d3/parseini_8c.html#a35">01739</a> <a class="code" href="../../d5/d3/parseini_8c.html#a35">CmpSearchLineInSectionByIndex</a>(
01740     IN PSECTION pSection,
01741     IN ULONG    LineIndex
01742     )
01743 
01744 <span class="comment">/*++</span>
01745 <span class="comment"></span>
01746 <span class="comment">    Routine Description:</span>
01747 <span class="comment"></span>
01748 <span class="comment">        This routine searches for the specified line in the inf.</span>
01749 <span class="comment"></span>
01750 <span class="comment">    Input Parameters:</span>
01751 <span class="comment"></span>
01752 <span class="comment">        pSection - Pointer to the section to be searched.</span>
01753 <span class="comment"></span>
01754 <span class="comment">        LineIndex - Index of the line to be searched.</span>
01755 <span class="comment"></span>
01756 <span class="comment">    Return Value:</span>
01757 <span class="comment"></span>
01758 <span class="comment">        Pointer to the line iff found. Else NULL.</span>
01759 <span class="comment"></span>
01760 <span class="comment">--*/</span>
01761 
01762 {
01763     <a class="code" href="../../d5/d3/parseini_8c.html#a1">PLINE</a>   pLine = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01764     ULONG   i;
01765 
01766     <span class="comment">//</span>
01767     <span class="comment">// Validate the parameters passed in.</span>
01768     <span class="comment">//</span>
01769 
01770     <span class="keywordflow">if</span> (pSection)
01771     {
01772 
01773         <span class="comment">//</span>
01774         <span class="comment">// Traverse down the current line list to the LineIndex line.</span>
01775         <span class="comment">//</span>
01776 
01777         <span class="keywordflow">for</span>(    i = 0, pLine = pSection-&gt;pLine;
01778                 i &lt; LineIndex &amp;&amp; pLine;
01779                 i++, pLine = pLine-&gt;pNext);
01780     }
01781 
01782     <span class="comment">//</span>
01783     <span class="comment">// Return the Line found</span>
01784     <span class="comment">//</span>
01785 
01786     <span class="keywordflow">return</span> (pLine);
01787 }
01788 
01789 PVOID
<a name="l01790"></a><a class="code" href="../../d6/d3/parseini_8h.html#a0">01790</a> <a class="code" href="../../d6/d3/parseini_8h.html#a0">CmpOpenInfFile</a>(
01791     IN  PVOID   InfImage,
01792     IN  ULONG   ImageSize
01793    )
01794 
01795 <span class="comment">/*++</span>
01796 <span class="comment"></span>
01797 <span class="comment">    Routine Description:</span>
01798 <span class="comment"></span>
01799 <span class="comment">        This routine opens an handle to the inf.</span>
01800 <span class="comment"></span>
01801 <span class="comment">    Input Parameters:</span>
01802 <span class="comment"></span>
01803 <span class="comment">        InfImage - Pointer to the inf image read into memory.</span>
01804 <span class="comment"></span>
01805 <span class="comment">        ImageSize - Image size.</span>
01806 <span class="comment"></span>
01807 <span class="comment">    Return Value:</span>
01808 <span class="comment"></span>
01809 <span class="comment">        Returns handle to the inf iff successful. Else NULL.</span>
01810 <span class="comment"></span>
01811 <span class="comment">--*/</span>
01812 
01813 {
01814     <a class="code" href="../../d5/d3/parseini_8c.html#a3">PINF</a>    infHandle;
01815     ULONG   errorLine = 0;
01816 
01817     <span class="comment">//</span>
01818     <span class="comment">// Parse the inf buffer.</span>
01819     <span class="comment">//</span>
01820 
01821     infHandle = <a class="code" href="../../d5/d3/parseini_8c.html#a33">CmpParseInfBuffer</a>(InfImage, ImageSize, &amp;errorLine);
01822 
01823     <span class="keywordflow">if</span> (infHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01824     {
01825         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Error on line %d in CmpOpenInfFile!\n"</span>, errorLine);
01826     }
01827 
01828     <span class="keywordflow">return</span> (infHandle);
01829 }
01830 
01831 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01832"></a><a class="code" href="../../d6/d3/parseini_8h.html#a1">01832</a> <a class="code" href="../../d6/d3/parseini_8h.html#a1">CmpCloseInfFile</a>(
01833     PVOID   InfHandle
01834     )
01835 
01836 <span class="comment">/*++</span>
01837 <span class="comment"></span>
01838 <span class="comment">    Routine Description:</span>
01839 <span class="comment"></span>
01840 <span class="comment">        This routine closes the inf handle by releasing any</span>
01841 <span class="comment">        memory allocated for it during parsing.</span>
01842 <span class="comment"></span>
01843 <span class="comment">    Input Parameters:</span>
01844 <span class="comment"></span>
01845 <span class="comment">        InfHandle - Handle to the inf to be closed.</span>
01846 <span class="comment"></span>
01847 <span class="comment">    Return Value:</span>
01848 <span class="comment"></span>
01849 <span class="comment">        None.</span>
01850 <span class="comment"></span>
01851 <span class="comment">--*/</span>
01852 
01853 {
01854     <span class="keywordflow">if</span> (InfHandle)
01855     {
01856         <a class="code" href="../../d5/d3/parseini_8c.html#a27">CmpFreeSectionList</a>(((<a class="code" href="../../d5/d3/parseini_8c.html#a3">PINF</a>)InfHandle)-&gt;pSection);
01857         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(InfHandle);
01858     }
01859 }
01860 
01861 BOOLEAN
<a name="l01862"></a><a class="code" href="../../d5/d3/parseini_8c.html#a39">01862</a> <a class="code" href="../../d6/d3/parseini_8h.html#a3">CmpSearchInfSection</a>(
01863     IN PINF  pInf,
01864     IN PCHAR Section
01865     )
01866 
01867 <span class="comment">/*++</span>
01868 <span class="comment"></span>
01869 <span class="comment">    Routine Description:</span>
01870 <span class="comment"></span>
01871 <span class="comment">        This routine searches for the specified section in the inf.</span>
01872 <span class="comment"></span>
01873 <span class="comment">    Input Parameters:</span>
01874 <span class="comment"></span>
01875 <span class="comment">        InfHandle - Handle to the inf to be read.</span>
01876 <span class="comment"></span>
01877 <span class="comment">        Section - Name of the section to be read.</span>
01878 <span class="comment"></span>
01879 <span class="comment">    Return Value:</span>
01880 <span class="comment"></span>
01881 <span class="comment">        TRUE iff section is found in the inf.</span>
01882 <span class="comment"></span>
01883 <span class="comment">--*/</span>
01884 
01885 {
01886     <span class="keywordflow">return</span> (<a class="code" href="../../d5/d3/parseini_8c.html#a36">CmpSearchSectionByName</a>(pInf, Section) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01887 }
01888 
01889 PCHAR
<a name="l01890"></a><a class="code" href="../../d6/d3/parseini_8h.html#a2">01890</a> <a class="code" href="../../d6/d3/parseini_8h.html#a2">CmpGetKeyName</a>(
01891     IN PVOID InfHandle,
01892     IN PCHAR Section,
01893     IN ULONG LineIndex
01894     )
01895 
01896 <span class="comment">/*++</span>
01897 <span class="comment"></span>
01898 <span class="comment">    Routine Description:</span>
01899 <span class="comment"></span>
01900 <span class="comment">        This routine returns the name of the specified line in the inf.</span>
01901 <span class="comment"></span>
01902 <span class="comment">    Input Parameters:</span>
01903 <span class="comment"></span>
01904 <span class="comment">        InfHandle - Handle to the inf to be read.</span>
01905 <span class="comment"></span>
01906 <span class="comment">        Section - Name of the section to be read.</span>
01907 <span class="comment"></span>
01908 <span class="comment">        LineIndex - Index of the line to be read.</span>
01909 <span class="comment"></span>
01910 <span class="comment">    Return Value:</span>
01911 <span class="comment"></span>
01912 <span class="comment">        Pointer to the name of line in the inf iff successful. Else NULL.</span>
01913 <span class="comment"></span>
01914 <span class="comment">--*/</span>
01915 
01916 {
01917     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>    pSection;
01918     <a class="code" href="../../d5/d3/parseini_8c.html#a1">PLINE</a>       pLine;
01919 
01920     <span class="comment">//</span>
01921     <span class="comment">// First search the section.</span>
01922     <span class="comment">//</span>
01923 
01924     pSection = <a class="code" href="../../d5/d3/parseini_8c.html#a36">CmpSearchSectionByName</a>((<a class="code" href="../../d5/d3/parseini_8c.html#a3">PINF</a>)InfHandle, Section);
01925     <span class="keywordflow">if</span>(pSection)
01926     {
01927         <span class="comment">//</span>
01928         <span class="comment">// Get the line in the section.</span>
01929         <span class="comment">//</span>
01930 
01931         pLine = <a class="code" href="../../d5/d3/parseini_8c.html#a35">CmpSearchLineInSectionByIndex</a>(pSection, LineIndex);
01932         <span class="keywordflow">if</span>(pLine)
01933         {
01934             <span class="keywordflow">return</span>(pLine-&gt;pName);
01935         }
01936     }
01937 
01938     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01939 }
01940 
01941 BOOLEAN
<a name="l01942"></a><a class="code" href="../../d6/d3/parseini_8h.html#a4">01942</a> <a class="code" href="../../d6/d3/parseini_8h.html#a4">CmpSearchInfLine</a>(
01943     IN PVOID InfHandle,
01944     IN PCHAR Section,
01945     IN ULONG LineIndex
01946     )
01947 
01948 <span class="comment">/*++</span>
01949 <span class="comment"></span>
01950 <span class="comment">    Routine Description:</span>
01951 <span class="comment"></span>
01952 <span class="comment">        This routine searches for the specified line in the inf.</span>
01953 <span class="comment"></span>
01954 <span class="comment">    Input Parameters:</span>
01955 <span class="comment"></span>
01956 <span class="comment">        InfHandle - Handle to the inf to be read.</span>
01957 <span class="comment"></span>
01958 <span class="comment">        Section - Name of the section to be read.</span>
01959 <span class="comment"></span>
01960 <span class="comment">        LineIndex - Index of the line to be read.</span>
01961 <span class="comment"></span>
01962 <span class="comment">    Return Value:</span>
01963 <span class="comment"></span>
01964 <span class="comment">        TRUE iff line is found in the section in the inf.</span>
01965 <span class="comment"></span>
01966 <span class="comment">--*/</span>
01967 
01968 {
01969     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>    pSection;
01970     <a class="code" href="../../d5/d3/parseini_8c.html#a1">PLINE</a>       pLine = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01971 
01972     <span class="comment">//</span>
01973     <span class="comment">// First search the section.</span>
01974     <span class="comment">//</span>
01975 
01976     pSection = <a class="code" href="../../d5/d3/parseini_8c.html#a36">CmpSearchSectionByName</a>((<a class="code" href="../../d5/d3/parseini_8c.html#a3">PINF</a>)InfHandle, Section);
01977     <span class="keywordflow">if</span>(pSection)
01978     {
01979         <span class="comment">//</span>
01980         <span class="comment">// Search the line in the section.</span>
01981         <span class="comment">//</span>
01982 
01983         pLine = <a class="code" href="../../d5/d3/parseini_8c.html#a35">CmpSearchLineInSectionByIndex</a>(pSection, LineIndex);
01984     }
01985 
01986     <span class="keywordflow">return</span> (pLine != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01987 }
01988 
01989 
01990 PCHAR
<a name="l01991"></a><a class="code" href="../../d6/d3/parseini_8h.html#a5">01991</a> <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a> (
01992     IN PVOID InfHandle,
01993     IN PCHAR Section,
01994     IN ULONG LineIndex,
01995     IN ULONG ValueIndex
01996     )
01997 
01998 <span class="comment">/*++</span>
01999 <span class="comment"></span>
02000 <span class="comment">    Routine Description:</span>
02001 <span class="comment"></span>
02002 <span class="comment">        This routine returns the value at the specified location in the inf.</span>
02003 <span class="comment"></span>
02004 <span class="comment">    Input Parameters:</span>
02005 <span class="comment"></span>
02006 <span class="comment">        InfHandle - Handle to the inf to be read.</span>
02007 <span class="comment"></span>
02008 <span class="comment">        Section - Name of the section to be read.</span>
02009 <span class="comment"></span>
02010 <span class="comment">        LineIndex - Index of the line to be read.</span>
02011 <span class="comment"></span>
02012 <span class="comment">        ValueIndex - Index of the value to be read.</span>
02013 <span class="comment"></span>
02014 <span class="comment">    Return Value:</span>
02015 <span class="comment"></span>
02016 <span class="comment">        Pointer to the value iff successful. Else NULL.</span>
02017 <span class="comment"></span>
02018 <span class="comment">--*/</span>
02019 
02020 {
02021     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a> pSection;
02022     <a class="code" href="../../d5/d3/parseini_8c.html#a1">PLINE</a>    pLine;
02023     <a class="code" href="../../d5/d3/parseini_8c.html#a0">PVALUE</a>   pValue;
02024 
02025     <span class="comment">//</span>
02026     <span class="comment">// Search the section in the inf.</span>
02027     <span class="comment">//</span>
02028 
02029     pSection = <a class="code" href="../../d5/d3/parseini_8c.html#a36">CmpSearchSectionByName</a>((<a class="code" href="../../d5/d3/parseini_8c.html#a3">PINF</a>)InfHandle, Section);
02030     <span class="keywordflow">if</span>(pSection)
02031     {
02032         <span class="comment">//</span>
02033         <span class="comment">// Search the line in the section.</span>
02034         <span class="comment">//</span>
02035 
02036         pLine = <a class="code" href="../../d5/d3/parseini_8c.html#a35">CmpSearchLineInSectionByIndex</a>(pSection, LineIndex);
02037         <span class="keywordflow">if</span>(pLine)
02038         {
02039             <span class="comment">//</span>
02040             <span class="comment">// Search the value in the line.</span>
02041             <span class="comment">//</span>
02042 
02043             pValue = <a class="code" href="../../d5/d3/parseini_8c.html#a34">CmpSearchValueInLine</a>(pLine, ValueIndex);
02044             <span class="keywordflow">if</span>(pValue)
02045             {
02046                 <span class="comment">//</span>
02047                 <span class="comment">// The value may need to be replaced by one of the strings</span>
02048                 <span class="comment">// from the string section.</span>
02049                 <span class="comment">//</span>
02050 
02051                 <span class="keywordflow">return</span>(<a class="code" href="../../d5/d3/parseini_8c.html#a28">CmpProcessForSimpleStringSub</a>(InfHandle, pValue-&gt;pName));
02052             }
02053         }
02054     }
02055 
02056     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02057 }
02058 
02059 ULONG
<a name="l02060"></a><a class="code" href="../../d6/d3/parseini_8h.html#a6">02060</a> <a class="code" href="../../d6/d3/parseini_8h.html#a6">CmpGetSectionLineIndexValueCount</a>(
02061     IN PVOID InfHandle,
02062     IN PCHAR Section,
02063     IN ULONG LineIndex
02064     )
02065 
02066 <span class="comment">/*++</span>
02067 <span class="comment"></span>
02068 <span class="comment">    Routine Description:</span>
02069 <span class="comment"></span>
02070 <span class="comment">        This routine returns the number of values in the inf line.</span>
02071 <span class="comment"></span>
02072 <span class="comment">    Input Parameters:</span>
02073 <span class="comment"></span>
02074 <span class="comment">        InfHandle - Handle to the inf to be read.</span>
02075 <span class="comment"></span>
02076 <span class="comment">        Section - Name of the section to be read.</span>
02077 <span class="comment"></span>
02078 <span class="comment">        LineIndex - Index of the line to be read.</span>
02079 <span class="comment"></span>
02080 <span class="comment">    Return Value:</span>
02081 <span class="comment"></span>
02082 <span class="comment">        Number of values in the inf line.</span>
02083 <span class="comment"></span>
02084 <span class="comment">--*/</span>
02085 
02086 {
02087     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>    pSection;
02088     <a class="code" href="../../d5/d3/parseini_8c.html#a1">PLINE</a>       pLine;
02089     <a class="code" href="../../d5/d3/parseini_8c.html#a0">PVALUE</a>      pValue;
02090     ULONG       count = 0;
02091 
02092     <span class="comment">//</span>
02093     <span class="comment">// Search the section in the inf.</span>
02094     <span class="comment">//</span>
02095 
02096     pSection = <a class="code" href="../../d5/d3/parseini_8c.html#a36">CmpSearchSectionByName</a>((<a class="code" href="../../d5/d3/parseini_8c.html#a3">PINF</a>)InfHandle, Section);
02097     <span class="keywordflow">if</span>(pSection)
02098     {
02099         <span class="comment">//</span>
02100         <span class="comment">// Search the line in the section.</span>
02101         <span class="comment">//</span>
02102 
02103         pLine = <a class="code" href="../../d5/d3/parseini_8c.html#a35">CmpSearchLineInSectionByIndex</a>(pSection, LineIndex);
02104         <span class="keywordflow">if</span> (pLine)
02105         {
02106             <span class="comment">//</span>
02107             <span class="comment">// Count the number of values in this line.</span>
02108             <span class="comment">//</span>
02109 
02110             <span class="keywordflow">for</span>(    pValue = pLine-&gt;pValue;
02111                     pValue;
02112                     pValue = pValue-&gt;pNext, count++);
02113         }
02114     }
02115 
02116     <span class="keywordflow">return</span> (count);
02117 }
02118 
02119 BOOLEAN
<a name="l02120"></a><a class="code" href="../../d6/d3/parseini_8h.html#a7">02120</a> <a class="code" href="../../d6/d3/parseini_8h.html#a7">CmpGetIntField</a>(
02121     IN PVOID InfHandle,
02122     IN PCHAR Section,
02123     IN ULONG LineIndex,
02124     IN ULONG ValueIndex,
02125     IN OUT PULONG Data
02126     )
02127 
02128 <span class="comment">/*++</span>
02129 <span class="comment"></span>
02130 <span class="comment">    Routine Description:</span>
02131 <span class="comment"></span>
02132 <span class="comment">        This routine reads integer data from the inf.</span>
02133 <span class="comment"></span>
02134 <span class="comment">    Input Parameters:</span>
02135 <span class="comment"></span>
02136 <span class="comment">        InfHandle - Handle to the inf to be read.</span>
02137 <span class="comment"></span>
02138 <span class="comment">        Section - Name of the section to be read.</span>
02139 <span class="comment"></span>
02140 <span class="comment">        LineIndex - Index of the line to be read.</span>
02141 <span class="comment"></span>
02142 <span class="comment">        ValueIndex - Index of the value to be read.</span>
02143 <span class="comment"></span>
02144 <span class="comment">        Data - Receives the integer data.</span>
02145 <span class="comment"></span>
02146 <span class="comment">    Return Value:</span>
02147 <span class="comment"></span>
02148 <span class="comment">        TRUE iff successful.</span>
02149 <span class="comment"></span>
02150 <span class="comment">--*/</span>
02151 
02152 {
02153     PCHAR   valueStr;
02154 
02155     <span class="comment">//</span>
02156     <span class="comment">// Get the specified value.</span>
02157     <span class="comment">//</span>
02158 
02159     valueStr = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(  InfHandle,
02160                                         Section,
02161                                         LineIndex,
02162                                         ValueIndex);
02163     <span class="comment">//</span>
02164     <span class="comment">// If valid value is found, convert it to an integer.</span>
02165     <span class="comment">//</span>
02166 
02167     <span class="keywordflow">if</span> (valueStr &amp;&amp; *valueStr)
02168     {
02169         *Data = strtoul(valueStr, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 16);
02170         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02171     }
02172 
02173     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02174 }
02175 
02176 BOOLEAN
<a name="l02177"></a><a class="code" href="../../d6/d3/parseini_8h.html#a8">02177</a> <a class="code" href="../../d6/d3/parseini_8h.html#a8">CmpGetBinaryField</a>(
02178     IN PVOID InfHandle,
02179     IN PCHAR Section,
02180     IN ULONG LineIndex,
02181     IN ULONG ValueIndex,
02182     IN OUT PVOID Buffer,
02183     IN ULONG BufferSize,
02184     IN OUT PULONG ActualSize
02185     )
02186 
02187 <span class="comment">/*++</span>
02188 <span class="comment"></span>
02189 <span class="comment">    Routine Description:</span>
02190 <span class="comment"></span>
02191 <span class="comment">        This routine reads binary data from the inf.</span>
02192 <span class="comment"></span>
02193 <span class="comment">    Input Parameters:</span>
02194 <span class="comment"></span>
02195 <span class="comment">        InfHandle - Handle to the inf to be read.</span>
02196 <span class="comment"></span>
02197 <span class="comment">        Section - Name of the section to be read.</span>
02198 <span class="comment"></span>
02199 <span class="comment">        LineIndex - Index of the line to be read.</span>
02200 <span class="comment"></span>
02201 <span class="comment">        ValueIndex - Index of the value to be read.</span>
02202 <span class="comment"></span>
02203 <span class="comment">        Buffer - Receives the binary data read.</span>
02204 <span class="comment"></span>
02205 <span class="comment">        BufferSize - Size of the buffer.</span>
02206 <span class="comment"></span>
02207 <span class="comment">        ActualSize - Receives the size of the data buffer required.</span>
02208 <span class="comment"></span>
02209 <span class="comment">    Return Value:</span>
02210 <span class="comment"></span>
02211 <span class="comment">        TRUE iff successful.</span>
02212 <span class="comment"></span>
02213 <span class="comment">--*/</span>
02214 
02215 {
02216     BOOLEAN     result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02217     ULONG       requiredSize;
02218     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>    pSection;
02219     <a class="code" href="../../d5/d3/parseini_8c.html#a1">PLINE</a>       pLine;
02220     <a class="code" href="../../d5/d3/parseini_8c.html#a0">PVALUE</a>      pValue;
02221     ULONG       count;
02222     PCHAR       valueStr;
02223 
02224     <span class="comment">//</span>
02225     <span class="comment">// Compute the size of buffer required to read in the binary data.</span>
02226     <span class="comment">//</span>
02227 
02228     requiredSize = (<a class="code" href="../../d6/d3/parseini_8h.html#a6">CmpGetSectionLineIndexValueCount</a>(   InfHandle,
02229                                                         Section,
02230                                                         LineIndex) - ValueIndex) * <span class="keyword">sizeof</span>(UCHAR);
02231     <span class="comment">//</span>
02232     <span class="comment">// Validate input parameters.</span>
02233     <span class="comment">//</span>
02234 
02235     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> &amp;&amp; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> &gt;= requiredSize)
02236     {
02237         <span class="comment">//</span>
02238         <span class="comment">// Search the section in the inf.</span>
02239         <span class="comment">//</span>
02240 
02241         pSection = <a class="code" href="../../d5/d3/parseini_8c.html#a36">CmpSearchSectionByName</a>((<a class="code" href="../../d5/d3/parseini_8c.html#a3">PINF</a>)InfHandle, Section);
02242         <span class="keywordflow">if</span>(pSection)
02243         {
02244             <span class="comment">//</span>
02245             <span class="comment">// Search the line in this section.</span>
02246             <span class="comment">//</span>
02247 
02248             pLine = <a class="code" href="../../d5/d3/parseini_8c.html#a35">CmpSearchLineInSectionByIndex</a>(pSection, LineIndex);
02249             <span class="keywordflow">if</span> (pLine)
02250             {
02251                 <span class="comment">//</span>
02252                 <span class="comment">// Go to the specified value.</span>
02253                 <span class="comment">//</span>
02254 
02255                 <span class="keywordflow">for</span>(    pValue = pLine-&gt;pValue, count = 0;
02256                         pValue &amp;&amp; count &lt; ValueIndex;
02257                         pValue = pValue-&gt;pNext, count++);
02258 
02259                 <span class="comment">//</span>
02260                 <span class="comment">// Read in and convert the binary data.</span>
02261                 <span class="comment">//</span>
02262 
02263                 <span class="keywordflow">for</span> (   ;
02264                         pValue;
02265                         pValue = pValue-&gt;pNext)
02266                 {
02267                     valueStr = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(  InfHandle,
02268                                                         Section,
02269                                                         LineIndex,
02270                                                         ValueIndex++);
02271                     <span class="keywordflow">if</span> (valueStr == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02272                     {
02273                         <span class="keywordflow">break</span>;
02274                     }
02275                     *((PUCHAR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)++ = (UCHAR)strtoul(valueStr, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 16);
02276                 }
02277                 <span class="keywordflow">if</span> (valueStr)
02278                 {
02279                     result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02280                 }
02281             }
02282         }
02283     }
02284 
02285     <span class="comment">//</span>
02286     <span class="comment">// The caller wants to know the buffer size required.</span>
02287     <span class="comment">//</span>
02288 
02289     <span class="keywordflow">if</span> (ActualSize)
02290     {
02291         *ActualSize = requiredSize;
02292         result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02293     }
02294 
02295     <span class="keywordflow">return</span> (result);
02296 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:08 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
