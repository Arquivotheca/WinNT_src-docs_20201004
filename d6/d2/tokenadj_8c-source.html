<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: tokenadj.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>tokenadj.c</h1><a href="../../d5/d3/tokenadj_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    tokenadj.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">   This module implements the services that perform individual adjustments</span>
00012 <span class="comment">   on token objects.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Jim Kelly (JimK) 15-June-1990</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Kernel mode only.</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="../../d6/d6/sep_8h.html">sep.h</a>"</span>
00027 <span class="preprocessor">#include "sertlp.h"</span>
00028 <span class="preprocessor">#include "<a class="code" href="../../d8/d3/tokenp_8h.html">tokenp.h</a>"</span>
00029 
00030 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtAdjustPrivilegesToken)</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtAdjustGroupsToken)</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepAdjustPrivileges)</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepAdjustGroups)</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00036 <span class="preprocessor"></span>
00037 
00039 <span class="comment">//                                                                    //</span>
00040 <span class="comment">//           Token Object Routines &amp; Methods                          //</span>
00041 <span class="comment">//                                                                    //</span>
00043 <span class="comment"></span>
00044 
00045 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00046"></a><a class="code" href="../../d5/d3/tokenadj_8c.html#a0">00046</a> <a class="code" href="../../d5/d3/tokenadj_8c.html#a0">NtAdjustPrivilegesToken</a> (
00047     IN HANDLE TokenHandle,
00048     IN BOOLEAN DisableAllPrivileges,
00049     IN PTOKEN_PRIVILEGES NewState OPTIONAL,
00050     IN ULONG BufferLength OPTIONAL,
00051     OUT PTOKEN_PRIVILEGES PreviousState OPTIONAL,
00052     OUT PULONG ReturnLength
00053     )
00054 
00055 
00056 <span class="comment">/*++</span>
00057 <span class="comment"></span>
00058 <span class="comment"></span>
00059 <span class="comment">Routine Description:</span>
00060 <span class="comment"></span>
00061 <span class="comment">    This routine is used to disable or enable privileges in the</span>
00062 <span class="comment">    specified token.  The absence of some of the privileges listed to</span>
00063 <span class="comment">    be changed won't effect the successful modification of the</span>
00064 <span class="comment">    privileges that are in the token.  The previous enabled/disabled</span>
00065 <span class="comment">    state of changed privileges may optionally be capture (for</span>
00066 <span class="comment">    resetting later).</span>
00067 <span class="comment"></span>
00068 <span class="comment">    TOKEN_ADJUST_PRIVILEGES access is required to enable or disable</span>
00069 <span class="comment">    privileges in a token.</span>
00070 <span class="comment"></span>
00071 <span class="comment"></span>
00072 <span class="comment">Arguments:</span>
00073 <span class="comment"></span>
00074 <span class="comment">    TokenHandle - Provides a handle to the token to operate on.</span>
00075 <span class="comment"></span>
00076 <span class="comment">    DisableAllPrivileges - This boolean parameter may be</span>
00077 <span class="comment">        used to disable all privileges assigned to the token.  If</span>
00078 <span class="comment">        this parameter is specified as TRUE, then the NewState parameter is</span>
00079 <span class="comment">        ignored.</span>
00080 <span class="comment"></span>
00081 <span class="comment">    NewState - This (optional) parameter points to a TOKEN_PRIVILEGES</span>
00082 <span class="comment">        data structure containing the privileges whose states are to</span>
00083 <span class="comment">        be adjusted (disabled or enabled).  Only the Enabled flag of</span>
00084 <span class="comment">        the attributes associated with each privilege is used.  It</span>
00085 <span class="comment">        provides the new value that is to be assigned to the</span>
00086 <span class="comment">        privilege in the token.</span>
00087 <span class="comment"></span>
00088 <span class="comment">    BufferLength - This optional parameter indicates the length (in</span>
00089 <span class="comment">        bytes) of the PreviousState buffer.  This value must be</span>
00090 <span class="comment">        provided if the PreviousState parameter is provided.</span>
00091 <span class="comment"></span>
00092 <span class="comment">    PreviousState - This (optional) parameter points to a buffer to</span>
00093 <span class="comment">        receive the state of any privileges actually changed by this</span>
00094 <span class="comment">        request.  This information is formated as a TOKEN_PRIVILEGES</span>
00095 <span class="comment">        data structure which may be passed as the NewState parameter</span>
00096 <span class="comment">        in a subsequent call to this routine to restore the original</span>
00097 <span class="comment">        state of those privilges.  TOKEN_QUERY access is needed to</span>
00098 <span class="comment">        use this parameter.</span>
00099 <span class="comment"></span>
00100 <span class="comment">        If this buffer does not contain enough space to receive the</span>
00101 <span class="comment">        complete list of modified privileges, then no privilege</span>
00102 <span class="comment">        states are changed and STATUS_BUFFER_TOO_SMALL is returned.</span>
00103 <span class="comment">        In this case, the ReturnLength OUT parameter will</span>
00104 <span class="comment">        contain the actual number of bytes needed to hold the</span>
00105 <span class="comment">        information.</span>
00106 <span class="comment"></span>
00107 <span class="comment">    ReturnLength - Indicates the actual number of bytes needed to</span>
00108 <span class="comment">        contain the previous privilege state information.</span>
00109 <span class="comment">        This parameter is ignored if the PreviousState argument is not</span>
00110 <span class="comment">        passed.</span>
00111 <span class="comment"></span>
00112 <span class="comment">Return Value:</span>
00113 <span class="comment"></span>
00114 <span class="comment">    STATUS_SUCCESS - The service successfully completed the requested</span>
00115 <span class="comment">        operation.</span>
00116 <span class="comment"></span>
00117 <span class="comment">    STATUS_NOT_ALL_ASSIGNED - This NT_SUCCESS severity return status</span>
00118 <span class="comment">        indicates that not all the specified privileges are currently</span>
00119 <span class="comment">        assigned to the caller.  All specified privileges that are</span>
00120 <span class="comment">        currently assigned have been successfully adjusted.</span>
00121 <span class="comment"></span>
00122 <span class="comment">    STATUS_BUFFER_TOO_SMALL - Indicates the optional buffer provided</span>
00123 <span class="comment">        to receive the previous states of changed privileges wasn't</span>
00124 <span class="comment">        large enough to receive that information.  No changes to</span>
00125 <span class="comment">        privilege states has been made.  The number of bytes needed</span>
00126 <span class="comment">        to hold the state change information is returned via the</span>
00127 <span class="comment">        ReturnLength parameter.</span>
00128 <span class="comment"></span>
00129 <span class="comment">    STATUS_INVALID_PARAMETER - Indicates neither the DisableAllPrivileges</span>
00130 <span class="comment">        parameter was specified as true, nor was an explicit NewState</span>
00131 <span class="comment">        provided.</span>
00132 <span class="comment"></span>
00133 <span class="comment">--*/</span>
00134 
00135 {
00136     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00137     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00138 
00139     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00140 
00141     ACCESS_MASK DesiredAccess;
00142 
00143     ULONG CapturedPrivilegeCount;
00144     PLUID_AND_ATTRIBUTES CapturedPrivileges = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00145     ULONG CapturedPrivilegesLength;
00146 
00147     ULONG LocalReturnLength;
00148     ULONG ChangeCount;
00149     BOOLEAN <a class="code" href="../../d8/d1/fdengine_8c.html#a8">ChangesMade</a>;
00150 
00151     ULONG ParameterLength;
00152 
00153     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00154 
00155     <span class="comment">//</span>
00156     <span class="comment">//  The semantics of the PreviousState parameter leads to a two-pass</span>
00157     <span class="comment">//  approach to adjusting privileges.  The first pass simply checks</span>
00158     <span class="comment">//  to see which privileges will change and counts them.  This allows</span>
00159     <span class="comment">//  the amount of space needed to be calculated and returned.  If</span>
00160     <span class="comment">//  the caller's PreviousState return buffer is not large enough, then</span>
00161     <span class="comment">//  an error is returned without making any modifications.  Otherwise,</span>
00162     <span class="comment">//  a second pass is made to actually make the changes.</span>
00163     <span class="comment">//</span>
00164     <span class="comment">//</span>
00165 
00166     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9/uipriv_8c.html#a9">DisableAllPrivileges</a> &amp;&amp; !ARGUMENT_PRESENT(NewState)) {
00167         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00168     }
00169 
00170     <span class="comment">//</span>
00171     <span class="comment">// Get previous processor mode and probe parameters if necessary.</span>
00172     <span class="comment">//</span>
00173 
00174     PreviousMode = KeGetPreviousMode();
00175     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00176         <span class="keywordflow">try</span> {
00177 
00178             <span class="comment">//</span>
00179             <span class="comment">// Make sure we can see all of the new state</span>
00180             <span class="comment">//</span>
00181 
00182             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9/uipriv_8c.html#a9">DisableAllPrivileges</a>) {
00183 
00184                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
00185                     NewState,
00186                     <span class="keyword">sizeof</span>(TOKEN_PRIVILEGES),
00187                     <span class="keyword">sizeof</span>(ULONG)
00188                     );
00189 
00190                 CapturedPrivilegeCount = NewState-&gt;PrivilegeCount;
00191                 ParameterLength = (ULONG)<span class="keyword">sizeof</span>(TOKEN_PRIVILEGES) +
00192                                   ( (CapturedPrivilegeCount - <a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a>) *
00193                                   (ULONG)<span class="keyword">sizeof</span>(LUID_AND_ATTRIBUTES)  );
00194 
00195                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
00196                     NewState,
00197                     ParameterLength,
00198                     <span class="keyword">sizeof</span>(ULONG)
00199                     );
00200 
00201             }
00202 
00203 
00204             <span class="comment">//</span>
00205             <span class="comment">// Check the PreviousState buffer for writeability</span>
00206             <span class="comment">//</span>
00207 
00208             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
00209 
00210                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
00211                     PreviousState,
00212                     BufferLength,
00213                     <span class="keyword">sizeof</span>(ULONG)
00214                     );
00215 
00216                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(ReturnLength);
00217             }
00218 
00219 
00220         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00221             <span class="keywordflow">return</span> GetExceptionCode();
00222         }
00223 
00224     } <span class="keywordflow">else</span> {
00225 
00226         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9/uipriv_8c.html#a9">DisableAllPrivileges</a>) {
00227 
00228             CapturedPrivilegeCount = NewState-&gt;PrivilegeCount;
00229         }
00230     }
00231 
00232 
00233 
00234     <span class="comment">//</span>
00235     <span class="comment">// Capture NewState if passed.</span>
00236     <span class="comment">//</span>
00237 
00238     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9/uipriv_8c.html#a9">DisableAllPrivileges</a>) {
00239 
00240         <span class="keywordflow">try</span> {
00241 
00242 
00243             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a12">SeCaptureLuidAndAttributesArray</a>(
00244                          (NewState-&gt;Privileges),
00245                          CapturedPrivilegeCount,
00246                          PreviousMode,
00247                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0,
00248                          <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00249                          <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00250                          &amp;CapturedPrivileges,
00251                          &amp;CapturedPrivilegesLength
00252                          );
00253 
00254         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00255 
00256             <span class="keywordflow">return</span> GetExceptionCode();
00257 
00258         }
00259 
00260         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00261 
00262             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00263 
00264         }
00265 
00266     }
00267 
00268 
00269     <span class="comment">//</span>
00270     <span class="comment">// Reference the token object and validate the caller's right</span>
00271     <span class="comment">// to adjust the privileges.</span>
00272     <span class="comment">//</span>
00273 
00274     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
00275         DesiredAccess = (TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY);
00276     } <span class="keywordflow">else</span> {
00277         DesiredAccess = TOKEN_ADJUST_PRIVILEGES;
00278     }
00279 
00280     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00281              TokenHandle,             <span class="comment">// Handle</span>
00282              DesiredAccess,           <span class="comment">// DesiredAccess</span>
00283              <a class="code" href="../../d0/d5/se_8h.html#a36">SepTokenObjectType</a>,      <span class="comment">// ObjectType</span>
00284              PreviousMode,            <span class="comment">// AccessMode</span>
00285              (PVOID *)&amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,         <span class="comment">// Object</span>
00286              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                     <span class="comment">// GrantedAccess</span>
00287              );
00288 
00289     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00290 
00291         <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00292             <a class="code" href="../../d2/d5/se_2capture_8c.html#a13">SeReleaseLuidAndAttributesArray</a>(
00293                 CapturedPrivileges,
00294                 PreviousMode,
00295                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00296                 );
00297         }
00298 
00299         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00300     }
00301 
00302     <span class="comment">//</span>
00303     <span class="comment">//  Gain exclusive access to the token.</span>
00304     <span class="comment">//</span>
00305 
00306     <a class="code" href="../../d8/d3/tokenp_8h.html#a7">SepAcquireTokenWriteLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00307 
00308     <span class="comment">//</span>
00309     <span class="comment">// First pass through the privileges list - just count the changes</span>
00310     <span class="comment">//</span>
00311 
00312 
00313     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d3/tokenp_8h.html#a24">SepAdjustPrivileges</a>(
00314                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
00315                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                <span class="comment">// Don't make changes this pass</span>
00316                 <a class="code" href="../../d2/d9/uipriv_8c.html#a9">DisableAllPrivileges</a>,
00317                 CapturedPrivilegeCount,
00318                 CapturedPrivileges,
00319                 PreviousState,
00320                 &amp;LocalReturnLength,
00321                 &amp;ChangeCount,
00322                 &amp;<a class="code" href="../../d8/d1/fdengine_8c.html#a8">ChangesMade</a>
00323                 );
00324 
00325     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
00326 
00327         <span class="keywordflow">try</span> {
00328 
00329             (*ReturnLength) = LocalReturnLength;
00330 
00331         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00332 
00333             <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00334             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00335 
00336             <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00337                 <a class="code" href="../../d2/d5/se_2capture_8c.html#a13">SeReleaseLuidAndAttributesArray</a>(
00338                     CapturedPrivileges,
00339                     PreviousMode,
00340                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00341                     );
00342             }
00343 
00344             <span class="keywordflow">return</span> GetExceptionCode();
00345         }
00346 
00347     }
00348 
00349 
00350     <span class="comment">//</span>
00351     <span class="comment">// Make sure there is enough room to return any  requested</span>
00352     <span class="comment">// information.</span>
00353     <span class="comment">//</span>
00354 
00355     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
00356         <span class="keywordflow">if</span> (LocalReturnLength &gt; BufferLength) {
00357 
00358             <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00359             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00360 
00361             <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00362                 <a class="code" href="../../d2/d5/se_2capture_8c.html#a13">SeReleaseLuidAndAttributesArray</a>(
00363                     CapturedPrivileges,
00364                     PreviousMode,
00365                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00366                     );
00367             }
00368 
00369             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00370         }
00371     }
00372 
00373     <span class="comment">//</span>
00374     <span class="comment">// Second pass through the privileges list - Make the changes.</span>
00375     <span class="comment">//</span>
00376     <span class="comment">// Note that the internal routine attempts to write the previous</span>
00377     <span class="comment">// state directly to the caller's buffer - and so may get an exception.</span>
00378     <span class="comment">//</span>
00379 
00380     <span class="keywordflow">try</span> {
00381 
00382         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d3/tokenp_8h.html#a24">SepAdjustPrivileges</a>(
00383                     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
00384                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,                 <span class="comment">// Make the changes this pass</span>
00385                     <a class="code" href="../../d2/d9/uipriv_8c.html#a9">DisableAllPrivileges</a>,
00386                     CapturedPrivilegeCount,
00387                     CapturedPrivileges,
00388                     PreviousState,
00389                     &amp;LocalReturnLength,
00390                     &amp;ChangeCount,
00391                     &amp;<a class="code" href="../../d8/d1/fdengine_8c.html#a8">ChangesMade</a>
00392                     );
00393 
00394 
00395         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
00396 
00397             PreviousState-&gt;PrivilegeCount = ChangeCount;
00398         }
00399 
00400     } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00401 
00402         <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00403         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00404         <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00405             <a class="code" href="../../d2/d5/se_2capture_8c.html#a13">SeReleaseLuidAndAttributesArray</a>(
00406                 CapturedPrivileges,
00407                 PreviousMode,
00408                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00409                 );
00410         }
00411         <span class="keywordflow">return</span> GetExceptionCode();
00412 
00413     }
00414 
00415 
00416     <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a8">ChangesMade</a> );
00417     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00418     <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00419         <a class="code" href="../../d2/d5/se_2capture_8c.html#a13">SeReleaseLuidAndAttributesArray</a>(
00420             CapturedPrivileges,
00421             PreviousMode,
00422             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00423             );
00424     }
00425 
00426     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00427 
00428 }
00429 
00430 
00431 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00432"></a><a class="code" href="../../d5/d3/tokenadj_8c.html#a1">00432</a> <a class="code" href="../../d5/d3/tokenadj_8c.html#a1">NtAdjustGroupsToken</a> (
00433     IN HANDLE TokenHandle,
00434     IN BOOLEAN ResetToDefault,
00435     IN PTOKEN_GROUPS NewState OPTIONAL,
00436     IN ULONG BufferLength OPTIONAL,
00437     OUT PTOKEN_GROUPS PreviousState OPTIONAL,
00438     OUT PULONG ReturnLength
00439     )
00440 
00441 <span class="comment">/*++</span>
00442 <span class="comment"></span>
00443 <span class="comment"></span>
00444 <span class="comment">Routine Description:</span>
00445 <span class="comment"></span>
00446 <span class="comment">    This routine is used to disable or enable groups in the specified</span>
00447 <span class="comment">    token.  The absence of some of the groups listed to be changed</span>
00448 <span class="comment">    won't effect the successful modification of the groups that are in</span>
00449 <span class="comment">    the token.  The previous enabled/disabled state of changed groups</span>
00450 <span class="comment">    may optionally be capture (for resetting later).</span>
00451 <span class="comment"></span>
00452 <span class="comment">    TOKEN_ADJUST_GROUPS access is required to enable or disable groups</span>
00453 <span class="comment">    in a token</span>
00454 <span class="comment"></span>
00455 <span class="comment">    Note that mandatory groups can not be disabled.  An attempt</span>
00456 <span class="comment">    disable any mandatory groups will cause the call to fail, leaving</span>
00457 <span class="comment">    the state of all groups unchanged.</span>
00458 <span class="comment"></span>
00459 <span class="comment"></span>
00460 <span class="comment">Arguments:</span>
00461 <span class="comment"></span>
00462 <span class="comment">    TokenHandle - Provides a handle to the token to operate on.</span>
00463 <span class="comment"></span>
00464 <span class="comment">    ResetToDefault - The parameter indicates whether all the groups</span>
00465 <span class="comment">        in the token are to be reset to their default enabled/disabled</span>
00466 <span class="comment">        state.</span>
00467 <span class="comment"></span>
00468 <span class="comment">    NewState - This parameter points to a TOKEN_GROUPS data structure</span>
00469 <span class="comment">        containing the groups whose states are to be adjusted</span>
00470 <span class="comment">        (disabled or enabled).  Only the Enabled flag of the</span>
00471 <span class="comment">        attributes associated with each group is used.  It provides</span>
00472 <span class="comment">        the new value that is to be assigned to the group in the</span>
00473 <span class="comment">        token.  If the ResetToDefault argument is specified as TRUE,</span>
00474 <span class="comment">        then this argument is ignored.  Otherwise, it must be passed.</span>
00475 <span class="comment"></span>
00476 <span class="comment">    BufferLength - This optional parameter indicates the length (in</span>
00477 <span class="comment">        bytes) of the PreviousState buffer.  This value must be</span>
00478 <span class="comment">        provided if the PreviousState parameter is provided.</span>
00479 <span class="comment"></span>
00480 <span class="comment">    PreviousState - This (optional) parameter points to a buffer to</span>
00481 <span class="comment">        receive the state of any groups actually changed by this</span>
00482 <span class="comment">        request.  This information is formated as a TOKEN_GROUPS data</span>
00483 <span class="comment">        structure which may be passed as the NewState parameter in a</span>
00484 <span class="comment">        subsequent call to NtAdjustGroups to restore the original state</span>
00485 <span class="comment">        of those groups.  TOKEN_QUERY access is needed to use this</span>
00486 <span class="comment">        parameter.</span>
00487 <span class="comment"></span>
00488 <span class="comment">        If this buffer does not contain enough space to receive the</span>
00489 <span class="comment">        complete list of modified groups, then no group states are</span>
00490 <span class="comment">        changed and STATUS_BUFFER_TOO_SMALL is returned.  In this</span>
00491 <span class="comment">        case, the ReturnLength return parameter will contain the</span>
00492 <span class="comment">        actual number of bytes needed to hold the information.</span>
00493 <span class="comment"></span>
00494 <span class="comment">    ReturnLength - Indicates the actual number of bytes needed to</span>
00495 <span class="comment">        contain the previous group state information.</span>
00496 <span class="comment">        This parameter is ignored if the PreviousState argument is not</span>
00497 <span class="comment">        passed.</span>
00498 <span class="comment"></span>
00499 <span class="comment"></span>
00500 <span class="comment">Return Value:</span>
00501 <span class="comment"></span>
00502 <span class="comment">    STATUS_SUCCESS - The service successfully completed the requested</span>
00503 <span class="comment">        operation.</span>
00504 <span class="comment"></span>
00505 <span class="comment">    STATUS_NOT_ALL_ASSIGNED - This NT_SUCCESS severity return status</span>
00506 <span class="comment">        indicates that not all the specified groups are currently</span>
00507 <span class="comment">        assigned to the caller.  All specified groups that are</span>
00508 <span class="comment">        currently assigned have been successfully adjusted.</span>
00509 <span class="comment"></span>
00510 <span class="comment">    STATUS_CANT_DISABLE_MANDATORY - Indicates an attempt was made to</span>
00511 <span class="comment">        disable a mandatory group.  The states of all groups remains</span>
00512 <span class="comment">        unchanged.</span>
00513 <span class="comment"></span>
00514 <span class="comment">    STATUS_BUFFER_TOO_SMALL - Indicates the optional buffer provided</span>
00515 <span class="comment">        to receive the previous states of changed group wasn't large</span>
00516 <span class="comment">        enough to receive that information.  No changes to group</span>
00517 <span class="comment">        states has been made.  The number of bytes needed to hold the</span>
00518 <span class="comment">        state change information is returned via the ReturnLength</span>
00519 <span class="comment">        parameter.</span>
00520 <span class="comment"></span>
00521 <span class="comment">    STATUS_INVALID_PARAMETER - Indicates neither the ResetToDefault</span>
00522 <span class="comment">        parameter was specified as true, nor was an explicit NewState</span>
00523 <span class="comment">        provided.</span>
00524 <span class="comment"></span>
00525 <span class="comment">--*/</span>
00526 {
00527 
00528     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00529     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00530 
00531     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00532 
00533     ACCESS_MASK DesiredAccess;
00534 
00535     ULONG CapturedGroupCount;
00536     PSID_AND_ATTRIBUTES CapturedGroups = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00537     ULONG CapturedGroupsLength;
00538 
00539     ULONG LocalReturnLength;
00540     ULONG ChangeCount;
00541     BOOLEAN <a class="code" href="../../d8/d1/fdengine_8c.html#a8">ChangesMade</a>;
00542     PSID SidBuffer;
00543 
00544     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00545 
00546     <span class="comment">//</span>
00547     <span class="comment">//  The semantics of the PreviousState parameter and the</span>
00548     <span class="comment">//  STATUS_CANT_DISABLE_MANDATORY completion status leads to a two-pass</span>
00549     <span class="comment">//  approach to adjusting groups.  The first pass simply checks</span>
00550     <span class="comment">//  to see which groups will change and counts them.  This allows</span>
00551     <span class="comment">//  the amount of space needed to be calculated and returned.  If</span>
00552     <span class="comment">//  the caller's PreviousState return buffer is not large enough, or</span>
00553     <span class="comment">//  one of the specified groups is a mandatory group, then an error</span>
00554     <span class="comment">//  is returned without making any modifications.  Otherwise, a second</span>
00555     <span class="comment">//  pass is made to actually make the changes.</span>
00556     <span class="comment">//</span>
00557 
00558     <span class="keywordflow">if</span> (!ResetToDefault &amp;&amp; !ARGUMENT_PRESENT(NewState)) {
00559         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00560     }
00561 
00562     <span class="comment">//</span>
00563     <span class="comment">// Get previous processor mode and probe parameters if necessary.</span>
00564     <span class="comment">//</span>
00565 
00566     PreviousMode = KeGetPreviousMode();
00567     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00568         <span class="keywordflow">try</span> {
00569 
00570             <span class="keywordflow">if</span> (!ResetToDefault) {
00571                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
00572                     NewState,
00573                     <span class="keyword">sizeof</span>(TOKEN_GROUPS),
00574                     <span class="keyword">sizeof</span>(ULONG)
00575                     );
00576             }
00577 
00578             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
00579 
00580                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
00581                     PreviousState,
00582                     BufferLength,
00583                     <span class="keyword">sizeof</span>(ULONG)
00584                     );
00585 
00586                 <span class="comment">//</span>
00587                 <span class="comment">// This parameter is only used if PreviousState</span>
00588                 <span class="comment">// is present</span>
00589                 <span class="comment">//</span>
00590 
00591                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(ReturnLength);
00592 
00593             }
00594 
00595 
00596         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00597             <span class="keywordflow">return</span> GetExceptionCode();
00598         }
00599     }
00600 
00601     <span class="comment">//</span>
00602     <span class="comment">// Capture NewState.</span>
00603     <span class="comment">//</span>
00604 
00605     <span class="keywordflow">if</span> (!ResetToDefault) {
00606 
00607         <span class="keywordflow">try</span> {
00608 
00609             CapturedGroupCount = NewState-&gt;GroupCount;
00610             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a14">SeCaptureSidAndAttributesArray</a>(
00611                          &amp;(NewState-&gt;Groups[0]),
00612                          CapturedGroupCount,
00613                          PreviousMode,
00614                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0,
00615                          <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00616                          <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00617                          &amp;CapturedGroups,
00618                          &amp;CapturedGroupsLength
00619                          );
00620 
00621             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00622 
00623                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00624 
00625             }
00626 
00627         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00628 
00629             <span class="keywordflow">return</span> GetExceptionCode();
00630 
00631         } <span class="comment">// endtry</span>
00632     } <span class="comment">// endif !ResetToDefault</span>
00633 
00634 
00635     <span class="comment">//</span>
00636     <span class="comment">// Reference the token object and validate the caller's right</span>
00637     <span class="comment">// to adjust the groups.</span>
00638     <span class="comment">//</span>
00639 
00640     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
00641         DesiredAccess = (TOKEN_ADJUST_GROUPS | TOKEN_QUERY);
00642     } <span class="keywordflow">else</span> {
00643         DesiredAccess = TOKEN_ADJUST_GROUPS;
00644     }
00645 
00646     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00647              TokenHandle,             <span class="comment">// Handle</span>
00648              DesiredAccess,           <span class="comment">// DesiredAccess</span>
00649              <a class="code" href="../../d0/d5/se_8h.html#a36">SepTokenObjectType</a>,      <span class="comment">// ObjectType</span>
00650              PreviousMode,            <span class="comment">// AccessMode</span>
00651              (PVOID *)&amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,         <span class="comment">// Object</span>
00652              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                     <span class="comment">// GrantedAccess</span>
00653              );
00654 
00655     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00656 
00657         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CapturedGroups)) {
00658             <a class="code" href="../../d2/d5/se_2capture_8c.html#a15">SeReleaseSidAndAttributesArray</a>( CapturedGroups, PreviousMode, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00659         }
00660 
00661         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00662     }
00663 
00664     <span class="comment">//</span>
00665     <span class="comment">//  Gain exclusive access to the token.</span>
00666     <span class="comment">//</span>
00667 
00668     <a class="code" href="../../d8/d3/tokenp_8h.html#a7">SepAcquireTokenWriteLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00669 
00670     <span class="comment">//</span>
00671     <span class="comment">// First pass through the groups list.</span>
00672     <span class="comment">//</span>
00673     <span class="comment">// This pass is always necessary for groups to make sure the caller</span>
00674     <span class="comment">// isn't trying to do anything illegal to mandatory groups.</span>
00675     <span class="comment">//</span>
00676 
00677     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d3/tokenp_8h.html#a23">SepAdjustGroups</a>(
00678                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
00679                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                <span class="comment">// Don't make changes this pass</span>
00680                  ResetToDefault,
00681                  CapturedGroupCount,
00682                  CapturedGroups,
00683                  PreviousState,
00684                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                <span class="comment">// Not returning SIDs this call</span>
00685                  &amp;LocalReturnLength,
00686                  &amp;ChangeCount,
00687                  &amp;<a class="code" href="../../d8/d1/fdengine_8c.html#a8">ChangesMade</a>
00688                  );
00689 
00690     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
00691 
00692         <span class="keywordflow">try</span> {
00693 
00694             (*ReturnLength) = LocalReturnLength;
00695 
00696         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00697 
00698             <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00699             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00700 
00701             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CapturedGroups)) {
00702                 <a class="code" href="../../d2/d5/se_2capture_8c.html#a15">SeReleaseSidAndAttributesArray</a>(
00703                     CapturedGroups,
00704                     PreviousMode,
00705                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00706                     );
00707             }
00708 
00709             <span class="keywordflow">return</span> GetExceptionCode();
00710         }
00711     }
00712 
00713     <span class="comment">//</span>
00714     <span class="comment">// Make sure we didn't encounter an error</span>
00715     <span class="comment">//</span>
00716 
00717     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00718 
00719         <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00720         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00721 
00722         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CapturedGroups)) {
00723             <a class="code" href="../../d2/d5/se_2capture_8c.html#a15">SeReleaseSidAndAttributesArray</a>(
00724                 CapturedGroups,
00725                 PreviousMode,
00726                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00727                 );
00728         }
00729 
00730         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00731 
00732     }
00733 
00734     <span class="comment">//</span>
00735     <span class="comment">// Make sure there is enough room to return requested information.</span>
00736     <span class="comment">// Also go on to calculate where the SID values go.</span>
00737     <span class="comment">//</span>
00738 
00739     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
00740         <span class="keywordflow">if</span> (LocalReturnLength &gt; BufferLength) {
00741 
00742             <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00743             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00744 
00745             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CapturedGroups)) {
00746                 <a class="code" href="../../d2/d5/se_2capture_8c.html#a15">SeReleaseSidAndAttributesArray</a>(
00747                     CapturedGroups,
00748                     PreviousMode,
00749                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00750                     );
00751             }
00752 
00753 
00754             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00755         }
00756 
00757         <span class="comment">//</span>
00758         <span class="comment">// Calculate where the SIDs can be placed in the PreviousState</span>
00759         <span class="comment">// buffer.</span>
00760         <span class="comment">//</span>
00761 
00762         SidBuffer = (PSID)(<a class="code" href="../../d3/d8/udfprocs_8h.html#a27">LongAlignPtr</a>(
00763                             (PCHAR)PreviousState + (ULONG)<span class="keyword">sizeof</span>(TOKEN_GROUPS) +
00764                             (ChangeCount * (ULONG)<span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES)) -
00765                             (<a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a> * (ULONG)<span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES))
00766                             ) );
00767 
00768     }
00769 
00770     <span class="comment">//</span>
00771     <span class="comment">// Second pass through the groups list.</span>
00772     <span class="comment">//</span>
00773 
00774     <span class="keywordflow">try</span> {
00775 
00776         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d3/tokenp_8h.html#a23">SepAdjustGroups</a>(
00777                      <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
00778                      <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,                 <span class="comment">// Make changes in this pass</span>
00779                      ResetToDefault,
00780                      CapturedGroupCount,
00781                      CapturedGroups,
00782                      PreviousState,
00783                      SidBuffer,
00784                      &amp;LocalReturnLength,
00785                      &amp;ChangeCount,
00786                      &amp;<a class="code" href="../../d8/d1/fdengine_8c.html#a8">ChangesMade</a>
00787                      );
00788 
00789         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
00790 
00791             PreviousState-&gt;GroupCount = ChangeCount;
00792         }
00793 
00794     } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00795 
00796         <span class="comment">//SepFreeToken( Token, TRUE );</span>
00797         <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00798         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00799         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CapturedGroups)) {
00800             <a class="code" href="../../d2/d5/se_2capture_8c.html#a15">SeReleaseSidAndAttributesArray</a>( CapturedGroups, PreviousMode, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00801         }
00802         <span class="keywordflow">return</span> GetExceptionCode();
00803 
00804     }
00805 
00806     <span class="comment">//SepFreeToken( Token, ChangesMade );</span>
00807     <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>, <a class="code" href="../../d8/d1/fdengine_8c.html#a8">ChangesMade</a> );
00808     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00809 
00810     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CapturedGroups)) {
00811         <a class="code" href="../../d2/d5/se_2capture_8c.html#a15">SeReleaseSidAndAttributesArray</a>( CapturedGroups, PreviousMode, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00812     }
00813 
00814     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00815 
00816 }
00817 
00818 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00819"></a><a class="code" href="../../d8/d3/tokenp_8h.html#a24">00819</a> <a class="code" href="../../d8/d3/tokenp_8h.html#a24">SepAdjustPrivileges</a>(
00820     IN PTOKEN Token,
00821     IN BOOLEAN MakeChanges,
00822     IN BOOLEAN DisableAllPrivileges,
00823     IN ULONG PrivilegeCount OPTIONAL,
00824     IN PLUID_AND_ATTRIBUTES NewState OPTIONAL,
00825     OUT PTOKEN_PRIVILEGES PreviousState OPTIONAL,
00826     OUT PULONG ReturnLength,
00827     OUT PULONG ChangeCount,
00828     OUT PBOOLEAN ChangesMade
00829     )
00830 
00831 <span class="comment">/*++</span>
00832 <span class="comment"></span>
00833 <span class="comment"></span>
00834 <span class="comment">Routine Description:</span>
00835 <span class="comment"></span>
00836 <span class="comment">    This routine is used to walk the privileges array in a token as a</span>
00837 <span class="comment">    result of a request to adjust privileges.</span>
00838 <span class="comment"></span>
00839 <span class="comment">    If the MakeChanges parameter is FALSE, this routine simply determines</span>
00840 <span class="comment">    what changes are needed and how much space is necessary to save the</span>
00841 <span class="comment">    current state of changed privileges.</span>
00842 <span class="comment"></span>
00843 <span class="comment">    If the MakeChanges parameter is TRUE, this routine will not only</span>
00844 <span class="comment">    calculate the space necessary to save the current state, but will</span>
00845 <span class="comment">    actually make the changes.</span>
00846 <span class="comment"></span>
00847 <span class="comment">    This routine makes the following assumptions:</span>
00848 <span class="comment"></span>
00849 <span class="comment">      1) The token is locked for exclusive access.</span>
00850 <span class="comment"></span>
00851 <span class="comment">      2) The PrivilegeCount and NewState parameters (if passed) are captured</span>
00852 <span class="comment">         and accesses to them will not result in access violations.</span>
00853 <span class="comment"></span>
00854 <span class="comment">      4) Any access violations encountered may leave the request</span>
00855 <span class="comment">         partially completed.  It is the calling routine's responsibility</span>
00856 <span class="comment">         to catch exceptions.</span>
00857 <span class="comment"></span>
00858 <span class="comment">      5) The calling routine is responsible for inrementing the token's</span>
00859 <span class="comment">         ModifiedId field.</span>
00860 <span class="comment"></span>
00861 <span class="comment">Arguments:</span>
00862 <span class="comment"></span>
00863 <span class="comment">    Token - Pointer to the token to act upon.</span>
00864 <span class="comment"></span>
00865 <span class="comment">    MakeChanges - A boolean value indicating whether the changes should</span>
00866 <span class="comment">        actually be made, or just evaluated.  A value of TRUE indicates</span>
00867 <span class="comment">        the changes should be made.</span>
00868 <span class="comment"></span>
00869 <span class="comment">    DisableAllPrivilegs - A boolean value indicating whether all privileges</span>
00870 <span class="comment">        are to be disabled, or only select, specified privileges.  A value</span>
00871 <span class="comment">        of TRUE indicates all privileges are to be disabled.</span>
00872 <span class="comment"></span>
00873 <span class="comment">    PrivilegeCount - This parameter is required only if the NewState parameter</span>
00874 <span class="comment">        is used.  In that case, this parameter indicates how many entries are</span>
00875 <span class="comment">        in the NewState parameter.</span>
00876 <span class="comment"></span>
00877 <span class="comment">    NewState - This parameter is ignored if the DisableAllPrivileges</span>
00878 <span class="comment">        argument is TRUE.  If the DisableAllPrivileges argument is FALSE,</span>
00879 <span class="comment">        then this parameter must be provided and specifies the new state</span>
00880 <span class="comment">        to set privileges to (enabled or disabled).</span>
00881 <span class="comment"></span>
00882 <span class="comment">    PreviousState - This (optional) parameter points to a buffer to</span>
00883 <span class="comment">        receive the state of any privileges actually changed by this</span>
00884 <span class="comment">        request.  This information is formated as a TOKEN_PRIVILEGES data</span>
00885 <span class="comment">        structure which may be passed as the NewState parameter in a</span>
00886 <span class="comment">        subsequent call to NtAdjustPrivileges to restore the original state</span>
00887 <span class="comment">        of those privileges.  It is the caller's responsibility to make</span>
00888 <span class="comment">        sure this buffer is large enough to receive all the state</span>
00889 <span class="comment">        information.</span>
00890 <span class="comment"></span>
00891 <span class="comment">    ReturnLength - Points to a buffer to receive the number of bytes needed</span>
00892 <span class="comment">        to retrieve the previous state information of changed privileges.</span>
00893 <span class="comment">        This parameter is ignored if the PreviousState argument is not</span>
00894 <span class="comment">        passed.</span>
00895 <span class="comment"></span>
00896 <span class="comment">    ChangeCount - Points to a ULONG to receive the number of privileges</span>
00897 <span class="comment">        which were adjusted (or would be adjusted, if changes are made).</span>
00898 <span class="comment"></span>
00899 <span class="comment">    ChangesMade - Points to a boolean flag which is to receive an indication</span>
00900 <span class="comment">        as to whether any changes were made as a result of this call.  This</span>
00901 <span class="comment">        is expected to be used to decide whether or not to increment the</span>
00902 <span class="comment">        token's ModifiedId field.</span>
00903 <span class="comment"></span>
00904 <span class="comment">Return Value:</span>
00905 <span class="comment"></span>
00906 <span class="comment">    STATUS_SUCCESS - Call completed sccessfully.</span>
00907 <span class="comment"></span>
00908 <span class="comment">    STATUS_NOT_ALL_ASSIGNED - Indicates not all the specified adjustments</span>
00909 <span class="comment">        have been made (or could be made, if update wasn't requested).</span>
00910 <span class="comment"></span>
00911 <span class="comment">--*/</span>
00912 {
00913     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> CompletionStatus = STATUS_SUCCESS;
00914 
00915     ULONG OldIndex;
00916     ULONG NewIndex;
00917     BOOLEAN Found;
00918     ULONG MatchCount = 0;
00919 
00920     LUID_AND_ATTRIBUTES CurrentPrivilege;
00921 
00922     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00923 
00924     <span class="comment">//</span>
00925     <span class="comment">//  Walk through the privileges array to determine which need to be</span>
00926     <span class="comment">//  adjusted.</span>
00927     <span class="comment">//</span>
00928 
00929     OldIndex = 0;
00930     (*ChangeCount) = 0;
00931 
00932     <span class="keywordflow">while</span> (OldIndex &lt; <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrivilegeCount) {
00933 
00934         CurrentPrivilege = (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Privileges)[OldIndex];
00935 
00936         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9/uipriv_8c.html#a9">DisableAllPrivileges</a>) {
00937 
00938             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/tokenp_8h.html#a11">SepTokenPrivilegeAttributes</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,OldIndex) &amp;
00939                SE_PRIVILEGE_ENABLED ) {
00940 
00941                 <span class="comment">//</span>
00942                 <span class="comment">// Change, if necessary (saving previous state if</span>
00943                 <span class="comment">// appropriate).</span>
00944                 <span class="comment">//</span>
00945 
00946                 <span class="keywordflow">if</span> (MakeChanges) {
00947 
00948                     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
00949 
00950                         PreviousState-&gt;Privileges[(*ChangeCount)] =
00951                             CurrentPrivilege;
00952                     }
00953 
00954                     <a class="code" href="../../d8/d3/tokenp_8h.html#a11">SepTokenPrivilegeAttributes</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,OldIndex) &amp;=
00955                         ~SE_PRIVILEGE_ENABLED;
00956 
00957 
00958 
00959                 } <span class="comment">//endif make changes</span>
00960 
00961                 <span class="comment">//</span>
00962                 <span class="comment">// increment the number of changes</span>
00963                 <span class="comment">//</span>
00964 
00965                 (*ChangeCount) += 1;
00966 
00967             } <span class="comment">// endif privilege enabled</span>
00968 
00969         } <span class="keywordflow">else</span> {
00970 
00971             <span class="comment">//</span>
00972             <span class="comment">//  Selective adjustments - this is a little trickier</span>
00973             <span class="comment">//  Compare the current privilege to each of those in</span>
00974             <span class="comment">//  the NewState array.  If a match is found, then adjust</span>
00975             <span class="comment">//  the current privilege appropriately.</span>
00976             <span class="comment">//</span>
00977 
00978             NewIndex = 0;
00979             Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00980 
00981             <span class="keywordflow">while</span> ( (NewIndex &lt; PrivilegeCount) &amp;&amp; !Found)  {
00982 
00983                 <span class="comment">//</span>
00984                 <span class="comment">// Look for a comparison</span>
00985                 <span class="comment">//</span>
00986 
00987                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;CurrentPrivilege.Luid,&amp;NewState[NewIndex].Luid)) {
00988 
00989                     Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00990                     MatchCount += 1;
00991 
00992                     <span class="keywordflow">if</span> ( (<a class="code" href="../../d8/d3/tokenp_8h.html#a10">SepArrayPrivilegeAttributes</a>( NewState, NewIndex ) &amp;
00993                           SE_PRIVILEGE_ENABLED)
00994                         !=
00995                          (<a class="code" href="../../d8/d3/tokenp_8h.html#a11">SepTokenPrivilegeAttributes</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,OldIndex) &amp;
00996                           SE_PRIVILEGE_ENABLED)  ) {
00997 
00998                         <span class="comment">//</span>
00999                         <span class="comment">// Change, if necessary (saving previous state if</span>
01000                         <span class="comment">// appropriate).</span>
01001                         <span class="comment">//</span>
01002 
01003                         <span class="keywordflow">if</span> (MakeChanges) {
01004 
01005                             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
01006 
01007                                 PreviousState-&gt;Privileges[(*ChangeCount)] =
01008                                     CurrentPrivilege;
01009                             }
01010 
01011                             <a class="code" href="../../d8/d3/tokenp_8h.html#a11">SepTokenPrivilegeAttributes</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,OldIndex) &amp;=
01012                                 ~(<a class="code" href="../../d8/d3/tokenp_8h.html#a11">SepTokenPrivilegeAttributes</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,OldIndex)
01013                                   &amp; SE_PRIVILEGE_ENABLED);
01014                             <a class="code" href="../../d8/d3/tokenp_8h.html#a11">SepTokenPrivilegeAttributes</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,OldIndex) |=
01015                                  (<a class="code" href="../../d8/d3/tokenp_8h.html#a10">SepArrayPrivilegeAttributes</a>(NewState,NewIndex)
01016                                   &amp; SE_PRIVILEGE_ENABLED);
01017 
01018                             <span class="comment">//</span>
01019                             <span class="comment">// if this is SeChangeNotifyPrivilege, then</span>
01020                             <span class="comment">// change its corresponding bit in TokenFlags</span>
01021                             <span class="comment">//</span>
01022 
01023                             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;CurrentPrivilege.Luid,
01024                                               &amp;<a class="code" href="../../d0/d5/se_8h.html#a100">SeChangeNotifyPrivilege</a>)) {
01025                                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenFlags ^= <a class="code" href="../../d0/d5/se_8h.html#a1">TOKEN_HAS_TRAVERSE_PRIVILEGE</a>;
01026                             }
01027 
01028 
01029 
01030                         } <span class="comment">//endif make changes</span>
01031 
01032                         <span class="comment">//</span>
01033                         <span class="comment">// increment the number of changes</span>
01034                         <span class="comment">//</span>
01035 
01036                         (*ChangeCount) += 1;
01037 
01038 
01039                     } <span class="comment">// endif change needed</span>
01040 
01041                 } <span class="comment">// endif found</span>
01042 
01043                 NewIndex += 1;
01044 
01045             } <span class="comment">// endwhile searching NewState</span>
01046 
01047         } <span class="comment">// endelse</span>
01048 
01049         OldIndex += 1;
01050 
01051     } <span class="comment">// endwhile privileges in token</span>
01052 
01053     <span class="comment">//</span>
01054     <span class="comment">// If we disabled all privileges, then clear the TokenFlags flag</span>
01055     <span class="comment">// corresponding to the SeChangeNotifyPrivilege privilege.</span>
01056     <span class="comment">//</span>
01057 
01058 
01059     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9/uipriv_8c.html#a9">DisableAllPrivileges</a>) {
01060         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenFlags &amp;= ~<a class="code" href="../../d0/d5/se_8h.html#a1">TOKEN_HAS_TRAVERSE_PRIVILEGE</a>;
01061     }
01062 
01063     <span class="comment">//</span>
01064     <span class="comment">// Set completion status appropriately if some not assigned</span>
01065     <span class="comment">//</span>
01066 
01067     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9/uipriv_8c.html#a9">DisableAllPrivileges</a>) {
01068 
01069         <span class="keywordflow">if</span> (MatchCount &lt; PrivilegeCount) {
01070             CompletionStatus = STATUS_NOT_ALL_ASSIGNED;
01071         }
01072     }
01073 
01074     <span class="comment">//</span>
01075     <span class="comment">//  Indicate whether changes were made</span>
01076     <span class="comment">//</span>
01077 
01078     <span class="keywordflow">if</span> ((*ChangeCount) &gt; 0  &amp;&amp;  MakeChanges) {
01079         (*ChangesMade) = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01080     } <span class="keywordflow">else</span> {
01081         (*ChangesMade) = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01082     }
01083 
01084     <span class="comment">//</span>
01085     <span class="comment">// Calculate the space needed to return previous state information</span>
01086     <span class="comment">//</span>
01087 
01088     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
01089 
01090         (*ReturnLength) = (ULONG)<span class="keyword">sizeof</span>(TOKEN_PRIVILEGES) +
01091                           ((*ChangeCount) *  (ULONG)<span class="keyword">sizeof</span>(LUID_AND_ATTRIBUTES)) -
01092                           (<a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a> * (ULONG)<span class="keyword">sizeof</span>(LUID_AND_ATTRIBUTES));
01093     }
01094 
01095    <span class="keywordflow">return</span> CompletionStatus;
01096 }
01097 
01098 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01099"></a><a class="code" href="../../d8/d3/tokenp_8h.html#a23">01099</a> <a class="code" href="../../d8/d3/tokenp_8h.html#a23">SepAdjustGroups</a>(
01100     IN PTOKEN Token,
01101     IN BOOLEAN MakeChanges,
01102     IN BOOLEAN ResetToDefault,
01103     IN ULONG GroupCount,
01104     IN PSID_AND_ATTRIBUTES NewState OPTIONAL,
01105     OUT PTOKEN_GROUPS PreviousState OPTIONAL,
01106     OUT PSID SidBuffer OPTIONAL,
01107     OUT PULONG ReturnLength,
01108     OUT PULONG ChangeCount,
01109     OUT PBOOLEAN ChangesMade
01110     )
01111 
01112 <span class="comment">/*++</span>
01113 <span class="comment"></span>
01114 <span class="comment"></span>
01115 <span class="comment">Routine Description:</span>
01116 <span class="comment"></span>
01117 <span class="comment">    This routine is used to walk the groups array in a token as a</span>
01118 <span class="comment">    result of a request to adjust groups.</span>
01119 <span class="comment"></span>
01120 <span class="comment">    If the MakeChanges parameter is FALSE, this routine simply determines</span>
01121 <span class="comment">    what changes are needed and how much space is necessary to save the</span>
01122 <span class="comment">    current state of changed groups.</span>
01123 <span class="comment"></span>
01124 <span class="comment">    If the MakeChanges parameter is TRUE, this routine will not only</span>
01125 <span class="comment">    calculate the space necessary to save the current state, but will</span>
01126 <span class="comment">    actually make the changes.</span>
01127 <span class="comment"></span>
01128 <span class="comment">    This routine makes the following assumptions:</span>
01129 <span class="comment"></span>
01130 <span class="comment">      1) The token is locked for exclusive access.</span>
01131 <span class="comment"></span>
01132 <span class="comment">      2) The NewState parameter is captured and accesses</span>
01133 <span class="comment">         to it will not result in access violations.</span>
01134 <span class="comment"></span>
01135 <span class="comment">      4) Any access violations encountered may leave the request</span>
01136 <span class="comment">         partially completed.  It is the calling routine's responsibility</span>
01137 <span class="comment">         to catch exceptions.</span>
01138 <span class="comment"></span>
01139 <span class="comment">      5) The calling routine is responsible for inrementing the token's</span>
01140 <span class="comment">         ModifiedId field.</span>
01141 <span class="comment"></span>
01142 <span class="comment">Arguments:</span>
01143 <span class="comment"></span>
01144 <span class="comment">    Token - Pointer to the token to act upon.</span>
01145 <span class="comment"></span>
01146 <span class="comment">    MakeChanges - A boolean value indicating whether the changes should</span>
01147 <span class="comment">        actually be made, or just evaluated.  A value of TRUE indicates</span>
01148 <span class="comment">        the changes should be made.</span>
01149 <span class="comment"></span>
01150 <span class="comment">    ResetToDefault - Indicates that the groups are to be reset to their</span>
01151 <span class="comment">        default enabled/disabled state.</span>
01152 <span class="comment"></span>
01153 <span class="comment">    GroupCount - This parameter is required only if the NewState parameter</span>
01154 <span class="comment">        is used.  In that case, this parameter indicates how many entries are</span>
01155 <span class="comment">        in the NewState parameter.</span>
01156 <span class="comment"></span>
01157 <span class="comment">    NewState - This parameter points to a SID_AND_ATTRIBUTES array</span>
01158 <span class="comment">        containing the groups whose states are to be adjusted</span>
01159 <span class="comment">        (disabled or enabled).  Only the Enabled flag of the</span>
01160 <span class="comment">        attributes associated with each group is used.  It provides</span>
01161 <span class="comment">        the new value that is to be assigned to the group in the</span>
01162 <span class="comment">        token.  If the ResetToDefault argument is specified as TRUE,</span>
01163 <span class="comment">        then this argument is ignored.  Otherwise, it must be passed.</span>
01164 <span class="comment"></span>
01165 <span class="comment">    PreviousState - This (optional) parameter points to a buffer to</span>
01166 <span class="comment">        receive the state of any groups actually changed by this</span>
01167 <span class="comment">        request.  This information is formated as a TOKEN_GROUPS data</span>
01168 <span class="comment">        structure which may be passed as the NewState parameter in a</span>
01169 <span class="comment">        subsequent call to NtAdjustGroups to restore the original state</span>
01170 <span class="comment">        of those groups.  It is the caller's responsibility to make</span>
01171 <span class="comment">        sure this buffer is large enough to receive all the state</span>
01172 <span class="comment">        information.</span>
01173 <span class="comment"></span>
01174 <span class="comment">    SidBuffer - Pointer to buffer to receive the SID values corresponding</span>
01175 <span class="comment">        to the groups returned in the PreviousState argument.</span>
01176 <span class="comment"></span>
01177 <span class="comment">    ReturnLength - Points to a buffer to receive the number of bytes needed</span>
01178 <span class="comment">        to retrieve the previous state information of changed privileges.</span>
01179 <span class="comment">        This parameter is ignored if the PreviousState argument is not</span>
01180 <span class="comment">        passed.</span>
01181 <span class="comment"></span>
01182 <span class="comment">    ChangeCount - Points to a ULONG to receive the number of groups</span>
01183 <span class="comment">        which were adjusted (or would be adjusted, if changes are made).</span>
01184 <span class="comment"></span>
01185 <span class="comment">    ChangesMade - Points to a boolean flag which is to receive an indication</span>
01186 <span class="comment">        as to whether any changes were made as a result of this call.  This</span>
01187 <span class="comment">        is expected to be used to decide whether or not to increment the</span>
01188 <span class="comment">        token's ModifiedId field.</span>
01189 <span class="comment"></span>
01190 <span class="comment">Return Value:</span>
01191 <span class="comment"></span>
01192 <span class="comment">    STATUS_SUCCESS - Call completed sccessfully.</span>
01193 <span class="comment"></span>
01194 <span class="comment">    STATUS_NOT_ALL_ASSIGNED - Indicates not all the specified adjustments</span>
01195 <span class="comment">        have been made (or could be made, if update wasn't requested).</span>
01196 <span class="comment"></span>
01197 <span class="comment">    STATUS_CANT_DISABLE_MANDATORY - Not all adjustments were made (or could</span>
01198 <span class="comment">        be made, if update not requested) because an attempt was made to</span>
01199 <span class="comment">        disable a mandatory group.  The state of the groups is left</span>
01200 <span class="comment">        in an underterministic state if update was requested.</span>
01201 <span class="comment"></span>
01202 <span class="comment"></span>
01203 <span class="comment">--*/</span>
01204 {
01205 
01206     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> CompletionStatus = STATUS_SUCCESS;
01207 
01208     ULONG OldIndex;
01209     ULONG NewIndex;
01210     ULONG SidLength;
01211     ULONG LocalReturnLength = 0;
01212     PSID NextSid;
01213     BOOLEAN Found;
01214     ULONG MatchCount = 0;
01215     BOOLEAN EnableGroup;
01216     BOOLEAN DisableGroup;
01217     ULONG TokenGroupAttributes;
01218 
01219     SID_AND_ATTRIBUTES CurrentGroup;
01220 
01221     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01222 
01223     <span class="comment">//</span>
01224     <span class="comment">// NextSid is used to copy group SID values if asked for previous state.</span>
01225     <span class="comment">//</span>
01226 
01227     NextSid = SidBuffer;
01228 
01229 
01230     <span class="comment">//</span>
01231     <span class="comment">//  Walk through the groups array to determine which need to be</span>
01232     <span class="comment">//  adjusted.</span>
01233     <span class="comment">//</span>
01234 
01235     OldIndex = 1;             <span class="comment">// Don't evaluate the 0th entry (user ID)</span>
01236     (*ChangeCount) = 0;
01237 
01238     <span class="keywordflow">while</span> (OldIndex &lt; <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount) {
01239 
01240         CurrentGroup = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[OldIndex];
01241 
01242         <span class="keywordflow">if</span> (ResetToDefault) {
01243 
01244             TokenGroupAttributes = <a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,OldIndex);
01245 
01246             <span class="comment">//</span>
01247             <span class="comment">// If the group is enabled by default and currently disabled,</span>
01248             <span class="comment">// then we must enable it.</span>
01249             <span class="comment">//</span>
01250 
01251             EnableGroup = (BOOLEAN)( (TokenGroupAttributes &amp; SE_GROUP_ENABLED_BY_DEFAULT)
01252                 &amp;&amp; !(TokenGroupAttributes &amp; SE_GROUP_ENABLED));
01253 
01254             <span class="comment">//</span>
01255             <span class="comment">// If the group is disabled by default and currently enabled,</span>
01256             <span class="comment">// then we must disable it.</span>
01257             <span class="comment">//</span>
01258 
01259             DisableGroup = (BOOLEAN)( !(TokenGroupAttributes &amp; SE_GROUP_ENABLED_BY_DEFAULT)
01260                 &amp;&amp; (TokenGroupAttributes &amp; SE_GROUP_ENABLED));
01261 
01262             <span class="comment">//</span>
01263             <span class="comment">// Blow up if it's a mandatory group that is not both</span>
01264             <span class="comment">// enabled by default and enabled (SepCreateToken should</span>
01265             <span class="comment">// make sure that this never happens).</span>
01266             <span class="comment">//</span>
01267 
01268             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(TokenGroupAttributes &amp; SE_GROUP_MANDATORY)
01269                    || (TokenGroupAttributes &amp; (SE_GROUP_ENABLED_BY_DEFAULT | SE_GROUP_ENABLED)
01270                        == (SE_GROUP_ENABLED_BY_DEFAULT | SE_GROUP_ENABLED)));
01271 
01272             <span class="keywordflow">if</span> ( EnableGroup || DisableGroup ) {
01273 
01274                 SidLength = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( CurrentGroup.Sid );
01275                 SidLength = (ULONG)LongAlignSize(SidLength);
01276                 LocalReturnLength += SidLength;
01277 
01278                 <span class="comment">//</span>
01279                 <span class="comment">// Change, if necessary (saving previous state if</span>
01280                 <span class="comment">// appropriate).</span>
01281                 <span class="comment">//</span>
01282 
01283                 <span class="keywordflow">if</span> (MakeChanges) {
01284 
01285                     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
01286 
01287                         (*(PreviousState)).Groups[(*ChangeCount)].Attributes =
01288                             CurrentGroup.Attributes;
01289 
01290                         (*(PreviousState)).Groups[(*ChangeCount)].Sid =
01291                             NextSid;
01292 
01293                         <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( SidLength, NextSid, CurrentGroup.Sid );
01294                         NextSid = (PSID)((ULONG_PTR)NextSid + SidLength);
01295                     }
01296 
01297                     <span class="keywordflow">if</span> (EnableGroup) {
01298                         <a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,OldIndex) |= SE_GROUP_ENABLED;
01299                     } <span class="keywordflow">else</span> {
01300                         <a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,OldIndex) &amp;= ~SE_GROUP_ENABLED;
01301                     }
01302 
01303 
01304 
01305                 } <span class="comment">//endif make changes</span>
01306 
01307                 <span class="comment">//</span>
01308                 <span class="comment">// increment the number of changes</span>
01309                 <span class="comment">//</span>
01310 
01311                 (*ChangeCount) += 1;
01312 
01313             } <span class="comment">// endif group enabled</span>
01314 
01315         } <span class="keywordflow">else</span> {
01316 
01317             <span class="comment">//</span>
01318             <span class="comment">//  Selective adjustments - this is a little trickier</span>
01319             <span class="comment">//  Compare the current group to each of those in</span>
01320             <span class="comment">//  the NewState array.  If a match is found, then adjust</span>
01321             <span class="comment">//  the current group appropriately.</span>
01322             <span class="comment">//</span>
01323 
01324             NewIndex = 0;
01325             Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01326 
01327             <span class="keywordflow">while</span> ( (NewIndex &lt; GroupCount) &amp;&amp; !Found)  {
01328 
01329                 <span class="comment">//</span>
01330                 <span class="comment">// Look for a comparison</span>
01331                 <span class="comment">//</span>
01332 
01333                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(
01334                         CurrentGroup.Sid,
01335                         NewState[NewIndex].Sid
01336                         ) ) {
01337 
01338                     Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01339                     MatchCount += 1;
01340 
01341 
01342                     <span class="comment">//</span>
01343                     <span class="comment">// See if it needs to be changed</span>
01344                     <span class="comment">//</span>
01345 
01346                     <span class="keywordflow">if</span> ( (<a class="code" href="../../d8/d3/tokenp_8h.html#a12">SepArrayGroupAttributes</a>( NewState, NewIndex ) &amp;
01347                             SE_GROUP_ENABLED ) !=
01348                          (<a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,OldIndex) &amp;
01349                             SE_GROUP_ENABLED ) ) {
01350 
01351                         <span class="comment">//</span>
01352                         <span class="comment">// Make sure group is not mandatory</span>
01353                         <span class="comment">//</span>
01354 
01355                         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,OldIndex) &amp;
01356                               SE_GROUP_MANDATORY ) {
01357                             <span class="keywordflow">return</span> STATUS_CANT_DISABLE_MANDATORY;
01358                         }
01359 
01360                         <span class="comment">//</span>
01361                         <span class="comment">// Make sure group is not deny-only</span>
01362                         <span class="comment">//</span>
01363 
01364 
01365                         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,OldIndex) &amp;
01366                               SE_GROUP_USE_FOR_DENY_ONLY ) {
01367                             <span class="keywordflow">return</span> STATUS_CANT_ENABLE_DENY_ONLY;
01368                         }
01369 
01370                         SidLength = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( CurrentGroup.Sid );
01371                         SidLength = (ULONG)LongAlignSize(SidLength);
01372                         LocalReturnLength += SidLength;
01373 
01374                         <span class="comment">//</span>
01375                         <span class="comment">// Change, if necessary (saving previous state if</span>
01376                         <span class="comment">// appropriate).</span>
01377                         <span class="comment">//</span>
01378 
01379                         <span class="keywordflow">if</span> (MakeChanges) {
01380 
01381                             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
01382 
01383                                 PreviousState-&gt;Groups[(*ChangeCount)].Attributes =
01384                                     CurrentGroup.Attributes;
01385 
01386                                 PreviousState-&gt;Groups[(*ChangeCount)].Sid =
01387                                     NextSid;
01388 
01389                                 <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( SidLength, NextSid, CurrentGroup.Sid );
01390 
01391                                 NextSid = (PSID)((ULONG_PTR)NextSid + SidLength);
01392                             }
01393 
01394                             <a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,OldIndex) &amp;=
01395                                 ~(<a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,OldIndex)
01396                                   &amp; SE_GROUP_ENABLED);
01397                             <a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,OldIndex) |=
01398                                  (<a class="code" href="../../d8/d3/tokenp_8h.html#a12">SepArrayGroupAttributes</a>(NewState,NewIndex)
01399                                   &amp; SE_GROUP_ENABLED);
01400 
01401 
01402 
01403                         } <span class="comment">//endif make changes</span>
01404 
01405                         <span class="comment">//</span>
01406                         <span class="comment">// increment the number of changes</span>
01407                         <span class="comment">//</span>
01408 
01409                         (*ChangeCount) += 1;
01410 
01411 
01412                     } <span class="comment">// endif change needed</span>
01413 
01414                 } <span class="comment">// endif found</span>
01415 
01416                 NewIndex += 1;
01417 
01418             } <span class="comment">// endwhile searching NewState</span>
01419 
01420         } <span class="comment">// endelse</span>
01421 
01422         OldIndex += 1;
01423 
01424     } <span class="comment">// endwhile more groups in token</span>
01425 
01426     <span class="comment">//</span>
01427     <span class="comment">// Set completion status appropriately if some not assigned</span>
01428     <span class="comment">//</span>
01429 
01430     <span class="keywordflow">if</span> (!ResetToDefault) {
01431 
01432         <span class="keywordflow">if</span> (MatchCount &lt; GroupCount) {
01433             CompletionStatus = STATUS_NOT_ALL_ASSIGNED;
01434         }
01435     }
01436 
01437     <span class="comment">//</span>
01438     <span class="comment">//  Indicate whether changes were made</span>
01439     <span class="comment">//</span>
01440 
01441     <span class="keywordflow">if</span> ((*ChangeCount) &gt; 0  &amp;&amp;  MakeChanges) {
01442         (*ChangesMade) = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01443     } <span class="keywordflow">else</span> {
01444         (*ChangesMade) = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01445     }
01446 
01447     <span class="comment">//</span>
01448     <span class="comment">// Calculate the space needed to return previous state information</span>
01449     <span class="comment">// (The SID lengths have already been added up in LocalReturnLength).</span>
01450     <span class="comment">//</span>
01451 
01452     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
01453 
01454         (*ReturnLength) = LocalReturnLength +
01455                           (ULONG)<span class="keyword">sizeof</span>(TOKEN_GROUPS) +
01456                           ((*ChangeCount) *  (ULONG)<span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES)) -
01457                           (<a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a> * (ULONG)<span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES));
01458     }
01459 
01460    <span class="keywordflow">return</span> CompletionStatus;
01461 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:01 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
