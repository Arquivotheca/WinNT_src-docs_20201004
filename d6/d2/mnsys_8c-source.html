<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: mnsys.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>mnsys.c</h1><a href="../../d5/d3/mnsys_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************** Module Header ********************************\</span>
00002 <span class="comment">* Module Name: mnsys.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* System Menu Routines</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">*  10-10-90 JimA    Cleanup.</span>
00010 <span class="comment">*  03-18-91 IanJa   Window revalidation added (none required)</span>
00011 <span class="comment">\***************************************************************************/</span>
00012 
00013 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00014 <span class="preprocessor">#pragma hdrstop</span>
00015 <span class="preprocessor"></span>
00016 <span class="keywordtype">void</span> <a class="code" href="../../d5/d3/mnsys_8c.html#a0">_SetCloseDefault</a>(<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pSubMenu);
00017 <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d5/d3/mnsys_8c.html#a1">FindFakeMDIChild</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndParent);
00018 
00019 <span class="comment">/***************************************************************************\</span>
00020 <span class="comment">* LoadSysDesktopMenu</span>
00021 <span class="comment">*</span>
00022 <span class="comment">* Loads and locks a desktop system menu. Since we have to call the client</span>
00023 <span class="comment">*  to load the menu, while thread 1 is loading the menu, thread 2</span>
00024 <span class="comment">*  might grab the critical section, check pdesk-&gt;spmenu* and decide that</span>
00025 <span class="comment">*  the menu needs to be loaded. Hence we could load the menu more than once.</span>
00026 <span class="comment">*  this function handles that case to avoid leaking menus.</span>
00027 <span class="comment">*</span>
00028 <span class="comment">* 10/24/97 Gerardob     Created</span>
00029 <span class="comment">\***************************************************************************/</span>
<a name="l00030"></a><a class="code" href="../../d4/d1/userk_8h.html#a1605">00030</a> <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> <a class="code" href="../../d4/d1/userk_8h.html#a1605">xxxLoadSysDesktopMenu</a> (<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> * ppmenu, UINT uMenuId)
00031 {
00032     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenu;
00033     <span class="comment">/*</span>
00034 <span class="comment">     * This should only be called when the menu hasn't been loaded</span>
00035 <span class="comment">     */</span>
00036     UserAssert(*ppmenu == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00037 
00038     pmenu = <a class="code" href="../../d5/d7/ntuser_2rtl_2menu_8c.html#a2">xxxLoadSysMenu</a>(uMenuId);
00039     <span class="keywordflow">if</span> (pmenu == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00040         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00041     }
00042     <span class="comment">/*</span>
00043 <span class="comment">     * If someone beat us loading the menu, destroy this one</span>
00044 <span class="comment">     *  and return the one already loaded</span>
00045 <span class="comment">     */</span>
00046     <span class="keywordflow">if</span> (*ppmenu != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00047         UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(*ppmenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a149">MFSYSMENU</a>));
00048         RIPMSG1(RIP_WARNING,
00049                 <span class="stringliteral">"LoadSysDesktopMenu: Menu loaded during callback. ppmenu:%#p"</span>,
00050                 ppmenu);
00051         <a class="code" href="../../d4/d1/userk_8h.html#a1887">_DestroyMenu</a>(pmenu);
00052         <span class="keywordflow">return</span> *ppmenu;
00053     }
00054     <span class="comment">/*</span>
00055 <span class="comment">     * Mark it, lock it and done</span>
00056 <span class="comment">     */</span>
00057     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a784">SetMF</a>(pmenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a149">MFSYSMENU</a>);
00058     <a class="code" href="../../d4/d1/userk_8h.html#a1603">LockDesktopMenu</a>(ppmenu, pmenu);
00059     <span class="keywordflow">return</span> pmenu;
00060 }
00061 <span class="comment">/***************************************************************************\</span>
00062 <span class="comment">* Lock/UnlockDesktopMenu</span>
00063 <span class="comment">*</span>
00064 <span class="comment">* These functions lock/unlock a pmenu into a desktop structure (spmenuSys or</span>
00065 <span class="comment">*  spmenuDialogSys) and mark/clear it as such.</span>
00066 <span class="comment">* We mark these menus so we can identify them quickly on single bit test.</span>
00067 <span class="comment">* We also don't want any one to modify these menus or any submenu.</span>
00068 <span class="comment">*</span>
00069 <span class="comment">* Note that this assumes that there is only one submenu. If more are added,</span>
00070 <span class="comment">*  these functions have to be fixed accordingly.</span>
00071 <span class="comment">*</span>
00072 <span class="comment">* 08/18/97 Gerardob     Created</span>
00073 <span class="comment">\***************************************************************************/</span>
<a name="l00074"></a><a class="code" href="../../d4/d1/userk_8h.html#a1603">00074</a> PVOID <a class="code" href="../../d4/d1/userk_8h.html#a1603">LockDesktopMenu</a>(<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> * ppmenu, <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenu)
00075 {
00076     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pSubMenu;
00077     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiDesktop;
00078     <span class="comment">/*</span>
00079 <span class="comment">     * We only load desktop sys menus once.</span>
00080 <span class="comment">     */</span>
00081     UserAssert(*ppmenu == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00082 
00083     <span class="keywordflow">if</span> (pmenu == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00084         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00085     }
00086 
00087     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a784">SetMF</a>(pmenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a148">MFDESKTOP</a>);
00088     <span class="comment">/*</span>
00089 <span class="comment">     * This is awful but this is the real owner of this object. We used to set it</span>
00090 <span class="comment">     *  to NULL but that was forcing us to handle the NULL owner all over the place</span>
00091 <span class="comment">     */</span>
00092     ptiDesktop = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;rpdesk-&gt;rpwinstaParent-&gt;pTerm-&gt;ptiDesktop;
00093     <a class="code" href="../../d4/d1/userk_8h.html#a111">HMChangeOwnerProcess</a>(pmenu, ptiDesktop);
00094 
00095     pSubMenu = pmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a>;
00096     UserAssert(pSubMenu != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00097 
00098     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a784">SetMF</a>(pSubMenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a148">MFDESKTOP</a>);
00099     <a class="code" href="../../d4/d1/userk_8h.html#a111">HMChangeOwnerProcess</a>(pSubMenu, ptiDesktop);
00100 
00101 <span class="preprocessor">#if DBG</span>
00102 <span class="preprocessor"></span>    {
00103         <span class="comment">/*</span>
00104 <span class="comment">         * Assert that there are no other submenus that would need to be</span>
00105 <span class="comment">         *  marked as MFDESKTOP.</span>
00106 <span class="comment">         */</span>
00107         <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pitem;
00108         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uItems;
00109 
00110         UserAssert(pmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a> == 1);
00111 
00112         pitem = pSubMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>;
00113         uItems = pSubMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>;
00114         <span class="keywordflow">while</span> (uItems--) {
00115             UserAssert(pitem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00116             pitem++;
00117         }
00118     }
00119 <span class="preprocessor">#endif</span>
00120 <span class="preprocessor"></span>
00121     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(ppmenu, pmenu);
00122 }
00123 
<a name="l00124"></a><a class="code" href="../../d4/d1/userk_8h.html#a1604">00124</a> PVOID <a class="code" href="../../d4/d1/userk_8h.html#a1604">UnlockDesktopMenu</a>(<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> * ppmenu)
00125 {
00126     UserAssert(*ppmenu != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00127     UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(*ppmenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a148">MFDESKTOP</a>));
00128     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a785">ClearMF</a>(*ppmenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a148">MFDESKTOP</a>);
00129     UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>((*ppmenu)-&gt;rgItems-&gt;spSubMenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a148">MFDESKTOP</a>));
00130     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a785">ClearMF</a>((*ppmenu)-&gt;rgItems-&gt;spSubMenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a148">MFDESKTOP</a>);
00131     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(ppmenu);
00132 }
00133 <span class="comment">/***************************************************************************\</span>
00134 <span class="comment">* GetSysMenuHandle</span>
00135 <span class="comment">*</span>
00136 <span class="comment">* Returns a handle to the system menu of the given window. NULL if</span>
00137 <span class="comment">* the window doesn't have a system menu.</span>
00138 <span class="comment">*</span>
00139 <span class="comment">* History:</span>
00140 <span class="comment">\***************************************************************************/</span>
00141 
<a name="l00142"></a><a class="code" href="../../d5/d3/mnsys_8c.html#a5">00142</a> <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> <a class="code" href="../../d4/d1/userk_8h.html#a1403">xxxGetSysMenuHandle</a>(
00143     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00144 {
00145     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu;
00146 
00147     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00148 
00149     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a639">WFSYSMENU</a>)) {
00150         pMenu = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o15">spmenuSys</a>;
00151 
00152         <span class="comment">/*</span>
00153 <span class="comment">         * If the window doesn't have a System Menu, use the default one.</span>
00154 <span class="comment">         */</span>
00155         <span class="keywordflow">if</span> (pMenu == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00156 
00157             <span class="comment">/*</span>
00158 <span class="comment">             * Grab the menu from the desktop.  If the desktop menu</span>
00159 <span class="comment">             * has not been loaded and this is not a system thread,</span>
00160 <span class="comment">             * load it now.  Callbacks cannot be made from a system</span>
00161 <span class="comment">             * thread or when a thread is in cleanup.</span>
00162 <span class="comment">             */</span>
00163             pMenu = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk-&gt;spmenuSys;
00164 
00165             <span class="comment">/*</span>
00166 <span class="comment">             * Do not do callbacks if the thread is exiting.  We ran into this when</span>
00167 <span class="comment">             * destroying a thread's window and the window it was promoting to</span>
00168 <span class="comment">             * foreground was a hard error popup.</span>
00169 <span class="comment">             */</span>
00170             <span class="keywordflow">if</span> (pMenu == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; !(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;TIF_flags &amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a797">TIF_SYSTEMTHREAD</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>))) {
00171 
00172                 pMenu = <a class="code" href="../../d4/d1/userk_8h.html#a1605">xxxLoadSysDesktopMenu</a> (&amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk-&gt;spmenuSys, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a753">ID_SYSMENU</a>);
00173             }
00174         }
00175     } <span class="keywordflow">else</span> {
00176         pMenu = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00177     }
00178 
00179     <span class="keywordflow">return</span> pMenu;
00180 }
00181 
00182 <span class="comment">/***************************************************************************\</span>
00183 <span class="comment">*</span>
00184 <span class="comment">*  GetSysMenu()</span>
00185 <span class="comment">*</span>
00186 <span class="comment">*  Sets up the system menu first, then returns it.</span>
00187 <span class="comment">*</span>
00188 <span class="comment">\***************************************************************************/</span>
<a name="l00189"></a><a class="code" href="../../d4/d1/userk_8h.html#a1404">00189</a> <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> <a class="code" href="../../d4/d1/userk_8h.html#a1404">xxxGetSysMenu</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, BOOL fSubMenu)
00190 {
00191     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a>   pMenu;
00192 
00193     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00194     <a class="code" href="../../d4/d1/userk_8h.html#a1402">xxxSetSysMenu</a>(pwnd);
00195     <span class="keywordflow">if</span> ((pMenu = <a class="code" href="../../d4/d1/userk_8h.html#a1403">xxxGetSysMenuHandle</a>(pwnd)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00196         <span class="keywordflow">if</span> (fSubMenu)
00197             pMenu = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a15">_GetSubMenu</a>(pMenu, 0);
00198     }
00199 
00200     <span class="keywordflow">return</span>(pMenu);
00201 }
00202 
00203 <span class="comment">/***************************************************************************\</span>
00204 <span class="comment">* IsSmallerThanScreen</span>
00205 <span class="comment">*</span>
00206 <span class="comment">\***************************************************************************/</span>
00207 
<a name="l00208"></a><a class="code" href="../../d4/d1/userk_8h.html#a1109">00208</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1109">IsSmallerThanScreen</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00209 {
00210     <span class="keywordtype">int</span> dxMax, dyMax;
00211     <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a> pMonitor;
00212 
00213     pMonitor = <a class="code" href="../../d9/d1/mmrtl_8c.html#a8">_MonitorFromWindow</a>(pwnd, MONITOR_DEFAULTTOPRIMARY);
00214     dxMax = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.right - pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.left;
00215     dyMax = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.bottom - pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.top;
00216 
00217     <span class="keywordflow">if</span> ((pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left &lt; dxMax) ||
00218             (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.bottom - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top &lt; dyMax)) {
00219         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00220     }
00221     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00222 }
00223 
00224 <span class="comment">/***************************************************************************\</span>
00225 <span class="comment">* SetSysMenu</span>
00226 <span class="comment">*</span>
00227 <span class="comment">* !</span>
00228 <span class="comment">*</span>
00229 <span class="comment">* History:</span>
00230 <span class="comment">\***************************************************************************/</span>
00231 
<a name="l00232"></a><a class="code" href="../../d4/d1/userk_8h.html#a1402">00232</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1402">xxxSetSysMenu</a>(
00233     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00234 {
00235     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu;
00236     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> wSize;
00237     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> wMinimize;
00238     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> wMaximize;
00239     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> wMove;
00240     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> wRestore;
00241     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> wDefault;
00242     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fFramedDialogBox;
00243     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlmenu;
00244 
00245     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00246     <span class="comment">/*</span>
00247 <span class="comment">     * Get the handle of the current system menu.</span>
00248 <span class="comment">     */</span>
00249     <span class="keywordflow">if</span> ((pMenu = <a class="code" href="../../d4/d1/userk_8h.html#a1403">xxxGetSysMenuHandle</a>(pwnd)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00250 
00251         pMenu = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a15">_GetSubMenu</a>(pMenu, 0);
00252         <span class="keywordflow">if</span> (!pMenu)
00253             <span class="keywordflow">return</span>;
00254 
00255         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pMenu, &amp;tlmenu);
00256 
00257         <span class="comment">/*</span>
00258 <span class="comment">         * System modal window: no size, icon, zoom, or move.</span>
00259 <span class="comment">         */</span>
00260 
00261 <span class="comment">// No system modal windows on NT.</span>
00262 <span class="comment">//        wSize = wMaximize = wMinimize = wMove =</span>
00263 <span class="comment">//            (UINT)((_GetSysModalWindow() == NULL) || hTaskLockInput ? 0: MFS_GRAYED);</span>
00264         wSize = wMaximize = wMinimize = wMove =  0;
00265         wRestore = MFS_GRAYED;
00266 
00267         <span class="comment">//</span>
00268         <span class="comment">// Default menu command is close.</span>
00269         <span class="comment">//</span>
00270         wDefault = SC_CLOSE;
00271 
00272         <span class="comment">/*</span>
00273 <span class="comment">         * Minimized exceptions: no minimize, restore.</span>
00274 <span class="comment">         */</span>
00275 
00276         <span class="comment">// we need to reverse these because VB has a "special" window</span>
00277         <span class="comment">// that is both minimized but without a minbox.</span>
00278         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>))
00279         {
00280             wRestore  = 0;
00281             wMinimize = MFS_GRAYED;
00282             wSize     = MFS_GRAYED;
00283             wDefault  = SC_RESTORE;
00284 
00285             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/winloop2_8c.html#a2">IsTrayWindow</a>(pwnd))
00286               wMove = MFS_GRAYED;
00287         }
00288         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a636">WFMINBOX</a>))
00289             wMinimize = MFS_GRAYED;
00290 
00291         <span class="comment">/*</span>
00292 <span class="comment">         * Maximized exceptions: no maximize, restore.</span>
00293 <span class="comment">         */</span>
00294         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a634">WFMAXBOX</a>))
00295             wMaximize = MFS_GRAYED;
00296         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a648">WFMAXIMIZED</a>)) {
00297             wRestore = 0;
00298 
00299             <span class="comment">/*</span>
00300 <span class="comment">             * If the window is maximized but it isn't larger than the</span>
00301 <span class="comment">             * screen, we allow the user to move the window around the</span>
00302 <span class="comment">             * desktop (but we don't allow resizing).</span>
00303 <span class="comment">             */</span>
00304             wMove = MFS_GRAYED;
00305             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a654">WFCHILD</a>)) {
00306                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1109">IsSmallerThanScreen</a>(pwnd)) {
00307                     wMove = 0;
00308                 }
00309             }
00310 
00311             wSize     = MFS_GRAYED;
00312             wMaximize = MFS_GRAYED;
00313         }
00314 
00315         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a638">WFSIZEBOX</a>))
00316             wSize = MFS_GRAYED;
00317 
00318         <span class="comment">/*</span>
00319 <span class="comment">         * Are we dealing with a framed dialog box with a sys menu?</span>
00320 <span class="comment">         * Dialogs with min/max/size boxes get a regular system menu</span>
00321 <span class="comment">         *  (as opposed to the dialog menu)</span>
00322 <span class="comment">         */</span>
00323         fFramedDialogBox =
00324                 (((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a645">WFBORDERMASK</a>) == (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)<a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a642">WFDLGFRAME</a>))
00325                         || (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a612">WEFDLGMODALFRAME</a>)))
00326                     &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a638">WFSIZEBOX</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a636">WFMINBOX</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a634">WFMAXBOX</a>));
00327 
00328         <span class="keywordflow">if</span> (!fFramedDialogBox) {
00329             <a class="code" href="../../d4/d1/userk_8h.html#a1889">xxxEnableMenuItem</a>(pMenu, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)SC_SIZE, wSize);
00330             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a619">WEFTOOLWINDOW</a>))
00331             {
00332                 <a class="code" href="../../d4/d1/userk_8h.html#a1889">xxxEnableMenuItem</a>(pMenu, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)SC_MINIMIZE, wMinimize);
00333                 <a class="code" href="../../d4/d1/userk_8h.html#a1889">xxxEnableMenuItem</a>(pMenu, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)SC_MAXIMIZE, wMaximize);
00334                 <a class="code" href="../../d4/d1/userk_8h.html#a1889">xxxEnableMenuItem</a>(pMenu, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)SC_RESTORE, wRestore);
00335             }
00336         }
00337 
00338         <a class="code" href="../../d4/d1/userk_8h.html#a1889">xxxEnableMenuItem</a>(pMenu, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)SC_MOVE, wMove);
00339 
00340 <span class="preprocessor">#if DBG</span>
00341 <span class="preprocessor"></span>        <span class="comment">/*</span>
00342 <span class="comment">         * Assert that nobody managed to change the desktop menus.</span>
00343 <span class="comment">         */</span>
00344         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(pMenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a149">MFSYSMENU</a>)) {
00345             <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pItem = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a10">MNLookUpItem</a>(pMenu, SC_CLOSE, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00346             UserAssert((pItem != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a788">TestMFS</a>(pItem, MFS_GRAYED));
00347         }
00348 <span class="preprocessor">#endif</span>
00349 <span class="preprocessor"></span>
00350         <span class="keywordflow">if</span> (wDefault == SC_CLOSE)
00351             <a class="code" href="../../d5/d3/mnsys_8c.html#a0">_SetCloseDefault</a>(pMenu);
00352         <span class="keywordflow">else</span>
00353             <a class="code" href="../../d4/d1/userk_8h.html#a1599">_SetMenuDefaultItem</a>(pMenu, wDefault, MF_BYCOMMAND);
00354 
00355         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlmenu);
00356     }
00357 }
00358 
00359 
00360 <span class="comment">/***************************************************************************\</span>
00361 <span class="comment">* GetSystemMenu</span>
00362 <span class="comment">*</span>
00363 <span class="comment">* !</span>
00364 <span class="comment">*</span>
00365 <span class="comment">* History:</span>
00366 <span class="comment">\***************************************************************************/</span>
00367 
<a name="l00368"></a><a class="code" href="../../d4/d1/userk_8h.html#a1886">00368</a> <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> <a class="code" href="../../d4/d1/userk_8h.html#a1886">xxxGetSystemMenu</a>(
00369     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00370     BOOL fRevert)
00371 {
00372     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenu;
00373     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00374 
00375     <span class="comment">/*</span>
00376 <span class="comment">     * Should we start with a fresh copy?</span>
00377 <span class="comment">     */</span>
00378 
00379     pmenu = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o15">spmenuSys</a>;
00380     <span class="keywordflow">if</span> (fRevert) {
00381 
00382         <span class="comment">/*</span>
00383 <span class="comment">         * Destroy the old system menu.</span>
00384 <span class="comment">         */</span>
00385         <span class="keywordflow">if</span> ((pmenu != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(pmenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a149">MFSYSMENU</a>)) {
00386 
00387             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1363">UnlockWndMenu</a>(pwnd, &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o15">spmenuSys</a>)) {
00388                 <a class="code" href="../../d4/d1/userk_8h.html#a1887">_DestroyMenu</a>(pmenu);
00389             }
00390         }
00391     } <span class="keywordflow">else</span> {
00392 
00393         <span class="comment">/*</span>
00394 <span class="comment">         * Do we need to load a new system menu?</span>
00395 <span class="comment">         */</span>
00396         <span class="keywordflow">if</span> (((pmenu == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(pmenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a149">MFSYSMENU</a>))
00397                 &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a639">WFSYSMENU</a>)) {
00398 
00399             <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> pGlobalPopupMenu;
00400             <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uMenuId = (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o15">spmenuSys</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a753">ID_SYSMENU</a> : <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a756">ID_DIALOGSYSMENU</a>);
00401             pmenu = <a class="code" href="../../d5/d7/ntuser_2rtl_2menu_8c.html#a2">xxxLoadSysMenu</a>(uMenuId);
00402             <span class="keywordflow">if</span> (pmenu == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00403                 RIPMSG1(RIP_WARNING, <span class="stringliteral">"_GetSystemMenu: xxxLoadSysMenu Failed. pwnd:%#p"</span>, pwnd);
00404             }
00405             <a class="code" href="../../d4/d1/userk_8h.html#a1362">LockWndMenu</a>(pwnd, &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o15">spmenuSys</a>, pmenu);
00406 
00407             pmenu = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o15">spmenuSys</a>;
00408             pGlobalPopupMenu = <a class="code" href="../../d4/d1/userk_8h.html#a1321">GetpGlobalPopupMenu</a>(pwnd);
00409             <span class="keywordflow">if</span> ((pGlobalPopupMenu != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00410                     &amp;&amp; !pGlobalPopupMenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o3">fIsTrackPopup</a>
00411                     &amp;&amp; (pGlobalPopupMenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a> == pwnd)) {
00412 
00413                 UserAssert(pGlobalPopupMenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a> == pwnd);
00414                 <span class="keywordflow">if</span> (pGlobalPopupMenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o2">fIsSysMenu</a>) {
00415                     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pGlobalPopupMenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>, pmenu);
00416                 } <span class="keywordflow">else</span> {
00417                     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pGlobalPopupMenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o30">spmenuAlternate</a>, pmenu);
00418                 }
00419             }
00420         }
00421     }
00422 
00423     <span class="comment">/*</span>
00424 <span class="comment">     * Return the handle to the system menu.</span>
00425 <span class="comment">     */</span>
00426     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o15">spmenuSys</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00427         <span class="comment">/*</span>
00428 <span class="comment">         * The app is probably going to modify this menu and then we'll need to</span>
00429 <span class="comment">         *  redraw the caption buttons. Hence we need to store the window pointer</span>
00430 <span class="comment">         *  in this pmenu or we won't be able to know what window to repaint.</span>
00431 <span class="comment">         * The bogus thing is that we cannot call LockWndMenu here because this is</span>
00432 <span class="comment">         *  not the actual pmenuSys.</span>
00433 <span class="comment">         */</span>
00434         pmenu = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a15">_GetSubMenu</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o15">spmenuSys</a>, 0);
00435         <span class="keywordflow">if</span> (pmenu) {
00436             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a784">SetMF</a>(pmenu, <a class="code" href="../../d1/d0/inc_2user_8h.html#a147">MFAPPSYSMENU</a>);
00437             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o8">spwndNotify</a>, pwnd);
00438         }
00439         <span class="keywordflow">return</span> pmenu;
00440     }
00441 
00442     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00443 }
00444 
00445 <span class="comment">/***************************************************************************\</span>
00446 <span class="comment">* MenuItemState</span>
00447 <span class="comment">*</span>
00448 <span class="comment">* Sets the menu item flags identified by wMask to the states identified</span>
00449 <span class="comment">* by wFlags.</span>
00450 <span class="comment">*</span>
00451 <span class="comment">* History:</span>
00452 <span class="comment">* 10-11-90 JimA       Translated from ASM</span>
00453 <span class="comment">\***************************************************************************/</span>
00454 
<a name="l00455"></a><a class="code" href="../../d5/d3/mnsys_8c.html#a10">00455</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d3/mnsys_8c.html#a10">MenuItemState</a>(
00456     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu,
00457     UINT wCmd,
00458     DWORD wFlags,
00459     DWORD wMask,
00460     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> *ppMenu)
00461 {
00462     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pItem;
00463     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> wRet;
00464 
00465     <span class="comment">/*</span>
00466 <span class="comment">     * Get a pointer the the menu item</span>
00467 <span class="comment">     */</span>
00468     <span class="keywordflow">if</span> ((pItem = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a10">MNLookUpItem</a>(pMenu, wCmd, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>) (wFlags &amp; MF_BYPOSITION), ppMenu)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00469         <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1;
00470 
00471     <span class="comment">/*</span>
00472 <span class="comment">     * Return previous state</span>
00473 <span class="comment">     */</span>
00474     wRet = pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o1">fState</a> &amp; wMask;
00475 
00476     <span class="comment">/*</span>
00477 <span class="comment">     * Set new state</span>
00478 <span class="comment">     */</span>
00479     pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o1">fState</a> ^= ((wRet ^ wFlags) &amp; wMask);
00480 
00481     <span class="keywordflow">return</span> wRet;
00482 }
00483 
00484 
00485 <span class="comment">/***************************************************************************\</span>
00486 <span class="comment">* EnableMenuItem</span>
00487 <span class="comment">*</span>
00488 <span class="comment">* Enable, disable or gray a menu item.</span>
00489 <span class="comment">*</span>
00490 <span class="comment">* History:</span>
00491 <span class="comment">* 10-11-90 JimA       Translated from ASM</span>
00492 <span class="comment">\***************************************************************************/</span>
00493 
<a name="l00494"></a><a class="code" href="../../d4/d1/userk_8h.html#a1889">00494</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d1/userk_8h.html#a1889">xxxEnableMenuItem</a>(
00495     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu,
00496     UINT wIDEnableItem,
00497     UINT wEnable)
00498 {
00499     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dres;
00500     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pRealMenu;
00501     <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopup;
00502 
00503     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pMenu);
00504 
00505     dres = <a class="code" href="../../d5/d3/mnsys_8c.html#a10">MenuItemState</a>(pMenu, wIDEnableItem, wEnable,
00506             MFS_GRAYED, &amp;pRealMenu);
00507 
00508     <span class="comment">/*</span>
00509 <span class="comment">     * If enabling/disabling a system menu item, redraw the caption buttons</span>
00510 <span class="comment">     */</span>
00511     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(pMenu, <a class="code" href="../../d1/d0/inc_2user_8h.html#a147">MFAPPSYSMENU</a>) &amp;&amp; (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o8">spwndNotify</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00512 
00513         <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
00514 
00515         <span class="keywordflow">switch</span> (wIDEnableItem) {
00516         <span class="keywordflow">case</span> SC_SIZE:
00517         <span class="keywordflow">case</span> SC_MOVE:
00518         <span class="keywordflow">case</span> SC_MINIMIZE:
00519         <span class="keywordflow">case</span> SC_MAXIMIZE:
00520         <span class="keywordflow">case</span> SC_CLOSE:
00521         <span class="keywordflow">case</span> SC_RESTORE:
00522             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o8">spwndNotify</a>, &amp;tlpwnd);
00523             <a class="code" href="../../d4/d1/userk_8h.html#a1995">xxxRedrawTitle</a>(pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o8">spwndNotify</a>, DC_BUTTONS);
00524             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
00525         }
00526     }
00527 
00528     <span class="comment">/* 367162: If the menu is already being displayed we need to redraw it */</span>
00529     <span class="keywordflow">if</span>(pRealMenu &amp;&amp; (ppopup = <a class="code" href="../../d4/d1/userk_8h.html#a1602">MNGetPopupFromMenu</a>(pRealMenu, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))){
00530         <a class="code" href="../../d4/d1/userk_8h.html#a1336">xxxMNUpdateShownMenu</a>(ppopup, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a530">MNUS_DEFAULT</a>);
00531     }
00532 
00533     <span class="keywordflow">return</span> dres;
00534 }
00535 
00536 
00537 <span class="comment">/***************************************************************************\</span>
00538 <span class="comment">* CheckMenuItem (API)</span>
00539 <span class="comment">*</span>
00540 <span class="comment">* Check or un-check a popup menu item.</span>
00541 <span class="comment">*</span>
00542 <span class="comment">* History:</span>
00543 <span class="comment">* 10-11-90 JimA       Translated from ASM</span>
00544 <span class="comment">\***************************************************************************/</span>
00545 
<a name="l00546"></a><a class="code" href="../../d4/d1/userk_8h.html#a1888">00546</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d1/userk_8h.html#a1888">_CheckMenuItem</a>(
00547     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu,
00548     UINT wIDCheckItem,
00549     UINT wCheck)
00550 {
00551     <span class="keywordflow">return</span> <a class="code" href="../../d5/d3/mnsys_8c.html#a10">MenuItemState</a>(pMenu, wIDCheckItem, wCheck, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)MF_CHECKED, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00552 }
00553 
00554 
00555 <span class="comment">/***************************************************************************\</span>
00556 <span class="comment">*</span>
00557 <span class="comment">*  SetMenuDefaultItem() -</span>
00558 <span class="comment">*</span>
00559 <span class="comment">*  Sets the default item in the menu, by command or by position based on the</span>
00560 <span class="comment">*  fByPosition flag.</span>
00561 <span class="comment">*  We unset all the other items as the default, then set the given one.</span>
00562 <span class="comment">*</span>
00563 <span class="comment">*  The return value is TRUE if the given item was set as default, FALSE</span>
00564 <span class="comment">*  if not.</span>
00565 <span class="comment">*</span>
00566 <span class="comment">\***************************************************************************/</span>
<a name="l00567"></a><a class="code" href="../../d4/d1/userk_8h.html#a1599">00567</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1599">_SetMenuDefaultItem</a>(<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu, UINT wID, BOOL fByPosition)
00568 {
00569     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>  iItem;
00570     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>  cItems;
00571     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pItem;
00572     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pItemFound;
00573     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a>   pMenuFound;
00574 
00575     <span class="comment">//</span>
00576     <span class="comment">// We need to check if wId actually exists on this menu.  0xFFFF means</span>
00577     <span class="comment">// clear all default items.</span>
00578     <span class="comment">//</span>
00579 
00580     <span class="keywordflow">if</span> (wID != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>)
00581     {
00582         pItemFound = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a10">MNLookUpItem</a>(pMenu, wID, fByPosition, &amp;pMenuFound);
00583 
00584         <span class="comment">// item must be on same menu and can't be a separator</span>
00585         <span class="keywordflow">if</span> ((pItemFound == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (pMenuFound != pMenu) || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a791">TestMFT</a>(pItemFound, MFT_SEPARATOR))
00586             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00587 
00588     }
00589     <span class="keywordflow">else</span>
00590         pItemFound = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00591 
00592     pItem = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>;
00593     cItems = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>;
00594 
00595     <span class="comment">// Walk the menu list, clearing MFS_DEFAULT from all other items, and</span>
00596     <span class="comment">// setting MFS_DEFAULT on the requested one.</span>
00597     <span class="keywordflow">for</span> (iItem = 0; iItem &lt; cItems; iItem++, pItem++) {
00598         <span class="comment">//</span>
00599         <span class="comment">// Note we don't change the state of lpItemFound if it exists.  This</span>
00600         <span class="comment">// is so that below, where we try to set the default, we can tell</span>
00601         <span class="comment">// if we need to recalculate the underline.</span>
00602         <span class="comment">//</span>
00603 
00604         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a788">TestMFS</a>(pItem, MFS_DEFAULT) &amp;&amp; (pItem != pItemFound))
00605         {
00606             <span class="comment">//</span>
00607             <span class="comment">// We are changing the default item.  As such, it will be drawn</span>
00608             <span class="comment">// with a different font than the one used to calculate it, if</span>
00609             <span class="comment">// the menu has already been drawn once.  We need to ensure</span>
00610             <span class="comment">// that the underline gets drawn in the right place the next</span>
00611             <span class="comment">// time the menu comes up.  Cause it to recalculate.</span>
00612             <span class="comment">//</span>
00613             <span class="comment">// We do NOT do this if the item</span>
00614             <span class="comment">//      (a) isn't default--otherwise we'll recalculate the</span>
00615             <span class="comment">//  underline for every system menu item every time we go into</span>
00616             <span class="comment">//  menu mode because sysmenu init will call SetMenuDefaultItem.</span>
00617             <span class="comment">//      (b) isn't the item we're going to set as the default.</span>
00618             <span class="comment">//  That way we don't recalculate the underline when the item</span>
00619             <span class="comment">//  isn't changing state.</span>
00620             <span class="comment">//</span>
00621             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a789">ClearMFS</a>(pItem, MFS_DEFAULT);
00622             pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o14">ulX</a> = <a class="code" href="../../d4/d1/userk_8h.html#a570">UNDERLINE_RECALC</a>;
00623             pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o15">ulWidth</a> = 0;
00624         }
00625     }
00626 
00627     <span class="keywordflow">if</span> (wID != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>)
00628     {
00629         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a788">TestMFS</a>(pItemFound, MFS_DEFAULT))
00630         {
00631             <span class="comment">//</span>
00632             <span class="comment">// We are changing from non-default to default.  Clear out</span>
00633             <span class="comment">// the underline info.  If the menu has never painted, this</span>
00634             <span class="comment">// won't do anything.  But it matters a lot if it has.</span>
00635             <span class="comment">//</span>
00636             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a787">SetMFS</a>(pItemFound, MFS_DEFAULT);
00637             pItemFound-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o14">ulX</a> = <a class="code" href="../../d4/d1/userk_8h.html#a570">UNDERLINE_RECALC</a>;
00638             pItemFound-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o15">ulWidth</a> = 0;
00639         }
00640     }
00641 
00642     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00643 }
00644 
00645 <span class="comment">// --------------------------------------------------------------------------</span>
00646 <span class="comment">//</span>
00647 <span class="comment">//  SetCloseDefault()</span>
00648 <span class="comment">//</span>
00649 <span class="comment">//  Tries to find a close item in the first level of menu items.  Looks</span>
00650 <span class="comment">//  for SC_CLOSE, then a couple other IDs.  We'd rather not do lstrstri's</span>
00651 <span class="comment">//  for "Close", which is slow.</span>
00652 <span class="comment">//</span>
00653 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00654"></a><a class="code" href="../../d5/d3/mnsys_8c.html#a0">00654</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d3/mnsys_8c.html#a0">_SetCloseDefault</a>(<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pSubMenu)
00655 {
00656     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1599">_SetMenuDefaultItem</a>(pSubMenu, SC_CLOSE, MF_BYCOMMAND))
00657     {
00658         <span class="comment">//</span>
00659         <span class="comment">// Bloody hell.  Let's try a couple other values.</span>
00660         <span class="comment">//      * Project   --  0x7000 less</span>
00661         <span class="comment">//      * FoxPro    --  0xC070</span>
00662         <span class="comment">//</span>
00663         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1599">_SetMenuDefaultItem</a>(pSubMenu, SC_CLOSE - 0x7000, MF_BYCOMMAND))
00664             <a class="code" href="../../d4/d1/userk_8h.html#a1599">_SetMenuDefaultItem</a>(pSubMenu, 0xC070, MF_BYCOMMAND);
00665     }
00666 }
00667 
00668 
00669 <span class="comment">// --------------------------------------------------------------------------</span>
00670 <span class="comment">//</span>
00671 <span class="comment">//  FindFakeMDIChild()</span>
00672 <span class="comment">//</span>
00673 <span class="comment">//  Attempts to find first child visible child window in the zorder that</span>
00674 <span class="comment">//  has a system menu or is maxed.  We can't check for an exact system</span>
00675 <span class="comment">//  menu match because several apps make their own copy of the sys menu.</span>
00676 <span class="comment">//</span>
00677 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00678"></a><a class="code" href="../../d5/d3/mnsys_8c.html#a1">00678</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d5/d3/mnsys_8c.html#a1">FindFakeMDIChild</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00679 {
00680     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>    pwndReturn;
00681 
00682     <span class="comment">// Skip invisible windows and their descendants</span>
00683     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>))
00684         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00685 
00686     <span class="comment">// Did we hit pay dirt?</span>
00687     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a654">WFCHILD</a>) &amp;&amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a648">WFMAXIMIZED</a>) || (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o15">spmenuSys</a>)))
00688         <span class="keywordflow">return</span>(pwnd);
00689 
00690     <span class="comment">// Check our children</span>
00691     <span class="keywordflow">for</span> (pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>; pwnd; pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>)
00692     {
00693         pwndReturn = <a class="code" href="../../d5/d3/mnsys_8c.html#a1">FindFakeMDIChild</a>(pwnd);
00694         <span class="keywordflow">if</span> (pwndReturn)
00695             <span class="keywordflow">return</span>(pwndReturn);
00696     }
00697 
00698     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00699 }
00700 
00701 
00702 
00703 <span class="comment">// --------------------------------------------------------------------------</span>
00704 <span class="comment">//</span>
00705 <span class="comment">//  SetupFakeMDIAppStuff()</span>
00706 <span class="comment">//</span>
00707 <span class="comment">//  For apps that dork around with their own MDI (Excel, Word, Project,</span>
00708 <span class="comment">//      Quattro Pro), we want to make them a little more Chicago friendly.</span>
00709 <span class="comment">//      Namely we:</span>
00710 <span class="comment">//</span>
00711 <span class="comment">//      (1) Set the default menu item to SC_CLOSE if there isn't one (this</span>
00712 <span class="comment">//          won't help FoxPro, but they do so much wrong stuff it doesn't</span>
00713 <span class="comment">//          really matter).</span>
00714 <span class="comment">//          That way double-clicks will still work.</span>
00715 <span class="comment">//</span>
00716 <span class="comment">//      (2) Get the right small icon.</span>
00717 <span class="comment">//</span>
00718 <span class="comment">//  The way we do this is to go find the child window of the menu bar parent</span>
00719 <span class="comment">//  who has a system menu that is this one.</span>
00720 <span class="comment">//</span>
00721 <span class="comment">//  If the system menu is the standard one, then we can't do (2).</span>
00722 <span class="comment">//</span>
00723 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00724"></a><a class="code" href="../../d5/d3/mnsys_8c.html#a14">00724</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d3/mnsys_8c.html#a14">SetupFakeMDIAppStuff</a>(<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> lpMenu, <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> lpItem)
00725 {
00726     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a>   pSubMenu;
00727     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>    pwndParent;
00728     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>    pwndChild;
00729 
00730     <span class="keywordflow">if</span> (!(pSubMenu = lpItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a>))
00731         <span class="keywordflow">return</span>;
00732 
00733     pwndParent = lpMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o8">spwndNotify</a>;
00734 
00735     <span class="comment">//</span>
00736     <span class="comment">// Set up the default menu item.  Project and FoxPro renumber their</span>
00737     <span class="comment">// IDs so we do some special stuff for them, among others.</span>
00738     <span class="comment">//</span>
00739     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndParent, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>))
00740     {
00741         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d7/ntuser_2rtl_2menu_8c.html#a0">_GetMenuDefaultItem</a>(pSubMenu, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, GMDI_USEDISABLED) == -1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>)
00742             <a class="code" href="../../d5/d3/mnsys_8c.html#a0">_SetCloseDefault</a>(pSubMenu);
00743     }
00744 
00745     <span class="comment">//</span>
00746     <span class="comment">// Don't touch the HIWORD if we don't find an HWND.  That way apps</span>
00747     <span class="comment">// like Excel which have starting-up maxed children can benefit a little.</span>
00748     <span class="comment">// The first time the menu bar is redrawn, the child isn't visible/</span>
00749     <span class="comment">// around (they add the item too early).  But if it redraws later, or</span>
00750     <span class="comment">// you max a child, the icon will kick in.</span>
00751     <span class="comment">//</span>
00752     <span class="keywordflow">if</span> (pwndChild = <a class="code" href="../../d5/d3/mnsys_8c.html#a1">FindFakeMDIChild</a>(pwndParent)) {
00753         lpItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o8">dwItemData</a> = (ULONG_PTR)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwndChild);
00754 <span class="comment">//        lpItem-&gt;dwTypeData = MAKELONG(LOWORD(lpItem-&gt;dwTypeData), HW16(hwndChild));</span>
00755     }
00756 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:52 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
