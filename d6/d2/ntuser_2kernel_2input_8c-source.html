<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: input.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>input.c</h1><a href="../../d5/d3/ntuser_2kernel_2input_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: input.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains the core functions of the input sub-system</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 10-18-90 DavidPe      Created.</span>
00010 <span class="comment">* 02-14-91 mikeke       Added Revalidation code</span>
00011 <span class="comment">\***************************************************************************/</span>
00012 
00013 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00014 <span class="preprocessor">#pragma hdrstop</span>
00015 <span class="preprocessor"></span>
00016 <span class="comment">//#define MARKPATH</span>
00017 <span class="preprocessor">#ifdef MARKPATH</span>
00018 <span class="preprocessor"></span><a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> gfMarkPath;
00019 <span class="preprocessor">#endif</span>
00020 <span class="preprocessor"></span>
00021 <span class="preprocessor">#if DEBUGTAGS</span>
00022 <span class="preprocessor"></span>
00023 <span class="keywordtype">int</span>  gnSysPeekSearch;
00024 
00025 <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a11">CheckPtiSysPeek</a>(<span class="keywordtype">int</span> where, <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pq, ULONG_PTR newIdSysPeek)
00026 {
00027     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00028     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       dwRip;
00029 
00030     dwRip = (newIdSysPeek &gt; 1) ? RIP_THERESMORE : 0;
00031     TAGMSG5(DBGTAG_SysPeek | dwRip,
00032             <span class="stringliteral">"%d pti %#p sets id %#p to pq %#p ; old id %#p"</span>,
00033             where, ptiCurrent, newIdSysPeek, pq, pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o3">idSysPeek</a>);
00034 
00035     <span class="keywordflow">if</span> (newIdSysPeek &gt; 1) {
00036         <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsg = (<a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a>)newIdSysPeek;
00037         TAGMSG5(DBGTAG_SysPeek | RIP_NONAME,
00038                 <span class="stringliteral">"-&gt; msg %lx hwnd %#p w %#p l %#p pti %#p"</span>,
00039                 pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message, pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.hwnd,  pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam,
00040                 pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam,  pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o5">pti</a>);
00041     }
00042 }
00043 
00044 <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a12">CheckSysLock</a>(<span class="keywordtype">int</span> where, <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pq, <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiSysLock)
00045 {
00046     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00047     TAGMSG5(DBGTAG_SysPeek,
00048             <span class="stringliteral">"%d pti %#p sets ptiSL %#p to pq %#p ; old ptiSL %#p\n"</span>,
00049             where, ptiCurrent, ptiSysLock, pq, pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o1">ptiSysLock</a>);
00050 }
00051 <span class="preprocessor">#endif //DEBUGTAGS</span>
00052 <span class="preprocessor"></span>
00053 <span class="preprocessor">#if DBG</span>
00054 <span class="preprocessor"></span><a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> gfLogPlayback;
00055 
00056 LPCSTR aszMouse[] = {
00057     <span class="stringliteral">"WM_MOUSEMOVE"</span>,
00058     <span class="stringliteral">"WM_LBUTTONDOWN"</span>,
00059     <span class="stringliteral">"WM_LBUTTONUP"</span>,
00060     <span class="stringliteral">"WM_LBUTTONDBLCLK"</span>,
00061     <span class="stringliteral">"WM_RBUTTONDOWN"</span>,
00062     <span class="stringliteral">"WM_RBUTTONUP"</span>,
00063     <span class="stringliteral">"WM_RBUTTONDBLCLK"</span>,
00064     <span class="stringliteral">"WM_MBUTTONDOWN"</span>,
00065     <span class="stringliteral">"WM_MBUTTONUP"</span>,
00066     <span class="stringliteral">"WM_MBUTTONDBLCLK"</span>
00067     <span class="stringliteral">"WM_MOUSEWHEEL"</span>,
00068     <span class="stringliteral">"WM_XBUTTONDOWN"</span>,
00069     <span class="stringliteral">"WM_XBUTTONUP"</span>,
00070     <span class="stringliteral">"WM_XBUTTONDBLCLK"</span>,
00071 };
00072 LPCSTR aszKey[] = {
00073     <span class="stringliteral">"WM_KEYDOWN"</span>,
00074     <span class="stringliteral">"WM_KEYUP"</span>,
00075     <span class="stringliteral">"WM_CHAR"</span>,
00076     <span class="stringliteral">"WM_DEADCHAR"</span>,
00077     <span class="stringliteral">"WM_SYSKEYDOWN"</span>,
00078     <span class="stringliteral">"WM_SYSKEYUP"</span>,
00079     <span class="stringliteral">"WM_SYSCHAR"</span>,
00080     <span class="stringliteral">"WM_SYSDEADCHAR"</span>
00081 };
00082 <span class="preprocessor">#endif  // DBG</span>
00083 <span class="preprocessor"></span>
<a name="l00084"></a><a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a0">00084</a> <span class="preprocessor">#define CANCEL_ACTIVESTATE  0</span>
<a name="l00085"></a><a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a1">00085</a> <span class="preprocessor"></span><span class="preprocessor">#define CANCEL_FOCUSSTATE   1</span>
<a name="l00086"></a><a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a2">00086</a> <span class="preprocessor"></span><span class="preprocessor">#define CANCEL_CAPTURESTATE 2</span>
00087 <span class="preprocessor"></span>
<a name="l00088"></a><a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a3">00088</a> <span class="preprocessor">#define KEYSTATESIZE    (CBKEYSTATE + CBKEYSTATERECENTDOWN)</span>
00089 <span class="preprocessor"></span>
00090 
00091 <span class="comment">/*</span>
00092 <span class="comment"> * xxxGetNextSysMsg return values</span>
00093 <span class="comment"> */</span>
<a name="l00094"></a><a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a4">00094</a> <span class="preprocessor">#define PQMSG_PLAYBACK       ((PQMSG)1)</span>
00095 <span class="preprocessor"></span>
00096 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a18">xxxScanSysQueue</a>(<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent, LPMSG lpMsg, <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndFilter,
00097         UINT msgMinFilter, UINT msgMaxFilter, DWORD flags, DWORD fsReason);
00098 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d3/queue_8c.html#a61">xxxReadPostMessage</a>(<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti, LPMSG lpMsg, <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndFilter,
00099         UINT msgMin, UINT msgMax, BOOL fRemoveMsg);
00100 <span class="keywordtype">void</span> <a class="code" href="../../d6/d3/queue_8c.html#a53">CleanEventMessage</a>(<a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsg);
00101 
00102 <span class="comment">/***************************************************************************\</span>
00103 <span class="comment">* xxxWaitMessage (API)</span>
00104 <span class="comment">*</span>
00105 <span class="comment">* This API will block until an input message is received on</span>
00106 <span class="comment">* the current queue.</span>
00107 <span class="comment">*</span>
00108 <span class="comment">* History:</span>
00109 <span class="comment">* 10-25-90 DavidPe      Created.</span>
00110 <span class="comment">\***************************************************************************/</span>
00111 
<a name="l00112"></a><a class="code" href="../../d4/d1/userk_8h.html#a1634">00112</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1634">xxxWaitMessage</a>(VOID)
00113 {
00114     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1196">xxxSleepThread</a>(QS_ALLINPUT | QS_EVENT, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00115 }
00116 
00117 
00118 <span class="comment">/***************************************************************************\</span>
00119 <span class="comment">* CheckProcessBackground/Foreground</span>
00120 <span class="comment">*</span>
00121 <span class="comment">* This checks to see if the process is at the right priority. If CSPINS is</span>
00122 <span class="comment">* greater than CSPINBACKGROUND and the process isn't at the background</span>
00123 <span class="comment">* priority, put it there. If it is less than this and should be foreground</span>
00124 <span class="comment">* and isn't put it there.</span>
00125 <span class="comment">*</span>
00126 <span class="comment">* Need to put foreground spinning apps in the background (make it the same</span>
00127 <span class="comment">* priority as all other background apps) so that bad apps can still communicate</span>
00128 <span class="comment">* with apps in the background via dde, for example. There are other cases</span>
00129 <span class="comment">* where spinning foreground apps affect the server, the printer spooler, and</span>
00130 <span class="comment">* mstest scenarios. On Win3.1, calling PeekMessage() involves making a trip</span>
00131 <span class="comment">* through the scheduler, forcing other apps to run. Processes run with</span>
00132 <span class="comment">* priority on NT, where the foreground process gets foreground priority for</span>
00133 <span class="comment">* greater responsiveness.</span>
00134 <span class="comment">*</span>
00135 <span class="comment">* If an app calls peek/getmessage without idling, count how many times this</span>
00136 <span class="comment">* happens - if it happens CSPINBACKGROUND or more times, make the process</span>
00137 <span class="comment">* background. This handles most of the win3.1 app compatibility spinning</span>
00138 <span class="comment">* cases. If there is no priority contention, the app continues to run at</span>
00139 <span class="comment">* full speed (no performance scenarios should be adversely affected by this).</span>
00140 <span class="comment">*</span>
00141 <span class="comment">* This solves these cases:</span>
00142 <span class="comment">*</span>
00143 <span class="comment">* - high speed timer not allowing app to go idle</span>
00144 <span class="comment">* - post/peek loop (receiving a WM_ENTERIDLE, and posting a msg, for example)</span>
00145 <span class="comment">* - peek no remove loop (winword "idle" state, most dde loops, as examples)</span>
00146 <span class="comment">*</span>
00147 <span class="comment">* But doesn't protect against these sort of cases:</span>
00148 <span class="comment">*</span>
00149 <span class="comment">* - app calls getmessage, then goes into a tight loop</span>
00150 <span class="comment">* - non-gui threads in tight cpu loops</span>
00151 <span class="comment">*</span>
00152 <span class="comment">* 02-08-93 ScottLu      Created.</span>
00153 <span class="comment">\***************************************************************************/</span>
00154 
<a name="l00155"></a><a class="code" href="../../d6/d3/queue_8c.html#a18">00155</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d3/queue_8c.html#a18">CheckProcessForeground</a>(
00156     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti)
00157 {
00158     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiT;
00159 
00160     <span class="comment">/*</span>
00161 <span class="comment">     * Check to see if we need to move this process into foreground</span>
00162 <span class="comment">     * priority.</span>
00163 <span class="comment">     */</span>
00164     pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o1">cSpins</a> = 0;
00165     pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a804">TIF_SPINNING</a>;
00166     pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o4">dwTIFlags</a> = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a>;
00167 
00168     <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;W32PF_Flags &amp; W32PF_FORCEBACKGROUNDPRIORITY) {
00169         <span class="comment">/*</span>
00170 <span class="comment">         * See if any thread of this process is spinning. If none</span>
00171 <span class="comment">         * are, we can remove the force to background.</span>
00172 <span class="comment">         */</span>
00173         <span class="keywordflow">for</span> (ptiT = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o1">ptiList</a>; ptiT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; ptiT = ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o29">ptiSibling</a>) {
00174             <span class="keywordflow">if</span> (ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a804">TIF_SPINNING</a>)
00175                 <span class="keywordflow">return</span>;
00176         }
00177 
00178         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;W32PF_Flags &amp;= ~W32PF_FORCEBACKGROUNDPRIORITY;
00179         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a111">gppiWantForegroundPriority</a>) {
00180             <a class="code" href="../../d4/d1/userk_8h.html#a1334">SetForegroundPriority</a>(pti, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00181         }
00182     }
00183 }
00184 
00185 <span class="comment">/***************************************************************************\</span>
00186 <span class="comment">* xxxInternalGetMessage</span>
00187 <span class="comment">*</span>
00188 <span class="comment">* This routine is the worker for both xxxGetMessage() and xxxPeekMessage()</span>
00189 <span class="comment">* and is modelled after its win3.1 counterpart. From Win3.1:</span>
00190 <span class="comment">*</span>
00191 <span class="comment">* Get msg from the app queue or sys queue if there is one that matches</span>
00192 <span class="comment">* hwndFilter and matches msgMin/msgMax. If no messages in either queue, check</span>
00193 <span class="comment">* the QS_PAINT and QS_TIMER bits, call DoPaint or DoTimer to Post the</span>
00194 <span class="comment">* appropriate message to the application queue, and then Read that message.</span>
00195 <span class="comment">* Otherwise, if in GetMessage, Sleep until a wake bit is set indicating there</span>
00196 <span class="comment">* is something we need to do.  If in PeekMessage, return to caller. Before</span>
00197 <span class="comment">* reading messages from the queues, check to see if the QS_SENDMESSAGE bit</span>
00198 <span class="comment">* is set, and if so, call ReceiveMessage().</span>
00199 <span class="comment">*</span>
00200 <span class="comment">* New for NT5: HIWORD(flags) contains a wake mask provided by the caller.</span>
00201 <span class="comment">*   This mask is passed to CalcWakeMask to be combined with the mask generated</span>
00202 <span class="comment">*   from msgMin and MsgMax. The default mask includes QS_SENDMESSAGE</span>
00203 <span class="comment">*   now; we won't call xxxReceiveMessages (directly) unless this bit is set;</span>
00204 <span class="comment">*   however, to avoid potentail deadlocks and maintain NT4 compatibility as</span>
00205 <span class="comment">*   much as possible, we fail the call if QS_SENDMESSAGE is set in fsWakeBits</span>
00206 <span class="comment">*   but not requested by the caller. The same applies to QS_EVENT which we would</span>
00207 <span class="comment">*   always process in NT4.</span>
00208 <span class="comment">*</span>
00209 <span class="comment">*</span>
00210 <span class="comment">* 10-19-92 ScottLu      Created.</span>
00211 <span class="comment">\***************************************************************************/</span>
00212 
<a name="l00213"></a><a class="code" href="../../d4/d1/userk_8h.html#a1638">00213</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1638">xxxInternalGetMessage</a>(
00214     LPMSG lpMsg,
00215     HWND hwndFilter,
00216     UINT msgMin,
00217     UINT msgMax,
00218     UINT flags,
00219     BOOL fGetMessage)
00220 {
00221     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> fsWakeBits;
00222     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> fsWakeMask;
00223     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> fsRemoveBits;
00224     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
00225     PW32PROCESS W32Process;
00226     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndFilter;
00227     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fLockPwndFilter;
00228     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndFilter;
00229     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRemove;
00230     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fExit;
00231     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pq;
00232 <span class="preprocessor">#ifdef MARKPATH</span>
00233 <span class="preprocessor"></span>    <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> pathTaken = 0;
00234 
00235 <span class="preprocessor">#define PATHTAKEN(x)  pathTaken  |= x</span>
00236 <span class="preprocessor"></span><span class="preprocessor">#define DUMPPATHTAKEN() if (gfMarkPath) DbgPrint("xxxInternalGetMessage path:%08x\n", pathTaken)</span>
00237 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00238 <span class="preprocessor"></span><span class="preprocessor">#define PATHTAKEN(x)</span>
00239 <span class="preprocessor"></span><span class="preprocessor">#define DUMPPATHTAKEN()</span>
00240 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00241 <span class="preprocessor"></span>
00242     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00243     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
00244 
00245     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00246 
00247     <span class="comment">/*</span>
00248 <span class="comment">     * PeekMessage accepts NULL, 0x0000FFFF, and -1 as valid HWNDs.</span>
00249 <span class="comment">     * If hwndFilter is invalid we can't just return FALSE because that will</span>
00250 <span class="comment">     * hose existing badly behaved apps who might attempt to dispatch</span>
00251 <span class="comment">     * the random contents of pmsg.</span>
00252 <span class="comment">     */</span>
00253     <span class="keywordflow">if</span> ((hwndFilter == (HWND)-1) || (hwndFilter == (HWND)0x0000FFFF)) {
00254         hwndFilter = (HWND)1;
00255     }
00256 
00257     <span class="keywordflow">if</span> ((hwndFilter != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (hwndFilter != (HWND)1)) {
00258         <span class="keywordflow">if</span> ((pwndFilter = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwndFilter)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00259             lpMsg-&gt;hwnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00260             lpMsg-&gt;message = WM_NULL;
00261             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(1);
00262             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a6">DUMPPATHTAKEN</a>();
00263             <span class="keywordflow">if</span> (fGetMessage)
00264                 <span class="keywordflow">return</span> -1;
00265             <span class="keywordflow">else</span>
00266                 <span class="keywordflow">return</span> 0;
00267         }
00268 
00269         <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwndFilter, &amp;tlpwndFilter);
00270         fLockPwndFilter = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00271 
00272     } <span class="keywordflow">else</span> {
00273         pwndFilter = (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)hwndFilter;
00274         fLockPwndFilter = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00275     }
00276 
00277     <span class="comment">/*</span>
00278 <span class="comment">     * Add one to our spin count. At this end of this routine we'll check</span>
00279 <span class="comment">     * to see if the spin count gets &gt;= CSPINBACKGROUND. If so we'll put this</span>
00280 <span class="comment">     * process into the background.</span>
00281 <span class="comment">     */</span>
00282     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o1">cSpins</a>++;
00283 
00284     <span class="comment">/*</span>
00285 <span class="comment">     * Check to see if the startglass is on, and if so turn it off and update.</span>
00286 <span class="comment">     */</span>
00287     W32Process = W32GetCurrentProcess();
00288     <span class="keywordflow">if</span> (W32Process-&gt;W32PF_Flags &amp; W32PF_STARTGLASS) {
00289 
00290         <span class="comment">/*</span>
00291 <span class="comment">         * This app is no longer in "starting" mode. Recalc when to hide</span>
00292 <span class="comment">         * the app starting cursor.</span>
00293 <span class="comment">         */</span>
00294         W32Process-&gt;W32PF_Flags &amp;= ~W32PF_STARTGLASS;
00295         <span class="comment">/*</span>
00296 <span class="comment">         * Don't need DeferWinEventNotify() - xxxDoSysExpunge below doesn't</span>
00297 <span class="comment">         */</span>
00298         <a class="code" href="../../d4/d1/userk_8h.html#a1490">zzzCalcStartCursorHide</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
00299     }
00300 
00301     <span class="comment">/*</span>
00302 <span class="comment">     * Next check to see if any .dlls need freeing in</span>
00303 <span class="comment">     * the context of this client (used for windows hooks).</span>
00304 <span class="comment">     */</span>
00305     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o11">cSysExpunge</a> != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a153">gcSysExpunge</a>) {
00306         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o11">cSysExpunge</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a153">gcSysExpunge</a>;
00307         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o12">dwhmodLibLoadedMask</a> &amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a152">gdwSysExpungeMask</a>)
00308             <a class="code" href="../../d4/d1/userk_8h.html#a1545">xxxDoSysExpunge</a>(ptiCurrent);
00309     }
00310 
00311     <span class="comment">/*</span>
00312 <span class="comment">     * Set up BOOL fRemove local variable from for ReadMessage()</span>
00313 <span class="comment">     */</span>
00314     fRemove = flags &amp; PM_REMOVE;
00315 
00316     <span class="comment">/*</span>
00317 <span class="comment">     * Unlock the system queue if it's owned by us.</span>
00318 <span class="comment">     */</span>
00319     <span class="comment">/*</span>
00320 <span class="comment">     * If we're currently processing a message, unlock the input queue</span>
00321 <span class="comment">     * because the sender, who is blocked, might be the owner, and in order</span>
00322 <span class="comment">     * to reply, the receiver may need to read keyboard / mouse input.</span>
00323 <span class="comment">     */</span>
00324     <span class="comment">/*</span>
00325 <span class="comment">     * If this thread has the input queue locked and the last message removed</span>
00326 <span class="comment">     * is the last message we looked at, then unlock - we're ready for anyone</span>
00327 <span class="comment">     * to get the next message.</span>
00328 <span class="comment">     */</span>
00329     pq = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>;
00330     <span class="keywordflow">if</span> (   (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o12">psmsCurrent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00331         || (pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o1">ptiSysLock</a> == ptiCurrent &amp;&amp; pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o2">idSysLock</a> == ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o15">idLast</a>)
00332        ) {
00333         <a class="code" href="../../d4/d1/userk_8h.html#a12">CheckSysLock</a>(1, pq, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00334         pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o1">ptiSysLock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00335         <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(2);
00336     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o1">ptiSysLock</a>
00337                 &amp;&amp; (pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o1">ptiSysLock</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o50">cVisWindows</a> == 0)
00338                 &amp;&amp; (<a class="code" href="../../d4/d1/userk_8h.html#a1519">PhkFirstGlobalValid</a>(ptiCurrent, WH_JOURNALPLAYBACK) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00339         <span class="comment">/*</span>
00340 <span class="comment">         * If the thread that has the system queue lock has no windows visible</span>
00341 <span class="comment">         * (can happen if it just hid its last window), don't expect it to call</span>
00342 <span class="comment">         * GetMessage() again! - unlock the system queue. --- ScottLu</span>
00343 <span class="comment">         * This condition creates a hole by which a second thread attached to</span>
00344 <span class="comment">         * the same queue as thread 1 can alter pq-&gt;idSysPeek during a callback</span>
00345 <span class="comment">         * made by thread 1 so that thread 1 will delete the wrong message</span>
00346 <span class="comment">         * (losing keystrokes - causing Shift to appear be stuck down editing a</span>
00347 <span class="comment">         * Graph5 caption embedded in Word32 document #5032.  However, MSTEST</span>
00348 <span class="comment">         * requires this hole, so allow it if Journal Playback is occurring</span>
00349 <span class="comment">         * #8850 (yes, a hack)  Chicago also has this behavior.  --- IanJa</span>
00350 <span class="comment">         */</span>
00351         <a class="code" href="../../d4/d1/userk_8h.html#a12">CheckSysLock</a>(2, pq, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00352         pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o1">ptiSysLock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00353         <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(3);
00354     }
00355     <span class="keywordflow">if</span> (pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o1">ptiSysLock</a> != ptiCurrent) {
00356         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o0">CTIF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a822">CTIF_SYSQUEUELOCKED</a>;
00357     }
00358 
00359     <span class="comment">/*</span>
00360 <span class="comment">     * If msgMax == 0 then msgMax = -1: that makes our range checking only</span>
00361 <span class="comment">     * have to deal with msgMin &lt; msgMax.</span>
00362 <span class="comment">     */</span>
00363     <span class="keywordflow">if</span> (msgMax == 0)
00364         msgMax--;
00365 
00366     <span class="comment">/*</span>
00367 <span class="comment">     * Compute the QS* mask that corresponds to the message range</span>
00368 <span class="comment">     *  and the wake mask filter (HIWORD(flags))</span>
00369 <span class="comment">     */</span>
00370     fsWakeMask = <a class="code" href="../../d7/d3/ntuser_2rtl_2input_8c.html#a1">CalcWakeMask</a>(msgMin, msgMax, HIWORD(flags));
00371     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o44">fsChangeBitsRemoved</a> = 0;
00372 
00373     <span class="comment">/*</span>
00374 <span class="comment">     * If we can yield and one or more events were skipped,</span>
00375 <span class="comment">     * set the wakebits for event</span>
00376 <span class="comment">     */</span>
00377     <span class="keywordflow">if</span> (!(flags &amp; PM_NOYIELD) &amp;&amp; ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a813">TIF_DELAYEDEVENT</a>) {
00378         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a> |= QS_EVENT;
00379         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o1">fsChangeBits</a> |= QS_EVENT;
00380         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a813">TIF_DELAYEDEVENT</a>;
00381         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o4">dwTIFlags</a> = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a>;
00382     }
00383 
00384     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00385 
00386         <span class="comment">/*</span>
00387 <span class="comment">         * Restore any wake bits saved while journalling</span>
00388 <span class="comment">         */</span>
00389         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a> |= ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o3">fsWakeBitsJournal</a>;
00390 
00391         <span class="comment">/*</span>
00392 <span class="comment">         * If we need to recalc queue attachments, do it here. Do it on the</span>
00393 <span class="comment">         * right desktop or else the queues will get created in the wrong</span>
00394 <span class="comment">         * heap.</span>
00395 <span class="comment">         */</span>
00396         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a107">gpdeskRecalcQueueAttach</a>) {
00397             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a107">gpdeskRecalcQueueAttach</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00398 
00399             <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; !<a class="code" href="../../d4/d1/userk_8h.html#a418">FJOURNALRECORD</a>() &amp;&amp; !<a class="code" href="../../d4/d1/userk_8h.html#a419">FJOURNALPLAYBACK</a>()) {
00400                 <span class="comment">/*</span>
00401 <span class="comment">                 * No need to DeferWinEventNotify(): a call to</span>
00402 <span class="comment">                 * xxxReceiveMessages is made just below</span>
00403 <span class="comment">                 */</span>
00404                 <a class="code" href="../../d4/d1/userk_8h.html#a1203">zzzReattachThreads</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00405                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(4);
00406             }
00407         }
00408 
00409         <span class="comment">/*</span>
00410 <span class="comment">         * Remember what change bits we're clearing. This is important to</span>
00411 <span class="comment">         * fix a bug in the input model: If an app receives a sent message</span>
00412 <span class="comment">         * from within SleepThread(), then does PostMessage() (which sets</span>
00413 <span class="comment">         * QS_POSTMESSAGE), then does a PeekMessage(...) for some different</span>
00414 <span class="comment">         * posted message (clears QS_POSTMESSAGE in fsChangeBits), then returns</span>
00415 <span class="comment">         * back into SleepThread(), it won't wake up to retrieve that newly</span>
00416 <span class="comment">         * posted message because the change bits are cleared.</span>
00417 <span class="comment">         *</span>
00418 <span class="comment">         * What we do is remember the change bits that are being cleared.</span>
00419 <span class="comment">         * Then, when we return to SleepThread(), we put these remembered</span>
00420 <span class="comment">         * bits back into the change bits that also have corresponding</span>
00421 <span class="comment">         * bits in the wakebits (so we don't set changebits that represent</span>
00422 <span class="comment">         * input that isn't there anymore). This way, the app will retrieve</span>
00423 <span class="comment">         * the newly posted message refered to earlier.</span>
00424 <span class="comment">         * - scottlu</span>
00425 <span class="comment">         *</span>
00426 <span class="comment">         * New for NT5: Since QS_SENDMESSAGE was never set it fsWakeMask before (NT4),</span>
00427 <span class="comment">         *  it was never cleared from fsChangeBits. For compatibility, we won't clear</span>
00428 <span class="comment">         *  it now even if specified in fsWakeMask; hence we won't affect any one</span>
00429 <span class="comment">         *  checking for QS_SENDMESSAGE in pcti-&gt;fsChangeBits.</span>
00430 <span class="comment">         */</span>
00431         fsRemoveBits = fsWakeMask &amp; ~QS_SENDMESSAGE;
00432         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o44">fsChangeBitsRemoved</a> |= ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o1">fsChangeBits</a> &amp; fsRemoveBits;
00433 
00434         <span class="comment">/*</span>
00435 <span class="comment">         * Clear the change bits that we're looking at, in order to detect</span>
00436 <span class="comment">         * incoming events that may occur the last time we checked the wake</span>
00437 <span class="comment">         * bits.</span>
00438 <span class="comment">         */</span>
00439         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o1">fsChangeBits</a> &amp;= ~fsRemoveBits;
00440 
00441         <span class="comment">/*</span>
00442 <span class="comment">         * Check for sent messages. Check the the actual wake bits (i.e, from pcti)</span>
00443 <span class="comment">         *  so we know for real.</span>
00444 <span class="comment">         */</span>
00445         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a> &amp; fsWakeMask &amp; QS_SENDMESSAGE) {
00446             <a class="code" href="../../d4/d1/userk_8h.html#a502">xxxReceiveMessages</a>(ptiCurrent);
00447         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a> &amp; QS_SENDMESSAGE) {
00448             RIPMSG2(RIP_WARNING, <span class="stringliteral">"xxxInternalGetMessage:(1st test) sendmsgs pending. Bits:%#lx Mask:%#lx"</span>,
00449                         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a>, fsWakeMask);
00450             <span class="keywordflow">goto</span> NoMessages;
00451         }
00452 
00453         <span class="comment">/*</span>
00454 <span class="comment">         * Check to see if we have any input we want.</span>
00455 <span class="comment">         */</span>
00456         <span class="keywordflow">if</span> ((ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a> &amp; fsWakeMask) == 0) {
00457             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(8);
00458             <span class="keywordflow">goto</span> NoMessages;
00459         }
00460         fsWakeBits = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a>;
00461 
00462         <span class="comment">/*</span>
00463 <span class="comment">         * If the queue lock is != NULL (ptiSysLock) and it is this thread that</span>
00464 <span class="comment">         * locked it, then go get the message from the system queue. This is</span>
00465 <span class="comment">         * to prevent messages posted after a PeekMessage/no-remove from being</span>
00466 <span class="comment">         * seen before the original message from the system queue. (Aldus</span>
00467 <span class="comment">         * Pagemaker requires this) (bobgu 8/5/87).</span>
00468 <span class="comment">         */</span>
00469         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o1">ptiSysLock</a> == ptiCurrent &amp;&amp;
00470                 (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a865">QF_LOCKNOREMOVE</a>)) {
00471             <span class="comment">/*</span>
00472 <span class="comment">             * Does the caller want mouse / keyboard?</span>
00473 <span class="comment">             */</span>
00474             <span class="keywordflow">if</span> (fsWakeBits &amp; fsWakeMask &amp; (QS_INPUT | QS_EVENT)) {
00475 
00476                 <span class="comment">/*</span>
00477 <span class="comment">                 * It should never get here during exit.</span>
00478 <span class="comment">                 */</span>
00479                 UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a340">gbExitInProgress</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00480 
00481                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a18">xxxScanSysQueue</a>(ptiCurrent, lpMsg, pwndFilter,
00482                         msgMin, msgMax, flags,
00483                         fsWakeBits &amp; fsWakeMask &amp; (QS_INPUT | QS_EVENT))) {
00484 
00485                     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x10);
00486                     <span class="keywordflow">break</span>;
00487                 }
00488             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fsWakeBits &amp; QS_EVENT) {
00489                 RIPMSG2(RIP_WARNING,
00490                     <span class="stringliteral">"xxxInternalGetMessage:(1st test)events pending. Bits:%#lx Mask:%#lx"</span>,
00491                     fsWakeBits, fsWakeMask);
00492                 <span class="keywordflow">goto</span> NoMessages;
00493             }
00494         }
00495 
00496         <span class="comment">/*</span>
00497 <span class="comment">         * See if there's a message in the application queue.</span>
00498 <span class="comment">         */</span>
00499         <span class="keywordflow">if</span> (fsWakeBits &amp; fsWakeMask &amp; QS_POSTMESSAGE) {
00500             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/queue_8c.html#a61">xxxReadPostMessage</a>(ptiCurrent, lpMsg, pwndFilter,
00501                     msgMin, msgMax, fRemove)) {
00502                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x20);
00503                 <span class="keywordflow">break</span>;
00504             }
00505         }
00506 
00507         <span class="comment">/*</span>
00508 <span class="comment">         * Time to scan the raw input queue for input. First check to see</span>
00509 <span class="comment">         * if the caller wants mouse / keyboard input.</span>
00510 <span class="comment">         */</span>
00511         <span class="keywordflow">if</span> (fsWakeBits &amp; fsWakeMask &amp; (QS_INPUT | QS_EVENT)) {
00512 
00513             <span class="comment">/*</span>
00514 <span class="comment">             * It should never get here during exit.</span>
00515 <span class="comment">             */</span>
00516             UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a340">gbExitInProgress</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00517 
00518             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a18">xxxScanSysQueue</a>(ptiCurrent, lpMsg, pwndFilter,
00519                     msgMin, msgMax, flags,
00520                     fsWakeBits &amp; fsWakeMask &amp; (QS_INPUT | QS_EVENT))) {
00521                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x40);
00522                 <span class="keywordflow">break</span>;
00523             }
00524         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fsWakeBits &amp; QS_EVENT) {
00525             RIPMSG2(RIP_WARNING, <span class="stringliteral">"xxxInternalGetMessage:(2nd test)events pending. Bits:%#lx Mask:%#lx"</span>,
00526                         fsWakeBits, fsWakeMask);
00527             <span class="keywordflow">goto</span> NoMessages;
00528         }
00529 
00530         <span class="comment">/*</span>
00531 <span class="comment">         * Check for sent messages. Check the the actual wake bits (i.e, from pcti)</span>
00532 <span class="comment">         *  so we know for real.</span>
00533 <span class="comment">         */</span>
00534         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a> &amp; fsWakeMask &amp; QS_SENDMESSAGE) {
00535             <a class="code" href="../../d4/d1/userk_8h.html#a502">xxxReceiveMessages</a>(ptiCurrent);
00536         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a> &amp; QS_SENDMESSAGE) {
00537             RIPMSG2(RIP_WARNING, <span class="stringliteral">"xxxInternalGetMessage:(2nd test)sendmsgs pending. Bits:%#lx Mask:%#lx"</span>,
00538                         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a>, fsWakeMask);
00539             <span class="keywordflow">goto</span> NoMessages;
00540         }
00541 
00542         <span class="comment">/*</span>
00543 <span class="comment">         * Get new input bits.</span>
00544 <span class="comment">         */</span>
00545         <span class="keywordflow">if</span> ((ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a> &amp; fsWakeMask) == 0) {
00546             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x80);
00547             <span class="keywordflow">goto</span> NoMessages;
00548         }
00549         fsWakeBits = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a>;
00550 
00551         <span class="comment">/*</span>
00552 <span class="comment">         * Does the caller want paint messages? If so, try to find a paint.</span>
00553 <span class="comment">         */</span>
00554         <span class="keywordflow">if</span> (fsWakeBits &amp; fsWakeMask &amp; QS_PAINT) {
00555             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1218">DoPaint</a>(pwndFilter, lpMsg)) {
00556                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x100);
00557                 <span class="keywordflow">break</span>;
00558             }
00559         }
00560 
00561         <span class="comment">/*</span>
00562 <span class="comment">         * We must yield for 16 bit apps before checking timers or an app</span>
00563 <span class="comment">         * that has a fast timer could chew up all the time and never let</span>
00564 <span class="comment">         * anyone else run.</span>
00565 <span class="comment">         *</span>
00566 <span class="comment">         * NOTE: This could cause PeekMessage() to yield TWICE, if the user</span>
00567 <span class="comment">         * is filtering with a window handle. If the DoTimer() call fails</span>
00568 <span class="comment">         * then we end up yielding again.</span>
00569 <span class="comment">         */</span>
00570         <span class="keywordflow">if</span> (!(flags &amp; PM_NOYIELD)) {
00571             <span class="comment">/*</span>
00572 <span class="comment">             * This is the point where windows would yield.  Here we wait to wake</span>
00573 <span class="comment">             * up any threads waiting for this thread to hit "idle state".</span>
00574 <span class="comment">             */</span>
00575             <a class="code" href="../../d4/d1/userk_8h.html#a1636">zzzWakeInputIdle</a>(ptiCurrent);
00576 
00577             <span class="comment">/*</span>
00578 <span class="comment">             * Yield and receive pending messages.</span>
00579 <span class="comment">             */</span>
00580             <a class="code" href="../../d4/d1/userk_8h.html#a1557">xxxUserYield</a>(ptiCurrent);
00581 
00582             <span class="comment">/*</span>
00583 <span class="comment">             * Check new input buts and receive pending messages.</span>
00584 <span class="comment">             */</span>
00585             <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a> &amp; fsWakeMask &amp; QS_SENDMESSAGE) {
00586                 <a class="code" href="../../d4/d1/userk_8h.html#a502">xxxReceiveMessages</a>(ptiCurrent);
00587             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a> &amp; QS_SENDMESSAGE) {
00588                 RIPMSG2(RIP_WARNING, <span class="stringliteral">"xxxInternalGetMessage:(3rd test) sendmsgs pending. Bits:%#lx Mask:%#lx"</span>,
00589                             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a>, fsWakeMask);
00590                 <span class="keywordflow">goto</span> NoMessages;
00591             }
00592 
00593             <span class="keywordflow">if</span> ((ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a> &amp; fsWakeMask) == 0) {
00594 
00595                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x200);
00596                 <span class="keywordflow">goto</span> NoMessages;
00597             }
00598             fsWakeBits = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a>;
00599         }
00600 
00601         <span class="comment">/*</span>
00602 <span class="comment">         * Does the app want timer messages, and if there one pending?</span>
00603 <span class="comment">         */</span>
00604         <span class="keywordflow">if</span> (fsWakeBits &amp; fsWakeMask &amp; QS_TIMER) {
00605             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1219">DoTimer</a>(pwndFilter)) {
00606                 <span class="comment">/*</span>
00607 <span class="comment">                 * DoTimer() posted the message into the app's queue,</span>
00608 <span class="comment">                 * so start over and we'll grab it from there.</span>
00609 <span class="comment">                 */</span>
00610                  <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x400);
00611                  <span class="keywordflow">continue</span>;
00612             }
00613         }
00614 
00615 NoMessages:
00616         <span class="comment">/*</span>
00617 <span class="comment">         * Looks like we have no input. If we're being called from GetMessage()</span>
00618 <span class="comment">         * then go to sleep until we find something.</span>
00619 <span class="comment">         */</span>
00620         <span class="keywordflow">if</span> (!fGetMessage) {
00621             <span class="comment">/*</span>
00622 <span class="comment">             * This is one last check for pending sent messages. It also</span>
00623 <span class="comment">             * yields. Win3.1 does this.</span>
00624 <span class="comment">             */</span>
00625             <span class="keywordflow">if</span> (!(flags &amp; PM_NOYIELD)) {
00626                 <span class="comment">/*</span>
00627 <span class="comment">                 * This is the point where windows yields. Here we wait to wake</span>
00628 <span class="comment">                 * up any threads waiting for this thread to hit "idle state".</span>
00629 <span class="comment">                 */</span>
00630                 <a class="code" href="../../d4/d1/userk_8h.html#a1636">zzzWakeInputIdle</a>(ptiCurrent);
00631 
00632                 <span class="comment">/*</span>
00633 <span class="comment">                 * Yield and receive pending messages.</span>
00634 <span class="comment">                 */</span>
00635                 <a class="code" href="../../d4/d1/userk_8h.html#a1557">xxxUserYield</a>(ptiCurrent);
00636             }
00637             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x800);
00638             <span class="keywordflow">goto</span> FalseExit;
00639         }
00640 
00641         <span class="comment">/*</span>
00642 <span class="comment">         * This is a getmessage not a peekmessage, so sleep. When we sleep,</span>
00643 <span class="comment">         * zzzWakeInputIdle() is called to wake up any apps waiting on this</span>
00644 <span class="comment">         * app to go idle.</span>
00645 <span class="comment">         */</span>
00646         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1196">xxxSleepThread</a>(fsWakeMask, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))
00647             <span class="keywordflow">goto</span> FalseExit;
00648     } <span class="comment">/* while (TRUE) */</span>
00649 
00650     <span class="comment">/*</span>
00651 <span class="comment">     * If we're here then we have input for this queue. Call the</span>
00652 <span class="comment">     * GetMessage() hook with this input.</span>
00653 <span class="comment">     */</span>
00654     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(ptiCurrent, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a515">WHF_GETMESSAGE</a>))
00655         <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HC_ACTION, flags, (LPARAM)lpMsg, WH_GETMESSAGE);
00656 
00657     <span class="comment">/*</span>
00658 <span class="comment">     * If called from PeekMessage(), return TRUE.</span>
00659 <span class="comment">     */</span>
00660     <span class="keywordflow">if</span> (!fGetMessage) {
00661         <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x1000);
00662         <span class="keywordflow">goto</span> TrueExit;
00663     }
00664 
00665     <span class="comment">/*</span>
00666 <span class="comment">     * Being called from GetMessage(): return FALSE if the message is WM_QUIT,</span>
00667 <span class="comment">     * TRUE otherwise.</span>
00668 <span class="comment">     */</span>
00669     <span class="keywordflow">if</span> (lpMsg-&gt;message == WM_QUIT) {
00670         <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x2000);
00671         <span class="keywordflow">goto</span> FalseExit;
00672     }
00673 
00674     <span class="comment">/*</span>
00675 <span class="comment">     * Fall through to TrueExit...</span>
00676 <span class="comment">     */</span>
00677 
00678 TrueExit:
00679     <span class="comment">/*</span>
00680 <span class="comment">     * Update timeLastRead. We use this for hung app calculations.</span>
00681 <span class="comment">     */</span>
00682     <a class="code" href="../../d4/d1/userk_8h.html#a257">SET_TIME_LAST_READ</a>(ptiCurrent);
00683     fExit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00684     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x4000);
00685     <span class="keywordflow">goto</span> Exit;
00686 
00687 FalseExit:
00688     fExit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00689 
00690 Exit:
00691     <span class="keywordflow">if</span> (fLockPwndFilter)
00692         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndFilter);
00693 
00694     <span class="comment">/*</span>
00695 <span class="comment">     * see CheckProcessBackground() comment above</span>
00696 <span class="comment">     * Check to see if we need to move this process into background</span>
00697 <span class="comment">     * priority.</span>
00698 <span class="comment">     */</span>
00699     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o1">cSpins</a> &gt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a767">CSPINBACKGROUND</a>) {
00700 
00701         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o1">cSpins</a> = 0;
00702 
00703         <span class="keywordflow">if</span> (!(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a804">TIF_SPINNING</a>)) {
00704 
00705             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a804">TIF_SPINNING</a>;
00706             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o4">dwTIFlags</a> = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a>;
00707 
00708             <span class="keywordflow">if</span> (!(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;W32PF_Flags &amp; W32PF_FORCEBACKGROUNDPRIORITY)) {
00709 
00710                 ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;W32PF_Flags |= W32PF_FORCEBACKGROUNDPRIORITY;
00711 
00712                 <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a111">gppiWantForegroundPriority</a>) {
00713                     <a class="code" href="../../d4/d1/userk_8h.html#a1334">SetForegroundPriority</a>(ptiCurrent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00714                 }
00715             }
00716         }
00717 
00718         <span class="comment">/*</span>
00719 <span class="comment">         * For spinning Message loops, we need to take the 16bit-thread out</span>
00720 <span class="comment">         * of the scheduler temporarily so that other processes can get a chance</span>
00721 <span class="comment">         * to run.  This is appearent in OLE operations where a 16bit foreground</span>
00722 <span class="comment">         * thread starts an OLE activation on a 32bit process.  The 32bit process</span>
00723 <span class="comment">         * gets starved of CPU while the 16bit thread spins.</span>
00724 <span class="comment">         */</span>
00725         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) {
00726 
00727             <span class="comment">/*</span>
00728 <span class="comment">             * Take the 16bit thread out of the scheduler.  This wakes any</span>
00729 <span class="comment">             * other 16bit thread needing time, and takes the current thread</span>
00730 <span class="comment">             * out.  We will do a brief sleep so that apps can respond in time.</span>
00731 <span class="comment">             * When done, we will reschedule the thread.  The zzzWakeInputIdle()</span>
00732 <span class="comment">             * should have been called in the no-messages section, so we have</span>
00733 <span class="comment">             * already set the Idle-Event.</span>
00734 <span class="comment">             */</span>
00735             <a class="code" href="../../d4/d1/userk_8h.html#a1556">xxxSleepTask</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a17">HEVENT_REMOVEME</a>);
00736 
00737             <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00738             ZwYieldExecution();
00739             <a class="code" href="../../d4/d1/userk_8h.html#a21">CheckForClientDeath</a>();
00740             <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00741 
00742             <a class="code" href="../../d4/d1/userk_8h.html#a1558">xxxDirectedYield</a>(DY_OLDYIELD);
00743         }
00744     }
00745 
00746     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x8000);
00747     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a6">DUMPPATHTAKEN</a>();
00748     <span class="keywordflow">return</span> fExit;
00749 }
00750 <span class="preprocessor">#undef PATHTAKEN</span>
00751 <span class="preprocessor"></span><span class="preprocessor">#undef DUMPPATHTAKEN</span>
00752 <span class="preprocessor"></span>
00753 <span class="comment">/***************************************************************************\</span>
00754 <span class="comment">* xxxDispatchMessage (API)</span>
00755 <span class="comment">*</span>
00756 <span class="comment">* Calls the appropriate window procedure or function with pmsg.</span>
00757 <span class="comment">*</span>
00758 <span class="comment">* History:</span>
00759 <span class="comment">* 10-25-90 DavidPe      Created.</span>
00760 <span class="comment">\***************************************************************************/</span>
00761 
<a name="l00762"></a><a class="code" href="../../d4/d1/userk_8h.html#a1640">00762</a> LRESULT <a class="code" href="../../d4/d1/userk_8h.html#a1640">xxxDispatchMessage</a>(
00763     LPMSG pmsg)
00764 {
00765     LRESULT lRet;
00766     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00767     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a988">WNDPROC_PWND</a> lpfnWndProc;
00768     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
00769 
00770     pwnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00771     <span class="keywordflow">if</span> (pmsg-&gt;hwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00772         <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(pmsg-&gt;hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00773             <span class="keywordflow">return</span> 0;
00774     }
00775 
00776     <span class="comment">/*</span>
00777 <span class="comment">     * If this is a synchronous-only message (takes a pointer in wParam or</span>
00778 <span class="comment">     * lParam), then don't allow this message to go through since those</span>
00779 <span class="comment">     * parameters have not been thunked, and are pointing into outer-space</span>
00780 <span class="comment">     * (which would case exceptions to occur).</span>
00781 <span class="comment">     *</span>
00782 <span class="comment">     * (This api is only called in the context of a message loop, and you</span>
00783 <span class="comment">     * don't get synchronous-only messages in a message loop).</span>
00784 <span class="comment">     */</span>
00785     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a918">TESTSYNCONLYMESSAGE</a>(pmsg-&gt;message, pmsg-&gt;wParam)) {
00786         <span class="comment">/*</span>
00787 <span class="comment">         * Fail if 32 bit app is calling.</span>
00788 <span class="comment">         */</span>
00789         <span class="keywordflow">if</span> (!(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;TIF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>)) {
00790             RIPERR1(ERROR_MESSAGE_SYNC_ONLY, RIP_WARNING, <span class="stringliteral">"xxxDispatchMessage: Sync only message 0x%lX"</span>,
00791                     pmsg-&gt;message);
00792             <span class="keywordflow">return</span> 0;
00793         }
00794 
00795         <span class="comment">/*</span>
00796 <span class="comment">         * For wow apps, allow it to go through (for compatibility). Change</span>
00797 <span class="comment">         * the message id so our code doesn't understand the message - wow</span>
00798 <span class="comment">         * will get the message and strip out this bit before dispatching</span>
00799 <span class="comment">         * the message to the application.</span>
00800 <span class="comment">         */</span>
00801         pmsg-&gt;message |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a544">MSGFLAG_WOW_RESERVED</a>;
00802     }
00803 
00804     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwnd, &amp;tlpwnd);
00805 
00806     <span class="comment">/*</span>
00807 <span class="comment">     * Is this a timer?  If there's a proc address, call it,</span>
00808 <span class="comment">     * otherwise send it to the wndproc.</span>
00809 <span class="comment">     */</span>
00810     <span class="keywordflow">if</span> ((pmsg-&gt;message == WM_TIMER) || (pmsg-&gt;message == <a class="code" href="../../d1/d1/bench_8c.html#a4">WM_SYSTIMER</a>)) {
00811         <span class="keywordflow">if</span> (pmsg-&gt;lParam != 0) {
00812 
00813             <span class="comment">/*</span>
00814 <span class="comment">             * System timers must be executed on the server's context.</span>
00815 <span class="comment">             */</span>
00816             <span class="keywordflow">if</span> (pmsg-&gt;message == <a class="code" href="../../d1/d1/bench_8c.html#a4">WM_SYSTIMER</a>) {
00817 
00818                 <span class="comment">/*</span>
00819 <span class="comment">                 * Verify that it's a valid timer proc. If so,</span>
00820 <span class="comment">                 * don't leave the critsect to call server-side procs</span>
00821 <span class="comment">                 * and pass a PWND, not HWND.</span>
00822 <span class="comment">                 */</span>
00823                 <a class="code" href="../../d4/d8/structtagTIMER.html">PTIMER</a> ptmr;
00824                 lRet = 0;
00825                 <span class="keywordflow">for</span> (ptmr = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a247">gptmrFirst</a>; ptmr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; ptmr = ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o1">ptmrNext</a>) {
00826                     <span class="keywordflow">if</span> ((pmsg-&gt;lParam == (LPARAM)ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o9">pfn</a>) &amp;&amp; (ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o8">flags</a> &amp; TMRF_SYSTEM)) {
00827                         ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o9">pfn</a>(pwnd, <a class="code" href="../../d1/d1/bench_8c.html#a4">WM_SYSTIMER</a>, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)pmsg-&gt;wParam,
00828                                   <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>());
00829                         <span class="keywordflow">break</span>;
00830                     }
00831                 }
00832                 <span class="keywordflow">goto</span> Exit;
00833             } <span class="keywordflow">else</span> {
00834                 <span class="comment">/*</span>
00835 <span class="comment">                 * WM_TIMER is the same for Unicode/ANSI.</span>
00836 <span class="comment">                 */</span>
00837                 <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00838 
00839                 <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a797">TIF_SYSTEMTHREAD</a>) {
00840                     lRet = 0;
00841                     <span class="keywordflow">goto</span> Exit;
00842                 }
00843 
00844                 lRet = <a class="code" href="../../d4/d1/userk_8h.html#a242">CallClientProcA</a>(pwnd, WM_TIMER,
00845                        pmsg-&gt;wParam, <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>(), pmsg-&gt;lParam);
00846 
00847                 <span class="keywordflow">goto</span> Exit;
00848             }
00849         }
00850     }
00851 
00852     <span class="comment">/*</span>
00853 <span class="comment">     * Check to see if pwnd is NULL AFTER the timer check.  Apps can set</span>
00854 <span class="comment">     * timers with NULL hwnd's, that's totally legal.  But NULL hwnd messages</span>
00855 <span class="comment">     * don't get dispatched, so check here after the timer case but before</span>
00856 <span class="comment">     * dispatching - if it's NULL, just return 0.</span>
00857 <span class="comment">     */</span>
00858     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00859         lRet = 0;
00860         <span class="keywordflow">goto</span> Exit;
00861     }
00862 
00863     <span class="comment">/*</span>
00864 <span class="comment">     * If we're dispatching a WM_PAINT message, set a flag to be used to</span>
00865 <span class="comment">     * determine whether it was processed properly.</span>
00866 <span class="comment">     */</span>
00867     <span class="keywordflow">if</span> (pmsg-&gt;message == WM_PAINT)
00868         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a573">WFPAINTNOTPROCESSED</a>);
00869 
00870     <span class="comment">/*</span>
00871 <span class="comment">     * If this window's proc is meant to be executed from the server side</span>
00872 <span class="comment">     * we'll just stay inside the semaphore and call it directly.  Note</span>
00873 <span class="comment">     * how we don't convert the pwnd into an hwnd before calling the proc.</span>
00874 <span class="comment">     */</span>
00875     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a569">WFSERVERSIDEPROC</a>)) {
00876         ULONG_PTR fnMessageType;
00877 
00878         fnMessageType = pmsg-&gt;message &gt;= WM_USER ? (ULONG_PTR)SfnDWORD :
00879                 (ULONG_PTR)<a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a22">gapfnScSendMessage</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1144">MessageTable</a>[pmsg-&gt;message].<a class="code" href="../../d6/d2/structtagMSG__TABLE__ENTRY.html#o0">iFunction</a>];
00880 
00881         <span class="comment">/*</span>
00882 <span class="comment">         * Convert the WM_CHAR from ANSI to UNICODE if the source was ANSI</span>
00883 <span class="comment">         */</span>
00884         <span class="keywordflow">if</span> (fnMessageType == (ULONG_PTR)SfnINWPARAMCHAR &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a570">WFANSIPROC</a>)) {
00885             UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>() == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)); <span class="comment">// use receiver's codepage</span>
00886             <a class="code" href="../../d5/d6/chartran_8c.html#a5">RtlMBMessageWParamCharToWCS</a>(pmsg-&gt;message, &amp;pmsg-&gt;wParam);
00887         }
00888 
00889         lRet = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o8">lpfnWndProc</a>(pwnd, pmsg-&gt;message, pmsg-&gt;wParam,
00890                 pmsg-&gt;lParam);
00891         <span class="keywordflow">goto</span> Exit;
00892     }
00893 
00894     <span class="comment">/*</span>
00895 <span class="comment">     * Cool people dereference any window structure members before they</span>
00896 <span class="comment">     * leave the critsect.</span>
00897 <span class="comment">     */</span>
00898     lpfnWndProc = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o8">lpfnWndProc</a>;
00899 
00900     {
00901         <span class="comment">/*</span>
00902 <span class="comment">         * If we're dispatching the message to an ANSI wndproc we need to</span>
00903 <span class="comment">         * convert the character messages from Unicode to Ansi.</span>
00904 <span class="comment">         */</span>
00905         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a570">WFANSIPROC</a>)) {
00906             UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>() == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)); <span class="comment">// use receiver's codepage</span>
00907             <a class="code" href="../../d5/d6/chartran_8c.html#a4">RtlWCSMessageWParamCharToMB</a>(pmsg-&gt;message, &amp;pmsg-&gt;wParam);
00908             lRet = <a class="code" href="../../d4/d1/userk_8h.html#a242">CallClientProcA</a>(pwnd, pmsg-&gt;message,
00909                     pmsg-&gt;wParam, pmsg-&gt;lParam, (ULONG_PTR)lpfnWndProc);
00910         } <span class="keywordflow">else</span> {
00911             lRet = <a class="code" href="../../d4/d1/userk_8h.html#a243">CallClientProcW</a>(pwnd, pmsg-&gt;message,
00912                     pmsg-&gt;wParam, pmsg-&gt;lParam, (ULONG_PTR)lpfnWndProc);
00913         }
00914     }
00915 
00916     <span class="comment">/*</span>
00917 <span class="comment">     * If we dispatched a WM_PAINT message and it wasn't properly</span>
00918 <span class="comment">     * processed, do the drawing here.</span>
00919 <span class="comment">     */</span>
00920     <span class="keywordflow">if</span> (pmsg-&gt;message == WM_PAINT &amp;&amp; <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(pmsg-&gt;hwnd) &amp;&amp;
00921             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a573">WFPAINTNOTPROCESSED</a>)) {
00922         <span class="comment">//RIPMSG0(RIP_WARNING,</span>
00923         <span class="comment">//    "Missing BeginPaint or GetUpdateRect/Rgn(fErase == TRUE) in WM_PAINT");</span>
00924         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a584">WFWMPAINTSENT</a>);
00925         <a class="code" href="../../d4/d1/userk_8h.html#a1040">xxxSimpleDoSyncPaint</a>(pwnd);
00926     }
00927 
00928 Exit:
00929     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
00930     <span class="keywordflow">return</span> lRet;
00931 }
00932 
00933 <span class="comment">/***************************************************************************\</span>
00934 <span class="comment">* AdjustForCoalescing</span>
00935 <span class="comment">*</span>
00936 <span class="comment">* If message is in the coalesce message range, and it's message and hwnd</span>
00937 <span class="comment">* equals the last message in the queue, then coalesce these two messages</span>
00938 <span class="comment">* by simple deleting the last one.</span>
00939 <span class="comment">*</span>
00940 <span class="comment">* 11-12-92 ScottLu      Created.</span>
00941 <span class="comment">\***************************************************************************/</span>
00942 
<a name="l00943"></a><a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a25">00943</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a25">AdjustForCoalescing</a>(
00944     <a class="code" href="../../d6/d1/structtagMLIST.html">PMLIST</a> pml,
00945     HWND hwnd,
00946     UINT message)
00947 {
00948     <span class="comment">/*</span>
00949 <span class="comment">     * First see if this message is in that range.</span>
00950 <span class="comment">     */</span>
00951     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a823">CheckMsgFilter</a>(message, WM_COALESCE_FIRST, WM_COALESCE_LAST) &amp;&amp;
00952             (message != WM_TIMECHANGE))
00953         <span class="keywordflow">return</span>;
00954 
00955     <span class="keywordflow">if</span> (pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o1">pqmsgWriteLast</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00956         <span class="keywordflow">return</span>;
00957 
00958     <span class="keywordflow">if</span> (pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o1">pqmsgWriteLast</a>-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message != message)
00959         <span class="keywordflow">return</span>;
00960 
00961     <span class="keywordflow">if</span> (pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o1">pqmsgWriteLast</a>-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.hwnd != hwnd)
00962         <span class="keywordflow">return</span>;
00963 
00964     <span class="comment">/*</span>
00965 <span class="comment">     * The message and hwnd are the same, so delete this message and</span>
00966 <span class="comment">     * the new one will added later.</span>
00967 <span class="comment">     */</span>
00968     <a class="code" href="../../d4/d1/userk_8h.html#a1212">DelQEntry</a>(pml, pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o1">pqmsgWriteLast</a>);
00969 }
00970 
00971 <span class="comment">/***************************************************************************\</span>
00972 <span class="comment">* _PostMessage (API)</span>
00973 <span class="comment">*</span>
00974 <span class="comment">* Writes a message to the message queue for pwnd.  If pwnd == -1, the message</span>
00975 <span class="comment">* is broadcasted to all windows.</span>
00976 <span class="comment">*</span>
00977 <span class="comment">* History:</span>
00978 <span class="comment">* 11-06-90 DavidPe      Created.</span>
00979 <span class="comment">\***************************************************************************/</span>
00980 
<a name="l00981"></a><a class="code" href="../../d4/d1/userk_8h.html#a1642">00981</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(
00982     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00983     UINT message,
00984     WPARAM wParam,
00985     LPARAM lParam)
00986 {
00987     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsg;
00988     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fPwndUnlock;
00989     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRet;
00990     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwPostCode;
00991     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
00992     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
00993 
00994     <span class="comment">/*</span>
00995 <span class="comment">     * First check to see if this message takes DWORDs only. If it does not,</span>
00996 <span class="comment">     * fail the post. Cannot allow an app to post a message with pointers or</span>
00997 <span class="comment">     * handles in it - this can cause the server to fault and cause other</span>
00998 <span class="comment">     * problems - such as causing apps in separate address spaces to fault.</span>
00999 <span class="comment">     * (or even an app in the same address space to fault!)</span>
01000 <span class="comment">     */</span>
01001     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a918">TESTSYNCONLYMESSAGE</a>(message, wParam)) {
01002         RIPERR1(ERROR_MESSAGE_SYNC_ONLY,
01003                 RIP_WARNING,
01004                 <span class="stringliteral">"Invalid parameter \"message\" (%ld) to _PostMessage"</span>,
01005                 message);
01006 
01007         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01008     }
01009 
01010     <span class="comment">/*</span>
01011 <span class="comment">     * Is this a BroadcastMsg()?</span>
01012 <span class="comment">     */</span>
01013     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d1/userk_8h.html#a457">PWND_BROADCAST</a>) {
01014         <a class="code" href="../../d4/d1/userk_8h.html#a1475">xxxBroadcastMessage</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, message, wParam, lParam, <a class="code" href="../../d4/d1/userk_8h.html#a445">BMSG_POSTMSG</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01015         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01016     }
01017 
01018     pti = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01019 
01020     <span class="comment">/*</span>
01021 <span class="comment">     * Is this posting to the current thread info?</span>
01022 <span class="comment">     */</span>
01023     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01024         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1645">_PostThreadMessage</a>(pti, message, wParam, lParam);
01025     }
01026 
01027     fPwndUnlock = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01028     <span class="keywordflow">if</span> (message &gt;= WM_DDE_FIRST &amp;&amp; message &lt;= WM_DDE_LAST) {
01029         <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(pti, pwnd, &amp;tlpwnd);
01030         dwPostCode = <a class="code" href="../../d4/d1/userk_8h.html#a1874">xxxDDETrackPostHook</a>(&amp;message, pwnd, wParam, &amp;lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01031 
01032         <span class="keywordflow">if</span> (dwPostCode != <a class="code" href="../../d6/d4/ddetrack_8h.html#a19">DO_POST</a>) {
01033             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
01034             <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)dwPostCode;
01035         }
01036 
01037         fPwndUnlock = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01038     }
01039 
01040     pti = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd);
01041 
01042     <span class="comment">/*</span>
01043 <span class="comment">     * Check to see if this message is in the multimedia coalescing range.</span>
01044 <span class="comment">     * If so, see if it can be coalesced with the previous message.</span>
01045 <span class="comment">     */</span>
01046     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a25">AdjustForCoalescing</a>(&amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o43">mlPost</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd), message);
01047 
01048     <span class="comment">/*</span>
01049 <span class="comment">     * Allocate a key state update event if needed.</span>
01050 <span class="comment">     */</span>
01051     <span class="keywordflow">if</span> (message &gt;= WM_KEYFIRST &amp;&amp; message &lt;= WM_KEYLAST) {
01052         <a class="code" href="../../d4/d1/userk_8h.html#a1235">PostUpdateKeyStateEvent</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>);
01053     }
01054 
01055     <span class="comment">/*</span>
01056 <span class="comment">     * Put this message on the 'post' list.</span>
01057 <span class="comment">     */</span>
01058     fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01059     <span class="keywordflow">if</span> ((pqmsg = <a class="code" href="../../d4/d1/userk_8h.html#a1210">AllocQEntry</a>(&amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o43">mlPost</a>)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01060         <span class="comment">/*</span>
01061 <span class="comment">         * Set the QS_POSTMESSAGE bit so the thread knows it has a message.</span>
01062 <span class="comment">         */</span>
01063         <a class="code" href="../../d4/d1/userk_8h.html#a1503">StoreQMessage</a>(pqmsg, pwnd, message, wParam, lParam, 0, 0, 0);
01064         <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(pti, QS_POSTMESSAGE | QS_ALLPOSTMESSAGE);
01065 
01066         <span class="comment">/*</span>
01067 <span class="comment">         * If it's a hotkey, set the QS_HOTKEY bit since we have a separate</span>
01068 <span class="comment">         * bit for those messages.</span>
01069 <span class="comment">         */</span>
01070         <span class="keywordflow">if</span> (message == WM_HOTKEY)
01071             <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(pti, QS_HOTKEY);
01072 
01073         fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01074     } <span class="keywordflow">else</span> {
01075         RIPMSG1(RIP_WARNING, <span class="stringliteral">"_PostMessage: Failed to alloc Q entry: target pti=0x%p"</span>,
01076                 pti);
01077     }
01078 
01079     <span class="comment">/*</span>
01080 <span class="comment">     * Are we posting to the thread currently reading from the input queue?</span>
01081 <span class="comment">     * If so, update idSysLock with this pqmsg so that the input queue will</span>
01082 <span class="comment">     * not be unlocked until this message is read.</span>
01083 <span class="comment">     */</span>
01084     <span class="keywordflow">if</span> (pti == pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o1">ptiSysLock</a>)
01085         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o2">idSysLock</a> = (ULONG_PTR)pqmsg;
01086 
01087     <span class="keywordflow">if</span> (fPwndUnlock)
01088         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
01089 
01090     <span class="keywordflow">return</span> fRet;
01091 }
01092 <span class="comment">/***************************************************************************\</span>
01093 <span class="comment">* _PostQuitMessage (API)</span>
01094 <span class="comment">*</span>
01095 <span class="comment">* Writes a message to the message queue for pwnd.  If pwnd == -1, the message</span>
01096 <span class="comment">* is broadcasted to all windows.</span>
01097 <span class="comment">*</span>
01098 <span class="comment">* History:</span>
01099 <span class="comment">* 11-06-90 DavidPe      Created.</span>
01100 <span class="comment">* 05-16-91 mikeke       Changed to return BOOL</span>
01101 <span class="comment">\***************************************************************************/</span>
<a name="l01102"></a><a class="code" href="../../d4/d1/userk_8h.html#a1643">01102</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1643">IPostQuitMessage</a>(<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti, <span class="keywordtype">int</span> nExitCode)
01103 {
01104     pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o16">cQuit</a> = 1;
01105     pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o17">exitCode</a> = nExitCode;
01106     <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(pti, QS_POSTMESSAGE | QS_ALLPOSTMESSAGE);
01107     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01108 }
<a name="l01109"></a><a class="code" href="../../d4/d1/userk_8h.html#a1644">01109</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1644">_PostQuitMessage</a>(<span class="keywordtype">int</span> nExitCode)
01110 {
01111     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1643">IPostQuitMessage</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), nExitCode);
01112 }
01113 <span class="comment">/***************************************************************************\</span>
01114 <span class="comment">* _PostThreadMessage (API)</span>
01115 <span class="comment">*</span>
01116 <span class="comment">* Given a thread ID, the function will post the specified message to this</span>
01117 <span class="comment">* thread with pmsg-&gt;hwnd == NULL..</span>
01118 <span class="comment">*</span>
01119 <span class="comment">* History:</span>
01120 <span class="comment">* 11-21-90 DavidPe      Created.</span>
01121 <span class="comment">\***************************************************************************/</span>
01122 
<a name="l01123"></a><a class="code" href="../../d4/d1/userk_8h.html#a1645">01123</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1645">_PostThreadMessage</a>(
01124     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti,
01125     UINT        message,
01126     WPARAM      wParam,
01127     LPARAM      lParam)
01128 {
01129     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a>       pqmsg;
01130 
01131     <span class="keywordflow">if</span> ((pti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)                                ||
01132         !(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a816">TIF_GUITHREADINITIALIZED</a>) ||
01133         (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>)) {
01134 
01135         RIPERR0(ERROR_INVALID_THREAD_ID, RIP_VERBOSE, <span class="stringliteral">""</span>);
01136         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01137     }
01138 
01139     <span class="comment">/*</span>
01140 <span class="comment">     * First check to see if this message takes DWORDs only. If it does not,</span>
01141 <span class="comment">     * fail the post. Cannot allow an app to post a message with pointers or</span>
01142 <span class="comment">     * handles in it - this can cause the server to fault and cause other</span>
01143 <span class="comment">     * problems - such as causing apps in separate address spaces to fault.</span>
01144 <span class="comment">     * (or even an app in the same address space to fault!)</span>
01145 <span class="comment">     */</span>
01146     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a918">TESTSYNCONLYMESSAGE</a>(message, wParam)) {
01147         RIPERR1(ERROR_MESSAGE_SYNC_ONLY,
01148                 RIP_WARNING,
01149                 <span class="stringliteral">"Invalid parameter \"message\" (%ld) to _PostThreadMessage"</span>,
01150                 message);
01151 
01152         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01153     }
01154 
01155     <span class="comment">/*</span>
01156 <span class="comment">     * Check to see if this message is in the multimedia coalescing range.</span>
01157 <span class="comment">     * If so, see if it can be coalesced with the previous message.</span>
01158 <span class="comment">     */</span>
01159     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a25">AdjustForCoalescing</a>(&amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o43">mlPost</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, message);
01160 
01161     <span class="comment">/*</span>
01162 <span class="comment">     * Put this message on the 'post' list.</span>
01163 <span class="comment">     */</span>
01164     <span class="keywordflow">if</span> ((pqmsg = <a class="code" href="../../d4/d1/userk_8h.html#a1210">AllocQEntry</a>(&amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o43">mlPost</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01165         RIPMSG1(RIP_WARNING, <span class="stringliteral">"_PostThreadMessage: Failed to alloc Q entry: Target pti=0x%p"</span>,
01166                 pti);
01167         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01168     }
01169 
01170     <span class="comment">/*</span>
01171 <span class="comment">     * Set the QS_POSTMESSAGE bit so the thread knows it has a message.</span>
01172 <span class="comment">     */</span>
01173     <a class="code" href="../../d4/d1/userk_8h.html#a1503">StoreQMessage</a>(pqmsg, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, message, wParam, lParam, 0, 0, 0);
01174     <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(pti, QS_POSTMESSAGE | QS_ALLPOSTMESSAGE);
01175 
01176     <span class="comment">/*</span>
01177 <span class="comment">     * If it's a hotkey, set the QS_HOTKEY bit since we have a separate</span>
01178 <span class="comment">     * bit for those messages.</span>
01179 <span class="comment">     */</span>
01180     <span class="keywordflow">if</span> (message == WM_HOTKEY)
01181         <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(pti, QS_HOTKEY);
01182 
01183     <span class="comment">/*</span>
01184 <span class="comment">     * Are we posting to the thread currently reading from the input queue?</span>
01185 <span class="comment">     * If so, update idSysLock with this pqmsg so that the input queue will</span>
01186 <span class="comment">     * not be unlocked until this message is read.</span>
01187 <span class="comment">     */</span>
01188     <span class="keywordflow">if</span> (pti == pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o1">ptiSysLock</a>)
01189         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o2">idSysLock</a> = (ULONG_PTR)pqmsg;
01190 
01191     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01192 }
01193 
01194 
01195 <span class="comment">/***************************************************************************\</span>
01196 <span class="comment">* _GetMessagePos (API)</span>
01197 <span class="comment">*</span>
01198 <span class="comment">* This API returns the cursor position when the last message was read from</span>
01199 <span class="comment">* the current message queue.</span>
01200 <span class="comment">*</span>
01201 <span class="comment">* History:</span>
01202 <span class="comment">* 11-19-90 DavidPe      Created.</span>
01203 <span class="comment">\***************************************************************************/</span>
01204 
<a name="l01205"></a><a class="code" href="../../d4/d1/userk_8h.html#a1639">01205</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d1/userk_8h.html#a1639">_GetMessagePos</a>(VOID)
01206 {
01207     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
01208 
01209     pti = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01210 
01211     <span class="keywordflow">return</span> MAKELONG((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o38">ptLast</a>.x, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o38">ptLast</a>.y);
01212 }
01213 
01214 
01215 
01216 <span class="preprocessor">#ifdef SYSMODALWINDOWS</span>
01217 <span class="preprocessor"></span><span class="comment">/***************************************************************************\</span>
01218 <span class="comment">* _SetSysModalWindow (API)</span>
01219 <span class="comment">*</span>
01220 <span class="comment">* History:</span>
01221 <span class="comment">* 01-25-91 DavidPe      Created stub.</span>
01222 <span class="comment">\***************************************************************************/</span>
01223 
01224 <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a> _SetSysModalWindow(
01225     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
01226 {
01227     pwnd;
01228     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01229 }
01230 
01231 
01232 <span class="comment">/***************************************************************************\</span>
01233 <span class="comment">* _GetSysModalWindow (API)</span>
01234 <span class="comment">*</span>
01235 <span class="comment">* History:</span>
01236 <span class="comment">* 01-25-91 DavidPe      Created stub.</span>
01237 <span class="comment">\***************************************************************************/</span>
01238 
01239 <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a> _GetSysModalWindow(VOID)
01240 {
01241     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01242 }
01243 <span class="preprocessor">#endif //LATER</span>
01244 <span class="preprocessor"></span>
01245 <span class="comment">/***************************************************************************\</span>
01246 <span class="comment">* PostMove</span>
01247 <span class="comment">*</span>
01248 <span class="comment">* This routine gets called when it is detected that the QF_MOUSEMOVED bit</span>
01249 <span class="comment">* is set in a particular queue.</span>
01250 <span class="comment">*</span>
01251 <span class="comment">* 11-03-92 ScottLu      Created.</span>
01252 <span class="comment">\***************************************************************************/</span>
01253 
<a name="l01254"></a><a class="code" href="../../d4/d1/userk_8h.html#a1478">01254</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1478">PostMove</a>(
01255     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pq)
01256 {
01257 <span class="preprocessor">#ifdef REDIRECTION</span>
01258 <span class="preprocessor"></span>    POINT pt;
01259 <span class="preprocessor">#endif // REDIRECTION</span>
01260 <span class="preprocessor"></span>
01261     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
01262 
01263     <span class="comment">/*</span>
01264 <span class="comment">     * set gdwMouseMoveTimeStamp to 0 after posting the move so</span>
01265 <span class="comment">     * subsequent calls to SetFMouseMove doesn't use the same value</span>
01266 <span class="comment">     * of gdwMouseMoveTimeStamp. Bug 74508.</span>
01267 <span class="comment">     */</span>
01268     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a77">gdwMouseMoveTimeStamp</a> == 0) {
01269         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a77">gdwMouseMoveTimeStamp</a> = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>();
01270     }
01271 
01272 <span class="preprocessor">#ifdef REDIRECTION</span>
01273 <span class="preprocessor"></span>
01274     PopMouseMove(pq, &amp;pt);
01275 
01276     <a class="code" href="../../d4/d1/userk_8h.html#a1195">PostInputMessage</a>(pq, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, WM_MOUSEMOVE, 0,
01277             MAKELONG((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)pt.x, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)pt.y),
01278             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a77">gdwMouseMoveTimeStamp</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a76">gdwMouseMoveExtraInfo</a>);
01279 <span class="preprocessor">#else</span>
01280 <span class="preprocessor"></span>    <a class="code" href="../../d4/d1/userk_8h.html#a1195">PostInputMessage</a>(pq, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, WM_MOUSEMOVE, 0,
01281             MAKELONG((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor.x, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor.y),
01282             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a77">gdwMouseMoveTimeStamp</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a76">gdwMouseMoveExtraInfo</a>);
01283 <span class="preprocessor">#endif // REDIRECTION</span>
01284 <span class="preprocessor"></span>
01285     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a77">gdwMouseMoveTimeStamp</a> = 0;
01286 
01287     pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a860">QF_MOUSEMOVED</a>;
01288 }
01289 
01290 <span class="preprocessor">#ifdef REDIRECTION</span>
01291 <span class="preprocessor"></span>
01292 <span class="keyword">typedef</span> <span class="keyword">struct </span>tagQMOUSEMOVE {
01293     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a>    pq;
01294     POINT pt;
01295 } QMOUSEMOVE;
01296 
01297 <span class="preprocessor">#define MAX_QMOUSEMOVE  16</span>
01298 <span class="preprocessor"></span>
01299 QMOUSEMOVE gqMouseMove[MAX_QMOUSEMOVE];
01300 
01301 <span class="keywordtype">int</span> gnLastMouseMove;
01302 
01303 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> PushMouseMove(
01304     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a>    pq,
01305     POINT pt)
01306 {
01307     <span class="keywordtype">int</span> ind;
01308 
01309     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
01310 
01311     UserAssert(gnLastMouseMove &lt; MAX_QMOUSEMOVE - 1);
01312 
01313     <span class="keywordflow">for</span> (ind = 0; ind &lt; gnLastMouseMove; ind++) {
01314         <span class="keywordflow">if</span> (pq == gqMouseMove[ind].pq) {
01315 
01316             gqMouseMove[ind].pt = pt;
01317             <span class="keywordflow">return</span>;
01318         }
01319     }
01320 
01321     gqMouseMove[gnLastMouseMove].pq = pq;
01322     gqMouseMove[gnLastMouseMove].pt = pt;
01323 
01324     gnLastMouseMove++;
01325 }
01326 
01327 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> PopMouseMove(
01328     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a>     pq,
01329     POINT* ppt)
01330 {
01331     <span class="keywordtype">int</span> ind;
01332 
01333     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
01334 
01335     <span class="keywordflow">for</span> (ind = 0; ind &lt; gnLastMouseMove; ind++) {
01336         <span class="keywordflow">if</span> (pq == gqMouseMove[ind].pq) {
01337             *ppt = gqMouseMove[ind].pt;
01338 
01339             RtlMoveMemory(&amp;gqMouseMove[ind],
01340                           &amp;gqMouseMove[ind + 1],
01341                           (gnLastMouseMove - ind - 1) * <span class="keyword">sizeof</span>(QMOUSEMOVE));
01342 
01343             gnLastMouseMove--;
01344 
01345             <span class="keywordflow">return</span>;
01346         }
01347     }
01348     UserAssert(0);
01349 }
01350 <span class="preprocessor">#endif // REDIRECTION</span>
01351 <span class="preprocessor"></span>
01352 <span class="comment">/***************************************************************************\</span>
01353 <span class="comment">* zzzSetFMouseMoved</span>
01354 <span class="comment">*</span>
01355 <span class="comment">* Send a mouse move through the system. This usually occurs when doing</span>
01356 <span class="comment">* window management to be sure that the mouse shape accurately reflects</span>
01357 <span class="comment">* the part of the window it is currently over (window managment may have</span>
01358 <span class="comment">* changed this).</span>
01359 <span class="comment">*</span>
01360 <span class="comment">* 11-02-92 ScottLu      Created.</span>
01361 <span class="comment">\***************************************************************************/</span>
01362 
<a name="l01363"></a><a class="code" href="../../d4/d1/userk_8h.html#a1476">01363</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a32">zzzSetFMouseMoved</a>()
01364 {
01365     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
01366     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndOldCursor;
01367     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a>   pq;
01368 
01369 <span class="preprocessor">#ifdef REDIRECTION</span>
01370 <span class="preprocessor"></span>    <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwndStart;
01371     POINT ptMouse = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor;
01372 <span class="preprocessor">#endif // REDIRECTION</span>
01373 <span class="preprocessor"></span>
01374     <span class="comment">/*</span>
01375 <span class="comment">     * Need to first figure out what queue this mouse event is in. Do NOT</span>
01376 <span class="comment">     * check for mouse capture here !! Talk to scottlu.</span>
01377 <span class="comment">     */</span>
01378     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a13">gspwndScreenCapture</a>) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01379 
01380 <span class="preprocessor">#ifdef REDIRECTION</span>
01381 <span class="preprocessor"></span>        <span class="comment">/*</span>
01382 <span class="comment">         * Call the speed hit test hook</span>
01383 <span class="comment">         */</span>
01384         pwndStart = xxxCallSpeedHitTestHook(&amp;ptMouse);
01385 <span class="preprocessor">#endif // REDIRECTION</span>
01386 <span class="preprocessor"></span>
01387         <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a90">gspwndMouseOwner</a>) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01388             <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a14">gspwndInternalCapture</a>) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01389 
01390                 UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01391 
01392 <span class="preprocessor">#ifdef REDIRECTION</span>
01393 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (pwndStart == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01394                     pwndStart = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>;
01395                 }
01396                 pwnd = <a class="code" href="../../d9/d8/winwhere_8c.html#a3">SpeedHitTest</a>(pwndStart, ptMouse);
01397 <span class="preprocessor">#else</span>
01398 <span class="preprocessor"></span>                pwnd = <a class="code" href="../../d9/d8/winwhere_8c.html#a3">SpeedHitTest</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor);
01399 <span class="preprocessor">#endif // REDIRECTION</span>
01400 <span class="preprocessor"></span>
01401             }
01402         }
01403     }
01404 
01405     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01406         <span class="keywordflow">return</span>;
01407 
01408     <span class="comment">/*</span>
01409 <span class="comment">     * This is apparently needed by the attach/unattach code for some</span>
01410 <span class="comment">     * reason. I'd like to get rid of it - scottlu.</span>
01411 <span class="comment">     */</span>
01412     pwndOldCursor = <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a108">gspwndCursor</a>, pwnd);
01413 
01414     <span class="comment">/*</span>
01415 <span class="comment">     * If we're giving a mouse move to a new queue, be sure the cursor</span>
01416 <span class="comment">     * image represents what this queue thinks it should be.</span>
01417 <span class="comment">     */</span>
01418     pq = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq;
01419 
01420     <span class="comment">/*</span>
01421 <span class="comment">     * Protect pq by deferring WinEvent notification</span>
01422 <span class="comment">     */</span>
01423     <a class="code" href="../../d4/d1/userk_8h.html#a614">DeferWinEventNotify</a>();
01424 
01425     <span class="keywordflow">if</span> (pq != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a31">gpqCursor</a>) {
01426         <span class="comment">/*</span>
01427 <span class="comment">         * If the old queue had the mouse captured, let him know that</span>
01428 <span class="comment">         * the mouse moved first. Need this to fix tooltips in</span>
01429 <span class="comment">         * WordPerfect Office. Do the same for mouse tracking.</span>
01430 <span class="comment">         */</span>
01431         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a31">gpqCursor</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01432 
01433             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a31">gpqCursor</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01434                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a31">gpqCursor</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a860">QF_MOUSEMOVED</a>;
01435                 <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a31">gpqCursor</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a>), QS_MOUSEMOVE);
01436 
01437 <span class="preprocessor">#ifdef REDIRECTION</span>
01438 <span class="preprocessor"></span>                PushMouseMove(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a31">gpqCursor</a>, ptMouse);
01439 <span class="preprocessor">#endif // REDIRECTION</span>
01440 <span class="preprocessor"></span>
01441             }
01442 
01443             <span class="keywordflow">if</span> ((pwndOldCursor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(pwndOldCursor) != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(pwnd))) {
01444                 <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a456">GETPDESK</a>(pwndOldCursor);
01445                 <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a295">DF_MOUSEMOVETRK</a>) {
01446                     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o21">spwndTrack</a>);
01447                     <a class="code" href="../../d4/d1/userk_8h.html#a1217">PostEventMessage</a>(pti, pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, <a class="code" href="../../d4/d1/userk_8h.html#a346">QEVENT_CANCELMOUSEMOVETRK</a>,
01448                                      pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o21">spwndTrack</a>, pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a>, pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o22">htEx</a>,
01449                                      <a class="code" href="../../d4/d1/userk_8h.html#a295">DF_MOUSEMOVETRK</a>);
01450                     pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a295">DF_MOUSEMOVETRK</a>;
01451                 }
01452             }
01453         }
01454 
01455         <span class="comment">/*</span>
01456 <span class="comment">         * First re-assign gpqCursor so any zzzSetCursor() calls</span>
01457 <span class="comment">         * will only take effect if done by the thread that</span>
01458 <span class="comment">         * owns the window the mouse is currently over.</span>
01459 <span class="comment">         */</span>
01460         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a31">gpqCursor</a> = pq;
01461 
01462         <span class="comment">/*</span>
01463 <span class="comment">         * Call zzzUpdateCursorImage() so the new gpqCursor's</span>
01464 <span class="comment">         * notion of the current cursor is represented.</span>
01465 <span class="comment">         */</span>
01466         <a class="code" href="../../d7/d1/ntuser_2kernel_2cursor_8c.html#a11">zzzUpdateCursorImage</a>();
01467 
01468     }
01469 
01470     <span class="comment">/*</span>
01471 <span class="comment">     * Set the mouse moved bit for this queue so we know later to post</span>
01472 <span class="comment">     * a move message to this queue.</span>
01473 <span class="comment">     */</span>
01474     pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a860">QF_MOUSEMOVED</a>;
01475 
01476 <span class="preprocessor">#ifdef REDIRECTION</span>
01477 <span class="preprocessor"></span>    PushMouseMove(pq, ptMouse);
01478 <span class="preprocessor">#endif // REDIRECTION</span>
01479 <span class="preprocessor"></span>
01480 
01481     <span class="comment">/*</span>
01482 <span class="comment">     * Reassign mouse input to this thread - this indicates which thread</span>
01483 <span class="comment">     * to wake up when new input comes in.</span>
01484 <span class="comment">     */</span>
01485     pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o4">ptiMouse</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd);
01486 
01487     <span class="comment">/*</span>
01488 <span class="comment">     * Wake some thread within this queue to process this mouse event.</span>
01489 <span class="comment">     */</span>
01490     <a class="code" href="../../d4/d1/userk_8h.html#a1198">WakeSomeone</a>(pq, WM_MOUSEMOVE, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01491 
01492     <span class="comment">/*</span>
01493 <span class="comment">     * We're possibly generating a fake mouse move message - it has no</span>
01494 <span class="comment">     * extra info associated with it - so 0 it out.</span>
01495 <span class="comment">     */</span>
01496     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a76">gdwMouseMoveExtraInfo</a> = 0;
01497 
01498     <a class="code" href="../../d4/d1/userk_8h.html#a617">zzzEndDeferWinEventNotify</a>();
01499 }
01500 
01501 <span class="comment">/***************************************************************************\</span>
01502 <span class="comment">* CancelForegroundActivate</span>
01503 <span class="comment">*</span>
01504 <span class="comment">* This routine cancels the foreground activate that we allow apps starting</span>
01505 <span class="comment">* up to have. This means that if you make a request to start an app,</span>
01506 <span class="comment">* if this routine is called before the app becomes foreground, it won't</span>
01507 <span class="comment">* become foreground. This routine gets called if the user down clicks or</span>
01508 <span class="comment">* makes a keydown event, with the idea being that if the user did this,</span>
01509 <span class="comment">* the user is using some other app and doesn't want the newly starting</span>
01510 <span class="comment">* application to appear on top and force itself into the foreground.</span>
01511 <span class="comment">*</span>
01512 <span class="comment">* 09-15-92 ScottLu      Created.</span>
01513 <span class="comment">\***************************************************************************/</span>
01514 
<a name="l01515"></a><a class="code" href="../../d4/d1/userk_8h.html#a1941">01515</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a33">CancelForegroundActivate</a>()
01516 {
01517     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppiT;
01518 
01519     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a657">TEST_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a647">PUDF_ALLOWFOREGROUNDACTIVATE</a>)) {
01520 
01521         <span class="keywordflow">for</span> (ppiT = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a109">gppiStarting</a>; ppiT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; ppiT = ppiT-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o7">ppiNext</a>) {
01522             <span class="comment">/*</span>
01523 <span class="comment">             * Don't cancel activation if the app is being debugged - if</span>
01524 <span class="comment">             * the debugger stops the application before it has created and</span>
01525 <span class="comment">             * activated its first window, the app will come up behind all</span>
01526 <span class="comment">             * others - not what you want when being debugged.</span>
01527 <span class="comment">             */</span>
01528             <span class="keywordflow">if</span> (!ppiT-&gt;Process-&gt;DebugPort) {
01529                 ppiT-&gt;W32PF_Flags &amp;= ~W32PF_ALLOWFOREGROUNDACTIVATE;
01530                 TAGMSG1(DBGTAG_FOREGROUND, <span class="stringliteral">"CancelForegroundActivate clear W32PF %#p"</span>, ppiT);
01531             }
01532         }
01533 
01534         <a class="code" href="../../d4/d1/userk_8h.html#a660">CLEAR_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a647">PUDF_ALLOWFOREGROUNDACTIVATE</a>);
01535         TAGMSG0(DBGTAG_FOREGROUND, <span class="stringliteral">"CancelForegroundActivate clear PUDF"</span>);
01536     }
01537 }
01538 
01539 <span class="comment">/***************************************************************************\</span>
01540 <span class="comment">* RestoreForegroundActivate</span>
01541 <span class="comment">*</span>
01542 <span class="comment">* This routine re-enables an app's right to foreground activate (activate and</span>
01543 <span class="comment">* come on top) if it is starting up. This is called when we minimize or when</span>
01544 <span class="comment">* the last window of a thread goes away, for example.</span>
01545 <span class="comment">*</span>
01546 <span class="comment">* 01-26-93 ScottLu      Created.</span>
01547 <span class="comment">\***************************************************************************/</span>
01548 
<a name="l01549"></a><a class="code" href="../../d4/d1/userk_8h.html#a1940">01549</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a34">RestoreForegroundActivate</a>()
01550 {
01551     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppiT;
01552 
01553     <span class="keywordflow">for</span> (ppiT = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a109">gppiStarting</a>; ppiT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; ppiT = ppiT-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o7">ppiNext</a>) {
01554         <span class="keywordflow">if</span> (ppiT-&gt;W32PF_Flags &amp; W32PF_APPSTARTING) {
01555             ppiT-&gt;W32PF_Flags |= W32PF_ALLOWFOREGROUNDACTIVATE;
01556             TAGMSG1(DBGTAG_FOREGROUND, <span class="stringliteral">"RestoreForegroundActivate set W32PF %#p"</span>, ppiT);
01557             <a class="code" href="../../d4/d1/userk_8h.html#a659">SET_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a647">PUDF_ALLOWFOREGROUNDACTIVATE</a>);
01558             TAGMSG0(DBGTAG_FOREGROUND, <span class="stringliteral">"RestoreForegroundActivate set PUDF"</span>);
01559         }
01560     }
01561 }
01562 
01563 
01564 <span class="comment">/***************************************************************************\</span>
01565 <span class="comment">* PostInputMessage</span>
01566 <span class="comment">*</span>
01567 <span class="comment">* Puts a message on the 'input' linked-list of message for the specified</span>
01568 <span class="comment">* queue.</span>
01569 <span class="comment">*</span>
01570 <span class="comment">* History:</span>
01571 <span class="comment">* 10-25-90 DavidPe      Created.</span>
01572 <span class="comment">* 01-21-92 DavidPe      Rewrote to deal with OOM errors gracefully.</span>
01573 <span class="comment">\***************************************************************************/</span>
01574 
<a name="l01575"></a><a class="code" href="../../d4/d1/userk_8h.html#a1195">01575</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1195">PostInputMessage</a>(
01576     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a>    pq,
01577     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwnd,
01578     UINT  message,
01579     WPARAM wParam,
01580     LPARAM lParam,
01581     DWORD time,
01582     ULONG_PTR dwExtraInfo)
01583 {
01584     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsgInput, pqmsgPrev;
01585     <span class="keywordtype">short</span> sWheelDelta;
01586 
01587     <span class="comment">/*</span>
01588 <span class="comment">     * Grab the last written message before we start allocing new ones,</span>
01589 <span class="comment">     * so we're sure to point to the correct message.</span>
01590 <span class="comment">     */</span>
01591     pqmsgPrev = pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>.<a class="code" href="../../d6/d1/structtagMLIST.html#o1">pqmsgWriteLast</a>;
01592 
01593     <span class="comment">/*</span>
01594 <span class="comment">     * Allocate a key state update event if needed.</span>
01595 <span class="comment">     */</span>
01596     <span class="keywordflow">if</span> (pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a856">QF_UPDATEKEYSTATE</a>) {
01597         <a class="code" href="../../d4/d1/userk_8h.html#a1235">PostUpdateKeyStateEvent</a>(pq);
01598     }
01599 
01600     <span class="comment">/*</span>
01601 <span class="comment">     * We want to coalesce sequential WM_MOUSEMOVE and WM_MOUSEWHEEL.</span>
01602 <span class="comment">     * WM_MOUSEMOVEs are coalesced by just storing the most recent</span>
01603 <span class="comment">     * event over the last one.</span>
01604 <span class="comment">     * WM_MOUSEWHEELs also add up the wheel rolls.</span>
01605 <span class="comment">     */</span>
01606     <span class="keywordflow">if</span> (pqmsgPrev != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
01607         pqmsgPrev-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message == message &amp;&amp;
01608         (message == WM_MOUSEMOVE || message == WM_MOUSEWHEEL)) {
01609 
01610         <span class="keywordflow">if</span> (message == WM_MOUSEWHEEL) {
01611             sWheelDelta = (<span class="keywordtype">short</span>)HIWORD(wParam) + (<span class="keywordtype">short</span>)HIWORD(pqmsgPrev-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam);
01612 
01613 <span class="preprocessor">#if 0</span>
01614 <span class="preprocessor"></span>            <span class="comment">/*</span>
01615 <span class="comment">             * LATER: We can't remove a wheel message with zero delta</span>
01616 <span class="comment">             * unless we know it hasn't been peeked. Ideally,</span>
01617 <span class="comment">             * we would check idsyspeek for this, but we're too close</span>
01618 <span class="comment">             * to ship and idsyspeek is too fragile. Consider also</span>
01619 <span class="comment">             * checking to see if mouse move messages have been peeked.</span>
01620 <span class="comment">             */</span>
01621 
01622             <span class="keywordflow">if</span> (sWheelDelta == 0) {
01623                 <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a>)pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o3">idSysPeek</a> == pqmsgPrev) {
01624                     RIPMSG0(RIP_VERBOSE,
01625                             <span class="stringliteral">"Coalescing of mouse wheel messages causing "</span>
01626                             <span class="stringliteral">"idSysPeek to be reset to 0"</span>);
01627 
01628                     pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o3">idSysPeek</a> = 0;
01629                 }
01630 
01631                 <a class="code" href="../../d4/d1/userk_8h.html#a1212">DelQEntry</a>(&amp;pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>, pqmsgPrev);
01632                 <span class="keywordflow">return</span>;
01633             }
01634 <span class="preprocessor">#endif</span>
01635 <span class="preprocessor"></span>
01636             wParam = MAKEWPARAM(LOWORD(wParam), sWheelDelta);
01637         }
01638 
01639         <a class="code" href="../../d4/d1/userk_8h.html#a1503">StoreQMessage</a>(pqmsgPrev, pwnd, message, wParam, lParam, time, 0, dwExtraInfo);
01640         <a class="code" href="../../d4/d1/userk_8h.html#a1198">WakeSomeone</a>(pq, message, pqmsgPrev);
01641 
01642         <span class="keywordflow">return</span>;
01643     }
01644 
01645     <span class="comment">/*</span>
01646 <span class="comment">     * Fill in pqmsgInput.</span>
01647 <span class="comment">     */</span>
01648     pqmsgInput = <a class="code" href="../../d4/d1/userk_8h.html#a1210">AllocQEntry</a>(&amp;pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>);
01649     <span class="keywordflow">if</span> (pqmsgInput != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01650         <a class="code" href="../../d4/d1/userk_8h.html#a1503">StoreQMessage</a>(pqmsgInput, pwnd, message, wParam, lParam, time, 0, dwExtraInfo);
01651         <a class="code" href="../../d4/d1/userk_8h.html#a1198">WakeSomeone</a>(pq, message, pqmsgInput);
01652     }
01653 }
01654 
01655 <span class="comment">/***************************************************************************\</span>
01656 <span class="comment">* WakeSomeone</span>
01657 <span class="comment">*</span>
01658 <span class="comment">* Figures out which thread to wake up based on the queue and message.</span>
01659 <span class="comment">* If the queue pointer is NULL, figures out a likely queue.</span>
01660 <span class="comment">*</span>
01661 <span class="comment">* 10-23-92 ScottLu      Created.</span>
01662 <span class="comment">\***************************************************************************/</span>
01663 
<a name="l01664"></a><a class="code" href="../../d4/d1/userk_8h.html#a1198">01664</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1198">WakeSomeone</a>(
01665     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pq,
01666     UINT message,
01667     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsg)
01668 {
01669     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSetLastWoken = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01670     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiT;
01671 
01672     <span class="comment">/*</span>
01673 <span class="comment">     * Set the appropriate wakebits for this queue.</span>
01674 <span class="comment">     */</span>
01675     ptiT = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01676     <span class="keywordflow">switch</span> (message) {
01677 
01678     <span class="keywordflow">case</span> WM_SYSKEYDOWN:
01679     <span class="keywordflow">case</span> WM_KEYDOWN:
01680         <span class="comment">/*</span>
01681 <span class="comment">         * Don't change input ownership if the user is holding down</span>
01682 <span class="comment">         *  a modifier key. When doing a ctrl-drag operation for example,</span>
01683 <span class="comment">         *  the ctrl key must be down when the user drops the object (ie, mouse up).</span>
01684 <span class="comment">         *  On mouse up the RIT gives input ownership to the target; but since</span>
01685 <span class="comment">         *  ctrl is down, on the next repeat key we used to give input ownership</span>
01686 <span class="comment">         *  to the focus window (usually the drag source). Hence the target</span>
01687 <span class="comment">         *  would lose owenerhip and couldn't take the foreground.</span>
01688 <span class="comment">         */</span>
01689         <span class="keywordflow">if</span> (pqmsg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01690             <span class="keywordflow">switch</span> (pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam) {
01691                 <span class="keywordflow">case</span> VK_SHIFT:
01692                 <span class="keywordflow">case</span> VK_CONTROL:
01693                 <span class="keywordflow">case</span> VK_MENU:
01694                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(pq, pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam)) {
01695                         <span class="keywordflow">break</span>;
01696                     }
01697                     <span class="comment">/* Fall through */</span>
01698 
01699                 <span class="keywordflow">default</span>:
01700                     fSetLastWoken = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01701                     <span class="keywordflow">break</span>;
01702             }
01703         } <span class="keywordflow">else</span> {
01704             fSetLastWoken = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01705         }
01706         <span class="comment">/* fall through */</span>
01707 
01708     <span class="keywordflow">case</span> WM_SYSCHAR:
01709     <span class="keywordflow">case</span> WM_CHAR:
01710         <span class="comment">/* Freelance graphics seems to pass in WM_SYSCHARs and WM_CHARs into</span>
01711 <span class="comment">         * the journal playback hook, so we need to set an input bit for</span>
01712 <span class="comment">         * this case since that is what win3.1 does. VB2 "learning" demo does</span>
01713 <span class="comment">         * the same, as does Excel intro.</span>
01714 <span class="comment">         *</span>
01715 <span class="comment">         * On win3.1, the WM_CHAR would by default set the QS_MOUSEBUTTON bit.</span>
01716 <span class="comment">         * On NT, the WM_CHAR sets the QS_KEY bit. This is because</span>
01717 <span class="comment">         * ScanSysQueue() calls TransferWakeBit() with the QS_KEY bit when</span>
01718 <span class="comment">         * a WM_CHAR message is passed in. By using the QS_KEY bit on NT,</span>
01719 <span class="comment">         * we're more compatible with what win3.1 wants to be.</span>
01720 <span class="comment">         *</span>
01721 <span class="comment">         * This fixes a case where the mouse was over progman, the WM_CHAR</span>
01722 <span class="comment">         * would come in via journal playback, wakesomeone would be called,</span>
01723 <span class="comment">         * and set the mouse bit in progman. Progman would then get into</span>
01724 <span class="comment">         * ScanSysQueue(), callback the journal playback hook, get the WM_CHAR,</span>
01725 <span class="comment">         * and do it again, looping. This caught VB2 in a loop.</span>
01726 <span class="comment">         */</span>
01727 
01728         <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a33">CancelForegroundActivate</a>();
01729 
01730         <span class="comment">/* fall through */</span>
01731 
01732     <span class="keywordflow">case</span> WM_KEYUP:
01733     <span class="keywordflow">case</span> WM_SYSKEYUP:
01734     <span class="keywordflow">case</span> WM_MOUSEWHEEL:
01735         <span class="comment">/*</span>
01736 <span class="comment">         * Win3.1 first looks at what thread has the active status. This</span>
01737 <span class="comment">         * means that we don't depend on the thread owning ptiKeyboard</span>
01738 <span class="comment">         * to wake up and process this key in order to give it to the</span>
01739 <span class="comment">         * active window, which is potentially newly active. Case in</span>
01740 <span class="comment">         * point: excel bringing up CBT, cbt has an error, brings up</span>
01741 <span class="comment">         * a message box: since excel is filtering for CBT messages only,</span>
01742 <span class="comment">         * ptiKeyboard never gets reassigned to CBT so CBT doesn't get</span>
01743 <span class="comment">         * any key messages and appears hung.</span>
01744 <span class="comment">         */</span>
01745         ptiT = pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a>;
01746         <span class="keywordflow">if</span> (pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01747             ptiT = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>);
01748 
01749         <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(ptiT, message == WM_MOUSEWHEEL ? QS_MOUSEBUTTON : QS_KEY);
01750         <span class="keywordflow">break</span>;
01751 
01752     <span class="keywordflow">case</span> WM_MOUSEMOVE:
01753         <span class="comment">/*</span>
01754 <span class="comment">         * Make sure we wake up the thread with the capture, if there is</span>
01755 <span class="comment">         * one. This fixes PC Tools screen capture program, which sets</span>
01756 <span class="comment">         * capture and then loops trying to remove messages from the</span>
01757 <span class="comment">         * queue.</span>
01758 <span class="comment">         */</span>
01759         <span class="keywordflow">if</span> (pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01760             ptiT = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a>);
01761         <span class="keywordflow">else</span>
01762             ptiT = pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o4">ptiMouse</a>;
01763         <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(ptiT, QS_MOUSEMOVE);
01764         <span class="keywordflow">break</span>;
01765 
01766 
01767     <span class="keywordflow">case</span> WM_LBUTTONDOWN:
01768     <span class="keywordflow">case</span> WM_LBUTTONDBLCLK:
01769     <span class="keywordflow">case</span> WM_RBUTTONDOWN:
01770     <span class="keywordflow">case</span> WM_RBUTTONDBLCLK:
01771     <span class="keywordflow">case</span> WM_MBUTTONDOWN:
01772     <span class="keywordflow">case</span> WM_MBUTTONDBLCLK:
01773     <span class="keywordflow">case</span> WM_XBUTTONDOWN:
01774     <span class="keywordflow">case</span> WM_XBUTTONDBLCLK:
01775             fSetLastWoken = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01776 
01777         <span class="comment">/* fall through */</span>
01778 
01779     <span class="keywordflow">default</span>:
01780         <span class="comment">/*</span>
01781 <span class="comment">         * The default case in Win3.1 for this is QS_MOUSEBUTTON.</span>
01782 <span class="comment">         */</span>
01783 
01784         <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a33">CancelForegroundActivate</a>();
01785 
01786         <span class="comment">/* fall through */</span>
01787 
01788     <span class="keywordflow">case</span> WM_LBUTTONUP:
01789     <span class="keywordflow">case</span> WM_RBUTTONUP:
01790     <span class="keywordflow">case</span> WM_MBUTTONUP:
01791     <span class="keywordflow">case</span> WM_XBUTTONUP:
01792         <span class="comment">/*</span>
01793 <span class="comment">         * Make sure we wake up the thread with the capture, if there is</span>
01794 <span class="comment">         * one. This fixes PC Tools screen capture program, which sets</span>
01795 <span class="comment">         * capture and then loops trying to remove messages from the</span>
01796 <span class="comment">         * queue.</span>
01797 <span class="comment">         */</span>
01798         <span class="keywordflow">if</span> (pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
01799                 message &gt;= WM_MOUSEFIRST &amp;&amp; message &lt;= WM_MOUSELAST)
01800             ptiT = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a>);
01801         <span class="keywordflow">else</span>
01802             ptiT = pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o4">ptiMouse</a>;
01803         <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(ptiT, QS_MOUSEBUTTON);
01804         <span class="keywordflow">break</span>;
01805     }
01806 
01807     <span class="comment">/*</span>
01808 <span class="comment">     * If a messaged was passed in, remember in it who we woke up for this</span>
01809 <span class="comment">     * message. We do this so each message is ownership marked. This way</span>
01810 <span class="comment">     * we can merge/unmerge message streams when zzzAttachThreadInput() is</span>
01811 <span class="comment">     * called.</span>
01812 <span class="comment">     */</span>
01813     <span class="keywordflow">if</span> (ptiT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01814         <span class="keywordflow">if</span> (pqmsg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01815 
01816             <a class="code" href="../../d4/d1/userk_8h.html#a1504">StoreQMessagePti</a>(pqmsg, ptiT);
01817 
01818             UserAssert(!(ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>));
01819         }
01820 
01821         <span class="comment">/*</span>
01822 <span class="comment">         * Remember who got the last key/click down.</span>
01823 <span class="comment">         */</span>
01824         <span class="keywordflow">if</span> (fSetLastWoken) {
01825             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o2">ptiLastWoken</a> = ptiT;
01826         }
01827     }
01828 
01829 }
01830 
01831 
01832 <span class="comment">/***************************************************************************\</span>
01833 <span class="comment">* PostUpdateKeyStateEvent</span>
01834 <span class="comment">*</span>
01835 <span class="comment">* This routine posts an event which updates the local thread's keystate</span>
01836 <span class="comment">* table. This makes sure the thread's key state is always up-to-date.</span>
01837 <span class="comment">*</span>
01838 <span class="comment">* An example is: control-esc from cmd to taskman.</span>
01839 <span class="comment">* Control goes to cmd, but taskman is activated. Control state is still down</span>
01840 <span class="comment">* in cmd - switch back to cmd, start typing, nothing appears because it thinks</span>
01841 <span class="comment">* the control state is still down.</span>
01842 <span class="comment">*</span>
01843 <span class="comment">* As events go into a particular queue (queue A), the async key state table is</span>
01844 <span class="comment">* updated. As long as transition events are put into queue A, the key</span>
01845 <span class="comment">* state at the logical "end of the queue" is up-to-date with the async key</span>
01846 <span class="comment">* state. As soon as the user posts transition events (up/down msgs) into queue</span>
01847 <span class="comment">* B, the queue A's end-of-queue key state is out of date with the user. If</span>
01848 <span class="comment">* the user then again added messages to queue A, when those messages are read</span>
01849 <span class="comment">* the thread specific key state would not be updated correctly unless we</span>
01850 <span class="comment">* did some synchronization (which this routine helps to do).</span>
01851 <span class="comment">*</span>
01852 <span class="comment">* As soon as transition events change queues, we go mark all the other queues</span>
01853 <span class="comment">* with the QF_UPDATEKEYSTATE flag. Before any input event is posted into</span>
01854 <span class="comment">* a queue, this flag is checked, and if set, this routine is called. This</span>
01855 <span class="comment">* routine makes a copy of the async key state, and a copy of the bits</span>
01856 <span class="comment">* representing the keys that have changed since the last update (we need to</span>
01857 <span class="comment">* keep track of which keys have changed so that any state set by the</span>
01858 <span class="comment">* app with SetKeyboardState() doesn't get wiped out). We take this data</span>
01859 <span class="comment">* and post a new event of the type QEVENT_UPDATEKEYSTATE, which points to this</span>
01860 <span class="comment">* key state and transition information. When this message is read out of the</span>
01861 <span class="comment">* queue, this key state copy is copied into the thread specific key state</span>
01862 <span class="comment">* table for those keys that have changed, and the copy is deallocated.</span>
01863 <span class="comment">*</span>
01864 <span class="comment">* This ensures all queues are input-synchronized with key transitions no matter</span>
01865 <span class="comment">* where they occur. The side affect of this is that an application may suddenly</span>
01866 <span class="comment">* have a key be up without seeing the up message. If this causes any problems</span>
01867 <span class="comment">* we may have to generate false transition messages (this could have more nasty</span>
01868 <span class="comment">* side affects as well, so it needs to be considered closely before being</span>
01869 <span class="comment">* implemented.)</span>
01870 <span class="comment">*</span>
01871 <span class="comment">* 06-07-91 ScottLu      Created.</span>
01872 <span class="comment">\***************************************************************************/</span>
01873 
<a name="l01874"></a><a class="code" href="../../d4/d1/userk_8h.html#a1235">01874</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1235">PostUpdateKeyStateEvent</a>(
01875     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pq)
01876 {
01877     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *pb;
01878     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsg;
01879 
01880     <span class="keywordflow">if</span> (!(pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a856">QF_UPDATEKEYSTATE</a>))
01881         <span class="keywordflow">return</span>;
01882 
01883     <span class="comment">/*</span>
01884 <span class="comment">     * Exclude the RIT - it's queue is never read, so don't waste memory</span>
01885 <span class="comment">     */</span>
01886     <span class="keywordflow">if</span> (pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>) {
01887         <span class="keywordflow">return</span>;
01888     }
01889 
01890     <span class="comment">/*</span>
01891 <span class="comment">     * If there's no mousebutton or keystroke input pending, process the</span>
01892 <span class="comment">     * UpdateKeyState Event now: thus saving memory allocation and giving</span>
01893 <span class="comment">     * applications the correct KeyState immediately.</span>
01894 <span class="comment">     * NOTE: There may be event/activation msgs in pq-&gt;mlInput that don't</span>
01895 <span class="comment">     * affect keystate, so I'd like to just test QS_KEY | QS_MOUSEBUTTON</span>
01896 <span class="comment">     * specifically, instead of the cMsgss.  However, sometimes there are</span>
01897 <span class="comment">     * keystroke or mousebutton msgs in the q without those bits set! - IanJa</span>
01898 <span class="comment">     */</span>
01899     <span class="keywordflow">if</span> (pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>.<a class="code" href="../../d6/d1/structtagMLIST.html#o2">cMsgs</a> == 0) {
01900         <a class="code" href="../../d4/d1/userk_8h.html#a1236">ProcessUpdateKeyStateEvent</a>(pq, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a222">gafAsyncKeyState</a>, pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o16">afKeyRecentDown</a>);
01901         <span class="keywordflow">goto</span> SyncQueue;
01902     }
01903 <span class="preprocessor">#if DBG</span>
01904 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((!pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a> || !(pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a> &amp; QS_KEY)) &amp;&amp;
01905              (!pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o4">ptiMouse</a>    || !(pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o4">ptiMouse</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a> &amp; QS_MOUSEBUTTON))) {
01906         <span class="comment">/*</span>
01907 <span class="comment">         * See if there are any key or mousebutton messages that aren't</span>
01908 <span class="comment">         * indicated by QS_KEY or QS_MOUSEBUTTON bits.</span>
01909 <span class="comment">         */</span>
01910         <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsgT;
01911         <span class="keywordflow">for</span> (pqmsgT = pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>.<a class="code" href="../../d6/d1/structtagMLIST.html#o0">pqmsgRead</a>; pqmsgT; pqmsgT = pqmsgT-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o0">pqmsgNext</a>) {
01912             <span class="keywordflow">if</span> (pqmsgT-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message &gt;= WM_KEYFIRST &amp;&amp; pqmsgT-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message &lt;= WM_KEYLAST) {
01913                 TAGMSG1(DBGTAG_InputWithoutQS,
01914                         <span class="stringliteral">"PostUpdateKeyStateEvent() pushing in front of a keystroke: Q %#p"</span>, pq);
01915             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pqmsgT-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message &gt;= WM_LBUTTONDOWN &amp;&amp; pqmsgT-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message &lt;= WM_XBUTTONDBLCLK) {
01916                 TAGMSG1(DBGTAG_InputWithoutQS,
01917                         <span class="stringliteral">"PostUpdateKeyStateEvent() pushing in front of a mousebutton: Q %#p"</span>, pq);
01918             }
01919         }
01920     }
01921 <span class="preprocessor">#endif</span>
01922 <span class="preprocessor"></span>
01923     UserAssert(pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>.<a class="code" href="../../d6/d1/structtagMLIST.html#o1">pqmsgWriteLast</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01924 
01925     <span class="comment">/*</span>
01926 <span class="comment">     * If the last input message is an UPDATEKEYSTATE event, coalesce with it.</span>
01927 <span class="comment">     * (Prevents big memory leaks on apps that don't read input messages)</span>
01928 <span class="comment">     */</span>
01929     pqmsg = pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>.<a class="code" href="../../d6/d1/structtagMLIST.html#o1">pqmsgWriteLast</a>;
01930     <span class="keywordflow">if</span> (pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o4">dwQEvent</a> == <a class="code" href="../../d4/d1/userk_8h.html#a337">QEVENT_UPDATEKEYSTATE</a>) {
01931         <span class="keywordtype">int</span> i;
01932         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *pdw;
01933 
01934         pb = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)(pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam);
01935         pdw = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *) (pb + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a825">CBKEYSTATE</a>);
01936 
01937         <span class="comment">/*</span>
01938 <span class="comment">         * Copy in the new key state</span>
01939 <span class="comment">         */</span>
01940         RtlCopyMemory(pb, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a222">gafAsyncKeyState</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a825">CBKEYSTATE</a>);
01941 
01942         <span class="comment">/*</span>
01943 <span class="comment">         * Or in the recent key down state (DWORD at a time)</span>
01944 <span class="comment">         */</span>
01945 <span class="preprocessor">#if (CBKEYSTATERECENTDOWN % 4) != 0</span>
01946 <span class="preprocessor"></span><span class="preprocessor">#error "CBKEYSTATERECENTDOWN assumed to be an integral number of DWORDs"</span>
01947 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01948 <span class="preprocessor"></span>        <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a826">CBKEYSTATERECENTDOWN</a> / <span class="keyword">sizeof</span>(*pdw); i++) {
01949             *pdw++ |= ((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)(pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o16">afKeyRecentDown</a>))[i];
01950         }
01951 
01952         <span class="comment">/*</span>
01953 <span class="comment">         * Set QS_EVENTSET as in PostEventMessage, although this is</span>
01954 <span class="comment">         * usually, but not always already set</span>
01955 <span class="comment">         */</span>
01956         <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a>, QS_EVENTSET);
01957         <span class="keywordflow">goto</span> SyncQueue;
01958     }
01959 
01960     <span class="comment">/*</span>
01961 <span class="comment">     * Make a copy of the async key state buffer, point to it, and add an</span>
01962 <span class="comment">     * event to the end of the input queue.</span>
01963 <span class="comment">     */</span>
01964     <span class="keywordflow">if</span> ((pb = UserAllocPool(<a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a3">KEYSTATESIZE</a>, TAG_KBDSTATE)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01965         <span class="keywordflow">return</span>;
01966     }
01967 
01968     RtlCopyMemory(pb, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a222">gafAsyncKeyState</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a825">CBKEYSTATE</a>);
01969     RtlCopyMemory(pb + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a825">CBKEYSTATE</a>, pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o16">afKeyRecentDown</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a826">CBKEYSTATERECENTDOWN</a>);
01970 
01971     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1217">PostEventMessage</a>(pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a>, pq, <a class="code" href="../../d4/d1/userk_8h.html#a337">QEVENT_UPDATEKEYSTATE</a>,
01972                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0 , (WPARAM)pb, 0)) {
01973         UserFreePool(pb);
01974         <span class="keywordflow">return</span>;
01975     }
01976 
01977     <span class="comment">/*</span>
01978 <span class="comment">     * The key state of the queue is input-synchronized with the user.  Erase</span>
01979 <span class="comment">     * all 'recent down' flags.</span>
01980 <span class="comment">     */</span>
01981 SyncQueue:
01982     RtlZeroMemory(pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o16">afKeyRecentDown</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a826">CBKEYSTATERECENTDOWN</a>);
01983     pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a856">QF_UPDATEKEYSTATE</a>;
01984 }
01985 
01986 
01987 <span class="comment">/***************************************************************************\</span>
01988 <span class="comment">* ProcessUpdateKeyStateEvent</span>
01989 <span class="comment">*</span>
01990 <span class="comment">* This is part two of the above routine, called when the QEVENT_UPDATEKEYSTATE</span>
01991 <span class="comment">* message is read out of the input queue.</span>
01992 <span class="comment">*</span>
01993 <span class="comment">* 06-07-91 ScottLu      Created.</span>
01994 <span class="comment">\***************************************************************************/</span>
01995 
<a name="l01996"></a><a class="code" href="../../d4/d1/userk_8h.html#a1236">01996</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1236">ProcessUpdateKeyStateEvent</a>(
01997     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pq,
01998     CONST PBYTE pbKeyState,
01999     CONST PBYTE pbRecentDown)
02000 {
02001     <span class="keywordtype">int</span> i, j;
02002     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *pbChange;
02003     <span class="keywordtype">int</span> vk;
02004 
02005     pbChange = pbRecentDown;
02006     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a826">CBKEYSTATERECENTDOWN</a>; i++, pbChange++) {
02007 
02008         <span class="comment">/*</span>
02009 <span class="comment">         * Find some keys that have changed.</span>
02010 <span class="comment">         */</span>
02011         <span class="keywordflow">if</span> (*pbChange == 0)
02012             <span class="keywordflow">continue</span>;
02013 
02014         <span class="comment">/*</span>
02015 <span class="comment">         * Some keys have changed in this byte.  find out which key it is.</span>
02016 <span class="comment">         */</span>
02017         <span class="keywordflow">for</span> (j = 0; j &lt; 8; j++) {
02018 
02019             <span class="comment">/*</span>
02020 <span class="comment">             * Convert our counts to a virtual key index and check to see</span>
02021 <span class="comment">             * if this key has changed.</span>
02022 <span class="comment">             */</span>
02023             vk = (i &lt;&lt; 3) + j;
02024             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a834">TestKeyRecentDownBit</a>(pbRecentDown, vk))
02025                 <span class="keywordflow">continue</span>;
02026 
02027             <span class="comment">/*</span>
02028 <span class="comment">             * This key has changed.  Update it's state in the thread key</span>
02029 <span class="comment">             * state table.</span>
02030 <span class="comment">             */</span>
02031 
02032             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a827">TestKeyDownBit</a>(pbKeyState, vk)) {
02033                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a838">SetKeyStateDown</a>(pq, vk);
02034             } <span class="keywordflow">else</span> {
02035                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a839">ClearKeyStateDown</a>(pq, vk);
02036             }
02037 
02038             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a830">TestKeyToggleBit</a>(pbKeyState, vk)) {
02039                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a841">SetKeyStateToggle</a>(pq, vk);
02040             } <span class="keywordflow">else</span> {
02041                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a842">ClearKeyStateToggle</a>(pq, vk);
02042             }
02043         }
02044     }
02045 
02046     <span class="comment">/*</span>
02047 <span class="comment">     * Update the key cache index.</span>
02048 <span class="comment">     */</span>
02049     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;dwKeyCache++;
02050 
02051     <span class="comment">/*</span>
02052 <span class="comment">     * All updated.  Free the key state table if it was posted as an Event Message</span>
02053 <span class="comment">     */</span>
02054     <span class="keywordflow">if</span> (pbKeyState != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a222">gafAsyncKeyState</a>) {
02055         UserFreePool(pbKeyState);
02056     }
02057 }
02058 
02059 
02060 <span class="comment">/***************************************************************************\</span>
02061 <span class="comment">* PostEventMessage</span>
02062 <span class="comment">*</span>
02063 <span class="comment">*</span>
02064 <span class="comment">* History:</span>
02065 <span class="comment">* 03-04-91 DavidPe      Created.</span>
02066 <span class="comment">\***************************************************************************/</span>
02067 
<a name="l02068"></a><a class="code" href="../../d4/d1/userk_8h.html#a1217">02068</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1217">PostEventMessage</a>(
02069     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti,
02070     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a>    pq,
02071     DWORD dwQEvent,
02072     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwnd,
02073     UINT  message,
02074     WPARAM wParam,
02075     LPARAM lParam)
02076 {
02077     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsgEvent;
02078 
02079     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
02080 
02081     <span class="comment">/*</span>
02082 <span class="comment">     * If the thread is in cleanup, then it's possible the queue has</span>
02083 <span class="comment">     * already been removed for this thread.  If this is the case, then</span>
02084 <span class="comment">     * we should fail to post the event to a dying thread.</span>
02085 <span class="comment">     */</span>
02086     <span class="keywordflow">if</span> (pti &amp;&amp; (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>))
02087         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02088 
02089     <span class="keywordflow">if</span> ((pqmsgEvent = <a class="code" href="../../d4/d1/userk_8h.html#a1210">AllocQEntry</a>(&amp;pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02090         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02091 
02092     <a class="code" href="../../d4/d1/userk_8h.html#a1503">StoreQMessage</a>(pqmsgEvent, pwnd, message, wParam, lParam, 0, dwQEvent, 0);
02093 
02094     <a class="code" href="../../d4/d1/userk_8h.html#a1504">StoreQMessagePti</a>(pqmsgEvent, pti);
02095 
02096     <span class="comment">/*</span>
02097 <span class="comment">     * Let this thread know it has an event message to process.</span>
02098 <span class="comment">     */</span>
02099     <span class="keywordflow">if</span> (pti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02100         UserAssert(pti);
02101         <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o4">ptiMouse</a>, QS_EVENTSET);
02102         <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a>, QS_EVENTSET);
02103     } <span class="keywordflow">else</span> {
02104         <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(pti, QS_EVENTSET);
02105     }
02106 
02107     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02108 }
02109 
02110 <span class="comment">/***************************************************************************\</span>
02111 <span class="comment">* CheckOnTop</span>
02112 <span class="comment">*</span>
02113 <span class="comment">* Usually windows come to the top and activate all at once. Occasionally, a</span>
02114 <span class="comment">* starting app will create a window, pause for awhile, then make itself</span>
02115 <span class="comment">* visible. During that pause, if the user clicks down, the window won't be</span>
02116 <span class="comment">* allowed to activate (because of our foreground activation model). But this</span>
02117 <span class="comment">* still leaves the new window on top of the active window. When this click</span>
02118 <span class="comment">* happens, we get here: if this window is active and is not on top, bring it</span>
02119 <span class="comment">* to the top.</span>
02120 <span class="comment">*</span>
02121 <span class="comment">* Case in point: start winquote, click down. The window</span>
02122 <span class="comment">* you clicked on is active, but winquote is on top.</span>
02123 <span class="comment">*</span>
02124 <span class="comment">* This rarely does anything because 99.99% of the time the active</span>
02125 <span class="comment">* window is already where it should be - on top. Note that</span>
02126 <span class="comment">* CalcForegroundInsertAfter() takes into account owner-based zordering.</span>
02127 <span class="comment">*</span>
02128 <span class="comment">*</span>
02129 <span class="comment">* NOTE: the following was the original function written.  However, this</span>
02130 <span class="comment">*       function has been disabled for now.  in WinWord and Excel especially,</span>
02131 <span class="comment">*       this tends to cause savebits to be blown-away on mouse-activation of</span>
02132 <span class="comment">*       its dialog-boxes.  This could be a problem with GW_HWNDPREV and/or</span>
02133 <span class="comment">*       CalcForground not being the same, which causes a SetWindowPos to be</span>
02134 <span class="comment">*       called, resulting in the freeing of the SPB.  This also solves a</span>
02135 <span class="comment">*       problem with the ComboBoxes in MsMoney hiding/freeing the dropdown</span>
02136 <span class="comment">*       listbox on activation as well.</span>
02137 <span class="comment">*</span>
02138 <span class="comment">* We need this for ActiveWindowTracking support. xxxBringWindowToTop used to be a call</span>
02139 <span class="comment">*  to SetWindowPos but now it's gone.</span>
02140 <span class="comment">*</span>
02141 <span class="comment">* It returns TRUE if the window was brought the top; if no z-order change</span>
02142 <span class="comment">*  took place, it returns FALSE.</span>
02143 <span class="comment">*</span>
02144 <span class="comment">* 05-20-93 ScottLu      Created.</span>
02145 <span class="comment">* 10-17-94 ChrisWil     Made into stub-macro.</span>
02146 <span class="comment">* 05-30-96 GerardoB     Brought it back to live for AWT</span>
02147 <span class="comment">\***************************************************************************/</span>
<a name="l02148"></a><a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a40">02148</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a40">CheckOnTop</a>(<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti, <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndTop, UINT message)
02149 {
02150     <span class="keywordflow">if</span> (pwndTop != pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>)
02151         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02152 
02153     <span class="keywordflow">switch</span> (message) {
02154         <span class="keywordflow">case</span> WM_LBUTTONDOWN:
02155         <span class="keywordflow">case</span> WM_RBUTTONDOWN:
02156         <span class="keywordflow">case</span> WM_MBUTTONDOWN:
02157         <span class="keywordflow">case</span> WM_XBUTTONDOWN:
02158             <span class="keywordflow">if</span> (   <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndTop, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>)
02159                     || (<a class="code" href="../../d6/d9/rtl_2wow_8c.html#a13">_GetWindow</a>(pwndTop, GW_HWNDPREV) != <a class="code" href="../../d4/d1/userk_8h.html#a1614">CalcForegroundInsertAfter</a>(pwndTop))) {
02160 
02161                  <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pwndTop, <a class="code" href="../../d4/d1/userk_8h.html#a452">PWND_TOP</a>, 0, 0, 0, 0,
02162                         SWP_NOSIZE | SWP_NOMOVE | SWP_NOACTIVATE);
02163              }
02164              <span class="keywordflow">break</span>;
02165     }
02166 
02167     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02168 }
02169 
02170 
<a name="l02171"></a><a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a7">02171</a> <span class="preprocessor">#define MA_PASSTHRU     0</span>
<a name="l02172"></a><a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a8">02172</a> <span class="preprocessor"></span><span class="preprocessor">#define MA_SKIP         1</span>
<a name="l02173"></a><a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a9">02173</a> <span class="preprocessor"></span><span class="preprocessor">#define MA_REHITTEST    2</span>
02174 <span class="preprocessor"></span>
02175 <span class="comment">/***************************************************************************\</span>
02176 <span class="comment">* zzzActiveCursorTracking</span>
02177 <span class="comment">*</span>
02178 <span class="comment">* If active window tracking is enabled, activation follows</span>
02179 <span class="comment">*  the mouse. If the mouse is NOT on the active window</span>
02180 <span class="comment">* (i.e., it was activated by a keyboard operation),</span>
02181 <span class="comment">*  activation will change as soon as the mouse moves.</span>
02182 <span class="comment">* So we have to make sure the mouse is on the active window.</span>
02183 <span class="comment">*</span>
02184 <span class="comment">* History</span>
02185 <span class="comment">* 12/07/96  GerardoB  Created</span>
02186 <span class="comment">\***************************************************************************/</span>
<a name="l02187"></a><a class="code" href="../../d4/d1/userk_8h.html#a1653">02187</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1653">zzzActiveCursorTracking</a> (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
02188 {
02189     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fVisible;
02190     POINT pt;
02191 
02192     <span class="comment">/*</span>
02193 <span class="comment">     * If the last input event wasn't from the keyboard, bail</span>
02194 <span class="comment">     * The user is probably moving the mouse.</span>
02195 <span class="comment">     */</span>
02196     <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o1">dwFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a376">LINP_KEYBOARD</a>)) {
02197         <span class="keywordflow">return</span>;
02198     }
02199     <span class="comment">/*</span>
02200 <span class="comment">     * If we're already there, bail.</span>
02201 <span class="comment">     */</span>
02202     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>((LPRECT)&amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a79">gptCursorAsync</a>)) {
02203         <span class="keywordflow">return</span>;
02204     }
02205     <span class="comment">/*</span>
02206 <span class="comment">     * If the window the mouse is on is not "active-trackable", then</span>
02207 <span class="comment">     *  we can leave the mouse right where it is</span>
02208 <span class="comment">     */</span>
02209      <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a108">gspwndCursor</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (<a class="code" href="../../d4/d1/userk_8h.html#a1654">GetActiveTrackPwnd</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a108">gspwndCursor</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02210          <span class="keywordflow">return</span>;
02211      }
02212      <span class="comment">/*</span>
02213 <span class="comment">      * If this window doesn't have a point visible in the screen, bail</span>
02214 <span class="comment">      */</span>
02215      pt.x = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left + ((pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right  - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left) / 2);
02216      pt.y = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top  + ((pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.bottom - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top)  / 2);
02217      <a class="code" href="../../d4/d1/userk_8h.html#a1182">BoundCursor</a>(&amp;pt);
02218      <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>((LPRECT)&amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>, pt)) {
02219          <span class="keywordflow">return</span>;
02220      }
02221     <span class="comment">/*</span>
02222 <span class="comment">     * We need to make sure that this window is marked as visible or someone</span>
02223 <span class="comment">     *  else will be waken up to update the cursor (and might</span>
02224 <span class="comment">     *  activate itself because of the active tracking).</span>
02225 <span class="comment">     *</span>
02226 <span class="comment">     * Later5.0 GerardoB: If the window is still not visible when</span>
02227 <span class="comment">     *  it wakes up, then we're out of luck.</span>
02228 <span class="comment">     */</span>
02229     fVisible = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>);
02230     <span class="keywordflow">if</span> (!fVisible) {
02231         <a class="code" href="../../d4/d1/userk_8h.html#a1626">SetVisible</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a751">SV_SET</a>);
02232     }
02233 
02234     <span class="comment">/*</span>
02235 <span class="comment">     * Move the cursor to the center of this window</span>
02236 <span class="comment">     */</span>
02237     <a class="code" href="../../d4/d1/userk_8h.html#a1179">zzzInternalSetCursorPos</a>(pt.x, pt.y);
02238     <span class="comment">/*</span>
02239 <span class="comment">     * Restore visible bit.</span>
02240 <span class="comment">     */</span>
02241     <span class="keywordflow">if</span> (!fVisible) {
02242         <a class="code" href="../../d4/d1/userk_8h.html#a1626">SetVisible</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a750">SV_UNSET</a>);
02243     }
02244 }
02245 <span class="comment">/***************************************************************************\</span>
02246 <span class="comment">* GetActiveTrackPwnd</span>
02247 <span class="comment">*</span>
02248 <span class="comment">* History</span>
02249 <span class="comment">* 12/07/96  GerardoB  Extracted from xxxActiveWindowTracking.</span>
02250 <span class="comment">\***************************************************************************/</span>
<a name="l02251"></a><a class="code" href="../../d4/d1/userk_8h.html#a1654">02251</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d4/d1/userk_8h.html#a1654">GetActiveTrackPwnd</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, <a class="code" href="../../d7/d4/structtagQ.html">Q</a> **ppq)
02252 {
02253     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndActivate;
02254     <a class="code" href="../../d7/d4/structtagQ.html">Q</a> *pq;
02255 
02256     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
02257     pwndActivate = pwnd;
02258 
02259     <span class="comment">/*</span>
02260 <span class="comment">     * Find the top parent</span>
02261 <span class="comment">     */</span>
02262     <span class="keywordflow">while</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwndActivate)) {
02263         pwndActivate = pwndActivate-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
02264     }
02265 
02266     <span class="comment">/*</span>
02267 <span class="comment">     * If disabled, get a enabled popup owned by it.</span>
02268 <span class="comment">     */</span>
02269     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndActivate, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a651">WFDISABLED</a>)) {
02270         <span class="comment">/*</span>
02271 <span class="comment">         * This is what we do elsewhere when someone clicks on a</span>
02272 <span class="comment">         *  disabled non-active window. It might be cheaper to check</span>
02273 <span class="comment">         *  pwnd-&gt;spwndLastActive first (we might need to walk up</span>
02274 <span class="comment">         *  the owner chain though, as this is where we set spwndLastAcitve</span>
02275 <span class="comment">         *  when activating a new window. see xxxActivateThisWindow).</span>
02276 <span class="comment">         * But let's do the same here; this should be fixed/improved</span>
02277 <span class="comment">         *  in DWP_GetEnabledPopup anyway. There might be a reason</span>
02278 <span class="comment">         *  why we don't grab spwndLastActive if OK.... perhaps it has</span>
02279 <span class="comment">         *  something to do with nested owner windows</span>
02280 <span class="comment">         */</span>
02281          pwndActivate = <a class="code" href="../../d4/d1/userk_8h.html#a1633">DWP_GetEnabledPopup</a>(pwndActivate);
02282     }
02283 
02284     <span class="comment">/*</span>
02285 <span class="comment">     * Bail if we didn't find a visible window</span>
02286 <span class="comment">     */</span>
02287     <span class="keywordflow">if</span> ((pwndActivate == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndActivate, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)) {
02288         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02289     }
02290 
02291     <span class="comment">/*</span>
02292 <span class="comment">     * If already active in the foreground queue, nothing to do</span>
02293 <span class="comment">     * Don't activate the modeless menu notification window (it would</span>
02294 <span class="comment">     *  dismiss the menu)</span>
02295 <span class="comment">     */</span>
02296     pq = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndActivate)-&gt;pq;
02297     <span class="keywordflow">if</span> ((pq == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>)
02298             &amp;&amp; ((pwndActivate == pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>)
02299                 || <a class="code" href="../../d4/d1/userk_8h.html#a1328">IsModelessMenuNotificationWindow</a>(pwndActivate))) {
02300 
02301         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02302     }
02303 
02304     <span class="comment">/*</span>
02305 <span class="comment">     * Don't activate the shell window.</span>
02306 <span class="comment">     */</span>
02307     <span class="keywordflow">if</span> (pwndActivate == pwndActivate-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk-&gt;pDeskInfo-&gt;spwndShell) {
02308         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02309     }
02310 
02311     <span class="comment">/*</span>
02312 <span class="comment">     * Return the queue if requested</span>
02313 <span class="comment">     */</span>
02314     <span class="keywordflow">if</span> (ppq != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02315         *ppq = pq;
02316     }
02317 
02318     <span class="keywordflow">return</span> pwndActivate;
02319 }
02320 <span class="comment">/***************************************************************************\</span>
02321 <span class="comment">* xxxActivateWindowTracking</span>
02322 <span class="comment">*</span>
02323 <span class="comment">* Activates a window without z-ordering it to the top</span>
02324 <span class="comment">*</span>
02325 <span class="comment">* 06/05/96  GerardoB  Created</span>
02326 <span class="comment">\***************************************************************************/</span>
<a name="l02327"></a><a class="code" href="../../d4/d1/userk_8h.html#a1655">02327</a> <span class="keywordtype">int</span> <a class="code" href="../../d4/d1/userk_8h.html#a1655">xxxActiveWindowTracking</a>(
02328     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
02329     UINT uMsg,
02330     <span class="keywordtype">int</span> iHitTest)
02331 {
02332 
02333     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSuccess;
02334     <span class="keywordtype">int</span> iRet;
02335     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndActivate;
02336     <a class="code" href="../../d7/d4/structtagQ.html">Q</a> *pq;
02337     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndActivate;
02338 
02339     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
02340     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a563">TestUP</a>(ACTIVEWINDOWTRACKING));
02341 
02342     <span class="comment">/*</span>
02343 <span class="comment">     * If the mouse hasn't been long enough on this queue, bail.</span>
02344 <span class="comment">     */</span>
02345     pq = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq;
02346     <span class="keywordflow">if</span> (!(pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a870">QF_ACTIVEWNDTRACKING</a>)) {
02347         <span class="keywordflow">return</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a7">MA_PASSTHRU</a>;
02348     }
02349     pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a870">QF_ACTIVEWNDTRACKING</a>;
02350 
02351     <span class="comment">/*</span>
02352 <span class="comment">     * If the foreground is locked, bail</span>
02353 <span class="comment">     */</span>
02354     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a2025">IsForegroundLocked</a>()) {
02355         <span class="keywordflow">return</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a7">MA_PASSTHRU</a>;
02356     }
02357 
02358     <span class="comment">/*</span>
02359 <span class="comment">     * Get the window we need to activate. If none, bail.</span>
02360 <span class="comment">     */</span>
02361     pwndActivate = <a class="code" href="../../d4/d1/userk_8h.html#a1654">GetActiveTrackPwnd</a>(pwnd, &amp;pq);
02362     <span class="keywordflow">if</span> (pwndActivate == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02363         <span class="keywordflow">return</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a7">MA_PASSTHRU</a>;
02364     }
02365 
02366     <span class="comment">/*</span>
02367 <span class="comment">     * Lock if needed because we're about to callback</span>
02368 <span class="comment">     */</span>
02369     <span class="keywordflow">if</span> (pwnd != pwndActivate) {
02370         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwndActivate, &amp;tlpwndActivate);
02371     }
02372 
02373     <span class="comment">/*</span>
02374 <span class="comment">     * Let's ask if it's OK to do this</span>
02375 <span class="comment">     *</span>
02376 <span class="comment">     * This message is supposed to go to the window the mouse is on.</span>
02377 <span class="comment">     * This could be a child window which might return MA_NOACTIVATE*.</span>
02378 <span class="comment">     * For mouse clicks (which is what we want to emulate here)</span>
02379 <span class="comment">     *  xxxButtonEvent calls xxxSetForegroundWindow2 so their</span>
02380 <span class="comment">     *  pwndActivate gets brought to the foreground regardless.</span>
02381 <span class="comment">     * So we send the message to pwndActivate instead.</span>
02382 <span class="comment">     */</span>
02383     iRet = (<span class="keywordtype">int</span>)<a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndActivate, WM_MOUSEACTIVATE,
02384             (WPARAM)(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwndActivate)), MAKELONG((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)iHitTest, uMsg));
02385 
02386 
02387     <span class="keywordflow">switch</span> (iRet) {
02388         <span class="keywordflow">case</span> MA_ACTIVATE:
02389         <span class="keywordflow">case</span> MA_ACTIVATEANDEAT:
02390             <span class="keywordflow">if</span> (pq == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>) {
02391                 fSuccess = <a class="code" href="../../d4/d1/userk_8h.html#a1229">xxxActivateThisWindow</a>(pwndActivate, 0,
02392                         (<a class="code" href="../../d4/d1/userk_8h.html#a563">TestUP</a>(ACTIVEWNDTRKZORDER) ? 0 : <a class="code" href="../../d4/d1/userk_8h.html#a514">ATW_NOZORDER</a>));
02393             } <span class="keywordflow">else</span> {
02394                 fSuccess = <a class="code" href="../../d4/d1/userk_8h.html#a1225">xxxSetForegroundWindow2</a>(pwndActivate, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02395                         <a class="code" href="../../d4/d1/userk_8h.html#a507">SFW_SWITCH</a> | (<a class="code" href="../../d4/d1/userk_8h.html#a563">TestUP</a>(ACTIVEWNDTRKZORDER) ? 0 : <a class="code" href="../../d4/d1/userk_8h.html#a508">SFW_NOZORDER</a>));
02396             }
02397 
02398             <span class="comment">/*</span>
02399 <span class="comment">             * Eat the message if activation failed.</span>
02400 <span class="comment">             */</span>
02401             <span class="keywordflow">if</span> (!fSuccess) {
02402                 iRet = <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a8">MA_SKIP</a>;
02403             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (iRet == MA_ACTIVATEANDEAT) {
02404                iRet = <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a8">MA_SKIP</a>;
02405             }
02406             <span class="keywordflow">break</span>;
02407 
02408         <span class="keywordflow">case</span> MA_NOACTIVATEANDEAT:
02409             iRet = <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a8">MA_SKIP</a>;
02410             <span class="keywordflow">break</span>;
02411 
02412 
02413         <span class="keywordflow">case</span> MA_NOACTIVATE:
02414         <span class="keywordflow">default</span>:
02415             iRet = <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a7">MA_PASSTHRU</a>;
02416             <span class="keywordflow">break</span>;
02417     }
02418 
02419     <span class="keywordflow">if</span> (pwnd != pwndActivate) {
02420         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndActivate);
02421     }
02422 
02423     <span class="keywordflow">return</span> iRet;
02424 
02425 }
02426 <span class="comment">/***************************************************************************\</span>
02427 <span class="comment">* xxxMouseActivate</span>
02428 <span class="comment">*</span>
02429 <span class="comment">* This is where activation due to mouse clicks occurs.</span>
02430 <span class="comment">*</span>
02431 <span class="comment">* IMPLEMENTATION:</span>
02432 <span class="comment">*     The message is sent to the specified window.  In xxxDefWindowProc, the</span>
02433 <span class="comment">*     message is sent to the window's parent.  The receiving window may</span>
02434 <span class="comment">*            a) process the message,</span>
02435 <span class="comment">*            b) skip the message totally, or</span>
02436 <span class="comment">*            c) re-hit test message</span>
02437 <span class="comment">*</span>
02438 <span class="comment">*     A WM_SETCURSOR message is also sent through the system to set the cursor.</span>
02439 <span class="comment">*</span>
02440 <span class="comment">* History:</span>
02441 <span class="comment">* 11-22-90 DavidPe      Ported.</span>
02442 <span class="comment">\***************************************************************************/</span>
02443 
<a name="l02444"></a><a class="code" href="../../d4/d1/userk_8h.html#a1232">02444</a> <span class="keywordtype">int</span> <a class="code" href="../../d4/d1/userk_8h.html#a1232">xxxMouseActivate</a>(
02445     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti,
02446     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
02447     UINT message,
02448     WPARAM wParam,
02449     LPPOINT lppt,
02450     <span class="keywordtype">int</span> ht)
02451 {
02452     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> x, y;
02453     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndTop;
02454     <span class="keywordtype">int</span> result;
02455     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndTop;
02456     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSend;
02457 
02458     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
02459 
02460     UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a453">_GETPDESK</a>(pwnd) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02461 
02462     <span class="comment">/*</span>
02463 <span class="comment">     * No mouse activation if the mouse is captured. Must check for the capture</span>
02464 <span class="comment">     * ONLY here. 123W depends on it - create a graph, select Rearrange..</span>
02465 <span class="comment">     * flip horizontal, click outside the graph. If this code checks for</span>
02466 <span class="comment">     * anything beside just capture, 123w will get the below messages and</span>
02467 <span class="comment">     * get confused.</span>
02468 <span class="comment">     */</span>
02469     <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02470         <span class="keywordflow">return</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a7">MA_PASSTHRU</a>;
02471     }
02472 
02473     result = <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a7">MA_PASSTHRU</a>;
02474 
02475     pwndTop = pwnd;
02476     <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(pti, pwndTop, &amp;tlpwndTop);
02477 
02478         <span class="comment">/*</span>
02479 <span class="comment">         * B#1404</span>
02480 <span class="comment">         * Don't send WM_PARENTNOTIFY messages if the child has</span>
02481 <span class="comment">         * WS_EX_NOPARENTNOTIFY style.</span>
02482 <span class="comment">         *</span>
02483 <span class="comment">         * Unfortunately, this breaks people who create controls in</span>
02484 <span class="comment">         * MDI children, like WinMail.  They don't get WM_PARENTNOTIFY</span>
02485 <span class="comment">         * messages, which don't get passed to DefMDIChildProc(), which</span>
02486 <span class="comment">         * then can't update the active MDI child.  Grrr.</span>
02487 <span class="comment">         */</span>
02488 
02489     fSend = (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>) || !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a614">WEFNOPARENTNOTIFY</a>));
02490 
02491     <span class="comment">/*</span>
02492 <span class="comment">     * If it's a buttondown event, send WM_PARENTNOTIFY.</span>
02493 <span class="comment">     */</span>
02494     <span class="keywordflow">switch</span> (message) {
02495     <span class="keywordflow">case</span> WM_LBUTTONDOWN:
02496     <span class="keywordflow">case</span> WM_RBUTTONDOWN:
02497     <span class="keywordflow">case</span> WM_MBUTTONDOWN:
02498     <span class="keywordflow">case</span> WM_XBUTTONDOWN:
02499         <span class="keywordflow">while</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwndTop)) {
02500             pwndTop = pwndTop-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
02501 
02502             <span class="keywordflow">if</span> (fSend) {
02503                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndTop);
02504                 <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(pti, pwndTop, &amp;tlpwndTop);
02505                 x = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(lppt-&gt;x - pwndTop-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left);
02506                 y = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(lppt-&gt;y - pwndTop-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top);
02507 
02508                 <span class="comment">/* Get the xbutton from the hiword of wParam */</span>
02509                 UserAssert(message == WM_XBUTTONDOWN || HIWORD(wParam) == 0);
02510                 UserAssert(LOWORD(wParam) == 0);
02511                 <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndTop, WM_PARENTNOTIFY, (WPARAM)(message | wParam), MAKELPARAM(x, y));
02512             }
02513         }
02514 
02515         <span class="keywordflow">if</span> (!fSend) {
02516             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndTop);
02517             <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(pti, pwndTop, &amp;tlpwndTop);
02518         }
02519 
02520         <span class="comment">/*</span>
02521 <span class="comment">         * NOTE: We break out of this loop with pwndTop locked.</span>
02522 <span class="comment">         */</span>
02523         <span class="keywordflow">break</span>;
02524     }
02525 
02526     <span class="comment">/*</span>
02527 <span class="comment">     * The mouse was moved onto this window: make it foreground</span>
02528 <span class="comment">     */</span>
02529     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a563">TestUP</a>(ACTIVEWINDOWTRACKING) &amp;&amp; (message == WM_MOUSEMOVE)) {
02530         result = <a class="code" href="../../d4/d1/userk_8h.html#a1655">xxxActiveWindowTracking</a>(pwnd, WM_MOUSEMOVE, ht);
02531     }
02532 
02533     <span class="comment">/*</span>
02534 <span class="comment">     * Are we hitting an inactive top-level window WHICH ISN'T THE DESKTOP(!)?</span>
02535 <span class="comment">     *</span>
02536 <span class="comment">     * craigc 7-14-89 hitting either inactive top level or any child window,</span>
02537 <span class="comment">     * to be compatible with 2.X.  Apps apparently needs this message.</span>
02538 <span class="comment">     */</span>
02539     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> != pwnd || pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a868">QF_EVENTDEACTIVATEREMOVED</a>) &amp;&amp;
02540             (pwndTop != <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwndTop))) {
02541         <span class="keywordflow">switch</span> (message) {
02542         <span class="keywordflow">case</span> WM_LBUTTONDOWN:
02543         <span class="keywordflow">case</span> WM_RBUTTONDOWN:
02544         <span class="keywordflow">case</span> WM_MBUTTONDOWN:
02545         <span class="keywordflow">case</span> WM_XBUTTONDOWN:
02546 
02547             <span class="comment">/*</span>
02548 <span class="comment">             * Send the MOUSEACTIVATE message.</span>
02549 <span class="comment">             */</span>
02550             result = (<span class="keywordtype">int</span>)<a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_MOUSEACTIVATE,
02551                     (WPARAM)(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndTop)), MAKELONG((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)ht, message));
02552 
02553             <span class="keywordflow">switch</span> (result) {
02554 
02555             <span class="keywordflow">case</span> 0:
02556             <span class="keywordflow">case</span> MA_ACTIVATE:
02557             <span class="keywordflow">case</span> MA_ACTIVATEANDEAT:
02558 
02559                 <span class="comment">/*</span>
02560 <span class="comment">                 * If activation fails, swallow the message.</span>
02561 <span class="comment">                 */</span>
02562                 <span class="keywordflow">if</span> ((pwndTop != pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> ||
02563                         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a868">QF_EVENTDEACTIVATEREMOVED</a>) &amp;&amp;
02564                         !<a class="code" href="../../d4/d1/userk_8h.html#a1230">xxxActivateWindow</a>(pwndTop,
02565                           (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)((pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o10">codeCapture</a> == <a class="code" href="../../d4/d1/userk_8h.html#a462">NO_CAP_CLIENT</a>) ?
02566                           <a class="code" href="../../d4/d1/userk_8h.html#a253">AW_TRY2</a> : <a class="code" href="../../d4/d1/userk_8h.html#a251">AW_TRY</a>))) {
02567                     result = <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a8">MA_SKIP</a>;
02568                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndTop, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a651">WFDISABLED</a>)) {
02569 <span class="preprocessor">#ifdef NEVER</span>
02570 <span class="preprocessor"></span>
02571                     <span class="comment">/*</span>
02572 <span class="comment">                     * Althoug this is what win3 does, it is braindead: it</span>
02573 <span class="comment">                     * can easily cause infinite loops.  Returning "rehittest"</span>
02574 <span class="comment">                     * means process this event over again - nothing causes</span>
02575 <span class="comment">                     * anything different to happen, and we get an infinite</span>
02576 <span class="comment">                     * loop.  This case never gets executed on win3 because if</span>
02577 <span class="comment">                     * the window is disabled, it got the HTERROR hittest</span>
02578 <span class="comment">                     * code.  This can only be done on Win32 where input is</span>
02579 <span class="comment">                     * assigned to a window BEFORE process occurs to pull</span>
02580 <span class="comment">                     * it out of the queue.</span>
02581 <span class="comment">                     */</span>
02582                     result = <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a9">MA_REHITTEST</a>;
02583 <span class="preprocessor">#endif</span>
02584 <span class="preprocessor"></span>
02585                     <span class="comment">/*</span>
02586 <span class="comment">                     * Someone clicked on a window before it was disabled...</span>
02587 <span class="comment">                     * Since it is disabled now, don't send this message to</span>
02588 <span class="comment">                     * it: instead eat it.</span>
02589 <span class="comment">                     */</span>
02590                     result = <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a8">MA_SKIP</a>;
02591                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (result == MA_ACTIVATEANDEAT) {
02592                     result = <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a8">MA_SKIP</a>;
02593                 } <span class="keywordflow">else</span> {
02594                     result = <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a7">MA_PASSTHRU</a>;
02595                     <span class="keywordflow">goto</span> ItsActiveJustCheckOnTop;
02596                 }
02597                 <span class="keywordflow">break</span>;
02598 
02599             <span class="keywordflow">case</span> MA_NOACTIVATEANDEAT:
02600                 result = <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a8">MA_SKIP</a>;
02601                 <span class="keywordflow">break</span>;
02602             }
02603         }
02604     } <span class="keywordflow">else</span> {
02605 ItsActiveJustCheckOnTop:
02606         <span class="comment">/*</span>
02607 <span class="comment">         * Make sure this active window is on top (see comment</span>
02608 <span class="comment">         * in CheckOnTop).</span>
02609 <span class="comment">         */</span>
02610         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a563">TestUP</a>(ACTIVEWINDOWTRACKING)) {
02611             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a40">CheckOnTop</a>(pti, pwndTop, message)) {
02612                 <span class="comment">/*</span>
02613 <span class="comment">                 * The window was z-ordered to the top.</span>
02614 <span class="comment">                 * If it is a console window, skip the message</span>
02615 <span class="comment">                 *  so it won't go into "selecting" mode</span>
02616 <span class="comment">                 * Hard error boxes are created by csrss as well</span>
02617 <span class="comment">                 * If we have topmost console windows someday, this</span>
02618 <span class="comment">                 *  will need to change</span>
02619 <span class="comment">                 */</span>
02620                  <span class="keywordflow">if</span> ((ht == HTCLIENT)
02621                         &amp;&amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndTop)-&gt;TIF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a798">TIF_CSRSSTHREAD</a>)
02622                         &amp;&amp; !(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndTop, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>))) {
02623 
02624                      RIPMSG2(RIP_WARNING, <span class="stringliteral">"xxxMouseActivate: Skipping msg %#lx for pwnd %#p"</span>,
02625                             message, pwndTop);
02626                      result = <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a8">MA_SKIP</a>;
02627                  }
02628             }
02629         } <span class="comment">/* if (TestUP(ACTIVEWINDOWTRACKING)) */</span>
02630     }
02631 
02632     <span class="comment">/*</span>
02633 <span class="comment">     * Now set the cursor shape.</span>
02634 <span class="comment">     */</span>
02635     <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02636         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_SETCURSOR, (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwnd),
02637                 MAKELONG((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)ht, message));
02638     }
02639 
02640     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndTop);
02641     <span class="keywordflow">return</span> result;
02642 }
02643 
02644 <span class="comment">/***************************************************************************\</span>
02645 <span class="comment">*  ResetMouseHover()</span>
02646 <span class="comment">*</span>
02647 <span class="comment">*  Resets mouse hover state information.</span>
02648 <span class="comment">*</span>
02649 <span class="comment">*  11/03/95    francish    created.</span>
02650 <span class="comment">*  09/04/97    GerardoB    Rewritten to use per desktop tracking</span>
02651 <span class="comment">\***************************************************************************/</span>
02652 
<a name="l02653"></a><a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a45">02653</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a45">ResetMouseHover</a>(<a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk, POINT pt)
02654 {
02655     <span class="comment">/*</span>
02656 <span class="comment">     * Reset the timer and hover rect</span>
02657 <span class="comment">     */</span>
02658     <a class="code" href="../../d4/d1/userk_8h.html#a1044">InternalSetTimer</a>(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o21">spwndTrack</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a49">IDSYS_MOUSEHOVER</a>,
02659                      pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o24">dwMouseHoverTime</a>,
02660                     <a class="code" href="../../d4/d2/timers_8c.html#a22">xxxSystemTimerProc</a>, TMRF_SYSTEM);
02661 
02662     <a class="code" href="../../d3/d6/rect_8c.html#a1">SetRect</a>(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o23">rcMouseHover</a>,
02663             pt.x - <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a102">gcxMouseHover</a> / 2,
02664             pt.y - <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a103">gcyMouseHover</a> / 2,
02665             pt.x + <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a102">gcxMouseHover</a> / 2,
02666             pt.y + <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a103">gcyMouseHover</a> / 2);
02667 
02668 }
02669 
02670 <span class="comment">/***************************************************************************\</span>
02671 <span class="comment">*  QueryTrackMouseEvent()</span>
02672 <span class="comment">*</span>
02673 <span class="comment">*  Fills in a TRACKMOUSEEVENT structure describing current tracking state.</span>
02674 <span class="comment">*</span>
02675 <span class="comment">*  11/03/95    francish    created.</span>
02676 <span class="comment">*  09/04/97    GerardoB    Rewritten to use per desktop tracking</span>
02677 <span class="comment">\***************************************************************************/</span>
02678 
<a name="l02679"></a><a class="code" href="../../d4/d1/userk_8h.html#a1129">02679</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1129">QueryTrackMouseEvent</a>(
02680     LPTRACKMOUSEEVENT lpTME)
02681 {
02682     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
02683     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>;
02684 
02685     <span class="comment">/*</span>
02686 <span class="comment">     * initialize the struct</span>
02687 <span class="comment">     */</span>
02688     RtlZeroMemory(lpTME, <span class="keyword">sizeof</span>(*lpTME));
02689     lpTME-&gt;cbSize = <span class="keyword">sizeof</span>(*lpTME);
02690     <span class="comment">/*</span>
02691 <span class="comment">     * Bail if not tracking any mouse event</span>
02692 <span class="comment">     *  or if the current thread is not in spwndTrack's queue</span>
02693 <span class="comment">     */</span>
02694     <span class="keywordflow">if</span> (!(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a294">DF_TRACKMOUSEEVENT</a>)
02695             || (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o21">spwndTrack</a>)-&gt;pq)) {
02696         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02697     }
02698     <span class="comment">/*</span>
02699 <span class="comment">     * fill in the requested information</span>
02700 <span class="comment">     */</span>
02701     <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o22">htEx</a> != HTCLIENT) {
02702         lpTME-&gt;dwFlags |= TME_NONCLIENT;
02703     }
02704     <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a292">DF_TRACKMOUSELEAVE</a>) {
02705         lpTME-&gt;dwFlags |= TME_LEAVE;
02706     }
02707     <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a293">DF_TRACKMOUSEHOVER</a>) {
02708         lpTME-&gt;dwFlags |= TME_HOVER;
02709         lpTME-&gt;dwHoverTime = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o24">dwMouseHoverTime</a>;
02710     }
02711 
02712     lpTME-&gt;hwndTrack = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o21">spwndTrack</a>);
02713 
02714     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02715 }
02716 
02717 <span class="comment">/***************************************************************************\</span>
02718 <span class="comment">*  TrackMouseEvent()</span>
02719 <span class="comment">*</span>
02720 <span class="comment">*  API for requesting extended mouse notifications (hover, leave, ...)</span>
02721 <span class="comment">*</span>
02722 <span class="comment">*  11/03/95    francish    created.</span>
02723 <span class="comment">*  09/04/97    GerardoB    Rewritten to use per desktop tracking</span>
02724 <span class="comment">\***************************************************************************/</span>
<a name="l02725"></a><a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a47">02725</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a47">TrackMouseEvent</a>(
02726     LPTRACKMOUSEEVENT lpTME)
02727 {
02728     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;rpdesk;
02729     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>     pwnd;
02730 
02731     <span class="comment">/*</span>
02732 <span class="comment">     * Validate hwndTrack</span>
02733 <span class="comment">     */</span>
02734     pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(lpTME-&gt;hwndTrack);
02735     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02736         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02737     }
02738     <span class="comment">/*</span>
02739 <span class="comment">     * If we're not tracking this window or not in correct hittest, bail</span>
02740 <span class="comment">     */</span>
02741     <span class="keywordflow">if</span> ((pwnd != pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o21">spwndTrack</a>)
02742             || (!!(lpTME-&gt;dwFlags &amp; TME_NONCLIENT) ^ (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o22">htEx</a> != HTCLIENT))) {
02743 
02744         <span class="keywordflow">if</span> ((lpTME-&gt;dwFlags &amp; TME_LEAVE) &amp;&amp; !(lpTME-&gt;dwFlags &amp; TME_CANCEL)) {
02745             <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwnd,
02746                          ((lpTME-&gt;dwFlags &amp; TME_NONCLIENT) ? WM_NCMOUSELEAVE : WM_MOUSELEAVE),
02747                          0, 0);
02748         }
02749         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02750     }
02751 
02752     <span class="comment">/*</span>
02753 <span class="comment">     * Process cancel request</span>
02754 <span class="comment">     */</span>
02755     <span class="keywordflow">if</span> (lpTME-&gt;dwFlags &amp; TME_CANCEL) {
02756         <span class="keywordflow">if</span> (lpTME-&gt;dwFlags &amp; TME_LEAVE) {
02757             pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a292">DF_TRACKMOUSELEAVE</a>;
02758         }
02759         <span class="keywordflow">if</span> (lpTME-&gt;dwFlags &amp; TME_HOVER) {
02760             <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a293">DF_TRACKMOUSEHOVER</a>) {
02761                 <a class="code" href="../../d4/d1/userk_8h.html#a1567">_KillSystemTimer</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a49">IDSYS_MOUSEHOVER</a>);
02762                 pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a293">DF_TRACKMOUSEHOVER</a>;
02763             }
02764         }
02765         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02766     }
02767 
02768     <span class="comment">/*</span>
02769 <span class="comment">     * Track mouse leave</span>
02770 <span class="comment">     */</span>
02771     <span class="keywordflow">if</span> (lpTME-&gt;dwFlags &amp; TME_LEAVE) {
02772         pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a292">DF_TRACKMOUSELEAVE</a>;
02773     }
02774     <span class="comment">/*</span>
02775 <span class="comment">     * Track mouse hover</span>
02776 <span class="comment">     */</span>
02777     <span class="keywordflow">if</span> (lpTME-&gt;dwFlags &amp; TME_HOVER) {
02778         pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a293">DF_TRACKMOUSEHOVER</a>;
02779 
02780         pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o24">dwMouseHoverTime</a> = lpTME-&gt;dwHoverTime;
02781         <span class="keywordflow">if</span> ((pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o24">dwMouseHoverTime</a> == 0) || (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o24">dwMouseHoverTime</a> == HOVER_DEFAULT)) {
02782             pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o24">dwMouseHoverTime</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a104">gdtMouseHover</a>;
02783         }
02784 
02785         <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a45">ResetMouseHover</a>(pdesk, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;ptLast);
02786     }
02787 
02788     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02789 }
02790 
02791 <span class="comment">/***************************************************************************\</span>
02792 <span class="comment">* xxxGetNextSysMsg</span>
02793 <span class="comment">*</span>
02794 <span class="comment">* Returns the queue pointer of the next system message or</span>
02795 <span class="comment">*  NULL             - no more messages (may be a journal playback delay)</span>
02796 <span class="comment">*  PQMSG_PLAYBACK   - got a journal playback message</span>
02797 <span class="comment">* (Anything else is a real pointer)</span>
02798 <span class="comment">*</span>
02799 <span class="comment">* 10-23-92 ScottLu      Created.</span>
02800 <span class="comment">\***************************************************************************/</span>
02801 
<a name="l02802"></a><a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a48">02802</a> <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a48">xxxGetNextSysMsg</a>(
02803     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti,
02804     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsgPrev,
02805     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsg)
02806 {
02807     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d7/d4/conexts_8c.html#a26">dt</a>;
02808     <a class="code" href="../../d6/d1/structtagMLIST.html">PMLIST</a> pml;
02809     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsgT;
02810 
02811     <span class="comment">/*</span>
02812 <span class="comment">     * If there is a journal playback hook, call it to get the next message.</span>
02813 <span class="comment">     */</span>
02814     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d1/userk_8h.html#a1519">PhkFirstGlobalValid</a>(pti, WH_JOURNALPLAYBACK) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02815             &amp;&amp; (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>)) {
02816         <span class="comment">/*</span>
02817 <span class="comment">         * We can't search through journal messages: we only get the current</span>
02818 <span class="comment">         * journal message. So if the caller has already called us once</span>
02819 <span class="comment">         * before, then exit with no messages.</span>
02820 <span class="comment">         */</span>
02821         <span class="keywordflow">if</span> (pqmsgPrev != 0)
02822             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02823 
02824         <span class="comment">/*</span>
02825 <span class="comment">         * Tell the journal playback hook that we're done</span>
02826 <span class="comment">         * with this message now.</span>
02827 <span class="comment">         */</span>
02828         <a class="code" href="../../d7/d4/conexts_8c.html#a26">dt</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1525">xxxCallJournalPlaybackHook</a>(pqmsg);
02829         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/conexts_8c.html#a26">dt</a> == 0xFFFFFFFF)
02830             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02831 
02832         <span class="comment">/*</span>
02833 <span class="comment">         * If dt == 0, then we don't need to wait: set the right wake</span>
02834 <span class="comment">         * bits and return this message.</span>
02835 <span class="comment">         */</span>
02836         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/conexts_8c.html#a26">dt</a> == 0) {
02837             <a class="code" href="../../d4/d1/userk_8h.html#a1198">WakeSomeone</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02838             <span class="keywordflow">return</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a4">PQMSG_PLAYBACK</a>;
02839         } <span class="keywordflow">else</span> {
02840             <span class="comment">/*</span>
02841 <span class="comment">             * There is logically no more input in the "queue", so clear the</span>
02842 <span class="comment">             * bits so that we will sleep when GetMessage is called.</span>
02843 <span class="comment">             */</span>
02844             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a> &amp;= ~QS_INPUT;
02845             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o1">fsChangeBits</a> &amp;= ~QS_INPUT;
02846 
02847             <span class="comment">/*</span>
02848 <span class="comment">             * Need to wait before processing this next message. Set</span>
02849 <span class="comment">             * a journal timer.</span>
02850 <span class="comment">             */</span>
02851             <a class="code" href="../../d4/d1/userk_8h.html#a1526">SetJournalTimer</a>(<a class="code" href="../../d7/d4/conexts_8c.html#a26">dt</a>, pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message);
02852 
02853             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02854         }
02855     }
02856 
02857     <span class="comment">/*</span>
02858 <span class="comment">     * No journalling going on... return next message in system queue.</span>
02859 <span class="comment">     */</span>
02860 
02861     <span class="comment">/*</span>
02862 <span class="comment">     * Queue up a mouse move if the mouse has moved.</span>
02863 <span class="comment">     */</span>
02864     <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a860">QF_MOUSEMOVED</a>) {
02865         <a class="code" href="../../d4/d1/userk_8h.html#a1478">PostMove</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>);
02866     }
02867 
02868     <span class="comment">/*</span>
02869 <span class="comment">     * If no messages in the input queue, return with 0.</span>
02870 <span class="comment">     */</span>
02871     pml = &amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>;
02872     <span class="keywordflow">if</span> (pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o2">cMsgs</a> == 0)
02873         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02874 
02875     <span class="comment">/*</span>
02876 <span class="comment">     * If this is the first call to xxxGetNextSysMsg(), return the</span>
02877 <span class="comment">     * first message.</span>
02878 <span class="comment">     */</span>
02879     <span class="keywordflow">if</span> (pqmsgPrev == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o3">idSysPeek</a> &lt;= (ULONG_PTR)<a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a4">PQMSG_PLAYBACK</a>) {
02880         pqmsgT = pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o0">pqmsgRead</a>;
02881     } <span class="keywordflow">else</span> {
02882         <span class="comment">/*</span>
02883 <span class="comment">         * Otherwise return the next message in the queue. Index with</span>
02884 <span class="comment">         * idSysPeek, because that is updated by recursive calls through</span>
02885 <span class="comment">         * this code.</span>
02886 <span class="comment">         */</span>
02887         pqmsgT = ((<a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a>)(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o3">idSysPeek</a>))-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o0">pqmsgNext</a>;
02888     }
02889 
02890     <span class="comment">/*</span>
02891 <span class="comment">     * Fill in the structure passed, and return the pointer to the</span>
02892 <span class="comment">     * current message in the message list. This will become the new</span>
02893 <span class="comment">     * pq-&gt;idSysPeek.</span>
02894 <span class="comment">     */</span>
02895     <span class="keywordflow">if</span> (pqmsgT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02896         *pqmsg = *pqmsgT;
02897     <span class="keywordflow">return</span> pqmsgT;
02898 }
02899 
02900 <span class="comment">/***************************************************************************\</span>
02901 <span class="comment">* UpdateKeyState</span>
02902 <span class="comment">*</span>
02903 <span class="comment">* Updates queue key state tables.</span>
02904 <span class="comment">*</span>
02905 <span class="comment">* 11-11-92 ScottLu      Created.</span>
02906 <span class="comment">\***************************************************************************/</span>
02907 
<a name="l02908"></a><a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a49">02908</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a49">UpdateKeyState</a>(
02909     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pq,
02910     UINT vk,
02911     BOOL fDown)
02912 {
02913     <span class="keywordflow">if</span> (vk != 0) {
02914         <span class="comment">/*</span>
02915 <span class="comment">         * If we're going down, toggle only if the key isn't</span>
02916 <span class="comment">         * already down.</span>
02917 <span class="comment">         */</span>
02918         <span class="keywordflow">if</span> (fDown &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(pq, vk)) {
02919             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a840">TestKeyStateToggle</a>(pq, vk)) {
02920                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a842">ClearKeyStateToggle</a>(pq, vk);
02921             } <span class="keywordflow">else</span> {
02922                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a841">SetKeyStateToggle</a>(pq, vk);
02923             }
02924         }
02925 
02926         <span class="comment">/*</span>
02927 <span class="comment">         * Now set/clear the key down state.</span>
02928 <span class="comment">         */</span>
02929         <span class="keywordflow">if</span> (fDown) {
02930             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a838">SetKeyStateDown</a>(pq, vk);
02931         } <span class="keywordflow">else</span> {
02932             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a839">ClearKeyStateDown</a>(pq, vk);
02933         }
02934 
02935         <span class="comment">/*</span>
02936 <span class="comment">         * If this is one of the keys we cache, update the key cache index.</span>
02937 <span class="comment">         */</span>
02938         <span class="keywordflow">if</span> (vk &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a108">CVKKEYCACHE</a>) {
02939             <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;dwKeyCache++;
02940         }
02941     }
02942 }
02943 
02944 <span class="comment">/***************************************************************************\</span>
02945 <span class="comment">* EqualMsg</span>
02946 <span class="comment">*</span>
02947 <span class="comment">* This routine is called in case that idSysPeek points to a message</span>
02948 <span class="comment">* and we are trying to remove a different message</span>
02949 <span class="comment">*</span>
02950 <span class="comment">* 04-25-96 CLupu      Created.</span>
02951 <span class="comment">\***************************************************************************/</span>
02952 
<a name="l02953"></a><a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a50">02953</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a50">EqualMsg</a>(<a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsg1, <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsg2)
02954 {
02955     <span class="keywordflow">if</span> (pqmsg1-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.hwnd    != pqmsg2-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.hwnd ||
02956         pqmsg1-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message != pqmsg2-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message)
02957         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02958 
02959     <span class="comment">/*</span>
02960 <span class="comment">     * This might be a coalesced WM_MOUSEMOVE</span>
02961 <span class="comment">     */</span>
02962     <span class="keywordflow">if</span> (pqmsg1-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message == WM_MOUSEMOVE)
02963         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02964 
02965     <span class="keywordflow">if</span> (pqmsg1-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o5">pti</a>      != pqmsg2-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o5">pti</a> ||
02966         pqmsg1-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.time != pqmsg2-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.time)
02967         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02968 
02969     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02970 }
02971 
02972 <span class="comment">/***************************************************************************\</span>
02973 <span class="comment">* xxxSkipSysMsg</span>
02974 <span class="comment">*</span>
02975 <span class="comment">* This routine "skips" an input message: either by calling the journal</span>
02976 <span class="comment">* hooks if we're journalling or by "skipping" the message in the input</span>
02977 <span class="comment">* queue. Internal keystate tables are updated as well.</span>
02978 <span class="comment">*</span>
02979 <span class="comment">* 10-23-92 ScottLu      Created.</span>
02980 <span class="comment">\***************************************************************************/</span>
02981 
<a name="l02982"></a><a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a51">02982</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a51">xxxSkipSysMsg</a>(
02983     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti,
02984     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsg)
02985 {
02986     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsgT;
02987     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  fDown;
02988     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>  vk;
02989     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phook;
02990 
02991     <span class="comment">/*</span>
02992 <span class="comment">     * If idSysPeek is 0, then the pqmsg that we were looking at has been</span>
02993 <span class="comment">     * deleted, probably because of a callout from ScanSysQueue, and that</span>
02994 <span class="comment">     * callout then called PeekMessage(fRemove == TRUE), and then returned.</span>
02995 <span class="comment">     */</span>
02996     <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o3">idSysPeek</a> == 0)
02997         <span class="keywordflow">return</span>;
02998 
02999     phook = <a class="code" href="../../d4/d1/userk_8h.html#a1519">PhkFirstGlobalValid</a>(pti, WH_JOURNALPLAYBACK);
03000     <span class="keywordflow">if</span> (phook != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03001         <span class="comment">/*</span>
03002 <span class="comment">         * Tell the journal playback hook that we're done</span>
03003 <span class="comment">         * with this message now.</span>
03004 <span class="comment">         */</span>
03005         phook-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a504">HF_NEEDHC_SKIP</a>;
03006     } <span class="keywordflow">else</span> {
03007         phook = <a class="code" href="../../d4/d1/userk_8h.html#a1519">PhkFirstGlobalValid</a>(pti, WH_JOURNALRECORD);
03008         <span class="keywordflow">if</span> (phook != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03009             <span class="comment">/*</span>
03010 <span class="comment">             * We've processed a new message: tell the journal record</span>
03011 <span class="comment">             * hook what the message is.</span>
03012 <span class="comment">             */</span>
03013             <a class="code" href="../../d4/d1/userk_8h.html#a1524">xxxCallJournalRecordHook</a>(pqmsg);
03014         }
03015 
03016         <span class="comment">/*</span>
03017 <span class="comment">         * If idSysPeek is 0 now, it means we've been recursed into yet</span>
03018 <span class="comment">         * again. This would confuse a journalling app, but it would confuse</span>
03019 <span class="comment">         * us more because we'd fault. Return if idSysPeek is 0.</span>
03020 <span class="comment">         */</span>
03021         <span class="keywordflow">if</span> ((pqmsgT = (<a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a>)pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o3">idSysPeek</a>) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03022             <span class="keywordflow">return</span>;
03023 
03024         <span class="comment">/*</span>
03025 <span class="comment">         * Delete this message from the input queue. Make sure pqmsgT isn't</span>
03026 <span class="comment">         * 1: this could happen if an app unhooked a journal record hook</span>
03027 <span class="comment">         * during a callback from xxxScanSysQueue.</span>
03028 <span class="comment">         */</span>
03029         <span class="keywordflow">if</span> (pqmsgT != <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a4">PQMSG_PLAYBACK</a>) {
03030             <span class="comment">/*</span>
03031 <span class="comment">             * There are cases when idSysPeek points to a different message</span>
03032 <span class="comment">             * than the one we are trying to remove. This can happen if</span>
03033 <span class="comment">             * two threads enters in xxxScanSysQueue, sets the idSysPeek and</span>
03034 <span class="comment">             * after this their queues got redistributed. The first thread</span>
03035 <span class="comment">             * will have the idSysPeek preserved but the second one has to</span>
03036 <span class="comment">             * search the queue for its message. - ask CLupu</span>
03037 <span class="comment">             */</span>
03038             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a50">EqualMsg</a>(pqmsgT, pqmsg)) {
03039 
03040                 <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsgS;
03041 
03042 <span class="preprocessor">#if DEBUGTAGS</span>
03043 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (IsDbgTagEnabled(DBGTAG_SysPeek)) {
03044                     gnSysPeekSearch++;
03045                 }
03046 <span class="preprocessor">#endif</span>
03047 <span class="preprocessor"></span>
03048                 TAGMSG0(DBGTAG_SysPeek | RIP_THERESMORE,              <span class="stringliteral">"Different message than idSysPeek\n"</span>);
03049                 TAGMSG2(DBGTAG_SysPeek | RIP_NONAME | RIP_THERESMORE, <span class="stringliteral">"pqmsg   = %#p  idSysPeek = %#p"</span>,  pqmsg,              pqmsgT);
03050                 TAGMSG2(DBGTAG_SysPeek | RIP_NONAME | RIP_THERESMORE, <span class="stringliteral">"pti     = %#p  pti       = %#p"</span>,  pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o5">pti</a>,         pqmsgT-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o5">pti</a>);
03051                 TAGMSG2(DBGTAG_SysPeek | RIP_NONAME | RIP_THERESMORE, <span class="stringliteral">"msg     = %08lx  msg       = %08lx"</span>,  pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message, pqmsgT-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message);
03052                 TAGMSG2(DBGTAG_SysPeek | RIP_NONAME | RIP_THERESMORE, <span class="stringliteral">"hwnd    = %#p  hwnd      = %#p"</span>,  pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.hwnd,    pqmsgT-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.hwnd);
03053                 TAGMSG2(DBGTAG_SysPeek | RIP_NONAME | RIP_THERESMORE, <span class="stringliteral">"wParam  = %#p  wParam    = %#p"</span>,  pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam,  pqmsgT-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam);
03054                 TAGMSG2(DBGTAG_SysPeek | RIP_NONAME | RIP_THERESMORE, <span class="stringliteral">"lParam  = %#p  lParam    = %#p"</span>,  pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam,  pqmsgT-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam);
03055                 TAGMSG2(DBGTAG_SysPeek | RIP_NONAME | RIP_THERESMORE, <span class="stringliteral">"time    = %08lx  time      = %08lx"</span>,  pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.time,    pqmsgT-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.time);
03056                 TAGMSG2(DBGTAG_SysPeek | RIP_NONAME | RIP_THERESMORE, <span class="stringliteral">"Extra   = %08lx  Extra     = %08lx"</span>,  pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o3">ExtraInfo</a>,   pqmsgT-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o3">ExtraInfo</a>);
03057                 TAGMSG1(DBGTAG_SysPeek | RIP_NONAME,                  <span class="stringliteral">"\npqmsgT  = %#p"</span>, pqmsgT);
03058 
03059                 <span class="comment">/*</span>
03060 <span class="comment">                 * Begin to search for this message</span>
03061 <span class="comment">                 */</span>
03062                 pqmsgS = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>.<a class="code" href="../../d6/d1/structtagMLIST.html#o0">pqmsgRead</a>;
03063 
03064                 <span class="keywordflow">while</span> (pqmsgS != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03065                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a50">EqualMsg</a>(pqmsgS, pqmsg)) {
03066                         TAGMSG2(DBGTAG_SysPeek | RIP_THERESMORE,
03067                                 <span class="stringliteral">"Deleting pqmsg %#p, pti %#p"</span>,
03068                                 pqmsgS, pqmsgS-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o5">pti</a>);
03069 
03070                         TAGMSG4(DBGTAG_SysPeek | RIP_NONAME,
03071                                 <span class="stringliteral">"m %04lx, w %#p, l %#p, t %lx"</span>,
03072                                 pqmsgS-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message, pqmsgS-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.hwnd,
03073                                 pqmsgS-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam, pqmsgS-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.time);
03074 
03075                         pqmsgT = pqmsgS;
03076                         <span class="keywordflow">break</span>;
03077                     }
03078                     pqmsgS = pqmsgS-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o0">pqmsgNext</a>;
03079                 }
03080                 <span class="keywordflow">if</span> (pqmsgS == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03081                     TAGMSG0(DBGTAG_SysPeek, <span class="stringliteral">"Didn't find a matching message. No message removed."</span>);
03082                     <span class="keywordflow">return</span>;
03083                 }
03084             }
03085 
03086             <span class="keywordflow">if</span> (pqmsgT == (<a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a>)pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o3">idSysPeek</a>) {
03087                 <span class="comment">/*</span>
03088 <span class="comment">                 * We'll remove this message from the input queue</span>
03089 <span class="comment">                 * so set idSysPeek to 0.</span>
03090 <span class="comment">                 */</span>
03091                 <a class="code" href="../../d4/d1/userk_8h.html#a11">CheckPtiSysPeek</a>(1, pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, 0);
03092                 pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o3">idSysPeek</a> = 0;
03093             }
03094             <a class="code" href="../../d4/d1/userk_8h.html#a1212">DelQEntry</a>(&amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>, pqmsgT);
03095         }
03096     }
03097 
03098     fDown = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03099     vk = 0;
03100 
03101     <span class="keywordflow">switch</span> (pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message) {
03102     <span class="keywordflow">case</span> WM_MOUSEMOVE:
03103     <span class="keywordflow">case</span> WM_QUEUESYNC:
03104     <span class="keywordflow">default</span>:
03105         <span class="comment">/*</span>
03106 <span class="comment">         * No state change.</span>
03107 <span class="comment">         */</span>
03108         <span class="keywordflow">break</span>;
03109 
03110     <span class="keywordflow">case</span> WM_KEYUP:
03111     <span class="keywordflow">case</span> WM_SYSKEYUP:
03112         fDown = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03113 
03114         <span class="comment">/*</span>
03115 <span class="comment">         * Fall through.</span>
03116 <span class="comment">         */</span>
03117     <span class="keywordflow">case</span> WM_KEYDOWN:
03118     <span class="keywordflow">case</span> WM_SYSKEYDOWN:
03119         vk = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(LOWORD(pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam));
03120         <span class="keywordflow">break</span>;
03121 
03122     <span class="keywordflow">case</span> WM_LBUTTONUP:
03123         fDown = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03124 
03125         <span class="comment">/*</span>
03126 <span class="comment">         * Fall through.</span>
03127 <span class="comment">         */</span>
03128     <span class="keywordflow">case</span> WM_LBUTTONDOWN:
03129         vk = VK_LBUTTON;
03130         <span class="keywordflow">break</span>;
03131 
03132     <span class="keywordflow">case</span> WM_RBUTTONUP:
03133         fDown = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03134 
03135         <span class="comment">/*</span>
03136 <span class="comment">         * Fall through.</span>
03137 <span class="comment">         */</span>
03138     <span class="keywordflow">case</span> WM_RBUTTONDOWN:
03139         vk = VK_RBUTTON;
03140         <span class="keywordflow">break</span>;
03141 
03142     <span class="keywordflow">case</span> WM_MBUTTONUP:
03143         fDown = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03144 
03145         <span class="comment">/*</span>
03146 <span class="comment">         * Fall through.</span>
03147 <span class="comment">         */</span>
03148     <span class="keywordflow">case</span> WM_MBUTTONDOWN:
03149         vk = VK_MBUTTON;
03150         <span class="keywordflow">break</span>;
03151 
03152     <span class="keywordflow">case</span> WM_XBUTTONUP:
03153         fDown = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03154 
03155         <span class="comment">/*</span>
03156 <span class="comment">         * Fall through.</span>
03157 <span class="comment">         */</span>
03158     <span class="keywordflow">case</span> WM_XBUTTONDOWN:
03159         UserAssert(GET_XBUTTON_WPARAM(pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam) == XBUTTON1 ||
03160                    GET_XBUTTON_WPARAM(pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam) == XBUTTON2);
03161 
03162         <span class="keywordflow">switch</span> (GET_XBUTTON_WPARAM(pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam)) {
03163         <span class="keywordflow">case</span> XBUTTON1:
03164             vk = VK_XBUTTON1;
03165             <span class="keywordflow">break</span>;
03166 
03167         <span class="keywordflow">case</span> XBUTTON2:
03168             vk = VK_XBUTTON2;
03169             <span class="keywordflow">break</span>;
03170         }
03171 
03172         <span class="keywordflow">break</span>;
03173     }
03174 
03175     <span class="comment">/*</span>
03176 <span class="comment">     * Set toggle and down bits appropriately.</span>
03177 <span class="comment">     */</span>
03178     <span class="keywordflow">if</span> ((vk == VK_SHIFT) || (vk == VK_MENU) || (vk == VK_CONTROL)) {
03179         <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> vkHanded, vkOtherHand;
03180         <span class="comment">/*</span>
03181 <span class="comment">         * Convert this virtual key into a differentiated (Left/Right) key</span>
03182 <span class="comment">         * depending on the extended key bit.</span>
03183 <span class="comment">         */</span>
03184         vkHanded = (vk - VK_SHIFT) * 2 + VK_LSHIFT +
03185                 ((pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam &amp; EXTENDED_BIT) ? 1 : 0);
03186         vkOtherHand = vkHanded ^ 1;
03187 
03188         <span class="keywordflow">if</span> (vk == VK_SHIFT) {
03189             <span class="comment">/*</span>
03190 <span class="comment">             * Clear extended bit for r.h. Shift, since it isn't really</span>
03191 <span class="comment">             * extended (bit was set to indicate right-handed)</span>
03192 <span class="comment">             */</span>
03193             pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam &amp;= ~EXTENDED_BIT;
03194         }
03195 
03196         <span class="comment">/*</span>
03197 <span class="comment">         * Update the key state for the differentiated (Left/Right) key.</span>
03198 <span class="comment">         */</span>
03199         <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a49">UpdateKeyState</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, vkHanded, fDown);
03200 
03201         <span class="comment">/*</span>
03202 <span class="comment">         * Update key state for the undifferentiated (logical) key.</span>
03203 <span class="comment">         */</span>
03204         <span class="keywordflow">if</span> (fDown || !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, vkOtherHand)) {
03205             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a49">UpdateKeyState</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, vk, fDown);
03206         }
03207     } <span class="keywordflow">else</span> {
03208         <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a49">UpdateKeyState</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, vk, fDown);
03209     }
03210 }
03211 
03212 
03213 
03214 <span class="preprocessor">#if DBG</span>
03215 <span class="preprocessor"></span><span class="comment">/***************************************************************************\</span>
03216 <span class="comment">* LogPlayback</span>
03217 <span class="comment">*</span>
03218 <span class="comment">*</span>
03219 <span class="comment">* History:</span>
03220 <span class="comment">* 02-13-95 JimA             Created.</span>
03221 <span class="comment">\***************************************************************************/</span>
03222 
03223 <span class="keywordtype">void</span> LogPlayback(
03224     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
03225     PMSG lpmsg)
03226 {
03227     <span class="keyword">static</span> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndM = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pwndK = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03228     LPCSTR lpszMsg;
03229     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> achBuf[20];
03230 
03231     <span class="keywordflow">if</span> ((lpmsg-&gt;message &gt;= WM_MOUSEFIRST) &amp;&amp; (lpmsg-&gt;message &lt;= WM_MOUSELAST)) {
03232         lpszMsg = aszMouse[lpmsg-&gt;message - WM_MOUSEFIRST];
03233         <span class="keywordflow">if</span> (pwnd != pwndM) {
03234             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*** Mouse input to window \"%ws\" of class \"%s\"\n"</span>,
03235                     pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o17">strName</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o0">Length</a> ? pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o17">strName</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a> : L<span class="stringliteral">""</span>,
03236                     pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;lpszAnsiClassName);
03237             pwndM = pwnd;
03238         }
03239     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((lpmsg-&gt;message &gt;= WM_KEYFIRST) &amp;&amp; (lpmsg-&gt;message &lt;= WM_KEYLAST)) {
03240         lpszMsg = aszKey[lpmsg-&gt;message - WM_KEYFIRST];
03241         <span class="keywordflow">if</span> (pwnd != pwndK) {
03242             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*** Kbd input to window \"%ws\" of class \"%s\"\n"</span>,
03243                     pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o17">strName</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o0">Length</a> ? pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o17">strName</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a> : L<span class="stringliteral">""</span>,
03244                     pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;lpszAnsiClassName);
03245             pwndK = pwnd;
03246         }
03247     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lpmsg-&gt;message == WM_QUEUESYNC) {
03248         lpszMsg = <span class="stringliteral">"WM_QUEUESYNC"</span>;
03249     } <span class="keywordflow">else</span> {
03250         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(achBuf, <span class="stringliteral">"0x%4x"</span>, lpmsg-&gt;message);
03251         lpszMsg = achBuf;
03252     }
03253     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"msg = %s, wP = %x, lP = %x\n"</span>, lpszMsg,
03254             lpmsg-&gt;wParam, lpmsg-&gt;lParam);
03255 }
03256 <span class="preprocessor">#endif  // DBG</span>
03257 <span class="preprocessor"></span>
03258 <span class="comment">/***************************************************************************\</span>
03259 <span class="comment">*</span>
03260 <span class="comment">*  GetMouseKeyFlags()</span>
03261 <span class="comment">*</span>
03262 <span class="comment">*  Computes MOST of the MK_ flags given a Q.</span>
03263 <span class="comment">*  Does not compute MK_MOUSEENTER.</span>
03264 <span class="comment">*</span>
03265 <span class="comment">\***************************************************************************/</span>
03266 
<a name="l03267"></a><a class="code" href="../../d4/d1/userk_8h.html#a1641">03267</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d4/d1/userk_8h.html#a1641">GetMouseKeyFlags</a>(
03268     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pq)
03269 {
03270     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> wParam = 0;
03271 
03272     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(pq, VK_LBUTTON))
03273         wParam |= MK_LBUTTON;
03274     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(pq, VK_RBUTTON))
03275         wParam |= MK_RBUTTON;
03276     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(pq, VK_MBUTTON))
03277         wParam |= MK_MBUTTON;
03278     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(pq, VK_XBUTTON1))
03279         wParam |= MK_XBUTTON1;
03280     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(pq, VK_XBUTTON2))
03281         wParam |= MK_XBUTTON2;
03282     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(pq, VK_SHIFT))
03283         wParam |= MK_SHIFT;
03284     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(pq, VK_CONTROL))
03285         wParam |= MK_CONTROL;
03286 
03287     <span class="keywordflow">return</span> wParam;
03288 }
03289 
03290 <span class="comment">/***************************************************************************\</span>
03291 <span class="comment">* xxxScanSysQueue</span>
03292 <span class="comment">*</span>
03293 <span class="comment">* This routine looks at the hardware message, determines what</span>
03294 <span class="comment">* window it will be in, determines what the input message will</span>
03295 <span class="comment">* be, and then checks the destination window against hwndFilter,</span>
03296 <span class="comment">* and the input message against msgMinFilter and msgMaxFilter.</span>
03297 <span class="comment">*</span>
03298 <span class="comment">* It also updates various input synchronized states like keystate info.</span>
03299 <span class="comment">*</span>
03300 <span class="comment">* This is almost verbatim from Win3.1.</span>
03301 <span class="comment">*</span>
03302 <span class="comment">* 10-20-92 ScottLu      Created.</span>
03303 <span class="comment">\***************************************************************************/</span>
03304 
<a name="l03305"></a><a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a18">03305</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a18">xxxScanSysQueue</a>(
03306     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent,
03307     LPMSG lpMsg,
03308     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndFilter,
03309     UINT msgMinFilter,
03310     UINT msgMaxFilter,
03311     DWORD flags,
03312     DWORD fsReason)
03313 {
03314     <a class="code" href="../../d8/d4/structtagQMSG.html">QMSG</a> qmsg;
03315     HWND hwnd;
03316     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
03317     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> message;
03318     WPARAM wParam;
03319     LPARAM lParam;
03320     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiKeyWake, ptiMouseWake, ptiEventWake;
03321     POINT pt, ptScreen;
03322     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> codeMouseDown;
03323     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fMouseHookCalled;
03324     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fKbdHookCalled;
03325     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fOtherApp;
03326     <span class="keywordtype">int</span> part;
03327     MOUSEHOOKSTRUCTEX mhs;
03328     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT;
03329     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fPrevDown;
03330     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fDown;
03331     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fAlt;
03332     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
03333     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndT;
03334     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRemove = (flags &amp; PM_REMOVE);
03335 <span class="preprocessor">#ifdef FE_IME</span>
03336 <span class="preprocessor"></span>    <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwImmRet = 0;
03337 <span class="preprocessor">#endif</span>
03338 <span class="preprocessor"></span><span class="preprocessor">#ifdef MARKPATH</span>
03339 <span class="preprocessor"></span>    <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> pathTaken = 0;
03340     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> pathTaken2 = 0;
03341     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> pathTaken3 = 0;
03342 
03343 <span class="preprocessor">#define PATHTAKEN(x)  pathTaken  |= x</span>
03344 <span class="preprocessor"></span><span class="preprocessor">#define PATHTAKEN2(x) pathTaken2 |= x</span>
03345 <span class="preprocessor"></span><span class="preprocessor">#define PATHTAKEN3(x) pathTaken3 |= x</span>
03346 <span class="preprocessor"></span><span class="preprocessor">#define DUMPPATHTAKEN() if (gfMarkPath) DbgPrint("xxxScanSysQueue path:%08x %08x %08x\n", pathTaken, pathTaken2, pathTaken3)</span>
03347 <span class="preprocessor"></span><span class="preprocessor">#define DUMPSUBPATHTAKEN(p, x) if (gfMarkPath &amp;&amp; p &amp; x) { DbgPrint("  %08x %08x %08x\n", pathTaken, pathTaken2, pathTaken3); pathTaken = pathTaken2 = pathTaken3 = 0; }</span>
03348 <span class="preprocessor"></span><span class="preprocessor">#else</span>
03349 <span class="preprocessor"></span><span class="preprocessor">#define PATHTAKEN(x)</span>
03350 <span class="preprocessor"></span><span class="preprocessor">#define PATHTAKEN2(x)</span>
03351 <span class="preprocessor"></span><span class="preprocessor">#define PATHTAKEN3(x)</span>
03352 <span class="preprocessor"></span><span class="preprocessor">#define DUMPPATHTAKEN()</span>
03353 <span class="preprocessor"></span><span class="preprocessor">#define DUMPSUBPATHTAKEN(p, x)</span>
03354 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
03355 <span class="preprocessor"></span>
03356     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
03357     UserAssert((fsReason &amp; ~(QS_EVENT | QS_INPUT)) == 0 &amp;&amp;
03358                (fsReason &amp; (QS_EVENT | QS_INPUT)) != 0);
03359 
03360     <span class="comment">/*</span>
03361 <span class="comment">     * If we are looking at a peeked message currently (recursion into this</span>
03362 <span class="comment">     * routine) and the only reason we got here was because of an event</span>
03363 <span class="comment">     * message (an app was filtering for a non-input message), then just</span>
03364 <span class="comment">     * return so we don't screw up idSysPeek. If we do enter this code</span>
03365 <span class="comment">     * idSysPeek will get set back to 0, and when we return back into</span>
03366 <span class="comment">     * the previous xxxScanSysQueue(), SkipSysMsg() will do nothing, so the</span>
03367 <span class="comment">     * message won't get removed. (MS Publisher 2.0 does this).</span>
03368 <span class="comment">     */</span>
03369     <span class="keywordflow">if</span> (fsReason == QS_EVENT) {
03370         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o3">idSysPeek</a> != 0) {
03371             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(1);
03372             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a6">DUMPPATHTAKEN</a>();
03373             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03374         }
03375     }
03376 
03377     fDown = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03378     fMouseHookCalled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03379     fKbdHookCalled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03380 
03381     <span class="comment">/*</span>
03382 <span class="comment">     * Lock the queue if it's currently unlocked.</span>
03383 <span class="comment">     */</span>
03384     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o1">ptiSysLock</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03385         <a class="code" href="../../d4/d1/userk_8h.html#a12">CheckSysLock</a>(3, ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, ptiCurrent);
03386         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o1">ptiSysLock</a> = ptiCurrent;
03387         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o0">CTIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a822">CTIF_SYSQUEUELOCKED</a>;
03388     }
03389 
03390     <span class="comment">/*</span>
03391 <span class="comment">     * Flag to tell if locker was removing messages. If not, then next time</span>
03392 <span class="comment">     * Get/PeekMessage is called, the input message list is scanned before the</span>
03393 <span class="comment">     * post msg list.</span>
03394 <span class="comment">     *</span>
03395 <span class="comment">     * Under Win3.1, this flag only gets modified for key and mouse messages.</span>
03396 <span class="comment">     * Since under NT ScanSysQueue() can be called to execute event messages,</span>
03397 <span class="comment">     * we make this check to be compatible.</span>
03398 <span class="comment">     */</span>
03399     <span class="keywordflow">if</span> (fsReason &amp; QS_INPUT) {
03400         <span class="keywordflow">if</span> (fRemove) {
03401             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(2);
03402             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a865">QF_LOCKNOREMOVE</a>;
03403         } <span class="keywordflow">else</span> {
03404             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(4);
03405             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a865">QF_LOCKNOREMOVE</a>;
03406         }
03407     }
03408 
03409     <span class="comment">/*</span>
03410 <span class="comment">     * Return FALSE if the current thread is not the one that lock this queue.</span>
03411 <span class="comment">     */</span>
03412     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o1">ptiSysLock</a> != ptiCurrent) {
03413         <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(8);
03414         <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a6">DUMPPATHTAKEN</a>();
03415         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03416     }
03417 
03418     ptiEventWake = ptiKeyWake = ptiMouseWake = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03419 
03420     <span class="comment">/*</span>
03421 <span class="comment">     * Initialize the thread lock structure here so we can unlock/lock in</span>
03422 <span class="comment">     * the main loop.</span>
03423 <span class="comment">     */</span>
03424     pwnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03425     <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwnd, &amp;tlpwnd);
03426 
03427 RestartScan:
03428     <a class="code" href="../../d4/d1/userk_8h.html#a11">CheckPtiSysPeek</a>(2, ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, 0);
03429     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o3">idSysPeek</a> = 0;
03430 
03431 ContinueScan:
03432     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03433         ULONG_PTR idSysPeek;
03434 
03435         <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a14">DUMPSUBPATHTAKEN</a>(pathTaken, 0xf0);
03436         <span class="comment">/*</span>
03437 <span class="comment">         * Store idSysPeek in a local which forces pq to be reloaded</span>
03438 <span class="comment">         * in case it changed during the xxx call (the compiler can</span>
03439 <span class="comment">         * evaluate the LValue at any time)</span>
03440 <span class="comment">         */</span>
03441         idSysPeek = (ULONG_PTR)<a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a48">xxxGetNextSysMsg</a>(ptiCurrent,
03442                 (<a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a>)ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o3">idSysPeek</a>, &amp;qmsg);
03443         <a class="code" href="../../d4/d1/userk_8h.html#a11">CheckPtiSysPeek</a>(3, ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, idSysPeek);
03444         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o3">idSysPeek</a> = idSysPeek;
03445 
03446         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o3">idSysPeek</a> == 0) {
03447             <span class="comment">/*</span>
03448 <span class="comment">             * If we are only looking for event messages and we didn't</span>
03449 <span class="comment">             * find any, then clear the QS_EVENT bit</span>
03450 <span class="comment">             */</span>
03451             <span class="keywordflow">if</span> (fsReason == QS_EVENT)
03452                 <a class="code" href="../../d4/d1/userk_8h.html#a1199">ClearWakeBit</a>(ptiCurrent, QS_EVENT, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03453             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x10);
03454             <span class="keywordflow">goto</span> NoMessages;
03455         }
03456 
03457         <span class="comment">/*</span>
03458 <span class="comment">         * pwnd should be locked for the duration of this routine.</span>
03459 <span class="comment">         * For most messages right out of GetNextSysMsg, this is</span>
03460 <span class="comment">         * NULL.</span>
03461 <span class="comment">         */</span>
03462         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
03463         pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.hwnd);
03464         <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwnd, &amp;tlpwnd);
03465 
03466         <span class="comment">/*</span>
03467 <span class="comment">         * See if this is an event message. If so, execute it regardless</span>
03468 <span class="comment">         * of message and window filters, but only if it is the first element</span>
03469 <span class="comment">         * of the input queue.</span>
03470 <span class="comment">         */</span>
03471         <span class="keywordflow">if</span> (qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o4">dwQEvent</a> != 0) {
03472             <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
03473 
03474             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x20);
03475             <span class="comment">/*</span>
03476 <span class="comment">             * Most event messages can be executed out of order relative to</span>
03477 <span class="comment">             * its place in the queue. There are some examples were this is</span>
03478 <span class="comment">             * not allowed, and we check that here. For example, we would not</span>
03479 <span class="comment">             * want a keystate synchronization event to be processed before</span>
03480 <span class="comment">             * the keystrokes that came before it in the queue!</span>
03481 <span class="comment">             *</span>
03482 <span class="comment">             * We need to have most event messages be able to get processed</span>
03483 <span class="comment">             * out of order because apps can be filtering for message ranges</span>
03484 <span class="comment">             * that don't include input (like dde) - those scenarios still</span>
03485 <span class="comment">             * need to process events such as deactivate event messages even</span>
03486 <span class="comment">             * if there is input in the input queue.</span>
03487 <span class="comment">             */</span>
03488             <span class="keywordflow">switch</span> (qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o4">dwQEvent</a>) {
03489             <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a337">QEVENT_UPDATEKEYSTATE</a>:
03490                 <span class="comment">/*</span>
03491 <span class="comment">                 * If the message is not the next message in the queue, don't</span>
03492 <span class="comment">                 * process it.</span>
03493 <span class="comment">                 */</span>
03494                 <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o3">idSysPeek</a> !=
03495                         (ULONG_PTR)ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>.<a class="code" href="../../d6/d1/structtagMLIST.html#o0">pqmsgRead</a>) {
03496                     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x40);
03497                     <span class="keywordflow">continue</span>;
03498                 }
03499                 <span class="keywordflow">break</span>;
03500             }
03501 
03502             <span class="comment">/*</span>
03503 <span class="comment">             * If this event isn't for this thread, wake the thread it is</span>
03504 <span class="comment">             * for.  A NULL qmsg.hti means that any thread can process</span>
03505 <span class="comment">             * the event.</span>
03506 <span class="comment">             */</span>
03507             <span class="keywordflow">if</span> (qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o5">pti</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; (pti = qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o5">pti</a>) != ptiCurrent) {
03508 
03509                 <span class="comment">/*</span>
03510 <span class="comment">                 * If somehow this event message got into the wrong queue,</span>
03511 <span class="comment">                 * then ignore it.</span>
03512 <span class="comment">                 */</span>
03513                 UserAssert(pti-&gt;pq == ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>);
03514                 <span class="keywordflow">if</span> (pti-&gt;pq != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>) {
03515                     <a class="code" href="../../d6/d3/queue_8c.html#a53">CleanEventMessage</a>((<a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a>)ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o3">idSysPeek</a>);
03516                     <a class="code" href="../../d4/d1/userk_8h.html#a1212">DelQEntry</a>(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>,
03517                             (<a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a>)ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o3">idSysPeek</a>);
03518                     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x80);
03519                     <span class="keywordflow">goto</span> RestartScan;
03520                 }
03521 
03522                 <span class="comment">/*</span>
03523 <span class="comment">                 * If ptiEventWake is already set, it means we've already</span>
03524 <span class="comment">                 * found a thread to wake for event.</span>
03525 <span class="comment">                 */</span>
03526                 <span class="keywordflow">if</span> (ptiEventWake == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03527                     ptiEventWake = pti;
03528 
03529                 <span class="comment">/*</span>
03530 <span class="comment">                 * Clear idSysPeek so that the targeted thread</span>
03531 <span class="comment">                 * can always get it.  Look at the test at the</span>
03532 <span class="comment">                 * start of this routine for more info.</span>
03533 <span class="comment">                 */</span>
03534                 <a class="code" href="../../d4/d1/userk_8h.html#a11">CheckPtiSysPeek</a>(4, ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, 0);
03535                 ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o3">idSysPeek</a> = 0;
03536                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x100);
03537                 <span class="keywordflow">goto</span> NoMessages;
03538             }
03539 
03540             <span class="comment">/*</span>
03541 <span class="comment">             * If this is called with PM_NOYIELD from a 16-bit app, skip</span>
03542 <span class="comment">             * processing any event that can generate activation messages.  An</span>
03543 <span class="comment">             * example is printing from PageMaker 5.0.  Bug #12662.</span>
03544 <span class="comment">             */</span>
03545             <span class="keywordflow">if</span> ((flags &amp; PM_NOYIELD) &amp;&amp; (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>)) {
03546                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x200);
03547                 <span class="keywordflow">switch</span> (qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o4">dwQEvent</a>) {
03548 
03549                 <span class="comment">/*</span>
03550 <span class="comment">                 * The following events are safe to process if no yield</span>
03551 <span class="comment">                 * is to occur.</span>
03552 <span class="comment">                 */</span>
03553                 <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a337">QEVENT_UPDATEKEYSTATE</a>:
03554                 <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a344">QEVENT_ASYNCSENDMSG</a>:
03555                     <span class="keywordflow">break</span>;
03556 
03557                 <span class="comment">/*</span>
03558 <span class="comment">                 * Skip all other events.</span>
03559 <span class="comment">                 */</span>
03560                 <span class="keywordflow">default</span>:
03561                     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a813">TIF_DELAYEDEVENT</a>;
03562                     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o4">dwTIFlags</a> = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a>;
03563                     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x400);
03564                     <span class="keywordflow">goto</span> ContinueScan;
03565                 }
03566             }
03567 
03568             <span class="comment">/*</span>
03569 <span class="comment">             * Delete this before it gets processed so there are no</span>
03570 <span class="comment">             * recursion problems.</span>
03571 <span class="comment">             */</span>
03572             <a class="code" href="../../d4/d1/userk_8h.html#a1212">DelQEntry</a>(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>,
03573                     (<a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a>)ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o3">idSysPeek</a>);
03574 
03575             <span class="comment">/*</span>
03576 <span class="comment">             * Clear idSysPeek before processing any events messages, because</span>
03577 <span class="comment">             * they may recurse and want to use idSysPeek.</span>
03578 <span class="comment">             */</span>
03579             <a class="code" href="../../d4/d1/userk_8h.html#a11">CheckPtiSysPeek</a>(5, ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, 0);
03580             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o3">idSysPeek</a> = 0;
03581             <a class="code" href="../../d4/d1/userk_8h.html#a1214">xxxProcessEventMessage</a>(ptiCurrent, &amp;qmsg);
03582 
03583             <span class="comment">/*</span>
03584 <span class="comment">             * Restart the scan from the start so we start with 0 in</span>
03585 <span class="comment">             * pq-&gt;idSysPeek (since that message is now gone!).</span>
03586 <span class="comment">             */</span>
03587             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x800);
03588             <span class="keywordflow">goto</span> RestartScan;
03589         }
03590 
03591         <span class="comment">/*</span>
03592 <span class="comment">         * If the reason we called was just to process event messages, don't</span>
03593 <span class="comment">         * enumerate any other mouse or key messages!</span>
03594 <span class="comment">         */</span>
03595         <span class="keywordflow">if</span> (fsReason == QS_EVENT) {
03596             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x1000);
03597             <span class="keywordflow">continue</span>;
03598         }
03599 
03600         <span class="keywordflow">switch</span> (message = qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message) {
03601         <span class="keywordflow">case</span> WM_QUEUESYNC:
03602             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x2000);
03603             <span class="comment">/*</span>
03604 <span class="comment">             * This message is for CBT. Its parameters should already be</span>
03605 <span class="comment">             * set up correctly.</span>
03606 <span class="comment">             */</span>
03607             wParam = 0;
03608             lParam = qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam;
03609 
03610             <span class="comment">/*</span>
03611 <span class="comment">             * Check if this is intended for the current app. Use the mouse</span>
03612 <span class="comment">             * bit for WM_QUEUESYNC.</span>
03613 <span class="comment">             */</span>
03614             <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd) != ptiCurrent) {
03615                 <span class="comment">/*</span>
03616 <span class="comment">                 * If this other app isn't going to read from this</span>
03617 <span class="comment">                 * queue, then skip this message. This can happen with</span>
03618 <span class="comment">                 * WM_QUEUESYNC if the app passed a window handle</span>
03619 <span class="comment">                 * to the wrong queue. This isn't likely to happen in</span>
03620 <span class="comment">                 * this case because WM_QUEUESYNCs come in while journalling,</span>
03621 <span class="comment">                 * which has all threads sharing the same queue.</span>
03622 <span class="comment">                 */</span>
03623                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>) {
03624                     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x4000);
03625                     <span class="keywordflow">goto</span> SkipMessage;
03626                 }
03627 
03628                 <span class="keywordflow">if</span> (ptiMouseWake == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03629                     ptiMouseWake = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd);
03630                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x8000);
03631                 <span class="keywordflow">goto</span> NoMessages;
03632             }
03633 
03634             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a823">CheckMsgFilter</a>(message, msgMinFilter, msgMaxFilter)) {
03635                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x10000);
03636                 <span class="keywordflow">goto</span> NoMessages;
03637             }
03638 
03639             <span class="comment">/*</span>
03640 <span class="comment">             * Eat the message.</span>
03641 <span class="comment">             */</span>
03642             <span class="keywordflow">if</span> (fRemove) {
03643                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a51">xxxSkipSysMsg</a>(ptiCurrent, &amp;qmsg);
03644             }
03645 
03646             <span class="comment">/*</span>
03647 <span class="comment">             * !!HARDWARE HOOK!! goes here.</span>
03648 <span class="comment">             */</span>
03649 
03650             <span class="comment">/*</span>
03651 <span class="comment">             * Return the message.</span>
03652 <span class="comment">             */</span>
03653             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x20000);
03654             <span class="keywordflow">goto</span> ReturnMessage;
03655             <span class="keywordflow">break</span>;
03656 
03657         <span class="comment">/*</span>
03658 <span class="comment">         * Mouse message or generic hardware messages</span>
03659 <span class="comment">         * Key messages are handled in case statements</span>
03660 <span class="comment">         * further down in this switch.</span>
03661 <span class="comment">         */</span>
03662         <span class="keywordflow">default</span>:
03663 ReprocessMsg:
03664             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a14">DUMPSUBPATHTAKEN</a>(pathTaken, 0x40000);
03665             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x40000);
03666             <span class="comment">/*</span>
03667 <span class="comment">             * !!GENERIC HARDWARE MESSAGE!! support goes here.</span>
03668 <span class="comment">             */</span>
03669 
03670             <span class="comment">/*</span>
03671 <span class="comment">             * Take the mouse position out of the message.</span>
03672 <span class="comment">             */</span>
03673             pt.x = (<span class="keywordtype">int</span>)(<span class="keywordtype">short</span>)LOWORD(qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam);
03674             pt.y = (<span class="keywordtype">int</span>)(<span class="keywordtype">short</span>)HIWORD(qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam);
03675 
03676             <span class="comment">/*</span>
03677 <span class="comment">             * Assume we have a capture.</span>
03678 <span class="comment">             */</span>
03679             part = HTCLIENT;
03680 
03681             <span class="comment">/*</span>
03682 <span class="comment">             * We have a special global we use for when we're full screen.</span>
03683 <span class="comment">             * All mouse input will go to this window.</span>
03684 <span class="comment">             */</span>
03685             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a13">gspwndScreenCapture</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03686                 <span class="comment">/*</span>
03687 <span class="comment">                 * Change the mouse coordinates to full screen.</span>
03688 <span class="comment">                 */</span>
03689                 pwnd = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a13">gspwndScreenCapture</a>;
03690                 lParam = MAKELONG((WORD)qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.pt.x,
03691                         (WORD)qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.pt.y);
03692                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x80000);
03693             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pwnd = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a>) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03694 
03695                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x100000);
03696                 <span class="comment">/*</span>
03697 <span class="comment">                 * We don't have the capture. Figure out which window owns</span>
03698 <span class="comment">                 * this message.</span>
03699 <span class="comment">                 *</span>
03700 <span class="comment">                 * NOTE: Use gptiRit and not ptiCurrent to get the desktop</span>
03701 <span class="comment">                 * window because if ptiCurrent is the thread that created</span>
03702 <span class="comment">                 * the main desktop, it's associated desktop is the logon</span>
03703 <span class="comment">                 * desktop - don't want to hittest against the logon desktop</span>
03704 <span class="comment">                 * while switched into the main desktop!</span>
03705 <span class="comment">                 */</span>
03706                 pwndT = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>;
03707 
03708                 <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwndT, &amp;tlpwndT);
03709 
03710                 hwnd = <a class="code" href="../../d9/d8/winwhere_8c.html#a4">xxxWindowHitTest</a>(pwndT, pt, &amp;part, <a class="code" href="../../d4/d1/userk_8h.html#a505">WHT_IGNOREDISABLED</a>);
03711                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
03712 
03713                 <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03714                     pwnd = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>;
03715                     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x200000);
03716                 }
03717 
03718                 <span class="keywordflow">if</span> (part == HTCLIENT) {
03719                     <span class="comment">/*</span>
03720 <span class="comment">                     * Part of the client... normal mouse message.</span>
03721 <span class="comment">                     * NO_CAP_CLIENT means "not captured, in client area</span>
03722 <span class="comment">                     * of window".</span>
03723 <span class="comment">                     */</span>
03724                     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o10">codeCapture</a> = <a class="code" href="../../d4/d1/userk_8h.html#a462">NO_CAP_CLIENT</a>;
03725                     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x400000);
03726                 } <span class="keywordflow">else</span> {
03727                     <span class="comment">/*</span>
03728 <span class="comment">                     * Not part of the client... must be an NCMOUSEMESSAGE.</span>
03729 <span class="comment">                     * NO_CAP_SYS is a creative name by raor which means</span>
03730 <span class="comment">                     * "not captured, in system area of window."</span>
03731 <span class="comment">                     */</span>
03732                     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o10">codeCapture</a> = <a class="code" href="../../d4/d1/userk_8h.html#a463">NO_CAP_SYS</a>;
03733                     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x800000);
03734                 }
03735             }
03736 
03737             <span class="comment">/*</span>
03738 <span class="comment">             * We've reassigned pwnd, so lock it.</span>
03739 <span class="comment">             */</span>
03740             <a class="code" href="../../d4/d1/userk_8h.html#a982">ThreadLockExchange</a>(pwnd, &amp;tlpwnd);
03741 
03742             <span class="keywordflow">if</span> (fOtherApp = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd) != ptiCurrent)) {
03743 
03744                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x1000000);
03745                 <span class="comment">/*</span>
03746 <span class="comment">                 * If this other app isn't going to read from this</span>
03747 <span class="comment">                 * queue, then skip this message. This can happen if</span>
03748 <span class="comment">                 * the RIT queues up a message thinking it goes to</span>
03749 <span class="comment">                 * a particular hwnd, but then by the time GetMessage()</span>
03750 <span class="comment">                 * is called for that thread, it doesn't go to that hwnd</span>
03751 <span class="comment">                 * (like in the case of mouse messages, window rearrangement</span>
03752 <span class="comment">                 * happens which changes which hwnd the mouse hits on).</span>
03753 <span class="comment">                 */</span>
03754                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>) {
03755                     <a class="code" href="../../d4/d1/userk_8h.html#a1785">zzzSetCursor</a>(<a class="code" href="../../d4/d1/userk_8h.html#a321">SYSCUR</a>(ARROW));
03756                     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x2000000);
03757                     <span class="keywordflow">goto</span> SkipMessage;
03758                 }
03759 
03760                 <span class="comment">/*</span>
03761 <span class="comment">                 * If we haven't already found a message that is intended</span>
03762 <span class="comment">                 * for another app, remember that we have one.</span>
03763 <span class="comment">                 */</span>
03764                 <span class="keywordflow">if</span> (ptiMouseWake == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03765                     ptiMouseWake = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd);
03766                     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x4000000);
03767                 }
03768             }
03769 
03770             <span class="comment">/*</span>
03771 <span class="comment">             * Map mouse coordinates based on hit test area code.</span>
03772 <span class="comment">             */</span>
03773             ptScreen = pt;
03774             <span class="keywordflow">switch</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o10">codeCapture</a>) {
03775             <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a464">CLIENT_CAPTURE</a>:
03776             <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a462">NO_CAP_CLIENT</a>:
03777 <span class="preprocessor">#ifdef USE_MIRRORING</span>
03778 <span class="preprocessor"></span>                <span class="comment">//Screen To Client</span>
03779                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WEFLAYOUTRTL)) {
03780                     pt.x = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.right - pt.x;
03781                 } <span class="keywordflow">else</span>
03782 <span class="preprocessor">#endif</span>
03783 <span class="preprocessor"></span>                {
03784                     pt.x -= pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left;
03785                 }
03786                 pt.y -= pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top;
03787                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(2);
03788                 <span class="keywordflow">break</span>;
03789 
03790             <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a465">WINDOW_CAPTURE</a>:
03791 <span class="preprocessor">#ifdef USE_MIRRORING</span>
03792 <span class="preprocessor"></span>                <span class="comment">//Screen To Window</span>
03793                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WEFLAYOUTRTL)) {
03794                     pt.x = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right - pt.x;
03795                 } <span class="keywordflow">else</span>
03796 <span class="preprocessor">#endif</span>
03797 <span class="preprocessor"></span>                {
03798                     pt.x -= pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left;
03799                 }
03800                 pt.y -= pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top;
03801                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(4);
03802                 <span class="keywordflow">break</span>;
03803             }
03804 
03805             <span class="comment">/*</span>
03806 <span class="comment">             * Track mouse moves when it moves to a different window or</span>
03807 <span class="comment">             * a different hit-test area for hot-tracking, tooltips,</span>
03808 <span class="comment">             * active window tracking and TrackMouseEvent.</span>
03809 <span class="comment">             * Mouse clicks reset tracking state too.</span>
03810 <span class="comment">             * Do it only if the message is for the current thread;</span>
03811 <span class="comment">             *  otherwise, the hit test code (part) is not valid</span>
03812 <span class="comment">             *  (it's always HTCLIENT; see xxxWindowHitTest2).</span>
03813 <span class="comment">             *  Tracking will take place when that thread wakes up</span>
03814 <span class="comment">             * We also don't do it if this thread is not on pqCursor;</span>
03815 <span class="comment">             *  that would be the case for a slow app that gets the</span>
03816 <span class="comment">             *  input message when the mouse has already left its queue</span>
03817 <span class="comment">             */</span>
03818              <span class="keywordflow">if</span> (!fOtherApp &amp;&amp; (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a31">gpqCursor</a>)) {
03819                  <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fNewpwndTrack = (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o21">spwndTrack</a> != pwnd);
03820                  <span class="keywordtype">int</span> htEx = <a class="code" href="../../d4/d1/userk_8h.html#a1970">FindNCHitEx</a>(pwnd, part, pt);
03821                  <span class="keywordflow">if</span> ((message != WM_MOUSEMOVE)
03822                         || fNewpwndTrack
03823                         || (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o22">htEx</a> != htEx)) {
03824 
03825                      <a class="code" href="../../d4/d1/userk_8h.html#a1971">xxxTrackMouseMove</a>(pwnd, htEx, message);
03826                      ValidateThreadLocks(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o1">ptl</a>, (ULONG_PTR)&amp;tlpwnd, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03827                  }
03828 
03829                  <span class="comment">/*</span>
03830 <span class="comment">                  * Reset mouse hovering if needed.</span>
03831 <span class="comment">                  *</span>
03832 <span class="comment">                  */</span>
03833                  <span class="keywordflow">if</span> (!fNewpwndTrack &amp;&amp; (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a293">DF_TRACKMOUSEHOVER</a>)) {
03834                      <span class="keywordflow">if</span> ((message != WM_MOUSEMOVE)
03835                             || !<a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o23">rcMouseHover</a>, ptScreen)) {
03836 
03837                          <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a45">ResetMouseHover</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>, ptScreen);
03838                      }
03839                  } <span class="keywordflow">else</span> {
03840                      <span class="comment">/*</span>
03841 <span class="comment">                      * Hover must be canceled.</span>
03842 <span class="comment">                      */</span>
03843                      UserAssert(!(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a293">DF_TRACKMOUSEHOVER</a>));
03844                  }
03845 
03846              } <span class="comment">/* if (!fOtherApp.... */</span>
03847 
03848             <span class="comment">/*</span>
03849 <span class="comment">             * Now see if it matches the window handle filter. If not,</span>
03850 <span class="comment">             * get the next message.</span>
03851 <span class="comment">             */</span>
03852             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1220">CheckPwndFilter</a>(pwnd, pwndFilter)) {
03853                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x8000000);
03854                 <span class="keywordflow">continue</span>;
03855             }
03856 
03857             <span class="comment">/*</span>
03858 <span class="comment">             * See if we need to map to a double click.</span>
03859 <span class="comment">             */</span>
03860             codeMouseDown = 0;
03861             <span class="keywordflow">switch</span> (message) {
03862             <span class="keywordflow">case</span> WM_LBUTTONDOWN:
03863             <span class="keywordflow">case</span> WM_RBUTTONDOWN:
03864             <span class="keywordflow">case</span> WM_MBUTTONDOWN:
03865             <span class="keywordflow">case</span> WM_XBUTTONDOWN:
03866                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a485">TestCF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a472">CFDBLCLKS</a>) ||
03867                         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o10">codeCapture</a> == <a class="code" href="../../d4/d1/userk_8h.html#a463">NO_CAP_SYS</a> ||
03868                         <a class="code" href="../../d4/d1/userk_8h.html#a1323">IsMenuStarted</a>(ptiCurrent)) {
03869                     codeMouseDown++;
03870                     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x10000000);
03871                     <span class="keywordflow">if</span> (qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.time &lt;= ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o13">timeDblClk</a> &amp;&amp;
03872                             (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a343">gbClientDoubleClickSupport</a>) &amp;&amp;
03873                             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwnd) == ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o14">hwndDblClk</a> &amp;&amp;
03874                             message == ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o11">msgDblClk</a> &amp;&amp;
03875                             (message != WM_XBUTTONDOWN ||
03876                               GET_XBUTTON_WPARAM(qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam) == ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o12">xbtnDblClk</a>)) {
03877                         RECT rcDblClk = {
03878                             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o15">ptDblClk</a>.x - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXDOUBLECLK) / 2,
03879                             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o15">ptDblClk</a>.y - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYDOUBLECLK) / 2,
03880                             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o15">ptDblClk</a>.x + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXDOUBLECLK) / 2,
03881                             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o15">ptDblClk</a>.y + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYDOUBLECLK) / 2
03882                         };
03883                         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>(&amp;rcDblClk, qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.pt)) {
03884                             message += (WM_LBUTTONDBLCLK - WM_LBUTTONDOWN);
03885                             codeMouseDown++;
03886                             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x20000000);
03887                         }
03888                     }
03889                 }
03890 
03891             <span class="comment">// FALL THROUGH!!!</span>
03892 
03893             <span class="keywordflow">case</span> WM_LBUTTONUP:
03894             <span class="keywordflow">case</span> WM_RBUTTONUP:
03895             <span class="keywordflow">case</span> WM_MBUTTONUP:
03896             <span class="keywordflow">case</span> WM_XBUTTONUP:
03897                 <span class="comment">/*</span>
03898 <span class="comment">                 * Note that the mouse button went up or down if we were</span>
03899 <span class="comment">                 * in menu status mode of alt-key down</span>
03900 <span class="comment">                 */</span>
03901 
03902                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x40000000);
03903                 <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a858">QF_FMENUSTATUS</a>) {
03904                     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a857">QF_FMENUSTATUSBREAK</a>;
03905                     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a5">PATHTAKEN</a>(0x80000000);
03906                 }
03907             }
03908 
03909             <span class="comment">/*</span>
03910 <span class="comment">             * Map message number based on hit test area code.</span>
03911 <span class="comment">             */</span>
03912             <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o10">codeCapture</a> == <a class="code" href="../../d4/d1/userk_8h.html#a463">NO_CAP_SYS</a>) {
03913                 message += (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(WM_NCMOUSEMOVE - WM_MOUSEMOVE);
03914                 wParam = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)part;
03915                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(1);
03916             }
03917 
03918             <span class="comment">/*</span>
03919 <span class="comment">             * Message number has been mapped: see if it fits the filter.</span>
03920 <span class="comment">             * If not, get the next message.</span>
03921 <span class="comment">             */</span>
03922             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a823">CheckMsgFilter</a>(message, msgMinFilter, msgMaxFilter)) {
03923                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(8);
03924                 <span class="keywordflow">continue</span>;
03925             }
03926 
03927              <span class="comment">/*</span>
03928 <span class="comment">             * If message is for another app but it fits our filter, then</span>
03929 <span class="comment">             * we should stop looking for messages: this will ensure that</span>
03930 <span class="comment">             * we don't keep looking and find and process a message that</span>
03931 <span class="comment">             * occured later than the one that should be processed by the</span>
03932 <span class="comment">             * other guy.</span>
03933 <span class="comment">             */</span>
03934             <span class="keywordflow">if</span> (fOtherApp) {
03935                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(0x10);
03936                 <span class="keywordflow">goto</span> NoMessages;
03937             }
03938 
03939             <span class="comment">/*</span>
03940 <span class="comment">             * If we're doing full drag, the mouse messages should go to</span>
03941 <span class="comment">             * the xxxMoveSize PeekMessage loop. So we get the next message.</span>
03942 <span class="comment">             * This can happen when an application does a PeekMessage in</span>
03943 <span class="comment">             * response to a message sent inside the movesize dragging loop.</span>
03944 <span class="comment">             * This causes the dragging loop to not get the WM_LBUTTONUP</span>
03945 <span class="comment">             * message and dragging continues after the button is up</span>
03946 <span class="comment">             * (fix for Micrografx Draw). -johannec</span>
03947 <span class="comment">             */</span>
03948             <span class="keywordflow">if</span> (message &gt;= WM_MOUSEFIRST &amp;&amp; message &lt;= WM_MOUSELAST &amp;&amp;
03949                     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a809">TIF_MOVESIZETRACKING</a>) {
03950                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(0x20);
03951                 <span class="keywordflow">continue</span>;
03952             }
03953 
03954             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>() &amp;&amp; (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d1/d0/inc_2user_8h.html#a808">TIF_MSGPOSCHANGED</a>)) {
03955                 ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp;= ~<a class="code" href="../../d1/d0/inc_2user_8h.html#a808">TIF_MSGPOSCHANGED</a>;
03956                 <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a>(EVENT_OBJECT_LOCATIONCHANGE, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03957                     OBJID_CURSOR, INDEXID_CONTAINER, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03958                 ValidateThreadLocks(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o1">ptl</a>, (ULONG_PTR)&amp;tlpwnd, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03959             }
03960 
03961             <span class="comment">/*</span>
03962 <span class="comment">             * Let us call the mouse hook to find out if this click is</span>
03963 <span class="comment">             * permitted by it.</span>
03964 <span class="comment">             *</span>
03965 <span class="comment">             * We want to inform the mouse hook before we test for</span>
03966 <span class="comment">             * HTNOWHERE and HTERROR; Otherwise, the mouse hook won't</span>
03967 <span class="comment">             * get these messages (sankar 12/10/91).</span>
03968 <span class="comment">             */</span>
03969             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(ptiCurrent, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a520">WHF_MOUSE</a>)) {
03970                 fMouseHookCalled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03971                 mhs.pt = qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.pt;
03972                 mhs.hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwnd);
03973                 mhs.wHitTestCode = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)part;
03974                 mhs.dwExtraInfo = qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o3">ExtraInfo</a>;
03975                 UserAssert(LOWORD(qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam) == 0);
03976                 mhs.mouseData = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam;
03977 
03978                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1523">xxxCallMouseHook</a>(message, &amp;mhs, fRemove)) {
03979                     <span class="comment">/*</span>
03980 <span class="comment">                     * Not allowed by mouse hook; so skip it.</span>
03981 <span class="comment">                     */</span>
03982                     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(0x40);
03983                     <span class="keywordflow">goto</span> SkipMessage;
03984                 }
03985                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(0x80);
03986                 ValidateThreadLocks(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o1">ptl</a>, (ULONG_PTR)&amp;tlpwnd, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03987             }
03988 
03989             <span class="comment">/*</span>
03990 <span class="comment">             * If a HTERROR or HTNOWHERE occured, send the window the</span>
03991 <span class="comment">             * WM_SETCURSOR message so it can beep or whatever. Then skip</span>
03992 <span class="comment">             * the message and try the next one.</span>
03993 <span class="comment">             */</span>
03994             <span class="keywordflow">switch</span> (part) {
03995             <span class="keywordflow">case</span> HTERROR:
03996             <span class="keywordflow">case</span> HTNOWHERE:
03997                 <span class="comment">/*</span>
03998 <span class="comment">                 * Now set the cursor shape.</span>
03999 <span class="comment">                 */</span>
04000                 <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_SETCURSOR, (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwnd),
04001                         MAKELONG(part, qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message));
04002 
04003                 <span class="comment">/*</span>
04004 <span class="comment">                 * Skip the message.</span>
04005 <span class="comment">                 */</span>
04006                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(0x100);
04007                 <span class="keywordflow">goto</span> SkipMessage;
04008                 <span class="keywordflow">break</span>;
04009             }
04010 
04011             <span class="keywordflow">if</span> (fRemove) {
04012                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(0x200);
04013                 <span class="comment">/*</span>
04014 <span class="comment">                 * Since the processing of a down click may cause the next</span>
04015 <span class="comment">                 * message to be interpreted as a double click, we only want</span>
04016 <span class="comment">                 * to do the double click setup if we're actually going to</span>
04017 <span class="comment">                 * remove the message.  Otherwise, the next time we read the</span>
04018 <span class="comment">                 * same message it would be interpreted as a double click.</span>
04019 <span class="comment">                 */</span>
04020                 <span class="keywordflow">switch</span> (codeMouseDown) {
04021                 <span class="keywordflow">case</span> 1:
04022                     <span class="comment">/*</span>
04023 <span class="comment">                     * Down clock: set up for later possible double click.</span>
04024 <span class="comment">                     */</span>
04025                     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o11">msgDblClk</a> = qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message;
04026 
04027                     <span class="comment">/*</span>
04028 <span class="comment">                     * Note that even if the following assertion were not true,</span>
04029 <span class="comment">                     * we could still put bogus data in ptiCurrent-&gt;pq-&gt;xbtnDblClk</span>
04030 <span class="comment">                     * when the message is not WM_XBUTTONDOWN, since when we check</span>
04031 <span class="comment">                     * for dblclick we compare the message number before the xbtnDblClk.</span>
04032 <span class="comment">                     */</span>
04033                     UserAssert(qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message == WM_XBUTTONDOWN || GET_XBUTTON_WPARAM(qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam) == 0);
04034                     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o12">xbtnDblClk</a> = GET_XBUTTON_WPARAM(qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam);
04035 
04036                     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o13">timeDblClk</a> = qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.time + <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a100">gdtDblClk</a>;
04037                     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o14">hwndDblClk</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwnd);
04038                     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o15">ptDblClk</a> = qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.pt;
04039                     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(0x400);
04040                     <span class="keywordflow">break</span>;
04041 
04042                 <span class="keywordflow">case</span> 2:
04043                     <span class="comment">/*</span>
04044 <span class="comment">                     * Double click: finish processing.</span>
04045 <span class="comment">                     */</span>
04046                     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o13">timeDblClk</a> = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
04047                     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(0x800);
04048                     <span class="keywordflow">break</span>;
04049 
04050                 <span class="keywordflow">default</span>:
04051                     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(0x1000);
04052                     <span class="keywordflow">break</span>;
04053                 }
04054 
04055                 <span class="comment">/*</span>
04056 <span class="comment">                 * Set mouse cursor and allow app to activate window</span>
04057 <span class="comment">                 * only if we're removing the message.</span>
04058 <span class="comment">                 */</span>
04059                 <span class="keywordflow">switch</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1232">xxxMouseActivate</a>(ptiCurrent, pwnd,
04060                         qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message, qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam, &amp;qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.pt, part)) {
04061 SkipMessage:
04062                 <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a8">MA_SKIP</a>:
04063                     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a14">DUMPSUBPATHTAKEN</a>(pathTaken2, 0x2000);
04064                     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(0x2000);
04065                     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a51">xxxSkipSysMsg</a>(ptiCurrent, &amp;qmsg);
04066 
04067                     <span class="comment">/*</span>
04068 <span class="comment">                     * Inform the CBT hook that we skipped a mouse click.</span>
04069 <span class="comment">                     */</span>
04070                     <span class="keywordflow">if</span> (fMouseHookCalled) {
04071                         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(ptiCurrent, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a518">WHF_CBT</a>)) {
04072                             <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HCBT_CLICKSKIPPED, message,
04073                                     (LPARAM)&amp;mhs, WH_CBT);
04074                             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(0x4000);
04075                         }
04076                         fMouseHookCalled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04077                     }
04078 
04079                     <span class="comment">/*</span>
04080 <span class="comment">                     * Inform the CBT hook that we skipped a key</span>
04081 <span class="comment">                     */</span>
04082                     <span class="keywordflow">if</span> (fKbdHookCalled) {
04083                         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(ptiCurrent, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a518">WHF_CBT</a>)) {
04084                             <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HCBT_KEYSKIPPED, wParam, lParam,
04085                                     WH_CBT);
04086                             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(0x8000);
04087                         }
04088                         fKbdHookCalled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04089                     }
04090 
04091                     <span class="comment">/*</span>
04092 <span class="comment">                     * If we aren't removing messages, don't reset idSysPeek</span>
04093 <span class="comment">                     * otherwise we will go into an infinite loop if</span>
04094 <span class="comment">                     * the keyboard hook says to ignore the message.</span>
04095 <span class="comment">                     * (bobgu 4/7/87).</span>
04096 <span class="comment">                     */</span>
04097                     <span class="keywordflow">if</span> (!fRemove) {
04098                         <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(0x10000);
04099                         <span class="keywordflow">goto</span> ContinueScan;
04100                     } <span class="keywordflow">else</span> {
04101                         <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(0x20000);
04102                         <span class="keywordflow">goto</span> RestartScan;
04103                     }
04104                     <span class="keywordflow">break</span>;
04105 
04106                 <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a9">MA_REHITTEST</a>:
04107                     <span class="comment">/*</span>
04108 <span class="comment">                     * Reprocess the message.</span>
04109 <span class="comment">                     */</span>
04110                     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(0x40000);
04111                     <span class="keywordflow">goto</span> ReprocessMsg;
04112                 }
04113             }
04114 
04115             <span class="comment">/*</span>
04116 <span class="comment">             * Eat the message from the input queue (and set the keystate</span>
04117 <span class="comment">             * table).</span>
04118 <span class="comment">             */</span>
04119             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(0x80000);
04120             <span class="keywordflow">if</span> (fRemove) {
04121                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a51">xxxSkipSysMsg</a>(ptiCurrent, &amp;qmsg);
04122             }
04123 
04124             <span class="keywordflow">if</span> (fRemove &amp;&amp; fMouseHookCalled &amp;&amp; <a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(ptiCurrent, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a518">WHF_CBT</a>)) {
04125                 <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HCBT_CLICKSKIPPED, message,
04126                         (LPARAM)&amp;mhs, WH_CBT);
04127             }
04128             fMouseHookCalled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04129 
04130             lParam = MAKELONG((<span class="keywordtype">short</span>)pt.x, (<span class="keywordtype">short</span>)pt.y);
04131 
04132             <span class="comment">/*</span>
04133 <span class="comment">             * Calculate virtual key state bitmask for wParam.</span>
04134 <span class="comment">             */</span>
04135             <span class="keywordflow">if</span> (message &gt;= WM_MOUSEFIRST) {
04136                 <span class="comment">/*</span>
04137 <span class="comment">                 * This is a USER mouse message. Calculate the bit mask for the</span>
04138 <span class="comment">                 * virtual key state.</span>
04139 <span class="comment">                 */</span>
04140                 wParam = <a class="code" href="../../d4/d1/userk_8h.html#a1641">GetMouseKeyFlags</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>);
04141                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(0x100000);
04142             }
04143 
04144             <span class="keywordflow">if</span> (    (WM_NCXBUTTONFIRST &lt;= message &amp;&amp; message &lt;= WM_NCXBUTTONLAST) ||
04145                     (WM_XBUTTONFIRST &lt;= message &amp;&amp; message &lt;= WM_XBUTTONLAST)) {
04146 
04147                 <span class="comment">/*</span>
04148 <span class="comment">                 * The hiword of wParam is assigned the xbutton number when</span>
04149 <span class="comment">                 * the message is queued.</span>
04150 <span class="comment">                 */</span>
04151                 UserAssert(LOWORD(qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam) == 0);
04152                 UserAssert(HIWORD(wParam) == 0);
04153                 wParam |= qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam;
04154             }
04155 
04156             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(0x200000);
04157 
04158             <span class="comment">/*</span>
04159 <span class="comment">             * If this app has a modeles menu bar,</span>
04160 <span class="comment">             *  then the menu code should get the first shot at messages on the menu</span>
04161 <span class="comment">             * Note that this assumes that xxxHandleMenuMessages</span>
04162 <span class="comment">             *  doens't need any of the stuff set after ReturnMessage</span>
04163 <span class="comment">             */</span>
04164             <span class="keywordflow">if</span> ((part == HTMENU)
04165                     &amp;&amp; fRemove
04166                     &amp;&amp; (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
04167                     &amp;&amp; ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a>-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>
04168                     &amp;&amp; (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a>-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
04169                     &amp;&amp; (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a>-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a>)) {
04170 
04171                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1398">xxxCallHandleMenuMessages</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a>, pwnd, message, wParam, lParam)) {
04172                     <span class="keywordflow">goto</span> RestartScan;
04173                 }
04174             }
04175 
04176             <span class="keywordflow">goto</span> ReturnMessage;
04177             <span class="keywordflow">break</span>;
04178 
04179         <span class="keywordflow">case</span> WM_KEYDOWN:
04180         <span class="keywordflow">case</span> WM_SYSKEYDOWN:
04181             fDown = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04182 
04183             <span class="comment">/*</span>
04184 <span class="comment">             * If we are sending keyboard input to an app that has been</span>
04185 <span class="comment">             * spinning then boost it back up.  If we don't you use spinning</span>
04186 <span class="comment">             * apps like Write or Project and do two builds in the</span>
04187 <span class="comment">             * background.  Note the app will also be unboosted again shortly</span>
04188 <span class="comment">             * after you stop typing by the old logic. #11188</span>
04189 <span class="comment">             */</span>
04190             <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a804">TIF_SPINNING</a>)
04191                 <a class="code" href="../../d6/d3/queue_8c.html#a18">CheckProcessForeground</a>(ptiCurrent);
04192 
04193             <span class="comment">/*</span>
04194 <span class="comment">             * Apps doing journal playback sometimes put trash in the hiword</span>
04195 <span class="comment">             * of wParam... zero it out here.</span>
04196 <span class="comment">             */</span>
04197             wParam = qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam &amp; 0xFF;
04198 
04199             <span class="comment">/*</span>
04200 <span class="comment">             * Clear QF_FMENUSTATUS if a key other than Alt it hit</span>
04201 <span class="comment">             * since this means the break of the Alt wouldn't be a</span>
04202 <span class="comment">             * menu key anymore.</span>
04203 <span class="comment">             */</span>
04204             <span class="keywordflow">if</span> (wParam != VK_MENU)
04205                 ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp;= ~(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a858">QF_FMENUSTATUS</a>|<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a857">QF_FMENUSTATUSBREAK</a>);
04206 
04207             <span class="comment">/*</span>
04208 <span class="comment">             * Check for keyboard language toggle.  Build the key state</span>
04209 <span class="comment">             * here for use during key up processing (where the layout</span>
04210 <span class="comment">             * switching takes place.  This code is skipped if layout</span>
04211 <span class="comment">             * switching via the keyboard is disabled.</span>
04212 <span class="comment">             */</span>
04213             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a65">gLangToggle</a>[0].<a class="code" href="../../d2/d9/structtagKBDLANGTOGGLE.html#o0">bVkey</a> &amp;&amp; (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a66">gLangToggleKeyState</a> &lt; <a class="code" href="../../d4/d1/userk_8h.html#a284">KLT_NONE</a>)) {
04214                 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> i;
04215                 <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> scancode = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(HIWORD(qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam));
04216                 <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> vkey = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam);
04217 
04218                 <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d4/d1/userk_8h.html#a620">LANGTOGGLEKEYS_SIZE</a>; i++) {
04219                     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a65">gLangToggle</a>[i].<a class="code" href="../../d2/d9/structtagKBDLANGTOGGLE.html#o1">bScan</a>) {
04220                         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a65">gLangToggle</a>[i].<a class="code" href="../../d2/d9/structtagKBDLANGTOGGLE.html#o1">bScan</a> == scancode) {
04221                             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a66">gLangToggleKeyState</a> |= <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a65">gLangToggle</a>[i].<a class="code" href="../../d2/d9/structtagKBDLANGTOGGLE.html#o2">iBitPosition</a>;
04222                             <span class="keywordflow">break</span>;
04223                         }
04224                     } <span class="keywordflow">else</span> {
04225                         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a65">gLangToggle</a>[i].<a class="code" href="../../d2/d9/structtagKBDLANGTOGGLE.html#o0">bVkey</a> == vkey) {
04226                             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a66">gLangToggleKeyState</a> |= <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a65">gLangToggle</a>[i].<a class="code" href="../../d2/d9/structtagKBDLANGTOGGLE.html#o2">iBitPosition</a>;
04227                             <span class="keywordflow">break</span>;
04228                         }
04229                     }
04230                 }
04231 
04232                 <span class="keywordflow">if</span> (i == <a class="code" href="../../d4/d1/userk_8h.html#a620">LANGTOGGLEKEYS_SIZE</a>) {
04233                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a66">gLangToggleKeyState</a> = <a class="code" href="../../d4/d1/userk_8h.html#a284">KLT_NONE</a>;   <span class="comment">// not a language toggle combination</span>
04234                 }
04235             }
04236 
04237             <span class="comment">/*</span>
04238 <span class="comment">             * Check if it is the PrintScrn key.</span>
04239 <span class="comment">             */</span>
04240             fAlt = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_MENU);
04241             <span class="keywordflow">if</span> (wParam == VK_SNAPSHOT &amp;&amp;
04242                 ((fAlt &amp;&amp; !(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o46">fsReserveKeys</a> &amp; CONSOLE_ALTPRTSC)) ||
04243                  (!fAlt &amp;&amp; !(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o46">fsReserveKeys</a> &amp; CONSOLE_PRTSC)))) {
04244 
04245                 <span class="comment">/*</span>
04246 <span class="comment">                 * Remove this message from the input queue.</span>
04247 <span class="comment">                 */</span>
04248                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(0x400000);
04249                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a51">xxxSkipSysMsg</a>(ptiCurrent, &amp;qmsg);
04250 
04251                 <span class="comment">/*</span>
04252 <span class="comment">                 * PRINTSCREEN          -&gt; Snap the whole screen.</span>
04253 <span class="comment">                 * ALT-PRINTSCREEN      -&gt; Snap the current window.</span>
04254 <span class="comment">                 */</span>
04255                 pwndT = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>;
04256 
04257                 <span class="comment">/*</span>
04258 <span class="comment">                 * check also the scan code to see if we got here</span>
04259 <span class="comment">                 * through keybd_event(VK_SNAPSHOT, ...</span>
04260 <span class="comment">                 * the scan code is in lParam bits 16-23</span>
04261 <span class="comment">                 */</span>
04262                 <span class="keywordflow">if</span> (!fAlt &amp;&amp; ((qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam &amp; 0x00FF0000) != 0x00010000)) {
04263                     pwndT = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>;
04264                 }
04265 
04266                 <span class="keywordflow">if</span> (pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04267                     <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwndT, &amp;tlpwndT);
04268                     <a class="code" href="../../d4/d1/userk_8h.html#a1528">xxxSnapWindow</a>(pwndT);
04269                     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
04270                 }
04271 
04272                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(0x800000);
04273                 <span class="keywordflow">goto</span> RestartScan;
04274             }
04275 
04276             <span class="comment">/*</span>
04277 <span class="comment">             * Check for hot keys being hit if any are defined.</span>
04278 <span class="comment">             */</span>
04279             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a116">gcHotKey</a> != 0 &amp;&amp; (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a68">gfEnableHexNumpad</a> || (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a67">gfInNumpadHexInput</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a489">NUMPAD_HEXMODE_HL</a>) == 0)) {
04280                 <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> key;
04281                 key = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wParam;
04282 
04283                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_MENU))
04284                     key |= 0x0400;
04285 
04286                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_CONTROL))
04287                     key |= 0x0200;
04288 
04289                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_SHIFT))
04290                     key |= 0x0100;
04291 
04292                 pwndT = <a class="code" href="../../d7/d7/winhtky_8c.html#a0">HotKeyToWindow</a>(key);
04293 
04294                 <span class="keywordflow">if</span> (pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04295                     <span class="comment">/*</span>
04296 <span class="comment">                     * VK_PACKET shouldn't be a hot key.</span>
04297 <span class="comment">                     */</span>
04298                     UserAssert((key &amp; 0xff) != VK_PACKET);
04299 
04300                     <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>, WM_SYSCOMMAND,
04301                                 (WPARAM)SC_HOTKEY, (LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwndT));
04302 
04303                     <span class="comment">/*</span>
04304 <span class="comment">                     * Remove this message from the input queue.</span>
04305 <span class="comment">                     */</span>
04306                     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a51">xxxSkipSysMsg</a>(ptiCurrent, &amp;qmsg);
04307                     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(0x1000000);
04308                     <span class="keywordflow">goto</span> RestartScan;
04309                 }
04310 
04311                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(0x2000000);
04312             }
04313 
04314 <span class="preprocessor">#if DBG</span>
04315 <span class="preprocessor"></span>            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a67">gfInNumpadHexInput</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a489">NUMPAD_HEXMODE_HL</a>) {
04316                 RIPMSG0(RIP_VERBOSE, <span class="stringliteral">"xxxScanSysQueue: gfInNumpadHexInput is true, so we skipped hotkey."</span>);
04317             }
04318 <span class="preprocessor">#endif</span>
04319 <span class="preprocessor"></span>
04320             <span class="keywordflow">if</span> (wParam == VK_PACKET) {
04321                 <span class="comment">/*</span>
04322 <span class="comment">                 * Save the character in thread's cache for TranslateMessage</span>
04323 <span class="comment">                 */</span>
04324                 ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o45">wchInjected</a> = HIWORD(qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam);
04325                 qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam = wParam;
04326                 UserAssert(qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam == VK_PACKET);
04327             }
04328 
04329             <span class="comment">/*</span>
04330 <span class="comment">             * Fall through.</span>
04331 <span class="comment">             */</span>
04332 
04333         <span class="keywordflow">case</span> WM_SYSKEYUP:
04334         <span class="keywordflow">case</span> WM_KEYUP:
04335             wParam = qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam &amp; 0xFF;
04336             <span class="keywordflow">if</span> (wParam == VK_PACKET) {
04337                 qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam = wParam;
04338             }
04339 
04340             <span class="comment">/*</span>
04341 <span class="comment">             * Special processing for thai locale toggle using grave accent key</span>
04342 <span class="comment">             * Remove key message irrespective of fDown otherwise it will</span>
04343 <span class="comment">             * generate WM_CHAR message</span>
04344 <span class="comment">             */</span>
04345             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a69">gbGraveKeyToggle</a> &amp;&amp;
04346                 <span class="comment">//</span>
04347                 <span class="comment">// In case of mstsc.exe, should not eat Grave Accent key message.</span>
04348                 <span class="comment">// TS client must send Grave Accent key message to server side.</span>
04349                 <span class="comment">//</span>
04350                 !(<a class="code" href="../../d6/d3/queue_8c.html#a36">GetAppImeCompatFlags</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp; IMECOMPAT_HYDRACLIENT) &amp;&amp;
04351                 <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(HIWORD(qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam)) == SCANCODE_THAI_LAYOUT_TOGGLE &amp;&amp;
04352                 fRemove &amp;&amp;
04353                 !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_SHIFT)   &amp;&amp;
04354                 !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_MENU)    &amp;&amp;
04355                 !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_CONTROL) &amp;&amp;
04356                 !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_LWIN)    &amp;&amp;
04357                 !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_RWIN)){
04358 
04359                 <span class="keywordflow">if</span> ((pwnd = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>){
04360                     pwnd = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>;
04361                 }
04362 
04363                 <span class="comment">/*</span>
04364 <span class="comment">                 * Post message only on WM_KEYUP</span>
04365 <span class="comment">                 */</span>
04366                 <span class="keywordflow">if</span> (!fDown &amp;&amp; pwnd){
04367                     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>     ptiToggle = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd);
04368                     <a class="code" href="../../d4/d9/structtagKL.html">PKL</a>             pkl = ptiToggle-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>;
04369 
04370                     <span class="keywordflow">if</span> (pkl &amp;&amp; (pkl = <a class="code" href="../../d4/d1/userk_8h.html#a1019">HKLtoPKL</a>(ptiToggle, (HKL)HKL_NEXT))) {
04371                         <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(
04372                             pwnd,
04373                             WM_INPUTLANGCHANGEREQUEST,
04374                             (WPARAM)(((pkl-&gt;dwFontSigs &amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a64">gSystemFS</a>) ? INPUTLANGCHANGE_SYSCHARSET : 0) | INPUTLANGCHANGE_FORWARD),
04375                             (LPARAM)pkl-&gt;hkl
04376                             );
04377                     }
04378                 }
04379                 <span class="comment">/*</span>
04380 <span class="comment">                 * eat Accent Grave's key msgs</span>
04381 <span class="comment">                 */</span>
04382                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a51">xxxSkipSysMsg</a>(ptiCurrent, &amp;qmsg);
04383                 <span class="keywordflow">goto</span> RestartScan;
04384             }
04385 
04386             <span class="comment">/*</span>
04387 <span class="comment">             * Process keyboard toggle keys only if this is</span>
04388 <span class="comment">             * a break event and fRemove == TRUE.  Some apps,</span>
04389 <span class="comment">             * for instance Word 95, call PeekMessage with</span>
04390 <span class="comment">             * PM_NOREMOVE followed by a call with PM_REMOVE.</span>
04391 <span class="comment">             * We only want to process this once.  Skip all</span>
04392 <span class="comment">             * of this is layout switching via the keyboard</span>
04393 <span class="comment">             * is disabled.</span>
04394 <span class="comment">             */</span>
04395             <span class="keywordflow">if</span> (!fDown &amp;&amp; fRemove &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a65">gLangToggle</a>[0].<a class="code" href="../../d2/d9/structtagKBDLANGTOGGLE.html#o0">bVkey</a>) {
04396                 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bDropToggle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04397                 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwDirection = 0;
04398                 <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pkl;
04399                 <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiToggle;
04400                 <span class="comment">// PWND pwndTop;</span>
04401                 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bArabicSwitchPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04402                 LCID lcid;
04403 
04404                 ZwQueryDefaultLocale(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;lcid);
04405 
04406                 pwnd = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>;
04407                 <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04408                     pwnd = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>;
04409                     <span class="keywordflow">if</span> (!pwnd) {
04410                         <span class="keywordflow">goto</span> NoLayoutSwitch;
04411                     }
04412                 }
04413 
04414                 ptiToggle = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd);
04415                 pkl = ptiToggle-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>;
04416                 UserAssert(ptiToggle-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04417 
04418                 <span class="comment">/*</span>
04419 <span class="comment">                 * Check for Arabic toggle context</span>
04420 <span class="comment">                 */</span>
04421                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a66">gLangToggleKeyState</a> &lt; <a class="code" href="../../d4/d1/userk_8h.html#a284">KLT_NONE</a> &amp;&amp; PRIMARYLANGID(lcid) == LANG_ARABIC){
04422                     <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pkl_next = <a class="code" href="../../d4/d1/userk_8h.html#a1019">HKLtoPKL</a> (ptiToggle, (HKL)HKL_NEXT);
04423 
04424                     <span class="comment">/*</span>
04425 <span class="comment">                     * test if there are exactly two pkl's and at least one</span>
04426 <span class="comment">                     * of them is arabic</span>
04427 <span class="comment">                     */</span>
04428                     <span class="keywordflow">if</span> (pkl &amp;&amp; pkl_next &amp;&amp;
04429                         pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a> != pkl_next-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a> &amp;&amp; pkl_next == <a class="code" href="../../d4/d1/userk_8h.html#a1019">HKLtoPKL</a>(ptiToggle, (HKL)HKL_PREV) &amp;&amp;
04430                         (PRIMARYLANGID(HandleToUlong(pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>)) == LANG_ARABIC || PRIMARYLANGID(HandleToUlong(pkl_next-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>)) == LANG_ARABIC)){
04431                         bArabicSwitchPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04432                     }
04433                 }
04434 
04435                 <span class="comment">/*</span>
04436 <span class="comment">                 * NT has always had Alt LShift going forward (down) the list,</span>
04437 <span class="comment">                 * and Alt RShift going backwards. Windows '95 is different.</span>
04438 <span class="comment">                 */</span>
04439                 <span class="keywordflow">switch</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a66">gLangToggleKeyState</a>) {
04440                 <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a280">KLT_ALTLEFTSHIFT</a>:
04441                    bDropToggle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04442                    dwDirection = INPUTLANGCHANGE_FORWARD;
04443                    <span class="keywordflow">if</span> (!bArabicSwitchPresent || PRIMARYLANGID(HandleToUlong(pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>)) == LANG_ARABIC){
04444                        pkl = <a class="code" href="../../d4/d1/userk_8h.html#a1019">HKLtoPKL</a>(ptiToggle, (HKL)HKL_NEXT);
04445                    }
04446                    <span class="keywordflow">break</span>;
04447 
04448                 <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a282">KLT_ALTRIGHTSHIFT</a>:
04449                    bDropToggle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04450                    dwDirection = INPUTLANGCHANGE_BACKWARD;
04451                    <span class="keywordflow">if</span> (!bArabicSwitchPresent || PRIMARYLANGID(HandleToUlong(pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>)) != LANG_ARABIC){
04452                        pkl = <a class="code" href="../../d4/d1/userk_8h.html#a1019">HKLtoPKL</a>(ptiToggle, (HKL)HKL_PREV);
04453                    }
04454                    <span class="keywordflow">break</span>;
04455 
04456                 <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a283">KLT_ALTBOTHSHIFTS</a>:
04457                    pkl = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a62">gspklBaseLayout</a>;
04458                    <span class="keywordflow">break</span>;
04459 
04460                 <span class="keywordflow">default</span>:
04461                    <span class="keywordflow">goto</span> NoLayoutSwitch;
04462                    <span class="keywordflow">break</span>;
04463                 }
04464 
04465                 <span class="keywordflow">if</span> (pkl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04466                     pkl = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;spklActive;
04467                 }
04468 
04469                 <span class="comment">/*</span>
04470 <span class="comment">                 * If these two are not NULL, then winlogon hasn't loaded</span>
04471 <span class="comment">                 * any keyboard layouts yet: but nobody should be getting</span>
04472 <span class="comment">                 * input yet, so Assert but check pkl anyway. #99321</span>
04473 <span class="comment">                 */</span>
04474                 UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a62">gspklBaseLayout</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04475                 UserAssert(pkl);
04476                 <span class="keywordflow">if</span> (pkl) {
04477                     <span class="comment">/*</span>
04478 <span class="comment">                     * Not a very satisfactory window to post to, but it's hard</span>
04479 <span class="comment">                     * to figure out a better window. Just do as Memphis does.</span>
04480 <span class="comment">                     * Note: The following went up too high, bypassing Word</span>
04481 <span class="comment">                     * when using wordmail - IanJa bug #64744.</span>
04482 <span class="comment">                     *    if ((pwndTop = GetTopLevelWindow(pwnd)) != NULL) {</span>
04483 <span class="comment">                     *       pwnd = pwndTop;</span>
04484 <span class="comment">                     *    }</span>
04485 <span class="comment">                     */</span>
04486                     <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwnd, WM_INPUTLANGCHANGEREQUEST,
04487                             (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(((pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o6">dwFontSigs</a> &amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a64">gSystemFS</a>) ? INPUTLANGCHANGE_SYSCHARSET : 0) | dwDirection),
04488                             (LPARAM)pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>);
04489                 }
04490 
04491 NoLayoutSwitch:
04492 
04493                 <span class="keywordflow">if</span> (bDropToggle) {
04494                     <span class="comment">/*</span>
04495 <span class="comment">                     * Clear this key from the key state so that multiple key</span>
04496 <span class="comment">                     * presses will work (i.e., Alt+Shft+Shft).  We don't do</span>
04497 <span class="comment">                     * this when both shift keys are pressed simultaneously to</span>
04498 <span class="comment">                     * avoid two activates.</span>
04499 <span class="comment">                     */</span>
04500                     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> i;
04501                     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> scancode = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(HIWORD(qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam));
04502                     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> vkey = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam);
04503 
04504                     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d4/d1/userk_8h.html#a620">LANGTOGGLEKEYS_SIZE</a>; i++) {
04505                         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a65">gLangToggle</a>[i].<a class="code" href="../../d2/d9/structtagKBDLANGTOGGLE.html#o1">bScan</a>) {
04506                             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a65">gLangToggle</a>[i].<a class="code" href="../../d2/d9/structtagKBDLANGTOGGLE.html#o1">bScan</a> == scancode) {
04507                                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a66">gLangToggleKeyState</a> &amp;= ~(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a65">gLangToggle</a>[i].<a class="code" href="../../d2/d9/structtagKBDLANGTOGGLE.html#o2">iBitPosition</a>);
04508                             }
04509                         } <span class="keywordflow">else</span> {
04510                             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a65">gLangToggle</a>[i].<a class="code" href="../../d2/d9/structtagKBDLANGTOGGLE.html#o0">bVkey</a> == vkey) {
04511                                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a66">gLangToggleKeyState</a> &amp;= ~(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a65">gLangToggle</a>[i].<a class="code" href="../../d2/d9/structtagKBDLANGTOGGLE.html#o2">iBitPosition</a>);
04512                             }
04513                         }
04514                     }
04515                 } <span class="keywordflow">else</span> {
04516                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a66">gLangToggleKeyState</a> = 0;
04517                 }
04518             }
04519 
04520             <span class="comment">/*</span>
04521 <span class="comment">             * Convert F10 to syskey for new apps.</span>
04522 <span class="comment">             */</span>
04523             <span class="keywordflow">if</span> (wParam == VK_F10)
04524                 message |= (WM_SYSKEYDOWN - WM_KEYDOWN);
04525 
04526             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_CONTROL) &amp;&amp;
04527                     wParam == VK_ESCAPE) {
04528                 message |= (WM_SYSKEYDOWN - WM_KEYDOWN);
04529             }
04530 
04531             <span class="comment">/*</span>
04532 <span class="comment">             * Clear the 'simulated keystroke' bit for all applications except</span>
04533 <span class="comment">             * console so it can pass it to 16-bit vdms. VDM keyboards need to</span>
04534 <span class="comment">             * distinguish between AltGr (where Ctrl keystroke is simulated)</span>
04535 <span class="comment">             * and a real Ctrl+Alt. Check TIF_CSRSSTHREAD for the console</span>
04536 <span class="comment">             * input thread because it lives in the server. This is a cheap</span>
04537 <span class="comment">             * way to check for it.</span>
04538 <span class="comment">             */</span>
04539             <span class="keywordflow">if</span> (!(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a798">TIF_CSRSSTHREAD</a>))
04540                 qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam &amp;= ~FAKE_KEYSTROKE;
04541             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(0x4000000);
04542 
04543             <span class="comment">/*</span>
04544 <span class="comment">             * Fall through.</span>
04545 <span class="comment">             */</span>
04546 
04547             <span class="comment">/*</span>
04548 <span class="comment">             * Some apps want to be able to feed WM_CHAR messages through</span>
04549 <span class="comment">             * the playback hook. Why? Because they want to be able to</span>
04550 <span class="comment">             * convert a string of characters info key messages</span>
04551 <span class="comment">             * and feed them to themselves or other apps. Unfortunately,</span>
04552 <span class="comment">             * there are no machine independent virtual key codes for</span>
04553 <span class="comment">             * some characters (for example '$'), so they need to send</span>
04554 <span class="comment">             * those through as WM_CHARs. (6/10/87).</span>
04555 <span class="comment">             */</span>
04556 
04557         <span class="keywordflow">case</span> WM_CHAR:
04558             wParam = qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam &amp; 0xFF;
04559 
04560             <span class="comment">/*</span>
04561 <span class="comment">             * Assign the input to the focus window. If there is no focus</span>
04562 <span class="comment">             * window, assign it to the active window as a SYS message.</span>
04563 <span class="comment">             */</span>
04564             pwnd = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>;
04565             <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04566                 <span class="keywordflow">if</span> ((pwnd = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04567                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a823">CheckMsgFilter</a>(message, WM_KEYDOWN, WM_DEADCHAR)) {
04568                         message += (WM_SYSKEYDOWN - WM_KEYDOWN);
04569                         <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(0x8000000);
04570                     }
04571                 } <span class="keywordflow">else</span> {
04572                     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(0x10000000);
04573                     <span class="keywordflow">goto</span> SkipMessage;
04574                 }
04575             }
04576 
04577             <span class="comment">/*</span>
04578 <span class="comment">             * If there is no active window or focus window, eat this</span>
04579 <span class="comment">             * message.</span>
04580 <span class="comment">             */</span>
04581             <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04582                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(0x20000000);
04583                 <span class="keywordflow">goto</span> SkipMessage;
04584             }
04585 
04586             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
04587             <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwnd, &amp;tlpwnd);
04588 
04589             <span class="comment">/*</span>
04590 <span class="comment">             * Check if this is intended for the current app.</span>
04591 <span class="comment">             */</span>
04592             <span class="keywordflow">if</span> (fOtherApp = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd) != ptiCurrent)) {
04593                 <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndModalLoop;
04594 
04595                 <span class="comment">/*</span>
04596 <span class="comment">                 * If this other app isn't going to read from this</span>
04597 <span class="comment">                 * queue, then skip this message. This can happen if</span>
04598 <span class="comment">                 * the RIT queues up a message thinking it goes to</span>
04599 <span class="comment">                 * a particular hwnd, but then by the time GetMessage()</span>
04600 <span class="comment">                 * is called for that thread, it doesn't go to that hwnd</span>
04601 <span class="comment">                 * (like in the case of mouse messages, window rearrangement</span>
04602 <span class="comment">                 * happens which changes which hwnd the mouse hits on).</span>
04603 <span class="comment">                 */</span>
04604                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>) {
04605                     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(0x40000000);
04606                     <span class="keywordflow">goto</span> SkipMessage;
04607                 }
04608 
04609                 <span class="comment">/*</span>
04610 <span class="comment">                 * If the current thread is in the menu or movesize loop</span>
04611 <span class="comment">                 *  then we need to give it the input</span>
04612 <span class="comment">                 */</span>
04613                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1322">IsInsideMenuLoop</a>(ptiCurrent)) {
04614                     pwndModalLoop = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a>-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>;
04615                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o30">pmsd</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04616                     pwndModalLoop = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o30">pmsd</a>-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o0">spwnd</a>;
04617                     RIPMSG0(RIP_WARNING, <span class="stringliteral">"xxxScanSysQueue: returning key to movesize loop"</span>);
04618                 } <span class="keywordflow">else</span> {
04619                     pwndModalLoop = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04620                 }
04621 
04622                 <span class="comment">/*</span>
04623 <span class="comment">                 * If we're switching windows, lock the new one</span>
04624 <span class="comment">                 */</span>
04625                 <span class="keywordflow">if</span> (pwndModalLoop != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04626                     pwnd = pwndModalLoop;
04627                     fOtherApp = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd) != ptiCurrent);
04628                     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
04629                     <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwnd, &amp;tlpwnd);
04630                     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(0x80000000);
04631                 }
04632 
04633                 <span class="comment">/*</span>
04634 <span class="comment">                 * If not for us, then remember who it is for.</span>
04635 <span class="comment">                 */</span>
04636                 <span class="keywordflow">if</span> (ptiKeyWake == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04637                     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a12">PATHTAKEN3</a>(1);
04638                     ptiKeyWake = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd);
04639                 }
04640             }
04641 
04642             <span class="comment">/*</span>
04643 <span class="comment">             * See if this thing matches our filter.</span>
04644 <span class="comment">             */</span>
04645             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a823">CheckMsgFilter</a>(message, msgMinFilter, msgMaxFilter) ||
04646                     !<a class="code" href="../../d4/d1/userk_8h.html#a1220">CheckPwndFilter</a>(pwnd, pwndFilter)) {
04647                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a12">PATHTAKEN3</a>(2);
04648                 <span class="keywordflow">continue</span>;
04649             }
04650 
04651             <span class="comment">/*</span>
04652 <span class="comment">             * This message matches our filter. If it is not for us then</span>
04653 <span class="comment">             * stop searching to make sure the real owner processes this</span>
04654 <span class="comment">             * message first.</span>
04655 <span class="comment">             */</span>
04656             <span class="keywordflow">if</span> (fOtherApp) {
04657                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a12">PATHTAKEN3</a>(4);
04658                 <span class="keywordflow">goto</span> NoMessages;
04659             }
04660 
04661             <span class="comment">/*</span>
04662 <span class="comment">             * Generate some special messages if we are removing and we are</span>
04663 <span class="comment">             * not inside the menu loop.</span>
04664 <span class="comment">             */</span>
04665             <span class="keywordflow">if</span> (fRemove &amp;&amp; !<a class="code" href="../../d4/d1/userk_8h.html#a1322">IsInsideMenuLoop</a>(ptiCurrent)) {
04666                 <span class="comment">/*</span>
04667 <span class="comment">                 * Generate a WM_CONTEXTMENU for the VK_APPS key</span>
04668 <span class="comment">                 */</span>
04669                 <span class="keywordflow">if</span> ((wParam == VK_APPS) &amp;&amp; (message == WM_KEYUP)) {
04670                     <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwnd, WM_CONTEXTMENU, (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pwnd), <a class="code" href="../../d4/d1/userk_8h.html#a461">KEYBOARD_MENU</a>);
04671                 }
04672 
04673                 <span class="comment">/*</span>
04674 <span class="comment">                 * If this is a WM_KEYDOWN message for F1 key then we must generate</span>
04675 <span class="comment">                 * the WM_KEYF1 message.</span>
04676 <span class="comment">                 */</span>
04677                 <span class="keywordflow">if</span> ((wParam == VK_F1) &amp;&amp; (message == WM_KEYDOWN)) {
04678                     <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwnd, WM_KEYF1, 0, 0);
04679                 }
04680             }
04681 
04682             <span class="comment">/*</span>
04683 <span class="comment">             * If one Shift key is released while the other Shift key is held</span>
04684 <span class="comment">             * down, this keystroke is normally skipped, presumably to prevent</span>
04685 <span class="comment">             * applications from thinking that the shift condition no longer</span>
04686 <span class="comment">             * applies.</span>
04687 <span class="comment">             */</span>
04688             <span class="keywordflow">if</span> (wParam == VK_SHIFT) {
04689                 <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> vkHanded, vkOtherHand;
04690 
04691                 <span class="keywordflow">if</span> (qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam &amp; EXTENDED_BIT) {
04692                     vkHanded = VK_RSHIFT;
04693                 } <span class="keywordflow">else</span> {
04694                     vkHanded = VK_LSHIFT;
04695                 }
04696                 vkOtherHand = vkHanded ^ 1;
04697 
04698                 <span class="keywordflow">if</span> (!fDown &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, vkOtherHand)) {
04699                     <span class="comment">/*</span>
04700 <span class="comment">                     * Unlike normal apps, Console MUST be sent a Shift break</span>
04701 <span class="comment">                     * even when the other Shift key is still down, since it</span>
04702 <span class="comment">                     * has to be passed on to VDM, which maintains it's own</span>
04703 <span class="comment">                     * state. Check TIF_CSRSSTHREAD for the console input</span>
04704 <span class="comment">                     * thread because it lives in the server. This is a cheap</span>
04705 <span class="comment">                     * way to check for it.</span>
04706 <span class="comment">                     */</span>
04707                     <span class="keywordflow">if</span> ((ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a798">TIF_CSRSSTHREAD</a>) == 0) {
04708                         <span class="comment">/*</span>
04709 <span class="comment">                         * We ignore this key event, so we must update</span>
04710 <span class="comment">                         * it's key state whether fRemove is TRUE or not.</span>
04711 <span class="comment">                         * (ignoring an key event is same as removing it)</span>
04712 <span class="comment">                         */</span>
04713                         qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam = vkHanded;
04714                         <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a51">xxxSkipSysMsg</a>(ptiCurrent, &amp;qmsg);
04715                         <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a12">PATHTAKEN3</a>(8);
04716                         <span class="keywordflow">goto</span> RestartScan;
04717                     }
04718                     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a12">PATHTAKEN3</a>(0x10);
04719                 }
04720             }
04721 
04722             <span class="comment">/*</span>
04723 <span class="comment">             * Get the previous up/down state of the key here since</span>
04724 <span class="comment">             * SkipSysMsg() sets the key state table and destroys</span>
04725 <span class="comment">             * the previous state info.</span>
04726 <span class="comment">             */</span>
04727             fPrevDown = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04728             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, wParam))
04729                 fPrevDown = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04730 
04731             <span class="comment">/*</span>
04732 <span class="comment">             * Eat the message from the input queue and set the keystate</span>
04733 <span class="comment">             * table.</span>
04734 <span class="comment">             */</span>
04735             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a12">PATHTAKEN3</a>(0x20);
04736             <span class="keywordflow">if</span> (fRemove) {
04737                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a51">xxxSkipSysMsg</a>(ptiCurrent, &amp;qmsg);
04738             }
04739 
04740             <span class="comment">/*</span>
04741 <span class="comment">             * This gets us the LOWORD of lParam, the repeat count,</span>
04742 <span class="comment">             * the bit in the hi byte indicating whether this is an extended</span>
04743 <span class="comment">             * key, and the scan code.  We also need to re-get the wParam in</span>
04744 <span class="comment">             * case xxxSkipSysMsg called a hook which modified the message.</span>
04745 <span class="comment">             * AfterDark's password protection does this.</span>
04746 <span class="comment">             */</span>
04747             lParam = qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam;
04748             wParam = qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam;
04749 
04750             <span class="comment">/*</span>
04751 <span class="comment">             * Indicate if it was previously down.</span>
04752 <span class="comment">             */</span>
04753             <span class="keywordflow">if</span> (fPrevDown)
04754                 lParam |= 0x40000000;           <span class="comment">// KF_REPEAT</span>
04755 
04756             <span class="comment">/*</span>
04757 <span class="comment">             * Set the transition bit.</span>
04758 <span class="comment">             */</span>
04759             <span class="keywordflow">switch</span> (message) {
04760             <span class="keywordflow">case</span> WM_KEYUP:
04761             <span class="keywordflow">case</span> WM_SYSKEYUP:
04762                 lParam |= 0x80000000;           <span class="comment">// KF_UP</span>
04763                 <span class="keywordflow">break</span>;
04764             }
04765 
04766             <span class="comment">/*</span>
04767 <span class="comment">             * Set the alt key down bit.</span>
04768 <span class="comment">             */</span>
04769             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_MENU)) {
04770                 lParam |= 0x20000000;           <span class="comment">// KF_ALTDOWN</span>
04771             }
04772 
04773             <span class="comment">/*</span>
04774 <span class="comment">             * Set the menu state flag.</span>
04775 <span class="comment">             */</span>
04776             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1323">IsMenuStarted</a>(ptiCurrent)) {
04777                 lParam |= 0x10000000;           <span class="comment">// KF_MENUMODE</span>
04778             }
04779 
04780             <span class="comment">/*</span>
04781 <span class="comment">             * Set the dialog state flag.</span>
04782 <span class="comment">             */</span>
04783             <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a867">QF_DIALOGACTIVE</a>) {
04784                 lParam |= 0x08000000;           <span class="comment">// KF_DLGMODE</span>
04785             }
04786 
04787             <span class="comment">/*</span>
04788 <span class="comment">             * 0x80000000 is set if up, clear if down</span>
04789 <span class="comment">             * 0x40000000 is previous up/down state of key</span>
04790 <span class="comment">             * 0x20000000 is whether the alt key is down</span>
04791 <span class="comment">             * 0x10000000 is whether currently in menumode.</span>
04792 <span class="comment">             * 0x08000000 is whether in dialog mode</span>
04793 <span class="comment">             * 0x04000000 is not used</span>
04794 <span class="comment">             * 0x02000000 is not used</span>
04795 <span class="comment">             * 0x01000000 is whether this is an extended keyboard key</span>
04796 <span class="comment">             *</span>
04797 <span class="comment">             * Low word is repeat count, low byte hiword is scan code,</span>
04798 <span class="comment">             * hi byte hiword is all these bits.</span>
04799 <span class="comment">             */</span>
04800 
04801             <span class="comment">/*</span>
04802 <span class="comment">             * Callback the client IME before calling the keyboard hook.</span>
04803 <span class="comment">             * If the vkey is one of the IME hotkeys, the vkey will not</span>
04804 <span class="comment">             * be passed to the keyboard hook.</span>
04805 <span class="comment">             * If IME needs this vkey, VK_PROCESSKEY will be put into the</span>
04806 <span class="comment">             * application queue instead of real vkey.</span>
04807 <span class="comment">             */</span>
04808             UserAssert(ptiCurrent != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04809             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a119">gpImeHotKeyListHeader</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
04810                     fRemove &amp;&amp;
04811                     !<a class="code" href="../../d4/d1/userk_8h.html#a1323">IsMenuStarted</a>(ptiCurrent) &amp;&amp;
04812                     !(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a817">TIF_DISABLEIME</a>) &amp;&amp;
04813                     pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04814 
04815                 WPARAM wParamTemp = wParam;
04816 
04817                 <span class="keywordflow">if</span> (wParam == VK_PACKET) {
04818                     wParamTemp = MAKEWPARAM(wParam, ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o45">wchInjected</a>);
04819                 }
04820 
04821                 <span class="comment">/*</span>
04822 <span class="comment">                 * xxxImmProcessKey also checks the registered IME hotkeys.</span>
04823 <span class="comment">                 */</span>
04824                 dwImmRet = <a class="code" href="../../d4/d1/userk_8h.html#a2047">xxxImmProcessKey</a>( ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>,
04825                                              pwnd,
04826                                              message,
04827                                              wParamTemp,
04828                                              lParam);
04829                 <span class="keywordflow">if</span> ( dwImmRet &amp; (<a class="code" href="../../d4/d5/conimep_8h.html#a46">IPHK_HOTKEY</a> | IPHK_SKIPTHISKEY) ) {
04830                     dwImmRet = 0;
04831                     <span class="keywordflow">goto</span> SkipMessage;
04832                 }
04833             }
04834 
04835             <span class="comment">/*</span>
04836 <span class="comment">             * If we are removing the message, call the keyboard hook</span>
04837 <span class="comment">             * with HC_ACTION, otherwise call the hook with HC_NOREMOVE</span>
04838 <span class="comment">             * to let it know that the message is not being removed.</span>
04839 <span class="comment">             */</span>
04840             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(ptiCurrent, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a514">WHF_KEYBOARD</a>)) {
04841                 fKbdHookCalled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04842                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(fRemove ? HC_ACTION : HC_NOREMOVE,
04843                         wParam, lParam, WH_KEYBOARD)) {
04844                     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a12">PATHTAKEN3</a>(0x40);
04845                     <span class="keywordflow">goto</span> SkipMessage;
04846                 }
04847             }
04848 
04849             <span class="keywordflow">if</span> (fKbdHookCalled &amp;&amp; fRemove &amp;&amp; <a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(ptiCurrent, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a518">WHF_CBT</a>)) {
04850                 <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HCBT_KEYSKIPPED, wParam, lParam, WH_CBT);
04851                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a12">PATHTAKEN3</a>(0x80);
04852             }
04853 
04854             fKbdHookCalled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04855             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a12">PATHTAKEN3</a>(0x100);
04856             <span class="keywordflow">goto</span> ReturnMessage;
04857 
04858         <span class="keywordflow">case</span> WM_MOUSEWHEEL:
04859             <span class="comment">/*</span>
04860 <span class="comment">             * If we are sending keyboard input to an app that has been</span>
04861 <span class="comment">             * spinning then boost it back up.  If we don't you use spinning</span>
04862 <span class="comment">             * apps like Write or Project and do two builds in the</span>
04863 <span class="comment">             * background.  Note the app will also be unboosted again shortly</span>
04864 <span class="comment">             * after you stop typing by the old logic. #11188</span>
04865 <span class="comment">             */</span>
04866             <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a804">TIF_SPINNING</a>)
04867                 <a class="code" href="../../d6/d3/queue_8c.html#a18">CheckProcessForeground</a>(ptiCurrent);
04868 
04869             <span class="comment">/*</span>
04870 <span class="comment">             * Assign the input to the focus window. If there is no focus</span>
04871 <span class="comment">             * window, or we are in a menu loop, eat this message.</span>
04872 <span class="comment">             */</span>
04873             pwnd = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>;
04874             <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || <a class="code" href="../../d4/d1/userk_8h.html#a1322">IsInsideMenuLoop</a>(ptiCurrent)) {
04875                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(0x20000000);
04876                 <span class="keywordflow">goto</span> SkipMessage;
04877             }
04878 
04879             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
04880             <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwnd, &amp;tlpwnd);
04881 
04882             <span class="comment">/*</span>
04883 <span class="comment">             * Check if this is intended for the current app.</span>
04884 <span class="comment">             */</span>
04885             <span class="keywordflow">if</span> (fOtherApp = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd) != ptiCurrent)) {
04886 
04887                 <span class="comment">/*</span>
04888 <span class="comment">                 * If this other app isn't going to read from this</span>
04889 <span class="comment">                 * queue, then skip this message. This can happen if</span>
04890 <span class="comment">                 * the RIT queues up a message thinking it goes to</span>
04891 <span class="comment">                 * a particular hwnd, but then by the time GetMessage()</span>
04892 <span class="comment">                 * is called for that thread, it doesn't go to that hwnd</span>
04893 <span class="comment">                 * (like in the case of mouse messages, window rearrangement</span>
04894 <span class="comment">                 * happens which changes which hwnd the mouse hits on).</span>
04895 <span class="comment">                 */</span>
04896                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>) {
04897                     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a11">PATHTAKEN2</a>(0x40000000);
04898                     <span class="keywordflow">goto</span> SkipMessage;
04899                 }
04900 
04901                 <span class="comment">/*</span>
04902 <span class="comment">                 * If not for us, then remember who it is for.</span>
04903 <span class="comment">                 */</span>
04904                 <span class="keywordflow">if</span> (ptiKeyWake == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04905                     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a12">PATHTAKEN3</a>(1);
04906                     ptiKeyWake = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd);
04907                 }
04908             }
04909 
04910             <span class="comment">/*</span>
04911 <span class="comment">             * See if this thing matches our filter.</span>
04912 <span class="comment">             * NOTE: We need to check whether the caller is filtering</span>
04913 <span class="comment">             * for all mouse messages - if so, we assume the caller</span>
04914 <span class="comment">             * wants mouse wheel messages too.</span>
04915 <span class="comment">             */</span>
04916             <span class="keywordflow">if</span> (    !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a823">CheckMsgFilter</a>(WM_MOUSEWHEEL, msgMinFilter, msgMaxFilter) ||
04917                     !<a class="code" href="../../d4/d1/userk_8h.html#a1220">CheckPwndFilter</a>(pwnd, pwndFilter)) {
04918                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a12">PATHTAKEN3</a>(2);
04919                 <span class="keywordflow">continue</span>;
04920             }
04921 
04922             <span class="comment">/*</span>
04923 <span class="comment">             * This message matches our filter. If it is not for us then</span>
04924 <span class="comment">             * stop searching to make sure the real owner processes this</span>
04925 <span class="comment">             * message first.</span>
04926 <span class="comment">             */</span>
04927             <span class="keywordflow">if</span> (fOtherApp) {
04928                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a12">PATHTAKEN3</a>(4);
04929                 <span class="keywordflow">goto</span> NoMessages;
04930             }
04931 
04932             <span class="comment">/*</span>
04933 <span class="comment">             * Eat the message from the input queue and set the keystate</span>
04934 <span class="comment">             * table.</span>
04935 <span class="comment">             */</span>
04936             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a12">PATHTAKEN3</a>(0x20);
04937             <span class="keywordflow">if</span> (fRemove) {
04938                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a51">xxxSkipSysMsg</a>(ptiCurrent, &amp;qmsg);
04939             }
04940 
04941             wParam = <a class="code" href="../../d4/d1/userk_8h.html#a1641">GetMouseKeyFlags</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>);
04942             UserAssert(LOWORD(qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam) == 0);
04943             UserAssert(HIWORD(wParam) == 0);
04944             wParam |= qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam;
04945             lParam = qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam;
04946 
04947             <span class="comment">/*</span>
04948 <span class="comment">             * If we are removing the message, call the mouse hook</span>
04949 <span class="comment">             * with HC_ACTION, otherwise call the hook with HC_NOREM</span>
04950 <span class="comment">             * to let it know that the message is not being removed.</span>
04951 <span class="comment">             */</span>
04952             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(ptiCurrent, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a520">WHF_MOUSE</a>)) {
04953                 fMouseHookCalled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04954                 mhs.pt = qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.pt;
04955                 mhs.hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwnd);
04956                 mhs.wHitTestCode = HTNOWHERE;
04957                 mhs.dwExtraInfo = qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o3">ExtraInfo</a>;
04958                 mhs.mouseData = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam;
04959                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1523">xxxCallMouseHook</a>(message, &amp;mhs, fRemove)) {
04960                     <span class="comment">/*</span>
04961 <span class="comment">                     * Not allowed by mouse hook; so skip it.</span>
04962 <span class="comment">                     */</span>
04963                     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a12">PATHTAKEN3</a>(0x40);
04964                     <span class="keywordflow">goto</span> SkipMessage;
04965                 }
04966             }
04967 
04968             <span class="keywordflow">if</span> (fMouseHookCalled &amp;&amp; fRemove &amp;&amp; <a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(ptiCurrent, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a518">WHF_CBT</a>)) {
04969                 <span class="comment">/*</span>
04970 <span class="comment">                 * CONSIDER: Add new HCBT_ constant for the mouse wheel?</span>
04971 <span class="comment">                 */</span>
04972                 <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HCBT_CLICKSKIPPED, message, (LPARAM)&amp;mhs, WH_CBT);
04973                 <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a12">PATHTAKEN3</a>(0x80);
04974             }
04975 
04976             fMouseHookCalled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04977             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a12">PATHTAKEN3</a>(0x100);
04978             <span class="keywordflow">goto</span> ReturnMessage;
04979         } <span class="comment">/* End of switch (message = qmsg.msg.message) */</span>
04980     } <span class="comment">/* End of the GetNextSysMsg() loop */</span>
04981 
04982 ReturnMessage:
04983     <span class="keywordflow">if</span> (!RtlEqualMemory(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o38">ptLast</a>, &amp;qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.pt, <span class="keyword">sizeof</span>(POINT))) {
04984         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d1/d0/inc_2user_8h.html#a808">TIF_MSGPOSCHANGED</a>;
04985     }
04986     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o38">ptLast</a> = qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.pt;
04987     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o14">timeLast</a> = qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.time;
04988     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o25">ExtraInfo</a> = qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o3">ExtraInfo</a>;
04989 
04990     <span class="comment">/*</span>
04991 <span class="comment">     * idSysLock value of 1 indicates that the message came from the input</span>
04992 <span class="comment">     * queue.</span>
04993 <span class="comment">     */</span>
04994     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o15">idLast</a> = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o2">idSysLock</a> = 1;
04995 
04996     <span class="comment">/*</span>
04997 <span class="comment">     * Now see if our input bit is set for this input. If it isn't, set ours</span>
04998 <span class="comment">     * and clear the guy who had it previously.</span>
04999 <span class="comment">     */</span>
05000     <a class="code" href="../../d4/d1/userk_8h.html#a1473">TransferWakeBit</a>(ptiCurrent, message);
05001 
05002     <span class="comment">/*</span>
05003 <span class="comment">     * Clear the input bits if no messages in the input queue.</span>
05004 <span class="comment">     */</span>
05005     <a class="code" href="../../d4/d1/userk_8h.html#a1199">ClearWakeBit</a>(ptiCurrent, QS_MOUSE | QS_KEY | QS_EVENT | QS_TRANSFER, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
05006 
05007     <span class="comment">/*</span>
05008 <span class="comment">     * Get the message and split.</span>
05009 <span class="comment">     */</span>
05010     lpMsg-&gt;hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwnd);
05011     lpMsg-&gt;message = message;
05012 
05013     <span class="comment">/*</span>
05014 <span class="comment">     * If the IME claims that it needs this vkey, replace it</span>
05015 <span class="comment">     * with VK_PROCESSKEY. The real vkey has been saved in</span>
05016 <span class="comment">     * the input context in the client side.</span>
05017 <span class="comment">     */</span>
05018     lpMsg-&gt;wParam = (dwImmRet &amp; <a class="code" href="../../d4/d5/conimep_8h.html#a47">IPHK_PROCESSBYIME</a>) ? VK_PROCESSKEY : wParam;
05019 
05020     lpMsg-&gt;lParam = lParam;
05021     lpMsg-&gt;time = qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.time;
05022     lpMsg-&gt;pt = qmsg.<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.pt;
05023 
05024 <span class="preprocessor">#if DBG</span>
05025 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (gfLogPlayback &amp;&amp; ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o3">idSysPeek</a> == (LONG_PTR)<a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a4">PQMSG_PLAYBACK</a>)
05026         LogPlayback(pwnd, lpMsg);
05027 <span class="preprocessor">#endif  // DBG</span>
05028 <span class="preprocessor"></span>
05029     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
05030 
05031     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a12">PATHTAKEN3</a>(0x200);
05032     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a6">DUMPPATHTAKEN</a>();
05033     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05034 
05035 NoMessages:
05036     <span class="comment">/*</span>
05037 <span class="comment">     * The message was for another app, or none were found that fit the</span>
05038 <span class="comment">     * filter.</span>
05039 <span class="comment">     */</span>
05040 
05041     <span class="comment">/*</span>
05042 <span class="comment">     * Unlock the system queue.</span>
05043 <span class="comment">     */</span>
05044     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o2">idSysLock</a>  = 0;
05045     <a class="code" href="../../d4/d1/userk_8h.html#a12">CheckSysLock</a>(4, ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05046     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o1">ptiSysLock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05047     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o0">CTIF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a822">CTIF_SYSQUEUELOCKED</a>;
05048 
05049     <span class="comment">/*</span>
05050 <span class="comment">     * Wake up someone else if we found a message for him.  QS_TRANSFER</span>
05051 <span class="comment">     * signifies that the thread was woken due to input transfer</span>
05052 <span class="comment">     * from another thread, rather than from a real input event.</span>
05053 <span class="comment">     */</span>
05054     <span class="keywordflow">if</span> (ptiKeyWake != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || ptiMouseWake != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || ptiEventWake != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05055         <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a12">PATHTAKEN3</a>(0x400);
05056         <span class="keywordflow">if</span> (ptiKeyWake != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05057             <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(ptiKeyWake, QS_KEY | QS_TRANSFER);
05058             <a class="code" href="../../d4/d1/userk_8h.html#a1199">ClearWakeBit</a>(ptiCurrent, QS_KEY | QS_TRANSFER, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05059             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a12">PATHTAKEN3</a>(0x800);
05060         }
05061 
05062         <span class="keywordflow">if</span> (ptiMouseWake != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05063             <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(ptiMouseWake, QS_MOUSE | QS_TRANSFER);
05064             <a class="code" href="../../d4/d1/userk_8h.html#a1199">ClearWakeBit</a>(ptiCurrent, QS_MOUSE | QS_TRANSFER, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05065             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a12">PATHTAKEN3</a>(0x1000);
05066         }
05067 
05068         <span class="keywordflow">if</span> (ptiEventWake != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05069             <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(ptiEventWake, QS_EVENTSET);
05070             <a class="code" href="../../d4/d1/userk_8h.html#a1199">ClearWakeBit</a>(ptiCurrent, QS_EVENT, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05071             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a12">PATHTAKEN3</a>(0x2000);
05072         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a419">FJOURNALPLAYBACK</a>()) {
05073 
05074             <span class="comment">/*</span>
05075 <span class="comment">             * If journal playback is occuring, clear the input bits.  This will</span>
05076 <span class="comment">             * help prevent a race condition between two threads that call</span>
05077 <span class="comment">             * WaitMessage/PeekMessage.  This can occur when embedding an OLE</span>
05078 <span class="comment">             * object.  An example is inserting a Word object into an Excel</span>
05079 <span class="comment">             * spreadsheet.</span>
05080 <span class="comment">             * Also clear change bits else this thread might not xxxSleepThread.</span>
05081 <span class="comment">             */</span>
05082             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o3">fsWakeBitsJournal</a> |= (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a> &amp;
05083                     (QS_MOUSE | QS_KEY | QS_TRANSFER));
05084             <a class="code" href="../../d4/d1/userk_8h.html#a1199">ClearWakeBit</a>(ptiCurrent, QS_MOUSE | QS_KEY | QS_TRANSFER, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05085             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o1">fsChangeBits</a> &amp;= ~(QS_MOUSE | QS_KEY | QS_TRANSFER);
05086         }
05087     } <span class="keywordflow">else</span> {
05088         <span class="comment">/*</span>
05089 <span class="comment">         * Clear the input bits if no messages in the input queue.</span>
05090 <span class="comment">         */</span>
05091         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o3">fsWakeBitsJournal</a> = 0;
05092         <a class="code" href="../../d4/d1/userk_8h.html#a1199">ClearWakeBit</a>(ptiCurrent, QS_MOUSE | QS_KEY | QS_EVENT |
05093                 QS_TRANSFER, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
05094         <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a12">PATHTAKEN3</a>(0x4000);
05095     }
05096 
05097     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
05098 
05099     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a12">PATHTAKEN3</a>(0x8000);
05100     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a6">DUMPPATHTAKEN</a>();
05101     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05102 }
05103 <span class="preprocessor">#undef PATHTAKEN</span>
05104 <span class="preprocessor"></span><span class="preprocessor">#undef PATHTAKEN2</span>
05105 <span class="preprocessor"></span><span class="preprocessor">#undef PATHTAKEN3</span>
05106 <span class="preprocessor"></span><span class="preprocessor">#undef DUMPPATHTAKEN</span>
05107 <span class="preprocessor"></span><span class="preprocessor">#undef DUMPSUBPATHTAKEN</span>
05108 <span class="preprocessor"></span>
05109 
05110 <span class="comment">/***************************************************************************\</span>
05111 <span class="comment">* IdleTimerProc</span>
05112 <span class="comment">*</span>
05113 <span class="comment">* This will start the screen saver app</span>
05114 <span class="comment">*</span>
05115 <span class="comment">* History:</span>
05116 <span class="comment">* 09-06-91  mikeke      Created.</span>
05117 <span class="comment">* 03-26-92  DavidPe     Changed to be run from hungapp timer on RIT.</span>
05118 <span class="comment">\***************************************************************************/</span>
05119 
<a name="l05120"></a><a class="code" href="../../d4/d1/userk_8h.html#a1635">05120</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1635">IdleTimerProc</a>(VOID)
05121 {
05122 
05123     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
05124 
05125     <span class="keywordflow">if</span> (    (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a843">TestAsyncKeyStateDown</a>(VK_LBUTTON)) ||
05126             (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a843">TestAsyncKeyStateDown</a>(VK_RBUTTON)) ||
05127             (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a843">TestAsyncKeyStateDown</a>(VK_MBUTTON)) ||
05128             (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a843">TestAsyncKeyStateDown</a>(VK_XBUTTON1)) ||
05129             (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a843">TestAsyncKeyStateDown</a>(VK_XBUTTON2))) {
05130 
05131         <span class="keywordflow">return</span>;
05132     }
05133 
05134 
05135     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a98">giScreenSaveTimeOutMs</a> &gt; 0) {
05136 
05137         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a2023">IsTimeFromLastInput</a>((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a98">giScreenSaveTimeOutMs</a>))) {
05138 
05139             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a158">gppiScreenSaver</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05140 
05141                 <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a158">gppiScreenSaver</a>-&gt;W32PF_Flags &amp; W32PF_IDLESCREENSAVER)) {
05142                     <span class="comment">/*</span>
05143 <span class="comment">                     * Bump the priority of the screen saver down to idle.</span>
05144 <span class="comment">                     */</span>
05145                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a158">gppiScreenSaver</a>-&gt;W32PF_Flags |= W32PF_IDLESCREENSAVER;
05146                     <a class="code" href="../../d4/d1/userk_8h.html#a1333">SetForegroundPriorityProcess</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a158">gppiScreenSaver</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a158">gppiScreenSaver</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o2">ptiMainThread</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
05147                 }
05148             } <span class="keywordflow">else</span> {
05149                 <span class="comment">/*</span>
05150 <span class="comment">                 * Tell the system that it needs to bring up a screen saver.</span>
05151 <span class="comment">                 *</span>
05152 <span class="comment">                 * Carefull with the case when the active window is hung. If this</span>
05153 <span class="comment">                 * is the case the screen saver won't be started by winlogon because</span>
05154 <span class="comment">                 * DefWindowProc won't call StartScreenSaver(FALSE).</span>
05155 <span class="comment">                 */</span>
05156                 <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
05157                     (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
05158                     !<a class="code" href="../../d4/d1/userk_8h.html#a1650">FHungApp</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a912">CMSHUNGAPPTIMEOUT</a>)) {
05159 
05160                     <span class="comment">/*</span>
05161 <span class="comment">                     * Tell winlogon to start the screen saver if we have a secure</span>
05162 <span class="comment">                     * screen saver. In case we do have a secure one, the next PostMessage</span>
05163 <span class="comment">                     * will be ignored in winlogon.</span>
05164 <span class="comment">                     */</span>
05165                     <a class="code" href="../../d4/d1/userk_8h.html#a1121">StartScreenSaver</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
05166                     <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>, WM_SYSCOMMAND, SC_SCREENSAVE, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
05167                 } <span class="keywordflow">else</span> {
05168                     <a class="code" href="../../d4/d1/userk_8h.html#a1121">StartScreenSaver</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05169                 }
05170             }
05171         }
05172     }
05173 
05174     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a301">giLowPowerTimeOutMs</a> &gt; 0) &amp;&amp; ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o1">dwFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a378">LINP_LOWPOWER</a>) == 0)) {
05175         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a2023">IsTimeFromLastInput</a>((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a301">giLowPowerTimeOutMs</a>))) {
05176             <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
05177                 <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>, WM_SYSCOMMAND, SC_MONITORPOWER, <a class="code" href="../../d4/d1/userk_8h.html#a664">LOWPOWER_PHASE</a>);
05178             }
05179         }
05180     }
05181 
05182     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a302">giPowerOffTimeOutMs</a> &gt; 0) &amp;&amp; ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o1">dwFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a379">LINP_POWEROFF</a>) == 0)) {
05183         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a2023">IsTimeFromLastInput</a>((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a302">giPowerOffTimeOutMs</a>))) {
05184             <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
05185                 <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>, WM_SYSCOMMAND, SC_MONITORPOWER, <a class="code" href="../../d4/d1/userk_8h.html#a665">POWEROFF_PHASE</a>);
05186             }
05187         }
05188     }
05189 
05190 }
05191 
05192 <span class="comment">/***************************************************************************\</span>
05193 <span class="comment">* zzzWakeInputIdle</span>
05194 <span class="comment">*</span>
05195 <span class="comment">* The calling thread is going "idle". Wake up any thread waiting for this.</span>
05196 <span class="comment">*</span>
05197 <span class="comment">* 09-24-91 ScottLu      Created.</span>
05198 <span class="comment">\***************************************************************************/</span>
05199 
<a name="l05200"></a><a class="code" href="../../d4/d1/userk_8h.html#a1636">05200</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1636">zzzWakeInputIdle</a>(
05201     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti)
05202 {
05203     PW32PROCESS W32Process = W32GetCurrentProcess();
05204 
05205     <span class="comment">/*</span>
05206 <span class="comment">     * clear out the TIF_FIRSTIDLE since here we are</span>
05207 <span class="comment">     */</span>
05208     pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a807">TIF_FIRSTIDLE</a>;
05209 
05210 
05211     <span class="comment">/*</span>
05212 <span class="comment">     * Shared Wow Apps use the per thread idle event for synchronization.</span>
05213 <span class="comment">     * Separate Wow VDMs use the regular mechanism.</span>
05214 <span class="comment">     */</span>
05215     <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a806">TIF_SHAREDWOW</a>) {
05216         UserAssert(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>);
05217         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o4">pwti</a>) {
05218             <a class="code" href="../../d4/d1/userk_8h.html#a365">SET_PSEUDO_EVENT</a>(&amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o4">pwti</a>-&gt;<a class="code" href="../../d8/d9/structtagWOWTHREADINFO.html#o4">pIdleEvent</a>);
05219         }
05220     } <span class="keywordflow">else</span> {
05221         <span class="comment">/*</span>
05222 <span class="comment">         * If the main thread is NULL, set it to this queue: it is calling</span>
05223 <span class="comment">         * GetMessage().</span>
05224 <span class="comment">         */</span>
05225         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o2">ptiMainThread</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
05226             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o2">ptiMainThread</a> = pti;
05227 
05228         <span class="comment">/*</span>
05229 <span class="comment">         * Wake up anyone waiting on this event.</span>
05230 <span class="comment">         */</span>
05231         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o2">ptiMainThread</a> == pti) {
05232             <a class="code" href="../../d4/d1/userk_8h.html#a365">SET_PSEUDO_EVENT</a>(&amp;W32Process-&gt;InputIdleEvent);
05233         }
05234     }
05235 
05236     <span class="comment">/*</span>
05237 <span class="comment">     * Check to see if the startglass is on, and if so turn it off and update.</span>
05238 <span class="comment">     */</span>
05239     <span class="keywordflow">if</span> (W32Process-&gt;W32PF_Flags &amp; W32PF_STARTGLASS) {
05240         <span class="comment">/*</span>
05241 <span class="comment">         * This app is no longer in "starting" mode. Recalc when to hide</span>
05242 <span class="comment">         * the app starting cursor.</span>
05243 <span class="comment">         */</span>
05244         W32Process-&gt;W32PF_Flags &amp;= ~W32PF_STARTGLASS;
05245         <a class="code" href="../../d4/d1/userk_8h.html#a1490">zzzCalcStartCursorHide</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
05246     }
05247 }
05248 
<a name="l05249"></a><a class="code" href="../../d4/d1/userk_8h.html#a1637">05249</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1637">SleepInputIdle</a>(
05250     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti)
05251 {
05252     PW32PROCESS W32Process;
05253 
05254     <span class="comment">/*</span>
05255 <span class="comment">     * Shared Wow Apps use the per thread idle event for synchronization.</span>
05256 <span class="comment">     * Separate Wow VDMs use the regular mechanism.</span>
05257 <span class="comment">     */</span>
05258     <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a806">TIF_SHAREDWOW</a>) {
05259         UserAssert(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>);
05260         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o4">pwti</a>) {
05261             <a class="code" href="../../d4/d1/userk_8h.html#a366">RESET_PSEUDO_EVENT</a>(&amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o4">pwti</a>-&gt;<a class="code" href="../../d8/d9/structtagWOWTHREADINFO.html#o4">pIdleEvent</a>);
05262         }
05263     } <span class="keywordflow">else</span> {
05264         <span class="comment">/*</span>
05265 <span class="comment">         * If the main thread is NULL, set it to this queue: it is calling</span>
05266 <span class="comment">         * GetMessage().</span>
05267 <span class="comment">         */</span>
05268         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o2">ptiMainThread</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
05269             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o2">ptiMainThread</a> = pti;
05270 
05271         <span class="comment">/*</span>
05272 <span class="comment">         * Put to sleep up anyone waiting on this event.</span>
05273 <span class="comment">         */</span>
05274         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o2">ptiMainThread</a> == pti) {
05275             W32Process = W32GetCurrentProcess();
05276             <a class="code" href="../../d4/d1/userk_8h.html#a366">RESET_PSEUDO_EVENT</a>(&amp;W32Process-&gt;InputIdleEvent);
05277         }
05278     }
05279 }
05280 
05281 <span class="comment">/***************************************************************************\</span>
05282 <span class="comment">* zzzRecalcThreadAttachment</span>
05283 <span class="comment">* zzzRecalc2</span>
05284 <span class="comment">* zzzAddAttachment</span>
05285 <span class="comment">* CheckAttachment</span>
05286 <span class="comment">*</span>
05287 <span class="comment">* Runs through all the attachinfo fields for all threads and calculates</span>
05288 <span class="comment">* which threads share which queues. Puts calculated result in pqAttach</span>
05289 <span class="comment">* field in each threadinfo structure. This is a difficult problem</span>
05290 <span class="comment">* whose only solution in iterative. The basic algorithm is:</span>
05291 <span class="comment">*</span>
05292 <span class="comment">* 0. Find next unattached thread and attach a queue to it. If none, stop.</span>
05293 <span class="comment">* 1. Loop through all threads: If thread X assigned to this queue or any</span>
05294 <span class="comment">*    of X's attach requests assigned to this queue, assign X and all X's</span>
05295 <span class="comment">*    attachments to this queue. Remember if we ever attach a 16 bit thread.</span>
05296 <span class="comment">* 2. If thread X is a 16 bit thread and we've already attached another</span>
05297 <span class="comment">*    16 bit thread, assign X and all X's attachments to this queue.</span>
05298 <span class="comment">* 3. If any change found in 1-2, goto 1</span>
05299 <span class="comment">* 4. Goto 0</span>
05300 <span class="comment">*</span>
05301 <span class="comment">* 12-11-92 ScottLu      Created.</span>
05302 <span class="comment">* 01-Oct-1993 mikeke    Fixed to work with MWOWs</span>
05303 <span class="comment">\***************************************************************************/</span>
05304 
<a name="l05305"></a><a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a56">05305</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a56">zzzAddAttachment</a>(
05306     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti,
05307     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pqAttach,
05308     LPBOOL pfChanged)
05309 {
05310     <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o28">pqAttach</a> != pqAttach) {
05311         <span class="comment">/*</span>
05312 <span class="comment">         * LATER</span>
05313 <span class="comment">         * !!! This is totally screwed up,  The only reason that this thing</span>
05314 <span class="comment">         * could be non null is because two threads are going through</span>
05315 <span class="comment">         * zzzAttachThreadInput() at the same time.  No one can predict</span>
05316 <span class="comment">         * what kind of problems are going to be caused by that.</span>
05317 <span class="comment">         * We leave the critical section in one place where we send</span>
05318 <span class="comment">         * WM_CANCELMODE below.  We should figure out how to remove</span>
05319 <span class="comment">         * the sendmessage.</span>
05320 <span class="comment">         *</span>
05321 <span class="comment">         * If there already is a queue there, as there may be, destroy it.</span>
05322 <span class="comment">         * Note that zzzDestroyQueue() will only get rid of the queue if the</span>
05323 <span class="comment">         * thread reference count goes to 0.</span>
05324 <span class="comment">         */</span>
05325         <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pqDestroy = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o28">pqAttach</a>;
05326         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o28">pqAttach</a> = pqAttach;
05327         <span class="keywordflow">if</span> (pqDestroy != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
05328             <a class="code" href="../../d4/d1/userk_8h.html#a1209">zzzDestroyQueue</a>(pqDestroy, pti);
05329         pqAttach-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a>++;
05330         *pfChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05331     }
05332 }
05333 
<a name="l05334"></a><a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a57">05334</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a57">zzzRecalc2</a>(
05335     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pqAttach)
05336 {
05337     <a class="code" href="../../d6/d8/structtagATTACHINFO.html">PATTACHINFO</a> pai;
05338     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
05339     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fChanged;
05340     PLIST_ENTRY pHead, pEntry;
05341 
05342     <span class="comment">/*</span>
05343 <span class="comment">     * Defer Win Event notifications so we can traverse PtiList with impunity</span>
05344 <span class="comment">     * #bug number from shiflet</span>
05345 <span class="comment">     */</span>
05346     <a class="code" href="../../d4/d1/userk_8h.html#a614">DeferWinEventNotify</a>();
05347     <a class="code" href="../../d4/d1/userk_8h.html#a159">BEGINATOMICCHECK</a>();
05348 
05349     <span class="comment">/*</span>
05350 <span class="comment">     * Keep adding attachments until everything that should be attached to this</span>
05351 <span class="comment">     * queue is attached</span>
05352 <span class="comment">     */</span>
05353     <span class="keywordflow">do</span> {
05354         fChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05355 
05356         <span class="comment">/*</span>
05357 <span class="comment">         * If a thread is attached to this Q attach all of it's attachments</span>
05358 <span class="comment">         * and MWOW buddies if they aren't already attached.</span>
05359 <span class="comment">         */</span>
05360         pHead = &amp;<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;rpdesk-&gt;PtiList;
05361         <span class="keywordflow">for</span> (pEntry = pHead-&gt;Flink; pEntry != pHead; pEntry = pEntry-&gt;Flink) {
05362             pti = CONTAINING_RECORD(pEntry, <a class="code" href="../../d2/d8/structtagTHREADINFO.html">THREADINFO</a>, PtiLink);
05363 
05364             <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o28">pqAttach</a> == pqAttach) {
05365                 <span class="comment">/*</span>
05366 <span class="comment">                 * check each of the attachments to see if this thread is attached</span>
05367 <span class="comment">                 * to any other threads</span>
05368 <span class="comment">                 */</span>
05369                 <span class="keywordflow">for</span> (pai = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a106">gpai</a>; pai != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pai = pai-&gt;<a class="code" href="../../d6/d8/structtagATTACHINFO.html#o0">paiNext</a>) {
05370                     <span class="comment">/*</span>
05371 <span class="comment">                     * if they weren't attached already, attach them</span>
05372 <span class="comment">                     */</span>
05373                     <span class="keywordflow">if</span> (pai-&gt;<a class="code" href="../../d6/d8/structtagATTACHINFO.html#o1">pti1</a> == pti || pai-&gt;<a class="code" href="../../d6/d8/structtagATTACHINFO.html#o2">pti2</a> == pti) {
05374                         <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a56">zzzAddAttachment</a>((pai-&gt;<a class="code" href="../../d6/d8/structtagATTACHINFO.html#o1">pti1</a> == pti) ? pai-&gt;<a class="code" href="../../d6/d8/structtagATTACHINFO.html#o2">pti2</a> : pai-&gt;<a class="code" href="../../d6/d8/structtagATTACHINFO.html#o1">pti1</a>,
05375                                 pqAttach, &amp;fChanged);
05376                     }
05377                 }
05378 
05379                 <span class="comment">/*</span>
05380 <span class="comment">                 * If this is a 16bit thread attach to all other threads in</span>
05381 <span class="comment">                 * it's MWOW</span>
05382 <span class="comment">                 */</span>
05383                 <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) {
05384                     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiAttach;
05385                     PLIST_ENTRY pHeadAttach, pEntryAttach;
05386 
05387                     pHeadAttach = &amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o20">PtiList</a>;
05388                     <span class="keywordflow">for</span> (pEntryAttach = pHeadAttach-&gt;Flink;
05389                             pEntryAttach != pHeadAttach;
05390                             pEntryAttach = pEntryAttach-&gt;Flink) {
05391                         ptiAttach = CONTAINING_RECORD(pEntryAttach, <a class="code" href="../../d2/d8/structtagTHREADINFO.html">THREADINFO</a>, PtiLink);
05392 
05393                         <span class="keywordflow">if</span> (ptiAttach-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a> &amp;&amp;
05394                             ptiAttach-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> == pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>) {
05395                             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a56">zzzAddAttachment</a>(ptiAttach, pqAttach, &amp;fChanged);
05396                         }
05397                     }
05398                 }
05399             }
05400         }
05401     } <span class="keywordflow">while</span> (fChanged);
05402     <a class="code" href="../../d4/d1/userk_8h.html#a163">ENDATOMICCHECK</a>();
05403     <a class="code" href="../../d4/d1/userk_8h.html#a617">zzzEndDeferWinEventNotify</a>();
05404 }
05405 
05406 
<a name="l05407"></a><a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a58">05407</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a58">zzzRecalcThreadAttachment</a>()
05408 {
05409     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
05410     PLIST_ENTRY pHead, pEntry;
05411 
05412     <span class="comment">/*</span>
05413 <span class="comment">     * Win Event notifications must be defered so we can traverse PtiList with impunity</span>
05414 <span class="comment">     */</span>
05415     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a615">IsWinEventNotifyDeferred</a>());
05416 
05417     <span class="comment">/*</span>
05418 <span class="comment">     * For all threads, start an attach queue if a thread hasn't been</span>
05419 <span class="comment">     * attached yet.</span>
05420 <span class="comment">     */</span>
05421     pHead = &amp;<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;rpdesk-&gt;PtiList;
05422     <span class="keywordflow">for</span> (pEntry = pHead-&gt;Flink; pEntry != pHead; pEntry = pEntry-&gt;Flink) {
05423         pti = CONTAINING_RECORD(pEntry, <a class="code" href="../../d2/d8/structtagTHREADINFO.html">THREADINFO</a>, PtiLink);
05424 
05425         <span class="comment">/*</span>
05426 <span class="comment">         * Assert: We should not leave the critsect from xxxCreateThreadInfo</span>
05427 <span class="comment">         * with the new thread in the rpdesk-&gt;PtiList but not yet with a queue.</span>
05428 <span class="comment">         */</span>
05429         UserAssert(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05430 
05431         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o28">pqAttach</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05432 
05433             <span class="comment">/*</span>
05434 <span class="comment">             * Allocate a new queue for this thread if more than</span>
05435 <span class="comment">             * one thread references it.</span>
05436 <span class="comment">             */</span>
05437             <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a> &gt; 1) {
05438                 pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o28">pqAttach</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1204">AllocQueue</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05439 
05440                 <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o28">pqAttach</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05441                     RIPMSG0(RIP_WARNING, <span class="stringliteral">"zzzRecalcThreadAttachment: AllocQueue failed"</span>);
05442                     <span class="keywordflow">break</span>;
05443                 }
05444 
05445                 pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o28">pqAttach</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a>++;
05446             } <span class="keywordflow">else</span> {
05447                 pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o28">pqAttach</a> = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>;
05448             }
05449 
05450             <span class="comment">/*</span>
05451 <span class="comment">             * Attach every thread that is directly or indirectly attached</span>
05452 <span class="comment">             * to this thread.</span>
05453 <span class="comment">             */</span>
05454             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a57">zzzRecalc2</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o28">pqAttach</a>);
05455         }
05456     }
05457 }
05458 
05459 
05460 <span class="comment">/***************************************************************************\</span>
05461 <span class="comment">* RedistributeInput</span>
05462 <span class="comment">*</span>
05463 <span class="comment">* This routine takes a input stream from the queue being left, and</span>
05464 <span class="comment">* redistributes it. This effectively filters out the messages destined</span>
05465 <span class="comment">* to the thread that left the queue.</span>
05466 <span class="comment">*</span>
05467 <span class="comment">* 12-10-92 ScottLu      Created.</span>
05468 <span class="comment">\***************************************************************************/</span>
05469 
<a name="l05470"></a><a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a59">05470</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a59">RedistributeInput</a>(
05471     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsgS,
05472     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a>    pqRedist)
05473 {
05474     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiSave;
05475     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiT;
05476     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> *ppqmsgD;
05477     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsgT;
05478     <a class="code" href="../../d6/d1/structtagMLIST.html">PMLIST</a> pmlInput;
05479 
05480     <span class="comment">/*</span>
05481 <span class="comment">     * Since the thread attaching or unattaching may have left a queue</span>
05482 <span class="comment">     * shared by other threads, the messages we are going to requeue</span>
05483 <span class="comment">     * may have multiple destinations. On top of this, once we find</span>
05484 <span class="comment">     * a home queue for a message, it needs to be inserted in the</span>
05485 <span class="comment">     * list ordered by its time stamp (older messages go at the end).</span>
05486 <span class="comment">     */</span>
05487 
05488     <span class="comment">/*</span>
05489 <span class="comment">     * Loop through a given dest's messages to find where to insert</span>
05490 <span class="comment">     * the source messages, based on message time stamp. Be sure</span>
05491 <span class="comment">     * to deal with empty message lists (meaning, check for NULL).</span>
05492 <span class="comment">     */</span>
05493 
05494     ptiT = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05495     ppqmsgD = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05496     pmlInput = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05497 
05498     <span class="keywordflow">while</span> (pqmsgS != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05499 
05500         <span class="comment">/*</span>
05501 <span class="comment">         * Find out where this message should go.</span>
05502 <span class="comment">         */</span>
05503         ptiSave = ptiT;
05504         ptiT = pqmsgS-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o5">pti</a>;
05505 
05506         <span class="comment">/*</span>
05507 <span class="comment">         * Get rid of some event messages.</span>
05508 <span class="comment">         *</span>
05509 <span class="comment">         * QEVENT_UPDATEKEYSTATE: key state already up to date</span>
05510 <span class="comment">         */</span>
05511         <span class="keywordflow">if</span> (pqmsgS-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o4">dwQEvent</a> == <a class="code" href="../../d4/d1/userk_8h.html#a337">QEVENT_UPDATEKEYSTATE</a>) {
05512             ptiT = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05513         }
05514 
05515         <span class="keywordflow">if</span> (ptiT == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05516             <span class="comment">/*</span>
05517 <span class="comment">             * Unlink it. pqmsgS should be the first in the list</span>
05518 <span class="comment">             */</span>
05519 
05520             UserAssert(!pqmsgS-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o1">pqmsgPrev</a>);
05521             <span class="keywordflow">if</span> (pqmsgS-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o0">pqmsgNext</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05522                 pqmsgS-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o0">pqmsgNext</a>-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o1">pqmsgPrev</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05523             }
05524 
05525             pqmsgT = pqmsgS;
05526             pqmsgS = pqmsgS-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o0">pqmsgNext</a>;
05527 
05528             <span class="comment">/*</span>
05529 <span class="comment">             * Clean it / free it.</span>
05530 <span class="comment">             */</span>
05531             <a class="code" href="../../d6/d3/queue_8c.html#a53">CleanEventMessage</a>(pqmsgT);
05532             <a class="code" href="../../d4/d1/userk_8h.html#a1211">FreeQEntry</a>(pqmsgT);
05533 
05534             ptiT = ptiSave;
05535             <span class="keywordflow">continue</span>;
05536         }
05537 
05538         <span class="comment">/*</span>
05539 <span class="comment">         * Point to the pointer that points to the first message</span>
05540 <span class="comment">         * that this message should go to, so that pointer is easy to</span>
05541 <span class="comment">         * update, no matter where it is.</span>
05542 <span class="comment">         */</span>
05543         <span class="keywordflow">if</span> (ppqmsgD == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || ptiSave != ptiT) {
05544 
05545             <span class="comment">/*</span>
05546 <span class="comment">             * If the source is younger than the last message in the</span>
05547 <span class="comment">             * destination, go to the end.  Otherwise, start at the</span>
05548 <span class="comment">             * head of the desination list and find a place to insert</span>
05549 <span class="comment">             * the message.</span>
05550 <span class="comment">             */</span>
05551             <span class="keywordflow">if</span> (ptiT-&gt;pq-&gt;mlInput.pqmsgWriteLast != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
05552                     pqmsgS-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.time &gt;= ptiT-&gt;pq-&gt;mlInput.pqmsgWriteLast-&gt;msg.time) {
05553                 ppqmsgD = &amp;ptiT-&gt;pq-&gt;mlInput.pqmsgWriteLast-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o0">pqmsgNext</a>;
05554             } <span class="keywordflow">else</span> {
05555                 ppqmsgD = &amp;ptiT-&gt;pq-&gt;mlInput.pqmsgRead;
05556             }
05557 
05558             pmlInput = &amp;ptiT-&gt;pq-&gt;mlInput;
05559         }
05560 
05561         <span class="comment">/*</span>
05562 <span class="comment">         * If we're not at the end of the destination AND the destination</span>
05563 <span class="comment">         * message time is younger than the source time, go on to</span>
05564 <span class="comment">         * the next message.</span>
05565 <span class="comment">         */</span>
05566         <span class="keywordflow">while</span> (*ppqmsgD != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; ((*ppqmsgD)-&gt;msg.time &lt;= pqmsgS-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.time)) {
05567             ppqmsgD = &amp;((*ppqmsgD)-&gt;pqmsgNext);
05568         }
05569 
05570         <span class="comment">/*</span>
05571 <span class="comment">         * Link in the source before the dest message. Update</span>
05572 <span class="comment">         * it's next and prev pointers. Update the dest prev</span>
05573 <span class="comment">         * pointer.</span>
05574 <span class="comment">         */</span>
05575         pqmsgT = pqmsgS;
05576         pqmsgS = pqmsgS-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o0">pqmsgNext</a>;
05577         pqmsgT-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o0">pqmsgNext</a> = *ppqmsgD;
05578 
05579         <span class="keywordflow">if</span> (*ppqmsgD != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05580             pqmsgT-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o1">pqmsgPrev</a> = (*ppqmsgD)-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o1">pqmsgPrev</a>;
05581             (*ppqmsgD)-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o1">pqmsgPrev</a> = pqmsgT;
05582         } <span class="keywordflow">else</span> {
05583             pqmsgT-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o1">pqmsgPrev</a> = pmlInput-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o1">pqmsgWriteLast</a>;
05584             pmlInput-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o1">pqmsgWriteLast</a> = pqmsgT;
05585         }
05586         *ppqmsgD = pqmsgT;
05587         ppqmsgD = &amp;pqmsgT-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o0">pqmsgNext</a>;
05588         pmlInput-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o2">cMsgs</a>++;
05589 
05590         <span class="comment">/*</span>
05591 <span class="comment">         * If the thread has an event message, make sure it's going to wake</span>
05592 <span class="comment">         * up to process it. The QS_EVENT flag might not be set if the thread</span>
05593 <span class="comment">         * previously found an event message for another thread and passed</span>
05594 <span class="comment">         * control over to him.</span>
05595 <span class="comment">         */</span>
05596         <span class="keywordflow">if</span> (pqmsgT-&gt;dwQEvent != 0 &amp;&amp; !(ptiT-&gt;pcti-&gt;fsWakeBits &amp; QS_EVENT)) {
05597             <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(ptiT, QS_EVENTSET);
05598         }
05599 
05600         <span class="comment">/*</span>
05601 <span class="comment">         * Preserve the 'idSysPeek' from the old queue.</span>
05602 <span class="comment">         * Carefull if the redistributed queue is the same as ptiT-&gt;pq.</span>
05603 <span class="comment">         */</span>
05604         <span class="keywordflow">if</span> (pqmsgT == (<a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a>)(pqRedist-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o3">idSysPeek</a>) &amp;&amp; (pqRedist != ptiT-&gt;pq)) {
05605 
05606             <span class="keywordflow">if</span> (ptiT-&gt;pq-&gt;idSysPeek == 0) {
05607                 <a class="code" href="../../d4/d1/userk_8h.html#a11">CheckPtiSysPeek</a>(6, ptiT-&gt;pq, pqRedist-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o3">idSysPeek</a>);
05608                 ptiT-&gt;pq-&gt;idSysPeek = pqRedist-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o3">idSysPeek</a>;
05609             }
05610 
05611 <span class="preprocessor">#if DEBUGTAGS</span>
05612 <span class="preprocessor"></span>            <span class="keywordflow">else</span> {
05613                 TAGMSG2(DBGTAG_SysPeek,
05614                         <span class="stringliteral">"idSysPeek %#p already set in pq %#p"</span>,
05615                         ptiT-&gt;pq-&gt;idSysPeek, ptiT-&gt;pq);
05616 
05617             }
05618 <span class="preprocessor">#endif</span>
05619 <span class="preprocessor"></span>            <span class="comment">/*</span>
05620 <span class="comment">             * Set the 'idSysPeek' of this queue to 0 since</span>
05621 <span class="comment">             * we moved the idSysPeek to other queue</span>
05622 <span class="comment">             */</span>
05623             <a class="code" href="../../d4/d1/userk_8h.html#a11">CheckPtiSysPeek</a>(7, pqRedist, 0);
05624             pqRedist-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o3">idSysPeek</a> = 0;
05625 
05626             <span class="comment">/*</span>
05627 <span class="comment">             * Preserve also 'ptiSysLock'.</span>
05628 <span class="comment">             * Set ptiSysLock to the ptiT-&gt;pq only if it points to</span>
05629 <span class="comment">             * that queue.</span>
05630 <span class="comment">             */</span>
05631             <span class="keywordflow">if</span> (ptiT-&gt;pq-&gt;ptiSysLock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
05632                 pqRedist-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o1">ptiSysLock</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
05633                 pqRedist-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o1">ptiSysLock</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> == ptiT-&gt;pq) {
05634 
05635                 <a class="code" href="../../d4/d1/userk_8h.html#a12">CheckSysLock</a>(4, ptiT-&gt;pq, pqRedist-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o1">ptiSysLock</a>);
05636                 ptiT-&gt;pq-&gt;ptiSysLock = pqRedist-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o1">ptiSysLock</a>;
05637 
05638                 <a class="code" href="../../d4/d1/userk_8h.html#a12">CheckSysLock</a>(5, pqRedist, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05639                 pqRedist-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o1">ptiSysLock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05640             }
05641 <span class="preprocessor">#if DEBUGTAGS</span>
05642 <span class="preprocessor"></span>            <span class="keywordflow">else</span> {
05643                 TAGMSG2(DBGTAG_SysPeek,
05644                         <span class="stringliteral">"ptiSysLock %#p already set in pq %#p\n"</span>,
05645                         ptiT-&gt;pq-&gt;ptiSysLock, ptiT-&gt;pq);
05646             }
05647 <span class="preprocessor">#endif</span>
05648 <span class="preprocessor"></span>        }
05649 
05650         <span class="comment">/*</span>
05651 <span class="comment">         * Don't want the prev pointer on our message list to point</span>
05652 <span class="comment">         * to this message which is on a different list (doesn't</span>
05653 <span class="comment">         * really matter because we're about to link it anyway,</span>
05654 <span class="comment">         * but completeness shouldn't hurt).</span>
05655 <span class="comment">         */</span>
05656         <span class="keywordflow">if</span> (pqmsgS != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05657             pqmsgS-&gt;pqmsgPrev = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05658         }
05659     }
05660 }
05661 
05662 <span class="comment">/***************************************************************************\</span>
05663 <span class="comment">* CancelInputState</span>
05664 <span class="comment">*</span>
05665 <span class="comment">* This routine takes a queue and "cancels" input state in it - i.e., if the</span>
05666 <span class="comment">* app thinks it is active, make it think it is not active, etc.</span>
05667 <span class="comment">*</span>
05668 <span class="comment">* 12-10-92 ScottLu      Created.</span>
05669 <span class="comment">\***************************************************************************/</span>
05670 
<a name="l05671"></a><a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a60">05671</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a60">CancelInputState</a>(
05672     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti,
05673     DWORD cmd)
05674 {
05675     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
05676     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT;
05677     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndT;
05678     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndChild;
05679     <a class="code" href="../../d8/d7/structtagAAS.html">AAS</a> aas;
05680 
05681     <span class="comment">/*</span>
05682 <span class="comment">     * In all cases, do not leave do any send messages or any callbacks!</span>
05683 <span class="comment">     * This is because this code is called from</span>
05684 <span class="comment">     * SetWindowsHook(WH_JOURNALPLAYBACK | WH_JOURNALRECORD). No app currently</span>
05685 <span class="comment">     * calling this routine expects to be called before this routine returns.</span>
05686 <span class="comment">     * (If you do callback before it returns, you'll break at least Access</span>
05687 <span class="comment">     * for Windows). - scottlu</span>
05688 <span class="comment">     */</span>
05689     <span class="keywordflow">switch</span> (cmd) {
05690     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a0">CANCEL_ACTIVESTATE</a>:
05691         <span class="comment">/*</span>
05692 <span class="comment">         * Active state.</span>
05693 <span class="comment">         */</span>
05694         pwndT = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>;
05695         <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwndT, &amp;tlpwndT);
05696 
05697         <a class="code" href="../../d4/d1/userk_8h.html#a1582">QueueNotifyMessage</a>(pwndT, WM_NCACTIVATE, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, 0);
05698         <a class="code" href="../../d4/d1/userk_8h.html#a1582">QueueNotifyMessage</a>(pwndT, WM_ACTIVATE,
05699                 MAKELONG(WA_INACTIVE, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)),
05700                 0);
05701 
05702         <span class="keywordflow">if</span> (pwndT == pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>)
05703             <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>);
05704 
05705         aas.<a class="code" href="../../d8/d7/structtagAAS.html#o0">ptiNotify</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndT);
05706         aas.<a class="code" href="../../d8/d7/structtagAAS.html#o1">tidActDeact</a> = <a class="code" href="../../d4/d1/userk_8h.html#a107">TIDq</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndT));
05707         aas.<a class="code" href="../../d8/d7/structtagAAS.html#o2">fActivating</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05708         aas.<a class="code" href="../../d8/d7/structtagAAS.html#o3">fQueueNotify</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05709 
05710         <span class="comment">/*</span>
05711 <span class="comment">         * Even though this in an xxx call, it does NOT leave any critical</span>
05712 <span class="comment">         * sections (because fQueueNotify is TRUE).</span>
05713 <span class="comment">         */</span>
05714         <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndT)-&gt;rpdesk-&gt;pDeskInfo-&gt;spwnd-&gt;spwndChild, &amp;tlpwndChild);
05715         <a class="code" href="../../d4/d1/userk_8h.html#a1428">xxxInternalEnumWindow</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndT)-&gt;rpdesk-&gt;pDeskInfo-&gt;spwnd-&gt;spwndChild,
05716                 (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a990">WNDENUMPROC_PWND</a>)<a class="code" href="../../d3/d6/focusact_8c.html#a3">xxxActivateApp</a>, (LPARAM)&amp;aas, <a class="code" href="../../d4/d1/userk_8h.html#a410">BWL_ENUMLIST</a>);
05717         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndChild);
05718 
05719         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
05720         <span class="keywordflow">break</span>;
05721 
05722     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a1">CANCEL_FOCUSSTATE</a>:
05723         <span class="comment">/*</span>
05724 <span class="comment">         * Focus state.</span>
05725 <span class="comment">         */</span>
05726         pwndT = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>;
05727         <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwndT, &amp;tlpwndT);
05728 
05729         <a class="code" href="../../d4/d1/userk_8h.html#a1582">QueueNotifyMessage</a>(pwndT, WM_KILLFOCUS, 0, 0);
05730 <span class="preprocessor">#ifdef FE_IME</span>
05731 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
05732             <span class="comment">/*</span>
05733 <span class="comment">             * Even though this in an xxx call, it does NOT leave any</span>
05734 <span class="comment">             * critical section (because fQueueMsg is TRUE).</span>
05735 <span class="comment">             */</span>
05736             <a class="code" href="../../d4/d1/userk_8h.html#a2036">xxxFocusSetInputContext</a>(pwndT, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
05737         }
05738 <span class="preprocessor">#endif</span>
05739 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (pwndT == pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>)
05740             <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>);
05741 
05742         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
05743         <span class="keywordflow">break</span>;
05744 
05745     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a2">CANCEL_CAPTURESTATE</a>:
05746         <span class="comment">/*</span>
05747 <span class="comment">         * Capture state.</span>
05748 <span class="comment">         */</span>
05749 
05750         <span class="comment">/*</span>
05751 <span class="comment">         * We shouldn't be nuking the capture of a modal menu mode.</span>
05752 <span class="comment">         */</span>
05753         UserAssert((pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
05754                     || pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a>-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>
05755                     || pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a>-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o16">fInDoDragDrop</a>);
05756 
05757         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a869">QF_CAPTURELOCKED</a>;
05758         pwndT = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a>;
05759         <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwndT, &amp;tlpwndT);
05760 
05761         <a class="code" href="../../d4/d1/userk_8h.html#a1582">QueueNotifyMessage</a>(pwndT, WM_CANCELMODE, 0, 0);
05762         <span class="keywordflow">if</span> (pwndT == pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a>)
05763             <a class="code" href="../../d4/d1/userk_8h.html#a2068">UnlockCaptureWindow</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>);
05764 
05765         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
05766         <span class="keywordflow">break</span>;
05767     }
05768 
05769     <span class="keywordflow">return</span>;
05770 }
05771 
05772 <span class="comment">/***************************************************************************\</span>
05773 <span class="comment">* DBGValidateQueueStates</span>
05774 <span class="comment">*</span>
05775 <span class="comment">* Verifies that all queues point to stuff owned by a thread attached to</span>
05776 <span class="comment">*  the queue.</span>
05777 <span class="comment">*</span>
05778 <span class="comment">* 07/29/97 GerardoB     Created</span>
05779 <span class="comment">\***************************************************************************/</span>
05780 <span class="preprocessor">#if DBG</span>
05781 <span class="preprocessor"></span><span class="preprocessor">#define VALIDATEQSPWND(spwnd) \</span>
05782 <span class="preprocessor">        if (pq-&gt; ## spwnd != NULL) { \</span>
05783 <span class="preprocessor">            ptiwnd = GETPTI(pq-&gt; ## spwnd); \</span>
05784 <span class="preprocessor">            fDestroyedOK = (TestWF(pq-&gt; ## spwnd, WFDESTROYED) &amp;&amp; (ptiwnd == gptiRit)); \</span>
05785 <span class="preprocessor">            UserAssert((pti-&gt;rpdesk == ptiwnd-&gt;rpdesk) || fDestroyedOK); \</span>
05786 <span class="preprocessor">            UserAssert((pti == ptiwnd) \</span>
05787 <span class="preprocessor">                        || (fAttached &amp;&amp; (pq == ptiwnd-&gt;pq)) \</span>
05788 <span class="preprocessor">                        || fDestroyedOK); \</span>
05789 <span class="preprocessor">        }</span>
05790 <span class="preprocessor"></span>
05791 
05792 <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1794">DBGValidateQueueStates</a> (<a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk)
05793 {
05794     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fAttached, fDestroyedOK;
05795     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pq;
05796     PLIST_ENTRY pHead, pEntry;
05797     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti, ptiwnd;
05798     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwInForeground = 0;
05799 
05800     UserAssert((gpqForeground == NULL)
05801                 || ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o4">ptiMouse</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == grpdeskRitInput)
05802                     &amp;&amp; (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a> != 0)));
05803 
05804     <span class="keywordflow">if</span> (pdesk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05805         RIPMSG0(RIP_WARNING, <span class="stringliteral">"DBGValidateQueueStates: Null pdesk parameter"</span>);
05806         <span class="keywordflow">return</span>;
05807     }
05808     pHead = &amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o20">PtiList</a>;
05809     <span class="keywordflow">for</span> (pEntry = pHead-&gt;Flink; pEntry != pHead; pEntry = pEntry-&gt;Flink) {
05810 
05811         pti = CONTAINING_RECORD(pEntry, <a class="code" href="../../d2/d8/structtagTHREADINFO.html">THREADINFO</a>, PtiLink);
05812         pq = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>;
05813         <span class="keywordflow">if</span> (pq == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05814             RIPMSG2(RIP_WARNING, <span class="stringliteral">"DBGValidateQueueStates: Null pq. pti:%#p. pdesk:%#p"</span>, pti, pdesk);
05815             <span class="keywordflow">continue</span>;
05816         }
05817         <span class="comment">/*</span>
05818 <span class="comment">         * The queue should have a non-null cThreads excepting when it is</span>
05819 <span class="comment">         * QF_INDESTROY</span>
05820 <span class="comment">         */</span>
05821         <span class="keywordflow">if</span> (!(pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a864">QF_INDESTROY</a>)) {
05822             UserAssert(pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a> != 0);
05823         }
05824         fAttached = (pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a> &gt; 1);
05825         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>) {
05826             dwInForeground++;
05827         }
05828         <span class="comment">/*</span>
05829 <span class="comment">         * pti's</span>
05830 <span class="comment">         */</span>
05831         UserAssert((pti == pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o4">ptiMouse</a>)
05832                     || (fAttached &amp;&amp; (pq == pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o4">ptiMouse</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>)));
05833         UserAssert(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o4">ptiMouse</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>);
05834         UserAssert((pti == pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a>)
05835                     || (fAttached &amp;&amp; (pq == pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>)));
05836         UserAssert(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>);
05837         <span class="keywordflow">if</span> (pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o1">ptiSysLock</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05838             UserAssert((pti == pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o1">ptiSysLock</a>)
05839                         || (fAttached &amp;&amp; (pq == pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o1">ptiSysLock</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>)));
05840         }
05841         <span class="comment">/*</span>
05842 <span class="comment">         * pwnd's.</span>
05843 <span class="comment">         */</span>
05844         VALIDATEQSPWND(spwndActive);
05845         VALIDATEQSPWND(spwndFocus);
05846         VALIDATEQSPWND(spwndCapture);
05847         VALIDATEQSPWND(spwndActivePrev);
05848     }
05849 
05850     UserAssert((gpqForeground == NULL)
05851                 || (dwInForeground == 0)
05852                 || (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a> == dwInForeground));
05853 }
05854 
05855 <span class="comment">/***************************************************************************\</span>
05856 <span class="comment">* DBGValidateQueue</span>
05857 <span class="comment">*</span>
05858 <span class="comment">* Verifies that queue is readable and fields are valid.</span>
05859 <span class="comment">*</span>
05860 <span class="comment">* 02-Sep-1999 JerrySh   Created.</span>
05861 <span class="comment">\***************************************************************************/</span>
05862 <span class="keywordtype">void</span> DBGValidateQueue(<a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pq)
05863 {
05864     <span class="keywordflow">if</span> (pq != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05865         <a class="code" href="../../d7/d4/structtagQ.html">Q</a> q = *pq;
05866         UserAssert(q.<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> == <a class="code" href="../../d4/d1/userk_8h.html#a102">HtoP</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(q.<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>)));
05867         UserAssert(q.<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a> == <a class="code" href="../../d4/d1/userk_8h.html#a102">HtoP</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(q.<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>)));
05868         UserAssert(q.<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a> == <a class="code" href="../../d4/d1/userk_8h.html#a102">HtoP</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(q.<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a>)));
05869         UserAssert(q.<a class="code" href="../../d7/d4/structtagQ.html#o9">spwndActivePrev</a> == <a class="code" href="../../d4/d1/userk_8h.html#a102">HtoP</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(q.<a class="code" href="../../d7/d4/structtagQ.html#o9">spwndActivePrev</a>)));
05870         UserAssert(q.<a class="code" href="../../d7/d4/structtagQ.html#o19">spcurCurrent</a> == <a class="code" href="../../d4/d1/userk_8h.html#a102">HtoP</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(q.<a class="code" href="../../d7/d4/structtagQ.html#o19">spcurCurrent</a>)));
05871     }
05872 }
05873 <span class="preprocessor">#endif </span><span class="comment">/* DBG */</span>
05874 <span class="comment">/***************************************************************************\</span>
05875 <span class="comment">* zzzAttachThreadInput (API)</span>
05876 <span class="comment">* zzzReattachThreads</span>
05877 <span class="comment">* zzzAttachToQueue</span>
05878 <span class="comment">* CheckTransferState</span>
05879 <span class="comment">*</span>
05880 <span class="comment">* Attaches a given thread to another input queue, either by attaching to</span>
05881 <span class="comment">* a queue (referenced by another thread id), or detaching from one.</span>
05882 <span class="comment">*</span>
05883 <span class="comment">* 12-09-92  ScottLu     Created.</span>
05884 <span class="comment">\***************************************************************************/</span>
05885 
<a name="l05886"></a><a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a15">05886</a> <span class="preprocessor">#define CTS_DONOTHING 0</span>
<a name="l05887"></a><a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a16">05887</a> <span class="preprocessor"></span><span class="preprocessor">#define CTS_CANCELOLD 1</span>
<a name="l05888"></a><a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a17">05888</a> <span class="preprocessor"></span><span class="preprocessor">#define CTS_TRANSFER  2</span>
05889 <span class="preprocessor"></span>
<a name="l05890"></a><a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a61">05890</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a61">CheckTransferState</a>(
05891     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti,
05892     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pqAttach,
05893     LONG offset,
05894     BOOL fJoiningForeground)
05895 {
05896     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndOld, pwndNew, pwndForegroundState;
05897 
05898     <span class="comment">/*</span>
05899 <span class="comment">     * return 0: do nothing.</span>
05900 <span class="comment">     * return 1: cancel the old state.</span>
05901 <span class="comment">     * return 2: transfer the old state to the new state</span>
05902 <span class="comment">     */</span>
05903     pwndOld = *(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> *)(((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *)pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>) + offset);
05904     pwndNew = *(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> *)(((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *)pqAttach) + offset);
05905 
05906     <span class="comment">/*</span>
05907 <span class="comment">     * Make sure the old state even exists, and that the old state is</span>
05908 <span class="comment">     * owned by this thread. If not, nothing happens.</span>
05909 <span class="comment">     */</span>
05910     <span class="keywordflow">if</span> (pwndOld == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndOld) != pti)
05911         <span class="keywordflow">return</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a15">CTS_DONOTHING</a>;
05912 
05913     <span class="comment">/*</span>
05914 <span class="comment">     * If the new state already exists, cancel the old state.</span>
05915 <span class="comment">     */</span>
05916     <span class="keywordflow">if</span> (pwndNew != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
05917         <span class="keywordflow">return</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a16">CTS_CANCELOLD</a>;
05918 
05919     <span class="comment">/*</span>
05920 <span class="comment">     * Transfer this old state if this thread is not joining the foreground.</span>
05921 <span class="comment">     */</span>
05922     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || !fJoiningForeground)
05923         <span class="keywordflow">return</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a17">CTS_TRANSFER</a>;
05924 
05925     <span class="comment">/*</span>
05926 <span class="comment">     * We're joining the foreground - only transfer the old state if we own</span>
05927 <span class="comment">     * that foreground state or if there is no foreground state.</span>
05928 <span class="comment">     */</span>
05929     pwndForegroundState = *(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> *)(((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *)<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>) + offset);
05930     <span class="keywordflow">if</span> (pwndForegroundState == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || pwndOld == pwndForegroundState)
05931         <span class="keywordflow">return</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a17">CTS_TRANSFER</a>;
05932 
05933     <span class="comment">/*</span>
05934 <span class="comment">     * We're joining the foreground but we didn't set that foreground state.</span>
05935 <span class="comment">     * Don't allow the transfer of that state.</span>
05936 <span class="comment">     */</span>
05937     <span class="keywordflow">return</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a16">CTS_CANCELOLD</a>;
05938 }
05939 
<a name="l05940"></a><a class="code" href="../../d4/d1/userk_8h.html#a1213">05940</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1213">zzzAttachToQueue</a>(
05941     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti,
05942     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a>   pqAttach,
05943     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a>   pqJournal,
05944     BOOL fJoiningForeground)
05945 {
05946     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsgT;
05947     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pqDestroy;
05948 
05949     <span class="comment">/*</span>
05950 <span class="comment">     * Check active state.</span>
05951 <span class="comment">     */</span>
05952     <span class="keywordflow">switch</span> (<a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a61">CheckTransferState</a>(pti, pqAttach,
05953             FIELD_OFFSET(<a class="code" href="../../d7/d4/structtagQ.html">Q</a>, spwndActive), fJoiningForeground)) {
05954     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a16">CTS_CANCELOLD</a>:
05955         <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a60">CancelInputState</a>(pti, <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a0">CANCEL_ACTIVESTATE</a>);
05956         <span class="keywordflow">break</span>;
05957 
05958     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a17">CTS_TRANSFER</a>:
05959         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pqAttach-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>, pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>);
05960         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>);
05961 
05962         <span class="comment">/*</span>
05963 <span class="comment">         * The caret usually follows the focus window, which follows</span>
05964 <span class="comment">         * the active window...</span>
05965 <span class="comment">         */</span>
05966         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o18">caret</a>.<a class="code" href="../../d6/d9/structtagCARET.html#o0">spwnd</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05967 
05968             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o18">caret</a>.<a class="code" href="../../d6/d9/structtagCARET.html#o0">spwnd</a>) == pti) {
05969                 <span class="comment">/*</span>
05970 <span class="comment">                 * Just copy the entire caret structure... that way we</span>
05971 <span class="comment">                 * don't need to deal with locking/unlocking the spwnd.</span>
05972 <span class="comment">                 */</span>
05973                 <span class="keywordflow">if</span> (pqAttach-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o18">caret</a>.<a class="code" href="../../d6/d9/structtagCARET.html#o0">spwnd</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05974                     pqAttach-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o18">caret</a> = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o18">caret</a>;
05975                     pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o18">caret</a>.<a class="code" href="../../d6/d9/structtagCARET.html#o0">spwnd</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05976                 }
05977             }
05978         }
05979         <span class="keywordflow">break</span>;
05980     }
05981 
05982     <span class="comment">/*</span>
05983 <span class="comment">     * Check focus state.</span>
05984 <span class="comment">     */</span>
05985     <span class="keywordflow">switch</span> (<a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a61">CheckTransferState</a>(pti, pqAttach,
05986             FIELD_OFFSET(<a class="code" href="../../d7/d4/structtagQ.html">Q</a>, spwndFocus), fJoiningForeground)) {
05987     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a16">CTS_CANCELOLD</a>:
05988         <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a60">CancelInputState</a>(pti, <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a1">CANCEL_FOCUSSTATE</a>);
05989         <span class="keywordflow">break</span>;
05990 
05991     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a17">CTS_TRANSFER</a>:
05992         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pqAttach-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>, pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>);
05993         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>);
05994         <span class="keywordflow">break</span>;
05995     }
05996 
05997     <span class="comment">/*</span>
05998 <span class="comment">     * Check capture state.</span>
05999 <span class="comment">     */</span>
06000     <span class="keywordflow">switch</span> (<a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a61">CheckTransferState</a>(pti, pqAttach,
06001             FIELD_OFFSET(<a class="code" href="../../d7/d4/structtagQ.html">Q</a>, spwndCapture), fJoiningForeground)) {
06002     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a16">CTS_CANCELOLD</a>:
06003         <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a60">CancelInputState</a>(pti, <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a2">CANCEL_CAPTURESTATE</a>);
06004         <span class="keywordflow">break</span>;
06005 
06006     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a17">CTS_TRANSFER</a>:
06007         <a class="code" href="../../d4/d1/userk_8h.html#a2067">LockCaptureWindow</a>(pqAttach, pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a>);
06008         <a class="code" href="../../d4/d1/userk_8h.html#a2068">UnlockCaptureWindow</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>);
06009         pqAttach-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o10">codeCapture</a> = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o10">codeCapture</a>;
06010         pqAttach-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> ^= ((pqAttach-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> ^ pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a>) &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a869">QF_CAPTURELOCKED</a>);
06011         <span class="keywordflow">break</span>;
06012 
06013 <span class="preprocessor">#if DBG</span>
06014 <span class="preprocessor"></span>    <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a15">CTS_DONOTHING</a>:
06015         <span class="comment">/*</span>
06016 <span class="comment">         * We should always transfer the capture state of a thread</span>
06017 <span class="comment">         *  in modal menu mode</span>
06018 <span class="comment">         */</span>
06019         UserAssert((pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
06020                     || <a class="code" href="../../d4/d1/userk_8h.html#a1319">ExitMenuLoop</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a>, pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a>-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>)
06021                     || pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a>-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>
06022                     || pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a>-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o16">fInDoDragDrop</a>);
06023 
06024         <span class="keywordflow">break</span>;
06025 <span class="preprocessor">#endif</span>
06026 <span class="preprocessor"></span>    }
06027 
06028     <span class="comment">/*</span>
06029 <span class="comment">     * Check spwndActivePrev state.  This check has some considerations.</span>
06030 <span class="comment">     * If the CTS_TRANSFER is returned, it usually means there was no</span>
06031 <span class="comment">     * prev-active in the attach-queue, and it will use the first</span>
06032 <span class="comment">     * window it encounters.  Since we walk the thread-list, a out-of-zorder</span>
06033 <span class="comment">     * window could be chosen.  So, to counter this, we'll check the</span>
06034 <span class="comment">     * attach-queue-next-prev against the thread-previous window to see</span>
06035 <span class="comment">     * if it is truly the next-zorder window.</span>
06036 <span class="comment">     */</span>
06037     <span class="keywordflow">switch</span> (<a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a61">CheckTransferState</a>(pti, pqAttach,
06038             FIELD_OFFSET(<a class="code" href="../../d7/d4/structtagQ.html">Q</a>, spwndActivePrev), fJoiningForeground)) {
06039     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a17">CTS_TRANSFER</a>:
06040         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pqAttach-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o9">spwndActivePrev</a>, pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o9">spwndActivePrev</a>);
06041         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o9">spwndActivePrev</a>);
06042         <span class="keywordflow">break</span>;
06043 
06044     <span class="keywordflow">case</span> <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a16">CTS_CANCELOLD</a>:
06045 
06046         <span class="comment">/*</span>
06047 <span class="comment">         * Check to see if the previous window is what we would expect it</span>
06048 <span class="comment">         * to be.</span>
06049 <span class="comment">         */</span>
06050         <span class="keywordflow">if</span> (pqAttach-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> &amp;&amp;
06051             (pqAttach-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o9">spwndActivePrev</a> &amp;&amp; pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o9">spwndActivePrev</a>) &amp;&amp;
06052             (pqAttach-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a> == pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o9">spwndActivePrev</a>)) {
06053 
06054             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pqAttach-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o9">spwndActivePrev</a>, pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o9">spwndActivePrev</a>);
06055             <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o9">spwndActivePrev</a>);
06056         }
06057         <span class="keywordflow">break</span>;
06058     }
06059 
06060     <span class="keywordflow">if</span> (pti == pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o1">ptiSysLock</a>) {
06061         <span class="comment">/*</span>
06062 <span class="comment">         * Preserve any of the flags we might have already been set on pqAttach.</span>
06063 <span class="comment">         * Note that these flags might have been set on a previous call</span>
06064 <span class="comment">        *   to this function that received the same pqAttach</span>
06065 <span class="comment">         */</span>
06066         pqAttach-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> ^= ((pqAttach-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> ^ pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a>)
06067                                 &amp; ~(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a869">QF_CAPTURELOCKED</a>));
06068 
06069         <span class="comment">/*</span>
06070 <span class="comment">         *  Fix for 29967 "Start menu disappears when clicked  and Office</span>
06071 <span class="comment">         *  taskbar has focus!". Win95 uses a global counter instead of this</span>
06072 <span class="comment">         *  flag. In NT when we click on Office taskbar and then on the Start</span>
06073 <span class="comment">         *  Menu, MSoffice calls zzzAttachThreadInput() which changes the Start</span>
06074 <span class="comment">         *  Menu's queue and the new queue has the QF_ACTIVATIONCHANGE flag on.</span>
06075 <span class="comment">         *  Inside the xxxMNLoop we test if this flag is on and if it is we</span>
06076 <span class="comment">         *  exit the menu.</span>
06077 <span class="comment">         */</span>
06078         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1322">IsInsideMenuLoop</a>(pti)) {
06079             pqAttach-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a861">QF_ACTIVATIONCHANGE</a>;
06080         }
06081 
06082         <span class="comment">/*</span>
06083 <span class="comment">         * Unlock the queue since pti is moving to anotther queue.</span>
06084 <span class="comment">         */</span>
06085         <span class="comment">/* CheckSysLock(6, pq, NULL); what number? */</span>
06086         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o1">ptiSysLock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06087     }
06088 
06089     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a108">gspwndCursor</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pti == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a108">gspwndCursor</a>)) {
06090         <a class="code" href="../../d4/d1/userk_8h.html#a599">LockQCursor</a>(pqAttach, pti-&gt;pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o19">spcurCurrent</a>);
06091     }
06092 
06093     <span class="comment">/*</span>
06094 <span class="comment">     * Each thread has its own cursor level, which is a count of the number</span>
06095 <span class="comment">     * of times that app has called show/hide cursor. This gets added into</span>
06096 <span class="comment">     * the queue's count for a completely accurate count every time this</span>
06097 <span class="comment">     * queue recalculation is done.</span>
06098 <span class="comment">     */</span>
06099     <span class="comment">/*</span>
06100 <span class="comment">     * LATER</span>
06101 <span class="comment">     * We need to adjust the iCursorLevel of the old queue to reflect</span>
06102 <span class="comment">     * the fact that a thread is departing.</span>
06103 <span class="comment">     * FritzS</span>
06104 <span class="comment">     */</span>
06105     pqAttach-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o20">iCursorLevel</a> += pti-&gt;iCursorLevel;
06106 
06107     <span class="comment">/*</span>
06108 <span class="comment">     * Pump up the new queue with the right input variables.</span>
06109 <span class="comment">     */</span>
06110     pqAttach-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o4">ptiMouse</a>    = pti;
06111     pqAttach-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a> = pti;
06112 
06113     pqDestroy = pti-&gt;pq;
06114 
06115     <span class="comment">/*</span>
06116 <span class="comment">     * Don't increment the thread count here because we already incremented</span>
06117 <span class="comment">     * it when we put it in pti-&gt;pqAttach. Since we're moving it from pqAttach</span>
06118 <span class="comment">     * to pq, we don't mess with the reference count.</span>
06119 <span class="comment">     */</span>
06120     pti-&gt;pq = pqAttach;
06121 
06122     <span class="comment">/*</span>
06123 <span class="comment">     * If the thread is using the journal queue, leave the message list</span>
06124 <span class="comment">     * alone.  Otherwise, redistribute the messages.</span>
06125 <span class="comment">     */</span>
06126     <span class="keywordflow">if</span> (pqDestroy != pqJournal) {
06127 
06128         <span class="comment">/*</span>
06129 <span class="comment">         * Remember the current message list so it can get redistributed taking</span>
06130 <span class="comment">         * into account ptiAttach's new queue.</span>
06131 <span class="comment">         */</span>
06132         pqmsgT = pqDestroy-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>.<a class="code" href="../../d6/d1/structtagMLIST.html#o0">pqmsgRead</a>;
06133         pqDestroy-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>.<a class="code" href="../../d6/d1/structtagMLIST.html#o0">pqmsgRead</a>      = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06134         pqDestroy-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>.<a class="code" href="../../d6/d1/structtagMLIST.html#o1">pqmsgWriteLast</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06135         pqDestroy-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>.<a class="code" href="../../d6/d1/structtagMLIST.html#o2">cMsgs</a>          = 0;
06136 
06137         <span class="comment">/*</span>
06138 <span class="comment">         * Now redistribute the input messages from the old queue they go into the</span>
06139 <span class="comment">         * right queues.</span>
06140 <span class="comment">         *</span>
06141 <span class="comment">         * Preserve the 'idSysPeek' when redistributing the queue</span>
06142 <span class="comment">         */</span>
06143         <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a59">RedistributeInput</a>(pqmsgT, pqDestroy);
06144 
06145         <span class="comment">/*</span>
06146 <span class="comment">         * Officially attach the new queue to this thread. Note that zzzDestroyQueue()</span>
06147 <span class="comment">         * doesn't actually destroy anything until the thread reference count goes</span>
06148 <span class="comment">         * to 0.</span>
06149 <span class="comment">         */</span>
06150         <a class="code" href="../../d4/d1/userk_8h.html#a1209">zzzDestroyQueue</a>(pqDestroy, pti);
06151 
06152     } <span class="keywordflow">else</span> {
06153         UserAssert(pqDestroy-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a>);
06154         pqDestroy-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a>--;
06155     }
06156 }
06157 
<a name="l06158"></a><a class="code" href="../../d4/d1/userk_8h.html#a1203">06158</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1203">zzzReattachThreads</a>(
06159     BOOL fJournalAttach)
06160 {
06161     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
06162     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
06163     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a>          pqForegroundPrevNew;
06164     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a>          pqForegroundNew;
06165     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a>          pqAttach;
06166     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a>          pqJournal;
06167     PLIST_ENTRY pHead, pEntry;
06168     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        bHadAnActiveForegroundWindow;
06169 
06170     <span class="comment">/*</span>
06171 <span class="comment">     * In all cases, do not leave do any send messages or any callbacks!</span>
06172 <span class="comment">     * This is because this code is called from</span>
06173 <span class="comment">     * SetWindowsHook(WH_JOURNALPLAYBACK | WH_JOURNALRECORD). No app currently</span>
06174 <span class="comment">     * calling this routine expects to be called before this routine returns.</span>
06175 <span class="comment">     * (If you do callback before it returns, you'll break at least Access</span>
06176 <span class="comment">     * for Windows). - scottlu</span>
06177 <span class="comment">     */</span>
06178 
06179 <span class="preprocessor">#if DBG</span>
06180 <span class="preprocessor"></span>    <a class="code" href="../../d4/d1/userk_8h.html#a1794">DBGValidateQueueStates</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>);
06181 <span class="preprocessor">#endif</span>
06182 <span class="preprocessor"></span>
06183     <span class="comment">/*</span>
06184 <span class="comment">     * Defer Win Event notifications so we can traverse PtiList with impunity</span>
06185 <span class="comment">     * Also, we don't want to callback while we're half way attached</span>
06186 <span class="comment">     */</span>
06187     <a class="code" href="../../d4/d1/userk_8h.html#a614">DeferWinEventNotify</a>();
06188     <a class="code" href="../../d4/d1/userk_8h.html#a159">BEGINATOMICCHECK</a>();
06189 
06190     <span class="comment">/*</span>
06191 <span class="comment">     * Don't recalc attach info if this is a journal attach, because</span>
06192 <span class="comment">     * the journal attach code has already done this for us.</span>
06193 <span class="comment">     */</span>
06194     <span class="keywordflow">if</span> (!fJournalAttach) {
06195 
06196         <span class="comment">/*</span>
06197 <span class="comment">         * Now recalculate all the different queue groups, based on the</span>
06198 <span class="comment">         * attach requests. This fills in the pqAttach of each thread info</span>
06199 <span class="comment">         * with the new queue this thread belongs to. Always takes into</span>
06200 <span class="comment">         * account all attachment requests.</span>
06201 <span class="comment">         */</span>
06202         <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a58">zzzRecalcThreadAttachment</a>();
06203 
06204         <span class="comment">/*</span>
06205 <span class="comment">         * Make a guess about which queue is the journal queue.</span>
06206 <span class="comment">         */</span>
06207         pqJournal = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>;
06208         <span class="keywordflow">if</span> (pqJournal == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
06209             pqJournal = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>;
06210 
06211         <span class="comment">/*</span>
06212 <span class="comment">         * If the queue is only used by one thread, perform normal processing.</span>
06213 <span class="comment">         */</span>
06214         <span class="keywordflow">if</span> (pqJournal-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a> == 1) {
06215             pqJournal = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06216         } <span class="keywordflow">else</span> {
06217 
06218             <span class="comment">/*</span>
06219 <span class="comment">             * Lock the queue to ensure that it stays valid</span>
06220 <span class="comment">             * until we have redistributed the input.</span>
06221 <span class="comment">             */</span>
06222             (pqJournal-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o23">cLockCount</a>)++;
06223         }
06224     } <span class="keywordflow">else</span> {
06225         pqJournal = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06226     }
06227 
06228     <span class="comment">/*</span>
06229 <span class="comment">     * What will be the new foreground queue?</span>
06230 <span class="comment">     */</span>
06231     pqForegroundNew = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06232 
06233     <span class="comment">/*</span>
06234 <span class="comment">     * Remember if there is a foreground window so we don't force one</span>
06235 <span class="comment">     * at the end if there wasn't one before the attach</span>
06236 <span class="comment">     */</span>
06237     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06238         bHadAnActiveForegroundWindow = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06239         pqForegroundNew = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>)-&gt;pqAttach;
06240     } <span class="keywordflow">else</span> {
06241         bHadAnActiveForegroundWindow = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06242     }
06243 
06244     pqForegroundPrevNew = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06245     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a30">gpqForegroundPrev</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a30">gpqForegroundPrev</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o9">spwndActivePrev</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06246         pqForegroundPrevNew = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a30">gpqForegroundPrev</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o9">spwndActivePrev</a>)-&gt;pqAttach;
06247     }
06248 
06249 
06250     pHead = &amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o20">PtiList</a>;
06251     <span class="keywordflow">for</span> (pEntry = pHead-&gt;Flink; pEntry != pHead; pEntry = pEntry-&gt;Flink) {
06252         pti = CONTAINING_RECORD(pEntry, <a class="code" href="../../d2/d8/structtagTHREADINFO.html">THREADINFO</a>, PtiLink);
06253 
06254         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o28">pqAttach</a> == pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>) {
06255             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o28">pqAttach</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06256         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o28">pqAttach</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06257             <span class="comment">/*</span>
06258 <span class="comment">             * It is crucial that we NULL out pqAttach for this queue once</span>
06259 <span class="comment">             * we have it in a local variable because the NULL-ness of this</span>
06260 <span class="comment">             * field is checked in attach operations.</span>
06261 <span class="comment">             */</span>
06262             pqAttach = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o28">pqAttach</a>;
06263             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o28">pqAttach</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06264 
06265             <a class="code" href="../../d4/d1/userk_8h.html#a1213">zzzAttachToQueue</a>(pti, pqAttach, pqJournal, pqForegroundNew == pqAttach);
06266         }
06267 
06268     }
06269 
06270     <span class="comment">/*</span>
06271 <span class="comment">     * If we are doing a journal detach, redistribute the input messages</span>
06272 <span class="comment">     * from the old queue.</span>
06273 <span class="comment">     */</span>
06274     <span class="keywordflow">if</span> (pqJournal != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06275         <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsgRedist;
06276 
06277         UserAssert(pqJournal-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o23">cLockCount</a>);
06278         (pqJournal-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o23">cLockCount</a>)--;
06279         pqmsgRedist = pqJournal-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>.<a class="code" href="../../d6/d1/structtagMLIST.html#o0">pqmsgRead</a>;
06280 
06281         pqJournal-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>.<a class="code" href="../../d6/d1/structtagMLIST.html#o0">pqmsgRead</a>      = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06282         pqJournal-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>.<a class="code" href="../../d6/d1/structtagMLIST.html#o1">pqmsgWriteLast</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06283         pqJournal-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>.<a class="code" href="../../d6/d1/structtagMLIST.html#o2">cMsgs</a>          = 0;
06284         <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a59">RedistributeInput</a>(pqmsgRedist, pqJournal);
06285 
06286         <span class="comment">/*</span>
06287 <span class="comment">         * Only destroy the queue if it is no longer is use.</span>
06288 <span class="comment">         */</span>
06289         <span class="keywordflow">if</span> (pqJournal-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a> == 0) {
06290             pqJournal-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a> = 1;    <span class="comment">// prevent underflow</span>
06291             <a class="code" href="../../d4/d1/userk_8h.html#a1209">zzzDestroyQueue</a>(pqJournal, pti); <span class="comment">// DeferWinEventNotify() ?? IANJA ??</span>
06292         } <span class="keywordflow">else</span> {
06293             <span class="comment">/*</span>
06294 <span class="comment">             * Make sure that this queue doesn't point to a pti</span>
06295 <span class="comment">             *  no longer attached to it.</span>
06296 <span class="comment">             * Hopefully we'll go to zzzDestroyQueue only once</span>
06297 <span class="comment">             * Increment cThreads so the queue won't be destroyed</span>
06298 <span class="comment">             *  but we'll simply reassign the pti fields.</span>
06299 <span class="comment">             */</span>
06300             <span class="keywordflow">if</span> ((pqJournal-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o4">ptiMouse</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
06301                     &amp;&amp; (pqJournal != pqJournal-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o4">ptiMouse</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>)) {
06302                 pqJournal-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a>++;
06303                 <a class="code" href="../../d4/d1/userk_8h.html#a1209">zzzDestroyQueue</a>(pqJournal, pqJournal-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o4">ptiMouse</a>);
06304             }
06305             <span class="keywordflow">if</span> ((pqJournal-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
06306                     &amp;&amp; (pqJournal != pqJournal-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>)) {
06307                 pqJournal-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a>++;
06308                 <a class="code" href="../../d4/d1/userk_8h.html#a1209">zzzDestroyQueue</a>(pqJournal, pqJournal-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a>);
06309             }
06310         }
06311     }
06312 
06313 <span class="preprocessor">#if DBG</span>
06314 <span class="preprocessor"></span>    <a class="code" href="../../d4/d1/userk_8h.html#a1794">DBGValidateQueueStates</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>);
06315 <span class="preprocessor">#endif</span>
06316 <span class="preprocessor"></span>
06317     <span class="comment">/*</span>
06318 <span class="comment">     * If the current thread is not on the active desktop, do not</span>
06319 <span class="comment">     * change the global foreground state.</span>
06320 <span class="comment">     */</span>
06321     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;rpdesk != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>) {
06322         <a class="code" href="../../d4/d1/userk_8h.html#a167">EXITATOMICCHECK</a>();
06323         <a class="code" href="../../d4/d1/userk_8h.html#a617">zzzEndDeferWinEventNotify</a>();
06324         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06325     }
06326 
06327     <span class="comment">/*</span>
06328 <span class="comment">     * We're done attaching. gptiForeground hasn't changed... but</span>
06329 <span class="comment">     * gpqForeground has!  Try not to leave NULL as the foreground.</span>
06330 <span class="comment">     */</span>
06331 <span class="preprocessor">#if DBG</span>
06332 <span class="preprocessor"></span>    DBGValidateQueue(pqForegroundNew);
06333 <span class="preprocessor">#endif</span>
06334 <span class="preprocessor"></span>    <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> = pqForegroundNew;
06335     <span class="comment">// So we can Alt-Esc xxxNextWindow without an AV</span>
06336     <span class="comment">// If we have a non-NULL gpqForeground, its kbd input thread better have an rpdesk!</span>
06337     UserAssert(!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> || (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a> &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>));
06338     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a30">gpqForegroundPrev</a> = pqForegroundPrevNew;
06339 
06340     <a class="code" href="../../d4/d1/userk_8h.html#a163">ENDATOMICCHECK</a>();
06341     <a class="code" href="../../d4/d1/userk_8h.html#a617">zzzEndDeferWinEventNotify</a>();
06342 
06343     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (bHadAnActiveForegroundWindow))  {
06344         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndNewForeground;
06345         <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
06346 
06347         pwndNewForeground = <a class="code" href="../../d4/d1/userk_8h.html#a1893">_GetNextQueueWindow</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
06348 
06349         <span class="comment">/*</span>
06350 <span class="comment">         * Don't use xxxSetForegroundWindow2 because we must not leave</span>
06351 <span class="comment">         * the critical section.  There is no currently active foreground</span>
06352 <span class="comment">         * so all that is needed is to post an activate event to the</span>
06353 <span class="comment">         * new foreground queue.</span>
06354 <span class="comment">         */</span>
06355         <span class="keywordflow">if</span> (pwndNewForeground != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06356             <a class="code" href="../../d4/d1/userk_8h.html#a1217">PostEventMessage</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndNewForeground),
06357                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndNewForeground)-&gt;pq, <a class="code" href="../../d4/d1/userk_8h.html#a339">QEVENT_ACTIVATE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0,
06358                     0, (LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwndNewForeground));
06359         }
06360     }
06361     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a32">zzzSetFMouseMoved</a>();
06362     UserAssert((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o4">ptiMouse</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>));
06363 
06364     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06365 }
06366 
<a name="l06367"></a><a class="code" href="../../d4/d1/userk_8h.html#a1202">06367</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1202">zzzAttachThreadInput</a>(
06368     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiAttach,
06369     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiAttachTo,
06370     BOOL fAttach)
06371 {
06372     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
06373 
06374     <span class="comment">/*</span>
06375 <span class="comment">     * Attaching to yourself doesn't make any sense.</span>
06376 <span class="comment">     */</span>
06377     <span class="keywordflow">if</span> (ptiAttach == ptiAttachTo)
06378         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06379 
06380 <span class="preprocessor">#if defined(FE_IME)</span>
06381 <span class="preprocessor"></span>    <span class="comment">/*</span>
06382 <span class="comment">     * For console IME issue</span>
06383 <span class="comment">     *</span>
06384 <span class="comment">     * Console IME do attach to console input thread message queue.</span>
06385 <span class="comment">     * So needs share message queue for synchronize a key state.</span>
06386 <span class="comment">     */</span>
06387     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
06388         <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiConsoleIME;
06389         <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiConsoleInput;
06390 
06391         <span class="keywordflow">if</span> ( ((ptiConsoleIME   = <a class="code" href="../../d4/d1/userk_8h.html#a1201">PtiFromThreadId</a>(ptiAttach-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o18">dwConsoleIMEThreadId</a>)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
06392              ((ptiConsoleInput = <a class="code" href="../../d4/d1/userk_8h.html#a1201">PtiFromThreadId</a>(ptiAttach-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o17">dwConsoleThreadId</a>)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)    &amp;&amp;
06393              (ptiAttach == ptiConsoleIME)     &amp;&amp;
06394              (ptiAttachTo == ptiConsoleInput) &amp;&amp;
06395              (ptiConsoleIME-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a801">TIF_DONTATTACHQUEUE</a>)
06396            )
06397         {
06398             <span class="keywordflow">goto</span> SkipCheck;
06399         }
06400     }
06401 <span class="preprocessor">#endif</span>
06402 <span class="preprocessor"></span>    <span class="comment">/*</span>
06403 <span class="comment">     * Will this thread allow attaching? Shell threads and system threads</span>
06404 <span class="comment">     * won't allow attaching.</span>
06405 <span class="comment">     */</span>
06406     <span class="keywordflow">if</span> (ptiAttachTo-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a801">TIF_DONTATTACHQUEUE</a>)
06407         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06408     <span class="keywordflow">if</span> (ptiAttach-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a801">TIF_DONTATTACHQUEUE</a>)
06409         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06410 
06411 <span class="preprocessor">#if defined(FE_IME)</span>
06412 <span class="preprocessor"></span>SkipCheck:
06413 <span class="preprocessor">#endif</span>
06414 <span class="preprocessor"></span>    <span class="comment">/*</span>
06415 <span class="comment">     * Don't allow attaching across desktops, either.</span>
06416 <span class="comment">     */</span>
06417     <span class="keywordflow">if</span> (ptiAttachTo-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> != ptiAttach-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>)
06418         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06419 
06420     <span class="comment">/*</span>
06421 <span class="comment">     * If attaching, make a new attachinfo structure for this thread.</span>
06422 <span class="comment">     * If not attaching, remove an existing attach reference.</span>
06423 <span class="comment">     */</span>
06424     <span class="keywordflow">if</span> (fAttach) {
06425         <a class="code" href="../../d6/d8/structtagATTACHINFO.html">PATTACHINFO</a> pai;
06426 
06427          <span class="comment">/*</span>
06428 <span class="comment">         * Alloc a new attachinfo struct, fill it in, link it in.</span>
06429 <span class="comment">         */</span>
06430         <span class="keywordflow">if</span> ((pai = (<a class="code" href="../../d6/d8/structtagATTACHINFO.html">PATTACHINFO</a>)UserAllocPool(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d8/structtagATTACHINFO.html">ATTACHINFO</a>), TAG_ATTACHINFO)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
06431             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06432 
06433         pai-&gt;<a class="code" href="../../d6/d8/structtagATTACHINFO.html#o1">pti1</a> = ptiAttach;
06434         pai-&gt;<a class="code" href="../../d6/d8/structtagATTACHINFO.html#o2">pti2</a> = ptiAttachTo;;
06435         pai-&gt;<a class="code" href="../../d6/d8/structtagATTACHINFO.html#o0">paiNext</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a106">gpai</a>;
06436         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a106">gpai</a> = pai;
06437     } <span class="keywordflow">else</span> {
06438         <a class="code" href="../../d6/d8/structtagATTACHINFO.html">PATTACHINFO</a> *ppai;
06439         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06440 
06441         <span class="comment">/*</span>
06442 <span class="comment">         * Search for this attachinfo struct. If we can't find it, fail.</span>
06443 <span class="comment">         * If we do find it, unlink it and free it.</span>
06444 <span class="comment">         */</span>
06445         <span class="keywordflow">for</span> (ppai = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a106">gpai</a>; (*ppai) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; ppai = &amp;(*ppai)-&gt;<a class="code" href="../../d6/d8/structtagATTACHINFO.html#o0">paiNext</a>) {
06446             <span class="keywordflow">if</span> (((*ppai)-&gt;pti2 == ptiAttachTo) &amp;&amp; ((*ppai)-&gt;pti1 == ptiAttach)) {
06447                 <a class="code" href="../../d6/d8/structtagATTACHINFO.html">PATTACHINFO</a> paiKill = *ppai;
06448                 fFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06449                 *ppai = (*ppai)-&gt;<a class="code" href="../../d6/d8/structtagATTACHINFO.html#o0">paiNext</a>;
06450                 UserFreePool((HLOCAL)paiKill);
06451                 <span class="keywordflow">break</span>;
06452             }
06453         }
06454 
06455         <span class="comment">/*</span>
06456 <span class="comment">         * If we couldn't find this reference, then fail.</span>
06457 <span class="comment">         */</span>
06458         <span class="keywordflow">if</span> (!fFound) {
06459             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06460         }
06461     }
06462 
06463     <span class="comment">/*</span>
06464 <span class="comment">     * Now do the actual reattachment work for all threads - unless we're</span>
06465 <span class="comment">     * journalling. If we did by mistake do attachment while journalling</span>
06466 <span class="comment">     * was occuring, journalling would be hosed because journalling requires</span>
06467 <span class="comment">     * all threads to be attached - but it is also treated as a special</span>
06468 <span class="comment">     * case so it doesn't affect the ATTACHINFO structures. Therefore</span>
06469 <span class="comment">     * recalcing attach info based on ATTACHINFO structures would break</span>
06470 <span class="comment">     * the attachment required for journalling.</span>
06471 <span class="comment">     */</span>
06472     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a418">FJOURNALRECORD</a>() &amp;&amp; !<a class="code" href="../../d4/d1/userk_8h.html#a419">FJOURNALPLAYBACK</a>())
06473         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1203">zzzReattachThreads</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
06474 
06475     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06476 }
06477 
06478 <span class="comment">/***************************************************************************\</span>
06479 <span class="comment">* _SetMessageExtraInfo (API)</span>
06480 <span class="comment">*</span>
06481 <span class="comment">* History:</span>
06482 <span class="comment">* 1-May-1995 FritzS</span>
06483 <span class="comment">\***************************************************************************/</span>
06484 
<a name="l06485"></a><a class="code" href="../../d4/d1/userk_8h.html#a1915">06485</a> LONG_PTR <a class="code" href="../../d4/d1/userk_8h.html#a1915">_SetMessageExtraInfo</a>(LONG_PTR lData)
06486 {
06487     LONG_PTR lRet;
06488     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
06489 
06490     lRet = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o25">ExtraInfo</a>;
06491     pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o25">ExtraInfo</a> = lData;
06492     <span class="keywordflow">return</span> lRet;
06493 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:24 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
