<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cmworker.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cmworker.c</h1><a href="../../d5/d3/cmworker_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1992  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    cmworker.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains support for the worker thread of the registry.</span>
00012 <span class="comment">    The worker thread (actually an executive worker thread is used) is</span>
00013 <span class="comment">    required for operations that must take place in the context of the</span>
00014 <span class="comment">    system process.  (particularly file I/O)</span>
00015 <span class="comment"></span>
00016 <span class="comment">Author:</span>
00017 <span class="comment"></span>
00018 <span class="comment">    John Vert (jvert) 21-Oct-1992</span>
00019 <span class="comment"></span>
00020 <span class="comment">Revision History:</span>
00021 <span class="comment"></span>
00022 <span class="comment">--*/</span>
00023 
00024 <span class="preprocessor">#include    "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00025 
<a name="l00026"></a><a class="code" href="../../d5/d3/cmworker_8c.html#a3">00026</a> <span class="keyword">extern</span>  LIST_ENTRY  <a class="code" href="../../d8/d9/cmapi_8c.html#a1">CmpHiveListHead</a>;
00027 
00028 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00029 <a class="code" href="../../d5/d3/cmworker_8c.html#a15">CmpInitializeHiveList</a>(
00030     VOID
00031     );
00032 
00033 <span class="comment">//</span>
00034 <span class="comment">// ----- LAZY FLUSH CONTROL -----</span>
00035 <span class="comment">//</span>
00036 <span class="comment">// LAZY_FLUSH_INTERVAL_IN_SECONDS controls how many seconds will elapse</span>
00037 <span class="comment">// between when the hive is marked dirty and when the lazy flush worker</span>
00038 <span class="comment">// thread is queued to write the data to disk.</span>
00039 <span class="comment">//</span>
<a name="l00040"></a><a class="code" href="../../d5/d3/cmworker_8c.html#a0">00040</a> <span class="preprocessor">#define LAZY_FLUSH_INTERVAL_IN_SECONDS  5</span>
00041 <span class="preprocessor"></span>
00042 <span class="comment">//</span>
00043 <span class="comment">// LAZY_FLUSH_TIMEOUT_IN_SECONDS controls how long the lazy flush worker</span>
00044 <span class="comment">// thread will wait for the registry lock before giving up and queueing</span>
00045 <span class="comment">// the lazy flush timer again.</span>
00046 <span class="comment">//</span>
<a name="l00047"></a><a class="code" href="../../d5/d3/cmworker_8c.html#a1">00047</a> <span class="preprocessor">#define LAZY_FLUSH_TIMEOUT_IN_SECONDS 1</span>
00048 <span class="preprocessor"></span>
<a name="l00049"></a><a class="code" href="../../d5/d3/cmworker_8c.html#a2">00049</a> <span class="preprocessor">#define SECOND_MULT 10*1000*1000        // 10-&gt;mic, 1000-&gt;mil, 1000-&gt;second</span>
00050 <span class="preprocessor"></span>
<a name="l00051"></a><a class="code" href="../../d5/d3/cmworker_8c.html#a4">00051</a> <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a>   <a class="code" href="../../d1/d3/cmsysini_8c.html#a9">CmpSystemProcess</a>;
<a name="l00052"></a><a class="code" href="../../d5/d3/cmworker_8c.html#a5">00052</a> <a class="code" href="../../d3/d8/struct__KTIMER.html">KTIMER</a>      <a class="code" href="../../d5/d3/cmworker_8c.html#a5">CmpLazyFlushTimer</a>;
<a name="l00053"></a><a class="code" href="../../d5/d3/cmworker_8c.html#a6">00053</a> <a class="code" href="../../d1/d6/struct__KDPC.html">KDPC</a>        <a class="code" href="../../d5/d3/cmworker_8c.html#a6">CmpLazyFlushDpc</a>;
<a name="l00054"></a><a class="code" href="../../d5/d3/cmworker_8c.html#a7">00054</a> <a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">WORK_QUEUE_ITEM</a> <a class="code" href="../../d5/d3/cmworker_8c.html#a7">CmpLazyWorkItem</a>;
00055 
<a name="l00056"></a><a class="code" href="../../d5/d3/cmworker_8c.html#a8">00056</a> BOOLEAN <a class="code" href="../../d1/d2/cmp_8h.html#a185">CmpLazyFlushPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00057 
<a name="l00058"></a><a class="code" href="../../d5/d3/cmworker_8c.html#a9">00058</a> <span class="keyword">extern</span> BOOLEAN <a class="code" href="../../d8/d9/cmapi_8c.html#a0">CmpNoWrite</a>;
<a name="l00059"></a><a class="code" href="../../d5/d3/cmworker_8c.html#a10">00059</a> <span class="keyword">extern</span> BOOLEAN <a class="code" href="../../d8/d9/cmapi_8c.html#a3">CmpWasSetupBoot</a>;
<a name="l00060"></a><a class="code" href="../../d5/d3/cmworker_8c.html#a11">00060</a> <span class="keyword">extern</span> BOOLEAN <a class="code" href="../../d7/d0/cmdat2_8c.html#a13">HvShutdownComplete</a>;
<a name="l00061"></a><a class="code" href="../../d5/d3/cmworker_8c.html#a12">00061</a> <span class="keyword">extern</span> BOOLEAN <a class="code" href="../../d8/d9/cmapi_8c.html#a2">CmpProfileLoaded</a>;
00062 
00063 <span class="comment">//</span>
00064 <span class="comment">// Indicate whether the "disk full" popup has been triggered yet or not.</span>
00065 <span class="comment">//</span>
<a name="l00066"></a><a class="code" href="../../d5/d3/cmworker_8c.html#a13">00066</a> <span class="keyword">extern</span> BOOLEAN <a class="code" href="../../d7/d0/cmdat2_8c.html#a7">CmpDiskFullWorkerPopupDisplayed</a>;
00067 
00068 <span class="comment">//</span>
00069 <span class="comment">// set to true if disk full when trying to save the changes made between system hive loading and registry initalization</span>
00070 <span class="comment">//</span>
<a name="l00071"></a><a class="code" href="../../d5/d3/cmworker_8c.html#a14">00071</a> <span class="keyword">extern</span> BOOLEAN <a class="code" href="../../d7/d0/cmdat2_8c.html#a8">CmpCannotWriteConfiguration</a>;
00072 
00073 <span class="preprocessor">#if DBG</span>
00074 <span class="preprocessor"></span><a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>    CmpCallerThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00075 <span class="preprocessor">#endif</span>
00076 <span class="preprocessor"></span>
00077 <span class="comment">//</span>
00078 <span class="comment">// Local function prototypes</span>
00079 <span class="comment">//</span>
00080 
00081 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00082 <a class="code" href="../../d5/d3/cmworker_8c.html#a16">CmpLazyFlushWorker</a>(
00083     IN PVOID Parameter
00084     );
00085 
00086 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00087 <a class="code" href="../../d5/d3/cmworker_8c.html#a17">CmpLazyFlushDpcRoutine</a>(
00088     IN <a class="code" href="../../d1/d6/struct__KDPC.html">PKDPC</a> Dpc,
00089     IN PVOID DeferredContext,
00090     IN PVOID SystemArgument1,
00091     IN PVOID SystemArgument2
00092     );
00093 
00094 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00095 <a class="code" href="../../d5/d3/cmworker_8c.html#a18">CmpDiskFullWarningWorker</a>(
00096     IN PVOID WorkItem
00097     );
00098 
00099 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00100 <a class="code" href="../../d5/d3/cmworker_8c.html#a19">CmpDiskFullWarning</a>(
00101     VOID
00102     );
00103 
00104 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00105 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpWorker)</span>
00106 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpLazyFlush)</span>
00107 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpLazyFlushWorker)</span>
00108 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpDiskFullWarningWorker)</span>
00109 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpDiskFullWarning)</span>
00110 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00111 <span class="preprocessor"></span>
00112 
00113 
00114 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00115"></a><a class="code" href="../../d5/d3/cmworker_8c.html#a20">00115</a> <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(
00116     IN <a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html">PREGISTRY_COMMAND</a> CommandArea
00117     )
00118 <span class="comment">/*++</span>
00119 <span class="comment"></span>
00120 <span class="comment">Routine Description:</span>
00121 <span class="comment"></span>
00122 <span class="comment">    Actually execute the command specified in CommandArea, and</span>
00123 <span class="comment">    report its completion.</span>
00124 <span class="comment"></span>
00125 <span class="comment">Arguments:</span>
00126 <span class="comment"></span>
00127 <span class="comment">    Parameter - supplies a pointer to the REGISTRY_COMMAND structure to</span>
00128 <span class="comment">                be executed.</span>
00129 <span class="comment"></span>
00130 <span class="comment">Return Value:</span>
00131 <span class="comment"></span>
00132 <span class="comment">--*/</span>
00133 {
00134     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00135     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive;
00136     IO_STATUS_BLOCK IoStatusBlock;
00137     PUNICODE_STRING <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>;
00138     ULONG i;
00139     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00140     PFILE_RENAME_INFORMATION RenameInfo;
00141     PLIST_ENTRY p;
00142     BOOLEAN result;
00143     HANDLE NullHandle;
00144 
00145     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00146 
00147     <span class="keywordflow">switch</span> (<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a>) {
00148 
00149         <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a101">REG_CMD_INIT</a>:
00150             <span class="comment">//</span>
00151             <span class="comment">// Initialize lazy flush timer and DPC</span>
00152             <span class="comment">//</span>
00153             <a class="code" href="../../d4/d1/dpcobj_8c.html#a1">KeInitializeDpc</a>(&amp;<a class="code" href="../../d5/d3/cmworker_8c.html#a6">CmpLazyFlushDpc</a>,
00154                             <a class="code" href="../../d5/d3/cmworker_8c.html#a17">CmpLazyFlushDpcRoutine</a>,
00155                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00156 
00157             <a class="code" href="../../d3/d2/timerobj_8c.html#a1">KeInitializeTimer</a>(&amp;<a class="code" href="../../d5/d3/cmworker_8c.html#a5">CmpLazyFlushTimer</a>);
00158 
00159             <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>(&amp;<a class="code" href="../../d5/d3/cmworker_8c.html#a7">CmpLazyWorkItem</a>, <a class="code" href="../../d5/d3/cmworker_8c.html#a16">CmpLazyFlushWorker</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00160 
00161             <a class="code" href="../../d8/d9/cmapi_8c.html#a0">CmpNoWrite</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00162 
00163             <a class="code" href="../../d8/d9/cmapi_8c.html#a3">CmpWasSetupBoot</a> = <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o11">SetupBoot</a>;
00164             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o11">SetupBoot</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00165                 <a class="code" href="../../d5/d3/cmworker_8c.html#a15">CmpInitializeHiveList</a>();
00166             }
00167 
00168             <span class="comment">//</span>
00169             <span class="comment">// flush dirty data to disk</span>
00170             <span class="comment">//</span>
00171             <a class="code" href="../../d1/d2/cmp_8h.html#a243">CmpDoFlushAll</a>();
00172             <span class="keywordflow">break</span>;
00173 
00174         <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a102">REG_CMD_FLUSH_KEY</a>:
00175             <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a> =
00176                 <a class="code" href="../../d1/d2/cmp_8h.html#a228">CmFlushKey</a>(<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o1">Hive</a>, <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o2">Cell</a>);
00177             <span class="keywordflow">break</span>;
00178 
00179         <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a110">REG_CMD_REFRESH_HIVE</a>:
00180             <span class="comment">//</span>
00181             <span class="comment">// Refresh hive to match last flushed version</span>
00182             <span class="comment">//</span>
00183             <a class="code" href="../../d0/d2/hivesync_8c.html#a6">HvRefreshHive</a>(<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o1">Hive</a>);
00184             <span class="keywordflow">break</span>;
00185 
00186         <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a103">REG_CMD_FILE_SET_SIZE</a>:
00187             <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a> = <a class="code" href="../../d7/d3/cmwrapr_8c.html#a13">CmpDoFileSetSize</a>(
00188                                     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o1">Hive</a>,
00189                                     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o3">FileType</a>,
00190                                     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o4">FileSize</a>
00191                                     );
00192             <span class="keywordflow">break</span>;
00193 
00194         <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a104">REG_CMD_HIVE_OPEN</a>:
00195 
00196             <span class="comment">//</span>
00197             <span class="comment">// Open the file.</span>
00198             <span class="comment">//</span>
00199             <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> = <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o6">FileAttributes</a>-&gt;ObjectName;
00200 
00201             <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a> = <a class="code" href="../../d1/d3/cmsysini_8c.html#a52">CmpInitHiveFromFile</a>(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>,
00202                                                      0,
00203                                                      &amp;<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a>,
00204                                                      &amp;<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o10">Allocate</a>,
00205                                                      &amp;<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o12">RegistryLockAquired</a>);
00206             <span class="comment">//</span>
00207             <span class="comment">// NT Servers will return STATUS_ACCESS_DENIED. Netware 3.1x</span>
00208             <span class="comment">// servers could return any of the other error codes if the GUEST</span>
00209             <span class="comment">// account is disabled.</span>
00210             <span class="comment">//</span>
00211             <span class="keywordflow">if</span> (((<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a> == STATUS_ACCESS_DENIED) ||
00212                  (<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a> == STATUS_NO_SUCH_USER) ||
00213                  (<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a> == STATUS_WRONG_PASSWORD) ||
00214                  (<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a> == STATUS_ACCOUNT_EXPIRED) ||
00215                  (<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a> == STATUS_ACCOUNT_DISABLED) ||
00216                  (<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a> == STATUS_ACCOUNT_RESTRICTION)) &amp;&amp;
00217                 (<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o16">ImpersonationContext</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00218                 <span class="comment">//</span>
00219                 <span class="comment">// Impersonate the caller and try it again.  This</span>
00220                 <span class="comment">// lets us open hives on a remote machine.</span>
00221                 <span class="comment">//</span>
00222                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d5/seclient_8c.html#a3">SeImpersonateClientEx</a>(
00223                                 <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o16">ImpersonationContext</a>,
00224                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00225 
00226                 <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) ) {
00227 
00228                     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a> = <a class="code" href="../../d1/d3/cmsysini_8c.html#a52">CmpInitHiveFromFile</a>(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>,
00229                                                              0,
00230                                                              &amp;<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a>,
00231                                                              &amp;<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o10">Allocate</a>,
00232                                                              &amp;<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o12">RegistryLockAquired</a>);
00233                     NullHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00234 
00235                     <a class="code" href="../../d6/d5/ps_2security_8c.html#a9">PsRevertToSelf</a>();
00236                 }
00237             }
00238 
00239             <span class="keywordflow">break</span>;
00240 
00241         <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a105">REG_CMD_HIVE_CLOSE</a>:
00242 
00243             <span class="comment">//</span>
00244             <span class="comment">// Close the files associated with this hive.</span>
00245             <span class="comment">//</span>
00246             CmHive = <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a>;
00247 
00248             <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d0/d1/hivedata_8h.html#a42">HFILE_TYPE_MAX</a>; i++) {
00249                 <span class="keywordflow">if</span> (CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[i] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00250                     ZwClose(CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[i]);
00251                     CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[i] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00252                 }
00253             }
00254             <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a> = STATUS_SUCCESS;
00255             <span class="keywordflow">break</span>;
00256 
00257         <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a111">REG_CMD_HIVE_READ</a>:
00258 
00259             <span class="comment">//</span>
00260             <span class="comment">// Used by special case of savekey, just do a read</span>
00261             <span class="comment">//</span>
00262             result = <a class="code" href="../../d7/d3/cmwrapr_8c.html#a15">CmpFileRead</a>(
00263                         (<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a>,
00264                         <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o3">FileType</a>,
00265                         <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o9">Offset</a>,
00266                         <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o8">Buffer</a>,
00267                         <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o4">FileSize</a>           <span class="comment">// read length</span>
00268                         );
00269             <span class="keywordflow">if</span> (result) {
00270                 <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a> = STATUS_SUCCESS;
00271             } <span class="keywordflow">else</span> {
00272                 <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a> = STATUS_REGISTRY_IO_FAILED;
00273             }
00274             <span class="keywordflow">break</span>;
00275 
00276         <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a106">REG_CMD_SHUTDOWN</a>:
00277 
00278             <span class="comment">//</span>
00279             <span class="comment">// shut down the registry</span>
00280             <span class="comment">//</span>
00281             <a class="code" href="../../d1/d2/cmp_8h.html#a243">CmpDoFlushAll</a>();
00282 
00283             <span class="comment">//</span>
00284             <span class="comment">// close all the hive files</span>
00285             <span class="comment">//</span>
00286             p=<a class="code" href="../../d8/d9/cmapi_8c.html#a1">CmpHiveListHead</a>.Flink;
00287             <span class="keywordflow">while</span> (p!=&amp;<a class="code" href="../../d8/d9/cmapi_8c.html#a1">CmpHiveListHead</a>) {
00288                 CmHive = CONTAINING_RECORD(p, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, <a class="code" href="../../d4/d6/regext_8c.html#a0">HiveList</a>);
00289                 <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d0/d1/hivedata_8h.html#a42">HFILE_TYPE_MAX</a>; i++) {
00290                     <span class="keywordflow">if</span> (CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[i] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00291                         ZwClose(CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[i]);
00292                         CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[i] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00293                     }
00294                 }
00295                 p=p-&gt;Flink;
00296             }
00297 
00298             <span class="keywordflow">break</span>;
00299 
00300         <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a107">REG_CMD_RENAME_HIVE</a>:
00301             <span class="comment">//</span>
00302             <span class="comment">// Rename a CmHive's primary handle</span>
00303             <span class="comment">//</span>
00304             <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a>-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>];
00305             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o14">OldName</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00306                 <a class="code" href="../../d1/d2/cmp_8h.html#a63">ASSERT_PASSIVE_LEVEL</a>();
00307                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQueryObject(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
00308                                        ObjectNameInformation,
00309                                        <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o14">OldName</a>,
00310                                        <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o15">NameInfoLength</a>,
00311                                        &amp;<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o15">NameInfoLength</a>);
00312                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00313                     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00314                     <span class="keywordflow">break</span>;
00315                 }
00316             }
00317 
00318             RenameInfo = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00319                                         <span class="keyword">sizeof</span>(FILE_RENAME_INFORMATION) +
00320                                         <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o13">NewName</a>-&gt;Length);
00321             <span class="keywordflow">if</span> (RenameInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00322                 <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00323                 <span class="keywordflow">break</span>;
00324             }
00325             RenameInfo-&gt;ReplaceIfExists = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00326             RenameInfo-&gt;RootDirectory = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00327             RenameInfo-&gt;FileNameLength = <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o13">NewName</a>-&gt;Length;
00328             RtlMoveMemory(RenameInfo-&gt;FileName,
00329                           <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o13">NewName</a>-&gt;Buffer,
00330                           <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o13">NewName</a>-&gt;Length);
00331 
00332             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a39">ZwSetInformationFile</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
00333                                           &amp;IoStatusBlock,
00334                                           (PVOID)RenameInfo,
00335                                           <span class="keyword">sizeof</span>(FILE_RENAME_INFORMATION) +
00336                                           <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o13">NewName</a>-&gt;Length,
00337                                           FileRenameInformation);
00338             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(RenameInfo);
00339             <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00340             <span class="keywordflow">break</span>;
00341 
00342         <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a108">REG_CMD_ADD_HIVE_LIST</a>:
00343             <span class="comment">//</span>
00344             <span class="comment">// Add a hive to the hive file list</span>
00345             <span class="comment">//</span>
00346             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a309">CmpAddToHiveFileList</a>(<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a>);
00347             <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00348             <span class="keywordflow">break</span>;
00349 
00350         <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a109">REG_CMD_REMOVE_HIVE_LIST</a>:
00351             <span class="comment">//</span>
00352             <span class="comment">// Remove a hive from the hive file list</span>
00353             <span class="comment">//</span>
00354             <a class="code" href="../../d1/d2/cmp_8h.html#a310">CmpRemoveFromHiveFileList</a>(<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a>);
00355             <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>-&gt;<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a> = STATUS_SUCCESS;
00356             <span class="keywordflow">break</span>;
00357 
00358         <span class="keywordflow">default</span>:
00359             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR,6,1,0,0);
00360 
00361     } <span class="comment">// switch</span>
00362 
00363     <span class="keywordflow">return</span>;
00364 }
00365 
00366 
00367 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00368"></a><a class="code" href="../../d5/d3/cmworker_8c.html#a21">00368</a> <a class="code" href="../../d6/d3/cmwraper_8c.html#a11">CmpLazyFlush</a>(
00369     VOID
00370     )
00371 
00372 <span class="comment">/*++</span>
00373 <span class="comment"></span>
00374 <span class="comment">Routine Description:</span>
00375 <span class="comment"></span>
00376 <span class="comment">    This routine resets the registry timer to go off at a specified interval</span>
00377 <span class="comment">    in the future (LAZY_FLUSH_INTERVAL_IN_SECONDS).</span>
00378 <span class="comment"></span>
00379 <span class="comment">Arguments:</span>
00380 <span class="comment"></span>
00381 <span class="comment">    None</span>
00382 <span class="comment"></span>
00383 <span class="comment">Return Value:</span>
00384 <span class="comment"></span>
00385 <span class="comment">    None.</span>
00386 <span class="comment"></span>
00387 <span class="comment">--*/</span>
00388 
00389 {
00390     LARGE_INTEGER DueTime;
00391 
00392     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00393     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a30">CMS_IO</a>) {
00394         KdPrint((<span class="stringliteral">"CmpLazyFlush: setting lazy flush timer\n"</span>));
00395     }
00396     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d9/cmapi_8c.html#a0">CmpNoWrite</a>) {
00397 
00398         DueTime.QuadPart = Int32x32To64(<a class="code" href="../../d5/d3/cmworker_8c.html#a0">LAZY_FLUSH_INTERVAL_IN_SECONDS</a>,
00399                                         - <a class="code" href="../../d5/d3/cmworker_8c.html#a2">SECOND_MULT</a>);
00400 
00401         <span class="comment">//</span>
00402         <span class="comment">// Indicate relative time</span>
00403         <span class="comment">//</span>
00404 
00405         <a class="code" href="../../d3/d2/timerobj_8c.html#a6">KeSetTimer</a>(&amp;<a class="code" href="../../d5/d3/cmworker_8c.html#a5">CmpLazyFlushTimer</a>,
00406                    DueTime,
00407                    &amp;<a class="code" href="../../d5/d3/cmworker_8c.html#a6">CmpLazyFlushDpc</a>);
00408 
00409     }
00410 
00411 
00412 }
00413 
00414 
00415 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00416"></a><a class="code" href="../../d5/d3/cmworker_8c.html#a17">00416</a> <a class="code" href="../../d5/d3/cmworker_8c.html#a17">CmpLazyFlushDpcRoutine</a>(
00417     IN <a class="code" href="../../d1/d6/struct__KDPC.html">PKDPC</a> Dpc,
00418     IN PVOID DeferredContext,
00419     IN PVOID SystemArgument1,
00420     IN PVOID SystemArgument2
00421     )
00422 
00423 <span class="comment">/*++</span>
00424 <span class="comment"></span>
00425 <span class="comment">Routine Description:</span>
00426 <span class="comment"></span>
00427 <span class="comment">    This is the DPC routine triggered by the lazy flush timer.  All it does</span>
00428 <span class="comment">    is queue a work item to an executive worker thread.  The work item will</span>
00429 <span class="comment">    do the actual lazy flush to disk.</span>
00430 <span class="comment"></span>
00431 <span class="comment">Arguments:</span>
00432 <span class="comment"></span>
00433 <span class="comment">    Dpc - Supplies a pointer to the DPC object.</span>
00434 <span class="comment"></span>
00435 <span class="comment">    DeferredContext - not used</span>
00436 <span class="comment"></span>
00437 <span class="comment">    SystemArgument1 - not used</span>
00438 <span class="comment"></span>
00439 <span class="comment">    SystemArgument2 - not used</span>
00440 <span class="comment"></span>
00441 <span class="comment">Return Value:</span>
00442 <span class="comment"></span>
00443 <span class="comment">    None.</span>
00444 <span class="comment"></span>
00445 <span class="comment">--*/</span>
00446 
00447 {
00448     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a30">CMS_IO</a>) {
00449         KdPrint((<span class="stringliteral">"CmpLazyFlushDpc: queuing lazy flush work item\n"</span>));
00450     }
00451 
00452     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d2/cmp_8h.html#a185">CmpLazyFlushPending</a>) {
00453         <a class="code" href="../../d1/d2/cmp_8h.html#a185">CmpLazyFlushPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00454         <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>(&amp;<a class="code" href="../../d5/d3/cmworker_8c.html#a7">CmpLazyWorkItem</a>, <a class="code" href="../../d5/d8/ex_8h.html#a332a206">DelayedWorkQueue</a>);
00455     }
00456 
00457 }
00458 
00459 
00460 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00461"></a><a class="code" href="../../d5/d3/cmworker_8c.html#a16">00461</a> <a class="code" href="../../d5/d3/cmworker_8c.html#a16">CmpLazyFlushWorker</a>(
00462     IN PVOID Parameter
00463     )
00464 
00465 <span class="comment">/*++</span>
00466 <span class="comment"></span>
00467 <span class="comment">Routine Description:</span>
00468 <span class="comment"></span>
00469 <span class="comment">    Worker routine called to do a lazy flush.  Called by an executive worker</span>
00470 <span class="comment">    thread in the system process.  </span>
00471 <span class="comment"></span>
00472 <span class="comment">Arguments:</span>
00473 <span class="comment"></span>
00474 <span class="comment">    Parameter - not used.</span>
00475 <span class="comment"></span>
00476 <span class="comment">Return Value:</span>
00477 <span class="comment"></span>
00478 <span class="comment">    None.</span>
00479 <span class="comment"></span>
00480 <span class="comment">--*/</span>
00481 
00482 {
00483     BOOLEAN Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00484 
00485     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00486 
00487     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a30">CMS_IO</a>) {
00488         KdPrint((<span class="stringliteral">"CmpLazyFlushWorker: flushing hives\n"</span>));
00489     }
00490 
00491     <a class="code" href="../../d6/d3/cmwraper_8c.html#a14">CmpLockRegistry</a>();
00492     <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d0/cmdat2_8c.html#a13">HvShutdownComplete</a>) {
00493         Result = <a class="code" href="../../d1/d2/cmp_8h.html#a243">CmpDoFlushAll</a>();
00494     }
00495     <a class="code" href="../../d1/d2/cmp_8h.html#a185">CmpLazyFlushPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00496     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00497 
00498     <span class="keywordflow">if</span>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a8">CmpCannotWriteConfiguration</a> ) {
00499         <span class="comment">//</span>
00500         <span class="comment">// Disk full; system hive haven't been save at initialization</span>
00501         <span class="comment">//</span>
00502         <span class="keywordflow">if</span>(Result) {
00503             <span class="comment">//</span>
00504             <span class="comment">// All hives were saved; No need for disk full warning anymore</span>
00505             <span class="comment">//</span>
00506             <a class="code" href="../../d7/d0/cmdat2_8c.html#a8">CmpCannotWriteConfiguration</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00507         } <span class="keywordflow">else</span> {
00508             <span class="comment">//</span>
00509             <span class="comment">// Issue another hard error (if not already displayed) and postpone a lazy flush operation</span>
00510             <span class="comment">//</span>
00511             <a class="code" href="../../d5/d3/cmworker_8c.html#a19">CmpDiskFullWarning</a>();
00512             <a class="code" href="../../d6/d3/cmwraper_8c.html#a11">CmpLazyFlush</a>();
00513         }
00514     }
00515 }
00516 
00517 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00518"></a><a class="code" href="../../d5/d3/cmworker_8c.html#a18">00518</a> <a class="code" href="../../d5/d3/cmworker_8c.html#a18">CmpDiskFullWarningWorker</a>(
00519     IN PVOID WorkItem
00520     )
00521 
00522 <span class="comment">/*++</span>
00523 <span class="comment"></span>
00524 <span class="comment">Routine Description:</span>
00525 <span class="comment"></span>
00526 <span class="comment">    Displays hard error popup that indicates the disk is full.</span>
00527 <span class="comment"></span>
00528 <span class="comment">Arguments:</span>
00529 <span class="comment"></span>
00530 <span class="comment">    WorkItem - Supplies pointer to the work item. This routine will</span>
00531 <span class="comment">               free the work item.</span>
00532 <span class="comment"></span>
00533 <span class="comment">Return Value:</span>
00534 <span class="comment"></span>
00535 <span class="comment">    None.</span>
00536 <span class="comment"></span>
00537 <span class="comment">--*/</span>
00538 
00539 {
00540     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00541     ULONG Response;
00542 
00543     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(WorkItem);
00544 
00545     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d8/ex_8h.html#a306">ExRaiseHardError</a>(STATUS_DISK_FULL,
00546                               0,
00547                               0,
00548                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00549                               OptionOk,
00550                               &amp;Response);
00551 }
00552 
00553 
00554 
00555 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00556"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a47">00556</a> <a class="code" href="../../d5/d3/cmworker_8c.html#a19">CmpDiskFullWarning</a>(
00557     VOID
00558     )
00559 <span class="comment">/*++</span>
00560 <span class="comment"></span>
00561 <span class="comment">Routine Description:</span>
00562 <span class="comment"></span>
00563 <span class="comment">    Raises a hard error of type STATUS_DISK_FULL if wasn't already raised</span>
00564 <span class="comment"></span>
00565 <span class="comment">Arguments:</span>
00566 <span class="comment"></span>
00567 <span class="comment">    None</span>
00568 <span class="comment"></span>
00569 <span class="comment">Return Value:</span>
00570 <span class="comment"></span>
00571 <span class="comment">    None</span>
00572 <span class="comment"></span>
00573 <span class="comment">--*/</span>
00574 {
00575     <a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">PWORK_QUEUE_ITEM</a> WorkItem;
00576 
00577     <span class="keywordflow">if</span>( (!<a class="code" href="../../d7/d0/cmdat2_8c.html#a7">CmpDiskFullWorkerPopupDisplayed</a>) &amp;&amp; (<a class="code" href="../../d7/d0/cmdat2_8c.html#a8">CmpCannotWriteConfiguration</a>) &amp;&amp; (<a class="code" href="../../d6/d8/ex_2harderr_8c.html#a5">ExReadyForErrors</a>) &amp;&amp; (<a class="code" href="../../d8/d9/cmapi_8c.html#a2">CmpProfileLoaded</a>) ) {
00578 
00579         <span class="comment">//</span>
00580         <span class="comment">// Queue work item to display popup</span>
00581         <span class="comment">//</span>
00582         WorkItem = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">WORK_QUEUE_ITEM</a>));
00583         <span class="keywordflow">if</span> (WorkItem != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00584 
00585             <a class="code" href="../../d7/d0/cmdat2_8c.html#a7">CmpDiskFullWorkerPopupDisplayed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00586             <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>(WorkItem,
00587                                  <a class="code" href="../../d5/d3/cmworker_8c.html#a18">CmpDiskFullWarningWorker</a>,
00588                                  WorkItem);
00589             <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>(WorkItem, <a class="code" href="../../d5/d8/ex_8h.html#a332a206">DelayedWorkQueue</a>);
00590         }
00591     }
00592 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:29 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
