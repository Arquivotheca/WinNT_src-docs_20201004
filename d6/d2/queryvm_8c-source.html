<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: queryvm.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>queryvm.c</h1><a href="../../d5/d3/queryvm_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">   queryvm.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the routines which implement the</span>
00012 <span class="comment">    NtQueryVirtualMemory service.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Lou Perazzoli (loup) 21-Aug-1989</span>
00017 <span class="comment">    Landy Wang (landyw) 02-June-1997</span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
00023 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00024 
<a name="l00025"></a><a class="code" href="../../d5/d3/queryvm_8c.html#a0">00025</a> <span class="keyword">extern</span> <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="code" href="../../d5/d8/fssup_8c.html#a3">IoFileObjectType</a>;
00026 
00027 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00028 <a class="code" href="../../d5/d3/queryvm_8c.html#a1">MiGetWorkingSetInfo</a> (
00029     IN PMEMORY_WORKING_SET_INFORMATION WorkingSetInfo,
00030     IN ULONG Length,
00031     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
00032     );
00033 
00034 <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>
00035 <a class="code" href="../../d5/d3/queryvm_8c.html#a2">MiCaptureSystemPte</a> (
00036     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerProtoPte,
00037     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
00038     );
00039 
00040 <span class="preprocessor">#if DBG</span>
00041 <span class="preprocessor"></span><a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> MmWatchProcess;
00042 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> MmFooBar(VOID);
00043 <span class="preprocessor">#endif // DBG</span>
00044 <span class="preprocessor"></span>
00045 ULONG
00046 <a class="code" href="../../d5/d3/queryvm_8c.html#a3">MiQueryAddressState</a> (
00047     IN PVOID Va,
00048     IN <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad,
00049     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess,
00050     OUT PULONG ReturnedProtect
00051     );
00052 
00053 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00054 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtQueryVirtualMemory)</span>
00055 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiQueryAddressState)</span>
00056 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK,MiGetWorkingSetInfo)</span>
00057 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00058 <span class="preprocessor"></span>
00059 
00060 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00061"></a><a class="code" href="../../d5/d3/queryvm_8c.html#a4">00061</a> <a class="code" href="../../d5/d3/queryvm_8c.html#a4">NtQueryVirtualMemory</a> (
00062     IN HANDLE ProcessHandle,
00063     IN PVOID BaseAddress,
00064     IN MEMORY_INFORMATION_CLASS MemoryInformationClass,
00065     OUT PVOID MemoryInformation,
00066     IN ULONG MemoryInformationLength,
00067     OUT PULONG ReturnLength OPTIONAL
00068      )
00069 
00070 <span class="comment">/*++</span>
00071 <span class="comment"></span>
00072 <span class="comment">Routine Description:</span>
00073 <span class="comment"></span>
00074 <span class="comment">    This function provides the capability to determine the state,</span>
00075 <span class="comment">    protection, and type of a region of pages within the virtual address</span>
00076 <span class="comment">    space of the subject process.</span>
00077 <span class="comment"></span>
00078 <span class="comment">    The state of the first page within the region is determined and then</span>
00079 <span class="comment">    subsequent entries in the process address map are scanned from the</span>
00080 <span class="comment">    base address upward until either the entire range of pages has been</span>
00081 <span class="comment">    scanned or until a page with a nonmatching set of attributes is</span>
00082 <span class="comment">    encountered. The region attributes, the length of the region of pages</span>
00083 <span class="comment">    with matching attributes, and an appropriate status value are</span>
00084 <span class="comment">    returned.</span>
00085 <span class="comment"></span>
00086 <span class="comment">    If the entire region of pages does not have a matching set of</span>
00087 <span class="comment">    attributes, then the returned length parameter value can be used to</span>
00088 <span class="comment">    calculate the address and length of the region of pages that was not</span>
00089 <span class="comment">    scanned.</span>
00090 <span class="comment"></span>
00091 <span class="comment">Arguments:</span>
00092 <span class="comment"></span>
00093 <span class="comment"></span>
00094 <span class="comment">    ProcessHandle - An open handle to a process object.</span>
00095 <span class="comment"></span>
00096 <span class="comment">    BaseAddress - The base address of the region of pages to be</span>
00097 <span class="comment">        queried. This value is rounded down to the next host-page-</span>
00098 <span class="comment">        address boundary.</span>
00099 <span class="comment"></span>
00100 <span class="comment">    MemoryInformationClass - The memory information class about which</span>
00101 <span class="comment">        to retrieve information.</span>
00102 <span class="comment"></span>
00103 <span class="comment">    MemoryInformation - A pointer to a buffer that receives the</span>
00104 <span class="comment">        specified information.  The format and content of the buffer</span>
00105 <span class="comment">        depend on the specified information class.</span>
00106 <span class="comment"></span>
00107 <span class="comment"></span>
00108 <span class="comment">        MemoryBasicInformation - Data type is PMEMORY_BASIC_INFORMATION.</span>
00109 <span class="comment"></span>
00110 <span class="comment">            MEMORY_BASIC_INFORMATION Structure</span>
00111 <span class="comment"></span>
00112 <span class="comment"></span>
00113 <span class="comment">            ULONG RegionSize - The size of the region in bytes</span>
00114 <span class="comment">                beginning at the base address in which all pages have</span>
00115 <span class="comment">                identical attributes.</span>
00116 <span class="comment"></span>
00117 <span class="comment">            ULONG State - The state of the pages within the region.</span>
00118 <span class="comment"></span>
00119 <span class="comment">                State Values                        State Values</span>
00120 <span class="comment"></span>
00121 <span class="comment">                MEM_COMMIT - The state of the pages within the region</span>
00122 <span class="comment">                    is committed.</span>
00123 <span class="comment"></span>
00124 <span class="comment">                MEM_FREE - The state of the pages within the region</span>
00125 <span class="comment">                    is free.</span>
00126 <span class="comment"></span>
00127 <span class="comment">                MEM_RESERVE - The state of the pages within the</span>
00128 <span class="comment">                    region is reserved.</span>
00129 <span class="comment"></span>
00130 <span class="comment">            ULONG Protect - The protection of the pages within the</span>
00131 <span class="comment">                region.</span>
00132 <span class="comment"></span>
00133 <span class="comment"></span>
00134 <span class="comment">                Protect Values                        Protect Values</span>
00135 <span class="comment"></span>
00136 <span class="comment">                PAGE_NOACCESS - No access to the region of pages is</span>
00137 <span class="comment">                    allowed. An attempt to read, write, or execute</span>
00138 <span class="comment">                    within the region results in an access violation</span>
00139 <span class="comment">                    (i.e., a GP fault).</span>
00140 <span class="comment"></span>
00141 <span class="comment">                PAGE_EXECUTE - Execute access to the region of pages</span>
00142 <span class="comment">                    is allowed. An attempt to read or write within</span>
00143 <span class="comment">                    the region results in an access violation.</span>
00144 <span class="comment"></span>
00145 <span class="comment">                PAGE_READONLY - Read-only and execute access to the</span>
00146 <span class="comment">                    region of pages is allowed. An attempt to write</span>
00147 <span class="comment">                    within the region results in an access violation.</span>
00148 <span class="comment"></span>
00149 <span class="comment">                PAGE_READWRITE - Read, write, and execute access to</span>
00150 <span class="comment">                    the region of pages is allowed. If write access</span>
00151 <span class="comment">                    to the underlying section is allowed, then a</span>
00152 <span class="comment">                    single copy of the pages are shared. Otherwise,</span>
00153 <span class="comment">                    the pages are shared read-only/copy-on-write.</span>
00154 <span class="comment"></span>
00155 <span class="comment">                PAGE_GUARD - Read, write, and execute access to the</span>
00156 <span class="comment">                    region of pages is allowed; however, access to</span>
00157 <span class="comment">                    the region causes a "guard region entered"</span>
00158 <span class="comment">                    condition to be raised in the subject process.</span>
00159 <span class="comment"></span>
00160 <span class="comment">                PAGE_NOCACHE - Disable the placement of committed</span>
00161 <span class="comment">                    pages into the data cache.</span>
00162 <span class="comment"></span>
00163 <span class="comment">            ULONG Type - The type of pages within the region.</span>
00164 <span class="comment"></span>
00165 <span class="comment"></span>
00166 <span class="comment">                Type Values</span>
00167 <span class="comment"></span>
00168 <span class="comment">                MEM_PRIVATE - The pages within the region are</span>
00169 <span class="comment">                    private.</span>
00170 <span class="comment"></span>
00171 <span class="comment">                MEM_MAPPED - The pages within the region are mapped</span>
00172 <span class="comment">                    into the view of a section.</span>
00173 <span class="comment"></span>
00174 <span class="comment">                MEM_IMAGE - The pages within the region are mapped</span>
00175 <span class="comment">                    into the view of an image section.</span>
00176 <span class="comment"></span>
00177 <span class="comment">    MemoryInformationLength - Specifies the length in bytes  of</span>
00178 <span class="comment">        the memory information buffer.</span>
00179 <span class="comment"></span>
00180 <span class="comment">    ReturnLength - An optional pointer which, if specified,</span>
00181 <span class="comment">        receives the number of bytes placed in the process</span>
00182 <span class="comment">        information buffer.</span>
00183 <span class="comment"></span>
00184 <span class="comment"></span>
00185 <span class="comment">Return Value:</span>
00186 <span class="comment"></span>
00187 <span class="comment">    Returns the status</span>
00188 <span class="comment"></span>
00189 <span class="comment">    TBS</span>
00190 <span class="comment"></span>
00191 <span class="comment"></span>
00192 <span class="comment">Environment:</span>
00193 <span class="comment"></span>
00194 <span class="comment">    Kernel mode.</span>
00195 <span class="comment"></span>
00196 <span class="comment">--*/</span>
00197 
00198 {
00199     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00200     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess;
00201     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00202     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
00203     BOOLEAN PteIsZero;
00204     PVOID Va;
00205     BOOLEAN Found;
00206     SIZE_T TheRegionSize;
00207     ULONG NewProtect;
00208     ULONG NewState;
00209     PVOID FilePointer;
00210     ULONG_PTR BaseVpn;
00211     MEMORY_BASIC_INFORMATION Info;
00212     LOGICAL Attached;
00213 
00214     Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00215     PteIsZero = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00216 
00217     <span class="comment">//</span>
00218     <span class="comment">// Make sure the user's buffer is large enough for the requested operation.</span>
00219     <span class="comment">//</span>
00220 
00221     <span class="comment">//</span>
00222     <span class="comment">// Check argument validity.</span>
00223     <span class="comment">//</span>
00224     <span class="keywordflow">switch</span> (MemoryInformationClass) {
00225         <span class="keywordflow">case</span> MemoryBasicInformation:
00226                 <span class="keywordflow">if</span> (MemoryInformationLength &lt; <span class="keyword">sizeof</span>(MEMORY_BASIC_INFORMATION)) {
00227                     <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00228                 }
00229                 <span class="keywordflow">break</span>;
00230 
00231         <span class="keywordflow">case</span> MemoryWorkingSetInformation:
00232                 <span class="keywordflow">if</span> (MemoryInformationLength &lt; <span class="keyword">sizeof</span>(ULONG)) {
00233                     <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00234                 }
00235                 <span class="keywordflow">break</span>;
00236 
00237         <span class="keywordflow">case</span> MemoryMappedFilenameInformation:
00238                 FilePointer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00239                 <span class="keywordflow">break</span>;
00240         <span class="keywordflow">default</span>:
00241             <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
00242     }
00243 
00244     PreviousMode = KeGetPreviousMode();
00245 
00246     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00247 
00248         <span class="comment">//</span>
00249         <span class="comment">// Check arguments.</span>
00250         <span class="comment">//</span>
00251 
00252         <span class="keywordflow">try</span> {
00253 
00254             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(MemoryInformation,
00255                           MemoryInformationLength,
00256                           <span class="keyword">sizeof</span>(ULONG_PTR));
00257 
00258             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength)) {
00259                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(ReturnLength);
00260             }
00261 
00262         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00263 
00264             <span class="comment">//</span>
00265             <span class="comment">// If an exception occurs during the probe or capture</span>
00266             <span class="comment">// of the initial values, then handle the exception and</span>
00267             <span class="comment">// return the exception code as the status value.</span>
00268             <span class="comment">//</span>
00269 
00270             <span class="keywordflow">return</span> GetExceptionCode();
00271         }
00272     }
00273     <span class="keywordflow">if</span> (BaseAddress &gt; MM_HIGHEST_USER_ADDRESS) {
00274         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00275     }
00276 
00277     <span class="keywordflow">if</span> ((BaseAddress &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a19">MM_HIGHEST_VAD_ADDRESS</a>)
00278 <span class="preprocessor">#if defined(MM_SHARED_USER_DATA_VA)</span>
00279 <span class="preprocessor"></span>            ||
00280          (<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(BaseAddress) == (PVOID)MM_SHARED_USER_DATA_VA)
00281 <span class="preprocessor">#endif</span>
00282 <span class="preprocessor"></span>             ) {
00283 
00284         <span class="comment">//</span>
00285         <span class="comment">// Indicate a reserved area from this point on.</span>
00286         <span class="comment">//</span>
00287 
00288         <span class="keywordflow">if</span> ( MemoryInformationClass == MemoryBasicInformation ) {
00289 
00290             <span class="keywordflow">try</span> {
00291                 ((PMEMORY_BASIC_INFORMATION)MemoryInformation)-&gt;AllocationBase =
00292                                       (PCHAR) <a class="code" href="../../d4/d8/mi_8h.html#a19">MM_HIGHEST_VAD_ADDRESS</a> + 1;
00293                 ((PMEMORY_BASIC_INFORMATION)MemoryInformation)-&gt;AllocationProtect =
00294                                                                       PAGE_READONLY;
00295                 ((PMEMORY_BASIC_INFORMATION)MemoryInformation)-&gt;BaseAddress =
00296                                                        <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(BaseAddress);
00297                 ((PMEMORY_BASIC_INFORMATION)MemoryInformation)-&gt;RegionSize =
00298                                     ((PCHAR)MM_HIGHEST_USER_ADDRESS + 1) -
00299                                                 (PCHAR)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(BaseAddress);
00300                 ((PMEMORY_BASIC_INFORMATION)MemoryInformation)-&gt;State = MEM_RESERVE;
00301                 ((PMEMORY_BASIC_INFORMATION)MemoryInformation)-&gt;Protect = PAGE_NOACCESS;
00302                 ((PMEMORY_BASIC_INFORMATION)MemoryInformation)-&gt;Type = MEM_PRIVATE;
00303 
00304                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength)) {
00305                     *ReturnLength = <span class="keyword">sizeof</span>(MEMORY_BASIC_INFORMATION);
00306                 }
00307 
00308 <span class="preprocessor">#if defined(MM_SHARED_USER_DATA_VA)</span>
00309 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(BaseAddress) == (PVOID)MM_SHARED_USER_DATA_VA) {
00310 
00311                     <span class="comment">//</span>
00312                     <span class="comment">// This is the page that is double mapped between</span>
00313                     <span class="comment">// user mode and kernel mode.</span>
00314                     <span class="comment">//</span>
00315 
00316                     ((PMEMORY_BASIC_INFORMATION)MemoryInformation)-&gt;AllocationBase =
00317                                 (PVOID)MM_SHARED_USER_DATA_VA;
00318                     ((PMEMORY_BASIC_INFORMATION)MemoryInformation)-&gt;Protect =
00319                                                                  PAGE_READONLY;
00320                     ((PMEMORY_BASIC_INFORMATION)MemoryInformation)-&gt;RegionSize =
00321                                                                  <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00322                     ((PMEMORY_BASIC_INFORMATION)MemoryInformation)-&gt;State =
00323                                                                  MEM_COMMIT;
00324                 }
00325 <span class="preprocessor">#endif</span>
00326 <span class="preprocessor"></span>
00327             } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00328 
00329                 <span class="comment">//</span>
00330                 <span class="comment">// Just return success.</span>
00331                 <span class="comment">//</span>
00332             }
00333 
00334             <span class="keywordflow">return</span> STATUS_SUCCESS;
00335         } <span class="keywordflow">else</span> {
00336             <span class="keywordflow">return</span> STATUS_INVALID_ADDRESS;
00337         }
00338     }
00339 
00340     <span class="keywordflow">if</span> ( ProcessHandle == NtCurrentProcess() ) {
00341         TargetProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00342     } <span class="keywordflow">else</span> {
00343         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> ( ProcessHandle,
00344                                              PROCESS_QUERY_INFORMATION,
00345                                              <a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>,
00346                                              PreviousMode,
00347                                              (PVOID *)&amp;TargetProcess,
00348                                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00349 
00350         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00351             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00352         }
00353     }
00354 
00355     <span class="keywordflow">if</span> (MemoryInformationClass == MemoryWorkingSetInformation) {
00356 
00357         <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
00358 
00359         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/queryvm_8c.html#a1">MiGetWorkingSetInfo</a> (MemoryInformation,
00360                                       MemoryInformationLength,
00361                                       TargetProcess);
00362         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
00363 
00364         <span class="keywordflow">if</span> ( ProcessHandle != NtCurrentProcess() ) {
00365             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (TargetProcess);
00366         }
00367         <span class="keywordflow">try</span> {
00368 
00369             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength)) {
00370                 *ReturnLength = ((((PMEMORY_WORKING_SET_INFORMATION)
00371                                     MemoryInformation)-&gt;NumberOfEntries - 1) *
00372                                         <span class="keyword">sizeof</span>(ULONG)) +
00373                                         <span class="keyword">sizeof</span>(MEMORY_WORKING_SET_INFORMATION);
00374             }
00375 
00376         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00377         }
00378 
00379         <span class="keywordflow">return</span> STATUS_SUCCESS;
00380     }
00381 
00382     <span class="comment">//</span>
00383     <span class="comment">// If the specified process is not the current process, attach</span>
00384     <span class="comment">// to the specified process.</span>
00385     <span class="comment">//</span>
00386 
00387     <span class="keywordflow">if</span> ( ProcessHandle != NtCurrentProcess() ) {
00388         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;TargetProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>);
00389         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00390     }
00391     <span class="keywordflow">else</span> {
00392         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00393     }
00394 
00395     <span class="comment">//</span>
00396     <span class="comment">// Get working set mutex and block APCs.</span>
00397     <span class="comment">//</span>
00398 
00399     <a class="code" href="../../d4/d8/mi_8h.html#a161">LOCK_WS_AND_ADDRESS_SPACE</a> (TargetProcess);
00400 
00401     <span class="comment">//</span>
00402     <span class="comment">// Make sure the address space was not deleted, if so, return an error.</span>
00403     <span class="comment">//</span>
00404 
00405     <span class="keywordflow">if</span> (TargetProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o27">AddressSpaceDeleted</a> != 0) {
00406         <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (TargetProcess);
00407         <span class="keywordflow">if</span> (Attached == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00408             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00409             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (TargetProcess);
00410         }
00411         <span class="keywordflow">return</span> STATUS_PROCESS_IS_TERMINATING;
00412     }
00413 
00414     <span class="comment">//</span>
00415     <span class="comment">// Locate the VAD that contains the base address or the VAD</span>
00416     <span class="comment">// which follows the base address.</span>
00417     <span class="comment">//</span>
00418 
00419     Vad = TargetProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o38">VadRoot</a>;
00420     BaseVpn = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (BaseAddress);
00421 
00422     <span class="keywordflow">for</span> (;;) {
00423 
00424         <span class="keywordflow">if</span> (Vad == (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00425             <span class="keywordflow">break</span>;
00426         }
00427 
00428         <span class="keywordflow">if</span> ((BaseVpn &gt;= Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>) &amp;&amp;
00429             (BaseVpn &lt;= Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>)) {
00430             Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00431             <span class="keywordflow">break</span>;
00432         }
00433 
00434         <span class="keywordflow">if</span> (BaseVpn &lt; Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>) {
00435             <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o3">LeftChild</a> == (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00436                 <span class="keywordflow">break</span>;
00437             }
00438             Vad = Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o3">LeftChild</a>;
00439 
00440         } <span class="keywordflow">else</span> {
00441             <span class="keywordflow">if</span> (BaseVpn &lt; Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>) {
00442                 <span class="keywordflow">break</span>;
00443             }
00444             <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o4">RightChild</a> == (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00445                 <span class="keywordflow">break</span>;
00446             }
00447             Vad = Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o4">RightChild</a>;
00448         }
00449     }
00450 
00451     <span class="keywordflow">if</span> (!Found) {
00452 
00453         <span class="comment">//</span>
00454         <span class="comment">// There is no virtual address allocated at the base</span>
00455         <span class="comment">// address.  Return the size of the hole starting at</span>
00456         <span class="comment">// the base address.</span>
00457         <span class="comment">//</span>
00458 
00459         <span class="keywordflow">if</span> (Vad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00460             TheRegionSize = ((PCHAR)<a class="code" href="../../d4/d8/mi_8h.html#a19">MM_HIGHEST_VAD_ADDRESS</a> + 1) -
00461                                                 (PCHAR)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(BaseAddress);
00462         } <span class="keywordflow">else</span> {
00463             <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a> &lt; BaseVpn) {
00464 
00465                 <span class="comment">//</span>
00466                 <span class="comment">// We are looking at the Vad which occupies the range</span>
00467                 <span class="comment">// just before the desired range.  Get the next Vad.</span>
00468                 <span class="comment">//</span>
00469 
00470                 Vad = <a class="code" href="../../d4/d8/mi_8h.html#a96">MiGetNextVad</a> (Vad);
00471                 <span class="keywordflow">if</span> (Vad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00472                     TheRegionSize = ((PCHAR)<a class="code" href="../../d4/d8/mi_8h.html#a19">MM_HIGHEST_VAD_ADDRESS</a> + 1) -
00473                                                 (PCHAR)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(BaseAddress);
00474                 } <span class="keywordflow">else</span> {
00475                     TheRegionSize = (PCHAR)<a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>) -
00476                                                 (PCHAR)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(BaseAddress);
00477                 }
00478             } <span class="keywordflow">else</span> {
00479                 TheRegionSize = (PCHAR)<a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>) -
00480                                                 (PCHAR)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(BaseAddress);
00481             }
00482         }
00483 
00484         <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (TargetProcess);
00485 
00486         <span class="keywordflow">if</span> (Attached == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00487             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00488             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (TargetProcess);
00489         }
00490 
00491         <span class="comment">//</span>
00492         <span class="comment">// Establish an exception handler and write the information and</span>
00493         <span class="comment">// returned length.</span>
00494         <span class="comment">//</span>
00495 
00496         <span class="keywordflow">if</span> ( MemoryInformationClass == MemoryBasicInformation ) {
00497             <span class="keywordflow">try</span> {
00498 
00499                 ((PMEMORY_BASIC_INFORMATION)MemoryInformation)-&gt;AllocationBase =
00500                                                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00501                 ((PMEMORY_BASIC_INFORMATION)MemoryInformation)-&gt;AllocationProtect =
00502                                                                             0;
00503                 ((PMEMORY_BASIC_INFORMATION)MemoryInformation)-&gt;BaseAddress =
00504                                                             <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(BaseAddress);
00505                 ((PMEMORY_BASIC_INFORMATION)MemoryInformation)-&gt;RegionSize =
00506                                                                     TheRegionSize;
00507                 ((PMEMORY_BASIC_INFORMATION)MemoryInformation)-&gt;State = MEM_FREE;
00508                 ((PMEMORY_BASIC_INFORMATION)MemoryInformation)-&gt;Protect = PAGE_NOACCESS;
00509                 ((PMEMORY_BASIC_INFORMATION)MemoryInformation)-&gt;Type = 0;
00510 
00511                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength)) {
00512                     *ReturnLength = <span class="keyword">sizeof</span>(MEMORY_BASIC_INFORMATION);
00513                 }
00514 
00515             } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00516 
00517                 <span class="comment">//</span>
00518                 <span class="comment">// Just return success.</span>
00519                 <span class="comment">//</span>
00520             }
00521 
00522             <span class="keywordflow">return</span> STATUS_SUCCESS;
00523         }
00524         <span class="keywordflow">return</span> STATUS_INVALID_ADDRESS;
00525     }
00526 
00527     <span class="comment">//</span>
00528     <span class="comment">// Found a VAD.</span>
00529     <span class="comment">//</span>
00530 
00531     Va = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(BaseAddress);
00532     Info.BaseAddress = Va;
00533 
00534     <span class="comment">//</span>
00535     <span class="comment">// There is a page mapped at the base address.</span>
00536     <span class="comment">//</span>
00537 
00538     <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PrivateMemory) {
00539         Info.Type = MEM_PRIVATE;
00540     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.ImageMap == 0) {
00541         Info.Type = MEM_MAPPED;
00542 
00543         <span class="keywordflow">if</span> ( MemoryInformationClass == MemoryMappedFilenameInformation ) {
00544             <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a>) {
00545                 FilePointer = Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>;
00546             }
00547             <span class="keywordflow">if</span> ( !FilePointer ) {
00548                 FilePointer = (PVOID)1;
00549             } <span class="keywordflow">else</span> {
00550                 <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(FilePointer);
00551             }
00552         }
00553 
00554     } <span class="keywordflow">else</span> {
00555         Info.Type = MEM_IMAGE;
00556     }
00557 
00558     Info.State = <a class="code" href="../../d5/d3/queryvm_8c.html#a3">MiQueryAddressState</a> (Va, Vad, TargetProcess, &amp;Info.Protect);
00559 
00560     Va = (PVOID)((PCHAR)Va + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00561 
00562     <span class="keywordflow">while</span> (<a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (Va) &lt;= Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>) {
00563 
00564         NewState = <a class="code" href="../../d5/d3/queryvm_8c.html#a3">MiQueryAddressState</a> (Va,
00565                                         Vad,
00566                                         TargetProcess,
00567                                         &amp;NewProtect);
00568 
00569         <span class="keywordflow">if</span> ((NewState != Info.State) || (NewProtect != Info.Protect)) {
00570 
00571             <span class="comment">//</span>
00572             <span class="comment">// The state for this address does not match, calculate</span>
00573             <span class="comment">// size and return.</span>
00574             <span class="comment">//</span>
00575 
00576             <span class="keywordflow">break</span>;
00577         }
00578         Va = (PVOID)((PCHAR)Va + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00579     } <span class="comment">// end while</span>
00580 
00581     Info.RegionSize = ((PCHAR)Va - (PCHAR)Info.BaseAddress);
00582     Info.AllocationBase = <a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>);
00583     Info.AllocationProtect = <a class="code" href="../../d4/d8/mi_8h.html#a86">MI_CONVERT_FROM_PTE_PROTECTION</a> (
00584                                              Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection);
00585 
00586     <span class="comment">//</span>
00587     <span class="comment">// A range has been found, release the mutexes, deattach from the</span>
00588     <span class="comment">// target process and return the information.</span>
00589     <span class="comment">//</span>
00590 
00591 <span class="preprocessor">#if !(defined(_MIALT4K_))</span>
00592 <span class="preprocessor"></span>
00593     <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (TargetProcess);
00594 
00595 <span class="preprocessor">#else</span>
00596 <span class="preprocessor"></span>
00597     <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (TargetProcess);
00598 
00599     <span class="keywordflow">if</span> (TargetProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o78">Wow64Process</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00600         
00601         Info.BaseAddress = <a class="code" href="../../d2/d9/miia64_8h.html#a230">PAGE_4K_ALIGN</a>(BaseAddress);
00602 
00603         <a class="code" href="../../d2/d9/miia64_8h.html#a309">MiQueryRegionFor4kPage</a>(Info.BaseAddress,
00604                                <a class="code" href="../../d4/d8/mi_8h.html#a109">MI_VPN_TO_VA_ENDING</a>(Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>),
00605                                &amp;Info.RegionSize,
00606                                &amp;Info.State,
00607                                &amp;Info.Protect,
00608                                TargetProcess);
00609     }
00610 
00611     <a class="code" href="../../d4/d8/mi_8h.html#a163">UNLOCK_ADDRESS_SPACE</a> (TargetProcess);
00612 
00613 <span class="preprocessor">#endif</span>
00614 <span class="preprocessor"></span>
00615     <span class="keywordflow">if</span> (Attached == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00616         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00617         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (TargetProcess);
00618     }
00619 
00620 <span class="preprocessor">#if DBG</span>
00621 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a81">MM_DBG_SHOW_NT_CALLS</a>) {
00622         <span class="keywordflow">if</span> ( !MmWatchProcess ) {
00623             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"queryvm base %lx allocbase %lx protect %lx size %lx\n"</span>,
00624                 Info.BaseAddress, Info.AllocationBase, Info.AllocationProtect,
00625                 Info.RegionSize);
00626             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    state %lx  protect %lx  type %lx\n"</span>,
00627                 Info.State, Info.Protect, Info.Type);
00628         }
00629     }
00630 <span class="preprocessor">#endif //DBG</span>
00631 <span class="preprocessor"></span>
00632     <span class="keywordflow">if</span> ( MemoryInformationClass == MemoryBasicInformation ) {
00633         <span class="keywordflow">try</span> {
00634 
00635             *(PMEMORY_BASIC_INFORMATION)MemoryInformation = Info;
00636 
00637             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength)) {
00638                 *ReturnLength = <span class="keyword">sizeof</span>(MEMORY_BASIC_INFORMATION);
00639             }
00640 
00641         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00642         }
00643         <span class="keywordflow">return</span> STATUS_SUCCESS;
00644     }
00645 
00646     <span class="comment">//</span>
00647     <span class="comment">// Try to return the name of the file that is mapped.</span>
00648     <span class="comment">//</span>
00649 
00650     <span class="keywordflow">if</span> ( !FilePointer ) {
00651         <span class="keywordflow">return</span> STATUS_INVALID_ADDRESS;
00652     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( FilePointer == (PVOID)1 ) {
00653         <span class="keywordflow">return</span> STATUS_FILE_INVALID;
00654     }
00655 
00656     <span class="comment">//</span>
00657     <span class="comment">// We have a referenced pointer to the file. Call ObQueryNameString</span>
00658     <span class="comment">// and get the file name</span>
00659     <span class="comment">//</span>
00660 
00661     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/obquery_8c.html#a7">ObQueryNameString</a>(
00662                 FilePointer,
00663                 MemoryInformation,
00664                 MemoryInformationLength,
00665                 ReturnLength
00666                 );
00667     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(FilePointer);
00668     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00669 }
00670 
00671 
00672 ULONG
<a name="l00673"></a><a class="code" href="../../d5/d3/queryvm_8c.html#a3">00673</a> <a class="code" href="../../d5/d3/queryvm_8c.html#a3">MiQueryAddressState</a> (
00674     IN PVOID Va,
00675     IN <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad,
00676     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess,
00677     OUT PULONG ReturnedProtect
00678     )
00679 
00680 <span class="comment">/*++</span>
00681 <span class="comment"></span>
00682 <span class="comment">Routine Description:</span>
00683 <span class="comment"></span>
00684 <span class="comment"></span>
00685 <span class="comment">Arguments:</span>
00686 <span class="comment"></span>
00687 <span class="comment">Return Value:</span>
00688 <span class="comment"></span>
00689 <span class="comment">    Returns the state (MEM_COMMIT, MEM_RESERVE, MEM_PRIVATE).</span>
00690 <span class="comment"></span>
00691 <span class="comment">Environment:</span>
00692 <span class="comment"></span>
00693 <span class="comment">    Kernel mode.  Working set lock and address creation lock held.</span>
00694 <span class="comment"></span>
00695 <span class="comment">--*/</span>
00696 
00697 {
00698     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00699     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00700     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00701     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> CapturedProtoPte;
00702     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ProtoPte;
00703     ULONG PteIsZero;
00704     ULONG State;
00705     ULONG Protect;
00706     ULONG Waited;
00707     LOGICAL PteDetected;
00708 
00709 <span class="preprocessor">#ifdef LARGE_PAGES</span>
00710 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.LargePages) {
00711         *ReturnedProtect = <a class="code" href="../../d4/d8/mi_8h.html#a86">MI_CONVERT_FROM_PTE_PROTECTION</a> (
00712                                              Vad-&gt;u.VadFlags.Protection);
00713         <span class="keywordflow">return</span> MEM_COMMIT;
00714     }
00715 <span class="preprocessor">#endif //LARGE_PAGES</span>
00716 <span class="preprocessor"></span>
00717     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (Va);
00718     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (Va);
00719     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Va);
00720 
00721     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Vad-&gt;StartingVpn &lt;= <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (Va)) &amp;&amp;
00722             (Vad-&gt;EndingVpn &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (Va)));
00723 
00724     PteIsZero = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00725     PteDetected = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00726 
00727     <span class="keywordflow">do</span> {
00728 
00729         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a>(PointerPpe,
00730                                        TargetProcess,
00731                                        <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00732                                        &amp;Waited)) {
00733             <span class="keywordflow">break</span>;
00734         }
00735     
00736         Waited = 0;
00737 
00738         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a>(PointerPde,
00739                                        TargetProcess,
00740                                        <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00741                                        &amp;Waited)) {
00742             <span class="keywordflow">break</span>;
00743         }
00744 
00745         <span class="keywordflow">if</span> (Waited == 0) {
00746             PteDetected = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00747         }
00748 
00749     } <span class="keywordflow">while</span> (Waited != 0);
00750 
00751     <span class="keywordflow">if</span> (PteDetected == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00752 
00753         <span class="comment">//</span>
00754         <span class="comment">// A PTE exists at this address, see if it is zero.</span>
00755         <span class="comment">//</span>
00756 
00757         <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0) {
00758 
00759             PteIsZero = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00760 
00761             <span class="comment">//</span>
00762             <span class="comment">// There is a non-zero PTE at this address, use</span>
00763             <span class="comment">// it to build the information block.</span>
00764             <span class="comment">//</span>
00765 
00766             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/mmsup_8c.html#a3">MiIsPteDecommittedPage</a> (PointerPte)) {
00767                 Protect = 0;
00768                 State = MEM_RESERVE;
00769             } <span class="keywordflow">else</span> {
00770 
00771                 State = MEM_COMMIT;
00772                 <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.PhysicalMapping == 1) {
00773 
00774                     <span class="comment">//</span>
00775                     <span class="comment">// Physical mapping, there is no corresponding</span>
00776                     <span class="comment">// PFN element to get the page protection from.</span>
00777                     <span class="comment">//</span>
00778 
00779                     Protect = <a class="code" href="../../d4/d8/mi_8h.html#a86">MI_CONVERT_FROM_PTE_PROTECTION</a> (
00780                                              Vad-&gt;u.VadFlags.Protection);
00781                 } <span class="keywordflow">else</span> {
00782                     Protect = <a class="code" href="../../d0/d9/protect_8c.html#a7">MiGetPageProtection</a> (PointerPte,
00783                                                    TargetProcess);
00784 
00785                     <span class="keywordflow">if</span> ((PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Valid == 0) &amp;&amp;
00786                         (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1) &amp;&amp;
00787                         (Vad-&gt;u.VadFlags.PrivateMemory == 0) &amp;&amp;
00788                         (Vad-&gt;ControlArea != (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00789 
00790                         <span class="comment">//</span>
00791                         <span class="comment">// Make sure the protoPTE is committed.</span>
00792                         <span class="comment">//</span>
00793 
00794                         ProtoPte = <a class="code" href="../../d4/d8/mi_8h.html#a246">MiGetProtoPteAddress</a>(Vad,
00795                                                     <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (Va));
00796                         CapturedProtoPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = 0;
00797                         <span class="keywordflow">if</span> (ProtoPte) {
00798                             CapturedProtoPte = <a class="code" href="../../d5/d3/queryvm_8c.html#a2">MiCaptureSystemPte</a> (ProtoPte,
00799                                                                TargetProcess);
00800                         }
00801                         <span class="keywordflow">if</span> (CapturedProtoPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
00802                             State = MEM_RESERVE;
00803                             Protect = 0;
00804                         }
00805                     }
00806                 }
00807             }
00808         }
00809     }
00810 
00811     <span class="keywordflow">if</span> (PteIsZero) {
00812 
00813         <span class="comment">//</span>
00814         <span class="comment">// There is no PDE at this address, the template from</span>
00815         <span class="comment">// the VAD supplies the information unless the VAD is</span>
00816         <span class="comment">// for an image file.  For image files the individual</span>
00817         <span class="comment">// protection is on the prototype PTE.</span>
00818         <span class="comment">//</span>
00819 
00820         <span class="comment">//</span>
00821         <span class="comment">// Get the default protection information.</span>
00822         <span class="comment">//</span>
00823 
00824         State = MEM_RESERVE;
00825         Protect = 0;
00826 
00827         <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.PhysicalMapping == 1) {
00828 
00829             <span class="comment">//</span>
00830             <span class="comment">// Must be banked memory, just return reserved.</span>
00831             <span class="comment">//</span>
00832 
00833             NOTHING;
00834 
00835         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Vad-&gt;u.VadFlags.PrivateMemory == 0) &amp;&amp;
00836             (Vad-&gt;ControlArea != (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00837 
00838             <span class="comment">//</span>
00839             <span class="comment">// This VAD refers to a section.  Even though the PTE is</span>
00840             <span class="comment">// zero, the actual page may be committed in the section.</span>
00841             <span class="comment">//</span>
00842 
00843             ProtoPte = <a class="code" href="../../d4/d8/mi_8h.html#a246">MiGetProtoPteAddress</a>(Vad, <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (Va));
00844 
00845             CapturedProtoPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = 0;
00846             <span class="keywordflow">if</span> (ProtoPte) {
00847                 CapturedProtoPte = <a class="code" href="../../d5/d3/queryvm_8c.html#a2">MiCaptureSystemPte</a> (ProtoPte,
00848                                                        TargetProcess);
00849             }
00850 
00851             <span class="keywordflow">if</span> (CapturedProtoPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0) {
00852                 State = MEM_COMMIT;
00853 
00854                 <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.ImageMap == 0) {
00855                     Protect = <a class="code" href="../../d4/d8/mi_8h.html#a86">MI_CONVERT_FROM_PTE_PROTECTION</a> (
00856                                               Vad-&gt;u.VadFlags.Protection);
00857                 } <span class="keywordflow">else</span> {
00858 
00859                     <span class="comment">//</span>
00860                     <span class="comment">// This is an image file, the protection is in the</span>
00861                     <span class="comment">// prototype PTE.</span>
00862                     <span class="comment">//</span>
00863 
00864                     Protect = <a class="code" href="../../d0/d9/protect_8c.html#a7">MiGetPageProtection</a> (&amp;CapturedProtoPte,
00865                                                         TargetProcess);
00866                 }
00867             }
00868 
00869         } <span class="keywordflow">else</span> {
00870 
00871             <span class="comment">//</span>
00872             <span class="comment">// Get the protection from the corresponding VAD.</span>
00873             <span class="comment">//</span>
00874 
00875             <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.MemCommit) {
00876                 State = MEM_COMMIT;
00877                 Protect = <a class="code" href="../../d4/d8/mi_8h.html#a86">MI_CONVERT_FROM_PTE_PROTECTION</a> (
00878                                             Vad-&gt;u.VadFlags.Protection);
00879             }
00880         }
00881     }
00882 
00883     *ReturnedProtect = Protect;
00884     <span class="keywordflow">return</span> State;
00885 }
00886 
00887 
00888 
00889 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00890"></a><a class="code" href="../../d5/d3/queryvm_8c.html#a1">00890</a> <a class="code" href="../../d5/d3/queryvm_8c.html#a1">MiGetWorkingSetInfo</a> (
00891     IN PMEMORY_WORKING_SET_INFORMATION WorkingSetInfo,
00892     IN ULONG Length,
00893     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
00894     )
00895 
00896 {
00897     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl;
00898     PMEMORY_WORKING_SET_INFORMATION Info;
00899     PMEMORY_WORKING_SET_BLOCK Entry;
00900     PMEMORY_WORKING_SET_BLOCK LastEntry;
00901     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
00902     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> LastWsle;
00903     ULONG WsSize;
00904     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00905     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00906     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00907     LOGICAL Attached;
00908 
00909     <span class="comment">//</span>
00910     <span class="comment">// Allocate an MDL to map the request.</span>
00911     <span class="comment">//</span>
00912 
00913     Mdl = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00914                                  <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>) + <span class="keyword">sizeof</span>(PFN_NUMBER) +
00915                                      <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (Length) * <span class="keyword">sizeof</span>(PFN_NUMBER),
00916                                  '  mM');
00917 
00918     <span class="keywordflow">if</span> (Mdl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00919         <span class="keywordflow">return</span>(STATUS_INSUFFICIENT_RESOURCES);
00920     }
00921 
00922     <span class="comment">//</span>
00923     <span class="comment">// Initialize the MDL for the request.</span>
00924     <span class="comment">//</span>
00925 
00926     <a class="code" href="../../d2/d1/mm_8h.html#a24">MmInitializeMdl</a>(Mdl, WorkingSetInfo, Length);
00927 
00928     <span class="keywordflow">try</span> {
00929         <a class="code" href="../../d5/d6/iosup_8c.html#a41">MmProbeAndLockPages</a> (Mdl, KeGetPreviousMode(), <a class="code" href="../../d2/d1/mm_8h.html#a344a169">IoWriteAccess</a>);
00930     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00931         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Mdl);
00932         <span class="keywordflow">return</span> GetExceptionCode();
00933     }
00934 
00935     Info = <a class="code" href="../../d2/d1/mm_8h.html#a25">MmGetSystemAddressForMdlSafe</a> (Mdl, <a class="code" href="../../d2/d1/mm_8h.html#a347a182">NormalPagePriority</a>);
00936 
00937     <span class="keywordflow">if</span> (Info == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00938         <a class="code" href="../../d5/d6/iosup_8c.html#a45">MmUnlockPages</a> (Mdl);
00939         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Mdl);
00940         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00941     }
00942 
00943     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != Process) {
00944         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;Process-&gt;Pcb);
00945         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00946     }
00947     <span class="keywordflow">else</span> {
00948         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00949     }
00950 
00951     <a class="code" href="../../d4/d8/mi_8h.html#a154">LOCK_WS</a> (Process);
00952 
00953     status = STATUS_SUCCESS;
00954 
00955     <span class="keywordflow">if</span> (Process-&gt;AddressSpaceDeleted != 0) {
00956         status = STATUS_PROCESS_IS_TERMINATING;
00957     }
00958 
00959     WsSize = Process-&gt;Vm.WorkingSetSize;
00960     Info-&gt;NumberOfEntries = WsSize;
00961 
00962     <span class="keywordflow">if</span> ((WsSize * <span class="keyword">sizeof</span>(ULONG)) &gt;= Length) {
00963         status = STATUS_INFO_LENGTH_MISMATCH;
00964     }
00965 
00966     <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
00967         <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (Process);
00968         <span class="keywordflow">if</span> (Attached == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00969             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
00970         }
00971         <a class="code" href="../../d5/d6/iosup_8c.html#a45">MmUnlockPages</a> (Mdl);
00972         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Mdl);
00973         <span class="keywordflow">return</span> status;
00974     }
00975 
00976     Wsle = <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>;
00977     LastWsle = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[<a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a>];
00978     Entry = &amp;Info-&gt;WorkingSetInfo[0];
00979     LastEntry = (PMEMORY_WORKING_SET_BLOCK)(
00980                             (PCHAR)Info + (Length &amp; (~(<span class="keyword">sizeof</span>(ULONG) - 1))));
00981 
00982     <span class="keywordflow">do</span> {
00983         <span class="keywordflow">if</span> (Wsle-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid == 1) {
00984             Entry-&gt;VirtualPage = Wsle-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.VirtualPageNumber;
00985             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Wsle-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress);
00986             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
00987             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
00988 
00989             Entry-&gt;Shared = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte;
00990             <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte == 0) {
00991                 Entry-&gt;ShareCount = 0;
00992                 Entry-&gt;Protection = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a184">MI_GET_PROTECTION_FROM_SOFT_PTE</a>(&amp;Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
00993             } <span class="keywordflow">else</span> {
00994                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount &lt;= 7) {
00995                     Entry-&gt;ShareCount = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount;
00996                 }
00997                 <span class="keywordflow">else</span> {
00998                     Entry-&gt;ShareCount = 7;
00999                 }
01000                 <span class="keywordflow">if</span> (Wsle-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.SameProtectAsProto == 1) {
01001                     Entry-&gt;Protection = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a184">MI_GET_PROTECTION_FROM_SOFT_PTE</a>(&amp;Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
01002                 } <span class="keywordflow">else</span> {
01003                     Entry-&gt;Protection = Wsle-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Protection;
01004                 }
01005             }
01006             Entry += 1;
01007         }
01008         Wsle += 1;
01009     }<span class="keywordflow">while</span> ((Entry &lt; LastEntry) &amp;&amp; (Wsle &lt;= LastWsle));
01010 
01011     <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (Process);
01012     <span class="keywordflow">if</span> (Attached == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01013         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
01014     }
01015     <a class="code" href="../../d5/d6/iosup_8c.html#a45">MmUnlockPages</a> (Mdl);
01016     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Mdl);
01017     <span class="keywordflow">return</span> STATUS_SUCCESS;
01018 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:34 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
