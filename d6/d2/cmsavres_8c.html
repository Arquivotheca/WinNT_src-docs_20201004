<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cmsavres.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cmsavres.c File Reference</h1><code>#include "<a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>"</code><br>

<p>
<a href="../../d7/d1/cmsavres_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d2/cmsavres_8c.html#a0">CM_SAVEKEYBUFSIZE</a>&nbsp;&nbsp;&nbsp;0x10000</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d2/cmsavres_8c.html#a7">CmpCreateTemporaryHive</a> (IN HANDLE FileHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a> (<a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d2/cmsavres_8c.html#a9">CmpLoadHiveVolatile</a> (IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock, IN HANDLE FileHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d2/cmsavres_8c.html#a10">CmpRefreshHive</a> (IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d2/cmsavres_8c.html#a11">CmpSaveKeyByFileCopy</a> (<a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, HANDLE FileHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d2/cmsavres_8c.html#a12">CmpRefreshWorkerRoutine</a> (<a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> Current, PVOID <a class="el" href="../../d3/d1/threads_8h.html#a107">Context1</a>, PVOID <a class="el" href="../../d3/d1/threads_8h.html#a108">Context2</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d2/cmsavres_8c.html#a13">CmpMergeKeyValues</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> SourceHive, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> SourceKeyCell, <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> SourceKeyNode, <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> TargetHive, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> TargetKeyCell, <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> TargetKeyNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d2/cmsavres_8c.html#a14">CmRestoreKey</a> (IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock, IN HANDLE FileHandle, IN ULONG Flags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d2/cmsavres_8c.html#a15">CmSaveKey</a> (IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock, IN HANDLE FileHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d2/cmsavres_8c.html#a16">CmSaveMergedKeys</a> (IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> HighPrecedenceKcb, IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> LowPrecedenceKcb, IN HANDLE FileHandle)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d2/cmsavres_8c.html#a1">CmpMasterHive</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d2/cmsavres_8c.html#a2">CmpProfileLoaded</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PUCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d2/cmsavres_8c.html#a3">CmpStashBuffer</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d2/cmsavres_8c.html#a4">CmpGlobalQuotaAllowed</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d2/cmsavres_8c.html#a5">CmpGlobalQuotaWarning</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d2/cmsavres_8c.html#a6">CmpGlobalQuotaUsed</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="cmsavres.c::CM_SAVEKEYBUFSIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_SAVEKEYBUFSIZE&nbsp;&nbsp;&nbsp;0x10000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00027">27</a> of file <a class="el" href="../../d7/d1/cmsavres_8c-source.html">cmsavres.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01261">CmpSaveKeyByFileCopy()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a7" doxytag="cmsavres.c::CmpCreateTemporaryHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmpCreateTemporaryHive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>FileHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01439">1439</a> of file <a class="el" href="../../d7/d1/cmsavres_8c-source.html">cmsavres.c</a>.
<p>
References <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00197">HINIT_CREATE</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00203">HIVE_VOLATILE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00862">CmSaveKey()</a>, and <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01047">CmSaveMergedKeys()</a>.
<p>
<pre class="fragment"><div>01444                    :
01445 
01446     Allocates and inits a temporary hive.
01447 
01448 Arguments:
01449 
01450     FileHandle - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to back <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive.
01451 
01452 Return Value:
01453 
01454     Pointer to CmHive.
01455 
01456     If <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation failed.
01457 
01458 --*/
01459 {
01460     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> TempHive;
01461     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01462 
01463     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01464 
01465     <span class="comment">//</span>
01466     <span class="comment">// NOTE: Hive will get put on CmpHiveListHead list.</span>
01467     <span class="comment">//       Make sure CmpDestroyTemporaryHive gets called to remove it.</span>
01468     <span class="comment">//</span>
01469 
01470     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a275">CmpInitializeHive</a>(&amp;TempHive,
01471                           HINIT_CREATE,
01472                           HIVE_VOLATILE,
01473                           0,
01474                           NULL,
01475                           NULL,
01476                           NULL,
01477                           NULL,
01478                           NULL,
01479                           NULL);
01480     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01481         <span class="keywordflow">return</span>(TempHive);
01482     } <span class="keywordflow">else</span> {
01483         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01484     }
01485 
01486 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="cmsavres.c::CmpDestroyTemporaryHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpDestroyTemporaryHive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>CmHive</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01490">1490</a> of file <a class="el" href="../../d7/d1/cmsavres_8c-source.html">cmsavres.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00186">CmpFree()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00261">CMS_SAVRES</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00649">_CMHIVE::Hive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00652">_CMHIVE::HiveList</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00653">_CMHIVE::HiveLock</a>, <a class="el" href="../../d3/d0/hivefree_8c-source.html#l00034">HvFreeHive()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00484">CmpLoadHiveVolatile()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00097">CmRestoreKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00862">CmSaveKey()</a>, and <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01047">CmSaveMergedKeys()</a>.
<p>
<pre class="fragment"><div>01495                    :
01496 
01497     Frees all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pieces of a hive.
01498 
01499 Arguments:
01500 
01501     CmHive - CM level hive structure to free
01502 
01503 Return Value:
01504 
01505     None.
01506 
01507 --*/
01508 {
01509     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01510     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_SAVRES) {
01511         KdPrint((<span class="stringliteral">"CmpDestroyTemporaryHive:\n"</span>));
01512         KdPrint((<span class="stringliteral">"\tCmHive=%08lx\n"</span>, CmHive));
01513     }
01514 
01515     <span class="keywordflow">if</span> (CmHive == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01516         <span class="keywordflow">return</span>;
01517     }
01518 
01519     <span class="comment">//</span>
01520     <span class="comment">// NOTE: Hive is on CmpHiveListHead list.</span>
01521     <span class="comment">//       Remove it.</span>
01522     <span class="comment">//</span>
01523     RemoveEntryList(&amp;CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o3">HiveList</a>);
01524 
01525     <a class="code" href="../../d2/d1/hivefree_8c.html#a0">HvFreeHive</a>(&amp;(CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>));
01526     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a> );
01527     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a>);
01528     <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(CmHive, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>));
01529 
01530     <span class="keywordflow">return</span>;
01531 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="cmsavres.c::CmpLoadHiveVolatile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpLoadHiveVolatile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyControlBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00484">484</a> of file <a class="el" href="../../d7/d1/cmsavres_8c-source.html">cmsavres.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00745">_REGISTRY_COMMAND::CmHive</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00699">CmpConstructName()</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00151">CmpCopyCompressedName()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00686">CmpCopyKeyPartial()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01314">CmpCopyTree</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01490">CmpDestroyTemporaryHive()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00673">CmpHKeyNameLen</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00496">CmpLinkHiveToMaster()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00036">CmpMasterHive</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00029">CmpProfileLoaded</a>, <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00354">CmpSetGlobalQuotaAllowed()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00738">_REGISTRY_COMMAND::Command</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00291">ExFreePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00568">HFILE_TYPE_PRIMARY</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00197">HINIT_CREATE</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00199">HINIT_FILE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00649">_CMHIVE::Hive</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00203">HIVE_VOLATILE</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00440">KEY_COMP_NAME</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00537">_CELL_DATA::_u::KeyNode</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00477">_CM_KEY_NODE::Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00475">_CM_KEY_NODE::NameLength</a>, <a class="el" href="../../d0/d2/rtreplac_8c-source.html#l00045">NewName</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00281">PROTECTED_POOL</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00726">REG_CMD_ADD_HIVE_LIST</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00343">_HBASE_BLOCK::RootCell</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01883">RtlAppendUnicodeStringToString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01821">RtlAppendUnicodeToString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01763">RtlCopyUnicodeString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00097">CmRestoreKey()</a>.
<p>
<pre class="fragment"><div>00491                    :
00492 
00493     Creates a <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a5">VOLATILE</a> hive and loads <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> underneath <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> and <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>.
00494     The data <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">volatile</span> hive <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> copied <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  The
00495     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> *NOT* in use by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry when <span class="keyword">this</span> returns.
00496 
00497 Arguments:
00498 
00499     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> hive <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be created under.
00500            Currently <span class="keyword">this</span> must be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Master <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>.
00501 
00502     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> hive's parent.  (Usually
00503            will by \Registry\User)
00504 
00505     FileHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> that will be copied
00506            into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">volatile</span> hive.
00507 
00508 Return Value:
00509 
00510     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00511 
00512 --*/
00513 
00514 {
00515     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00516     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00517     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> RootData;
00518     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> NewHive;
00519     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> TempHive;
00520     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
00521     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Root;
00522     <a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html">REGISTRY_COMMAND</a> Command;
00523     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00524     UNICODE_STRING RootName;
00525     UNICODE_STRING <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>;
00526     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> NewNameLength;
00527     PUNICODE_STRING ConstructedName;
00528 
00529     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00530     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
00531 
00532     <span class="keywordflow">if</span> (KeyControlBlock-&gt;Delete) {
00533         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00534         <span class="keywordflow">return</span>(STATUS_KEY_DELETED);
00535     }
00536     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyControlBlock-&gt;KeyHive;
00537     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = KeyControlBlock-&gt;KeyCell;
00538 
00539     <span class="comment">//</span>
00540     <span class="comment">// New hives can be created only under the master hive.</span>
00541     <span class="comment">//</span>
00542 
00543     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> != &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>) {
00544         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00545         <span class="keywordflow">return</span>(STATUS_INVALID_PARAMETER);
00546     }
00547 
00548     <span class="comment">//</span>
00549     <span class="comment">// Create a temporary hive and load the file into it</span>
00550     <span class="comment">//</span>
00551     status = <a class="code" href="../../d1/d2/cmp_8h.html#a275">CmpInitializeHive</a>(&amp;TempHive,
00552                            HINIT_FILE,
00553                            0,
00554                            HFILE_TYPE_PRIMARY,
00555                            NULL,
00556                            FileHandle,
00557                            NULL,
00558                            NULL,
00559                            NULL,
00560                            NULL); 
00561     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00562         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00563         <span class="keywordflow">return</span>(status);
00564     }                           
00565 
00566     <span class="comment">//</span>
00567     <span class="comment">// Create the volatile hive.</span>
00568     <span class="comment">//</span>
00569     status = <a class="code" href="../../d1/d2/cmp_8h.html#a275">CmpInitializeHive</a>(&amp;NewHive,
00570                            HINIT_CREATE,
00571                            HIVE_VOLATILE,
00572                            0,
00573                            NULL,
00574                            NULL,
00575                            NULL,
00576                            NULL,
00577                            NULL,
00578                            NULL);
00579     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00580         <a class="code" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a>(TempHive);
00581         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00582         <span class="keywordflow">return</span>(status);
00583     }                           
00584 
00585     <span class="comment">//</span>
00586     <span class="comment">// Create the target root</span>
00587     <span class="comment">//</span>
00588     Root = <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a11">CmpCopyKeyPartial</a>(&amp;TempHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>,
00589                              TempHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a>,
00590                              &amp;NewHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>,
00591                              HCELL_NIL,
00592                              FALSE);
00593     <span class="keywordflow">if</span> (Root == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00594         <a class="code" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a>(TempHive);
00595         <a class="code" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a>(NewHive);
00596         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00597         <span class="keywordflow">return</span>(STATUS_INSUFFICIENT_RESOURCES);
00598     }
00599     NewHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a> = Root;
00600 
00601     <span class="comment">//</span>
00602     <span class="comment">// Copy the temporary hive into the volatile hive</span>
00603     <span class="comment">//</span>
00604     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d2/cmp_8h.html#a118">CmpCopyTree</a>(&amp;TempHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>,
00605                     TempHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a>,
00606                     &amp;NewHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>,
00607                     Root))
00608     {
00609         <a class="code" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a>(TempHive);
00610         <a class="code" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a>(NewHive);
00611         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00612         <span class="keywordflow">return</span>(STATUS_INSUFFICIENT_RESOURCES);
00613     }
00614 
00615     <span class="comment">//</span>
00616     <span class="comment">// The volatile hive now has all the right stuff in all the right places,</span>
00617     <span class="comment">// we just need to link it into the master hive.</span>
00618     <span class="comment">//</span>
00619     RootData = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(&amp;NewHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>,Root);
00620     ConstructedName = <a class="code" href="../../d8/d2/cmsubs_8c.html#a18">CmpConstructName</a>(KeyControlBlock);
00621     
00622     NewNameLength = ConstructedName-&gt;Length +
00623                 <a class="code" href="../../d1/d2/cmp_8h.html#a96">CmpHKeyNameLen</a>(&amp;RootData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>) +
00624                 <span class="keyword">sizeof</span>(WCHAR);
00625     <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, NewNameLength);
00626     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00627         <a class="code" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a>(TempHive);
00628         <a class="code" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a>(NewHive);
00629         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00630         <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(ConstructedName, CM_NAME_TAG | PROTECTED_POOL);
00631         <span class="keywordflow">return</span>(STATUS_INSUFFICIENT_RESOURCES);
00632     }
00633     <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Length = <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.MaximumLength = NewNameLength;
00634     <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>(&amp;NewName, ConstructedName);
00635     <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(ConstructedName, CM_NAME_TAG | PROTECTED_POOL);
00636     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;NewName, L<span class="stringliteral">"\\"</span>);
00637 
00638     <span class="keywordflow">if</span> (RootData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>) {
00639         <a class="code" href="../../d1/d2/cmp_8h.html#a318">CmpCopyCompressedName</a>(<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Buffer + (<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Length / <span class="keyword">sizeof</span>(WCHAR)),
00640                               <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.MaximumLength - <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Length,
00641                               RootData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,
00642                               <a class="code" href="../../d1/d2/cmp_8h.html#a96">CmpHKeyNameLen</a>(&amp;RootData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>));
00643         <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Length += <a class="code" href="../../d1/d2/cmp_8h.html#a96">CmpHKeyNameLen</a>(&amp;RootData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>);
00644     } <span class="keywordflow">else</span> {
00645         RootName.Buffer = RootData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>;
00646         RootName.Length = RootName.MaximumLength = RootData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
00647 
00648         <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;NewName,&amp;RootName);
00649     }
00650 
00651     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/cmwraper_8c.html#a28">CmpLinkHiveToMaster</a>(&amp;NewName,
00652                                  NULL,
00653                                  NewHive,
00654                                  FALSE,
00655                                  NULL);
00656     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00657         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a> = NewHive;
00658         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a108">REG_CMD_ADD_HIVE_LIST</a>;
00659         <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
00660     } <span class="keywordflow">else</span> {
00661         <a class="code" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a>(NewHive);
00662     }
00663     <a class="code" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a>(TempHive);
00664 
00665     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Buffer);
00666 
00667     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00668         <span class="comment">//</span>
00669         <span class="comment">// We've given user chance to log on, so turn on quota</span>
00670         <span class="comment">//</span>
00671         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/cmapi_8c.html#a2">CmpProfileLoaded</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00672             <a class="code" href="../../d8/d9/cmapi_8c.html#a2">CmpProfileLoaded</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00673             <a class="code" href="../../d1/d2/cmp_8h.html#a249">CmpSetGlobalQuotaAllowed</a>();
00674         }
00675     }
00676 
00677     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00678     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00679 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="cmsavres.c::CmpMergeKeyValues" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpMergeKeyValues           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceKeyCell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceKeyNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetKeyCell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetKeyNode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01150">1150</a> of file <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html">cmtrecpy.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00895">CmpCopyValue()</a>, <a class="el" href="../../d5/d2/cmtree_8c-source.html#l00033">CmpFindNameInList()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01582">CmpInitializeValueNameString()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01338">CmpSyncKeyValues()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00332">_CHILD_LIST::Count</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l01295">HvReallocateCell()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00541">_CELL_DATA::_u::KeyList</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00333">_CHILD_LIST::List</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00036">MAX_KEY_VALUE_NAME_LENGTH</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00468">_CM_KEY_NODE::MaxValueDataLen</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00467">_CM_KEY_NODE::MaxValueNameLen</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00458">_CM_KEY_NODE::ValueList</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
<pre class="fragment"><div>01160                    :
01161     Merges <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> values from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> two key-nodes provided.
01162     Rules <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> merge:
01163     1. The target values are not touched!
01164     2. Only values from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source that are not present in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> 
01165     target are taken into account by <span class="keyword">this</span> routine. They are added
01166     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target node value list <span class="stringliteral">"as they are"</span>.
01167 
01168 Arguments:
01169 
01170    SourceHive     - <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source key
01171    SourceKeyCell  - The source key's cell
01172    SourceKeyNode  - The source key's body
01173    
01174    TargetHive     - <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target key
01175    TargetKeyCell  - The target key's cell
01176    TargetKeyNode  - The target key's body
01177 
01178 Return Value:
01179 
01180    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> of successful, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
01181 
01182 --*/
01183 {
01184     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;    
01185     BOOLEAN success = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;    
01186     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> psrclist, ptarlist;
01187     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newvalue, newlist = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;    
01188     ULONG i, count, Type;
01189     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> poldvalue;
01190     WCHAR *NameBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01191     UNICODE_STRING <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
01192 
01193 
01194     <span class="keywordflow">if</span>(TargetKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o13">MaxValueNameLen</a> &lt; SourceKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o13">MaxValueNameLen</a>) {
01195         TargetKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o13">MaxValueNameLen</a> = SourceKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o13">MaxValueNameLen</a>;
01196     }
01197 
01198     <span class="keywordflow">if</span>(TargetKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o14">MaxValueDataLen</a> &lt; SourceKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o14">MaxValueDataLen</a>) {
01199         TargetKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o14">MaxValueDataLen</a> = SourceKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o14">MaxValueDataLen</a>;
01200     }
01201 
01202     <span class="keywordflow">if</span>(TargetKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> == 0) {
01203         <span class="comment">//</span>
01204         <span class="comment">// No Values in Target, do a sync</span>
01205         <span class="comment">//</span>
01206         <span class="keywordflow">return</span> <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a5">CmpSyncKeyValues</a>(SourceHive, SourceKeyCell, SourceKeyNode, TargetHive, TargetKeyCell, TargetKeyNode);
01207     }
01208     <span class="comment">//</span>
01209     <span class="comment">// Set up the value list</span>
01210     <span class="comment">//</span>
01211     count = SourceKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a>;
01212 
01213     <span class="keywordflow">if</span> (count == 0) {
01214 
01215         <span class="comment">// No values in source, no update to the list needed.</span>
01216         success = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01217     } <span class="keywordflow">else</span> {        
01218 
01219         NameBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, MAX_KEY_VALUE_NAME_LENGTH);
01220         <span class="keywordflow">if</span>(!NameBuffer) <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01221 
01222         <span class="comment">//</span>
01223         <span class="comment">// The type of the new cells will be the same as that</span>
01224         <span class="comment">// of the target cell.</span>
01225         <span class="comment">//</span>
01226 
01227         Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(TargetKeyCell);    
01228 
01229         <span class="comment">//</span>
01230         <span class="comment">// Reallocate the value list for target to fit the new size</span>
01231         <span class="comment">// Worst case: all values from the source node will be added </span>
01232         <span class="comment">// to the target node</span>
01233         <span class="comment">//</span>
01234 
01235         psrclist = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SourceHive, SourceKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>);
01236 
01237         newlist = <a class="code" href="../../d8/d0/hivecell_8c.html#a20">HvReallocateCell</a>(
01238                     TargetHive,
01239                     TargetKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>,
01240                     (TargetKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> + count) * <span class="keyword">sizeof</span>(HCELL_INDEX)
01241                     );
01242 
01243         <span class="comment">// Growing up may fail</span>
01244         <span class="keywordflow">if</span> (newlist == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01245             <span class="keywordflow">goto</span> EndValueMerge;
01246         }
01247         TargetKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a> = newlist;
01248         ptarlist = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(TargetHive, newlist);
01249 
01250 
01251         <span class="comment">//</span>
01252         <span class="comment">// Copy the values</span>
01253         <span class="comment">//</span>
01254         <span class="keywordflow">for</span> (i = 0; i &lt; count; i++) {
01255 
01256             poldvalue = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SourceHive, psrclist-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o4">KeyList</a>[i]);
01257             
01258             <span class="comment">//</span>
01259             <span class="comment">// get the name</span>
01260             <span class="comment">//</span>
01261             <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a15">CmpInitializeValueNameString</a>(poldvalue,&amp;ValueName,NameBuffer);
01262 
01263 
01264             <span class="comment">//</span>
01265             <span class="comment">// check if this particular values doesn't exist in the target node already</span>
01266             <span class="comment">//</span>
01267             <span class="keywordflow">if</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a> == <a class="code" href="../../d4/d3/cmtree_8c.html#a0">CmpFindNameInList</a>(TargetHive,&amp;(TargetKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>),&amp;ValueName,NULL,NULL)) {
01268 
01269                 <span class="comment">//</span>
01270                 <span class="comment">// No, it doesn't, so add it</span>
01271                 <span class="comment">//</span>
01272                 newvalue = <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a12">CmpCopyValue</a>(
01273                                 SourceHive,
01274                                 psrclist-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o4">KeyList</a>[i],
01275                                 TargetHive,
01276                                 Type
01277                                 );
01278 
01279                 <span class="keywordflow">if</span> (newvalue != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01280 
01281                     ptarlist-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o4">KeyList</a>[TargetKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a>++] = newvalue;
01282 
01283                 } <span class="keywordflow">else</span> {
01284 
01285                     <span class="comment">// Delete all the copied values on an error.</span>
01286 
01287                     <span class="keywordflow">for</span> (; i &gt; 0; i--) {
01288                         <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(
01289                             TargetHive,
01290                             ptarlist-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o4">KeyList</a>[--TargetKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a>]
01291                             );
01292                     }
01293                     <span class="keywordflow">goto</span> EndValueMerge;
01294                 }
01295             }
01296         }
01297 
01298         <span class="comment">//</span>
01299         <span class="comment">// adjust the Value list to the new count. </span>
01300         <span class="comment">// This call shouldn't fail (the new size is smaller or in the worst case equal to the old one)</span>
01301         <span class="comment">//</span>
01302         newlist = <a class="code" href="../../d8/d0/hivecell_8c.html#a20">HvReallocateCell</a>(
01303                     TargetHive,
01304                     TargetKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>,
01305                     TargetKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> * <span class="keyword">sizeof</span>(HCELL_INDEX)
01306                     );
01307 
01308         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(newlist != HCELL_NIL);
01309         TargetKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a> = newlist;
01310 
01311         success = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01312     }
01313 
01314 EndValueMerge:
01315     <span class="keywordflow">if</span> (NameBuffer) <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NameBuffer);
01316 
01317     <span class="keywordflow">if</span> (success == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01318 
01319         <span class="comment">// Clean-up on failure</span>
01320         <span class="comment">// Revert to the original size</span>
01321         <span class="keywordflow">if</span> (newlist != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01322             newlist = <a class="code" href="../../d8/d0/hivecell_8c.html#a20">HvReallocateCell</a>(
01323                         TargetHive,
01324                         TargetKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>,
01325                         TargetKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> * <span class="keyword">sizeof</span>(HCELL_INDEX)
01326                         );
01327 
01328             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(newlist != HCELL_NIL);
01329             TargetKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a> = newlist;
01330         }
01331 
01332     }
01333 
01334     <span class="keywordflow">return</span> success;
01335 }
    
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="cmsavres.c::CmpRefreshHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpRefreshHive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>KeyControlBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00731">731</a> of file <a class="el" href="../../d7/d1/cmsavres_8c-source.html">cmsavres.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01235">CmpFlushNotify()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00684">CmpRefreshWorkerRoutine()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01071">CmpSearchKeyControlBlockTree()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00738">_REGISTRY_COMMAND::Command</a>, <a class="el" href="../../d9/d2/cmwrapr2_8c-source.html#l00029">CommandArea</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00739">_REGISTRY_COMMAND::Hive</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00204">HIVE_NOLAZYFLUSH</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00622">_HHIVE::HiveFlags</a>, <a class="el" href="../../d5/d5/regext_8c-source.html#l00033">HiveList</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00434">KEY_HIVE_ENTRY</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00561">_CM_NOTIFY_BLOCK::KeyBody</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00537">_CELL_DATA::_u::KeyNode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00728">REG_CMD_REFRESH_HIVE</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00436">SeSinglePrivilegeCheck()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01675">SeTcbPrivilege</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00097">CmRestoreKey()</a>.
<p>
<pre class="fragment"><div>00736                    :
00737 
00738     Backs <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> all changes to a hives since <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> was last flushed.
00739     Used as a transaction abort by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security system.
00740 
00741     Caller must have <a class="code" href="../../d0/d5/se_8h.html#a84">SeTcbPrivilege</a>.
00742 
00743     The target hive must have <a class="code" href="../../d6/d0/hive_8h.html#a10">HIVE_NOLAZYFLUSH</a> set.
00744 
00745     KeyControlBlock must refer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive (HIVE_ENTRY must
00746     be set in the key.)
00747 
00748     Any kcbs that point into <span class="keyword">this</span> hive (and thus any handles open
00749     against it) will be force to DELETED state.  (If we <span class="keywordflow">do</span> any work.)
00750 
00751     All notifies pending against the hive will be flushed.
00752 
00753     When we're done, only the tombstone kcbs, handles, and attached
00754     notify blocks will be left.
00755 
00756     WARNNOTE:   Once reads have begun, <span class="keywordflow">if</span> the operation fails, the hive
00757                 will be corrupt, so we will bugcheck.
00758 
00759 Arguments:
00760 
00761     KeyControlBlock - provides a reference to the root of the hive
00762                       we wish to refresh.
00763 
00764 Return Value:
00765 
00766     NTSTATUS
00767 
00768 --*/
00769 {
00770     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>              Hive;
00771     HCELL_INDEX         Cell;
00772     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>          pcell;
00773     <a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html">REGISTRY_COMMAND</a>    CommandArea;
00774     PLIST_ENTRY         ptr;
00775     <a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a>    node;
00776 
00777     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00778     <span class="comment">//</span>
00779     <span class="comment">// Check to see if the caller has the privilege to make this call.</span>
00780     <span class="comment">//</span>
00781     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(SeTcbPrivilege, KeGetPreviousMode())) {
00782         <span class="keywordflow">return</span> STATUS_PRIVILEGE_NOT_HELD;
00783     }
00784 
00785     <span class="keywordflow">if</span> (KeyControlBlock-&gt;Delete) {
00786         <span class="keywordflow">return</span>(STATUS_KEY_DELETED);
00787     }
00788     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
00789     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyControlBlock-&gt;KeyHive;
00790     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = KeyControlBlock-&gt;KeyCell;
00791 
00792     <span class="comment">//</span>
00793     <span class="comment">// check to see if hive is of proper type</span>
00794     <span class="comment">//</span>
00795     <span class="keywordflow">if</span> ( ! (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a10">HIVE_NOLAZYFLUSH</a>)) {
00796         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00797         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00798     }
00799 
00800     <span class="comment">//</span>
00801     <span class="comment">// punt if any volatile storage has been allocated</span>
00802     <span class="comment">//</span>
00803     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>].Length != 0) {
00804         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00805         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00806     }
00807 
00808     <span class="comment">//</span>
00809     <span class="comment">// check to see if call was applied to the root of the hive</span>
00810     <span class="comment">//</span>
00811     pcell = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);
00812     <span class="keywordflow">if</span> ( ! (pcell-&gt;u.KeyNode.Flags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a29">KEY_HIVE_ENTRY</a>)) {
00813         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00814         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00815     }
00816 
00817     <span class="comment">//</span>
00818     <span class="comment">// Flush all NotifyBlocks attached to this hive</span>
00819     <span class="comment">//</span>
00820     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00821 
00822         <span class="comment">//</span>
00823         <span class="comment">// flush below will edit list, so restart at beginning each time</span>
00824         <span class="comment">//</span>
00825         ptr = &amp;(((<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>)-&gt;NotifyList);
00826         <span class="keywordflow">if</span> (ptr-&gt;Flink == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00827             <span class="keywordflow">break</span>;
00828         }
00829 
00830         ptr = ptr-&gt;Flink;
00831         node = CONTAINING_RECORD(ptr, <a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">CM_NOTIFY_BLOCK</a>, HiveList);
00832         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((node-&gt;KeyBody)-&gt;NotifyBlock == node);
00833         <a class="code" href="../../d1/d2/cmp_8h.html#a288">CmpFlushNotify</a>(node-&gt;KeyBody);
00834     }
00835 
00836     <span class="comment">//</span>
00837     <span class="comment">// Force all kcbs that refer to this hive to the deleted state.</span>
00838     <span class="comment">//</span>
00839     <a class="code" href="../../d8/d2/cmsubs_8c.html#a21">CmpSearchKeyControlBlockTree</a>(
00840         CmpRefreshWorkerRoutine,
00841         (PVOID)Hive,
00842         NULL
00843         );
00844 
00845     <span class="comment">//</span>
00846     <span class="comment">// We cannot do the relevent I/O from this context, so send a</span>
00847     <span class="comment">// command to the worker code.</span>
00848     <span class="comment">//</span>
00849     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a110">REG_CMD_REFRESH_HIVE</a>;
00850     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o1">Hive</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00851     <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;CommandArea);
00852     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00853     <span class="comment">//</span>
00854     <span class="comment">// we're back (rather than bugchecked) so it worked</span>
00855     <span class="comment">//</span>
00856     <span class="keywordflow">return</span> STATUS_SUCCESS;
00857 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="cmsavres.c::CmpRefreshWorkerRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG CmpRefreshWorkerRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Current</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00684">684</a> of file <a class="el" href="../../d7/d1/cmsavres_8c-source.html">cmsavres.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00266">Context1</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00272">_CM_KEY_CONTROL_BLOCK::Delete</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00855">KCB_WORKER_CONTINUE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00857">KCB_WORKER_DELETE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00280">_CM_KEY_CONTROL_BLOCK::KeyCell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00279">_CM_KEY_CONTROL_BLOCK::KeyHive</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00731">CmpRefreshHive()</a>.
<p>
<pre class="fragment"><div>00691                    :
00692 
00693     Helper used by <a class="code" href="../../d6/d2/cmsavres_8c.html#a10">CmpRefreshHive</a> when calling
00694     <a class="code" href="../../d1/d2/cmp_8h.html#a215">CmpSearchKeyControlBlockTree</a>.
00695 
00696     If a match <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> found, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> KCB <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> deleted and restart <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00697     Else, <span class="keywordflow">continue</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00698 
00699 Arguments:
00700 
00701     Current - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> to examine
00702 
00703     <a class="code" href="../../d3/d1/threads_8h.html#a107">Context1</a> - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive to match against
00704 
00705     <a class="code" href="../../d3/d1/threads_8h.html#a108">Context2</a> - nothing
00706 
00707 Return Value:
00708 
00709     <span class="keywordflow">if</span> no match, <span class="keywordflow">return</span> <span class="keywordflow">continue</span>.
00710 
00711     <span class="keywordflow">if</span> match, <span class="keywordflow">return</span> restart.
00712 
00713 --*/
00714 {
00715     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00716     <span class="keywordflow">if</span> (Current-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a> == (<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)<a class="code" href="../../d3/d1/threads_8h.html#a107">Context1</a>) {
00717 
00718         <span class="comment">//</span>
00719         <span class="comment">// match.  set deleted flag.  continue search.</span>
00720         <span class="comment">//</span>
00721         Current-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o0">Delete</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00722         Current-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00723         Current-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o6">KeyCell</a> = 0;
00724         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d2/cmp_8h.html#a116">KCB_WORKER_DELETE</a>);
00725     }
00726     <span class="keywordflow">return</span> <a class="code" href="../../d1/d2/cmp_8h.html#a114">KCB_WORKER_CONTINUE</a>;
00727 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="cmsavres.c::CmpSaveKeyByFileCopy" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpSaveKeyByFileCopy           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01261">1261</a> of file <a class="el" href="../../d7/d1/cmsavres_8c-source.html">cmsavres.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00746">_REGISTRY_COMMAND::Buffer</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00027">CM_SAVEKEYBUFSIZE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00745">_REGISTRY_COMMAND::CmHive</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00772">CmpFileFlush()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00516">CmpFileWrite()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00032">CmpStashBuffer</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00738">_REGISTRY_COMMAND::Command</a>, <a class="el" href="../../d9/d2/cmwrapr2_8c-source.html#l00029">CommandArea</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00480">CMP_OFFSET_ARRAY::DataBuffer</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00481">CMP_OFFSET_ARRAY::DataLength</a>, <a class="el" href="../../d2/d9/tdisp_8c-source.html#l00009">ErrorExit()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00127">ExAllocatePoolWithQuota</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00650">_CMHIVE::FileHandles</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00479">CMP_OFFSET_ARRAY::FileOffset</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00742">_REGISTRY_COMMAND::FileSize</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00741">_REGISTRY_COMMAND::FileType</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00571">HFILE_TYPE_EXTERNAL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00568">HFILE_TYPE_PRIMARY</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00344">_HBASE_BLOCK::Length</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00747">_REGISTRY_COMMAND::Offset</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a178">PagedPoolCacheAligned</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00729">REG_CMD_HIVE_READ</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00336">_HBASE_BLOCK::Sequence1</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00337">_HBASE_BLOCK::Sequence2</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00743">_REGISTRY_COMMAND::Status</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00862">CmSaveKey()</a>.
<p>
<pre class="fragment"><div>01267                    :
01268 
01269     Do special <span class="keywordflow">case</span> of SaveKey by copying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
01270 
01271 Arguments:
01272 
01273     CmHive - supplies a pointer to an HHive
01274 
01275     FileHandle - open handle to target <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
01276 
01277 Return Value:
01278 
01279     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
01280 
01281 --*/
01282 {
01283     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    BaseBlock;
01284     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        status;
01285     ULONG           <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01286     ULONG           Length;
01287     ULONG           Position;
01288     <a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html">REGISTRY_COMMAND</a>   <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>;
01289     PUCHAR          CopyBuffer;
01290     ULONG           BufferLength;
01291     ULONG           BytesToCopy;
01292     <a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html">CMP_OFFSET_ARRAY</a> offsetElement;
01293 
01294     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01295 
01296     <span class="comment">//</span>
01297     <span class="comment">// Attempt to allocate large buffer for copying stuff around.  If</span>
01298     <span class="comment">// we can't get one, just use the stash buffer.</span>
01299     <span class="comment">//</span>
01300     BufferLength = <a class="code" href="../../d6/d2/cmsavres_8c.html#a0">CM_SAVEKEYBUFSIZE</a>;
01301     <span class="keywordflow">try</span> {
01302         CopyBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a11">ExAllocatePoolWithQuota</a>(PagedPoolCacheAligned,
01303                                              BufferLength);
01304     } except(EXCEPTION_EXECUTE_HANDLER) {
01305         CopyBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01306     }
01307     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
01308     <span class="keywordflow">if</span> (CopyBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01309         CopyBuffer = <a class="code" href="../../d8/d9/cmapi_8c.html#a4">CmpStashBuffer</a>;
01310         BufferLength = <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
01311     }
01312     <span class="comment">//</span>
01313     <span class="comment">// Read the base block, step the sequence number, and write it out</span>
01314     <span class="comment">//</span>
01315     status = STATUS_REGISTRY_IO_FAILED;
01316 
01317     CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a>] = FileHandle;
01318 
01319     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = 0;
01320     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a111">REG_CMD_HIVE_READ</a>;
01321     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a> = CmHive;
01322     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o3">FileType</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>;
01323     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o9">Offset</a> = &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01324     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o8">Buffer</a> = CopyBuffer;
01325     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o4">FileSize</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
01326     <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;CommandArea);
01327     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a>)) {
01328         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01329     }
01330 
01331     BaseBlock = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)CopyBuffer;
01332     Length = BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a>;
01333 
01334     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o1">Sequence1</a>++;
01335 
01336     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = 0;
01337     offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o0">FileOffset</a> = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01338     offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o1">DataBuffer</a> = CopyBuffer;
01339     offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o2">DataLength</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
01340     <span class="keywordflow">if</span> ( ! <a class="code" href="../../d7/d3/cmwrapr_8c.html#a16">CmpFileWrite</a>((<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)CmHive, HFILE_TYPE_EXTERNAL, &amp;offsetElement,
01341                         1, &amp;Offset))
01342     {
01343         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01344     }
01345 
01346     <span class="comment">//</span>
01347     <span class="comment">// Flush the external, so header will show corrupt until we're done</span>
01348     <span class="comment">//</span>
01349     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/cmwrapr_8c.html#a17">CmpFileFlush</a>((<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)CmHive, HFILE_TYPE_EXTERNAL)) {
01350         status = STATUS_SUCCESS;
01351     }
01352 
01353     <span class="comment">//</span>
01354     <span class="comment">// For span of data, read from master and write to external</span>
01355     <span class="comment">//</span>
01356     <span class="keywordflow">for</span> (Position = 0; Position &lt; Length; Position += BytesToCopy) {
01357 
01358         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = Position + <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
01359         BytesToCopy = Length-Position;
01360         <span class="keywordflow">if</span> (BytesToCopy &gt; BufferLength) {
01361             BytesToCopy = BufferLength;
01362         }
01363 
01364         <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a111">REG_CMD_HIVE_READ</a>;
01365         <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a> = CmHive;
01366         <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o3">FileType</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>;
01367         <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o9">Offset</a> = &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01368         <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o8">Buffer</a> = CopyBuffer;
01369         <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o4">FileSize</a> = BytesToCopy;
01370         <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;CommandArea);
01371         <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a>)) {
01372             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01373         }
01374 
01375         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = Position + <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
01376         offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o0">FileOffset</a> = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01377         offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o1">DataBuffer</a> = CopyBuffer;
01378         offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o2">DataLength</a> = BytesToCopy;
01379         <span class="keywordflow">if</span> ( ! <a class="code" href="../../d7/d3/cmwrapr_8c.html#a16">CmpFileWrite</a>((<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)CmHive, HFILE_TYPE_EXTERNAL, &amp;offsetElement,
01380                             1, &amp;Offset))
01381         {
01382             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01383         }
01384     }
01385 
01386     <span class="comment">//</span>
01387     <span class="comment">// Flush the external, so data is there before we update the header</span>
01388     <span class="comment">//</span>
01389     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/cmwrapr_8c.html#a17">CmpFileFlush</a>((<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)CmHive, HFILE_TYPE_EXTERNAL)) {
01390         status = STATUS_SUCCESS;
01391     }
01392 
01393     <span class="comment">//</span>
01394     <span class="comment">// Reread the base block, sync the seq #, rewrite it.</span>
01395     <span class="comment">// (Brute force, but means no memory alloc - always works)</span>
01396     <span class="comment">//</span>
01397     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = 0;
01398     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a111">REG_CMD_HIVE_READ</a>;
01399     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a> = CmHive;
01400     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o3">FileType</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>;
01401     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o9">Offset</a> = &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01402     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o8">Buffer</a> = CopyBuffer;
01403     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o4">FileSize</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
01404     <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;CommandArea);
01405     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a>)) {
01406         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01407     }
01408     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o1">Sequence1</a>++;     <span class="comment">// it got trampled when we reread it</span>
01409     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o2">Sequence2</a>++;
01410 
01411     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = 0;
01412     offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o0">FileOffset</a> = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01413     offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o1">DataBuffer</a> = CopyBuffer;
01414     offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o2">DataLength</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
01415     <span class="keywordflow">if</span> ( ! <a class="code" href="../../d7/d3/cmwrapr_8c.html#a16">CmpFileWrite</a>((<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)CmHive, HFILE_TYPE_EXTERNAL, &amp;offsetElement,
01416                         1, &amp;Offset))
01417     {
01418         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01419     }
01420 
01421     <span class="comment">//</span>
01422     <span class="comment">// Flush the external, and we are done</span>
01423     <span class="comment">//</span>
01424     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/cmwrapr_8c.html#a17">CmpFileFlush</a>((<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)CmHive, HFILE_TYPE_EXTERNAL)) {
01425         status = STATUS_SUCCESS;
01426     }
01427 
01428 <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>:
01429     <span class="keywordflow">if</span> (CopyBuffer != <a class="code" href="../../d8/d9/cmapi_8c.html#a4">CmpStashBuffer</a>) {
01430         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(CopyBuffer);
01431     }
01432     CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a>] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01433     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01434     <span class="keywordflow">return</span> status;
01435 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="cmsavres.c::CmRestoreKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmRestoreKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyControlBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00097">97</a> of file <a class="el" href="../../d7/d1/cmsavres_8c-source.html">cmsavres.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00346">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00376">_CM_INDEX::Cell</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00460">_CM_KEY_NODE::ChildHiveReference</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00255">CM_KCB_SUBKEY_HINT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00373">CM_KEY_FAST_LEAF</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00371">CM_KEY_INDEX_ROOT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00568">CmpCleanUpKcbValueCache()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00686">CmpCopyKeyPartial()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01314">CmpCopyTree</a>, <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00034">CmpDeleteTree()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01490">CmpDestroyTemporaryHive()</a>, <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00140">CmpFreeKeyByCell()</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00484">CmpLoadHiveVolatile()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00036">CmpMasterHive</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00029">CmpProfileLoaded</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00731">CmpRefreshHive()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00114">CmpReportNotify()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00180">CmpSearchForOpenSubKeys()</a>, <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00354">CmpSetGlobalQuotaAllowed()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00261">CMS_SAVRES</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00382">_CM_KEY_FAST_INDEX::Count</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00388">_CM_KEY_INDEX::Count</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00308">DCmCheckRegistry</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00291">ExFreePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00568">HFILE_TYPE_PRIMARY</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00199">HINIT_FILE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00649">_CMHIVE::Hive</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00071">HSTORAGE_TYPE</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l01295">HvReallocateCell()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00440">KEY_COMP_NAME</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00434">KEY_HIVE_ENTRY</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00341">_CM_KEY_REFERENCE::KeyCell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00540">_CELL_DATA::_u::KeyIndex</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00537">_CELL_DATA::_u::KeyNode</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00383">_CM_KEY_FAST_INDEX::List</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00389">_CM_KEY_INDEX::List</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00477">_CM_KEY_NODE::Name</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00475">_CM_KEY_NODE::NameLength</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00453">_CM_KEY_NODE::Parent</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00107">PHCELL_INDEX</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00281">PROTECTED_POOL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00343">_HBASE_BLOCK::RootCell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00387">_CM_KEY_INDEX::Signature</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00454">_CM_KEY_NODE::SubKeyCounts</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00457">_CM_KEY_NODE::SubKeyLists</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02348">NtRestoreKey()</a>.
<p>
<pre class="fragment"><div>00104                    :
00105 
00106     This copies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data from an on-disk hive into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry.  The <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
00107     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not loaded into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system will NOT be <span class="keyword">using</span>
00108     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call returns.
00109 
00110     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flag REG_WHOLE_HIVE_VOLATILE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not set, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given key <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> replaced
00111     by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  The root's name <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> changed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name
00112     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given key.
00113 
00114     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flag REG_WHOLE_HIVE_VOLATILE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set, a <span class="keyword">volatile</span> hive <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> created,
00115     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> copied into <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resulting hive <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> linked to
00116     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> master hive.  The given key must be in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> master hive.  (Usually
00117     will be \Registry\User)
00118 
00119     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flag REG_REFRESH_HIVE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set (must be only flag) then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00120     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> will be restored to its state as of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last flush.
00121     (The hive must be marked NOLAZY_FLUSH, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller must have
00122      TCB privilege, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle must point to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive.
00123      If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> refresh fails, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive will be corrupt, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system
00124      will bugcheck.)
00125 
00126     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flag REG_FORCE_RESTORE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> restore operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done even
00127     <span class="keywordflow">if</span> there areopen handles underneath <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key we are restoring to.
00128 
00129 Arguments:
00130 
00131     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive
00132 
00133     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - supplies index of node at root of tree to restore into
00134 
00135     FileHandle - handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to read from.
00136 
00137 Return Value:
00138 
00139     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
00140 
00141         &lt;TBS&gt;
00142 
00143 --*/
00144 {
00145     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00146     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  ptar;
00147     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  psrc;
00148     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>     TmpCmHive;
00149     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newroot;
00150     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newcell;
00151     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> parent;
00152     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> list;
00153     ULONG       count;
00154     ULONG       i;
00155     ULONG       j;
00156     LONG        size;
00157     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>      <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00158     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
00159     <a class="code" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a> Type;
00160     ULONG       NumberLeaves;
00161     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> LeafArray;
00162     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a> Leaf;
00163     <a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a> FastLeaf;
00164 
00165     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00166     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_SAVRES) {
00167         KdPrint((<span class="stringliteral">"CmRestoreKey:\n"</span>));
00168         KdPrint((<span class="stringliteral">"\tKCB=%08lx\n"</span>,KeyControlBlock));
00169         KdPrint((<span class="stringliteral">"\tFileHandle=%08lx\n"</span>,FileHandle));
00170     }
00171 
00172     <span class="keywordflow">if</span> (Flags &amp; REG_REFRESH_HIVE) {
00173         <span class="keywordflow">if</span> ((Flags &amp; ~REG_REFRESH_HIVE) != 0) {
00174             <span class="comment">//</span>
00175             <span class="comment">// Refresh must be alone</span>
00176             <span class="comment">//</span>
00177             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00178         }
00179     }
00180 
00181     <span class="comment">//</span>
00182     <span class="comment">// If they want to do WHOLE_HIVE_VOLATILE, it's a completely different API.</span>
00183     <span class="comment">//</span>
00184     <span class="keywordflow">if</span> (Flags &amp; REG_WHOLE_HIVE_VOLATILE) {
00185         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d2/cmsavres_8c.html#a9">CmpLoadHiveVolatile</a>(KeyControlBlock, FileHandle));
00186     }
00187 
00188     <span class="comment">//</span>
00189     <span class="comment">// If they want to do REFRESH_HIVE, that's a completely different api too.</span>
00190     <span class="comment">//</span>
00191     <span class="keywordflow">if</span> (Flags &amp; REG_REFRESH_HIVE) {
00192         <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
00193         status = <a class="code" href="../../d6/d2/cmsavres_8c.html#a10">CmpRefreshHive</a>(KeyControlBlock);
00194         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00195         <span class="keywordflow">return</span> status;
00196     }
00197 
00198     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyControlBlock-&gt;KeyHive;
00199     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = KeyControlBlock-&gt;KeyCell;
00200 
00201     <span class="comment">//</span>
00202     <span class="comment">// Disallow attempts to "restore" the master hive</span>
00203     <span class="comment">//</span>
00204     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> == &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>) {
00205         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00206     }
00207 
00208     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
00209 
00210     <span class="comment">//</span>
00211     <span class="comment">// Make sure this key has not been deleted</span>
00212     <span class="comment">//</span>
00213     <span class="keywordflow">if</span> (KeyControlBlock-&gt;Delete) {
00214         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00215         <span class="keywordflow">return</span>(STATUS_CANNOT_DELETE);
00216     }
00217 
00218     <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>(CONTAINING_RECORD(Hive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive));
00219 
00220     <span class="comment">//</span>
00221     <span class="comment">// Check for any open handles underneath the key we are restoring to.</span>
00222     <span class="comment">//</span>
00223     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/cmsubs_8c.html#a12">CmpSearchForOpenSubKeys</a>(KeyControlBlock,(Flags&amp;REG_FORCE_RESTORE)?SearchAndDeref:SearchIfExist) != 0) {
00224 
00225         <span class="comment">//</span>
00226         <span class="comment">// Cannot restore over a subtree with open handles in it, or the open handles to subkeys </span>
00227         <span class="comment">// successfully marked as closed.</span>
00228         <span class="comment">//</span>
00229 
00230         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00231         <span class="keywordflow">return</span>(STATUS_CANNOT_DELETE);
00232     }
00233 
00234     <span class="comment">//</span>
00235     <span class="comment">// Make sure this is the only handle open for this key</span>
00236     <span class="comment">//</span>
00237     <span class="keywordflow">if</span> (KeyControlBlock-&gt;RefCount != 1 &amp;&amp; !(Flags&amp;REG_FORCE_RESTORE)) {
00238         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00239         <span class="keywordflow">return</span>(STATUS_CANNOT_DELETE);
00240     }
00241 
00242     ptar = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);
00243 
00244     <span class="comment">//</span>
00245     <span class="comment">// The subtree the caller wants does not exactly match a</span>
00246     <span class="comment">// subtree.  Make a temporary hive, load the file into it,</span>
00247     <span class="comment">// tree copy the temporary to the active, and free the temporary.</span>
00248     <span class="comment">//</span>
00249 
00250     <span class="comment">//</span>
00251     <span class="comment">// Create the temporary hive</span>
00252     <span class="comment">//</span>
00253     status = <a class="code" href="../../d1/d2/cmp_8h.html#a275">CmpInitializeHive</a>(&amp;TmpCmHive,
00254                            HINIT_FILE,
00255                            0,
00256                            HFILE_TYPE_PRIMARY,
00257                            NULL,
00258                            FileHandle,
00259                            NULL,
00260                            NULL,
00261                            NULL,
00262                            NULL);
00263 
00264     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00265         <span class="keywordflow">goto</span> ErrorExit1;
00266     }                         
00267 
00268     <span class="comment">//</span>
00269     <span class="comment">// Create a new target root, under which we will copy the new tree</span>
00270     <span class="comment">//</span>
00271     <span class="keywordflow">if</span> (ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a29">KEY_HIVE_ENTRY</a>) {
00272         parent = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;                         <span class="comment">// root of hive, so parent is NIL</span>
00273     } <span class="keywordflow">else</span> {
00274         parent = ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a>;
00275     }
00276 
00277     newroot = <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a11">CmpCopyKeyPartial</a>(&amp;(TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>),
00278                                 TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a>,
00279                                 Hive,
00280                                 parent,
00281                                 TRUE);
00282     <span class="keywordflow">if</span> (newroot == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00283         status = STATUS_INSUFFICIENT_RESOURCES;
00284         <span class="keywordflow">goto</span> ErrorExit2;
00285     }
00286 
00287     <span class="comment">//</span>
00288     <span class="comment">// newroot has all the correct stuff, except that it has the</span>
00289     <span class="comment">// source root's name, when it needs to have the target root's.</span>
00290     <span class="comment">// So edit its name.</span>
00291     <span class="comment">//</span>
00292     psrc = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);
00293     ptar = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, newroot);
00294     size = FIELD_OFFSET(<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">CM_KEY_NODE</a>, Name) + psrc-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
00295 
00296     <span class="comment">//</span>
00297     <span class="comment">// make sure that new root has correct amount of space</span>
00298     <span class="comment">// to hold name from old root</span>
00299     <span class="comment">//</span>
00300     newcell = <a class="code" href="../../d8/d0/hivecell_8c.html#a20">HvReallocateCell</a>(Hive, newroot, size);
00301     <span class="keywordflow">if</span> (newcell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00302         status = STATUS_INSUFFICIENT_RESOURCES;
00303         <span class="keywordflow">goto</span> ErrorExit2;
00304     }
00305     newroot = newcell;
00306     ptar = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, newroot);
00307 
00308     status = STATUS_SUCCESS;
00309 
00310     RtlMoveMemory((PVOID)&amp;(ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>[0]),
00311                   (PVOID)&amp;(psrc-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>[0]),
00312                   psrc-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
00313 
00314     ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a> = psrc-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
00315     <span class="keywordflow">if</span> (psrc-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>) {
00316         ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>;
00317     } <span class="keywordflow">else</span> {
00318         ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>;
00319     }
00320 
00321     <span class="comment">//</span>
00322     <span class="comment">// newroot is now ready to have subtree copied under it, do tree copy</span>
00323     <span class="comment">//</span>
00324     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a118">CmpCopyTree</a>(&amp;(TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>),
00325                     TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a>,
00326                     Hive,
00327                     newroot) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)
00328     {
00329         status = STATUS_INSUFFICIENT_RESOURCES;
00330         <span class="keywordflow">goto</span> ErrorExit2;
00331     }
00332 
00333     <span class="comment">//</span>
00334     <span class="comment">// The new root and the tree under it now look the way we want.</span>
00335     <span class="comment">//</span>
00336 
00337     <span class="comment">//</span>
00338     <span class="comment">// Swap the new tree in for the old one.</span>
00339     <span class="comment">//</span>
00340     ptar = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);
00341     parent = ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a>;
00342 
00343     <span class="keywordflow">if</span> (ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a29">KEY_HIVE_ENTRY</a>) {
00344 
00345         <span class="comment">//</span>
00346         <span class="comment">// root is actually the root of the hive.  parent doesn't</span>
00347         <span class="comment">// refer to it via a child list, but rather with an inter hive</span>
00348         <span class="comment">// pointer.  also, must update base block</span>
00349         <span class="comment">//</span>
00350         ptar = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>( (&amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>)), parent);
00351         ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o8">ChildHiveReference</a>.<a class="code" href="../../d5/d5/struct__CM__KEY__REFERENCE.html#o0">KeyCell</a> = newroot;
00352         ptar = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, newroot);
00353         ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a> = parent;
00354         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a> = newroot;
00355 
00356 
00357     } <span class="keywordflow">else</span> {
00358 
00359         <span class="comment">//</span>
00360         <span class="comment">//  Notice that new root is *always* name of existing target,</span>
00361         <span class="comment">//      therefore, even in b-tree, old and new cell can share</span>
00362         <span class="comment">//      the same reference slot in the parent.  So simply edit</span>
00363         <span class="comment">//      the new cell_index on the top of the old.</span>
00364         <span class="comment">//</span>
00365         ptar = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, parent);
00366         Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Cell);
00367         list = ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type];
00368         count = ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[Type];
00369 
00370         ptar = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, list);
00371         <span class="keywordflow">if</span> (ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o3">KeyIndex</a>.<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a18">CM_KEY_INDEX_ROOT</a>) {
00372             NumberLeaves = ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o3">KeyIndex</a>.<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a>;
00373             LeafArray = &amp;ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o3">KeyIndex</a>.<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[0];
00374         } <span class="keywordflow">else</span> {
00375             NumberLeaves = 1;
00376             LeafArray = &amp;list;
00377         }
00378 
00379         <span class="comment">//</span>
00380         <span class="comment">// Look in each leaf for the HCELL_INDEX we need to replace</span>
00381         <span class="comment">//</span>
00382         <span class="keywordflow">for</span> (i = 0; i &lt; NumberLeaves; i++) {
00383             Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, LeafArray[i]);
00384             <span class="keywordflow">if</span> (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a20">CM_KEY_FAST_LEAF</a>) {
00385                 FastLeaf = (<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a>)Leaf;
00386                 <span class="keywordflow">for</span> (j=0; j &lt; FastLeaf-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o1">Count</a>; j++) {
00387                     <span class="keywordflow">if</span> (FastLeaf-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[j].<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o0">Cell</a> == <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>) {
00388                         FastLeaf-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[j].<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o0">Cell</a> = newroot;
00389                         <span class="keywordflow">goto</span> FoundCell;
00390                     }
00391                 }
00392             } <span class="keywordflow">else</span> {
00393                 <span class="keywordflow">for</span> (j=0; j &lt; Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a>; j++) {
00394                     <span class="keywordflow">if</span> (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[j] == <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>) {
00395 
00396                         Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[j] = newroot;
00397                         <span class="keywordflow">goto</span> FoundCell;
00398                     }
00399                 }
00400             }
00401         }
00402         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);      <span class="comment">//  implies we didn't find it</span>
00403                         <span class="comment">//  we should never get here</span>
00404     }
00405 
00406 FoundCell:
00407 
00408 
00409     <span class="comment">//</span>
00410     <span class="comment">// Fix up the key control block to point to the new root</span>
00411     <span class="comment">//</span>
00412     KeyControlBlock-&gt;KeyCell = newroot;
00413     KeyControlBlock-&gt;KeyNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, newroot);
00414 
00415     <span class="comment">//</span>
00416     <span class="comment">// Kcb has changed, update the cache information.</span>
00417     <span class="comment">// Registry locked exclusively, no need for KCB lock.</span>
00418     <span class="comment">//</span>
00419     <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
00420 
00421     <a class="code" href="../../d8/d2/cmsubs_8c.html#a16">CmpCleanUpKcbValueCache</a>(KeyControlBlock);
00422 
00423     <span class="keywordflow">if</span> (KeyControlBlock-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a11">CM_KCB_SUBKEY_HINT</a>) {
00424         <span class="comment">//</span>
00425         <span class="comment">// Now free the HintIndex allocation</span>
00426         <span class="comment">//</span>
00427         <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(KeyControlBlock-&gt;IndexHint, CM_CACHE_INDEX_TAG | PROTECTED_POOL);
00428     }
00429 
00430     KeyControlBlock-&gt;ValueCache.Count = KeyControlBlock-&gt;KeyNode-&gt;ValueList.Count;
00431     KeyControlBlock-&gt;ValueCache.ValueList = (ULONG_PTR) (KeyControlBlock-&gt;KeyNode-&gt;ValueList.List);
00432     KeyControlBlock-&gt;Flags = KeyControlBlock-&gt;KeyNode-&gt;Flags;
00433     KeyControlBlock-&gt;Security = KeyControlBlock-&gt;KeyNode-&gt;Security;
00434 
00435     KeyControlBlock-&gt;ExtFlags = 0;
00436 
00437     <span class="comment">//</span>
00438     <span class="comment">// Delete the old subtree and it's root cell</span>
00439     <span class="comment">//</span>
00440     <a class="code" href="../../d3/d3/cmtredel_8c.html#a0">CmpDeleteTree</a>(Hive, Cell);
00441     <a class="code" href="../../d3/d3/cmtredel_8c.html#a1">CmpFreeKeyByCell</a>(Hive, Cell, FALSE);
00442 
00443     <span class="comment">//</span>
00444     <span class="comment">// Report the notify event</span>
00445     <span class="comment">//</span>
00446     <a class="code" href="../../d6/d3/cmwraper_8c.html#a13">CmpReportNotify</a>(KeyControlBlock,
00447                     KeyControlBlock-&gt;KeyHive,
00448                     KeyControlBlock-&gt;KeyCell,
00449                     REG_NOTIFY_CHANGE_NAME);
00450     
00451 
00452     <span class="comment">//</span>
00453     <span class="comment">// Free the temporary hive</span>
00454     <span class="comment">//</span>
00455     <a class="code" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a>(TmpCmHive);
00456 
00457     <span class="comment">//</span>
00458     <span class="comment">// We've given user chance to log on, so turn on quota</span>
00459     <span class="comment">//</span>
00460     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/cmapi_8c.html#a2">CmpProfileLoaded</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00461         <a class="code" href="../../d8/d9/cmapi_8c.html#a2">CmpProfileLoaded</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00462         <a class="code" href="../../d1/d2/cmp_8h.html#a249">CmpSetGlobalQuotaAllowed</a>();
00463     }
00464 
00465     <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>(CONTAINING_RECORD(Hive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive));
00466     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00467     <span class="keywordflow">return</span> status;
00468 
00469 
00470     <span class="comment">//</span>
00471     <span class="comment">// Error exits</span>
00472     <span class="comment">//</span>
00473 ErrorExit2:
00474     <a class="code" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a>(TmpCmHive);
00475 ErrorExit1:
00476     <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>(CONTAINING_RECORD(Hive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive));
00477     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00478 
00479     <span class="keywordflow">return</span> status;
00480 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="cmsavres.c::CmSaveKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmSaveKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyControlBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00862">862</a> of file <a class="el" href="../../d7/d1/cmsavres_8c-source.html">cmsavres.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00422">CM_WRAP_LIMIT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00686">CmpCopyKeyPartial()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01314">CmpCopyTree</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01439">CmpCreateTemporaryHive()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01490">CmpDestroyTemporaryHive()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00037">CmpGlobalQuotaAllowed</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00063">CmpGlobalQuotaUsed</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00038">CmpGlobalQuotaWarning</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00036">CmpMasterHive</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01261">CmpSaveKeyByFileCopy()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00261">CMS_SAVRES</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00308">DCmCheckRegistry</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00608">_HHIVE::DirtyCount</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00650">_CMHIVE::FileHandles</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00571">HFILE_TYPE_EXTERNAL</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00649">_CMHIVE::Hive</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00204">HIVE_NOLAZYFLUSH</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00622">_HHIVE::HiveFlags</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01433">HvWriteHive()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00537">_CELL_DATA::_u::KeyNode</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00343">_HBASE_BLOCK::RootCell</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02471">NtSaveKey()</a>.
<p>
<pre class="fragment"><div>00868                    :
00869 
00870 Arguments:
00871 
00872     KeyControlBlock - pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> KCB that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key
00873 
00874     FileHandle - handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to dump to.
00875 
00876 Return Value:
00877 
00878     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
00879 
00880         &lt;TBS&gt;
00881 
00882 --*/
00883 {
00884     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00885     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  proot;
00886     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>      flags;
00887     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>     TmpCmHive;
00888     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>     CmHive;
00889     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newroot;
00890     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00891     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
00892     ULONG OldQuotaAllowed;
00893     ULONG OldQuotaWarning;
00894 <span class="preprocessor">#if DBG</span>
00895 <span class="preprocessor"></span>    ULONG OldQuotaUsed;
00896 <span class="preprocessor">#endif</span>
00897 <span class="preprocessor"></span>
00898     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00899     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_SAVRES) {
00900         KdPrint((<span class="stringliteral">"CmSaveKey:\n"</span>));
00901         KdPrint((<span class="stringliteral">"\tKCB=%08lx"</span>,KeyControlBlock));
00902         KdPrint((<span class="stringliteral">"\tFileHandle=%08lx\n"</span>,FileHandle));
00903     }
00904 
00905     <span class="comment">//</span>
00906     <span class="comment">// Disallow attempts to "save" the master hive</span>
00907     <span class="comment">//</span>
00908     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyControlBlock-&gt;KeyHive;
00909     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = KeyControlBlock-&gt;KeyCell;
00910 
00911     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> == &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>) {
00912         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00913     }
00914 
00915     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
00916 
00917     <span class="keywordflow">if</span> (KeyControlBlock-&gt;Delete) {
00918         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00919         <span class="keywordflow">return</span> STATUS_KEY_DELETED;
00920     }
00921 
00922     <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>(CONTAINING_RECORD(Hive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive));
00923 
00924     <span class="keywordflow">if</span> ( (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a10">HIVE_NOLAZYFLUSH</a>) &amp;&amp;
00925          (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> != 0))
00926     {
00927         <span class="comment">//</span>
00928         <span class="comment">// It's a NOLAZY hive, and there's some dirty data, so writing</span>
00929         <span class="comment">// out a snapshot of what's in memory will not give the caller</span>
00930         <span class="comment">// consistent user data.  Therefore, copy the on disk image</span>
00931         <span class="comment">// instead of the memory image</span>
00932         <span class="comment">//</span>
00933 
00934         <span class="comment">//</span>
00935         <span class="comment">// Note that this will generate weird results if the key</span>
00936         <span class="comment">// being saved is not the root of the hive, since the</span>
00937         <span class="comment">// resulting file will always be a copy of the entire hive, not</span>
00938         <span class="comment">// just the subtree they asked for.</span>
00939         <span class="comment">//</span>
00940         status = <a class="code" href="../../d6/d2/cmsavres_8c.html#a11">CmpSaveKeyByFileCopy</a>((<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)Hive, FileHandle);
00941         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00942         <span class="keywordflow">return</span> status;
00943     }
00944 
00945     proot = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);
00946     flags = proot-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a>;
00947 
00948 
00949     <span class="comment">//</span>
00950     <span class="comment">// Always try to copy the hive and write it out.  This has the</span>
00951     <span class="comment">// effect of compressing out unused free storage.</span>
00952     <span class="comment">// If there isn't space, and the savekey is of the root of the</span>
00953     <span class="comment">// hive, then just write it out directly.  (i.e. don't fail on</span>
00954     <span class="comment">// a whole hive restore just because we're out of memory.)</span>
00955     <span class="comment">//</span>
00956     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SAVRES) KdPrint(("\tSave of partial hive\n"));
00957 
00958     <span class="comment">//</span>
00959     <span class="comment">// The subtree the caller wants does not exactly match a</span>
00960     <span class="comment">// subtree.  Make a temporary hive, tree copy the source</span>
00961     <span class="comment">// to temp, write out the temporary, free the temporary.</span>
00962     <span class="comment">//</span>
00963 
00964     <span class="comment">//</span>
00965     <span class="comment">// temporarily disable registry quota as we will be giving this memory back immediately!</span>
00966     <span class="comment">//</span>
00967     OldQuotaAllowed = CmpGlobalQuotaAllowed;
00968     OldQuotaWarning = CmpGlobalQuotaWarning;
00969     CmpGlobalQuotaAllowed = CM_WRAP_LIMIT;
00970     CmpGlobalQuotaWarning = CM_WRAP_LIMIT;
00971 
00972 #if DBG
00973     OldQuotaUsed = CmpGlobalQuotaUsed;
00974 #endif
00975 
00976     <span class="comment">//</span>
00977     <span class="comment">// Create the temporary hive</span>
00978     <span class="comment">//</span>
00979 
00980     TmpCmHive = CmpCreateTemporaryHive(FileHandle);
00981     if (TmpCmHive == NULL) {
00982         status =  STATUS_INSUFFICIENT_RESOURCES;
00983         <span class="keywordflow">goto</span> ErrorInsufficientResources;
00984     }
00985 
00986     <span class="comment">//</span>
00987     <span class="comment">// Create a root cell, mark it as such</span>
00988     <span class="comment">//</span>
00989 
00990     newroot = <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a11">CmpCopyKeyPartial</a>(
00991                 Hive,
00992                 Cell,
00993                 &amp;(TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>),
00994                 HCELL_NIL,          <span class="comment">// will force KEY_HIVE_ENTRY set</span>
00995                 TRUE);
00996     <span class="keywordflow">if</span> (newroot == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00997         status = STATUS_INSUFFICIENT_RESOURCES;
00998         <span class="keywordflow">goto</span> ErrorInsufficientResources;
00999     }
01000     TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a> = newroot;
01001 
01002     <span class="comment">//</span>
01003     <span class="comment">// Do a tree copy</span>
01004     <span class="comment">//</span>
01005     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a118">CmpCopyTree</a>(Hive, Cell, &amp;(TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>), newroot) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01006         status = STATUS_INSUFFICIENT_RESOURCES;
01007         <span class="keywordflow">goto</span> ErrorInsufficientResources;
01008     }
01009 
01010     <span class="comment">//</span>
01011     <span class="comment">// Write the file</span>
01012     <span class="comment">//</span>
01013     TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a>] = FileHandle;
01014     status = <a class="code" href="../../d0/d2/hivesync_8c.html#a15">HvWriteHive</a>(&amp;(TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>));
01015     TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a>] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01016 
01017     <span class="comment">//</span>
01018     <span class="comment">// Error exits</span>
01019     <span class="comment">//</span>
01020 ErrorInsufficientResources:
01021 
01022     <span class="comment">//</span>
01023     <span class="comment">// Free the temporary hive</span>
01024     <span class="comment">//</span>
01025     <span class="keywordflow">if</span> (TmpCmHive != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01026         <a class="code" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a>(TmpCmHive);
01027     }
01028 
01029 <span class="preprocessor">#if DBG</span>
01030 <span class="preprocessor"></span>    <span class="comment">//</span>
01031     <span class="comment">// Sanity check: when this assert fires, we have leaks in the copy routine.</span>
01032     <span class="comment">//</span>
01033     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( OldQuotaUsed == CmpGlobalQuotaUsed );
01034 <span class="preprocessor">#endif</span>
01035 <span class="preprocessor"></span>
01036     <span class="comment">//</span>
01037     <span class="comment">// Set global quota back to what it was.</span>
01038     <span class="comment">//</span>
01039     <a class="code" href="../../d8/d9/cmapi_8c.html#a7">CmpGlobalQuotaAllowed</a> = OldQuotaAllowed;
01040     <a class="code" href="../../d8/d9/cmapi_8c.html#a8">CmpGlobalQuotaWarning</a> = OldQuotaWarning;
01041     <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>(CONTAINING_RECORD(Hive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive));
01042     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01043     <span class="keywordflow">return</span> status;
01044 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="cmsavres.c::CmSaveMergedKeys" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmSaveMergedKeys           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>HighPrecedenceKcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LowPrecedenceKcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01047">1047</a> of file <a class="el" href="../../d7/d1/cmsavres_8c-source.html">cmsavres.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00422">CM_WRAP_LIMIT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00686">CmpCopyKeyPartial()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01314">CmpCopyTree</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01439">CmpCreateTemporaryHive()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01490">CmpDestroyTemporaryHive()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00037">CmpGlobalQuotaAllowed</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00063">CmpGlobalQuotaUsed</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00038">CmpGlobalQuotaWarning</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d2/d3/cmtrecpy_8c.html#a6">CmpMergeKeyValues()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01351">CmpMergeTrees</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00261">CMS_SAVRES</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00308">DCmCheckRegistry</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00608">_HHIVE::DirtyCount</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00650">_CMHIVE::FileHandles</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00571">HFILE_TYPE_EXTERNAL</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00649">_CMHIVE::Hive</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00204">HIVE_NOLAZYFLUSH</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00622">_HHIVE::HiveFlags</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01433">HvWriteHive()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00537">_CELL_DATA::_u::KeyNode</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00343">_HBASE_BLOCK::RootCell</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02559">NtSaveMergedKeys()</a>.
<p>
<pre class="fragment"><div>01054                    :
01055 
01056 Arguments:
01057 
01058     HighPrecedenceKcb - pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> KCB that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> High precedence key 
01059                         (<a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> one that wins in a duplicate key <span class="keywordflow">case</span>)
01060 
01061     LowPrecedenceKcb - pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> KCB that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Low precedence key 
01062                         (<a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> one that gets overwritten in a duplicate key <span class="keywordflow">case</span>)
01063 
01064     FileHandle - handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to dump to.
01065 
01066 Return Value:
01067 
01068     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
01069 
01070         &lt;TBS&gt;
01071 
01072 --*/
01073 {
01074     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
01075     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  proot;
01076     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>      flags;
01077     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>     TmpCmHive;
01078     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newroot;
01079     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> HighHive;
01080     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> LowHive;
01081     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> HighCell;
01082     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> LowCell;
01083     ULONG OldQuotaAllowed;
01084     ULONG OldQuotaWarning;
01085     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> HighNode,LowNode;
01086 <span class="preprocessor">#if DBG</span>
01087 <span class="preprocessor"></span>    ULONG OldQuotaUsed;
01088 <span class="preprocessor">#endif</span>
01089 <span class="preprocessor"></span>
01090     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01091     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_SAVRES) {
01092         KdPrint((<span class="stringliteral">"CmSaveMergedKeys:\n"</span>));
01093         KdPrint((<span class="stringliteral">"\tHighKCB=%08lx"</span>,HighPrecedenceKcb));
01094         KdPrint((<span class="stringliteral">"\tLowKCB=%08lx"</span>,LowPrecedenceKcb));
01095         KdPrint((<span class="stringliteral">"\tFileHandle=%08lx\n"</span>,FileHandle));
01096     }
01097 
01098     <span class="comment">//</span>
01099     <span class="comment">// Disallow attempts to "merge" keys located in the same hive</span>
01100     <span class="comment">// A brutal way to avoid recursivity</span>
01101     <span class="comment">//</span>
01102     HighHive = HighPrecedenceKcb-&gt;KeyHive;
01103     HighCell = HighPrecedenceKcb-&gt;KeyCell;
01104     LowHive = LowPrecedenceKcb-&gt;KeyHive;
01105     LowCell = LowPrecedenceKcb-&gt;KeyCell;
01106 
01107     <span class="keywordflow">if</span> (LowHive  == HighHive ) {
01108         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01109     }
01110 
01111     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
01112 
01113     <span class="keywordflow">if</span> (HighPrecedenceKcb-&gt;Delete || LowPrecedenceKcb-&gt;Delete) {
01114         <span class="comment">//</span>
01115         <span class="comment">// Unlock the registry and fail if one of the keys are marked as deleted</span>
01116         <span class="comment">//</span>
01117         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01118         <span class="keywordflow">return</span> STATUS_KEY_DELETED;
01119     }
01120 
01121     <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>(CONTAINING_RECORD(HighHive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive));
01122     <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>(CONTAINING_RECORD(LowHive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive));
01123 
01124 
01125     <span class="keywordflow">if</span>( ((HighHive-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a10">HIVE_NOLAZYFLUSH</a>) &amp;&amp; (HighHive-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> != 0)) ||
01126         ((LowHive-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a10">HIVE_NOLAZYFLUSH</a>) &amp;&amp; (LowHive-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> != 0)) ) {
01127         <span class="comment">//</span>
01128         <span class="comment">// Reject the call when one of the hives is a NOLAZY hive and there's</span>
01129         <span class="comment">// some dirty data. Another alternative will be to save only one of the </span>
01130         <span class="comment">// trees (if a valid one exists) or an entire hive (see CmSaveKey)</span>
01131         <span class="comment">//</span>
01132         status =  STATUS_INVALID_PARAMETER;
01133         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01134         <span class="keywordflow">return</span> status;
01135     }
01136 
01137     proot = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(LowHive, LowCell);
01138     flags = proot-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a>;
01139 
01140 
01141     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SAVRES) KdPrint(("\tCopy of partial HighHive\n"));
01142 
01143     <span class="comment">//</span>
01144     <span class="comment">// Make a temporary hive, tree copy the key subtree from</span>
01145     <span class="comment">// HighHive hive to temp, tree-merge with the key subtree from</span>
01146     <span class="comment">// LowHive hive, write out the temporary, free the temporary.</span>
01147     <span class="comment">// Always write the HighHive subtree first, so its afterwise</span>
01148     <span class="comment">// only add new keys/values</span>
01149     <span class="comment">// </span>
01150 
01151     <span class="comment">//</span>
01152     <span class="comment">// temporarily disable registry quota as we will be giving this memory back immediately!</span>
01153     <span class="comment">//</span>
01154     OldQuotaAllowed = CmpGlobalQuotaAllowed;
01155     OldQuotaWarning = CmpGlobalQuotaWarning;
01156     CmpGlobalQuotaAllowed = CM_WRAP_LIMIT;
01157     CmpGlobalQuotaWarning = CM_WRAP_LIMIT;
01158 
01159 #if DBG
01160     OldQuotaUsed = CmpGlobalQuotaUsed;
01161 #endif
01162 
01163     <span class="comment">//</span>
01164     <span class="comment">// Create the temporary hive</span>
01165     <span class="comment">//</span>
01166 
01167     TmpCmHive = CmpCreateTemporaryHive(FileHandle);
01168     if (TmpCmHive == NULL) {
01169         status =  STATUS_INSUFFICIENT_RESOURCES;
01170         <span class="keywordflow">goto</span> ErrorInsufficientResources;
01171     }
01172 
01173     <span class="comment">//</span>
01174     <span class="comment">// Create a root cell, mark it as such</span>
01175     <span class="comment">//</span>
01176 
01177     newroot = <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a11">CmpCopyKeyPartial</a>(
01178                 HighHive,
01179                 HighCell,
01180                 &amp;(TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>),
01181                 HCELL_NIL,          <span class="comment">// will force KEY_HIVE_ENTRY set</span>
01182                 TRUE);
01183     <span class="keywordflow">if</span> (newroot == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01184         status = STATUS_INSUFFICIENT_RESOURCES;
01185         <span class="keywordflow">goto</span> ErrorInsufficientResources;
01186     }
01187     TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a> = newroot;
01188 
01189     <span class="comment">//</span>
01190     <span class="comment">// Do a tree copy. Copy the HighCell tree from HighHive first.</span>
01191     <span class="comment">//</span>
01192     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a118">CmpCopyTree</a>(HighHive, HighCell, &amp;(TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>), newroot) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01193         status = STATUS_INSUFFICIENT_RESOURCES;
01194         <span class="keywordflow">goto</span> ErrorInsufficientResources;
01195     }
01196 
01197     <span class="comment">//</span>
01198     <span class="comment">// Merge the values in the root node of the merged subtrees</span>
01199     <span class="comment">//</span>
01200     LowNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(LowHive, LowCell);                                         
01201     HighNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(&amp;(TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>),newroot);
01202 
01203     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d3/cmtrecpy_8c.html#a6">CmpMergeKeyValues</a>(LowHive, LowCell, LowNode, &amp;(TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>), newroot, HighNode) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ){
01204         status = STATUS_INSUFFICIENT_RESOURCES;
01205         <span class="keywordflow">goto</span> ErrorInsufficientResources;
01206     }
01207 
01208     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SAVRES) KdPrint(("\tMerge partial LowHive over the HighHive\n"));
01209 
01210     <span class="comment">//</span>
01211     <span class="comment">// Merge the two trees. A Merge operation is a sync that obeys</span>
01212     <span class="comment">// the following aditional rules:</span>
01213     <span class="comment">//      1. keys the exist in the taget tree and does not exist</span>
01214     <span class="comment">//      in the source tree remain as they are (don't get deleted)</span>
01215     <span class="comment">//      2. keys the doesn't exist both in the target tree are added</span>
01216     <span class="comment">//      "as they are" from the source tree (always the target tree</span>
01217     <span class="comment">//      has a higher precedence)</span>
01218     <span class="comment">// </span>
01219     if (CmpMergeTrees(LowHive, LowCell, &amp;(TmpCmHive-&gt;Hive), newroot) == FALSE) {
01220         status = STATUS_INSUFFICIENT_RESOURCES;
01221         <span class="keywordflow">goto</span> ErrorInsufficientResources;
01222     }
01223     
01224     <span class="comment">//</span>
01225     <span class="comment">// Write the file</span>
01226     <span class="comment">//</span>
01227     TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a>] = FileHandle;
01228     status = <a class="code" href="../../d0/d2/hivesync_8c.html#a15">HvWriteHive</a>(&amp;(TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>));
01229     TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a>] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01230 
01231     <span class="comment">//</span>
01232     <span class="comment">// Error exits</span>
01233     <span class="comment">//</span>
01234 ErrorInsufficientResources:
01235     <span class="comment">//</span>
01236     <span class="comment">// Free the temporary hive</span>
01237     <span class="comment">//</span>
01238     <span class="keywordflow">if</span> (TmpCmHive != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01239         <a class="code" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a>(TmpCmHive);
01240     }
01241 
01242 <span class="preprocessor">#if DBG</span>
01243 <span class="preprocessor"></span>    <span class="comment">//</span>
01244     <span class="comment">// Sanity check: when this assert fires, we have leaks in the merge routine.</span>
01245     <span class="comment">//</span>
01246     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( OldQuotaUsed == CmpGlobalQuotaUsed );
01247 <span class="preprocessor">#endif</span>
01248 <span class="preprocessor"></span>    <span class="comment">//</span>
01249     <span class="comment">// Set global quota back to what it was.</span>
01250     <span class="comment">//</span>
01251     <a class="code" href="../../d8/d9/cmapi_8c.html#a7">CmpGlobalQuotaAllowed</a> = OldQuotaAllowed;
01252     <a class="code" href="../../d8/d9/cmapi_8c.html#a8">CmpGlobalQuotaWarning</a> = OldQuotaWarning;
01253     <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>(CONTAINING_RECORD(HighHive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive));
01254     <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>(CONTAINING_RECORD(LowHive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive));
01255     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01256     <span class="keywordflow">return</span> status;
01257 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a4" doxytag="cmsavres.c::CmpGlobalQuotaAllowed" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d6/d2/cmsavres_8c.html#a4">CmpGlobalQuotaAllowed</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00034">34</a> of file <a class="el" href="../../d7/d1/cmsavres_8c-source.html">cmsavres.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="cmsavres.c::CmpGlobalQuotaUsed" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d6/d2/cmsavres_8c.html#a6">CmpGlobalQuotaUsed</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00036">36</a> of file <a class="el" href="../../d7/d1/cmsavres_8c-source.html">cmsavres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00204">CmpClaimGlobalQuota()</a>, <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00265">CmpReleaseGlobalQuota()</a>, <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00092">CmQueryRegistryQuotaInformation()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00862">CmSaveKey()</a>, and <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01047">CmSaveMergedKeys()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="cmsavres.c::CmpGlobalQuotaWarning" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d6/d2/cmsavres_8c.html#a5">CmpGlobalQuotaWarning</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00035">35</a> of file <a class="el" href="../../d7/d1/cmsavres_8c-source.html">cmsavres.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="cmsavres.c::CmpMasterHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> <a class="el" href="../../d6/d3/cmwraper_8c.html#a7">CmpMasterHive</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00029">29</a> of file <a class="el" href="../../d7/d1/cmsavres_8c-source.html">cmsavres.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="cmsavres.c::CmpProfileLoaded" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d5/d3/cmworker_8c.html#a12">CmpProfileLoaded</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00031">31</a> of file <a class="el" href="../../d7/d1/cmsavres_8c-source.html">cmsavres.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="cmsavres.c::CmpStashBuffer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PUCHAR <a class="el" href="../../d1/d3/cmsysini_8c.html#a26">CmpStashBuffer</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00033">33</a> of file <a class="el" href="../../d7/d1/cmsavres_8c-source.html">cmsavres.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:11 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
