<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: physsect.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>physsect.c</h1><a href="../../d0/d6/alpha_2physsect_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment">Copyright (c) 1992  Digital Equipment Corporation</span>
00005 <span class="comment"></span>
00006 <span class="comment">Module Name:</span>
00007 <span class="comment"></span>
00008 <span class="comment">   physsect.c</span>
00009 <span class="comment"></span>
00010 <span class="comment">Abstract:</span>
00011 <span class="comment"></span>
00012 <span class="comment">    This module contains the routine for mapping physical sections for</span>
00013 <span class="comment">    ALPHA machines.</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    Lou Perazzoli (loup) 22-May-1989</span>
00018 <span class="comment">    Joe Notarangelo      21-Sep-1992</span>
00019 <span class="comment"></span>
00020 <span class="comment">Revision History:</span>
00021 <span class="comment"></span>
00022 <span class="comment">    Landy Wang (landyw) 08-April-1998 : Modifications for 3-level 64-bit NT.</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00027 
00028 <span class="comment">//#define FIRSTDBG 1</span>
00029 <span class="comment">//#define AGGREGATE_DBG FIRSTDBG</span>
00030 
00031 
00032 <span class="keyword">static</span>
00033 ULONG
00034 <a class="code" href="../../d1/d6/axp64_2physsect_8c.html#a3">MaximumAlignment</a>( ULONG );
00035 
00036 <span class="keyword">static</span>
00037 ULONG
00038 <a class="code" href="../../d1/d6/axp64_2physsect_8c.html#a4">AggregatePages</a>( <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>, ULONG, ULONG, PULONG );
00039 
00040 
00041 
00042 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00043"></a><a class="code" href="../../d4/d8/mi_8h.html#a913">00043</a> <a class="code" href="../../d4/d8/mi_8h.html#a913">MiMapViewOfPhysicalSection</a> (
00044     IN <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea,
00045     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00046     IN PVOID *CapturedBase,
00047     IN PLARGE_INTEGER SectionOffset,
00048     IN PSIZE_T CapturedViewSize,
00049     IN ULONG ProtectionMask,
00050     IN ULONG_PTR ZeroBits,
00051     IN ULONG AllocationType,
00052     IN BOOLEAN WriteCombined,
00053     OUT PBOOLEAN ReleasedWsMutex
00054     )
00055 
00056 <span class="comment">/*++</span>
00057 <span class="comment"></span>
00058 <span class="comment">Routine Description:</span>
00059 <span class="comment"></span>
00060 <span class="comment">    This routine maps the specified physical section into the</span>
00061 <span class="comment">    specified process's address space.</span>
00062 <span class="comment"></span>
00063 <span class="comment">Arguments:</span>
00064 <span class="comment"></span>
00065 <span class="comment">    see MmMapViewOfSection above...</span>
00066 <span class="comment"></span>
00067 <span class="comment">    ControlArea - Supplies the control area for the section.</span>
00068 <span class="comment"></span>
00069 <span class="comment">    Process - Supplies the process pointer which is receiving the section.</span>
00070 <span class="comment"></span>
00071 <span class="comment">    ProtectionMask - Supplies the initial page protection-mask.</span>
00072 <span class="comment"></span>
00073 <span class="comment">    ReleasedWsMutex - Supplies FALSE, receives TRUE if the working set</span>
00074 <span class="comment">                      mutex is released.</span>
00075 <span class="comment"></span>
00076 <span class="comment">Return Value:</span>
00077 <span class="comment"></span>
00078 <span class="comment">    Status of the map view operation.</span>
00079 <span class="comment"></span>
00080 <span class="comment">Environment:</span>
00081 <span class="comment"></span>
00082 <span class="comment">    Kernel Mode, working set mutex and address creation mutex held.</span>
00083 <span class="comment"></span>
00084 <span class="comment">--*/</span>
00085 
00086 {
00087     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
00088     PVOID StartingAddress;
00089     PVOID EndingAddress;
00090     KIRQL OldIrql;
00091     KIRQL OldIrql2;
00092     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00093     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00094     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00095     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
00096     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00097     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
00098     ULONG PhysicalViewSize;
00099     ULONG Alignment;
00100     ULONG PagesToMap;
00101     ULONG NextPfn;
00102     PVOID UsedPageTableHandle;
00103     PVOID UsedPageDirectoryHandle;
00104     <a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">PMI_PHYSICAL_VIEW</a> PhysicalView;
00105 
00106     <span class="comment">//</span>
00107     <span class="comment">// Physical memory section.</span>
00108     <span class="comment">//</span>
00109 
00110 <span class="preprocessor">#ifdef FIRSTDBG</span>
00111 <span class="preprocessor"></span>
00112     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Physsect CaptureBase = %x  SectionOffset = %x\n"</span>,
00113               CapturedBase, SectionOffset-&gt;LowPart );
00114     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Physsect Allocation Type = %x, MEM_LARGE_PAGES = %x\n"</span>,
00115               AllocationType, MEM_LARGE_PAGES );
00116 
00117 <span class="preprocessor">#endif //FIRSTDBG</span>
00118 <span class="preprocessor"></span>
00119     <span class="comment">//</span>
00120     <span class="comment">// Compute the alignment we require for the virtual mapping.</span>
00121     <span class="comment">// The default is 64K to match protection boundaries.</span>
00122     <span class="comment">// Larger page sizes are used if MEM_LARGE_PAGES is requested.</span>
00123     <span class="comment">// The Alpha AXP architecture supports granularity hints so that</span>
00124     <span class="comment">// larger pages can be defined in the following multiples of</span>
00125     <span class="comment">// PAGE_SIZE:</span>
00126     <span class="comment">//            8**(GH) * PAGE_SIZE, where GH element of {0,1,2,3}</span>
00127     <span class="comment">//</span>
00128 
00129     Alignment = <a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a>;
00130 
00131     <span class="keywordflow">if</span>( AllocationType &amp; MEM_LARGE_PAGES ){
00132 
00133         <span class="comment">//</span>
00134         <span class="comment">// MaxAlignment is the maximum boundary alignment of the</span>
00135         <span class="comment">// SectionOffset (where the maximum boundary is one of the possible</span>
00136         <span class="comment">//                granularity hints boundaries)</span>
00137         <span class="comment">//</span>
00138 
00139         ULONG MaxAlignment = <a class="code" href="../../d1/d6/axp64_2physsect_8c.html#a3">MaximumAlignment</a>( SectionOffset-&gt;LowPart );
00140 
00141         Alignment = (MaxAlignment &gt; Alignment) ? MaxAlignment : Alignment;
00142 
00143 <span class="preprocessor">#ifdef FIRSTDBG</span>
00144 <span class="preprocessor"></span>
00145         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Alignment = %x, SectionOffset = %x\n"</span>,
00146                        Alignment, SectionOffset-&gt;LowPart );
00147 
00148 <span class="preprocessor">#endif //FIRSTDBG</span>
00149 <span class="preprocessor"></span>
00150     }
00151 
00152 
00153     <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
00154 
00155     <span class="keywordflow">if</span> (*CapturedBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00156 
00157         <span class="comment">//</span>
00158         <span class="comment">// Attempt to locate address space.  This could raise an</span>
00159         <span class="comment">// exception.</span>
00160         <span class="comment">//</span>
00161 
00162         <span class="keywordflow">try</span> {
00163 
00164             <span class="comment">//</span>
00165             <span class="comment">// Find a starting address on an alignment boundary.</span>
00166             <span class="comment">//</span>
00167 
00168 
00169             PhysicalViewSize = (SectionOffset-&gt;LowPart + *CapturedViewSize) -
00170                                (ULONG)<a class="code" href="../../d4/d8/mi_8h.html#a91">MI_64K_ALIGN</a>(SectionOffset-&gt;LowPart);
00171             StartingAddress = <a class="code" href="../../d6/d3/vadtree_8c.html#a3">MiFindEmptyAddressRange</a> (PhysicalViewSize,
00172                                                        Alignment,
00173                                                        (ULONG)ZeroBits);
00174 
00175         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00176 
00177             <span class="keywordflow">return</span> GetExceptionCode();
00178         }
00179 
00180         EndingAddress = (PVOID)(((ULONG)StartingAddress +
00181                                 PhysicalViewSize - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>));
00182         StartingAddress = (PVOID)((ULONG)StartingAddress +
00183                                      (SectionOffset-&gt;LowPart &amp; (<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a> - 1)));
00184 
00185         <span class="keywordflow">if</span> (ZeroBits &gt; 0) {
00186             <span class="keywordflow">if</span> (EndingAddress &gt; (PVOID)((ULONG)0xFFFFFFFF &gt;&gt; ZeroBits)) {
00187                 <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00188             }
00189         }
00190 
00191     } <span class="keywordflow">else</span> {
00192 
00193         <span class="comment">//</span>
00194         <span class="comment">// Check to make sure the specified base address to ending address</span>
00195         <span class="comment">// is currently unused.</span>
00196         <span class="comment">//</span>
00197 
00198         PhysicalViewSize = (SectionOffset-&gt;LowPart + *CapturedViewSize) -
00199                                 (ULONG)<a class="code" href="../../d4/d8/mi_8h.html#a91">MI_64K_ALIGN</a>(SectionOffset-&gt;LowPart);
00200         StartingAddress = (PVOID)((ULONG)<a class="code" href="../../d4/d8/mi_8h.html#a91">MI_64K_ALIGN</a>(*CapturedBase) +
00201                                     (SectionOffset-&gt;LowPart &amp; (<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a> - 1)));
00202         EndingAddress = (PVOID)(((ULONG)StartingAddress +
00203                                 *CapturedViewSize - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>));
00204 
00205         Vad = <a class="code" href="../../d4/d8/mi_8h.html#a98">MiCheckForConflictingVad</a> (StartingAddress, EndingAddress);
00206         <span class="keywordflow">if</span> (Vad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00207 <span class="preprocessor">#if 0</span>
00208 <span class="preprocessor"></span>            MiDumpConflictingVad (StartingAddress, EndingAddress, Vad);
00209 <span class="preprocessor">#endif</span>
00210 <span class="preprocessor"></span>
00211             <span class="keywordflow">return</span> STATUS_CONFLICTING_ADDRESSES;
00212         }
00213     }
00214 
00215     <span class="comment">//</span>
00216     <span class="comment">// An unoccuppied address range has been found, build the virtual</span>
00217     <span class="comment">// address descriptor to describe this range.</span>
00218     <span class="comment">//</span>
00219 
00220     <span class="comment">//</span>
00221     <span class="comment">// Establish an exception handler and attempt to allocate</span>
00222     <span class="comment">// the pool and charge quota.  Note that the InsertVad routine</span>
00223     <span class="comment">// will also charge quota which could raise an exception.</span>
00224     <span class="comment">//</span>
00225 
00226     <span class="keywordflow">try</span>  {
00227 
00228         PhysicalView = (<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">PMI_PHYSICAL_VIEW</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00229                                                                  <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">MI_PHYSICAL_VIEW</a>),
00230                                                                  <a class="code" href="../../d4/d8/mi_8h.html#a231">MI_PHYSICAL_VIEW_KEY</a>);
00231         <span class="keywordflow">if</span> (PhysicalView == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00232             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INSUFFICIENT_RESOURCES);
00233         }
00234 
00235         Vad = (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d6/struct__MMVAD.html">MMVAD</a>), ' daV');
00236         <span class="keywordflow">if</span> (Vad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00237             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INSUFFICIENT_RESOURCES);
00238         }
00239 
00240         PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o1">Vad</a> = Vad;
00241         PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o2">StartVa</a> = StartingAddress;
00242         PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o3">EndVa</a> = EndingAddress;
00243 
00244         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a> = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (StartingAddress);
00245         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a> = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndingAddress);
00246         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a> = ControlArea;
00247         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.LongFlags = 0;
00248         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.Inherit = ViewUnmap;
00249         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PhysicalMapping = 1;
00250         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o19">u4</a>.Banked = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00251         <span class="comment">// Vad-&gt;u.VadFlags.ImageMap = 0;</span>
00252         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection = ProtectionMask;
00253         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.CopyOnWrite = 0;
00254         <span class="comment">// Vad-&gt;u.VadFlags.LargePages = 0;</span>
00255         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o9">FirstPrototypePte</a> =
00256                        (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a180">MI_CONVERT_PHYSICAL_BUS_TO_PFN</a>(*SectionOffset));
00257 
00258         <span class="comment">//</span>
00259         <span class="comment">// Set the first prototype PTE field in the Vad.</span>
00260         <span class="comment">//</span>
00261 
00262         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o10">LastContiguousPte</a> =
00263                        (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a180">MI_CONVERT_PHYSICAL_BUS_TO_PFN</a>(*SectionOffset));
00264 
00265         <span class="comment">//</span>
00266         <span class="comment">// Insert the VAD.  This could get an exception.</span>
00267         <span class="comment">//</span>
00268 
00269         <a class="code" href="../../d6/d3/vadtree_8c.html#a0">MiInsertVad</a> (Vad);
00270 
00271     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00272 
00273         <span class="keywordflow">if</span> (PhysicalView != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00274             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (PhysicalView);
00275         }
00276 
00277         <span class="keywordflow">if</span> (Vad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00278 
00279             <span class="comment">//</span>
00280             <span class="comment">// The pool allocation suceeded, but the quota charge</span>
00281             <span class="comment">// in InsertVad failed, deallocate the pool and return</span>
00282             <span class="comment">// an error.</span>
00283             <span class="comment">//</span>
00284 
00285             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Vad);
00286             <span class="keywordflow">return</span> GetExceptionCode();
00287         }
00288         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00289     }
00290 
00291     <span class="comment">// Increment the count of the number of views for the</span>
00292     <span class="comment">// section object.  This requires the PFN mutex to be held.</span>
00293     <span class="comment">//</span>
00294 
00295     <a class="code" href="../../d4/d8/mi_8h.html#a133">LOCK_AWE</a> (Process, OldIrql);
00296     <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql2);
00297 
00298     InsertHeadList (&amp;Process-&gt;PhysicalVadList, &amp;PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o0">ListEntry</a>);
00299 
00300     ControlArea-&gt;NumberOfMappedViews += 1;
00301     ControlArea-&gt;NumberOfUserReferences += 1;
00302     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;NumberOfSectionReferences != 0);
00303 
00304     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql2);
00305     <a class="code" href="../../d4/d8/mi_8h.html#a134">UNLOCK_AWE</a> (Process, OldIrql);
00306 
00307     <span class="comment">//</span>
00308     <span class="comment">// Build the PTEs in the address space.</span>
00309     <span class="comment">//</span>
00310 
00311     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (StartingAddress);
00312     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (StartingAddress);
00313     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (StartingAddress);
00314     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (EndingAddress);
00315 
00316 <span class="preprocessor">#if defined (_WIN64)</span>
00317 <span class="preprocessor"></span>    <a class="code" href="../../d4/d8/mi_8h.html#a245">MiMakePpeExistAndMakeValid</a> (PointerPpe, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00318     <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
00319         UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
00320         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a181">MI_GET_USED_PTES_FROM_HANDLE</a> (UsedPageDirectoryHandle) == 0); 
00321         <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
00322     }
00323 <span class="preprocessor">#endif</span>
00324 <span class="preprocessor"></span>
00325     <a class="code" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a>(PointerPde, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00326 
00327     Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
00328 
00329     PagesToMap = ( ((ULONG)EndingAddress - (ULONG)StartingAddress)
00330                    + (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>-1) ) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00331 
00332     NextPfn = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a180">MI_CONVERT_PHYSICAL_BUS_TO_PFN</a>(*SectionOffset);
00333 
00334 <span class="preprocessor">#ifdef FIRSTDBG</span>
00335 <span class="preprocessor"></span>
00336     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Physsect, PagesToMap = %x  NextPfn = %x\n"</span>,
00337                    PagesToMap, NextPfn );
00338 
00339 <span class="preprocessor">#endif //FIRSTDBG</span>
00340 <span class="preprocessor"></span>
00341     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
00342                        NextPfn,
00343                        ProtectionMask,
00344                        PointerPte);
00345 
00346     <span class="keywordflow">if</span> (WriteCombined == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00347         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a111">MI_SET_PTE_WRITE_COMBINE</a> (TempPte);
00348     }
00349 
00350     <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write) {
00351             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Dirty = 1;
00352     }
00353     
00354     <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
00355 
00356         ULONG PagesTogether;
00357         ULONG GranularityHint;
00358 
00359         <span class="comment">//</span>
00360         <span class="comment">// Compute the number of pages that can be mapped together</span>
00361         <span class="comment">//</span>
00362 
00363         <span class="keywordflow">if</span> (AllocationType &amp; MEM_LARGE_PAGES) {
00364             PagesTogether = <a class="code" href="../../d1/d6/axp64_2physsect_8c.html#a4">AggregatePages</a> (PointerPte,
00365                                             NextPfn,
00366                                             PagesToMap,
00367                                             &amp;GranularityHint);
00368         } <span class="keywordflow">else</span> {
00369             PagesTogether = 1;
00370             GranularityHint = 0;
00371         }
00372 
00373 <span class="preprocessor">#ifdef FIRSTDBG</span>
00374 <span class="preprocessor"></span>
00375         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Physsect  PointerPte = %x, NextPfn = %x\n"</span>,
00376                        PointerPte, NextPfn );
00377         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Va = %x  TempPte.Pfn = %x\n"</span>,
00378                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>( PointerPte ),
00379                        TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber );
00380         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: PagesToMap = %x\n"</span>, PagesToMap );
00381         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: PagesTogether = %x, GH = %x\n"</span>,
00382                        PagesTogether, GranularityHint );
00383 
00384 <span class="preprocessor">#endif //FIRSTDBG</span>
00385 <span class="preprocessor"></span>
00386         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.GranularityHint = GranularityHint;
00387 
00388         NextPfn += PagesTogether;
00389         PagesToMap -= PagesTogether;
00390 
00391         UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte));
00392 
00393         <span class="keywordflow">while</span> (PagesTogether--) {
00394 
00395             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPte)) {
00396 
00397                 PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
00398 
00399                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a166">MiIsPteOnPpeBoundary</a> (PointerPte)) {
00400                     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
00401                     <a class="code" href="../../d4/d8/mi_8h.html#a245">MiMakePpeExistAndMakeValid</a> (PointerPpe, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00402                     <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
00403                         UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
00404                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a181">MI_GET_USED_PTES_FROM_HANDLE</a> (UsedPageDirectoryHandle) == 0); 
00405                 
00406                         <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
00407                     }
00408                 }
00409 
00410                 <a class="code" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a> (PointerPde, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00411                 Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
00412                 UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte));
00413             }
00414 
00415             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PointerPte-&gt;u.Long == 0 );
00416 
00417             *PointerPte = TempPte;
00418 <span class="preprocessor">#if PFN_CONSISTENCY</span>
00419 <span class="preprocessor"></span>            <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00420 <span class="preprocessor">#endif</span>
00421 <span class="preprocessor"></span>            Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
00422 <span class="preprocessor">#if PFN_CONSISTENCY</span>
00423 <span class="preprocessor"></span>            <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00424 <span class="preprocessor">#endif</span>
00425 <span class="preprocessor"></span>
00426             <span class="comment">//</span>
00427             <span class="comment">// Increment the count of non-zero page table entries for this</span>
00428             <span class="comment">// page table and the number of private pages for the process.</span>
00429             <span class="comment">//</span>
00430 
00431             <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageTableHandle);
00432 
00433             PointerPte += 1;
00434 
00435             TempPte.u.Hard.PageFrameNumber += 1;
00436 
00437         } <span class="comment">// while (PagesTogether-- )</span>
00438 
00439     }  <span class="comment">// while (PointerPte &lt;= LastPte)</span>
00440 
00441     <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
00442     *ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00443 
00444     <span class="comment">//</span>
00445     <span class="comment">// Update the current virtual size in the process header.</span>
00446     <span class="comment">//</span>
00447 
00448     *CapturedViewSize = (ULONG)EndingAddress - (ULONG)StartingAddress + 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00449     Process-&gt;VirtualSize += *CapturedViewSize;
00450 
00451     <span class="keywordflow">if</span> (Process-&gt;VirtualSize &gt; Process-&gt;PeakVirtualSize) {
00452         Process-&gt;PeakVirtualSize = Process-&gt;VirtualSize;
00453     }
00454 
00455     <span class="comment">//</span>
00456     <span class="comment">// Translate the virtual address to a quasi-virtual address for</span>
00457     <span class="comment">// use by drivers that touch mapped devices.  Note: the routine</span>
00458     <span class="comment">// HalCreateQva will not translate the StartingAddress if the</span>
00459     <span class="comment">// StartingAddress is within system memory address space.</span>
00460     <span class="comment">//</span>
00461     <span class="comment">// N.B. - It will not work to attempt map addresses that begin in</span>
00462     <span class="comment">// system memory and extend through i/o space.</span>
00463     <span class="comment">//</span>
00464 
00465     *CapturedBase = HalCreateQva( *SectionOffset, StartingAddress );
00466 
00467     <span class="keywordflow">return</span> STATUS_SUCCESS;
00468 }
00469 
00470 
00471 ULONG
<a name="l00472"></a><a class="code" href="../../d0/d6/alpha_2physsect_8c.html#a3">00472</a> <a class="code" href="../../d1/d6/axp64_2physsect_8c.html#a3">MaximumAlignment</a>(
00473     IN ULONG Offset
00474     )
00475 <span class="comment">/*++</span>
00476 <span class="comment"></span>
00477 <span class="comment">Routine Description:</span>
00478 <span class="comment"></span>
00479 <span class="comment">    This routine returns the maximum granularity hint alignment boundary</span>
00480 <span class="comment">    to which Offset is naturally aligned.</span>
00481 <span class="comment"></span>
00482 <span class="comment">Arguments:</span>
00483 <span class="comment"></span>
00484 <span class="comment">    Offset - Supplies the address offset to check for alignment.</span>
00485 <span class="comment"></span>
00486 <span class="comment">Return Value:</span>
00487 <span class="comment"></span>
00488 <span class="comment">    The number which represents the largest natural alignment of Offset.</span>
00489 <span class="comment"></span>
00490 <span class="comment">Environment:</span>
00491 <span class="comment"></span>
00492 <span class="comment">--*/</span>
00493 {
00494 
00495     <span class="keywordflow">if</span>( (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &amp; (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a37">GH3_PAGE_SIZE</a> - 1)) == 0 ){
00496         <span class="keywordflow">return</span> <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a37">GH3_PAGE_SIZE</a>;
00497     }
00498 
00499     <span class="keywordflow">if</span>( (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &amp; (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a39">GH2_PAGE_SIZE</a> - 1)) == 0 ){
00500         <span class="keywordflow">return</span> <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a39">GH2_PAGE_SIZE</a>;
00501     }
00502 
00503     <span class="keywordflow">if</span>( (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &amp; (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a41">GH1_PAGE_SIZE</a> - 1)) == 0 ){
00504         <span class="keywordflow">return</span> <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a41">GH1_PAGE_SIZE</a>;
00505     }
00506 
00507     <span class="keywordflow">if</span>( (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) == 0 ){
00508         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00509     }
00510 
00511     <span class="keywordflow">return</span> 0;
00512 }
00513 
00514 
00515 ULONG
<a name="l00516"></a><a class="code" href="../../d0/d6/alpha_2physsect_8c.html#a4">00516</a> <a class="code" href="../../d1/d6/axp64_2physsect_8c.html#a4">AggregatePages</a>(
00517     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>  PointerPte,
00518     IN ULONG   Pfn,
00519     IN ULONG   Pages,
00520     OUT PULONG GranularityHint
00521     )
00522 <span class="comment">/*++</span>
00523 <span class="comment"></span>
00524 <span class="comment">Routine Description:</span>
00525 <span class="comment"></span>
00526 <span class="comment">    This routine computes the number of standard size pages that can be</span>
00527 <span class="comment">    aggregated into a single large page and returns the granularity hint</span>
00528 <span class="comment">    for that size large page.</span>
00529 <span class="comment"></span>
00530 <span class="comment">Arguments:</span>
00531 <span class="comment"></span>
00532 <span class="comment">    PointerPte - Supplies the PTE pointer for the starting virtual address</span>
00533 <span class="comment">                     of the mapping.</span>
00534 <span class="comment">    Pfn - Supplies the starting page frame number of the memory to be</span>
00535 <span class="comment">                     mapped.</span>
00536 <span class="comment">    Pages - Supplies the number of pages to map.</span>
00537 <span class="comment"></span>
00538 <span class="comment">    GranularityHint - Receives the granularity hint for the large page used</span>
00539 <span class="comment">                         to aggregate the standard pages.</span>
00540 <span class="comment"></span>
00541 <span class="comment">Return Value:</span>
00542 <span class="comment"></span>
00543 <span class="comment">    The number of pages that can be aggregated together.</span>
00544 <span class="comment"></span>
00545 <span class="comment">Environment:</span>
00546 <span class="comment"></span>
00547 <span class="comment">--*/</span>
00548 {
00549 
00550     ULONG MaxVirtualAlignment;
00551     ULONG MaxPhysicalAlignment;
00552     ULONG MaxPageAlignment;
00553     ULONG MaxAlignment;
00554 
00555     <span class="comment">//</span>
00556     <span class="comment">// Determine the largest page that will map a maximum of Pages.</span>
00557     <span class="comment">// The largest page must be both virtually and physically aligned</span>
00558     <span class="comment">// to the large page size boundary.</span>
00559     <span class="comment">// Determine the largest common alignment for the virtual and</span>
00560     <span class="comment">// physical addresses, factor in Pages, and then match to the</span>
00561     <span class="comment">// largest page size possible via the granularity hints.</span>
00562     <span class="comment">//</span>
00563 
00564     MaxVirtualAlignment = <a class="code" href="../../d1/d6/axp64_2physsect_8c.html#a3">MaximumAlignment</a>((ULONG)
00565                               <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>( PointerPte ) );
00566     MaxPhysicalAlignment = <a class="code" href="../../d1/d6/axp64_2physsect_8c.html#a3">MaximumAlignment</a>( (ULONG)(Pfn &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) );
00567 
00568     MaxPageAlignment = (ULONG)(Pages &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00569 
00570 <span class="preprocessor">#ifdef AGGREGATE_DBG</span>
00571 <span class="preprocessor"></span>
00572     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Aggregate MaxVirtualAlign = %x\n"</span>, MaxVirtualAlignment );
00573     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Aggregate MaxPhysicalAlign = %x\n"</span>, MaxPhysicalAlignment );
00574     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Aggregate MaxPageAlign = %x\n"</span>, MaxPageAlignment );
00575 
00576 <span class="preprocessor">#endif //AGGREGATE_DBG</span>
00577 <span class="preprocessor"></span>    <span class="comment">//</span>
00578     <span class="comment">// Maximum alignment is the minimum of the virtual and physical alignments.</span>
00579     <span class="comment">//</span>
00580 
00581     MaxAlignment =  (MaxVirtualAlignment &gt; MaxPhysicalAlignment) ?
00582                         MaxPhysicalAlignment : MaxVirtualAlignment;
00583     MaxAlignment = (MaxAlignment &gt; MaxPageAlignment) ?
00584                         MaxPageAlignment : MaxAlignment;
00585 
00586     <span class="comment">//</span>
00587     <span class="comment">// Convert MaxAlignment to granularity hint value</span>
00588     <span class="comment">//</span>
00589 
00590     <span class="keywordflow">if</span>( (MaxAlignment &amp; (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a37">GH3_PAGE_SIZE</a> - 1)) == 0 ){
00591 
00592         *GranularityHint = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a36">GH3</a>;
00593 
00594     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( (MaxAlignment &amp; (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a39">GH2_PAGE_SIZE</a> - 1)) == 0 ){
00595 
00596         *GranularityHint = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a38">GH2</a>;
00597 
00598     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( (MaxAlignment &amp; (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a41">GH1_PAGE_SIZE</a> - 1)) == 0 ){
00599 
00600         *GranularityHint = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a40">GH1</a>;
00601 
00602     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( (MaxAlignment &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) == 0 ){
00603 
00604         *GranularityHint = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a42">GH0</a>;
00605 
00606     } <span class="keywordflow">else</span> {
00607 
00608         *GranularityHint = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a42">GH0</a>;
00609 
00610 <span class="preprocessor">#if DBG</span>
00611 <span class="preprocessor"></span>
00612         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Aggregate Physical pages - not page aligned\n"</span> );
00613 
00614 <span class="preprocessor">#endif //DBG</span>
00615 <span class="preprocessor"></span>
00616     } <span class="comment">// end, if then elseif</span>
00617 
00618     <span class="comment">//</span>
00619     <span class="comment">// Return number of pages aggregated.</span>
00620     <span class="comment">//</span>
00621 
00622     <span class="keywordflow">return</span>( MaxAlignment &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> );
00623 
00624 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:09 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
