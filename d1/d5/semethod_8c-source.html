<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: semethod.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>semethod.c</h1><a href="../../d0/d6/semethod_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    Semethod.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This Module implements the SeDefaultObjectMethod procedure.  This</span>
00012 <span class="comment">    procedure and SeAssignSecurity are the only two procedures that will</span>
00013 <span class="comment">    place a security descriptor on an object.  Therefore they must understand</span>
00014 <span class="comment">    and agree on how a descriptor is allocated from pool so that they can</span>
00015 <span class="comment">    deallocate and reallocate pool as necessary. Any security descriptor</span>
00016 <span class="comment">    that is attached to an object by these procedures has the following</span>
00017 <span class="comment">    pool allocation plan.</span>
00018 <span class="comment"></span>
00019 <span class="comment">    1. if the objects security descriptor is null then there is no pool</span>
00020 <span class="comment">       allocated</span>
00021 <span class="comment"></span>
00022 <span class="comment">    2. otherwise there is at least one pool allocation for the security</span>
00023 <span class="comment">       descriptor header.  if it's acl fields are null then there are no</span>
00024 <span class="comment">       other pool allocations (this should never happen).</span>
00025 <span class="comment"></span>
00026 <span class="comment">    3. There is a separate pool allocation for each acl in the descriptor.</span>
00027 <span class="comment">       So a maximum of three pool allocations can occur for each attached</span>
00028 <span class="comment">       security descriptor.</span>
00029 <span class="comment"></span>
00030 <span class="comment">    4  Everytime an acl is replace in a descriptor we see if we can use</span>
00031 <span class="comment">       the old acl and if so then we try and keep the acl size as large</span>
00032 <span class="comment">       as possible.</span>
00033 <span class="comment"></span>
00034 <span class="comment">    Note that this is different from the algorithm used to capture</span>
00035 <span class="comment">    a security descriptor (which puts everything in one pool allocation).</span>
00036 <span class="comment">    Also note that this can be easily optimized at a later time (if necessary)</span>
00037 <span class="comment">    to use only one allocation.</span>
00038 <span class="comment"></span>
00039 <span class="comment"></span>
00040 <span class="comment"></span>
00041 <span class="comment">Author:</span>
00042 <span class="comment"></span>
00043 <span class="comment">    Gary Kimura     (GaryKi)    9-Nov-1989</span>
00044 <span class="comment">    Jim Kelly       (JimK)     10-May-1990</span>
00045 <span class="comment"></span>
00046 <span class="comment">Environment:</span>
00047 <span class="comment"></span>
00048 <span class="comment">    Kernel Mode</span>
00049 <span class="comment"></span>
00050 <span class="comment">Revision History:</span>
00051 <span class="comment"></span>
00052 <span class="comment"></span>
00053 <span class="comment">--*/</span>
00054 
00055 <span class="preprocessor">#include "<a class="code" href="../../d6/d6/sep_8h.html">sep.h</a>"</span>
00056 <span class="preprocessor">#include "sertlp.h"</span>
00057 
00058 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00059 <a class="code" href="../../d0/d6/semethod_8c.html#a0">SepDefaultDeleteMethod</a> (
00060     IN OUT PSECURITY_DESCRIPTOR *ObjectsSecurityDescriptor
00061     );
00062 
00063 
00064 
00065 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00066 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeSetSecurityAccessMask)</span>
00067 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeQuerySecurityAccessMask)</span>
00068 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeDefaultObjectMethod)</span>
00069 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeSetSecurityDescriptorInfo)</span>
00070 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeQuerySecurityDescriptorInfo)</span>
00071 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepDefaultDeleteMethod)</span>
00072 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00073 <span class="preprocessor"></span>
00074 
00075 
00076 
00077 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00078"></a><a class="code" href="../../d0/d6/semethod_8c.html#a1">00078</a> <a class="code" href="../../d0/d6/semethod_8c.html#a1">SeSetSecurityAccessMask</a>(
00079     IN SECURITY_INFORMATION SecurityInformation,
00080     OUT PACCESS_MASK DesiredAccess
00081     )
00082 
00083 <span class="comment">/*++</span>
00084 <span class="comment"></span>
00085 <span class="comment">Routine Description:</span>
00086 <span class="comment"></span>
00087 <span class="comment">    This routine builds an access mask representing the accesses necessary</span>
00088 <span class="comment">    to set the object security information specified in the SecurityInformation</span>
00089 <span class="comment">    parameter.  While it is not difficult to determine this information,</span>
00090 <span class="comment">    the use of a single routine to generate it will ensure minimal impact</span>
00091 <span class="comment">    when the security information associated with an object is extended in</span>
00092 <span class="comment">    the future (to include mandatory access control information).</span>
00093 <span class="comment"></span>
00094 <span class="comment">Arguments:</span>
00095 <span class="comment"></span>
00096 <span class="comment">    SecurityInformation - Identifies the object's security information to be</span>
00097 <span class="comment">        modified.</span>
00098 <span class="comment"></span>
00099 <span class="comment">    DesiredAccess - Points to an access mask to be set to represent the</span>
00100 <span class="comment">        accesses necessary to modify the information specified in the</span>
00101 <span class="comment">        SecurityInformation parameter.</span>
00102 <span class="comment"></span>
00103 <span class="comment">Return Value:</span>
00104 <span class="comment"></span>
00105 <span class="comment">    None.</span>
00106 <span class="comment"></span>
00107 <span class="comment">--*/</span>
00108 
00109 {
00110 
00111     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00112 
00113     <span class="comment">//</span>
00114     <span class="comment">// Figure out accesses needed to perform the indicated operation(s).</span>
00115     <span class="comment">//</span>
00116 
00117     (*DesiredAccess) = 0;
00118 
00119     <span class="keywordflow">if</span> ((SecurityInformation &amp; OWNER_SECURITY_INFORMATION) ||
00120         (SecurityInformation &amp; GROUP_SECURITY_INFORMATION)   ) {
00121         (*DesiredAccess) |= WRITE_OWNER;
00122     }
00123 
00124     <span class="keywordflow">if</span> (SecurityInformation &amp; DACL_SECURITY_INFORMATION) {
00125         (*DesiredAccess) |= WRITE_DAC;
00126     }
00127 
00128     <span class="keywordflow">if</span> (SecurityInformation &amp; SACL_SECURITY_INFORMATION) {
00129         (*DesiredAccess) |= ACCESS_SYSTEM_SECURITY;
00130     }
00131 
00132     <span class="keywordflow">return</span>;
00133 
00134 }
00135 
00136 
00137 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00138"></a><a class="code" href="../../d0/d6/semethod_8c.html#a2">00138</a> <a class="code" href="../../d0/d6/semethod_8c.html#a2">SeQuerySecurityAccessMask</a>(
00139     IN SECURITY_INFORMATION SecurityInformation,
00140     OUT PACCESS_MASK DesiredAccess
00141     )
00142 
00143 <span class="comment">/*++</span>
00144 <span class="comment"></span>
00145 <span class="comment">Routine Description:</span>
00146 <span class="comment"></span>
00147 <span class="comment">    This routine builds an access mask representing the accesses necessary</span>
00148 <span class="comment">    to query the object security information specified in the</span>
00149 <span class="comment">    SecurityInformation parameter.  While it is not difficult to determine</span>
00150 <span class="comment">    this information, the use of a single routine to generate it will ensure</span>
00151 <span class="comment">    minimal impact when the security information associated with an object is</span>
00152 <span class="comment">    extended in the future (to include mandatory access control information).</span>
00153 <span class="comment"></span>
00154 <span class="comment">Arguments:</span>
00155 <span class="comment"></span>
00156 <span class="comment">    SecurityInformation - Identifies the object's security information to be</span>
00157 <span class="comment">        queried.</span>
00158 <span class="comment"></span>
00159 <span class="comment">    DesiredAccess - Points to an access mask to be set to represent the</span>
00160 <span class="comment">        accesses necessary to query the information specified in the</span>
00161 <span class="comment">        SecurityInformation parameter.</span>
00162 <span class="comment"></span>
00163 <span class="comment">Return Value:</span>
00164 <span class="comment"></span>
00165 <span class="comment">    None.</span>
00166 <span class="comment"></span>
00167 <span class="comment">--*/</span>
00168 
00169 {
00170     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00171 
00172     <span class="comment">//</span>
00173     <span class="comment">// Figure out accesses needed to perform the indicated operation(s).</span>
00174     <span class="comment">//</span>
00175 
00176     (*DesiredAccess) = 0;
00177 
00178     <span class="keywordflow">if</span> ((SecurityInformation &amp; OWNER_SECURITY_INFORMATION) ||
00179         (SecurityInformation &amp; GROUP_SECURITY_INFORMATION) ||
00180         (SecurityInformation &amp; DACL_SECURITY_INFORMATION)) {
00181         (*DesiredAccess) |= READ_CONTROL;
00182     }
00183 
00184     <span class="keywordflow">if</span> ((SecurityInformation &amp; SACL_SECURITY_INFORMATION)) {
00185         (*DesiredAccess) |= ACCESS_SYSTEM_SECURITY;
00186     }
00187 
00188     <span class="keywordflow">return</span>;
00189 
00190 }
00191 
00192 
00193 
00194 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00195"></a><a class="code" href="../../d0/d6/semethod_8c.html#a3">00195</a> <a class="code" href="../../d0/d6/semethod_8c.html#a3">SeDefaultObjectMethod</a> (
00196     IN PVOID Object,
00197     IN SECURITY_OPERATION_CODE OperationCode,
00198     IN PSECURITY_INFORMATION SecurityInformation,
00199     IN OUT PSECURITY_DESCRIPTOR SecurityDescriptor,
00200     IN OUT PULONG CapturedLength,
00201     IN OUT PSECURITY_DESCRIPTOR *ObjectsSecurityDescriptor,
00202     IN POOL_TYPE PoolType,
00203     IN PGENERIC_MAPPING GenericMapping
00204     )
00205 
00206 <span class="comment">/*++</span>
00207 <span class="comment"></span>
00208 <span class="comment">Routine Description:</span>
00209 <span class="comment"></span>
00210 <span class="comment">    This is the default security method for objects.  It is responsible</span>
00211 <span class="comment">    for either retrieving, setting, and deleting the security descriptor of</span>
00212 <span class="comment">    an object.  It is not used to assign the original security descriptor</span>
00213 <span class="comment">    to an object (use SeAssignSecurity for that purpose).</span>
00214 <span class="comment"></span>
00215 <span class="comment"></span>
00216 <span class="comment">    IT IS ASSUMED THAT THE OBJECT MANAGER HAS ALREADY DONE THE ACCESS</span>
00217 <span class="comment">    VALIDATIONS NECESSARY TO ALLOW THE REQUESTED OPERATIONS TO BE PERFORMED.</span>
00218 <span class="comment"></span>
00219 <span class="comment">Arguments:</span>
00220 <span class="comment"></span>
00221 <span class="comment">    Object - Supplies a pointer to the object being used.</span>
00222 <span class="comment"></span>
00223 <span class="comment">    OperationCode - Indicates if the operation is for setting, querying, or</span>
00224 <span class="comment">        deleting the object's security descriptor.</span>
00225 <span class="comment"></span>
00226 <span class="comment">    SecurityInformation - Indicates which security information is being</span>
00227 <span class="comment">        queried or set.  This argument is ignored for the delete operation.</span>
00228 <span class="comment"></span>
00229 <span class="comment">    SecurityDescriptor - The meaning of this parameter depends on the</span>
00230 <span class="comment">        OperationCode:</span>
00231 <span class="comment"></span>
00232 <span class="comment">        QuerySecurityDescriptor - For the query operation this supplies the</span>
00233 <span class="comment">            buffer to copy the descriptor into.  The security descriptor is</span>
00234 <span class="comment">            assumed to have been probed up to the size passed in in Length.</span>
00235 <span class="comment">            Since it still points into user space, it must always be</span>
00236 <span class="comment">            accessed in a try clause in case it should suddenly disappear.</span>
00237 <span class="comment"></span>
00238 <span class="comment">        SetSecurityDescriptor - For a set operation this supplies the</span>
00239 <span class="comment">            security descriptor to copy into the object.  The security</span>
00240 <span class="comment">            descriptor must be captured before this routine is called.</span>
00241 <span class="comment"></span>
00242 <span class="comment">        DeleteSecurityDescriptor - It is ignored when deleting a security</span>
00243 <span class="comment">            descriptor.</span>
00244 <span class="comment"></span>
00245 <span class="comment">        AssignSecurityDescriptor - For assign operations this is the</span>
00246 <span class="comment">            security descriptor that will be assigned to the object.</span>
00247 <span class="comment">            It is assumed to be in kernel space, and is therefore not</span>
00248 <span class="comment">            probed or captured.</span>
00249 <span class="comment"></span>
00250 <span class="comment">    CapturedLength - For the query operation this specifies the length, in</span>
00251 <span class="comment">        bytes, of the security descriptor buffer, and upon return contains</span>
00252 <span class="comment">        the number of bytes needed to store the descriptor.  If the length</span>
00253 <span class="comment">        needed is greater than the length supplied the operation will fail.</span>
00254 <span class="comment">        It is ignored in the set and delete operation.</span>
00255 <span class="comment"></span>
00256 <span class="comment">        This parameter is assumed to be captured and probed as appropriate.</span>
00257 <span class="comment"></span>
00258 <span class="comment">    ObjectsSecurityDescriptor - For the Set operation this supplies the address</span>
00259 <span class="comment">        of a pointer to the object's current security descriptor.  This routine</span>
00260 <span class="comment">        will either modify the security descriptor in place or allocate a new</span>
00261 <span class="comment">        security descriptor and use this variable to indicate its new location.</span>
00262 <span class="comment">        For the query operation it simply supplies the security descriptor</span>
00263 <span class="comment">        being queried.  The caller is responsible for freeing the old security</span>
00264 <span class="comment">        descriptor.</span>
00265 <span class="comment"></span>
00266 <span class="comment">    PoolType - For the set operation this specifies the pool type to use if</span>
00267 <span class="comment">        a new security descriptor needs to be allocated.  It is ignored</span>
00268 <span class="comment">        in the query and delete operation.</span>
00269 <span class="comment"></span>
00270 <span class="comment">        the mapping of generic to specific/standard access types for the object</span>
00271 <span class="comment">        being accessed.  This mapping structure is expected to be safe to</span>
00272 <span class="comment">        access (i.e., captured if necessary) prior to be passed to this routine.</span>
00273 <span class="comment"></span>
00274 <span class="comment">Return Value:</span>
00275 <span class="comment"></span>
00276 <span class="comment">    NTSTATUS - STATUS_SUCCESS if the operation is successful and an</span>
00277 <span class="comment">        appropriate error status otherwise.</span>
00278 <span class="comment"></span>
00279 <span class="comment">--*/</span>
00280 
00281 {
00282     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00283 
00284     <span class="comment">//</span>
00285     <span class="comment">// If the object's security descriptor is null, then object is not</span>
00286     <span class="comment">// one that has security information associated with it.  Return</span>
00287     <span class="comment">// an error.</span>
00288     <span class="comment">//</span>
00289 
00290     <span class="comment">//</span>
00291     <span class="comment">//  Make sure the common parts of our input are proper</span>
00292     <span class="comment">//</span>
00293 
00294     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (OperationCode == <a class="code" href="../../d0/d5/se_8h.html#a200a108">SetSecurityDescriptor</a>) ||
00295             (OperationCode == <a class="code" href="../../d0/d5/se_8h.html#a200a109">QuerySecurityDescriptor</a>) ||
00296             (OperationCode == <a class="code" href="../../d0/d5/se_8h.html#a200a111">AssignSecurityDescriptor</a>) ||
00297             (OperationCode == <a class="code" href="../../d0/d5/se_8h.html#a200a110">DeleteSecurityDescriptor</a>) );
00298 
00299     <span class="comment">//</span>
00300     <span class="comment">//  This routine simply cases off of the operation code to decide</span>
00301     <span class="comment">//  which support routine to call</span>
00302     <span class="comment">//</span>
00303 
00304     <span class="keywordflow">switch</span> (OperationCode) {
00305 
00306         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/se_8h.html#a200a108">SetSecurityDescriptor</a>:
00307 
00308         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (PoolType == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) || (PoolType == <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>) );
00309 
00310         <span class="keywordflow">return</span> <a class="code" href="../../d9/d1/obse_8c.html#a13">ObSetSecurityDescriptorInfo</a>( Object,
00311                                             SecurityInformation,
00312                                             SecurityDescriptor,
00313                                             ObjectsSecurityDescriptor,
00314                                             PoolType,
00315                                             GenericMapping
00316                                             );
00317 
00318 
00319 
00320     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/se_8h.html#a200a109">QuerySecurityDescriptor</a>:
00321 
00322         <span class="comment">//</span>
00323         <span class="comment">//  check the rest of our input and call the default query security</span>
00324         <span class="comment">//  method</span>
00325         <span class="comment">//</span>
00326 
00327         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( CapturedLength != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00328 
00329         <span class="keywordflow">return</span> <a class="code" href="../../d9/d1/obse_8c.html#a12">ObQuerySecurityDescriptorInfo</a>( SecurityInformation,
00330                                               SecurityDescriptor,
00331                                               CapturedLength,
00332                                               ObjectsSecurityDescriptor );
00333 
00334     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/se_8h.html#a200a110">DeleteSecurityDescriptor</a>:
00335 
00336         <span class="comment">//</span>
00337         <span class="comment">//  call the default delete security method</span>
00338         <span class="comment">//</span>
00339 
00340         <span class="keywordflow">return</span> <a class="code" href="../../d0/d6/semethod_8c.html#a0">SepDefaultDeleteMethod</a>( ObjectsSecurityDescriptor );
00341 
00342     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/se_8h.html#a200a111">AssignSecurityDescriptor</a>:
00343 
00344         <a class="code" href="../../d9/d1/obse_8c.html#a7">ObAssignObjectSecurityDescriptor</a>( Object, SecurityDescriptor, PoolType );
00345         <span class="keywordflow">return</span>( STATUS_SUCCESS );
00346 
00347     <span class="keywordflow">default</span>:
00348 
00349         <span class="comment">//</span>
00350         <span class="comment">//  Bugcheck on any other operation code,  We won't get here if</span>
00351         <span class="comment">//  the earlier asserts are still checked.</span>
00352         <span class="comment">//</span>
00353 
00354         <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>( SECURITY_SYSTEM );
00355         <span class="keywordflow">return</span>( STATUS_INVALID_PARAMETER );
00356 
00357     }
00358 
00359 }
00360 
00361 
00362 
00363 
00364 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00365"></a><a class="code" href="../../d0/d6/semethod_8c.html#a4">00365</a> <a class="code" href="../../d0/d6/semethod_8c.html#a4">SeSetSecurityDescriptorInfo</a> (
00366     IN PVOID Object OPTIONAL,
00367     IN PSECURITY_INFORMATION SecurityInformation,
00368     IN PSECURITY_DESCRIPTOR ModificationDescriptor,
00369     IN OUT PSECURITY_DESCRIPTOR *ObjectsSecurityDescriptor,
00370     IN POOL_TYPE PoolType,
00371     IN PGENERIC_MAPPING GenericMapping
00372     )
00373 
00374 <span class="comment">/*++</span>
00375 <span class="comment"></span>
00376 <span class="comment">Routine Description:</span>
00377 <span class="comment"></span>
00378 <span class="comment">    This routine will set an object's security descriptor.  The input</span>
00379 <span class="comment">    security descriptor must be previously captured.</span>
00380 <span class="comment"></span>
00381 <span class="comment">Arguments:</span>
00382 <span class="comment"></span>
00383 <span class="comment">    Object - Optionally supplies the object whose security is</span>
00384 <span class="comment">        being adjusted.  This is used to update security quota</span>
00385 <span class="comment">        information.</span>
00386 <span class="comment"></span>
00387 <span class="comment">    SecurityInformation - Indicates which security information is</span>
00388 <span class="comment">        to be applied to the object.  The value(s) to be assigned are</span>
00389 <span class="comment">        passed in the SecurityDescriptor parameter.</span>
00390 <span class="comment"></span>
00391 <span class="comment">    ModificationDescriptor - Supplies the input security descriptor to be</span>
00392 <span class="comment">        applied to the object.  The caller of this routine is expected</span>
00393 <span class="comment">        to probe and capture the passed security descriptor before calling</span>
00394 <span class="comment">        and release it after calling.</span>
00395 <span class="comment"></span>
00396 <span class="comment">    ObjectsSecurityDescriptor - Supplies the address of a pointer to</span>
00397 <span class="comment">        the objects security descriptor that is going to be altered by</span>
00398 <span class="comment">        this procedure.  This structure must be deallocated by the caller.</span>
00399 <span class="comment"></span>
00400 <span class="comment">    PoolType - Specifies the type of pool to allocate for the objects</span>
00401 <span class="comment">        security descriptor.</span>
00402 <span class="comment"></span>
00403 <span class="comment">    GenericMapping - This argument provides the mapping of generic to</span>
00404 <span class="comment">        specific/standard access types for the object being accessed.</span>
00405 <span class="comment">        This mapping structure is expected to be safe to access</span>
00406 <span class="comment">        (i.e., captured if necessary) prior to be passed to this routine.</span>
00407 <span class="comment"></span>
00408 <span class="comment">Return Value:</span>
00409 <span class="comment"></span>
00410 <span class="comment">    NTSTATUS - STATUS_SUCCESS if successful and an appropriate error</span>
00411 <span class="comment">        value otherwise.</span>
00412 <span class="comment"></span>
00413 <span class="comment">--*/</span>
00414 
00415 {
00416 
00417 
00418 
00419     <span class="comment">//</span>
00420     <span class="comment">// Make sure the object already has a security descriptor.</span>
00421     <span class="comment">// Objects that 'may' have security descriptors 'must' have security</span>
00422     <span class="comment">// descriptors.  If this one doesn't already have one, then we can't</span>
00423     <span class="comment">// assign one to it.</span>
00424     <span class="comment">//</span>
00425 
00426     <span class="keywordflow">if</span> ((*ObjectsSecurityDescriptor) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00427         <span class="keywordflow">return</span>(STATUS_NO_SECURITY_ON_OBJECT);
00428     }
00429 
00430 
00431     <span class="comment">//</span>
00432     <span class="comment">// Pass this call to the common Rtlp routine.</span>
00433     <span class="comment">//</span>
00434 
00435     <span class="keywordflow">return</span> <a class="code" href="../../d8/d6/sertl_8c.html#a77">RtlpSetSecurityObject</a> (
00436                     Object,
00437                     *SecurityInformation,
00438                     ModificationDescriptor,
00439                     ObjectsSecurityDescriptor,
00440                     0,  <span class="comment">// No Auto Inheritance</span>
00441                     PoolType,
00442                     GenericMapping,
00443                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ); <span class="comment">// No Token</span>
00444 
00445 
00446 }
00447 
00448 
00449 
00450 
00451 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00452"></a><a class="code" href="../../d0/d6/semethod_8c.html#a5">00452</a> <a class="code" href="../../d0/d6/semethod_8c.html#a5">SeSetSecurityDescriptorInfoEx</a> (
00453     IN PVOID Object OPTIONAL,
00454     IN PSECURITY_INFORMATION SecurityInformation,
00455     IN PSECURITY_DESCRIPTOR ModificationDescriptor,
00456     IN OUT PSECURITY_DESCRIPTOR *ObjectsSecurityDescriptor,
00457     IN ULONG AutoInheritFlags,
00458     IN POOL_TYPE PoolType,
00459     IN PGENERIC_MAPPING GenericMapping
00460     )
00461 
00462 <span class="comment">/*++</span>
00463 <span class="comment"></span>
00464 <span class="comment">Routine Description:</span>
00465 <span class="comment"></span>
00466 <span class="comment">    This routine will set an object's security descriptor.  The input</span>
00467 <span class="comment">    security descriptor must be previously captured.</span>
00468 <span class="comment"></span>
00469 <span class="comment">Arguments:</span>
00470 <span class="comment"></span>
00471 <span class="comment">    Object - Optionally supplies the object whose security is</span>
00472 <span class="comment">        being adjusted.  This is used to update security quota</span>
00473 <span class="comment">        information.</span>
00474 <span class="comment"></span>
00475 <span class="comment">    SecurityInformation - Indicates which security information is</span>
00476 <span class="comment">        to be applied to the object.  The value(s) to be assigned are</span>
00477 <span class="comment">        passed in the SecurityDescriptor parameter.</span>
00478 <span class="comment"></span>
00479 <span class="comment">    ModificationDescriptor - Supplies the input security descriptor to be</span>
00480 <span class="comment">        applied to the object.  The caller of this routine is expected</span>
00481 <span class="comment">        to probe and capture the passed security descriptor before calling</span>
00482 <span class="comment">        and release it after calling.</span>
00483 <span class="comment"></span>
00484 <span class="comment">    ObjectsSecurityDescriptor - Supplies the address of a pointer to</span>
00485 <span class="comment">        the objects security descriptor that is going to be altered by</span>
00486 <span class="comment">        this procedure.  This structure must be deallocated by the caller.</span>
00487 <span class="comment"></span>
00488 <span class="comment">    AutoInheritFlags - Controls automatic inheritance of ACES.</span>
00489 <span class="comment">        Valid values are a bits mask of the logical OR of</span>
00490 <span class="comment">        one or more of the following bits:</span>
00491 <span class="comment"></span>
00492 <span class="comment">        SEF_DACL_AUTO_INHERIT - If set, inherited ACEs from the</span>
00493 <span class="comment">            DACL in the ObjectsSecurityDescriptor are preserved and inherited ACEs from</span>
00494 <span class="comment">            the ModificationDescriptor are ignored. Inherited ACEs are not supposed</span>
00495 <span class="comment">            to be modified; so preserving them across this call is appropriate.</span>
00496 <span class="comment">            If a protected server does not itself implement auto inheritance, it should</span>
00497 <span class="comment">            not set this bit.  The caller of the protected server may implement</span>
00498 <span class="comment">            auto inheritance and my indeed be modifying inherited ACEs.</span>
00499 <span class="comment"></span>
00500 <span class="comment">        SEF_SACL_AUTO_INHERIT - If set, inherited ACEs from the</span>
00501 <span class="comment">            SACL in the ObjectsSecurityDescriptor are preserved and inherited ACEs from</span>
00502 <span class="comment">            the ModificationDescriptor are ignored. Inherited ACEs are not supposed</span>
00503 <span class="comment">            to be modified; so preserving them across this call is appropriate.</span>
00504 <span class="comment">            If a protected server does not itself implement auto inheritance, it should</span>
00505 <span class="comment">            not set this bit.  The caller of the protected server may implement</span>
00506 <span class="comment">            auto inheritance and my indeed be modifying inherited ACEs.</span>
00507 <span class="comment"></span>
00508 <span class="comment">    PoolType - Specifies the type of pool to allocate for the objects</span>
00509 <span class="comment">        security descriptor.</span>
00510 <span class="comment"></span>
00511 <span class="comment">    GenericMapping - This argument provides the mapping of generic to</span>
00512 <span class="comment">        specific/standard access types for the object being accessed.</span>
00513 <span class="comment">        This mapping structure is expected to be safe to access</span>
00514 <span class="comment">        (i.e., captured if necessary) prior to be passed to this routine.</span>
00515 <span class="comment"></span>
00516 <span class="comment">Return Value:</span>
00517 <span class="comment"></span>
00518 <span class="comment">    NTSTATUS - STATUS_SUCCESS if successful and an appropriate error</span>
00519 <span class="comment">        value otherwise.</span>
00520 <span class="comment"></span>
00521 <span class="comment">--*/</span>
00522 
00523 {
00524 
00525 
00526 
00527     <span class="comment">//</span>
00528     <span class="comment">// Make sure the object already has a security descriptor.</span>
00529     <span class="comment">// Objects that 'may' have security descriptors 'must' have security</span>
00530     <span class="comment">// descriptors.  If this one doesn't already have one, then we can't</span>
00531     <span class="comment">// assign one to it.</span>
00532     <span class="comment">//</span>
00533 
00534     <span class="keywordflow">if</span> ((*ObjectsSecurityDescriptor) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00535         <span class="keywordflow">return</span>(STATUS_NO_SECURITY_ON_OBJECT);
00536     }
00537 
00538 
00539     <span class="comment">//</span>
00540     <span class="comment">// Pass this call to the common Rtlp routine.</span>
00541     <span class="comment">//</span>
00542 
00543     <span class="keywordflow">return</span> <a class="code" href="../../d8/d6/sertl_8c.html#a77">RtlpSetSecurityObject</a> (
00544                     Object,
00545                     *SecurityInformation,
00546                     ModificationDescriptor,
00547                     ObjectsSecurityDescriptor,
00548                     AutoInheritFlags,
00549                     PoolType,
00550                     GenericMapping,
00551                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ); <span class="comment">// No Token</span>
00552 
00553 
00554 }
00555 
00556 
00557 
00558 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00559"></a><a class="code" href="../../d0/d6/semethod_8c.html#a6">00559</a> <a class="code" href="../../d0/d6/semethod_8c.html#a6">SeQuerySecurityDescriptorInfo</a> (
00560     IN PSECURITY_INFORMATION SecurityInformation,
00561     OUT PSECURITY_DESCRIPTOR SecurityDescriptor,
00562     IN OUT PULONG Length,
00563     IN PSECURITY_DESCRIPTOR *ObjectsSecurityDescriptor
00564     )
00565 
00566 <span class="comment">/*++</span>
00567 <span class="comment"></span>
00568 <span class="comment">Routine Description:</span>
00569 <span class="comment"></span>
00570 <span class="comment">    This routine will extract the desired information from the</span>
00571 <span class="comment">    passed security descriptor and return the information in</span>
00572 <span class="comment">    the passed buffer as a security descriptor in self-relative</span>
00573 <span class="comment">    format.</span>
00574 <span class="comment"></span>
00575 <span class="comment">Arguments:</span>
00576 <span class="comment"></span>
00577 <span class="comment">    SecurityInformation - Specifies what information is being queried.</span>
00578 <span class="comment"></span>
00579 <span class="comment">    SecurityDescriptor - Supplies the buffer to output the requested</span>
00580 <span class="comment">        information into.</span>
00581 <span class="comment"></span>
00582 <span class="comment">        This buffer has been probed only to the size indicated by</span>
00583 <span class="comment">        the Length parameter.  Since it still points into user space,</span>
00584 <span class="comment">        it must always be accessed in a try clause.</span>
00585 <span class="comment"></span>
00586 <span class="comment">    Length - Supplies the address of a variable containing the length of</span>
00587 <span class="comment">        the security descriptor buffer.  Upon return this variable will</span>
00588 <span class="comment">        contain the length needed to store the requested information.</span>
00589 <span class="comment"></span>
00590 <span class="comment">    ObjectsSecurityDescriptor - Supplies the address of a pointer to</span>
00591 <span class="comment">        the objects security descriptor.  The passed security descriptor</span>
00592 <span class="comment">        must be in self-relative format.</span>
00593 <span class="comment"></span>
00594 <span class="comment">Return Value:</span>
00595 <span class="comment"></span>
00596 <span class="comment">    NTSTATUS - STATUS_SUCCESS if successful and an appropriate error value</span>
00597 <span class="comment">        otherwise</span>
00598 <span class="comment"></span>
00599 <span class="comment">--*/</span>
00600 
00601 {
00602     ULONG BufferLength;
00603 
00604     ULONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00605     ULONG OwnerLength;
00606     ULONG GroupLength;
00607     ULONG DaclLength;
00608     ULONG SaclLength;
00609     PUCHAR NextFree;
00610     SECURITY_DESCRIPTOR IObjectSecurity;
00611 
00612     <span class="comment">//</span>
00613     <span class="comment">// Note that IObjectSecurity is not a pointer to a pointer</span>
00614     <span class="comment">// like ObjectsSecurityDescriptor is.</span>
00615     <span class="comment">//</span>
00616 
00617     SECURITY_DESCRIPTOR_RELATIVE *ISecurityDescriptor = SecurityDescriptor;
00618 
00619     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00620 
00621     <span class="comment">//</span>
00622     <span class="comment">//  We will be accessing user memory throughout this routine,</span>
00623     <span class="comment">//  therefore do everything in a try-except clause.</span>
00624     <span class="comment">//</span>
00625 
00626     <span class="keywordflow">try</span> {
00627 
00628         BufferLength = *Length;
00629 
00630         <span class="comment">//</span>
00631         <span class="comment">//  Check if the object's descriptor is null, and if it is then</span>
00632         <span class="comment">//  we only need to return a blank security descriptor record</span>
00633         <span class="comment">//</span>
00634 
00635         <span class="keywordflow">if</span> (*ObjectsSecurityDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00636 
00637             *Length = <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR_RELATIVE);
00638 
00639             <span class="comment">//</span>
00640             <span class="comment">//  Now make sure it's large enough for the security descriptor</span>
00641             <span class="comment">//  record</span>
00642             <span class="comment">//</span>
00643 
00644             <span class="keywordflow">if</span> (BufferLength &lt; <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR_RELATIVE)) {
00645 
00646                 <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00647 
00648             }
00649 
00650             <span class="comment">//</span>
00651             <span class="comment">//  It's large enough to make a blank security descriptor record</span>
00652             <span class="comment">//</span>
00653             <span class="comment">//  Note that this parameter has been probed for write by the</span>
00654             <span class="comment">//  object manager, however, we still have to be careful when</span>
00655             <span class="comment">//  writing to it.</span>
00656             <span class="comment">//</span>
00657 
00658             <span class="comment">//</span>
00659             <span class="comment">// We do not have to probe this here, because the object</span>
00660             <span class="comment">// manager has probed it for length=BufferLength, which we</span>
00661             <span class="comment">// know at this point is at least as large as a security</span>
00662             <span class="comment">// descriptor.</span>
00663             <span class="comment">//</span>
00664 
00665             <a class="code" href="../../d8/d6/sertl_8c.html#a54">RtlCreateSecurityDescriptorRelative</a>( SecurityDescriptor,
00666                                                  SECURITY_DESCRIPTOR_REVISION );
00667 
00668             <span class="comment">//</span>
00669             <span class="comment">// Mark it as self-relative</span>
00670             <span class="comment">//</span>
00671 
00672             RtlpSetControlBits( ISecurityDescriptor, SE_SELF_RELATIVE );
00673 
00674             <span class="comment">//</span>
00675             <span class="comment">//  And return to our caller</span>
00676             <span class="comment">//</span>
00677 
00678             <span class="keywordflow">return</span> STATUS_SUCCESS;
00679 
00680         }
00681 
00682         <span class="comment">//</span>
00683         <span class="comment">// Create an absolute format SD on the stack pointing into</span>
00684         <span class="comment">// user space to simplify the following code</span>
00685         <span class="comment">//</span>
00686 
00687         RtlCopyMemory( (&amp;IObjectSecurity),
00688                       *ObjectsSecurityDescriptor,
00689                       <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR_RELATIVE) );
00690 
00691         IObjectSecurity.Owner = RtlpOwnerAddrSecurityDescriptor(
00692                     (SECURITY_DESCRIPTOR *) *ObjectsSecurityDescriptor );
00693         IObjectSecurity.Group = RtlpGroupAddrSecurityDescriptor(
00694                     (SECURITY_DESCRIPTOR *) *ObjectsSecurityDescriptor );
00695         IObjectSecurity.Dacl = RtlpDaclAddrSecurityDescriptor(
00696                     (SECURITY_DESCRIPTOR *) *ObjectsSecurityDescriptor );
00697         IObjectSecurity.Sacl = RtlpSaclAddrSecurityDescriptor(
00698                     (SECURITY_DESCRIPTOR *) *ObjectsSecurityDescriptor );
00699 
00700         IObjectSecurity.Control &amp;= ~SE_SELF_RELATIVE;
00701 
00702         <span class="comment">//</span>
00703         <span class="comment">//  This is not a blank descriptor so we need to determine the size</span>
00704         <span class="comment">//  needed to store the requested information.  It is the size of the</span>
00705         <span class="comment">//  descriptor record plus the size of each requested component.</span>
00706         <span class="comment">//</span>
00707 
00708         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR_RELATIVE);
00709 
00710         <span class="keywordflow">if</span> ( (((*SecurityInformation) &amp; OWNER_SECURITY_INFORMATION)) &amp;&amp;
00711              (IObjectSecurity.Owner != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
00712 
00713             OwnerLength = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( IObjectSecurity.Owner );
00714             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> += (ULONG)LongAlignSize(OwnerLength);
00715 
00716         }
00717 
00718         <span class="keywordflow">if</span> ( (((*SecurityInformation) &amp; GROUP_SECURITY_INFORMATION)) &amp;&amp;
00719              (IObjectSecurity.Group != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
00720 
00721             GroupLength = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( IObjectSecurity.Group );
00722             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> += (ULONG)LongAlignSize(GroupLength);
00723 
00724         }
00725 
00726         <span class="keywordflow">if</span> ( (((*SecurityInformation) &amp; DACL_SECURITY_INFORMATION)) &amp;&amp;
00727              (IObjectSecurity.Control &amp; SE_DACL_PRESENT) &amp;&amp;
00728              (IObjectSecurity.Dacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
00729 
00730 
00731             DaclLength = (ULONG)LongAlignSize((IObjectSecurity.Dacl)-&gt;AclSize);
00732             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> += DaclLength;
00733 
00734         }
00735 
00736         <span class="keywordflow">if</span> ( (((*SecurityInformation) &amp; SACL_SECURITY_INFORMATION)) &amp;&amp;
00737              (IObjectSecurity.Control &amp; SE_SACL_PRESENT) &amp;&amp;
00738              (IObjectSecurity.Sacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
00739 
00740             SaclLength = (ULONG)LongAlignSize((IObjectSecurity.Sacl)-&gt;AclSize);
00741             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> += SaclLength;
00742 
00743         }
00744 
00745         <span class="comment">//</span>
00746         <span class="comment">//  Tell the caller how much space this will require</span>
00747         <span class="comment">//  (whether we actually fit or not)</span>
00748         <span class="comment">//</span>
00749 
00750         *Length = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00751 
00752         <span class="comment">//</span>
00753         <span class="comment">//  Now make sure the size is less than or equal to the length</span>
00754         <span class="comment">//  we were passed</span>
00755         <span class="comment">//</span>
00756 
00757         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &gt; BufferLength) {
00758 
00759             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00760 
00761         }
00762 
00763         <span class="comment">//</span>
00764         <span class="comment">//  The length is fine.</span>
00765         <span class="comment">//</span>
00766         <span class="comment">//  Fill in the length and flags part of the security descriptor.</span>
00767         <span class="comment">//  The real addresses of each acl will be filled in later when we</span>
00768         <span class="comment">//  copy the ACLs over.</span>
00769         <span class="comment">//</span>
00770         <span class="comment">//  Note that we only set a flag in the descriptor if the information</span>
00771         <span class="comment">//  was requested, which is a simple copy of the requested information</span>
00772         <span class="comment">//  input variable</span>
00773         <span class="comment">//</span>
00774         <span class="comment">//  The output buffer has already been probed to the passed size,</span>
00775         <span class="comment">//  so we can just write to it.</span>
00776         <span class="comment">//</span>
00777 
00778         <a class="code" href="../../d8/d6/sertl_8c.html#a54">RtlCreateSecurityDescriptorRelative</a>( SecurityDescriptor,
00779                                              SECURITY_DESCRIPTOR_REVISION );
00780 
00781         <span class="comment">//</span>
00782         <span class="comment">// Mark the returned Security Descriptor as being in</span>
00783         <span class="comment">// self-relative format</span>
00784         <span class="comment">//</span>
00785 
00786         RtlpSetControlBits( ISecurityDescriptor, SE_SELF_RELATIVE );
00787 
00788         <span class="comment">//</span>
00789         <span class="comment">//  NextFree is used to point to the next free spot in the</span>
00790         <span class="comment">//  returned security descriptor.</span>
00791         <span class="comment">//</span>
00792 
00793         NextFree = <a class="code" href="../../d3/d8/udfprocs_8h.html#a27">LongAlignPtr</a>((PUCHAR)SecurityDescriptor +
00794                                         <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR_RELATIVE));
00795 
00796         <span class="comment">//</span>
00797         <span class="comment">//  Copy the Owner SID if necessary and update the NextFree pointer,</span>
00798         <span class="comment">//  keeping it longword aligned.</span>
00799         <span class="comment">//</span>
00800 
00801         <span class="keywordflow">if</span> ( ((*SecurityInformation) &amp; OWNER_SECURITY_INFORMATION) &amp;&amp;
00802              ((IObjectSecurity.Owner) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
00803 
00804                 RtlMoveMemory( NextFree,
00805                                IObjectSecurity.Owner,
00806                                OwnerLength );
00807 
00808                 ISecurityDescriptor-&gt;Owner = (ULONG)((PUCHAR)NextFree - (PUCHAR)SecurityDescriptor);
00809 
00810                 RtlpPropagateControlBits(
00811                     ISecurityDescriptor,
00812                     &amp;IObjectSecurity,
00813                     SE_OWNER_DEFAULTED
00814                     );
00815 
00816                 NextFree += (ULONG)LongAlignSize(OwnerLength);
00817 
00818         }
00819 
00820 
00821         <span class="comment">//</span>
00822         <span class="comment">//  Copy the Group SID if necessary and update the NextFree pointer,</span>
00823         <span class="comment">//  keeping it longword aligned.</span>
00824         <span class="comment">//</span>
00825 
00826         <span class="keywordflow">if</span> ( ((*SecurityInformation) &amp; GROUP_SECURITY_INFORMATION) &amp;&amp;
00827              (IObjectSecurity.Group != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
00828 
00829                 RtlMoveMemory( NextFree,
00830                                IObjectSecurity.Group,
00831                                GroupLength );
00832 
00833                 ISecurityDescriptor-&gt;Group = (ULONG)((PUCHAR)NextFree - (PUCHAR)SecurityDescriptor);
00834 
00835                 RtlpPropagateControlBits(
00836                     ISecurityDescriptor,
00837                     &amp;IObjectSecurity,
00838                     SE_GROUP_DEFAULTED
00839                     );
00840 
00841                 NextFree += (ULONG)LongAlignSize(GroupLength);
00842 
00843         }
00844 
00845 
00846         <span class="comment">//</span>
00847         <span class="comment">//  Set discretionary acl information if requested.</span>
00848         <span class="comment">//  If not set in object's security,</span>
00849         <span class="comment">//  then everything is already set properly.</span>
00850         <span class="comment">//</span>
00851 
00852         <span class="keywordflow">if</span> ( (*SecurityInformation) &amp; DACL_SECURITY_INFORMATION) {
00853 
00854             RtlpPropagateControlBits(
00855                 ISecurityDescriptor,
00856                 &amp;IObjectSecurity,
00857                 SE_DACL_PRESENT | SE_DACL_DEFAULTED | SE_DACL_PROTECTED | SE_DACL_AUTO_INHERITED
00858                 );
00859 
00860             <span class="comment">//</span>
00861             <span class="comment">// Copy the acl if non-null  and update the NextFree pointer,</span>
00862             <span class="comment">// keeping it longword aligned.</span>
00863             <span class="comment">//</span>
00864 
00865             <span class="keywordflow">if</span> ( (IObjectSecurity.Control &amp; SE_DACL_PRESENT) != 0 &amp;&amp;
00866                  IObjectSecurity.Dacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00867 
00868                 RtlMoveMemory( NextFree,
00869                                IObjectSecurity.Dacl,
00870                                (IObjectSecurity.Dacl)-&gt;AclSize );
00871 
00872                 ISecurityDescriptor-&gt;Dacl = (ULONG)((PUCHAR)NextFree - (PUCHAR)SecurityDescriptor);
00873 
00874                 NextFree += DaclLength;
00875 
00876             }
00877         }
00878 
00879 
00880         <span class="comment">//</span>
00881         <span class="comment">//  Set system acl information if requested.</span>
00882         <span class="comment">//  If not set in object's security,</span>
00883         <span class="comment">//  then everything is already set properly.</span>
00884         <span class="comment">//</span>
00885 
00886         <span class="keywordflow">if</span> ( (*SecurityInformation) &amp; SACL_SECURITY_INFORMATION) {
00887 
00888             RtlpPropagateControlBits(
00889                 ISecurityDescriptor,
00890                 &amp;IObjectSecurity,
00891                 SE_SACL_PRESENT | SE_SACL_DEFAULTED | SE_SACL_PROTECTED | SE_SACL_AUTO_INHERITED
00892                 );
00893 
00894             <span class="comment">//</span>
00895             <span class="comment">// Copy the acl if non-null  and update the NextFree pointer,</span>
00896             <span class="comment">// keeping it longword aligned.</span>
00897             <span class="comment">//</span>
00898             <span class="keywordflow">if</span> ( (IObjectSecurity.Control &amp; SE_SACL_PRESENT) != 0 &amp;&amp;
00899                  IObjectSecurity.Sacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00900 
00901                 RtlMoveMemory( NextFree,
00902                                IObjectSecurity.Sacl,
00903                                (IObjectSecurity.Sacl)-&gt;AclSize );
00904 
00905                 ISecurityDescriptor-&gt;Sacl = (ULONG)((PUCHAR)NextFree - (PUCHAR)SecurityDescriptor);
00906 
00907             }
00908         }
00909 
00910     } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00911         <span class="keywordflow">return</span>(GetExceptionCode());
00912     }
00913 
00914     <span class="keywordflow">return</span> STATUS_SUCCESS;
00915 
00916 }
00917 
00918 
00919 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00920"></a><a class="code" href="../../d0/d6/semethod_8c.html#a0">00920</a> <a class="code" href="../../d0/d6/semethod_8c.html#a0">SepDefaultDeleteMethod</a> (
00921     IN OUT PSECURITY_DESCRIPTOR *ObjectsSecurityDescriptor
00922     )
00923 
00924 <span class="comment">/*++</span>
00925 <span class="comment"></span>
00926 <span class="comment">Routine Description:</span>
00927 <span class="comment"></span>
00928 <span class="comment">    This is a private procedure to delete the security descriptor for</span>
00929 <span class="comment">    an object.  It cleans up any pool allocations that have occured</span>
00930 <span class="comment">    as part of the descriptor.</span>
00931 <span class="comment"></span>
00932 <span class="comment">Arguments:</span>
00933 <span class="comment"></span>
00934 <span class="comment">    ObjectsSecurityDescriptor - Supplies the address of a pointer</span>
00935 <span class="comment">        to the security descriptor being deleted.</span>
00936 <span class="comment"></span>
00937 <span class="comment">Return Value:</span>
00938 <span class="comment"></span>
00939 <span class="comment">    NTSTATUS - STATUS_SUCCESS</span>
00940 <span class="comment"></span>
00941 <span class="comment">--*/</span>
00942 
00943 {
00944     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00945 
00946     <span class="keywordflow">return</span> (<a class="code" href="../../d8/d1/obsdata_8c.html#a19">ObDeassignSecurity</a> ( ObjectsSecurityDescriptor ));
00947 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:45 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
