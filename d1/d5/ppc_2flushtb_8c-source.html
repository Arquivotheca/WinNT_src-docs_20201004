<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: flushtb.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>flushtb.c</h1><a href="../../d0/d6/ppc_2flushtb_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1992-1994 Microsoft Corporation</span>
00004 <span class="comment">Copyright (c) 1994 IBM Corporation</span>
00005 <span class="comment"></span>
00006 <span class="comment">Module Name:</span>
00007 <span class="comment"></span>
00008 <span class="comment">    flushtb.c</span>
00009 <span class="comment"></span>
00010 <span class="comment">Abstract:</span>
00011 <span class="comment"></span>
00012 <span class="comment">    This module implements machine dependent functions to flush the</span>
00013 <span class="comment">    translation buffer and synchronize PIDs in an MP system.</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    David N. Cutler (davec) 13-May-1989</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Modified for PowerPC by Mark Mergen (mergen@watson.ibm.com) 25-Aug-1994</span>
00020 <span class="comment"></span>
00021 <span class="comment">Environment:</span>
00022 <span class="comment"></span>
00023 <span class="comment">    Kernel mode only.</span>
00024 <span class="comment"></span>
00025 <span class="comment">Revision History:</span>
00026 <span class="comment"></span>
00027 <span class="comment"></span>
00028 <span class="comment">--*/</span>
00029 
00030 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00031 
00032 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00033"></a><a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">00033</a> <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (
00034     IN BOOLEAN Invalid,
00035     IN BOOLEAN AllProcessors
00036     )
00037 
00038 <span class="comment">/*++</span>
00039 <span class="comment"></span>
00040 <span class="comment">Routine Description:</span>
00041 <span class="comment"></span>
00042 <span class="comment">    This function flushes the entire translation buffer (TB) on all</span>
00043 <span class="comment">    processors that are currently running threads which are children</span>
00044 <span class="comment">    of the current process or flushes the entire translation buffer</span>
00045 <span class="comment">    on all processors in the host configuration.</span>
00046 <span class="comment"></span>
00047 <span class="comment">    N.B. The entire translation buffer on all processors in the host</span>
00048 <span class="comment">         configuration is always flushed since PowerPC TB is tagged by</span>
00049 <span class="comment">         VSID and translations are held across context switch boundaries.</span>
00050 <span class="comment"></span>
00051 <span class="comment">Arguments:</span>
00052 <span class="comment"></span>
00053 <span class="comment">    Invalid - Supplies a boolean value that specifies the reason for</span>
00054 <span class="comment">        flushing the translation buffer.</span>
00055 <span class="comment"></span>
00056 <span class="comment">    AllProcessors - Supplies a boolean value that determines which</span>
00057 <span class="comment">        translation buffers are to be flushed.</span>
00058 <span class="comment"></span>
00059 <span class="comment">Return Value:</span>
00060 <span class="comment"></span>
00061 <span class="comment">    None.</span>
00062 <span class="comment"></span>
00063 <span class="comment">--*/</span>
00064 
00065 {
00066 
00067     KIRQL OldIrql;
00068 
00069     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a58">SYNCH_LEVEL</a>);
00070 
00071 <span class="preprocessor">#if !defined(NT_UP)</span>
00072 <span class="preprocessor"></span>
00073     <span class="comment">//</span>
00074     <span class="comment">// Raise IRQL to synchronization level to avoid a possible context switch.</span>
00075     <span class="comment">//</span>
00076 
00077     OldIrql = KeRaiseIrqlToSynchLevel();
00078 
00079     <a class="code" href="../../d0/d0/ki_8h.html#a21">IPI_INSTRUMENT_COUNT</a>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;Number, FlushEntireTb);
00080 
00081 <span class="preprocessor">#endif</span>
00082 <span class="preprocessor"></span>
00083     <span class="comment">//</span>
00084     <span class="comment">// Flush TB on current processor.</span>
00085     <span class="comment">// PowerPC hardware broadcasts if MP.</span>
00086     <span class="comment">//</span>
00087 
00088     <a class="code" href="../../d4/d9/ke_8h.html#a374">KeFlushCurrentTb</a>();
00089 
00090 <span class="preprocessor">#if !defined(NT_UP)</span>
00091 <span class="preprocessor"></span>
00092     <span class="comment">//</span>
00093     <span class="comment">// Lower IRQL to previous level.</span>
00094     <span class="comment">//</span>
00095 
00096     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00097 
00098 <span class="preprocessor">#endif</span>
00099 <span class="preprocessor"></span>
00100     <span class="keywordflow">return</span>;
00101 }
00102 
00103 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00104"></a><a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a1">00104</a> <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a1">KeFlushMultipleTb</a> (
00105     IN ULONG Number,
00106     IN PVOID *Virtual,
00107     IN BOOLEAN Invalid,
00108     IN BOOLEAN AllProcessors,
00109     IN PHARDWARE_PTE *PtePointer OPTIONAL,
00110     IN HARDWARE_PTE PteValue
00111     )
00112 
00113 <span class="comment">/*++</span>
00114 <span class="comment"></span>
00115 <span class="comment">Routine Description:</span>
00116 <span class="comment"></span>
00117 <span class="comment">    This function flushes multiple entries from the translation buffer</span>
00118 <span class="comment">    on all processors that are currently running threads which are</span>
00119 <span class="comment">    children of the current process or flushes multiple entries from</span>
00120 <span class="comment">    the translation buffer on all processors in the host configuration.</span>
00121 <span class="comment"></span>
00122 <span class="comment">    N.B. The specified translation entries on all processors in the host</span>
00123 <span class="comment">         configuration are always flushed since PowerPC TB is tagged by</span>
00124 <span class="comment">         VSID and translations are held across context switch boundaries.</span>
00125 <span class="comment"></span>
00126 <span class="comment">Arguments:</span>
00127 <span class="comment"></span>
00128 <span class="comment">    Number - Supplies the number of TB entries to flush.</span>
00129 <span class="comment"></span>
00130 <span class="comment">    Virtual - Supplies a pointer to an array of virtual addresses that</span>
00131 <span class="comment">        are within the pages whose translation buffer entries are to be</span>
00132 <span class="comment">        flushed.</span>
00133 <span class="comment"></span>
00134 <span class="comment">    Invalid - Supplies a boolean value that specifies the reason for</span>
00135 <span class="comment">        flushing the translation buffer.</span>
00136 <span class="comment"></span>
00137 <span class="comment">    AllProcessors - Supplies a boolean value that determines which</span>
00138 <span class="comment">        translation buffers are to be flushed.</span>
00139 <span class="comment"></span>
00140 <span class="comment">    PtePointer - Supplies an optional pointer to an array of pointers to</span>
00141 <span class="comment">       page table entries that receive the specified page table entry</span>
00142 <span class="comment">       value.</span>
00143 <span class="comment"></span>
00144 <span class="comment">    PteValue - Supplies the the new page table entry value.</span>
00145 <span class="comment"></span>
00146 <span class="comment">Return Value:</span>
00147 <span class="comment"></span>
00148 <span class="comment">    None.</span>
00149 <span class="comment"></span>
00150 <span class="comment">--*/</span>
00151 
00152 {
00153 
00154     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00155 
00156     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() == <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00157 
00158     <span class="comment">//</span>
00159     <span class="comment">// If a page table entry address array is specified, then set the</span>
00160     <span class="comment">// specified page table entries to the specific value.</span>
00161     <span class="comment">//</span>
00162 
00163     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PtePointer)) {
00164         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; Number; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00165             *PtePointer[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = PteValue;
00166         }
00167     }
00168 
00169 <span class="preprocessor">#if !defined(NT_UP)</span>
00170 <span class="preprocessor"></span>
00171     <a class="code" href="../../d0/d0/ki_8h.html#a21">IPI_INSTRUMENT_COUNT</a>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;Number, FlushSingleTb);
00172 
00173 <span class="preprocessor">#endif</span>
00174 <span class="preprocessor"></span>
00175     <span class="comment">//</span>
00176     <span class="comment">// Flush the specified entries from the TB on the current processor.</span>
00177     <span class="comment">// PowerPC hardware broadcasts if MP.</span>
00178     <span class="comment">//</span>
00179 
00180     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; Number; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00181         <a class="code" href="../../d0/d0/ki_8h.html#a114">KiFlushSingleTb</a>(Invalid, <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]);
00182     }
00183 
00184     <span class="keywordflow">return</span>;
00185 }
00186 
00187 HARDWARE_PTE
<a name="l00188"></a><a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">00188</a> <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (
00189     IN PVOID Virtual,
00190     IN BOOLEAN Invalid,
00191     IN BOOLEAN AllProcessors,
00192     IN PHARDWARE_PTE PtePointer,
00193     IN HARDWARE_PTE PteValue
00194     )
00195 
00196 <span class="comment">/*++</span>
00197 <span class="comment"></span>
00198 <span class="comment">Routine Description:</span>
00199 <span class="comment"></span>
00200 <span class="comment">    This function flushes a single entry from the translation buffer</span>
00201 <span class="comment">    on all processors that are currently running threads which are</span>
00202 <span class="comment">    children of the current process or flushes a single entry from</span>
00203 <span class="comment">    the translation buffer on all processors in the host configuration.</span>
00204 <span class="comment"></span>
00205 <span class="comment">    N.B. The specified translation entry on all processors in the host</span>
00206 <span class="comment">         configuration is always flushed since PowerPC TB is tagged by</span>
00207 <span class="comment">         VSID and translations are held across context switch boundaries.</span>
00208 <span class="comment"></span>
00209 <span class="comment">Arguments:</span>
00210 <span class="comment"></span>
00211 <span class="comment">    Virtual - Supplies a virtual address that is within the page whose</span>
00212 <span class="comment">        translation buffer entry is to be flushed.</span>
00213 <span class="comment"></span>
00214 <span class="comment">    Invalid - Supplies a boolean value that specifies the reason for</span>
00215 <span class="comment">        flushing the translation buffer.</span>
00216 <span class="comment"></span>
00217 <span class="comment">    AllProcessors - Supplies a boolean value that determines which</span>
00218 <span class="comment">        translation buffers are to be flushed.</span>
00219 <span class="comment"></span>
00220 <span class="comment">    PtePointer - Supplies a pointer to the page table entry which</span>
00221 <span class="comment">        receives the specified value.</span>
00222 <span class="comment"></span>
00223 <span class="comment">    PteValue - Supplies the the new page table entry value.</span>
00224 <span class="comment"></span>
00225 <span class="comment">Return Value:</span>
00226 <span class="comment"></span>
00227 <span class="comment">    The previous contents of the specified page table entry is returned</span>
00228 <span class="comment">    as the function value.</span>
00229 <span class="comment"></span>
00230 <span class="comment">--*/</span>
00231 
00232 {
00233 
00234     HARDWARE_PTE OldPte;
00235 
00236     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() == <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00237 
00238     <span class="comment">//</span>
00239     <span class="comment">// Collect call data.</span>
00240     <span class="comment">//</span>
00241 
00242 <span class="preprocessor">#if defined(_COLLECT_FLUSH_SINGLE_CALLDATA_)</span>
00243 <span class="preprocessor"></span>
00244     <a class="code" href="../../d5/d8/ex_8h.html#a1">RECORD_CALL_DATA</a>(&amp;<a class="code" href="../../d0/d0/ki_8h.html#a46">KiFlushSingleCallData</a>);
00245 
00246 <span class="preprocessor">#endif</span>
00247 <span class="preprocessor"></span>
00248     <span class="comment">//</span>
00249     <span class="comment">// Capture the previous contents of the page table entry and set the</span>
00250     <span class="comment">// page table entry to the new value.</span>
00251     <span class="comment">//</span>
00252 
00253     OldPte = *PtePointer;
00254     *PtePointer = PteValue;
00255 
00256 <span class="preprocessor">#if !defined(NT_UP)</span>
00257 <span class="preprocessor"></span>
00258     <a class="code" href="../../d0/d0/ki_8h.html#a21">IPI_INSTRUMENT_COUNT</a>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;Number, FlushSingleTb);
00259 
00260 <span class="preprocessor">#endif</span>
00261 <span class="preprocessor"></span>
00262     <span class="comment">//</span>
00263     <span class="comment">// Flush the specified entry from the TB on the current processor.</span>
00264     <span class="comment">// PowerPC hardware broadcasts if MP.</span>
00265     <span class="comment">//</span>
00266 
00267     <a class="code" href="../../d0/d0/ki_8h.html#a114">KiFlushSingleTb</a>(Invalid, <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>);
00268 
00269     <span class="comment">//</span>
00270     <span class="comment">// Return the previous page table entry value.</span>
00271     <span class="comment">//</span>
00272 
00273     <span class="keywordflow">return</span> OldPte;
00274 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:02 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
