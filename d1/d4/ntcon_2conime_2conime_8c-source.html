<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: conime.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>conime.c</h1><a href="../../d0/d5/ntcon_2conime_2conime_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">// Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00002 <span class="comment">//</span>
00003 <span class="comment">//  MODULE:   ConIme.c</span>
00004 <span class="comment">//</span>
00005 <span class="comment">//  PURPOSE:   Console IME control.</span>
00006 <span class="comment">//</span>
00007 <span class="comment">//  PLATFORMS: Windows NT-J 3.51</span>
00008 <span class="comment">//</span>
00009 <span class="comment">//  FUNCTIONS:</span>
00010 <span class="comment">//    WinMain() - calls initialization functions, processes message loop</span>
00011 <span class="comment">//    WndProc - Processes messages for the main window.</span>
00012 <span class="comment">//</span>
00013 <span class="comment">//  History:</span>
00014 <span class="comment">//</span>
00015 <span class="comment">//  27.Jul.1995 v-HirShi (Hirotoshi Shimizu)    created</span>
00016 <span class="comment">//</span>
00017 <span class="comment">//  COMMENTS:</span>
00018 <span class="comment">//</span>
00019 
00020 <span class="preprocessor">#include "<a class="code" href="../../d5/d3/w32_2ntcon_2conime_2precomp_8h.html">precomp.h</a>"</span>
00021 <span class="preprocessor">#pragma hdrstop</span>
00022 <span class="preprocessor"></span>
00023 
00024 <span class="comment">// Global Variables</span>
00025 
<a name="l00026"></a><a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a3">00026</a> HANDLE          <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a3">LastConsole</a>;
<a name="l00027"></a><a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a4">00027</a> HIMC            <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a4">ghDefaultIMC</a>;
00028 
<a name="l00029"></a><a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a5">00029</a> <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a>  *<a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a5">ConsoleTable</a>;
<a name="l00030"></a><a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a6">00030</a> ULONG           <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a6">NumberOfConsoleTable</a>;
00031 
<a name="l00032"></a><a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a7">00032</a> CRITICAL_SECTION <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a7">ConsoleTableLock</a>; <span class="comment">// serialize console table access</span>
<a name="l00033"></a><a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a0">00033</a> <span class="preprocessor">#define LockConsoleTable()   RtlEnterCriticalSection(&amp;ConsoleTableLock)</span>
<a name="l00034"></a><a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a1">00034</a> <span class="preprocessor"></span><span class="preprocessor">#define UnlockConsoleTable() RtlLeaveCriticalSection(&amp;ConsoleTableLock)</span>
00035 <span class="preprocessor"></span>
00036 
<a name="l00037"></a><a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a8">00037</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>            <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a8">gfDoNotKillFocus</a>;
00038 
00039 
<a name="l00040"></a><a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a9">00040</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>           <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a9">dwConsoleThreadId</a>;
00041 
00042 
00043 <span class="preprocessor">#if DBG</span>
00044 <span class="preprocessor"></span>ULONG <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a2">InputExceptionFilter</a>(
00045     PEXCEPTION_POINTERS pexi)
00046 {
00047     <span class="keywordflow">if</span> (pexi-&gt;ExceptionRecord-&gt;ExceptionCode != STATUS_PORT_DISCONNECTED) {
00048         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CONIME: Unexpected exception - %x, pexi = %x\n"</span>,
00049                 pexi-&gt;ExceptionRecord-&gt;ExceptionCode, pexi);
00050         DbgBreakPoint();
00051     }
00052 
00053     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>;
00054 }
00055 <span class="preprocessor">#else</span>
<a name="l00056"></a><a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a2">00056</a> <span class="preprocessor"></span><span class="preprocessor">#define InputExceptionFilter(pexi) EXCEPTION_EXECUTE_HANDLER</span>
00057 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00058 <span class="preprocessor"></span>
00059 
00060 <span class="keywordtype">int</span>
00061 <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a>
<a name="l00062"></a><a class="code" href="../../d0/d2/usrbench_8h.html#a51">00062</a> <a class="code" href="../../d0/d2/usrbench_8h.html#a51">WinMain</a>(
00063     HINSTANCE hInstance,
00064     HINSTANCE hPrevInstance,
00065     LPSTR     lpCmdLine,
00066     <span class="keywordtype">int</span>       nCmdShow
00067     )
00068 {
00069     MSG <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
00070     WCHAR systemPath[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00071 
00072     GetSystemDirectory ( systemPath, <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a> );
00073     SetCurrentDirectory ( systemPath );
00074 
00075     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d5/conimep_8h.html#a95">InitConsoleIME</a>(hInstance) ) {
00076         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: InitConsoleIME failure!\n"</span>));
00077         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00078     }
00079     <span class="keywordflow">else</span> {
00080         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: InitConsoleIME successful!\n"</span>));
00081     }
00082 
00083     <span class="keywordflow">try</span> {
00084 
00085         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)  {
00086             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d8/ntcftxt_8h.html#a16">GetMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 0)) {
00087                 <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a21">TranslateMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>);
00088                 <a class="code" href="../../d5/d9/cltxt_8h.html#a24">DispatchMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>);
00089             } <span class="keywordflow">else</span> {
00090                 <span class="keywordflow">break</span>;
00091             }
00092         }
00093 
00094     } except (<a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a2">InputExceptionFilter</a>(GetExceptionInformation())) {
00095 
00096         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a9">dwConsoleThreadId</a>)
00097         {
00098             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: Exception on WinMain!!\n"</span>));
00099             UnregisterConsoleIME();
00100             <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a9">dwConsoleThreadId</a> = 0;
00101         }
00102 
00103     }
00104 
00105     <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.wParam;
00106 }
00107 
00108 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00109"></a><a class="code" href="../../d4/d5/conimep_8h.html#a95">00109</a> <a class="code" href="../../d4/d5/conimep_8h.html#a95">InitConsoleIME</a>(
00110     HINSTANCE hInstance
00111     )
00112 {
00113     HANDLE   hEvent;
00114     ATOM     atom;
00115     HWND     <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>;
00116     WNDCLASS ConsoleIMEClass;
00117     <span class="keywordtype">int</span>      cxExecStart;
00118     <span class="keywordtype">int</span>      cyExecStart;
00119     WCHAR    szMenuName[16];                 <span class="comment">// The name of Menu</span>
00120     WCHAR    szClassName[16];                <span class="comment">// The class name of this application</span>
00121     WCHAR    <a class="code" href="../../d5/d6/ntcon_2conime_2globals_8h.html#a2">szTitle</a>[16];                    <span class="comment">// The title bar text</span>
00122 
00123 <span class="preprocessor">#ifdef DEBUG_MODE</span>
00124 <span class="preprocessor"></span>    WCHAR    szAppName[16];                  <span class="comment">// The name of this application</span>
00125 
00126     LoadString(hInstance, <a class="code" href="../../d4/d5/conimep_8h.html#a9">IDS_TITLE</a>,     <a class="code" href="../../d5/d6/ntcon_2conime_2globals_8h.html#a2">szTitle</a>,     <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d6/ntcon_2conime_2globals_8h.html#a2">szTitle</a>));
00127 <span class="preprocessor">#else</span>
00128 <span class="preprocessor"></span>    <a class="code" href="../../d5/d6/ntcon_2conime_2globals_8h.html#a2">szTitle</a>[0] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00129 <span class="preprocessor">#endif</span>
00130 <span class="preprocessor"></span>
00131     <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: Enter InitConsoleIMEl!\n"</span>));
00132 
00133     <a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a>(&amp;<a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a7">ConsoleTableLock</a>);
00134 
00135     <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a5">ConsoleTable</a> = (<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> *)LocalAlloc(LPTR, <a class="code" href="../../d4/d5/conimep_8h.html#a12">CONSOLE_INITIAL_TABLE</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a>));
00136     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a5">ConsoleTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00137         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00138     }
00139     RtlZeroMemory(<a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a5">ConsoleTable</a>, <a class="code" href="../../d4/d5/conimep_8h.html#a12">CONSOLE_INITIAL_TABLE</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/conimep_8h.html#a91">PCONSOLE_TABLE</a>));
00140     <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a6">NumberOfConsoleTable</a> = <a class="code" href="../../d4/d5/conimep_8h.html#a12">CONSOLE_INITIAL_TABLE</a>;
00141 
00142     <span class="comment">// Load the application name and description strings.</span>
00143     LoadString(hInstance, <a class="code" href="../../d4/d5/conimep_8h.html#a6">IDS_MENUNAME</a>,  szMenuName,  <span class="keyword">sizeof</span>(szMenuName));
00144     LoadString(hInstance, <a class="code" href="../../d4/d5/conimep_8h.html#a8">IDS_CLASSNAME</a>, szClassName, <span class="keyword">sizeof</span>(szClassName));
00145 
00146     hEvent = OpenEvent(EVENT_MODIFY_STATE,    <span class="comment">// Access flag</span>
00147                        <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                 <span class="comment">// Inherit</span>
00148                        <a class="code" href="../../d3/d5/conime_8h.html#a0">CONSOLEIME_EVENT</a>);     <span class="comment">// Event object name</span>
00149     <span class="keywordflow">if</span> (hEvent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00150     {
00151         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: OpenEvent failure! %d\n"</span>,GetLastError()));
00152         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00153     }
00154 
00155     <span class="comment">// Fill in window class structure with parameters that describe the</span>
00156     <span class="comment">// main window.</span>
00157 
00158     ConsoleIMEClass.style         = 0;                       <span class="comment">// Class style(s).</span>
00159     ConsoleIMEClass.lpfnWndProc   = <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a12">WndProc</a>;                 <span class="comment">// Window Procedure</span>
00160     ConsoleIMEClass.cbClsExtra    = 0;                       <span class="comment">// No per-class extra data.</span>
00161     ConsoleIMEClass.cbWndExtra    = 0;                       <span class="comment">// No per-window extra data.</span>
00162     ConsoleIMEClass.hInstance     = hInstance;               <span class="comment">// Owner of this class</span>
00163     ConsoleIMEClass.hIcon         = LoadIcon(hInstance, MAKEINTRESOURCE(<a class="code" href="../../d4/d5/conimep_8h.html#a1">ID_CONSOLEIME_ICON</a>));
00164     ConsoleIMEClass.hCursor       = LoadCursor(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, IDC_ARROW); <span class="comment">// Cursor</span>
00165     ConsoleIMEClass.hbrBackground = GetStockObject(WHITE_BRUSH); <span class="comment">// Default color</span>
00166     ConsoleIMEClass.lpszMenuName  = szMenuName;              <span class="comment">// Menu name from .RC</span>
00167     ConsoleIMEClass.lpszClassName = szClassName;             <span class="comment">// Class Name</span>
00168 
00169     <span class="comment">// Register the window class and return FALSE if unsuccesful.</span>
00170 
00171     atom = <a class="code" href="../../d5/d9/cltxt_8h.html#a7">RegisterClass</a>(&amp;ConsoleIMEClass);
00172     <span class="keywordflow">if</span> (atom == 0)
00173     {
00174         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: RegisterClass failure! %d\n"</span>,GetLastError()));
00175         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00176     }
00177     <span class="keywordflow">else</span> {
00178         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: RegisterClass Successful!\n"</span>));
00179     }
00180 
00181     <span class="comment">// Guess size for now.</span>
00182     cxExecStart = <a class="code" href="../../d3/d9/client_2wow_8c.html#a16">GetSystemMetrics</a>(SM_CXSCREEN);
00183     cyExecStart = <a class="code" href="../../d3/d9/client_2wow_8c.html#a16">GetSystemMetrics</a>(SM_CYMENU);
00184 
00185     <span class="comment">// Create a main window for this application instance.</span>
00186     <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> = CreateWindow(szClassName,                 <span class="comment">// See RegisterClass() call.</span>
00187                         <a class="code" href="../../d5/d6/ntcon_2conime_2globals_8h.html#a2">szTitle</a>,                     <span class="comment">// Text for window title bar.</span>
00188                         WS_OVERLAPPEDWINDOW,
00189                         cxExecStart - (cxExecStart / 3) ,
00190                         cyExecStart ,
00191                         cxExecStart / 3 ,
00192                         cyExecStart * 10 ,
00193                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                        <span class="comment">// Overlapped has no parent.</span>
00194                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                        <span class="comment">// Use the window class menu.</span>
00195                         hInstance,
00196                         (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00197 
00198     <span class="comment">// If window could not be created, return "failure"</span>
00199     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00200         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: CreateWindow failured! %d\n"</span>,GetLastError()));
00201         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00202     }
00203     <span class="keywordflow">else</span>{
00204         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: CreateWindow Successful!\n"</span>));
00205     }
00206 
00207     <span class="keywordflow">if</span> (! RegisterConsoleIME(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, &amp;<a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a9">dwConsoleThreadId</a>))
00208     {
00209         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: RegisterConsoleIME failured! %d\n"</span>,GetLastError()));
00210         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00211     }
00212 
00213     <span class="keywordflow">if</span> (! AttachThreadInput(GetCurrentThreadId(), <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a9">dwConsoleThreadId</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))
00214     {
00215         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: AttachThreadInput failured! %d\n"</span>,GetLastError()));
00216         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00217     }
00218 
00219     <span class="comment">/*</span>
00220 <span class="comment">     * dwConsoleThreadId is locked until event sets of hEvent</span>
00221 <span class="comment">     */</span>
00222     SetEvent(hEvent);
00223     CloseHandle(hEvent);
00224 
00225 <span class="preprocessor">#ifdef DEBUG_MODE</span>
00226 <span class="preprocessor"></span>    LoadString(hInstance, <a class="code" href="../../d4/d5/conimep_8h.html#a7">IDS_APPNAME</a>,   szAppName,   <span class="keyword">sizeof</span>(szAppName));
00227 
00228     <span class="comment">// Make the window visible; update its client area; and return "success"</span>
00229     <a class="code" href="../../d3/d0/user32_8def.html#a32">ShowWindow</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, SW_MINIMIZE); <span class="comment">// Show the window</span>
00230     <a class="code" href="../../d5/d9/cltxt_8h.html#a23">SetWindowText</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, szAppName);
00231     <a class="code" href="../../d3/d8/client_8c.html#a140">UpdateWindow</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>);         <span class="comment">// Sends WM_PAINT message</span>
00232 
00233     {
00234         <span class="keywordtype">int</span> i;
00235 
00236         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d4/d5/conimep_8h.html#a16">CVMAX</a>; i++) {
00237             ConvertLine[i] = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
00238             ConvertLineAtr[i] = 0;
00239         }
00240         xPos = 0;
00241         xPosLast = 0;
00242     }
00243 
00244 <span class="preprocessor">#endif</span>
00245 <span class="preprocessor"></span>
00246     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;                <span class="comment">// We succeeded...</span>
00247 
00248 <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>:
00249     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a9">dwConsoleThreadId</a>)
00250         UnregisterConsoleIME();
00251     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>)
00252         <a class="code" href="../../d3/d4/w32_2ntuser_2client_2nt6_2pch_8h.html#a3">DestroyWindow</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>);
00253     <span class="keywordflow">if</span> (atom)
00254         <a class="code" href="../../d0/d8/ntcftxt_8h.html#a30">UnregisterClass</a>(szClassName,hInstance);
00255     <span class="keywordflow">if</span> (hEvent)
00256     {
00257         SetEvent(hEvent);
00258         CloseHandle(hEvent);
00259     }
00260     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00261 }
00262 
00263 
00264 <span class="comment">//</span>
00265 <span class="comment">//  FUNCTION: WndProc(HWND, UINT, WPARAM, LPARAM)</span>
00266 <span class="comment">//</span>
00267 <span class="comment">//  PURPOSE:  Processes messages</span>
00268 <span class="comment">//</span>
00269 <span class="comment">//  PARAMETERS:</span>
00270 <span class="comment">//    hwnd     - window handle</span>
00271 <span class="comment">//    uMessage - message number</span>
00272 <span class="comment">//    wparam   - additional information (dependant of message number)</span>
00273 <span class="comment">//    lparam   - additional information (dependant of message number)</span>
00274 <span class="comment">//</span>
00275 <span class="comment">//  MESSAGES:</span>
00276 <span class="comment">//</span>
00277 <span class="comment">//    WM_COMMAND    - exit command</span>
00278 <span class="comment">//    WM_DESTROY    - destroy window</span>
00279 <span class="comment">//</span>
00280 <span class="comment">//  RETURN VALUE:</span>
00281 <span class="comment">//</span>
00282 <span class="comment">//    Depends on the message number.</span>
00283 <span class="comment">//</span>
00284 <span class="comment">//  COMMENTS:</span>
00285 <span class="comment">//</span>
00286 <span class="comment">//</span>
00287 
<a name="l00288"></a><a class="code" href="../../d4/d5/conimep_8h.html#a96">00288</a> LRESULT <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> PASCAL <a class="code" href="../../d0/d2/usrbench_8h.html#a52">WndProc</a>( HWND hWnd,
00289                          UINT Message,
00290                          WPARAM wParam,
00291                          LPARAM lParam)
00292 {
00293     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwImmRet = 0;        <span class="comment">// return value of ImmSrvProcessKey()</span>
00294 
00295     <span class="keywordflow">try</span> {
00296 
00297         <span class="keywordflow">switch</span> (Message)
00298         {
00299             <span class="keywordflow">case</span> <a class="code" href="../../d3/d5/conime_8h.html#a9">CONIME_CREATE</a>:
00300                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: CONIME_CREATE: Console Handle=%08x\n"</span>, wParam));
00301                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d5/conimep_8h.html#a103">InsertNewConsole</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>,(HANDLE)wParam,(HWND)lParam);
00302 
00303             <span class="keywordflow">case</span> <a class="code" href="../../d3/d5/conime_8h.html#a10">CONIME_DESTROY</a>:
00304                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: CONIME_DESTROY: Console Handle=%08x\n"</span>, wParam));
00305                 <span class="keywordflow">return</span> <a class="code" href="../../d0/d5/srvinit_8c.html#a37">RemoveConsole</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, (HANDLE)wParam);
00306 
00307             <span class="keywordflow">case</span> <a class="code" href="../../d3/d5/conime_8h.html#a11">CONIME_SETFOCUS</a>:
00308                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: CONIME_SETFOCUS: Console Handle=%08x\n"</span>, wParam));
00309                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d5/conimep_8h.html#a104">ConsoleSetFocus</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, (HANDLE)wParam, (HKL)lParam);
00310 
00311             <span class="keywordflow">case</span> <a class="code" href="../../d3/d5/conime_8h.html#a12">CONIME_KILLFOCUS</a>:
00312                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: CONIME_KILLFOCUS: Console Handle=%08x\n"</span>, wParam));
00313                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d5/conimep_8h.html#a105">ConsoleKillFocus</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, (HANDLE)wParam);
00314 
00315             <span class="keywordflow">case</span> <a class="code" href="../../d3/d5/conime_8h.html#a14">CONIME_GET_NLSMODE</a>:
00316                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: CONIME_GET_NLSMODE: Console Handle=%08x\n"</span>, wParam));
00317                 <span class="keywordflow">return</span> <a class="code" href="../../d0/d6/consubs_8c.html#a11">GetNLSMode</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, (HANDLE)wParam);
00318 
00319             <span class="keywordflow">case</span> <a class="code" href="../../d3/d5/conime_8h.html#a15">CONIME_SET_NLSMODE</a>:
00320                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: CONIME_SET_NLSMODE: Console Handle=%08x\n"</span>, wParam));
00321                 <span class="keywordflow">return</span> <a class="code" href="../../d0/d6/consubs_8c.html#a12">SetNLSMode</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, (HANDLE)wParam, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)lParam);
00322 
00323             <span class="keywordflow">case</span> <a class="code" href="../../d3/d5/conime_8h.html#a13">CONIME_HOTKEY</a>:
00324                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: CONIME_HOTKEY\n"</span>));
00325                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/country_8c.html#a14">ConimeHotkey</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, (HANDLE)wParam, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)lParam);
00326 
00327             <span class="keywordflow">case</span> <a class="code" href="../../d3/d5/conime_8h.html#a17">CONIME_NOTIFY_VK_KANA</a>:
00328                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: CONIME_NOTIFY_VK_KANA\n"</span>));
00329                 <span class="keywordflow">return</span> <a class="code" href="../../d0/d6/consubs_8c.html#a9">ImeUISetConversionMode</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>);
00330 
00331             <span class="keywordflow">case</span> <a class="code" href="../../d3/d5/conime_8h.html#a16">CONIME_NOTIFY_SCREENBUFFERSIZE</a>: {
00332                 COORD ScreenBufferSize;
00333                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: CONIME_NOTIFY_SCREENBUFFERSIZE: Console Handle=%08x\n"</span>, wParam));
00334                 ScreenBufferSize.X = LOWORD(lParam);
00335                 ScreenBufferSize.Y = HIWORD(lParam);
00336                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d5/conimep_8h.html#a106">ConsoleScreenBufferSize</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, (HANDLE)wParam, ScreenBufferSize);
00337             }
00338 
00339             <span class="keywordflow">case</span> <a class="code" href="../../d3/d5/conime_8h.html#a18">CONIME_INPUTLANGCHANGE</a>: {
00340                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: CONIME_INPUTLANGCHANGE: Console Handle=%08x \n"</span>,wParam));
00341                 <a class="code" href="../../d4/d5/conimep_8h.html#a108">ConImeInputLangchange</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, (HANDLE)wParam, (HKL)lParam );
00342                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00343             }
00344 
00345             <span class="keywordflow">case</span> <a class="code" href="../../d3/d5/conime_8h.html#a19">CONIME_NOTIFY_CODEPAGE</a>: {
00346                 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> Output;
00347                 WORD Codepage;
00348 
00349                 Codepage = HIWORD(lParam);
00350                 Output = LOWORD(lParam);
00351                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: CONIME_NOTIFY_CODEPAGE: Console Handle=%08x %04x %04x\n"</span>,wParam, Output, Codepage));
00352                 <span class="keywordflow">return</span> <a class="code" href="../../d0/d6/consubs_8c.html#a13">ConsoleCodepageChange</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, (HANDLE)wParam, Output, Codepage);
00353             }
00354 
00355             <span class="keywordflow">case</span> WM_KEYDOWN    +<a class="code" href="../../d3/d5/conime_8h.html#a23">CONIME_KEYDATA</a>:
00356             <span class="keywordflow">case</span> WM_KEYUP      +<a class="code" href="../../d3/d5/conime_8h.html#a23">CONIME_KEYDATA</a>:
00357             <span class="keywordflow">case</span> WM_SYSKEYDOWN +<a class="code" href="../../d3/d5/conime_8h.html#a23">CONIME_KEYDATA</a>:
00358             <span class="keywordflow">case</span> WM_SYSKEYUP   +<a class="code" href="../../d3/d5/conime_8h.html#a23">CONIME_KEYDATA</a>:
00359             <span class="keywordflow">case</span> WM_DEADCHAR   +<a class="code" href="../../d3/d5/conime_8h.html#a23">CONIME_KEYDATA</a>:
00360             <span class="keywordflow">case</span> WM_SYSDEADCHAR+<a class="code" href="../../d3/d5/conime_8h.html#a23">CONIME_KEYDATA</a>:
00361             <span class="keywordflow">case</span> WM_SYSCHAR    +<a class="code" href="../../d3/d5/conime_8h.html#a23">CONIME_KEYDATA</a>:
00362             <span class="keywordflow">case</span> WM_CHAR       +<a class="code" href="../../d3/d5/conime_8h.html#a23">CONIME_KEYDATA</a>:
00363                 <a class="code" href="../../d0/d0/imefull_8c.html#a1">CharHandlerFromConsole</a>( <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, Message, (ULONG)wParam, (ULONG)lParam );
00364                 <span class="keywordflow">break</span>;
00365             <span class="keywordflow">case</span> WM_KEYDOWN:
00366             <span class="keywordflow">case</span> WM_KEYUP:
00367             <span class="keywordflow">case</span> WM_SYSKEYDOWN:
00368             <span class="keywordflow">case</span> WM_SYSKEYUP:
00369             <span class="keywordflow">case</span> WM_DEADCHAR:
00370             <span class="keywordflow">case</span> WM_SYSDEADCHAR:
00371             <span class="keywordflow">case</span> WM_SYSCHAR:
00372             <span class="keywordflow">case</span> WM_CHAR:
00373                 <a class="code" href="../../d0/d0/imefull_8c.html#a2">CharHandlerToConsole</a>( <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, Message, (ULONG)wParam, (ULONG)lParam );
00374                 <span class="keywordflow">break</span>;
00375 
00376             <span class="keywordflow">case</span> WM_INPUTLANGCHANGE:
00377                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: CONIME_INPUTLANGCHANGE: Console Handle=%08x \n"</span>,wParam));
00378                 <a class="code" href="../../d4/d5/conimep_8h.html#a110">InputLangchange</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)wParam, (HKL)lParam );
00379                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00380 
00381             <span class="keywordflow">case</span> WM_INPUTLANGCHANGEREQUEST:
00382                 <span class="comment">// Console IME never receive this message for this window is hidden</span>
00383                 <span class="comment">// and doesn't have focus.</span>
00384                 <span class="comment">//</span>
00385                 <span class="comment">// However, Hot key of IME_CHOTKEY_IME_NONIME_TOGGLE/IME_THOTKEY_IME_NONIME_TOGGLE</span>
00386                 <span class="comment">// are send this message by ImmSimulateHotKey API.</span>
00387                 <span class="comment">//</span>
00388                 <span class="comment">// If nothing processing by this message, then DefWindowProc calls</span>
00389                 <span class="comment">// ActivateKeyboardLayout on kernel side.</span>
00390                 <span class="comment">// And, ActivateKeyboardLayout send WM_INPUTLANGCHANGE message to focus window</span>
00391                 <span class="comment">// on this message queue.</span>
00392                 <span class="comment">// It window is console window procedure.</span>
00393                 <span class="comment">// Console window procedure can do send CONIME_INPUTLANGCHANGE message to</span>
00394                 <span class="comment">// console IME window.</span>
00395                 <span class="comment">// In console window is windowed case, this sequence as well.</span>
00396                 <span class="comment">// But, In console window is full screen case, message queue have not focus.</span>
00397                 <span class="comment">// WM_INPUTLANGCHANGE message can not send to console window procedure.</span>
00398                 <span class="comment">//</span>
00399                 <span class="comment">// This code avoid console full screen mode problem.</span>
00400                 <span class="comment">// Send message to console window procedure when this window receive it.</span>
00401                 <span class="comment">//</span>
00402                 {
00403                     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> ConTbl;
00404 
00405                     ConTbl = <a class="code" href="../../d4/d5/conimep_8h.html#a100">SearchConsole</a>(<a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a3">LastConsole</a>);
00406                     <span class="keywordflow">if</span> (ConTbl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00407                         <span class="keywordflow">return</span> <a class="code" href="../../d5/d9/cltxt_8h.html#a15">DefWindowProc</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, Message, wParam, lParam);
00408                     }
00409 
00410                     <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o1">hWndCon</a>, Message, wParam, lParam);
00411                 }
00412                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;    <span class="comment">// TRUE : process this message by application</span>
00413 
00414             <span class="keywordflow">case</span> <a class="code" href="../../d3/d5/conime_8h.html#a20">CONIME_INPUTLANGCHANGEREQUEST</a>:
00415                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: CONIME_INPUTLANGCHANGEREQUEST: Console Handle=%08x \n"</span>,wParam));
00416                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d5/conimep_8h.html#a107">ConImeInputLangchangeRequest</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, (HANDLE)wParam, (HKL)lParam, <a class="code" href="../../d3/d5/conime_8h.html#a24">CONIME_DIRECT</a>);
00417 
00418             <span class="keywordflow">case</span> <a class="code" href="../../d3/d5/conime_8h.html#a21">CONIME_INPUTLANGCHANGEREQUESTFORWARD</a>:
00419                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: CONIME_INPUTLANGCHANGEREQUEST: Console Handle=%08x \n"</span>,wParam));
00420                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d5/conimep_8h.html#a107">ConImeInputLangchangeRequest</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, (HANDLE)wParam, (HKL)lParam, <a class="code" href="../../d3/d5/conime_8h.html#a25">CONIME_FORWARD</a>);
00421 
00422             <span class="keywordflow">case</span> <a class="code" href="../../d3/d5/conime_8h.html#a22">CONIME_INPUTLANGCHANGEREQUESTBACKWARD</a>:
00423                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: CONIME_INPUTLANGCHANGEREQUEST: Console Handle=%08x \n"</span>,wParam));
00424                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d5/conimep_8h.html#a107">ConImeInputLangchangeRequest</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, (HANDLE)wParam, (HKL)lParam, <a class="code" href="../../d3/d5/conime_8h.html#a26">CONIME_BACKWARD</a>);
00425 
00426 <span class="preprocessor">#ifdef DEBUG_MODE</span>
00427 <span class="preprocessor"></span>            <span class="keywordflow">case</span> WM_MOVE:
00428                 ImeUIMoveCandWin( <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> );
00429                 <span class="keywordflow">break</span>;
00430 
00431             <span class="keywordflow">case</span> WM_COMMAND: <span class="comment">// message: command from application menu</span>
00432 
00433                 <span class="comment">// Message packing of wparam and lparam have changed for Win32,</span>
00434                 <span class="comment">// so use the GET_WM_COMMAND macro to unpack the commnad</span>
00435 
00436                 <span class="keywordflow">switch</span> (LOWORD(wParam)) {
00437                     <span class="keywordflow">case</span> <a class="code" href="../../d4/d5/conimep_8h.html#a3">MM_EXIT</a>:
00438                         <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>,WM_CLOSE,0,0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00439                         <span class="keywordflow">break</span>;
00440 
00441                     <span class="keywordflow">case</span> <a class="code" href="../../d4/d5/conimep_8h.html#a4">MM_ACCESS_VIOLATION</a>:
00442                         {
00443                             <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> p = 0;
00444                             *p = 0;
00445                         }
00446                         <span class="keywordflow">break</span>;
00447                 }
00448                 <span class="keywordflow">break</span>;
00449 <span class="preprocessor">#endif</span>
00450 <span class="preprocessor"></span>
00451             <span class="keywordflow">case</span> WM_IME_STARTCOMPOSITION:
00452                 <a class="code" href="../../d0/d6/consubs_8c.html#a1">ImeUIStartComposition</a>( <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> );
00453                 <span class="keywordflow">break</span>;
00454             <span class="keywordflow">case</span> WM_IME_ENDCOMPOSITION:
00455                 <a class="code" href="../../d0/d6/consubs_8c.html#a2">ImeUIEndComposition</a>( <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> );
00456                 <span class="keywordflow">break</span>;
00457             <span class="keywordflow">case</span> WM_IME_COMPOSITION:
00458                 <a class="code" href="../../d0/d6/consubs_8c.html#a3">ImeUIComposition</a>( <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, wParam, lParam );
00459                 <span class="keywordflow">break</span>;
00460             <span class="keywordflow">case</span> WM_IME_COMPOSITIONFULL:
00461                 <span class="keywordflow">break</span>;
00462             <span class="keywordflow">case</span> WM_IME_NOTIFY:
00463                 <span class="keywordflow">if</span> ( !<a class="code" href="../../d0/d6/consubs_8c.html#a4">ImeUINotify</a>( <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, wParam, lParam ) ) {
00464                     <span class="keywordflow">return</span> <a class="code" href="../../d5/d9/cltxt_8h.html#a15">DefWindowProc</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, Message, wParam, lParam);
00465                 }
00466                 <span class="keywordflow">break</span>;
00467             <span class="keywordflow">case</span> WM_IME_SETCONTEXT:
00468                 <span class="comment">//</span>
00469                 <span class="comment">// The application have to pass WM_IME_SETCONTEXT to DefWindowProc.</span>
00470                 <span class="comment">// When the application want to handle the IME at the timing of</span>
00471                 <span class="comment">// focus changing, the application should use WM_GETFOCUS or</span>
00472                 <span class="comment">// WM_KILLFOCUS.</span>
00473                 <span class="comment">//</span>
00474                 lParam &amp;= ~ISC_SHOWUIALL;
00475 
00476                 <span class="keywordflow">return</span> <a class="code" href="../../d5/d9/cltxt_8h.html#a15">DefWindowProc</a>( <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, Message, wParam, lParam );
00477             <span class="keywordflow">case</span> WM_IME_SYSTEM:
00478                 <span class="keywordflow">switch</span> (wParam) {
00479                     <span class="keywordflow">case</span> IMS_CLOSEPROPERTYWINDOW:
00480                     <span class="keywordflow">case</span> IMS_OPENPROPERTYWINDOW:
00481                         <a class="code" href="../../d0/d6/consubs_8c.html#a14">ImeSysPropertyWindow</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, wParam, lParam);
00482                         <span class="keywordflow">break</span>;
00483                     <span class="keywordflow">default</span>:
00484                         <span class="keywordflow">return</span> <a class="code" href="../../d5/d9/cltxt_8h.html#a15">DefWindowProc</a>( <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, Message, wParam, lParam );
00485                 }
00486                 <span class="keywordflow">break</span>;
00487 
00488             <span class="keywordflow">case</span> WM_CREATE:
00489                 <span class="keywordflow">return</span> <a class="code" href="../../d0/d6/consubs_8c.html#a0">Create</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>);
00490                 <span class="keywordflow">break</span>;
00491 
00492             <span class="keywordflow">case</span> WM_DESTROY:
00493                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME:Recieve WM_DESTROY\n"</span>));
00494                 <a class="code" href="../../d4/d5/conimep_8h.html#a97">ExitList</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>);
00495                 <a class="code" href="../../d3/d8/client_8c.html#a122">PostQuitMessage</a>(0);
00496                 <span class="keywordflow">return</span> 0;
00497                 <span class="keywordflow">break</span>;
00498 
00499             <span class="keywordflow">case</span> WM_CLOSE:
00500                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME:Recieve WM_CLOSE\n"</span>));
00501                 <a class="code" href="../../d3/d4/w32_2ntuser_2client_2nt6_2pch_8h.html#a3">DestroyWindow</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>);
00502                 <span class="keywordflow">return</span> 0;
00503                 <span class="keywordflow">break</span>;
00504 
00505             <span class="keywordflow">case</span> WM_ENABLE:{
00506                 <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> FocusedConsole;
00507                 <span class="keywordflow">if</span> (!wParam) {
00508                     FocusedConsole = <a class="code" href="../../d4/d5/conimep_8h.html#a100">SearchConsole</a>(<a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a3">LastConsole</a>);
00509                     <span class="keywordflow">if</span> (FocusedConsole != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00510                         FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o0">hConsole</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00511                         FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o27">Enable</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00512                         <a class="code" href="../../d3/d8/client_8c.html#a98">EnableWindow</a>(FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o1">hWndCon</a>,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00513                         <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a8">gfDoNotKillFocus</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00514                     }
00515                 }
00516                 <span class="keywordflow">else</span>{
00517                     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> i;
00518                     <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a0">LockConsoleTable</a>();
00519                     <span class="keywordflow">for</span> ( i = 1; i &lt; <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a6">NumberOfConsoleTable</a>; i ++){
00520                         FocusedConsole = <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a5">ConsoleTable</a>[i];
00521                         <span class="keywordflow">if</span> (FocusedConsole != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00522                         {
00523                             <span class="keywordflow">if</span> ((FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o0">hConsole</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)&amp;&amp;
00524                                 (!FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o27">Enable</a>)&amp;&amp;
00525                                 (!<a class="code" href="../../d3/d9/client_2wow_8c.html#a20">IsWindowEnabled</a>(FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o1">hWndCon</a>))){
00526                                 <a class="code" href="../../d3/d8/client_8c.html#a98">EnableWindow</a>(FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o1">hWndCon</a>,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00527                                 FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o27">Enable</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00528                                 <span class="keywordflow">if</span> (!FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o28">LateRemove</a>)
00529                                     <a class="code" href="../../d3/d8/client_8c.html#a131">SetForegroundWindow</a>(FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o1">hWndCon</a>);
00530                             }
00531                         }
00532                     }
00533                     <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a1">UnlockConsoleTable</a>();
00534                 }
00535                 <span class="keywordflow">return</span> <a class="code" href="../../d5/d9/cltxt_8h.html#a15">DefWindowProc</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, Message, wParam, lParam);
00536                 <span class="keywordflow">break</span>;
00537             }
00538 
00539 <span class="preprocessor">#ifdef DEBUG_MODE</span>
00540 <span class="preprocessor"></span>            <span class="keywordflow">case</span> WM_SETFOCUS:
00541                 <a class="code" href="../../d6/d0/usercli_8h.html#a233">CreateCaret</a>( <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>,
00542                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00543                              <a class="code" href="../../d0/d6/consubs_8c.html#a5">IsUnicodeFullWidth</a>( ConvertLine[xPos] ) ?
00544                              CaretWidth*2 : CaretWidth,
00545                              (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)cyMetrics );
00546                 <a class="code" href="../../d3/d8/client_8c.html#a128">SetCaretPos</a>( xPos * cxMetrics, 0 );
00547                 ShowCaret( <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> );
00548                 <span class="keywordflow">break</span>;
00549 
00550             <span class="keywordflow">case</span> WM_KILLFOCUS:
00551                 HideCaret( <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> );
00552                 <a class="code" href="../../d3/d8/client_8c.html#a95">DestroyCaret</a>();
00553                 <span class="keywordflow">break</span>;
00554 
00555             <span class="keywordflow">case</span> WM_PAINT:
00556                 {
00557                     PAINTSTRUCT pstruc;
00558                     HDC  hDC;
00559                     hDC = <a class="code" href="../../d3/d0/user32_8def.html#a41">BeginPaint</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>,&amp;pstruc);
00560                     ReDraw(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>);
00561                     EndPaint(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>,&amp;pstruc);
00562                     <span class="keywordflow">break</span>;
00563                 }
00564 <span class="preprocessor">#endif</span>
00565 <span class="preprocessor"></span>
00566             <span class="keywordflow">case</span> WM_QUERYENDSESSION:
00567 <span class="preprocessor">#ifdef HIRSHI_DEBUG</span>
00568 <span class="preprocessor"></span>                <span class="comment">/*</span>
00569 <span class="comment">                 * If specified ntsd debugger on this process,</span>
00570 <span class="comment">                 * then never catch WM_QUERYENDSESSION when logoff/shutdown because</span>
00571 <span class="comment">                 * this process will terminate when ntsd process terminated.</span>
00572 <span class="comment">                 */</span>
00573                 {
00574                     <span class="keywordtype">int</span> i;
00575                     i = MessageBox(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>,TEXT(<span class="stringliteral">"Could you approve exit session?"</span>), TEXT(<span class="stringliteral">"Console IME"</span>),
00576                                    MB_ICONSTOP | MB_YESNO);
00577                     <span class="keywordflow">return</span> (i == IDYES ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00578                 }
00579 <span class="preprocessor">#endif</span>
00580 <span class="preprocessor"></span>                <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;           <span class="comment">// Logoff or shutdown time.</span>
00581 
00582             <span class="keywordflow">case</span> WM_ENDSESSION:
00583                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME:Recieve WM_ENDSESSION\n"</span>));
00584                 <a class="code" href="../../d4/d5/conimep_8h.html#a97">ExitList</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>);
00585                 <span class="keywordflow">return</span> 0;
00586 
00587             <span class="keywordflow">default</span>:          <span class="comment">// Passes it on if unproccessed</span>
00588                 <span class="keywordflow">return</span> <a class="code" href="../../d5/d9/cltxt_8h.html#a15">DefWindowProc</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, Message, wParam, lParam);
00589         }
00590 
00591     } except (<a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a2">InputExceptionFilter</a>(GetExceptionInformation())) {
00592 
00593         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a9">dwConsoleThreadId</a>)
00594         {
00595             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: Exception on WndProc!!\n"</span>));
00596             UnregisterConsoleIME();
00597             <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a9">dwConsoleThreadId</a> = 0;
00598 
00599             <a class="code" href="../../d3/d4/w32_2ntuser_2client_2nt6_2pch_8h.html#a3">DestroyWindow</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>);
00600             <span class="keywordflow">return</span> 0;
00601         }
00602 
00603     }
00604 
00605 
00606     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00607 }
00608 
00609 
00610 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00611"></a><a class="code" href="../../d4/d5/conimep_8h.html#a97">00611</a> <a class="code" href="../../d4/d5/conimep_8h.html#a97">ExitList</a>(
00612     HWND hWnd
00613     )
00614 {
00615     ULONG i ,j;
00616     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> FocusedConsole;
00617 
00618     <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME:ExitList Processing\n"</span>));
00619     <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a3">ImmAssociateContext</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>,<a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a4">ghDefaultIMC</a>);
00620 
00621     <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a0">LockConsoleTable</a>();
00622 
00623     <span class="keywordflow">for</span> (i = 1; i &lt; <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a6">NumberOfConsoleTable</a>; i++) {
00624         FocusedConsole = <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a5">ConsoleTable</a>[i];
00625         <span class="keywordflow">if</span> (FocusedConsole != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00626         {
00627             <span class="keywordflow">if</span> (FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o0">hConsole</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00628                 <span class="keywordflow">if</span> (FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o27">Enable</a>) {
00629                     <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a2">ImmDestroyContext</a>(FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o5">hIMC_Original</a>);
00630                     <span class="keywordflow">if</span> ( FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00631                         LocalFree( FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a> );
00632                         FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00633                     }
00634                     <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="../../d4/d5/conimep_8h.html#a26">MAX_LISTCAND</a>; j++){
00635                         <span class="keywordflow">if</span> (FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[j] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00636                             LocalFree(FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[j]);
00637                             FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[j] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00638                             FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o20">CandListMemAllocSize</a>[j] = 0;
00639                         }
00640                     }
00641                     <span class="keywordflow">if</span> (FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00642                         LocalFree(FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>);
00643                         FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o24">CandSepAllocSize</a> = 0;
00644                     }
00645                     FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o27">Enable</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00646                 }
00647                 <span class="keywordflow">else</span>
00648                     FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o28">LateRemove</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00649             }
00650         }
00651     }
00652     LocalFree( <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a5">ConsoleTable</a> );
00653     <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a1">UnlockConsoleTable</a>();
00654 
00655     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a9">dwConsoleThreadId</a>)
00656     {
00657         AttachThreadInput(GetCurrentThreadId(), <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a9">dwConsoleThreadId</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00658         UnregisterConsoleIME();
00659         <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a9">dwConsoleThreadId</a> = 0;
00660     }
00661 }
00662 
00663 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00664"></a><a class="code" href="../../d4/d5/conimep_8h.html#a98">00664</a> <a class="code" href="../../d4/d5/conimep_8h.html#a98">InsertConsole</a>(
00665     HWND    hWnd,
00666     HANDLE  hConsole,
00667     HWND    hWndConsole
00668     )
00669 {
00670     ULONG i;
00671     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> FocusedConsole;
00672 
00673     i = 1;
00674 
00675     <span class="keywordflow">do</span> {
00676         <span class="keywordflow">for</span> (; i &lt; <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a6">NumberOfConsoleTable</a>; i++) {
00677             FocusedConsole = <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a5">ConsoleTable</a>[i];
00678 
00679             <span class="keywordflow">if</span> (FocusedConsole == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00680             {
00681                 FocusedConsole = LocalAlloc(LPTR, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">CONSOLE_TABLE</a>));
00682                 <span class="keywordflow">if</span> (FocusedConsole == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00683                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00684                 <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a5">ConsoleTable</a>[i] = FocusedConsole;
00685             }
00686 
00687             <span class="keywordflow">if</span> ((FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o0">hConsole</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00688                 (FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o28">LateRemove</a>)&amp;&amp;
00689                 (FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o27">Enable</a>)) {
00690                 <a class="code" href="../../d4/d5/conimep_8h.html#a102">RemoveConsoleWorker</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, FocusedConsole);
00691             }
00692 
00693             <span class="keywordflow">if</span> (FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o0">hConsole</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00694                 RtlZeroMemory(FocusedConsole, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">CONSOLE_TABLE</a>));
00695                 FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o30">lphklList</a> = LocalAlloc(LPTR, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/struct__HKL__TABLE.html">HKL_TABLE</a>)*<a class="code" href="../../d4/d5/conimep_8h.html#a14">HKL_INITIAL_TABLE</a>);
00696                 <span class="keywordflow">if</span> (FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o30">lphklList</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00697                 {
00698                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00699                 }
00700                 RtlZeroMemory(FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o30">lphklList</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/conimep_8h.html#a88">HKL_TABLE</a>)*<a class="code" href="../../d4/d5/conimep_8h.html#a14">HKL_INITIAL_TABLE</a>);
00701                 FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o29">hklListMax</a> = <a class="code" href="../../d4/d5/conimep_8h.html#a14">HKL_INITIAL_TABLE</a> ;
00702 
00703                 FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o4">hIMC_Current</a> = <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a1">ImmCreateContext</a>();
00704                 <span class="keywordflow">if</span> (FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o4">hIMC_Current</a> == (HIMC)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00705                     LocalFree(FocusedConsole);
00706                     FocusedConsole = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00707                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00708                 }
00709 
00710                 FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o5">hIMC_Original</a> = FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o4">hIMC_Current</a>;
00711                 FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o0">hConsole</a>      = hConsole;
00712                 FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o1">hWndCon</a>       = hWndConsole;
00713 <span class="comment">//                FocusedConsole-&gt;hklActive     = NULL;</span>
00714                 FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o27">Enable</a>        = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00715 <span class="comment">//                FocusedConsole-&gt;LateRemove    = FALSE;</span>
00716 <span class="comment">//                FocusedConsole-&gt;fNestCandidate = FALSE;</span>
00717 <span class="comment">//                FocusedConsole-&gt;fInComposition = FALSE;</span>
00718 <span class="comment">//                FocusedConsole-&gt;fInCandidate = FALSE;</span>
00719                 FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o2">ScreenBufferSize</a>.X = <a class="code" href="../../d4/d5/conimep_8h.html#a36">DEFAULT_TEMP_WIDTH</a>;
00720 
00721                 FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o15">CompAttrColor</a>[0] = <a class="code" href="../../d3/d5/conime_8h.html#a31">DEFAULT_COMP_ENTERED</a>;
00722                 FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o15">CompAttrColor</a>[1] = <a class="code" href="../../d3/d5/conime_8h.html#a32">DEFAULT_COMP_ALREADY_CONVERTED</a>;
00723                 FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o15">CompAttrColor</a>[2] = <a class="code" href="../../d3/d5/conime_8h.html#a33">DEFAULT_COMP_CONVERSION</a>;
00724                 FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o15">CompAttrColor</a>[3] = <a class="code" href="../../d3/d5/conime_8h.html#a34">DEFAULT_COMP_YET_CONVERTED</a>;
00725                 FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o15">CompAttrColor</a>[4] = <a class="code" href="../../d3/d5/conime_8h.html#a35">DEFAULT_COMP_INPUT_ERROR</a>;
00726                 FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o15">CompAttrColor</a>[5] = <a class="code" href="../../d3/d5/conime_8h.html#a35">DEFAULT_COMP_INPUT_ERROR</a>;
00727                 FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o15">CompAttrColor</a>[6] = <a class="code" href="../../d3/d5/conime_8h.html#a35">DEFAULT_COMP_INPUT_ERROR</a>;
00728                 FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o15">CompAttrColor</a>[7] = <a class="code" href="../../d3/d5/conime_8h.html#a35">DEFAULT_COMP_INPUT_ERROR</a>;
00729 
00730                 <a class="code" href="../../d6/d7/country_8c.html#a15">GetIMEName</a>(FocusedConsole);
00731 
00732                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00733             }
00734         }
00735     } <span class="keywordflow">while</span> (<a class="code" href="../../d4/d5/conimep_8h.html#a99">GrowConsoleTable</a>());
00736 
00737     <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: Cannot grow Console Table\n"</span>));
00738     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00739 }
00740 
00741 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00742"></a><a class="code" href="../../d4/d5/conimep_8h.html#a99">00742</a> <a class="code" href="../../d4/d5/conimep_8h.html#a99">GrowConsoleTable</a>(
00743     VOID
00744     )
00745 {
00746     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> *NewTable;
00747     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> *OldTable;
00748     ULONG MaxConsoleTable;
00749 
00750     MaxConsoleTable = <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a6">NumberOfConsoleTable</a> + <a class="code" href="../../d4/d5/conimep_8h.html#a13">CONSOLE_CONSOLE_TABLE_INCREMENT</a>;
00751     NewTable = (<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> *)LocalAlloc(LPTR, MaxConsoleTable * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a>));
00752     <span class="keywordflow">if</span> (NewTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00753         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00754     }
00755     CopyMemory(NewTable, <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a5">ConsoleTable</a>, <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a6">NumberOfConsoleTable</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/conimep_8h.html#a91">PCONSOLE_TABLE</a>));
00756 
00757     OldTable = <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a5">ConsoleTable</a>;
00758     <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a5">ConsoleTable</a> = NewTable;
00759     <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a6">NumberOfConsoleTable</a> = MaxConsoleTable;
00760 
00761     LocalFree(OldTable);
00762 
00763     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00764 }
00765 
00766 <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a>
<a name="l00767"></a><a class="code" href="../../d4/d5/conimep_8h.html#a100">00767</a> <a class="code" href="../../d4/d5/conimep_8h.html#a100">SearchConsole</a>(
00768     HANDLE hConsole
00769     )
00770 {
00771     ULONG i;
00772     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> FocusedConsole;
00773 
00774     <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a0">LockConsoleTable</a>();
00775 
00776     <span class="comment">// conime receive ime message from console before 1st console registered.</span>
00777     <span class="comment">// this will happen after restart conime when conime dead by bogus ime's AV or </span>
00778     <span class="comment">// other problem</span>
00779     <span class="comment">// so this fail safe code is  necessary to protect consrv.</span>
00780     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a3">LastConsole</a> == 0) {
00781         <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a3">LastConsole</a> = hConsole ;
00782     }
00783 
00784     <span class="keywordflow">for</span> (i = 1; i &lt; <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a6">NumberOfConsoleTable</a>; i++) {
00785         FocusedConsole = <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a5">ConsoleTable</a>[i];
00786         <span class="keywordflow">if</span> (FocusedConsole != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00787         {
00788             <span class="keywordflow">if</span> ((FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o0">hConsole</a> == hConsole)&amp;&amp;
00789                 (!FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o28">LateRemove</a>)) {
00790 
00791                 <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a1">UnlockConsoleTable</a>();
00792                 <span class="keywordflow">return</span> FocusedConsole;
00793             }
00794         }
00795     }
00796     <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a1">UnlockConsoleTable</a>();
00797     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00798 }
00799 
00800 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00801"></a><a class="code" href="../../d4/d5/conimep_8h.html#a101">00801</a> <a class="code" href="../../d0/d5/srvinit_8c.html#a37">RemoveConsole</a>(
00802     HWND hwnd,
00803     HANDLE hConsole
00804     )
00805 {
00806     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> ConTbl;
00807     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> ret;
00808 
00809     <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a0">LockConsoleTable</a>();
00810 
00811     ConTbl = <a class="code" href="../../d4/d5/conimep_8h.html#a100">SearchConsole</a>(hConsole);
00812     <span class="keywordflow">if</span> (ConTbl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00813     {
00814         <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a1">UnlockConsoleTable</a>();
00815         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00816     }
00817     ret = <a class="code" href="../../d4/d5/conimep_8h.html#a102">RemoveConsoleWorker</a>(hwnd, ConTbl);
00818 
00819     <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a1">UnlockConsoleTable</a>();
00820     <span class="keywordflow">return</span> ret;
00821 }
00822 
00823 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00824"></a><a class="code" href="../../d4/d5/conimep_8h.html#a102">00824</a> <a class="code" href="../../d4/d5/conimep_8h.html#a102">RemoveConsoleWorker</a>(
00825     HWND hwnd,
00826     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> ConTbl
00827     )
00828 {
00829     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> j;
00830 
00831     <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o27">Enable</a>) {
00832         ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o0">hConsole</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00833         ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o2">ScreenBufferSize</a>.X = 0;
00834         ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o9">ConsoleCP</a> = 0;
00835         ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o10">ConsoleOutputCP</a> = 0;
00836         ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o3">hklActive</a> = 0;
00837 
00838         <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a2">ImmDestroyContext</a>(ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o5">hIMC_Original</a>);
00839 
00840         <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>){
00841             LocalFree(ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a>);
00842         }
00843         <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="../../d4/d5/conimep_8h.html#a26">MAX_LISTCAND</a>; j++){
00844             <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[j] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00845                 LocalFree(ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[j]);
00846             }
00847         }
00848         <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00849             LocalFree(ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>);
00850         }
00851 
00852         <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o30">lphklList</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00853             LocalFree(ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o30">lphklList</a>) ;
00854         }
00855 
00856         ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o27">Enable</a>     = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00857         ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o28">LateRemove</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00858     }
00859     <span class="keywordflow">else</span>
00860         ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o28">LateRemove</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00861 
00862 <span class="preprocessor">#ifdef DEBUG_MODE</span>
00863 <span class="preprocessor"></span>    InvalidateRect(hwnd,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00864 <span class="preprocessor">#endif</span>
00865 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00866 }
00867 
00868 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00869"></a><a class="code" href="../../d4/d5/conimep_8h.html#a103">00869</a> <a class="code" href="../../d4/d5/conimep_8h.html#a103">InsertNewConsole</a>(
00870     HWND   hWnd,
00871     HANDLE hConsole,
00872     HWND   hWndConsole
00873     )
00874 {
00875     <span class="comment">// conime receive ime message from console before 1st console registered.</span>
00876     <span class="comment">// this will happen after restart conime when conime dead by bogus ime's AV or </span>
00877     <span class="comment">// other problem</span>
00878     <span class="comment">// so this fail safe code is  necessary to protect consrv.</span>
00879     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d5/conimep_8h.html#a100">SearchConsole</a>(hConsole) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00880         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00881     }
00882 
00883     <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a0">LockConsoleTable</a>();
00884 
00885     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d5/conimep_8h.html#a98">InsertConsole</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, hConsole, hWndConsole)) {
00886         <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a1">UnlockConsoleTable</a>();
00887         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00888     }
00889 
00890 <span class="preprocessor">#ifdef DEBUG_MODE</span>
00891 <span class="preprocessor"></span>    DisplayInformation(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, hConsole);
00892 <span class="preprocessor">#endif</span>
00893 <span class="preprocessor"></span>
00894     <a class="code" href="../../d0/d6/consubs_8c.html#a8">ImeUISetOpenStatus</a>( hWndConsole );
00895 
00896     <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a1">UnlockConsoleTable</a>();
00897 
00898     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00899 }
00900 
00901 
00902 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00903"></a><a class="code" href="../../d4/d5/conimep_8h.html#a104">00903</a> <a class="code" href="../../d4/d5/conimep_8h.html#a104">ConsoleSetFocus</a>(
00904     HWND hWnd,
00905     HANDLE hConsole,
00906     HKL hKL
00907     )
00908 {
00909     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> ConTbl;
00910     HKL OldhKL;
00911 
00912     ConTbl = <a class="code" href="../../d4/d5/conimep_8h.html#a100">SearchConsole</a>(hConsole);
00913     <span class="keywordflow">if</span> (ConTbl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00914         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: Error! Cannot found registed Console\n"</span>));
00915         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00916     }
00917 
00918     <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a8">gfDoNotKillFocus</a> ){
00919         <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a8">gfDoNotKillFocus</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00920     }
00921 
00922     OldhKL = ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o3">hklActive</a> ;
00923     ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o3">hklActive</a> = hKL;
00924     <a class="code" href="../../d3/d0/user32_8def.html#a45">ActivateKeyboardLayout</a>(ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o3">hklActive</a>, 0);
00925     <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a3">ImmAssociateContext</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o4">hIMC_Current</a>);
00926 
00927     <span class="keywordflow">if</span> (OldhKL == 0) {
00928         <a class="code" href="../../d6/d7/country_8c.html#a15">GetIMEName</a>( ConTbl );
00929         ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o26">ImmGetProperty</a> = <a class="code" href="../../d4/d1/layout_8c.html#a17">ImmGetProperty</a>(ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o3">hklActive</a> , IGP_PROPERTY);
00930     }
00931 
00932 <span class="comment">//v-hirshi Jun.13.1996 #if defined(LATER_DBCS)  // kazum</span>
00933     <a class="code" href="../../d1/d5/ntuser_2imm_2conime_8c.html#a4">ImmSetActiveContextConsoleIME</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00934 <span class="comment">//v-hirshi Jun.13.1996 #endif</span>
00935 
00936     <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a3">LastConsole</a> = hConsole;
00937 
00938 <span class="preprocessor">#ifdef DEBUG_MODE</span>
00939 <span class="preprocessor"></span>    DisplayInformation(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, hConsole);
00940 <span class="preprocessor">#endif</span>
00941 <span class="preprocessor"></span>
00942     <a class="code" href="../../d0/d6/consubs_8c.html#a8">ImeUISetOpenStatus</a>( <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> );
00943     <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00944         <a class="code" href="../../d8/d7/country3_8c.html#a5">ReDisplayCompositionStr</a>( <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> );
00945 
00946     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00947 }
00948 
00949 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00950"></a><a class="code" href="../../d4/d5/conimep_8h.html#a105">00950</a> <a class="code" href="../../d4/d5/conimep_8h.html#a105">ConsoleKillFocus</a>(
00951     HWND hWnd,
00952     HANDLE hConsole
00953     )
00954 {
00955     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> ConTbl;
00956 
00957     ConTbl = <a class="code" href="../../d4/d5/conimep_8h.html#a100">SearchConsole</a>(hConsole);
00958     <span class="keywordflow">if</span> (ConTbl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00959         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: Error! Cannot found registed Console\n"</span>));
00960         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00961     }
00962 
00963     <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a8">gfDoNotKillFocus</a> ){
00964         <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a8">gfDoNotKillFocus</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00965     }
00966     <span class="keywordflow">else</span>{
00967 <span class="comment">//v-hirshi Jun.13.1996 #if defined(LATER_DBCS)  // kazum</span>
00968         <a class="code" href="../../d1/d5/ntuser_2imm_2conime_8c.html#a4">ImmSetActiveContextConsoleIME</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00969 <span class="comment">//v-hirshi Jun.13.1996 #endif</span>
00970         <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a3">ImmAssociateContext</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a4">ghDefaultIMC</a>);
00971     }
00972 
00973 <span class="preprocessor">#ifdef DEBUG_MODE</span>
00974 <span class="preprocessor"></span>    DisplayInformation(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, hConsole);
00975 <span class="preprocessor">#endif</span>
00976 <span class="preprocessor"></span>
00977     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00978 }
00979 
00980 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00981"></a><a class="code" href="../../d4/d5/conimep_8h.html#a106">00981</a> <a class="code" href="../../d4/d5/conimep_8h.html#a106">ConsoleScreenBufferSize</a>(
00982     HWND hWnd,
00983     HANDLE hConsole,
00984     COORD ScreenBufferSize
00985     )
00986 {
00987     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> ConTbl;
00988 
00989     ConTbl = <a class="code" href="../../d4/d5/conimep_8h.html#a100">SearchConsole</a>(hConsole);
00990     <span class="keywordflow">if</span> (ConTbl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00991         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: Error! Cannot found registed Console\n"</span>));
00992         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00993     }
00994 
00995     ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o2">ScreenBufferSize</a> = ScreenBufferSize;
00996     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00997 }
00998 
00999 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l01000"></a><a class="code" href="../../d4/d5/conimep_8h.html#a107">01000</a> <a class="code" href="../../d4/d5/conimep_8h.html#a107">ConImeInputLangchangeRequest</a>(
01001     HWND hWnd,
01002     HANDLE hConsole,
01003     HKL hkl,
01004     <span class="keywordtype">int</span> Direction
01005     )
01006 {
01007     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> ConTbl;
01008     <span class="keywordtype">int</span> nLayouts;
01009     LPHKL lphkl;
01010     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> RequiredLID = 0;
01011     <span class="keywordtype">int</span> StartPos;
01012     <span class="keywordtype">int</span> CurrentHklPos;
01013     <span class="keywordtype">int</span> i;
01014 
01015     ConTbl = <a class="code" href="../../d4/d5/conimep_8h.html#a100">SearchConsole</a>(hConsole);
01016     <span class="keywordflow">if</span> (ConTbl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01017         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: cannot find registered Console\n"</span>));
01018         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01019     }
01020 
01021     <span class="keywordflow">switch</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o10">ConsoleOutputCP</a>) {
01022         <span class="keywordflow">case</span> <a class="code" href="../../d4/d5/conimep_8h.html#a64">JAPAN_CODEPAGE</a>:
01023             RequiredLID = <a class="code" href="../../d4/d5/conimep_8h.html#a43">LANG_ID_JAPAN</a>;
01024             <span class="keywordflow">break</span>;
01025         <span class="keywordflow">case</span> <a class="code" href="../../d4/d5/conimep_8h.html#a65">PRC_CODEPAGE</a>:
01026             RequiredLID = <a class="code" href="../../d4/d5/conimep_8h.html#a45">LANG_ID_PRC</a>;
01027             <span class="keywordflow">break</span>;
01028         <span class="keywordflow">case</span> <a class="code" href="../../d4/d5/conimep_8h.html#a66">KOREA_CODEPAGE</a>:
01029             RequiredLID = <a class="code" href="../../d4/d5/conimep_8h.html#a44">LANG_ID_KOREA</a>;
01030             <span class="keywordflow">break</span>;
01031         <span class="keywordflow">case</span> <a class="code" href="../../d4/d5/conimep_8h.html#a67">TAIWAN_CODEPAGE</a>:
01032             RequiredLID = <a class="code" href="../../d4/d5/conimep_8h.html#a42">LANG_ID_TAIWAN</a>;
01033             <span class="keywordflow">break</span>;
01034         <span class="keywordflow">default</span>:
01035             <span class="keywordflow">break</span>;
01036     }
01037 
01038     <span class="keywordflow">if</span> ( !<a class="code" href="../../d4/d5/conimep_8h.html#a49">IS_IME_KBDLAYOUT</a>(hkl) ||
01039         ( <a class="code" href="../../d4/d5/conimep_8h.html#a50">HKL_TO_LANGID</a>(hkl) == RequiredLID)) {
01040         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01041     }
01042     <span class="keywordflow">if</span> (Direction == <a class="code" href="../../d3/d5/conime_8h.html#a24">CONIME_DIRECT</a>) {
01043         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01044     }
01045 
01046     nLayouts = GetKeyboardLayoutList(0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01047     <span class="keywordflow">if</span> (nLayouts == 0) {
01048         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01049     }
01050     lphkl = LocalAlloc(LPTR, nLayouts * <span class="keyword">sizeof</span>(HKL));
01051     <span class="keywordflow">if</span> (lphkl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01052         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01053     }
01054     GetKeyboardLayoutList(nLayouts, lphkl);
01055 
01056     <span class="keywordflow">for</span> (CurrentHklPos = 0; CurrentHklPos &lt; nLayouts; CurrentHklPos++) {
01057         <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o3">hklActive</a> == lphkl[CurrentHklPos] ) {
01058             <span class="keywordflow">break</span>;
01059         }
01060     }
01061     <span class="keywordflow">if</span> (CurrentHklPos &gt;= nLayouts) {
01062         LocalFree(lphkl);
01063         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01064     }
01065 
01066     StartPos = CurrentHklPos;
01067 
01068     <span class="keywordflow">for</span> (i = 0; i &lt; nLayouts; i++) {
01069         StartPos+=Direction;
01070         <span class="keywordflow">if</span> (StartPos &lt; 0) {
01071             StartPos = nLayouts-1;
01072         }
01073         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (StartPos &gt;= nLayouts) {
01074             StartPos = 0;
01075         }
01076         
01077         <span class="keywordflow">if</span> ((( HandleToUlong(lphkl[StartPos]) &amp; 0xf0000000) == 0x00000000) ||
01078             (( HandleToUlong(lphkl[StartPos]) &amp; 0x0000ffff) == RequiredLID)) {
01079             <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o1">hWndCon</a>,
01080                          <a class="code" href="../../d3/d5/conime_8h.html#a27">CM_CONIME_KL_ACTIVATE</a>,
01081                           HandleToUlong(lphkl[StartPos]),
01082                          0);
01083             LocalFree(lphkl);
01084             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01085         }
01086     }
01087 
01088     LocalFree(lphkl);
01089     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01090 
01091 }
01092 
01093 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l01094"></a><a class="code" href="../../d4/d5/conimep_8h.html#a108">01094</a> <a class="code" href="../../d4/d5/conimep_8h.html#a108">ConImeInputLangchange</a>(
01095     HWND hWnd,
01096     HANDLE hConsole,
01097     HKL hkl
01098     )
01099 {
01100     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> ConTbl;
01101     <a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html">LPCONIME_UIMODEINFO</a> lpModeInfo;
01102     COPYDATASTRUCT CopyData;
01103     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> counter ;
01104     <a class="code" href="../../d0/d8/struct__HKL__TABLE.html">LPHKL_TABLE</a> lphklListNew ;
01105 
01106     ConTbl = <a class="code" href="../../d4/d5/conimep_8h.html#a100">SearchConsole</a>(hConsole);
01107     <span class="keywordflow">if</span> (ConTbl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01108         <span class="comment">// cannot find specified console.</span>
01109         <span class="comment">// It might be last console lost focus.</span>
01110         <span class="comment">// try Last Console.</span>
01111         ConTbl = <a class="code" href="../../d4/d5/conimep_8h.html#a100">SearchConsole</a>(<a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a3">LastConsole</a>);
01112         <span class="keywordflow">if</span> (ConTbl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01113             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: Error! Cannot found registed Console\n"</span>));
01114             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01115         }
01116     }
01117 
01118     <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o30">lphklList</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01119         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01120     }
01121 
01122     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d5/conimep_8h.html#a49">IS_IME_KBDLAYOUT</a>(ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o3">hklActive</a>)) {
01123         <span class="keywordflow">for</span> (counter = 0 ; counter &lt; ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o29">hklListMax</a> ;counter ++) 
01124         {
01125             <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o30">lphklList</a>[counter].<a class="code" href="../../d0/d8/struct__HKL__TABLE.html#o0">hkl</a> == 0 || ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o30">lphklList</a>[counter].<a class="code" href="../../d0/d8/struct__HKL__TABLE.html#o0">hkl</a> == ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o3">hklActive</a>) {
01126                 <span class="keywordflow">break</span>;
01127             }
01128         }
01129 
01130         <span class="keywordflow">if</span> (counter &gt;= ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o29">hklListMax</a>)
01131         {
01132             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(counter == ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o29">hklListMax</a>);
01133             <span class="comment">// reallocation</span>
01134             lphklListNew = LocalAlloc(LPTR, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/struct__HKL__TABLE.html">HKL_TABLE</a>) * (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o29">hklListMax</a> + <a class="code" href="../../d4/d5/conimep_8h.html#a15">HKL_TABLE_INCREMENT</a>) ) ;
01135             <span class="keywordflow">if</span> (lphklListNew != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01136             {
01137                 CopyMemory(lphklListNew , ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o30">lphklList</a> , <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/conimep_8h.html#a88">HKL_TABLE</a>) * ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o29">hklListMax</a>) ;
01138                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o29">hklListMax</a> += <a class="code" href="../../d4/d5/conimep_8h.html#a15">HKL_TABLE_INCREMENT</a> ;
01139                 LocalFree(ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o30">lphklList</a>);
01140                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o30">lphklList</a> = lphklListNew;
01141             }
01142             <span class="keywordflow">else</span> {
01143                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
01144             }
01145         }
01146         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o30">lphklList</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01147         ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o30">lphklList</a>[counter].<a class="code" href="../../d0/d8/struct__HKL__TABLE.html#o0">hkl</a> = ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o3">hklActive</a>;
01148         ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o30">lphklList</a>[counter].<a class="code" href="../../d0/d8/struct__HKL__TABLE.html#o1">dwConversion</a> = ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o7">dwConversion</a> | (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o6">fOpen</a> ? <a class="code" href="../../d3/d5/conime_8h.html#a29">IME_CMODE_OPEN</a> : 0)  ;
01149     }
01150 
01151     <a class="code" href="../../d3/d0/user32_8def.html#a45">ActivateKeyboardLayout</a>(hkl, 0);
01152     ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o3">hklActive</a> = hkl;
01153     <a class="code" href="../../d6/d7/country_8c.html#a15">GetIMEName</a>( ConTbl );
01154     <a class="code" href="../../d0/d6/consubs_8c.html#a6">ImeUIOpenStatusWindow</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>);
01155     ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o26">ImmGetProperty</a> = <a class="code" href="../../d4/d1/layout_8c.html#a17">ImmGetProperty</a>(ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o3">hklActive</a> , IGP_PROPERTY);
01156 
01157     lpModeInfo = (<a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html">LPCONIME_UIMODEINFO</a>)LocalAlloc( LPTR, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html">CONIME_UIMODEINFO</a>) ) ;
01158     <span class="keywordflow">if</span> ( lpModeInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01159         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01160     }
01161     CopyData.dwData = <a class="code" href="../../d3/d5/conime_8h.html#a5">CI_CONIMEMODEINFO</a> ;
01162     CopyData.cbData = <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d5/conime_8h.html#a42">CONIME_UIMODEINFO</a>) ;
01163     CopyData.lpData = lpModeInfo ;
01164 
01165     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d5/conimep_8h.html#a49">IS_IME_KBDLAYOUT</a>(hkl)) {
01166 
01167         <span class="keywordflow">for</span> (counter=0; counter &lt; ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o29">hklListMax</a> ; counter++)
01168         {
01169             <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o30">lphklList</a>[counter].<a class="code" href="../../d0/d8/struct__HKL__TABLE.html#o0">hkl</a> == hkl)
01170             {
01171                 <a class="code" href="../../d0/d6/consubs_8c.html#a12">SetNLSMode</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, hConsole,ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o30">lphklList</a>[counter].<a class="code" href="../../d0/d8/struct__HKL__TABLE.html#o1">dwConversion</a> ) ;
01172                 <a class="code" href="../../d0/d6/consubs_8c.html#a6">ImeUIOpenStatusWindow</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>) ;
01173                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d7/country_8c.html#a17">ImeUIMakeInfoString</a>(ConTbl,
01174                                         lpModeInfo))
01175                 {
01176                     <a class="code" href="../../d4/d5/conimep_8h.html#a109">ConsoleImeSendMessage</a>( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o1">hWndCon</a>,
01177                                            (WPARAM)<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>,
01178                                            (LPARAM)&amp;CopyData
01179                                          ) ;
01180                 }
01181             }
01182         }
01183     }
01184     <span class="keywordflow">else</span>
01185     {
01186 
01187         <a class="code" href="../../d0/d6/consubs_8c.html#a12">SetNLSMode</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, hConsole,ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o7">dwConversion</a> &amp; ~<a class="code" href="../../d3/d5/conime_8h.html#a29">IME_CMODE_OPEN</a> ) ;
01188         lpModeInfo-&gt;<a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html#o0">ModeStringLen</a> = 0 ;
01189         lpModeInfo-&gt;<a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html#o1">Position</a> = <a class="code" href="../../d3/d5/conime_8h.html#a2">VIEW_RIGHT</a> ;
01190         <a class="code" href="../../d4/d5/conimep_8h.html#a109">ConsoleImeSendMessage</a>( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o1">hWndCon</a>,
01191                                (WPARAM)<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>,
01192                                (LPARAM)&amp;CopyData
01193                               ) ;
01194     }
01195 
01196     LocalFree( lpModeInfo );
01197 
01198     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01199 }
01200 
01201 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l01202"></a><a class="code" href="../../d4/d5/conimep_8h.html#a110">01202</a> <a class="code" href="../../d4/d5/conimep_8h.html#a110">InputLangchange</a>(
01203     HWND hWnd,
01204     DWORD CharSet,
01205     HKL hkl
01206     )
01207 {
01208     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> ConTbl;
01209 
01210     ConTbl = <a class="code" href="../../d4/d5/conimep_8h.html#a100">SearchConsole</a>(<a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a3">LastConsole</a>);
01211     <span class="keywordflow">if</span> (ConTbl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01212         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: Error! Cannot found registed Console\n"</span>));
01213         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01214     }
01215 
01216     ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o3">hklActive</a> = hkl;
01217     <a class="code" href="../../d3/d0/user32_8def.html#a45">ActivateKeyboardLayout</a>(ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o3">hklActive</a>, 0);
01218     <a class="code" href="../../d6/d7/country_8c.html#a15">GetIMEName</a>( ConTbl );
01219     <a class="code" href="../../d0/d6/consubs_8c.html#a6">ImeUIOpenStatusWindow</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>);
01220     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01221 }
01222 
01223 <span class="comment">/*</span>
01224 <span class="comment"> * Console IME message pump.</span>
01225 <span class="comment"> */</span>
01226 LRESULT
<a name="l01227"></a><a class="code" href="../../d4/d5/conimep_8h.html#a109">01227</a> <a class="code" href="../../d4/d5/conimep_8h.html#a109">ConsoleImeSendMessage</a>(
01228     HWND   hWndConsoleIME,
01229     WPARAM wParam,
01230     LPARAM lParam
01231     )
01232 {
01233     LRESULT lResult;
01234     LRESULT fNoTimeout;
01235 
01236     <span class="keywordflow">if</span> (hWndConsoleIME == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01237     {
01238         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01239     }
01240 
01241     fNoTimeout = <a class="code" href="../../d5/d9/cltxt_8h.html#a17">SendMessageTimeout</a>(hWndConsoleIME,
01242                                     WM_COPYDATA,
01243                                     wParam,
01244                                     lParam,
01245                                     SMTO_ABORTIFHUNG | SMTO_NORMAL,
01246                                     <a class="code" href="../../d3/d5/conime_8h.html#a28">CONIME_SENDMSG_TIMEOUT</a>,
01247                                     &amp;lResult);
01248 
01249     <span class="keywordflow">if</span> (fNoTimeout)
01250     {
01251         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01252     }
01253 
01254 
01255     <span class="comment">/*</span>
01256 <span class="comment">     * ConsoleImeMessagePump give up SendMessage to conime.</span>
01257 <span class="comment">     * CONIME is hung up.</span>
01258 <span class="comment">     * probably, consrv also hung up.</span>
01259 <span class="comment">     */</span>
01260     KdPrint((<span class="stringliteral">"ConsoleImeSendMessage: CONIME_SENDMSG_COUNT is hung up\n"</span>));
01261 
01262     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01263 
01264 }
01265 
01266 <span class="preprocessor">#ifdef DEBUG_MODE</span>
01267 <span class="preprocessor"></span>
01268 <span class="keywordtype">int</span>             cxMetrics;
01269 <span class="keywordtype">int</span>             cyMetrics;
01270 <span class="keywordtype">int</span>             cxOverTypeCaret;
01271 <span class="keywordtype">int</span>             xPos;
01272 <span class="keywordtype">int</span>             xPosLast;
01273 <span class="keywordtype">int</span>             CaretWidth;                     <span class="comment">// insert/overtype mode caret width</span>
01274 
01275 WCHAR           ConvertLine[<a class="code" href="../../d4/d5/conimep_8h.html#a16">CVMAX</a>];
01276 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>   ConvertLineAtr[<a class="code" href="../../d4/d5/conimep_8h.html#a16">CVMAX</a>];
01277 
01278 WCHAR           DispTitle[] = TEXT(<span class="stringliteral">" Console Handle"</span>);
01279 
01280 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> CompColor[ 8 ] = { RGB(   0,   0,   0 ),  <span class="comment">// ATTR_INPUT</span>
01281                          RGB(   0,   0, 255 ),  <span class="comment">// ATTR_TARGET_CONVERTED</span>
01282                          RGB(   0, 255,   0 ),  <span class="comment">// ATTR_CONVERTED</span>
01283                          RGB( 255,   0,   0 ),  <span class="comment">// ATTR_TARGET_NOTCONVERTED</span>
01284                          RGB( 255,   0, 255 ),  <span class="comment">// ATTR_INPUT_ERROR</span>
01285                          RGB(   0, 255, 255 ),  <span class="comment">// ATTR_DEFAULT</span>
01286                          RGB( 255, 255,   0 ),  <span class="comment">// ATTR_DEFAULT</span>
01287                          RGB( 255, 255, 255 ) };<span class="comment">// ATTR_DEFAULT</span>
01288 
01289 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01290 DisplayConvInformation(
01291     HWND hWnd
01292     )
01293 {
01294     RECT      <a class="code" href="../../d5/d6/structRect.html">Rect</a>;
01295     HDC       lhdc;
01296 
01297     lhdc = <a class="code" href="../../d3/d4/w32_2ntuser_2client_2nt6_2pch_8h.html#a1">GetDC</a>(hWnd);
01298     <a class="code" href="../../d3/d9/client_2wow_8c.html#a24">GetClientRect</a>(hWnd, &amp;Rect);
01299 
01300     InvalidateRect(hWnd,NULL,FALSE);
01301     <a class="code" href="../../d3/d8/client_8c.html#a140">UpdateWindow</a>(hWnd);
01302     <a class="code" href="../../d3/d8/client_8c.html#a45">ReleaseDC</a>(hWnd, lhdc);
01303 }
01304 
01305 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01306 DisplayInformation(
01307     HWND hWnd,
01308     HANDLE hConsole
01309     )
01310 {
01311     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> ConTbl;
01312     RECT      <a class="code" href="../../d5/d6/structRect.html">Rect</a>;
01313     HDC       lhdc;
01314 
01315     ConTbl = <a class="code" href="../../d4/d5/conimep_8h.html#a100">SearchConsole</a>(hConsole);
01316     <span class="keywordflow">if</span> (ConTbl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01317         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: Error! Cannot found registed Console\n"</span>));
01318         <span class="keywordflow">return</span>;
01319     }
01320 
01321     lhdc = <a class="code" href="../../d3/d4/w32_2ntuser_2client_2nt6_2pch_8h.html#a1">GetDC</a>(hWnd);
01322     <a class="code" href="../../d3/d9/client_2wow_8c.html#a24">GetClientRect</a>(hWnd, &amp;Rect);
01323 
01324     wsprintf(ConTbl-&gt;DispBuf, TEXT(<span class="stringliteral">"%08x"</span>), (ULONG)hConsole);
01325 
01326     InvalidateRect(hWnd,NULL,FALSE);
01327     <a class="code" href="../../d3/d8/client_8c.html#a140">UpdateWindow</a>(hWnd);
01328     <a class="code" href="../../d3/d8/client_8c.html#a45">ReleaseDC</a>(hWnd, lhdc);
01329 }
01330 
01331 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01332 RealReDraw(
01333     HDC r_hdc
01334     )
01335 {
01336     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> ConTbl;
01337     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>     ix, iy, i, rx, sx;
01338     ULONG   cnt;
01339     <span class="keywordtype">int</span>     ColorIndex;
01340     <span class="keywordtype">int</span>     PrevColorIndex;
01341     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwColor;
01342 
01343     iy = 0;
01344 
01345     dwColor = GetTextColor( r_hdc );
01346 
01347     ColorIndex = ( ((<span class="keywordtype">int</span>)ConvertLineAtr[0]) &lt; 0 ) ? 0 : (<span class="keywordtype">int</span>)ConvertLineAtr[0];
01348     ColorIndex = ( ColorIndex &gt; 7 ) ? 0 : ColorIndex;
01349     PrevColorIndex = ColorIndex;
01350     SetTextColor( r_hdc, CompColor[ ColorIndex ] );
01351 
01352     rx = 0;
01353     sx = 0;
01354     <span class="keywordflow">for</span> (ix = 0; ix &lt; <a class="code" href="../../d4/d5/conimep_8h.html#a20">MAXCOL</a>; ) {
01355         <span class="keywordflow">for</span> (i = ix; i &lt; <a class="code" href="../../d4/d5/conimep_8h.html#a20">MAXCOL</a>; i++) {
01356             <span class="keywordflow">if</span> (PrevColorIndex != (<span class="keywordtype">int</span>)ConvertLineAtr[i])
01357                 <span class="keywordflow">break</span>;
01358             rx += <a class="code" href="../../d0/d6/consubs_8c.html#a5">IsUnicodeFullWidth</a>(ConvertLine[ix]) ? 2 : 1;
01359         }
01360         TextOut( r_hdc, sx * cxMetrics, iy, &amp;ConvertLine[ix], i-ix );
01361         sx = rx;
01362         ColorIndex = ( ((<span class="keywordtype">int</span>)ConvertLineAtr[i]) &lt; 0 ) ? 0 : (<span class="keywordtype">int</span>)ConvertLineAtr[i];
01363         ColorIndex = ( ColorIndex &gt; 7 ) ? 0 : ColorIndex;
01364         PrevColorIndex = ColorIndex;
01365         SetTextColor( r_hdc, CompColor[ ColorIndex ] );
01366         ix = i;
01367     }
01368 
01369     ix = 0;
01370     SetTextColor( r_hdc, dwColor );
01371     iy += cyMetrics;
01372     TextOut( r_hdc, ix, iy, DispTitle, lstrlenW(DispTitle));
01373 
01374     iy += cyMetrics;
01375 
01376     <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a0">LockConsoleTable</a>();
01377 
01378     <span class="keywordflow">for</span> (cnt = 1; cnt &lt; <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a6">NumberOfConsoleTable</a>; cnt++, iy += cyMetrics){
01379         ConTbl = <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a5">ConsoleTable</a>[cnt];
01380         <span class="keywordflow">if</span> (ConTbl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01381         {
01382             <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o0">hConsole</a>)
01383             {
01384                 TextOut( r_hdc, ix, iy, ConTbl-&gt;DispBuf, lstrlenW(ConTbl-&gt;DispBuf) );
01385             }
01386         }
01387     }
01388 
01389     <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a1">UnlockConsoleTable</a>();
01390 
01391     <span class="keywordflow">return</span>;
01392 }
01393 
01394 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01395 ReDraw(
01396     HWND hWnd
01397     )
01398 {
01399     HDC r_hdc;
01400     RECT ClientRect;
01401 
01402     <a class="code" href="../../d3/d9/client_2wow_8c.html#a24">GetClientRect</a>(hWnd, &amp;ClientRect);
01403     r_hdc = <a class="code" href="../../d3/d4/w32_2ntuser_2client_2nt6_2pch_8h.html#a1">GetDC</a>(hWnd);
01404     <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>(r_hdc, &amp;ClientRect, GetStockObject(WHITE_BRUSH));
01405     RealReDraw(r_hdc);
01406     <a class="code" href="../../d3/d8/client_8c.html#a45">ReleaseDC</a>(hWnd, r_hdc);
01407     <span class="keywordflow">return</span>;
01408 }
01409 <span class="preprocessor">#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:32 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
