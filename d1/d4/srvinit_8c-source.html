<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: srvinit.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>srvinit.c</h1><a href="../../d0/d5/srvinit_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    srvinit.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This is the main initialization file for the console</span>
00012 <span class="comment">    Server.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Therese Stowell (thereses) 11-Nov-1990</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include "<a class="code" href="../../d6/d3/w32_2ntcon_2server_2precomp_8h.html">precomp.h</a>"</span>
00023 <span class="preprocessor">#pragma hdrstop</span>
00024 <span class="preprocessor"></span>
00025 
<a name="l00026"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a2">00026</a> CONST PCSR_API_ROUTINE <a class="code" href="../../d0/d5/srvinit_8c.html#a2">ConsoleServerApiDispatchTable</a>[ <a class="code" href="../../d5/d5/conmsg_8h.html#a236a235">ConsolepMaxApiNumber</a> - <a class="code" href="../../d5/d5/conmsg_8h.html#a236a163">ConsolepOpenConsole</a> ] = {
00027     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a222">SrvOpenConsole</a>,
00028     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a184">SrvGetConsoleInput</a>,
00029     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a185">SrvWriteConsoleInput</a>,
00030     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a186">SrvReadConsoleOutput</a>,
00031     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a187">SrvWriteConsoleOutput</a>,
00032     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a188">SrvReadConsoleOutputString</a>,
00033     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a189">SrvWriteConsoleOutputString</a>,
00034     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a190">SrvFillConsoleOutput</a>,
00035     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a193">SrvGetConsoleMode</a>,
00036     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a194">SrvGetConsoleNumberOfFonts</a>,
00037     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a195">SrvGetConsoleNumberOfInputEvents</a>,
00038     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a197">SrvGetConsoleScreenBufferInfo</a>,
00039     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a198">SrvGetConsoleCursorInfo</a>,
00040     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a199">SrvGetConsoleMouseInfo</a>,
00041     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a200">SrvGetConsoleFontInfo</a>,
00042     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a201">SrvGetConsoleFontSize</a>,
00043     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a202">SrvGetConsoleCurrentFont</a>,
00044     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a203">SrvSetConsoleMode</a>,
00045     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a205">SrvSetConsoleActiveScreenBuffer</a>,
00046     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a206">SrvFlushConsoleInputBuffer</a>,
00047     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a196">SrvGetLargestConsoleWindowSize</a>,
00048     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a207">SrvSetConsoleScreenBufferSize</a>,
00049     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a208">SrvSetConsoleCursorPosition</a>,
00050     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a209">SrvSetConsoleCursorInfo</a>,
00051     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a210">SrvSetConsoleWindowInfo</a>,
00052     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a211">SrvScrollConsoleScreenBuffer</a>,
00053     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a212">SrvSetConsoleTextAttribute</a>,
00054     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a213">SrvSetConsoleFont</a>,
00055     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a214">SrvSetConsoleIcon</a>,
00056     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a223">SrvReadConsole</a>,
00057     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a224">SrvWriteConsole</a>,
00058     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a225">SrvDuplicateHandle</a>,
00059     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a226">SrvGetHandleInformation</a>,
00060     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a227">SrvSetHandleInformation</a>,
00061     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a231">SrvCloseHandle</a>,
00062     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a91">SrvVerifyConsoleIoHandle</a>,
00063     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a264">SrvAllocConsole</a>,
00064     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a265">SrvFreeConsole</a>,
00065     (PCSR_API_ROUTINE)<a class="code" href="../../d3/d1/server_2cmdline_8c.html#a82">SrvGetConsoleTitle</a>,
00066     (PCSR_API_ROUTINE)<a class="code" href="../../d3/d1/server_2cmdline_8c.html#a83">SrvSetConsoleTitle</a>,
00067     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a191">SrvCreateConsoleScreenBuffer</a>,
00068     (PCSR_API_ROUTINE)<a class="code" href="../../d5/d1/w32_2ntcon_2server_2bitmap_8c.html#a1">SrvInvalidateBitMapRect</a>,
00069     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a276">SrvVDMConsoleOperation</a>,
00070     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a278">SrvSetConsoleCursor</a>,
00071     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a279">SrvShowConsoleCursor</a>,
00072     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a280">SrvConsoleMenuControl</a>,
00073     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a281">SrvSetConsolePalette</a>,
00074     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a282">SrvSetConsoleDisplayMode</a>,
00075     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a285">SrvRegisterConsoleVDM</a>,
00076     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a287">SrvGetConsoleHardwareState</a>,
00077     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a288">SrvSetConsoleHardwareState</a>,
00078     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a289">SrvGetConsoleDisplayMode</a>,
00079     (PCSR_API_ROUTINE)<a class="code" href="../../d3/d1/server_2cmdline_8c.html#a29">SrvAddConsoleAlias</a>,
00080     (PCSR_API_ROUTINE)<a class="code" href="../../d3/d1/server_2cmdline_8c.html#a30">SrvGetConsoleAlias</a>,
00081     (PCSR_API_ROUTINE)<a class="code" href="../../d3/d1/server_2cmdline_8c.html#a31">SrvGetConsoleAliasesLength</a>,
00082     (PCSR_API_ROUTINE)<a class="code" href="../../d3/d1/server_2cmdline_8c.html#a34">SrvGetConsoleAliasExesLength</a>,
00083     (PCSR_API_ROUTINE)<a class="code" href="../../d3/d1/server_2cmdline_8c.html#a33">SrvGetConsoleAliases</a>,
00084     (PCSR_API_ROUTINE)<a class="code" href="../../d3/d1/server_2cmdline_8c.html#a35">SrvGetConsoleAliasExes</a>,
00085     (PCSR_API_ROUTINE)<a class="code" href="../../d3/d1/server_2cmdline_8c.html#a37">SrvExpungeConsoleCommandHistory</a>,
00086     (PCSR_API_ROUTINE)<a class="code" href="../../d3/d1/server_2cmdline_8c.html#a38">SrvSetConsoleNumberOfCommands</a>,
00087     (PCSR_API_ROUTINE)<a class="code" href="../../d3/d1/server_2cmdline_8c.html#a39">SrvGetConsoleCommandHistoryLength</a>,
00088     (PCSR_API_ROUTINE)<a class="code" href="../../d3/d1/server_2cmdline_8c.html#a40">SrvGetConsoleCommandHistory</a>,
00089     (PCSR_API_ROUTINE)<a class="code" href="../../d3/d1/server_2cmdline_8c.html#a41">SrvSetConsoleCommandHistoryMode</a>,
00090     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a217">SrvGetConsoleCP</a>,
00091     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a216">SrvSetConsoleCP</a>,
00092     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a291">SrvSetConsoleKeyShortcuts</a>,
00093     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a290">SrvSetConsoleMenuClose</a>,
00094     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a286">SrvConsoleNotifyLastClose</a>,
00095     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a204">SrvGenerateConsoleCtrlEvent</a>,
00096     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a218">SrvGetConsoleKeyboardLayoutName</a>,
00097     (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a219">SrvGetConsoleWindow</a>,
00098 <span class="preprocessor">#if defined(FE_SB)</span>
00099 <span class="preprocessor"></span>    (PCSR_API_ROUTINE)SrvGetConsoleCharType,
00100     (PCSR_API_ROUTINE)SrvSetConsoleLocalEUDC,
00101     (PCSR_API_ROUTINE)SrvSetConsoleCursorMode,
00102     (PCSR_API_ROUTINE)SrvGetConsoleCursorMode,
00103     (PCSR_API_ROUTINE)SrvRegisterConsoleOS2,
00104     (PCSR_API_ROUTINE)SrvSetConsoleOS2OemFormat,
00105 <span class="preprocessor">#if defined(FE_IME)</span>
00106 <span class="preprocessor"></span>    (PCSR_API_ROUTINE)SrvGetConsoleNlsMode,
00107     (PCSR_API_ROUTINE)SrvSetConsoleNlsMode,
00108     (PCSR_API_ROUTINE)SrvRegisterConsoleIME,
00109     (PCSR_API_ROUTINE)SrvUnregisterConsoleIME,
00110 <span class="preprocessor">#endif // FE_IME</span>
00111 <span class="preprocessor"></span><span class="preprocessor">#endif // FE_SB</span>
00112 <span class="preprocessor"></span>    (PCSR_API_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a272">SrvGetConsoleLangId</a>
00113 };
00114 
<a name="l00115"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a3">00115</a> CONST BOOLEAN <a class="code" href="../../d0/d5/srvinit_8c.html#a3">ConsoleServerApiServerValidTable</a>[ <a class="code" href="../../d5/d5/conmsg_8h.html#a236a235">ConsolepMaxApiNumber</a> - <a class="code" href="../../d5/d5/conmsg_8h.html#a236a163">ConsolepOpenConsole</a> ] = {
00116     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// OpenConsole</span>
00117     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// GetConsoleInput,</span>
00118     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// WriteConsoleInput,</span>
00119     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// ReadConsoleOutput,</span>
00120     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// WriteConsoleOutput,</span>
00121     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// ReadConsoleOutputString,</span>
00122     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// WriteConsoleOutputString,</span>
00123     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// FillConsoleOutput,</span>
00124     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// GetConsoleMode,</span>
00125     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// GetNumberOfConsoleFonts,</span>
00126     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// GetNumberOfConsoleInputEvents,</span>
00127     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// GetConsoleScreenBufferInfo,</span>
00128     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// GetConsoleCursorInfo,</span>
00129     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// GetConsoleMouseInfo,</span>
00130     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// GetConsoleFontInfo,</span>
00131     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// GetConsoleFontSize,</span>
00132     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// GetCurrentConsoleFont,</span>
00133     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// SetConsoleMode,</span>
00134     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// SetConsoleActiveScreenBuffer,</span>
00135     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// FlushConsoleInputBuffer,</span>
00136     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// GetLargestConsoleWindowSize,</span>
00137     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// SetConsoleScreenBufferSize,</span>
00138     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// SetConsoleCursorPosition,</span>
00139     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// SetConsoleCursorInfo,</span>
00140     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// SetConsoleWindowInfo,</span>
00141     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// ScrollConsoleScreenBuffer,</span>
00142     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// SetConsoleTextAttribute,</span>
00143     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// SetConsoleFont,</span>
00144     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// SetConsoleIcon</span>
00145     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// ReadConsole,</span>
00146     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// WriteConsole,</span>
00147     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// DuplicateHandle,</span>
00148     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// GetHandleInformation,</span>
00149     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// SetHandleInformation,</span>
00150     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// CloseHandle</span>
00151     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// VerifyConsoleIoHandle</span>
00152     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// AllocConsole,</span>
00153     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// FreeConsole</span>
00154     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// GetConsoleTitle,</span>
00155     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// SetConsoleTitle,</span>
00156     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// CreateConsoleScreenBuffer</span>
00157     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// InvalidateConsoleBitmapRect</span>
00158     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// VDMConsoleOperation</span>
00159     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// SetConsoleCursor,</span>
00160     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// ShowConsoleCursor</span>
00161     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// ConsoleMenuControl</span>
00162     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// SetConsolePalette</span>
00163     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// SetConsoleDisplayMode</span>
00164     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// RegisterConsoleVDM,</span>
00165     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// GetConsoleHardwareState</span>
00166     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// SetConsoleHardwareState</span>
00167     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,      <span class="comment">// GetConsoleDisplayMode</span>
00168     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// AddConsoleAlias,</span>
00169     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// GetConsoleAlias,</span>
00170     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// GetConsoleAliasesLength,</span>
00171     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// GetConsoleAliasExesLength,</span>
00172     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// GetConsoleAliases,</span>
00173     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// GetConsoleAliasExes</span>
00174     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// ExpungeConsoleCommandHistory,</span>
00175     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// SetConsoleNumberOfCommands,</span>
00176     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// GetConsoleCommandHistoryLength,</span>
00177     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// GetConsoleCommandHistory,</span>
00178     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// SetConsoleCommandHistoryMode</span>
00179     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// SrvGetConsoleCP,</span>
00180     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// SrvSetConsoleCP,</span>
00181     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// SrvSetConsoleKeyShortcuts,</span>
00182     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// SrvSetConsoleMenuClose</span>
00183     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// SrvConsoleNotifyLastClose</span>
00184     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// SrvGenerateConsoleCtrlEvent</span>
00185     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// SrvGetConsoleKeyboardLayoutName</span>
00186     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// SrvGetConsoleWindow,</span>
00187 <span class="preprocessor">#if defined(FE_SB)</span>
00188 <span class="preprocessor"></span>    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// GetConsoleCharType</span>
00189     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// SrvSetConsoleLocalEUDC,</span>
00190     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// SrvSetConsoleCursorMode,</span>
00191     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// SrvGetConsoleCursorMode</span>
00192     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// SrvRegisterConsoleOS2,</span>
00193     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// SrvSetConsoleOS2OemFormat,</span>
00194 <span class="preprocessor">#if defined(FE_IME)</span>
00195 <span class="preprocessor"></span>    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// GetConsoleNlsMode</span>
00196     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// SetConsoleNlsMode</span>
00197     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// RegisterConsoleIME</span>
00198     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,     <span class="comment">// UnregisterConsoleIME</span>
00199 <span class="preprocessor">#endif // FE_IME</span>
00200 <span class="preprocessor"></span><span class="preprocessor">#endif // FE_SB</span>
00201 <span class="preprocessor"></span>    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>      <span class="comment">// GetConsoleLangId</span>
00202 };
00203 
00204 <span class="preprocessor">#if DBG</span>
00205 <span class="preprocessor"></span>PSZ ConsoleServerApiNameTable[ <a class="code" href="../../d5/d5/conmsg_8h.html#a236a235">ConsolepMaxApiNumber</a> - <a class="code" href="../../d5/d5/conmsg_8h.html#a236a163">ConsolepOpenConsole</a> ] = {
00206     <span class="stringliteral">"SrvOpenConsole"</span>,
00207     <span class="stringliteral">"SrvGetConsoleInput"</span>,
00208     <span class="stringliteral">"SrvWriteConsoleInput"</span>,
00209     <span class="stringliteral">"SrvReadConsoleOutput"</span>,
00210     <span class="stringliteral">"SrvWriteConsoleOutput"</span>,
00211     <span class="stringliteral">"SrvReadConsoleOutputString"</span>,
00212     <span class="stringliteral">"SrvWriteConsoleOutputString"</span>,
00213     <span class="stringliteral">"SrvFillConsoleOutput"</span>,
00214     <span class="stringliteral">"SrvGetConsoleMode"</span>,
00215     <span class="stringliteral">"SrvGetConsoleNumberOfFonts"</span>,
00216     <span class="stringliteral">"SrvGetConsoleNumberOfInputEvents"</span>,
00217     <span class="stringliteral">"SrvGetConsoleScreenBufferInfo"</span>,
00218     <span class="stringliteral">"SrvGetConsoleCursorInfo"</span>,
00219     <span class="stringliteral">"SrvGetConsoleMouseInfo"</span>,
00220     <span class="stringliteral">"SrvGetConsoleFontInfo"</span>,
00221     <span class="stringliteral">"SrvGetConsoleFontSize"</span>,
00222     <span class="stringliteral">"SrvGetConsoleCurrentFont"</span>,
00223     <span class="stringliteral">"SrvSetConsoleMode"</span>,
00224     <span class="stringliteral">"SrvSetConsoleActiveScreenBuffer"</span>,
00225     <span class="stringliteral">"SrvFlushConsoleInputBuffer"</span>,
00226     <span class="stringliteral">"SrvGetLargestConsoleWindowSize"</span>,
00227     <span class="stringliteral">"SrvSetConsoleScreenBufferSize"</span>,
00228     <span class="stringliteral">"SrvSetConsoleCursorPosition"</span>,
00229     <span class="stringliteral">"SrvSetConsoleCursorInfo"</span>,
00230     <span class="stringliteral">"SrvSetConsoleWindowInfo"</span>,
00231     <span class="stringliteral">"SrvScrollConsoleScreenBuffer"</span>,
00232     <span class="stringliteral">"SrvSetConsoleTextAttribute"</span>,
00233     <span class="stringliteral">"SrvSetConsoleFont"</span>,
00234     <span class="stringliteral">"SrvSetConsoleIcon"</span>,
00235     <span class="stringliteral">"SrvReadConsole"</span>,
00236     <span class="stringliteral">"SrvWriteConsole"</span>,
00237     <span class="stringliteral">"SrvDuplicateHandle"</span>,
00238     <span class="stringliteral">"SrvGetHandleInformation"</span>,
00239     <span class="stringliteral">"SrvSetHandleInformation"</span>,
00240     <span class="stringliteral">"SrvCloseHandle"</span>,
00241     <span class="stringliteral">"SrvVerifyConsoleIoHandle"</span>,
00242     <span class="stringliteral">"SrvAllocConsole"</span>,
00243     <span class="stringliteral">"SrvFreeConsole"</span>,
00244     <span class="stringliteral">"SrvGetConsoleTitle"</span>,
00245     <span class="stringliteral">"SrvSetConsoleTitle"</span>,
00246     <span class="stringliteral">"SrvCreateConsoleScreenBuffer"</span>,
00247     <span class="stringliteral">"SrvInvalidateBitMapRect"</span>,
00248     <span class="stringliteral">"SrvVDMConsoleOperation"</span>,
00249     <span class="stringliteral">"SrvSetConsoleCursor"</span>,
00250     <span class="stringliteral">"SrvShowConsoleCursor"</span>,
00251     <span class="stringliteral">"SrvConsoleMenuControl"</span>,
00252     <span class="stringliteral">"SrvSetConsolePalette"</span>,
00253     <span class="stringliteral">"SrvSetConsoleDisplayMode"</span>,
00254     <span class="stringliteral">"SrvRegisterConsoleVDM"</span>,
00255     <span class="stringliteral">"SrvGetConsoleHardwareState"</span>,
00256     <span class="stringliteral">"SrvSetConsoleHardwareState"</span>,
00257     <span class="stringliteral">"SrvGetConsoleDisplayMode"</span>,
00258     <span class="stringliteral">"SrvAddConsoleAlias"</span>,
00259     <span class="stringliteral">"SrvGetConsoleAlias"</span>,
00260     <span class="stringliteral">"SrvGetConsoleAliasesLength"</span>,
00261     <span class="stringliteral">"SrvGetConsoleAliasExesLength"</span>,
00262     <span class="stringliteral">"SrvGetConsoleAliases"</span>,
00263     <span class="stringliteral">"SrvGetConsoleAliasExes"</span>,
00264     <span class="stringliteral">"SrvExpungeConsoleCommandHistory"</span>,
00265     <span class="stringliteral">"SrvSetConsoleNumberOfCommands"</span>,
00266     <span class="stringliteral">"SrvGetConsoleCommandHistoryLength"</span>,
00267     <span class="stringliteral">"SrvGetConsoleCommandHistory"</span>,
00268     <span class="stringliteral">"SrvSetConsoleCommandHistoryMode"</span>,
00269     <span class="stringliteral">"SrvGetConsoleCP"</span>,
00270     <span class="stringliteral">"SrvSetConsoleCP"</span>,
00271     <span class="stringliteral">"SrvSetConsoleKeyShortcuts"</span>,
00272     <span class="stringliteral">"SrvSetConsoleMenuClose"</span>,
00273     <span class="stringliteral">"SrvConsoleNotifyLastClose"</span>,
00274     <span class="stringliteral">"SrvGenerateConsoleCtrlEvent"</span>,
00275     <span class="stringliteral">"SrvGetConsoleKeyboardLayoutName"</span>,
00276     <span class="stringliteral">"SrvGetConsoleWindow"</span>,
00277 <span class="preprocessor">#if defined(FE_SB)</span>
00278 <span class="preprocessor"></span>    <span class="stringliteral">"SrvGetConsoleCharType"</span>,
00279     <span class="stringliteral">"SrvSetConsoleLocalEUDC"</span>,
00280     <span class="stringliteral">"SrvSetConsoleCursorMode"</span>,
00281     <span class="stringliteral">"SrvGetConsoleCursorMode"</span>,
00282     <span class="stringliteral">"SrvRegisterConsoleOS2"</span>,
00283     <span class="stringliteral">"SrvSetConsoleOS2OemFormat"</span>,
00284 <span class="preprocessor">#if defined(FE_IME)</span>
00285 <span class="preprocessor"></span>    <span class="stringliteral">"SrvGetConsoleNlsMode"</span>,
00286     <span class="stringliteral">"SrvSetConsoleNlsMode"</span>,
00287     <span class="stringliteral">"SrvRegisterConsoleIME"</span>,
00288     <span class="stringliteral">"SrvUnregisterConsoleIME"</span>,
00289 <span class="preprocessor">#endif // FE_IME</span>
00290 <span class="preprocessor"></span><span class="preprocessor">#endif // FE_SB</span>
00291 <span class="preprocessor"></span>    <span class="stringliteral">"SrvGetConsoleLangId"</span>
00292 };
00293 <span class="preprocessor">#endif // DBG</span>
00294 <span class="preprocessor"></span>
<a name="l00295"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a4">00295</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a12">FullScreenInitialized</a>;
<a name="l00296"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a5">00296</a> CRITICAL_SECTION    <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a13">ConsoleVDMCriticalSection</a>;
<a name="l00297"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a6">00297</a> <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a>    <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a14">ConsoleVDMOnSwitching</a>;
00298 
00299 
<a name="l00300"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a7">00300</a> CRITICAL_SECTION <a class="code" href="../../d0/d5/srvinit_8c.html#a7">ConsoleInitWindowsLock</a>;
<a name="l00301"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a8">00301</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a21">fOneTimeInitialized</a>;
00302 
<a name="l00303"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a9">00303</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a>;
<a name="l00304"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a10">00304</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a3">WINDOWSCP</a>;
<a name="l00305"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a11">00305</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a22">ConsoleOutputCP</a>;
<a name="l00306"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a12">00306</a> <a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html">CONSOLE_REGISTRY_INFO</a> <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>;
00307 <span class="preprocessor">#if defined(FE_SB)</span>
00308 <span class="preprocessor"></span>BOOLEAN gfIsDBCSACP;
00309 <span class="preprocessor">#endif</span>
00310 <span class="preprocessor"></span>
00311 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00312 <a class="code" href="../../d0/d5/srvinit_8c.html#a22">UnregisterVDM</a>(
00313     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
00314     );
00315 
00316 ULONG
00317 <a class="code" href="../../d0/d5/srvinit_8c.html#a23">NonConsoleProcessShutdown</a>(
00318     PCSR_PROCESS Process,
00319     DWORD dwFlags
00320     );
00321 
00322 ULONG
00323 <a class="code" href="../../d0/d5/srvinit_8c.html#a24">ConsoleClientShutdown</a>(
00324     PCSR_PROCESS Process,
00325     ULONG Flags,
00326     BOOLEAN fFirstPass
00327     );
00328 
00329 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00330 <a class="code" href="../../d0/d5/srvinit_8c.html#a25">ConsoleClientConnectRoutine</a>(
00331     IN PCSR_PROCESS Process,
00332     IN OUT PVOID ConnectionInfo,
00333     IN OUT PULONG ConnectionInfoLength
00334     );
00335 
00336 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00337 <a class="code" href="../../d0/d5/srvinit_8c.html#a26">ConsoleClientDisconnectRoutine</a>(
00338     IN PCSR_PROCESS Process
00339     );
00340 
00341 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d5/d4/server_2msgbeep_8c.html#a0">ConsolePlaySound</a>(
00342     VOID
00343     );
00344 
00345 
00346 
<a name="l00347"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a13">00347</a> HANDLE <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a4">ghInstance</a>;
<a name="l00348"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a14">00348</a> HICON <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a5">ghDefaultIcon</a>;
<a name="l00349"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a15">00349</a> HICON <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a6">ghDefaultSmIcon</a>;
<a name="l00350"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a16">00350</a> HCURSOR <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a7">ghNormalCursor</a>;
00351 
<a name="l00352"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a17">00352</a> PWIN32HEAP <a class="code" href="../../d8/d5/consrv_8h.html#a59">pConHeap</a>;
<a name="l00353"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a18">00353</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  <a class="code" href="../../d8/d5/consrv_8h.html#a60">dwConBaseTag</a>;
00354 
<a name="l00355"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a19">00355</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a24">gExtendedEditKey</a>;
<a name="l00356"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a20">00356</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a25">gfTrimLeadingZeros</a>;
00357 
<a name="l00358"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a21">00358</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a26">gfLoadConIme</a>;
00359 
<a name="l00360"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a28">00360</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d0/d5/srvinit_8c.html#a28">LoadLinkInfo</a>(
00361     <a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html">PCONSOLE_INFO</a> ConsoleInfo,
00362     LPWSTR Title,
00363     LPDWORD TitleLength,
00364     LPWSTR CurDir,
00365     LPWSTR AppName
00366     )
00367 {
00368     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwLinkLen;
00369     WCHAR LinkName[ <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>+1 ];
00370     <a class="code" href="../../d2/d9/structLNKPROPNTCONSOLE.html">LNKPROPNTCONSOLE</a> linkprops;
00371     LPWSTR pszIconLocation;
00372     <span class="keywordtype">int</span> nIconIndex;
00373 
00374     ConsoleInfo-&gt;uCodePage = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a>;
00375 
00376     <span class="comment">// Do some initialization</span>
00377     ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o7">hIcon</a> = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a5">ghDefaultIcon</a>;
00378     ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o8">hSmIcon</a> = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a6">ghDefaultSmIcon</a>;
00379     pszIconLocation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00380     nIconIndex = 0;
00381 
00382     <span class="comment">// Try to impersonate the client-side thread</span>
00383     <span class="keywordflow">if</span> (!CsrImpersonateClient(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00384         ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o10">dwStartupFlags</a> &amp;= (~STARTF_TITLEISLINKNAME);
00385         <span class="keywordflow">goto</span> DefaultInit;
00386     }
00387 
00388     <span class="comment">// Did we get started from a link?</span>
00389     <span class="keywordflow">if</span> (ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o10">dwStartupFlags</a> &amp; STARTF_TITLEISLINKNAME) {
00390 
00391         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> Success;
00392         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> oldLen;
00393 
00394         <span class="comment">// Get the filename of the link (TitleLength is BYTES, not CHARS)</span>
00395         dwLinkLen = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(<a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(*TitleLength,(<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>+1)*<span class="keyword">sizeof</span>(WCHAR)));
00396         RtlCopyMemory(LinkName,Title,dwLinkLen);
00397         LinkName[ <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a> ] = (WCHAR)0;
00398 
00399 
00400         <span class="comment">// Get the title for the window, which is effectively the link file name</span>
00401         oldLen = *TitleLength;
00402         *TitleLength = <a class="code" href="../../d3/d4/link_8c.html#a0">GetTitleFromLinkName</a>( LinkName, Title );
00403         <span class="keywordflow">if</span> (*TitleLength &lt; oldLen)
00404             Title[ *TitleLength / <span class="keyword">sizeof</span>(WCHAR) ] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00405 
00406         <span class="comment">// try to get console properties from the link</span>
00407         Success =  <a class="code" href="../../d3/d4/link_8c.html#a3">GetLinkProperties</a>( LinkName,
00408                                       &amp;linkprops,
00409                                       <span class="keyword">sizeof</span>(linkprops)
00410                                      );
00411 
00412         <span class="keywordflow">if</span> (Success == <a class="code" href="../../d8/d5/consrv_8h.html#a47">LINK_NOINFO</a>) {
00413             ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o10">dwStartupFlags</a> &amp;= (~STARTF_TITLEISLINKNAME);
00414             <span class="keywordflow">goto</span> NormalInit;
00415         }
00416 
00417         <span class="keywordflow">if</span> (linkprops.pszIconLocation &amp;&amp; *linkprops.pszIconLocation) {
00418             pszIconLocation = linkprops.pszIconLocation;
00419             nIconIndex = linkprops.uIcon;
00420             ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o6">iIconId</a> = 0;
00421         }
00422 
00423         <span class="comment">// Transfer link settings</span>
00424         ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o9">dwHotKey</a> = linkprops.uHotKey;
00425         ConsoleInfo-&gt;wShowWindow = (WORD)linkprops.uShowCmd;
00426 
00427         <span class="keywordflow">if</span> (Success == <a class="code" href="../../d8/d5/consrv_8h.html#a48">LINK_SIMPLEINFO</a>) {
00428             ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o10">dwStartupFlags</a> &amp;= (~STARTF_TITLEISLINKNAME);
00429             <span class="keywordflow">goto</span> NormalInit;
00430         }
00431 
00432         <span class="comment">// Transfer console link settings</span>
00433         ConsoleInfo-&gt;wFillAttribute = linkprops.console_props.wFillAttribute;
00434         ConsoleInfo-&gt;wPopupFillAttribute = linkprops.console_props.wPopupFillAttribute;
00435 
00436         RtlCopyMemory( &amp;ConsoleInfo-&gt;dwScreenBufferSize,
00437                        &amp;linkprops.console_props.dwScreenBufferSize,
00438                        <span class="keyword">sizeof</span>(NT_CONSOLE_PROPS) - FIELD_OFFSET(NT_CONSOLE_PROPS, dwScreenBufferSize)
00439                       );
00440 
00441         ConsoleInfo-&gt;uCodePage = linkprops.fe_console_props.uCodePage;
00442 
00443 <span class="preprocessor">#if 0</span>
00444 <span class="preprocessor"></span>        {
00445 
00446             <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> i;
00447 
00448             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"[LoadLinkInfo Properties for %ws]\n"</span>, Title );
00449             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    wFillAttribute      = 0x%04X\n"</span>, ConsoleInfo-&gt;wFillAttribute );
00450             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    wPopupFillAttribute = 0x%04X\n"</span>, ConsoleInfo-&gt;wPopupFillAttribute );
00451             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    dwScreenBufferSize  = (%d , %d)\n"</span>, ConsoleInfo-&gt;dwScreenBufferSize.X, ConsoleInfo-&gt;dwScreenBufferSize.Y );
00452             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    dwWindowSize        = (%d , %d)\n"</span>, ConsoleInfo-&gt;dwWindowSize.X, ConsoleInfo-&gt;dwWindowSize.Y );
00453             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    dwWindowOrigin      = (%d , %d)\n"</span>, ConsoleInfo-&gt;dwWindowOrigin.X, ConsoleInfo-&gt;dwWindowOrigin.Y );
00454             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    nFont               = 0x%X\n"</span>, ConsoleInfo-&gt;nFont );
00455             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    nInputBufferSize    = 0x%X\n"</span>, ConsoleInfo-&gt;nInputBufferSize );
00456             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    dwFontSize          = (%d , %d)\n"</span>, ConsoleInfo-&gt;dwFontSize.X, ConsoleInfo-&gt;dwFontSize.Y );
00457             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    uFontFamily         = 0x%08X\n"</span>, ConsoleInfo-&gt;uFontFamily );
00458             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    uFontWeight         = 0x%08X\n"</span>, ConsoleInfo-&gt;uFontWeight );
00459             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    FaceName            = %ws\n"</span>, ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o23">FaceName</a> );
00460             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    uCursorSize         = %d\n"</span>, ConsoleInfo-&gt;uCursorSize );
00461             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    bFullScreen         = %s\n"</span>, ConsoleInfo-&gt;bFullScreen ? <span class="stringliteral">"TRUE"</span> : <span class="stringliteral">"FALSE"</span> );
00462             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    bQuickEdit          = %s\n"</span>, ConsoleInfo-&gt;bQuickEdit  ? <span class="stringliteral">"TRUE"</span> : <span class="stringliteral">"FALSE"</span> );
00463             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    bInsertMode         = %s\n"</span>, ConsoleInfo-&gt;bInsertMode ? <span class="stringliteral">"TRUE"</span> : <span class="stringliteral">"FALSE"</span> );
00464             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    bAutoPosition       = %s\n"</span>, ConsoleInfo-&gt;bAutoPosition ? <span class="stringliteral">"TRUE"</span> : <span class="stringliteral">"FALSE"</span> );
00465             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    uHistoryBufferSize  = %d\n"</span>, ConsoleInfo-&gt;uHistoryBufferSize );
00466             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    uNumHistoryBuffers  = %d\n"</span>, ConsoleInfo-&gt;uNumberOfHistoryBuffers );
00467             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    bHistoryNoDup       = %s\n"</span>, ConsoleInfo-&gt;bHistoryNoDup ? <span class="stringliteral">"TRUE"</span> : <span class="stringliteral">"FALSE"</span> );
00468             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    ColorTable = ["</span> );
00469             i=0;
00470             <span class="keywordflow">while</span>( i &lt; 16 )
00471             {
00472                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n         "</span>);
00473                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"0x%08X "</span>, ConsoleInfo-&gt;ColorTable[i++]);
00474                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"0x%08X "</span>, ConsoleInfo-&gt;ColorTable[i++]);
00475                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"0x%08X "</span>, ConsoleInfo-&gt;ColorTable[i++]);
00476                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"0x%08X "</span>, ConsoleInfo-&gt;ColorTable[i++]);
00477             }
00478             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"]\n\n"</span> );
00479         }
00480 <span class="preprocessor">#endif</span>
00481 <span class="preprocessor"></span>
00482         ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o10">dwStartupFlags</a> &amp;= ~(STARTF_USESIZE | STARTF_USECOUNTCHARS);
00483     }
00484 
00485 NormalInit:
00486 
00487     <span class="comment">//</span>
00488     <span class="comment">// Go get the icon</span>
00489     <span class="comment">//</span>
00490 
00491     <span class="keywordflow">if</span> (pszIconLocation == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00492         dwLinkLen = <a class="code" href="../../d5/d1/curdir_8c.html#a32">RtlDosSearchPath_U</a>(CurDir,
00493                                        AppName,
00494                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00495                                        <span class="keyword">sizeof</span>(LinkName),
00496                                        LinkName,
00497                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00498         <span class="keywordflow">if</span> (dwLinkLen &gt; 0 &amp;&amp; dwLinkLen &lt; <span class="keyword">sizeof</span>(LinkName)) {
00499             pszIconLocation = LinkName;
00500         } <span class="keywordflow">else</span> {
00501             pszIconLocation = AppName;
00502         }
00503     }
00504 
00505     <span class="keywordflow">if</span> (pszIconLocation != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00506         HICON hIcon, hSmIcon;
00507         hIcon = hSmIcon = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00508         <a class="code" href="../../d6/d0/extract_8c.html#a47">PrivateExtractIconExW</a>(pszIconLocation,
00509                               nIconIndex,
00510                               &amp;hIcon,
00511                               &amp;hSmIcon,
00512                               1);
00513         <span class="comment">/*</span>
00514 <span class="comment">         * If there is no large icon, use the default ones</span>
00515 <span class="comment">         * If there is only a large icon in the resource, do not use</span>
00516 <span class="comment">         * the default small one but let it be NULL so we'll stretch the large one</span>
00517 <span class="comment">         */</span>
00518         <span class="keywordflow">if</span> (hIcon != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00519             ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o7">hIcon</a> = hIcon;
00520             ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o8">hSmIcon</a> = hSmIcon;
00521         }
00522     }
00523 
00524     CsrRevertToSelf();
00525 
00526     <span class="keywordflow">if</span> (! IsValidCodePage(ConsoleInfo-&gt;uCodePage)) {    <span class="comment">// fail safe</span>
00527         ConsoleInfo-&gt;uCodePage = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a>;
00528     }
00529 
00530     <span class="keywordflow">if</span> (!(ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o10">dwStartupFlags</a> &amp; STARTF_TITLEISLINKNAME)) {
00531         <a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html">CONSOLE_REGISTRY_INFO</a> RegInfo;
00532 
00533 DefaultInit:
00534         <span class="comment">//</span>
00535         <span class="comment">// read values from the registry</span>
00536         <span class="comment">//</span>
00537 
00538         RegInfo = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>;
00539         <a class="code" href="../../d0/d5/srvinit_8c.html#a44">GetRegistryValues</a>(Title, &amp;RegInfo);
00540 
00541         <span class="comment">//</span>
00542         <span class="comment">// if a value isn't specified in STARTUPINFO, then use the one</span>
00543         <span class="comment">// from the registry.</span>
00544         <span class="comment">//</span>
00545 
00546         <span class="keywordflow">if</span> (!(ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o10">dwStartupFlags</a> &amp; STARTF_USEFILLATTRIBUTE)) {
00547             ConsoleInfo-&gt;wFillAttribute = RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o12">ScreenFill</a>.Attributes;
00548         }
00549         ConsoleInfo-&gt;wPopupFillAttribute = RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o13">PopupFill</a>.Attributes;
00550 
00551         <span class="keywordflow">if</span> (!(ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o10">dwStartupFlags</a> &amp; STARTF_USECOUNTCHARS)) {
00552             ConsoleInfo-&gt;dwScreenBufferSize = RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o0">ScreenBufferSize</a>;
00553         }
00554         <span class="keywordflow">if</span> (!(ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o10">dwStartupFlags</a> &amp; STARTF_USESIZE)) {
00555             ConsoleInfo-&gt;dwWindowSize = RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o1">WindowSize</a>;
00556         }
00557         <span class="keywordflow">if</span> (!(ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o10">dwStartupFlags</a> &amp; STARTF_USEPOSITION)) {
00558             ConsoleInfo-&gt;dwWindowOrigin = RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o2">WindowOrigin</a>;
00559             ConsoleInfo-&gt;bAutoPosition = RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o11">AutoPosition</a>;
00560         } <span class="keywordflow">else</span> {
00561             ConsoleInfo-&gt;bAutoPosition = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00562         }
00563         <span class="keywordflow">if</span> (!(ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o10">dwStartupFlags</a> &amp; STARTF_RUNFULLSCREEN)) {
00564             ConsoleInfo-&gt;bFullScreen = RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o8">FullScreen</a>;
00565         } <span class="keywordflow">else</span> {
00566             ConsoleInfo-&gt;bFullScreen = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00567         }
00568 
00569         ConsoleInfo-&gt;uFontFamily = RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o4">FontFamily</a>;
00570         ConsoleInfo-&gt;uFontWeight = RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o5">FontWeight</a>;
00571         ConsoleInfo-&gt;dwFontSize = RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o3">FontSize</a>;
00572         RtlCopyMemory(ConsoleInfo-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o23">FaceName</a>, RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o6">FaceName</a>, <span class="keyword">sizeof</span>(RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o6">FaceName</a>));
00573 
00574         ConsoleInfo-&gt;bQuickEdit = RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o9">QuickEdit</a>;
00575         ConsoleInfo-&gt;bInsertMode = RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o10">InsertMode</a>;
00576 
00577         ConsoleInfo-&gt;uCursorSize = RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o7">CursorSize</a>;
00578         ConsoleInfo-&gt;uHistoryBufferSize = RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o14">HistoryBufferSize</a>;
00579         ConsoleInfo-&gt;uNumberOfHistoryBuffers = RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o15">NumberOfHistoryBuffers</a>;
00580         ConsoleInfo-&gt;bHistoryNoDup = RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o16">HistoryNoDup</a>;
00581         RtlCopyMemory(ConsoleInfo-&gt;ColorTable, RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>, <span class="keyword">sizeof</span>(RegInfo.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>));
00582 <span class="preprocessor">#ifdef FE_SB</span>
00583 <span class="preprocessor"></span>        ConsoleInfo-&gt;uCodePage = RegInfo.CodePage;
00584 <span class="preprocessor">#endif</span>
00585 <span class="preprocessor"></span>    }
00586 }
00587 
00588 
00589 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00590"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a29">00590</a> <a class="code" href="../../d0/d5/srvinit_8c.html#a29">InitWindowClass</a>( VOID )
00591 {
00592     WNDCLASSEX wc;
00593     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> retval;
00594     ATOM atomConsoleClass;
00595 
00596     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a7">ghNormalCursor</a> = LoadCursor(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, IDC_ARROW);
00597     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a0">ghModuleWin</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00598     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a5">ghDefaultIcon</a>       = LoadIcon(<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a0">ghModuleWin</a>, MAKEINTRESOURCE(<a class="code" href="../../d7/d1/usersrv_8h.html#a5">IDI_CONSOLE</a>));
00599     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a6">ghDefaultSmIcon</a>     = LoadImage(<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a0">ghModuleWin</a>, MAKEINTRESOURCE(<a class="code" href="../../d7/d1/usersrv_8h.html#a5">IDI_CONSOLE</a>), IMAGE_ICON,
00600                                     <a class="code" href="../../d3/d9/client_2wow_8c.html#a16">GetSystemMetrics</a>(SM_CXSMICON), <a class="code" href="../../d3/d9/client_2wow_8c.html#a16">GetSystemMetrics</a>(SM_CYSMICON),
00601                                     LR_SHARED);
00602     wc.hIcon            = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a5">ghDefaultIcon</a>;
00603     wc.cbSize           = <span class="keyword">sizeof</span>(WNDCLASSEX);
00604     wc.style            = CS_HREDRAW | CS_VREDRAW | CS_OWNDC | CS_DBLCLKS;
00605     wc.lpfnWndProc      = <a class="code" href="../../d8/d5/consrv_8h.html#a121">ConsoleWindowProc</a>;
00606     wc.cbClsExtra       = 0;
00607     wc.cbWndExtra       = GWL_CONSOLE_WNDALLOC;
00608     wc.hInstance        = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a4">ghInstance</a>;
00609     wc.hCursor          = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a7">ghNormalCursor</a>;
00610     wc.hbrBackground    = CreateSolidBrush(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[<a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o12">ScreenFill</a>.Attributes &gt;&gt; 4) &amp; 0xF]);
00611     wc.lpszMenuName     = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00612     wc.lpszClassName    = <a class="code" href="../../d1/d7/server_8h.html#a93">CONSOLE_WINDOW_CLASS</a>;
00613     wc.hIconSm          = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a6">ghDefaultSmIcon</a>;
00614 
00615     atomConsoleClass = <a class="code" href="../../d5/d9/cltxt_8h.html#a8">RegisterClassEx</a>(&amp;wc);
00616     retval = (atomConsoleClass != 0);
00617 
00618     <span class="keywordflow">if</span> (retval)
00619         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a86">NtUserConsoleControl</a>(ConsoleClassAtom, &amp;atomConsoleClass, <span class="keyword">sizeof</span>(ATOM));
00620 
00621     <span class="keywordflow">return</span> retval;
00622 }
00623 
00624 
00625 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00626"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a30">00626</a> <a class="code" href="../../d0/d5/srvinit_8c.html#a30">InitWindowsStuff</a>(
00627     HDESK hdesk,
00628     LPDWORD lpdwThreadId)
00629 {
00630     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00631     CLIENT_ID ClientId;
00632     CONSOLEDESKTOPCONSOLETHREAD ConsoleDesktopInfo;
00633     <a class="code" href="../../d0/d3/struct__INPUT__THREAD__INIT__INFO.html">INPUT_THREAD_INIT_INFO</a> InputThreadInitInfo;
00634 
00635     <span class="comment">//</span>
00636     <span class="comment">// This routine must be done within a critical section to ensure that</span>
00637     <span class="comment">// only one thread can initialize at a time. We need a special critical</span>
00638     <span class="comment">// section here because Csr calls into ConsoleAddProcessRoutine with</span>
00639     <span class="comment">// it's own critical section locked and then tries to grab the</span>
00640     <span class="comment">// ConsoleHandleTableLock. If we call CsrAddStaticServerThread here</span>
00641     <span class="comment">// with the ConsoleHandleTableLock locked we could get into a deadlock</span>
00642     <span class="comment">// situation. This critical section should not be used anywhere else.</span>
00643     <span class="comment">//</span>
00644 
00645     RtlEnterCriticalSection(&amp;<a class="code" href="../../d0/d5/srvinit_8c.html#a7">ConsoleInitWindowsLock</a>);
00646 
00647     ConsoleDesktopInfo.hdesk = hdesk;
00648     ConsoleDesktopInfo.dwThreadId = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1;
00649     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a86">NtUserConsoleControl</a>(ConsoleDesktopConsoleThread, &amp;ConsoleDesktopInfo,
00650             <span class="keyword">sizeof</span>(ConsoleDesktopInfo));
00651     <span class="keywordflow">if</span> (ConsoleDesktopInfo.dwThreadId == 0) {
00652 
00653         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a21">fOneTimeInitialized</a>) {
00654 
00655 <span class="preprocessor">#if defined(FE_SB)</span>
00656 <span class="preprocessor"></span>            <a class="code" href="../../d0/d3/dbcs_8h.html#a44">InitializeDbcsMisc</a>();
00657 <span class="preprocessor">#endif</span>
00658 <span class="preprocessor"></span>
00659             <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a12">FullScreenInitialized</a> = <a class="code" href="../../d7/d4/server_2private_8c.html#a55">InitializeFullScreen</a>();
00660 
00661             <span class="comment">//</span>
00662             <span class="comment">// read the registry values</span>
00663             <span class="comment">//</span>
00664 
00665             <a class="code" href="../../d0/d5/srvinit_8c.html#a44">GetRegistryValues</a>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>, &amp;<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>);
00666 
00667             <span class="comment">//</span>
00668             <span class="comment">// allocate buffer for scrolling</span>
00669             <span class="comment">//</span>
00670 
00671             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/output_8c.html#a59">InitializeScrollBuffer</a>();
00672             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00673             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00674                 <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00675         }
00676 
00677         <span class="comment">//</span>
00678         <span class="comment">// create GetMessage thread</span>
00679         <span class="comment">//</span>
00680 
00681         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/ex_2event_8c.html#a5">NtCreateEvent</a>(&amp;InputThreadInitInfo.<a class="code" href="../../d0/d3/struct__INPUT__THREAD__INIT__INFO.html#o1">InitCompleteEventHandle</a>, EVENT_ALL_ACCESS,
00682                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00683         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00684             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00685         }
00686 
00687         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(NtCurrentProcess(), hdesk,
00688                 NtCurrentProcess(), &amp;InputThreadInitInfo.<a class="code" href="../../d0/d3/struct__INPUT__THREAD__INIT__INFO.html#o2">DesktopHandle</a>, 0,
00689                 0, DUPLICATE_SAME_ACCESS);
00690         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00691             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(InputThreadInitInfo.<a class="code" href="../../d0/d3/struct__INPUT__THREAD__INIT__INFO.html#o1">InitCompleteEventHandle</a>);
00692             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00693         }
00694 
00695         <span class="comment">// can't call CreateThread from server</span>
00696         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/rtlexec_8c.html#a13">RtlCreateUserThread</a>(NtCurrentProcess(),
00697                                      (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00698                                      <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00699                                      0,
00700                                      0,
00701                                      0,
00702                                      (PUSER_THREAD_START_ROUTINE)<a class="code" href="../../d8/d5/consrv_8h.html#a132">ConsoleInputThread</a>,
00703                                      &amp;InputThreadInitInfo,
00704                                      &amp;InputThreadInitInfo.<a class="code" href="../../d0/d3/struct__INPUT__THREAD__INIT__INFO.html#o0">ThreadHandle</a>,
00705                                      &amp;ClientId
00706                                     );
00707         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00708             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(InputThreadInitInfo.<a class="code" href="../../d0/d3/struct__INPUT__THREAD__INIT__INFO.html#o1">InitCompleteEventHandle</a>);
00709             CloseDesktop(InputThreadInitInfo.<a class="code" href="../../d0/d3/struct__INPUT__THREAD__INIT__INFO.html#o2">DesktopHandle</a>);
00710             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00711         }
00712 
00713         CsrAddStaticServerThread(InputThreadInitInfo.<a class="code" href="../../d0/d3/struct__INPUT__THREAD__INIT__INFO.html#o0">ThreadHandle</a>,&amp;ClientId,0);
00714         <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>(InputThreadInitInfo.<a class="code" href="../../d0/d3/struct__INPUT__THREAD__INIT__INFO.html#o0">ThreadHandle</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00715         <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>(InputThreadInitInfo.<a class="code" href="../../d0/d3/struct__INPUT__THREAD__INIT__INFO.html#o1">InitCompleteEventHandle</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00716         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(InputThreadInitInfo.<a class="code" href="../../d0/d3/struct__INPUT__THREAD__INIT__INFO.html#o1">InitCompleteEventHandle</a>);
00717 
00718         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(InputThreadInitInfo.<a class="code" href="../../d0/d3/struct__INPUT__THREAD__INIT__INFO.html#o3">InitStatus</a>)) {
00719             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00720         }
00721 
00722         *lpdwThreadId = HandleToUlong(ClientId.UniqueThread);
00723 
00724         <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a21">fOneTimeInitialized</a>=<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00725     } <span class="keywordflow">else</span> {
00726         *lpdwThreadId = ConsoleDesktopInfo.dwThreadId;
00727     }
00728 
00729 <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>:
00730     RtlLeaveCriticalSection(&amp;<a class="code" href="../../d0/d5/srvinit_8c.html#a7">ConsoleInitWindowsLock</a>);
00731 
00732     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00733 }
00734 
00735 
00736 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> APIPRIVATE
<a name="l00737"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a31">00737</a> <a class="code" href="../../d0/d5/srvinit_8c.html#a31">ConServerDllInitialization</a>(
00738     PCSR_SERVER_DLL LoadedServerDll
00739     )
00740 
00741 <span class="comment">/*++</span>
00742 <span class="comment"></span>
00743 <span class="comment">Routine Description:</span>
00744 <span class="comment"></span>
00745 <span class="comment">    This routine is called to initialize the server dll.  It initializes</span>
00746 <span class="comment">    the console handle table.</span>
00747 <span class="comment"></span>
00748 <span class="comment">Arguments:</span>
00749 <span class="comment"></span>
00750 <span class="comment">    LoadedServerDll - Pointer to console server dll data</span>
00751 <span class="comment"></span>
00752 <span class="comment">Return Value:</span>
00753 <span class="comment"></span>
00754 <span class="comment">--*/</span>
00755 
00756 {
00757     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00758 
00759     LoadedServerDll-&gt;ApiNumberBase = CONSRV_FIRST_API_NUMBER;
00760     LoadedServerDll-&gt;MaxApiNumber = <a class="code" href="../../d5/d5/conmsg_8h.html#a236a235">ConsolepMaxApiNumber</a>;
00761     LoadedServerDll-&gt;ApiDispatchTable = (PCSR_API_ROUTINE *)<a class="code" href="../../d0/d5/srvinit_8c.html#a2">ConsoleServerApiDispatchTable</a>;
00762     LoadedServerDll-&gt;ApiServerValidTable = (PBOOLEAN)<a class="code" href="../../d0/d5/srvinit_8c.html#a3">ConsoleServerApiServerValidTable</a>;
00763 <span class="preprocessor">#if DBG</span>
00764 <span class="preprocessor"></span>    LoadedServerDll-&gt;ApiNameTable = ConsoleServerApiNameTable;
00765 <span class="preprocessor">#else</span>
00766 <span class="preprocessor"></span>    LoadedServerDll-&gt;ApiNameTable = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00767 <span class="preprocessor">#endif</span>
00768 <span class="preprocessor"></span>    LoadedServerDll-&gt;PerProcessDataLength = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">CONSOLE_PER_PROCESS_DATA</a>);
00769     LoadedServerDll-&gt;ConnectRoutine = <a class="code" href="../../d0/d5/srvinit_8c.html#a25">ConsoleClientConnectRoutine</a>;
00770     LoadedServerDll-&gt;DisconnectRoutine = <a class="code" href="../../d0/d5/srvinit_8c.html#a26">ConsoleClientDisconnectRoutine</a>;
00771     LoadedServerDll-&gt;AddProcessRoutine = <a class="code" href="../../d8/d5/consrv_8h.html#a69">ConsoleAddProcessRoutine</a>;
00772     LoadedServerDll-&gt;ShutdownProcessRoutine = <a class="code" href="../../d0/d5/srvinit_8c.html#a24">ConsoleClientShutdown</a>;
00773 
00774     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a4">ghInstance</a> = LoadedServerDll-&gt;ModuleHandle;
00775 
00776     <span class="comment">// initialize data structures</span>
00777 
00778     InitWin32HeapStubs();
00779 
00780     <a class="code" href="../../d8/d5/consrv_8h.html#a59">pConHeap</a> = Win32HeapCreate(
00781                               <span class="stringliteral">"CH_Head"</span>,
00782                               <span class="stringliteral">"CH_Tail"</span>,
00783                               HEAP_GROWABLE | HEAP_CLASS_5 |
00784 #<span class="keywordflow">if</span> <a class="code" href="../../d0/d9/ntosdef_8h.html#a8">DBG</a>
00785                               HEAP_TAIL_CHECKING_ENABLED,
00786 #<span class="keywordflow">else</span>
00787                               0,
00788 #endif
00789                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,             <span class="comment">// HeapBase</span>
00790                               64 * 1024,        <span class="comment">// ReserveSize</span>
00791                               4096,             <span class="comment">// CommitSize</span>
00792                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,             <span class="comment">// Lock to use for serialization</span>
00793                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);            <span class="comment">// GrowthThreshold</span>
00794 
00795     <span class="comment">// pConHeap = RtlProcessHeap();</span>
00796 
00797     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a59">pConHeap</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00798         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00799     }
00800 
00801     <a class="code" href="../../d8/d5/consrv_8h.html#a60">dwConBaseTag</a> = Win32HeapCreateTag( <a class="code" href="../../d8/d5/consrv_8h.html#a59">pConHeap</a>,
00802                                      0,
00803                                      <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"CON!"</span>,
00804                                      <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"TMP\0"</span>
00805                                      <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"BMP\0"</span>
00806                                      <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ALIAS\0"</span>
00807                                      <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"HISTORY\0"</span>
00808                                      <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"TITLE\0"</span>
00809                                      <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"HANDLE\0"</span>
00810                                      <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"CONSOLE\0"</span>
00811                                      <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ICON\0"</span>
00812                                      <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"BUFFER\0"</span>
00813                                      <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"WAIT\0"</span>
00814                                      <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"FONT\0"</span>
00815                                      <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SCREEN\0"</span>
00816 #<span class="keywordflow">if</span> defined(FE_SB)
00817                                      <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"TMP DBCS\0"</span>
00818                                      <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SCREEN DBCS\0"</span>
00819                                      <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"EUDC\0"</span>
00820                                      <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"CONVAREA\0"</span>
00821                                      <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"IME\0"</span>
00822 #endif
00823                                    );
00824     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a10">InitializeConsoleHandleTable</a>();
00825     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00826         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00827     }
00828 
00829     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a26">RtlInitializeCriticalSectionAndSpinCount</a>(&amp;<a class="code" href="../../d0/d5/srvinit_8c.html#a7">ConsoleInitWindowsLock</a>,
00830                                                       0x80000000);
00831     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00832         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00833     }
00834 
00835     <span class="comment">//</span>
00836     <span class="comment">// Initialize Input thread local message queue</span>
00837     <span class="comment">//</span>
00838     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a26">RtlInitializeCriticalSectionAndSpinCount</a>(&amp;<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a28">gInputThreadMsgLock</a>,
00839                                                       0x80000000);
00840     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00841         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00842     }
00843 
00844     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a37">InitializeThreadMessages</a>();
00845 
00846 <span class="preprocessor">#ifdef i386</span>
00847 <span class="preprocessor"></span>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a26">RtlInitializeCriticalSectionAndSpinCount</a>(&amp;<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a13">ConsoleVDMCriticalSection</a>,
00848                                                       0x80000000);
00849     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00850         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00851     }
00852     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a14">ConsoleVDMOnSwitching</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00853 <span class="preprocessor">#endif</span>
00854 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a> = GetOEMCP();
00855     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a3">WINDOWSCP</a> = GetACP();
00856 <span class="preprocessor">#if !defined(FE_SB)</span>
00857 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a22">ConsoleOutputCP</a> = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a>;
00858 <span class="preprocessor">#endif</span>
00859 <span class="preprocessor"></span>
00860     <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a21">InitializeFonts</a>();
00861 
00862     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a15">InputThreadTlsIndex</a> = TlsAlloc();
00863     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a15">InputThreadTlsIndex</a> == 0xFFFFFFFF)
00864         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00865 
00866 <span class="preprocessor">#if defined(FE_SB)</span>
00867 <span class="preprocessor"></span>    gfIsDBCSACP = !!<a class="code" href="../../d0/d3/dbcs_8h.html#a46">IsAvailableFarEastCodePage</a>(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a3">WINDOWSCP</a>);
00868 <span class="preprocessor">#endif</span>
00869 <span class="preprocessor"></span>
00870     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00871 }
00872 
00873 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00874"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a32">00874</a> <a class="code" href="../../d0/d5/srvinit_8c.html#a32">MapHandle</a>(
00875     IN HANDLE ClientProcessHandle,
00876     IN HANDLE ServerHandle,
00877     OUT PHANDLE ClientHandle
00878     )
00879 {
00880     <span class="comment">//</span>
00881     <span class="comment">// map event handle into dll's handle space.</span>
00882     <span class="comment">//</span>
00883 
00884     <span class="keywordflow">return</span> DuplicateHandle(NtCurrentProcess(),
00885                            ServerHandle,
00886                            ClientProcessHandle,
00887                            ClientHandle,
00888                            0,
00889                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00890                            DUPLICATE_SAME_ACCESS
00891                           );
00892 }
00893 
00894 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00895"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a33">00895</a> <a class="code" href="../../d0/d5/srvinit_8c.html#a33">AddProcessToList</a>(
00896     IN OUT <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00897     IN OUT <a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">PCONSOLE_PROCESS_HANDLE</a> ProcessHandleRecord,
00898     IN HANDLE ProcessHandle
00899     )
00900 {
00901     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(Console-&gt;Flags &amp; (<a class="code" href="../../d1/d7/server_8h.html#a12">CONSOLE_TERMINATING</a> | <a class="code" href="../../d1/d7/server_8h.html#a15">CONSOLE_SHUTTING_DOWN</a>)));
00902 
00903     ProcessHandleRecord-&gt;ProcessHandle = ProcessHandle;
00904     ProcessHandleRecord-&gt;TerminateCount = 0;
00905     InsertHeadList(&amp;Console-&gt;ProcessHandleList,&amp;ProcessHandleRecord-&gt;ListLink);
00906 
00907     <a class="code" href="../../d6/d2/output_8c.html#a72">SetProcessFocus</a>(ProcessHandleRecord-&gt;Process, Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a2">CONSOLE_HAS_FOCUS</a>);
00908 }
00909 
00910 <a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">PCONSOLE_PROCESS_HANDLE</a>
<a name="l00911"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a34">00911</a> <a class="code" href="../../d0/d5/srvinit_8c.html#a34">FindProcessInList</a>(
00912     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00913     IN HANDLE ProcessHandle
00914     )
00915 {
00916     <a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">PCONSOLE_PROCESS_HANDLE</a> ProcessHandleRecord;
00917     PLIST_ENTRY ListHead, ListNext;
00918 
00919     ListHead = &amp;Console-&gt;ProcessHandleList;
00920     ListNext = ListHead-&gt;Flink;
00921     <span class="keywordflow">while</span> (ListNext != ListHead) {
00922         ProcessHandleRecord = CONTAINING_RECORD( ListNext, <a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">CONSOLE_PROCESS_HANDLE</a>, ListLink );
00923         <span class="keywordflow">if</span> (ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o1">ProcessHandle</a> == ProcessHandle) {
00924             <span class="keywordflow">return</span> ProcessHandleRecord;
00925         }
00926         ListNext = ListNext-&gt;Flink;
00927     }
00928     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00929 }
00930 
00931 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00932"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a35">00932</a> <a class="code" href="../../d0/d5/srvinit_8c.html#a35">RemoveProcessFromList</a>(
00933     IN OUT <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00934     IN HANDLE ProcessHandle
00935     )
00936 {
00937     <a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">PCONSOLE_PROCESS_HANDLE</a> ProcessHandleRecord;
00938     PLIST_ENTRY ListHead, ListNext;
00939 
00940     ListHead = &amp;Console-&gt;ProcessHandleList;
00941     ListNext = ListHead-&gt;Flink;
00942     <span class="keywordflow">while</span> (ListNext != ListHead) {
00943         ProcessHandleRecord = CONTAINING_RECORD( ListNext, <a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">CONSOLE_PROCESS_HANDLE</a>, ListLink );
00944         ListNext = ListNext-&gt;Flink;
00945         <span class="keywordflow">if</span> (ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o1">ProcessHandle</a> == ProcessHandle) {
00946             RemoveEntryList(&amp;ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o0">ListLink</a>);
00947             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ProcessHandleRecord);
00948             <span class="keywordflow">return</span>;
00949         }
00950     }
00951     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00952 }
00953 
00954 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00955"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a36">00955</a> <a class="code" href="../../d0/d5/srvinit_8c.html#a36">SetUpConsole</a>(
00956     IN OUT <a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html">PCONSOLE_INFO</a> ConsoleInfo,
00957     IN DWORD TitleLength,
00958     IN LPWSTR Title,
00959     IN LPWSTR CurDir,
00960     IN LPWSTR AppName,
00961     IN <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData,
00962     IN BOOLEAN WindowVisible,
00963     IN PUNICODE_STRING pstrDesktopName
00964     )
00965 {
00966     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00967     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
00968     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> ConsoleThreadId;
00969     HWINSTA hwinsta;
00970     HDESK hdesk;
00971     USEROBJECTFLAGS UserObjectFlags;
00972     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> Length;
00973 
00974     <span class="comment">//</span>
00975     <span class="comment">// Connect to the windowstation and desktop.</span>
00976     <span class="comment">//</span>
00977 
00978     <span class="keywordflow">if</span> (!CsrImpersonateClient(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00979         <span class="keywordflow">return</span> STATUS_BAD_IMPERSONATION_LEVEL;
00980     }
00981 
00982     hdesk = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a97">NtUserResolveDesktop</a>(<a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>(),
00983             pstrDesktopName, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;hwinsta);
00984 
00985     CsrRevertToSelf();
00986 
00987     <span class="keywordflow">if</span> (hdesk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00988         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00989     }
00990 
00991     <span class="comment">//</span>
00992     <span class="comment">// Need to initialize windows stuff once real console app starts.</span>
00993     <span class="comment">// This is because for the time being windows expects the first</span>
00994     <span class="comment">// app to be a windows app.</span>
00995     <span class="comment">//</span>
00996 
00997     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/srvinit_8c.html#a30">InitWindowsStuff</a>(hdesk, &amp;ConsoleThreadId);
00998     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00999         CloseDesktop(hdesk);
01000         <a class="code" href="../../d3/d0/user32_8def.html#a72">CloseWindowStation</a>(hwinsta);
01001         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01002     }
01003 
01004     <span class="comment">//</span>
01005     <span class="comment">// If the windowstation isn't visible, then neither is the window.</span>
01006     <span class="comment">//</span>
01007 
01008     <span class="keywordflow">if</span> (WindowVisible) {
01009         <span class="keywordflow">if</span> (GetUserObjectInformation(hwinsta,
01010                                      UOI_FLAGS,
01011                                      &amp;UserObjectFlags,
01012                                      <span class="keyword">sizeof</span>(UserObjectFlags),
01013                                      &amp;Length)) {
01014             <span class="keywordflow">if</span> (!(UserObjectFlags.dwFlags &amp; WSF_VISIBLE)) {
01015                 WindowVisible = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01016             }
01017         }
01018     }
01019 
01020     <span class="comment">//</span>
01021     <span class="comment">// We need to see if we were spawned from a link.  If we were, we</span>
01022     <span class="comment">// need to call back into the shell to try to get all the console</span>
01023     <span class="comment">// information from the link.</span>
01024     <span class="comment">//</span>
01025 
01026     <a class="code" href="../../d0/d5/srvinit_8c.html#a28">LoadLinkInfo</a>( ConsoleInfo, Title, &amp;TitleLength, CurDir, AppName );
01027 
01028     <a class="code" href="../../d8/d5/consrv_8h.html#a40">LockConsoleHandleTable</a>();
01029 
01030     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a13">AllocateConsoleHandle</a>(&amp;ConsoleInfo-&gt;ConsoleHandle);
01031     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01032         <a class="code" href="../../d8/d5/consrv_8h.html#a41">UnlockConsoleHandleTable</a>();
01033         CloseDesktop(hdesk);
01034         <a class="code" href="../../d3/d0/user32_8def.html#a72">CloseWindowStation</a>(hwinsta);
01035         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01036     }
01037 
01038     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a19">AllocateConsole</a>(ConsoleInfo-&gt;ConsoleHandle,
01039                              Title,
01040                              (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)TitleLength,
01041                              <a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>(),
01042                              &amp;ConsoleInfo-&gt;StdIn,
01043                              &amp;ConsoleInfo-&gt;StdOut,
01044                              &amp;ConsoleInfo-&gt;StdErr,
01045                              ProcessData,
01046                              ConsoleInfo,
01047                              WindowVisible,
01048                              ConsoleThreadId
01049                              );
01050     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01051         <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a14">FreeConsoleHandle</a>(ConsoleInfo-&gt;ConsoleHandle);
01052         <a class="code" href="../../d8/d5/consrv_8h.html#a41">UnlockConsoleHandleTable</a>();
01053         CloseDesktop(hdesk);
01054         <a class="code" href="../../d3/d0/user32_8def.html#a72">CloseWindowStation</a>(hwinsta);
01055         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01056     }
01057     <a class="code" href="../../d1/d7/server_8h.html#a90">CONSOLE_SETCONSOLEHANDLE</a>(ConsoleInfo-&gt;ConsoleHandle);
01058     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a11">DereferenceConsoleHandle</a>(ConsoleInfo-&gt;ConsoleHandle,&amp;Console);
01059     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01060 
01061     <span class="comment">//</span>
01062     <span class="comment">// increment console reference count</span>
01063     <span class="comment">//</span>
01064 
01065     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o1">RefCount</a>++;
01066 
01067     <span class="comment">//</span>
01068     <span class="comment">// Save the windowstation and desktop handles so they</span>
01069     <span class="comment">// can be used later</span>
01070     <span class="comment">//</span>
01071 
01072     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o6">hWinSta</a> = hwinsta;
01073     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o7">hDesk</a> = hdesk;
01074 
01075     <a class="code" href="../../d8/d5/consrv_8h.html#a41">UnlockConsoleHandleTable</a>();
01076 
01077 <span class="preprocessor">#if defined(FE_IME)</span>
01078 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a33">CONSOLE_IS_IME_ENABLED</a>())
01079     {
01080         <span class="keywordflow">if</span> (WindowVisible)
01081         {
01082             InitConsoleIMEStuff(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o7">hDesk</a>, ConsoleThreadId, Console);
01083         }
01084     }
01085 <span class="preprocessor">#endif</span>
01086 <span class="preprocessor"></span>
01087     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01088 }
01089 
01090 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01091"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a25">01091</a> <a class="code" href="../../d0/d5/srvinit_8c.html#a25">ConsoleClientConnectRoutine</a>(
01092     IN PCSR_PROCESS Process,
01093     IN OUT PVOID ConnectionInfo,
01094     IN OUT PULONG ConnectionInfoLength
01095     )
01096 
01097 <span class="comment">/*++</span>
01098 <span class="comment"></span>
01099 <span class="comment">Routine Description:</span>
01100 <span class="comment"></span>
01101 <span class="comment">    This routine is called when a new process is created.  For processes</span>
01102 <span class="comment">    without parents, it creates the console.  For processes with</span>
01103 <span class="comment">    parents, it duplicates the handle table.</span>
01104 <span class="comment"></span>
01105 <span class="comment">Arguments:</span>
01106 <span class="comment"></span>
01107 <span class="comment">    Process - Pointer to process structure.</span>
01108 <span class="comment"></span>
01109 <span class="comment">    ConnectionInfo - Pointer to connection info.</span>
01110 <span class="comment"></span>
01111 <span class="comment">    ConnectionInfoLength - Connection info length.</span>
01112 <span class="comment"></span>
01113 <span class="comment">Return Value:</span>
01114 <span class="comment"></span>
01115 <span class="comment">--*/</span>
01116 
01117 {
01118     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01119     <a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html">PCONSOLE_API_CONNECTINFO</a> p = (<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html">PCONSOLE_API_CONNECTINFO</a>)ConnectionInfo;
01120     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
01121     <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData;
01122     <a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">PCONSOLE_PROCESS_HANDLE</a> ProcessHandleRecord;
01123     CONSOLEWINDOWSTATIONPROCESS ConsoleWindowStationInfo;
01124     UNICODE_STRING strDesktopName;
01125     CONSOLE_PROCESS_INFO cpi;
01126 
01127     <span class="keywordflow">if</span> (p == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
01128         *ConnectionInfoLength != <span class="keyword">sizeof</span>( *p ) ||
01129         p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o9">AppNameLength</a> &gt; <span class="keyword">sizeof</span>(p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o10">AppName</a>) ||
01130         p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o11">CurDirLength</a> &gt; <span class="keyword">sizeof</span>(p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o12">CurDir</a>) ||
01131         p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o5">TitleLength</a> &gt; <span class="keyword">sizeof</span>(p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o6">Title</a>)) {
01132 
01133         KdPrint((<span class="stringliteral">"CONSRV: bad connection info\n"</span>));
01134         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01135         <span class="keywordflow">return</span>( STATUS_UNSUCCESSFUL );
01136     }
01137 
01138     <span class="comment">//</span>
01139     <span class="comment">// Make sure the strings are NULL terminated.</span>
01140     <span class="comment">//</span>
01141 
01142     p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o10">AppName</a>[<a class="code" href="../../d2/d3/tnlsxlat_8c.html#a0">NELEM</a>(p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o10">AppName</a>) - 1] = 0;
01143     p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o12">CurDir</a>[<a class="code" href="../../d2/d3/tnlsxlat_8c.html#a0">NELEM</a>(p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o12">CurDir</a>) - 1] = 0;
01144     p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o6">Title</a>[<a class="code" href="../../d2/d3/tnlsxlat_8c.html#a0">NELEM</a>(p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o6">Title</a>) - 1] = 0;
01145 
01146     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a10">CtrlRoutine</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01147         <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a10">CtrlRoutine</a> = p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o3">CtrlRoutine</a>;
01148     }
01149 <span class="preprocessor">#if defined(FE_IME)</span>
01150 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a11">ConsoleIMERoutine</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01151         <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a11">ConsoleIMERoutine</a> = p-&gt;ConsoleIMERoutine;
01152     }
01153 <span class="preprocessor">#endif</span>
01154 <span class="preprocessor"></span>    ProcessData = <a class="code" href="../../d1/d7/server_8h.html#a82">CONSOLE_FROMPROCESSPERPROCESSDATA</a>(Process);
01155     Console = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01156 
01157     <span class="comment">//</span>
01158     <span class="comment">// If this process is not a console app, stop right here - no</span>
01159     <span class="comment">// initialization is needed. Just need to remember that this</span>
01160     <span class="comment">// is not a console app so that we do no work during</span>
01161     <span class="comment">// ClientDisconnectRoutine().</span>
01162     <span class="comment">//</span>
01163 
01164     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01165     <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d7/server_8h.html#a86">CONSOLE_GETCONSOLEAPPFROMPROCESSDATA</a>(ProcessData) = p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o1">ConsoleApp</a>)) {
01166 
01167         <span class="comment">//</span>
01168         <span class="comment">// First call off to USER so it unblocks any app waiting on a call</span>
01169         <span class="comment">// to WaitForInputIdle. This way apps calling WinExec() to exec console</span>
01170         <span class="comment">// apps will return right away.</span>
01171         <span class="comment">//</span>
01172 
01173 
01174         <span class="comment">/*</span>
01175 <span class="comment">         * Bug 273518 - joejo</span>
01176 <span class="comment">         *</span>
01177 <span class="comment">         * Adding optimization to bug fix</span>
01178 <span class="comment">         */</span>
01179         cpi.dwProcessID = HandleToUlong(<a class="code" href="../../d1/d7/server_8h.html#a80">CONSOLE_CLIENTPROCESSID</a>());
01180         cpi.dwFlags = (p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o0">ConsoleInfo</a>.<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o0">ConsoleHandle</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ? 0 : CPI_NEWPROCESSWINDOW;
01181 
01182         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a86">NtUserConsoleControl</a>(ConsoleNotifyConsoleApplication,
01183                 &amp;cpi, <span class="keyword">sizeof</span>(CONSOLE_PROCESS_INFO));
01184 
01185         <span class="comment">//</span>
01186         <span class="comment">// create console</span>
01187         <span class="comment">//</span>
01188 
01189         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o0">ConsoleInfo</a>.<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o0">ConsoleHandle</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01190             ProcessHandleRecord = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a14">HANDLE_TAG</a> ),<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">CONSOLE_PROCESS_HANDLE</a>));
01191             <span class="keywordflow">if</span> (ProcessHandleRecord == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01192                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
01193                 <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01194             }
01195 
01196             <span class="comment">//</span>
01197             <span class="comment">// We are creating a new console, so derereference</span>
01198             <span class="comment">// the parent's console, if any.</span>
01199             <span class="comment">//</span>
01200 
01201             <span class="keywordflow">if</span> (ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o0">ConsoleHandle</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01202                 <a class="code" href="../../d0/d5/srvinit_8c.html#a37">RemoveConsole</a>(ProcessData, Process-&gt;ProcessHandle, 0);
01203             }
01204 
01205             <span class="comment">//</span>
01206             <span class="comment">// Get the desktop name.</span>
01207             <span class="comment">//</span>
01208 
01209             <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o7">DesktopLength</a>) {
01210                 strDesktopName.Buffer = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(
01211                                                   <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),
01212                                                   p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o7">DesktopLength</a>);
01213                 <span class="keywordflow">if</span> (strDesktopName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01214                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
01215                     <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01216                 }
01217                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a9">NtReadVirtualMemory</a>(Process-&gt;ProcessHandle,
01218                                     (PVOID)p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o8">Desktop</a>,
01219                                     strDesktopName.Buffer,
01220                                     p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o7">DesktopLength</a>,
01221                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01222                                    );
01223                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01224                     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(strDesktopName.Buffer);
01225                     <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01226                 }
01227                 strDesktopName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o7">DesktopLength</a>;
01228                 strDesktopName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o7">DesktopLength</a> - <span class="keyword">sizeof</span>(WCHAR));
01229             } <span class="keywordflow">else</span> {
01230                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strDesktopName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Default"</span>);
01231             }
01232 
01233             ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o6">RootProcess</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01234             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/srvinit_8c.html#a36">SetUpConsole</a>(&amp;p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o0">ConsoleInfo</a>,
01235                                     p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o5">TitleLength</a>,
01236                                     p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o6">Title</a>,
01237                                     p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o12">CurDir</a>,
01238                                     p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o10">AppName</a>,
01239                                     ProcessData,
01240                                     p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o2">WindowVisible</a>,
01241                                     &amp;strDesktopName);
01242             <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o7">DesktopLength</a>)
01243                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(strDesktopName.Buffer);
01244             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01245                 <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01246             }
01247 
01248             <span class="comment">// Play the Open sound for console apps</span>
01249 
01250             <a class="code" href="../../d5/d4/server_2msgbeep_8c.html#a0">ConsolePlaySound</a>();
01251 
01252             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a34">RevalidateConsole</a>(p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o0">ConsoleInfo</a>.<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o0">ConsoleHandle</a>,&amp;Console);
01253             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01254         }
01255         <span class="keywordflow">else</span> {
01256             ProcessHandleRecord = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01257             ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o6">RootProcess</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01258 
01259             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01260             <span class="keywordflow">if</span> (!(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a34">RevalidateConsole</a>(p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o0">ConsoleInfo</a>.<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o0">ConsoleHandle</a>,&amp;Console))) ) {
01261                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PROCESS_IS_TERMINATING;
01262                 <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01263             }
01264 
01265             <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a15">CONSOLE_SHUTTING_DOWN</a>) {
01266                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PROCESS_IS_TERMINATING;
01267                 <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01268             }
01269 
01270             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d5/srvinit_8c.html#a32">MapHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>(),
01271                             Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o17">InitEvents</a>[<a class="code" href="../../d5/d5/conmsg_8h.html#a4">INITIALIZATION_SUCCEEDED</a>],
01272                             &amp;p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o0">ConsoleInfo</a>.<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o5">InitEvents</a>[<a class="code" href="../../d5/d5/conmsg_8h.html#a4">INITIALIZATION_SUCCEEDED</a>]
01273                             ) ||
01274                 !<a class="code" href="../../d0/d5/srvinit_8c.html#a32">MapHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>(),
01275                             Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o17">InitEvents</a>[<a class="code" href="../../d5/d5/conmsg_8h.html#a5">INITIALIZATION_FAILED</a>],
01276                             &amp;p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o0">ConsoleInfo</a>.<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o5">InitEvents</a>[<a class="code" href="../../d5/d5/conmsg_8h.html#a5">INITIALIZATION_FAILED</a>]
01277                             ) ||
01278                 !<a class="code" href="../../d0/d5/srvinit_8c.html#a32">MapHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>(),
01279                             Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o3">InputBuffer</a>.<a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html#o11">InputWaitEvent</a>,
01280                             &amp;p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o0">ConsoleInfo</a>.<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o1">InputWaitHandle</a>
01281                             )) {
01282                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
01283                 <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01284             }
01285 
01286             ProcessHandleRecord = <a class="code" href="../../d0/d5/srvinit_8c.html#a34">FindProcessInList</a>(Console,<a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>());
01287             <span class="keywordflow">if</span> (ProcessHandleRecord) {
01288                 ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o4">CtrlRoutine</a> = p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o3">CtrlRoutine</a>;
01289                 ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o5">PropRoutine</a> = p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o4">PropRoutine</a>;
01290                 ProcessHandleRecord = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01291             }
01292         }
01293         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01294 
01295             <span class="comment">//</span>
01296             <span class="comment">// Associate the correct window station with client process</span>
01297             <span class="comment">// so they can do Global atom calls.</span>
01298             <span class="comment">//</span>
01299             <span class="keywordflow">if</span> (DuplicateHandle( NtCurrentProcess(),
01300                                  Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o6">hWinSta</a>,
01301                                  Process-&gt;ProcessHandle,
01302                                  &amp;ConsoleWindowStationInfo.hwinsta,
01303                                  0,
01304                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01305                                  DUPLICATE_SAME_ACCESS
01306                                )
01307                ) {
01308                 ConsoleWindowStationInfo.dwProcessId = HandleToUlong(<a class="code" href="../../d1/d7/server_8h.html#a80">CONSOLE_CLIENTPROCESSID</a>());
01309                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a86">NtUserConsoleControl</a>(ConsoleWindowStationProcess,
01310                         &amp;ConsoleWindowStationInfo, <span class="keyword">sizeof</span>(ConsoleWindowStationInfo));
01311 
01312                 }
01313 
01314             <span class="keywordflow">if</span> (ProcessHandleRecord) {
01315                 ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o2">Process</a> = Process;
01316                 ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o4">CtrlRoutine</a> = p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o3">CtrlRoutine</a>;
01317                 ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o5">PropRoutine</a> = p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o4">PropRoutine</a>;
01318                 <a class="code" href="../../d0/d5/srvinit_8c.html#a33">AddProcessToList</a>(Console,ProcessHandleRecord,<a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>());
01319             }
01320             <a class="code" href="../../d6/d2/output_8c.html#a73">SetProcessForegroundRights</a>(Process,
01321                                        Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a2">CONSOLE_HAS_FOCUS</a>);
01322             <a class="code" href="../../d8/d5/consrv_8h.html#a254">AllocateCommandHistory</a>(Console,
01323                             p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o9">AppNameLength</a>,
01324                             p-&gt;<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o10">AppName</a>,
01325                             <a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>());
01326             <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01327 
01328         } <span class="keywordflow">else</span> {
01329 <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>:
01330             <a class="code" href="../../d1/d7/server_8h.html#a88">CONSOLE_SETCONSOLEAPPFROMPROCESSDATA</a>(ProcessData,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01331             <span class="keywordflow">if</span> (ProcessHandleRecord)
01332                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ProcessHandleRecord);
01333             <span class="keywordflow">if</span> (Console) {
01334                 <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01335             }
01336             <span class="keywordflow">if</span> (ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o0">ConsoleHandle</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01337                 <a class="code" href="../../d0/d5/srvinit_8c.html#a37">RemoveConsole</a>(ProcessData, Process-&gt;ProcessHandle, 0);
01338             }
01339         }
01340     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o0">ConsoleHandle</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01341 
01342         <span class="comment">//</span>
01343         <span class="comment">// This is a non-console app with a reference to a</span>
01344         <span class="comment">// reference to a parent console.  Dereference the</span>
01345         <span class="comment">// console.</span>
01346         <span class="comment">//</span>
01347 
01348         <a class="code" href="../../d0/d5/srvinit_8c.html#a37">RemoveConsole</a>(ProcessData, Process-&gt;ProcessHandle, 0);
01349     }
01350 
01351     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01352 }
01353 
01354 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01355"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a37">01355</a> <a class="code" href="../../d0/d5/srvinit_8c.html#a37">RemoveConsole</a>(
01356     IN <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData,
01357     IN HANDLE ProcessHandle,
01358     IN HANDLE ProcessId
01359     )
01360 {
01361     ULONG i;
01362     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
01363     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01364     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
01365 
01366     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a34">RevalidateConsole</a>(ProcessData-&gt;ConsoleHandle, &amp;Console);
01367 
01368     <span class="comment">//</span>
01369     <span class="comment">// If this process isn't using the console, error.</span>
01370     <span class="comment">//</span>
01371 
01372     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01373         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01374         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01375     }
01376 
01377     <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a7">CONSOLE_NOTIFY_LAST_CLOSE</a>) {
01378         <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o73">ProcessIdLastNotifyClose</a> == ProcessId) {
01379             <span class="comment">// if this process is the one who wants last close notification,</span>
01380             <span class="comment">// remove it.</span>
01381             Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a7">CONSOLE_NOTIFY_LAST_CLOSE</a>;
01382             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o72">hProcessLastNotifyClose</a>);
01383         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ProcessData-&gt;RootProcess) {
01384             <span class="comment">// notify the ntvdm process to terminate if the console root</span>
01385             <span class="comment">// process is going away.</span>
01386             HANDLE ConsoleHandle;
01387             <a class="code" href="../../d2/d4/struct__CONSOLE__PROCESS__TERMINATION__RECORD.html">CONSOLE_PROCESS_TERMINATION_RECORD</a> ProcessHandleList;
01388 
01389             Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a7">CONSOLE_NOTIFY_LAST_CLOSE</a>;
01390             ConsoleHandle = Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o65">ConsoleHandle</a>;
01391             ProcessHandleList.<a class="code" href="../../d2/d4/struct__CONSOLE__PROCESS__TERMINATION__RECORD.html#o0">ProcessHandle</a> = Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o72">hProcessLastNotifyClose</a>;
01392             ProcessHandleList.<a class="code" href="../../d2/d4/struct__CONSOLE__PROCESS__TERMINATION__RECORD.html#o1">TerminateCount</a> = 0;
01393             ProcessHandleList.<a class="code" href="../../d2/d4/struct__CONSOLE__PROCESS__TERMINATION__RECORD.html#o3">CtrlRoutine</a> = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a10">CtrlRoutine</a>;
01394             <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01395             <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a52">CreateCtrlThread</a>(&amp;ProcessHandleList,
01396                             1,
01397                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01398                             SYSTEM_ROOT_CONSOLE_EVENT,
01399                             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01400             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(ProcessHandleList.<a class="code" href="../../d2/d4/struct__CONSOLE__PROCESS__TERMINATION__RECORD.html#o0">ProcessHandle</a>);
01401             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a34">RevalidateConsole</a>(ConsoleHandle, &amp;Console);
01402             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01403             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01404                 <span class="keywordflow">return</span> STATUS_SUCCESS;
01405             }
01406         }
01407     }
01408 
01409     <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o52">VDMProcessId</a> == ProcessId &amp;&amp;
01410         (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>)) {
01411         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a14">CONSOLE_FULLSCREEN_NOPAINT</a>;
01412         <a class="code" href="../../d0/d5/srvinit_8c.html#a22">UnregisterVDM</a>(Console);
01413     }
01414 
01415     <span class="keywordflow">if</span> (ProcessHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01416         <a class="code" href="../../d0/d5/srvinit_8c.html#a35">RemoveProcessFromList</a>(Console,ProcessHandle);
01417         <a class="code" href="../../d8/d5/consrv_8h.html#a259">FreeCommandHistory</a>(Console,ProcessHandle);
01418     }
01419 
01420     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o1">RefCount</a>);
01421 
01422     <span class="comment">//</span>
01423     <span class="comment">// close the process's handles.</span>
01424     <span class="comment">//</span>
01425 
01426     <span class="keywordflow">for</span> (i=0;i&lt;ProcessData-&gt;HandleTableSize;i++) {
01427         <span class="keywordflow">if</span> (ProcessData-&gt;HandleTablePtr[i].HandleType != <a class="code" href="../../d1/d7/server_8h.html#a47">CONSOLE_FREE_HANDLE</a>) {
01428             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">DereferenceIoHandleNoCheck</a>(ProcessData,
01429                                                 (HANDLE) i,
01430                                                 &amp;HandleData
01431                                                );
01432             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01433             <span class="keywordflow">if</span> (HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> &amp; <a class="code" href="../../d5/d5/conmsg_8h.html#a0">CONSOLE_INPUT_HANDLE</a>) {
01434                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a35">CloseInputHandle</a>(ProcessData,Console,HandleData,(HANDLE) i);
01435             }
01436             <span class="keywordflow">else</span> {
01437                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a36">CloseOutputHandle</a>(ProcessData,Console,HandleData,(HANDLE) i,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01438             }
01439         }
01440     }
01441     <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a25">FreeProcessData</a>(ProcessData);
01442     ProcessData-&gt;ConsoleHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01443 
01444     <span class="comment">//</span>
01445     <span class="comment">// decrement the console reference count.  free the console if it goes to</span>
01446     <span class="comment">// zero.</span>
01447     <span class="comment">//</span>
01448 
01449     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o1">RefCount</a>--;
01450     <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o1">RefCount</a> == 0) {
01451 
01452 <span class="preprocessor">#if defined(FE_IME)</span>
01453 <span class="preprocessor"></span>
01454         PCONVERSIONAREA_INFORMATION ConvAreaInfo;
01455         PCONVERSIONAREA_INFORMATION ConvAreaInfoNext;
01456 
01457         ConvAreaInfo = Console-&gt;ConsoleIme.ConvAreaRoot;
01458         <span class="keywordflow">while</span>(ConvAreaInfo) {
01459             ConvAreaInfoNext = ConvAreaInfo-&gt;ConvAreaNext;
01460             FreeConvAreaScreenBuffer(ConvAreaInfo-&gt;ScreenBuffer);
01461             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ConvAreaInfo);
01462             ConvAreaInfo = ConvAreaInfoNext;
01463         }
01464 
01465         <span class="keywordflow">if</span> (Console-&gt;ConsoleIme.NumberOfConvAreaCompStr) {
01466             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Console-&gt;ConsoleIme.ConvAreaCompStr);
01467         }
01468         <span class="keywordflow">if</span> (Console-&gt;ConsoleIme.CompStrData) {
01469             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Console-&gt;ConsoleIme.CompStrData);
01470         }
01471 <span class="preprocessor">#endif</span>
01472 <span class="preprocessor"></span>        <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a21">FreeCon</a>(Console);
01473     }
01474     <span class="keywordflow">else</span> {
01475         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01476     }
01477     <span class="keywordflow">return</span>( STATUS_SUCCESS );
01478 }
01479 
01480 <span class="comment">//NTSTATUS</span>
01481 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01482"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a26">01482</a> <a class="code" href="../../d0/d5/srvinit_8c.html#a26">ConsoleClientDisconnectRoutine</a>(
01483     IN PCSR_PROCESS Process
01484     )
01485 
01486 <span class="comment">/*++</span>
01487 <span class="comment"></span>
01488 <span class="comment">Routine Description:</span>
01489 <span class="comment"></span>
01490 <span class="comment">    This routine is called when a process is destroyed.  It closes the</span>
01491 <span class="comment">    process's handles and frees the console if it's the last reference.</span>
01492 <span class="comment"></span>
01493 <span class="comment">Arguments:</span>
01494 <span class="comment"></span>
01495 <span class="comment">    Process - Pointer to process structure.</span>
01496 <span class="comment"></span>
01497 <span class="comment">Return Value:</span>
01498 <span class="comment"></span>
01499 <span class="comment">--*/</span>
01500 
01501 {
01502     <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData;
01503 
01504 <span class="preprocessor">#if 0</span>
01505 <span class="preprocessor"></span>    OutputDebugString(<span class="stringliteral">"entering ConsoleClientDisconnectRoutine\n"</span>);
01506 <span class="preprocessor">#endif</span>
01507 <span class="preprocessor"></span>    ProcessData = <a class="code" href="../../d1/d7/server_8h.html#a82">CONSOLE_FROMPROCESSPERPROCESSDATA</a>(Process);
01508 
01509     <span class="comment">//</span>
01510     <span class="comment">// If this process is not a console app, stop right here - no</span>
01511     <span class="comment">// disconnect processing is needed, because this app didn't create</span>
01512     <span class="comment">// or connect to an existing console.</span>
01513     <span class="comment">//</span>
01514 
01515     <span class="keywordflow">if</span> ( ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o0">ConsoleHandle</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01516 <span class="preprocessor">#if defined(FE_IME)</span>
01517 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (ProcessData-&gt;hDesk )
01518         {
01519             <span class="comment">//</span>
01520             <span class="comment">// If this process is a Console IME,</span>
01521             <span class="comment">// should unregister console IME on this desktop.</span>
01522             <span class="comment">//</span>
01523             RemoveConsoleIME(Process, HandleToUlong(Process-&gt;ClientId.UniqueThread));
01524         }
01525 <span class="preprocessor">#endif</span>
01526 <span class="preprocessor"></span>        <span class="keywordflow">return</span>;
01527     }
01528 
01529     <a class="code" href="../../d0/d5/srvinit_8c.html#a37">RemoveConsole</a>(ProcessData,
01530             <a class="code" href="../../d1/d7/server_8h.html#a81">CONSOLE_FROMPROCESSPROCESSHANDLE</a>(Process),
01531             Process-&gt;ClientId.UniqueProcess);
01532     <a class="code" href="../../d1/d7/server_8h.html#a88">CONSOLE_SETCONSOLEAPPFROMPROCESSDATA</a>(ProcessData,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01533     <span class="keywordflow">return</span>;
01534 }
01535 
01536 ULONG
<a name="l01537"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a38">01537</a> <a class="code" href="../../d0/d5/srvinit_8c.html#a38">SrvAllocConsole</a>(
01538     IN OUT PCSR_API_MSG m,
01539     IN OUT PCSR_REPLY_STATUS ReplyStatus
01540     )
01541 {
01542     <a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html">PCONSOLE_ALLOC_MSG</a> a = (<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html">PCONSOLE_ALLOC_MSG</a>)&amp;m-&gt;u.ApiMessageData;
01543     <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData;
01544     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01545     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
01546     <a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">PCONSOLE_PROCESS_HANDLE</a> ProcessHandleRecord;
01547     PCSR_PROCESS Process;
01548     UNICODE_STRING strDesktopName;
01549 
01550     ProcessData = <a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>();
01551     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d1/d7/server_8h.html#a86">CONSOLE_GETCONSOLEAPPFROMPROCESSDATA</a>(ProcessData));
01552 
01553     <span class="keywordflow">if</span> (!CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o2">Title</a>, a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o1">TitleLength</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)) ||
01554         !CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o4">Desktop</a>, a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o3">DesktopLength</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)) ||
01555         !CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o8">CurDir</a>, a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o7">CurDirLength</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)) ||
01556         !CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o6">AppName</a>, a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o5">AppNameLength</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)) ||
01557         !CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o0">ConsoleInfo</a>, <span class="keyword">sizeof</span>(*a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o0">ConsoleInfo</a>), <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>))) {
01558 
01559         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01560     }
01561 
01562     Process = (PCSR_PROCESS)(CSR_SERVER_QUERYCLIENTTHREAD()-&gt;Process);
01563     <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o3">DesktopLength</a>)
01564         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strDesktopName, a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o4">Desktop</a>);
01565     <span class="keywordflow">else</span>
01566         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strDesktopName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Default"</span>);
01567 
01568     ProcessHandleRecord = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a14">HANDLE_TAG</a> ),<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">CONSOLE_PROCESS_HANDLE</a>));
01569     <span class="keywordflow">if</span> (ProcessHandleRecord == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01570         <span class="keywordflow">return</span> (ULONG)STATUS_NO_MEMORY;
01571     }
01572 
01573     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/srvinit_8c.html#a36">SetUpConsole</a>(a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o0">ConsoleInfo</a>,
01574                           a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o1">TitleLength</a>,
01575                           a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o2">Title</a>,
01576                           a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o8">CurDir</a>,
01577                           a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o6">AppName</a>,
01578                           ProcessData,
01579                           <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01580                           &amp;strDesktopName);
01581     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01582         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ProcessHandleRecord);
01583         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01584     }
01585     <a class="code" href="../../d1/d7/server_8h.html#a87">CONSOLE_SETCONSOLEAPP</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01586     Process-&gt;Flags |= CSR_PROCESS_CONSOLEAPP;
01587     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a34">RevalidateConsole</a>(a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o0">ConsoleInfo</a>-&gt;<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o0">ConsoleHandle</a>,&amp;Console);
01588     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01589     ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o2">Process</a> = CSR_SERVER_QUERYCLIENTTHREAD()-&gt;Process;
01590     ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o4">CtrlRoutine</a> = a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o9">CtrlRoutine</a>;
01591     ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o5">PropRoutine</a> = a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o10">PropRoutine</a>;
01592     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (!(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a15">CONSOLE_SHUTTING_DOWN</a>));
01593     <a class="code" href="../../d0/d5/srvinit_8c.html#a33">AddProcessToList</a>(Console,ProcessHandleRecord,<a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>());
01594     <a class="code" href="../../d6/d2/output_8c.html#a73">SetProcessForegroundRights</a>(Process,
01595                                Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a2">CONSOLE_HAS_FOCUS</a>);
01596     (HANDLE) <a class="code" href="../../d8/d5/consrv_8h.html#a254">AllocateCommandHistory</a>(Console,
01597                            a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o5">AppNameLength</a>,
01598                            a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o6">AppName</a>,
01599                            <a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>());
01600 
01601     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01602 
01603     <span class="keywordflow">return</span> STATUS_SUCCESS;
01604     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
01605 }
01606 
01607 ULONG
<a name="l01608"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a39">01608</a> <a class="code" href="../../d0/d5/srvinit_8c.html#a39">SrvFreeConsole</a>(
01609     IN OUT PCSR_API_MSG m,
01610     IN OUT PCSR_REPLY_STATUS ReplyStatus
01611     )
01612 {
01613     <a class="code" href="../../d4/d0/struct__CONSOLE__FREE__MSG.html">PCONSOLE_FREE_MSG</a> a = (<a class="code" href="../../d4/d0/struct__CONSOLE__FREE__MSG.html">PCONSOLE_FREE_MSG</a>)&amp;m-&gt;u.ApiMessageData;
01614     <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData;
01615     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01616 
01617     ProcessData = <a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>();
01618     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d7/server_8h.html#a86">CONSOLE_GETCONSOLEAPPFROMPROCESSDATA</a>(ProcessData));
01619 
01620     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d7/server_8h.html#a91">CONSOLE_GETCONSOLEHANDLEFROMPROCESSDATA</a>(ProcessData)==a-&gt;<a class="code" href="../../d4/d0/struct__CONSOLE__FREE__MSG.html#o0">ConsoleHandle</a>);
01621 
01622     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/srvinit_8c.html#a37">RemoveConsole</a>(ProcessData,
01623             <a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>(),
01624             <a class="code" href="../../d1/d7/server_8h.html#a80">CONSOLE_CLIENTPROCESSID</a>());
01625 
01626     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01627         <a class="code" href="../../d1/d7/server_8h.html#a87">CONSOLE_SETCONSOLEAPP</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01628     }
01629 
01630     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01631     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
01632 }
01633 
01634 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01635"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a44">01635</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a44">MyRegOpenKey</a>(
01636     IN HANDLE hKey,
01637     IN LPWSTR lpSubKey,
01638     OUT PHANDLE phResult
01639     )
01640 {
01641     OBJECT_ATTRIBUTES   Obja;
01642     UNICODE_STRING      SubKey;
01643 
01644     <span class="comment">//</span>
01645     <span class="comment">// Convert the subkey to a counted Unicode string.</span>
01646     <span class="comment">//</span>
01647 
01648     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;SubKey, lpSubKey );
01649 
01650     <span class="comment">//</span>
01651     <span class="comment">// Initialize the OBJECT_ATTRIBUTES structure and open the key.</span>
01652     <span class="comment">//</span>
01653 
01654     InitializeObjectAttributes(
01655         &amp;Obja,
01656         &amp;SubKey,
01657         OBJ_CASE_INSENSITIVE,
01658         hKey,
01659         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01660         );
01661 
01662     <span class="keywordflow">return</span> <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(
01663               phResult,
01664               KEY_READ,
01665               &amp;Obja
01666               );
01667 }
01668 
01669 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01670"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a41">01670</a> <a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(
01671     IN HANDLE hKey,
01672     IN LPWSTR lpValueName,
01673     IN DWORD dwValueLength,
01674     OUT LPBYTE lpData
01675     )
01676 {
01677     UNICODE_STRING <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
01678     ULONG BufferLength;
01679     ULONG ResultLength;
01680     PKEY_VALUE_PARTIAL_INFORMATION KeyValueInformation;
01681     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01682 
01683     <span class="comment">//</span>
01684     <span class="comment">// Convert the subkey to a counted Unicode string.</span>
01685     <span class="comment">//</span>
01686 
01687     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>, lpValueName );
01688 
01689     BufferLength = FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION, Data) + dwValueLength;
01690     KeyValueInformation = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),BufferLength);
01691     <span class="keywordflow">if</span> (KeyValueInformation == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01692         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01693 
01694     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
01695                 hKey,
01696                 &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
01697                 KeyValuePartialInformation,
01698                 KeyValueInformation,
01699                 BufferLength,
01700                 &amp;ResultLength
01701                 );
01702     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01703         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeyValueInformation-&gt;DataLength &lt;= dwValueLength);
01704         RtlCopyMemory(lpData,
01705             KeyValueInformation-&gt;Data,
01706             KeyValueInformation-&gt;DataLength);
01707         <span class="keywordflow">if</span> (KeyValueInformation-&gt;Type == REG_SZ ||
01708             KeyValueInformation-&gt;Type == REG_MULTI_SZ
01709            ) {
01710             <span class="keywordflow">if</span> (KeyValueInformation-&gt;DataLength + <span class="keyword">sizeof</span>(WCHAR) &gt; dwValueLength) {
01711                 KeyValueInformation-&gt;DataLength -= <span class="keyword">sizeof</span>(WCHAR);
01712             }
01713             lpData[KeyValueInformation-&gt;DataLength++] = 0;
01714             lpData[KeyValueInformation-&gt;DataLength] = 0;
01715         }
01716     }
01717     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(KeyValueInformation);
01718     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01719 }
01720 
01721 <span class="preprocessor">#if defined(FE_SB)</span>
01722 <span class="preprocessor"></span><a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
01723 MyRegQueryValueEx(
01724     IN HANDLE hKey,
01725     IN LPWSTR lpValueName,
01726     IN DWORD dwValueLength,
01727     OUT LPBYTE lpData,
01728     OUT LPDWORD lpDataLength
01729     )
01730 {
01731     UNICODE_STRING <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
01732     ULONG BufferLength;
01733     ULONG ResultLength;
01734     PKEY_VALUE_PARTIAL_INFORMATION KeyValueInformation;
01735     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01736 
01737     <span class="comment">//</span>
01738     <span class="comment">// Convert the subkey to a counted Unicode string.</span>
01739     <span class="comment">//</span>
01740 
01741     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;ValueName, lpValueName );
01742 
01743     BufferLength = FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION, Data) + dwValueLength;
01744     KeyValueInformation = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TMP_TAG ),BufferLength);
01745     <span class="keywordflow">if</span> (KeyValueInformation == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01746         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01747 
01748     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
01749                 hKey,
01750                 &amp;ValueName,
01751                 KeyValuePartialInformation,
01752                 KeyValueInformation,
01753                 BufferLength,
01754                 &amp;ResultLength
01755                 );
01756     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01757         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeyValueInformation-&gt;DataLength &lt;= dwValueLength);
01758         RtlCopyMemory(lpData,
01759             KeyValueInformation-&gt;Data,
01760             KeyValueInformation-&gt;DataLength);
01761         <span class="keywordflow">if</span> (lpDataLength)
01762         {
01763             *lpDataLength = KeyValueInformation-&gt;DataLength;
01764         }
01765     }
01766     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(KeyValueInformation);
01767     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01768 }
01769 
01770 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
01771 MyRegEnumValue(
01772     IN HANDLE hKey,
01773     IN DWORD dwIndex,
01774     OUT DWORD dwValueLength,
01775     OUT LPWSTR lpValueName,
01776     OUT DWORD dwDataLength,
01777     OUT LPBYTE lpData
01778     )
01779 {
01780     ULONG BufferLength;
01781     ULONG ResultLength;
01782     PKEY_VALUE_FULL_INFORMATION KeyValueInformation;
01783     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01784 
01785     <span class="comment">//</span>
01786     <span class="comment">// Convert the subkey to a counted Unicode string.</span>
01787     <span class="comment">//</span>
01788 
01789     BufferLength = <span class="keyword">sizeof</span>(KEY_VALUE_FULL_INFORMATION) + dwValueLength + dwDataLength;
01790     KeyValueInformation = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TMP_TAG ),BufferLength);
01791     <span class="keywordflow">if</span> (KeyValueInformation == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01792         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01793 
01794     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a18">NtEnumerateValueKey</a>(
01795                 hKey,
01796                 dwIndex,
01797                 KeyValueFullInformation,
01798                 KeyValueInformation,
01799                 BufferLength,
01800                 &amp;ResultLength
01801                 );
01802     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01803         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeyValueInformation-&gt;NameLength &lt;= dwValueLength);
01804         RtlMoveMemory(lpValueName,
01805                       KeyValueInformation-&gt;Name,
01806                       KeyValueInformation-&gt;NameLength);
01807         lpValueName[ KeyValueInformation-&gt;NameLength &gt;&gt; 1 ] = UNICODE_NULL;
01808 
01809 
01810         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeyValueInformation-&gt;DataLength &lt;= dwDataLength);
01811         RtlMoveMemory(lpData,
01812             (PBYTE)KeyValueInformation + KeyValueInformation-&gt;DataOffset,
01813             KeyValueInformation-&gt;DataLength);
01814         <span class="keywordflow">if</span> (KeyValueInformation-&gt;Type == REG_SZ) {
01815             <span class="keywordflow">if</span> (KeyValueInformation-&gt;DataLength + <span class="keyword">sizeof</span>(WCHAR) &gt; dwDataLength) {
01816                 KeyValueInformation-&gt;DataLength -= <span class="keyword">sizeof</span>(WCHAR);
01817             }
01818             lpData[KeyValueInformation-&gt;DataLength++] = 0;
01819             lpData[KeyValueInformation-&gt;DataLength] = 0;
01820         }
01821     }
01822     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(KeyValueInformation);
01823     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01824 }
01825 <span class="preprocessor">#endif</span>
01826 <span class="preprocessor"></span>
<a name="l01827"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a0">01827</a> <span class="preprocessor">#define SYSTEM_ROOT         (L"%SystemRoot%")</span>
<a name="l01828"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a1">01828</a> <span class="preprocessor"></span><span class="preprocessor">#define SYSTEM_ROOT_LENGTH  (sizeof(SYSTEM_ROOT) - sizeof(WCHAR))</span>
01829 <span class="preprocessor"></span>
01830 LPWSTR
<a name="l01831"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a42">01831</a> <a class="code" href="../../d0/d5/srvinit_8c.html#a42">TranslateConsoleTitle</a>(
01832     LPWSTR ConsoleTitle,
01833     PUSHORT pcbTranslatedTitle,
01834     BOOL Unexpand,
01835     BOOL Substitute
01836     )
01837 <span class="comment">/*++</span>
01838 <span class="comment"></span>
01839 <span class="comment">Routine Description:</span>
01840 <span class="comment"></span>
01841 <span class="comment">    This routine translates path characters into '_' characters because</span>
01842 <span class="comment">    the NT registry apis do not allow the creation of keys with</span>
01843 <span class="comment">    names that contain path characters. It also converts absolute paths</span>
01844 <span class="comment">    into %SystemRoot% relative ones. As an example, if both behaviors were</span>
01845 <span class="comment">    specified it would convert a title like C:\WINNT\System32\cmd.exe to</span>
01846 <span class="comment">    %SystemRoot%_System32_cmd.exe.</span>
01847 <span class="comment"></span>
01848 <span class="comment">Arguments:</span>
01849 <span class="comment"></span>
01850 <span class="comment">    ConsoleTitle - Pointer to string to translate.</span>
01851 <span class="comment"></span>
01852 <span class="comment">    pcbTranslatedTitle - On return, contains size of translated title.</span>
01853 <span class="comment"></span>
01854 <span class="comment">    Unexpand - Convert absolute path to %SystemRoot% relative one.</span>
01855 <span class="comment"></span>
01856 <span class="comment">    Substitute - Replace '\' with '_' in path.</span>
01857 <span class="comment"></span>
01858 <span class="comment">Return Value:</span>
01859 <span class="comment"></span>
01860 <span class="comment">    Pointer to translated title or NULL.</span>
01861 <span class="comment"></span>
01862 <span class="comment">Note:</span>
01863 <span class="comment"></span>
01864 <span class="comment">    This routine allocates a buffer that must be freed.</span>
01865 <span class="comment"></span>
01866 <span class="comment">--*/</span>
01867 {
01868     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> cbConsoleTitle,i;
01869     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> cbSystemRoot;
01870     LPWSTR TranslatedConsoleTitle,Tmp;
01871 
01872     cbConsoleTitle = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((lstrlenW(ConsoleTitle) + 1) * <span class="keyword">sizeof</span>(WCHAR));
01873     cbSystemRoot = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(lstrlenW(USER_SHARED_DATA-&gt;NtSystemRoot) * <span class="keyword">sizeof</span>(WCHAR));
01874 
01875     <span class="keywordflow">if</span> (Unexpand &amp;&amp; !<a class="code" href="../../d8/d5/consrv_8h.html#a262">MyStringCompareW</a>(ConsoleTitle,
01876                                       USER_SHARED_DATA-&gt;NtSystemRoot,
01877                                       cbSystemRoot,
01878                                       <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
01879         cbConsoleTitle -= cbSystemRoot;
01880         (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ConsoleTitle += cbSystemRoot;
01881         cbSystemRoot = <a class="code" href="../../d0/d5/srvinit_8c.html#a1">SYSTEM_ROOT_LENGTH</a>;
01882     } <span class="keywordflow">else</span> {
01883         cbSystemRoot = 0;
01884     }
01885 
01886     Tmp = TranslatedConsoleTitle = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a13">TITLE_TAG</a> ),cbSystemRoot + cbConsoleTitle);
01887     <span class="keywordflow">if</span> (TranslatedConsoleTitle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01888         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01889     }
01890 
01891     RtlCopyMemory(TranslatedConsoleTitle, <a class="code" href="../../d0/d5/srvinit_8c.html#a0">SYSTEM_ROOT</a>, cbSystemRoot);
01892     (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)TranslatedConsoleTitle += cbSystemRoot;
01893 
01894     <span class="keywordflow">for</span> (i=0;i&lt;cbConsoleTitle;i+=<span class="keyword">sizeof</span>(WCHAR)) {
01895         <span class="keywordflow">if</span> (Substitute &amp;&amp; *ConsoleTitle == <span class="charliteral">'\\'</span>) {
01896             *TranslatedConsoleTitle++ = (WCHAR)<span class="charliteral">'_'</span>;
01897         } <span class="keywordflow">else</span> {
01898             *TranslatedConsoleTitle++ = *ConsoleTitle;
01899         }
01900         ConsoleTitle++;
01901     }
01902 
01903     <span class="keywordflow">if</span> (pcbTranslatedTitle) {
01904         *pcbTranslatedTitle = cbSystemRoot + cbConsoleTitle;
01905     }
01906 
01907     <span class="keywordflow">return</span> Tmp;
01908 }
01909 
01910 
01911 ULONG
<a name="l01912"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a24">01912</a> <a class="code" href="../../d0/d5/srvinit_8c.html#a24">ConsoleClientShutdown</a>(
01913     PCSR_PROCESS Process,
01914     ULONG Flags,
01915     BOOLEAN fFirstPass
01916     )
01917 {
01918     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
01919     <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData;
01920     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01921     HWND <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>;
01922     HANDLE TerminationEvent;
01923     HANDLE ConsoleHandle;
01924     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> WaitStatus;
01925     USERTHREAD_USEDESKTOPINFO utudi;
01926 
01927     <span class="comment">//</span>
01928     <span class="comment">// Find the console associated with this process</span>
01929     <span class="comment">//</span>
01930 
01931     ProcessData = <a class="code" href="../../d1/d7/server_8h.html#a82">CONSOLE_FROMPROCESSPERPROCESSDATA</a>(Process);
01932 
01933     <span class="comment">//</span>
01934     <span class="comment">// If this process is not a console app, stop right here unless</span>
01935     <span class="comment">// this is the second pass of shutdown, in which case we'll take</span>
01936     <span class="comment">// it.</span>
01937     <span class="comment">//</span>
01938 
01939     <span class="keywordflow">if</span> (!ProcessData || !<a class="code" href="../../d1/d7/server_8h.html#a86">CONSOLE_GETCONSOLEAPPFROMPROCESSDATA</a>(ProcessData)) {
01940 <span class="preprocessor">#if defined(FE_IME)</span>
01941 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (fFirstPass &amp;&amp;
01942             (ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o0">ConsoleHandle</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01943             (ProcessData-&gt;hDesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))
01944         {
01945             <span class="comment">//</span>
01946             <span class="comment">// If this process is a Console IME,</span>
01947             <span class="comment">// should unregister console IME on this desktop.</span>
01948             <span class="comment">//</span>
01949             RemoveConsoleIME(Process, HandleToUlong(Process-&gt;ClientId.UniqueThread));
01950         }
01951 <span class="preprocessor">#endif</span>
01952 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (fFirstPass) {
01953             <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a14">SHUTDOWN_UNKNOWN_PROCESS</a>;
01954         }
01955         <span class="keywordflow">return</span> <a class="code" href="../../d0/d5/srvinit_8c.html#a23">NonConsoleProcessShutdown</a>(Process, Flags);
01956     }
01957 
01958     <span class="comment">//</span>
01959     <span class="comment">// Find the console structure pointer.</span>
01960     <span class="comment">//</span>
01961 
01962     ConsoleHandle = <a class="code" href="../../d1/d7/server_8h.html#a91">CONSOLE_GETCONSOLEHANDLEFROMPROCESSDATA</a>(ProcessData);
01963     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a34">RevalidateConsole</a>(
01964             ConsoleHandle,
01965             &amp;Console);
01966 
01967     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01968         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a14">SHUTDOWN_UNKNOWN_PROCESS</a>;
01969         }
01970 
01971     <span class="comment">//</span>
01972     <span class="comment">// If this is the invisible WOW console, return UNKNOWN so USER</span>
01973     <span class="comment">// enumerates 16-bit gui apps.</span>
01974     <span class="comment">//</span>
01975 
01976     <span class="keywordflow">if</span> ((Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a8">CONSOLE_NO_WINDOW</a>) &amp;&amp;
01977         (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a18">CONSOLE_WOW_REGISTERED</a>)) {
01978         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01979         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a14">SHUTDOWN_UNKNOWN_PROCESS</a>;
01980         }
01981 
01982     <span class="comment">//</span>
01983     <span class="comment">// Sometimes the console structure is around even though the</span>
01984     <span class="comment">// hWnd has been NULLed out. In this case, go to non-console</span>
01985     <span class="comment">// process shutdown.</span>
01986     <span class="comment">//</span>
01987 
01988     <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> = Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o8">hWnd</a>;
01989     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || !<a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>)) {
01990         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01991         <span class="keywordflow">return</span> <a class="code" href="../../d0/d5/srvinit_8c.html#a23">NonConsoleProcessShutdown</a>(Process, Flags);
01992         }
01993 
01994     <span class="comment">//</span>
01995     <span class="comment">// Make a copy of the console termination event</span>
01996     <span class="comment">//</span>
01997 
01998     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(NtCurrentProcess(),
01999                                Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o68">TerminationEvent</a>,
02000                                NtCurrentProcess(),
02001                                &amp;TerminationEvent,
02002                                0,
02003                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
02004                                DUPLICATE_SAME_ACCESS
02005                                );
02006     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02007         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
02008         <span class="keywordflow">return</span> <a class="code" href="../../d0/d5/srvinit_8c.html#a23">NonConsoleProcessShutdown</a>(Process, Flags);
02009     }
02010 
02011     <span class="comment">//</span>
02012     <span class="comment">// Attach to the desktop.</span>
02013     <span class="comment">//</span>
02014 
02015     utudi.hThread = Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o75">InputThreadInfo</a>-&gt;<a class="code" href="../../d9/d2/struct__INPUT__THREAD__INFO.html#o0">ThreadHandle</a>;
02016     utudi.drdRestore.pdeskRestore = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02017     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(NtCurrentThread(),
02018                                         UserThreadUseDesktop,
02019                                         &amp;utudi,
02020                                         <span class="keyword">sizeof</span>(utudi));
02021 
02022     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
02023     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02024         <span class="keywordflow">return</span> <a class="code" href="../../d0/d5/srvinit_8c.html#a23">NonConsoleProcessShutdown</a>(Process, Flags);
02025     }
02026 
02027     <span class="comment">//</span>
02028     <span class="comment">// We're done looking at this process structure, so dereference it.</span>
02029     <span class="comment">//</span>
02030     CsrDereferenceProcess(Process);
02031 
02032     <span class="comment">//</span>
02033     <span class="comment">// Synchronously talk to this console.</span>
02034     <span class="comment">//</span>
02035 
02036     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d5/consrv_8h.html#a154">ShutdownConsole</a>(ConsoleHandle, Flags);
02037 
02038     <span class="comment">//</span>
02039     <span class="comment">// Detach from the desktop.</span>
02040     <span class="comment">//</span>
02041 
02042     utudi.hThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02043     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(NtCurrentThread(),
02044                                UserThreadUseDesktop,
02045                                &amp;utudi,
02046                                <span class="keyword">sizeof</span>(utudi));
02047 
02048     <span class="comment">//</span>
02049     <span class="comment">// If Status == STATUS_PROCESS_IS_TERMINATING, then we should wait</span>
02050     <span class="comment">// for the console to exit.</span>
02051     <span class="comment">//</span>
02052 
02053     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PROCESS_IS_TERMINATING) {
02054         WaitStatus = <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a18">InternalWaitCancel</a>(TerminationEvent, 500000);
02055         <span class="keywordflow">if</span> (WaitStatus == STATUS_WAIT_1) {
02056             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a15">SHUTDOWN_CANCEL</a>;
02057         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (WaitStatus != STATUS_TIMEOUT) {
02058             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a13">SHUTDOWN_KNOWN_PROCESS</a>;
02059         } <span class="keywordflow">else</span> {
02060 <span class="preprocessor">#if DBG</span>
02061 <span class="preprocessor"></span>            PLIST_ENTRY ListHead, ListNext;
02062             <a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">PCONSOLE_PROCESS_HANDLE</a> ProcessHandleRecord;
02063             PCSR_PROCESS Process;
02064 
02065             RIPMSG0(RIP_ERROR | RIP_THERESMORE, <span class="stringliteral">"********************************************"</span>);
02066             RIPMSG1(RIP_ERROR | RIP_THERESMORE, <span class="stringliteral">"Shutdown wait timed out on console %p"</span>, Console);
02067             RIPMSG1(RIP_ERROR | RIP_THERESMORE, <span class="stringliteral">"Reference count is %d"</span>, Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o1">RefCount</a>);
02068             RIPMSG0(RIP_ERROR | RIP_THERESMORE, <span class="stringliteral">"Dump these processes and see if they're hung"</span>);
02069             ListHead = &amp;Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o19">ProcessHandleList</a>;
02070             ListNext = ListHead-&gt;Flink;
02071             <span class="keywordflow">while</span> (ListNext != ListHead) {
02072                 ProcessHandleRecord = CONTAINING_RECORD(ListNext, <a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">CONSOLE_PROCESS_HANDLE</a>, ListLink);
02073                 Process = ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o2">Process</a>;
02074                 RIPMSG2(RIP_ERROR | RIP_THERESMORE, <span class="stringliteral">"CsrProcess = %p ProcessId = %x"</span>, Process, Process-&gt;ClientId.UniqueProcess);
02075                 ListNext = ListNext-&gt;Flink;
02076             }
02077             RIPMSG0(RIP_ERROR, <span class="stringliteral">"********************************************"</span>);
02078 <span class="preprocessor">#endif</span>
02079 <span class="preprocessor"></span>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a15">SHUTDOWN_CANCEL</a>;
02080         }
02081     }
02082     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(TerminationEvent);
02083 
02084     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02085 }
02086 
02087 ULONG
<a name="l02088"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a23">02088</a> <a class="code" href="../../d0/d5/srvinit_8c.html#a23">NonConsoleProcessShutdown</a>(
02089     PCSR_PROCESS Process,
02090     DWORD dwFlags
02091     )
02092 {
02093     <a class="code" href="../../d2/d4/struct__CONSOLE__PROCESS__TERMINATION__RECORD.html">CONSOLE_PROCESS_TERMINATION_RECORD</a> TerminateRecord;
02094     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> EventType;
02095     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> Success;
02096     HANDLE ProcessHandle;
02097 
02098     Success = DuplicateHandle(NtCurrentProcess(),
02099             Process-&gt;ProcessHandle,
02100             NtCurrentProcess(),
02101             &amp;ProcessHandle,
02102             0,
02103             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
02104             DUPLICATE_SAME_ACCESS);
02105 
02106     <span class="keywordflow">if</span> (!Success)
02107         ProcessHandle = Process-&gt;ProcessHandle;
02108 
02109     TerminateRecord.<a class="code" href="../../d2/d4/struct__CONSOLE__PROCESS__TERMINATION__RECORD.html#o0">ProcessHandle</a> = ProcessHandle;
02110     TerminateRecord.<a class="code" href="../../d2/d4/struct__CONSOLE__PROCESS__TERMINATION__RECORD.html#o1">TerminateCount</a> = 0;
02111     TerminateRecord.<a class="code" href="../../d2/d4/struct__CONSOLE__PROCESS__TERMINATION__RECORD.html#o3">CtrlRoutine</a> = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a10">CtrlRoutine</a>;
02112 
02113     CsrDereferenceProcess(Process);
02114 
02115     EventType = CTRL_LOGOFF_EVENT;
02116     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; EWX_SHUTDOWN)
02117         EventType = CTRL_SHUTDOWN_EVENT;
02118 
02119     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a52">CreateCtrlThread</a>(&amp;TerminateRecord,
02120             1,
02121             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02122             EventType,
02123             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02124 
02125     <span class="keywordflow">if</span> (Success)
02126         CloseHandle(ProcessHandle);
02127 
02128     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a13">SHUTDOWN_KNOWN_PROCESS</a>;
02129 }
02130 
02131 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02132"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a42">02132</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a42">InitializeConsoleAttributes</a>( VOID )
02133 
02134 <span class="comment">/*++</span>
02135 <span class="comment"></span>
02136 <span class="comment">Routine Description:</span>
02137 <span class="comment"></span>
02138 <span class="comment">    This routine initializes default attributes from the current</span>
02139 <span class="comment">    user's registry values. It gets called during logon/logoff.</span>
02140 <span class="comment"></span>
02141 <span class="comment">Arguments:</span>
02142 <span class="comment"></span>
02143 <span class="comment">    none</span>
02144 <span class="comment"></span>
02145 <span class="comment">Return Value:</span>
02146 <span class="comment"></span>
02147 <span class="comment">    none</span>
02148 <span class="comment"></span>
02149 <span class="comment">--*/</span>
02150 
02151 {
02152     <span class="comment">//</span>
02153     <span class="comment">// Store default values in structure and mark it</span>
02154     <span class="comment">// as invalid (by resetting LastWriteTime).</span>
02155     <span class="comment">//</span>
02156 
02157     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o12">ScreenFill</a>.Attributes = 0x07;            <span class="comment">// white on black</span>
02158     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o12">ScreenFill</a>.Char.UnicodeChar = (WCHAR)<span class="charliteral">' '</span>;
02159     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o13">PopupFill</a>.Attributes = 0xf5;             <span class="comment">// purple on white</span>
02160     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o13">PopupFill</a>.Char.UnicodeChar = (WCHAR)<span class="charliteral">' '</span>;
02161     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o10">InsertMode</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02162     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o9">QuickEdit</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02163     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o11">AutoPosition</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02164     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o8">FullScreen</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02165     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o0">ScreenBufferSize</a>.X = 80;
02166     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o0">ScreenBufferSize</a>.Y = 25;
02167     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o1">WindowSize</a>.X = 80;
02168     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o1">WindowSize</a>.Y = 25;
02169     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o2">WindowOrigin</a>.X = 0;
02170     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o2">WindowOrigin</a>.Y = 0;
02171     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o3">FontSize</a>.X = 0;
02172     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o3">FontSize</a>.Y = 0;
02173     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o4">FontFamily</a> = 0;
02174     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o5">FontWeight</a> = 0;
02175     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o6">FaceName</a>[0] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
02176     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o7">CursorSize</a> = <a class="code" href="../../d7/d2/output_8h.html#a10">CURSOR_SMALL_SIZE</a>;
02177     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o14">HistoryBufferSize</a> = <a class="code" href="../../d4/d1/cmdline_8h.html#a6">DEFAULT_NUMBER_OF_COMMANDS</a>;
02178     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o15">NumberOfHistoryBuffers</a> = <a class="code" href="../../d4/d1/cmdline_8h.html#a7">DEFAULT_NUMBER_OF_BUFFERS</a>;
02179     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o16">HistoryNoDup</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02180     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[ 0] = RGB(0,   0,   0   );
02181     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[ 1] = RGB(0,   0,   0x80);
02182     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[ 2] = RGB(0,   0x80,0   );
02183     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[ 3] = RGB(0,   0x80,0x80);
02184     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[ 4] = RGB(0x80,0,   0   );
02185     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[ 5] = RGB(0x80,0,   0x80);
02186     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[ 6] = RGB(0x80,0x80,0   );
02187     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[ 7] = RGB(0xC0,0xC0,0xC0);
02188     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[ 8] = RGB(0x80,0x80,0x80);
02189     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[ 9] = RGB(0,   0,   0xFF);
02190     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[10] = RGB(0,   0xFF,0   );
02191     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[11] = RGB(0,   0xFF,0xFF);
02192     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[12] = RGB(0xFF,0,   0   );
02193     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[13] = RGB(0xFF,0,   0xFF);
02194     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[14] = RGB(0xFF,0xFF,0   );
02195     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o17">ColorTable</a>[15] = RGB(0xFF,0xFF,0xFF);
02196 <span class="preprocessor">#if defined(FE_SB) // scotthsu</span>
02197 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.CodePage = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a>;
02198 <span class="preprocessor">#endif</span>
02199 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o18">LastWriteTime</a> = 0;
02200 
02201     <span class="comment">//</span>
02202     <span class="comment">// Get system metrics for this user</span>
02203     <span class="comment">//</span>
02204 
02205     <a class="code" href="../../d6/d2/output_8c.html#a38">InitializeSystemMetrics</a>();
02206 }
02207 
02208 
02209 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02210"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a44">02210</a> <a class="code" href="../../d0/d5/srvinit_8c.html#a44">GetRegistryValues</a>(
02211     IN LPWSTR ConsoleTitle,
02212     OUT <a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html">PCONSOLE_REGISTRY_INFO</a> RegInfo
02213     )
02214 
02215 <span class="comment">/*++</span>
02216 <span class="comment"></span>
02217 <span class="comment">Routine Description:</span>
02218 <span class="comment"></span>
02219 <span class="comment">    This routine reads in values from the registry and places them</span>
02220 <span class="comment">    in the supplied structure.</span>
02221 <span class="comment"></span>
02222 <span class="comment">Arguments:</span>
02223 <span class="comment"></span>
02224 <span class="comment">    ConsoleTitle - name of subkey to open</span>
02225 <span class="comment"></span>
02226 <span class="comment">    RegInfo - pointer to structure to receive information</span>
02227 <span class="comment"></span>
02228 <span class="comment">Return Value:</span>
02229 <span class="comment"></span>
02230 <span class="comment">    none</span>
02231 <span class="comment"></span>
02232 <span class="comment">--*/</span>
02233 
02234 {
02235     HANDLE hCurrentUserKey;
02236     HANDLE hConsoleKey;
02237     HANDLE hTitleKey;
02238     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02239     LPWSTR TranslatedConsoleTitle;
02240     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwValue;
02241     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> i;
02242     WCHAR awchFaceName[LF_FACESIZE];
02243     WCHAR awchBuffer[64];
02244     KEY_BASIC_INFORMATION KeyInfo;
02245     ULONG ResultLength;
02246 
02247     <span class="comment">//</span>
02248     <span class="comment">// Impersonate the client process</span>
02249     <span class="comment">//</span>
02250 
02251     <span class="keywordflow">if</span> (!CsrImpersonateClient(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02252         KdPrint((<span class="stringliteral">"CONSRV: GetRegistryValues Impersonate failed\n"</span>));
02253         <span class="keywordflow">return</span>;
02254     }
02255 
02256     <span class="comment">//</span>
02257     <span class="comment">// Open the current user registry key</span>
02258     <span class="comment">//</span>
02259 
02260     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a27">RtlOpenCurrentUser</a>(MAXIMUM_ALLOWED, &amp;hCurrentUserKey);
02261     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02262         CsrRevertToSelf();
02263         <span class="keywordflow">return</span>;
02264     }
02265 
02266     <span class="comment">//</span>
02267     <span class="comment">// Open the console registry key</span>
02268     <span class="comment">//</span>
02269 
02270     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2server_8c.html#a44">MyRegOpenKey</a>(hCurrentUserKey,
02271                           CONSOLE_REGISTRY_STRING,
02272                           &amp;hConsoleKey);
02273     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02274         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hCurrentUserKey);
02275         CsrRevertToSelf();
02276         <span class="keywordflow">return</span>;
02277     }
02278 
02279     <span class="comment">//</span>
02280     <span class="comment">// If we're not reading the default key, check if the default values</span>
02281     <span class="comment">// need to be updated</span>
02282     <span class="comment">//</span>
02283 
02284     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a24">NtQueryKey</a>(hConsoleKey,
02285                         KeyBasicInformation,
02286                         &amp;KeyInfo,
02287                         <span class="keyword">sizeof</span>(KeyInfo),
02288                         &amp;ResultLength);
02289     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02290         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o18">LastWriteTime</a> != KeyInfo.LastWriteTime.QuadPart) {
02291             <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o18">LastWriteTime</a> = KeyInfo.LastWriteTime.QuadPart;
02292             <span class="keywordflow">if</span> (RegInfo != &amp;<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>) {
02293                 <a class="code" href="../../d0/d5/srvinit_8c.html#a44">GetRegistryValues</a>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>, &amp;<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>);
02294                 *RegInfo = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>;
02295             }
02296         }
02297     }
02298 
02299     <span class="comment">//</span>
02300     <span class="comment">// Open the console title subkey</span>
02301     <span class="comment">//</span>
02302 
02303     TranslatedConsoleTitle = <a class="code" href="../../d0/d5/srvinit_8c.html#a42">TranslateConsoleTitle</a>(ConsoleTitle, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02304     <span class="keywordflow">if</span> (TranslatedConsoleTitle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02305         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hConsoleKey);
02306         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hCurrentUserKey);
02307         CsrRevertToSelf();
02308         <span class="keywordflow">return</span>;
02309     }
02310     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2server_8c.html#a44">MyRegOpenKey</a>(hConsoleKey,
02311                          TranslatedConsoleTitle,
02312                          &amp;hTitleKey);
02313     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TranslatedConsoleTitle);
02314     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02315         TranslatedConsoleTitle = <a class="code" href="../../d0/d5/srvinit_8c.html#a42">TranslateConsoleTitle</a>(ConsoleTitle, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02316         <span class="keywordflow">if</span> (TranslatedConsoleTitle) {
02317             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2server_8c.html#a44">MyRegOpenKey</a>(hConsoleKey,
02318                                  TranslatedConsoleTitle,
02319                                  &amp;hTitleKey);
02320             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TranslatedConsoleTitle);
02321         }
02322     }
02323     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02324         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hConsoleKey);
02325         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hCurrentUserKey);
02326         CsrRevertToSelf();
02327         <span class="keywordflow">return</span>;
02328     }
02329 
02330     <span class="comment">//</span>
02331     <span class="comment">// Initial screen fill</span>
02332     <span class="comment">//</span>
02333 
02334     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02335                        CONSOLE_REGISTRY_FILLATTR,
02336                        <span class="keyword">sizeof</span>(dwValue), (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;dwValue))) {
02337         RegInfo-&gt;ScreenFill.Attributes = (WORD)dwValue;
02338     }
02339 
02340     <span class="comment">//</span>
02341     <span class="comment">// Initial popup fill</span>
02342     <span class="comment">//</span>
02343 
02344     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02345                        CONSOLE_REGISTRY_POPUPATTR,
02346                        <span class="keyword">sizeof</span>(dwValue), (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;dwValue))) {
02347         RegInfo-&gt;PopupFill.Attributes = (WORD)dwValue;
02348     }
02349 
02350     <span class="comment">//</span>
02351     <span class="comment">// Initial insert mode</span>
02352     <span class="comment">//</span>
02353 
02354     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02355                        CONSOLE_REGISTRY_INSERTMODE,
02356                        <span class="keyword">sizeof</span>(dwValue), (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;dwValue))) {
02357         RegInfo-&gt;InsertMode = !!dwValue;
02358     }
02359 
02360     <span class="comment">//</span>
02361     <span class="comment">// Initial quick edit mode</span>
02362     <span class="comment">//</span>
02363 
02364     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02365                        CONSOLE_REGISTRY_QUICKEDIT,
02366                        <span class="keyword">sizeof</span>(dwValue), (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;dwValue))) {
02367         RegInfo-&gt;QuickEdit = !!dwValue;
02368     }
02369 
02370 <span class="preprocessor">#ifdef i386</span>
02371 <span class="preprocessor"></span>    <span class="comment">//</span>
02372     <span class="comment">// Initial full screen mode</span>
02373     <span class="comment">//</span>
02374 
02375     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02376                        CONSOLE_REGISTRY_FULLSCR,
02377                        <span class="keyword">sizeof</span>(dwValue), (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;dwValue))) {
02378         RegInfo-&gt;FullScreen = !!dwValue;
02379     }
02380 <span class="preprocessor">#endif</span>
02381 <span class="preprocessor"></span>
02382 <span class="preprocessor">#if defined(FE_SB) // scotthsu</span>
02383 <span class="preprocessor"></span>    <span class="comment">//</span>
02384     <span class="comment">// Code Page</span>
02385     <span class="comment">//</span>
02386 
02387     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02388                        CONSOLE_REGISTRY_CODEPAGE,
02389                        <span class="keyword">sizeof</span>(dwValue), (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;dwValue))) {
02390         RegInfo-&gt;CodePage = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)dwValue;
02391 
02392         <span class="comment">// If this routine specified default settings for console property,</span>
02393         <span class="comment">// then make sure code page value when Fae East environment.</span>
02394         <span class="comment">// If code page value does not the same to OEMCP and any FE's code page then</span>
02395         <span class="comment">// we are override code page value to OEMCP on default console property.</span>
02396         <span class="comment">// Because, Far East environment has limitation that doesn not switch to</span>
02397         <span class="comment">// another FE's code page by the SetConsoleCP/SetConsoleOutputCP.</span>
02398         <span class="comment">//</span>
02399         <span class="comment">// Compare of ConsoleTitle and L"" has limit to default property of console.</span>
02400         <span class="comment">// It means, this code doesn't care user defined property.</span>
02401         <span class="comment">// Content of user defined property has responsibility to themselves.</span>
02402 
02403         <span class="keywordflow">if</span> ( wcscmp(ConsoleTitle,<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>) == 0 &amp;&amp;
02404              <a class="code" href="../../d0/d3/dbcs_8h.html#a46">IsAvailableFarEastCodePage</a>( RegInfo-&gt;CodePage ) &amp;&amp;
02405              <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a> != RegInfo-&gt;CodePage ) {
02406             RegInfo-&gt;CodePage = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a>;
02407         }
02408     }
02409 <span class="preprocessor">#endif</span>
02410 <span class="preprocessor"></span>
02411     <span class="comment">//</span>
02412     <span class="comment">// Initial screen buffer size</span>
02413     <span class="comment">//</span>
02414 
02415     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02416                        CONSOLE_REGISTRY_BUFFERSIZE,
02417                        <span class="keyword">sizeof</span>(dwValue), (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;dwValue))) {
02418         RegInfo-&gt;ScreenBufferSize.X = LOWORD(dwValue);
02419         RegInfo-&gt;ScreenBufferSize.Y = HIWORD(dwValue);
02420         <span class="keywordflow">if</span> (RegInfo-&gt;ScreenBufferSize.X &lt;= 0)
02421             RegInfo-&gt;ScreenBufferSize.X = 1;
02422         <span class="keywordflow">if</span> (RegInfo-&gt;ScreenBufferSize.Y &lt;= 0)
02423             RegInfo-&gt;ScreenBufferSize.Y = 1;
02424     }
02425 
02426     <span class="comment">//</span>
02427     <span class="comment">// Initial window size</span>
02428     <span class="comment">//</span>
02429 
02430     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02431                        CONSOLE_REGISTRY_WINDOWSIZE,
02432                        <span class="keyword">sizeof</span>(dwValue), (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;dwValue))) {
02433         RegInfo-&gt;WindowSize.X = LOWORD(dwValue);
02434         RegInfo-&gt;WindowSize.Y = HIWORD(dwValue);
02435         <span class="keywordflow">if</span> (RegInfo-&gt;WindowSize.X &lt;= 0)
02436             RegInfo-&gt;WindowSize.X = 1;
02437         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (RegInfo-&gt;WindowSize.X &gt; RegInfo-&gt;ScreenBufferSize.X)
02438             RegInfo-&gt;WindowSize.X = RegInfo-&gt;ScreenBufferSize.X;
02439         <span class="keywordflow">if</span> (RegInfo-&gt;WindowSize.Y &lt;= 0)
02440             RegInfo-&gt;WindowSize.Y = 1;
02441         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (RegInfo-&gt;WindowSize.Y &gt; RegInfo-&gt;ScreenBufferSize.Y)
02442             RegInfo-&gt;WindowSize.Y = RegInfo-&gt;ScreenBufferSize.Y;
02443     }
02444 
02445     <span class="comment">//</span>
02446     <span class="comment">// Initial window position</span>
02447     <span class="comment">//</span>
02448 
02449     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02450                        CONSOLE_REGISTRY_WINDOWPOS,
02451                        <span class="keyword">sizeof</span>(dwValue), (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;dwValue))) {
02452         RegInfo-&gt;WindowOrigin.X = LOWORD(dwValue);
02453         RegInfo-&gt;WindowOrigin.Y = HIWORD(dwValue);
02454         RegInfo-&gt;AutoPosition = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02455     }
02456 
02457     <span class="comment">//</span>
02458     <span class="comment">// Initial font size</span>
02459     <span class="comment">//</span>
02460 
02461     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02462                        CONSOLE_REGISTRY_FONTSIZE,
02463                        <span class="keyword">sizeof</span>(dwValue), (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;dwValue))) {
02464         RegInfo-&gt;FontSize.X = LOWORD(dwValue);
02465         RegInfo-&gt;FontSize.Y = HIWORD(dwValue);
02466     }
02467 
02468     <span class="comment">//</span>
02469     <span class="comment">// Initial font family</span>
02470     <span class="comment">//</span>
02471 
02472     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02473                        CONSOLE_REGISTRY_FONTFAMILY,
02474                        <span class="keyword">sizeof</span>(dwValue), (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;dwValue))) {
02475         RegInfo-&gt;FontFamily = dwValue;
02476     }
02477 
02478     <span class="comment">//</span>
02479     <span class="comment">// Initial font weight</span>
02480     <span class="comment">//</span>
02481 
02482     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02483                        CONSOLE_REGISTRY_FONTWEIGHT,
02484                        <span class="keyword">sizeof</span>(dwValue), (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;dwValue))) {
02485         RegInfo-&gt;FontWeight = dwValue;
02486     }
02487 
02488     <span class="comment">//</span>
02489     <span class="comment">// Initial font face name</span>
02490     <span class="comment">//</span>
02491 
02492     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02493                        CONSOLE_REGISTRY_FACENAME,
02494                        <span class="keyword">sizeof</span>(awchFaceName), (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)awchFaceName))) {
02495         RtlCopyMemory(RegInfo-&gt;FaceName, awchFaceName, <span class="keyword">sizeof</span>(awchFaceName));
02496         RegInfo-&gt;FaceName[<a class="code" href="../../d2/d3/tnlsxlat_8c.html#a0">NELEM</a>(RegInfo-&gt;FaceName) - 1] = 0;
02497     }
02498 
02499     <span class="comment">//</span>
02500     <span class="comment">// Initial cursor size</span>
02501     <span class="comment">//</span>
02502 
02503     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02504                        CONSOLE_REGISTRY_CURSORSIZE,
02505                        <span class="keyword">sizeof</span>(dwValue), (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;dwValue))) {
02506         RegInfo-&gt;CursorSize = dwValue;
02507     }
02508 
02509     <span class="comment">//</span>
02510     <span class="comment">// Initial history buffer size</span>
02511     <span class="comment">//</span>
02512 
02513     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02514                        CONSOLE_REGISTRY_HISTORYSIZE,
02515                        <span class="keyword">sizeof</span>(dwValue), (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;dwValue))) {
02516         RegInfo-&gt;HistoryBufferSize = dwValue;
02517     }
02518 
02519     <span class="comment">//</span>
02520     <span class="comment">// Initial number of history buffers</span>
02521     <span class="comment">//</span>
02522 
02523     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02524                        CONSOLE_REGISTRY_HISTORYBUFS,
02525                        <span class="keyword">sizeof</span>(dwValue), (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;dwValue))) {
02526         RegInfo-&gt;NumberOfHistoryBuffers = dwValue;
02527     }
02528 
02529     <span class="comment">//</span>
02530     <span class="comment">// Initial history duplication mode</span>
02531     <span class="comment">//</span>
02532 
02533     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02534                        CONSOLE_REGISTRY_HISTORYNODUP,
02535                        <span class="keyword">sizeof</span>(dwValue), (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;dwValue))) {
02536         RegInfo-&gt;HistoryNoDup = dwValue;
02537     }
02538 
02539     <span class="keywordflow">for</span> (i=0; i&lt;16; i++) {
02540         wsprintf(awchBuffer, CONSOLE_REGISTRY_COLORTABLE, i);
02541         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey, awchBuffer,
02542                            <span class="keyword">sizeof</span>(dwValue), (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;dwValue))) {
02543             RegInfo-&gt;ColorTable[ i ] = dwValue;
02544         }
02545     }
02546 
02547     <span class="keywordflow">if</span> (RegInfo == &amp;<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>) {
02548         <span class="comment">//</span>
02549         <span class="comment">// If the common (default) setting has been changed,</span>
02550         <span class="comment">//</span>
02551 
02552         <span class="comment">//</span>
02553         <span class="comment">// Get registry for conime flag</span>
02554         <span class="comment">//</span>
02555         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hConsoleKey, CONSOLE_REGISTRY_LOAD_CONIME, <span class="keyword">sizeof</span> dwValue, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;dwValue))) {
02556             <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a26">gfLoadConIme</a> = (dwValue != 0);
02557         } <span class="keywordflow">else</span> {
02558             <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a26">gfLoadConIme</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02559         }
02560 
02561         <span class="comment">//</span>
02562         <span class="comment">// get extended edit mode and keys from registry.</span>
02563         <span class="comment">//</span>
02564         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hConsoleKey,
02565                 CONSOLE_REGISTRY_EXTENDEDEDITKEY,
02566                 <span class="keyword">sizeof</span> dwValue,
02567                 (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;dwValue)) &amp;&amp;
02568                 dwValue &lt;= 1) {
02569 
02570             ExtKeyDefBuf buf;
02571 
02572             <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a24">gExtendedEditKey</a> = dwValue;
02573 
02574             <span class="comment">//</span>
02575             <span class="comment">// Initialize Extended Edit keys</span>
02576             <span class="comment">//</span>
02577             <a class="code" href="../../d4/d1/cmdline_8h.html#a63">InitExtendedEditKeys</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02578 
02579             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hConsoleKey,
02580                         CONSOLE_REGISTRY_EXTENDEDEDITKEY_CUSTOM,
02581                         <span class="keyword">sizeof</span> buf,
02582                         (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;buf))) {
02583                 <a class="code" href="../../d4/d1/cmdline_8h.html#a63">InitExtendedEditKeys</a>(&amp;buf);
02584             }
02585 <span class="preprocessor">    #if DBG</span>
02586 <span class="preprocessor"></span>            <span class="keywordflow">else</span> {
02587                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Error reading ExtendedEditkeyCustom.\n"</span>);
02588             }
02589 <span class="preprocessor">    #endif</span>
02590 <span class="preprocessor"></span>        }
02591         <span class="keywordflow">else</span> {
02592             <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a24">gExtendedEditKey</a> = 0;
02593             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"Error reading ExtendedEditkey.\n"</span>));
02594         }
02595 
02596         <span class="comment">//</span>
02597         <span class="comment">// Word delimiters</span>
02598         <span class="comment">//</span>
02599         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a24">gExtendedEditKey</a>) {
02600             <span class="comment">// If extended edit key is given, provide extended word delimiters</span>
02601             <span class="comment">// by default.</span>
02602             memcpy((LPBYTE)<a class="code" href="../../d3/d1/server_2cmdline_8c.html#a14">gaWordDelimChars</a>, (LPBYTE)<a class="code" href="../../d3/d1/server_2cmdline_8c.html#a15">gaWordDelimCharsDefault</a>,
02603                     <span class="keyword">sizeof</span> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a14">gaWordDelimChars</a>[0] * <a class="code" href="../../d4/d1/cmdline_8h.html#a24">WORD_DELIM_MAX</a>);
02604         } <span class="keywordflow">else</span> {
02605             <span class="comment">// Otherwise, stick to the original word delimiter.</span>
02606             <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a14">gaWordDelimChars</a>[0] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
02607         }
02608 
02609         <span class="comment">// Read word delimiters from registry</span>
02610         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hConsoleKey,
02611                     CONSOLE_REGISTRY_WORD_DELIM,
02612                     <span class="keyword">sizeof</span> awchBuffer,
02613                     (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)awchBuffer))) {
02614             <span class="comment">// OK, copy it to the word delimiter array.</span>
02615             wcsncpy(<a class="code" href="../../d3/d1/server_2cmdline_8c.html#a14">gaWordDelimChars</a>, awchBuffer, <a class="code" href="../../d4/d1/cmdline_8h.html#a24">WORD_DELIM_MAX</a>);
02616             <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a14">gaWordDelimChars</a>[<a class="code" href="../../d4/d1/cmdline_8h.html#a24">WORD_DELIM_MAX</a> - 1] = 0;
02617         }
02618 
02619         <span class="comment">//</span>
02620         <span class="comment">// Read Trim Zero Heading flag</span>
02621         <span class="comment">//</span>
02622         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hTitleKey,
02623                            CONSOLE_REGISTRY_TRIMZEROHEADINGS,
02624                            <span class="keyword">sizeof</span>(dwValue), (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;dwValue))) {
02625             <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a25">gfTrimLeadingZeros</a> = dwValue;
02626         } <span class="keywordflow">else</span> {
02627             <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a25">gfTrimLeadingZeros</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02628         }
02629     }
02630 
02631 
02632     <span class="comment">//</span>
02633     <span class="comment">// Close the registry keys</span>
02634     <span class="comment">//</span>
02635 
02636     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hTitleKey);
02637     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hConsoleKey);
02638     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hCurrentUserKey);
02639     CsrRevertToSelf();
02640 }
02641 
02642 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02643"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a45">02643</a> <a class="code" href="../../d0/d5/srvinit_8c.html#a45">GetConsoleLangId</a>(
02644     IN UINT OutputCP,
02645     OUT LANGID* pLangId
02646     )
02647 {
02648     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02649 
02650     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a32">CONSOLE_IS_DBCS_ENABLED</a>()){
02651         <span class="keywordflow">if</span> (pLangId != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02652             <span class="keywordflow">switch</span> (OutputCP) {
02653                 <span class="keywordflow">case</span> 932:
02654                     *pLangId = MAKELANGID( LANG_JAPANESE, SUBLANG_DEFAULT );
02655                     <span class="keywordflow">break</span>;
02656                 <span class="keywordflow">case</span> 949:
02657                     *pLangId = MAKELANGID( LANG_KOREAN, SUBLANG_KOREAN );
02658                     <span class="keywordflow">break</span>;
02659                 <span class="keywordflow">case</span> 936:
02660                     *pLangId = MAKELANGID( LANG_CHINESE, SUBLANG_CHINESE_SIMPLIFIED );
02661                     <span class="keywordflow">break</span>;
02662                 <span class="keywordflow">case</span> 950:
02663                     *pLangId = MAKELANGID( LANG_CHINESE, SUBLANG_CHINESE_TRADITIONAL );
02664                     <span class="keywordflow">break</span>;
02665                 <span class="keywordflow">default</span>:
02666                     *pLangId = MAKELANGID( LANG_ENGLISH, SUBLANG_ENGLISH_US );
02667                     <span class="keywordflow">break</span>;
02668             }
02669         }
02670         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02671     }
02672     <span class="keywordflow">else</span> {
02673         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_SUPPORTED;
02674     }
02675 
02676     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02677 }
02678 
02679 ULONG
<a name="l02680"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a46">02680</a> <a class="code" href="../../d0/d5/srvinit_8c.html#a46">SrvGetConsoleLangId</a>(
02681     IN OUT PCSR_API_MSG m,
02682     IN OUT PCSR_REPLY_STATUS ReplyStatus
02683     )
02684 {
02685     <a class="code" href="../../d4/d3/struct__CONSOLE__LANGID__MSG.html">PCONSOLE_LANGID_MSG</a> a = (<a class="code" href="../../d4/d3/struct__CONSOLE__LANGID__MSG.html">PCONSOLE_LANGID_MSG</a>)&amp;m-&gt;u.ApiMessageData;
02686     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02687     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
02688 
02689     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d4/d3/struct__CONSOLE__LANGID__MSG.html#o0">ConsoleHandle</a>,
02690                          &amp;Console
02691                         );
02692     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02693         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02694     }
02695     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/srvinit_8c.html#a45">GetConsoleLangId</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o62">OutputCP</a>, &amp;a-&gt;<a class="code" href="../../d4/d3/struct__CONSOLE__LANGID__MSG.html#o1">LangId</a>);
02696 
02697     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
02698     <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02699     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
02700 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:51 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
