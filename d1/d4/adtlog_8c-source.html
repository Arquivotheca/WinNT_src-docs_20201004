<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: adtlog.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>adtlog.c</h1><a href="../../d0/d5/adtlog_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    adtlog.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Auditing - Audit Record Queuing and Logging Routines</span>
00012 <span class="comment"></span>
00013 <span class="comment">    This file contains functions that construct Audit Records in self-</span>
00014 <span class="comment">    relative form from supplied information, enqueue/dequeue them and</span>
00015 <span class="comment">    write them to the log.</span>
00016 <span class="comment"></span>
00017 <span class="comment">Author:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Scott Birrell       (ScottBi)       November 8, 1991</span>
00020 <span class="comment"></span>
00021 <span class="comment">Environment:</span>
00022 <span class="comment"></span>
00023 <span class="comment">    Kernel Mode only</span>
00024 <span class="comment"></span>
00025 <span class="comment">Revision History:</span>
00026 <span class="comment"></span>
00027 <span class="comment">--*/</span>
00028 
00029 <span class="preprocessor">#include &lt;nt.h&gt;</span>
00030 <span class="preprocessor">#include &lt;<a class="code" href="../../d9/d8/ntos_8h.html">ntos.h</a>&gt;</span>
00031 <span class="preprocessor">#include &lt;zwapi.h&gt;</span>
00032 <span class="preprocessor">#include "<a class="code" href="../../d6/d6/sep_8h.html">sep.h</a>"</span>
00033 <span class="preprocessor">#include "sertlp.h"</span>
00034 <span class="preprocessor">#include "<a class="code" href="../../d7/d4/adt_8h.html">adt.h</a>"</span>
00035 <span class="preprocessor">#include "<a class="code" href="../../d1/d5/adtp_8h.html">adtp.h</a>"</span>
00036 <span class="preprocessor">#include "<a class="code" href="../../d1/d0/rmp_8h.html">rmp.h</a>"</span>
00037 
00038 
00039 
00040 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00041 <span class="preprocessor"></span>
00042 <span class="preprocessor">#pragma alloc_text(PAGE,SepAdtCopyToLsaSharedMemory)</span>
00043 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepAdtLogAuditRecord)</span>
00044 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepAdtMarshallAuditRecord)</span>
00045 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepAdtSetAuditLogInformation)</span>
00046 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepDequeueWorkItem)</span>
00047 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepQueueWorkItem)</span>
00048 <span class="preprocessor"></span>
00049 <span class="preprocessor">#endif</span>
00050 <span class="preprocessor"></span>
00051 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00052"></a><a class="code" href="../../d0/d5/adtlog_8c.html#a0">00052</a> <a class="code" href="../../d0/d5/adtlog_8c.html#a0">SepAdtLogAuditRecord</a>(
00053     IN PSE_ADT_PARAMETER_ARRAY AuditParameters
00054     )
00055 
00056 <span class="comment">/*++</span>
00057 <span class="comment"></span>
00058 <span class="comment">Routine Description:</span>
00059 <span class="comment"></span>
00060 <span class="comment">    This function manages the logging of Audit Records.  It provides the</span>
00061 <span class="comment">    single interface to the Audit Logging component from the Audit/Alarm</span>
00062 <span class="comment">    generation routines.  The function constructs an Audit Record in</span>
00063 <span class="comment">    self-relative format from the information provided and appends it to</span>
00064 <span class="comment">    the Audit Record Queue, a doubly-linked list of Audit Records awaiting</span>
00065 <span class="comment">    output to the Audit Log.  A dedicated thread reads this queue, writing</span>
00066 <span class="comment">    Audit Records to the Audit Log and removing them from the Audit Queue.</span>
00067 <span class="comment"></span>
00068 <span class="comment">Arguments:</span>
00069 <span class="comment"></span>
00070 <span class="comment">    AuditEventType - Specifies the type of the Audit Event described by</span>
00071 <span class="comment">        the audit information provided.</span>
00072 <span class="comment"></span>
00073 <span class="comment">    AuditInformation - Pointer to buffer containing captured auditing</span>
00074 <span class="comment">        information related to an Audit Event of type AuditEventType.</span>
00075 <span class="comment"></span>
00076 <span class="comment">Return Value:</span>
00077 <span class="comment"></span>
00078 <span class="comment">    STATUS_SUCCESS</span>
00079 <span class="comment">    STATUS_UNSUCCESSFUL - Audit record was not queued</span>
00080 <span class="comment">    STATUS_INSUFFICIENT_RESOURCES - unable to allocate heap</span>
00081 <span class="comment"></span>
00082 <span class="comment">--*/</span>
00083 
00084 {
00085     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00086     <a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html">PSEP_LSA_WORK_ITEM</a> AuditWorkItem;
00087 
00088     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00089 
00090     AuditWorkItem = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>( <a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html">SEP_LSA_WORK_ITEM</a> ), 'iAeS' );
00091 
00092     <span class="keywordflow">if</span> ( AuditWorkItem == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00093 
00094         <a class="code" href="../../d1/d5/adtp_8h.html#a31">SepAuditFailed</a>();
00095         <span class="keywordflow">return</span>;
00096     }
00097 
00098     AuditWorkItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o2">Tag</a> = <a class="code" href="../../d6/d6/sep_8h.html#a77a34">SepAuditRecord</a>;
00099     AuditWorkItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o6">CommandNumber</a> = LsapWriteAuditMessageCommand;
00100     AuditWorkItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o8">ReplyBuffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00101     AuditWorkItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o9">ReplyBufferLength</a> = 0;
00102     AuditWorkItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o10">CleanupFunction</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00103 
00104     <span class="comment">//</span>
00105     <span class="comment">// Build an Audit record in self-relative format from the supplied</span>
00106     <span class="comment">// Audit Information.</span>
00107     <span class="comment">//</span>
00108 
00109     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d5/adtp_8h.html#a18">SepAdtMarshallAuditRecord</a>(
00110                  AuditParameters,
00111                  (PSE_ADT_PARAMETER_ARRAY *) &amp;AuditWorkItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o5">CommandParams</a>.BaseAddress,
00112                  &amp;AuditWorkItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o1">CommandParamsMemoryType</a>
00113                  );
00114 
00115     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00116 
00117         <span class="comment">//</span>
00118         <span class="comment">// Extract the length of the Audit Record.  Store it as the length</span>
00119         <span class="comment">// of the Command Parameters buffer.</span>
00120         <span class="comment">//</span>
00121 
00122         AuditWorkItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o7">CommandParamsLength</a> =
00123             ((PSE_ADT_PARAMETER_ARRAY) AuditWorkItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o5">CommandParams</a>.BaseAddress)-&gt;Length;
00124 
00125         <span class="comment">//</span>
00126         <span class="comment">// If we're going to crash on a discarded audit, ignore the queue bounds</span>
00127         <span class="comment">// check and force the item onto the queue.</span>
00128         <span class="comment">//</span>
00129 
00130         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d6/sep_8h.html#a68">SepQueueWorkItem</a>( AuditWorkItem, (BOOLEAN)(<a class="code" href="../../d1/d5/adtp_8h.html#a12">SepCrashOnAuditFail</a> ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) )) {
00131 
00132             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( AuditWorkItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o5">CommandParams</a>.BaseAddress );
00133             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( AuditWorkItem );
00134 
00135             <span class="comment">//</span>
00136             <span class="comment">// We failed to put the record on the queue.  Take whatever action is</span>
00137             <span class="comment">// appropriate.</span>
00138             <span class="comment">//</span>
00139 
00140             <a class="code" href="../../d1/d5/adtp_8h.html#a31">SepAuditFailed</a>();
00141         }
00142 
00143     } <span class="keywordflow">else</span> {
00144 
00145         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( AuditWorkItem );
00146         <a class="code" href="../../d1/d5/adtp_8h.html#a31">SepAuditFailed</a>();
00147     }
00148 }
00149 
00150 
00151 
00152 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00153"></a><a class="code" href="../../d1/d5/adtp_8h.html#a31">00153</a> <a class="code" href="../../d1/d5/adtp_8h.html#a31">SepAuditFailed</a>(
00154     VOID
00155     )
00156 
00157 <span class="comment">/*++</span>
00158 <span class="comment"></span>
00159 <span class="comment">Routine Description:</span>
00160 <span class="comment"></span>
00161 <span class="comment">    Bugchecks the system due to a missed audit (optional requirement</span>
00162 <span class="comment">    for C2 compliance).</span>
00163 <span class="comment"></span>
00164 <span class="comment">Arguments:</span>
00165 <span class="comment"></span>
00166 <span class="comment">    None.</span>
00167 <span class="comment"></span>
00168 <span class="comment">Return Value:</span>
00169 <span class="comment"></span>
00170 <span class="comment">    None.</span>
00171 <span class="comment"></span>
00172 <span class="comment">--*/</span>
00173 
00174 {
00175     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00176     OBJECT_ATTRIBUTES Obja;
00177     HANDLE KeyHandle;
00178     UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
00179     UNICODE_STRING <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
00180     UCHAR NewValue;
00181 
00182     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<span class="keyword">sizeof</span>(UCHAR) == <span class="keyword">sizeof</span>(BOOLEAN));
00183 
00184     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d5/adtp_8h.html#a12">SepCrashOnAuditFail</a>) {
00185         <span class="keywordflow">return</span>;
00186     }
00187 
00188     <span class="comment">//</span>
00189     <span class="comment">// Turn off flag in the registry that controls crashing on audit failure</span>
00190     <span class="comment">//</span>
00191 
00192     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\Lsa"</span>);
00193 
00194     InitializeObjectAttributes( &amp;Obja,
00195                                 &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,
00196                                 OBJ_CASE_INSENSITIVE | 
00197                                     OBJ_KERNEL_HANDLE,
00198                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00199                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00200                                 );
00201     <span class="keywordflow">do</span> {
00202 
00203         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwOpenKey(
00204                      &amp;KeyHandle,
00205                      KEY_SET_VALUE,
00206                      &amp;Obja
00207                      );
00208 
00209     } <span class="keywordflow">while</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INSUFFICIENT_RESOURCES) || (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NO_MEMORY));
00210 
00211     <span class="comment">//</span>
00212     <span class="comment">// If the LSA key isn't there, he's got big problems.  But don't crash.</span>
00213     <span class="comment">//</span>
00214 
00215     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_OBJECT_NAME_NOT_FOUND) {
00216         <a class="code" href="../../d1/d5/adtp_8h.html#a12">SepCrashOnAuditFail</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00217         <span class="keywordflow">return</span>;
00218     }
00219 
00220     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00221         <span class="keywordflow">goto</span> bugcheck;
00222     }
00223 
00224     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>, CRASH_ON_AUDIT_FAIL_VALUE );
00225 
00226     NewValue = LSAP_ALLOW_ADIMIN_LOGONS_ONLY;
00227 
00228     <span class="keywordflow">do</span> {
00229 
00230         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwSetValueKey( KeyHandle,
00231                                 &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00232                                 0,
00233                                 REG_NONE,
00234                                 &amp;NewValue,
00235                                 <span class="keyword">sizeof</span>(UCHAR)
00236                                 );
00237 
00238     } <span class="keywordflow">while</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INSUFFICIENT_RESOURCES) || (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NO_MEMORY));
00239     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00240 
00241     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00242         <span class="keywordflow">goto</span> bugcheck;
00243     }
00244 
00245     <span class="keywordflow">do</span> {
00246 
00247         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwFlushKey( KeyHandle );
00248 
00249     } <span class="keywordflow">while</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INSUFFICIENT_RESOURCES) || (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NO_MEMORY));
00250     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00251 
00252     <span class="comment">//</span>
00253     <span class="comment">// go boom.</span>
00254     <span class="comment">//</span>
00255 
00256 bugcheck:
00257 
00258     <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(AUDIT_FAILURE);
00259 }
00260 
00261 
00262 
00263 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00264"></a><a class="code" href="../../d1/d5/adtp_8h.html#a18">00264</a> <a class="code" href="../../d1/d5/adtp_8h.html#a18">SepAdtMarshallAuditRecord</a>(
00265     IN PSE_ADT_PARAMETER_ARRAY AuditParameters,
00266     OUT PSE_ADT_PARAMETER_ARRAY *MarshalledAuditParameters,
00267     OUT PSEP_RM_LSA_MEMORY_TYPE RecordMemoryType
00268     )
00269 
00270 <span class="comment">/*++</span>
00271 <span class="comment"></span>
00272 <span class="comment">Routine Description:</span>
00273 <span class="comment"></span>
00274 <span class="comment">    This routine will take an AuditParamters structure and create</span>
00275 <span class="comment">    a new AuditParameters structure that is suitable for sending</span>
00276 <span class="comment">    to LSA.  It will be in self-relative form and allocated as</span>
00277 <span class="comment">    a single chunk of memory.</span>
00278 <span class="comment"></span>
00279 <span class="comment">Arguments:</span>
00280 <span class="comment"></span>
00281 <span class="comment"></span>
00282 <span class="comment">    AuditParameters - A filled in set of AuditParameters to be marshalled.</span>
00283 <span class="comment"></span>
00284 <span class="comment">    MarshalledAuditParameters - Returns a pointer to a block of heap memory</span>
00285 <span class="comment">        containing the passed AuditParameters in self-relative form suitable</span>
00286 <span class="comment">        for passing to LSA.</span>
00287 <span class="comment"></span>
00288 <span class="comment"></span>
00289 <span class="comment">Return Value:</span>
00290 <span class="comment"></span>
00291 <span class="comment">    None.</span>
00292 <span class="comment"></span>
00293 <span class="comment">--*/</span>
00294 
00295 {
00296     ULONG i;
00297     ULONG TotalSize = <span class="keyword">sizeof</span>( SE_ADT_PARAMETER_ARRAY );
00298     PUNICODE_STRING TargetString;
00299     PCHAR Base;
00300     ULONG BaseIncr;
00301 
00302     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00303 
00304     <span class="comment">//</span>
00305     <span class="comment">// Calculate the total size required for the passed AuditParameters</span>
00306     <span class="comment">// block.  This calculation will probably be an overestimate of the</span>
00307     <span class="comment">// amount of space needed, because data smaller that 2 dwords will</span>
00308     <span class="comment">// be stored directly in the parameters structure, but their length</span>
00309     <span class="comment">// will be counted here anyway.  The overestimate can't be more than</span>
00310     <span class="comment">// 24 dwords, and will never even approach that amount, so it isn't</span>
00311     <span class="comment">// worth the time it would take to avoid it.</span>
00312     <span class="comment">//</span>
00313 
00314     <span class="keywordflow">for</span> (i=0; i&lt;AuditParameters-&gt;ParameterCount; i++) {
00315         TotalSize += (ULONG)LongAlignSize(AuditParameters-&gt;Parameters[i].Length);
00316     }
00317 
00318     <span class="comment">//</span>
00319     <span class="comment">// Allocate a big enough block of memory to hold everything.</span>
00320     <span class="comment">// If it fails, quietly abort, since there isn't much else we</span>
00321     <span class="comment">// can do.</span>
00322     <span class="comment">//</span>
00323 
00324     *MarshalledAuditParameters = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, TotalSize, 'pAeS' );
00325 
00326     <span class="keywordflow">if</span> (*MarshalledAuditParameters == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00327 
00328         *RecordMemoryType = SepRmNoMemory;
00329         <span class="keywordflow">return</span>(STATUS_INSUFFICIENT_RESOURCES);
00330     }
00331 
00332     *RecordMemoryType = SepRmPagedPoolMemory;
00333 
00334     RtlCopyMemory (
00335        *MarshalledAuditParameters,
00336        AuditParameters,
00337        <span class="keyword">sizeof</span>( SE_ADT_PARAMETER_ARRAY )
00338        );
00339 
00340    (*MarshalledAuditParameters)-&gt;Length = TotalSize;
00341    (*MarshalledAuditParameters)-&gt;Flags  = SE_ADT_PARAMETERS_SELF_RELATIVE;
00342 
00343     <span class="comment">//</span>
00344     <span class="comment">// Start walking down the list of parameters and marshall them</span>
00345     <span class="comment">// into the target buffer.</span>
00346     <span class="comment">//</span>
00347 
00348     Base = (PCHAR) ((PCHAR)(*MarshalledAuditParameters) + <span class="keyword">sizeof</span>( SE_ADT_PARAMETER_ARRAY ));
00349 
00350     <span class="keywordflow">for</span> (i=0; i&lt;AuditParameters-&gt;ParameterCount; i++) {
00351 
00352 
00353         <span class="keywordflow">switch</span> (AuditParameters-&gt;Parameters[i].Type) {
00354             <span class="keywordflow">case</span> SeAdtParmTypeNone:
00355             <span class="keywordflow">case</span> SeAdtParmTypeUlong:
00356             <span class="keywordflow">case</span> SeAdtParmTypeLogonId:
00357             <span class="keywordflow">case</span> SeAdtParmTypeNoLogonId:
00358             <span class="keywordflow">case</span> SeAdtParmTypeAccessMask:
00359                 {
00360                     <span class="comment">//</span>
00361                     <span class="comment">// Nothing to do for this</span>
00362                     <span class="comment">//</span>
00363 
00364                     <span class="keywordflow">break</span>;
00365 
00366                 }
00367             <span class="keywordflow">case</span> SeAdtParmTypeString:
00368             <span class="keywordflow">case</span> SeAdtParmTypeFileSpec:
00369                 {
00370                     PUNICODE_STRING <a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>;
00371                     <span class="comment">//</span>
00372                     <span class="comment">// We must copy the body of the unicode string</span>
00373                     <span class="comment">// and then copy the body of the string.  Pointers</span>
00374                     <span class="comment">// must be turned into offsets.</span>
00375 
00376                     TargetString = (PUNICODE_STRING)Base;
00377 
00378                     <a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a> = AuditParameters-&gt;Parameters[i].Address;
00379 
00380                     *TargetString = *<a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>;
00381 
00382                     <span class="comment">//</span>
00383                     <span class="comment">// Reset the data pointer in the output parameters to</span>
00384                     <span class="comment">// 'point' to the new string structure.</span>
00385                     <span class="comment">//</span>
00386 
00387                     (*MarshalledAuditParameters)-&gt;Parameters[i].Address = Base - (ULONG_PTR)(*MarshalledAuditParameters);
00388 
00389                     Base += <span class="keyword">sizeof</span>( UNICODE_STRING );
00390 
00391                     RtlCopyMemory( Base, <a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>-&gt;Buffer, <a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>-&gt;Length );
00392 
00393                     <span class="comment">//</span>
00394                     <span class="comment">// Make the string buffer in the target string point to where we</span>
00395                     <span class="comment">// just copied the data.</span>
00396                     <span class="comment">//</span>
00397 
00398                     TargetString-&gt;Buffer = (PWSTR)(Base - (ULONG_PTR)(*MarshalledAuditParameters));
00399 
00400                     BaseIncr = (ULONG)LongAlignSize(<a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>-&gt;Length);
00401 
00402                     Base += BaseIncr;
00403 
00404                     <span class="keywordflow">break</span>;
00405                 }
00406 
00407             <span class="comment">//</span>
00408             <span class="comment">// Handle types where we simply copy the buffer.</span>
00409             <span class="comment">//</span>
00410             <span class="keywordflow">case</span> SeAdtParmTypeSid:
00411             <span class="keywordflow">case</span> SeAdtParmTypePrivs:
00412             <span class="keywordflow">case</span> SeAdtParmTypeObjectTypes:
00413                 {
00414                     <span class="comment">//</span>
00415                     <span class="comment">// Copy the data into the output buffer</span>
00416                     <span class="comment">//</span>
00417 
00418                     RtlCopyMemory( Base,
00419                                    AuditParameters-&gt;Parameters[i].Address,
00420                                    AuditParameters-&gt;Parameters[i].Length );
00421 
00422                     <span class="comment">//</span>
00423                     <span class="comment">// Reset the 'address' of the data to be its offset in the</span>
00424                     <span class="comment">// buffer.</span>
00425                     <span class="comment">//</span>
00426 
00427                     (*MarshalledAuditParameters)-&gt;Parameters[i].Address = Base - (ULONG_PTR)(*MarshalledAuditParameters);
00428 
00429                     Base +=  (ULONG)LongAlignSize( AuditParameters-&gt;Parameters[i].Length );
00430 
00431 
00432                     <span class="keywordflow">break</span>;
00433                 }
00434             <span class="keywordflow">default</span>:
00435                 {
00436                     <span class="comment">//</span>
00437                     <span class="comment">// We got passed junk, complain.</span>
00438                     <span class="comment">//</span>
00439 
00440                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00441                     <span class="keywordflow">break</span>;
00442                 }
00443         }
00444     }
00445 
00446     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00447 }
00448 
00449 
00450 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00451"></a><a class="code" href="../../d1/d5/adtp_8h.html#a17">00451</a> <a class="code" href="../../d1/d5/adtp_8h.html#a17">SepAdtSetAuditLogInformation</a>(
00452     IN PPOLICY_AUDIT_LOG_INFO AuditLogInformation
00453     )
00454 
00455 <span class="comment">/*++</span>
00456 <span class="comment"></span>
00457 <span class="comment">Routine Description:</span>
00458 <span class="comment"></span>
00459 <span class="comment">    This function stores Audit Log Information in the Reference Monitor's</span>
00460 <span class="comment">    in-memory database.  This information contains parameters such as Audit</span>
00461 <span class="comment">    Log size etc.  It is the caller's responsibility to ensure that the</span>
00462 <span class="comment">    supplied information is valid.</span>
00463 <span class="comment"></span>
00464 <span class="comment">    NOTE:  After initialization, this function is only called by the LSA</span>
00465 <span class="comment">    via a Reference Monitor command.  This is a necessary restriction</span>
00466 <span class="comment">    because the Audit Log Information stored in the LSA Database must</span>
00467 <span class="comment">    remain in sync</span>
00468 <span class="comment"></span>
00469 <span class="comment">Arguments:</span>
00470 <span class="comment"></span>
00471 <span class="comment">    AuditLogInformation - Pointer to Audit Log Information structure.</span>
00472 <span class="comment"></span>
00473 <span class="comment">Return Value:</span>
00474 <span class="comment"></span>
00475 <span class="comment">    None.</span>
00476 <span class="comment"></span>
00477 <span class="comment">--*/</span>
00478 
00479 {
00480     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00481 
00482     <span class="comment">//</span>
00483     <span class="comment">// Acquire Reference Monitor Database write lock.</span>
00484     <span class="comment">//</span>
00485 
00486     <a class="code" href="../../d1/d0/rmp_8h.html#a3">SepRmAcquireDbWriteLock</a>();
00487 
00488     <span class="comment">//</span>
00489     <span class="comment">// Write the information</span>
00490     <span class="comment">//</span>
00491 
00492     <a class="code" href="../../d1/d5/adtp_8h.html#a3">SepAdtLogInformation</a> = *AuditLogInformation;
00493 
00494     <span class="comment">//</span>
00495     <span class="comment">// Release Reference Monitor Database write lock</span>
00496     <span class="comment">//</span>
00497 
00498     <a class="code" href="../../d1/d0/rmp_8h.html#a5">SepRmReleaseDbWriteLock</a>();
00499 }
00500 
00501 
00502 
00503 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00504"></a><a class="code" href="../../d0/d5/adtlog_8c.html#a4">00504</a> <a class="code" href="../../d0/d5/adtlog_8c.html#a4">SepAdtCopyToLsaSharedMemory</a>(
00505     IN HANDLE LsaProcessHandle,
00506     IN PVOID Buffer,
00507     IN ULONG BufferLength,
00508     OUT PVOID *LsaBufferAddress
00509     )
00510 
00511 <span class="comment">/*++</span>
00512 <span class="comment"></span>
00513 <span class="comment">Routine Description:</span>
00514 <span class="comment"></span>
00515 <span class="comment">    This function allocates memory shared with the LSA and optionally copies</span>
00516 <span class="comment">    a given buffer to it.</span>
00517 <span class="comment"></span>
00518 <span class="comment">Arguments:</span>
00519 <span class="comment"></span>
00520 <span class="comment">    LsaProcessHandle - Specifies a handle to the Lsa Process.</span>
00521 <span class="comment"></span>
00522 <span class="comment">    Buffer - Pointer to the buffer to be copied.</span>
00523 <span class="comment"></span>
00524 <span class="comment">    BufferLength - Length of buffer.</span>
00525 <span class="comment"></span>
00526 <span class="comment">    LsaBufferAddress - Receives the address of the buffer valid in the</span>
00527 <span class="comment">        Lsa process context.</span>
00528 <span class="comment"></span>
00529 <span class="comment">Return Value:</span>
00530 <span class="comment"></span>
00531 <span class="comment">    NTSTATUS - Standard Nt Result Code</span>
00532 <span class="comment"></span>
00533 <span class="comment">        Result codes returned by called routines.</span>
00534 <span class="comment">--*/</span>
00535 
00536 {
00537     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, SecondaryStatus;
00538     PVOID OutputLsaBufferAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00539     SIZE_T RegionSize = BufferLength;
00540 
00541     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00542 
00543     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory(
00544                  LsaProcessHandle,
00545                  &amp;OutputLsaBufferAddress,
00546                  0,
00547                  &amp;RegionSize,
00548                  MEM_COMMIT,
00549                  PAGE_READWRITE
00550                  );
00551 
00552     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00553 
00554         <span class="keywordflow">goto</span> CopyToLsaSharedMemoryError;
00555     }
00556 
00557     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwWriteVirtualMemory(
00558                  LsaProcessHandle,
00559                  OutputLsaBufferAddress,
00560                  <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00561                  BufferLength,
00562                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00563                  );
00564 
00565     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00566 
00567         <span class="keywordflow">goto</span> CopyToLsaSharedMemoryError;
00568     }
00569 
00570     *LsaBufferAddress = OutputLsaBufferAddress;
00571     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00572 
00573 CopyToLsaSharedMemoryError:
00574 
00575     <span class="comment">//</span>
00576     <span class="comment">// If we allocated memory, free it.</span>
00577     <span class="comment">//</span>
00578 
00579     <span class="keywordflow">if</span> (OutputLsaBufferAddress != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00580 
00581         RegionSize = 0;
00582 
00583         SecondaryStatus = ZwFreeVirtualMemory(
00584                               LsaProcessHandle,
00585                               &amp;OutputLsaBufferAddress,
00586                               &amp;RegionSize,
00587                               MEM_RELEASE
00588                               );
00589 
00590         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(SecondaryStatus));
00591 
00592         OutputLsaBufferAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00593     }
00594 
00595     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00596 }
00597 
00598 
00599 BOOLEAN
<a name="l00600"></a><a class="code" href="../../d6/d6/sep_8h.html#a68">00600</a> <a class="code" href="../../d6/d6/sep_8h.html#a68">SepQueueWorkItem</a>(
00601     IN <a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html">PSEP_LSA_WORK_ITEM</a> LsaWorkItem,
00602     IN BOOLEAN ForceQueue
00603     )
00604 
00605 <span class="comment">/*++</span>
00606 <span class="comment"></span>
00607 <span class="comment">Routine Description:</span>
00608 <span class="comment"></span>
00609 <span class="comment">    Puts the passed work item on the queue to be passed to LSA,</span>
00610 <span class="comment">    and returns the state of the queue upon arrival.</span>
00611 <span class="comment"></span>
00612 <span class="comment">Arguments:</span>
00613 <span class="comment"></span>
00614 <span class="comment">    LsaWorkItem - Pointer to the work item to be queued.</span>
00615 <span class="comment"></span>
00616 <span class="comment">    ForceQueue - Indicate that this item is not to be discarded</span>
00617 <span class="comment">        due because of a full queue.</span>
00618 <span class="comment"></span>
00619 <span class="comment">Return Value:</span>
00620 <span class="comment"></span>
00621 <span class="comment">    TRUE - The item was successfully queued.</span>
00622 <span class="comment"></span>
00623 <span class="comment">    FALSE - The item was not queued and must be discarded.</span>
00624 <span class="comment"></span>
00625 <span class="comment">--*/</span>
00626 
00627 {
00628     BOOLEAN rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00629     BOOLEAN StartExThread = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
00630 
00631     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00632 
00633 <span class="preprocessor">#if 0</span>
00634 <span class="preprocessor"></span>
00635   <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Queueing an audit\n"</span>);
00636 
00637 <span class="preprocessor">#endif</span>
00638 <span class="preprocessor"></span>
00639     <a class="code" href="../../d6/d6/sep_8h.html#a14">SepLockLsaQueue</a>();
00640 
00641     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d5/adtp_8h.html#a11">SepAdtDiscardingAudits</a> &amp;&amp; !ForceQueue) {
00642 
00643         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d5/adtp_8h.html#a10">SepAdtCurrentListLength</a> &lt; <a class="code" href="../../d1/d5/adtp_8h.html#a6">SepAdtMinListLength</a>) {
00644 
00645             <span class="comment">//</span>
00646             <span class="comment">// We need to generate an audit saying how many audits we've</span>
00647             <span class="comment">// discarded.</span>
00648             <span class="comment">//</span>
00649             <span class="comment">// Since we have the mutex protecting the Audit queue, we don't</span>
00650             <span class="comment">// have to worry about anyone coming along and logging an</span>
00651             <span class="comment">// audit.  But *we* can, since a mutex may be acquired recursively.</span>
00652             <span class="comment">//</span>
00653             <span class="comment">// Since we are so protected, turn off the SepAdtDiscardingAudits</span>
00654             <span class="comment">// flag here so that we don't come through this path again.</span>
00655             <span class="comment">//</span>
00656 
00657             <a class="code" href="../../d1/d5/adtp_8h.html#a11">SepAdtDiscardingAudits</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00658 
00659             <a class="code" href="../../d7/d6/sepaudit_8c.html#a22">SepAdtGenerateDiscardAudit</a>();
00660 <span class="preprocessor">#if 0</span>
00661 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Auditing resumed\n"</span>);
00662 <span class="preprocessor">#endif</span>
00663 <span class="preprocessor"></span>
00664             <span class="comment">//</span>
00665             <span class="comment">// We must assume that that worked, so clear the discard count.</span>
00666             <span class="comment">//</span>
00667 
00668             <a class="code" href="../../d1/d5/adtp_8h.html#a9">SepAdtCountEventsDiscarded</a> = 0;
00669 
00670             <span class="comment">//</span>
00671             <span class="comment">// Our 'audits discarded' audit is now on the queue,</span>
00672             <span class="comment">// continue logging the one we started with.</span>
00673             <span class="comment">//</span>
00674 
00675         } <span class="keywordflow">else</span> {
00676 
00677             <span class="comment">//</span>
00678             <span class="comment">// We are not yet below our low water mark.  Toss</span>
00679             <span class="comment">// this audit and increment the discard count.</span>
00680             <span class="comment">//</span>
00681 
00682             <a class="code" href="../../d1/d5/adtp_8h.html#a9">SepAdtCountEventsDiscarded</a>++;
00683             rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00684             <span class="keywordflow">goto</span> Exit;
00685         }
00686     }
00687 
00688     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d5/adtp_8h.html#a10">SepAdtCurrentListLength</a> &lt; <a class="code" href="../../d1/d5/adtp_8h.html#a5">SepAdtMaxListLength</a> || ForceQueue) {
00689 
00690         InsertTailList(&amp;<a class="code" href="../../d8/d5/seglobal_8c.html#a95">SepLsaQueue</a>, &amp;LsaWorkItem-&gt;List);
00691 
00692         <span class="keywordflow">if</span> (++<a class="code" href="../../d1/d5/adtp_8h.html#a10">SepAdtCurrentListLength</a> == 1) {
00693 
00694 <span class="preprocessor">#if 0</span>
00695 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Queueing a work item\n"</span>);
00696 <span class="preprocessor">#endif</span>
00697 <span class="preprocessor"></span>
00698             StartExThread = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
00699         }
00700 
00701     } <span class="keywordflow">else</span> {
00702 
00703         <span class="comment">//</span>
00704         <span class="comment">// There is no room for this audit on the queue,</span>
00705         <span class="comment">// so change our state to 'discarding' and tell</span>
00706         <span class="comment">// the caller to toss this audit.</span>
00707         <span class="comment">//</span>
00708 
00709         <a class="code" href="../../d1/d5/adtp_8h.html#a11">SepAdtDiscardingAudits</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00710 
00711 <span class="preprocessor">#if 0</span>
00712 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Starting to discard audits\n"</span>);
00713 <span class="preprocessor">#endif</span>
00714 <span class="preprocessor"></span>
00715         rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00716     }
00717 
00718 Exit:
00719 
00720     <a class="code" href="../../d6/d6/sep_8h.html#a15">SepUnlockLsaQueue</a>();
00721 
00722     <span class="keywordflow">if</span> ( StartExThread )
00723     {
00724         <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>( &amp;<a class="code" href="../../d8/d5/seglobal_8c.html#a97">SepExWorkItem</a>.<a class="code" href="../../d2/d2/struct__SEP__WORK__ITEM.html#o0">WorkItem</a>,
00725                               (<a class="code" href="../../d5/d8/ex_8h.html#a111">PWORKER_THREAD_ROUTINE</a>) <a class="code" href="../../d0/d0/rmmain_8c.html#a6">SepRmCallLsa</a>,
00726                               &amp;<a class="code" href="../../d8/d5/seglobal_8c.html#a97">SepExWorkItem</a>
00727                               );
00728 
00729         <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>( &amp;<a class="code" href="../../d8/d5/seglobal_8c.html#a97">SepExWorkItem</a>.<a class="code" href="../../d2/d2/struct__SEP__WORK__ITEM.html#o0">WorkItem</a>, <a class="code" href="../../d5/d8/ex_8h.html#a332a206">DelayedWorkQueue</a> );
00730     }
00731 
00732     <span class="keywordflow">return</span>( rc );
00733 }
00734 
00735 
00736 
00737 <a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html">PSEP_LSA_WORK_ITEM</a>
<a name="l00738"></a><a class="code" href="../../d0/d5/adtlog_8c.html#a6">00738</a> <a class="code" href="../../d0/d5/adtlog_8c.html#a6">SepDequeueWorkItem</a>(
00739     VOID
00740     )
00741 
00742 <span class="comment">/*++</span>
00743 <span class="comment"></span>
00744 <span class="comment">Routine Description:</span>
00745 <span class="comment"></span>
00746 <span class="comment">    Removes the top element of the SepLsaQueue and returns the</span>
00747 <span class="comment">    next element if there is one, NULL otherwise.</span>
00748 <span class="comment"></span>
00749 <span class="comment">Arguments:</span>
00750 <span class="comment"></span>
00751 <span class="comment">    None.</span>
00752 <span class="comment"></span>
00753 <span class="comment">Return Value:</span>
00754 <span class="comment"></span>
00755 <span class="comment">    A pointer to the next SEP_LSA_WORK_ITEM, or NULL.</span>
00756 <span class="comment"></span>
00757 <span class="comment">--*/</span>
00758 
00759 {
00760     <a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html">PSEP_LSA_WORK_ITEM</a> OldWorkQueueItem;
00761 
00762     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00763 
00764     <a class="code" href="../../d6/d6/sep_8h.html#a14">SepLockLsaQueue</a>();
00765 
00766     OldWorkQueueItem = (<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html">PSEP_LSA_WORK_ITEM</a>)RemoveHeadList(&amp;<a class="code" href="../../d8/d5/seglobal_8c.html#a95">SepLsaQueue</a>);
00767     OldWorkQueueItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o0">List</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00768     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( OldWorkQueueItem );
00769 
00770     <a class="code" href="../../d1/d5/adtp_8h.html#a10">SepAdtCurrentListLength</a>--;
00771 
00772 <span class="preprocessor">#if 0</span>
00773 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Removing item\n"</span>);
00774 <span class="preprocessor">#endif</span>
00775 <span class="preprocessor"></span>
00776     <span class="keywordflow">if</span> (IsListEmpty( &amp;<a class="code" href="../../d8/d5/seglobal_8c.html#a95">SepLsaQueue</a> )) {
00777 
00778         <a class="code" href="../../d6/d6/sep_8h.html#a15">SepUnlockLsaQueue</a>();
00779         <span class="keywordflow">return</span>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00780     }
00781 
00782     <span class="comment">//</span>
00783     <span class="comment">// We know there's something on the queue now, so we</span>
00784     <span class="comment">// can unlock it.</span>
00785     <span class="comment">//</span>
00786 
00787     <a class="code" href="../../d6/d6/sep_8h.html#a15">SepUnlockLsaQueue</a>();
00788     <span class="keywordflow">return</span>((<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html">PSEP_LSA_WORK_ITEM</a>)(&amp;<a class="code" href="../../d8/d5/seglobal_8c.html#a95">SepLsaQueue</a>)-&gt;Flink);
00789 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:13 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
