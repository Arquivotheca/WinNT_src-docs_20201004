<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: kdcomio.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>kdcomio.c</h1><a href="../../d0/d5/4_2kdcomio_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    kdcomio.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the I/O comunications for the portable kernel</span>
00012 <span class="comment">    debugger.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    David N. Cutler 27-July-1990</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include "<a class="code" href="../../d1/d7/4_2kdp_8h.html">kdp.h</a>"</span>
00023 
00024 ULONG
00025 <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a0">KdpComputeChecksum</a> (
00026     IN PUCHAR Buffer,
00027     IN ULONG Length
00028     );
00029 
00030 ULONG
00031 <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a1">KdpReceiveString</a> (
00032     OUT PCHAR Destination,
00033     IN ULONG Length
00034     );
00035 
00036 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00037 <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a2">KdpSendString</a> (
00038     IN PCHAR Source,
00039     IN ULONG Length
00040     );
00041 
00042 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00043 <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a3">KdpSendControlPacket</a> (
00044     IN USHORT PacketType,
00045     IN ULONG PacketId OPTIONAL
00046     );
00047 
00048 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEKD, KdpComputeChecksum)</span>
00050 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEKD, KdpReceivePacketLeader)</span>
00051 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEKD, KdpReceiveString)</span>
00052 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEKD, KdpSendString)</span>
00053 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEKD, KdpSendControlPacket)</span>
00054 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEKD, KdpReceivePacket)</span>
00055 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEKD, KdpSendPacket)</span>
00056 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00057 <span class="preprocessor"></span>
00058 
00059 ULONG
00060 <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a0">KdpComputeChecksum</a> (
00061     IN PUCHAR Buffer,
00062     IN ULONG Length
00063     )
00064 
00065 <span class="comment">/*++</span>
00066 <span class="comment"></span>
00067 <span class="comment">Routine Description:</span>
00068 <span class="comment"></span>
00069 <span class="comment">    This routine computes the checksum for the string passed in.</span>
00070 <span class="comment"></span>
00071 <span class="comment">Arguments:</span>
00072 <span class="comment"></span>
00073 <span class="comment">    Buffer - Supplies a pointer to the string.</span>
00074 <span class="comment"></span>
00075 <span class="comment">    Length - Supplies the length of the string.</span>
00076 <span class="comment"></span>
00077 <span class="comment">Return Value:</span>
00078 <span class="comment"></span>
00079 <span class="comment">    A ULONG is return as the checksum for the input string.</span>
00080 <span class="comment"></span>
00081 <span class="comment">--*/</span>
00082 
00083 {
00084 
00085     ULONG Checksum = 0;
00086 
00087     <span class="keywordflow">while</span> (Length &gt; 0) {
00088         Checksum = Checksum + (ULONG)*<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>++;
00089         Length--;
00090     }
00091     <span class="keywordflow">return</span> Checksum;
00092 }
00093 
00094 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>
<a name="l00095"></a><a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a4">00095</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a148">KdpReceivePacketLeader</a> (
00096     IN ULONG PacketType,
00097     OUT PULONG PacketLeader
00098     )
00099 
00100 <span class="comment">/*++</span>
00101 <span class="comment"></span>
00102 <span class="comment">Routine Description:</span>
00103 <span class="comment"></span>
00104 <span class="comment">    This routine waits for a packet header leader.</span>
00105 <span class="comment"></span>
00106 <span class="comment">Arguments:</span>
00107 <span class="comment"></span>
00108 <span class="comment">    PacketType - supplies the type of packet we are expecting.</span>
00109 <span class="comment"></span>
00110 <span class="comment">    PacketLeader - supplies a pointer to a ulong variable to receive</span>
00111 <span class="comment">                   packet leader bytes.</span>
00112 <span class="comment"></span>
00113 <span class="comment">Return Value:</span>
00114 <span class="comment"></span>
00115 <span class="comment">    KDP_PACKET_RESEND - if resend is required.</span>
00116 <span class="comment">    KDP_PAKCET_TIMEOUT - if timeout.</span>
00117 <span class="comment">    KDP_PACKET_RECEIVED - if packet received.</span>
00118 <span class="comment"></span>
00119 <span class="comment">--*/</span>
00120 
00121 {
00122 
00123     UCHAR Input, PreviousByte = 0;
00124     ULONG PacketId = 0;
00125     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00126     ULONG ReturnCode;
00127     BOOLEAN BreakinDetected = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00128 
00129     <span class="comment">//</span>
00130     <span class="comment">// NOTE - With all the interrupts being off, it is very hard</span>
00131     <span class="comment">// to implement the actual timeout code. (Maybe, by reading the CMOS.)</span>
00132     <span class="comment">// Here we use a loop count to wait about 3 seconds.  The CpGetByte</span>
00133     <span class="comment">// will return with error code = CP_GET_NODATA if it cannot find data</span>
00134     <span class="comment">// byte within 1 second. Kernel debugger's timeout period is 5 seconds.</span>
00135     <span class="comment">//</span>
00136 
00137     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
00138     <span class="keywordflow">do</span> {
00139         ReturnCode = <a class="code" href="../../d2/d7/hal_8h.html#a200">KdPortGetByte</a>(&amp;Input);
00140         <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d7/d3/kd_8h.html#a1">CP_GET_NODATA</a>) {
00141             <span class="keywordflow">if</span> (BreakinDetected) {
00142                 <a class="code" href="../../d8/d5/kddata_8c.html#a89">KdpControlCPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00143                 <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a11">KDP_PACKET_RESEND</a>;
00144             } <span class="keywordflow">else</span> {
00145                 <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a10">KDP_PACKET_TIMEOUT</a>;
00146             }
00147         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d7/d3/kd_8h.html#a2">CP_GET_ERROR</a>) {
00148             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
00149             <span class="keywordflow">continue</span>;
00150         } <span class="keywordflow">else</span> {                    <span class="comment">// if (ReturnCode == CP_GET_SUCCESS)</span>
00151             <span class="keywordflow">if</span> ( Input == PACKET_LEADER_BYTE ||
00152                  Input == CONTROL_PACKET_LEADER_BYTE ) {
00153                 <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> == 0 ) {
00154                     PreviousByte = Input;
00155                     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++;
00156                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Input == PreviousByte ) {
00157                     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++;
00158                 } <span class="keywordflow">else</span> {
00159                     PreviousByte = Input;
00160                     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 1;
00161                 }
00162             } <span class="keywordflow">else</span> {
00163 
00164                 <span class="comment">//</span>
00165                 <span class="comment">// If we detect breakin character, we need to verify it</span>
00166                 <span class="comment">// validity.  (It is possible that we missed a packet leader</span>
00167                 <span class="comment">// and the breakin character is simply a data byte in the</span>
00168                 <span class="comment">// packet.)</span>
00169                 <span class="comment">// Since kernel debugger send out breakin character ONLY</span>
00170                 <span class="comment">// when it is waiting for State Change packet.  The breakin</span>
00171                 <span class="comment">// character should not be followed by any other character</span>
00172                 <span class="comment">// except packet leader byte.</span>
00173                 <span class="comment">//</span>
00174 
00175                 <span class="keywordflow">if</span> ( Input == BREAKIN_PACKET_BYTE ) {
00176                     BreakinDetected = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00177                 } <span class="keywordflow">else</span> {
00178 
00179                     <span class="comment">//</span>
00180                     <span class="comment">// The following statement is ABSOLUTELY necessary.</span>
00181                     <span class="comment">//</span>
00182 
00183                     BreakinDetected = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00184                 }
00185                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
00186             }
00187         }
00188     } <span class="keywordflow">while</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; 4 );
00189 
00190     <span class="keywordflow">if</span> (BreakinDetected) {
00191         <a class="code" href="../../d8/d5/kddata_8c.html#a89">KdpControlCPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00192     }
00193 
00194     <span class="comment">//</span>
00195     <span class="comment">// return the packet leader and FALSE to indicate no resend is needed.</span>
00196     <span class="comment">//</span>
00197 
00198     <span class="keywordflow">if</span> ( Input == PACKET_LEADER_BYTE ) {
00199         *PacketLeader = PACKET_LEADER;
00200     } <span class="keywordflow">else</span> {
00201         *PacketLeader = CONTROL_PACKET_LEADER;
00202     }
00203 
00204     <a class="code" href="../../d7/d3/kd_8h.html#a12">KdDebuggerNotPresent</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00205     SharedUserData-&gt;KdDebuggerEnabled |= 0x00000002;
00206     <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a9">KDP_PACKET_RECEIVED</a>;
00207 }
00208 
00209 ULONG
00210 <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a1">KdpReceiveString</a> (
00211     OUT PCHAR Destination,
00212     IN ULONG Length
00213     )
00214 
00215 <span class="comment">/*++</span>
00216 <span class="comment"></span>
00217 <span class="comment">Routine Description:</span>
00218 <span class="comment"></span>
00219 <span class="comment">    This routine reads a string from the kernel debugger port.</span>
00220 <span class="comment"></span>
00221 <span class="comment">Arguments:</span>
00222 <span class="comment"></span>
00223 <span class="comment">    Destination - Supplies a pointer to the input string.</span>
00224 <span class="comment"></span>
00225 <span class="comment">    Length - Supplies the length of the string to be read.</span>
00226 <span class="comment"></span>
00227 <span class="comment">Return Value:</span>
00228 <span class="comment"></span>
00229 <span class="comment">    CP_GET_SUCCESS is returned if string is successfully read from the</span>
00230 <span class="comment">        kernel debugger line.</span>
00231 <span class="comment">    CP_GET_ERROR is returned if error encountered during reading.</span>
00232 <span class="comment">    CP_GET_NODATA is returned if timeout.</span>
00233 <span class="comment"></span>
00234 <span class="comment">--*/</span>
00235 
00236 {
00237 
00238     UCHAR Input;
00239     ULONG ReturnCode;
00240 
00241     <span class="comment">//</span>
00242     <span class="comment">// Read bytes until either a error is encountered or the entire string</span>
00243     <span class="comment">// has been read.</span>
00244     <span class="comment">//</span>
00245     <span class="keywordflow">while</span> (Length &gt; 0) {
00246         ReturnCode = <a class="code" href="../../d2/d7/hal_8h.html#a200">KdPortGetByte</a>(&amp;Input);
00247         <span class="keywordflow">if</span> (ReturnCode != <a class="code" href="../../d7/d3/kd_8h.html#a0">CP_GET_SUCCESS</a>) {
00248             <span class="keywordflow">return</span> ReturnCode;
00249         } <span class="keywordflow">else</span> {
00250             *Destination++ = Input;
00251             Length -= 1;
00252         }
00253     }
00254     <span class="keywordflow">return</span> <a class="code" href="../../d7/d3/kd_8h.html#a0">CP_GET_SUCCESS</a>;
00255 }
00256 
00257 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00258 <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a2">KdpSendString</a> (
00259     IN PCHAR Source,
00260     IN ULONG Length
00261     )
00262 
00263 <span class="comment">/*++</span>
00264 <span class="comment"></span>
00265 <span class="comment">Routine Description:</span>
00266 <span class="comment"></span>
00267 <span class="comment">    This routine writes a string to the kernel debugger port.</span>
00268 <span class="comment"></span>
00269 <span class="comment">Arguments:</span>
00270 <span class="comment"></span>
00271 <span class="comment">    Source - Supplies a pointer to the output string.</span>
00272 <span class="comment"></span>
00273 <span class="comment">    Length - Supplies the length of the string to be written.</span>
00274 <span class="comment"></span>
00275 <span class="comment">Return Value:</span>
00276 <span class="comment"></span>
00277 <span class="comment">    None.</span>
00278 <span class="comment"></span>
00279 <span class="comment">--*/</span>
00280 
00281 {
00282 
00283     UCHAR Output;
00284 
00285     <span class="comment">//</span>
00286     <span class="comment">// Write bytes to the kernel debugger port.</span>
00287     <span class="comment">//</span>
00288 
00289     <span class="keywordflow">while</span> (Length &gt; 0) {
00290         Output = *Source++;
00291         <a class="code" href="../../d2/d7/hal_8h.html#a202">KdPortPutByte</a>(Output);
00292         Length -= 1;
00293     }
00294     <span class="keywordflow">return</span>;
00295 }
00296 
00297 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00298 <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a3">KdpSendControlPacket</a> (
00299     IN USHORT PacketType,
00300     IN ULONG PacketId OPTIONAL
00301     )
00302 
00303 <span class="comment">/*++</span>
00304 <span class="comment"></span>
00305 <span class="comment">Routine Description:</span>
00306 <span class="comment"></span>
00307 <span class="comment">    This routine sends a control packet to the host machine that is running the</span>
00308 <span class="comment">    kernel debugger and waits for an ACK.</span>
00309 <span class="comment"></span>
00310 <span class="comment">Arguments:</span>
00311 <span class="comment"></span>
00312 <span class="comment">    PacketType - Supplies the type of packet to send.</span>
00313 <span class="comment"></span>
00314 <span class="comment">    PacketId - Supplies packet id, optionally.</span>
00315 <span class="comment"></span>
00316 <span class="comment">Return Value:</span>
00317 <span class="comment"></span>
00318 <span class="comment">    None.</span>
00319 <span class="comment"></span>
00320 <span class="comment">--*/</span>
00321 
00322 {
00323 
00324     KD_PACKET PacketHeader;
00325 
00326     <span class="comment">//</span>
00327     <span class="comment">// Initialize and send the packet header.</span>
00328     <span class="comment">//</span>
00329 
00330     PacketHeader.PacketLeader = CONTROL_PACKET_LEADER;
00331     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( (PVOID)(ULONG_PTR) PacketId )) {
00332         PacketHeader.PacketId = PacketId;
00333     }
00334     PacketHeader.ByteCount = 0;
00335     PacketHeader.Checksum = 0;
00336     PacketHeader.PacketType = PacketType;
00337     <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a2">KdpSendString</a>((PCHAR)&amp;PacketHeader, <span class="keyword">sizeof</span>(KD_PACKET));
00338 
00339     <span class="keywordflow">return</span>;
00340 }
00341 
00342 ULONG
<a name="l00343"></a><a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a5">00343</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a112">KdpReceivePacket</a> (
00344     IN ULONG PacketType,
00345     OUT PSTRING MessageHeader,
00346     OUT PSTRING MessageData,
00347     OUT PULONG DataLength
00348     )
00349 
00350 <span class="comment">/*++</span>
00351 <span class="comment"></span>
00352 <span class="comment">Routine Description:</span>
00353 <span class="comment"></span>
00354 <span class="comment">    This routine receives a packet from the host machine that is running</span>
00355 <span class="comment">    the kernel debugger UI.  This routine is ALWAYS called after packet being</span>
00356 <span class="comment">    sent by caller.  It first waits for ACK packet for the packet sent and</span>
00357 <span class="comment">    then waits for the packet desired.</span>
00358 <span class="comment"></span>
00359 <span class="comment">    N.B. If caller is KdPrintString, the parameter PacketType is</span>
00360 <span class="comment">       PACKET_TYPE_KD_ACKNOWLEDGE.  In this case, this routine will return</span>
00361 <span class="comment">       right after the ack packet is received.</span>
00362 <span class="comment"></span>
00363 <span class="comment">Arguments:</span>
00364 <span class="comment"></span>
00365 <span class="comment">    PacketType - Supplies the type of packet that is excepted.</span>
00366 <span class="comment"></span>
00367 <span class="comment">    MessageHeader - Supplies a pointer to a string descriptor for the input</span>
00368 <span class="comment">        message.</span>
00369 <span class="comment"></span>
00370 <span class="comment">    MessageData - Supplies a pointer to a string descriptor for the input data.</span>
00371 <span class="comment"></span>
00372 <span class="comment">    DataLength - Supplies pointer to ULONG to receive length of recv. data.</span>
00373 <span class="comment"></span>
00374 <span class="comment">Return Value:</span>
00375 <span class="comment"></span>
00376 <span class="comment">    KDP_PACKET_RESEND - if resend is required.</span>
00377 <span class="comment">    KDP_PAKCET_TIMEOUT - if timeout.</span>
00378 <span class="comment">    KDP_PACKET_RECEIVED - if packet received.</span>
00379 <span class="comment"></span>
00380 <span class="comment">--*/</span>
00381 
00382 {
00383 
00384     UCHAR Input;
00385     ULONG MessageLength;
00386     KD_PACKET PacketHeader;
00387     ULONG ReturnCode;
00388     ULONG Checksum;
00389 
00390 WaitForPacketLeader:
00391 
00392     <span class="comment">//</span>
00393     <span class="comment">// Read Packet Leader</span>
00394     <span class="comment">//</span>
00395 
00396     ReturnCode = <a class="code" href="../../d1/d7/4_2kdp_8h.html#a148">KdpReceivePacketLeader</a>(PacketType, &amp;PacketHeader.PacketLeader);
00397 
00398     <span class="comment">//</span>
00399     <span class="comment">// If we can successfully read packet leader, it has high possibility that</span>
00400     <span class="comment">// kernel debugger is alive.  So reset count.</span>
00401     <span class="comment">//</span>
00402 
00403     <span class="keywordflow">if</span> (ReturnCode != <a class="code" href="../../d0/d7/kdp_8h.html#a10">KDP_PACKET_TIMEOUT</a>) {
00404         <a class="code" href="../../d8/d5/kddata_8c.html#a88">KdpNumberRetries</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a87">KdpRetryCount</a>;
00405     }
00406     <span class="keywordflow">if</span> (ReturnCode != <a class="code" href="../../d0/d7/kdp_8h.html#a9">KDP_PACKET_RECEIVED</a>) {
00407         <span class="keywordflow">return</span> ReturnCode;
00408     }
00409 
00410     <span class="comment">//</span>
00411     <span class="comment">// Read packet type.</span>
00412     <span class="comment">//</span>
00413 
00414     ReturnCode = <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a1">KdpReceiveString</a>((PCHAR)&amp;PacketHeader.PacketType,
00415                                   <span class="keyword">sizeof</span>(PacketHeader.PacketType));
00416     <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d7/d3/kd_8h.html#a1">CP_GET_NODATA</a>) {
00417         <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a10">KDP_PACKET_TIMEOUT</a>;
00418     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d7/d3/kd_8h.html#a2">CP_GET_ERROR</a>) {
00419         <span class="keywordflow">if</span> (PacketHeader.PacketLeader == CONTROL_PACKET_LEADER) {
00420 
00421             <span class="comment">//</span>
00422             <span class="comment">// If read error and it is for a control packet, simply</span>
00423             <span class="comment">// preptend that we have not seen this packet.  Hopefully</span>
00424             <span class="comment">// we will receive the packet we desire which automatically acks</span>
00425             <span class="comment">// the packet we just sent.</span>
00426             <span class="comment">//</span>
00427 
00428             <span class="keywordflow">goto</span> WaitForPacketLeader;
00429         } <span class="keywordflow">else</span> {
00430 
00431             <span class="comment">//</span>
00432             <span class="comment">// if read error while reading data packet, we have to ask</span>
00433             <span class="comment">// kernel debugger to resend us the packet.</span>
00434             <span class="comment">//</span>
00435 
00436             <span class="keywordflow">goto</span> SendResendPacket;
00437         }
00438     }
00439 
00440     <span class="comment">//</span>
00441     <span class="comment">// if the packet we received is a resend request, we return true and</span>
00442     <span class="comment">// let caller resend the packet.</span>
00443     <span class="comment">//</span>
00444 
00445     <span class="keywordflow">if</span> ( PacketHeader.PacketLeader == CONTROL_PACKET_LEADER &amp;&amp;
00446          PacketHeader.PacketType == PACKET_TYPE_KD_RESEND ) {
00447         <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a11">KDP_PACKET_RESEND</a>;
00448     }
00449 
00450     <span class="comment">//</span>
00451     <span class="comment">// Read data length.</span>
00452     <span class="comment">//</span>
00453 
00454     ReturnCode = <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a1">KdpReceiveString</a>((PCHAR)&amp;PacketHeader.ByteCount,
00455                                   <span class="keyword">sizeof</span>(PacketHeader.ByteCount));
00456     <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d7/d3/kd_8h.html#a1">CP_GET_NODATA</a>) {
00457         <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a10">KDP_PACKET_TIMEOUT</a>;
00458     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d7/d3/kd_8h.html#a2">CP_GET_ERROR</a>) {
00459         <span class="keywordflow">if</span> (PacketHeader.PacketLeader == CONTROL_PACKET_LEADER) {
00460             <span class="keywordflow">goto</span> WaitForPacketLeader;
00461         } <span class="keywordflow">else</span> {
00462             <span class="keywordflow">goto</span> SendResendPacket;
00463         }
00464     }
00465 
00466     <span class="comment">//</span>
00467     <span class="comment">// Read Packet Id.</span>
00468     <span class="comment">//</span>
00469 
00470     ReturnCode = <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a1">KdpReceiveString</a>((PCHAR)&amp;PacketHeader.PacketId,
00471                                   <span class="keyword">sizeof</span>(PacketHeader.PacketId));
00472 
00473     <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d7/d3/kd_8h.html#a1">CP_GET_NODATA</a>) {
00474         <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a10">KDP_PACKET_TIMEOUT</a>;
00475     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d7/d3/kd_8h.html#a2">CP_GET_ERROR</a>) {
00476         <span class="keywordflow">if</span> (PacketHeader.PacketLeader == CONTROL_PACKET_LEADER) {
00477             <span class="keywordflow">goto</span> WaitForPacketLeader;
00478         } <span class="keywordflow">else</span> {
00479             <span class="keywordflow">goto</span> SendResendPacket;
00480         }
00481     }
00482 
00483     <span class="comment">//</span>
00484     <span class="comment">// Read packet checksum.</span>
00485     <span class="comment">//</span>
00486 
00487     ReturnCode = <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a1">KdpReceiveString</a>((PCHAR)&amp;PacketHeader.Checksum,
00488                                   <span class="keyword">sizeof</span>(PacketHeader.Checksum));
00489     <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d7/d3/kd_8h.html#a1">CP_GET_NODATA</a>) {
00490         <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a10">KDP_PACKET_TIMEOUT</a>;
00491     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d7/d3/kd_8h.html#a2">CP_GET_ERROR</a>) {
00492         <span class="keywordflow">if</span> (PacketHeader.PacketLeader == CONTROL_PACKET_LEADER) {
00493             <span class="keywordflow">goto</span> WaitForPacketLeader;
00494         } <span class="keywordflow">else</span> {
00495             <span class="keywordflow">goto</span> SendResendPacket;
00496         }
00497     }
00498 
00499     <span class="comment">//</span>
00500     <span class="comment">// A complete packet header is received.  Check its validity and</span>
00501     <span class="comment">// perform appropriate action depending on packet type.</span>
00502     <span class="comment">//</span>
00503 
00504     <span class="keywordflow">if</span> (PacketHeader.PacketLeader == CONTROL_PACKET_LEADER ) {
00505         <span class="keywordflow">if</span> (PacketHeader.PacketType == PACKET_TYPE_KD_ACKNOWLEDGE ) {
00506 
00507             <span class="comment">//</span>
00508             <span class="comment">// If we received an expected ACK packet and we are not</span>
00509             <span class="comment">// waiting for any new packet, update outgoing packet id</span>
00510             <span class="comment">// and return.  If we are NOT waiting for ACK packet</span>
00511             <span class="comment">// we will keep on waiting.  If the ACK packet</span>
00512             <span class="comment">// is not for the packet we send, ignore it and keep on waiting.</span>
00513             <span class="comment">//</span>
00514 
00515             <span class="keywordflow">if</span> (PacketHeader.PacketId !=
00516                 (<a class="code" href="../../d8/d5/kddata_8c.html#a92">KdpNextPacketIdToSend</a> &amp; ~SYNC_PACKET_ID))  {
00517                 <span class="keywordflow">goto</span> WaitForPacketLeader;
00518             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PacketType == PACKET_TYPE_KD_ACKNOWLEDGE) {
00519                 <a class="code" href="../../d8/d5/kddata_8c.html#a92">KdpNextPacketIdToSend</a> ^= 1;
00520                 <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a9">KDP_PACKET_RECEIVED</a>;
00521             } <span class="keywordflow">else</span> {
00522                 <span class="keywordflow">goto</span> WaitForPacketLeader;
00523             }
00524         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PacketHeader.PacketType == PACKET_TYPE_KD_RESET) {
00525 
00526             <span class="comment">//</span>
00527             <span class="comment">// if we received Reset packet, reset the packet control variables</span>
00528             <span class="comment">// and resend earlier packet.</span>
00529             <span class="comment">//</span>
00530 
00531             <a class="code" href="../../d8/d5/kddata_8c.html#a92">KdpNextPacketIdToSend</a> = INITIAL_PACKET_ID;
00532             <a class="code" href="../../d8/d5/kddata_8c.html#a93">KdpPacketIdExpected</a> = INITIAL_PACKET_ID;
00533             <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a3">KdpSendControlPacket</a>(PACKET_TYPE_KD_RESET, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00534             <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a11">KDP_PACKET_RESEND</a>;
00535         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PacketHeader.PacketType == PACKET_TYPE_KD_RESEND) {
00536             <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a11">KDP_PACKET_RESEND</a>;
00537         } <span class="keywordflow">else</span> {
00538 
00539             <span class="comment">//</span>
00540             <span class="comment">// Invalid packet header, ignore it.</span>
00541             <span class="comment">//</span>
00542 
00543             <span class="keywordflow">goto</span> WaitForPacketLeader;
00544         }
00545 
00546     <span class="comment">//</span>
00547     <span class="comment">// The packet header is for data packet (not control packet).</span>
00548     <span class="comment">//</span>
00549 
00550     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PacketType == PACKET_TYPE_KD_ACKNOWLEDGE) {
00551 
00552         <span class="comment">//</span>
00553         <span class="comment">// if we are waiting for ACK packet ONLY</span>
00554         <span class="comment">// and we receive a data packet header, check if the packet id</span>
00555         <span class="comment">// is what we expected.  If yes, assume the acknowledge is lost (but</span>
00556         <span class="comment">// sent), ask sender to resend and return with PACKET_RECEIVED.</span>
00557         <span class="comment">//</span>
00558 
00559         <span class="keywordflow">if</span> (PacketHeader.PacketId == <a class="code" href="../../d8/d5/kddata_8c.html#a93">KdpPacketIdExpected</a>) {
00560             <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a3">KdpSendControlPacket</a>(PACKET_TYPE_KD_RESEND, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00561             <a class="code" href="../../d8/d5/kddata_8c.html#a92">KdpNextPacketIdToSend</a> ^= 1;
00562             <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a9">KDP_PACKET_RECEIVED</a>;
00563         } <span class="keywordflow">else</span> {
00564             <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a3">KdpSendControlPacket</a>(PACKET_TYPE_KD_ACKNOWLEDGE,
00565                                  PacketHeader.PacketId
00566                                  );
00567             <span class="keywordflow">goto</span> WaitForPacketLeader;
00568         }
00569     }
00570 
00571     <span class="comment">//</span>
00572     <span class="comment">// we are waiting for data packet and we received the packet header</span>
00573     <span class="comment">// for data packet. Perform the following checkings to make sure</span>
00574     <span class="comment">// it is the packet we are waiting for.</span>
00575     <span class="comment">//</span>
00576 
00577     <span class="comment">//</span>
00578     <span class="comment">// Check ByteCount received is valid</span>
00579     <span class="comment">//</span>
00580 
00581     MessageLength = MessageHeader-&gt;MaximumLength;
00582     <span class="keywordflow">if</span> ((PacketHeader.ByteCount &gt; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)PACKET_MAX_SIZE) ||
00583         (PacketHeader.ByteCount &lt; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)MessageLength)) {
00584         <span class="keywordflow">goto</span> SendResendPacket;
00585     }
00586     *DataLength = PacketHeader.ByteCount - MessageLength;
00587 
00588     <span class="comment">//</span>
00589     <span class="comment">// Read the message header.</span>
00590     <span class="comment">//</span>
00591 
00592     ReturnCode = <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a1">KdpReceiveString</a>(MessageHeader-&gt;Buffer, MessageLength);
00593     <span class="keywordflow">if</span> (ReturnCode != <a class="code" href="../../d7/d3/kd_8h.html#a0">CP_GET_SUCCESS</a>) {
00594         <span class="keywordflow">goto</span> SendResendPacket;
00595     }
00596     MessageHeader-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)MessageLength;
00597 
00598     <span class="comment">//</span>
00599     <span class="comment">// Read the message data.</span>
00600     <span class="comment">//</span>
00601 
00602     ReturnCode = <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a1">KdpReceiveString</a>(MessageData-&gt;Buffer, *DataLength);
00603     <span class="keywordflow">if</span> (ReturnCode != <a class="code" href="../../d7/d3/kd_8h.html#a0">CP_GET_SUCCESS</a>) {
00604         <span class="keywordflow">goto</span> SendResendPacket;
00605     }
00606     MessageData-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)*DataLength;
00607 
00608     <span class="comment">//</span>
00609     <span class="comment">// Read packet trailing byte</span>
00610     <span class="comment">//</span>
00611 
00612     ReturnCode = <a class="code" href="../../d2/d7/hal_8h.html#a200">KdPortGetByte</a>(&amp;Input);
00613     <span class="keywordflow">if</span> (ReturnCode != <a class="code" href="../../d7/d3/kd_8h.html#a0">CP_GET_SUCCESS</a> || Input != PACKET_TRAILING_BYTE) {
00614         <span class="keywordflow">goto</span> SendResendPacket;
00615     }
00616 
00617     <span class="comment">//</span>
00618     <span class="comment">// Check PacketType is what we are waiting for.</span>
00619     <span class="comment">//</span>
00620 
00621     <span class="keywordflow">if</span> (PacketType != PacketHeader.PacketType) {
00622         <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a3">KdpSendControlPacket</a>(PACKET_TYPE_KD_ACKNOWLEDGE,
00623                              PacketHeader.PacketId
00624                              );
00625         <span class="keywordflow">goto</span> WaitForPacketLeader;
00626     }
00627 
00628     <span class="comment">//</span>
00629     <span class="comment">// Check PacketId is valid.</span>
00630     <span class="comment">//</span>
00631 
00632     <span class="keywordflow">if</span> (PacketHeader.PacketId == INITIAL_PACKET_ID ||
00633         PacketHeader.PacketId == (INITIAL_PACKET_ID ^ 1)) {
00634         <span class="keywordflow">if</span> (PacketHeader.PacketId != <a class="code" href="../../d8/d5/kddata_8c.html#a93">KdpPacketIdExpected</a>) {
00635             <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a3">KdpSendControlPacket</a>(PACKET_TYPE_KD_ACKNOWLEDGE,
00636                                  PacketHeader.PacketId
00637                                  );
00638             <span class="keywordflow">goto</span> WaitForPacketLeader;
00639         }
00640     } <span class="keywordflow">else</span> {
00641         <span class="keywordflow">goto</span> SendResendPacket;
00642     }
00643 
00644     <span class="comment">//</span>
00645     <span class="comment">// Check checksum is valid.</span>
00646     <span class="comment">//</span>
00647 
00648     Checksum = <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a0">KdpComputeChecksum</a>(
00649                             MessageHeader-&gt;Buffer,
00650                             MessageHeader-&gt;Length
00651                             );
00652 
00653     Checksum += <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a0">KdpComputeChecksum</a>(
00654                             MessageData-&gt;Buffer,
00655                             MessageData-&gt;Length
00656                             );
00657     <span class="keywordflow">if</span> (Checksum != PacketHeader.Checksum) {
00658         <span class="keywordflow">goto</span> SendResendPacket;
00659     }
00660 
00661     <span class="comment">//</span>
00662     <span class="comment">// Send Acknowledge byte and the Id of the packet received.</span>
00663     <span class="comment">// Then, update the ExpectId for next incoming packet.</span>
00664     <span class="comment">//</span>
00665 
00666     <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a3">KdpSendControlPacket</a>(PACKET_TYPE_KD_ACKNOWLEDGE,
00667                          PacketHeader.PacketId
00668                          );
00669 
00670     <span class="comment">//</span>
00671     <span class="comment">// We have successfully received the packet so update the</span>
00672     <span class="comment">// packet control variables and return sucess.</span>
00673     <span class="comment">//</span>
00674 
00675     <a class="code" href="../../d8/d5/kddata_8c.html#a93">KdpPacketIdExpected</a> ^= 1;
00676     <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a9">KDP_PACKET_RECEIVED</a>;
00677 
00678 SendResendPacket:
00679     <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a3">KdpSendControlPacket</a>(PACKET_TYPE_KD_RESEND, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00680     <span class="keywordflow">goto</span> WaitForPacketLeader;
00681 }
00682 
00683 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00684"></a><a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a6">00684</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a> (
00685     IN ULONG PacketType,
00686     IN PSTRING MessageHeader,
00687     IN PSTRING MessageData OPTIONAL
00688     )
00689 
00690 <span class="comment">/*++</span>
00691 <span class="comment"></span>
00692 <span class="comment">Routine Description:</span>
00693 <span class="comment"></span>
00694 <span class="comment">    This routine sends a packet to the host machine that is running the</span>
00695 <span class="comment">    kernel debugger and waits for an ACK.</span>
00696 <span class="comment"></span>
00697 <span class="comment">Arguments:</span>
00698 <span class="comment"></span>
00699 <span class="comment">    PacketType - Supplies the type of packet to send.</span>
00700 <span class="comment"></span>
00701 <span class="comment">    MessageHeader - Supplies a pointer to a string descriptor that describes</span>
00702 <span class="comment">        the message information.</span>
00703 <span class="comment"></span>
00704 <span class="comment">    MessageData - Supplies a pointer to a string descriptor that describes</span>
00705 <span class="comment">        the optional message data.</span>
00706 <span class="comment"></span>
00707 <span class="comment">Return Value:</span>
00708 <span class="comment"></span>
00709 <span class="comment">    None.</span>
00710 <span class="comment"></span>
00711 <span class="comment">--*/</span>
00712 
00713 {
00714 
00715     KD_PACKET PacketHeader;
00716     ULONG MessageDataLength;
00717     ULONG ReturnCode;
00718     PDBGKD_DEBUG_IO DebugIo;
00719     PDBGKD_WAIT_STATE_CHANGE64 StateChange;
00720 
00721     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(MessageData) ) {
00722         MessageDataLength = MessageData-&gt;Length;
00723         PacketHeader.Checksum = <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a0">KdpComputeChecksum</a>(
00724                                         MessageData-&gt;Buffer,
00725                                         MessageData-&gt;Length
00726                                         );
00727     } <span class="keywordflow">else</span> {
00728         MessageDataLength = 0;
00729         PacketHeader.Checksum = 0;
00730     }
00731 
00732     PacketHeader.Checksum += <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a0">KdpComputeChecksum</a> (
00733                                     MessageHeader-&gt;Buffer,
00734                                     MessageHeader-&gt;Length
00735                                     );
00736 
00737     <span class="comment">//</span>
00738     <span class="comment">// Initialize and send the packet header.</span>
00739     <span class="comment">//</span>
00740 
00741     PacketHeader.PacketLeader = PACKET_LEADER;
00742     PacketHeader.ByteCount = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(MessageHeader-&gt;Length + MessageDataLength);
00743     PacketHeader.PacketType = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)PacketType;
00744     <a class="code" href="../../d8/d5/kddata_8c.html#a88">KdpNumberRetries</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a87">KdpRetryCount</a>;
00745     <span class="keywordflow">do</span> {
00746         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a88">KdpNumberRetries</a> == 0) {
00747 
00748             <span class="comment">//</span>
00749             <span class="comment">// If the packet is not for reporting exception, we give up</span>
00750             <span class="comment">// and declare debugger not present.</span>
00751             <span class="comment">//</span>
00752 
00753             <span class="keywordflow">if</span> (PacketType == PACKET_TYPE_KD_DEBUG_IO) {
00754                 DebugIo = (PDBGKD_DEBUG_IO)MessageHeader-&gt;Buffer;
00755                 <span class="keywordflow">if</span> (DebugIo-&gt;ApiNumber == DbgKdPrintStringApi) {
00756                     <a class="code" href="../../d7/d3/kd_8h.html#a12">KdDebuggerNotPresent</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00757                     SharedUserData-&gt;KdDebuggerEnabled &amp;= ~0x00000002;
00758                     <a class="code" href="../../d8/d5/kddata_8c.html#a92">KdpNextPacketIdToSend</a> = INITIAL_PACKET_ID | SYNC_PACKET_ID;
00759                     <a class="code" href="../../d8/d5/kddata_8c.html#a93">KdpPacketIdExpected</a> = INITIAL_PACKET_ID;
00760                     <span class="keywordflow">return</span>;
00761                 }
00762             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PacketType == PACKET_TYPE_KD_STATE_CHANGE64) {
00763                 StateChange = (PDBGKD_WAIT_STATE_CHANGE64)MessageHeader-&gt;Buffer;
00764                 <span class="keywordflow">if</span> (StateChange-&gt;NewState == DbgKdLoadSymbolsStateChange) {
00765                     <a class="code" href="../../d7/d3/kd_8h.html#a12">KdDebuggerNotPresent</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00766                     SharedUserData-&gt;KdDebuggerEnabled &amp;= ~0x00000002;
00767                     <a class="code" href="../../d8/d5/kddata_8c.html#a92">KdpNextPacketIdToSend</a> = INITIAL_PACKET_ID | SYNC_PACKET_ID;
00768                     <a class="code" href="../../d8/d5/kddata_8c.html#a93">KdpPacketIdExpected</a> = INITIAL_PACKET_ID;
00769                     <span class="keywordflow">return</span>;
00770                 }
00771             }
00772         }
00773 
00774         <span class="comment">//</span>
00775         <span class="comment">// Setting PacketId has to be in the do loop in case Packet Id was</span>
00776         <span class="comment">// reset.</span>
00777         <span class="comment">//</span>
00778 
00779         PacketHeader.PacketId = <a class="code" href="../../d8/d5/kddata_8c.html#a92">KdpNextPacketIdToSend</a>;
00780         <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a2">KdpSendString</a>((PCHAR)&amp;PacketHeader, <span class="keyword">sizeof</span>(KD_PACKET));
00781 
00782         <span class="comment">//</span>
00783         <span class="comment">// Output message header.</span>
00784         <span class="comment">//</span>
00785 
00786         <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a2">KdpSendString</a>(MessageHeader-&gt;Buffer, MessageHeader-&gt;Length);
00787 
00788         <span class="comment">//</span>
00789         <span class="comment">// Output message data.</span>
00790         <span class="comment">//</span>
00791 
00792         <span class="keywordflow">if</span> ( MessageDataLength ) {
00793             <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a2">KdpSendString</a>(MessageData-&gt;Buffer, MessageData-&gt;Length);
00794         }
00795 
00796         <span class="comment">//</span>
00797         <span class="comment">// Output a packet trailing byte</span>
00798         <span class="comment">//</span>
00799 
00800         <a class="code" href="../../d2/d7/hal_8h.html#a202">KdPortPutByte</a>(PACKET_TRAILING_BYTE);
00801 
00802         <span class="comment">//</span>
00803         <span class="comment">// Wait for the Ack Packet</span>
00804         <span class="comment">//</span>
00805 
00806         ReturnCode = <a class="code" href="../../d1/d7/4_2kdp_8h.html#a112">KdpReceivePacket</a>(
00807                          PACKET_TYPE_KD_ACKNOWLEDGE,
00808                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00809                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00810                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00811                          );
00812         <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d0/d7/kdp_8h.html#a10">KDP_PACKET_TIMEOUT</a>) {
00813             <a class="code" href="../../d8/d5/kddata_8c.html#a88">KdpNumberRetries</a>--;
00814         }
00815     } <span class="keywordflow">while</span> (ReturnCode != <a class="code" href="../../d0/d7/kdp_8h.html#a9">KDP_PACKET_RECEIVED</a>);
00816 
00817     <span class="comment">//</span>
00818     <span class="comment">// Reset Sync bit in packet id.  The packet we sent may have Sync bit set</span>
00819     <span class="comment">//</span>
00820 
00821     <a class="code" href="../../d8/d5/kddata_8c.html#a92">KdpNextPacketIdToSend</a> &amp;= ~SYNC_PACKET_ID;
00822 
00823     <span class="comment">//</span>
00824     <span class="comment">// Since we are able to talk to debugger, the retrycount is set to</span>
00825     <span class="comment">// maximum value.</span>
00826     <span class="comment">//</span>
00827 
00828     <a class="code" href="../../d8/d5/kddata_8c.html#a87">KdpRetryCount</a> = <a class="code" href="../../d8/d0/cmdat3_8c.html#a70">KdpDefaultRetries</a> ;
00829 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:34 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
