<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: spb.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>spb.c File Reference</h1><code>#include "<a class="el" href="../../d1/d3/w32_2ntuser_2kernel_2precomp_8h-source.html">precomp.h</a>"</code><br>

<p>
<a href="../../d2/d3/spb_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d4/spb_8c.html#a0">FBitsTouch</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwndDirty, LPRECT lprcDirty, <a class="el" href="../../d0/d7/structtagSPB.html">PSPB</a> pspb, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> flags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d4/spb_8c.html#a1">SpbCheckRect2</a> (<a class="el" href="../../d0/d7/structtagSPB.html">PSPB</a> pspb, <a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, LPRECT lprc, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> flags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d4/spb_8c.html#a2">SpbTransfer</a> (<a class="el" href="../../d0/d7/structtagSPB.html">PSPB</a> pspb, <a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, BOOL fChildren)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d4/spb_8c.html#a3">CreateSpb</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, UINT flags, HDC hdcScreen)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UINT&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d4/spb_8c.html#a4">RestoreSpb</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, HRGN hrgnUncovered, HDC *phdcScreen)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d4/spb_8c.html#a5">LockWindowUpdate2</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwndLock, BOOL fThreadOverride)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d7/structtagSPB.html">PSPB</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d4/spb_8c.html#a6">FindSpb</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d4/spb_8c.html#a7">SpbCheck</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d4/spb_8c.html#a8">SpbCheckDce</a> (<a class="el" href="../../d3/d2/structtagDCE.html">PDCE</a> pdce)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d4/spb_8c.html#a9">SpbCheckRect</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, LPRECT lprc, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> flags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d4/spb_8c.html#a10">SpbCheckPwnd</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d4/spb_8c.html#a11">FreeSpb</a> (<a class="el" href="../../d0/d7/structtagSPB.html">PSPB</a> pspb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d4/spb_8c.html#a12">FreeAllSpbs</a> (void)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a3" doxytag="spb.c::CreateSpb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CreateSpb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HDC&nbsp;</td>
          <td class="mdname" nowrap> <em>hdcScreen</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d3/spb_8c-source.html#l00341">341</a> of file <a class="el" href="../../d2/d3/spb_8c-source.html">spb.c</a>.
<p>
References <a class="el" href="../../d0/d1/mmrtl_8c-source.html#l00221">_MonitorFromRect()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03657">AnySpbs</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d2/d0/inctlpan_8c-source.html#l00480">cy</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03592">tagDCE::DCX_flags</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03649">tagSPB::flags</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00493">ghdcMem</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00506">ghrgnSPB2</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00464">gpDispInfo</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03646">tagSPB::hbm</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03586">tagDCE::hdc</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02094">tagDISPLAYINFO::hDev</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03648">tagSPB::hrgn</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01768">tagWND::hrgnClip</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02119">tagDISPLAYINFO::hrgnScreen</a>, <a class="el" href="../../d4/d5/rect_8c-source.html#l00191">IntersectRect()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02219">IntersectRgn</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00367">Lock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02197">tagDISPLAYINFO::pdceFirst</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03585">tagDCE::pdceNext</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02202">tagDISPLAYINFO::pMonitorPrimary</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02198">tagDISPLAYINFO::pspbFirst</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03644">tagSPB::pspbNext</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02790">PWNDDESKTOP</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03647">tagSPB::rc</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02157">tagMONITOR::rcMonitor</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02206">tagDISPLAYINFO::rcScreen</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01838">tagWND::rcWindow</a>, <a class="el" href="../../d4/d5/visrgn_8c-source.html#l00040">SetRectRgnIndirect()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02556">SetWF</a>, <a class="el" href="../../d4/d1/userk_8h.html#a884">SPB</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03654">SPB_LOCKUPDATE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03653">SPB_SAVESCREENBITS</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l00995">SpbCheck()</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l00273">SpbTransfer()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03645">tagSPB::spwnd</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01744">tagWND::spwndNext</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01745">tagWND::spwndParent</a>, <a class="el" href="../../d4/d5/rect_8c-source.html#l00327">SubtractRect()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00202">SYSMET</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03650">tagSPB::ulSaveId</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00368">Unlock</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, and <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02268">WFHASSPB</a>.
<p>
Referenced by <a class="el" href="../../d2/d3/spb_8c-source.html#l00802">LockWindowUpdate2()</a>, and <a class="el" href="../../d3/d7/swp_8c-source.html#l01955">zzzChangeStates()</a>.
<p>
<pre class="fragment"><div>00345 {
00346     <a class="code" href="../../d0/d7/structtagSPB.html">PSPB</a>    pspb;
00347     <span class="keywordtype">int</span>     fSpbLockUpdate;
00348 
00349     <span class="comment">/*</span>
00350 <span class="comment">     * Non-LOCKWINDOWUPDATE SPBs can only be created for top-level windows.</span>
00351 <span class="comment">     *</span>
00352 <span class="comment">     * This is because of the way that the display driver RestoreBits function</span>
00353 <span class="comment">     * works.  It can put bits down in places that aren't even part of the</span>
00354 <span class="comment">     * window's visrgn, and these bits need to be invalidated.  The</span>
00355 <span class="comment">     * SetWindowPos() code to handle this case only knows how to invalidate</span>
00356 <span class="comment">     * one of windows (i.e., the window's immediate parent), but all levels</span>
00357 <span class="comment">     * need to get invalidated.  See also the comments in wmswp.c, near the</span>
00358 <span class="comment">     * call to RestoreSpb().</span>
00359 <span class="comment">     *</span>
00360 <span class="comment">     * For example: the Q&amp;E app brings up a copyright dialog that is a child</span>
00361 <span class="comment">     * of its main window.  While this is up, the user alt-f alt-l to execute</span>
00362 <span class="comment">     * the file login command, which brings up another dialog that is a child</span>
00363 <span class="comment">     * of the desktop.  When the copyright dialog goes away, the display driver</span>
00364 <span class="comment">     * restores bits on top of the second dialog.  The SWP code knows to</span>
00365 <span class="comment">     * invalidate the bogus stuff in the main window, but not in the desktop.</span>
00366 <span class="comment">     *</span>
00367 <span class="comment">     * LOCKUPDATE SPBs are fine, because they don't call RestoreBits.</span>
00368 <span class="comment">     */</span>
00369     fSpbLockUpdate = flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a415">SPB_LOCKUPDATE</a>;
00370     <span class="keywordflow">if</span> (    !fSpbLockUpdate             &amp;&amp;
00371             pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>   &amp;&amp;
00372             pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> != <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
00373 
00374         <span class="keywordflow">return</span>;
00375     }
00376 
00377     <span class="comment">/*</span>
00378 <span class="comment">     * We go and check all the existing DCs at this point, to handle the</span>
00379 <span class="comment">     * case where we're saving an image of a window that has a "dirty"</span>
00380 <span class="comment">     * DC, which would eventually invalidate our saved image (but which</span>
00381 <span class="comment">     * is really okay).</span>
00382 <span class="comment">     */</span>
00383     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a417">AnySpbs</a>()) {
00384 
00385         <a class="code" href="../../d4/d1/userk_8h.html#a1764">SpbCheck</a>();
00386 
00387     } <span class="keywordflow">else</span> {
00388 
00389         <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> pdce;
00390 
00391         <span class="comment">/*</span>
00392 <span class="comment">         * Reset the dirty areas of all of the DC's and enable</span>
00393 <span class="comment">         * bounds accumulation.  We're creating a SPB now.  This</span>
00394 <span class="comment">         * is only done if there are no other SPB's in the list.</span>
00395 <span class="comment">         */</span>
00396         GreLockDisplay(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
00397 
00398         <span class="keywordflow">for</span> (pdce = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a>; pdce != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pdce = pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o0">pdceNext</a>) {
00399 
00400             <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_LAYERED)
00401                 <span class="keywordflow">continue</span>;
00402 
00403             GreGetBounds(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>, NULL, GGB_ENABLE_WINMGR);
00404         }
00405 
00406         GreUnlockDisplay(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
00407     }
00408 
00409     <span class="comment">/*</span>
00410 <span class="comment">     * Create the save popup bits structure</span>
00411 <span class="comment">     */</span>
00412     pspb = (<a class="code" href="../../d0/d7/structtagSPB.html">PSPB</a>)UserAllocPoolWithQuota(<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d7/structtagSPB.html">SPB</a>), TAG_SPB);
00413     <span class="keywordflow">if</span> (!pspb)
00414         <span class="keywordflow">return</span>;
00415 
00416     pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o1">spwnd</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00417     pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o3">rc</a>    = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>;
00418 
00419     <span class="comment">/*</span>
00420 <span class="comment">     * Clip to the screen</span>
00421 <span class="comment">     */</span>
00422     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o3">rc</a>, &amp;pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o3">rc</a>, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o14">rcScreen</a>))
00423         <span class="keywordflow">goto</span> BMError;
00424 
00425     pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o4">hrgn</a>  = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00426     pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o2">hbm</a>   = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00427     pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o5">flags</a> = flags;
00428     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o1">spwnd</a>), pwnd);
00429 
00430     <span class="keywordflow">if</span> (!fSpbLockUpdate) {
00431 
00432         RECT rc = pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o3">rc</a>;
00433 
00434         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(SAMEDISPLAYFORMAT)) {
00435             <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a> pMonitor = <a class="code" href="../../d9/d1/mmrtl_8c.html#a7">_MonitorFromRect</a>(&amp;pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o3">rc</a>, MONITOR_DEFAULTTOPRIMARY);
00436             RECT rcT;
00437 
00438             <span class="comment">/*</span>
00439 <span class="comment">             * If the intersection with the monitor isn't the entire visible</span>
00440 <span class="comment">             * window rectangle, then bail!  We don't save SPBs for windows</span>
00441 <span class="comment">             * that span multiple monitors.  Since we do a lot of work to</span>
00442 <span class="comment">             * pin dialogs and menus, there won't be too many of these</span>
00443 <span class="comment">             * babies.</span>
00444 <span class="comment">             */</span>
00445             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/rect_8c.html#a11">SubtractRect</a>(&amp;rcT, &amp;pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o3">rc</a>, &amp;pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>) &amp;&amp;
00446                     GreRectInRegion(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o15">hrgnScreen</a>, &amp;rcT))
00447                 <span class="keywordflow">goto</span> BMError2;
00448 
00449             <span class="comment">/*</span>
00450 <span class="comment">             * Clip to the window's monitor</span>
00451 <span class="comment">             */</span>
00452             <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o3">rc</a>, &amp;pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o3">rc</a>, &amp;pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>))
00453                 <span class="keywordflow">goto</span> BMError2;
00454 
00455             <span class="comment">/*</span>
00456 <span class="comment">             * dont save bits in a mixed bitdepth situtation</span>
00457 <span class="comment">             * we cant create the exactly correct format bitmap</span>
00458 <span class="comment">             * in all cases (555/565, and Paletized) so as</span>
00459 <span class="comment">             * a cop-out dont save bitmaps at all (on secondaries)</span>
00460 <span class="comment">             * in mixed bit-depth.</span>
00461 <span class="comment">             *</span>
00462 <span class="comment">             * the correct fix is to create a compatible</span>
00463 <span class="comment">             * bitmap for the monitor device and directly</span>
00464 <span class="comment">             * BitBlt() from/to the device (pMonitor-&gt;hdcMonitor)</span>
00465 <span class="comment">             * but this involves too much code at this time.</span>
00466 <span class="comment">             */</span>
00467             <span class="keywordflow">if</span> (pMonitor != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o12">pMonitorPrimary</a>)
00468                 <span class="keywordflow">goto</span> BMError2;
00469         }
00470 
00471         <span class="comment">/*</span>
00472 <span class="comment">         * If this window is a regional window, don't use driver save</span>
00473 <span class="comment">         * bits. Because it can only restore an entire rectangle,</span>
00474 <span class="comment">         * invalid region is calculated assuming the old vis rgn was</span>
00475 <span class="comment">         * rectangular. For regional windows, this would end up always</span>
00476 <span class="comment">         * invalidating the area of (rcWindow - hrgnWindow) every</span>
00477 <span class="comment">         * time an spb would be used. On the other hand, the invalid</span>
00478 <span class="comment">         * area calculated when not using driver save bits is perfect,</span>
00479 <span class="comment">         * because the restore blt can be correctly clipped to begin with.</span>
00480 <span class="comment">         */</span>
00481         <span class="keywordflow">if</span> ((pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00482             (pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o6">ulSaveId</a> = GreSaveScreenBits(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>,
00483                                                 SS_SAVE,
00484                                                 0,
00485                                                 (RECTL *)&amp;rc))) {
00486 
00487             <span class="comment">/*</span>
00488 <span class="comment">             * Remember that we copied this bitmap into on board memory.</span>
00489 <span class="comment">             */</span>
00490             pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o5">flags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a414">SPB_SAVESCREENBITS</a>;
00491 
00492         } <span class="keywordflow">else</span> {
00493             HBITMAP hbmSave;
00494             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    bRet;
00495 
00496             <span class="comment">/*</span>
00497 <span class="comment">             * The following delta byte-aligns the screen bitmap</span>
00498 <span class="comment">             */</span>
00499             <span class="keywordtype">int</span> dx = pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o3">rc</a>.left &amp; 0x0007;
00500             <span class="keywordtype">int</span> cx = pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o3">rc</a>.right - pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o3">rc</a>.left;
00501             <span class="keywordtype">int</span> <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o3">rc</a>.bottom - pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o3">rc</a>.top;
00502 
00503             <span class="comment">/*</span>
00504 <span class="comment">             * NOTE: we don't care about setting up a visrgn in</span>
00505 <span class="comment">             * hdcScreen, because BitBlt ignores it on reads.</span>
00506 <span class="comment">             */</span>
00507             pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o2">hbm</a> = GreCreateCompatibleBitmap(hdcScreen, cx + dx, cy);
00508             <span class="keywordflow">if</span> (!pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o2">hbm</a>)
00509                 <span class="keywordflow">goto</span> BMError2;
00510 
00511             hbmSave = (HBITMAP)GreSelectBitmap(ghdcMem, pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o2">hbm</a>);
00512             <span class="keywordflow">if</span> (!hbmSave)
00513                 <span class="keywordflow">goto</span> BMError2;
00514 
00515             <span class="comment">/*</span>
00516 <span class="comment">             * Copy the contents of the screen to the bitmap in the</span>
00517 <span class="comment">             * save popup bits structure.  If we ever find we run</span>
00518 <span class="comment">             * into problems with the screen access check we can</span>
00519 <span class="comment">             * do a bLockDisplay, give this process permission, do</span>
00520 <span class="comment">             * the BitBlt and then take away permission.  GDI</span>
00521 <span class="comment">             * accesses the screen and that bit only under the</span>
00522 <span class="comment">             * display semaphore so it is safe.  Alternatively</span>
00523 <span class="comment">             * if it is too hard to change this processes permission</span>
00524 <span class="comment">             * here we could do it in GDI by marking the psoSrc</span>
00525 <span class="comment">             * readable temporarily while completing the operation</span>
00526 <span class="comment">             * and then setting it back to unreadable when done.</span>
00527 <span class="comment">             * Or we could just fail it like the CreateCompatibleDC</span>
00528 <span class="comment">             * failed and force a redraw.  Basically we can't add</span>
00529 <span class="comment">             * 3K of code in GDI to do a BitBlt that just does 1</span>
00530 <span class="comment">             * test differently for this 1 place in User.</span>
00531 <span class="comment">             *</span>
00532 <span class="comment">             */</span>
00533             bRet = GreBitBlt(ghdcMem,
00534                              dx,
00535                              0,
00536                              cx,
00537                              cy,
00538                              hdcScreen,
00539                              pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o3">rc</a>.left,
00540                              pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o3">rc</a>.top,
00541                              0x00CC0000,
00542                              0);
00543 
00544             GreSelectBitmap(ghdcMem, hbmSave);
00545 
00546             <span class="keywordflow">if</span> (!bRet)
00547                 <span class="keywordflow">goto</span> BMError2;
00548 
00549             GreSetBitmapOwner(pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o2">hbm</a>, OBJECT_OWNER_PUBLIC);
00550         }
00551 
00552         <span class="comment">/*</span>
00553 <span class="comment">         * Mark that the window has an SPB.</span>
00554 <span class="comment">         */</span>
00555         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, WFHASSPB);
00556 
00557         <span class="comment">/*</span>
00558 <span class="comment">         * non-LOCKUPDATE SPBs are not invalidated by</span>
00559 <span class="comment">         * drawing in pspb-&gt;spwnd, so start the SPB validation</span>
00560 <span class="comment">         * loop below at the sibling immediately below us.</span>
00561 <span class="comment">         */</span>
00562         pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
00563     }
00564 
00565     <span class="comment">/*</span>
00566 <span class="comment">     * Link the new save popup bits structure into the list.</span>
00567 <span class="comment">     */</span>
00568     pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o0">pspbNext</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o10">pspbFirst</a>;
00569     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o10">pspbFirst</a> = pspb;
00570 
00571     <span class="comment">/*</span>
00572 <span class="comment">     * Here we deal with any update regions that may be</span>
00573 <span class="comment">     * pending in windows underneath the SPB.</span>
00574 <span class="comment">     *</span>
00575 <span class="comment">     * For all windows that might affect this SPB:</span>
00576 <span class="comment">     *    - Subtract the SPB rect from the update region</span>
00577 <span class="comment">     *    - Subtract the window from the SPB</span>
00578 <span class="comment">     *</span>
00579 <span class="comment">     * Note that we use pspb-&gt;spwnd here, in case it has</span>
00580 <span class="comment">     * no siblings.</span>
00581 <span class="comment">     *</span>
00582 <span class="comment">     * ghrgnSPB2 is the region that is used inside of SpbTransfer to</span>
00583 <span class="comment">     * validate window update regions. Intersect with the window clipping</span>
00584 <span class="comment">     * region, if it exists. Don't want to intersect with the spb rect if</span>
00585 <span class="comment">     * a clipping region exists because we'll end up validating more than</span>
00586 <span class="comment">     * we want to validate.</span>
00587 <span class="comment">     */</span>
00588     <a class="code" href="../../d3/d6/visrgn_8c.html#a9">SetRectRgnIndirect</a>(ghrgnSPB2, &amp;pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o3">rc</a>);
00589     <span class="keywordflow">if</span> (pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o1">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00590 
00591         <span class="comment">/*</span>
00592 <span class="comment">         * If we get an error bail since an error might result in more</span>
00593 <span class="comment">         * being validated than we want. Since the below code is only an</span>
00594 <span class="comment">         * optimizer, this is ok: the window will remain invalid and will</span>
00595 <span class="comment">         * draw, thereby invalidating the SPB like usual.</span>
00596 <span class="comment">         */</span>
00597         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a228">IntersectRgn</a>(ghrgnSPB2,
00598                          ghrgnSPB2,
00599                          pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o1">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a>) == ERROR) {
00600             <span class="keywordflow">return</span>;
00601         }
00602     }
00603 
00604     <span class="keywordflow">if</span> (pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o1">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
00605             <a class="code" href="../../d1/d4/spb_8c.html#a2">SpbTransfer</a>(pspb, pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o1">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>, FALSE)) {
00606 
00607         <span class="comment">/*</span>
00608 <span class="comment">         * Do the same for the siblings underneath us...</span>
00609 <span class="comment">         */</span>
00610         <span class="keywordflow">for</span> ( ; pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>) {
00611             <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d4/spb_8c.html#a2">SpbTransfer</a>(pspb, pwnd, TRUE))
00612                 <span class="keywordflow">break</span>;
00613         }
00614     }
00615 
00616     <span class="keywordflow">return</span>;
00617 
00618 BMError2:
00619     <span class="comment">/*</span>
00620 <span class="comment">     * Error creating the bitmap: clean up and return.</span>
00621 <span class="comment">     */</span>
00622     <span class="keywordflow">if</span> (pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o2">hbm</a>)
00623         GreDeleteObject(pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o2">hbm</a>);
00624 
00625     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o1">spwnd</a>);
00626     <span class="comment">// fall-through</span>
00627 
00628 BMError:
00629     UserFreePool(pspb);
00630 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="spb.c::FBitsTouch" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL FBitsTouch           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwndDirty</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPRECT&nbsp;</td>
          <td class="mdname" nowrap> <em>lprcDirty</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d7/structtagSPB.html">PSPB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pspb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>flags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d3/spb_8c-source.html#l00034">34</a> of file <a class="el" href="../../d2/d3/spb_8c-source.html">spb.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03649">tagSPB::flags</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01768">tagWND::hrgnClip</a>, <a class="el" href="../../d4/d5/rect_8c-source.html#l00191">IntersectRect()</a>, <a class="el" href="../../d3/d7/rtl_2winmgr_8c-source.html#l00537">IsVisible()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03647">tagSPB::rc</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01838">tagWND::rcWindow</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03654">SPB_LOCKUPDATE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03645">tagSPB::spwnd</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01746">tagWND::spwndChild</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01744">tagWND::spwndNext</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01745">tagWND::spwndParent</a>, <a class="el" href="../../d4/d5/rect_8c-source.html#l00327">SubtractRect()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02555">TestWF</a>, and <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02419">WFVISIBLE</a>.
<p>
Referenced by <a class="el" href="../../d2/d3/spb_8c-source.html#l00214">SpbCheckRect2()</a>.
<p>
<pre class="fragment"><div>00039 {
00040     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>    pwndSpb,
00041             pwndDirtySave;
00042     <span class="keywordtype">int</span>     fSpbLockUpdate;
00043 
00044     <span class="comment">/*</span>
00045 <span class="comment">     * When no window is passed in, skip all the window-related stuff and</span>
00046 <span class="comment">     * go directly to check the rectangle.</span>
00047 <span class="comment">     */</span>
00048     <span class="keywordflow">if</span> (pwndDirty == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00049         <span class="keywordflow">goto</span> ProbablyTouch;
00050 
00051     <span class="comment">/*</span>
00052 <span class="comment">     * If pwndDirty or its parents are invisible,</span>
00053 <span class="comment">     * then it can't invalidate any SPBs</span>
00054 <span class="comment">     */</span>
00055     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a6">IsVisible</a>(pwndDirty))
00056         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00057 
00058     pwndSpb = pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o1">spwnd</a>;
00059     fSpbLockUpdate = pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o5">flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a415">SPB_LOCKUPDATE</a>;
00060     <span class="keywordflow">if</span> (fSpbLockUpdate) {
00061 
00062         <span class="comment">/*</span>
00063 <span class="comment">         * If the guy is drawing through a locked window via</span>
00064 <span class="comment">         * DCX_LOCKWINDOWUPDATE and the spb is a LOCKUPDATE SPB, then</span>
00065 <span class="comment">         * don't do any invalidation of the SPB.  Basically we're trying</span>
00066 <span class="comment">         * to avoid having the tracking rectangle invalidate the SPB</span>
00067 <span class="comment">         * since it's drawn via a WinGetClipPS() ps.</span>
00068 <span class="comment">         */</span>
00069         <span class="keywordflow">if</span> (flags &amp; DCX_LOCKWINDOWUPDATE)
00070             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00071     }
00072 
00073     <span class="comment">/*</span>
00074 <span class="comment">     * If pwndDirty is pwndSpb's immediate parent (e.g., drawing in the</span>
00075 <span class="comment">     * desktop window behind a dialog box), then we may touch: do the</span>
00076 <span class="comment">     * intersection.</span>
00077 <span class="comment">     */</span>
00078     <span class="keywordflow">if</span> (pwndDirty == pwndSpb-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>)
00079         <span class="keywordflow">goto</span> ProbablyTouch;
00080 
00081     <span class="comment">/*</span>
00082 <span class="comment">     * We know that pwndDirty != pwndSpb-&gt;spwndParent.</span>
00083 <span class="comment">     * Now find the parent of pwndDirty that is a sibling of pwndSpb.</span>
00084 <span class="comment">     */</span>
00085     pwndDirtySave = pwndDirty;
00086 
00087     <span class="keywordflow">while</span> (pwndSpb-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> != pwndDirty-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>) {
00088         pwndDirty = pwndDirty-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
00089 
00090         <span class="comment">/*</span>
00091 <span class="comment">         * If we get to the top of the tree, it's because:</span>
00092 <span class="comment">         *  1.  pwndSpb == pwndDesktop</span>
00093 <span class="comment">         *  2.  pwndDirty is a parent of pwndSpb</span>
00094 <span class="comment">         *  3.  pwndDirty == pwndDesktop</span>
00095 <span class="comment">         *  4.  pwndDirty is a child of some other desktop</span>
00096 <span class="comment">         *  5.  pwndSpb and pwndDirty aren't siblings</span>
00097 <span class="comment">         *</span>
00098 <span class="comment">         * In all these cases, pwndDirty can't touch pwndSpb.</span>
00099 <span class="comment">         */</span>
00100         <span class="keywordflow">if</span> (pwndDirty == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00101             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00102     }
00103 
00104     <span class="comment">/*</span>
00105 <span class="comment">     * If pwndSpb is the same as pwndDirty, then it will invalidate</span>
00106 <span class="comment">     * only if the SPB is LOCKUPDATE.</span>
00107 <span class="comment">     *</span>
00108 <span class="comment">     * Non-LOCKUPDATE SPB's can't be invalidated by their</span>
00109 <span class="comment">     * own windows, but LOCKUPDATE SPB's can.</span>
00110 <span class="comment">     */</span>
00111     <span class="keywordflow">if</span> (pwndDirty == pwndSpb) {
00112         <span class="keywordflow">if</span> (!fSpbLockUpdate)
00113             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00114 
00115         <span class="comment">/*</span>
00116 <span class="comment">         * If pwndSpb itself was drawn in, then we can't</span>
00117 <span class="comment">         * try subtracting children.</span>
00118 <span class="comment">         */</span>
00119         <span class="keywordflow">if</span> (pwndDirtySave == pwndSpb)
00120             <span class="keywordflow">goto</span> ProbablyTouch;
00121 
00122         <span class="comment">/*</span>
00123 <span class="comment">         * We want to calculate the immediate child of pwndSpb</span>
00124 <span class="comment">         * on the path from pwndDirty to pwndSpb, so we can</span>
00125 <span class="comment">         * subtract off the rectangles of the children of pwndSpb</span>
00126 <span class="comment">         * in case there are intervening windows.</span>
00127 <span class="comment">         */</span>
00128         <span class="keywordflow">while</span> (pwndSpb != pwndDirtySave-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>) {
00129             pwndDirtySave = pwndDirtySave-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
00130         }
00131 
00132         <span class="comment">/*</span>
00133 <span class="comment">         * The SubtractIntervening loop subtracts the</span>
00134 <span class="comment">         * window rects starting from pwndSpb and ending</span>
00135 <span class="comment">         * at the window before pwndDirty, so set up</span>
00136 <span class="comment">         * our variables appropriately.</span>
00137 <span class="comment">         */</span>
00138         pwndDirty = pwndDirtySave;
00139         pwndSpb = pwndSpb-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
00140 
00141     } <span class="keywordflow">else</span> {
00142         <span class="comment">/*</span>
00143 <span class="comment">         * Now compare the Z order of pwndDirty and pwndSpb.</span>
00144 <span class="comment">         * If pwndDirty is above pwndSpb, then the SPB can't be touched.</span>
00145 <span class="comment">         */</span>
00146         pwndDirtySave = pwndDirty;
00147 
00148         <span class="comment">/*</span>
00149 <span class="comment">         * Compare the Z order by searching starting at pwndDirty,</span>
00150 <span class="comment">         * moving DOWN the Z order list.  If we encounter pwndSpb,</span>
00151 <span class="comment">         * then pwndDirty is ABOVE or EQUAL to pwndSpb.</span>
00152 <span class="comment">         */</span>
00153         <span class="keywordflow">for</span> ( ; pwndDirty != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pwndDirty = pwndDirty-&gt;spwndNext) {
00154             <span class="keywordflow">if</span> (pwndDirty == pwndSpb) {
00155                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00156             }
00157         }
00158         pwndDirty = pwndDirtySave;
00159 
00160         <span class="comment">/*</span>
00161 <span class="comment">         * We don't want to subtract the SPB window itself</span>
00162 <span class="comment">         */</span>
00163         pwndSpb = pwndSpb-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
00164     }
00165 
00166     <span class="comment">/*</span>
00167 <span class="comment">     * Subtract Intervening rectangles.</span>
00168 <span class="comment">     * pwndDirty is below pwndSpb.  If there are any intervening</span>
00169 <span class="comment">     * windows, subtract their window rects from lprcDirty to see if pwndDirty</span>
00170 <span class="comment">     * is obscured.</span>
00171 <span class="comment">     */</span>
00172     <span class="keywordflow">while</span> (pwndSpb &amp;&amp; pwndSpb != pwndDirty) {
00173         <span class="comment">/*</span>
00174 <span class="comment">         * If this window has a region selected, hwndDirty may draw through</span>
00175 <span class="comment">         * it even though it has a full rectangle! We can't subtract its</span>
00176 <span class="comment">         * rect from the dirty rect in this case.</span>
00177 <span class="comment">         */</span>
00178         <span class="keywordflow">if</span> (    <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndSpb, WFVISIBLE) &amp;&amp;
00179                 !pwndSpb-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a> &amp;&amp;
00180                 !<a class="code" href="../../d3/d6/rect_8c.html#a11">SubtractRect</a>(lprcDirty, lprcDirty, &amp;pwndSpb-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>)) {
00181 
00182             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00183         }
00184 
00185         pwndSpb = pwndSpb-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
00186     }
00187 
00188     <span class="comment">// fall through</span>
00189 ProbablyTouch:
00190 
00191     <span class="comment">/*</span>
00192 <span class="comment">     * If the rectangles don't intersect, there is no invalidation.</span>
00193 <span class="comment">     * (we make this test relatively late because it's expensive compared</span>
00194 <span class="comment">     * to the tests above).</span>
00195 <span class="comment">     * Otherwise, *lprcDirty now has the area of bits not obscured</span>
00196 <span class="comment">     * by intervening windows.</span>
00197 <span class="comment">     */</span>
00198 
00199     <span class="keywordflow">return</span> <a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(lprcDirty, lprcDirty, &amp;pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o3">rc</a>);
00200 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="spb.c::FindSpb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d7/structtagSPB.html">PSPB</a> FindSpb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pwnd</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d3/spb_8c-source.html#l00965">965</a> of file <a class="el" href="../../d2/d3/spb_8c-source.html">spb.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l03649">tagSPB::flags</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00464">gpDispInfo</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02198">tagDISPLAYINFO::pspbFirst</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03644">tagSPB::pspbNext</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03654">SPB_LOCKUPDATE</a>, and <a class="el" href="../../d5/d0/userk_8h-source.html#l03645">tagSPB::spwnd</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/swp_8c-source.html#l05543">OffsetChildren()</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l00651">RestoreSpb()</a>, <a class="el" href="../../d9/d2/movesize_8c-source.html#l01562">xxxDrawDragRect()</a>, <a class="el" href="../../d5/d7/createw_8c-source.html#l02218">xxxFreeWindow()</a>, and <a class="el" href="../../d3/d7/swp_8c-source.html#l02681">zzzBltValidBits()</a>.
<p>
<pre class="fragment"><div>00967 {
00968     <a class="code" href="../../d0/d7/structtagSPB.html">PSPB</a> pspb;
00969 
00970     <span class="comment">/*</span>
00971 <span class="comment">     * Walk through the list of save popup bits looking for a match on</span>
00972 <span class="comment">     * window handle.</span>
00973 <span class="comment">     */</span>
00974     <span class="keywordflow">for</span> (pspb = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o10">pspbFirst</a>; pspb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pspb = pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o0">pspbNext</a>) {
00975 
00976         <span class="keywordflow">if</span> (pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o1">spwnd</a> == pwnd &amp;&amp; !(pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o5">flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a415">SPB_LOCKUPDATE</a>))
00977             <span class="keywordflow">break</span>;
00978     }
00979 
00980     <span class="keywordflow">return</span> pspb;
00981 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="spb.c::FreeAllSpbs" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FreeAllSpbs           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d3/spb_8c-source.html#l01252">1252</a> of file <a class="el" href="../../d2/d3/spb_8c-source.html">spb.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l03657">AnySpbs</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l01171">FreeSpb()</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00464">gpDispInfo</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02198">tagDISPLAYINFO::pspbFirst</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/ntinput_8c-source.html#l02146">InitiateWin32kCleanup()</a>, <a class="el" href="../../d1/d2/palette_8c-source.html#l00146">xxxRealizePalette()</a>, <a class="el" href="../../d2/d2/dtbitmap_8c-source.html#l01079">xxxSetDeskWallpaper()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l03358">xxxSwitchDesktop()</a>, and <a class="el" href="../../d9/d7/fullscr_8c-source.html#l01273">xxxUserChangeDisplaySettings()</a>.
<p>
<pre class="fragment"><div>01253 {
01254 
01255     <span class="keywordflow">while</span>(<a class="code" href="../../d4/d1/userk_8h.html#a417">AnySpbs</a>()) {
01256         <a class="code" href="../../d4/d1/userk_8h.html#a1766">FreeSpb</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o10">pspbFirst</a>);
01257     }
01258 
01259     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o10">pspbFirst</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01260 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="spb.c::FreeSpb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FreeSpb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d7/structtagSPB.html">PSPB</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pspb</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d3/spb_8c-source.html#l01171">1171</a> of file <a class="el" href="../../d2/d3/spb_8c-source.html">spb.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l03657">AnySpbs</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02557">ClrWF</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03592">tagDCE::DCX_flags</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03649">tagSPB::flags</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00464">gpDispInfo</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03646">tagSPB::hbm</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03586">tagDCE::hdc</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02094">tagDISPLAYINFO::hDev</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03648">tagSPB::hrgn</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02197">tagDISPLAYINFO::pdceFirst</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03585">tagDCE::pdceNext</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02198">tagDISPLAYINFO::pspbFirst</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03644">tagSPB::pspbNext</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03653">SPB_SAVESCREENBITS</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03645">tagSPB::spwnd</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03650">tagSPB::ulSaveId</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00368">Unlock</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, and <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02268">WFHASSPB</a>.
<p>
Referenced by <a class="el" href="../../d2/d3/spb_8c-source.html#l01252">FreeAllSpbs()</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l00802">LockWindowUpdate2()</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l00651">RestoreSpb()</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l01126">SpbCheckPwnd()</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l00214">SpbCheckRect2()</a>, <a class="el" href="../../d9/d2/movesize_8c-source.html#l01562">xxxDrawDragRect()</a>, <a class="el" href="../../d5/d7/createw_8c-source.html#l02218">xxxFreeWindow()</a>, and <a class="el" href="../../d3/d7/swp_8c-source.html#l02681">zzzBltValidBits()</a>.
<p>
<pre class="fragment"><div>01173 {
01174     <a class="code" href="../../d0/d7/structtagSPB.html">PSPB</a> *ppspb;
01175     <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> pdce;
01176 
01177     <span class="keywordflow">if</span> (pspb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01178         <span class="keywordflow">return</span>;
01179 
01180     <span class="comment">/*</span>
01181 <span class="comment">     * Delete the bitmap.  If saved in screen memory, make special call.</span>
01182 <span class="comment">     */</span>
01183     <span class="keywordflow">if</span> (pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o5">flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a414">SPB_SAVESCREENBITS</a>) {
01184         GreSaveScreenBits(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, SS_FREE, pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o6">ulSaveId</a>, NULL);
01185     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o2">hbm</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01186         GreDeleteObject(pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o2">hbm</a>);
01187     }
01188 
01189     <span class="comment">/*</span>
01190 <span class="comment">     * Destroy the region.</span>
01191 <span class="comment">     */</span>
01192     <span class="keywordflow">if</span> (pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o4">hrgn</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>){
01193         GreDeleteObject(pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o4">hrgn</a>);
01194     }
01195 
01196     <span class="comment">/*</span>
01197 <span class="comment">     * Forget that there is an attached SPB.</span>
01198 <span class="comment">     */</span>
01199     <span class="keywordflow">if</span> (pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o1">spwnd</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01200         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o1">spwnd</a>, WFHASSPB);
01201         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o1">spwnd</a>);
01202     }
01203 
01204     <span class="comment">/*</span>
01205 <span class="comment">     * Unlink the spb.</span>
01206 <span class="comment">     */</span>
01207     ppspb = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o10">pspbFirst</a>;
01208     <span class="keywordflow">while</span> (*ppspb != pspb) {
01209         ppspb = &amp;(*ppspb)-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o0">pspbNext</a>;
01210     }
01211 
01212     *ppspb = pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o0">pspbNext</a>;
01213 
01214     <span class="comment">/*</span>
01215 <span class="comment">     * Free the save popup bits structure.</span>
01216 <span class="comment">     */</span>
01217     UserFreePool(pspb);
01218 
01219     <span class="comment">/*</span>
01220 <span class="comment">     * If we no longer have any SPBs then turn off window MGR</span>
01221 <span class="comment">     * bounds collection.</span>
01222 <span class="comment">     */</span>
01223     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a417">AnySpbs</a>()) {
01224 
01225         GreLockDisplay(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
01226 
01227         <span class="comment">/*</span>
01228 <span class="comment">         * Reset the dirty areas of all of the DC's.  NULL means reset.</span>
01229 <span class="comment">         */</span>
01230         <span class="keywordflow">for</span> (pdce = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a>; pdce != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pdce = pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o0">pdceNext</a>) {
01231 
01232             <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_LAYERED)
01233                 <span class="keywordflow">continue</span>;
01234 
01235             GreGetBounds(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>, NULL, GGB_DISABLE_WINMGR);
01236         }
01237 
01238         GreUnlockDisplay(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
01239     }
01240 
01241 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="spb.c::LockWindowUpdate2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL LockWindowUpdate2           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwndLock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>fThreadOverride</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d3/spb_8c-source.html#l00802">802</a> of file <a class="el" href="../../d2/d3/spb_8c-source.html">spb.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l01838">BEGINATOMICCHECK</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l00341">CreateSpb()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06469">DeferWinEventNotify</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01842">ENDATOMICCHECK</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03649">tagSPB::flags</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l01171">FreeSpb()</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00505">ghrgnSPB1</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00464">gpDispInfo</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00090">gptiLockUpdate</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00217">gspwndLockUpdate</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02094">tagDISPLAYINFO::hDev</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03648">tagSPB::hrgn</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03064">HRGN_FULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02232">IDC_DEFAULT</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06472">IsWinEventNotifyDeferredOK</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00367">Lock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02198">tagDISPLAYINFO::pspbFirst</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03644">tagSPB::pspbNext</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06598">PUDF_LOCKFULLSCREEN</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02790">PWNDDESKTOP</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03647">tagSPB::rc</a>, <a class="el" href="../../d4/d5/visrgn_8c-source.html#l00040">SetRectRgnIndirect()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03654">SPB_LOCKUPDATE</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l00995">SpbCheck()</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l01126">SpbCheckPwnd()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02221">SubtractRgn</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06608">TEST_PUDF</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00368">Unlock</a>, <a class="el" href="../../d9/d8/update_8c-source.html#l01302">xxxInternalInvalidate()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06473">zzzEndDeferWinEventNotify</a>, and <a class="el" href="../../d9/d2/dc_8c-source.html#l01812">zzzInvalidateDCCache()</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/fullscr_8c-source.html#l00101">FullScreenCleanup()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l04298">NtUserLockWindowUpdate()</a>, <a class="el" href="../../d9/d7/fullscr_8c-source.html#l00166">xxxMakeWindowForegroundWithState()</a>, <a class="el" href="../../d9/d2/movesize_8c-source.html#l00437">xxxMS_TrackMove()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l03772">xxxProcessEventMessage()</a>, and <a class="el" href="../../d4/d5/focusact_8c-source.html#l01342">xxxSetForegroundWindow2()</a>.
<p>
<pre class="fragment"><div>00805 {
00806     <a class="code" href="../../d0/d7/structtagSPB.html">PSPB</a> pspb;
00807     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fInval;
00808     HRGN hrgn;
00809     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>  ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00810 
00811     <span class="keywordflow">if</span> (    <span class="comment">/*</span>
00812 <span class="comment">             * If we're full screen right now, fail this call.</span>
00813 <span class="comment">             */</span>
00814             <a class="code" href="../../d4/d1/userk_8h.html#a657">TEST_PUDF</a>(PUDF_LOCKFULLSCREEN)
00815 
00816             ||
00817 
00818             <span class="comment">/*</span>
00819 <span class="comment">             * If the screen is already locked, and it's being locked</span>
00820 <span class="comment">             * by some other app, then fail.  If fThreadOverride is set</span>
00821 <span class="comment">             * then we're calling internally and it's okay to cancel</span>
00822 <span class="comment">             * someone elses LockUpdate.</span>
00823 <span class="comment">             */</span>
00824             (   <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a24">gptiLockUpdate</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00825                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a24">gptiLockUpdate</a> != <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>() &amp;&amp;
00826                 !fThreadOverride)) {
00827     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
00828 
00829         RIPERR0(ERROR_SCREEN_ALREADY_LOCKED,
00830                 RIP_WARNING,
00831                 <span class="stringliteral">"LockWindowUpdate failed because screen is locked by another application."</span>);
00832 
00833         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00834     }
00835 
00836     <span class="keywordflow">if</span> ((pwndLock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) == (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a24">gptiLockUpdate</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00837         <span class="keywordflow">if</span> (!fThreadOverride) {
00838             RIPERR1(ERROR_INVALID_PARAMETER,
00839                     RIP_WARNING,
00840                     <span class="stringliteral">"LockWindowUpdate failed because it is already %s."</span>,
00841                     (pwndLock != NULL) ? <span class="stringliteral">"locked"</span> : <span class="stringliteral">"unlocked"</span>);
00842         }
00843 
00844         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00845     }
00846 
00847     <span class="comment">/*</span>
00848 <span class="comment">     * This must be done while holding the screen critsec.</span>
00849 <span class="comment">     * Deadlock if we callback during this, so defer WinEvent notifications</span>
00850 <span class="comment">     */</span>
00851     <a class="code" href="../../d4/d1/userk_8h.html#a614">DeferWinEventNotify</a>();
00852     GreLockDisplay(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
00853 
00854     <span class="keywordflow">if</span> (pwndLock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00855         <span class="comment">/*</span>
00856 <span class="comment">         * We're about to make pwndLock and its siblings invisible:</span>
00857 <span class="comment">         * go invalidate any other affected SPBs.</span>
00858 <span class="comment">         */</span>
00859         <a class="code" href="../../d4/d1/userk_8h.html#a1770">SpbCheckPwnd</a>(pwndLock);
00860 
00861         <a class="code" href="../../d4/d1/userk_8h.html#a1768">CreateSpb</a>(pwndLock, SPB_LOCKUPDATE, NULL);
00862 
00863         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(gspwndLockUpdate), pwndLock);
00864         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a24">gptiLockUpdate</a> = ptiCurrent;
00865 
00866         <a class="code" href="../../d4/d1/userk_8h.html#a1004">zzzInvalidateDCCache</a>(pwndLock, IDC_DEFAULT);
00867 
00868     } <span class="keywordflow">else</span> {
00869         <span class="comment">/*</span>
00870 <span class="comment">         * Flush any accumulated rectangles and invalidate spbs.</span>
00871 <span class="comment">         */</span>
00872         <a class="code" href="../../d4/d1/userk_8h.html#a1764">SpbCheck</a>();
00873 
00874         <span class="comment">/*</span>
00875 <span class="comment">         * Save this in a local before we set it to NULL</span>
00876 <span class="comment">         */</span>
00877         pwndLock = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a89">gspwndLockUpdate</a>;
00878 
00879         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a24">gptiLockUpdate</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00880         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;gspwndLockUpdate);
00881 
00882         <a class="code" href="../../d4/d1/userk_8h.html#a1004">zzzInvalidateDCCache</a>(pwndLock, IDC_DEFAULT);
00883 
00884         <span class="comment">/*</span>
00885 <span class="comment">         * Assume SPB doesn't exist, or couldn't be created, and that we</span>
00886 <span class="comment">         * must invalidate the entire window.</span>
00887 <span class="comment">         */</span>
00888         fInval = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00889         hrgn = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>;
00890 
00891         <span class="comment">/*</span>
00892 <span class="comment">         * Find the LOCKUPDATE spb in the list, and if present calculate</span>
00893 <span class="comment">         * the area that has been invalidated, if any.</span>
00894 <span class="comment">         */</span>
00895         <span class="keywordflow">for</span> (pspb = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o10">pspbFirst</a>; pspb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pspb = pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o0">pspbNext</a>) {
00896 
00897             <span class="keywordflow">if</span> (pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o5">flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a415">SPB_LOCKUPDATE</a>) {
00898 
00899                 <span class="keywordflow">if</span> (pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o4">hrgn</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00900 
00901                     <span class="comment">/*</span>
00902 <span class="comment">                     * If no invalid area, then no invalidation needed.</span>
00903 <span class="comment">                     */</span>
00904                     fInval = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00905 
00906                 } <span class="keywordflow">else</span> {
00907 
00908                     <span class="comment">/*</span>
00909 <span class="comment">                     * Subtract SPB valid region from SPB rectangle, to</span>
00910 <span class="comment">                     * yield invalid region.</span>
00911 <span class="comment">                     */</span>
00912                     hrgn = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a196">ghrgnSPB1</a>;
00913                     <a class="code" href="../../d3/d6/visrgn_8c.html#a9">SetRectRgnIndirect</a>(hrgn, &amp;pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o3">rc</a>);
00914 
00915                     <span class="comment">/*</span>
00916 <span class="comment">                     * If spb rect minus the spb valid rgn is empty,</span>
00917 <span class="comment">                     * then there is nothing to invalidate.</span>
00918 <span class="comment">                     */</span>
00919                     fInval = <a class="code" href="../../d4/d1/userk_8h.html#a229">SubtractRgn</a>(hrgn, hrgn, pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o4">hrgn</a>) != NULLREGION;
00920                 }
00921 
00922                 <a class="code" href="../../d4/d1/userk_8h.html#a1766">FreeSpb</a>(pspb);
00923 
00924                 <span class="comment">/*</span>
00925 <span class="comment">                 * Exit this loop (there can be only one LOCKUPDATE spb)</span>
00926 <span class="comment">                 */</span>
00927                 <span class="keywordflow">break</span>;
00928             }
00929         }
00930 
00931         <span class="keywordflow">if</span> (fInval) {
00932             <a class="code" href="../../d4/d1/userk_8h.html#a159">BEGINATOMICCHECK</a>();
00933             <span class="comment">// want to prevent WinEvent notifies, but this make break asserts</span>
00934             <a class="code" href="../../d4/d1/userk_8h.html#a614">DeferWinEventNotify</a>();
00935             <a class="code" href="../../d4/d1/userk_8h.html#a1681">xxxInternalInvalidate</a>(<a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwndLock),
00936                                hrgn,
00937                                RDW_INVALIDATE | RDW_ERASE | RDW_ALLCHILDREN);
00938             <a class="code" href="../../d4/d1/userk_8h.html#a617">zzzEndDeferWinEventNotify</a>();
00939             <a class="code" href="../../d4/d1/userk_8h.html#a163">ENDATOMICCHECK</a>();
00940         }
00941 
00942         <span class="comment">/*</span>
00943 <span class="comment">         * Invalidate any other SPBs affected by the fact that this window</span>
00944 <span class="comment">         * and its children are being made visible.</span>
00945 <span class="comment">         */</span>
00946         <a class="code" href="../../d4/d1/userk_8h.html#a1770">SpbCheckPwnd</a>(pwndLock);
00947     }
00948 
00949     GreUnlockDisplay(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
00950     <a class="code" href="../../d4/d1/userk_8h.html#a617">zzzEndDeferWinEventNotify</a>();
00951 
00952     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00953 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="spb.c::RestoreSpb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UINT RestoreSpb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HRGN&nbsp;</td>
          <td class="mdname" nowrap> <em>hrgnUncovered</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HDC *&nbsp;</td>
          <td class="mdname" nowrap> <em>phdcScreen</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d3/spb_8c-source.html#l00651">651</a> of file <a class="el" href="../../d2/d3/spb_8c-source.html">spb.c</a>.
<p>
References <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00011">Error</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l00965">FindSpb()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03649">tagSPB::flags</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l01171">FreeSpb()</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00493">ghdcMem</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00505">ghrgnSPB1</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00506">ghrgnSPB2</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00464">gpDispInfo</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03646">tagSPB::hbm</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02099">tagDISPLAYINFO::hdcScreen</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02094">tagDISPLAYINFO::hDev</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03648">tagSPB::hrgn</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01768">tagWND::hrgnClip</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02219">IntersectRgn</a>, <a class="el" href="../../d3/d7/rtl_2winmgr_8c-source.html#l00537">IsVisible()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03647">tagSPB::rc</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02243">RSPB_INVALIDATE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02244">RSPB_INVALIDATE_SSB</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02242">RSPB_NO_INVALIDATE</a>, <a class="el" href="../../d4/d5/visrgn_8c-source.html#l00040">SetRectRgnIndirect()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03653">SPB_SAVESCREENBITS</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02221">SubtractRgn</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>, and <a class="el" href="../../d5/d0/userk_8h-source.html#l03650">tagSPB::ulSaveId</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/swp_8c-source.html#l02681">zzzBltValidBits()</a>.
<p>
<pre class="fragment"><div>00655 {
00656     <a class="code" href="../../d0/d7/structtagSPB.html">PSPB</a> pspb;
00657     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uInvalidate;
00658     HRGN hrgnRestorable;
00659 
00660     <span class="comment">/*</span>
00661 <span class="comment">     * Note that we DON'T call SpbCheck() here --</span>
00662 <span class="comment">     * SpbCheck() is called by zzzBltValidBits().</span>
00663 <span class="comment">     */</span>
00664     pspb = <a class="code" href="../../d4/d1/userk_8h.html#a1765">FindSpb</a>(pwnd);
00665 
00666     <span class="comment">/*</span>
00667 <span class="comment">     * Assume all of hrgnUncovered was restored, and there's nothing</span>
00668 <span class="comment">     * for our caller to invalidate.</span>
00669 <span class="comment">     */</span>
00670     uInvalidate = <a class="code" href="../../d4/d1/userk_8h.html#a237">RSPB_NO_INVALIDATE</a>;
00671     hrgnRestorable = hrgnUncovered;
00672 
00673     <span class="comment">/*</span>
00674 <span class="comment">     * First determine whether or not there is any area at all to restore.</span>
00675 <span class="comment">     * If hrgnUncovered &amp; pspb-&gt;hrgn is empty, then all of hrgnUncovered</span>
00676 <span class="comment">     * needs to be invalidated, and there's nothing to restore.</span>
00677 <span class="comment">     */</span>
00678     <span class="keywordflow">if</span> (pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o4">hrgn</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00679         <span class="comment">/*</span>
00680 <span class="comment">         * At least some of hrgnUncovered needs to be invalidated.</span>
00681 <span class="comment">         */</span>
00682         uInvalidate = <a class="code" href="../../d4/d1/userk_8h.html#a238">RSPB_INVALIDATE</a>;
00683 
00684         <span class="comment">/*</span>
00685 <span class="comment">         * Calculate the true area of bits to be restored.  If it becomes</span>
00686 <span class="comment">         * empty, then just free the SPB without changing hrgnUncovered,</span>
00687 <span class="comment">         * which is the area that must be invalidated.</span>
00688 <span class="comment">         */</span>
00689         hrgnRestorable = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a196">ghrgnSPB1</a>;
00690         <span class="keywordflow">switch</span> (<a class="code" href="../../d4/d1/userk_8h.html#a228">IntersectRgn</a>(hrgnRestorable, hrgnUncovered, pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o4">hrgn</a>)) {
00691         <span class="keywordflow">case</span> ERROR:
00692         <span class="keywordflow">case</span> NULLREGION:
00693             <span class="keywordflow">goto</span> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>;
00694 
00695         <span class="keywordflow">default</span>:
00696             <span class="keywordflow">break</span>;
00697         }
00698     }
00699 
00700     <span class="keywordflow">if</span> (pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o5">flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a414">SPB_SAVESCREENBITS</a>) {
00701 
00702         RECT rc = pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o3">rc</a>;
00703 
00704         <span class="comment">/*</span>
00705 <span class="comment">         * Since the restore frees the onboard memory, clear this</span>
00706 <span class="comment">         * bit so FreeSpb() won't try to free it again (regardless of</span>
00707 <span class="comment">         * whether we get an error or not)</span>
00708 <span class="comment">         */</span>
00709         pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o5">flags</a> &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a414">SPB_SAVESCREENBITS</a>;
00710         <span class="keywordflow">if</span> (!(GreSaveScreenBits(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>,
00711                                 SS_RESTORE,
00712                                 pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o6">ulSaveId</a>,
00713                                 (RECTL *)&amp;rc))) {
00714             <span class="keywordflow">goto</span> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>;
00715         }
00716 
00717         <span class="comment">/*</span>
00718 <span class="comment">         * The SS_RESTORE call will always restore the entire SPB</span>
00719 <span class="comment">         * rectangle, part of which may fall outside of hrgnUncovered.</span>
00720 <span class="comment">         * The area that must be invalidated by our caller is simply</span>
00721 <span class="comment">         * the SPB rectangle minus the area of restorable bits.</span>
00722 <span class="comment">         *</span>
00723 <span class="comment">         * If this region is not empty, then the SPB was not completely</span>
00724 <span class="comment">         * restored, so we must return FALSE.</span>
00725 <span class="comment">         */</span>
00726         <a class="code" href="../../d3/d6/visrgn_8c.html#a9">SetRectRgnIndirect</a>(ghrgnSPB2, &amp;pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o3">rc</a>);
00727         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a229">SubtractRgn</a>(hrgnUncovered, ghrgnSPB2, hrgnRestorable) != NULLREGION) {
00728             uInvalidate = <a class="code" href="../../d4/d1/userk_8h.html#a239">RSPB_INVALIDATE_SSB</a>;
00729         }
00730     } <span class="keywordflow">else</span> {
00731 
00732         HDC     hdcScreen;
00733         HBITMAP hbmSave;
00734 
00735         <span class="comment">/*</span>
00736 <span class="comment">         * In the unlikely event we need a screen DC and one wasn't passed in,</span>
00737 <span class="comment">         * get it now.  If we get one, we return the handle in *phdcScreen</span>
00738 <span class="comment">         * so that our caller can release it later.</span>
00739 <span class="comment">         */</span>
00740         <span class="keywordflow">if</span> (!*phdcScreen) {
00741             *phdcScreen = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o3">hdcScreen</a>;
00742         }
00743 
00744         hdcScreen = *phdcScreen;
00745 
00746         hbmSave = (HBITMAP)GreSelectBitmap(ghdcMem, pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o2">hbm</a>);
00747         <span class="keywordflow">if</span> (!hbmSave)
00748             <span class="keywordflow">goto</span> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>;
00749 
00750         <span class="comment">/*</span>
00751 <span class="comment">         * Be sure to clip to the area of restorable bits.</span>
00752 <span class="comment">         */</span>
00753 
00754         GreSelectVisRgn(hdcScreen, hrgnRestorable, SVR_COPYNEW);
00755 
00756         GreBitBlt(hdcScreen,
00757                   pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o3">rc</a>.left, pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o3">rc</a>.top,
00758                   pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o3">rc</a>.right - pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o3">rc</a>.left,
00759                   pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o3">rc</a>.bottom - pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o3">rc</a>.top,
00760                   ghdcMem,
00761                   pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o3">rc</a>.left &amp; 0x0007,
00762                   0,
00763                   SRCCOPY,
00764                   0);
00765 
00766         GreSelectBitmap(ghdcMem, hbmSave);
00767 
00768         <span class="comment">/*</span>
00769 <span class="comment">         * Now compute the area to be invalidated for return.</span>
00770 <span class="comment">         * This is simply the original hrgnUncovered - hrgnRestorable</span>
00771 <span class="comment">         */</span>
00772         <a class="code" href="../../d4/d1/userk_8h.html#a229">SubtractRgn</a>(hrgnUncovered, hrgnUncovered, hrgnRestorable);
00773     }
00774 
00775     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || !<a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a6">IsVisible</a>(pwnd))
00776         <a class="code" href="../../d4/d1/userk_8h.html#a1766">FreeSpb</a>(pspb);
00777 
00778     <span class="keywordflow">return</span> uInvalidate;
00779 
00780 <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>:
00781     <a class="code" href="../../d4/d1/userk_8h.html#a1766">FreeSpb</a>(pspb);
00782     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a238">RSPB_INVALIDATE</a>;
00783 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="spb.c::SpbCheck" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SpbCheck           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d3/spb_8c-source.html#l00995">995</a> of file <a class="el" href="../../d2/d3/spb_8c-source.html">spb.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l03657">AnySpbs</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03592">tagDCE::DCX_flags</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00464">gpDispInfo</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02094">tagDISPLAYINFO::hDev</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02197">tagDISPLAYINFO::pdceFirst</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03585">tagDCE::pdceNext</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l01040">SpbCheckDce()</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l01081">SpbCheckRect()</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d2/d3/spb_8c-source.html#l00341">CreateSpb()</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l00802">LockWindowUpdate2()</a>, and <a class="el" href="../../d3/d7/swp_8c-source.html#l02681">zzzBltValidBits()</a>.
<p>
<pre class="fragment"><div>00996 {
00997     <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> pdce;
00998     RECT rcBounds;
00999 
01000     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a417">AnySpbs</a>()) {
01001 
01002         GreLockDisplay(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
01003 
01004         <span class="comment">/*</span>
01005 <span class="comment">         * Walk through all of the DC's, accumulating dirty areas.</span>
01006 <span class="comment">         */</span>
01007         <span class="keywordflow">for</span> (pdce = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a>; pdce != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pdce = pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o0">pdceNext</a>) {
01008 
01009             <span class="comment">/*</span>
01010 <span class="comment">             * Only check valid cache entries...</span>
01011 <span class="comment">             */</span>
01012             <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; (DCX_INVALID | DCX_DESTROYTHIS))
01013                 <span class="keywordflow">continue</span>;
01014             
01015             <a class="code" href="../../d4/d1/userk_8h.html#a1771">SpbCheckDce</a>(pdce);
01016         }
01017 
01018         <span class="comment">/*</span>
01019 <span class="comment">         * Subtact out DirectDraw dirty rect from all the SPB's. The call to</span>
01020 <span class="comment">         * GreGetDirectDrawBounds will also reset the accumulated bounds.</span>
01021 <span class="comment">         */</span>
01022         <span class="keywordflow">if</span> (GreGetDirectDrawBounds(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, &amp;rcBounds)) {
01023             <a class="code" href="../../d4/d1/userk_8h.html#a1763">SpbCheckRect</a>(NULL, &amp;rcBounds, 0);
01024         }
01025 
01026         GreUnlockDisplay(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
01027     }
01028 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="spb.c::SpbCheckDce" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SpbCheckDce           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d3/d2/structtagDCE.html">PDCE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pdce</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d3/spb_8c-source.html#l01040">1040</a> of file <a class="el" href="../../d2/d3/spb_8c-source.html">spb.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l03592">tagDCE::DCX_flags</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03586">tagDCE::hdc</a>, <a class="el" href="../../d4/d5/rect_8c-source.html#l00191">IntersectRect()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d5/rect_8c-source.html#l00139">OffsetRect()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03594">tagDCE::pMonitor</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03587">tagDCE::pwndOrg</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02157">tagMONITOR::rcMonitor</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l01081">SpbCheckRect()</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d9/d2/dc_8c-source.html#l00608">_GetDCEx()</a>, <a class="el" href="../../d9/d2/dc_8c-source.html#l02151">GetMonitorDC()</a>, <a class="el" href="../../d9/d2/dc_8c-source.html#l00470">InvalidateDce()</a>, and <a class="el" href="../../d2/d3/spb_8c-source.html#l00995">SpbCheck()</a>.
<p>
<pre class="fragment"><div>01042 {
01043     RECT rc;
01044 
01045     <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_LAYERED)
01046         <span class="keywordflow">return</span>;
01047 
01048     <span class="comment">/*</span>
01049 <span class="comment">     * Query the dirty bounds rectangle.  Doing this clears the bounds</span>
01050 <span class="comment">     * as well.</span>
01051 <span class="comment">     */</span>
01052     <span class="keywordflow">if</span> (GreGetBounds(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>, &amp;rc, 0)) {
01053 
01054         <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o9">pMonitor</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01055             <span class="comment">/*</span>
01056 <span class="comment">             * Convert the bounds rect to screen coords.</span>
01057 <span class="comment">             */</span>
01058             <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(&amp;rc, pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o9">pMonitor</a>-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.left, 
01059                     pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o9">pMonitor</a>-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.top);
01060         }
01061 
01062         <span class="comment">/*</span>
01063 <span class="comment">         * Intersect the returned rectangle with the window rectangle</span>
01064 <span class="comment">         * in case the guy was drawing outside his window</span>
01065 <span class="comment">         */</span>
01066         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rc, &amp;rc, &amp;(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a>)-&gt;rcWindow))
01067             <a class="code" href="../../d4/d1/userk_8h.html#a1763">SpbCheckRect</a>(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a>, &amp;rc, pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a>);
01068     }
01069 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="spb.c::SpbCheckPwnd" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SpbCheckPwnd           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pwnd</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d3/spb_8c-source.html#l01126">1126</a> of file <a class="el" href="../../d2/d3/spb_8c-source.html">spb.c</a>.
<p>
References <a class="el" href="../../d2/d3/spb_8c-source.html#l01171">FreeSpb()</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00464">gpDispInfo</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02198">tagDISPLAYINFO::pspbFirst</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03644">tagSPB::pspbNext</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01838">tagWND::rcWindow</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l01081">SpbCheckRect()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03645">tagSPB::spwnd</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01745">tagWND::spwndParent</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d2/d3/spb_8c-source.html#l00802">LockWindowUpdate2()</a>, and <a class="el" href="../../d9/d2/dwp_8c-source.html#l00055">xxxDWP_SetRedraw()</a>.
<p>
<pre class="fragment"><div>01128 {
01129     <a class="code" href="../../d0/d7/structtagSPB.html">PSPB</a> pspb;
01130     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndSpb;
01131     <a class="code" href="../../d0/d7/structtagSPB.html">PSPB</a> pspbNext;
01132 
01133     <span class="comment">/*</span>
01134 <span class="comment">     * First blow away any SPBs owned by this window or its children.</span>
01135 <span class="comment">     */</span>
01136     <span class="keywordflow">for</span> (pspb = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o10">pspbFirst</a>; pspb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pspb = pspbNext) {
01137 
01138         <span class="comment">/*</span>
01139 <span class="comment">         * Get pspbNext now in case we free the SPB</span>
01140 <span class="comment">         */</span>
01141         pspbNext = pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o0">pspbNext</a>;
01142 
01143         <span class="comment">/*</span>
01144 <span class="comment">         * If pspb-&gt;spwnd is == pwnd or a child of pwnd, then free the SPB</span>
01145 <span class="comment">         */</span>
01146         <span class="keywordflow">for</span> (pwndSpb = pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o1">spwnd</a>; pwndSpb; pwndSpb = pwndSpb-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>) {
01147 
01148             <span class="keywordflow">if</span> (pwnd == pwndSpb)
01149                 <a class="code" href="../../d4/d1/userk_8h.html#a1766">FreeSpb</a>(pspb);
01150         }
01151     }
01152 
01153     <span class="comment">/*</span>
01154 <span class="comment">     * Then see if any other SPBs are affected...</span>
01155 <span class="comment">     */</span>
01156     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o10">pspbFirst</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01157         <a class="code" href="../../d4/d1/userk_8h.html#a1763">SpbCheckRect</a>(pwnd, &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>, 0);
01158     }
01159 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="spb.c::SpbCheckRect" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SpbCheckRect           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPRECT&nbsp;</td>
          <td class="mdname" nowrap> <em>lprc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>flags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d3/spb_8c-source.html#l01081">1081</a> of file <a class="el" href="../../d2/d3/spb_8c-source.html">spb.c</a>.
<p>
References <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00464">gpDispInfo</a>, <a class="el" href="../../d3/d7/rtl_2winmgr_8c-source.html#l00537">IsVisible()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02198">tagDISPLAYINFO::pspbFirst</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03644">tagSPB::pspbNext</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l00214">SpbCheckRect2()</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/scrollw_8c-source.html#l00653">_ScrollDC()</a>, <a class="el" href="../../d3/d7/swp_8c-source.html#l02529">BltValidInit()</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l00995">SpbCheck()</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l01040">SpbCheckDce()</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l01126">SpbCheckPwnd()</a>, <a class="el" href="../../d9/d8/update_8c-source.html#l01302">xxxInternalInvalidate()</a>, <a class="el" href="../../d0/d4/scrollw_8c-source.html#l00741">xxxScrollWindowEx()</a>, and <a class="el" href="../../d3/d7/swp_8c-source.html#l02681">zzzBltValidBits()</a>.
<p>
<pre class="fragment"><div>01085 {
01086     <a class="code" href="../../d0/d7/structtagSPB.html">PSPB</a> pspb, pspbNext;
01087 
01088     <span class="comment">/*</span>
01089 <span class="comment">     * If this window isn't visible, we're done.</span>
01090 <span class="comment">     */</span>
01091     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a6">IsVisible</a>(pwnd))
01092         <span class="keywordflow">return</span>;
01093 
01094     <span class="keywordflow">for</span> (pspb = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o10">pspbFirst</a>; pspb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pspb = pspbNext) {
01095 
01096         <span class="comment">/*</span>
01097 <span class="comment">         * Get the pointer to the next save popup bits structure now</span>
01098 <span class="comment">         * in case SpbCheckRect2() frees the current one.</span>
01099 <span class="comment">         */</span>
01100         pspbNext = pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o0">pspbNext</a>;
01101 
01102         <span class="comment">/*</span>
01103 <span class="comment">         * In win3.1 they used to exit the function if this function</span>
01104 <span class="comment">         * returned false.  This meant that if one of the spbs was freed</span>
01105 <span class="comment">         * the rest of the spbs would not be invalidated.</span>
01106 <span class="comment">         */</span>
01107         <a class="code" href="../../d1/d4/spb_8c.html#a1">SpbCheckRect2</a>(pspb, pwnd, lprc, flags);
01108     }
01109 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="spb.c::SpbCheckRect2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL SpbCheckRect2           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d7/structtagSPB.html">PSPB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pspb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPRECT&nbsp;</td>
          <td class="mdname" nowrap> <em>lprc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>flags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d3/spb_8c-source.html#l00214">214</a> of file <a class="el" href="../../d2/d3/spb_8c-source.html">spb.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00011">Error</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l00034">FBitsTouch()</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l01171">FreeSpb()</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00504">ghrgnSCR</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03648">tagSPB::hrgn</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03647">tagSPB::rc</a>, <a class="el" href="../../d4/d5/visrgn_8c-source.html#l00115">SetOrCreateRectRgnIndirectPublic()</a>, <a class="el" href="../../d4/d5/visrgn_8c-source.html#l00040">SetRectRgnIndirect()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02221">SubtractRgn</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d3/spb_8c-source.html#l01081">SpbCheckRect()</a>, and <a class="el" href="../../d2/d3/spb_8c-source.html#l00273">SpbTransfer()</a>.
<p>
<pre class="fragment"><div>00219 {
00220     RECT rcTouch = *lprc;
00221 
00222     <span class="comment">/*</span>
00223 <span class="comment">     * See if lprc touches any saved bits, taking into account what</span>
00224 <span class="comment">     * window the drawing is occuring in.</span>
00225 <span class="comment">     */</span>
00226     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d4/spb_8c.html#a0">FBitsTouch</a>(pwnd, &amp;rcTouch, pspb, flags)) {
00227 
00228         <span class="comment">/*</span>
00229 <span class="comment">         * If no SPB region exists, make one for the whole thing</span>
00230 <span class="comment">         */</span>
00231         <span class="keywordflow">if</span> (!pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o4">hrgn</a> &amp;&amp; <a class="code" href="../../d3/d6/visrgn_8c.html#a13">SetOrCreateRectRgnIndirectPublic</a>(
00232                 &amp;pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o4">hrgn</a>, &amp;pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o3">rc</a>) == ERROR) {
00233 
00234             <span class="keywordflow">goto</span> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>;
00235         }
00236 
00237         <span class="comment">/*</span>
00238 <span class="comment">         * Subtract the rectangle that is invalid from the SPB region</span>
00239 <span class="comment">         */</span>
00240         <a class="code" href="../../d3/d6/visrgn_8c.html#a9">SetRectRgnIndirect</a>(ghrgnSCR, &amp;rcTouch);
00241         <span class="keywordflow">switch</span> (<a class="code" href="../../d4/d1/userk_8h.html#a229">SubtractRgn</a>(pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o4">hrgn</a>, pspb-&gt;<a class="code" href="../../d0/d7/structtagSPB.html#o4">hrgn</a>, ghrgnSCR)) {
00242         <span class="keywordflow">case</span> ERROR:
00243         <span class="keywordflow">case</span> NULLREGION:
00244             <span class="keywordflow">goto</span> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>;
00245 
00246         <span class="keywordflow">default</span>:
00247             <span class="keywordflow">break</span>;
00248         }
00249     }
00250 
00251     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00252 
00253 <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>:
00254     <a class="code" href="../../d4/d1/userk_8h.html#a1766">FreeSpb</a>(pspb);
00255     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00256 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="spb.c::SpbTransfer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL SpbTransfer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d7/structtagSPB.html">PSPB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pspb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>fChildren</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d3/spb_8c-source.html#l00273">273</a> of file <a class="el" href="../../d2/d3/spb_8c-source.html">spb.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l01838">BEGINATOMICCHECK</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01842">ENDATOMICCHECK</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00506">ghrgnSPB2</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03064">HRGN_FULL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01757">tagWND::hrgnUpdate</a>, <a class="el" href="../../d9/d8/update_8c-source.html#l01772">IntersectWithParents()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01838">tagWND::rcWindow</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l00214">SpbCheckRect2()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01746">tagWND::spwndChild</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01744">tagWND::spwndNext</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d9/d8/update_8c-source.html#l01302">xxxInternalInvalidate()</a>.
<p>
Referenced by <a class="el" href="../../d2/d3/spb_8c-source.html#l00341">CreateSpb()</a>.
<p>
<pre class="fragment"><div>00277 {
00278     RECT rc;
00279 
00280     <span class="comment">/*</span>
00281 <span class="comment">     * If the window has an update region...</span>
00282 <span class="comment">     */</span>
00283     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00284 
00285         <span class="comment">/*</span>
00286 <span class="comment">         * Invalidate its update region rectangle from the SPB</span>
00287 <span class="comment">         */</span>
00288         <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> &gt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>) {
00289             GreGetRgnBox(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a>, &amp;rc);
00290         } <span class="keywordflow">else</span> {
00291             rc = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>;
00292         }
00293 
00294         <span class="comment">/*</span>
00295 <span class="comment">         * Intersect the update region bounds with the parent client rects,</span>
00296 <span class="comment">         * to make sure we don't invalidate more than we need to.  If</span>
00297 <span class="comment">         * nothing to validate, return TRUE (because SPB is probably not empty)</span>
00298 <span class="comment">         * These RDW_ flags won't cause the critical section to be left, nor</span>
00299 <span class="comment">         * will they provoke WinEvent notifications.</span>
00300 <span class="comment">         */</span>
00301         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1680">IntersectWithParents</a>(pwnd, &amp;rc)) {
00302             <a class="code" href="../../d4/d1/userk_8h.html#a159">BEGINATOMICCHECK</a>();
00303 
00304             <a class="code" href="../../d4/d1/userk_8h.html#a1681">xxxInternalInvalidate</a>(pwnd,
00305                                   ghrgnSPB2,
00306                                   RDW_VALIDATE | RDW_NOCHILDREN);
00307 
00308             <a class="code" href="../../d4/d1/userk_8h.html#a163">ENDATOMICCHECK</a>();
00309 
00310             <span class="comment">/*</span>
00311 <span class="comment">             * If the SPB vanished, return FALSE.</span>
00312 <span class="comment">             */</span>
00313             <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d4/spb_8c.html#a1">SpbCheckRect2</a>(pspb, pwnd, &amp;rc, DCX_WINDOW))
00314                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00315         }
00316     }
00317 
00318     <span class="keywordflow">if</span> (fChildren) {
00319         <span class="keywordflow">for</span> (pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>; pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>) {
00320             <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d4/spb_8c.html#a2">SpbTransfer</a>(pspb, pwnd, TRUE)) {
00321                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00322             }
00323         }
00324     }
00325 
00326     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00327 }
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:39 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
