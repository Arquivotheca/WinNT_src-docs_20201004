<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: perfuser.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>perfuser.c</h1><a href="../../d0/d5/perfuser_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:    perfuser.c</span>
00006 <span class="comment"></span>
00007 <span class="comment">Abstract:</span>
00008 <span class="comment">    This file implements the Extensible Objects for the User object type</span>
00009 <span class="comment"></span>
00010 <span class="comment">Revision History</span>
00011 <span class="comment"></span>
00012 <span class="comment">    July 97     MCostea     created</span>
00013 <span class="comment"></span>
00014 <span class="comment">--*/</span>
00015 
00016 <span class="preprocessor">#include &lt;nt.h&gt;</span>
00017 <span class="preprocessor">#include &lt;ntrtl.h&gt;</span>
00018 <span class="preprocessor">#include &lt;nturtl.h&gt;</span>
00019 <span class="preprocessor">#include &lt;windows.h&gt;</span>
00020 <span class="preprocessor">#include &lt;winuser.h&gt;</span>
00021 <span class="preprocessor">#include &lt;winperf.h&gt;</span>
00022 <span class="preprocessor">#include &lt;ntprfctr.h&gt;</span>
00023 <span class="preprocessor">#include &lt;string.h&gt;</span>
00024 <span class="preprocessor">#include &lt;wcstr.h&gt;</span>
00025 <span class="preprocessor">#include "userctrs.h"</span> <span class="comment">// error message definition</span>
00026 <span class="preprocessor">#include "<a class="code" href="../../d8/d4/perfmsg_8h.html">perfmsg.h</a>"</span>
00027 <span class="preprocessor">#include "<a class="code" href="../../d3/d5/perfutil_8h.html">perfutil.h</a>"</span>
00028 <span class="preprocessor">#include "<a class="code" href="../../d9/d0/userdata_8h.html">userdata.h</a>"</span>
00029 
<a name="l00030"></a><a class="code" href="../../d0/d5/perfuser_8c.html#a0">00030</a> <span class="preprocessor">#define ALL_PROCESSES_STRING L"_All Processes"</span>
00031 <span class="preprocessor"></span>
00032 <span class="comment">/*</span>
00033 <span class="comment"> * Declared in winuserp.h</span>
00034 <span class="comment"> */</span>
<a name="l00035"></a><a class="code" href="../../d0/d5/perfuser_8c.html#a1">00035</a> <span class="preprocessor">#define QUC_PID_TOTAL       0xffffffff</span>
<a name="l00036"></a><a class="code" href="../../d0/d5/perfuser_8c.html#a2">00036</a> <span class="preprocessor"></span><span class="preprocessor">#define QUERYUSER_TYPE_USER    0x1</span>
<a name="l00037"></a><a class="code" href="../../d0/d5/perfuser_8c.html#a3">00037</a> <span class="preprocessor"></span><span class="preprocessor">#define QUERYUSER_TYPE_CS      0x2</span>
00038 <span class="preprocessor"></span>
00039 <span class="comment">/*</span>
00040 <span class="comment"> *  The counters in CSSTATISTICS refer to the USER critical section:</span>
00041 <span class="comment"> *      gCSExclusive counts how many times the CS was aquired exclusive</span>
00042 <span class="comment"> *      gCSShared counts how many times the CS was aquired shared</span>
00043 <span class="comment"> *      gCSTimeExclusive counts the time (NtQueryPerformanceCounter() units)</span>
00044 <span class="comment"> *      spent in the resource since the last query.</span>
00045 <span class="comment"> */</span>
<a name="l00046"></a><a class="code" href="../../d5/d8/struct__tagCSStatistics.html">00046</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d5/d8/struct__tagCSStatistics.html">_tagCSStatistics</a> {
<a name="l00047"></a><a class="code" href="../../d5/d8/struct__tagCSStatistics.html#o0">00047</a>         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   <a class="code" href="../../d5/d8/struct__tagCSStatistics.html#o0">cExclusive</a>;
<a name="l00048"></a><a class="code" href="../../d5/d8/struct__tagCSStatistics.html#o1">00048</a>         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   <a class="code" href="../../d5/d8/struct__tagCSStatistics.html#o1">cShared</a>;
<a name="l00049"></a><a class="code" href="../../d5/d8/struct__tagCSStatistics.html#o2">00049</a>         __int64 <a class="code" href="../../d5/d8/struct__tagCSStatistics.html#o2">i64TimeExclusive</a>;
00050 } <a class="code" href="../../d5/d8/struct__tagCSStatistics.html">CSSTATISTICS</a>;
00051 
<a name="l00052"></a><a class="code" href="../../d0/d5/perfuser_8c.html#a5">00052</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a20">BOOL</a> (WINAPI *QueryUserCounters)(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>, <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>, <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> );
00053 
00054 <span class="comment">/*</span>
00055 <span class="comment"> *  References to constants which initialize the Object type definitions</span>
00056 <span class="comment"> */</span>
<a name="l00057"></a><a class="code" href="../../d0/d5/perfuser_8c.html#a7">00057</a> <span class="keyword">extern</span> <a class="code" href="../../d5/d4/struct__USER__DATA__DEFINITION.html">USER_DATA_DEFINITION</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a7">UserDataDefinition</a>;
<a name="l00058"></a><a class="code" href="../../d0/d5/perfuser_8c.html#a8">00058</a> <span class="keyword">extern</span> <a class="code" href="../../d7/d9/struct__CS__DATA__DEFINITION.html">CS_DATA_DEFINITION</a>   <a class="code" href="../../d0/d5/perfuser_8c.html#a8">CSDataDefinition</a>;
00059 
00060 <span class="comment">/*</span>
00061 <span class="comment"> * Global to store the process instances</span>
00062 <span class="comment"> * This array is filled when the dll is attached (OpenUserPerformanceData)</span>
00063 <span class="comment"> */</span>
<a name="l00064"></a><a class="code" href="../../d9/d8/struct__tagInstance.html">00064</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d9/d8/struct__tagInstance.html">_tagInstance</a> {
<a name="l00065"></a><a class="code" href="../../d9/d8/struct__tagInstance.html#o0">00065</a>     LPWSTR     <a class="code" href="../../d9/d8/struct__tagInstance.html#o0">pName</a>;    <span class="comment">// pointer to Unicode string</span>
<a name="l00066"></a><a class="code" href="../../d9/d8/struct__tagInstance.html#o1">00066</a>     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>      <a class="code" href="../../d9/d8/struct__tagInstance.html#o1">sizeName</a>; <span class="comment">// in bytes, including terminating NULL</span>
<a name="l00067"></a><a class="code" href="../../d9/d8/struct__tagInstance.html#o2">00067</a>     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>      <span class="keywordtype">id</span>;       <span class="comment">// client side ID</span>
00068 } <a class="code" href="../../d9/d8/struct__tagInstance.html">ProcessInstance</a>;
00069 
<a name="l00070"></a><a class="code" href="../../d0/d5/perfuser_8c.html#a10">00070</a> <a class="code" href="../../d9/d8/struct__tagInstance.html">ProcessInstance</a> *<a class="code" href="../../d0/d5/perfuser_8c.html#a10">gaInstances</a>;
<a name="l00071"></a><a class="code" href="../../d0/d5/perfuser_8c.html#a11">00071</a> <span class="keywordtype">int</span>     <a class="code" href="../../d0/d5/perfuser_8c.html#a11">gNumInstances</a>;
<a name="l00072"></a><a class="code" href="../../d0/d5/perfuser_8c.html#a12">00072</a> PDWORD  <a class="code" href="../../d0/d5/perfuser_8c.html#a12">gpPid</a>;            <span class="comment">// globals to store the allocate blocks of memory used</span>
<a name="l00073"></a><a class="code" href="../../d0/d5/perfuser_8c.html#a13">00073</a> PDWORD  <a class="code" href="../../d0/d5/perfuser_8c.html#a13">gpdwResult</a>;       <span class="comment">// as parameters in QueryUserCounters</span>
<a name="l00074"></a><a class="code" href="../../d0/d5/perfuser_8c.html#a14">00074</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   <a class="code" href="../../d0/d5/perfuser_8c.html#a14">dwOpenCount</a>;      <span class="comment">// count of "Open" threads</span>
<a name="l00075"></a><a class="code" href="../../d0/d5/perfuser_8c.html#a15">00075</a> HANDLE  <a class="code" href="../../d0/d5/perfuser_8c.html#a15">ghHeap</a>;
<a name="l00076"></a><a class="code" href="../../d0/d5/perfuser_8c.html#a16">00076</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    <a class="code" href="../../d0/d5/perfuser_8c.html#a16">gbInitOK</a>;          <span class="comment">// true = DLL initialized OK</span>
00077 
00078 <span class="comment">/*</span>
00079 <span class="comment"> * Function Prototypes</span>
00080 <span class="comment"> * used to insure that the data collection functions</span>
00081 <span class="comment"> * accessed by Perflib will have the correct calling format.</span>
00082 <span class="comment"> */</span>
00083 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a21">GlobalCollect</a>(
00084     IN      LPWSTR  lpValueName,
00085     IN OUT  LPVOID  *lppData,
00086     IN OUT  LPDWORD lpcbTotalBytes,
00087     IN OUT  LPDWORD lpNumObjectTypes,
00088     IN      DWORD   dwQueryType);
00089 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  <a class="code" href="../../d0/d5/perfuser_8c.html#a22">FillInstances</a>(VOID);
00090 
<a name="l00091"></a><a class="code" href="../../d0/d5/perfuser_8c.html#a17">00091</a> PM_OPEN_PROC    <a class="code" href="../../d0/d5/perfuser_8c.html#a17">OpenUserPerformanceData</a>;
<a name="l00092"></a><a class="code" href="../../d0/d5/perfuser_8c.html#a18">00092</a> PM_COLLECT_PROC <a class="code" href="../../d0/d5/perfuser_8c.html#a18">CollectUserPerformanceData</a>;
<a name="l00093"></a><a class="code" href="../../d0/d5/perfuser_8c.html#a19">00093</a> PM_CLOSE_PROC   <a class="code" href="../../d0/d5/perfuser_8c.html#a19">CloseUserPerformanceData</a>;
00094 
00095 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00096 __stdcall
<a name="l00097"></a><a class="code" href="../../d0/d5/perfuser_8c.html#a23">00097</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a23">DllInit</a>(
00098     IN HANDLE DLLHandle,
00099     IN DWORD  Reason,
00100     IN LPVOID ReservedAndUnused
00101 )
00102 {
00103     <span class="keywordtype">char</span> szUser32DllPath[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>+15];
00104     HMODULE hUser32Module;
00105     ReservedAndUnused;
00106     <span class="comment">/*</span>
00107 <span class="comment">     *  this will prevent the DLL from getting the DLL_THREAD_* messages</span>
00108 <span class="comment">     */</span>
00109     DisableThreadLibraryCalls (DLLHandle);
00110 
00111     <span class="keywordflow">switch</span>(Reason) {
00112         <span class="keywordflow">case</span> DLL_PROCESS_ATTACH:
00113 
00114             <span class="keywordflow">if</span> (!GetSystemDirectory(szUser32DllPath, <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>+1)) {
00115                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00116             }
00117             strcat( szUser32DllPath, <span class="stringliteral">"\\user32.dll"</span>);
00118 
00119             hUser32Module = GetModuleHandle(szUser32DllPath);
00120             <span class="keywordflow">if</span> (!hUser32Module) {
00121                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00122             }
00123             QueryUserCounters = (<a class="code" href="../../d0/d5/perfuser_8c.html#a20">BOOL</a> (WINAPI  *)(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>, <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>, <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> ))
00124                             GetProcAddress(hUser32Module, <span class="stringliteral">"QueryUserCounters"</span>);
00125             <span class="keywordflow">if</span> (!QueryUserCounters) {
00126                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00127             }
00128             <span class="keywordflow">break</span>;
00129 
00130         <span class="keywordflow">case</span> DLL_PROCESS_DETACH:
00131             <span class="keywordflow">break</span>;
00132     }
00133     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00134 }
00135 
<a name="l00136"></a><a class="code" href="../../d0/d5/perfuser_8c.html#a24">00136</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a24">OpenUserPerformanceData</a>(
00137     LPWSTR lpDeviceNames    )
00138 <span class="comment">/*++</span>
00139 <span class="comment">Routine Description:</span>
00140 <span class="comment"></span>
00141 <span class="comment">    This routine opens the interface with the event log and</span>
00142 <span class="comment">    initializes the data structures used to pass data back to the registry.</span>
00143 <span class="comment">    It also calls FillInstances.</span>
00144 <span class="comment"></span>
00145 <span class="comment">Arguments:</span>
00146 <span class="comment">    Pointer to object ID of each device to be opened</span>
00147 <span class="comment"></span>
00148 <span class="comment">Return Value:</span>
00149 <span class="comment">    None.</span>
00150 <span class="comment">--*/</span>
00151 {
00152     LONG    status;
00153     HKEY    hKeyDriverPerf;
00154     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   size;
00155     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>;
00156     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwFirstCounter;
00157     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwFirstHelp;
00158 
00159     PDWORD  pCounterNameTitleIndex;
00160     LPWSTR  *pCounterNameTitle;
00161     PDWORD  pCounterHelpTitleIndex;
00162     LPWSTR  *pCounterHelpTitle;
00163     <span class="keywordtype">int</span>     i;
00164 
00165     <span class="comment">/*</span>
00166 <span class="comment">     *  Since SCREG is multi-threaded and will call this routine in</span>
00167 <span class="comment">     *  order to service remote performance queries, this library</span>
00168 <span class="comment">     *  must keep track of how many times it has been opened (i.e.</span>
00169 <span class="comment">     *  how many threads have accessed it). the registry routines will</span>
00170 <span class="comment">     *  limit access to the initialization routine to only one thread</span>
00171 <span class="comment">     *  at a time so synchronization (i.e. reentrancy) should not be</span>
00172 <span class="comment">     *  a problem</span>
00173 <span class="comment">     */</span>
00174     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d5/perfuser_8c.html#a14">dwOpenCount</a>) {
00175 
00176         <a class="code" href="../../d8/d4/perfmsg_8h.html#a13">hEventLog</a> = <a class="code" href="../../d2/d5/perfutil_8c.html#a17">MonOpenEventLog</a>();  <span class="comment">// open Eventlog interface</span>
00177         <span class="comment">/*</span>
00178 <span class="comment">         * get counter and help index base values from registry</span>
00179 <span class="comment">         *      Open key to registry entry</span>
00180 <span class="comment">         *      read First Counter and First Help values</span>
00181 <span class="comment">         *      update static data structures by adding base to</span>
00182 <span class="comment">         *      offset value in structure.</span>
00183 <span class="comment">         */</span>
00184         status = RegOpenKeyEx (
00185             HKEY_LOCAL_MACHINE,
00186             <span class="stringliteral">"SYSTEM\\CurrentControlSet\\Services\\PerfUser\\Performance"</span>,
00187             0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00188             KEY_ALL_ACCESS,
00189             &amp;hKeyDriverPerf);
00190 
00191         <span class="keywordflow">if</span> (status != ERROR_SUCCESS) {
00192             <a class="code" href="../../d8/d4/perfmsg_8h.html#a12">REPORT_ERROR_DATA</a> (USERPERF_UNABLE_OPEN_DRIVER_KEY, <a class="code" href="../../d8/d4/perfmsg_8h.html#a2">LOG_USER</a>,
00193                 &amp;status, <span class="keyword">sizeof</span>(status));
00194             <span class="comment">/*</span>
00195 <span class="comment">             * these failures are fatal, if we can't get the base values of the</span>
00196 <span class="comment">             * counter or help names, then the names won't be available</span>
00197 <span class="comment">             * to the requesting application  so there's not much</span>
00198 <span class="comment">             * point in continuing.</span>
00199 <span class="comment">             */</span>
00200             <span class="keywordflow">goto</span> OpenExitPoint;
00201         }
00202 
00203         size = <span class="keyword">sizeof</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
00204         status = RegQueryValueEx(
00205                     hKeyDriverPerf,
00206                     <span class="stringliteral">"First Counter"</span>,
00207                     0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00208                     &amp;<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>,
00209                     (LPBYTE)&amp;dwFirstCounter,
00210                      &amp;size);
00211 
00212         <span class="keywordflow">if</span> (status != ERROR_SUCCESS) {
00213             <a class="code" href="../../d8/d4/perfmsg_8h.html#a12">REPORT_ERROR_DATA</a> (USERPERF_UNABLE_READ_FIRST_COUNTER, <a class="code" href="../../d8/d4/perfmsg_8h.html#a2">LOG_USER</a>,
00214                 &amp;status, <span class="keyword">sizeof</span>(status));
00215             <span class="keywordflow">goto</span> OpenExitPoint;
00216         }
00217 
00218         status = RegQueryValueEx(
00219                     hKeyDriverPerf,
00220                     <span class="stringliteral">"First Help"</span>,
00221                     0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00222                     &amp;<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>,
00223                     (LPBYTE)&amp;dwFirstHelp,
00224                     &amp;size);
00225 
00226         <span class="keywordflow">if</span> (status != ERROR_SUCCESS) {
00227             <a class="code" href="../../d8/d4/perfmsg_8h.html#a12">REPORT_ERROR_DATA</a> (USERPERF_UNABLE_READ_FIRST_HELP, <a class="code" href="../../d8/d4/perfmsg_8h.html#a2">LOG_USER</a>,
00228                 &amp;status, <span class="keyword">sizeof</span>(status));
00229             <span class="keywordflow">goto</span> OpenExitPoint;
00230         }
00231 
00232         <a class="code" href="../../d0/d5/perfuser_8c.html#a7">UserDataDefinition</a>.<a class="code" href="../../d5/d4/struct__USER__DATA__DEFINITION.html#o0">UserObjectType</a>.ObjectNameTitleIndex += dwFirstCounter;
00233         <a class="code" href="../../d0/d5/perfuser_8c.html#a7">UserDataDefinition</a>.<a class="code" href="../../d5/d4/struct__USER__DATA__DEFINITION.html#o0">UserObjectType</a>.ObjectHelpTitleIndex += dwFirstHelp;
00234 
00235         pCounterNameTitleIndex = &amp;<a class="code" href="../../d0/d5/perfuser_8c.html#a7">UserDataDefinition</a>.<a class="code" href="../../d5/d4/struct__USER__DATA__DEFINITION.html#o1">NumTotals</a>.CounterNameTitleIndex;
00236         pCounterHelpTitleIndex = &amp;<a class="code" href="../../d0/d5/perfuser_8c.html#a7">UserDataDefinition</a>.<a class="code" href="../../d5/d4/struct__USER__DATA__DEFINITION.html#o1">NumTotals</a>.CounterHelpTitleIndex;
00237 
00238         <span class="keywordflow">for</span> (i = 0; i&lt;<a class="code" href="../../d9/d0/userdata_8h.html#a21">NUM_USER_COUNTERS</a>;
00239                 i++,
00240                 pCounterNameTitleIndex += <span class="keyword">sizeof</span>(PERF_COUNTER_DEFINITION)/<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>),
00241                 pCounterHelpTitleIndex += <span class="keyword">sizeof</span>(PERF_COUNTER_DEFINITION)/<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>))
00242         {
00243             *pCounterNameTitleIndex += dwFirstCounter;
00244             *pCounterHelpTitleIndex += dwFirstHelp;
00245         }
00246         <span class="comment">/*</span>
00247 <span class="comment">         * Set CSDataDefinition indexes</span>
00248 <span class="comment">         */</span>
00249         <a class="code" href="../../d0/d5/perfuser_8c.html#a8">CSDataDefinition</a>.<a class="code" href="../../d7/d9/struct__CS__DATA__DEFINITION.html#o0">CSObjectType</a>.ObjectNameTitleIndex += dwFirstCounter;
00250         <a class="code" href="../../d0/d5/perfuser_8c.html#a8">CSDataDefinition</a>.<a class="code" href="../../d7/d9/struct__CS__DATA__DEFINITION.html#o0">CSObjectType</a>.ObjectHelpTitleIndex += dwFirstHelp;
00251         <a class="code" href="../../d0/d5/perfuser_8c.html#a8">CSDataDefinition</a>.<a class="code" href="../../d7/d9/struct__CS__DATA__DEFINITION.html#o1">CSExEnter</a>.CounterNameTitleIndex += dwFirstCounter;
00252         <a class="code" href="../../d0/d5/perfuser_8c.html#a8">CSDataDefinition</a>.<a class="code" href="../../d7/d9/struct__CS__DATA__DEFINITION.html#o1">CSExEnter</a>.CounterHelpTitleIndex += dwFirstHelp;
00253         <a class="code" href="../../d0/d5/perfuser_8c.html#a8">CSDataDefinition</a>.<a class="code" href="../../d7/d9/struct__CS__DATA__DEFINITION.html#o2">CSShEnter</a>.CounterNameTitleIndex += dwFirstCounter;
00254         <a class="code" href="../../d0/d5/perfuser_8c.html#a8">CSDataDefinition</a>.<a class="code" href="../../d7/d9/struct__CS__DATA__DEFINITION.html#o2">CSShEnter</a>.CounterHelpTitleIndex += dwFirstHelp;
00255         <a class="code" href="../../d0/d5/perfuser_8c.html#a8">CSDataDefinition</a>.<a class="code" href="../../d7/d9/struct__CS__DATA__DEFINITION.html#o3">CSExTime</a>.CounterNameTitleIndex += dwFirstCounter;
00256         <a class="code" href="../../d0/d5/perfuser_8c.html#a8">CSDataDefinition</a>.<a class="code" href="../../d7/d9/struct__CS__DATA__DEFINITION.html#o3">CSExTime</a>.CounterHelpTitleIndex += dwFirstHelp;
00257 
00258         RegCloseKey (hKeyDriverPerf); <span class="comment">// close key to registry</span>
00259         <a class="code" href="../../d0/d5/perfuser_8c.html#a16">gbInitOK</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;     <span class="comment">// ok to use this function</span>
00260     }
00261 
00262     <a class="code" href="../../d0/d5/perfuser_8c.html#a14">dwOpenCount</a>++;          <span class="comment">// increment OPEN counter</span>
00263     status = ERROR_SUCCESS; <span class="comment">// for successful exit</span>
00264 
00265 OpenExitPoint:
00266 
00267     <span class="keywordflow">return</span> status;
00268 }
00269 
<a name="l00270"></a><a class="code" href="../../d0/d5/perfuser_8c.html#a25">00270</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a25">CollectUserPerformanceData</a>(
00271     IN      LPWSTR  lpValueName,
00272     IN OUT  LPVOID  *lppData,
00273     IN OUT  LPDWORD lpcbTotalBytes,
00274     IN OUT  LPDWORD lpNumObjectTypes)
00275 
00276 <span class="comment">/*++</span>
00277 <span class="comment"></span>
00278 <span class="comment">Routine Description:    This routine will return the data for the User counters.</span>
00279 <span class="comment"></span>
00280 <span class="comment">Arguments:</span>
00281 <span class="comment">   IN       LPWSTR   lpValueName</span>
00282 <span class="comment">            pointer to a wide character string passed by registry.</span>
00283 <span class="comment">   IN OUT   LPVOID   *lppData</span>
00284 <span class="comment">         IN: pointer to the address of the buffer to receive the completed</span>
00285 <span class="comment">            PerfDataBlock and subordinate structures. This routine will</span>
00286 <span class="comment">            append its data to the buffer starting at the point referenced</span>
00287 <span class="comment">            by *lppData.</span>
00288 <span class="comment">         OUT: points to the first byte after the data structure added by this</span>
00289 <span class="comment">            routine. This routine updated the value at lppdata after appending</span>
00290 <span class="comment">            its data.</span>
00291 <span class="comment"></span>
00292 <span class="comment">   IN OUT   LPDWORD  lpcbTotalBytes</span>
00293 <span class="comment">         IN: the address of the DWORD that tells the size in bytes of the</span>
00294 <span class="comment">            buffer referenced by the lppData argument</span>
00295 <span class="comment">         OUT: the number of bytes added by this routine is written to the</span>
00296 <span class="comment">            DWORD pointed to by this argument</span>
00297 <span class="comment"></span>
00298 <span class="comment">   IN OUT   LPDWORD  NumObjectTypes</span>
00299 <span class="comment">         IN: the address of the DWORD to receive the number of objects added</span>
00300 <span class="comment">            by this routine</span>
00301 <span class="comment">         OUT: the number of objects added by this routine is written to the</span>
00302 <span class="comment">            DWORD pointed to by this argument</span>
00303 <span class="comment"></span>
00304 <span class="comment">Return Value:</span>
00305 <span class="comment"></span>
00306 <span class="comment">      ERROR_MORE_DATA if buffer passed is too small to hold data</span>
00307 <span class="comment">         any error conditions encountered are reported to the event log if</span>
00308 <span class="comment">         event logging is enabled.</span>
00309 <span class="comment">      ERROR_SUCCESS  if success or any other error. Errors, however are</span>
00310 <span class="comment">         also reported to the event log.</span>
00311 <span class="comment">--*/</span>
00312 {
00313 
00314     <span class="comment">//  Variables for reformatting the data</span>
00315     PERF_COUNTER_BLOCK      *pPerfCounterBlock;
00316     <a class="code" href="../../d5/d4/struct__USER__DATA__DEFINITION.html">USER_DATA_DEFINITION</a>    *pUserDataDefinition;
00317     ULONG   SpaceNeeded;
00318     PDWORD  pdwCounter, dwProcList;
00319     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwQueryType;
00320     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwObjects;
00321     <span class="keywordtype">int</span>     i;
00322 
00323     <span class="comment">/*</span>
00324 <span class="comment">     * before doing anything else, see if Open went OK</span>
00325 <span class="comment">     */</span>
00326     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d5/perfuser_8c.html#a16">gbInitOK</a>) {
00327         <span class="comment">// unable to continue because open failed.</span>
00328         *lpcbTotalBytes = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) 0;
00329         *lpNumObjectTypes = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) 0;
00330         <span class="keywordflow">return</span> ERROR_SUCCESS; <span class="comment">// yes, this is a successful exit</span>
00331     }
00332 
00333     <span class="comment">/*</span>
00334 <span class="comment">     * see if this is a foreign (i.e. non-NT) computer data request</span>
00335 <span class="comment">     */</span>
00336     dwQueryType = <a class="code" href="../../d3/d5/perfutil_8h.html#a19">GetQueryType</a> (lpValueName);
00337     <span class="keywordflow">if</span> (dwQueryType == <a class="code" href="../../d3/d5/perfutil_8h.html#a4">QUERY_FOREIGN</a>) {
00338         <span class="comment">/*</span>
00339 <span class="comment">         * this routine does not service requests for data from</span>
00340 <span class="comment">         * Non-NT computers</span>
00341 <span class="comment">         */</span>
00342         *lpcbTotalBytes = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) 0;
00343         *lpNumObjectTypes = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) 0;
00344         <span class="keywordflow">return</span> ERROR_SUCCESS;
00345     }
00346     <span class="keywordflow">if</span> (dwQueryType == <a class="code" href="../../d3/d5/perfutil_8h.html#a3">QUERY_ITEMS</a>) {
00347         <span class="keywordflow">if</span> ( !(dwObjects = <a class="code" href="../../d3/d5/perfutil_8h.html#a20">IsNumberInUnicodeList</a> (lpValueName) )) {
00348 
00349             <span class="comment">/*</span>
00350 <span class="comment">             * request received for data object not provided by this routine</span>
00351 <span class="comment">             */</span>
00352             *lpcbTotalBytes = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) 0;
00353             *lpNumObjectTypes = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) 0;
00354             <span class="keywordflow">return</span> ERROR_SUCCESS;
00355 
00356         }
00357 
00358         <span class="keywordflow">return</span> <a class="code" href="../../d0/d5/perfuser_8c.html#a21">GlobalCollect</a>(
00359                 lpValueName,
00360                 lppData,
00361                 lpcbTotalBytes,
00362                 lpNumObjectTypes,
00363                 dwObjects);
00364     }
00365     <span class="keywordflow">else</span> {
00366         <span class="comment">/*</span>
00367 <span class="comment">         * General request to fill the instance combo-box</span>
00368 <span class="comment">         * No need to actually retrieve the counter values</span>
00369 <span class="comment">         */</span>
00370         <span class="keywordflow">return</span> <a class="code" href="../../d0/d5/perfuser_8c.html#a21">GlobalCollect</a>(
00371                 lpValueName,
00372                 lppData,
00373                 lpcbTotalBytes,
00374                 lpNumObjectTypes,
00375                 <a class="code" href="../../d3/d5/perfutil_8h.html#a6">QUERY_NOCOUNTERS</a>);
00376     }
00377 
00378     <span class="keywordflow">return</span> ERROR_SUCCESS;
00379 }
00380 
00381 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a>
<a name="l00382"></a><a class="code" href="../../d0/d5/perfuser_8c.html#a26">00382</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a26">CloseUserPerformanceData</a>()
00383 <span class="comment">/*++</span>
00384 <span class="comment">Routine Description:</span>
00385 <span class="comment">    This routine closes the open handles to win32k device performance counters</span>
00386 <span class="comment"></span>
00387 <span class="comment">Arguments:</span>
00388 <span class="comment">    None.</span>
00389 <span class="comment"></span>
00390 <span class="comment">Return Value:</span>
00391 <span class="comment">    ERROR_SUCCESS</span>
00392 <span class="comment">--*/</span>
00393 
00394 {
00395     <span class="keywordtype">int</span> i;
00396     <span class="keywordflow">if</span> (!(--<a class="code" href="../../d0/d5/perfuser_8c.html#a14">dwOpenCount</a>)) { <span class="comment">// when this is the last thread...</span>
00397         <a class="code" href="../../d2/d5/perfutil_8c.html#a18">MonCloseEventLog</a>();
00398     }
00399     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a13">gpdwResult</a>)
00400         <a class="code" href="../../d3/d5/perfutil_8h.html#a12">FREE</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a13">gpdwResult</a>);
00401     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a12">gpPid</a>)
00402         <a class="code" href="../../d3/d5/perfutil_8h.html#a12">FREE</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a12">gpPid</a>);
00403     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a10">gaInstances</a>) {
00404         <span class="keywordflow">for</span> (i = 0; i&lt;<a class="code" href="../../d0/d5/perfuser_8c.html#a11">gNumInstances</a>; i++) {
00405             <a class="code" href="../../d3/d5/perfutil_8h.html#a12">FREE</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a10">gaInstances</a>[i].pName);
00406         }
00407         <a class="code" href="../../d3/d5/perfutil_8h.html#a12">FREE</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a10">gaInstances</a>);
00408     }
00409     <span class="keywordflow">return</span> ERROR_SUCCESS;
00410 }
00411 
00412 <span class="comment">/*</span>
00413 <span class="comment"> * As PerfMon calls GlobalCollect when it first loads the DLL</span>
00414 <span class="comment"> * I will NOT call QueryUserCounters for it.</span>
00415 <span class="comment"> * This is decided by the value of startMonitoring</span>
00416 <span class="comment"> */</span>
<a name="l00417"></a><a class="code" href="../../d0/d5/perfuser_8c.html#a21">00417</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a21">GlobalCollect</a>(
00418     IN      LPWSTR  lpValueName,
00419     IN OUT  LPVOID  *lppData,
00420     IN OUT  LPDWORD lpcbTotalBytes,
00421     IN OUT  LPDWORD lpNumObjectTypes,
00422     IN      DWORD   dwQueryType)
00423 {
00424     PERF_COUNTER_BLOCK      *pPerfCounterBlock;
00425     <a class="code" href="../../d5/d4/struct__USER__DATA__DEFINITION.html">USER_DATA_DEFINITION</a>    *pUserDataDefinition;
00426     <a class="code" href="../../d7/d9/struct__CS__DATA__DEFINITION.html">CS_DATA_DEFINITION</a>      *pCSDataDefinition;
00427     <span class="keyword">static</span> <a class="code" href="../../d5/d8/struct__tagCSStatistics.html">CSSTATISTICS</a>     PrevCSStatistics;
00428     <span class="keyword">static</span> __int64          i64Frecv;
00429     PERF_INSTANCE_DEFINITION    *pPerfInstanceDefinition;
00430     PDWORD  pdwCounter;     <span class="comment">// write pointer in the lppData</span>
00431     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwTotal, dwSpaceNeeded;
00432     <span class="keywordtype">int</span>     i, counter;
00433 
00434     <span class="comment">/*</span>
00435 <span class="comment">     *  FillInstances() is quite expensive and should normally be called only</span>
00436 <span class="comment">     *  once, in OpenUserPerformanceData().  The problem is that, when monitoring</span>
00437 <span class="comment">     *  remote machines, the Open get called by screg.exe only once, no matter how</span>
00438 <span class="comment">     *  many remote "probes" are attached.  So, if there are new processes on the</span>
00439 <span class="comment">     *  target machine, they can not be seen by the probes that are added afterwards.</span>
00440 <span class="comment">     */</span>
00441     <span class="keywordflow">if</span> (dwQueryType &amp; (<a class="code" href="../../d3/d5/perfutil_8h.html#a7">QUERY_USER</a> | <a class="code" href="../../d3/d5/perfutil_8h.html#a6">QUERY_NOCOUNTERS</a>)) {
00442         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d5/perfuser_8c.html#a22">FillInstances</a>()) {
00443             *lpcbTotalBytes = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) 0;
00444             *lpNumObjectTypes = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) 0;
00445             <span class="keywordflow">return</span> ERROR_SUCCESS;
00446         }
00447     }
00448     <span class="comment">/*</span>
00449 <span class="comment">     * First make sure we have enough space</span>
00450 <span class="comment">     * If the space will not sufice, we will get called again with a larger buffer</span>
00451 <span class="comment">     */</span>
00452     dwSpaceNeeded = 0;
00453     <span class="keywordflow">if</span> (dwQueryType &amp; (<a class="code" href="../../d3/d5/perfutil_8h.html#a7">QUERY_USER</a> | <a class="code" href="../../d3/d5/perfutil_8h.html#a6">QUERY_NOCOUNTERS</a>)) {
00454         dwSpaceNeeded += (<a class="code" href="../../d0/d5/perfuser_8c.html#a11">gNumInstances</a>)*(
00455                             <span class="keyword">sizeof</span>(PERF_INSTANCE_DEFINITION) +
00456                             <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a> * <span class="keyword">sizeof</span> (WCHAR) +
00457                             <span class="keyword">sizeof</span>(PERF_COUNTER_BLOCK) + <a class="code" href="../../d9/d0/userdata_8h.html#a20">SIZE_OF_USER_PERFORMANCE_DATA</a>) +
00458                             <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d4/struct__USER__DATA__DEFINITION.html">USER_DATA_DEFINITION</a>);
00459     }
00460     <span class="keywordflow">if</span> (dwQueryType &amp; (<a class="code" href="../../d3/d5/perfutil_8h.html#a8">QUERY_CS</a> | <a class="code" href="../../d3/d5/perfutil_8h.html#a6">QUERY_NOCOUNTERS</a>)) {
00461         dwSpaceNeeded += <a class="code" href="../../d9/d0/userdata_8h.html#a25">SIZE_OF_CS_PERFORMANCE_DATA</a>
00462                         + <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d9/struct__CS__DATA__DEFINITION.html">CS_DATA_DEFINITION</a>)
00463                         + <span class="keyword">sizeof</span>(PERF_COUNTER_BLOCK);
00464     }
00465     <span class="keywordflow">if</span> (*lpcbTotalBytes &lt; dwSpaceNeeded) {
00466             *lpcbTotalBytes = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) 0;
00467             *lpNumObjectTypes = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) 0;
00468             <span class="keywordflow">return</span> ERROR_MORE_DATA;
00469     }
00470 
00471     <span class="comment">/*</span>
00472 <span class="comment">     * fill the return data</span>
00473 <span class="comment">     */</span>
00474 
00475     *lpNumObjectTypes = 0;
00476     <span class="comment">/*</span>
00477 <span class="comment">     * pUserDataDefinition also keeps track of the buffer starting point</span>
00478 <span class="comment">     */</span>
00479     pUserDataDefinition = (<a class="code" href="../../d5/d4/struct__USER__DATA__DEFINITION.html">USER_DATA_DEFINITION</a> *) *lppData;
00480     pdwCounter = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *) *lppData;
00481 
00482     <span class="keywordflow">if</span> (dwQueryType &amp; (<a class="code" href="../../d3/d5/perfutil_8h.html#a7">QUERY_USER</a> | <a class="code" href="../../d3/d5/perfutil_8h.html#a6">QUERY_NOCOUNTERS</a>)) {
00483         <span class="comment">/*</span>
00484 <span class="comment">         * USER object is requested</span>
00485 <span class="comment">         */</span>
00486         (*lpNumObjectTypes) ++;
00487 
00488         <span class="keywordflow">if</span> (dwQueryType &amp; <a class="code" href="../../d3/d5/perfutil_8h.html#a7">QUERY_USER</a>) {
00489             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(QueryUserCounters(<a class="code" href="../../d0/d5/perfuser_8c.html#a2">QUERYUSER_TYPE_USER</a>,
00490                                 <a class="code" href="../../d0/d5/perfuser_8c.html#a12">gpPid</a>, <a class="code" href="../../d0/d5/perfuser_8c.html#a11">gNumInstances</a>*<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>),
00491                                 <a class="code" href="../../d0/d5/perfuser_8c.html#a13">gpdwResult</a>, (<a class="code" href="../../d9/d0/userdata_8h.html#a21">NUM_USER_COUNTERS</a>-1)*<a class="code" href="../../d0/d5/perfuser_8c.html#a11">gNumInstances</a>*<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)))) {
00492                 *lpcbTotalBytes = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) 0;
00493                 *lpNumObjectTypes = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) 0;
00494                 <span class="keywordflow">return</span> ERROR_SUCCESS;
00495             }
00496         }
00497         <span class="keywordflow">else</span> {
00498             memset(<a class="code" href="../../d0/d5/perfuser_8c.html#a13">gpdwResult</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)*<a class="code" href="../../d0/d5/perfuser_8c.html#a11">gNumInstances</a>*<a class="code" href="../../d9/d0/userdata_8h.html#a21">NUM_USER_COUNTERS</a>);
00499         }
00500         <span class="comment">/*</span>
00501 <span class="comment">         * Copy the (constant, initialized) Object Type and counter definitions</span>
00502 <span class="comment">         * to the caller's data buffer</span>
00503 <span class="comment">         */</span>
00504         memmove(pUserDataDefinition, &amp;<a class="code" href="../../d0/d5/perfuser_8c.html#a7">UserDataDefinition</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d4/struct__USER__DATA__DEFINITION.html">USER_DATA_DEFINITION</a>));
00505         pUserDataDefinition-&gt;<a class="code" href="../../d5/d4/struct__USER__DATA__DEFINITION.html#o0">UserObjectType</a>.NumInstances = <a class="code" href="../../d0/d5/perfuser_8c.html#a11">gNumInstances</a>;
00506 
00507         pPerfInstanceDefinition = (PERF_INSTANCE_DEFINITION *) &amp;pUserDataDefinition[1];
00508         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d0/d5/perfuser_8c.html#a11">gNumInstances</a>; i++) {
00509 
00510             <span class="comment">/*</span>
00511 <span class="comment">             * Collect and format all process instances</span>
00512 <span class="comment">             */</span>
00513             pPerfInstanceDefinition-&gt;ParentObjectTitleIndex = 0;
00514             pPerfInstanceDefinition-&gt;ParentObjectInstance = 0;
00515             pPerfInstanceDefinition-&gt;UniqueID = (LONG)<a class="code" href="../../d0/d5/perfuser_8c.html#a10">gaInstances</a>[i].<a class="code" href="../../d9/d8/struct__tagInstance.html#o2">id</a>;
00516             pPerfInstanceDefinition-&gt;NameOffset = <span class="keyword">sizeof</span>(PERF_INSTANCE_DEFINITION);
00517             pPerfInstanceDefinition-&gt;NameLength = <a class="code" href="../../d0/d5/perfuser_8c.html#a10">gaInstances</a>[i].<a class="code" href="../../d9/d8/struct__tagInstance.html#o1">sizeName</a>;
00518 
00519             pPerfInstanceDefinition-&gt;ByteLength = <span class="keyword">sizeof</span>(PERF_INSTANCE_DEFINITION) +
00520                                         pPerfInstanceDefinition-&gt;NameLength;
00521 
00522             wcscpy((<span class="keywordtype">wchar_t</span>*)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pPerfInstanceDefinition + <span class="keyword">sizeof</span>(PERF_INSTANCE_DEFINITION)),
00523                     <a class="code" href="../../d0/d5/perfuser_8c.html#a10">gaInstances</a>[i].pName);
00524 
00525             pPerfCounterBlock = (PERF_COUNTER_BLOCK *) ((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pPerfInstanceDefinition
00526                                 + pPerfInstanceDefinition-&gt;ByteLength);
00527 
00528             pPerfCounterBlock-&gt;ByteLength = <a class="code" href="../../d9/d0/userdata_8h.html#a20">SIZE_OF_USER_PERFORMANCE_DATA</a>;
00529             pdwCounter = (PDWORD) (&amp;pPerfCounterBlock[1]);
00530 
00531             <span class="keywordflow">for</span> (counter = dwTotal = 0; counter&lt;<a class="code" href="../../d9/d0/userdata_8h.html#a21">NUM_USER_COUNTERS</a>-1; counter++) {
00532                 dwTotal += <a class="code" href="../../d0/d5/perfuser_8c.html#a13">gpdwResult</a>[i*(<a class="code" href="../../d9/d0/userdata_8h.html#a21">NUM_USER_COUNTERS</a>-1)+counter];
00533             }
00534             *pdwCounter++ = dwTotal;
00535             memmove(pdwCounter,  <a class="code" href="../../d0/d5/perfuser_8c.html#a13">gpdwResult</a> + i*(<a class="code" href="../../d9/d0/userdata_8h.html#a21">NUM_USER_COUNTERS</a>-1), (<a class="code" href="../../d9/d0/userdata_8h.html#a21">NUM_USER_COUNTERS</a>-1)*<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
00536             pdwCounter += <a class="code" href="../../d9/d0/userdata_8h.html#a21">NUM_USER_COUNTERS</a>-1;
00537 
00538             pPerfInstanceDefinition = (PERF_INSTANCE_DEFINITION *)pdwCounter;
00539         }
00540 
00541         ((<a class="code" href="../../d9/d0/userdata_8h.html#a27">USER_DATA_DEFINITION</a> *)*lppData)-&gt;UserObjectType.TotalByteLength =
00542                 (ULONG)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pdwCounter - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pUserDataDefinition);
00543     }
00544 
00545     <span class="keywordflow">if</span> (dwQueryType &amp; (<a class="code" href="../../d3/d5/perfutil_8h.html#a8">QUERY_CS</a> | <a class="code" href="../../d3/d5/perfutil_8h.html#a6">QUERY_NOCOUNTERS</a>)) {
00546         <span class="comment">/*</span>
00547 <span class="comment">         * CS object is requested</span>
00548 <span class="comment">         */</span>
00549         (*lpNumObjectTypes) ++;
00550 
00551         <span class="comment">/*</span>
00552 <span class="comment">         * Write CS_DATA_DEFINITION object, no instances</span>
00553 <span class="comment">         *</span>
00554 <span class="comment">         * Copy the (constant, initialized) Object Type and counter definitions</span>
00555 <span class="comment">         * to the caller's data buffer</span>
00556 <span class="comment">         */</span>
00557         pCSDataDefinition = (<a class="code" href="../../d7/d9/struct__CS__DATA__DEFINITION.html">CS_DATA_DEFINITION</a> *)pdwCounter;
00558         memmove(pCSDataDefinition, &amp;<a class="code" href="../../d0/d5/perfuser_8c.html#a8">CSDataDefinition</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d9/struct__CS__DATA__DEFINITION.html">CS_DATA_DEFINITION</a>));
00559 
00560         pPerfCounterBlock = (PERF_COUNTER_BLOCK *) &amp;pCSDataDefinition[1];
00561         pPerfCounterBlock-&gt;ByteLength = <a class="code" href="../../d9/d0/userdata_8h.html#a25">SIZE_OF_CS_PERFORMANCE_DATA</a>;
00562 
00563         pdwCounter = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *) &amp;pPerfCounterBlock[1];
00564 
00565         <span class="keywordflow">if</span> (dwQueryType &amp; <a class="code" href="../../d3/d5/perfutil_8h.html#a6">QUERY_NOCOUNTERS</a>) {
00566             memset(pdwCounter, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)*<a class="code" href="../../d9/d0/userdata_8h.html#a26">NUM_CS_COUNTERS</a>);
00567         }
00568         <span class="keywordflow">else</span> {
00569             <a class="code" href="../../d5/d8/struct__tagCSStatistics.html">CSSTATISTICS</a> CSCounters;
00570 
00571             <span class="comment">/*</span>
00572 <span class="comment">             * When entering for the first time, grab the hardware</span>
00573 <span class="comment">             * cycle counter frequency (if any)</span>
00574 <span class="comment">             */</span>
00575             <span class="keywordflow">if</span> (!PrevCSStatistics.<a class="code" href="../../d5/d8/struct__tagCSStatistics.html#o2">i64TimeExclusive</a>) {
00576 
00577                 <span class="keywordflow">if</span> (!QueryPerformanceFrequency((LARGE_INTEGER*)&amp;i64Frecv))
00578                     i64Frecv = 0;
00579             }
00580             <span class="comment">/*</span>
00581 <span class="comment">             * Retrieve the CS counters</span>
00582 <span class="comment">             */</span>
00583              <span class="keywordflow">if</span> (!QueryUserCounters(<a class="code" href="../../d0/d5/perfuser_8c.html#a3">QUERYUSER_TYPE_CS</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, &amp;CSCounters, <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d8/struct__tagCSStatistics.html">CSSTATISTICS</a>))) {
00584                 <a class="code" href="../../d8/d4/perfmsg_8h.html#a9">REPORT_ERROR</a> (USERPERF_CS_CANT_QUERY, <a class="code" href="../../d8/d4/perfmsg_8h.html#a2">LOG_USER</a>);
00585              }
00586              <span class="comment">/*</span>
00587 <span class="comment">              * In case of overflow, the error will be of 1, no big deal</span>
00588 <span class="comment">              */</span>
00589              *pdwCounter = CSCounters.<a class="code" href="../../d5/d8/struct__tagCSStatistics.html#o0">cExclusive</a> - PrevCSStatistics.<a class="code" href="../../d5/d8/struct__tagCSStatistics.html#o0">cExclusive</a>;
00590              *(pdwCounter + 1) = CSCounters.<a class="code" href="../../d5/d8/struct__tagCSStatistics.html#o1">cShared</a> - PrevCSStatistics.<a class="code" href="../../d5/d8/struct__tagCSStatistics.html#o1">cShared</a>;
00591 
00592              <span class="keywordflow">if</span> (i64Frecv) {
00593                  <span class="comment">/*</span>
00594 <span class="comment">                  * Translate the value in counts per milisecond</span>
00595 <span class="comment">                  */</span>
00596                   *(pdwCounter + 2) = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)((CSCounters.<a class="code" href="../../d5/d8/struct__tagCSStatistics.html#o2">i64TimeExclusive</a>-PrevCSStatistics.<a class="code" href="../../d5/d8/struct__tagCSStatistics.html#o2">i64TimeExclusive</a>)*1000/i64Frecv);
00597              }
00598              <span class="keywordflow">else</span> {
00599                  <span class="comment">/*</span>
00600 <span class="comment">                  * No support for high resolution timer in the hardware</span>
00601 <span class="comment">                  */</span>
00602                   *(pdwCounter + 2) = 0;
00603              }
00604 
00605              PrevCSStatistics.<a class="code" href="../../d5/d8/struct__tagCSStatistics.html#o0">cExclusive</a> = CSCounters.<a class="code" href="../../d5/d8/struct__tagCSStatistics.html#o0">cExclusive</a>;
00606              PrevCSStatistics.<a class="code" href="../../d5/d8/struct__tagCSStatistics.html#o1">cShared</a> = CSCounters.<a class="code" href="../../d5/d8/struct__tagCSStatistics.html#o1">cShared</a>;
00607              PrevCSStatistics.<a class="code" href="../../d5/d8/struct__tagCSStatistics.html#o2">i64TimeExclusive</a> = CSCounters.<a class="code" href="../../d5/d8/struct__tagCSStatistics.html#o2">i64TimeExclusive</a>;
00608         }
00609         pdwCounter += <a class="code" href="../../d9/d0/userdata_8h.html#a26">NUM_CS_COUNTERS</a>;
00610     }
00611 
00612 
00613     <span class="comment">/*</span>
00614 <span class="comment">     *  update arguments for return</span>
00615 <span class="comment">     */</span>
00616     *lpcbTotalBytes = (ULONG)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pdwCounter - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)*lppData);
00617     *lppData = (PVOID) pdwCounter;
00618 
00619     <span class="keywordflow">return</span> ERROR_SUCCESS;
00620 }
00621 
00622 
<a name="l00623"></a><a class="code" href="../../d0/d5/perfuser_8c.html#a27">00623</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a27">CleanUpInstances</a>(VOID)
00624 <span class="comment">/*++</span>
00625 <span class="comment">Routine Description:</span>
00626 <span class="comment">    Clean-up previous allocated memory</span>
00627 <span class="comment">    Helper function</span>
00628 <span class="comment"></span>
00629 <span class="comment">--*/</span>
00630 {
00631     <span class="keywordtype">int</span> i;
00632 
00633     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a10">gaInstances</a>) {
00634         <span class="keywordflow">for</span> (i = 0; i&lt;<a class="code" href="../../d0/d5/perfuser_8c.html#a11">gNumInstances</a>; i++) {
00635             <a class="code" href="../../d3/d5/perfutil_8h.html#a12">FREE</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a10">gaInstances</a>[i].pName);
00636         }
00637         <a class="code" href="../../d3/d5/perfutil_8h.html#a12">FREE</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a10">gaInstances</a>);
00638         <a class="code" href="../../d0/d5/perfuser_8c.html#a10">gaInstances</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00639     }
00640 }
00641 
<a name="l00642"></a><a class="code" href="../../d0/d5/perfuser_8c.html#a22">00642</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a22">FillInstances</a>(VOID)
00643 <span class="comment">/*++</span>
00644 <span class="comment"></span>
00645 <span class="comment">Routine Description:</span>
00646 <span class="comment">    This routine will fill the gaInstances array when the performance dll is opened</span>
00647 <span class="comment">    The data in gaInstances will be used for every Collect call</span>
00648 <span class="comment"></span>
00649 <span class="comment">Arguments:      none</span>
00650 <span class="comment"></span>
00651 <span class="comment">Return Value:   success status</span>
00652 <span class="comment"></span>
00653 <span class="comment">--*/</span>
00654 {
00655     PSYSTEM_PROCESS_INFORMATION ProcessInfo;
00656     ULONG   TotalOffset = 0, ResultLength;
00657     PWCHAR  p, pPeriod;
00658     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   status;
00659     UCHAR   *pLargeBuffer;
00660     <span class="keywordtype">int</span>     cNumAllocatedInstances;
00661     <span class="keywordtype">int</span>     i, oldInstances;
00662 
00663     oldInstances  = <a class="code" href="../../d0/d5/perfuser_8c.html#a11">gNumInstances</a>;
00664     <a class="code" href="../../d0/d5/perfuser_8c.html#a11">gNumInstances</a> = 0;
00665 
00666     <a class="code" href="../../d0/d5/perfuser_8c.html#a27">CleanUpInstances</a>();
00667 
00668     <span class="keywordflow">if</span> (!(pLargeBuffer = <a class="code" href="../../d3/d5/perfutil_8h.html#a9">ALLOC</a>(<span class="keyword">sizeof</span>(UCHAR)*64*1024))) {
00669         <a class="code" href="../../d8/d4/perfmsg_8h.html#a12">REPORT_ERROR_DATA</a> (STATUS_NO_MEMORY, <a class="code" href="../../d8/d4/perfmsg_8h.html#a2">LOG_USER</a>,
00670                     &amp;status, <span class="keyword">sizeof</span>(status));
00671         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00672     }
00673 
00674     status = <a class="code" href="../../d6/d8/sysinfo_8c.html#a49">NtQuerySystemInformation</a>(
00675                 SystemProcessInformation,
00676                 pLargeBuffer,
00677                 <span class="keyword">sizeof</span>(UCHAR)*64*1024,
00678                 &amp;ResultLength);
00679     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00680         <span class="keywordflow">goto</span> ExitNoMemory;
00681     }
00682 
00683     cNumAllocatedInstances = ResultLength/<span class="keyword">sizeof</span>(SYSTEM_PROCESS_INFORMATION);
00684     <a class="code" href="../../d0/d5/perfuser_8c.html#a10">gaInstances</a> = <a class="code" href="../../d3/d5/perfutil_8h.html#a9">ALLOC</a>(cNumAllocatedInstances*<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__tagInstance.html">ProcessInstance</a>));
00685     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d5/perfuser_8c.html#a10">gaInstances</a>) {
00686 
00687         <a class="code" href="../../d8/d4/perfmsg_8h.html#a12">REPORT_ERROR_DATA</a> (STATUS_NO_MEMORY, <a class="code" href="../../d8/d4/perfmsg_8h.html#a2">LOG_USER</a>,
00688             &amp;status, <span class="keyword">sizeof</span>(status));
00689         <span class="keywordflow">goto</span> ExitNoMemory;
00690     }
00691 
00692     <span class="comment">/*</span>
00693 <span class="comment">     * create the first instance named _All Processes so that it will usualy show</span>
00694 <span class="comment">     * the first in the list</span>
00695 <span class="comment">     */</span>
00696     <a class="code" href="../../d0/d5/perfuser_8c.html#a10">gaInstances</a>[<a class="code" href="../../d0/d5/perfuser_8c.html#a11">gNumInstances</a>].<a class="code" href="../../d9/d8/struct__tagInstance.html#o1">sizeName</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a0">ALL_PROCESSES_STRING</a>);
00697     <a class="code" href="../../d0/d5/perfuser_8c.html#a10">gaInstances</a>[<a class="code" href="../../d0/d5/perfuser_8c.html#a11">gNumInstances</a>].<a class="code" href="../../d9/d8/struct__tagInstance.html#o2">id</a> = <a class="code" href="../../d0/d5/perfuser_8c.html#a1">QUC_PID_TOTAL</a>;
00698     <a class="code" href="../../d0/d5/perfuser_8c.html#a10">gaInstances</a>[<a class="code" href="../../d0/d5/perfuser_8c.html#a11">gNumInstances</a>].<a class="code" href="../../d9/d8/struct__tagInstance.html#o0">pName</a> = <a class="code" href="../../d3/d5/perfutil_8h.html#a9">ALLOC</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a10">gaInstances</a>[<a class="code" href="../../d0/d5/perfuser_8c.html#a11">gNumInstances</a>].sizeName);
00699     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d5/perfuser_8c.html#a10">gaInstances</a>[<a class="code" href="../../d0/d5/perfuser_8c.html#a11">gNumInstances</a>].<a class="code" href="../../d9/d8/struct__tagInstance.html#o0">pName</a>) {
00700         <a class="code" href="../../d8/d4/perfmsg_8h.html#a12">REPORT_ERROR_DATA</a> (STATUS_NO_MEMORY, <a class="code" href="../../d8/d4/perfmsg_8h.html#a2">LOG_USER</a>,
00701             &amp;status, <span class="keyword">sizeof</span>(status));
00702         <span class="keywordflow">goto</span> ExitNoMemory;
00703     }
00704     wcscpy(<a class="code" href="../../d0/d5/perfuser_8c.html#a10">gaInstances</a>[<a class="code" href="../../d0/d5/perfuser_8c.html#a11">gNumInstances</a>].pName, <a class="code" href="../../d0/d5/perfuser_8c.html#a0">ALL_PROCESSES_STRING</a>);
00705     <a class="code" href="../../d0/d5/perfuser_8c.html#a11">gNumInstances</a>++;
00706 
00707     ProcessInfo = (PSYSTEM_PROCESS_INFORMATION)pLargeBuffer;
00708     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00709         <span class="keywordflow">if</span> ( ProcessInfo-&gt;ImageName.Buffer ) {
00710             p = wcsrchr(ProcessInfo-&gt;ImageName.Buffer, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>);
00711             <span class="keywordflow">if</span> ( p ) {
00712                 p++;
00713                 }
00714             <span class="keywordflow">else</span> {
00715                 p = ProcessInfo-&gt;ImageName.Buffer;
00716                 }
00717             <span class="comment">/*</span>
00718 <span class="comment">             *  remove .exe from the name</span>
00719 <span class="comment">             */</span>
00720             <span class="keywordflow">if</span> (pPeriod =  wcsrchr(p, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'.'</span>))
00721                 *pPeriod = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00722             }
00723         <span class="keywordflow">else</span> {
00724                 p = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SystemProc"</span>;
00725             }
00726         <a class="code" href="../../d0/d5/perfuser_8c.html#a10">gaInstances</a>[<a class="code" href="../../d0/d5/perfuser_8c.html#a11">gNumInstances</a>].<a class="code" href="../../d9/d8/struct__tagInstance.html#o1">sizeName</a> = wcslen(p);
00727         <span class="comment">/*</span>
00728 <span class="comment">         *  convert to bytes</span>
00729 <span class="comment">         */</span>
00730         <a class="code" href="../../d0/d5/perfuser_8c.html#a10">gaInstances</a>[<a class="code" href="../../d0/d5/perfuser_8c.html#a11">gNumInstances</a>].<a class="code" href="../../d9/d8/struct__tagInstance.html#o1">sizeName</a> = (<a class="code" href="../../d0/d5/perfuser_8c.html#a10">gaInstances</a>[<a class="code" href="../../d0/d5/perfuser_8c.html#a11">gNumInstances</a>].<a class="code" href="../../d9/d8/struct__tagInstance.html#o1">sizeName</a> + 1)
00731                                                 * <span class="keyword">sizeof</span>(WCHAR);
00732         <a class="code" href="../../d0/d5/perfuser_8c.html#a10">gaInstances</a>[<a class="code" href="../../d0/d5/perfuser_8c.html#a11">gNumInstances</a>].<a class="code" href="../../d9/d8/struct__tagInstance.html#o0">pName</a> = <a class="code" href="../../d3/d5/perfutil_8h.html#a9">ALLOC</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a10">gaInstances</a>[<a class="code" href="../../d0/d5/perfuser_8c.html#a11">gNumInstances</a>].sizeName);
00733         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d5/perfuser_8c.html#a10">gaInstances</a>[<a class="code" href="../../d0/d5/perfuser_8c.html#a11">gNumInstances</a>].<a class="code" href="../../d9/d8/struct__tagInstance.html#o0">pName</a>) {
00734             <a class="code" href="../../d8/d4/perfmsg_8h.html#a12">REPORT_ERROR_DATA</a> (STATUS_NO_MEMORY, <a class="code" href="../../d8/d4/perfmsg_8h.html#a2">LOG_USER</a>,
00735                 &amp;status, <span class="keyword">sizeof</span>(status));
00736             <span class="keywordflow">goto</span> ExitNoMemory;
00737         }
00738         wcscpy(<a class="code" href="../../d0/d5/perfuser_8c.html#a10">gaInstances</a>[<a class="code" href="../../d0/d5/perfuser_8c.html#a11">gNumInstances</a>].pName, p);
00739         <a class="code" href="../../d0/d5/perfuser_8c.html#a10">gaInstances</a>[<a class="code" href="../../d0/d5/perfuser_8c.html#a11">gNumInstances</a>].<a class="code" href="../../d9/d8/struct__tagInstance.html#o2">id</a> = (WORD)ProcessInfo-&gt;UniqueProcessId;
00740         <a class="code" href="../../d0/d5/perfuser_8c.html#a11">gNumInstances</a>++;
00741 
00742         <span class="keywordflow">if</span> (ProcessInfo-&gt;NextEntryOffset == 0) {
00743             <span class="keywordflow">break</span>;
00744         }
00745         TotalOffset += ProcessInfo-&gt;NextEntryOffset;
00746         ProcessInfo = (PSYSTEM_PROCESS_INFORMATION)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>*)pLargeBuffer + TotalOffset);
00747     }
00748 
00749     <a class="code" href="../../d3/d5/perfutil_8h.html#a12">FREE</a>(pLargeBuffer);
00750     pLargeBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00751 
00752     <span class="keywordflow">if</span> (oldInstances != <a class="code" href="../../d0/d5/perfuser_8c.html#a11">gNumInstances</a>) {
00753         <span class="comment">/*</span>
00754 <span class="comment">         *  adjust the global buffers</span>
00755 <span class="comment">         */</span>
00756         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a13">gpdwResult</a>)
00757             <a class="code" href="../../d3/d5/perfutil_8h.html#a12">FREE</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a13">gpdwResult</a>);
00758         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a12">gpPid</a>)
00759             <a class="code" href="../../d3/d5/perfutil_8h.html#a12">FREE</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a12">gpPid</a>);
00760 
00761         <span class="keywordflow">if</span> (!(<a class="code" href="../../d0/d5/perfuser_8c.html#a13">gpdwResult</a> = <a class="code" href="../../d3/d5/perfutil_8h.html#a9">ALLOC</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)*<a class="code" href="../../d0/d5/perfuser_8c.html#a11">gNumInstances</a>*<a class="code" href="../../d9/d0/userdata_8h.html#a21">NUM_USER_COUNTERS</a>))) {
00762             <a class="code" href="../../d0/d5/perfuser_8c.html#a13">gpdwResult</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00763             <span class="keywordflow">goto</span> ExitNoMemory;
00764         }
00765 
00766         <span class="keywordflow">if</span> (!(<a class="code" href="../../d0/d5/perfuser_8c.html#a12">gpPid</a> = <a class="code" href="../../d3/d5/perfutil_8h.html#a9">ALLOC</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)*<a class="code" href="../../d0/d5/perfuser_8c.html#a11">gNumInstances</a>))) {
00767             <a class="code" href="../../d0/d5/perfuser_8c.html#a12">gpPid</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00768             <span class="keywordflow">goto</span> ExitNoMemory;
00769         }
00770         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d0/d5/perfuser_8c.html#a11">gNumInstances</a>; i++) {
00771             <a class="code" href="../../d0/d5/perfuser_8c.html#a12">gpPid</a>[i] = <a class="code" href="../../d0/d5/perfuser_8c.html#a10">gaInstances</a>[i].<a class="code" href="../../d9/d8/struct__tagInstance.html#o2">id</a>;
00772         }
00773     }
00774     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00775 
00776 ExitNoMemory:
00777 
00778     <a class="code" href="../../d0/d5/perfuser_8c.html#a27">CleanUpInstances</a>();
00779 
00780     <span class="keywordflow">if</span> (pLargeBuffer) {
00781         <a class="code" href="../../d3/d5/perfutil_8h.html#a12">FREE</a>(pLargeBuffer);
00782     }
00783     <a class="code" href="../../d0/d5/perfuser_8c.html#a16">gbInitOK</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00784     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00785 
00786 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:09 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
