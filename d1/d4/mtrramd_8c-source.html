<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: mtrramd.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>mtrramd.c</h1><a href="../../d0/d5/mtrramd_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00002 
<a name="l00003"></a><a class="code" href="../../d0/d5/mtrramd_8c.html#a0">00003</a> <span class="preprocessor">#define STATIC</span>
00004 <span class="preprocessor"></span>
<a name="l00005"></a><a class="code" href="../../d0/d5/mtrramd_8c.html#a1">00005</a> <span class="preprocessor">#define IDBG    0</span>
00006 <span class="preprocessor"></span>
00007 <span class="preprocessor">#if DBG</span>
00008 <span class="preprocessor"></span><span class="preprocessor">#define DBGMSG(a)   DbgPrint(a)</span>
00009 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00010"></a><a class="code" href="../../d0/d5/mtrramd_8c.html#a2">00010</a> <span class="preprocessor"></span><span class="preprocessor">#define DBGMSG(a)</span>
00011 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00012 <span class="preprocessor"></span>
00013 <span class="comment">//</span>
00014 <span class="comment">// Externals.</span>
00015 <span class="comment">//</span>
00016 
00017 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00018 <a class="code" href="../../d0/d5/mtrramd_8c.html#a23">KiLoadMTRR</a> (
00019     PVOID Context
00020     );
00021 
00022 <span class="comment">// --- AMD Structure definitions ---</span>
00023 
00024 <span class="comment">// K6 MTRR hardware register layout.</span>
00025 
00026 <span class="comment">// Single MTRR control register.</span>
00027 
<a name="l00028"></a><a class="code" href="../../d9/d6/struct__AMDK6__MTRR.html">00028</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d9/d6/struct__AMDK6__MTRR.html">_AMDK6_MTRR</a> {
<a name="l00029"></a><a class="code" href="../../d9/d6/struct__AMDK6__MTRR.html#o0">00029</a>     ULONG       <a class="code" href="../../d9/d6/struct__AMDK6__MTRR.html#o0">type</a>:2;
<a name="l00030"></a><a class="code" href="../../d9/d6/struct__AMDK6__MTRR.html#o1">00030</a>     ULONG       <a class="code" href="../../d9/d6/struct__AMDK6__MTRR.html#o1">mask</a>:15;
<a name="l00031"></a><a class="code" href="../../d9/d6/struct__AMDK6__MTRR.html#o2">00031</a>     ULONG       <a class="code" href="../../d9/d6/struct__AMDK6__MTRR.html#o2">base</a>:15;
00032 } <a class="code" href="../../d9/d6/struct__AMDK6__MTRR.html">AMDK6_MTRR</a>, *<a class="code" href="../../d9/d6/struct__AMDK6__MTRR.html">PAMDK6_MTRR</a>;
00033 
00034 <span class="comment">// MSR image, contains two control regs.</span>
00035 
<a name="l00036"></a><a class="code" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html">00036</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html">_AMDK6_MTRR_MSR_IMAGE</a> {
00037     <span class="keyword">union </span>{
00038         <span class="keyword">struct </span>{
<a name="l00039"></a><a class="code" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html#o0">00039</a>             <a class="code" href="../../d9/d6/struct__AMDK6__MTRR.html">AMDK6_MTRR</a>    <a class="code" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html#o0">mtrr0</a>;
<a name="l00040"></a><a class="code" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html#o1">00040</a>             <a class="code" href="../../d9/d6/struct__AMDK6__MTRR.html">AMDK6_MTRR</a>    <a class="code" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html#o1">mtrr1</a>;
00041         } hw;
<a name="l00042"></a><a class="code" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html#o3">00042</a>         ULONGLONG   <a class="code" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html#o3">QuadPart</a>;
00043     } u;
00044 } <a class="code" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html">AMDK6_MTRR_MSR_IMAGE</a>, *<a class="code" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html">PAMDK6_MTRR_MSR_IMAGE</a>;
00045 
00046 <span class="comment">// MTRR reg type field values.</span>
00047 
<a name="l00048"></a><a class="code" href="../../d0/d5/mtrramd_8c.html#a3">00048</a> <span class="preprocessor">#define AMDK6_MTRR_TYPE_DISABLED    0</span>
<a name="l00049"></a><a class="code" href="../../d0/d5/mtrramd_8c.html#a4">00049</a> <span class="preprocessor"></span><span class="preprocessor">#define AMDK6_MTRR_TYPE_UC          1</span>
<a name="l00050"></a><a class="code" href="../../d0/d5/mtrramd_8c.html#a5">00050</a> <span class="preprocessor"></span><span class="preprocessor">#define AMDK6_MTRR_TYPE_WC          2</span>
<a name="l00051"></a><a class="code" href="../../d0/d5/mtrramd_8c.html#a6">00051</a> <span class="preprocessor"></span><span class="preprocessor">#define AMDK6_MTRR_TYPE_MASK        3</span>
00052 <span class="preprocessor"></span>
00053 <span class="comment">// AMD K6 MTRR MSR Index number</span>
00054 
<a name="l00055"></a><a class="code" href="../../d0/d5/mtrramd_8c.html#a7">00055</a> <span class="preprocessor">#define AMDK6_MTRR_MSR                0xC0000085</span>
00056 <span class="preprocessor"></span>
00057 <span class="comment">//</span>
00058 <span class="comment">// Region table entry - used to track all write combined regions.</span>
00059 <span class="comment">//</span>
00060 <span class="comment">// Set BaseAddress to AMDK6_REGION_UNUSED for unused entries.</span>
00061 <span class="comment">//</span>
00062 
<a name="l00063"></a><a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html">00063</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html">_AMDK6_MTRR_REGION</a> {
<a name="l00064"></a><a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o0">00064</a>     ULONG                <a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o0">BaseAddress</a>;
<a name="l00065"></a><a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o1">00065</a>     ULONG                <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
<a name="l00066"></a><a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o2">00066</a>     <a class="code" href="../../d4/d9/ke_8h.html#a156">MEMORY_CACHING_TYPE</a>  <a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o2">RegionType</a>;
<a name="l00067"></a><a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o3">00067</a>     ULONG                <a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o3">RegionFlags</a>;
00068 } <a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html">AMDK6_MTRR_REGION</a>, *<a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html">PAMDK6_MTRR_REGION</a>;
00069 
<a name="l00070"></a><a class="code" href="../../d0/d5/mtrramd_8c.html#a8">00070</a> <span class="preprocessor">#define MAX_K6_REGIONS          2               // Limit the write combined regions to 2 since that's how many MTRRs we have available.</span>
00071 <span class="preprocessor"></span>
00072 <span class="comment">//</span>
00073 <span class="comment">// Value to set base address to for unused indication.</span>
00074 <span class="comment">//</span>
00075 
<a name="l00076"></a><a class="code" href="../../d0/d5/mtrramd_8c.html#a9">00076</a> <span class="preprocessor">#define AMDK6_REGION_UNUSED     0xFFFFFFFF</span>
00077 <span class="preprocessor"></span>
00078 <span class="comment">//</span>
00079 <span class="comment">// Flag to indicate that this region was set up by the BIOS.    </span>
00080 <span class="comment">//</span>
00081 
<a name="l00082"></a><a class="code" href="../../d0/d5/mtrramd_8c.html#a10">00082</a> <span class="preprocessor">#define AMDK6_REGION_FLAGS_BIOS 0x00000001</span>
00083 <span class="preprocessor"></span>
00084 <span class="comment">//</span>
00085 <span class="comment">// Usage count for hardware MTRR registers.</span>
00086 <span class="comment">//</span>
00087 
<a name="l00088"></a><a class="code" href="../../d0/d5/mtrramd_8c.html#a11">00088</a> <span class="preprocessor">#define AMDK6_MAX_MTRR        2</span>
00089 <span class="preprocessor"></span>
00090 <span class="comment">//</span>
00091 <span class="comment">// AMD Function Prototypes.</span>
00092 <span class="comment">//</span>
00093 
00094 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00095 <a class="code" href="../../d0/d5/mtrramd_8c.html#a24">KiAmdK6InitializeMTRR</a> (
00096     VOID
00097     );
00098 
00099 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00100 <a class="code" href="../../d0/d5/mtrramd_8c.html#a25">KiAmdK6RestoreMTRR</a> (
00101     );
00102 
00103 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00104 <a class="code" href="../../d0/d5/mtrramd_8c.html#a26">KiAmdK6MtrrSetMemoryType</a> (
00105     ULONG BaseAddress,
00106     ULONG Size,
00107     MEMORY_CACHING_TYPE Type
00108     );
00109 
00110 BOOLEAN
00111 <a class="code" href="../../d0/d5/mtrramd_8c.html#a27">KiAmdK6AddRegion</a> (
00112     ULONG BaseAddress,
00113     ULONG Size,
00114     MEMORY_CACHING_TYPE Type,
00115     ULONG Flags
00116     );
00117 
00118 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00119 <a class="code" href="../../d0/d5/mtrramd_8c.html#a28">KiAmdK6MtrrCommitChanges</a> (
00120     VOID
00121     );
00122 
00123 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00124 <a class="code" href="../../d0/d5/mtrramd_8c.html#a29">KiAmdK6HandleWcRegionRequest</a> (
00125     ULONG BaseAddress,
00126     ULONG Size
00127     );
00128 
00129 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00130 <a class="code" href="../../d0/d5/mtrramd_8c.html#a30">KiAmdK6MTRRAddRegionFromHW</a> (
00131     <a class="code" href="../../d9/d6/struct__AMDK6__MTRR.html">AMDK6_MTRR</a> RegImage
00132     );
00133 
00134 <a class="code" href="../../d0/d5/mtrramd_8c.html#a17">PAMDK6_MTRR_REGION</a>
00135 <a class="code" href="../../d0/d5/mtrramd_8c.html#a31">KiAmdK6FindFreeRegion</a> (
00136 MEMORY_CACHING_TYPE Type
00137     );
00138 
00139 <span class="preprocessor">#pragma alloc_text(INIT,KiAmdK6InitializeMTRR)</span>
00140 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK,KiAmdK6RestoreMTRR)</span>
00141 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK,KiAmdK6MtrrSetMemoryType)</span>
00142 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK,KiAmdK6AddRegion)</span>
00143 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK,KiAmdK6MtrrCommitChanges)</span>
00144 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK,KiAmdK6HandleWcRegionRequest)</span>
00145 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK,KiAmdK6MTRRAddRegionFromHW)</span>
00146 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK,KiAmdK6FindFreeRegion)</span>
00147 <span class="preprocessor"></span>
00148 <span class="comment">// --- AMD Global Variables ---</span>
00149 
<a name="l00150"></a><a class="code" href="../../d0/d5/mtrramd_8c.html#a18">00150</a> <span class="keyword">extern</span> KSPIN_LOCK <a class="code" href="../../d8/d4/mtrr_8c.html#a14">KiRangeLock</a>;
00151 
00152 <span class="comment">// AmdK6Regions - Table to track wc regions.</span>
00153 
<a name="l00154"></a><a class="code" href="../../d0/d5/mtrramd_8c.html#a19">00154</a> <a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html">AMDK6_MTRR_REGION</a> <a class="code" href="../../d0/d5/mtrramd_8c.html#a19">AmdK6Regions</a>[<a class="code" href="../../d0/d5/mtrramd_8c.html#a8">MAX_K6_REGIONS</a>];
<a name="l00155"></a><a class="code" href="../../d0/d5/mtrramd_8c.html#a20">00155</a> ULONG <a class="code" href="../../d0/d5/mtrramd_8c.html#a20">AmdK6RegionCount</a>;
00156 
00157 <span class="comment">// Usage counter for hardware MTRRs.</span>
00158 
<a name="l00159"></a><a class="code" href="../../d0/d5/mtrramd_8c.html#a21">00159</a> ULONG <a class="code" href="../../d0/d5/mtrramd_8c.html#a21">AmdMtrrHwUsageCount</a>;
00160 
00161 <span class="comment">// Global variable image of MTRR MSR.</span>
00162 
<a name="l00163"></a><a class="code" href="../../d0/d5/mtrramd_8c.html#a22">00163</a> <a class="code" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html">AMDK6_MTRR_MSR_IMAGE</a>    <a class="code" href="../../d0/d5/mtrramd_8c.html#a22">KiAmdK6Mtrr</a>;
00164 
00165 <span class="comment">// --- AMD Start of code ---</span>
00166 
00167 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00168"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a52">00168</a> <a class="code" href="../../d0/d5/mtrramd_8c.html#a24">KiAmdK6InitializeMTRR</a> (
00169     VOID
00170     )
00171 {
00172     ULONG    i;
00173     KIRQL    OldIrql;
00174 
00175     <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a>(<span class="stringliteral">"KiAmdK6InitializeMTRR: Initializing K6 MTRR support\n"</span>);
00176 
00177     <a class="code" href="../../d0/d5/mtrramd_8c.html#a22">KiAmdK6Mtrr</a>.<a class="code" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html#o4">u</a>.hw.mtrr0.type = <a class="code" href="../../d0/d5/mtrramd_8c.html#a3">AMDK6_MTRR_TYPE_DISABLED</a>;
00178     <a class="code" href="../../d0/d5/mtrramd_8c.html#a22">KiAmdK6Mtrr</a>.<a class="code" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html#o4">u</a>.hw.mtrr1.type = <a class="code" href="../../d0/d5/mtrramd_8c.html#a3">AMDK6_MTRR_TYPE_DISABLED</a>;
00179     <a class="code" href="../../d0/d5/mtrramd_8c.html#a20">AmdK6RegionCount</a> = <a class="code" href="../../d0/d5/mtrramd_8c.html#a8">MAX_K6_REGIONS</a>;
00180     <a class="code" href="../../d0/d5/mtrramd_8c.html#a21">AmdMtrrHwUsageCount</a> = 0;
00181 
00182     <span class="comment">//</span>
00183     <span class="comment">// Set all regions to free.</span>
00184     <span class="comment">//</span>
00185 
00186     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d0/d5/mtrramd_8c.html#a20">AmdK6RegionCount</a>; i++) {
00187         <a class="code" href="../../d0/d5/mtrramd_8c.html#a19">AmdK6Regions</a>[i].<a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o0">BaseAddress</a> = <a class="code" href="../../d0/d5/mtrramd_8c.html#a9">AMDK6_REGION_UNUSED</a>;
00188         <a class="code" href="../../d0/d5/mtrramd_8c.html#a19">AmdK6Regions</a>[i].<a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o3">RegionFlags</a> = 0;
00189     }
00190 
00191     <span class="comment">//</span>
00192     <span class="comment">// Initialize the spin lock.</span>
00193     <span class="comment">//</span>
00194     <span class="comment">// N.B. Normally this is done by KiInitializeMTRR but that</span>
00195     <span class="comment">// routine is not called in the AMD K6 case.</span>
00196     <span class="comment">//</span>
00197 
00198     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;<a class="code" href="../../d8/d4/mtrr_8c.html#a14">KiRangeLock</a>);
00199 
00200     <span class="comment">//</span>
00201     <span class="comment">// Read the MTRR registers to see if the BIOS has set them up.</span>
00202     <span class="comment">// If so, add entries to the region table and adjust the usage</span>
00203     <span class="comment">// count.  Serialize the region table.</span>
00204     <span class="comment">//</span>
00205 
00206     <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a> (&amp;<a class="code" href="../../d8/d4/mtrr_8c.html#a14">KiRangeLock</a>, &amp;OldIrql);
00207                 
00208     <a class="code" href="../../d0/d5/mtrramd_8c.html#a22">KiAmdK6Mtrr</a>.<a class="code" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html#o4">u</a>.QuadPart = <a class="code" href="../../d5/d3/i386_8h.html#a52">RDMSR</a> (<a class="code" href="../../d0/d5/mtrramd_8c.html#a7">AMDK6_MTRR_MSR</a>);
00209 
00210     <span class="comment">//</span>
00211     <span class="comment">// Check MTRR0 first.</span>
00212     <span class="comment">//</span>
00213 
00214     <a class="code" href="../../d0/d5/mtrramd_8c.html#a30">KiAmdK6MTRRAddRegionFromHW</a>(<a class="code" href="../../d0/d5/mtrramd_8c.html#a22">KiAmdK6Mtrr</a>.<a class="code" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html#o4">u</a>.hw.mtrr0);
00215 
00216     <span class="comment">//</span>
00217     <span class="comment">// Now check MTRR1.</span>
00218     <span class="comment">//</span>
00219 
00220     <a class="code" href="../../d0/d5/mtrramd_8c.html#a30">KiAmdK6MTRRAddRegionFromHW</a>(<a class="code" href="../../d0/d5/mtrramd_8c.html#a22">KiAmdK6Mtrr</a>.<a class="code" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html#o4">u</a>.hw.mtrr1);
00221 
00222     <span class="comment">//</span>
00223     <span class="comment">// Release the locks.</span>
00224     <span class="comment">//</span>
00225 
00226     <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a> (&amp;<a class="code" href="../../d8/d4/mtrr_8c.html#a14">KiRangeLock</a>, OldIrql);
00227 }
00228 
00229 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00230"></a><a class="code" href="../../d0/d5/mtrramd_8c.html#a30">00230</a> <a class="code" href="../../d0/d5/mtrramd_8c.html#a30">KiAmdK6MTRRAddRegionFromHW</a> (
00231     <a class="code" href="../../d9/d6/struct__AMDK6__MTRR.html">AMDK6_MTRR</a> RegImage
00232     )
00233 {
00234     ULONG BaseAddress, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>, TempMask;
00235 
00236     <span class="comment">//</span>
00237     <span class="comment">// Check to see if this MTRR is enabled.</span>
00238     <span class="comment">//</span>
00239         
00240     <span class="keywordflow">if</span> (RegImage.<a class="code" href="../../d9/d6/struct__AMDK6__MTRR.html#o0">type</a> != <a class="code" href="../../d0/d5/mtrramd_8c.html#a3">AMDK6_MTRR_TYPE_DISABLED</a>) {
00241 
00242         <span class="comment">//</span>
00243         <span class="comment">// If this is a write combined region then add an entry to</span>
00244         <span class="comment">// the region table.</span>
00245         <span class="comment">//</span>
00246 
00247         <span class="keywordflow">if</span> ((RegImage.<a class="code" href="../../d9/d6/struct__AMDK6__MTRR.html#o0">type</a> &amp; <a class="code" href="../../d0/d5/mtrramd_8c.html#a4">AMDK6_MTRR_TYPE_UC</a>) == 0) {
00248 
00249             <span class="comment">//</span>
00250             <span class="comment">// Create a new resion table entry.</span>
00251             <span class="comment">//</span>
00252 
00253             BaseAddress = RegImage.<a class="code" href="../../d9/d6/struct__AMDK6__MTRR.html#o2">base</a> &lt;&lt; 17;
00254 
00255             <span class="comment">//</span>
00256             <span class="comment">// Calculate the size base on the mask value.</span>
00257             <span class="comment">//</span>
00258 
00259             TempMask = RegImage.<a class="code" href="../../d9/d6/struct__AMDK6__MTRR.html#o1">mask</a>;
00260             
00261             <span class="comment">//</span>
00262             <span class="comment">// There should never be 4GB WC region!</span>
00263             <span class="comment">//</span>
00264 
00265             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (TempMask != 0);
00266 
00267             <span class="comment">//</span>
00268             <span class="comment">// Start with 128 size and search upward.</span>
00269             <span class="comment">//</span>
00270 
00271             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 0x00020000;
00272 
00273             <span class="keywordflow">while</span> ((TempMask &amp; 0x00000001) == 0) {
00274                 TempMask &gt;&gt;= 1;
00275                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &lt;&lt;= 1;
00276             }
00277 
00278             <span class="comment">//</span>
00279             <span class="comment">// Add the region to the table.</span>
00280             <span class="comment">//</span>
00281             
00282             <a class="code" href="../../d0/d5/mtrramd_8c.html#a27">KiAmdK6AddRegion</a>(BaseAddress,
00283                              <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
00284                              <a class="code" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a>,
00285                              <a class="code" href="../../d0/d5/mtrramd_8c.html#a10">AMDK6_REGION_FLAGS_BIOS</a>);
00286 
00287             <a class="code" href="../../d0/d5/mtrramd_8c.html#a21">AmdMtrrHwUsageCount</a>++;
00288         }
00289     }
00290 }
00291 
00292 
00293 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00294"></a><a class="code" href="../../d0/d5/mtrramd_8c.html#a26">00294</a> <a class="code" href="../../d0/d5/mtrramd_8c.html#a26">KiAmdK6MtrrSetMemoryType</a> (
00295     ULONG BaseAddress,
00296     ULONG Size,
00297     MEMORY_CACHING_TYPE Type
00298     )
00299 {
00300     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00301     KIRQL       OldIrql;
00302 
00303     <span class="keywordflow">switch</span>(Type) {
00304     <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a>:
00305 
00306         <span class="comment">//</span>
00307         <span class="comment">// H/W needs updating, lock down the code required to effect</span>
00308         <span class="comment">// the change.</span>
00309         <span class="comment">//</span>
00310 
00311         <span class="keywordflow">if</span> (KeGetCurrentIrql() &gt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
00312 
00313             <span class="comment">//</span>
00314             <span class="comment">// Code can not be locked down.   Supplying a new range type</span>
00315             <span class="comment">// requires that the caller calls at irql &lt; dispatch_level.</span>
00316             <span class="comment">//</span>
00317 
00318             <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a> (<span class="stringliteral">"KeAmdK6SetPhysicalCacheTypeRange failed due to calling IRQL == DISPATCH_LEVEL\n"</span>);
00319             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00320         }
00321 
00322         <span class="comment">//</span>
00323         <span class="comment">// Lock the code.</span>
00324         <span class="comment">//</span>
00325 
00326         <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
00327         
00328         <span class="comment">//</span>
00329         <span class="comment">// Serialize the region table.</span>
00330         <span class="comment">//</span>
00331 
00332         <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a> (&amp;<a class="code" href="../../d8/d4/mtrr_8c.html#a14">KiRangeLock</a>, &amp;OldIrql);
00333 
00334         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/mtrramd_8c.html#a29">KiAmdK6HandleWcRegionRequest</a>(BaseAddress, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
00335         
00336         <span class="comment">//</span>
00337         <span class="comment">// Release the locks.</span>
00338         <span class="comment">//</span>
00339 
00340         <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a> (&amp;<a class="code" href="../../d8/d4/mtrr_8c.html#a14">KiRangeLock</a>, OldIrql);
00341         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
00342         
00343         <span class="keywordflow">break</span>;  <span class="comment">// End of WriteCombined case.</span>
00344 
00345     <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/ke_8h.html#a413a248">MmNonCached</a>:
00346 
00347         <span class="comment">//</span>
00348         <span class="comment">// Add an entry to the region table.</span>
00349         <span class="comment">//</span>
00350 
00351         <span class="comment">// Don't need to add these to the region table.  Non-cached regions are </span>
00352         <span class="comment">// accessed using a non-caching virtual pointer set up in the page tables.</span>
00353 
00354         <span class="keywordflow">break</span>;
00355 
00356     <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>:
00357 
00358         <span class="comment">//</span>
00359         <span class="comment">// Redundant.  These should be filtered out in</span>
00360         <span class="comment">// KeAmdK6SetPhysicalCacheTypeRange();</span>
00361         <span class="comment">//</span>
00362 
00363         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_SUPPORTED;
00364         <span class="keywordflow">break</span>;
00365 
00366     <span class="keywordflow">default</span>:
00367         <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a> (<span class="stringliteral">"KeAmdK6SetPhysicalCacheTypeRange: no such cache type\n"</span>);
00368         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00369         <span class="keywordflow">break</span>;
00370     }
00371     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00372 }
00373 
00374 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00375"></a><a class="code" href="../../d0/d5/mtrramd_8c.html#a29">00375</a> <a class="code" href="../../d0/d5/mtrramd_8c.html#a29">KiAmdK6HandleWcRegionRequest</a> (
00376     ULONG BaseAddress,
00377     ULONG Size
00378     )
00379 {
00380     ULONG               i;
00381     ULONG               AdjustedSize, AdjustedEndAddress, AlignmentMask;
00382     ULONG               CombinedBase, CombinedSize, CombinedAdjustedSize;
00383     <a class="code" href="../../d0/d5/mtrramd_8c.html#a17">PAMDK6_MTRR_REGION</a>  pRegion;
00384     BOOLEAN             bCanCombine, bValidRange;
00385 
00386     <span class="comment">//</span>
00387     <span class="comment">// Try and find a region that overlaps or is adjacent to the new one and</span>
00388     <span class="comment">// check to see if the combined region would be a legal mapping.</span>
00389     <span class="comment">//</span>
00390 
00391     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d0/d5/mtrramd_8c.html#a20">AmdK6RegionCount</a>; i++) {
00392         pRegion = &amp;<a class="code" href="../../d0/d5/mtrramd_8c.html#a19">AmdK6Regions</a>[i];
00393         <span class="keywordflow">if</span> ((pRegion-&gt;<a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o0">BaseAddress</a> != <a class="code" href="../../d0/d5/mtrramd_8c.html#a9">AMDK6_REGION_UNUSED</a>) &amp;&amp;
00394             (pRegion-&gt;<a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o2">RegionType</a> == <a class="code" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a>)) {
00395 
00396             <span class="comment">//</span>
00397             <span class="comment">// Does the new start address overlap or adjoin an</span>
00398             <span class="comment">// existing WC region?</span>
00399             <span class="comment">//</span>
00400 
00401             <span class="keywordflow">if</span> (((pRegion-&gt;<a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o0">BaseAddress</a> &gt;= BaseAddress) &amp;&amp;
00402                  (pRegion-&gt;<a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o0">BaseAddress</a> &lt;= (BaseAddress + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>))) ||
00403                  ((BaseAddress &lt;= (pRegion-&gt;<a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o0">BaseAddress</a> + pRegion-&gt;<a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o1">Size</a>)) &amp;&amp;
00404                   (BaseAddress &gt;= pRegion-&gt;<a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o0">BaseAddress</a>))) {
00405 
00406                 <span class="comment">//</span>
00407                 <span class="comment">// Combine the two regions into one.</span>
00408                 <span class="comment">//</span>
00409 
00410                 AdjustedEndAddress = BaseAddress + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00411 
00412                 <span class="keywordflow">if</span> (pRegion-&gt;<a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o0">BaseAddress</a> &lt; BaseAddress) {
00413                     CombinedBase = pRegion-&gt;<a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o0">BaseAddress</a>;
00414                 } <span class="keywordflow">else</span> {
00415                     CombinedBase = BaseAddress;
00416                 }
00417 
00418                 <span class="keywordflow">if</span> ((pRegion-&gt;<a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o0">BaseAddress</a> + pRegion-&gt;<a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o1">Size</a>) &gt;
00419                     AdjustedEndAddress) {
00420                     CombinedSize = (pRegion-&gt;<a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o0">BaseAddress</a> + pRegion-&gt;<a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o1">Size</a>) -
00421                            CombinedBase;
00422                 } <span class="keywordflow">else</span> {
00423                     CombinedSize = AdjustedEndAddress - CombinedBase;
00424                 }
00425 
00426                 <span class="comment">//</span>
00427                 <span class="comment">// See if the new region would be a legal mapping.</span>
00428                 <span class="comment">//</span>
00429                 <span class="comment">//</span>
00430                 <span class="comment">// Find the smallest legal size that is equal to the requested range.  Scan</span>
00431                 <span class="comment">// all ranges from 128k - 2G. (Start at 2G and work down).</span>
00432                 <span class="comment">//</span>
00433         
00434                 CombinedAdjustedSize = 0x80000000;
00435                 AlignmentMask = 0x7fffffff;
00436                 bCanCombine = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00437                 
00438                 <span class="keywordflow">while</span> (CombinedAdjustedSize &gt; 0x00010000) {
00439 
00440                     <span class="comment">//</span>
00441                     <span class="comment">// Check the size to see if it matches the requested limit.</span>
00442                     <span class="comment">//</span>
00443 
00444                     <span class="keywordflow">if</span> (CombinedAdjustedSize == CombinedSize) {
00445 
00446                         <span class="comment">//</span>
00447                         <span class="comment">// This one works.</span>
00448                         <span class="comment">// Check to see if the base address conforms to the MTRR restrictions.</span>
00449                         <span class="comment">//</span>
00450 
00451                         <span class="keywordflow">if</span> ((CombinedBase &amp; AlignmentMask) == 0) {
00452                             bCanCombine = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00453                         }
00454 
00455                         <span class="keywordflow">break</span>;
00456 
00457                     } <span class="keywordflow">else</span> {
00458 
00459                         <span class="comment">//</span>
00460                         <span class="comment">// Bump it down to the next range size and try again.</span>
00461                         <span class="comment">//</span>
00462 
00463                         CombinedAdjustedSize &gt;&gt;= 1;
00464                         AlignmentMask &gt;&gt;= 1;
00465                     }
00466                 }
00467 
00468                 <span class="keywordflow">if</span> (bCanCombine) {
00469                     <span class="comment">//</span>
00470                     <span class="comment">// If the resized range is OK, record the change in the region</span>
00471                     <span class="comment">// table and commit the changes to hardware.</span>
00472                     <span class="comment">//</span>
00473                     
00474                     pRegion-&gt;<a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o0">BaseAddress</a> = CombinedBase;
00475                     pRegion-&gt;<a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o1">Size</a> = CombinedAdjustedSize;
00476                 
00477                     <span class="comment">//</span>
00478                     <span class="comment">// Reset the BIOS flag since we now "own" this region (if we didn't already).</span>
00479                     <span class="comment">//</span>
00480                 
00481                     pRegion-&gt;<a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o3">RegionFlags</a> &amp;= ~<a class="code" href="../../d0/d5/mtrramd_8c.html#a10">AMDK6_REGION_FLAGS_BIOS</a>;
00482 
00483                     <span class="keywordflow">return</span> <a class="code" href="../../d0/d5/mtrramd_8c.html#a28">KiAmdK6MtrrCommitChanges</a>();
00484                 }
00485             }
00486         }
00487     }
00488 
00489         <span class="comment">// A valid combination could not be found, so try to create a new range for this request.</span>
00490     <span class="comment">//</span>
00491     <span class="comment">// Find the smallest legal size that is less than or equal to the requested range.  Scan</span>
00492     <span class="comment">// all ranges from 128k - 2G. (Start at 2G and work down).</span>
00493     <span class="comment">//</span>
00494         
00495     AdjustedSize = 0x80000000;
00496     AlignmentMask = 0x7fffffff;
00497     bValidRange = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00498 
00499     <span class="keywordflow">while</span> (AdjustedSize &gt; 0x00010000) {
00500 
00501         <span class="comment">//</span>
00502         <span class="comment">// Check the size to see if it matches the requested limit.</span>
00503         <span class="comment">//</span>
00504 
00505         <span class="keywordflow">if</span> (AdjustedSize == <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>) {
00506 
00507             <span class="comment">//</span>
00508             <span class="comment">// This one works.</span>
00509             <span class="comment">//</span>
00510             <span class="comment">// Check to see if the base address conforms to the MTRR restrictions.</span>
00511             <span class="comment">//</span>
00512 
00513             <span class="keywordflow">if</span> ((BaseAddress &amp; AlignmentMask) == 0) {
00514                 bValidRange = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00515             }
00516             
00517             <span class="comment">//</span>
00518             <span class="comment">// Stop looking.</span>
00519             <span class="comment">//</span>
00520             
00521             <span class="keywordflow">break</span>;
00522 
00523         } <span class="keywordflow">else</span> {
00524 
00525             <span class="comment">//</span>
00526             <span class="comment">// Bump it down to the next range size and try again.</span>
00527             <span class="comment">//</span>
00528 
00529             AdjustedSize &gt;&gt;= 1;
00530             AlignmentMask &gt;&gt;= 1;
00531         }
00532     }
00533 
00534     <span class="comment">//</span>
00535     <span class="comment">// Couldn't find a legal region that fit.</span>
00536     <span class="comment">//</span>
00537     
00538     <span class="keywordflow">if</span> (!bValidRange) {
00539         <span class="keywordflow">return</span> STATUS_NOT_SUPPORTED;
00540     }
00541     
00542     
00543     <span class="comment">//</span>
00544     <span class="comment">// If we got this far then this is a new WC region.</span>
00545     <span class="comment">// Create a new region entry for this request.</span>
00546     <span class="comment">//</span>
00547 
00548     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d5/mtrramd_8c.html#a27">KiAmdK6AddRegion</a>(BaseAddress, AdjustedSize, <a class="code" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a>, 0)) {
00549         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00550     }
00551 
00552     <span class="comment">//</span>
00553     <span class="comment">// Commit the changes to hardware.</span>
00554     <span class="comment">//</span>
00555         
00556     <span class="keywordflow">return</span> <a class="code" href="../../d0/d5/mtrramd_8c.html#a28">KiAmdK6MtrrCommitChanges</a>();
00557 }
00558 
00559 BOOLEAN
<a name="l00560"></a><a class="code" href="../../d0/d5/mtrramd_8c.html#a27">00560</a> <a class="code" href="../../d0/d5/mtrramd_8c.html#a27">KiAmdK6AddRegion</a> (
00561     ULONG BaseAddress,
00562     ULONG Size,
00563     MEMORY_CACHING_TYPE Type,
00564     ULONG Flags
00565     )
00566 {
00567     <a class="code" href="../../d0/d5/mtrramd_8c.html#a17">PAMDK6_MTRR_REGION</a> pRegion;
00568 
00569     <span class="keywordflow">if</span> ((pRegion = <a class="code" href="../../d0/d5/mtrramd_8c.html#a31">KiAmdK6FindFreeRegion</a>(Type)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00570         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00571     }
00572     pRegion-&gt;<a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o0">BaseAddress</a> = BaseAddress;
00573     pRegion-&gt;<a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o1">Size</a> = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00574     pRegion-&gt;<a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o2">RegionType</a> = Type;
00575     pRegion-&gt;<a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o3">RegionFlags</a> = Flags;
00576     
00577     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00578 }
00579 
00580 <a class="code" href="../../d0/d5/mtrramd_8c.html#a17">PAMDK6_MTRR_REGION</a>
<a name="l00581"></a><a class="code" href="../../d0/d5/mtrramd_8c.html#a31">00581</a> <a class="code" href="../../d0/d5/mtrramd_8c.html#a31">KiAmdK6FindFreeRegion</a> (
00582     MEMORY_CACHING_TYPE Type
00583     )
00584 {
00585     ULONG    i;
00586 
00587     <span class="comment">//</span>
00588     <span class="comment">// If this is a MmWriteCombined request, limit the number of</span>
00589     <span class="comment">// regions to match the actual hardware support.</span>
00590     <span class="comment">//</span>
00591 
00592     <span class="keywordflow">if</span> (Type == <a class="code" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a>) {
00593         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/mtrramd_8c.html#a21">AmdMtrrHwUsageCount</a> &gt;= <a class="code" href="../../d0/d5/mtrramd_8c.html#a11">AMDK6_MAX_MTRR</a>) {
00594 
00595             <span class="comment">//</span>
00596             <span class="comment">// Search the table to see if there are any BIOS entries</span>
00597             <span class="comment">// we can replace.</span>
00598             <span class="comment">//</span>
00599 
00600             <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d0/d5/mtrramd_8c.html#a20">AmdK6RegionCount</a>; i++) {
00601                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/mtrramd_8c.html#a19">AmdK6Regions</a>[i].<a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o3">RegionFlags</a> &amp; <a class="code" href="../../d0/d5/mtrramd_8c.html#a10">AMDK6_REGION_FLAGS_BIOS</a>) {
00602                     <span class="keywordflow">return</span> &amp;<a class="code" href="../../d0/d5/mtrramd_8c.html#a19">AmdK6Regions</a>[i];
00603                 }
00604             }
00605 
00606             <span class="comment">//</span>
00607             <span class="comment">// No free HW MTRRs and no reusable entries.</span>
00608             <span class="comment">//</span>
00609 
00610             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00611         }
00612     }
00613 
00614     <span class="comment">//</span>
00615     <span class="comment">// Find the next free region in the table.</span>
00616     <span class="comment">//</span>
00617 
00618     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d0/d5/mtrramd_8c.html#a20">AmdK6RegionCount</a>; i++) {
00619         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/mtrramd_8c.html#a19">AmdK6Regions</a>[i].<a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o0">BaseAddress</a> == <a class="code" href="../../d0/d5/mtrramd_8c.html#a9">AMDK6_REGION_UNUSED</a>) {
00620 
00621             <span class="keywordflow">if</span> (Type == <a class="code" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a>) {
00622                 <a class="code" href="../../d0/d5/mtrramd_8c.html#a21">AmdMtrrHwUsageCount</a>++;
00623             }
00624             <span class="keywordflow">return</span> &amp;<a class="code" href="../../d0/d5/mtrramd_8c.html#a19">AmdK6Regions</a>[i];
00625         }
00626     }
00627 
00628 
00629     <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a>(<span class="stringliteral">"AmdK6FindFreeRegion: Region Table is Full!\n"</span>);
00630 
00631     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00632 }
00633 
00634 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00635"></a><a class="code" href="../../d0/d5/mtrramd_8c.html#a28">00635</a> <a class="code" href="../../d0/d5/mtrramd_8c.html#a28">KiAmdK6MtrrCommitChanges</a> (
00636     VOID
00637     )
00638 
00639 <span class="comment">/*++</span>
00640 <span class="comment"></span>
00641 <span class="comment">Routine Description:</span>
00642 <span class="comment"></span>
00643 <span class="comment">    Commits the values in the table to hardware.</span>
00644 <span class="comment"></span>
00645 <span class="comment">    This procedure builds the MTRR images into the KiAmdK6Mtrr variable and</span>
00646 <span class="comment">    calls KiLoadMTRR to actually load the register.</span>
00647 <span class="comment"></span>
00648 <span class="comment">Arguments:</span>
00649 <span class="comment"></span>
00650 <span class="comment">   None.</span>
00651 <span class="comment"></span>
00652 <span class="comment">Return Value:</span>
00653 <span class="comment"></span>
00654 <span class="comment">   None.</span>
00655 <span class="comment"></span>
00656 <span class="comment">--*/</span>
00657 
00658 {
00659     ULONG    i, dwWcRangeCount = 0;
00660     ULONG    RangeTemp, RangeMask;
00661 
00662     <span class="comment">//</span>
00663     <span class="comment">// Reset the MTRR image for both MTRRs disabled.</span>
00664     <span class="comment">//</span>
00665 
00666     <a class="code" href="../../d0/d5/mtrramd_8c.html#a22">KiAmdK6Mtrr</a>.<a class="code" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html#o4">u</a>.hw.mtrr0.type = <a class="code" href="../../d0/d5/mtrramd_8c.html#a3">AMDK6_MTRR_TYPE_DISABLED</a>;
00667     <a class="code" href="../../d0/d5/mtrramd_8c.html#a22">KiAmdK6Mtrr</a>.<a class="code" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html#o4">u</a>.hw.mtrr1.type = <a class="code" href="../../d0/d5/mtrramd_8c.html#a3">AMDK6_MTRR_TYPE_DISABLED</a>;
00668 
00669     <span class="comment">//</span>
00670     <span class="comment">// Find the Write Combining Regions, if any and set up the MTRR register.</span>
00671     <span class="comment">//</span>
00672 
00673     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d0/d5/mtrramd_8c.html#a20">AmdK6RegionCount</a>; i++) {
00674 
00675         <span class="comment">//</span>
00676         <span class="comment">// Is this a valid region, and is it a write combined type?</span>
00677         <span class="comment">//</span>
00678 
00679         <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d5/mtrramd_8c.html#a19">AmdK6Regions</a>[i].<a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o0">BaseAddress</a> != <a class="code" href="../../d0/d5/mtrramd_8c.html#a9">AMDK6_REGION_UNUSED</a>) &amp;&amp;
00680             (<a class="code" href="../../d0/d5/mtrramd_8c.html#a19">AmdK6Regions</a>[i].<a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o2">RegionType</a> == <a class="code" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a>)) {
00681             
00682             <span class="comment">//</span>
00683             <span class="comment">// Calculate the correct mask for this range size.  The</span>
00684             <span class="comment">// BaseAddress and size were validated and adjusted in</span>
00685             <span class="comment">// AmdK6MtrrSetMemoryType().</span>
00686             <span class="comment">//</span>
00687             <span class="comment">// Start with 128K and scan for all legal range values and</span>
00688             <span class="comment">// build the appropriate range mask at the same time.</span>
00689             <span class="comment">//</span>
00690 
00691             RangeTemp = 0x00020000;
00692             RangeMask = 0xfffe0000;            
00693 
00694             <span class="keywordflow">while</span> (RangeTemp != 0) {
00695                 <span class="keywordflow">if</span> (RangeTemp == <a class="code" href="../../d0/d5/mtrramd_8c.html#a19">AmdK6Regions</a>[i].<a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o1">Size</a>) {
00696                     <span class="keywordflow">break</span>;
00697                 }
00698                 RangeTemp &lt;&lt;= 1;
00699                 RangeMask &lt;&lt;= 1;
00700             }
00701             <span class="keywordflow">if</span> (RangeTemp == 0) {
00702 
00703                 <span class="comment">//</span>
00704                 <span class="comment">// Not a valid range size.  This can never happen!!</span>
00705                 <span class="comment">//</span>
00706 
00707                 <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a> (<span class="stringliteral">"AmdK6MtrrCommitChanges: Bad WC range in region table!\n"</span>);
00708 
00709                 <span class="keywordflow">return</span> STATUS_NOT_SUPPORTED;
00710             }
00711 
00712             <span class="comment">//</span>
00713             <span class="comment">// Add the region to the next available register.</span>
00714             <span class="comment">//</span>
00715 
00716             <span class="keywordflow">if</span> (dwWcRangeCount == 0)  {
00717 
00718                 <a class="code" href="../../d0/d5/mtrramd_8c.html#a22">KiAmdK6Mtrr</a>.<a class="code" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html#o4">u</a>.hw.mtrr0.base = <a class="code" href="../../d0/d5/mtrramd_8c.html#a19">AmdK6Regions</a>[i].<a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o0">BaseAddress</a> &gt;&gt; 17;
00719                 <a class="code" href="../../d0/d5/mtrramd_8c.html#a22">KiAmdK6Mtrr</a>.<a class="code" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html#o4">u</a>.hw.mtrr0.mask = RangeMask &gt;&gt; 17;
00720                 <a class="code" href="../../d0/d5/mtrramd_8c.html#a22">KiAmdK6Mtrr</a>.<a class="code" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html#o4">u</a>.hw.mtrr0.type = <a class="code" href="../../d0/d5/mtrramd_8c.html#a5">AMDK6_MTRR_TYPE_WC</a>;
00721                 dwWcRangeCount++;
00722 
00723             }  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dwWcRangeCount == 1) {
00724 
00725                 <a class="code" href="../../d0/d5/mtrramd_8c.html#a22">KiAmdK6Mtrr</a>.<a class="code" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html#o4">u</a>.hw.mtrr1.base = <a class="code" href="../../d0/d5/mtrramd_8c.html#a19">AmdK6Regions</a>[i].<a class="code" href="../../d3/d7/struct__AMDK6__MTRR__REGION.html#o0">BaseAddress</a> &gt;&gt; 17;
00726                 <a class="code" href="../../d0/d5/mtrramd_8c.html#a22">KiAmdK6Mtrr</a>.<a class="code" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html#o4">u</a>.hw.mtrr1.mask = RangeMask &gt;&gt; 17;
00727                 <a class="code" href="../../d0/d5/mtrramd_8c.html#a22">KiAmdK6Mtrr</a>.<a class="code" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html#o4">u</a>.hw.mtrr1.type = <a class="code" href="../../d0/d5/mtrramd_8c.html#a5">AMDK6_MTRR_TYPE_WC</a>;
00728                 dwWcRangeCount++;
00729 
00730             } <span class="keywordflow">else</span> {
00731 
00732                 <span class="comment">//</span>
00733                 <span class="comment">// Should never happen!  This should have been caught in</span>
00734                 <span class="comment">// the calling routine.</span>
00735                 <span class="comment">//</span>
00736 
00737                 <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a> (<span class="stringliteral">"AmdK6MtrrCommitChanges: Not enough MTRR registers to satisfy region table!\n"</span>);
00738 
00739                 <span class="keywordflow">return</span> STATUS_NOT_SUPPORTED;
00740             }
00741         }
00742     }
00743 
00744     <span class="comment">//</span>
00745     <span class="comment">// Commit the changes to hardware.</span>
00746     <span class="comment">//</span>
00747 
00748     <a class="code" href="../../d0/d5/mtrramd_8c.html#a23">KiLoadMTRR</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00749 
00750     <span class="keywordflow">return</span> STATUS_SUCCESS;
00751 }
00752 
00753 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00754"></a><a class="code" href="../../d0/d5/mtrramd_8c.html#a32">00754</a> <a class="code" href="../../d0/d5/mtrramd_8c.html#a32">KiAmdK6MtrrWRMSR</a> (
00755     VOID
00756     )
00757 
00758 <span class="comment">/*++</span>
00759 <span class="comment"></span>
00760 <span class="comment">Routine Description:</span>
00761 <span class="comment"></span>
00762 <span class="comment">    Write the AMD K6 MTRRs.</span>
00763 <span class="comment"></span>
00764 <span class="comment">    Note: Access to KiAmdK6Mtrr has been synchronized around this</span>
00765 <span class="comment">    call.</span>
00766 <span class="comment"></span>
00767 <span class="comment">Arguments:</span>
00768 <span class="comment"></span>
00769 <span class="comment">    None.</span>
00770 <span class="comment"></span>
00771 <span class="comment">Return Value:</span>
00772 <span class="comment"></span>
00773 <span class="comment">    None.</span>
00774 <span class="comment"></span>
00775 <span class="comment">--*/</span>
00776 
00777 {
00778     <span class="comment">//</span>
00779     <span class="comment">// Write the MTRRs</span>
00780     <span class="comment">//</span>
00781 
00782     <a class="code" href="../../d5/d3/i386_8h.html#a53">WRMSR</a> (<a class="code" href="../../d0/d5/mtrramd_8c.html#a7">AMDK6_MTRR_MSR</a>, <a class="code" href="../../d0/d5/mtrramd_8c.html#a22">KiAmdK6Mtrr</a>.<a class="code" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html#o4">u</a>.QuadPart);
00783 }
00784 
00785 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:53 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
