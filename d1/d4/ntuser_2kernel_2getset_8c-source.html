<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: getset.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>getset.c</h1><a href="../../d0/d5/ntuser_2kernel_2getset_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: getset.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains window manager information routines</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 22-Oct-1990 MikeHar   Ported functions from Win 3.0 sources.</span>
00010 <span class="comment">* 13-Feb-1991 MikeKe    Added Revalidation code (None)</span>
00011 <span class="comment">* 08-Feb-1991 IanJa     Unicode/ANSI aware and neutral</span>
00012 <span class="comment">\***************************************************************************/</span>
00013 
00014 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00015 <span class="preprocessor">#pragma hdrstop</span>
00016 <span class="preprocessor"></span>
00017 <span class="comment">/****************************************************************************\</span>
00018 <span class="comment">* DefSetText</span>
00019 <span class="comment">*</span>
00020 <span class="comment">* Processes WM_SETTEXT messages by text-alloc'ing a string in the alternate</span>
00021 <span class="comment">* ds and setting 'hwnd-&gt;hName' to it's handle.</span>
00022 <span class="comment">*</span>
00023 <span class="comment">* History:</span>
00024 <span class="comment">* 23-Oct-1990 MikeHar   Ported from Windows.</span>
00025 <span class="comment">* 09-Nov-1990 DarrinM   Cleanup.</span>
00026 <span class="comment">\****************************************************************************/</span>
00027 
<a name="l00028"></a><a class="code" href="../../d4/d1/userk_8h.html#a1529">00028</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1529">DefSetText</a>(
00029     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>          pwnd,
00030     <a class="code" href="../../d1/d9/struct__LARGE__STRING.html">PLARGE_STRING</a> cczpstr)
00031 {
00032     <span class="comment">/*</span>
00033 <span class="comment">     * Note -- string buffer may be on client side.</span>
00034 <span class="comment">     */</span>
00035     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk;
00036     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbString;
00037     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  fTranslateOk;
00038 
00039     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || cczpstr == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || cczpstr-&gt;<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00040         pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o17">strName</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o0">Length</a> = 0;
00041         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00042     }
00043 
00044     <span class="comment">/*</span>
00045 <span class="comment">     * Capture the new window name</span>
00046 <span class="comment">     */</span>
00047     <span class="keywordflow">if</span> (cczpstr-&gt;<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o2">bAnsi</a>)
00048         cbString = (cczpstr-&gt;<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o0">Length</a> + 1) * <span class="keyword">sizeof</span>(WCHAR);
00049     <span class="keywordflow">else</span>
00050         cbString = cczpstr-&gt;<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o0">Length</a> + <span class="keyword">sizeof</span>(WCHAR);
00051 
00052     <span class="comment">/*</span>
00053 <span class="comment">     * If the current buffer is not large enough,</span>
00054 <span class="comment">     * reallocate it.</span>
00055 <span class="comment">     */</span>
00056     pdesk = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk;
00057     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o17">strName</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o1">MaximumLength</a> &lt; cbString) {
00058         <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o17">strName</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00059             <a class="code" href="../../d4/d1/userk_8h.html#a313">DesktopFree</a>(pdesk, pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o17">strName</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a>);
00060         pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o17">strName</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a> = (LPWSTR)<a class="code" href="../../d4/d1/userk_8h.html#a1020">DesktopAlloc</a>(pdesk, cbString, <a class="code" href="../../d4/d1/userk_8h.html#a305">DTAG_TEXT</a>);
00061         pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o17">strName</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o0">Length</a> = 0;
00062         <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o17">strName</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00063             pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o17">strName</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o1">MaximumLength</a> = 0;
00064             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00065         }
00066         pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o17">strName</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o1">MaximumLength</a> = cbString;
00067     }
00068 
00069     fTranslateOk = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00070     <span class="keywordflow">if</span> (cczpstr-&gt;<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o0">Length</a> != 0) {
00071         <span class="keywordflow">try</span> {
00072             <span class="keywordflow">if</span> (!cczpstr-&gt;<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o2">bAnsi</a>) {
00073                 RtlCopyMemory(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o17">strName</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a>, cczpstr-&gt;<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>, cbString);
00074             } <span class="keywordflow">else</span> {
00075                 LPCSTR ccxpszAnsi = (LPCSTR)cczpstr-&gt;<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>;
00076 
00077                 fTranslateOk = <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d9/d6/nlsxlat_8c.html#a33">RtlMultiByteToUnicodeN</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o17">strName</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a>,
00078                         cbString, &amp;cbString,
00079                         (LPSTR)ccxpszAnsi, cbString / <span class="keyword">sizeof</span>(WCHAR)));
00080             }
00081         } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
00082             pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o17">strName</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o0">Length</a> = 0;
00083             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00084         }
00085     }
00086 
00087     <span class="keywordflow">if</span> (fTranslateOk) {
00088         pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o17">strName</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o0">Length</a> = cbString - <span class="keyword">sizeof</span>(WCHAR);
00089         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00090     } <span class="keywordflow">else</span> {
00091         pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o17">strName</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o0">Length</a> = 0;
00092         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00093     }
00094 }
00095 
00096 <span class="comment">/***************************************************************************\</span>
00097 <span class="comment">* FCallerOk</span>
00098 <span class="comment">*</span>
00099 <span class="comment">* Ensures that no client stomps on server windows.</span>
00100 <span class="comment">*</span>
00101 <span class="comment">* 04-Feb-1992 ScottLu   Created.</span>
00102 <span class="comment">\***************************************************************************/</span>
00103 
<a name="l00104"></a><a class="code" href="../../d4/d1/userk_8h.html#a1435">00104</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1435">FCallerOk</a>(
00105     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00106 {
00107     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00108 
00109     <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;TIF_flags &amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a797">TIF_SYSTEMTHREAD</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a798">TIF_CSRSSTHREAD</a>)) &amp;&amp;
00110             !(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a797">TIF_SYSTEMTHREAD</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a798">TIF_CSRSSTHREAD</a>))) {
00111         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00112     }
00113 
00114     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pEThread-&gt;Cid.UniqueProcess == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a> &amp;&amp;
00115             pti-&gt;pEThread-&gt;Cid.UniqueProcess != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a>) {
00116         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00117     }
00118 
00119     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00120 }
00121 
00122 <span class="comment">/***************************************************************************\</span>
00123 <span class="comment">* _SetWindowWord (supports SetWindowWordA/W API)</span>
00124 <span class="comment">*</span>
00125 <span class="comment">* Set a window word.  Positive index values set application window words</span>
00126 <span class="comment">* while negative index values set system window words.  The negative</span>
00127 <span class="comment">* indices are published in WINDOWS.H.</span>
00128 <span class="comment">*</span>
00129 <span class="comment">* History:</span>
00130 <span class="comment">* 26-Nov-1990 DarrinM   Wrote.</span>
00131 <span class="comment">\***************************************************************************/</span>
00132 
<a name="l00133"></a><a class="code" href="../../d4/d1/userk_8h.html#a1431">00133</a> WORD <a class="code" href="../../d4/d1/userk_8h.html#a1431">_SetWindowWord</a>(
00134     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00135     <span class="keywordtype">int</span>  index,
00136     WORD value)
00137 {
00138     WORD wOld;
00139 
00140     <span class="comment">/*</span>
00141 <span class="comment">     * Don't allow setting of words belonging to a system thread if the caller</span>
00142 <span class="comment">     * is not a system thread. Same goes for winlogon.</span>
00143 <span class="comment">     */</span>
00144     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1435">FCallerOk</a>(pwnd)) {
00145         RIPERR0(ERROR_INVALID_INDEX, RIP_VERBOSE, <span class="stringliteral">""</span>);
00146         <span class="keywordflow">return</span> 0;
00147     }
00148 
00149     <span class="comment">/*</span>
00150 <span class="comment">     * Applications can not set a WORD into a dialog Proc or any of the</span>
00151 <span class="comment">     * non-public reserved bytes in DLGWINDOWEXTRA (usersrv stores pointers</span>
00152 <span class="comment">     * theres)</span>
00153 <span class="comment">     */</span>
00154     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a567">WFDIALOGWINDOW</a>)) {
00155         <span class="keywordflow">if</span>  (((index &gt;= DWLP_DLGPROC) &amp;&amp; (index &lt; DWLP_MSGRESULT)) ||
00156                 ((index &gt; DWLP_USER+<span class="keyword">sizeof</span>(LONG_PTR)-<span class="keyword">sizeof</span>(WORD)) &amp;&amp; (index &lt; DLGWINDOWEXTRA))) {
00157             RIPERR3(ERROR_INVALID_INDEX, RIP_WARNING,
00158                   <span class="stringliteral">"SetWindowWord: Trying to set WORD of a windowproc pwnd=(%#p) index=(%ld) fnid (%lX)"</span>,
00159                 pwnd, index, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)pwnd-&gt;fnid);
00160             <span class="keywordflow">return</span> 0;
00161         } <span class="keywordflow">else</span> {
00162 
00163             <span class="comment">/*</span>
00164 <span class="comment">             * If this is really a dialog and not some other server class</span>
00165 <span class="comment">             * where usersrv has stored some data (Windows Compuserve -</span>
00166 <span class="comment">             * wincim - does this) then store the data now that we have</span>
00167 <span class="comment">             * verified the index limits.</span>
00168 <span class="comment">             */</span>
00169             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwnd) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a203">FNID_DIALOG</a>)
00170                 <span class="keywordflow">goto</span> DoSetWord;
00171         }
00172     }
00173 
00174     <span class="keywordflow">if</span> (index == GWLP_USERDATA) {
00175         wOld = (WORD)pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o18">dwUserData</a>;
00176         pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o18">dwUserData</a> = MAKELONG(value, HIWORD(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o18">dwUserData</a>));
00177         <span class="keywordflow">return</span> wOld;
00178     }
00179 
00180     <span class="comment">// fix for RedShift, they call SetWindowWord</span>
00181     <span class="comment">// tn play with the low word of the style dword</span>
00182     <span class="keywordflow">if</span> (index == GWL_STYLE) {
00183         wOld = (WORD)pwnd-&gt;style;
00184         pwnd-&gt;style = MAKELONG(value, HIWORD(pwnd-&gt;style));
00185         <span class="keywordflow">return</span> wOld;
00186     }
00187 
00188     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwnd) != 0) {
00189         <span class="keywordflow">if</span> (index &gt;= 0 &amp;&amp;
00190                 (index &lt; (<span class="keywordtype">int</span>)(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a231">CBFNID</a>(pwnd-&gt;fnid)-<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagWND.html">WND</a>)))) {
00191             <span class="keywordflow">switch</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwnd)) {
00192             <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a206">FNID_MDICLIENT</a>:
00193                 <span class="keywordflow">if</span> (index == 0)
00194                     <span class="keywordflow">break</span>;
00195                 <span class="keywordflow">goto</span> DoDefault;
00196 
00197             <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a200">FNID_BUTTON</a>:
00198                 <span class="comment">/*</span>
00199 <span class="comment">                 * CorelDraw, Direct Access 1.0 and WordPerfect 6.0 do a</span>
00200 <span class="comment">                 * get/set on the first button window word.  Allow this</span>
00201 <span class="comment">                 * for compatibility.</span>
00202 <span class="comment">                 */</span>
00203                 <span class="keywordflow">if</span> (index == 0) {
00204                     <span class="comment">/*</span>
00205 <span class="comment">                     *  Since we now use a lookaside buffer for the control's</span>
00206 <span class="comment">                     *  private data, we need to indirect into this structure.</span>
00207 <span class="comment">                     */</span>
00208                     <a class="code" href="../../d2/d9/structtagBUTN.html">PBUTN</a> pbutn = ((<a class="code" href="../../d3/d9/structtagBUTNWND.html">PBUTNWND</a>)pwnd)-&gt;pbutn;
00209                     <span class="keywordflow">if</span> (!pbutn || (LONG_PTR)pbutn == (LONG_PTR)-1) {
00210                         <span class="keywordflow">return</span> 0;
00211                     } <span class="keywordflow">else</span> {
00212                         <span class="keywordflow">try</span> {
00213                             wOld = (WORD)<a class="code" href="../../d5/d8/ex_8h.html#a20">ProbeAndReadUlong</a>(&amp;pbutn-&gt;<a class="code" href="../../d2/d9/structtagBUTN.html#o1">buttonState</a>);
00214                             pbutn-&gt;<a class="code" href="../../d2/d9/structtagBUTN.html#o1">buttonState</a> = value;
00215                         } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
00216                             wOld = 0;
00217                         }
00218                         <span class="keywordflow">return</span> wOld;
00219                     }
00220                 }
00221                 <span class="keywordflow">goto</span> DoDefault;
00222 
00223             <span class="keywordflow">default</span>:
00224 DoDefault:
00225                 RIPERR3(ERROR_INVALID_INDEX,
00226                         RIP_WARNING,
00227                         <span class="stringliteral">"SetWindowWord: Trying to set private server data pwnd=(%#p) index=(%ld) fnid (%lX)"</span>,
00228                         pwnd, index, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)pwnd-&gt;fnid);
00229                 <span class="keywordflow">return</span> 0;
00230                 <span class="keywordflow">break</span>;
00231             }
00232         }
00233     }
00234 
00235 DoSetWord:
00236     <span class="keywordflow">if</span> ((index &lt; 0) || ((UINT)index + sizeof(WORD) &gt; (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o10">cbwndExtra</a>)) {
00237         RIPERR0(ERROR_INVALID_INDEX, RIP_WARNING,<span class="stringliteral">"SetWindowWord Fails because of invalid index"</span>);
00238         <span class="keywordflow">return</span> 0;
00239     } <span class="keywordflow">else</span> {
00240         WORD UNALIGNED *pw;
00241 
00242         pw = (WORD UNALIGNED *)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *)(pwnd + 1) + index);
00243         wOld = *pw;
00244         *pw = value;
00245         <span class="keywordflow">return</span> (WORD)wOld;
00246     }
00247 }
00248 
00249 <span class="comment">/***************************************************************************\</span>
00250 <span class="comment">* xxxSetWindowLong (API)</span>
00251 <span class="comment">*</span>
00252 <span class="comment">* Set a window long.  Positive index values set application window longs</span>
00253 <span class="comment">* while negative index values set system window longs.  The negative</span>
00254 <span class="comment">* indices are published in WINDOWS.H.</span>
00255 <span class="comment">*</span>
00256 <span class="comment">* History:</span>
00257 <span class="comment">* 26-Nov-1990 DarrinM   Wrote.</span>
00258 <span class="comment">\***************************************************************************/</span>
00259 
<a name="l00260"></a><a class="code" href="../../d0/d5/ntuser_2kernel_2getset_8c.html#a3">00260</a> ULONG_PTR <a class="code" href="../../d4/d1/userk_8h.html#a586">xxxSetWindowLongPtr</a>(
00261     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwnd,
00262     <span class="keywordtype">int</span>   index,
00263     ULONG_PTR dwData,
00264     BOOL  bAnsi)
00265 {
00266     ULONG_PTR dwOld;
00267     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwCPDType = 0;
00268 
00269     <span class="comment">/*</span>
00270 <span class="comment">     * Hide the window proc from other processes</span>
00271 <span class="comment">     */</span>
00272 <span class="preprocessor">#if DBG</span>
00273 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>() != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;ppi) {
00274         RIPMSG0(RIP_WARNING, <span class="stringliteral">"Setting cross process windowlong; win95 would fail"</span>);
00275     }
00276 <span class="preprocessor">#endif</span>
00277 <span class="preprocessor"></span>
00278     <span class="comment">/*</span>
00279 <span class="comment">     * CheckLock(pwnd);  The only case that leaves the critical section is</span>
00280 <span class="comment">     * where xxxSetWindowData is called, which does this.  Saves us some locks.</span>
00281 <span class="comment">     *</span>
00282 <span class="comment">     *</span>
00283 <span class="comment">     * Don't allow setting of words belonging to a system thread if the caller</span>
00284 <span class="comment">     * is not a system thread. Same goes for winlogon.</span>
00285 <span class="comment">     */</span>
00286     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1435">FCallerOk</a>(pwnd)) {
00287         RIPERR0(ERROR_INVALID_INDEX, RIP_VERBOSE, <span class="stringliteral">""</span>);
00288         <span class="keywordflow">return</span> 0;
00289     }
00290 
00291     <span class="comment">/*</span>
00292 <span class="comment">     * If it's a dialog window, only a few indices are permitted.</span>
00293 <span class="comment">     */</span>
00294     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwnd) != 0) {
00295         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a567">WFDIALOGWINDOW</a>)) {
00296             <span class="keywordflow">switch</span> (index) {
00297             <span class="keywordflow">case</span> DWLP_MSGRESULT:
00298                  dwOld = (ULONG_PTR)((<a class="code" href="../../d4/d5/struct__DIALOG.html">PDIALOG</a>)(pwnd))-&gt;resultWP;
00299                  ((<a class="code" href="../../d4/d5/struct__DIALOG.html">PDIALOG</a>)(pwnd))-&gt;resultWP = (LONG_PTR)dwData;
00300                  <span class="keywordflow">return</span> dwOld;
00301 
00302             <span class="keywordflow">case</span> DWLP_USER:
00303                  dwOld = (ULONG_PTR)((<a class="code" href="../../d4/d5/struct__DIALOG.html">PDIALOG</a>)(pwnd))-&gt;unused;
00304                  ((<a class="code" href="../../d4/d5/struct__DIALOG.html">PDIALOG</a>)(pwnd))-&gt;unused = (LONG_PTR)dwData;
00305                  <span class="keywordflow">return</span> dwOld;
00306 
00307             <span class="keywordflow">default</span>:
00308                 <span class="keywordflow">if</span> (index &gt;= 0 &amp;&amp; index &lt; DLGWINDOWEXTRA) {
00309                     RIPERR0(ERROR_PRIVATE_DIALOG_INDEX, RIP_VERBOSE, <span class="stringliteral">""</span>);
00310                     <span class="keywordflow">return</span> 0;
00311                 }
00312             }
00313         } <span class="keywordflow">else</span> {
00314             <span class="keywordflow">if</span> (index &gt;= 0 &amp;&amp;
00315                     (index &lt; (<span class="keywordtype">int</span>)(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a231">CBFNID</a>(pwnd-&gt;fnid)-<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagWND.html">WND</a>)))) {
00316                 <span class="keywordflow">switch</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwnd)) {
00317                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a200">FNID_BUTTON</a>:
00318                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a201">FNID_COMBOBOX</a>:
00319                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a202">FNID_COMBOLISTBOX</a>:
00320                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a203">FNID_DIALOG</a>:
00321                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a205">FNID_LISTBOX</a>:
00322                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a207">FNID_STATIC</a>:
00323                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a204">FNID_EDIT</a>:
00324 <span class="preprocessor">#ifdef FE_IME</span>
00325 <span class="preprocessor"></span>                <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a208">FNID_IME</a>:
00326 <span class="preprocessor">#endif</span>
00327 <span class="preprocessor"></span>                    <span class="comment">/*</span>
00328 <span class="comment">                     * Allow the 0 index for controls to be set if it's</span>
00329 <span class="comment">                     * still NULL or the window is being destroyed. This</span>
00330 <span class="comment">                     * is where controls store their private data.</span>
00331 <span class="comment">                     */</span>
00332                     <span class="keywordflow">if</span> (index == 0) {
00333                         dwOld = *((PULONG_PTR)(pwnd + 1));
00334                         <span class="keywordflow">if</span> (dwOld == 0 || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a583">WFDESTROYED</a>))
00335                             <span class="keywordflow">goto</span> SetData;
00336                     }
00337                     <span class="keywordflow">break</span>;
00338 
00339                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a206">FNID_MDICLIENT</a>:
00340                     <span class="comment">/*</span>
00341 <span class="comment">                     * Allow the 0 index (which is reserved) to be set/get.</span>
00342 <span class="comment">                     * Quattro Pro 1.0 uses this index!</span>
00343 <span class="comment">                     *</span>
00344 <span class="comment">                     * Allow the 4 index to be set if it's still NULL or</span>
00345 <span class="comment">                     * the window is being destroyed. This is where we</span>
00346 <span class="comment">                     * store our private data.</span>
00347 <span class="comment">                     */</span>
00348 <span class="preprocessor">#ifndef _WIN64</span>
00349 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (index == 0) {
00350                         <span class="keywordflow">goto</span> SetData;
00351                     }
00352 <span class="preprocessor">#endif</span>
00353 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (index == <a class="code" href="../../d1/d0/inc_2user_8h.html#a787">GWLP_MDIDATA</a>) {
00354                         dwOld = *((PULONG_PTR)(pwnd + 1));
00355                         <span class="keywordflow">if</span> (dwOld == 0 || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a583">WFDESTROYED</a>))
00356                             <span class="keywordflow">goto</span> SetData;
00357                     }
00358                     <span class="keywordflow">break</span>;
00359                 }
00360 
00361                 RIPERR3(ERROR_INVALID_INDEX,
00362                         RIP_WARNING,
00363                         <span class="stringliteral">"SetWindowLongPtr: Trying to set private server data pwnd=(%#p) index=(%ld) FNID=(%lX)"</span>,
00364                         pwnd, index, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)pwnd-&gt;fnid);
00365                 <span class="keywordflow">return</span> 0;
00366             }
00367         }
00368     }
00369 
00370     <span class="keywordflow">if</span> (index &lt; 0) {
00371         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1433">xxxSetWindowData</a>(pwnd, index, dwData, bAnsi);
00372     } <span class="keywordflow">else</span> {
00373         <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)index + <span class="keyword">sizeof</span>(ULONG_PTR) &gt; (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o10">cbwndExtra</a>) {
00374             RIPERR3(ERROR_INVALID_INDEX,
00375                     RIP_WARNING,
00376                     <span class="stringliteral">"SetWindowLongPtr: Index %d too big for cbWndExtra %d on pwnd %#p"</span>,
00377                     index, pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o10">cbwndExtra</a>, pwnd);
00378             <span class="keywordflow">return</span> 0;
00379         } <span class="keywordflow">else</span> {
00380             ULONG_PTR UNALIGNED *pudw;
00381 
00382 SetData:
00383             pudw = (ULONG_PTR UNALIGNED *)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *)(pwnd + 1) + index);
00384             dwOld = *pudw;
00385             *pudw = dwData;
00386             <span class="keywordflow">return</span> dwOld;
00387         }
00388     }
00389 }
00390 
00391 <span class="preprocessor">#ifdef _WIN64</span>
00392 <span class="preprocessor"></span><a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d1/userk_8h.html#a1432">xxxSetWindowLong</a>(
00393     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwnd,
00394     <span class="keywordtype">int</span>   index,
00395     DWORD dwData,
00396     BOOL  bAnsi)
00397 {
00398     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwOld;
00399 
00400     <span class="comment">/*</span>
00401 <span class="comment">     * Hide the window proc from other processes</span>
00402 <span class="comment">     */</span>
00403 <span class="preprocessor">#if DBG</span>
00404 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>() != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;ppi) {
00405         RIPMSG0(RIP_WARNING, <span class="stringliteral">"Setting cross process windowlong; win95 would fail"</span>);
00406     }
00407 <span class="preprocessor">#endif</span>
00408 <span class="preprocessor"></span>
00409     <span class="comment">/*</span>
00410 <span class="comment">     * CheckLock(pwnd);  The only case that leaves the critical section is</span>
00411 <span class="comment">     * where xxxSetWindowData is called, which does this.  Saves us some locks.</span>
00412 <span class="comment">     *</span>
00413 <span class="comment">     *</span>
00414 <span class="comment">     * Don't allow setting of words belonging to a system thread if the caller</span>
00415 <span class="comment">     * is not a system thread. Same goes for winlogon.</span>
00416 <span class="comment">     */</span>
00417     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1435">FCallerOk</a>(pwnd)) {
00418         RIPERR0(ERROR_INVALID_INDEX, RIP_VERBOSE, <span class="stringliteral">""</span>);
00419         <span class="keywordflow">return</span> 0;
00420     }
00421 
00422     <span class="comment">/*</span>
00423 <span class="comment">     * If it's a dialog window, only a few indices are permitted.</span>
00424 <span class="comment">     */</span>
00425     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwnd) != 0) {
00426         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFDIALOGWINDOW)) {
00427             <span class="keywordflow">switch</span> (index) {
00428             <span class="keywordflow">case</span> DWLP_MSGRESULT:
00429                  dwOld = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)((<a class="code" href="../../d4/d5/struct__DIALOG.html">PDIALOG</a>)(pwnd))-&gt;resultWP;
00430                  ((<a class="code" href="../../d4/d5/struct__DIALOG.html">PDIALOG</a>)(pwnd))-&gt;resultWP = (<span class="keywordtype">long</span>)dwData;
00431                  <span class="keywordflow">return</span> dwOld;
00432 
00433             <span class="keywordflow">case</span> DWLP_USER:
00434                  dwOld = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)((<a class="code" href="../../d4/d5/struct__DIALOG.html">PDIALOG</a>)(pwnd))-&gt;unused;
00435                  ((<a class="code" href="../../d4/d5/struct__DIALOG.html">PDIALOG</a>)(pwnd))-&gt;unused = (<span class="keywordtype">long</span>)dwData;
00436                  <span class="keywordflow">return</span> dwOld;
00437 
00438             <span class="keywordflow">default</span>:
00439                 <span class="keywordflow">if</span> (index &gt;= 0 &amp;&amp; index &lt; DLGWINDOWEXTRA) {
00440                     RIPERR0(ERROR_PRIVATE_DIALOG_INDEX, RIP_VERBOSE, <span class="stringliteral">""</span>);
00441                     <span class="keywordflow">return</span> 0;
00442                 }
00443             }
00444         } <span class="keywordflow">else</span> {
00445             <span class="keywordflow">if</span> (index &gt;= 0 &amp;&amp;
00446                     (index &lt; (<span class="keywordtype">int</span>)(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a231">CBFNID</a>(pwnd-&gt;fnid)-<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagWND.html">WND</a>)))) {
00447                 <span class="keywordflow">switch</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwnd)) {
00448                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a206">FNID_MDICLIENT</a>:
00449                     <span class="comment">/*</span>
00450 <span class="comment">                     * Allow the 0 index (which is reserved) to be set/get.</span>
00451 <span class="comment">                     * Quattro Pro 1.0 uses this index!</span>
00452 <span class="comment">                     */</span>
00453                     <span class="keywordflow">if</span> (index == 0) {
00454                         <span class="keywordflow">goto</span> SetData;
00455                     }
00456                     <span class="keywordflow">break</span>;
00457                 }
00458 
00459                 RIPERR3(ERROR_INVALID_INDEX,
00460                         RIP_WARNING,
00461                         <span class="stringliteral">"SetWindowLong: Trying to set private server data pwnd=(%#p) index=(%ld) FNID=(%lX)"</span>,
00462                         pwnd, index, (DWORD)pwnd-&gt;fnid);
00463                 <span class="keywordflow">return</span> 0;
00464             }
00465         }
00466     }
00467 
00468     <span class="keywordflow">if</span> (index &lt; 0) {
00469         <span class="keywordflow">if</span> ((index != GWL_STYLE) &amp;&amp; (index != GWL_EXSTYLE) &amp;&amp; (index != GWL_ID) &amp;&amp; (index != GWLP_USERDATA)) {
00470             RIPERR1(ERROR_INVALID_INDEX, RIP_WARNING, <span class="stringliteral">"SetWindowLong: invalid index %d"</span>, index);
00471             <span class="keywordflow">return</span> 0;
00472         }
00473         <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d4/d1/userk_8h.html#a1433">xxxSetWindowData</a>(pwnd, index, dwData, bAnsi);
00474     } <span class="keywordflow">else</span> {
00475         <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)index + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) &gt; (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o10">cbwndExtra</a>) {
00476             RIPERR3(ERROR_INVALID_INDEX,
00477                     RIP_WARNING,
00478                     <span class="stringliteral">"SetWindowLong: Index %d too big for cbWndExtra %d on pwnd %#p"</span>,
00479                     index, pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o10">cbwndExtra</a>, pwnd);
00480             <span class="keywordflow">return</span> 0;
00481         } <span class="keywordflow">else</span> {
00482             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> UNALIGNED *pudw;
00483 
00484 SetData:
00485             pudw = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> UNALIGNED *)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *)(pwnd + 1) + index);
00486             dwOld = *pudw;
00487             *pudw = dwData;
00488             <span class="keywordflow">return</span> dwOld;
00489         }
00490     }
00491 }
00492 <span class="preprocessor">#endif</span>
00493 <span class="preprocessor"></span>
00494 <span class="comment">/***************************************************************************\</span>
00495 <span class="comment">* xxxHandleOwnerSwitch</span>
00496 <span class="comment">*</span>
00497 <span class="comment">\***************************************************************************/</span>
00498 
<a name="l00499"></a><a class="code" href="../../d0/d5/ntuser_2kernel_2getset_8c.html#a4">00499</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d5/ntuser_2kernel_2getset_8c.html#a4">xxxHandleOwnerSwitch</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndNewParent, <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndOldParent)
00500 {
00501     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00502     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndNewParent);
00503     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndOldParent);
00504 
00505     <span class="keywordflow">if</span> ((pwndOldParent != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00506             (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndOldParent) != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd))) {
00507 
00508         <span class="comment">/*</span>
00509 <span class="comment">         * See if it needs to be unattached.</span>
00510 <span class="comment">         */</span>
00511         <span class="keywordflow">if</span> ((pwndNewParent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00512             (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndNewParent) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)) ||
00513             (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndNewParent) != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndOldParent))) {
00514 
00515             <a class="code" href="../../d4/d1/userk_8h.html#a1202">zzzAttachThreadInput</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndOldParent), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00516         }
00517     }
00518 
00519     <span class="comment">/*</span>
00520 <span class="comment">     * See if it needs to be attached.</span>
00521 <span class="comment">     */</span>
00522     <span class="keywordflow">if</span> ((pwndNewParent != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00523             (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndNewParent) != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)) &amp;&amp;
00524             ((pwndOldParent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00525                 (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndNewParent) != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndOldParent)))) {
00526 
00527         <a class="code" href="../../d4/d1/userk_8h.html#a1202">zzzAttachThreadInput</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndNewParent), <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00528     }
00529 
00530     <span class="comment">/*</span>
00531 <span class="comment">     * Post hook messages for tray-windows.</span>
00532 <span class="comment">     */</span>
00533     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/winloop2_8c.html#a2">IsTrayWindow</a>(pwnd)) {
00534 
00535         HWND hw = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pwnd);
00536 
00537         <span class="comment">/*</span>
00538 <span class="comment">         * If we're setting the owner and it's changing from owned</span>
00539 <span class="comment">         * to unowned or vice-versa, notify the tray.</span>
00540 <span class="comment">         */</span>
00541         <span class="keywordflow">if</span> ((pwndOldParent != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (pwndNewParent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00542             <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HSHELL_WINDOWCREATED,
00543                         (WPARAM)hw,
00544                         (LONG)0,
00545                         WH_SHELL);
00546             <a class="code" href="../../d4/d1/userk_8h.html#a1867">PostShellHookMessages</a>(HSHELL_WINDOWCREATED, (LPARAM)hw);
00547 
00548         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pwndOldParent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (pwndNewParent != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00549             <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HSHELL_WINDOWDESTROYED,
00550                         (WPARAM)hw,
00551                         (LONG)0,
00552                         WH_SHELL);
00553             <a class="code" href="../../d4/d1/userk_8h.html#a1867">PostShellHookMessages</a>(HSHELL_WINDOWDESTROYED, (LPARAM)hw);
00554         }
00555     }
00556 }
00557 
00558 <span class="comment">/***************************************************************************\</span>
00559 <span class="comment">* xxxSetWindowData</span>
00560 <span class="comment">*</span>
00561 <span class="comment">* SetWindowWord and ServerSetWindowLong are now identical routines because they</span>
00562 <span class="comment">* both can return DWORDs.  This single routine performs the work for them both.</span>
00563 <span class="comment">*</span>
00564 <span class="comment">* History:</span>
00565 <span class="comment">* 26-Nov-1990 DarrinM   Wrote.</span>
00566 <span class="comment">\***************************************************************************/</span>
00567 
<a name="l00568"></a><a class="code" href="../../d4/d1/userk_8h.html#a1433">00568</a> ULONG_PTR <a class="code" href="../../d4/d1/userk_8h.html#a1433">xxxSetWindowData</a>(
00569     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwnd,
00570     <span class="keywordtype">int</span>   index,
00571     ULONG_PTR dwData,
00572     BOOL  bAnsi)
00573 {
00574     ULONG_PTR dwT;
00575     ULONG_PTR dwOld;
00576     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenu;
00577     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  *ppwnd;
00578     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwndNewParent;
00579     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwndOldParent;
00580     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  fTopOwner;
00581     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>    tlpwndOld;
00582     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>    tlpwndNew;
00583     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwCPDType = 0;
00584 
00585     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00586     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
00587 
00588     <span class="keywordflow">switch</span> (index) {
00589     <span class="keywordflow">case</span> GWLP_USERDATA:
00590         dwOld = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o18">dwUserData</a>;
00591         pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o18">dwUserData</a> = dwData;
00592         <span class="keywordflow">break</span>;
00593 
00594     <span class="keywordflow">case</span> GWL_EXSTYLE:
00595     <span class="keywordflow">case</span> GWL_STYLE:
00596         dwOld = <a class="code" href="../../d4/d1/userk_8h.html#a1434">xxxSetWindowStyle</a>(pwnd, index, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)dwData);
00597         <span class="keywordflow">break</span>;
00598 
00599     <span class="keywordflow">case</span> GWLP_ID:
00600         <span class="comment">/*</span>
00601 <span class="comment">         * Win95 does a TestWF(pwnd, WFCHILD) here, but we'll do the same</span>
00602 <span class="comment">         * check we do everywhere else or it'll cause us trouble.</span>
00603 <span class="comment">         */</span>
00604         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwnd)) {
00605 
00606             <span class="comment">/*</span>
00607 <span class="comment">             * pwnd-&gt;spmenu is an id in this case.</span>
00608 <span class="comment">             */</span>
00609             dwOld = (ULONG_PTR)pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>;
00610             pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a> = (<span class="keyword">struct </span><a class="code" href="../../d1/d1/structtagMENU.html">tagMENU</a> *)dwData;
00611         } <span class="keywordflow">else</span> {
00612             dwOld = 0;
00613             <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00614                 dwOld = (ULONG_PTR)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>);
00615 
00616             <span class="keywordflow">if</span> (dwData == 0) {
00617                 <a class="code" href="../../d4/d1/userk_8h.html#a1363">UnlockWndMenu</a>(pwnd, &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>);
00618             } <span class="keywordflow">else</span> {
00619                 pmenu = <a class="code" href="../../d7/d3/validate_8c.html#a9">ValidateHmenu</a>((HANDLE)dwData);
00620                 <span class="keywordflow">if</span> (pmenu != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00621                     <a class="code" href="../../d4/d1/userk_8h.html#a1362">LockWndMenu</a>(pwnd, &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>, pmenu);
00622                 } <span class="keywordflow">else</span> {
00623 
00624                     <span class="comment">/*</span>
00625 <span class="comment">                     * Menu is invalid, so don't set a new one!</span>
00626 <span class="comment">                     */</span>
00627                     dwOld = 0;
00628                 }
00629             }
00630         }
00631         <span class="keywordflow">break</span>;
00632 
00633     <span class="keywordflow">case</span> GWLP_HINSTANCE:
00634         dwOld = (ULONG_PTR)pwnd-&gt;hModule;
00635         pwnd-&gt;hModule = (HANDLE)dwData;
00636         <span class="keywordflow">break</span>;
00637 
00638     <span class="keywordflow">case</span> GWLP_WNDPROC:  <span class="comment">// See similar case DWLP_DLGPROC</span>
00639 
00640         <span class="comment">/*</span>
00641 <span class="comment">         * Hide the window proc from other processes</span>
00642 <span class="comment">         */</span>
00643         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>() != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;ppi) {
00644             RIPERR1(ERROR_ACCESS_DENIED, RIP_WARNING,
00645                 <span class="stringliteral">"SetWindowLong: Window owned by another process %#p"</span>, pwnd);
00646             <span class="keywordflow">return</span> 0;
00647         }
00648 
00649         <span class="comment">/*</span>
00650 <span class="comment">         * If the window has been zombized by a DestroyWindow but is still</span>
00651 <span class="comment">         * around because the window was locked don't let anyone change</span>
00652 <span class="comment">         * the window proc from DefWindowProc!</span>
00653 <span class="comment">         *</span>
00654 <span class="comment">         * !!! LATER long term move this test into the ValidateHWND; kind of</span>
00655 <span class="comment">         * !!! LATER close to shipping for that</span>
00656 <span class="comment">         */</span>
00657         <span class="keywordflow">if</span> (pwnd-&gt;fnid &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a227">FNID_DELETED_BIT</a>) {
00658             UserAssert(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o8">lpfnWndProc</a> == <a class="code" href="../../d8/d3/dwp_8c.html#a17">xxxDefWindowProc</a>);
00659             RIPERR1(ERROR_ACCESS_DENIED, RIP_WARNING,
00660                 <span class="stringliteral">"SetWindowLong: Window is a zombie %#p"</span>, pwnd);
00661             <span class="keywordflow">return</span> 0;
00662         }
00663 
00664         <span class="comment">/*</span>
00665 <span class="comment">         * If the application (client) subclasses a window that has a server -</span>
00666 <span class="comment">         * side window proc we must return an address that the client can call:</span>
00667 <span class="comment">         * this client-side wndproc expectes Unicode or ANSI depending on bAnsi</span>
00668 <span class="comment">         */</span>
00669 
00670         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a569">WFSERVERSIDEPROC</a>)) {
00671             dwOld = <a class="code" href="../../d2/d5/ntuser_2rtl_2getset_8c.html#a0">MapServerToClientPfn</a>((ULONG_PTR)pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o8">lpfnWndProc</a>, bAnsi);
00672 
00673             <span class="comment">/*</span>
00674 <span class="comment">             * If we don't have a client side address (like for the DDEMLMon</span>
00675 <span class="comment">             *  window) then blow off the subclassing.</span>
00676 <span class="comment">             */</span>
00677             <span class="keywordflow">if</span> (dwOld == 0) {
00678                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"SetWindowLong: subclass server only window"</span>);
00679                 <span class="keywordflow">return</span>(0);
00680             }
00681 
00682             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a569">WFSERVERSIDEPROC</a>);
00683         } <span class="keywordflow">else</span> {
00684             <span class="comment">/*</span>
00685 <span class="comment">             * Keep edit control behavior compatible with NT 3.51.</span>
00686 <span class="comment">             */</span>
00687             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwnd) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a204">FNID_EDIT</a>) {
00688                 dwOld = (ULONG_PTR)pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o8">lpfnWndProc</a>;
00689             } <span class="keywordflow">else</span> {
00690                 dwOld = <a class="code" href="../../d2/d5/ntuser_2rtl_2getset_8c.html#a1">MapClientNeuterToClientPfn</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>, (ULONG_PTR)pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o8">lpfnWndProc</a>, bAnsi);
00691             }
00692 
00693             <span class="comment">/*</span>
00694 <span class="comment">             * If the client mapping didn't change the window proc then see if</span>
00695 <span class="comment">             * we need a callproc handle.</span>
00696 <span class="comment">             */</span>
00697             <span class="keywordflow">if</span> (dwOld == (ULONG_PTR)pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o8">lpfnWndProc</a>) {
00698                 <span class="comment">/*</span>
00699 <span class="comment">                 * May need to return a CallProc handle if there is an Ansi/Unicode mismatch</span>
00700 <span class="comment">                 */</span>
00701                 <span class="keywordflow">if</span> (bAnsi != (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a570">WFANSIPROC</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00702                     dwCPDType |= bAnsi ? <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a459">CPD_ANSI_TO_UNICODE</a> : <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a460">CPD_UNICODE_TO_ANSI</a>;
00703                 }
00704             }
00705 
00706             UserAssert(!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a468">ISCPDTAG</a>(dwOld));
00707 
00708             <span class="keywordflow">if</span> (dwCPDType) {
00709                 ULONG_PTR cpd;
00710 
00711                 cpd = <a class="code" href="../../d0/d5/ntuser_2kernel_2getset_8c.html#a7">GetCPD</a>(pwnd, dwCPDType | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a463">CPD_WND</a>, dwOld);
00712 
00713                 <span class="keywordflow">if</span> (cpd) {
00714                     dwOld = cpd;
00715                 } <span class="keywordflow">else</span> {
00716                     RIPMSG0(RIP_WARNING, <span class="stringliteral">"SetWindowLong unable to alloc CPD returning handle\n"</span>);
00717                 }
00718             }
00719         }
00720 
00721         <span class="comment">/*</span>
00722 <span class="comment">         * Convert a possible CallProc Handle into a real address.  They may</span>
00723 <span class="comment">         * have kept the CallProc Handle from some previous mixed GetClassinfo</span>
00724 <span class="comment">         * or SetWindowLong.</span>
00725 <span class="comment">         *</span>
00726 <span class="comment">         * WARNING bAnsi is modified here to represent real type of</span>
00727 <span class="comment">         * proc rather than if SetWindowLongA or W was called</span>
00728 <span class="comment">         *</span>
00729 <span class="comment">         */</span>
00730         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a468">ISCPDTAG</a>(dwData)) {
00731             <a class="code" href="../../d3/d7/struct__CALLPROCDATA.html">PCALLPROCDATA</a> pCPD;
00732             <span class="keywordflow">if</span> (pCPD = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a8">HMValidateHandleNoRip</a>((HANDLE)dwData, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a243">TYPE_CALLPROC</a>)) {
00733                 dwData = pCPD-&gt;<a class="code" href="../../d3/d7/struct__CALLPROCDATA.html#o2">pfnClientPrevious</a>;
00734                 bAnsi = pCPD-&gt;<a class="code" href="../../d3/d7/struct__CALLPROCDATA.html#o3">wType</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a460">CPD_UNICODE_TO_ANSI</a>;
00735             }
00736         }
00737 
00738         <span class="comment">/*</span>
00739 <span class="comment">         * If an app 'unsubclasses' a server-side window proc we need to</span>
00740 <span class="comment">         * restore everything so SendMessage and friends know that it's</span>
00741 <span class="comment">         * a server-side proc again.  Need to check against client side</span>
00742 <span class="comment">         * stub addresses.</span>
00743 <span class="comment">         */</span>
00744         <span class="keywordflow">if</span> ((dwT = <a class="code" href="../../d4/d1/userk_8h.html#a1155">MapClientToServerPfn</a>(dwData)) != 0) {
00745             pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o8">lpfnWndProc</a> = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a988">WNDPROC_PWND</a>)dwT;
00746             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a569">WFSERVERSIDEPROC</a>);
00747             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a570">WFANSIPROC</a>);
00748         } <span class="keywordflow">else</span> {
00749             pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o8">lpfnWndProc</a> = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a988">WNDPROC_PWND</a>)<a class="code" href="../../d2/d5/ntuser_2rtl_2getset_8c.html#a1">MapClientNeuterToClientPfn</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>, dwData, bAnsi);
00750             <span class="keywordflow">if</span> (bAnsi) {
00751                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a570">WFANSIPROC</a>);
00752             } <span class="keywordflow">else</span> {
00753                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a570">WFANSIPROC</a>);
00754             }
00755 
00756             pwnd-&gt;hMod16 = <a class="code" href="../../d4/d1/userk_8h.html#a1281">xxxClientWOWGetProcModule</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o8">lpfnWndProc</a>);
00757 
00758         }
00759 
00760         <span class="keywordflow">break</span>;
00761 
00762     <span class="keywordflow">case</span> GWLP_HWNDPARENT:
00763         <span class="comment">/*</span>
00764 <span class="comment">         * Special case for pre-1.1 versions of Windows</span>
00765 <span class="comment">         * Set/GetWindowWord(GWW_HWNDPARENT) needs to be mapped</span>
00766 <span class="comment">         * to the hwndOwner for top level windows.</span>
00767 <span class="comment">         */</span>
00768         fTopOwner = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00769         <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
00770             ppwnd = &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>;
00771             fTopOwner = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00772         } <span class="keywordflow">else</span> {
00773             ppwnd = &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
00774         }
00775 
00776 
00777         <span class="comment">/*</span>
00778 <span class="comment">         * If we're a topmost, then we're only changing the owner</span>
00779 <span class="comment">         * relationship.  Otherwise, we are doing a relinking of the</span>
00780 <span class="comment">         * parent/child relationship.</span>
00781 <span class="comment">         */</span>
00782         pwndOldParent = *ppwnd;
00783         pwndNewParent = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>((HWND)dwData);
00784 
00785         <span class="keywordflow">if</span> ((pwndNewParent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; dwData) {
00786             RIPERR1(ERROR_INVALID_PARAMETER, RIP_VERBOSE, <span class="stringliteral">"Set GWL_HWNDPARENT, invalid hwndParent %#p"</span>, dwData);
00787             <span class="keywordflow">return</span> 0;
00788         }
00789 
00790         dwOld = (ULONG_PTR)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(*ppwnd);
00791 
00792         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndNewParent, &amp;tlpwndNew);
00793 
00794         <span class="keywordflow">if</span> (fTopOwner) {
00795 
00796             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndOldParent, &amp;tlpwndOld);
00797 
00798             <a class="code" href="../../d0/d5/ntuser_2kernel_2getset_8c.html#a4">xxxHandleOwnerSwitch</a>(pwnd, pwndNewParent, pwndOldParent);
00799 
00800             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a18">ValidateOwnerDepth</a>(pwnd, pwndNewParent)) {
00801 
00802                 <span class="comment">/*</span>
00803 <span class="comment">                 * Set the owner.</span>
00804 <span class="comment">                 */</span>
00805                 <span class="keywordflow">if</span> (pwndNewParent) {
00806                     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(ppwnd, pwndNewParent);
00807                 } <span class="keywordflow">else</span> {
00808                     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(ppwnd);
00809                 }
00810             } <span class="keywordflow">else</span> {
00811 
00812                 <span class="comment">/*</span>
00813 <span class="comment">                 * Undo the switch and set last error.</span>
00814 <span class="comment">                 */</span>
00815                 <a class="code" href="../../d0/d5/ntuser_2kernel_2getset_8c.html#a4">xxxHandleOwnerSwitch</a>(pwnd, pwndOldParent, pwndNewParent);
00816                 RIPERR0(ERROR_INVALID_PARAMETER, RIP_ERROR, <span class="stringliteral">"Detected loop in owner chain"</span>);
00817                 dwOld = 0;
00818             }
00819 
00820             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndOld);
00821 
00822         } <span class="keywordflow">else</span> {
00823             <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a6">xxxSetParent</a>(pwnd, pwndNewParent)) {
00824                 dwOld = 0;
00825             }
00826         }
00827 
00828         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndNew);
00829         <span class="keywordflow">break</span>;
00830 
00831     <span class="keywordflow">default</span>:
00832         RIPERR0(ERROR_INVALID_INDEX, RIP_VERBOSE, <span class="stringliteral">""</span>);
00833         <span class="keywordflow">return</span> 0;
00834     }
00835 
00836     <span class="keywordflow">return</span> dwOld;
00837 }
00838 
00839 <span class="comment">/***************************************************************************\</span>
00840 <span class="comment">* FindPCPD</span>
00841 <span class="comment">*</span>
00842 <span class="comment">* Searches the list of CallProcData's associated with window to see if</span>
00843 <span class="comment">* one already exists representing this transition.  CPD can be re-used</span>
00844 <span class="comment">* and aren't deleted until a window or thread dies</span>
00845 <span class="comment">*</span>
00846 <span class="comment">*</span>
00847 <span class="comment">* 04-Feb-1993 JohnC     Created.</span>
00848 <span class="comment">\***************************************************************************/</span>
00849 
<a name="l00850"></a><a class="code" href="../../d0/d5/ntuser_2kernel_2getset_8c.html#a6">00850</a> <a class="code" href="../../d3/d7/struct__CALLPROCDATA.html">PCALLPROCDATA</a> <a class="code" href="../../d0/d5/ntuser_2kernel_2getset_8c.html#a6">FindPCPD</a>(
00851     <a class="code" href="../../d3/d7/struct__CALLPROCDATA.html">PCALLPROCDATA</a> pCPD,
00852     ULONG_PTR      dwClientPrevious,
00853     WORD          wCPDType)
00854 {
00855     <span class="keywordflow">while</span> (pCPD) {
00856         <span class="keywordflow">if</span> ((pCPD-&gt;<a class="code" href="../../d3/d7/struct__CALLPROCDATA.html#o2">pfnClientPrevious</a> == dwClientPrevious) &amp;&amp;
00857                 (pCPD-&gt;<a class="code" href="../../d3/d7/struct__CALLPROCDATA.html#o3">wType</a> == wCPDType))
00858             <span class="keywordflow">return</span> pCPD;
00859         pCPD = pCPD-&gt;<a class="code" href="../../d3/d7/struct__CALLPROCDATA.html#o5">spcpdNext</a>;
00860     }
00861 
00862     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00863 }
00864 
00865 <span class="comment">/***************************************************************************\</span>
00866 <span class="comment">* GetCPD</span>
00867 <span class="comment">*</span>
00868 <span class="comment">* Searches the list of CallProcData's associated with a class or window</span>
00869 <span class="comment">* (if the class is not provided).  If one already exists representing this</span>
00870 <span class="comment">* transition it is returned or else a new CPD is created</span>
00871 <span class="comment">*</span>
00872 <span class="comment">* 04-Feb-1993 JohnC     Created.</span>
00873 <span class="comment">\***************************************************************************/</span>
00874 
<a name="l00875"></a><a class="code" href="../../d0/d5/ntuser_2kernel_2getset_8c.html#a7">00875</a> ULONG_PTR <a class="code" href="../../d0/d5/ntuser_2kernel_2getset_8c.html#a7">GetCPD</a>(
00876     PVOID pWndOrCls,
00877     DWORD CPDOption,
00878     ULONG_PTR dwProc32)
00879 {
00880     <a class="code" href="../../d3/d7/struct__CALLPROCDATA.html">PCALLPROCDATA</a> pCPD;
00881     <a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a>          pcls;
00882 <span class="preprocessor">#if DBG</span>
00883 <span class="preprocessor"></span>    <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>          bAnsiProc;
00884 <span class="preprocessor">#endif</span>
00885 <span class="preprocessor"></span>
00886     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
00887 
00888     <span class="keywordflow">if</span> (CPDOption &amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a463">CPD_WND</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a464">CPD_DIALOG</a>)) {
00889         UserAssert(!(CPDOption &amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a462">CPD_CLASS</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a465">CPD_WNDTOCLS</a>)));
00890         pcls = ((<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)pWndOrCls)-&gt;pcls;
00891 
00892 <span class="preprocessor">#if DBG</span>
00893 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (CPDOption &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a463">CPD_WND</a>) {
00894             bAnsiProc = !!(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pWndOrCls, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a570">WFANSIPROC</a>));
00895         } <span class="keywordflow">else</span> {
00896             <span class="comment">/*</span>
00897 <span class="comment">             * We'll assume the client-side dialog box code knows</span>
00898 <span class="comment">             * what it's doing, since we can't check it from here.</span>
00899 <span class="comment">             */</span>
00900             bAnsiProc = !!(CPDOption &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a460">CPD_UNICODE_TO_ANSI</a>);
00901         }
00902 <span class="preprocessor">#endif</span>
00903 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
00904         UserAssert(CPDOption &amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a462">CPD_CLASS</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a465">CPD_WNDTOCLS</a>));
00905         <span class="keywordflow">if</span> (CPDOption &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a465">CPD_WNDTOCLS</a>)
00906             pcls = ((<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)pWndOrCls)-&gt;pcls;
00907         <span class="keywordflow">else</span>
00908             pcls = pWndOrCls;
00909 <span class="preprocessor">#if DBG</span>
00910 <span class="preprocessor"></span>        bAnsiProc = !!(pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o7">CSF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a493">CSF_ANSIPROC</a>);
00911 <span class="preprocessor">#endif</span>
00912 <span class="preprocessor"></span>    }
00913 
00914 <span class="preprocessor">#if DBG</span>
00915 <span class="preprocessor"></span>    <span class="comment">/*</span>
00916 <span class="comment">     * We should never have a CallProc handle as the calling address</span>
00917 <span class="comment">     */</span>
00918     UserAssert(!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a468">ISCPDTAG</a>(dwProc32));
00919 
00920     <span class="keywordflow">if</span> (CPDOption &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a460">CPD_UNICODE_TO_ANSI</a>) {
00921         UserAssert(bAnsiProc);
00922     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CPDOption &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a459">CPD_ANSI_TO_UNICODE</a>) {
00923         UserAssert(!bAnsiProc);
00924     }
00925 
00926 <span class="preprocessor">#endif // DBG</span>
00927 <span class="preprocessor"></span>
00928     <span class="comment">/*</span>
00929 <span class="comment">     * See if we already have a CallProc Handle that represents this</span>
00930 <span class="comment">     * transition</span>
00931 <span class="comment">     */</span>
00932     pCPD = <a class="code" href="../../d0/d5/ntuser_2kernel_2getset_8c.html#a6">FindPCPD</a>(pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o10">spcpdFirst</a>, dwProc32, (WORD)CPDOption);
00933 
00934     <span class="keywordflow">if</span> (pCPD) {
00935         <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a467">MAKE_CPDHANDLE</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pCPD));
00936     }
00937 
00938     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00939 
00940     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00941 
00942     pCPD = <a class="code" href="../../d4/d1/userk_8h.html#a969">HMAllocObject</a>(ptiCurrent,
00943                          ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>,
00944                          <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a243">TYPE_CALLPROC</a>,
00945                          <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d7/struct__CALLPROCDATA.html">CALLPROCDATA</a>));
00946     <span class="keywordflow">if</span> (pCPD == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00947         RIPMSG0(RIP_WARNING, <span class="stringliteral">"GetCPD unable to alloc CALLPROCDATA\n"</span>);
00948         <span class="keywordflow">return</span> 0;
00949     }
00950 
00951     <span class="comment">/*</span>
00952 <span class="comment">     * Link in the new CallProcData to the class list.</span>
00953 <span class="comment">     * Note -- these pointers are locked because WOWCleanup can come in</span>
00954 <span class="comment">     * and delete objects, so we need to keep the pointers locked.</span>
00955 <span class="comment">     */</span>
00956     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pCPD-&gt;<a class="code" href="../../d3/d7/struct__CALLPROCDATA.html#o5">spcpdNext</a>, pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o10">spcpdFirst</a>);
00957     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o10">spcpdFirst</a>, pCPD);
00958 
00959     <span class="comment">/*</span>
00960 <span class="comment">     * Initialize the CPD</span>
00961 <span class="comment">     */</span>
00962     pCPD-&gt;<a class="code" href="../../d3/d7/struct__CALLPROCDATA.html#o2">pfnClientPrevious</a> = dwProc32;
00963     pCPD-&gt;<a class="code" href="../../d3/d7/struct__CALLPROCDATA.html#o3">wType</a> = (WORD)CPDOption;
00964 
00965     <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a467">MAKE_CPDHANDLE</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pCPD));
00966 }
00967 
00968 <span class="comment">/***************************************************************************\</span>
00969 <span class="comment">* MapClientToServerPfn</span>
00970 <span class="comment">*</span>
00971 <span class="comment">* Checks to see if a dword is a client wndproc stub to a server wndproc.</span>
00972 <span class="comment">* If it is, this returns the associated server side wndproc. If it isn't</span>
00973 <span class="comment">* this returns 0.</span>
00974 <span class="comment">*</span>
00975 <span class="comment">* 13-Jan-1992 ScottLu   Created.</span>
00976 <span class="comment">\***************************************************************************/</span>
00977 
<a name="l00978"></a><a class="code" href="../../d4/d1/userk_8h.html#a1155">00978</a> ULONG_PTR <a class="code" href="../../d4/d1/userk_8h.html#a1155">MapClientToServerPfn</a>(
00979     ULONG_PTR dw)
00980 {
00981     ULONG_PTR *pdw;
00982     <span class="keywordtype">int</span>   i;
00983 
00984     pdw = (ULONG_PTR *)&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o9">apfnClientW</a>;
00985     <span class="keywordflow">for</span> (i = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a192">FNID_WNDPROCSTART</a>; i &lt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a198">FNID_WNDPROCEND</a>; i++, pdw++) {
00986         <span class="keywordflow">if</span> (*pdw == dw)
00987             <span class="keywordflow">return</span> (ULONG_PTR)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a230">STOCID</a>(i);
00988     }
00989 
00990     pdw = (ULONG_PTR *)&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o8">apfnClientA</a>;
00991     <span class="keywordflow">for</span> (i = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a192">FNID_WNDPROCSTART</a>; i &lt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a198">FNID_WNDPROCEND</a>; i++, pdw++) {
00992         <span class="keywordflow">if</span> (*pdw == dw)
00993             <span class="keywordflow">return</span> (ULONG_PTR)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a230">STOCID</a>(i);
00994     }
00995 
00996     <span class="keywordflow">return</span> 0;
00997 }
00998 
<a name="l00999"></a><a class="code" href="../../d0/d5/ntuser_2kernel_2getset_8c.html#a9">00999</a> ULONG <a class="code" href="../../d0/d5/ntuser_2kernel_2getset_8c.html#a9">DBGGetWindowLong</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, <span class="keywordtype">int</span> index)
01000 {
01001     UserAssert(index &gt;= 0);
01002     UserAssert((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)index + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) &lt;= (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o10">cbwndExtra</a>);
01003     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a587">__GetWindowLong</a>(pwnd, index);
01004 }
01005 
<a name="l01006"></a><a class="code" href="../../d0/d5/ntuser_2kernel_2getset_8c.html#a10">01006</a> ULONG_PTR <a class="code" href="../../d0/d5/ntuser_2kernel_2getset_8c.html#a10">DBGGetWindowLongPtr</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, <span class="keywordtype">int</span> index)
01007 {
01008     UserAssert(index &gt;= 0);
01009     UserAssert((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)index + <span class="keyword">sizeof</span>(ULONG_PTR) &lt;= (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o10">cbwndExtra</a>);
01010     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a588">__GetWindowLongPtr</a>(pwnd, index);
01011 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:13 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
