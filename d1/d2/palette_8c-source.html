<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: palette.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>palette.c</h1><a href="../../d0/d3/palette_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************** Module Header ********************************\</span>
00002 <span class="comment">* Module Name: palette.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Palette Handling Routines</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 24-May-1993 MikeKe    From win3.1</span>
00010 <span class="comment">\***************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
00015 <span class="comment">/***************************************************************************\</span>
00016 <span class="comment">* IsTopmostRealApp</span>
00017 <span class="comment">*</span>
00018 <span class="comment">* Returns true if current process is the shell process and this window</span>
00019 <span class="comment">* is the first non-shell/user one we find in zorder.  If so, we consider</span>
00020 <span class="comment">* him to be the "palette foreground".</span>
00021 <span class="comment">*</span>
00022 <span class="comment">* History:</span>
00023 <span class="comment">\***************************************************************************/</span>
00024 
<a name="l00025"></a><a class="code" href="../../d0/d3/palette_8c.html#a0">00025</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d3/palette_8c.html#a0">IsTopmostRealApp</a>(
00026     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00027 {
00028     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>  ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00029     <a class="code" href="../../d1/d3/structtagDESKTOPINFO.html">PDESKTOPINFO</a> pdeskinfo = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk-&gt;pDeskInfo;
00030     <span class="keywordflow">if</span> ((pdeskinfo-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o5">spwndShell</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00031         (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pdeskinfo-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o5">spwndShell</a>)-&gt;pq != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>)) {
00032 
00033         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00034     }
00035 
00036     <span class="keywordflow">return</span> (pwnd == <a class="code" href="../../d4/d1/userk_8h.html#a1231">NextTopWindow</a>(ptiCurrent,
00037                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00038                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00039                                   <a class="code" href="../../d4/d1/userk_8h.html#a516">NTW_IGNORETOOLWINDOW</a>));
00040 }
00041 
00042 <span class="comment">/***************************************************************************\</span>
00043 <span class="comment">* _SelectPalette</span>
00044 <span class="comment">*</span>
00045 <span class="comment">* Selects palette into DC.  This is a wrapper to gdi where we can perform</span>
00046 <span class="comment">* checks to see if it's a foreground dc.</span>
00047 <span class="comment">*</span>
00048 <span class="comment">* History:</span>
00049 <span class="comment">\***************************************************************************/</span>
00050 
<a name="l00051"></a><a class="code" href="../../d4/d1/userk_8h.html#a1103">00051</a> HPALETTE <a class="code" href="../../d4/d1/userk_8h.html#a1103">_SelectPalette</a>(
00052     HDC      hdc,
00053     HPALETTE hpal,
00054     BOOL     fForceBackground)
00055 {
00056     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndTop;
00057     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fBackgroundPalette = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00058     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00059     <span class="comment">/*</span>
00060 <span class="comment">     * If we are not forcing palette into background, find out where it does</span>
00061 <span class="comment">     * actually belong. Don't ever select the default palette in as a</span>
00062 <span class="comment">     * foreground palette because this confuses gdi. Many apps do a</span>
00063 <span class="comment">     * (oldPal = SelectPalette) (myPal); Draw; SelectObject(oldPal).</span>
00064 <span class="comment">     * and we don't want to allow this to go through.</span>
00065 <span class="comment">     */</span>
00066     <span class="keywordflow">if</span> (!fForceBackground     &amp;&amp;
00067         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a368">TEST_PUSIF</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a364">PUSIF_PALETTEDISPLAY</a>) &amp;&amp;
00068         (hpal != GreGetStockObject(DEFAULT_PALETTE))) {
00069 
00070         <span class="keywordflow">if</span> (pwnd = <a class="code" href="../../d4/d1/userk_8h.html#a1703">WindowFromCacheDC</a>(hdc)) {
00071 
00072             <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndActive;
00073 
00074             <span class="comment">/*</span>
00075 <span class="comment">             * don't "select" palette unless on a palette device</span>
00076 <span class="comment">             */</span>
00077             pwndTop = <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a11">GetTopLevelWindow</a>(pwnd);
00078 
00079             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndTop, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a572">WFHASPALETTE</a>)) {
00080 
00081                 <span class="keywordflow">if</span> (pwndTop != <a class="code" href="../../d3/d9/client_2wow_8c.html#a3">_GetDesktopWindow</a>())
00082                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndTop)-&gt;TIF_flags |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a805">TIF_PALETTEAWARE</a>;
00083 
00084                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwndTop, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a572">WFHASPALETTE</a>);
00085             }
00086 
00087             <span class="comment">/*</span>
00088 <span class="comment">             * Hack-o-rama:</span>
00089 <span class="comment">             * Windows get foreground use of the palette if</span>
00090 <span class="comment">             *      * They are the foreground's active window</span>
00091 <span class="comment">             *      * The current process is the shell and they are the</span>
00092 <span class="comment">             * topmost valid non-toolwindow in the zorder.</span>
00093 <span class="comment">             *</span>
00094 <span class="comment">             * This makes our tray friendly on palettized displays.</span>
00095 <span class="comment">             * Currently, if you run a palette app and click on the tray,</span>
00096 <span class="comment">             * the palette app goes all weird.  Broderbund apps go</span>
00097 <span class="comment">             * completely black.  This is because they get forced to be</span>
00098 <span class="comment">             * background always, even though the shell isn't really</span>
00099 <span class="comment">             * palettized.</span>
00100 <span class="comment">             *</span>
00101 <span class="comment">             * Note: this palette architecture sucks.  Apps get forced to</span>
00102 <span class="comment">             * be background palette users even if the foreground thread</span>
00103 <span class="comment">             * couldn't care less about the palette.  Should go by zorder</span>
00104 <span class="comment">             * if so, but in a more clean way than this.</span>
00105 <span class="comment">             *</span>
00106 <span class="comment">             * We really only care about the tray &amp;&amp; the background.</span>
00107 <span class="comment">             * Cabinet dudes don't matter so much.</span>
00108 <span class="comment">             */</span>
00109             pwndActive = (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> ? <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00110 
00111 <span class="preprocessor">#if 0</span>
00112 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (pwndActive                                            &amp;&amp;
00113                 (pwndTop != pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk-&gt;pDeskInfo-&gt;spwndShell) &amp;&amp;
00114                 ((pwndActive == pwnd) || <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a16">_IsChild</a>(pwndActive, pwnd) || <a class="code" href="../../d0/d3/palette_8c.html#a0">IsTopmostRealApp</a>(pwnd)) &amp;&amp;
00115                 !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a619">WEFTOOLWINDOW</a>)) {
00116 
00117                 fBackgroundPalette = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00118             }
00119 <span class="preprocessor">#else</span>
00120 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((pwndTop != pwndTop-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk-&gt;pDeskInfo-&gt;spwnd)      &amp;&amp;
00121                 (pwndTop != pwndTop-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk-&gt;pDeskInfo-&gt;spwndShell) &amp;&amp;
00122                 (pwndActive != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)                                     &amp;&amp;
00123                 ((pwndActive == pwnd)          ||
00124                     <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a16">_IsChild</a>(pwndActive, pwnd) ||
00125                     <a class="code" href="../../d0/d3/palette_8c.html#a0">IsTopmostRealApp</a>(pwnd))                              &amp;&amp;
00126                 !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a619">WEFTOOLWINDOW</a>)) {
00127 
00128                 fBackgroundPalette = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00129             }
00130 <span class="preprocessor">#endif</span>
00131 <span class="preprocessor"></span>        }
00132     }
00133 
00134     <span class="keywordflow">return</span> GreSelectPalette(hdc, hpal, fBackgroundPalette);
00135 }
00136 
00137 <span class="comment">/***************************************************************************\</span>
00138 <span class="comment">* xxxRealizePalette</span>
00139 <span class="comment">*</span>
00140 <span class="comment">* Realizes palette to the DC.  This is a wrapper to gdi so that we can</span>
00141 <span class="comment">* check for changes prior to sending notifications.</span>
00142 <span class="comment">*</span>
00143 <span class="comment">* History:</span>
00144 <span class="comment">\***************************************************************************/</span>
00145 
<a name="l00146"></a><a class="code" href="../../d4/d1/userk_8h.html#a1104">00146</a> <span class="keywordtype">int</span> <a class="code" href="../../d4/d1/userk_8h.html#a1104">xxxRealizePalette</a>(
00147     HDC hdc)
00148 {
00149     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>           pwnd;
00150     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>          dwNumChanged;
00151     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
00152     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>       pdesk;
00153     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>             tlpwnd;
00154 
00155     dwNumChanged = GreRealizePalette(hdc);
00156 
00157     <span class="keywordflow">if</span> (HIWORD(dwNumChanged) &amp;&amp; IsDCCurrentPalette(hdc)) {
00158 
00159         pwnd = <a class="code" href="../../d4/d1/userk_8h.html#a1703">WindowFromCacheDC</a>(hdc);
00160 
00161         <span class="comment">/*</span>
00162 <span class="comment">         * if there is no associated window, don't send the palette change</span>
00163 <span class="comment">         * messages since this is a memory hdc.</span>
00164 <span class="comment">         */</span>
00165         <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00166             <span class="comment">/*</span>
00167 <span class="comment">             * Ok, send WM_PALETTECHANGED message to everyone. The wParam</span>
00168 <span class="comment">             * contains a handle to the currently active window.  Send</span>
00169 <span class="comment">             * message to the desktop also, so things on the desktop bitmap</span>
00170 <span class="comment">             * will paint ok.</span>
00171 <span class="comment">             */</span>
00172              <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwnd, &amp;tlpwnd);
00173              <a class="code" href="../../d4/d1/userk_8h.html#a1106">xxxBroadcastPaletteChanged</a>(pwnd, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00174              <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
00175 
00176             <span class="comment">/*</span>
00177 <span class="comment">             * Mark all other desktops as needing to send out</span>
00178 <span class="comment">             * WM_PALETTECHANGED messages.</span>
00179 <span class="comment">             */</span>
00180 
00181             pwinsta = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a>;
00182 
00183             <span class="keywordflow">while</span> (pwinsta != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00184                 pdesk = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a>;
00185                 <span class="keywordflow">while</span> (pdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00186                     <span class="keywordflow">if</span> (pdesk != pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk) {
00187                         pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a528">DTF_NEEDSPALETTECHANGED</a>;
00188                     }
00189                     pdesk = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o2">rpdeskNext</a>;
00190                 }
00191                 pwinsta = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o0">rpwinstaNext</a>;
00192             }
00193 
00194             GreRealizePalette(hdc);
00195         }
00196     }
00197 
00198     <span class="comment">/*</span>
00199 <span class="comment">     * Walk through the SPB list (the saved bitmaps under windows with the</span>
00200 <span class="comment">     * CS_SAVEBITS style) discarding all bitmaps</span>
00201 <span class="comment">     */</span>
00202     <span class="keywordflow">if</span> (HIWORD(dwNumChanged)) {
00203         <a class="code" href="../../d1/d4/spb_8c.html#a12">FreeAllSpbs</a>();
00204     }
00205 
00206     <span class="keywordflow">return</span> LOWORD(dwNumChanged);
00207 }
00208 
00209 <span class="comment">/***************************************************************************\</span>
00210 <span class="comment">* xxxFlushPalette</span>
00211 <span class="comment">*</span>
00212 <span class="comment">* This resets the palette and lets the next foreground app grab the</span>
00213 <span class="comment">* foreground palette.  This is called in such instances when we</span>
00214 <span class="comment">* minimize a window.</span>
00215 <span class="comment">*</span>
00216 <span class="comment">* History:</span>
00217 <span class="comment">* 31-Aug-1995  ChrisWil    Created.</span>
00218 <span class="comment">\***************************************************************************/</span>
00219 
<a name="l00220"></a><a class="code" href="../../d4/d1/userk_8h.html#a1105">00220</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1105">xxxFlushPalette</a>(
00221     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00222 {
00223     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00224     <span class="comment">/*</span>
00225 <span class="comment">     * Broadcast the palette changed messages.</span>
00226 <span class="comment">     */</span>
00227     GreRealizeDefaultPalette(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o3">hdcScreen</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00228     <a class="code" href="../../d4/d1/userk_8h.html#a1106">xxxBroadcastPaletteChanged</a>(pwnd, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00229 }
00230 
00231 <span class="comment">/***************************************************************************\</span>
00232 <span class="comment">* xxxBroadcastPaletteChanged</span>
00233 <span class="comment">*</span>
00234 <span class="comment">* RealizePalette passes FALSE for fForceDesktopso so that it does not</span>
00235 <span class="comment">* cause a loop in case RealizePalette was called by the desktop window.</span>
00236 <span class="comment">* In such a case we don't want to call RealizeDesktop. In all other cases</span>
00237 <span class="comment">* we do want to go to RealizeDesktop to give the desktop a chance to</span>
00238 <span class="comment">* reailze its palette or possibly just repaint.</span>
00239 <span class="comment">*</span>
00240 <span class="comment">* 04/22/97      vadimg      created</span>
00241 <span class="comment">\***************************************************************************/</span>
00242 
<a name="l00243"></a><a class="code" href="../../d4/d1/userk_8h.html#a1106">00243</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1106">xxxBroadcastPaletteChanged</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, BOOL fForceDesktop)
00244 {
00245     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndDesk;
00246     HWND hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd);
00247 
00248     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00249 
00250     pwndDesk = <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd);
00251     <span class="keywordflow">if</span> (fForceDesktop || pwnd != pwndDesk) {
00252         <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndDesk;
00253         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwndDesk, &amp;tlpwndDesk);
00254         <a class="code" href="../../d4/d1/userk_8h.html#a1806">xxxRealizeDesktop</a>(pwndDesk);
00255         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndDesk);
00256     }
00257 
00258     <a class="code" href="../../d4/d1/userk_8h.html#a1581">xxxSendNotifyMessage</a>(<a class="code" href="../../d4/d1/userk_8h.html#a457">PWND_BROADCAST</a>, WM_PALETTECHANGED, (WPARAM)hwnd, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00259 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:08 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
