<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: rtlinit.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>rtlinit.c File Reference</h1><code>#include "<a class="el" href="../../d8/d2/w32_2ntuser_2client_2precomp_8h-source.html">precomp.h</a>"</code><br>
<code>#include "ntimage.h"</code><br>

<p>
<a href="../../d2/d1/rtlinit_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/rtlinit_8c.html#a0">MOVE_TO_RTL</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/rtlinit_8c.html#a1">AllocateFromZone</a>(Zone)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/rtlinit_8c.html#a2">FreeToZone</a>(Zone, Block)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/rtlinit_8c.html#a3">RtlCaptureAnsiString</a> (<a class="el" href="../../d8/d1/struct__IN__STRING.html">PIN_STRING</a> pstr, LPCSTR psz, BOOL fForceAlloc)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/rtlinit_8c.html#a4">RtlCaptureLargeAnsiString</a> (<a class="el" href="../../d8/d8/struct__LARGE__IN__STRING.html">PLARGE_IN_STRING</a> plstr, LPCSTR psz, BOOL fForceAlloc)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/rtlinit_8c.html#a5">InitLookaside</a> (<a class="el" href="../../d2/d4/struct__LOOKASIDE.html">PLOOKASIDE</a> pla, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbEntry, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cEntries)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/rtlinit_8c.html#a6">AllocLookasideEntry</a> (<a class="el" href="../../d2/d4/struct__LOOKASIDE.html">PLOOKASIDE</a> pla)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/rtlinit_8c.html#a7">FreeLookasideEntry</a> (<a class="el" href="../../d2/d4/struct__LOOKASIDE.html">PLOOKASIDE</a> pla, PVOID pEntry)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a1" doxytag="rtlinit.c::AllocateFromZone" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define AllocateFromZone          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Zone&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(PVOID)((Zone)-&gt;FreeList.Next); \
    <span class="keywordflow">if</span> ( (Zone)-&gt;FreeList.Next ) (Zone)-&gt;FreeList.Next = (Zone)-&gt;FreeList.Next-&gt;Next
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d1/rtlinit_8c-source.html#l00171">171</a> of file <a class="el" href="../../d2/d1/rtlinit_8c-source.html">rtlinit.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d1/rtlinit_8c-source.html#l00299">AllocLookasideEntry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="rtlinit.c::FreeToZone" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FreeToZone          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Zone,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Block&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>( ((PSINGLE_LIST_ENTRY)(Block))-&gt;Next = (Zone)-&gt;FreeList.Next,  \
      (Zone)-&gt;FreeList.Next = ((PSINGLE_LIST_ENTRY)(Block)),        \
      ((PSINGLE_LIST_ENTRY)(Block))-&gt;Next                           \
    )
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d1/rtlinit_8c-source.html#l00205">205</a> of file <a class="el" href="../../d2/d1/rtlinit_8c-source.html">rtlinit.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d1/rtlinit_8c-source.html#l00344">FreeLookasideEntry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="rtlinit.c::MOVE_TO_RTL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MOVE_TO_RTL          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/rtlinit_8c-source.html#l00014">14</a> of file <a class="el" href="../../d2/d1/rtlinit_8c-source.html">rtlinit.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a6" doxytag="rtlinit.c::AllocLookasideEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID AllocLookasideEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d4/struct__LOOKASIDE.html">PLOOKASIDE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pla</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/rtlinit_8c-source.html#l00299">299</a> of file <a class="el" href="../../d2/d1/rtlinit_8c-source.html">rtlinit.c</a>.
<p>
References <a class="el" href="../../d2/d1/rtlinit_8c-source.html#l00171">AllocateFromZone</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00333">_LOOKASIDE::EntrySize</a>, <a class="el" href="../../d2/d7/clglobal_8c-source.html#l00089">gcsLookaside</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00332">_LOOKASIDE::LookasideZone</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d9/usercli_8h-source.html#l00958">UserLocalAlloc</a>.
<p>
Referenced by <a class="el" href="../../d4/d8/dlgmgr_8c-source.html#l00192">ValidateDialogPwnd()</a>.
<p>
<pre class="fragment"><div>00301 {
00302     PVOID pEntry;
00303 
00304     <span class="comment">//</span>
00305     <span class="comment">// Attempt to get an entry from the zone. If this fails, then</span>
00306     <span class="comment">// LocalAlloc the entry</span>
00307     <span class="comment">//</span>
00308 
00309     RtlEnterCriticalSection(&amp;gcsLookaside);
00310     pEntry = <a class="code" href="../../d1/d2/rtlinit_8c.html#a1">AllocateFromZone</a>(&amp;pla-&gt;<a class="code" href="../../d2/d4/struct__LOOKASIDE.html#o2">LookasideZone</a>);
00311     RtlLeaveCriticalSection(&amp;gcsLookaside);
00312 
00313     <span class="keywordflow">if</span> ( !pEntry ) {
00314 
00315         <span class="comment">/*</span>
00316 <span class="comment">         * Allocate a local structure.</span>
00317 <span class="comment">         */</span>
00318 <span class="preprocessor">#if DBG</span>
00319 <span class="preprocessor"></span>        pla-&gt;AllocSlowCalls++;
00320 <span class="preprocessor">#endif // DBG</span>
00321 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((pEntry = <a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(0, pla-&gt;<a class="code" href="../../d2/d4/struct__LOOKASIDE.html#o3">EntrySize</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00322             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00323         }
00324     RtlZeroMemory(pEntry, pla-&gt;<a class="code" href="../../d2/d4/struct__LOOKASIDE.html#o3">EntrySize</a>);
00325 <span class="preprocessor">#if DBG</span>
00326 <span class="preprocessor"></span>    pla-&gt;AllocCalls++;
00327 
00328     <span class="keywordflow">if</span> (pla-&gt;AllocCalls - pla-&gt;DelCalls &gt; pla-&gt;AllocHiWater ) {
00329         pla-&gt;AllocHiWater = pla-&gt;AllocCalls - pla-&gt;DelCalls;
00330         }
00331 <span class="preprocessor">#endif // DBG</span>
00332 <span class="preprocessor"></span>
00333     <span class="keywordflow">return</span> pEntry;
00334 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="rtlinit.c::FreeLookasideEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void FreeLookasideEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d4/struct__LOOKASIDE.html">PLOOKASIDE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pla</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>pEntry</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/rtlinit_8c-source.html#l00344">344</a> of file <a class="el" href="../../d2/d1/rtlinit_8c-source.html">rtlinit.c</a>.
<p>
References <a class="el" href="../../d2/d1/rtlinit_8c-source.html#l00205">FreeToZone</a>, <a class="el" href="../../d2/d7/clglobal_8c-source.html#l00089">gcsLookaside</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00330">_LOOKASIDE::LookasideBase</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00331">_LOOKASIDE::LookasideBounds</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00332">_LOOKASIDE::LookasideZone</a>, and <a class="el" href="../../d7/d9/usercli_8h-source.html#l00960">UserLocalFree</a>.
<p>
Referenced by <a class="el" href="../../d9/d0/btnctl_8c-source.html#l01338">ButtonWndProcWorker()</a>, <a class="el" href="../../d4/d8/dlgmgr_8c-source.html#l00460">DefDlgProcWorker()</a>, <a class="el" href="../../d6/d3/edecrare_8c-source.html#l00285">ECNcCreate()</a>, <a class="el" href="../../d6/d3/edecrare_8c-source.html#l00439">ECNcDestroyHandler()</a>, <a class="el" href="../../d0/d9/imectl_8c-source.html#l00083">ImeWndProcWorker()</a>, <a class="el" href="../../d6/d4/statctl_8c-source.html#l00840">StaticWndProcWorker()</a>, <a class="el" href="../../d4/d3/comboini_8c-source.html#l00394">xxxCBNcDestroyHandler()</a>, and <a class="el" href="../../d3/d1/lboxrare_8c-source.html#l00375">xxxDestroyLBox()</a>.
<p>
<pre class="fragment"><div>00347 {
00348 <span class="preprocessor">#if DBG</span>
00349 <span class="preprocessor"></span>    pla-&gt;DelCalls++;
00350 <span class="preprocessor">#endif // DBG</span>
00351 <span class="preprocessor"></span>
00352     <span class="comment">//</span>
00353     <span class="comment">// If the pEntry was from zone, then free to zone</span>
00354     <span class="comment">//</span>
00355     <span class="keywordflow">if</span> ( (PVOID)pEntry &gt;= pla-&gt;<a class="code" href="../../d2/d4/struct__LOOKASIDE.html#o0">LookasideBase</a> &amp;&amp; (PVOID)pEntry &lt; pla-&gt;<a class="code" href="../../d2/d4/struct__LOOKASIDE.html#o1">LookasideBounds</a> ) {
00356         RtlEnterCriticalSection(&amp;gcsLookaside);
00357         <a class="code" href="../../d1/d2/rtlinit_8c.html#a2">FreeToZone</a>(&amp;pla-&gt;<a class="code" href="../../d2/d4/struct__LOOKASIDE.html#o2">LookasideZone</a>,pEntry);
00358         RtlLeaveCriticalSection(&amp;gcsLookaside);
00359     } <span class="keywordflow">else</span> {
00360 <span class="preprocessor">#if DBG</span>
00361 <span class="preprocessor"></span>        pla-&gt;DelSlowCalls++;
00362 <span class="preprocessor">#endif // DBG</span>
00363 <span class="preprocessor"></span>        <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(pEntry);
00364     }
00365 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="rtlinit.c::InitLookaside" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS InitLookaside           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d4/struct__LOOKASIDE.html">PLOOKASIDE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pla</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>cbEntry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>cEntries</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/rtlinit_8c-source.html#l00221">221</a> of file <a class="el" href="../../d2/d1/rtlinit_8c-source.html">rtlinit.c</a>.
<p>
References <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00278">BlockSize</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02047">_ZONE_HEADER::BlockSize</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00333">_LOOKASIDE::EntrySize</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02045">_ZONE_HEADER::FreeList</a>, <a class="el" href="../../d2/d7/clglobal_8c-source.html#l00089">gcsLookaside</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00330">_LOOKASIDE::LookasideBase</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00331">_LOOKASIDE::LookasideBounds</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00332">_LOOKASIDE::LookasideZone</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d0/usercli_8h.html#a355">PLOOKASIDE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a120">PZONE_HEADER</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02046">_ZONE_HEADER::SegmentList</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02048">_ZONE_HEADER::TotalSegmentSize</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00958">UserLocalAlloc</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00960">UserLocalFree</a>, and <a class="el" href="../../d5/d8/ex_8h.html#a117">ZONE_SEGMENT_HEADER</a>.
<p>
Referenced by <a class="el" href="../../d4/d8/dlgmgr_8c-source.html#l00192">ValidateDialogPwnd()</a>.
<p>
<pre class="fragment"><div>00225 {
00226     ULONG i;
00227     PCH p;
00228     ULONG <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>;
00229     <a class="code" href="../../d0/d0/struct__ZONE__HEADER.html">PZONE_HEADER</a> Zone;
00230     PVOID InitialSegment;
00231     ULONG InitialSegmentSize;
00232 
00233     InitialSegmentSize = (cEntries * cbEntry) + <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d0/struct__ZONE__SEGMENT__HEADER.html">ZONE_SEGMENT_HEADER</a>);
00234 
00235     p = (PCH)<a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(0, InitialSegmentSize);
00236 
00237     <span class="keywordflow">if</span> ( !p ) {
00238         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00239         }
00240 
00241     RtlEnterCriticalSection(&amp;gcsLookaside);
00242 
00243     <span class="comment">//</span>
00244     <span class="comment">// If the lookaside list has already been initialized, we're done.</span>
00245     <span class="comment">//</span>
00246 
00247     <span class="keywordflow">if</span> (pla-&gt;<a class="code" href="../../d2/d4/struct__LOOKASIDE.html#o0">LookasideBase</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pla-&gt;<a class="code" href="../../d2/d4/struct__LOOKASIDE.html#o3">EntrySize</a> == cbEntry) {
00248         RtlLeaveCriticalSection(&amp;gcsLookaside);
00249         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(p);
00250         <span class="keywordflow">return</span> STATUS_SUCCESS;
00251     }
00252 
00253     pla-&gt;<a class="code" href="../../d2/d4/struct__LOOKASIDE.html#o0">LookasideBase</a> = (PVOID)p;
00254     pla-&gt;<a class="code" href="../../d2/d4/struct__LOOKASIDE.html#o1">LookasideBounds</a> = (PVOID)(p + InitialSegmentSize);
00255     pla-&gt;<a class="code" href="../../d2/d4/struct__LOOKASIDE.html#o3">EntrySize</a> = cbEntry;
00256 
00257     <span class="comment">//</span>
00258     <span class="comment">// Using the ExZone-like code, slice up the page into QMSG's</span>
00259     <span class="comment">//</span>
00260 
00261     Zone = &amp;pla-&gt;<a class="code" href="../../d2/d4/struct__LOOKASIDE.html#o2">LookasideZone</a>;
00262     <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a> = cbEntry;
00263     InitialSegment = pla-&gt;<a class="code" href="../../d2/d4/struct__LOOKASIDE.html#o0">LookasideBase</a>;
00264 
00265     Zone-&gt;<a class="code" href="../../d0/d0/struct__ZONE__HEADER.html#o2">BlockSize</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>;
00266 
00267     Zone-&gt;<a class="code" href="../../d0/d0/struct__ZONE__HEADER.html#o1">SegmentList</a>.Next = &amp;((<a class="code" href="../../d1/d0/struct__ZONE__SEGMENT__HEADER.html">PZONE_SEGMENT_HEADER</a>) InitialSegment)-&gt;SegmentList;
00268     ((<a class="code" href="../../d1/d0/struct__ZONE__SEGMENT__HEADER.html">PZONE_SEGMENT_HEADER</a>) InitialSegment)-&gt;SegmentList.Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00269     ((<a class="code" href="../../d1/d0/struct__ZONE__SEGMENT__HEADER.html">PZONE_SEGMENT_HEADER</a>) InitialSegment)-&gt;Reserved = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00270 
00271     Zone-&gt;<a class="code" href="../../d0/d0/struct__ZONE__HEADER.html#o0">FreeList</a>.Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00272 
00273     p = (PCH)InitialSegment + <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d0/struct__ZONE__SEGMENT__HEADER.html">ZONE_SEGMENT_HEADER</a>);
00274 
00275     <span class="keywordflow">for</span> (i = <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d0/struct__ZONE__SEGMENT__HEADER.html">ZONE_SEGMENT_HEADER</a>);
00276          i &lt;= InitialSegmentSize - <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>;
00277          i += <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>
00278         ) {
00279         ((PSINGLE_LIST_ENTRY)p)-&gt;Next = Zone-&gt;<a class="code" href="../../d0/d0/struct__ZONE__HEADER.html#o0">FreeList</a>.Next;
00280         Zone-&gt;<a class="code" href="../../d0/d0/struct__ZONE__HEADER.html#o0">FreeList</a>.Next = (PSINGLE_LIST_ENTRY)p;
00281         p += <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>;
00282     }
00283     Zone-&gt;<a class="code" href="../../d0/d0/struct__ZONE__HEADER.html#o3">TotalSegmentSize</a> = i;
00284 
00285     RtlLeaveCriticalSection(&amp;gcsLookaside);
00286 
00287     <span class="keywordflow">return</span> STATUS_SUCCESS;
00288 
00289 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="rtlinit.c::RtlCaptureAnsiString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL RtlCaptureAnsiString           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d8/d1/struct__IN__STRING.html">PIN_STRING</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pstr</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPCSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>psz</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>fForceAlloc</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/rtlinit_8c-source.html#l00030">30</a> of file <a class="el" href="../../d2/d1/rtlinit_8c-source.html">rtlinit.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00316">_IN_STRING::fAllocated</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00315">_IN_STRING::pstr</a>, <a class="el" href="../../d2/d7/clglobal_8c-source.html#l00061">pUserHeap</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, <a class="el" href="../../d0/d6/nlsxlat_8c-source.html#l00369">RtlMultiByteToUnicodeN()</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00314">_IN_STRING::strCapture</a>, <a class="el" href="../../d2/d7/regtest_8c.html#a2">strlen()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>00034 {
00035     <span class="keywordtype">int</span> cbSrc;
00036     <span class="keywordtype">int</span> cbDst;
00037 
00038     pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o2">fAllocated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00039     <span class="keywordflow">if</span> (psz) {
00040         cbSrc = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(psz) + 1;
00041         <span class="keywordflow">if</span> (cbSrc &gt; MAXUSHORT) {
00042             RIPMSG0(RIP_WARNING, <span class="stringliteral">"String too long for standard string"</span>);
00043             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00044         }
00045 
00046         <span class="comment">/*</span>
00047 <span class="comment">         * If the allocation is forced or if the string is</span>
00048 <span class="comment">         * too long to fit in the TEB, allocate a buffer.</span>
00049 <span class="comment">         * Otherwise, store the result in the TEB.</span>
00050 <span class="comment">         */</span>
00051         <span class="keywordflow">if</span> (fForceAlloc ||
00052                 cbSrc &gt; (STATIC_UNICODE_BUFFER_LENGTH / <span class="keyword">sizeof</span>(WCHAR))) {
00053             pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o0">strCapture</a>.Buffer = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(pUserHeap,
00054                     0, cbSrc * <span class="keyword">sizeof</span>(WCHAR));
00055             <span class="keywordflow">if</span> (pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o0">strCapture</a>.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00056                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00057             pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o2">fAllocated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00058             pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a> = &amp;pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o0">strCapture</a>;
00059             pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o0">strCapture</a>.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(cbSrc * <span class="keyword">sizeof</span>(WCHAR));
00060         } <span class="keywordflow">else</span> {
00061             pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a> = &amp;NtCurrentTeb()-&gt;StaticUnicodeString;
00062         }
00063 
00064         <span class="comment">/*</span>
00065 <span class="comment">         * Convert the string to Unicode</span>
00066 <span class="comment">         */</span>
00067         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d6/nlsxlat_8c.html#a33">RtlMultiByteToUnicodeN</a>(pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a>-&gt;Buffer,
00068                 (ULONG)pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a>-&gt;MaximumLength, &amp;cbDst,
00069                 (LPSTR)psz, cbSrc)) {
00070             RIPMSG0(RIP_WARNING, <span class="stringliteral">"Unicode conversion failed"</span>);
00071             <span class="keywordflow">if</span> (pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o2">fAllocated</a>) {
00072                 <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(pUserHeap, 0, pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o0">strCapture</a>.Buffer);
00073                 pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o2">fAllocated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00074             }
00075             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00076         }
00077         pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a>-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)cbDst - <span class="keyword">sizeof</span>(WCHAR);
00078     } <span class="keywordflow">else</span> {
00079         pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a> = &amp;pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o0">strCapture</a>;
00080         pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o0">strCapture</a>.Length = pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o0">strCapture</a>.MaximumLength = 0;
00081         pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o0">strCapture</a>.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00082     }
00083     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00084 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="rtlinit.c::RtlCaptureLargeAnsiString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL RtlCaptureLargeAnsiString           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d8/d8/struct__LARGE__IN__STRING.html">PLARGE_IN_STRING</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>plstr</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPCSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>psz</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>fForceAlloc</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/rtlinit_8c-source.html#l00095">95</a> of file <a class="el" href="../../d2/d1/rtlinit_8c-source.html">rtlinit.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00435">_LARGE_UNICODE_STRING::Buffer</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00322">_LARGE_IN_STRING::fAllocated</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l00463">_LARGE_UNICODE_STRING::Length</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l00464">_LARGE_UNICODE_STRING::MaximumLength</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d0/usercli_8h.html#a353">PLARGE_IN_STRING</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00321">_LARGE_IN_STRING::pstr</a>, <a class="el" href="../../d2/d7/clglobal_8c-source.html#l00061">pUserHeap</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, <a class="el" href="../../d0/d6/nlsxlat_8c-source.html#l00369">RtlMultiByteToUnicodeN()</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00320">_LARGE_IN_STRING::strCapture</a>, <a class="el" href="../../d2/d7/regtest_8c.html#a2">strlen()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l01197">_CreateWindowEx()</a>.
<p>
<pre class="fragment"><div>00099 {
00100     <span class="keywordtype">int</span> cchSrc;
00101     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uLength;
00102 
00103     plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o2">fAllocated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00104     plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o1">pstr</a> = &amp;plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o0">strCapture</a>;
00105 
00106     <span class="keywordflow">if</span> (psz) {
00107         cchSrc = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(psz) + 1;
00108 
00109         <span class="comment">/*</span>
00110 <span class="comment">         * If the allocation is forced or if the string is</span>
00111 <span class="comment">         * too long to fit in the TEB, allocate a buffer.</span>
00112 <span class="comment">         * Otherwise, store the result in the TEB.</span>
00113 <span class="comment">         */</span>
00114         <span class="keywordflow">if</span> (fForceAlloc || cchSrc &gt; STATIC_UNICODE_BUFFER_LENGTH) {
00115             plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o0">strCapture</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a> = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(pUserHeap,
00116                     0, cchSrc * <span class="keyword">sizeof</span>(WCHAR));
00117             <span class="keywordflow">if</span> (plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o0">strCapture</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00118                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00119             plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o2">fAllocated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00120             plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o0">strCapture</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o1">MaximumLength</a> = cchSrc * <span class="keyword">sizeof</span>(WCHAR);
00121         } <span class="keywordflow">else</span> {
00122             plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o0">strCapture</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a> = NtCurrentTeb()-&gt;StaticUnicodeBuffer;
00123             plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o0">strCapture</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o1">MaximumLength</a> =
00124                     (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(STATIC_UNICODE_BUFFER_LENGTH * <span class="keyword">sizeof</span>(WCHAR));
00125         }
00126 
00127         <span class="comment">/*</span>
00128 <span class="comment">         * Convert the string to Unicode</span>
00129 <span class="comment">         */</span>
00130         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d6/nlsxlat_8c.html#a33">RtlMultiByteToUnicodeN</a>(plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o1">pstr</a>-&gt;<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a>,
00131                 plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o1">pstr</a>-&gt;<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o1">MaximumLength</a>, &amp;uLength,
00132                 (LPSTR)psz, cchSrc)) {
00133             RIPMSG0(RIP_WARNING, <span class="stringliteral">"Unicode conversion failed"</span>);
00134             <span class="keywordflow">if</span> (plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o2">fAllocated</a>) {
00135                 <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(pUserHeap, 0, plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o0">strCapture</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a>);
00136                 plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o2">fAllocated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00137             }
00138             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00139         }
00140         plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o1">pstr</a>-&gt;<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o0">Length</a> = uLength - <span class="keyword">sizeof</span>(WCHAR);
00141     } <span class="keywordflow">else</span> {
00142         plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o0">strCapture</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o0">Length</a> = plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o0">strCapture</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o1">MaximumLength</a> = 0;
00143         plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o0">strCapture</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00144     }
00145     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00146 }
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:30 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
