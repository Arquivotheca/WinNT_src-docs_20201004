<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: obwait.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>obwait.c File Reference</h1><code>#include "<a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>"</code><br>

<p>
<a href="../../d2/d1/obwait_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/obwait_8c.html#a3">NtSignalAndWaitForSingleObject</a> (IN HANDLE SignalHandle, IN HANDLE WaitHandle, IN BOOLEAN Alertable, IN PLARGE_INTEGER Timeout OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a> (IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN BOOLEAN Alertable, IN PLARGE_INTEGER Timeout OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/obwait_8c.html#a5">NtWaitForMultipleObjects</a> (IN ULONG <a class="el" href="../../d6/d0/cmdat_8c.html#a5">Count</a>, IN HANDLE Handles[], IN WAIT_TYPE WaitType, IN BOOLEAN Alertable, IN PLARGE_INTEGER Timeout OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/obwait_8c.html#a6">ObWaitForSingleObject</a> (IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN BOOLEAN Alertable, IN PLARGE_INTEGER Timeout OPTIONAL)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/obwait_8c.html#a0">ExEventObjectType</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/obwait_8c.html#a1">ExMutantObjectType</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/obwait_8c.html#a2">ExSemaphoreObjectType</a></td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a3" doxytag="obwait.c::NtSignalAndWaitForSingleObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtSignalAndWaitForSingleObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>SignalHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>WaitHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Alertable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER Timeout&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/obwait_8c-source.html#l00038">38</a> of file <a class="el" href="../../d2/d1/obwait_8c-source.html">obwait.c</a>.
<p>
References <a class="el" href="../../d5/d9/ob_8h-source.html#l00190">_OBJECT_TYPE::DefaultObject</a>, <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00034">EVENT_INCREMENT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00030">ExEventObjectType</a>, <a class="el" href="../../d3/d4/mutant_8c-source.html#l00032">ExMutantObjectType</a>, <a class="el" href="../../d3/d5/semphore_8c-source.html#l00038">ExSemaphoreObjectType</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00057">_OBJECT_HANDLE_INFORMATION::GrantedAccess</a>, <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00178">KeReleaseMutant()</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00147">MUTANT_INCREMENT</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01391">ProbeAndReadLargeInteger</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00480">SeComputeDeniedAccesses</a>, <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00155">SEMAPHORE_INCREMENT</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, and <a class="el" href="../../d4/d9/ke_8h.html#a407a204">UserRequest</a>.
<p>
Referenced by <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01567">DisplayModeTransition()</a>.
<p>
<pre class="fragment"><div>00047                    :
00048 
00049     This function atomically signals <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified signal object and then
00050     waits until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified wait object attains a state of Signaled.  An
00051     optional timeout can also be specified.  If a timeout <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified,
00052     then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait will not be satisfied until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait object attains a
00053     state of Signaled.  If a timeout <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait object has
00054     not attained a state of Signaled when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timeout expires, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00055     wait <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> automatically satisfied.  If an <span class="keyword">explicit</span> timeout value of zero
00056     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified, then no wait will occur <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait cannot be satisfied
00057     immediately.  The wait can also be specified as alertable.
00058 
00059 Arguments:
00060 
00061     SignalHandle - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> signal object.
00062 
00063     WaitHandle  - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait object.
00064 
00065     Alertable - Supplies a <span class="keywordtype">boolean</span> value that specifies whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait
00066         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> alertable.
00067 
00068     Timeout - Supplies an pointer to an absolute or relative time over
00069         which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to occur.
00070 
00071 Return Value:
00072 
00073     The wait completion status.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of STATUS_TIMEOUT <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> a
00074     timeout occurred.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of STATUS_SUCCESS <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00075     object satisfied <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of STATUS_ALERTED <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00076     wait was aborted to deliver an alert to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of
00077     STATUS_USER_APC <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait was aborted to deliver a user
00078     APC to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread.
00079 
00080 --*/
00081 
00082 {
00083     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a> HandleInformation;
00084     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00085     PVOID RealObject;
00086     PVOID SignalObject;
00087     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> SignalObjectHeader;
00088     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00089     LARGE_INTEGER TimeoutValue;
00090     PVOID WaitObject;
00091     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> WaitObjectHeader;
00092 
00093     <span class="comment">//</span>
00094     <span class="comment">//  Establish an exception handler and probe the specified timeout value</span>
00095     <span class="comment">//  if necessary.  If the probe fails, then return the exception code as</span>
00096     <span class="comment">//  the service status.</span>
00097     <span class="comment">//</span>
00098 
00099     PreviousMode = KeGetPreviousMode();
00100 
00101     <span class="keywordflow">if</span> ((ARGUMENT_PRESENT(Timeout)) &amp;&amp; (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>)) {
00102 
00103         <span class="keywordflow">try</span> {
00104 
00105             TimeoutValue = <a class="code" href="../../d5/d8/ex_8h.html#a24">ProbeAndReadLargeInteger</a>(Timeout);
00106             Timeout = &amp;TimeoutValue;
00107 
00108         } except(EXCEPTION_EXECUTE_HANDLER) {
00109 
00110             <span class="keywordflow">return</span> GetExceptionCode();
00111         }
00112     }
00113 
00114     <span class="comment">//</span>
00115     <span class="comment">//  Reference the signal object by handle.</span>
00116     <span class="comment">//</span>
00117 
00118     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( SignalHandle,
00119                                         0,
00120                                         NULL,
00121                                         PreviousMode,
00122                                         &amp;SignalObject,
00123                                         &amp;HandleInformation );
00124 
00125     <span class="comment">//</span>
00126     <span class="comment">//  If the reference was successful, then reference the wait object by</span>
00127     <span class="comment">//  handle.</span>
00128     <span class="comment">//</span>
00129 
00130     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00131 
00132         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( WaitHandle,
00133                                             SYNCHRONIZE,
00134                                             NULL,
00135                                             PreviousMode,
00136                                             &amp;WaitObject,
00137                                             NULL );
00138 
00139         <span class="comment">//</span>
00140         <span class="comment">//  If the reference was successful, then determine the real wait</span>
00141         <span class="comment">//  object, check the signal object access, signal the signal object,</span>
00142         <span class="comment">//  and wait for the real wait object.</span>
00143         <span class="comment">//</span>
00144 
00145         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00146 
00147             WaitObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(WaitObject);
00148             RealObject = WaitObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o3">DefaultObject</a>;
00149 
00150             <span class="keywordflow">if</span> ((LONG_PTR)RealObject &gt;= 0) {
00151 
00152                 RealObject = (PVOID)((PCHAR)WaitObject + (ULONG_PTR)RealObject);
00153             }
00154 
00155             <span class="comment">//</span>
00156             <span class="comment">//  If the signal object is an event, then check for modify access</span>
00157             <span class="comment">//  and set the event.  Otherwise, if the signal object is a</span>
00158             <span class="comment">//  mutant, then attempt to release ownership of the mutant.</span>
00159             <span class="comment">//  Otherwise, if the object is a semaphore, then check for modify</span>
00160             <span class="comment">//  access and release the semaphore.  Otherwise, the signal objet</span>
00161             <span class="comment">//  is invalid.</span>
00162             <span class="comment">//</span>
00163 
00164             SignalObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(SignalObject);
00165             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
00166 
00167             <span class="keywordflow">if</span> (SignalObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a> == <a class="code" href="../../d7/d7/ntapi_8c.html#a3">ExEventObjectType</a>) {
00168 
00169                 <span class="comment">//</span>
00170                 <span class="comment">//  Check for access to the specified event object,</span>
00171                 <span class="comment">//</span>
00172 
00173                 <span class="keywordflow">if</span> ((PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp;
00174                     (<a class="code" href="../../d0/d5/se_8h.html#a8">SeComputeDeniedAccesses</a>( HandleInformation.<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o1">GrantedAccess</a>,
00175                                               EVENT_MODIFY_STATE) != 0 )) {
00176 
00177                     <span class="keywordflow">goto</span> WaitExit;
00178                 }
00179 
00180                 <span class="comment">//</span>
00181                 <span class="comment">//  Set the specified event and wait atomically.</span>
00182                 <span class="comment">//</span>
00183 
00184                 <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>((<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>)SignalObject, EVENT_INCREMENT, TRUE);
00185 
00186             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (SignalObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a> == <a class="code" href="../../d2/d5/mutant_8c.html#a0">ExMutantObjectType</a>) {
00187 
00188                 <span class="comment">//</span>
00189                 <span class="comment">//  Release the specified mutant and wait atomically.</span>
00190                 <span class="comment">//</span>
00191                 <span class="comment">//  N.B. The release will only be successful if the current</span>
00192                 <span class="comment">//       thread is the owner of the mutant.</span>
00193                 <span class="comment">//</span>
00194 
00195                 <span class="keywordflow">try</span> {
00196 
00197                     <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a>( (<a class="code" href="../../d3/d7/struct__KMUTANT.html">PKMUTANT</a>)SignalObject,
00198                                      MUTANT_INCREMENT,
00199                                      FALSE,
00200                                      TRUE );
00201 
00202                 } except(EXCEPTION_EXECUTE_HANDLER) {
00203 
00204                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00205 
00206                     <span class="keywordflow">goto</span> WaitExit;
00207                 }
00208 
00209             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (SignalObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a> == <a class="code" href="../../d2/d6/semphore_8c.html#a1">ExSemaphoreObjectType</a>) {
00210 
00211                 <span class="comment">//</span>
00212                 <span class="comment">//  Check for access to the specified semaphore object,</span>
00213                 <span class="comment">//</span>
00214 
00215                 <span class="keywordflow">if</span> ((PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp;
00216                     (<a class="code" href="../../d0/d5/se_8h.html#a8">SeComputeDeniedAccesses</a>( HandleInformation.<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o1">GrantedAccess</a>,
00217                                               SEMAPHORE_MODIFY_STATE) != 0 )) {
00218 
00219                     <span class="keywordflow">goto</span> WaitExit;
00220                 }
00221 
00222                 <span class="comment">//</span>
00223                 <span class="comment">//  Release the specified semaphore and wait atomically.</span>
00224                 <span class="comment">//</span>
00225 
00226                 <span class="keywordflow">try</span> {
00227 
00228                     <span class="comment">//</span>
00229                     <span class="comment">//  Release the specified semaphore and wait atomically.</span>
00230                     <span class="comment">//</span>
00231 
00232                     <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>( (<a class="code" href="../../d8/d7/struct__KSEMAPHORE.html">PKSEMAPHORE</a>)SignalObject,
00233                                         SEMAPHORE_INCREMENT,
00234                                         1,
00235                                         TRUE );
00236 
00237                 } except(EXCEPTION_EXECUTE_HANDLER) {
00238 
00239                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00240 
00241                     <span class="keywordflow">goto</span> WaitExit;
00242                 }
00243 
00244             } <span class="keywordflow">else</span> {
00245 
00246                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_TYPE_MISMATCH;
00247 
00248                 <span class="keywordflow">goto</span> WaitExit;
00249             }
00250 
00251             <span class="comment">//</span>
00252             <span class="comment">//  Protect the wait call just in case KeWait decides to raise</span>
00253             <span class="comment">//  For example, a mutant level is exceeded</span>
00254             <span class="comment">//</span>
00255 
00256             <span class="keywordflow">try</span> {
00257 
00258                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( RealObject,
00259                                                 UserRequest,
00260                                                 PreviousMode,
00261                                                 Alertable,
00262                                                 Timeout );
00263 
00264             } except(EXCEPTION_EXECUTE_HANDLER) {
00265 
00266                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00267             }
00268 
00269 WaitExit:
00270 
00271             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(WaitObject);
00272         }
00273 
00274         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(SignalObject);
00275     }
00276 
00277     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00278 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="obwait.c::NtWaitForMultipleObjects" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtWaitForMultipleObjects           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Count</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handles</em>[], </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN WAIT_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>WaitType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Alertable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER Timeout&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/obwait_8c-source.html#l00406">406</a> of file <a class="el" href="../../d2/d1/obwait_8c-source.html">obwait.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00313">_OBJECT_HEADER::Body</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00418">DecodeKernelHandle</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00190">_OBJECT_TYPE::DefaultObject</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01403">ExMapHandleToPointer()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00336">ExUnlockHandleTableEntry()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02690">_HANDLE_TABLE_ENTRY::GrantedAccess</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02694">_HANDLE_TABLE_ENTRY::GrantedAccessIndex</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00057">IsKernelHandle</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00324">KeStackAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00512">KeUnstackDetachProcess()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00395">KeWaitForMultipleObjects()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00370">NtGlobalFlag</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00289">OBJ_HANDLE_ATTRIBUTES</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02672">_HANDLE_TABLE_ENTRY::Object</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00213">ObpGetObjectTable</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00143">ObpIncrPointerCount</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00399">ObpKernelHandleTable</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01391">ProbeAndReadLargeInteger</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00579">PsInitialSystemProcess</a>, <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00562">RefCount</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00480">SeComputeDeniedAccesses</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00079">THREAD_WAIT_OBJECTS</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, and <a class="el" href="../../d4/d9/ke_8h.html#a407a204">UserRequest</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/dllinit_8c-source.html#l00656">AllocConsoleInternal()</a>, <a class="el" href="../../d9/d8/dllinit_8c-source.html#l00373">ConnectConsoleInternal()</a>, <a class="el" href="../../d1/d6/server_2server_8c-source.html#l00881">NotificationThread()</a>, <a class="el" href="../../d4/d2/tob_8c-source.html#l00187">obtest()</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l02824">RtlpWaitThread()</a>.
<p>
<pre class="fragment"><div>00416                    :
00417 
00418     This function waits until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified objects attain a state of
00419     Signaled.  The wait can be specified to wait until all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> objects
00420     attain a state of Signaled or until one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> objects attains a state
00421     of Signaled.  An optional timeout can also be specified.  If a timeout
00422     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait will not be satisfied until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> objects
00423     attain a state of Signaled.  If a timeout <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> objects
00424     have not attained a state of Signaled when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timeout expires, then
00425     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> automatically satisfied.  If an <span class="keyword">explicit</span> timeout value of
00426     zero <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified, then no wait will occur <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait cannot be satisfied
00427     immediately.  The wait can also be specified as alertable.
00428 
00429 Arguments:
00430 
00431     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> - Supplies a count of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of objects that are to be waited
00432         on.
00433 
00434     Handles[] - Supplies an array of handles to wait objects.
00435 
00436     WaitType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of wait to perform (WaitAll, WaitAny).
00437 
00438     Alertable - Supplies a <span class="keywordtype">boolean</span> value that specifies whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00439         alertable.
00440 
00441     Timeout - Supplies a pointer to an optional absolute of relative time over
00442         which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to occur.
00443 
00444 Return Value:
00445 
00446     The wait completion status.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of STATUS_TIMEOUT <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> a
00447     timeout occurred.  The index of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object (zero based) in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
00448     pointer array <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> an object satisfied <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of
00449     STATUS_ALERTED <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait was aborted to deliver an alert
00450     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of STATUS_USER_APC <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00451     wait was aborted to deliver a user APC to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread.
00452 
00453 --*/
00454 
00455 {
00456     HANDLE CapturedHandles[MAXIMUM_WAIT_OBJECTS];
00457     ULONG i;
00458     ULONG j;
00459     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00460     PVOID Objects[MAXIMUM_WAIT_OBJECTS];
00461     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00462     ULONG <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a5">RefCount</a>;
00463     ULONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00464     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00465     LARGE_INTEGER TimeoutValue;
00466     <a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">PKWAIT_BLOCK</a> WaitBlockArray;
00467     ACCESS_MASK GrantedAccess;
00468     PVOID WaitObjects[MAXIMUM_WAIT_OBJECTS];
00469     <a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> HandleTable;
00470     <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> HandleEntry;
00471     BOOLEAN AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00472     BOOLEAN InCriticalRegion = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00473     <a class="code" href="../../d3/d5/struct__KAPC__STATE.html">KAPC_STATE</a> ApcState;
00474 
00475     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00476 
00477     <span class="comment">//</span>
00478     <span class="comment">//  Protect ourselves from being interrupted while we hold a handle table</span>
00479     <span class="comment">//  entry lock</span>
00480     <span class="comment">//</span>
00481 
00482     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00483     InCriticalRegion = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00484 
00485     <span class="keywordflow">try</span> {
00486 
00487         <span class="comment">//</span>
00488         <span class="comment">//  If the number of objects is zero or greater than the largest number</span>
00489         <span class="comment">//  that can be waited on, then return and invalid parameter status.</span>
00490         <span class="comment">//</span>
00491 
00492         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> == 0) || (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> &gt; MAXIMUM_WAIT_OBJECTS)) {
00493 
00494             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_1;
00495             leave;
00496         }
00497 
00498         <span class="comment">//</span>
00499         <span class="comment">//  If the wait type is not wait any or wait all, then return an invalid</span>
00500         <span class="comment">//  parameter status.</span>
00501         <span class="comment">//</span>
00502 
00503         <span class="keywordflow">if</span> ((WaitType != WaitAny) &amp;&amp; (WaitType != WaitAll)) {
00504 
00505             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_3;
00506             leave;
00507         }
00508 
00509         <span class="comment">//</span>
00510         <span class="comment">//  Get previous processor mode and probe and capture input arguments if</span>
00511         <span class="comment">//  necessary.</span>
00512         <span class="comment">//</span>
00513 
00514         PreviousMode = KeGetPreviousMode();
00515 
00516         <span class="keywordflow">try</span> {
00517 
00518             <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00519 
00520                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Timeout)) {
00521 
00522                     TimeoutValue = <a class="code" href="../../d5/d8/ex_8h.html#a24">ProbeAndReadLargeInteger</a>(Timeout);
00523                     Timeout = &amp;TimeoutValue;
00524                 }
00525 
00526                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( Handles, Count * <span class="keyword">sizeof</span>(HANDLE), <span class="keyword">sizeof</span>(HANDLE) );
00527             }
00528 
00529             i= 0;
00530 
00531             <span class="keywordflow">do</span> {
00532 
00533                 CapturedHandles[i] = Handles[i];
00534                 i += 1;
00535 
00536             } <span class="keywordflow">while</span> (i &lt; <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>);
00537 
00538         } except(EXCEPTION_EXECUTE_HANDLER) {
00539 
00540             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00541             leave;
00542         }
00543 
00544         <span class="comment">//</span>
00545         <span class="comment">//  If the number of objects to be waited on is greater than the number</span>
00546         <span class="comment">//  of builtin wait blocks, then allocate an array of wait blocks from</span>
00547         <span class="comment">//  nonpaged pool. If the wait block array cannot be allocated, then</span>
00548         <span class="comment">//  return insufficient resources.</span>
00549         <span class="comment">//</span>
00550 
00551         WaitBlockArray = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00552 
00553         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> &gt; <a class="code" href="../../d4/d9/ke_8h.html#a6">THREAD_WAIT_OBJECTS</a>) {
00554 
00555             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> * <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">KWAIT_BLOCK</a> );
00556             WaitBlockArray = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPool, Size, 'tiaW');
00557 
00558             <span class="keywordflow">if</span> (WaitBlockArray == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00559 
00560                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00561                 leave;
00562             }
00563         }
00564 
00565         <span class="comment">//</span>
00566         <span class="comment">//  Loop through the array of handles and get a referenced pointer to</span>
00567         <span class="comment">//  each object.</span>
00568         <span class="comment">//</span>
00569 
00570         i = 0;
00571         <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a5">RefCount</a> = 0;
00572 
00573         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00574 
00575         <span class="keywordflow">do</span> {
00576 
00577 <span class="preprocessor">    #if DBG</span>
00578 <span class="preprocessor"></span>            <span class="comment">//</span>
00579             <span class="comment">//  On checked builds, check that if the Kernel handle bit is set,</span>
00580             <span class="comment">//  then we're coming from Kernel mode.  We should probably fail the</span>
00581             <span class="comment">//  call if bit set &amp;&amp; !Kmode</span>
00582             <span class="comment">//</span>
00583 
00584             <span class="keywordflow">if</span> ((CapturedHandles[i] != NtCurrentThread()) &amp;&amp;
00585                 (CapturedHandles[i] != NtCurrentProcess())) {
00586 
00587                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((CapturedHandles[i] &lt; 0) ? (PreviousMode == KernelMode) : TRUE);
00588             }
00589 <span class="preprocessor">    #endif</span>
00590 <span class="preprocessor"></span>
00591             <span class="comment">//</span>
00592             <span class="comment">//  Get a pointer to the object table entry.  Check if this is a kernel</span>
00593             <span class="comment">//  handle and if so then use the kernel handle table otherwise use the</span>
00594             <span class="comment">//  processes handle table.  If we are going for a kernel handle we'll</span>
00595             <span class="comment">//  need to attach to the kernel process otherwise we need to ensure</span>
00596             <span class="comment">//  that we aren't attached.</span>
00597             <span class="comment">//</span>
00598 
00599             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ioverifier_8c.html#a14">IsKernelHandle</a>( CapturedHandles[i], PreviousMode )) {
00600 
00601                 HANDLE KernelHandle;
00602 
00603                 <span class="comment">//</span>
00604                 <span class="comment">//  If we aren't already attached to the system process do so now</span>
00605                 <span class="comment">//  and remember that we are</span>
00606                 <span class="comment">//</span>
00607 
00608                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != <a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>) {
00609                     <a class="code" href="../../d3/d5/procobj_8c.html#a6">KeStackAttachProcess</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>, &amp;ApcState);
00610                     AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00611                 }
00612 
00613                 <span class="comment">//</span>
00614                 <span class="comment">//  Decode the user supplied handle into a regular handle value</span>
00615                 <span class="comment">//  and get its handle table entry</span>
00616                 <span class="comment">//</span>
00617 
00618                 KernelHandle = <a class="code" href="../../d5/d1/obp_8h.html#a27">DecodeKernelHandle</a>( CapturedHandles[i] );
00619 
00620                 HandleTable = <a class="code" href="../../d5/d1/obp_8h.html#a54">ObpKernelHandleTable</a>;
00621                 HandleEntry = <a class="code" href="../../d5/d8/ex_8h.html#a299">ExMapHandleToPointer</a>( HandleTable, KernelHandle );
00622 
00623             } <span class="keywordflow">else</span> {
00624 
00625                 <span class="comment">//</span>
00626                 <span class="comment">//  If we are attached to the system process then go back to the</span>
00627                 <span class="comment">//  original callers process</span>
00628                 <span class="comment">//</span>
00629 
00630                 <span class="keywordflow">if</span> (AttachedToProcess) {
00631                     <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
00632                     AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00633                 }
00634 
00635                 <span class="comment">//</span>
00636                 <span class="comment">//  Get the handle table entry</span>
00637                 <span class="comment">//</span>
00638 
00639                 HandleTable = <a class="code" href="../../d5/d1/obp_8h.html#a12">ObpGetObjectTable</a>();
00640                 HandleEntry = <a class="code" href="../../d5/d8/ex_8h.html#a299">ExMapHandleToPointer</a>( HandleTable, CapturedHandles[ i ] );
00641             }
00642 
00643             <span class="comment">//</span>
00644             <span class="comment">//  Make sure the handle really did translate to a valid</span>
00645             <span class="comment">//  entry</span>
00646             <span class="comment">//</span>
00647 
00648             <span class="keywordflow">if</span> (HandleEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00649 
00650                 <span class="comment">//</span>
00651                 <span class="comment">//  Get the granted access for the handle</span>
00652                 <span class="comment">//</span>
00653 
00654 <span class="preprocessor">    #if i386 &amp;&amp; !FPO</span>
00655 <span class="preprocessor"></span>
00656                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_KERNEL_STACK_TRACE_DB) {
00657 
00658                     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00659 
00660                         GrantedAccess = ObpTranslateGrantedAccessIndex( HandleEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o3">GrantedAccessIndex</a> );
00661                     }
00662 
00663                 } <span class="keywordflow">else</span> {
00664 
00665                     GrantedAccess = HandleEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a>;
00666                 }
00667 
00668 <span class="preprocessor">    #else</span>
00669 <span class="preprocessor"></span>                GrantedAccess = HandleEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a>;
00670 
00671 <span class="preprocessor">    #endif // i386 &amp;&amp; !FPO</span>
00672 <span class="preprocessor"></span>
00673                 <span class="comment">//</span>
00674                 <span class="comment">//  Make sure the handle as synchronize access to the</span>
00675                 <span class="comment">//  object</span>
00676                 <span class="comment">//</span>
00677 
00678                 <span class="keywordflow">if</span> ((PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp;
00679                     (<a class="code" href="../../d0/d5/se_8h.html#a8">SeComputeDeniedAccesses</a>( GrantedAccess, SYNCHRONIZE ) != 0)) {
00680 
00681                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
00682 
00683                     <a class="code" href="../../d5/d8/ex_8h.html#a288">ExUnlockHandleTableEntry</a>( HandleTable, HandleEntry );
00684 
00685                     <span class="keywordflow">goto</span> ServiceFailed;
00686 
00687                 } <span class="keywordflow">else</span> {
00688 
00689                     <span class="comment">//</span>
00690                     <span class="comment">//  We have a object with proper access so get the header</span>
00691                     <span class="comment">//  and if the default objects points to a real object</span>
00692                     <span class="comment">//  then that is the one we're going to wait on.</span>
00693                     <span class="comment">//  Otherwise we'll find the kernel wait object at an</span>
00694                     <span class="comment">//  offset into the object body</span>
00695                     <span class="comment">//</span>
00696 
00697                     ObjectHeader = (<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a>)(((ULONG_PTR)(HandleEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a>)) &amp; ~<a class="code" href="../../d5/d1/obp_8h.html#a17">OBJ_HANDLE_ATTRIBUTES</a>);
00698 
00699                     <span class="keywordflow">if</span> ((LONG_PTR)ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o3">DefaultObject</a> &lt; 0) {
00700 
00701                         <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a5">RefCount</a> += 1;
00702                         Objects[i] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00703                         WaitObjects[i] = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o3">DefaultObject</a>;
00704 
00705                     } <span class="keywordflow">else</span> {
00706 
00707                         <a class="code" href="../../d5/d1/obp_8h.html#a3">ObpIncrPointerCount</a>( ObjectHeader );
00708                         <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a5">RefCount</a> += 1;
00709                         Objects[i] = &amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o11">Body</a>;
00710 
00711                         <span class="comment">//</span>
00712                         <span class="comment">//  Compute the address of the kernel wait object.</span>
00713                         <span class="comment">//</span>
00714 
00715                         WaitObjects[i] = (PVOID)((PCHAR)&amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o11">Body</a> +
00716                                                  (ULONG_PTR)ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o3">DefaultObject</a>);
00717                     }
00718                 }
00719 
00720                 <a class="code" href="../../d5/d8/ex_8h.html#a288">ExUnlockHandleTableEntry</a>( HandleTable, HandleEntry );
00721 
00722             } <span class="keywordflow">else</span> {
00723 
00724                 <span class="comment">//</span>
00725                 <span class="comment">//  The entry in the handle table isn't in use</span>
00726                 <span class="comment">//</span>
00727 
00728                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_HANDLE;
00729 
00730                 <span class="keywordflow">goto</span> ServiceFailed;
00731             }
00732 
00733             i += 1;
00734 
00735         } <span class="keywordflow">while</span> (i &lt; <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>);
00736 
00737         <span class="comment">//</span>
00738         <span class="comment">//  At this point the WaitObjects[] is set to the kernel wait objects</span>
00739         <span class="comment">//</span>
00740         <span class="comment">//  Now Check to determine if any of the objects are specified more than</span>
00741         <span class="comment">//  once, but we only need to check this for wait all, with a wait any</span>
00742         <span class="comment">//  the user can specify the same object multiple times.</span>
00743         <span class="comment">//</span>
00744 
00745         <span class="keywordflow">if</span> (WaitType == WaitAll) {
00746 
00747             i = 0;
00748 
00749             <span class="keywordflow">do</span> {
00750 
00751                 <span class="keywordflow">for</span> (j = i + 1; j &lt; <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>; j += 1) {
00752 
00753                     <span class="keywordflow">if</span> (WaitObjects[i] == WaitObjects[j]) {
00754 
00755                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_MIX;
00756 
00757                         <span class="keywordflow">goto</span> ServiceFailed;
00758                     }
00759                 }
00760 
00761                 i += 1;
00762 
00763             } <span class="keywordflow">while</span> (i &lt; <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>);
00764         }
00765 
00766         <span class="comment">//</span>
00767         <span class="comment">//  Wait for the specified objects to attain a state of Signaled or a</span>
00768         <span class="comment">//  time out to occur.  Protect the wait call just in case KeWait decides</span>
00769         <span class="comment">//  to raise For example, a mutant level is exceeded</span>
00770         <span class="comment">//</span>
00771 
00772         <span class="keywordflow">try</span> {
00773 
00774             InCriticalRegion = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00775             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00776             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a3">KeWaitForMultipleObjects</a>( Count,
00777                                                WaitObjects,
00778                                                WaitType,
00779                                                UserRequest,
00780                                                PreviousMode,
00781                                                Alertable,
00782                                                Timeout,
00783                                                WaitBlockArray );
00784 
00785         } except(EXCEPTION_EXECUTE_HANDLER) {
00786 
00787             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00788         }
00789 
00790         <span class="comment">//</span>
00791         <span class="comment">//  If any objects were referenced, then deference them.</span>
00792         <span class="comment">//</span>
00793 
00794     ServiceFailed:
00795 
00796         <span class="keywordflow">while</span> (<a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a5">RefCount</a> &gt; 0) {
00797 
00798             <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a5">RefCount</a> -= 1;
00799 
00800             <span class="keywordflow">if</span> (Objects[<a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a5">RefCount</a>] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00801 
00802                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Objects[RefCount]);
00803             }
00804         }
00805 
00806         <span class="comment">//</span>
00807         <span class="comment">//  If are attached to the system process then return back to our callers</span>
00808         <span class="comment">//  process</span>
00809 
00810         <span class="keywordflow">if</span> (AttachedToProcess) {
00811             <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
00812             AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00813         }
00814 
00815         <span class="comment">//</span>
00816         <span class="comment">//  If a wait block array was allocated, then deallocate it.</span>
00817         <span class="comment">//</span>
00818 
00819         <span class="keywordflow">if</span> (WaitBlockArray != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00820 
00821             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(WaitBlockArray);
00822         }
00823 
00824     } finally {
00825 
00826         <span class="keywordflow">if</span> ( InCriticalRegion ) {
00827 
00828             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00829         }
00830     }
00831 
00832     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00833 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="obwait.c::NtWaitForSingleObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtWaitForSingleObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Alertable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER Timeout&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/obwait_8c-source.html#l00282">282</a> of file <a class="el" href="../../d2/d1/obwait_8c-source.html">obwait.c</a>.
<p>
References <a class="el" href="../../d5/d9/ob_8h-source.html#l00190">_OBJECT_TYPE::DefaultObject</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01391">ProbeAndReadLargeInteger</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, and <a class="el" href="../../d4/d9/ke_8h.html#a407a204">UserRequest</a>.
<p>
Referenced by <a class="el" href="../../d3/d9/server_2exitwin_8c-source.html#l00050">_ExitWindowsEx()</a>, <a class="el" href="../../d5/d9/dlluistb_8c-source.html#l00093">DbgUiWaitStateChange()</a>, <a class="el" href="../../d8/d7/ntcon_2server_2clipbrd_8c-source.html#l01008">DoPaste()</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00104">FsRtlpRegisterProviderWithMUP()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00626">InitWindowsStuff()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l03451">KillProcess()</a>, <a class="el" href="../../d6/d1/rtnotify_8c-source.html#l00080">main()</a>, <a class="el" href="../../d6/d4/rdwr_8c-source.html#l00050">NTFastDOSIO()</a>, <a class="el" href="../../d4/d2/tob_8c-source.html#l00187">obtest()</a>, <a class="el" href="../../d7/d3/icamsg_8c-source.html#l00167">RemoteMessageThread()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00515">RtlAcquireResourceExclusive()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00350">RtlAcquireResourceShared()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00851">RtlConvertSharedToExclusive()</a>, <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l00399">RtlDestroyQueryDebugBuffer()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01544">RtlpWaitForCriticalSection()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05503">RtlpWaitForEvent()</a>, <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l00469">RtlQueryProcessDebugInformation()</a>, <a class="el" href="../../d8/d6/lpcsvr_8c-source.html#l00552">RtlShutdownLpcServer()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l01582">SepClientOpenPipe()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l01258">SepReadPipe()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l01520">SepServerDisconnectPipe()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l01482">SepServerImpersonatePipe()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l01028">SepServerInitialize()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l01443">SepServerListenPipe()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l01330">SepTransceivePipe()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l01293">SepWritePipe()</a>, <a class="el" href="../../d9/d3/ntcon_2client_2getset_8c-source.html#l01356">SetConsoleCP()</a>, <a class="el" href="../../d7/d3/client_2private_8c-source.html#l00225">SetConsoleDisplayMode()</a>, <a class="el" href="../../d8/d7/ntcon_2server_2clipbrd_8c-source.html#l00452">StoreSelection()</a>, <a class="el" href="../../d4/d1/ofsmisc_8c-source.html#l00036">SynchronousNtFsControlFile()</a>, <a class="el" href="../../d3/d7/api_8c-source.html#l00279">TerminalServerRequestThread()</a>, <a class="el" href="../../d9/d6/udbgk_8c-source.html#l00069">UdbgTest1()</a>, <a class="el" href="../../d9/d6/udbgk_8c-source.html#l00280">UdbgTest2()</a>, <a class="el" href="../../d3/d9/server_2exitwin_8c-source.html#l00219">UserClientShutdown()</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01686">UserHardErrorEx()</a>, <a class="el" href="../../d8/d1/power_8c-source.html#l00845">VideoPortCallout()</a>, and <a class="el" href="../../d6/d0/w32_2ntcon_2server_2bitmap_8c-source.html#l00293">WriteRegionToScreenBitMap()</a>.
<p>
<pre class="fragment"><div>00290                    :
00291 
00292     This function waits until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified object attains a state of
00293     Signaled.  An optional timeout can also be specified.  If a timeout
00294     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait will not be satisfied until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00295     object attains a state of Signaled.  If a timeout <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified, and
00296     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object has not attained a state of Signaled when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timeout
00297     expires, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> automatically satisfied.  If an <span class="keyword">explicit</span>
00298     timeout value of zero <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified, then no wait will occur <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00299     wait cannot be satisfied immediately.  The wait can also be specified
00300     as alertable.
00301 
00302 Arguments:
00303 
00304     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>  - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait object.
00305 
00306     Alertable - Supplies a <span class="keywordtype">boolean</span> value that specifies whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait
00307         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> alertable.
00308 
00309     Timeout - Supplies an pointer to an absolute or relative time over
00310         which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to occur.
00311 
00312 Return Value:
00313 
00314     The wait completion status. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of STATUS_TIMEOUT <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> a
00315     timeout occurred.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of STATUS_SUCCESS <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00316     object satisfied <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of STATUS_ALERTED <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00317     wait was aborted to deliver an alert to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of
00318     STATUS_USER_APC <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait was aborted to deliver a user
00319     APC to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread.
00320 
00321 --*/
00322 
00323 {
00324     PVOID Object;
00325     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00326     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00327     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00328     LARGE_INTEGER TimeoutValue;
00329     PVOID WaitObject;
00330 
00331     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00332 
00333     <span class="comment">//</span>
00334     <span class="comment">//  Get previous processor mode and probe and capture timeout argument</span>
00335     <span class="comment">//  if necessary.</span>
00336     <span class="comment">//</span>
00337 
00338     PreviousMode = KeGetPreviousMode();
00339 
00340     <span class="keywordflow">if</span> ((ARGUMENT_PRESENT(Timeout)) &amp;&amp; (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>)) {
00341 
00342         <span class="keywordflow">try</span> {
00343 
00344             TimeoutValue = <a class="code" href="../../d5/d8/ex_8h.html#a24">ProbeAndReadLargeInteger</a>(Timeout);
00345             Timeout = &amp;TimeoutValue;
00346 
00347         } except(EXCEPTION_EXECUTE_HANDLER) {
00348 
00349             <span class="keywordflow">return</span> GetExceptionCode();
00350         }
00351     }
00352 
00353     <span class="comment">//</span>
00354     <span class="comment">//  Get a referenced pointer to the specified object with synchronize</span>
00355     <span class="comment">//  access.</span>
00356     <span class="comment">//</span>
00357 
00358     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( Handle,
00359                                         SYNCHRONIZE,
00360                                         NULL,
00361                                         PreviousMode,
00362                                         &amp;Object,
00363                                         NULL );
00364 
00365     <span class="comment">//</span>
00366     <span class="comment">//  If access is granted, then check to determine if the specified object</span>
00367     <span class="comment">//  can be waited on.</span>
00368     <span class="comment">//</span>
00369 
00370     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00371 
00372         ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
00373         WaitObject = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o3">DefaultObject</a>;
00374 
00375         <span class="keywordflow">if</span> ((LONG_PTR)WaitObject &gt;= 0) {
00376 
00377             WaitObject = (PVOID)((PCHAR)Object + (ULONG_PTR)WaitObject);
00378         }
00379 
00380         <span class="comment">//</span>
00381         <span class="comment">//  Protect the wait call just in case KeWait decides to raise</span>
00382         <span class="comment">//  For example, a mutant level is exceeded</span>
00383         <span class="comment">//</span>
00384 
00385         <span class="keywordflow">try</span> {
00386 
00387             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( WaitObject,
00388                                             UserRequest,
00389                                             PreviousMode,
00390                                             Alertable,
00391                                             Timeout );
00392 
00393         } except(EXCEPTION_EXECUTE_HANDLER) {
00394 
00395             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00396         }
00397 
00398         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Object);
00399     }
00400 
00401     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00402 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="obwait.c::ObWaitForSingleObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObWaitForSingleObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Alertable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER Timeout&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/obwait_8c-source.html#l00837">837</a> of file <a class="el" href="../../d2/d1/obwait_8c-source.html">obwait.c</a>.
<p>
References <a class="el" href="../../d5/d9/ob_8h-source.html#l00190">_OBJECT_TYPE::DefaultObject</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, and <a class="el" href="../../d4/d9/ke_8h.html#a407a204">UserRequest</a>.
<p>
<pre class="fragment"><div>00845                    :
00846 
00847     Please refer to <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>
00848 
00849 Arguments:
00850 
00851     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>  - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait object.
00852 
00853     Alertable - Supplies a <span class="keywordtype">boolean</span> value that specifies whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait
00854         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> alertable.
00855 
00856     Timeout - Supplies an pointer to an absolute or relative time over
00857         which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to occur.
00858 
00859 Return Value:
00860 
00861     The wait completion status. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of STATUS_TIMEOUT <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> a
00862     timeout occurred.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of STATUS_SUCCESS <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00863     object satisfied <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of STATUS_ALERTED <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00864     wait was aborted to deliver an alert to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of
00865     STATUS_USER_APC <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait was aborted to deliver a user
00866     APC to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread.
00867 
00868 --*/
00869 
00870 {
00871     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00872     PVOID Object;
00873     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00874     PVOID WaitObject;
00875 
00876     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00877 
00878     <span class="comment">//</span>
00879     <span class="comment">//  Get a referenced pointer to the specified object with synchronize</span>
00880     <span class="comment">//  access.</span>
00881     <span class="comment">//</span>
00882 
00883     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( Handle,
00884                                         SYNCHRONIZE,
00885                                         (<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>)NULL,
00886                                         KernelMode,
00887                                         &amp;Object,
00888                                         NULL );
00889 
00890     <span class="comment">//</span>
00891     <span class="comment">//  If access is granted, then check to determine if the specified object</span>
00892     <span class="comment">//  can be waited on.</span>
00893     <span class="comment">//</span>
00894 
00895     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00896 
00897         ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
00898 
00899         <span class="keywordflow">if</span> ((LONG_PTR)ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o3">DefaultObject</a> &lt; 0) {
00900 
00901             WaitObject = (PVOID)ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o3">DefaultObject</a>;
00902 
00903         } <span class="keywordflow">else</span> {
00904 
00905             WaitObject = (PVOID)((PCHAR)Object + (ULONG_PTR)ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o3">DefaultObject</a>);
00906         }
00907 
00908         <span class="comment">//</span>
00909         <span class="comment">//  Protect the wait call just in case KeWait decides</span>
00910         <span class="comment">//  to raise For example, a mutant level is exceeded</span>
00911         <span class="comment">//</span>
00912 
00913         <span class="keywordflow">try</span> {
00914 
00915             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( WaitObject,
00916                                             UserRequest,
00917                                             KernelMode,
00918                                             Alertable,
00919                                             Timeout );
00920 
00921         } except(EXCEPTION_EXECUTE_HANDLER) {
00922 
00923             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00924         }
00925 
00926         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Object);
00927     }
00928 
00929     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00930 }
}
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a0" doxytag="obwait.c::ExEventObjectType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="el" href="../../d4/d1/userk_8h.html#a786">ExEventObjectType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/obwait_8c-source.html#l00032">32</a> of file <a class="el" href="../../d2/d1/obwait_8c-source.html">obwait.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="obwait.c::ExMutantObjectType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="el" href="../../d1/d2/obwait_8c.html#a1">ExMutantObjectType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/obwait_8c-source.html#l00033">33</a> of file <a class="el" href="../../d2/d1/obwait_8c-source.html">obwait.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d4/mutant_8c-source.html#l00095">ExpMutantInitialization()</a>, <a class="el" href="../../d3/d4/mutant_8c-source.html#l00156">NtCreateMutant()</a>, <a class="el" href="../../d3/d4/mutant_8c-source.html#l00280">NtOpenMutant()</a>, <a class="el" href="../../d3/d4/mutant_8c-source.html#l00380">NtQueryMutant()</a>, <a class="el" href="../../d3/d4/mutant_8c-source.html#l00521">NtReleaseMutant()</a>, and <a class="el" href="../../d2/d1/obwait_8c-source.html#l00038">NtSignalAndWaitForSingleObject()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="obwait.c::ExSemaphoreObjectType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="el" href="../../d9/d4/vdmints_8c.html#a1">ExSemaphoreObjectType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/obwait_8c-source.html#l00034">34</a> of file <a class="el" href="../../d2/d1/obwait_8c-source.html">obwait.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:59 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
