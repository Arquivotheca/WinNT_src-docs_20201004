<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: dsocode.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>dsocode.c</h1><a href="../../d0/d3/dsocode_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: dsocode.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This file contains the dump structure offset (dso) extension. It is</span>
00007 <span class="comment">*  included by $(ALT_PROJECT)\dsotable.c which is generated by structo.exe</span>
00008 <span class="comment">*</span>
00009 <span class="comment">* History:</span>
00010 <span class="comment">* 06/17/96 GerardoB Created</span>
00011 <span class="comment">\***************************************************************************/</span>
00012 <span class="preprocessor">#include &lt;stdexts.h&gt;</span>
00013 
<a name="l00014"></a><a class="code" href="../../d0/d3/dsocode_8c.html#a0">00014</a> <span class="preprocessor">#define DsoPrint(x) Print("%.*s", nIndent, "                      "); Print x</span>
00015 <span class="preprocessor"></span>
<a name="l00016"></a><a class="code" href="../../d0/d3/dsocode_8c.html#a1">00016</a> <span class="preprocessor">#define EXACT_MATCH 0xFFFF</span>
00017 <span class="preprocessor"></span>
<a name="l00018"></a><a class="code" href="../../d0/d3/dsocode_8c.html#a3">00018</a> <span class="keywordtype">int</span> <a class="code" href="../../d0/d3/dsocode_8c.html#a3">gnIndent</a> = 0; <span class="comment">// caller should set and restore this appropriately.</span>
00019 
00020 <span class="comment">/***************************************************************************\</span>
00021 <span class="comment">* dsoTerminateString</span>
00022 <span class="comment">*</span>
00023 <span class="comment">* This is used to "parse" the command line. It null-terminates a space</span>
00024 <span class="comment">*  delimited string, returns its size and a pointer to the begining</span>
00025 <span class="comment">*  of next string</span>
00026 <span class="comment">*</span>
00027 <span class="comment">* 06/17/96 Created Gerardob</span>
00028 <span class="comment">\***************************************************************************/</span>
<a name="l00029"></a><a class="code" href="../../d0/d3/dsocode_8c.html#a4">00029</a> LPSTR <a class="code" href="../../d0/d3/dsocode_8c.html#a4">dsoTerminateString</a>(LPSTR psz, PDWORD pdwSize)
00030 {
00031     LPSTR pszWork = psz;
00032 
00033     <span class="keywordflow">while</span> (*pszWork != 0) {
00034         <span class="keywordflow">if</span> (*pszWork == <span class="charliteral">' '</span>) {
00035             *pszWork++ = 0;
00036             <span class="keywordflow">break</span>;
00037         }
00038         pszWork++;
00039     }
00040 
00041     *pdwSize = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(pszWork - psz);
00042     <span class="keywordflow">if</span> (*pszWork != 0) {
00043         (*pdwSize)--;
00044     }
00045 
00046     <span class="keywordflow">while</span> ((*pszWork != 0) &amp;&amp; (*pszWork == <span class="charliteral">' '</span>)) {
00047         pszWork++;
00048     }
00049 
00050     <span class="keywordflow">return</span> pszWork;
00051 }
00052 <span class="comment">/***************************************************************************\</span>
00053 <span class="comment">* dsoGetOffset</span>
00054 <span class="comment">*</span>
00055 <span class="comment">* If the highest order bit of psot-&gt;dwOffset is set, then the value is a</span>
00056 <span class="comment">*  relative offset from the previous field; otherwise, it is the</span>
00057 <span class="comment">*  actual field offset from the beginning of the structure</span>
00058 <span class="comment">*</span>
00059 <span class="comment">* 06/20/96 Created Gerardob</span>
00060 <span class="comment">\***************************************************************************/</span>
<a name="l00061"></a><a class="code" href="../../d0/d3/dsocode_8c.html#a5">00061</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d0/d3/dsocode_8c.html#a5">dsoGetOffset</a> (PSTRUCTUREOFFSETSTABLE psot)
00062 {
00063     <span class="keywordflow">if</span> (!(psot-&gt;dwOffset &amp; 0x80000000)) {
00064         <span class="keywordflow">return</span> psot-&gt;dwOffset;
00065     } <span class="keywordflow">else</span> {
00066         <span class="keywordflow">return</span> ((psot-&gt;dwOffset &amp; ~0x80000000) + <a class="code" href="../../d0/d3/dsocode_8c.html#a5">dsoGetOffset</a>(psot - 1));
00067     }
00068 }
00069 <span class="comment">/***************************************************************************\</span>
00070 <span class="comment">* dsoGetSize</span>
00071 <span class="comment">*</span>
00072 <span class="comment">* The field size is calculated by substracting its offset from the next</span>
00073 <span class="comment">*  field's offset. If the struct has unions, several "fields" might have</span>
00074 <span class="comment">*  the same offset, or a given table entry (i.e., a field) might have an</span>
00075 <span class="comment">*  offset value greater than the offset value for the next entry (a union</span>
00076 <span class="comment">*  of two structures).</span>
00077 <span class="comment">*</span>
00078 <span class="comment">* 06/26/96 Created Gerardob</span>
00079 <span class="comment">\***************************************************************************/</span>
<a name="l00080"></a><a class="code" href="../../d0/d3/dsocode_8c.html#a6">00080</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d0/d3/dsocode_8c.html#a6">dsoGetSize</a> (PSTRUCTUREOFFSETSTABLE psot, DWORD dwOffset)
00081 {
00082     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwNextFieldOffset;
00083 
00084     <span class="keywordflow">do</span> {
00085         psot++;
00086         dwNextFieldOffset = <a class="code" href="../../d0/d3/dsocode_8c.html#a5">dsoGetOffset</a>(psot);
00087     } <span class="keywordflow">while</span> (dwNextFieldOffset &lt;= dwOffset);
00088 
00089     <span class="keywordflow">return</span> dwNextFieldOffset - dwOffset;
00090 }
00091 <span class="comment">/***************************************************************************\</span>
00092 <span class="comment">* dsoGetStruct</span>
00093 <span class="comment">*</span>
00094 <span class="comment">* 07/03/96 Created Gerardob</span>
00095 <span class="comment">\***************************************************************************/</span>
<a name="l00096"></a><a class="code" href="../../d0/d3/dsocode_8c.html#a7">00096</a> PSTRUCTURESTABLE <a class="code" href="../../d0/d3/dsocode_8c.html#a7">dsoGetStruct</a> (LPSTR pszStruct, DWORD dwSize)
00097 {
00098     PSTRUCTURESTABLE pst = gst;
00099 
00100     <span class="comment">/*</span>
00101 <span class="comment">     * If dwSize is EXACT_MATCH, we try an exact</span>
00102 <span class="comment">     * case sensitive match</span>
00103 <span class="comment">     */</span>
00104     <span class="keywordflow">if</span> (dwSize == <a class="code" href="../../d0/d3/dsocode_8c.html#a1">EXACT_MATCH</a>) {
00105         <span class="keywordflow">while</span> (pst-&gt;pszName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00106             <span class="keywordflow">if</span> (!strcmp(pszStruct, pst-&gt;pszName)) {
00107                 <span class="keywordflow">return</span> pst;
00108             }
00109             pst++;
00110         }
00111         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00112     }
00113     <span class="comment">/*</span>
00114 <span class="comment">     * Try an exact case insensitive match</span>
00115 <span class="comment">     */</span>
00116     <span class="keywordflow">while</span> (pst-&gt;pszName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00117         <span class="keywordflow">if</span> (!_stricmp(pszStruct, pst-&gt;pszName)) {
00118             <span class="keywordflow">return</span> pst;
00119         }
00120         pst++;
00121     }
00122 
00123     <span class="comment">/*</span>
00124 <span class="comment">     * Partial prefix match</span>
00125 <span class="comment">     */</span>
00126     pst = gst;
00127     <span class="keywordflow">while</span> (pst-&gt;pszName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00128         <span class="keywordflow">if</span> (!_strnicmp(pszStruct, pst-&gt;pszName, dwSize)) {
00129             <span class="keywordflow">return</span> pst;
00130         }
00131         pst++;
00132     }
00133 
00134     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00135 
00136 }
00137 <span class="comment">/***************************************************************************\</span>
00138 <span class="comment">* dsoGetField</span>
00139 <span class="comment">*</span>
00140 <span class="comment">* 07/03/96 Created Gerardob</span>
00141 <span class="comment">\***************************************************************************/</span>
<a name="l00142"></a><a class="code" href="../../d0/d3/dsocode_8c.html#a8">00142</a> PSTRUCTUREOFFSETSTABLE <a class="code" href="../../d0/d3/dsocode_8c.html#a8">dosGetField</a> (PSTRUCTUREOFFSETSTABLE psot, LPSTR pszField, DWORD dwSize)
00143 {
00144     PSTRUCTUREOFFSETSTABLE psotFirst = psot;
00145 
00146     <span class="comment">/*</span>
00147 <span class="comment">     * try an exact match</span>
00148 <span class="comment">     */</span>
00149     <span class="keywordflow">while</span> (psot-&gt;pszField != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00150         <span class="keywordflow">if</span> (!_stricmp(pszField, psot-&gt;pszField)) {
00151             <span class="keywordflow">return</span> psot;
00152         }
00153         psot++;
00154     }
00155 
00156     <span class="comment">/*</span>
00157 <span class="comment">     * Partial prefix match</span>
00158 <span class="comment">     */</span>
00159     psot = psotFirst;
00160     <span class="keywordflow">while</span> (psot-&gt;pszField != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00161         <span class="keywordflow">if</span> (!_strnicmp(pszField, psot-&gt;pszField, dwSize)) {
00162             <span class="keywordflow">return</span> psot;
00163         }
00164         psot++;
00165     }
00166     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00167 
00168 }
00169 <span class="comment">/***************************************************************************\</span>
00170 <span class="comment">* Idso</span>
00171 <span class="comment">*</span>
00172 <span class="comment">* !dso StructName [FieldName] [Address]</span>
00173 <span class="comment">*</span>
00174 <span class="comment">* 06/17/96 Created Gerardob</span>
00175 <span class="comment">* 05/12/97 MCostea Added bit field support</span>
00176 <span class="comment">\***************************************************************************/</span>
00177 
<a name="l00178"></a><a class="code" href="../../d0/d3/dsocode_8c.html#a2">00178</a> <span class="preprocessor">#define NFIELDS 2  // per row.</span>
00179 <span class="preprocessor"></span>
<a name="l00180"></a><a class="code" href="../../d0/d3/dsocode_8c.html#a9">00180</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d3/dsocode_8c.html#a9">DsoDump</a>(
00181     DWORD opts,
00182     PSTRUCTUREOFFSETSTABLE psot,
00183     PSTRUCTURESTABLE pst,
00184     PVOID pAddress,
00185     BOOL fOneField)
00186 {
00187     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwValue, dwSize, dwMoveSize, dwBytesRead, dwOffset, dwOffsetNext, dwFieldsPerRow;
00188     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *pdwValue;
00189     PSTRUCTURESTABLE pstNested;
00190     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwBuffer [20];  <span class="comment">/* Make sure it has an even number of elemnts and at least 4*/</span>
00191     <span class="keyword">const</span> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *pcdwLimit = dwBuffer + (<span class="keyword">sizeof</span>(dwBuffer) / <span class="keyword">sizeof</span>(*dwBuffer));
00192     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> pBufferOffset;
00193     <span class="keywordtype">char</span>* pTmp;
00194     <span class="keywordtype">int</span>   nIndent = <a class="code" href="../../d0/d3/dsocode_8c.html#a3">gnIndent</a>;    <span class="comment">/* amount to indent */</span>
00195 
00196     <span class="keywordtype">int</span>   cBFStart, cBFLength;   <span class="comment">/* for printing bit field values: keeps count of field location */</span>
00197     <span class="keywordtype">int</span>   cBF;                   <span class="comment">/* no of dwords this set of bit-fields spread till now */</span>
00198     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwMask;
00199     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  fBF;
00200     <span class="keywordtype">int</span>   cchName;               <span class="comment">/* length of field name */</span>
00201 
00202 
00203     <span class="comment">/*</span>
00204 <span class="comment">     * If a field name was specified, dump that field only</span>
00205 <span class="comment">     * Otherwise, dump the whole table.</span>
00206 <span class="comment">     */</span>
00207     <span class="keywordflow">if</span> (fOneField) {
00208         <span class="comment">/*</span>
00209 <span class="comment">         * If no address available, just display the field name and offset</span>
00210 <span class="comment">         */</span>
00211         dwOffset = <a class="code" href="../../d0/d3/dsocode_8c.html#a5">dsoGetOffset</a>(psot);
00212 
00213         <a class="code" href="../../d0/d3/dsocode_8c.html#a0">DsoPrint</a>((<span class="stringliteral">"Structure %s - Size: %#lx\n"</span>, pst-&gt;pszName, pst-&gt;dwSize));
00214 
00215         <span class="comment">/*</span>
00216 <span class="comment">         * Try to see if the fields are not nested structures</span>
00217 <span class="comment">         */</span>
00218         <span class="keywordflow">if</span> (*psot-&gt;pszField &gt;= <span class="charliteral">'A'</span> &amp;&amp; *psot-&gt;pszField &lt;= <span class="charliteral">'Z'</span>) {
00219             <span class="comment">/*</span>
00220 <span class="comment">             * Probably the field is a nested structure</span>
00221 <span class="comment">             */</span>
00222             <span class="keywordflow">if</span> (pstNested = <a class="code" href="../../d0/d3/dsocode_8c.html#a7">dsoGetStruct</a> (psot-&gt;pszField, <a class="code" href="../../d0/d3/dsocode_8c.html#a1">EXACT_MATCH</a>)) {
00223                 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwNestedOffset = <a class="code" href="../../d0/d3/dsocode_8c.html#a5">dsoGetOffset</a>(psot);
00224                 <span class="keywordtype">char</span> cmdLine[80];
00225                 <a class="code" href="../../d0/d3/dsocode_8c.html#a0">DsoPrint</a>((<span class="stringliteral">"\nNested at offset %03lx: "</span>, dwNestedOffset));
00226                 <span class="keywordflow">if</span> (pAddress) {
00227                     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(cmdLine, <span class="stringliteral">"%s %p"</span>, psot-&gt;pszField, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pAddress + dwNestedOffset);
00228                     pTmp = cmdLine;
00229                 }
00230                 <span class="keywordflow">else</span> {
00231                     pTmp = psot-&gt;pszField;
00232                 }
00233                 <span class="keywordflow">return</span> <a class="code" href="../../d0/d3/dsocode_8c.html#a10">Idso</a>(opts, pTmp);
00234             }
00235         }
00236 
00237         <a class="code" href="../../d0/d3/dsocode_8c.html#a0">DsoPrint</a>((<span class="stringliteral">"Field: %s - Offset: %#lx\n"</span>, psot-&gt;pszField, dwOffset));
00238         <span class="keywordflow">if</span> (pAddress == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00239             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00240         }
00241 
00242         <span class="comment">/*</span>
00243 <span class="comment">         * Printing field value</span>
00244 <span class="comment">         */</span>
00245 
00246         <span class="comment">/*123456789 1*/</span>
00247         <a class="code" href="../../d0/d3/dsocode_8c.html#a0">DsoPrint</a>((<span class="stringliteral">"Address   Value\n"</span>));
00248 
00249         dwBytesRead = 0;
00250         dwSize = <a class="code" href="../../d0/d3/dsocode_8c.html#a6">dsoGetSize</a>(psot, dwOffset);
00251         <span class="comment">/*</span>
00252 <span class="comment">         * Print 4 DWORDS per row; one row per loop</span>
00253 <span class="comment">         */</span>
00254 
00255         <span class="keywordflow">do</span> { <span class="comment">/* while ((int)dwSize &gt; 0) */</span>
00256 
00257             <span class="comment">/*</span>
00258 <span class="comment">             * Read values for next row</span>
00259 <span class="comment">             */</span>
00260             <span class="keywordflow">if</span> (4 * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) &gt;= dwSize) {
00261                 dwMoveSize = dwSize;
00262             } <span class="keywordflow">else</span> {
00263                 dwMoveSize = 4 * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
00264             }
00265             <a class="code" href="../../d7/d4/conexts_8c.html#a2">moveBlock</a>(dwBuffer, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pAddress + dwOffset + dwBytesRead, dwMoveSize);
00266             pBufferOffset = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)dwBuffer;
00267 
00268             <span class="comment">/*</span>
00269 <span class="comment">             * Print the address</span>
00270 <span class="comment">             */</span>
00271             <a class="code" href="../../d0/d3/dsocode_8c.html#a0">DsoPrint</a>((<span class="stringliteral">"%p  "</span>, (DWORD_PTR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pAddress + dwOffset + dwBytesRead)));
00272             <span class="comment">/*</span>
00273 <span class="comment">             * Keep track of bytes read (dwBytesRead) and bytes</span>
00274 <span class="comment">             *  remaining to be read (dwSize)</span>
00275 <span class="comment">             */</span>
00276             dwBytesRead += dwMoveSize;
00277             dwSize -= dwMoveSize;
00278             <span class="comment">/*</span>
00279 <span class="comment">             * Print the values, one dword at the time</span>
00280 <span class="comment">             */</span>
00281             <span class="keywordflow">while</span> (dwMoveSize &gt;= <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)) {
00282                 <a class="code" href="../../d0/d3/dsocode_8c.html#a0">DsoPrint</a>((<span class="stringliteral">"%08lx "</span>, *((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)pBufferOffset)));
00283                 pBufferOffset += <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
00284                 dwMoveSize -= <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
00285             }
00286             <span class="comment">/*</span>
00287 <span class="comment">             * If less than a DWORD left, zero extend and print a DWORD</span>
00288 <span class="comment">             */</span>
00289             <span class="keywordflow">if</span> (dwMoveSize &gt; 0) {
00290                 dwValue = 0;
00291                 memcpy(&amp;dwValue, pBufferOffset, dwMoveSize);
00292                 <a class="code" href="../../d0/d3/dsocode_8c.html#a0">DsoPrint</a>((<span class="stringliteral">"%0*lx"</span>, dwMoveSize * 2, dwValue));
00293             }
00294             Print(<span class="stringliteral">"\n"</span>);
00295 
00296         } <span class="keywordflow">while</span> ((<span class="keywordtype">int</span>)dwSize &gt; 0);
00297 
00298         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00299 
00300     } <span class="comment">/* if (fOneField) */</span>
00301 
00302 
00303     <span class="comment">/*</span>
00304 <span class="comment">     * Printing all the fields.</span>
00305 <span class="comment">     */</span>
00306     <span class="keywordflow">if</span> (pAddress != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00307         <a class="code" href="../../d0/d3/dsocode_8c.html#a0">DsoPrint</a>((<span class="stringliteral">"Structure %s %#lx - Size: %#lx"</span>, pst-&gt;pszName, pAddress, pst-&gt;dwSize));
00308     } <span class="keywordflow">else</span> {
00309         <a class="code" href="../../d0/d3/dsocode_8c.html#a0">DsoPrint</a>((<span class="stringliteral">"Structure %s - Size: %#lx"</span>, pst-&gt;pszName, pst-&gt;dwSize));
00310     }
00311 
00312     dwOffset = 0;
00313     pBufferOffset = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; <span class="comment">/* Forces the local buffer to be loaded */</span>
00314     dwFieldsPerRow = <a class="code" href="../../d0/d3/dsocode_8c.html#a2">NFIELDS</a>;
00315     cBFStart = 0;
00316     cBF = 0;
00317 
00318     <span class="comment">/*</span>
00319 <span class="comment">     * Loop through all fields in the table. Print one field per loop</span>
00320 <span class="comment">     */</span>
00321 
00322     <span class="keywordflow">while</span> (psot-&gt;pszField != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00323         <span class="comment">/*</span>
00324 <span class="comment">         * Print two fields per row</span>
00325 <span class="comment">         */</span>
00326         <span class="keywordflow">if</span> (dwFieldsPerRow == <a class="code" href="../../d0/d3/dsocode_8c.html#a2">NFIELDS</a>) {
00327             Print(<span class="stringliteral">"\n"</span>);
00328             dwFieldsPerRow = 1;
00329             cchName = 24 - <a class="code" href="../../d0/d3/dsocode_8c.html#a3">gnIndent</a>/<a class="code" href="../../d0/d3/dsocode_8c.html#a2">NFIELDS</a>;
00330             nIndent = <a class="code" href="../../d0/d3/dsocode_8c.html#a3">gnIndent</a>;
00331             <span class="comment">// Print("cchName = %d\n", cchName);</span>
00332         } <span class="keywordflow">else</span> {
00333             dwFieldsPerRow++;
00334             cchName = 24 - (<a class="code" href="../../d0/d3/dsocode_8c.html#a3">gnIndent</a> + 1)/<a class="code" href="../../d0/d3/dsocode_8c.html#a2">NFIELDS</a>;
00335             nIndent = 0;
00336             <span class="comment">// Print("cchName = %d\n", cchName);</span>
00337         }
00338 
00339         <span class="comment">/*</span>
00340 <span class="comment">         * -v functionality</span>
00341 <span class="comment">         * Try to see if the fields are not nested structures</span>
00342 <span class="comment">         * The naming convention assigns Uppercase names for them</span>
00343 <span class="comment">         */</span>
00344         <span class="keywordflow">if</span> (opts &amp; OFLAG(v)) {
00345             <span class="keywordflow">if</span> (*psot-&gt;pszField &gt;= <span class="charliteral">'A'</span> &amp;&amp; *psot-&gt;pszField &lt;= <span class="charliteral">'Z'</span>) {
00346                 <span class="comment">/*</span>
00347 <span class="comment">                 * Probably the field is a nested structure</span>
00348 <span class="comment">                 */</span>
00349                 <span class="keywordflow">if</span> (pstNested = <a class="code" href="../../d0/d3/dsocode_8c.html#a7">dsoGetStruct</a> (psot-&gt;pszField, <a class="code" href="../../d0/d3/dsocode_8c.html#a1">EXACT_MATCH</a>)) {
00350                     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwNestedOffset = <a class="code" href="../../d0/d3/dsocode_8c.html#a5">dsoGetOffset</a>(psot);
00351                     <span class="keywordtype">char</span> cmdLine[80];
00352                     <a class="code" href="../../d0/d3/dsocode_8c.html#a0">DsoPrint</a>((<span class="stringliteral">"\nNested at offset %03lx: "</span>, dwNestedOffset));
00353                     <span class="keywordflow">if</span> (pAddress) {
00354                         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(cmdLine, <span class="stringliteral">"%s %p"</span>, psot-&gt;pszField, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pAddress + dwNestedOffset);
00355                         pTmp = cmdLine;
00356                     }
00357                     <span class="keywordflow">else</span> {
00358                         pTmp = psot-&gt;pszField;
00359                     }
00360                     <a class="code" href="../../d0/d3/dsocode_8c.html#a10">Idso</a>(opts, pTmp);
00361                     dwOffsetNext = <a class="code" href="../../d0/d3/dsocode_8c.html#a5">dsoGetOffset</a>(psot + 1);
00362                     dwFieldsPerRow = 0;
00363                     <span class="keywordflow">goto</span> Continue;
00364                 }
00365             }
00366         }
00367 
00368         <span class="comment">/*</span>
00369 <span class="comment">         * If no address provided, Print field name(s) and offset(s) only</span>
00370 <span class="comment">         */</span>
00371         <span class="keywordflow">if</span> (pAddress == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00372             <a class="code" href="../../d0/d3/dsocode_8c.html#a0">DsoPrint</a>((<span class="stringliteral">"%03lx %-*.*s"</span>, <a class="code" href="../../d0/d3/dsocode_8c.html#a5">dsoGetOffset</a>(psot),
00373                       cchName, cchName, psot-&gt;pszField));
00374         } <span class="keywordflow">else</span> {
00375             <span class="comment">/*</span>
00376 <span class="comment">             * Printing offsets and values.</span>
00377 <span class="comment">             *</span>
00378 <span class="comment">             * Get the size of the value and max it to one DWORD</span>
00379 <span class="comment">             */</span>
00380             dwOffsetNext = <a class="code" href="../../d0/d3/dsocode_8c.html#a5">dsoGetOffset</a>(psot + 1);
00381             <span class="keywordflow">if</span> (dwOffsetNext &gt; dwOffset) {
00382                 dwSize = dwOffsetNext - dwOffset;
00383             } <span class="keywordflow">else</span> {
00384                 dwSize = <a class="code" href="../../d0/d3/dsocode_8c.html#a6">dsoGetSize</a>(psot, dwOffset);
00385             }
00386             <span class="keywordflow">if</span> (dwSize &gt; <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)) {
00387                 dwSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
00388             }
00389 
00390             <span class="comment">/*</span>
00391 <span class="comment">             * Get a pointer to the value in the local buffer</span>
00392 <span class="comment">             * If the value is not in the buffer, load it</span>
00393 <span class="comment">             */</span>
00394             pdwValue = (PDWORD)(pBufferOffset + dwOffset);
00395             <span class="keywordflow">if</span> ((pdwValue &lt; dwBuffer) || (pdwValue + dwSize &gt; pcdwLimit)) {
00396                 pBufferOffset = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)dwBuffer - dwOffset;
00397                 pdwValue = dwBuffer;
00398 
00399                 <span class="keywordflow">if</span> (<span class="keyword">sizeof</span>(dwBuffer) &gt;= pst-&gt;dwSize - dwOffset) {
00400                     dwMoveSize = pst-&gt;dwSize - dwOffset;
00401                 } <span class="keywordflow">else</span> {
00402                     dwMoveSize = <span class="keyword">sizeof</span>(dwBuffer);
00403                 }
00404                 <a class="code" href="../../d7/d4/conexts_8c.html#a2">moveBlock</a>((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)dwBuffer, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pAddress + dwOffset, dwMoveSize);
00405 
00406             }
00407 
00408             <span class="comment">/*</span>
00409 <span class="comment">             * Copy the value and print it</span>
00410 <span class="comment">             */</span>
00411             dwValue = 0; <span class="comment">/* in case size &lt; sizeof(DWORD) */</span>
00412             memcpy(&amp;dwValue, pdwValue, dwSize);
00413 
00414             <span class="comment">/*</span>
00415 <span class="comment">             * Deal with bit fields</span>
00416 <span class="comment">             */</span>
00417             fBF = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00418             pTmp = psot-&gt;pszField;
00419             <span class="keywordflow">while</span> (*pTmp) {
00420                 <span class="keywordflow">if</span> (*pTmp++ == <span class="charliteral">':'</span>) {
00421 
00422                     fBF = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00423                     <span class="keywordflow">while</span> ((*pTmp == <span class="charliteral">' '</span>) || (*pTmp == <span class="charliteral">'\t'</span>)) {     <span class="comment">/* skip white spaces */</span>
00424                         ++pTmp;
00425                     }
00426                     cBFLength = *(pTmp++) - <span class="charliteral">'0'</span>;      <span class="comment">/* now get the bit size, maybe 2 digits */</span>
00427                     <span class="keywordflow">if</span> ((*pTmp &gt;= <span class="charliteral">'0'</span>) &amp;&amp; (*pTmp &lt;= <span class="charliteral">'9'</span>))
00428                         cBFLength = cBFLength*10 + (*pTmp - <span class="charliteral">'0'</span>);
00429 
00430                     <span class="keywordflow">if</span> (cBFStart == 0) {
00431                         <a class="code" href="../../d0/d3/dsocode_8c.html#a0">DsoPrint</a>((<span class="stringliteral">"(%03lx) %08lx BIT FIELDS\n"</span>, dwOffset, dwValue));
00432                         dwFieldsPerRow = 1;
00433                     }
00434                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cBFStart &gt;= 8*<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)) {   <span class="comment">/* check for multi-dword fields */</span>
00435                         cBF ++;
00436                         cBFStart %= 8*<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
00437                     }
00438 
00439                     dwMask = (1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a> &lt;&lt; cBFLength) - 1;
00440                     dwMask &lt;&lt;= cBFStart;
00441                     <span class="comment">/* print byte offset and the bit offset inside it */</span>
00442                     <a class="code" href="../../d0/d3/dsocode_8c.html#a0">DsoPrint</a>((<span class="stringliteral">"(%03lx) (%d)   %-2x %-*.*s"</span>, dwOffset + cBF*<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) + cBFStart/8, cBFStart &amp; 7,
00443                            (dwMask &amp; dwValue) &gt;&gt; cBFStart,
00444                             cchName, cchName, psot-&gt;pszField));
00445                     cBFStart += cBFLength;
00446                     cBFLength = 0;
00447                     <span class="keywordflow">break</span>;
00448                 }
00449             }
00450             <span class="keywordflow">if</span> (!fBF) {
00451                 <span class="keywordtype">int</span> width = 8;
00452                 <span class="keywordflow">if</span> (dwSize == <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>) || ((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)pdwValue &amp; 1)) {
00453                     dwValue &amp;= 0xff;
00454                     width = 2;
00455                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dwSize == <span class="keyword">sizeof</span>(WORD) || ((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)pdwValue &amp; 2)) {
00456                     dwValue &amp;= 0xffff;
00457                     width = 4;
00458                 }
00459                 <a class="code" href="../../d0/d3/dsocode_8c.html#a0">DsoPrint</a>((<span class="stringliteral">"(%03lx) %*s%0*lx %-*.*s"</span>, dwOffset, 8 - width, <span class="stringliteral">""</span>, width, dwValue,
00460                           cchName, cchName, psot-&gt;pszField));
00461                 cBFStart = 0;
00462                 cBF = 0;
00463             }
00464 
00465         } <span class="comment">/* if (pAddress == NULL) */</span>
00466 
00467 Continue:
00468         dwOffset = dwOffsetNext;
00469         psot++;
00470 
00471     } <span class="comment">/* while (psot-&gt;pszField != NULL) */</span>
00472 
00473     Print(<span class="stringliteral">"\n"</span>);
00474     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00475 }
00476 
00477 
<a name="l00478"></a><a class="code" href="../../d0/d3/dsocode_8c.html#a10">00478</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d3/dsocode_8c.html#a10">Idso</a>(DWORD opts, LPSTR pszCmdLine)
00479 {
00480     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fOneField = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00481     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSize;
00482     LPSTR pszField, pszAddress, pszRepeat;
00483     PSTRUCTURESTABLE pst;
00484     PSTRUCTUREOFFSETSTABLE psot;
00485     PVOID pAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00486     DWORD_PTR nRepeat = 1;
00487     <span class="keywordtype">int</span> nIndent = <a class="code" href="../../d0/d3/dsocode_8c.html#a3">gnIndent</a>;    <span class="comment">/* amount to indent */</span>
00488 
00489     <span class="keywordflow">if</span> (pszCmdLine == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00490         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00491     }
00492 
00493     <span class="comment">/*</span>
00494 <span class="comment">     * Find the struct table</span>
00495 <span class="comment">     */</span>
00496     <span class="keywordflow">while</span> (*pszCmdLine &amp;&amp; *pszCmdLine == <span class="charliteral">' '</span>) {
00497         *pszCmdLine++;
00498     }
00499     pszField = <a class="code" href="../../d0/d3/dsocode_8c.html#a4">dsoTerminateString</a>(pszCmdLine, &amp;dwSize);
00500     pst = <a class="code" href="../../d0/d3/dsocode_8c.html#a7">dsoGetStruct</a> (pszCmdLine, dwSize);
00501     <span class="keywordflow">if</span> (pst == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00502         <a class="code" href="../../d0/d3/dsocode_8c.html#a0">DsoPrint</a>((<span class="stringliteral">"Structure not found: %s\n"</span>, pszCmdLine));
00503         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00504     }
00505 
00506     <span class="comment">/*</span>
00507 <span class="comment">     * Got a table</span>
00508 <span class="comment">     */</span>
00509     psot = pst-&gt;psot;
00510 
00511     <span class="comment">/*</span>
00512 <span class="comment">     * If there is another argument, let's assume a field name follows</span>
00513 <span class="comment">     * first find the field:</span>
00514 <span class="comment">     */</span>
00515     <span class="keywordflow">while</span> (*pszField &amp;&amp; *pszField == <span class="charliteral">' '</span>) {
00516         *pszField++;
00517     }
00518     <span class="keywordflow">if</span> (*pszField != 0) {
00519         pszAddress = <a class="code" href="../../d0/d3/dsocode_8c.html#a4">dsoTerminateString</a>(pszField, &amp;dwSize);
00520         psot = <a class="code" href="../../d0/d3/dsocode_8c.html#a8">dosGetField</a> (psot, pszField, dwSize);
00521         <span class="keywordflow">while</span> (*pszAddress &amp;&amp; *pszAddress == <span class="charliteral">' '</span>) {
00522             *pszAddress++;
00523         }
00524 
00525         <span class="comment">/*</span>
00526 <span class="comment">         * If it didn't find the field and an address was provided, game over.</span>
00527 <span class="comment">         * Otherwise, the second parameter might be the address</span>
00528 <span class="comment">         */</span>
00529         <span class="keywordflow">if</span> (psot == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00530             <span class="keywordflow">if</span> ((*pszAddress != 0) &amp;&amp; (*pszAddress != <span class="charliteral">'*'</span>)) {
00531                 <a class="code" href="../../d0/d3/dsocode_8c.html#a0">DsoPrint</a>((<span class="stringliteral">"Field not found: %s. Struct: %s\n"</span>, pszField, pst-&gt;pszName));
00532                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00533             } <span class="keywordflow">else</span> {
00534                 pszRepeat = pszAddress;
00535                 pszAddress = pszField;
00536                 <span class="comment">/*</span>
00537 <span class="comment">                 * Reset psot since this argument was not a field</span>
00538 <span class="comment">                 */</span>
00539                 psot = pst-&gt;psot;
00540             }
00541         } <span class="keywordflow">else</span> {
00542             fOneField = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00543             pszRepeat = <a class="code" href="../../d0/d3/dsocode_8c.html#a4">dsoTerminateString</a>(pszAddress, &amp;dwSize);
00544             <span class="keywordflow">while</span> (*pszRepeat &amp;&amp; *pszRepeat == <span class="charliteral">' '</span>) {
00545                 *pszRepeat++;
00546             }
00547         }
00548 
00549         <span class="comment">/*</span>
00550 <span class="comment">         * Get the pointer to the struct</span>
00551 <span class="comment">         */</span>
00552         <span class="keywordflow">if</span> (*pszAddress != 0) {
00553             pAddress = EvalExp(pszAddress);
00554             <span class="keywordflow">if</span> (pAddress == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00555                 <span class="comment">/*</span>
00556 <span class="comment">                 * EvalExp displayed the error message, so return silently</span>
00557 <span class="comment">                 */</span>
00558                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00559             }
00560         }
00561 
00562         <span class="comment">/*</span>
00563 <span class="comment">         * Get the repeat count</span>
00564 <span class="comment">         */</span>
00565         <span class="keywordflow">if</span> ((*pszRepeat != 0) &amp;&amp; (*pszRepeat == <span class="charliteral">'*'</span>)) {
00566             nRepeat = (DWORD_PTR)EvalExp(pszRepeat+1);
00567             <span class="keywordflow">if</span> (nRepeat == 0) {
00568                 <span class="comment">/*</span>
00569 <span class="comment">                 * EvalExp displayed the error message, so return silently</span>
00570 <span class="comment">                 */</span>
00571                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00572             }
00573         }
00574     } <span class="comment">/* if (*pszField != 0) */</span>
00575 
00576     <span class="keywordflow">while</span> (nRepeat--) {
00577         <a class="code" href="../../d0/d3/dsocode_8c.html#a9">DsoDump</a>(opts, psot, pst, pAddress, fOneField);
00578         pAddress = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pAddress + pst-&gt;dwSize;
00579     }
00580 
00581     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00582 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:47 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
