<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cmp.h File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cmp.h File Reference</h1><code>#include "<a class="el" href="../../d0/d8/ntos_8h-source.html">ntos.h</a>"</code><br>
<code>#include "<a class="el" href="../../d7/d9/hive_8h-source.html">hive.h</a>"</code><br>
<code>#include "wchar.h"</code><br>
<code>#include "zwapi.h"</code><br>
<code>#include &lt;stdio.h&gt;</code><br>
<code>#include &lt;<a class="el" href="../../d7/d6/profiles_8h-source.html">profiles.h</a>&gt;</code><br>
<code>#include "<a class="el" href="../../d0/d0/cmdata_8h-source.html">cmdata.h</a>"</code><br>

<p>
<a href="../../d2/d1/cmp_8h-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">_BOOT_DRIVER_NODE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d4/struct__CM__KEY__BODY.html">_CM_KEY_BODY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/struct__CM__POST__KEY__BODY.html">_CM_POST_KEY_BODY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">_CM_NOTIFY_BLOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/struct__CM__SYNC__POST__BLOCK.html">_CM_SYNC_POST_BLOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html">_CM_ASYNC_USER_POST_BLOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d3/struct__CM__ASYNC__KERNEL__POST__BLOCK.html">_CM_ASYNC_KERNEL_POST_BLOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>union &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html">_CM_POST_BLOCK_UNION</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">_CM_POST_BLOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d6/struct__CMHIVE.html">_CMHIVE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d3/struct__REGISTRY__COMMAND.html">_REGISTRY_COMMAND</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">_CM_PARSE_CONTEXT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d7/struct__HIVE__LIST__ENTRY.html">_HIVE_LIST_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html">_CM_HARDWARE_PROFILE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">_CM_HARDWARE_PROFILE_LIST</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/struct__CM__HARDWARE__PROFILE__ALIAS.html">_CM_HARDWARE_PROFILE_ALIAS</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/struct__CM__HARDWARE__PROFILE__ALIAS__LIST.html">_CM_HARDWARE_PROFILE_ALIAS_LIST</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS.html">_CM_HARDWARE_PROFILE_ACPI_ALIAS</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS__LIST.html">_CM_HARDWARE_PROFILE_ACPI_ALIAS_LIST</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a0">_CM_ENTRYLIST_MANIPULATION</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(a)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a2">CmpClearListEntry</a>(a)&nbsp;&nbsp;&nbsp;(a)-&gt;Flink = (a)-&gt;Blink = NULL</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a3">_WMI_TRACING_REGISTRYCALLS</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a4">CmpWmiFireEvent</a>(<a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>, KeyHandle, ElapsedTime, <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>, Type)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a5">StartWmiCmTrace</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(<a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>, <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>, Type)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a7">CmpMakeSpecialPoolReadOnly</a>(a)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a8">CmpMakeSpecialPoolReadWrite</a>(a)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a9">CmpMakeValueCacheReadOnly</a>(a, b)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a10">CmpMakeValueCacheReadWrite</a>(a, b)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a11">HvpChangeBinAllocation</a>(a, b)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a12">HvpMarkBinReadWrite</a>(a, b)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(a)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a14">CmpAllocateTag</a>(a, b, <a class="el" href="../../d7/d1/genuedef_8c.html#a8">c</a>)&nbsp;&nbsp;&nbsp;CmpAllocate(a,b)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a15">CM_CACHE_FAKE_KEY</a>&nbsp;&nbsp;&nbsp;0x00000001</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a16">LOCK_KCB_TREE</a>()&nbsp;&nbsp;&nbsp;ExAcquireFastMutexUnsafe(&amp;<a class="el" href="../../d1/d3/cmsysini_8c.html#a11">CmpKcbLock</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>()&nbsp;&nbsp;&nbsp;ExReleaseFastMutexUnsafe(&amp;<a class="el" href="../../d1/d3/cmsysini_8c.html#a11">CmpKcbLock</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>&nbsp;&nbsp;&nbsp;2</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a20">CML_API_ARGS</a>&nbsp;&nbsp;&nbsp;3</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a21">CML_WORKER</a>&nbsp;&nbsp;&nbsp;4</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>&nbsp;&nbsp;&nbsp;5</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a23">CML_MINOR</a>&nbsp;&nbsp;&nbsp;6</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>&nbsp;&nbsp;&nbsp;7</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a25">CML_BIN</a>&nbsp;&nbsp;&nbsp;8</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a26">CMS_MAP</a>&nbsp;&nbsp;&nbsp;0x00000001</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>&nbsp;&nbsp;&nbsp;0x00000002</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>&nbsp;&nbsp;&nbsp;0x00000004</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a29">CMS_HIVE</a>&nbsp;&nbsp;&nbsp;0x00000008</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a30">CMS_IO</a>&nbsp;&nbsp;&nbsp;0x00000010</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a31">CMS_PARSE</a>&nbsp;&nbsp;&nbsp;0x00000020</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a32">CMS_SAVRES</a>&nbsp;&nbsp;&nbsp;0x00000040</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a33">CMS_CM</a>&nbsp;&nbsp;&nbsp;0x00000080</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a34">CMS_SEC</a>&nbsp;&nbsp;&nbsp;0x00000100</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a35">CMS_POOL</a>&nbsp;&nbsp;&nbsp;0x00000200</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a36">CMS_LOCKING</a>&nbsp;&nbsp;&nbsp;0x00000400</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a37">CMS_NOTIFY</a>&nbsp;&nbsp;&nbsp;0x00000800</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a38">CMS_EXCEPTION</a>&nbsp;&nbsp;&nbsp;0x00001000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a39">CMS_INDEX</a>&nbsp;&nbsp;&nbsp;0x00002000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a40">CMS_BIN_MAP</a>&nbsp;&nbsp;&nbsp;0x00004000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a41">CMS_MAP_ERROR</a>&nbsp;&nbsp;&nbsp;0x00010000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>&nbsp;&nbsp;&nbsp;0x00020000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a43">CMS_NTAPI_ERROR</a>&nbsp;&nbsp;&nbsp;0x00040000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a44">CMS_HIVE_ERROR</a>&nbsp;&nbsp;&nbsp;0x00080000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a45">CMS_IO_ERROR</a>&nbsp;&nbsp;&nbsp;0x00100000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a46">CMS_PARSE_ERROR</a>&nbsp;&nbsp;&nbsp;0x00200000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a47">CMS_SAVRES_ERROR</a>&nbsp;&nbsp;&nbsp;0x00400000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a48">CMS_CM_ERROR</a>&nbsp;&nbsp;&nbsp;0x00800000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a49">CMS_SEC_ERROR</a>&nbsp;&nbsp;&nbsp;0x01000000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a50">CMS_POOL_ERROR</a>&nbsp;&nbsp;&nbsp;0x02000000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a51">CMS_LOCKING_ERROR</a>&nbsp;&nbsp;&nbsp;0x04000000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a52">CMS_NOTIFY_ERROR</a>&nbsp;&nbsp;&nbsp;0x08000000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a53">CMS_INDEX_ERROR</a>&nbsp;&nbsp;&nbsp;0x10000000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a54">CMS_DEFAULT</a>&nbsp;&nbsp;&nbsp;((~(CMS_MAP)) &amp; 0xffffffff)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(level, select)&nbsp;&nbsp;&nbsp;if (0) {}</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a56">REGCHECKING</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>(a)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a58">REGISTRY_LOCK_CHECKING</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a61">ASSERT_CM_LOCK_OWNED</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a63">ASSERT_PASSIVE_LEVEL</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a64">CM_BUGCHECK</a>(Code, Parm1, Parm2, Parm3, Parm4)&nbsp;&nbsp;&nbsp;KeBugCheckEx( Code, Parm1, Parm2, Parm3, Parm4 )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(LINE, Map, <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, Address)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a66">CmpDumpSecurityDescriptor</a>(x, y)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a67">CLONE_CONTROL_SET</a>&nbsp;&nbsp;&nbsp;FALSE</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a68">NUMBER_TYPES</a>&nbsp;&nbsp;&nbsp;(MaximumType + 1)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a69">CM_WRAP_LIMIT</a>&nbsp;&nbsp;&nbsp;0x7fffffff</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a70">CM_MAX_STASH</a>&nbsp;&nbsp;&nbsp;1024*1024</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a71">CM_MAX_REASONABLE_VALUES</a>&nbsp;&nbsp;&nbsp;100</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a72">MAX_HIVE_LAYERS</a>&nbsp;&nbsp;&nbsp;2</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a73">RNDM_CONSTANT</a>&nbsp;&nbsp;&nbsp;314159269    /* default value for "scrambling constant" */</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a74">RNDM_PRIME</a>&nbsp;&nbsp;&nbsp;1000000007    /* prime number, also used for scrambling  */</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a75">HASH_KEY</a>(_convkey_)&nbsp;&nbsp;&nbsp;((RNDM_CONSTANT * (_convkey_)) % RNDM_PRIME)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a76">GET_HASH_INDEX</a>(<a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>)&nbsp;&nbsp;&nbsp;HASH_KEY(<a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>) % <a class="el" href="../../d8/d2/cmsubs_8c.html#a3">CmpHashTableSize</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a77">GET_HASH_ENTRY</a>(Table, <a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>)&nbsp;&nbsp;&nbsp;Table[GET_HASH_INDEX(<a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>)]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a78">KEY_BODY_TYPE</a>&nbsp;&nbsp;&nbsp;0x6b793032</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a79">INIT_KCB_KEYBODY_LIST</a>(kcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a80">ASSERT_KEYBODY_LIST_EMPTY</a>(kcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a81">ENLIST_KEYBODY_IN_KEYBODY_LIST</a>(KeyBody)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a82">DELIST_KEYBODY_FROM_KEYBODY_LIST</a>(KeyBody)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a83">ASSERT_KEY_OBJECT</a>(x)&nbsp;&nbsp;&nbsp;ASSERT(((<a class="el" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)x)-&gt;Type == KEY_BODY_TYPE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a84">ASSERT_NODE</a>(x)&nbsp;&nbsp;&nbsp;ASSERT(((<a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)x)-&gt;Signature == CM_KEY_NODE_SIGNATURE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a85">ASSERT_SECURITY</a>(x)&nbsp;&nbsp;&nbsp;ASSERT(((<a class="el" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>)x)-&gt;Signature == CM_KEY_SECURITY_SIGNATURE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a86">REG_NOTIFY_POST_TYPE_MASK</a>&nbsp;&nbsp;&nbsp;(0x0000FFFFL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a87">REG_NOTIFY_MASTER_POST</a>&nbsp;&nbsp;&nbsp;(0x00010000L)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a88">PostBlockType</a>(_post_)&nbsp;&nbsp;&nbsp;((<a class="el" href="../../d1/d2/cmp_8h.html#a166">POST_BLOCK_TYPE</a>)( ((_post_)-&gt;NotifyType) &amp; REG_NOTIFY_POST_TYPE_MASK ))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a89">IsMasterPostBlock</a>(_post_)&nbsp;&nbsp;&nbsp;( ((_post_)-&gt;NotifyType) &amp;   REG_NOTIFY_MASTER_POST )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a90">SetMasterPostBlockFlag</a>(_post_)&nbsp;&nbsp;&nbsp;( ((_post_)-&gt;NotifyType) |=  REG_NOTIFY_MASTER_POST )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a91">ClearMasterPostBlockFlag</a>(_post_)&nbsp;&nbsp;&nbsp;( ((_post_)-&gt;NotifyType) &amp;= ~REG_NOTIFY_MASTER_POST )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a92">LOCK_POST_LIST</a>()&nbsp;&nbsp;&nbsp;ExAcquireFastMutexUnsafe(&amp;<a class="el" href="../../d1/d3/cmsysini_8c.html#a12">CmpPostLock</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a93">UNLOCK_POST_LIST</a>()&nbsp;&nbsp;&nbsp;ExReleaseFastMutexUnsafe(&amp;<a class="el" href="../../d1/d3/cmsysini_8c.html#a12">CmpPostLock</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a94">CmLockHive</a>(_hive_)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a95">CmUnlockHive</a>(_hive_)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a96">CmpHKeyNameLen</a>(<a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a97">CmpNcbNameLen</a>(Ncb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a98">CmpHKeyNodeSize</a>(<a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>)&nbsp;&nbsp;&nbsp;(FIELD_OFFSET(<a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">CM_KEY_NODE</a>, <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>) + CmpNameSize(<a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a99">CmpValueNameLen</a>(Value)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a100">CmpHKeyValueSize</a>(<a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d8/d2/rtrenval_8c.html#a3">ValueName</a>)&nbsp;&nbsp;&nbsp;(FIELD_OFFSET(<a class="el" href="../../d7/d5/struct__CM__KEY__VALUE.html">CM_KEY_VALUE</a>, <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>) + CmpNameSize(<a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d8/d2/rtrenval_8c.html#a3">ValueName</a>))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a101">REG_CMD_INIT</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a102">REG_CMD_FLUSH_KEY</a>&nbsp;&nbsp;&nbsp;2</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a103">REG_CMD_FILE_SET_SIZE</a>&nbsp;&nbsp;&nbsp;3</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a104">REG_CMD_HIVE_OPEN</a>&nbsp;&nbsp;&nbsp;4</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a105">REG_CMD_HIVE_CLOSE</a>&nbsp;&nbsp;&nbsp;5</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a106">REG_CMD_SHUTDOWN</a>&nbsp;&nbsp;&nbsp;6</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a107">REG_CMD_RENAME_HIVE</a>&nbsp;&nbsp;&nbsp;7</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a108">REG_CMD_ADD_HIVE_LIST</a>&nbsp;&nbsp;&nbsp;8</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a109">REG_CMD_REMOVE_HIVE_LIST</a>&nbsp;&nbsp;&nbsp;9</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a110">REG_CMD_REFRESH_HIVE</a>&nbsp;&nbsp;&nbsp;10</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a111">REG_CMD_HIVE_READ</a>&nbsp;&nbsp;&nbsp;11</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a112">REG_OPTION_PREDEF_HANDLE</a>&nbsp;&nbsp;&nbsp;(0x00000008L)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a113">REG_PREDEF_HANDLE_MASK</a>&nbsp;&nbsp;&nbsp;(0x80000000L)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a114">KCB_WORKER_CONTINUE</a>&nbsp;&nbsp;&nbsp;0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a115">KCB_WORKER_DONE</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a116">KCB_WORKER_DELETE</a>&nbsp;&nbsp;&nbsp;2</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(h, k, <a class="el" href="../../d7/d0/exts_8h.html#a0">n</a>)&nbsp;&nbsp;&nbsp;CmpFindNameInList(h,&amp;((k)-&gt;ValueList),<a class="el" href="../../d7/d0/exts_8h.html#a0">n</a>,NULL,NULL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a118">CmpCopyTree</a>(s, <a class="el" href="../../d7/d1/genuedef_8c.html#a8">c</a>, t, l)&nbsp;&nbsp;&nbsp;CmpCopySyncTree(s,<a class="el" href="../../d7/d1/genuedef_8c.html#a8">c</a>,t,l,FALSE,Copy)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a119">CmpCopyTreeEx</a>(s, <a class="el" href="../../d7/d1/genuedef_8c.html#a8">c</a>, t, l, f)&nbsp;&nbsp;&nbsp;CmpCopySyncTree(s,<a class="el" href="../../d7/d1/genuedef_8c.html#a8">c</a>,t,l,f,Copy)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a120">CmpSyncTrees</a>(s, <a class="el" href="../../d7/d1/genuedef_8c.html#a8">c</a>, t, l, f)&nbsp;&nbsp;&nbsp;CmpCopySyncTree(s,<a class="el" href="../../d7/d1/genuedef_8c.html#a8">c</a>,t,l,f,Sync)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a121">CmpMergeTrees</a>(s, <a class="el" href="../../d7/d1/genuedef_8c.html#a8">c</a>, t, l)&nbsp;&nbsp;&nbsp;CmpCopySyncTree(s,<a class="el" href="../../d7/d1/genuedef_8c.html#a8">c</a>,t,l,FALSE,Merge)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a122">CmpAllocateMasterPostBlock</a>(b)&nbsp;&nbsp;&nbsp;CmpAllocatePostBlock(b,REG_NOTIFY_MASTER_POST,NULL,NULL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a123">CmpAllocateSlavePostBlock</a>(b, k, m)&nbsp;&nbsp;&nbsp;CmpAllocatePostBlock(b,0,k,m)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a124">SetUsed</a>(<a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a125">CM_HARDWARE_PROFILE_STR_DATABASE</a>&nbsp;&nbsp;&nbsp;L"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\IDConfigDB"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a126">CM_HARDWARE_PROFILE_STR_CCS_HWPROFILE</a>&nbsp;&nbsp;&nbsp;L"\\Registry\\Machine\\System\\CurrentControlSet\\Hardware Profiles"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a127">CM_HARDWARE_PROFILE_STR_CCS_CURRENT</a>&nbsp;&nbsp;&nbsp;L"\\Registry\\Machine\\System\\CurrentControlSet\\Hardware Profiles\\Current"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a128">CM_HARDWARE_PROFILE_STR_ALIAS</a>&nbsp;&nbsp;&nbsp;L"Alias"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a129">CM_HARDWARE_PROFILE_STR_ACPI_ALIAS</a>&nbsp;&nbsp;&nbsp;L"AcpiAlias"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a130">CM_HARDWARE_PROFILE_STR_HARDWARE_PROFILES</a>&nbsp;&nbsp;&nbsp;L"Hardware Profiles"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a131">CM_HARDWARE_PROFILE_STR_DOCKING_STATE</a>&nbsp;&nbsp;&nbsp;L"DockingState"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a132">CM_HARDWARE_PROFILE_STR_CAPABILITIES</a>&nbsp;&nbsp;&nbsp;L"Capabilities"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a133">CM_HARDWARE_PROFILE_STR_DOCKID</a>&nbsp;&nbsp;&nbsp;L"DockID"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a134">CM_HARDWARE_PROFILE_STR_SERIAL_NUMBER</a>&nbsp;&nbsp;&nbsp;L"SerialNumber"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a135">CM_HARDWARE_PROFILE_STR_ACPI_SERIAL_NUMBER</a>&nbsp;&nbsp;&nbsp;L"AcpiSerialNumber"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a136">CM_HARDWARE_PROFILE_STR_PROFILE_NUMBER</a>&nbsp;&nbsp;&nbsp;L"ProfileNumber"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a137">CM_HARDWARE_PROFILE_STR_ALIASABLE</a>&nbsp;&nbsp;&nbsp;L"Aliasable"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a138">CM_HARDWARE_PROFILE_STR_CLONED</a>&nbsp;&nbsp;&nbsp;L"Cloned"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a139">CM_HARDWARE_PROFILE_STR_PRISTINE</a>&nbsp;&nbsp;&nbsp;L"Pristine"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a140">CM_HARDWARE_PROFILE_STR_PREFERENCE_ORDER</a>&nbsp;&nbsp;&nbsp;L"PreferenceOrder"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a141">CM_HARDWARE_PROFILE_STR_FRIENDLY_NAME</a>&nbsp;&nbsp;&nbsp;L"FriendlyName"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a142">CM_HARDWARE_PROFILE_STR_CURRENT_DOCK_INFO</a>&nbsp;&nbsp;&nbsp;L"CurrentDockInfo"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a143">CM_HARDWARE_PROFILE_STR_HW_PROFILE_GUID</a>&nbsp;&nbsp;&nbsp;L"HwProfileGuid"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a144">CM_HARDWARE_PROFILE_STR_DOCKED</a>&nbsp;&nbsp;&nbsp;L"Docked"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a145">CM_HARDWARE_PROFILE_STR_UNDOCKED</a>&nbsp;&nbsp;&nbsp;L"Undocked"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a146">CM_HARDWARE_PROFILE_STR_UNKNOWN</a>&nbsp;&nbsp;&nbsp;L"Unknown"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a147">CM_HP_FLAGS_ALIASABLE</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a148">CM_HP_FLAGS_TRUE_MATCH</a>&nbsp;&nbsp;&nbsp;2</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a149">CM_HP_FLAGS_PRISTINE</a>&nbsp;&nbsp;&nbsp;4</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a150">CM_HP_FLAGS_DUPLICATE</a>&nbsp;&nbsp;&nbsp;8</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a151">CmpSetIoStatus</a>(Iosb, s, i, UseIosb32)</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">_BOOT_DRIVER_NODE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a157">BOOT_DRIVER_NODE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">_BOOT_DRIVER_NODE</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a158">PBOOT_DRIVER_NODE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d4/d4/struct__CM__KEY__BODY.html">_CM_KEY_BODY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a160">CM_KEY_BODY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d4/d4/struct__CM__KEY__BODY.html">_CM_KEY_BODY</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a161">PCM_KEY_BODY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d6/d6/struct__CM__POST__KEY__BODY.html">_CM_POST_KEY_BODY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a162">CM_POST_KEY_BODY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d6/d6/struct__CM__POST__KEY__BODY.html">_CM_POST_KEY_BODY</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a163">PCM_POST_KEY_BODY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">_CM_NOTIFY_BLOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a164">CM_NOTIFY_BLOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">_CM_NOTIFY_BLOCK</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a165">PCM_NOTIFY_BLOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d1/d2/cmp_8h.html#a335">_POST_BLOCK_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a166">POST_BLOCK_TYPE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d6/struct__CM__SYNC__POST__BLOCK.html">_CM_SYNC_POST_BLOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a167">CM_SYNC_POST_BLOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d6/struct__CM__SYNC__POST__BLOCK.html">_CM_SYNC_POST_BLOCK</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a168">PCM_SYNC_POST_BLOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html">_CM_ASYNC_USER_POST_BLOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a169">CM_ASYNC_USER_POST_BLOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html">_CM_ASYNC_USER_POST_BLOCK</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a170">PCM_ASYNC_USER_POST_BLOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d3/struct__CM__ASYNC__KERNEL__POST__BLOCK.html">_CM_ASYNC_KERNEL_POST_BLOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a171">CM_ASYNC_KERNEL_POST_BLOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d3/struct__CM__ASYNC__KERNEL__POST__BLOCK.html">_CM_ASYNC_KERNEL_POST_BLOCK</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a172">PCM_ASYNC_KERNEL_POST_BLOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html">_CM_POST_BLOCK_UNION</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a173">CM_POST_BLOCK_UNION</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html">_CM_POST_BLOCK_UNION</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a174">PCM_POST_BLOCK_UNION</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">_CM_POST_BLOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a175">CM_POST_BLOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">_CM_POST_BLOCK</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a176">PCM_POST_BLOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d6/struct__CMHIVE.html">_CMHIVE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a178">CMHIVE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d6/struct__CMHIVE.html">_CMHIVE</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a179">PCMHIVE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d4/d3/struct__REGISTRY__COMMAND.html">_REGISTRY_COMMAND</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a180">REGISTRY_COMMAND</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d4/d3/struct__REGISTRY__COMMAND.html">_REGISTRY_COMMAND</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a181">PREGISTRY_COMMAND</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">_CM_PARSE_CONTEXT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a182">CM_PARSE_CONTEXT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">_CM_PARSE_CONTEXT</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a183">PCM_PARSE_CONTEXT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef ULONG(*&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a184">PKCB_WORKER_ROUTINE</a> )(<a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> Current, PVOID <a class="el" href="../../d3/d1/threads_8h.html#a107">Context1</a>, PVOID <a class="el" href="../../d3/d1/threads_8h.html#a108">Context2</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d7/struct__HIVE__LIST__ENTRY.html">_HIVE_LIST_ENTRY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a187">HIVE_LIST_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d7/struct__HIVE__LIST__ENTRY.html">_HIVE_LIST_ENTRY</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a188">PHIVE_LIST_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html">_CM_HARDWARE_PROFILE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a189">CM_HARDWARE_PROFILE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html">_CM_HARDWARE_PROFILE</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a190">PCM_HARDWARE_PROFILE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">_CM_HARDWARE_PROFILE_LIST</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a191">CM_HARDWARE_PROFILE_LIST</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">_CM_HARDWARE_PROFILE_LIST</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a192">PCM_HARDWARE_PROFILE_LIST</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d3/struct__CM__HARDWARE__PROFILE__ALIAS.html">_CM_HARDWARE_PROFILE_ALIAS</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a193">CM_HARDWARE_PROFILE_ALIAS</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d3/struct__CM__HARDWARE__PROFILE__ALIAS.html">_CM_HARDWARE_PROFILE_ALIAS</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a194">PCM_HARDWARE_PROFILE_ALIAS</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d3/struct__CM__HARDWARE__PROFILE__ALIAS__LIST.html">_CM_HARDWARE_PROFILE_ALIAS_LIST</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a195">CM_HARDWARE_PROFILE_ALIAS_LIST</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d3/struct__CM__HARDWARE__PROFILE__ALIAS__LIST.html">_CM_HARDWARE_PROFILE_ALIAS_LIST</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a196">PCM_HARDWARE_PROFILE_ALIAS_LIST</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d6/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS.html">_CM_HARDWARE_PROFILE_ACPI_ALIAS</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a197">CM_HARDWARE_PROFILE_ACPI_ALIAS</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d6/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS.html">_CM_HARDWARE_PROFILE_ACPI_ALIAS</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a198">PCM_HARDWARE_PROFILE_ACPI_ALIAS</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS__LIST.html">_CM_HARDWARE_PROFILE_ACPI_ALIAS_LIST</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a199">CM_HARDWARE_PROFILE_ACPI_ALIAS_LIST</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS__LIST.html">_CM_HARDWARE_PROFILE_ACPI_ALIAS_LIST</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a200">PCM_HARDWARE_PROFILE_ACPI_ALIAS_LIST</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef NTSTATUS(*&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a201">PCM_ACPI_SELECTION_ROUTINE</a> )(IN <a class="el" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">PCM_HARDWARE_PROFILE_LIST</a> ProfileList, OUT PULONG ProfileIndexToUse, IN PVOID Context)</td></tr>

<tr><td colspan=2><br><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a335">_POST_BLOCK_TYPE</a> { <a class="el" href="../../d1/d2/cmp_8h.html#a335a204">PostSynchronous</a> =  1, 
<a class="el" href="../../d1/d2/cmp_8h.html#a335a205">PostAsyncUser</a> =  2, 
<a class="el" href="../../d1/d2/cmp_8h.html#a335a206">PostAsyncKernel</a> =  3
 }</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a207">CmpCheckLockExceptionFilter</a> (IN PEXCEPTION_POINTERS ExceptionPointers)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a208">CmpParseKey</a> (IN PVOID ParseObject, IN PVOID ObjectType, IN OUT <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, IN ULONG Attributes, IN OUT PUNICODE_STRING CompleteName, IN OUT PUNICODE_STRING RemainingName, IN OUT PVOID Context OPTIONAL, IN PSECURITY_QUALITY_OF_SERVICE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a9">SecurityQos</a> OPTIONAL, OUT PVOID *Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a209">CmpDoCreate</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>, IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState, IN PUNICODE_STRING <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, IN <a class="el" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">PCM_PARSE_CONTEXT</a> Context, IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> ParentKcb, OUT PVOID *Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a210">CmpDoCreateChild</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ParentCell, IN PSECURITY_DESCRIPTOR ParentDescriptor OPTIONAL, IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState, IN PUNICODE_STRING <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, IN <a class="el" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">PCM_PARSE_CONTEXT</a> Context, IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> ParentKcb, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> Flags, OUT <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> KeyCell, OUT PVOID *Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a211">CmpQueryKeyName</a> (IN PVOID Object, IN BOOLEAN HasObjectName, OUT POBJECT_NAME_INFORMATION ObjectNameInfo, IN ULONG Length, OUT PULONG ReturnLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a212">CmpDeleteKeyObject</a> (IN PVOID Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a213">CmpCloseKeyObject</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process OPTIONAL, IN PVOID Object, IN ACCESS_MASK GrantedAccess, IN ULONG ProcessHandleCount, IN ULONG SystemHandleCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a214">CmpSecurityMethod</a> (IN PVOID Object, IN <a class="el" href="../../d0/d5/se_8h.html#a19">SECURITY_OPERATION_CODE</a> OperationCode, IN PSECURITY_INFORMATION SecurityInformation, IN OUT PSECURITY_DESCRIPTOR SecurityDescriptor, IN OUT PULONG CapturedLength, IN OUT PSECURITY_DESCRIPTOR *ObjectsSecurityDescriptor, IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType, IN PGENERIC_MAPPING GenericMapping)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a215">CmpSearchKeyControlBlockTree</a> (<a class="el" href="../../d1/d2/cmp_8h.html#a184">PKCB_WORKER_ROUTINE</a> WorkerRoutine, PVOID <a class="el" href="../../d3/d1/threads_8h.html#a107">Context1</a>, PVOID <a class="el" href="../../d3/d1/threads_8h.html#a108">Context2</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a216">CmpAllocate</a> (ULONG <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>, BOOLEAN UseForIo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a217">CmpFree</a> (PVOID MemoryBlock, ULONG GlobalQuotaSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a218">CmpFileSetSize</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, ULONG FileType, ULONG FileSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a219">CmpDoFileSetSize</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, ULONG FileType, ULONG FileSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a220">CmpFileWrite</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, ULONG FileType, <a class="el" href="../../d0/d1/hivedata_8h.html#a66">PCMP_OFFSET_ARRAY</a> offsetArray, ULONG offsetArrayCount, PULONG FileOffset)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a221">CmpFileRead</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, ULONG FileType, PULONG FileOffset, PVOID DataBuffer, ULONG DataLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a222">CmpFileFlush</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, ULONG FileType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a223">CmpCreateEvent</a> (IN EVENT_TYPE eventType, OUT PHANDLE eventHandle, OUT <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> *event)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a224">CmDeleteKey</a> (IN <a class="el" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> KeyBody)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a225">CmDeleteValueKey</a> (IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock, IN UNICODE_STRING <a class="el" href="../../d8/d2/rtrenval_8c.html#a3">ValueName</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a226">CmEnumerateKey</a> (IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock, IN ULONG <a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>, IN KEY_INFORMATION_CLASS KeyInformationClass, IN PVOID KeyInformation, IN ULONG Length, IN PULONG ResultLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a227">CmEnumerateValueKey</a> (IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock, IN ULONG <a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>, IN KEY_VALUE_INFORMATION_CLASS KeyValueInformationClass, IN PVOID KeyValueInformation, IN ULONG Length, IN PULONG ResultLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a228">CmFlushKey</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a229">CmQueryKey</a> (IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock, IN KEY_INFORMATION_CLASS KeyInformationClass, IN PVOID KeyInformation, IN ULONG Length, IN PULONG ResultLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a230">CmQueryValueKey</a> (IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock, IN UNICODE_STRING <a class="el" href="../../d8/d2/rtrenval_8c.html#a3">ValueName</a>, IN KEY_VALUE_INFORMATION_CLASS KeyValueInformationClass, IN PVOID KeyValueInformation, IN ULONG Length, IN PULONG ResultLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a231">CmQueryMultipleValueKey</a> (IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock, IN PKEY_VALUE_ENTRY ValueEntries, IN ULONG EntryCount, IN PVOID <a class="el" href="../../d2/d7/regtest_8c.html#a1">ValueBuffer</a>, IN OUT PULONG BufferLength, IN OPTIONAL PULONG ResultLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a232">CmRenameValueKey</a> (IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock, IN UNICODE_STRING SourceValueName, IN UNICODE_STRING TargetValueName, IN ULONG TargetIndex)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a233">CmReplaceKey</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>, IN PUNICODE_STRING NewHiveName, IN PUNICODE_STRING OldFileName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a234">CmRestoreKey</a> (IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock, IN HANDLE FileHandle, IN ULONG Flags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a235">CmSaveKey</a> (IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock, IN HANDLE FileHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a236">CmSaveMergedKeys</a> (IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> HighPrecedenceKcb, IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> LowPrecedenceKcb, IN HANDLE FileHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a237">CmSetValueKey</a> (IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock, IN PUNICODE_STRING <a class="el" href="../../d8/d2/rtrenval_8c.html#a3">ValueName</a>, IN ULONG Type, IN PVOID Data, IN ULONG DataSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a238">CmSetLastWriteTimeKey</a> (IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock, IN PLARGE_INTEGER LastWriteTime)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a239">CmpNotifyChangeKey</a> (IN <a class="el" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> KeyBody, IN <a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a> PostBlock, IN ULONG CompletionFilter, IN BOOLEAN <a class="el" href="../../d5/d2/rtnotify_8c.html#a4">WatchTree</a>, IN PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN ULONG <a class="el" href="../../d7/d2/rtqval_8c.html#a7">BufferSize</a>, IN <a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a> MasterPostBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a240">CmLoadKey</a> (IN POBJECT_ATTRIBUTES TargetKey, IN POBJECT_ATTRIBUTES SourceFile, IN ULONG Flags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a241">CmUnloadKey</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>, IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> Kcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a242">CmpMarkKeyDirty</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a243">CmpDoFlushAll</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a244">CmpLazyFlush</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a245">CmpQuotaWarningWorker</a> (IN PVOID WorkItem)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a246">CmpComputeGlobalQuotaAllowed</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a247">CmpClaimGlobalQuota</a> (IN ULONG <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a248">CmpReleaseGlobalQuota</a> (IN ULONG <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a249">CmpSetGlobalQuotaAllowed</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a250">CmpAssignSecurityDescriptor</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>, IN <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node, IN PSECURITY_DESCRIPTOR SecurityDescriptor)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a251">CmpCheckCreateAccess</a> (IN PUNICODE_STRING <a class="el" href="../../d2/d2/rtload_8c.html#a7">RelativeName</a>, IN PSECURITY_DESCRIPTOR Descriptor, IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode, IN ACCESS_MASK AdditionalAccess, OUT PNTSTATUS AccessStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a252">CmpCheckNotifyAccess</a> (IN <a class="el" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a> NotifyBlock, IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PSECURITY_DESCRIPTOR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a253">CmpHiveRootSecurityDescriptor</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a254">CmpFreeSecurityDescriptor</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a255">CmpLockRegistryExclusive</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a256">CmpLockRegistry</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a257">CmpIsLastKnownGoodBoot</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a259">CmpQueryKeyData</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node, KEY_INFORMATION_CLASS KeyInformationClass, PVOID KeyInformation, ULONG Length, PULONG ResultLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a260">CmpFreeKeyBody</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a261">CmpFreeValue</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a262">CmpFindValueByName</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> KeyNode, PUNICODE_STRING <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a263">CmpDeleteChildByName</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>, UNICODE_STRING <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> ChildCell)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a264">CmpFreeKeyByCell</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>, BOOLEAN Unlink)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a265">CmpFindNameInList</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d7/d9/struct__CHILD__LIST.html">PCHILD_LIST</a> ChildList, IN PUNICODE_STRING <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>, IN OPTIONAL <a class="el" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> *ChildAddress, IN OPTIONAL PULONG ChildIndex)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a266">CmpCopyCell</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> SourceHive, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> SourceCell, <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> TargetHive, <a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a> Type)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a267">CmpCopyValue</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> SourceHive, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> SourceValueCell, <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> TargetHive, <a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a> Type)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a268">CmpCopyKeyPartial</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> SourceHive, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> SourceKeyCell, <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> TargetHive, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Parent, BOOLEAN CopyValues)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a269">CmpCopySyncTree</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> SourceHive, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> SourceCell, <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> TargetHive, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> TargetCell, BOOLEAN CopyVolatile, <a class="el" href="../../d9/d0/cmdata_8h.html#a66">CMP_COPY_TYPE</a> CopyType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a270">CmpDeleteTree</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a271">CmpSetVersionData</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a272">CmpInitializeHardwareConfiguration</a> (IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a273">CmpInitializeMachineDependentConfiguration</a> (IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a274">CmpInitializeRegistryNode</a> (IN <a class="el" href="../../d5/d8/struct__CONFIGURATION__COMPONENT__DATA.html">PCONFIGURATION_COMPONENT_DATA</a> CurrentEntry, IN HANDLE ParentHandle, OUT PHANDLE NewHandle, IN INTERFACE_TYPE <a class="el" href="../../d6/d0/cmdat_8c.html#a4">InterfaceType</a>, IN ULONG <a class="el" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a22">PUSHORT</a> DeviceIndexTable)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a275">CmpInitializeHive</a> (<a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> *CmHive, ULONG OperationType, ULONG HiveFlags, ULONG FileType, PVOID HiveData OPTIONAL, HANDLE Primary, HANDLE Alternate, HANDLE Log, HANDLE External, PUNICODE_STRING <a class="el" href="../../d8/d1/hivestat_8c.html#a9">FileName</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a276">CmpDestroyHive</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a277">CmpInitializeRegistryNames</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a278">CmpInitializeCache</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a279">CmpCreateKeyControlBlock</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>, <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node, <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> ParentKcb, BOOLEAN FakeKey, PUNICODE_STRING <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a280">CmpSearchForOpenSubKeys</a> (IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> SearchKey, IN <a class="el" href="../../d9/d0/cmdata_8h.html#a67">SUBKEY_SEARCH_TYPE</a> SearchType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a281">CmpDereferenceKeyControlBlock</a> (<a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a282">CmpRemoveKeyControlBlock</a> (<a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a283">CmpReportNotify</a> (<a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock, <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>, ULONG NotifyMask)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a284">CmpPostNotify</a> (<a class="el" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a> NotifyBlock, PUNICODE_STRING <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a> OPTIONAL, ULONG <a class="el" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>, NTSTATUS <a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>, PLIST_ENTRY ExternalKeyDeref OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a285">CmpAllocatePostBlock</a> (IN <a class="el" href="../../d1/d2/cmp_8h.html#a166">POST_BLOCK_TYPE</a> BlockType, IN ULONG PostFlags, IN <a class="el" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> KeyBody, IN <a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a> MasterBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a286">CmpFreePostBlock</a> (IN <a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a> PostBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a287">CmpPostApc</a> (struct <a class="el" href="../../d1/d5/struct__KAPC.html">_KAPC</a> *Apc, <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *NormalRoutine, PVOID *NormalContext, PVOID *SystemArgument1, PVOID *SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a288">CmpFlushNotify</a> (<a class="el" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> KeyBody)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a289">CmpPostApcRunDown</a> (struct <a class="el" href="../../d1/d5/struct__KAPC.html">_KAPC</a> *Apc)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a290">CmpOpenHiveFiles</a> (PUNICODE_STRING <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a6">BaseName</a>, PWSTR Extension OPTIONAL, PHANDLE Primary, PHANDLE Secondary, PULONG PrimaryDisposition, PULONG SecondaryDispoition, BOOLEAN CreateAllowed, BOOLEAN MarkAsSystemHive, PULONG ClusterSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a291">CmpLinkHiveToMaster</a> (PUNICODE_STRING LinkName, HANDLE RootDirectory, <a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive, BOOLEAN Allocate, PSECURITY_DESCRIPTOR SecurityDescriptor)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a292">CmpWorker</a> (IN OUT <a class="el" href="../../d4/d3/struct__REGISTRY__COMMAND.html">PREGISTRY_COMMAND</a> Command)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a293">CmpSaveBootControlSet</a> (IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> ControlSetNum)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a294">CmCheckRegistry</a> (<a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive, BOOLEAN Clean)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a295">CmpValidateHiveSecurityDescriptors</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a296">CmpFindControlSet</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> SystemHive, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> RootCell, IN PUNICODE_STRING SelectName, OUT PBOOLEAN AutoSelect)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a297">CmpFindDrivers</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ControlSet, IN SERVICE_LOAD_TYPE LoadType, IN PWSTR BootFileSystem OPTIONAL, IN PLIST_ENTRY DriverListHead)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a298">CmpFindNLSData</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ControlSet, OUT PUNICODE_STRING AnsiFilename, OUT PUNICODE_STRING OemFilename, OUT PUNICODE_STRING CaseTableFilename, OUT PUNICODE_STRING OemHalFilename)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a299">CmpFindProfileOption</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ControlSet, OUT <a class="el" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">PCM_HARDWARE_PROFILE_LIST</a> *ProfileList, OUT <a class="el" href="../../d9/d3/struct__CM__HARDWARE__PROFILE__ALIAS__LIST.html">PCM_HARDWARE_PROFILE_ALIAS_LIST</a> *AliasList, OUT PULONG Timeout)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a300">CmpSetCurrentProfile</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ControlSet, IN <a class="el" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html">PCM_HARDWARE_PROFILE</a> Profile)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a301">CmpResolveDriverDependencies</a> (IN PLIST_ENTRY DriverListHead)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a302">CmpSortDriverList</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ControlSet, IN PLIST_ENTRY DriverListHead)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Parent, PUNICODE_STRING SearchName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a304">CmpFindSubKeyByNumber</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Parent, ULONG Number)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a305">CmpAddSubKey</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Parent, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Child)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a306">CmpMarkIndexDirty</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ParentKey, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> TargetKey)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a307">CmpRemoveSubKey</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ParentKey, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> TargetKey)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a308">CmpGetNextName</a> (IN OUT PUNICODE_STRING RemainingName, OUT PUNICODE_STRING NextName, OUT PBOOLEAN Last)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a309">CmpAddToHiveFileList</a> (<a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a310">CmpRemoveFromHiveFileList</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a311">CmpInitHiveFromFile</a> (IN PUNICODE_STRING <a class="el" href="../../d8/d1/hivestat_8c.html#a9">FileName</a>, IN ULONG HiveFlags, OUT <a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> *CmHive, IN OUT PBOOLEAN Allocate, IN OUT PBOOLEAN RegistryLocked)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a312">CmpCloneHwProfile</a> (IN HANDLE IDConfigDB, IN HANDLE Parent, IN HANDLE OldProfile, IN ULONG OldProfileNumber, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> DockingState, OUT PHANDLE NewProfile, OUT PULONG NewProfileNumber)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a313">CmpCreateHwProfileFriendlyName</a> (IN HANDLE IDConfigDB, IN ULONG DockingState, IN ULONG NewProfileNumber, OUT PUNICODE_STRING FriendlyName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a314">CmSetAcpiHwProfile</a> (IN <a class="el" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html">PPROFILE_ACPI_DOCKING_STATE</a> DockState, IN <a class="el" href="../../d1/d2/cmp_8h.html#a201">PCM_ACPI_SELECTION_ROUTINE</a>, IN PVOID Context, OUT PHANDLE NewProfile, OUT PBOOLEAN ProfileChanged)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a315">CmpAddAcpiAliasEntry</a> (IN HANDLE IDConfigDB, IN <a class="el" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html">PPROFILE_ACPI_DOCKING_STATE</a> NewDockState, IN ULONG ProfileNumber, IN PWCHAR nameBuffer, IN PVOID valueBuffer, IN ULONG valueBufferLength, IN BOOLEAN PreventDuplication)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a316">CmpNameSize</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN PUNICODE_STRING <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a317">CmpCopyName</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN PWCHAR Destination, IN PUNICODE_STRING Source)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a318">CmpCopyCompressedName</a> (IN PWCHAR Destination, IN ULONG DestinationLength, IN PWCHAR Source, IN ULONG SourceLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a319">CmpCompareCompressedName</a> (IN PUNICODE_STRING SearchName, IN PWCHAR CompressedName, IN ULONG NameLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a320">CmpCompressedNameSize</a> (IN PWCHAR <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>, IN ULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html">PCM_NAME_CONTROL_BLOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a321">CmpGetNameControlBlock</a> (PUNICODE_STRING NodeName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a322">CmpDereferenceKeyControlBlockWithLock</a> (<a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a323">CmpCleanUpSubKeyInfo</a> (<a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a324">CmpCleanUpKcbValueCache</a> (<a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a325">CmpCleanUpKcbCacheWithLock</a> (<a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a326">CmpRemoveFromDelayedClose</a> (IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> kcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PUNICODE_STRING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a327">CmpConstructName</a> (<a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> kcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a328">CmpGetValueListFromCache</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d5/d6/struct__CACHED__CHILD__LIST.html">PCACHED_CHILD_LIST</a> ChildList, IN OUT BOOLEAN *IndexCached)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a329">CmpGetValueKeyFromCache</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> List, IN ULONG <a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>, OUT <a class="el" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PPCM_CACHED_VALUE</a> *ContainingList, IN BOOLEAN IndexCached, OUT BOOLEAN *ValueCached)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a330">CmpFindValueByNameFromCache</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d5/d6/struct__CACHED__CHILD__LIST.html">PCACHED_CHILD_LIST</a> ChildList, IN PUNICODE_STRING <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>, OUT <a class="el" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PPCM_CACHED_VALUE</a> *ContainingList, OUT ULONG *<a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>, OUT BOOLEAN *ValueCached)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a331">CmpQueryKeyValueData</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PCM_CACHED_VALUE</a> *ContainingList, <a class="el" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> ValueKey, BOOLEAN ValueCached, KEY_VALUE_INFORMATION_CLASS KeyValueInformationClass, PVOID KeyValueInformation, ULONG Length, PULONG ResultLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a332">CmpReferenceKeyControlBlock</a> (<a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a333">CmpInitializeKeyNameString</a> (<a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>, PUNICODE_STRING <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>, WCHAR *NameBuffer)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a334">CmpInitializeValueNameString</a> (<a class="el" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>, PUNICODE_STRING <a class="el" href="../../d8/d2/rtrenval_8c.html#a3">ValueName</a>, WCHAR *NameBuffer)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a152">WmiUsePerfClock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d7/d9/cm_8h.html#a28">PCM_TRACE_NOTIFY_ROUTINE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a153">CmpTraceRoutine</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a154">CmpCacheOnFlag</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a155">CmpKcbLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UNICODE_STRING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a156">CmRegistrySystemCloneName</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a159">CmpKeyObjectType</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a177">CmpPostLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a185">CmpLazyFlushPending</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a186">CmpRegistryLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a202">CmpHashTableSize</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="cmp.h::_CM_ENTRYLIST_MANIPULATION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define _CM_ENTRYLIST_MANIPULATION          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00045">45</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="cmp.h::_WMI_TRACING_REGISTRYCALLS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define _WMI_TRACING_REGISTRYCALLS          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00062">62</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a61" doxytag="cmp.h::ASSERT_CM_LOCK_OWNED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ASSERT_CM_LOCK_OWNED          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00345">345</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01738">CmpCancelSlavePost()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01032">CmpCheckNotifyAccess()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01235">CmpFlushNotify()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00487">CmpPostNotify()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01383">CmpSetValueKeyExisting()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, and <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00146">HvpGetCellPaged()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a62" doxytag="cmp.h::ASSERT_CM_LOCK_OWNED_EXCLUSIVE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ASSERT_CM_LOCK_OWNED_EXCLUSIVE          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00346">346</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/cmapi2_8c-source.html#l00031">CmDeleteKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00092">CmDeleteValueKey()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00537">CmpCleanUpSubKeyInfo()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01252">CmpCreateLinkNode()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00033">CmpDoCreate()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00226">CmpDoCreateChild()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01378">CmpNotifyChangeKey()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00180">CmpSearchForOpenSubKeys()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00158">CmpSecurityMethod()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00397">CmpSetSecurityDescriptorInfo()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00097">CmRestoreKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01087">CmSetValueKey()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03093">NtUnloadKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a83" doxytag="cmp.h::ASSERT_KEY_OBJECT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ASSERT_KEY_OBJECT          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">x&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ASSERT(((<a class="el" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)x)-&gt;Type == KEY_BODY_TYPE)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00530">530</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/cmse_8c-source.html#l00158">CmpSecurityMethod()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a80" doxytag="cmp.h::ASSERT_KEYBODY_LIST_EMPTY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ASSERT_KEYBODY_LIST_EMPTY          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">kcb&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00525">525</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00629">CmpCleanUpKcbCacheWithLock()</a>, and <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00824">CmpCreateKeyControlBlock()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a84" doxytag="cmp.h::ASSERT_NODE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ASSERT_NODE          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">x&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ASSERT(((<a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)x)-&gt;Signature == CM_KEY_NODE_SIGNATURE)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00531">531</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/cmse_8c-source.html#l00697">CmpAssignSecurityDescriptor()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01464">CmpFreeSecurityDescriptor()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01165">CmpGetKeySecurity()</a>, and <a class="el" href="../../d8/d1/cmse_8c-source.html#l01704">CmpInsertSecurityCellList()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a63" doxytag="cmp.h::ASSERT_PASSIVE_LEVEL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ASSERT_PASSIVE_LEVEL          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00360">360</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00227">CmpDoFileSetSize()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00772">CmpFileFlush()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00351">CmpFileRead()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00516">CmpFileWrite()</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00721">CmpOpenFileWithExtremePrejudice()</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00046">CmpOpenHiveFiles()</a>, and <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a85" doxytag="cmp.h::ASSERT_SECURITY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ASSERT_SECURITY          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">x&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ASSERT(((<a class="el" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>)x)-&gt;Signature == CM_KEY_SECURITY_SIGNATURE)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00532">532</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/cmse_8c-source.html#l01464">CmpFreeSecurityDescriptor()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01165">CmpGetKeySecurity()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01704">CmpInsertSecurityCellList()</a>, and <a class="el" href="../../d8/d1/cmse_8c-source.html#l00397">CmpSetSecurityDescriptorInfo()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a59" doxytag="cmp.h::BEGIN_LOCK_CHECKPOINT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BEGIN_LOCK_CHECKPOINT          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                                                       \
        ULONG   LockCountBefore,LockCountAfter;                             \
        LockCountBefore = <a class="code" href="../../d5/d8/ex_8h.html#a75">ExIsResourceAcquiredShared</a>(&amp;CmpRegistryLock);     \
        LockCountBefore += <a class="code" href="../../d5/d8/ex_8h.html#a74">ExIsResourceAcquiredExclusive</a>(&amp;CmpRegistryLock); \
        <span class="keywordflow">try</span> {
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00319">319</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00411">NtDeleteKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00504">NtDeleteValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00610">NtEnumerateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00756">NtEnumerateValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00904">NtFlushKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02881">NtLoadKey2()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02018">NtQueryKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03461">NtQueryMultipleValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l04090">NtQueryOpenSubKeys()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03336">NtReplaceKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02348">NtRestoreKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02471">NtSaveKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02559">NtSaveMergedKeys()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03235">NtSetInformationKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03093">NtUnloadKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a91" doxytag="cmp.h::ClearMasterPostBlockFlag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ClearMasterPostBlockFlag          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_post_&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;( ((_post_)-&gt;NotifyType) &amp;= ~REG_NOTIFY_MASTER_POST )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00634">634</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00487">CmpPostNotify()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a67" doxytag="cmp.h::CLONE_CONTROL_SET" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CLONE_CONTROL_SET&nbsp;&nbsp;&nbsp;FALSE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00417">417</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03458">CmpSaveBootControlSet()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a64" doxytag="cmp.h::CM_BUGCHECK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_BUGCHECK          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Code,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Parm1,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Parm2,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Parm3,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Parm4&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;KeBugCheckEx( Code, Parm1, Parm2, Parm3, Parm4 )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00373">373</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="cmp.h::CM_CACHE_FAKE_KEY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_CACHE_FAKE_KEY&nbsp;&nbsp;&nbsp;0x00000001          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00222">222</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l02056">CmpAddInfoAfterParseFailure()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a129" doxytag="cmp.h::CM_HARDWARE_PROFILE_STR_ACPI_ALIAS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_HARDWARE_PROFILE_STR_ACPI_ALIAS&nbsp;&nbsp;&nbsp;L"AcpiAlias"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01573">1573</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00544">CmpAddAcpiAliasEntry()</a>, and <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00076">CmpGetAcpiProfileInformation()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a135" doxytag="cmp.h::CM_HARDWARE_PROFILE_STR_ACPI_SERIAL_NUMBER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_HARDWARE_PROFILE_STR_ACPI_SERIAL_NUMBER&nbsp;&nbsp;&nbsp;L"AcpiSerialNumber"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01583">1583</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00544">CmpAddAcpiAliasEntry()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00076">CmpGetAcpiProfileInformation()</a>, and <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00805">CmSetAcpiHwProfile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a128" doxytag="cmp.h::CM_HARDWARE_PROFILE_STR_ALIAS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_HARDWARE_PROFILE_STR_ALIAS&nbsp;&nbsp;&nbsp;L"Alias"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01572">1572</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02606">CmpAddAliasEntry()</a>, and <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01513">CmpMoveBiosAliasTable()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a137" doxytag="cmp.h::CM_HARDWARE_PROFILE_STR_ALIASABLE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_HARDWARE_PROFILE_STR_ALIASABLE&nbsp;&nbsp;&nbsp;L"Aliasable"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01585">1585</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01869">CmpCloneHwProfile()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01284">CmpFindProfileOption()</a>, and <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00076">CmpGetAcpiProfileInformation()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a132" doxytag="cmp.h::CM_HARDWARE_PROFILE_STR_CAPABILITIES" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_HARDWARE_PROFILE_STR_CAPABILITIES&nbsp;&nbsp;&nbsp;L"Capabilities"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01580">1580</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02532">CmpAddDockingInfo()</a>, and <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02786">CmpCreateControlSet()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a127" doxytag="cmp.h::CM_HARDWARE_PROFILE_STR_CCS_CURRENT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_HARDWARE_PROFILE_STR_CCS_CURRENT&nbsp;&nbsp;&nbsp;L"\\Registry\\Machine\\System\\CurrentControlSet\\Hardware Profiles\\Current"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01568">1568</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00805">CmSetAcpiHwProfile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a126" doxytag="cmp.h::CM_HARDWARE_PROFILE_STR_CCS_HWPROFILE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_HARDWARE_PROFILE_STR_CCS_HWPROFILE&nbsp;&nbsp;&nbsp;L"\\Registry\\Machine\\System\\CurrentControlSet\\Hardware Profiles"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01567">1567</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01513">CmpMoveBiosAliasTable()</a>, and <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00805">CmSetAcpiHwProfile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a138" doxytag="cmp.h::CM_HARDWARE_PROFILE_STR_CLONED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_HARDWARE_PROFILE_STR_CLONED&nbsp;&nbsp;&nbsp;L"Cloned"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01586">1586</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01869">CmpCloneHwProfile()</a>, and <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01513">CmpMoveBiosAliasTable()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a142" doxytag="cmp.h::CM_HARDWARE_PROFILE_STR_CURRENT_DOCK_INFO" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_HARDWARE_PROFILE_STR_CURRENT_DOCK_INFO&nbsp;&nbsp;&nbsp;L"CurrentDockInfo"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01593">1593</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02786">CmpCreateControlSet()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00805">CmSetAcpiHwProfile()</a>, and <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00862">IopUpdateHardwareProfile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a125" doxytag="cmp.h::CM_HARDWARE_PROFILE_STR_DATABASE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_HARDWARE_PROFILE_STR_DATABASE&nbsp;&nbsp;&nbsp;L"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\IDConfigDB"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01566">1566</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00805">CmSetAcpiHwProfile()</a>, and <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00862">IopUpdateHardwareProfile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a144" doxytag="cmp.h::CM_HARDWARE_PROFILE_STR_DOCKED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_HARDWARE_PROFILE_STR_DOCKED&nbsp;&nbsp;&nbsp;L"Docked"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01598">1598</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l02529">CmpCreateHwProfileFriendlyName()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a133" doxytag="cmp.h::CM_HARDWARE_PROFILE_STR_DOCKID" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_HARDWARE_PROFILE_STR_DOCKID&nbsp;&nbsp;&nbsp;L"DockID"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01581">1581</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02532">CmpAddDockingInfo()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02786">CmpCreateControlSet()</a>, and <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01513">CmpMoveBiosAliasTable()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a131" doxytag="cmp.h::CM_HARDWARE_PROFILE_STR_DOCKING_STATE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_HARDWARE_PROFILE_STR_DOCKING_STATE&nbsp;&nbsp;&nbsp;L"DockingState"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01579">1579</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00544">CmpAddAcpiAliasEntry()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02532">CmpAddDockingInfo()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02786">CmpCreateControlSet()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00076">CmpGetAcpiProfileInformation()</a>, and <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00805">CmSetAcpiHwProfile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a141" doxytag="cmp.h::CM_HARDWARE_PROFILE_STR_FRIENDLY_NAME" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_HARDWARE_PROFILE_STR_FRIENDLY_NAME&nbsp;&nbsp;&nbsp;L"FriendlyName"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01592">1592</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01869">CmpCloneHwProfile()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01284">CmpFindProfileOption()</a>, and <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00076">CmpGetAcpiProfileInformation()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a130" doxytag="cmp.h::CM_HARDWARE_PROFILE_STR_HARDWARE_PROFILES" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_HARDWARE_PROFILE_STR_HARDWARE_PROFILES&nbsp;&nbsp;&nbsp;L"Hardware Profiles"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01574">1574</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01869">CmpCloneHwProfile()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l02529">CmpCreateHwProfileFriendlyName()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00076">CmpGetAcpiProfileInformation()</a>, and <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01513">CmpMoveBiosAliasTable()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a143" doxytag="cmp.h::CM_HARDWARE_PROFILE_STR_HW_PROFILE_GUID" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_HARDWARE_PROFILE_STR_HW_PROFILE_GUID&nbsp;&nbsp;&nbsp;L"HwProfileGuid"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01594">1594</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01869">CmpCloneHwProfile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a140" doxytag="cmp.h::CM_HARDWARE_PROFILE_STR_PREFERENCE_ORDER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_HARDWARE_PROFILE_STR_PREFERENCE_ORDER&nbsp;&nbsp;&nbsp;L"PreferenceOrder"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01591">1591</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01869">CmpCloneHwProfile()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01284">CmpFindProfileOption()</a>, and <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00076">CmpGetAcpiProfileInformation()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a139" doxytag="cmp.h::CM_HARDWARE_PROFILE_STR_PRISTINE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_HARDWARE_PROFILE_STR_PRISTINE&nbsp;&nbsp;&nbsp;L"Pristine"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01590">1590</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01284">CmpFindProfileOption()</a>, and <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00076">CmpGetAcpiProfileInformation()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a136" doxytag="cmp.h::CM_HARDWARE_PROFILE_STR_PROFILE_NUMBER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_HARDWARE_PROFILE_STR_PROFILE_NUMBER&nbsp;&nbsp;&nbsp;L"ProfileNumber"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01584">1584</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00544">CmpAddAcpiAliasEntry()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02606">CmpAddAliasEntry()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00076">CmpGetAcpiProfileInformation()</a>, and <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01513">CmpMoveBiosAliasTable()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a134" doxytag="cmp.h::CM_HARDWARE_PROFILE_STR_SERIAL_NUMBER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_HARDWARE_PROFILE_STR_SERIAL_NUMBER&nbsp;&nbsp;&nbsp;L"SerialNumber"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01582">1582</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02532">CmpAddDockingInfo()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02786">CmpCreateControlSet()</a>, and <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01513">CmpMoveBiosAliasTable()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a145" doxytag="cmp.h::CM_HARDWARE_PROFILE_STR_UNDOCKED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_HARDWARE_PROFILE_STR_UNDOCKED&nbsp;&nbsp;&nbsp;L"Undocked"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01599">1599</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l02529">CmpCreateHwProfileFriendlyName()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a146" doxytag="cmp.h::CM_HARDWARE_PROFILE_STR_UNKNOWN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_HARDWARE_PROFILE_STR_UNKNOWN&nbsp;&nbsp;&nbsp;L"Unknown"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01600">1600</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l02529">CmpCreateHwProfileFriendlyName()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a147" doxytag="cmp.h::CM_HP_FLAGS_ALIASABLE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_HP_FLAGS_ALIASABLE&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01625">1625</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01282">CmpFilterAcpiDockingState()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01284">CmpFindProfileOption()</a>, and <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00076">CmpGetAcpiProfileInformation()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a150" doxytag="cmp.h::CM_HP_FLAGS_DUPLICATE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_HP_FLAGS_DUPLICATE&nbsp;&nbsp;&nbsp;8          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01628">1628</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01282">CmpFilterAcpiDockingState()</a>, and <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00805">CmSetAcpiHwProfile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a149" doxytag="cmp.h::CM_HP_FLAGS_PRISTINE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_HP_FLAGS_PRISTINE&nbsp;&nbsp;&nbsp;4          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01627">1627</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01282">CmpFilterAcpiDockingState()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01284">CmpFindProfileOption()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00076">CmpGetAcpiProfileInformation()</a>, and <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00805">CmSetAcpiHwProfile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a148" doxytag="cmp.h::CM_HP_FLAGS_TRUE_MATCH" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_HP_FLAGS_TRUE_MATCH&nbsp;&nbsp;&nbsp;2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01626">1626</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01282">CmpFilterAcpiDockingState()</a>, and <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00805">CmSetAcpiHwProfile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a71" doxytag="cmp.h::CM_MAX_REASONABLE_VALUES" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_MAX_REASONABLE_VALUES&nbsp;&nbsp;&nbsp;100          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00431">431</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01619">CmpSetValueKeyNew()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a70" doxytag="cmp.h::CM_MAX_STASH" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_MAX_STASH&nbsp;&nbsp;&nbsp;1024*1024          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00428">428</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01383">CmpSetValueKeyExisting()</a>, and <a class="el" href="../../d4/d2/rtsetopt_8c-source.html#l00073">main()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a69" doxytag="cmp.h::CM_WRAP_LIMIT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_WRAP_LIMIT&nbsp;&nbsp;&nbsp;0x7fffffff          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00422">422</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00293">CmpComputeGlobalQuotaAllowed()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02293">CmReplaceKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00862">CmSaveKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01047">CmSaveMergedKeys()</a>, and <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00121">CmSetRegistryQuotaInformation()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="cmp.h::CML_API" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CML_API&nbsp;&nbsp;&nbsp;2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00243">243</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01028">CmNotifyRunDown()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03764">CmpFreePostBlock()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03603">CmpNameFromAttributes()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01383">CmpSetValueKeyExisting()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01619">CmpSetValueKeyNew()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01087">CmSetValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00411">NtDeleteKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00504">NtDeleteValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00610">NtEnumerateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00756">NtEnumerateValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00904">NtFlushKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02881">NtLoadKey2()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01156">NtNotifyChangeKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02018">NtQueryKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03461">NtQueryMultipleValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l04090">NtQueryOpenSubKeys()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03336">NtReplaceKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02348">NtRestoreKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02471">NtSaveKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02559">NtSaveMergedKeys()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03235">NtSetInformationKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03093">NtUnloadKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="cmp.h::CML_API_ARGS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CML_API_ARGS&nbsp;&nbsp;&nbsp;3          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00244">244</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00411">NtDeleteKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00504">NtDeleteValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00610">NtEnumerateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00756">NtEnumerateValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02881">NtLoadKey2()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03461">NtQueryMultipleValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l04090">NtQueryOpenSubKeys()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03336">NtReplaceKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03235">NtSetInformationKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03093">NtUnloadKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="cmp.h::CML_BIN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CML_BIN&nbsp;&nbsp;&nbsp;8          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00249">249</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/hivefree_8c-source.html#l00034">HvFreeHive()</a>, <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">HvInitializeHive()</a>, and <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00437">HvpEnlistBinInMap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="cmp.h::CML_BUGCHECK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CML_BUGCHECK&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00242">242</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02169">CmGetSystemDriverList()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00544">CmpAddAcpiAliasEntry()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02606">CmpAddAliasEntry()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03262">CmpCloneControlSet()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01869">CmpCloneHwProfile()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02786">CmpCreateControlSet()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00726">CmpInitializeHiveList()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02022">CmpInitializeSystemHive()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03983">CmpLinkKeyToHive()</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00046">CmpOpenHiveFiles()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l04077">CmpValidateAlternate()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02293">CmReplaceKey()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00647">HvSyncHive()</a>, and <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01433">HvWriteHive()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="cmp.h::CML_FLOW" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CML_FLOW&nbsp;&nbsp;&nbsp;7          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">248</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/cmse_8c-source.html#l00697">CmpAssignSecurityDescriptor()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00917">CmpCheckCreateAccess()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01032">CmpCheckNotifyAccess()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01252">CmpCreateLinkNode()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00033">CmpDoCreate()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00226">CmpDoCreateChild()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00963">CmpDoOpen()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01545">CmpFindMatchingDescriptorCell()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01464">CmpFreeSecurityDescriptor()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01165">CmpGetKeySecurity()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01109">CmpGetObjectSecurity()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01476">CmpGetSymbolicLink()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01704">CmpInsertSecurityCellList()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00368">CmpLazyFlush()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00416">CmpLazyFlushDpcRoutine()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00461">CmpLazyFlushWorker()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00044">CmpLockRegistry()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00847">CmpQuerySecurityDescriptorInfo()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01823">CmpRemoveSecurityCellList()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00158">CmpSecurityMethod()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00397">CmpSetSecurityDescriptorInfo()</a>, <a class="el" href="../../d3/d9/cmchek2_8c-source.html#l00034">CmpValidateHiveSecurityDescriptors()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00862">CmSaveKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01047">CmSaveMergedKeys()</a>, <a class="el" href="../../d8/d9/hivebin_8c-source.html#l00046">HvpAddBin()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00536">HvpBuildMap()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00047">HvpBuildMapAndCopy()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00437">HvpEnlistBinInMap()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01233">HvpFindNextDirtyBlock()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00146">HvpGetCellPaged()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00304">HvpInitMap()</a>, and <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00647">HvSyncHive()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="cmp.h::CML_MAJOR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CML_MAJOR&nbsp;&nbsp;&nbsp;5          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">246</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00564">CmFlushKey()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00895">CmpAddSubKey()</a>, <a class="el" href="../../d7/d0/cmhvlist_8c-source.html#l00042">CmpAddToHiveFileList()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01087">CmpAddToLeaf()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01738">CmpCancelSlavePost()</a>, <a class="el" href="../../d4/d9/cmclose_8c-source.html#l00028">CmpCloseKeyObject()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00127">CmpCopySyncTree()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01252">CmpCreateLinkNode()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01074">CmpCreateObjectTypes()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01165">CmpCreateRegistryRoot()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01328">CmpCreateRootNode()</a>, <a class="el" href="../../d2/d0/cmdelete_8c-source.html#l00031">CmpDeleteKeyObject()</a>, <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00034">CmpDeleteTree()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00772">CmpFileFlush()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00351">CmpFileRead()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00509">CmpFileSetSize()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00516">CmpFileWrite()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00186">CmpFindSubKeyByName()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00771">CmpFindSubKeyByNumber()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00475">CmpFindSubKeyInLeaf()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00266">CmpFindSubKeyInRoot()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01235">CmpFlushNotify()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03764">CmpFreePostBlock()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01634">CmpFreeSlavePost()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01227">CmpHiveRootSecurityDescriptor()</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00726">CmpInitializeHiveList()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03863">CmpIsLastKnownGoodBoot()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01421">CmpLinkHiveToMaster()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00804">CmpPostApc()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00922">CmpPostApcRunDown()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00487">CmpPostNotify()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01257">CmpSelectLeaf()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01472">CmpSplitLeaf()</a>, <a class="el" href="../../d3/d9/cmchek2_8c-source.html#l00034">CmpValidateHiveSecurityDescriptors()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00097">CmRestoreKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00862">CmSaveKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01047">CmSaveMergedKeys()</a>, <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">HvInitializeHive()</a>, and <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01433">HvWriteHive()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="cmp.h::CML_MINOR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CML_MINOR&nbsp;&nbsp;&nbsp;6          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">247</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00062">CmpAllocate()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01009">CmpCopyCell()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00686">CmpCopyKeyPartial()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00251">CmpCopySyncTree2()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00895">CmpCopyValue()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01490">CmpDestroyTemporaryHive()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00963">CmpDoOpen()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00186">CmpFree()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01476">CmpGetSymbolicLink()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00726">CmpInitializeHiveList()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01378">CmpNotifyChangeKey()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>, <a class="el" href="../../d6/d1/cmquery_8c-source.html#l00028">CmpQueryKeyName()</a>, <a class="el" href="../../d3/d9/cmchek2_8c-source.html#l00034">CmpValidateHiveSecurityDescriptors()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00200">HvIsBinDirty()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">HvMarkCellDirty()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00401">HvMarkClean()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00270">HvMarkDirty()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00775">HvpDoWriteHive()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00495">HvpGrowLog1()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00565">HvpGrowLog2()</a>, and <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01025">HvpWriteLog()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="cmp.h::CML_WORKER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CML_WORKER&nbsp;&nbsp;&nbsp;4          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00245">245</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/cmapi2_8c-source.html#l00031">CmDeleteKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00092">CmDeleteValueKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00285">CmEnumerateKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00416">CmEnumerateValueKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00564">CmFlushKey()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01378">CmpNotifyChangeKey()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00191">CmpReportNotify()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00647">CmQueryKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00940">CmQueryMultipleValueKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00804">CmQueryValueKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01841">CmSetLastWriteTimeKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01087">CmSetValueKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02079">CmUnloadKey()</a>, and <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00647">HvSyncHive()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a94" doxytag="cmp.h::CmLockHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmLockHive          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_hive_&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (_hive_)-&gt;HiveLock );\
                            <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>((_hive_)-&gt;HiveLock)
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00660">660</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00564">CmFlushKey()</a>, <a class="el" href="../../d4/d9/cmclose_8c-source.html#l00028">CmpCloseKeyObject()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02195">CmpDoFlushAll()</a>, and <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01235">CmpFlushNotify()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a55" doxytag="cmp.h::CMLOG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMLOG          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">level,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>select&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;if (0) {}</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">293</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/cmapi2_8c-source.html#l00031">CmDeleteKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00092">CmDeleteValueKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00285">CmEnumerateKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00416">CmEnumerateValueKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00564">CmFlushKey()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02169">CmGetSystemDriverList()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01028">CmNotifyRunDown()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00544">CmpAddAcpiAliasEntry()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02606">CmpAddAliasEntry()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00895">CmpAddSubKey()</a>, <a class="el" href="../../d7/d0/cmhvlist_8c-source.html#l00042">CmpAddToHiveFileList()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01087">CmpAddToLeaf()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00062">CmpAllocate()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00697">CmpAssignSecurityDescriptor()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01738">CmpCancelSlavePost()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00917">CmpCheckCreateAccess()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01032">CmpCheckNotifyAccess()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03262">CmpCloneControlSet()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01869">CmpCloneHwProfile()</a>, <a class="el" href="../../d4/d9/cmclose_8c-source.html#l00028">CmpCloseKeyObject()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01009">CmpCopyCell()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00686">CmpCopyKeyPartial()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00127">CmpCopySyncTree()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00251">CmpCopySyncTree2()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00895">CmpCopyValue()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02786">CmpCreateControlSet()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01252">CmpCreateLinkNode()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01074">CmpCreateObjectTypes()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01165">CmpCreateRegistryRoot()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01328">CmpCreateRootNode()</a>, <a class="el" href="../../d2/d0/cmdelete_8c-source.html#l00031">CmpDeleteKeyObject()</a>, <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00034">CmpDeleteTree()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01490">CmpDestroyTemporaryHive()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00033">CmpDoCreate()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00226">CmpDoCreateChild()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00963">CmpDoOpen()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00772">CmpFileFlush()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00351">CmpFileRead()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00509">CmpFileSetSize()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00516">CmpFileWrite()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01545">CmpFindMatchingDescriptorCell()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00186">CmpFindSubKeyByName()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00771">CmpFindSubKeyByNumber()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00475">CmpFindSubKeyInLeaf()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00266">CmpFindSubKeyInRoot()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01235">CmpFlushNotify()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00186">CmpFree()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03764">CmpFreePostBlock()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01464">CmpFreeSecurityDescriptor()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01634">CmpFreeSlavePost()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01165">CmpGetKeySecurity()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01109">CmpGetObjectSecurity()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01476">CmpGetSymbolicLink()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01227">CmpHiveRootSecurityDescriptor()</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00726">CmpInitializeHiveList()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02022">CmpInitializeSystemHive()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01704">CmpInsertSecurityCellList()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03863">CmpIsLastKnownGoodBoot()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00368">CmpLazyFlush()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00416">CmpLazyFlushDpcRoutine()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00461">CmpLazyFlushWorker()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01421">CmpLinkHiveToMaster()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03983">CmpLinkKeyToHive()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00044">CmpLockRegistry()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03603">CmpNameFromAttributes()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01378">CmpNotifyChangeKey()</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00046">CmpOpenHiveFiles()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00804">CmpPostApc()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00922">CmpPostApcRunDown()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00487">CmpPostNotify()</a>, <a class="el" href="../../d6/d1/cmquery_8c-source.html#l00028">CmpQueryKeyName()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00847">CmpQuerySecurityDescriptorInfo()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01823">CmpRemoveSecurityCellList()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00191">CmpReportNotify()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00158">CmpSecurityMethod()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01257">CmpSelectLeaf()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00397">CmpSetSecurityDescriptorInfo()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01383">CmpSetValueKeyExisting()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01619">CmpSetValueKeyNew()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01472">CmpSplitLeaf()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l04077">CmpValidateAlternate()</a>, <a class="el" href="../../d3/d9/cmchek2_8c-source.html#l00034">CmpValidateHiveSecurityDescriptors()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00647">CmQueryKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00940">CmQueryMultipleValueKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00804">CmQueryValueKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02293">CmReplaceKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00097">CmRestoreKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00862">CmSaveKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01047">CmSaveMergedKeys()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01841">CmSetLastWriteTimeKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01087">CmSetValueKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02079">CmUnloadKey()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d3/d0/hivefree_8c-source.html#l00034">HvFreeHive()</a>, <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">HvInitializeHive()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00200">HvIsBinDirty()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">HvMarkCellDirty()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00401">HvMarkClean()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00270">HvMarkDirty()</a>, <a class="el" href="../../d8/d9/hivebin_8c-source.html#l00046">HvpAddBin()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00536">HvpBuildMap()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00047">HvpBuildMapAndCopy()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00775">HvpDoWriteHive()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00437">HvpEnlistBinInMap()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01233">HvpFindNextDirtyBlock()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00146">HvpGetCellPaged()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00495">HvpGrowLog1()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00565">HvpGrowLog2()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00304">HvpInitMap()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01025">HvpWriteLog()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00647">HvSyncHive()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01433">HvWriteHive()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00411">NtDeleteKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00504">NtDeleteValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00610">NtEnumerateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00756">NtEnumerateValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00904">NtFlushKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02881">NtLoadKey2()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01156">NtNotifyChangeKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02018">NtQueryKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03461">NtQueryMultipleValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l04090">NtQueryOpenSubKeys()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03336">NtReplaceKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02348">NtRestoreKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02471">NtSaveKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02559">NtSaveMergedKeys()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03235">NtSetInformationKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03093">NtUnloadKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a122" doxytag="cmp.h::CmpAllocateMasterPostBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpAllocateMasterPostBlock          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">b&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;CmpAllocatePostBlock(b,REG_NOTIFY_MASTER_POST,NULL,NULL)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01471">1471</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a123" doxytag="cmp.h::CmpAllocateSlavePostBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpAllocateSlavePostBlock          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">b,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>k,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>m&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;CmpAllocatePostBlock(b,0,k,m)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01481">1481</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="cmp.h::CmpAllocateTag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpAllocateTag          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d1/genuedef_8c.html#a8">c</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;CmpAllocate(a,b)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00214">214</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="cmp.h::CmpClearListEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpClearListEntry          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(a)-&gt;Flink = (a)-&gt;Blink = NULL</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00054">54</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01028">CmNotifyRunDown()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01235">CmpFlushNotify()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03764">CmpFreePostBlock()</a>, and <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00487">CmpPostNotify()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a118" doxytag="cmp.h::CmpCopyTree" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpCopyTree          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">s,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d1/genuedef_8c.html#a8">c</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>t,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>l&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;CmpCopySyncTree(s,<a class="el" href="../../d7/d1/genuedef_8c.html#a8">c</a>,t,l,FALSE,Copy)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01314">1314</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03262">CmpCloneControlSet()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01869">CmpCloneHwProfile()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00484">CmpLoadHiveVolatile()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00097">CmRestoreKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00862">CmSaveKey()</a>, and <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01047">CmSaveMergedKeys()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a119" doxytag="cmp.h::CmpCopyTreeEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpCopyTreeEx          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">s,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d1/genuedef_8c.html#a8">c</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>t,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>l,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>f&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;CmpCopySyncTree(s,<a class="el" href="../../d7/d1/genuedef_8c.html#a8">c</a>,t,l,f,Copy)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01327">1327</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03458">CmpSaveBootControlSet()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a66" doxytag="cmp.h::CmpDumpSecurityDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpDumpSecurityDescriptor          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">x,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>y&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00400">400</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/cmse_8c-source.html#l00697">CmpAssignSecurityDescriptor()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00917">CmpCheckCreateAccess()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01032">CmpCheckNotifyAccess()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00397">CmpSetSecurityDescriptorInfo()</a>, and <a class="el" href="../../d3/d9/cmchek2_8c-source.html#l00034">CmpValidateHiveSecurityDescriptors()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a117" doxytag="cmp.h::CmpFindValueByName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpFindValueByName          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">h,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>k,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d0/exts_8h.html#a0">n</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;CmpFindNameInList(h,&amp;((k)-&gt;ValueList),<a class="el" href="../../d7/d0/exts_8h.html#a0">n</a>,NULL,NULL)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01243">1243</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/cmcontrl_8c-source.html#l00050">CmGetSystemControlValues()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00538">CmpAddDriverToList()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01082">CmpFindControlSet()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00108">CmpFindNLSData()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01284">CmpFindProfileOption()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01693">CmpFindTagIndex()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01476">CmpGetSymbolicLink()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00473">CmpIsLoadType()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01221">CmpSetCurrentProfile()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00744">CmpSortDriverList()</a>, and <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00940">CmQueryMultipleValueKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a96" doxytag="cmp.h::CmpHKeyNameLen" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpHKeyNameLen          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(((<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>)-&gt;Flags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>) ? \
            <a class="code" href="../../d9/d1/cmname_8c.html#a2">CmpCompressedNameSize</a>((Key)-&gt;Name,(Key)-&gt;NameLength) : \
            (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>)-&gt;NameLength)
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00673">673</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/cmhvlist_8c-source.html#l00251">CmpGetHiveName()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00484">CmpLoadHiveVolatile()</a>, and <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00110">CmpQueryKeyData()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a98" doxytag="cmp.h::CmpHKeyNodeSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpHKeyNodeSize          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(FIELD_OFFSET(<a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">CM_KEY_NODE</a>, <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>) + CmpNameSize(<a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00683">683</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01252">CmpCreateLinkNode()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01328">CmpCreateRootNode()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00226">CmpDoCreateChild()</a>, and <a class="el" href="../../d0/d4/edithive_8c-source.html#l00625">EhCreateChild()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a100" doxytag="cmp.h::CmpHKeyValueSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpHKeyValueSize          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d8/d2/rtrenval_8c.html#a3">ValueName</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(FIELD_OFFSET(<a class="el" href="../../d7/d5/struct__CM__KEY__VALUE.html">CM_KEY_VALUE</a>, <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>) + CmpNameSize(<a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d8/d2/rtrenval_8c.html#a3">ValueName</a>))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00697">697</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01619">CmpSetValueKeyNew()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="cmp.h::CmpMakeSpecialPoolReadOnly" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpMakeSpecialPoolReadOnly          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00142">142</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00403">CmpGetValueDataFromCache()</a>, <a class="el" href="../../d5/d2/cmtree_8c-source.html#l00200">CmpGetValueKeyFromCache()</a>, and <a class="el" href="../../d5/d2/cmtree_8c-source.html#l00115">CmpGetValueListFromCache()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="cmp.h::CmpMakeSpecialPoolReadWrite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpMakeSpecialPoolReadWrite          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00143">143</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00568">CmpCleanUpKcbValueCache()</a>, <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00403">CmpGetValueDataFromCache()</a>, and <a class="el" href="../../d5/d2/cmtree_8c-source.html#l00200">CmpGetValueKeyFromCache()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="cmp.h::CmpMakeValueCacheReadOnly" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpMakeValueCacheReadOnly          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00144">144</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00416">CmEnumerateValueKey()</a>, and <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00804">CmQueryValueKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="cmp.h::CmpMakeValueCacheReadWrite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpMakeValueCacheReadWrite          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00145">145</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00416">CmEnumerateValueKey()</a>, and <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00804">CmQueryValueKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="cmp.h::CmpMarkAllBinsReadOnly" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpMarkAllBinsReadOnly          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00172">172</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/cmapi2_8c-source.html#l00031">CmDeleteKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00092">CmDeleteValueKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00285">CmEnumerateKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00416">CmEnumerateValueKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00564">CmFlushKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00647">CmQueryKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00940">CmQueryMultipleValueKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00804">CmQueryValueKey()</a>, and <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01087">CmSetValueKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a121" doxytag="cmp.h::CmpMergeTrees" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpMergeTrees          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">s,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d1/genuedef_8c.html#a8">c</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>t,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>l&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;CmpCopySyncTree(s,<a class="el" href="../../d7/d1/genuedef_8c.html#a8">c</a>,t,l,FALSE,Merge)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01351">1351</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01047">CmSaveMergedKeys()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a97" doxytag="cmp.h::CmpNcbNameLen" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpNcbNameLen          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Ncb&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(((Ncb)-&gt;Compressed) ? \
            <a class="code" href="../../d9/d1/cmname_8c.html#a2">CmpCompressedNameSize</a>((Ncb)-&gt;Name,(Ncb)-&gt;NameLength) : \
            (Ncb)-&gt;NameLength)
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00678">678</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="cmp.h::CmpRemoveEntryList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpRemoveEntryList          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><span class="keywordflow">if</span>(((a)-&gt;Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; ((a)-&gt;Blink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {     \
            RemoveEntryList(a);                                                 \
            (a)-&gt;Flink = (a)-&gt;Blink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;                                 \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00048">48</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01028">CmNotifyRunDown()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01738">CmpCancelSlavePost()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01634">CmpFreeSlavePost()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00804">CmpPostApc()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00922">CmpPostApcRunDown()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00487">CmpPostNotify()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a151" doxytag="cmp.h::CmpSetIoStatus" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpSetIoStatus          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Iosb,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>s,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>i,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UseIosb32&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(Iosb)-&gt;Status = (s);                                                      \
(Iosb)-&gt;Information = (i);                                                 \
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l02019">2019</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01028">CmNotifyRunDown()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00804">CmpPostApc()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00922">CmpPostApcRunDown()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a120" doxytag="cmp.h::CmpSyncTrees" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpSyncTrees          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">s,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d1/genuedef_8c.html#a8">c</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>t,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>l,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>f&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;CmpCopySyncTree(s,<a class="el" href="../../d7/d1/genuedef_8c.html#a8">c</a>,t,l,f,Sync)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01339">1339</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03458">CmpSaveBootControlSet()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a99" doxytag="cmp.h::CmpValueNameLen" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpValueNameLen          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Value&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(((Value)-&gt;Flags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a37">VALUE_COMP_NAME</a>) ?                           \
            <a class="code" href="../../d9/d1/cmname_8c.html#a2">CmpCompressedNameSize</a>((Value)-&gt;Name,(Value)-&gt;NameLength) :  \
            (Value)-&gt;NameLength)
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00692">692</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00531">CmpQueryKeyValueData()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="cmp.h::CmpWmiFireEvent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpWmiFireEvent          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>KeyHandle,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ElapsedTime,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Type&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                                                   \
    <a class="code" href="../../d7/d9/cm_8h.html#a28">PCM_TRACE_NOTIFY_ROUTINE</a> TraceRoutine = <a class="code" href="../../d1/d2/cmp_8h.html#a153">CmpTraceRoutine</a>;        \
    <span class="keywordflow">if</span>( TraceRoutine != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {                                    \
        (*TraceRoutine)(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>,KeyHandle,ElapsedTime,<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,Type); \
    }                                                               \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00076">76</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="cmp.h::CMS_BIN_MAP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMS_BIN_MAP&nbsp;&nbsp;&nbsp;0x00004000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00269">269</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/hivefree_8c-source.html#l00034">HvFreeHive()</a>, <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">HvInitializeHive()</a>, and <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00437">HvpEnlistBinInMap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="cmp.h::CMS_CM" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMS_CM&nbsp;&nbsp;&nbsp;0x00000080          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00262">262</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/cmapi2_8c-source.html#l00031">CmDeleteKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00092">CmDeleteValueKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00285">CmEnumerateKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00416">CmEnumerateValueKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00564">CmFlushKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00647">CmQueryKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00940">CmQueryMultipleValueKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00804">CmQueryValueKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01841">CmSetLastWriteTimeKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01087">CmSetValueKey()</a>, and <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02079">CmUnloadKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a48" doxytag="cmp.h::CMS_CM_ERROR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMS_CM_ERROR&nbsp;&nbsp;&nbsp;0x00800000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00278">278</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a54" doxytag="cmp.h::CMS_DEFAULT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMS_DEFAULT&nbsp;&nbsp;&nbsp;((~(CMS_MAP)) &amp; 0xffffffff)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00286">286</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="cmp.h::CMS_EXCEPTION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMS_EXCEPTION&nbsp;&nbsp;&nbsp;0x00001000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00267">267</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01028">CmNotifyRunDown()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03603">CmpNameFromAttributes()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01383">CmpSetValueKeyExisting()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01619">CmpSetValueKeyNew()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01087">CmSetValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00504">NtDeleteValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00610">NtEnumerateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00756">NtEnumerateValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02881">NtLoadKey2()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02018">NtQueryKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03461">NtQueryMultipleValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l04090">NtQueryOpenSubKeys()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03235">NtSetInformationKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03093">NtUnloadKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="cmp.h::CMS_HIVE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMS_HIVE&nbsp;&nbsp;&nbsp;0x00000008          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00258">258</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d8/d9/hivebin_8c-source.html#l00046">HvpAddBin()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00536">HvpBuildMap()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00047">HvpBuildMapAndCopy()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00437">HvpEnlistBinInMap()</a>, and <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00304">HvpInitMap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="cmp.h::CMS_HIVE_ERROR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMS_HIVE_ERROR&nbsp;&nbsp;&nbsp;0x00080000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00274">274</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="cmp.h::CMS_INDEX" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMS_INDEX&nbsp;&nbsp;&nbsp;0x00002000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00268">268</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00895">CmpAddSubKey()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01087">CmpAddToLeaf()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00186">CmpFindSubKeyByName()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00771">CmpFindSubKeyByNumber()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00475">CmpFindSubKeyInLeaf()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00266">CmpFindSubKeyInRoot()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01257">CmpSelectLeaf()</a>, and <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01472">CmpSplitLeaf()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a53" doxytag="cmp.h::CMS_INDEX_ERROR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMS_INDEX_ERROR&nbsp;&nbsp;&nbsp;0x10000000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00283">283</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="cmp.h::CMS_INIT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMS_INIT&nbsp;&nbsp;&nbsp;0x00000002          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00256">256</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00544">CmpAddAcpiAliasEntry()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02606">CmpAddAliasEntry()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03262">CmpCloneControlSet()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01869">CmpCloneHwProfile()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02786">CmpCreateControlSet()</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00726">CmpInitializeHiveList()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03863">CmpIsLastKnownGoodBoot()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03983">CmpLinkKeyToHive()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l04077">CmpValidateAlternate()</a>, and <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">HvInitializeHive()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a42" doxytag="cmp.h::CMS_INIT_ERROR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMS_INIT_ERROR&nbsp;&nbsp;&nbsp;0x00020000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00272">272</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02169">CmGetSystemDriverList()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>, <a class="el" href="../../d7/d0/cmhvlist_8c-source.html#l00042">CmpAddToHiveFileList()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01074">CmpCreateObjectTypes()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01165">CmpCreateRegistryRoot()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01328">CmpCreateRootNode()</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00726">CmpInitializeHiveList()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02022">CmpInitializeSystemHive()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01421">CmpLinkHiveToMaster()</a>, and <a class="el" href="../../d9/d0/cminit_8c-source.html#l00046">CmpOpenHiveFiles()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="cmp.h::CMS_IO" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMS_IO&nbsp;&nbsp;&nbsp;0x00000010          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00259">259</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00772">CmpFileFlush()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00351">CmpFileRead()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00516">CmpFileWrite()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00368">CmpLazyFlush()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00416">CmpLazyFlushDpcRoutine()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00461">CmpLazyFlushWorker()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00200">HvIsBinDirty()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">HvMarkCellDirty()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00401">HvMarkClean()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00270">HvMarkDirty()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00775">HvpDoWriteHive()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01233">HvpFindNextDirtyBlock()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00495">HvpGrowLog1()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00565">HvpGrowLog2()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01025">HvpWriteLog()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00647">HvSyncHive()</a>, and <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01433">HvWriteHive()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a45" doxytag="cmp.h::CMS_IO_ERROR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMS_IO_ERROR&nbsp;&nbsp;&nbsp;0x00100000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00275">275</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00564">CmFlushKey()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00351">CmpFileRead()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00509">CmpFileSetSize()</a>, and <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00516">CmpFileWrite()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="cmp.h::CMS_LOCKING" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMS_LOCKING&nbsp;&nbsp;&nbsp;0x00000400          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00265">265</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00044">CmpLockRegistry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a51" doxytag="cmp.h::CMS_LOCKING_ERROR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMS_LOCKING_ERROR&nbsp;&nbsp;&nbsp;0x04000000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00281">281</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="cmp.h::CMS_MAP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMS_MAP&nbsp;&nbsp;&nbsp;0x00000001          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00255">255</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00146">HvpGetCellPaged()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="cmp.h::CMS_MAP_ERROR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMS_MAP_ERROR&nbsp;&nbsp;&nbsp;0x00010000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00271">271</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="cmp.h::CMS_NOTIFY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMS_NOTIFY&nbsp;&nbsp;&nbsp;0x00000800          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00266">266</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01738">CmpCancelSlavePost()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01235">CmpFlushNotify()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03764">CmpFreePostBlock()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01634">CmpFreeSlavePost()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01378">CmpNotifyChangeKey()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00804">CmpPostApc()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00922">CmpPostApcRunDown()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00487">CmpPostNotify()</a>, and <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00191">CmpReportNotify()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a52" doxytag="cmp.h::CMS_NOTIFY_ERROR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMS_NOTIFY_ERROR&nbsp;&nbsp;&nbsp;0x08000000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00282">282</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="cmp.h::CMS_NTAPI" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMS_NTAPI&nbsp;&nbsp;&nbsp;0x00000004          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00257">257</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01028">CmNotifyRunDown()</a>, <a class="el" href="../../d4/d9/cmclose_8c-source.html#l00028">CmpCloseKeyObject()</a>, <a class="el" href="../../d2/d0/cmdelete_8c-source.html#l00031">CmpDeleteKeyObject()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03764">CmpFreePostBlock()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00411">NtDeleteKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00504">NtDeleteValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00610">NtEnumerateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00756">NtEnumerateValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00904">NtFlushKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02881">NtLoadKey2()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01156">NtNotifyChangeKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02018">NtQueryKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03461">NtQueryMultipleValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l04090">NtQueryOpenSubKeys()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03336">NtReplaceKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02348">NtRestoreKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02471">NtSaveKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02559">NtSaveMergedKeys()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03235">NtSetInformationKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03093">NtUnloadKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="cmp.h::CMS_NTAPI_ERROR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMS_NTAPI_ERROR&nbsp;&nbsp;&nbsp;0x00040000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00273">273</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="cmp.h::CMS_PARSE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMS_PARSE&nbsp;&nbsp;&nbsp;0x00000020          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00260">260</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01252">CmpCreateLinkNode()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00033">CmpDoCreate()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00226">CmpDoCreateChild()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00963">CmpDoOpen()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01476">CmpGetSymbolicLink()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>, and <a class="el" href="../../d6/d1/cmquery_8c-source.html#l00028">CmpQueryKeyName()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a46" doxytag="cmp.h::CMS_PARSE_ERROR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMS_PARSE_ERROR&nbsp;&nbsp;&nbsp;0x00200000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00276">276</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="cmp.h::CMS_POOL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMS_POOL&nbsp;&nbsp;&nbsp;0x00000200          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00264">264</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00062">CmpAllocate()</a>, <a class="el" href="../../d4/d9/cmclose_8c-source.html#l00028">CmpCloseKeyObject()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00963">CmpDoOpen()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00186">CmpFree()</a>, and <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01378">CmpNotifyChangeKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a50" doxytag="cmp.h::CMS_POOL_ERROR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMS_POOL_ERROR&nbsp;&nbsp;&nbsp;0x02000000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00280">280</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="cmp.h::CMS_SAVRES" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMS_SAVRES&nbsp;&nbsp;&nbsp;0x00000040          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00261">261</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01009">CmpCopyCell()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00686">CmpCopyKeyPartial()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00127">CmpCopySyncTree()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00251">CmpCopySyncTree2()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00895">CmpCopyValue()</a>, <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00034">CmpDeleteTree()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01490">CmpDestroyTemporaryHive()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02293">CmReplaceKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00097">CmRestoreKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00862">CmSaveKey()</a>, and <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01047">CmSaveMergedKeys()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a47" doxytag="cmp.h::CMS_SAVRES_ERROR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMS_SAVRES_ERROR&nbsp;&nbsp;&nbsp;0x00400000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00277">277</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="cmp.h::CMS_SEC" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMS_SEC&nbsp;&nbsp;&nbsp;0x00000100          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00263">263</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/cmse_8c-source.html#l00697">CmpAssignSecurityDescriptor()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00917">CmpCheckCreateAccess()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01032">CmpCheckNotifyAccess()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01545">CmpFindMatchingDescriptorCell()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01464">CmpFreeSecurityDescriptor()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01165">CmpGetKeySecurity()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01109">CmpGetObjectSecurity()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01227">CmpHiveRootSecurityDescriptor()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01704">CmpInsertSecurityCellList()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00847">CmpQuerySecurityDescriptorInfo()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01823">CmpRemoveSecurityCellList()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00158">CmpSecurityMethod()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00397">CmpSetSecurityDescriptorInfo()</a>, and <a class="el" href="../../d3/d9/cmchek2_8c-source.html#l00034">CmpValidateHiveSecurityDescriptors()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a49" doxytag="cmp.h::CMS_SEC_ERROR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMS_SEC_ERROR&nbsp;&nbsp;&nbsp;0x01000000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00279">279</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a95" doxytag="cmp.h::CmUnlockHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmUnlockHive          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_hive_&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (_hive_)-&gt;HiveLock );\
                             <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>((_hive_)-&gt;HiveLock)
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00662">662</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00564">CmFlushKey()</a>, <a class="el" href="../../d4/d9/cmclose_8c-source.html#l00028">CmpCloseKeyObject()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02195">CmpDoFlushAll()</a>, and <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01235">CmpFlushNotify()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a57" doxytag="cmp.h::DCmCheckRegistry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DCmCheckRegistry          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00308">308</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00564">CmFlushKey()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00397">CmpSetSecurityDescriptorInfo()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00097">CmRestoreKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00862">CmSaveKey()</a>, and <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01047">CmSaveMergedKeys()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a82" doxytag="cmp.h::DELIST_KEYBODY_FROM_KEYBODY_LIST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DELIST_KEYBODY_FROM_KEYBODY_LIST          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">KeyBody&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00527">527</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/cmdelete_8c-source.html#l00031">CmpDeleteKeyObject()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a60" doxytag="cmp.h::END_LOCK_CHECKPOINT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define END_LOCK_CHECKPOINT          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>} except(<a class="code" href="../../d1/d2/cmp_8h.html#a207">CmpCheckLockExceptionFilter</a>(GetExceptionInformation())) {}     \
        LockCountAfter = <a class="code" href="../../d5/d8/ex_8h.html#a75">ExIsResourceAcquiredShared</a>(&amp;CmpRegistryLock);          \
        LockCountAfter += <a class="code" href="../../d5/d8/ex_8h.html#a74">ExIsResourceAcquiredExclusive</a>(&amp;CmpRegistryLock);      \
        <span class="keywordflow">if</span>( LockCountBefore != LockCountAfter ) {                               \
            <a class="code" href="../../d6/d3/cmwraper_8c.html#a23">KeBugCheckEx</a>(REGISTRY_ERROR,13,LockCountBefore,LockCountAfter,0);   \
        }                                                                       \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00325">325</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00411">NtDeleteKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00504">NtDeleteValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00610">NtEnumerateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00756">NtEnumerateValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00904">NtFlushKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02881">NtLoadKey2()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02018">NtQueryKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03461">NtQueryMultipleValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l04090">NtQueryOpenSubKeys()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03336">NtReplaceKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02348">NtRestoreKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02471">NtSaveKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02559">NtSaveMergedKeys()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03235">NtSetInformationKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03093">NtUnloadKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="cmp.h::EndWmiCmTrace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define EndWmiCmTrace          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Type&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a153">CmpTraceRoutine</a>) {\
        <span class="keywordflow">try</span> {\
            <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a152">WmiUsePerfClock</a>) {\
                EndSystemTime = <a class="code" href="../../d2/d7/hal_8h.html#a205">KeQueryPerformanceCounter</a>(NULL);\
            }\
            <span class="keywordflow">else</span> {\
                <a class="code" href="../../d6/d3/cmwraper_8c.html#a24">KeQuerySystemTime</a>(&amp;EndSystemTime);\
            }\
            <a class="code" href="../../d1/d2/cmp_8h.html#a4">CmpWmiFireEvent</a>(Status,Handle,EndSystemTime.QuadPart - StartSystemTime.QuadPart,KeyName,Type);\
        } except (EXCEPTION_EXECUTE_HANDLER) {\
        }\
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00097">97</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00411">NtDeleteKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00504">NtDeleteValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00610">NtEnumerateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00756">NtEnumerateValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00904">NtFlushKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02018">NtQueryKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03461">NtQueryMultipleValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03235">NtSetInformationKey()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a81" doxytag="cmp.h::ENLIST_KEYBODY_IN_KEYBODY_LIST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ENLIST_KEYBODY_IN_KEYBODY_LIST          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">KeyBody&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00526">526</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01165">CmpCreateRegistryRoot()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00226">CmpDoCreateChild()</a>, and <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00963">CmpDoOpen()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a77" doxytag="cmp.h::GET_HASH_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define GET_HASH_ENTRY          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Table,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;Table[GET_HASH_INDEX(<a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>)]</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00475">475</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01853">CmpCacheLookup()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00503">CmpDereferenceNameControlBlockWithLock()</a>, and <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01476">CmpGetSymbolicLink()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a76" doxytag="cmp.h::GET_HASH_INDEX" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define GET_HASH_INDEX          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;HASH_KEY(<a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>) % <a class="el" href="../../d8/d2/cmsubs_8c.html#a3">CmpHashTableSize</a></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00474">474</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00368">CmpGetNameControlBlock()</a>, and <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01350">CmpInsertKeyHash()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a75" doxytag="cmp.h::HASH_KEY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HASH_KEY          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_convkey_&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((RNDM_CONSTANT * (_convkey_)) % RNDM_PRIME)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00472">472</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01459">CmpRemoveKeyHash()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="cmp.h::HvpChangeBinAllocation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HvpChangeBinAllocation          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00170">170</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="cmp.h::HvpMarkBinReadWrite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HvpMarkBinReadWrite          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00171">171</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00270">HvMarkDirty()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a79" doxytag="cmp.h::INIT_KCB_KEYBODY_LIST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define INIT_KCB_KEYBODY_LIST          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">kcb&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00524">524</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00824">CmpCreateKeyControlBlock()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a89" doxytag="cmp.h::IsMasterPostBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IsMasterPostBlock          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_post_&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;( ((_post_)-&gt;NotifyType) &amp;   REG_NOTIFY_MASTER_POST )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00632">632</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01028">CmNotifyRunDown()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03883">CmpAllocatePostBlock()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01738">CmpCancelSlavePost()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03764">CmpFreePostBlock()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01634">CmpFreeSlavePost()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01378">CmpNotifyChangeKey()</a>, and <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00487">CmpPostNotify()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a114" doxytag="cmp.h::KCB_WORKER_CONTINUE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define KCB_WORKER_CONTINUE&nbsp;&nbsp;&nbsp;0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00855">855</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00684">CmpRefreshWorkerRoutine()</a>, and <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01071">CmpSearchKeyControlBlockTree()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a116" doxytag="cmp.h::KCB_WORKER_DELETE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define KCB_WORKER_DELETE&nbsp;&nbsp;&nbsp;2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00857">857</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00684">CmpRefreshWorkerRoutine()</a>, and <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01071">CmpSearchKeyControlBlockTree()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a115" doxytag="cmp.h::KCB_WORKER_DONE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define KCB_WORKER_DONE&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00856">856</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01071">CmpSearchKeyControlBlockTree()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a78" doxytag="cmp.h::KEY_BODY_TYPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define KEY_BODY_TYPE&nbsp;&nbsp;&nbsp;0x6b793032          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00486">486</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/cmclose_8c-source.html#l00028">CmpCloseKeyObject()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01165">CmpCreateRegistryRoot()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01900">CmpDelayedDerefKeys()</a>, <a class="el" href="../../d2/d0/cmdelete_8c-source.html#l00031">CmpDeleteKeyObject()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00226">CmpDoCreateChild()</a>, and <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00963">CmpDoOpen()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="cmp.h::LOCK_KCB_TREE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LOCK_KCB_TREE          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExAcquireFastMutexUnsafe(&amp;<a class="el" href="../../d1/d3/cmsysini_8c.html#a11">CmpKcbLock</a>)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00230">230</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00416">CmEnumerateValueKey()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l02056">CmpAddInfoAfterParseFailure()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00824">CmpCreateKeyControlBlock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01153">CmpDereferenceKeyControlBlock()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00963">CmpDoOpen()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01476">CmpGetSymbolicLink()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>, and <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00804">CmQueryValueKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a92" doxytag="cmp.h::LOCK_POST_LIST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LOCK_POST_LIST          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExAcquireFastMutexUnsafe(&amp;<a class="el" href="../../d1/d3/cmsysini_8c.html#a12">CmpPostLock</a>)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00643">643</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00487">CmpPostNotify()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a72" doxytag="cmp.h::MAX_HIVE_LAYERS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MAX_HIVE_LAYERS&nbsp;&nbsp;&nbsp;2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00442">442</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a68" doxytag="cmp.h::NUMBER_TYPES" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define NUMBER_TYPES&nbsp;&nbsp;&nbsp;(MaximumType + 1)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00420">420</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00465">CmpInitializeMachineDependentConfiguration()</a>, and <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00294">CmpSetupConfigurationTree()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a88" doxytag="cmp.h::PostBlockType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PostBlockType          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_post_&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((<a class="el" href="../../d1/d2/cmp_8h.html#a166">POST_BLOCK_TYPE</a>)( ((_post_)-&gt;NotifyType) &amp; REG_NOTIFY_POST_TYPE_MASK ))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00630">630</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01028">CmNotifyRunDown()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03764">CmpFreePostBlock()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00281">CmpNotifyTriggerCheck()</a>, and <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00487">CmpPostNotify()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a108" doxytag="cmp.h::REG_CMD_ADD_HIVE_LIST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define REG_CMD_ADD_HIVE_LIST&nbsp;&nbsp;&nbsp;8          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00726">726</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01901">CmLoadKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00484">CmpLoadHiveVolatile()</a>, and <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a103" doxytag="cmp.h::REG_CMD_FILE_SET_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define REG_CMD_FILE_SET_SIZE&nbsp;&nbsp;&nbsp;3          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00721">721</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d2/cmwrapr2_8c-source.html#l00045">CmpFileSetSize()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>, and <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00323">CmpWorkerCommand()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a102" doxytag="cmp.h::REG_CMD_FLUSH_KEY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define REG_CMD_FLUSH_KEY&nbsp;&nbsp;&nbsp;2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00720">720</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00323">CmpWorkerCommand()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02079">CmUnloadKey()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00904">NtFlushKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a105" doxytag="cmp.h::REG_CMD_HIVE_CLOSE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define REG_CMD_HIVE_CLOSE&nbsp;&nbsp;&nbsp;5          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00723">723</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01901">CmLoadKey()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00323">CmpWorkerCommand()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02293">CmReplaceKey()</a>, and <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02079">CmUnloadKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a104" doxytag="cmp.h::REG_CMD_HIVE_OPEN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define REG_CMD_HIVE_OPEN&nbsp;&nbsp;&nbsp;4          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00722">722</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01901">CmLoadKey()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00323">CmpWorkerCommand()</a>, and <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02293">CmReplaceKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a111" doxytag="cmp.h::REG_CMD_HIVE_READ" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define REG_CMD_HIVE_READ&nbsp;&nbsp;&nbsp;11          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00729">729</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01261">CmpSaveKeyByFileCopy()</a>, and <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a101" doxytag="cmp.h::REG_CMD_INIT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define REG_CMD_INIT&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00719">719</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00997">NtInitializeRegistry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a110" doxytag="cmp.h::REG_CMD_REFRESH_HIVE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define REG_CMD_REFRESH_HIVE&nbsp;&nbsp;&nbsp;10          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00728">728</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00731">CmpRefreshHive()</a>, and <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a109" doxytag="cmp.h::REG_CMD_REMOVE_HIVE_LIST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define REG_CMD_REMOVE_HIVE_LIST&nbsp;&nbsp;&nbsp;9          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00727">727</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>, and <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02079">CmUnloadKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a107" doxytag="cmp.h::REG_CMD_RENAME_HIVE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define REG_CMD_RENAME_HIVE&nbsp;&nbsp;&nbsp;7          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00725">725</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>, and <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02293">CmReplaceKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a106" doxytag="cmp.h::REG_CMD_SHUTDOWN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define REG_CMD_SHUTDOWN&nbsp;&nbsp;&nbsp;6          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00724">724</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00323">CmpWorkerCommand()</a>, and <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03944">CmShutdownSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a87" doxytag="cmp.h::REG_NOTIFY_MASTER_POST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define REG_NOTIFY_MASTER_POST&nbsp;&nbsp;&nbsp;(0x00010000L)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00625">625</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03764">CmpFreePostBlock()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a86" doxytag="cmp.h::REG_NOTIFY_POST_TYPE_MASK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define REG_NOTIFY_POST_TYPE_MASK&nbsp;&nbsp;&nbsp;(0x0000FFFFL)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00623">623</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a112" doxytag="cmp.h::REG_OPTION_PREDEF_HANDLE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define REG_OPTION_PREDEF_HANDLE&nbsp;&nbsp;&nbsp;(0x00000008L)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00766">766</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l04234">CmpCreatePredefined()</a>, and <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00226">CmpDoCreateChild()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a113" doxytag="cmp.h::REG_PREDEF_HANDLE_MASK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define REG_PREDEF_HANDLE_MASK&nbsp;&nbsp;&nbsp;(0x80000000L)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00767">767</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/cmdelete_8c-source.html#l00031">CmpDeleteKeyObject()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a56" doxytag="cmp.h::REGCHECKING" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define REGCHECKING&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00297">297</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a58" doxytag="cmp.h::REGISTRY_LOCK_CHECKING" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define REGISTRY_LOCK_CHECKING          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00311">311</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a73" doxytag="cmp.h::RNDM_CONSTANT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define RNDM_CONSTANT&nbsp;&nbsp;&nbsp;314159269    /* default value for "scrambling constant" */          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00469">469</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a74" doxytag="cmp.h::RNDM_PRIME" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define RNDM_PRIME&nbsp;&nbsp;&nbsp;1000000007    /* prime number, also used for scrambling  */          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00470">470</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a90" doxytag="cmp.h::SetMasterPostBlockFlag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SetMasterPostBlockFlag          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_post_&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;( ((_post_)-&gt;NotifyType) |=  REG_NOTIFY_MASTER_POST )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00633">633</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00487">CmpPostNotify()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a124" doxytag="cmp.h::SetUsed" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SetUsed          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                               \
        <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  p;                              \
        p = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);                  \
        <a class="code" href="../../d1/d0/cmchek_8c.html#a1">CmpUsedStorage</a> += <a class="code" href="../../d6/d0/hive_8h.html#a45">HvGetCellSize</a>(Hive, p);   \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01555">1555</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00323">CmpCheckKey()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00588">CmpCheckValueList()</a>, and <a class="el" href="../../d3/d9/cmchek2_8c-source.html#l00034">CmpValidateHiveSecurityDescriptors()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="cmp.h::StartWmiCmTrace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define StartWmiCmTrace          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>LARGE_INTEGER StartSystemTime;\
    LARGE_INTEGER EndSystemTime;\
    <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a153">CmpTraceRoutine</a>) {\
        <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a152">WmiUsePerfClock</a>) {\
            StartSystemTime = <a class="code" href="../../d2/d7/hal_8h.html#a205">KeQueryPerformanceCounter</a>(NULL);\
        }\
        <span class="keywordflow">else</span> {\
            <a class="code" href="../../d6/d3/cmwraper_8c.html#a24">KeQuerySystemTime</a>(&amp;StartSystemTime);\
        }\
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00084">84</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00411">NtDeleteKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00504">NtDeleteValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00610">NtEnumerateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00756">NtEnumerateValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00904">NtFlushKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02018">NtQueryKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03461">NtQueryMultipleValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03235">NtSetInformationKey()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="cmp.h::UNLOCK_KCB_TREE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UNLOCK_KCB_TREE          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExReleaseFastMutexUnsafe(&amp;<a class="el" href="../../d1/d3/cmsysini_8c.html#a11">CmpKcbLock</a>)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00231">231</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00416">CmEnumerateValueKey()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l02056">CmpAddInfoAfterParseFailure()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00824">CmpCreateKeyControlBlock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01153">CmpDereferenceKeyControlBlock()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00963">CmpDoOpen()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01476">CmpGetSymbolicLink()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>, and <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00804">CmQueryValueKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a93" doxytag="cmp.h::UNLOCK_POST_LIST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UNLOCK_POST_LIST          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExReleaseFastMutexUnsafe(&amp;<a class="el" href="../../d1/d3/cmsysini_8c.html#a12">CmpPostLock</a>)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00644">644</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00487">CmpPostNotify()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a65" doxytag="cmp.h::VALIDATE_CELL_MAP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define VALIDATE_CELL_MAP          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">LINE,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Map,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Address&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><span class="keywordflow">if</span>( Map == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {                                                                             \
            <a class="code" href="../../d1/d2/cmp_8h.html#a64">CM_BUGCHECK</a> (REGISTRY_ERROR,11,(ULONG_PTR)(Hive),(ULONG)(Address),(ULONG)(LINE)) ;     \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00378">378</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d3/d0/hivefree_8c-source.html#l00034">HvFreeHive()</a>, <a class="el" href="../../d3/d0/hivefree_8c-source.html#l00160">HvFreeHivePartial()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00200">HvIsBinDirty()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">HvMarkCellDirty()</a>, <a class="el" href="../../d8/d9/hivebin_8c-source.html#l00046">HvpAddBin()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00047">HvpBuildMapAndCopy()</a>, <a class="el" href="../../d8/d9/hivebin_8c-source.html#l00434">HvpCoalesceDiscardedBins()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01885">HvpDiscardBins()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00775">HvpDoWriteHive()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00437">HvpEnlistBinInMap()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01233">HvpFindNextDirtyBlock()</a>, <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00847">HvpRecoverData()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01946">HvpTruncateBins()</a>, and <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01584">HvRefreshHive()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a157" doxytag="cmp.h::BOOT_DRIVER_NODE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">_BOOT_DRIVER_NODE</a>  <a class="el" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">BOOT_DRIVER_NODE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00333">CmpFindDrivers()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a171" doxytag="cmp.h::CM_ASYNC_KERNEL_POST_BLOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d3/struct__CM__ASYNC__KERNEL__POST__BLOCK.html">_CM_ASYNC_KERNEL_POST_BLOCK</a>  <a class="el" href="../../d0/d3/struct__CM__ASYNC__KERNEL__POST__BLOCK.html">CM_ASYNC_KERNEL_POST_BLOCK</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a169" doxytag="cmp.h::CM_ASYNC_USER_POST_BLOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html">_CM_ASYNC_USER_POST_BLOCK</a>  <a class="el" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html">CM_ASYNC_USER_POST_BLOCK</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a189" doxytag="cmp.h::CM_HARDWARE_PROFILE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html">_CM_HARDWARE_PROFILE</a>  <a class="el" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html">CM_HARDWARE_PROFILE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01284">CmpFindProfileOption()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a197" doxytag="cmp.h::CM_HARDWARE_PROFILE_ACPI_ALIAS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d6/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS.html">_CM_HARDWARE_PROFILE_ACPI_ALIAS</a>  <a class="el" href="../../d6/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS.html">CM_HARDWARE_PROFILE_ACPI_ALIAS</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a199" doxytag="cmp.h::CM_HARDWARE_PROFILE_ACPI_ALIAS_LIST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d7/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS__LIST.html">_CM_HARDWARE_PROFILE_ACPI_ALIAS_LIST</a>  <a class="el" href="../../d7/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS__LIST.html">CM_HARDWARE_PROFILE_ACPI_ALIAS_LIST</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a193" doxytag="cmp.h::CM_HARDWARE_PROFILE_ALIAS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d3/struct__CM__HARDWARE__PROFILE__ALIAS.html">_CM_HARDWARE_PROFILE_ALIAS</a>  <a class="el" href="../../d8/d3/struct__CM__HARDWARE__PROFILE__ALIAS.html">CM_HARDWARE_PROFILE_ALIAS</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a195" doxytag="cmp.h::CM_HARDWARE_PROFILE_ALIAS_LIST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d9/d3/struct__CM__HARDWARE__PROFILE__ALIAS__LIST.html">_CM_HARDWARE_PROFILE_ALIAS_LIST</a>  <a class="el" href="../../d9/d3/struct__CM__HARDWARE__PROFILE__ALIAS__LIST.html">CM_HARDWARE_PROFILE_ALIAS_LIST</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a191" doxytag="cmp.h::CM_HARDWARE_PROFILE_LIST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">_CM_HARDWARE_PROFILE_LIST</a>  <a class="el" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">CM_HARDWARE_PROFILE_LIST</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01284">CmpFindProfileOption()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a160" doxytag="cmp.h::CM_KEY_BODY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d4/d4/struct__CM__KEY__BODY.html">_CM_KEY_BODY</a>  <a class="el" href="../../d4/d4/struct__CM__KEY__BODY.html">CM_KEY_BODY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a164" doxytag="cmp.h::CM_NOTIFY_BLOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">_CM_NOTIFY_BLOCK</a>  <a class="el" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">CM_NOTIFY_BLOCK</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01378">CmpNotifyChangeKey()</a>, and <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00357">CmpReportNotifyHelper()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a182" doxytag="cmp.h::CM_PARSE_CONTEXT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">_CM_PARSE_CONTEXT</a>  <a class="el" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">CM_PARSE_CONTEXT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a175" doxytag="cmp.h::CM_POST_BLOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">_CM_POST_BLOCK</a>  <a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">CM_POST_BLOCK</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03883">CmpAllocatePostBlock()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03764">CmpFreePostBlock()</a>, and <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00281">CmpNotifyTriggerCheck()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a173" doxytag="cmp.h::CM_POST_BLOCK_UNION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef union <a class="el" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html">_CM_POST_BLOCK_UNION</a>  <a class="el" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html">CM_POST_BLOCK_UNION</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03883">CmpAllocatePostBlock()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a162" doxytag="cmp.h::CM_POST_KEY_BODY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d6/d6/struct__CM__POST__KEY__BODY.html">_CM_POST_KEY_BODY</a>  <a class="el" href="../../d6/d6/struct__CM__POST__KEY__BODY.html">CM_POST_KEY_BODY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03883">CmpAllocatePostBlock()</a>, and <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01900">CmpDelayedDerefKeys()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a167" doxytag="cmp.h::CM_SYNC_POST_BLOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d7/d6/struct__CM__SYNC__POST__BLOCK.html">_CM_SYNC_POST_BLOCK</a>  <a class="el" href="../../d7/d6/struct__CM__SYNC__POST__BLOCK.html">CM_SYNC_POST_BLOCK</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a178" doxytag="cmp.h::CMHIVE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d9/d6/struct__CMHIVE.html">_CMHIVE</a>  <a class="el" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00564">CmFlushKey()</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, and <a class="el" href="../../d5/d5/regext_8c-source.html#l00073">pool()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a187" doxytag="cmp.h::HIVE_LIST_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d9/d7/struct__HIVE__LIST__ENTRY.html">_HIVE_LIST_ENTRY</a>  <a class="el" href="../../d9/d7/struct__HIVE__LIST__ENTRY.html">HIVE_LIST_ENTRY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a158" doxytag="cmp.h::PBOOT_DRIVER_NODE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">_BOOT_DRIVER_NODE</a> * <a class="el" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">PBOOT_DRIVER_NODE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a201" doxytag="cmp.h::PCM_ACPI_SELECTION_ROUTINE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef NTSTATUS(* <a class="el" href="../../d1/d2/cmp_8h.html#a201">PCM_ACPI_SELECTION_ROUTINE</a>)(IN <a class="el" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">PCM_HARDWARE_PROFILE_LIST</a> ProfileList, OUT PULONG ProfileIndexToUse,IN PVOID Context)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01798">1798</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a172" doxytag="cmp.h::PCM_ASYNC_KERNEL_POST_BLOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d3/struct__CM__ASYNC__KERNEL__POST__BLOCK.html">_CM_ASYNC_KERNEL_POST_BLOCK</a> * <a class="el" href="../../d0/d3/struct__CM__ASYNC__KERNEL__POST__BLOCK.html">PCM_ASYNC_KERNEL_POST_BLOCK</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a170" doxytag="cmp.h::PCM_ASYNC_USER_POST_BLOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html">_CM_ASYNC_USER_POST_BLOCK</a> * <a class="el" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html">PCM_ASYNC_USER_POST_BLOCK</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a190" doxytag="cmp.h::PCM_HARDWARE_PROFILE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html">_CM_HARDWARE_PROFILE</a> * <a class="el" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html">PCM_HARDWARE_PROFILE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01221">CmpSetCurrentProfile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a198" doxytag="cmp.h::PCM_HARDWARE_PROFILE_ACPI_ALIAS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d6/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS.html">_CM_HARDWARE_PROFILE_ACPI_ALIAS</a> * <a class="el" href="../../d6/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS.html">PCM_HARDWARE_PROFILE_ACPI_ALIAS</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a200" doxytag="cmp.h::PCM_HARDWARE_PROFILE_ACPI_ALIAS_LIST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d7/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS__LIST.html">_CM_HARDWARE_PROFILE_ACPI_ALIAS_LIST</a> * <a class="el" href="../../d7/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS__LIST.html">PCM_HARDWARE_PROFILE_ACPI_ALIAS_LIST</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a194" doxytag="cmp.h::PCM_HARDWARE_PROFILE_ALIAS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d3/struct__CM__HARDWARE__PROFILE__ALIAS.html">_CM_HARDWARE_PROFILE_ALIAS</a> * <a class="el" href="../../d8/d3/struct__CM__HARDWARE__PROFILE__ALIAS.html">PCM_HARDWARE_PROFILE_ALIAS</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a196" doxytag="cmp.h::PCM_HARDWARE_PROFILE_ALIAS_LIST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d9/d3/struct__CM__HARDWARE__PROFILE__ALIAS__LIST.html">_CM_HARDWARE_PROFILE_ALIAS_LIST</a> * <a class="el" href="../../d9/d3/struct__CM__HARDWARE__PROFILE__ALIAS__LIST.html">PCM_HARDWARE_PROFILE_ALIAS_LIST</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01284">CmpFindProfileOption()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a192" doxytag="cmp.h::PCM_HARDWARE_PROFILE_LIST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">_CM_HARDWARE_PROFILE_LIST</a> * <a class="el" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">PCM_HARDWARE_PROFILE_LIST</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01284">CmpFindProfileOption()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a161" doxytag="cmp.h::PCM_KEY_BODY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d4/d4/struct__CM__KEY__BODY.html">_CM_KEY_BODY</a> * <a class="el" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d9/cmapi2_8c-source.html#l00031">CmDeleteKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a165" doxytag="cmp.h::PCM_NOTIFY_BLOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">_CM_NOTIFY_BLOCK</a> * <a class="el" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d4/d9/cmclose_8c-source.html#l00028">CmpCloseKeyObject()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a183" doxytag="cmp.h::PCM_PARSE_CONTEXT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">_CM_PARSE_CONTEXT</a> * <a class="el" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">PCM_PARSE_CONTEXT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a176" doxytag="cmp.h::PCM_POST_BLOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">_CM_POST_BLOCK</a> * <a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a174" doxytag="cmp.h::PCM_POST_BLOCK_UNION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef union <a class="el" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html">_CM_POST_BLOCK_UNION</a> * <a class="el" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html">PCM_POST_BLOCK_UNION</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a163" doxytag="cmp.h::PCM_POST_KEY_BODY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d6/d6/struct__CM__POST__KEY__BODY.html">_CM_POST_KEY_BODY</a> * <a class="el" href="../../d6/d6/struct__CM__POST__KEY__BODY.html">PCM_POST_KEY_BODY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01900">CmpDelayedDerefKeys()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a168" doxytag="cmp.h::PCM_SYNC_POST_BLOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d7/d6/struct__CM__SYNC__POST__BLOCK.html">_CM_SYNC_POST_BLOCK</a> * <a class="el" href="../../d7/d6/struct__CM__SYNC__POST__BLOCK.html">PCM_SYNC_POST_BLOCK</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a179" doxytag="cmp.h::PCMHIVE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d9/d6/struct__CMHIVE.html">_CMHIVE</a> * <a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00564">CmFlushKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a188" doxytag="cmp.h::PHIVE_LIST_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d9/d7/struct__HIVE__LIST__ENTRY.html">_HIVE_LIST_ENTRY</a> * <a class="el" href="../../d9/d7/struct__HIVE__LIST__ENTRY.html">PHIVE_LIST_ENTRY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d5/regext_8c-source.html#l00073">pool()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a184" doxytag="cmp.h::PKCB_WORKER_ROUTINE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef ULONG(* <a class="el" href="../../d1/d2/cmp_8h.html#a184">PKCB_WORKER_ROUTINE</a>)(<a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> Current, PVOID <a class="el" href="../../d3/d1/threads_8h.html#a107">Context1</a>, PVOID <a class="el" href="../../d3/d1/threads_8h.html#a108">Context2</a>)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00861">861</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a166" doxytag="cmp.h::POST_BLOCK_TYPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d1/d2/cmp_8h.html#a335">_POST_BLOCK_TYPE</a>  <a class="el" href="../../d1/d2/cmp_8h.html#a166">POST_BLOCK_TYPE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00281">CmpNotifyTriggerCheck()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a181" doxytag="cmp.h::PREGISTRY_COMMAND" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d4/d3/struct__REGISTRY__COMMAND.html">_REGISTRY_COMMAND</a> * <a class="el" href="../../d4/d3/struct__REGISTRY__COMMAND.html">PREGISTRY_COMMAND</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a180" doxytag="cmp.h::REGISTRY_COMMAND" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d4/d3/struct__REGISTRY__COMMAND.html">_REGISTRY_COMMAND</a>  <a class="el" href="../../d4/d3/struct__REGISTRY__COMMAND.html">REGISTRY_COMMAND</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01901">CmLoadKey()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00904">NtFlushKey()</a>.    </td>
  </tr>
</table>
<hr><h2>Enumeration Type Documentation</h2>
<a class="anchor" name="a335" doxytag="cmp.h::_POST_BLOCK_TYPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d1/d2/cmp_8h.html#a335">_POST_BLOCK_TYPE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a335a204" doxytag="PostSynchronous" ></a>PostSynchronous</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a335a205" doxytag="PostAsyncUser" ></a>PostAsyncUser</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a335a206" doxytag="PostAsyncKernel" ></a>PostAsyncKernel</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00582">582</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
<pre class="fragment"><div>00582                               {
00583     <a class="code" href="../../d1/d2/cmp_8h.html#a335a204">PostSynchronous</a> = 1,
00584     <a class="code" href="../../d1/d2/cmp_8h.html#a335a205">PostAsyncUser</a> = 2,
00585     <a class="code" href="../../d1/d2/cmp_8h.html#a335a206">PostAsyncKernel</a> = 3
00586 } <a class="code" href="../../d1/d2/cmp_8h.html#a166">POST_BLOCK_TYPE</a>;
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a294" doxytag="cmp.h::CmCheckRegistry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG CmCheckRegistry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CmHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Clean</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00108">108</a> of file <a class="el" href="../../d2/d9/cmchek_8c-source.html">cmchek.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d1/d0/cmchek_8c.html#a5">CmCheckRegistryDebug</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00104">CmpCheckClean</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00103">CmpCheckHive</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00210">CmpCheckRegistry2()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00036">CmpMasterHive</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00034">CmpUsedStorage</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00175">CmpValidateHiveSecurityDescriptors()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00649">_CMHIVE::Hive</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d0/d0/hivechek_8c-source.html#l00054">HvCheckHive()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00343">_HBASE_BLOCK::RootCell</a>, and <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00026">UsedStorage</a>.
<p>
Referenced by <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02022">CmpInitializeSystemHive()</a>, and <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01584">HvRefreshHive()</a>.
<p>
<pre class="fragment"><div>00114                    :
00115 
00116     Check consistency of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry within a given hive.  <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> from
00117     root, and check that:
00118         .   Each child key points back to its parent.
00119         .   All allocated cells are refered to exactly once
00120             (requires looking inside <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive structure...)
00121             [This also detects space leaks.]
00122         .   All allocated cells are reachable from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root.
00123 
00124     NOTE:   Exactly 1 ref rule may change with security.
00125 
00126 Arguments:
00127 
00128     CmHive - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CM hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00129             hive of interest.
00130 
00131     Clean   - <span class="keywordflow">if</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, references to <span class="keyword">volatile</span> cells will be zapped
00132               (done at startup <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> to avoid groveling hives twice.)
00133               <span class="keywordflow">if</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, nothing will be changed.
00134 
00135 Return Value:
00136 
00137     0 <span class="keywordflow">if</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> OK.  <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a> <span class="keywordflow">return</span> indicator <span class="keywordflow">if</span> not.
00138 
00139     RANGE:  3000 - 3999
00140 
00141 --*/
00142 {
00143     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>  <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00144     ULONG   rc = 0;
00145     ULONG   Storage;
00146 
00147     <span class="keywordflow">if</span> (CmHive == <a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>) {
00148         <span class="keywordflow">return</span>(0);
00149     }
00150 
00151     <a class="code" href="../../d1/d0/cmchek_8c.html#a1">CmpUsedStorage</a> = 0;
00152 
00153     <a class="code" href="../../d1/d0/cmchek_8c.html#a5">CmCheckRegistryDebug</a>.Hive = (<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)CmHive;
00154     <a class="code" href="../../d1/d0/cmchek_8c.html#a5">CmCheckRegistryDebug</a>.Status = 0;
00155 
00156 
00157     <span class="comment">//</span>
00158     <span class="comment">// check the underlying hive and get storage use</span>
00159     <span class="comment">//</span>
00160     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = &amp;CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>;
00161 
00162     rc = <a class="code" href="../../d9/d0/hivechek_8c.html#a9">HvCheckHive</a>(Hive, &amp;Storage);
00163     <span class="keywordflow">if</span> (rc != 0) {
00164         <a class="code" href="../../d1/d0/cmchek_8c.html#a5">CmCheckRegistryDebug</a>.Status = rc;
00165         <span class="keywordflow">return</span> rc;
00166     }
00167 
00168     <span class="comment">//</span>
00169     <span class="comment">// Call recursive helper to check out the values and subkeys</span>
00170     <span class="comment">//</span>
00171     <a class="code" href="../../d1/d0/cmchek_8c.html#a14">CmpCheckHive</a> = (<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)CmHive;
00172     <a class="code" href="../../d1/d0/cmchek_8c.html#a15">CmpCheckClean</a> = Clean;
00173     rc = <a class="code" href="../../d1/d0/cmchek_8c.html#a16">CmpCheckRegistry2</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a>, HCELL_NIL);
00174 
00175     <span class="comment">//</span>
00176     <span class="comment">// Validate all the security descriptors in the hive</span>
00177     <span class="comment">//</span>
00178     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d3/cmwraper_8c.html#a21">CmpValidateHiveSecurityDescriptors</a>(Hive)) {
00179         KdPrint((<span class="stringliteral">"CmCheckRegistry:"</span>));
00180         KdPrint((<span class="stringliteral">" CmpValidateHiveSecurityDescriptors failed\n"</span>));
00181         rc = 3040;
00182         <a class="code" href="../../d1/d0/cmchek_8c.html#a5">CmCheckRegistryDebug</a>.Status = rc;
00183     }
00184 
00185 <span class="preprocessor">#if 0</span>
00186 <span class="preprocessor"></span>    <span class="comment">//</span>
00187     <span class="comment">// Check allocated storage against used storage</span>
00188     <span class="comment">//</span>
00189     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a1">CmpUsedStorage</a> != Storage) {
00190         KdPrint((<span class="stringliteral">"CmCheckRegistry:"</span>));
00191         KdPrint((<span class="stringliteral">" Storage Used:%08lx  Allocated:%08lx\n"</span>, UsedStorage, Storage));
00192         rc = 3042;
00193         <a class="code" href="../../d1/d0/cmchek_8c.html#a5">CmCheckRegistryDebug</a>.Status = rc;
00194     }
00195 <span class="preprocessor">#endif</span>
00196 <span class="preprocessor"></span>
00197     <span class="comment">//</span>
00198     <span class="comment">// Print a bit of a summary (make sure this data avail in all error cases)</span>
00199     <span class="comment">//</span>
00200     <span class="keywordflow">if</span> (rc &gt; 0) {
00201         KdPrint((<span class="stringliteral">"CmCheckRegistry Failed (%d): CmHive:%08lx\n"</span>, rc, CmHive));
00202         KdPrint((<span class="stringliteral">" Hive:%08lx Root:%08lx\n"</span>, Hive, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a>));
00203     }
00204 
00205     <span class="keywordflow">return</span> rc;
00206 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a224" doxytag="cmp.h::CmDeleteKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmDeleteKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>KeyBody</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/cmapi2_8c-source.html#l00031">31</a> of file <a class="el" href="../../d0/d9/cmapi2_8c-source.html">cmapi2.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00346">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00245">CML_WORKER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00537">CmpCleanUpSubKeyInfo()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01235">CmpFlushNotify()</a>, <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00140">CmpFreeKeyByCell()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00172">CmpMarkAllBinsReadOnly</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01260">CmpRemoveKeyControlBlock()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00114">CmpReportNotify()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00262">CMS_CM</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00272">_CM_KEY_CONTROL_BLOCK::Delete</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00437">KEY_NO_DELETE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00280">_CM_KEY_CONTROL_BLOCK::KeyCell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00279">_CM_KEY_CONTROL_BLOCK::KeyHive</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00295">_CM_KEY_CONTROL_BLOCK::KeyNode</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00285">_CM_KEY_CONTROL_BLOCK::ParentKcb</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a161">PCM_KEY_BODY</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00454">_CM_KEY_NODE::SubKeyCounts</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00411">NtDeleteKey()</a>.
<p>
<pre class="fragment"><div>00036                    :
00037 
00038     <a class="code" href="../../d9/d0/rtdelkey_8c.html#a5">Delete</a> a registry key, clean up Notify block.
00039 
00040 Arguments:
00041 
00042     KeyBody - pointer to key handle object
00043 
00044 Return Value:
00045 
00046     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00047 
00048 --*/
00049 {
00050     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00051     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>  ptarget;
00052     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>      <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00053     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
00054     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   KeyControlBlock;
00055 
00056     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_WORKER, CMS_CM) KdPrint(("CmDeleteKey\n"));
00057 
00058     CmpLockRegistryExclusive();
00059 
00060     <span class="comment">//</span>
00061     <span class="comment">// If already marked for deletion, storage is gone, so</span>
00062     <span class="comment">// do nothing and return success.</span>
00063     <span class="comment">//</span>
00064     KeyControlBlock = KeyBody-&gt;KeyControlBlock;
00065 
00066     if (KeyControlBlock-&gt;Delete == TRUE) {
00067         status = STATUS_SUCCESS;
00068         <span class="keywordflow">goto</span> Exit;
00069     }
00070 
00071     <span class="comment">// Mark the hive as read only</span>
00072     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a>);
00073 
00074     ptarget = KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o17">KeyNode</a>;
00075 
00076     <span class="keywordflow">if</span> ( ((ptarget-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] +
00077            ptarget-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>]) == 0) &amp;&amp;
00078          ((ptarget-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a30">KEY_NO_DELETE</a>) == 0))
00079     {
00080         <span class="comment">//</span>
00081         <span class="comment">// Cell is NOT marked NO_DELETE and does NOT have children</span>
00082         <span class="comment">// Send Notification while key still present, if delete fails,</span>
00083         <span class="comment">//   we'll have sent a spurious notify, that doesn't matter</span>
00084         <span class="comment">// Delete the actual storage</span>
00085         <span class="comment">//</span>
00086         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a>;
00087         <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o6">KeyCell</a>;
00088 
00089         <a class="code" href="../../d6/d3/cmwraper_8c.html#a13">CmpReportNotify</a>(
00090             KeyControlBlock,
00091             Hive,
00092             Cell,
00093             REG_NOTIFY_CHANGE_NAME
00094             );
00095 
00096         status = <a class="code" href="../../d3/d3/cmtredel_8c.html#a1">CmpFreeKeyByCell</a>(Hive, Cell, TRUE);
00097 
00098         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00099             <span class="comment">//</span>
00100             <span class="comment">// post any waiting notifies</span>
00101             <span class="comment">//</span>
00102 <span class="preprocessor">#ifdef KCB_TO_KEYBODY_LINK</span>
00103 <span class="preprocessor"></span>            CmpFlushNotifiesOnKeyBodyList(KeyControlBlock);
00104 <span class="preprocessor">#else</span>
00105 <span class="preprocessor"></span>            <a class="code" href="../../d1/d2/cmp_8h.html#a288">CmpFlushNotify</a>(KeyBody);
00106 <span class="preprocessor">#endif</span>
00107 <span class="preprocessor"></span>
00108             <span class="comment">//</span>
00109             <span class="comment">// Remove kcb out of cache, but do NOT</span>
00110             <span class="comment">// free its storage, CmDelete will do that when</span>
00111             <span class="comment">// the RefCount becomes zero.</span>
00112             <span class="comment">//</span>
00113             <span class="comment">// There are two things that can hold the RefCount non-zero.</span>
00114             <span class="comment">//</span>
00115             <span class="comment">// 1. open handles for this key</span>
00116             <span class="comment">// 2. Fake subKeys that are still in DelayClose.</span>
00117             <span class="comment">//</span>
00118             <span class="comment">// At this point, we have no way of deleting the fake subkeys from cache</span>
00119             <span class="comment">// unless we do a search for the whole cache, which is too expensive.</span>
00120             <span class="comment">// Thus, we decide to either let the fake keys age out of cache or when </span>
00121             <span class="comment">// someone is doing the lookup for the fake key, then we delete it at that point.</span>
00122             <span class="comment">// See routine CmpCacheLookup in cmparse.c for more details.</span>
00123             <span class="comment">//</span>
00124             <span class="comment">// If the parent has the subkey info or hint cached, free it.</span>
00125             <span class="comment">// Again, registry is locked exclusively, no need to lock KCB.</span>
00126             <span class="comment">//</span>
00127             <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
00128             <a class="code" href="../../d8/d2/cmsubs_8c.html#a15">CmpCleanUpSubKeyInfo</a>(KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o9">ParentKcb</a>);
00129             KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o0">Delete</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00130             <a class="code" href="../../d8/d2/cmsubs_8c.html#a24">CmpRemoveKeyControlBlock</a>(KeyControlBlock);
00131             KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o6">KeyCell</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00132             KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o17">KeyNode</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00133         }
00134 
00135     } <span class="keywordflow">else</span> {
00136 
00137         status = STATUS_CANNOT_DELETE;
00138 
00139     }
00140 
00141 Exit:
00142     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00143 
00144     <span class="comment">// Mark the hive as read only</span>
00145     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a>);
00146 
00147     <span class="keywordflow">return</span> status;
00148 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a225" doxytag="cmp.h::CmDeleteValueKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmDeleteValueKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyControlBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00092">92</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00346">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00245">CML_WORKER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00568">CmpCleanUpKcbValueCache()</a>, <a class="el" href="../../d5/d2/cmtree_8c-source.html#l00033">CmpFindNameInList()</a>, <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00053">CmpFreeValue()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00508">CmpIsHKeyValueSmall</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00172">CmpMarkAllBinsReadOnly</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00114">CmpReportNotify()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00262">CMS_CM</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00332">_CHILD_LIST::Count</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00498">_CM_KEY_VALUE::Data</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00497">_CM_KEY_VALUE::DataLength</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">HvMarkCellDirty()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l01295">HvReallocateCell()</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00541">_CELL_DATA::_u::KeyList</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00538">_CELL_DATA::_u::KeyValue</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00451">_CM_KEY_NODE::LastWriteTime</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00333">_CHILD_LIST::List</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00468">_CM_KEY_NODE::MaxValueDataLen</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00467">_CM_KEY_NODE::MaxValueNameLen</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d9/d0/cmdata_8h.html#a69">PCHILD_LIST</a>, <a class="el" href="../../d9/d0/cmdata_8h.html#a64">PCM_KEY_CONTROL_BLOCK</a>, <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00458">_CM_KEY_NODE::ValueList</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/edithive_8c-source.html#l00943">EhDeleteValueKey()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00504">NtDeleteValueKey()</a>.
<p>
<pre class="fragment"><div>00098                    :
00099 
00100     One of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value entries of a registry key may be removed with <span class="keyword">this</span> call.
00101 
00102     The value entry with <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a> <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> removed from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key.
00103     If no such entry exists, an error <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00104 
00105 Arguments:
00106 
00107     KeyControlBlock - pointer to <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> <span class="keywordflow">for</span> key to operate on
00108 
00109     <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> - The name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value to be deleted.  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a legal name.
00110 
00111 Return Value:
00112 
00113     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
00114 
00115         &lt;TBS&gt;
00116 
00117 --*/
00118 {
00119     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00120     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> pcell;
00121     <a class="code" href="../../d7/d9/struct__CHILD__LIST.html">PCHILD_LIST</a> plist;
00122     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> targetaddress;
00123     ULONG  targetindex;
00124     ULONG   newcount;
00125     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newcell;
00126     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ChildCell;
00127     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>      <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00128     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
00129     ULONG realsize;
00130     LARGE_INTEGER systemtime;
00131 
00132     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_WORKER, CMS_CM) KdPrint(("CmDeleteValueKey\n"));
00133 
00134     CmpLockRegistryExclusive();
00135 
00136     try {
00137         <span class="comment">//</span>
00138         <span class="comment">// no edits, not even this one, on keys marked for deletion</span>
00139         <span class="comment">//</span>
00140         <span class="keywordflow">if</span> (KeyControlBlock-&gt;Delete) {
00141             <span class="keywordflow">return</span> STATUS_KEY_DELETED;
00142         }
00143 
00144         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyControlBlock-&gt;KeyHive;
00145         <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = KeyControlBlock-&gt;KeyCell;
00146         pcell = KeyControlBlock-&gt;KeyNode;
00147 
00148         <span class="comment">// Mark the hive as read only</span>
00149         <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(Hive);
00150 
00151         status = STATUS_OBJECT_NAME_NOT_FOUND;
00152 
00153         plist = &amp;(pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>);
00154         ChildCell = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00155 
00156         <span class="keywordflow">if</span> (plist-&gt;<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> != 0) {
00157 
00158             <span class="comment">//</span>
00159             <span class="comment">// The parent has at least one value, map in the list of</span>
00160             <span class="comment">// values and call CmpFindChildInList</span>
00161             <span class="comment">//</span>
00162 
00163             <span class="comment">//</span>
00164             <span class="comment">// plist -&gt; the CHILD_LIST structure</span>
00165             <span class="comment">// pchild -&gt; the child node structure being examined</span>
00166             <span class="comment">//</span>
00167 
00168             ChildCell = <a class="code" href="../../d4/d3/cmtree_8c.html#a0">CmpFindNameInList</a>(Hive,
00169                                           plist,
00170                                           &amp;ValueName,
00171                                           &amp;targetaddress,
00172                                           &amp;targetindex);
00173 
00174             <span class="keywordflow">if</span> (ChildCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00175 
00176                 <span class="comment">//</span>
00177                 <span class="comment">// 1. the desired target was found</span>
00178                 <span class="comment">// 2. ChildCell is it's HCELL_INDEX</span>
00179                 <span class="comment">// 3. targetaddress points to it</span>
00180                 <span class="comment">// 4. targetindex is it's index</span>
00181                 <span class="comment">//</span>
00182 
00183                 <span class="comment">//</span>
00184                 <span class="comment">// attempt to mark all relevent cells dirty</span>
00185                 <span class="comment">//</span>
00186                 <span class="keywordflow">if</span> (!(<a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, Cell) &amp;&amp;
00187                       <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>) &amp;&amp;
00188                       <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, ChildCell)))
00189 
00190                 {
00191                     <span class="comment">// Mark the hive as read only</span>
00192                     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(Hive);
00193 
00194                     <span class="keywordflow">return</span> STATUS_NO_LOG_SPACE;
00195                 }
00196 
00197                 <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/cmdata_8h.html#a38">CmpIsHKeyValueSmall</a>(realsize,targetaddress-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o2">DataLength</a>)) {
00198 
00199                     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, targetaddress-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>)) {
00200 
00201                         <span class="comment">// Mark the hive as read only</span>
00202                         <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(Hive);
00203 
00204                         <span class="keywordflow">return</span>(STATUS_NO_LOG_SPACE);
00205                     }
00206                 }
00207 
00208                 newcount = plist-&gt;<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> - 1;
00209 
00210                 <span class="keywordflow">if</span> (newcount &gt; 0) {
00211                     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> pvector;
00212 
00213                     <span class="comment">//</span>
00214                     <span class="comment">// more than one entry list, squeeze</span>
00215                     <span class="comment">//</span>
00216                     pvector = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, plist-&gt;<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>);
00217                     <span class="keywordflow">for</span> ( ; targetindex &lt; newcount; targetindex++) {
00218                         pvector-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o4">KeyList</a>[ targetindex ] =
00219                             pvector-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o4">KeyList</a>[ targetindex+1 ];
00220                     }
00221 
00222                     newcell = <a class="code" href="../../d8/d0/hivecell_8c.html#a20">HvReallocateCell</a>(
00223                                 Hive,
00224                                 plist-&gt;<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>,
00225                                 newcount * <span class="keyword">sizeof</span>(HCELL_INDEX)
00226                                 );
00227                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(newcell != HCELL_NIL);
00228                     plist-&gt;<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a> = newcell;
00229 
00230                 } <span class="keywordflow">else</span> {
00231 
00232                     <span class="comment">//</span>
00233                     <span class="comment">// list is empty, free it</span>
00234                     <span class="comment">//</span>
00235                     <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, plist-&gt;<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>);
00236                 }
00237                 plist-&gt;<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> = newcount;
00238                 <a class="code" href="../../d9/d2/cmsubs2_8c.html#a3">CmpFreeValue</a>(Hive, ChildCell);
00239 
00240                 <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;systemtime);
00241                 pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o2">LastWriteTime</a> = systemtime;
00242 
00243                 <span class="keywordflow">if</span> (pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> == 0) {
00244                     pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o13">MaxValueNameLen</a> = 0;
00245                     pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o14">MaxValueDataLen</a> = 0;
00246                 }
00247 
00248                 <span class="comment">//</span>
00249                 <span class="comment">// We are changing the KCB cache. Since the registry is locked exclusively,</span>
00250                 <span class="comment">// we do not need a KCB lock.</span>
00251                 <span class="comment">//</span>
00252                 <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
00253 
00254                 <span class="comment">//</span>
00255                 <span class="comment">// Invalidate the cache</span>
00256                 <span class="comment">//</span>
00257                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a16">CmpCleanUpKcbValueCache</a>(KeyControlBlock);
00258 
00259                 KeyControlBlock-&gt;ValueCache.Count = plist-&gt;<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a>;
00260                 KeyControlBlock-&gt;ValueCache.ValueList = (ULONG_PTR) plist-&gt;<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>;
00261     
00262                 <a class="code" href="../../d6/d3/cmwraper_8c.html#a13">CmpReportNotify</a>(
00263                         KeyControlBlock,
00264                         KeyControlBlock-&gt;KeyHive,
00265                         KeyControlBlock-&gt;KeyCell,
00266                         REG_NOTIFY_CHANGE_LAST_SET
00267                         );
00268                 status = STATUS_SUCCESS;
00269             } <span class="keywordflow">else</span> {
00270                 status = STATUS_OBJECT_NAME_NOT_FOUND;
00271             }
00272         }
00273     } finally {
00274         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00275     }
00276 
00277     <span class="comment">// Mark the hive as read only</span>
00278     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(Hive);
00279 
00280     <span class="keywordflow">return</span> status;
00281 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a226" doxytag="cmp.h::CmEnumerateKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmEnumerateKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyControlBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Index</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KEY_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ResultLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00285">285</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00245">CML_WORKER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00771">CmpFindSubKeyByNumber()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00124">CmpLockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00172">CmpMarkAllBinsReadOnly</a>, <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00110">CmpQueryKeyData()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00262">CMS_CM</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, and <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/edithive_8c-source.html#l00320">EhEnumerateKey()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00610">NtEnumerateKey()</a>.
<p>
<pre class="fragment"><div>00295                    :
00296 
00297     Enumerate sub keys, <span class="keywordflow">return</span> data on <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>'th entry.
00298 
00299     <a class="code" href="../../d8/d9/cmapi_8c.html#a12">CmEnumerateKey</a> returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>'th sub key of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> open
00300     key specified.  The value STATUS_NO_MORE_ENTRIES will be
00301     returned <span class="keywordflow">if</span> value of <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> larger than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of sub keys.
00302 
00303     Note that <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> simply a way to select among child keys.  Two calls
00304     to <a class="code" href="../../d8/d9/cmapi_8c.html#a12">CmEnumerateKey</a> with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> are NOT guaranteed to <span class="keywordflow">return</span>
00305     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same results.
00306 
00307     If KeyInformation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not <span class="keywordtype">long</span> enough to hold all requested data,
00308     STATUS_BUFFER_OVERFLOW will be returned, and ResultLength will be
00309     set to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes actually required.
00310 
00311 Arguments:
00312 
00313     KeyControlBlock - pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> KCB that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key
00314 
00315     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> (0-based) number of the sub key to be returned.
00316 
00317     KeyInformationClass - Specifies the type of information returned in
00318         Buffer.  One of the following types:
00319 
00320         KeyBasicInformation - return last write time, title index, and name.
00321             (see KEY_BASIC_INFORMATION structure)
00322 
00323         KeyNodeInformation - return last write time, title index, name, class.
00324             (see KEY_NODE_INFORMATION structure)
00325 
00326     KeyInformation -Supplies pointer to buffer to receive the data.
00327 
00328     Length - Length of KeyInformation in bytes.
00329 
00330     ResultLength - Number of bytes actually written into KeyInformation.
00331 
00332 Return Value:
00333 
00334     NTSTATUS - Result code from call, among the following:
00335 
00336         &lt;TBS&gt;
00337 
00338 --*/
00339 {
00340     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00341     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> childcell;
00342     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00343     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
00344     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node;
00345 
00346     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_WORKER, CMS_CM) KdPrint(("CmEnumerateKey\n"));
00347 
00348 
00349     CmpLockRegistry();
00350 
00351     if (KeyControlBlock-&gt;Delete) {
00352         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00353         <span class="keywordflow">return</span> STATUS_KEY_DELETED;
00354     }
00355 
00356     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyControlBlock-&gt;KeyHive;
00357     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = KeyControlBlock-&gt;KeyCell;
00358 
00359     <span class="comment">// Mark the hive as read only</span>
00360     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(Hive);
00361 
00362     <span class="comment">//</span>
00363     <span class="comment">// fetch the child of interest</span>
00364     <span class="comment">//</span>
00365 
00366     childcell = <a class="code" href="../../d1/d2/cmp_8h.html#a304">CmpFindSubKeyByNumber</a>(Hive, KeyControlBlock-&gt;KeyNode, Index);
00367     <span class="keywordflow">if</span> (childcell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00368         <span class="comment">//</span>
00369         <span class="comment">// no such child, clean up and return error</span>
00370         <span class="comment">//</span>
00371 
00372         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00373 
00374         <span class="comment">// Mark the hive as read only</span>
00375         <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(Hive);
00376 
00377         <span class="keywordflow">return</span> STATUS_NO_MORE_ENTRIES;
00378     }
00379 
00380     Node = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,childcell);
00381 
00382     <span class="keywordflow">try</span> {
00383 
00384         <span class="comment">//</span>
00385         <span class="comment">// call a worker to perform data transfer</span>
00386         <span class="comment">//</span>
00387 
00388         status = <a class="code" href="../../d9/d2/cmsubs2_8c.html#a4">CmpQueryKeyData</a>(Hive,
00389                                  Node,
00390                                  KeyInformationClass,
00391                                  KeyInformation,
00392                                  Length,
00393                                  ResultLength);
00394 
00395      } except (EXCEPTION_EXECUTE_HANDLER) {
00396         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00397         status = GetExceptionCode();
00398 
00399         <span class="comment">// Mark the hive as read only</span>
00400         <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(Hive);
00401 
00402         <span class="keywordflow">return</span> status;
00403     }
00404 
00405     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00406 
00407     <span class="comment">// Mark the hive as read only</span>
00408     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(Hive);
00409 
00410     <span class="keywordflow">return</span> status;
00411 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a227" doxytag="cmp.h::CmEnumerateValueKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmEnumerateValueKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyControlBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Index</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KEY_VALUE_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyValueInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyValueInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ResultLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00416">416</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
References <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00256">CM_KCB_SYM_LINK_FOUND</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00245">CML_WORKER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00609">CMP_GET_CACHED_ADDRESS</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01184">CmpDereferenceKeyControlBlockWithLock()</a>, <a class="el" href="../../d5/d2/cmtree_8c-source.html#l00200">CmpGetValueKeyFromCache()</a>, <a class="el" href="../../d5/d2/cmtree_8c-source.html#l00115">CmpGetValueListFromCache()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00124">CmpLockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00144">CmpMakeValueCacheReadOnly</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00145">CmpMakeValueCacheReadWrite</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00172">CmpMarkAllBinsReadOnly</a>, <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00531">CmpQueryKeyValueData()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00262">CMS_CM</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00230">LOCK_KCB_TREE</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d9/d0/cmdata_8h.html#a81">PCM_KEY_VALUE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00604">PPCM_CACHED_VALUE</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00231">UNLOCK_KCB_TREE</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/edithive_8c-source.html#l00396">EhEnumerateValueKey()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00756">NtEnumerateValueKey()</a>.
<p>
<pre class="fragment"><div>00426                    :
00427 
00428     The value entries of an open key may be enumerated.
00429 
00430     <a class="code" href="../../d8/d9/cmapi_8c.html#a13">CmEnumerateValueKey</a> returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>'th value
00431     entry of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> open key specified by KeyHandle.  The value
00432     STATUS_NO_MORE_ENTRIES will be returned <span class="keywordflow">if</span> value of <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00433     larger than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of sub keys.
00434 
00435     Note that <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> simply a way to select among value
00436     entries.  Two calls to <a class="code" href="../../d7/d7/ntapi_8c.html#a18">NtEnumerateValueKey</a> with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>
00437     are NOT guaranteed to <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same results.
00438 
00439     If KeyValueInformation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not <span class="keywordtype">long</span> enough to hold all requested data,
00440     STATUS_BUFFER_OVERFLOW will be returned, and ResultLength will be
00441     set to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes actually required.
00442 
00443 Arguments:
00444 
00445     KeyControlBlock - pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> KCB that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key
00446 
00447     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> (0-based) number of the sub key to be returned.
00448 
00449     KeyValueInformationClass - Specifies the type of information returned
00450     in Buffer. One of the following types:
00451 
00452         KeyValueBasicInformation - return time of last write,
00453             title index, and name.  (See KEY_VALUE_BASIC_INFORMATION)
00454 
00455         KeyValueFullInformation - return time of last write,
00456             title index, name, class.  (See KEY_VALUE_FULL_INFORMATION)
00457 
00458     KeyValueInformation -Supplies pointer to buffer to receive the data.
00459 
00460     Length - Length of KeyValueInformation in bytes.
00461 
00462     ResultLength - Number of bytes actually written into KeyValueInformation.
00463 
00464 Return Value:
00465 
00466     NTSTATUS - Result code from call, among the following:
00467 
00468         &lt;TBS&gt;
00469 
00470 --*/
00471 {
00472     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00473     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00474     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node;
00475     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> ChildList;
00476     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> ValueData;
00477     BOOLEAN    IndexCached;
00478     BOOLEAN    ValueCached;
00479     <a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PPCM_CACHED_VALUE</a> ContainingList;
00480 
00481     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_WORKER, CMS_CM) KdPrint(("CmEnumerateValueKey\n"));
00482 
00483 
00484     <span class="comment">//</span>
00485     <span class="comment">// lock the parent cell</span>
00486     <span class="comment">//</span>
00487 
00488     CmpLockRegistry();
00489 
00490     if (KeyControlBlock-&gt;Delete) {
00491         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00492         <span class="keywordflow">return</span> STATUS_KEY_DELETED;
00493     }
00494     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyControlBlock-&gt;KeyHive;
00495     Node = KeyControlBlock-&gt;KeyNode;
00496 
00497     <span class="comment">//</span>
00498     <span class="comment">// fetch the child of interest</span>
00499     <span class="comment">//</span>
00500     <span class="comment">//</span>
00501     <span class="comment">// Do it using the cache</span>
00502     <span class="comment">//</span>
00503     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt;= KeyControlBlock-&gt;ValueCache.Count) {
00504         <span class="comment">//</span>
00505         <span class="comment">// No such child, clean up and return error.</span>
00506         <span class="comment">//</span>
00507         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00508         <span class="keywordflow">return</span>(STATUS_NO_MORE_ENTRIES);
00509     }
00510 
00511     <span class="comment">// Mark the hive as read only</span>
00512     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(Hive);
00513 
00514     <a class="code" href="../../d1/d2/cmp_8h.html#a16">LOCK_KCB_TREE</a>();
00515     <span class="keywordflow">if</span> (KeyControlBlock-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a12">CM_KCB_SYM_LINK_FOUND</a>) {
00516         <span class="comment">//</span>
00517         <span class="comment">// The value list is now set to the KCB for symbolic link,</span>
00518         <span class="comment">// Clean it up and set the value right before we do the query.</span>
00519         <span class="comment">//</span>
00520         <a class="code" href="../../d8/d2/cmsubs_8c.html#a23">CmpDereferenceKeyControlBlockWithLock</a>(KeyControlBlock-&gt;ValueCache.RealKcb);
00521         KeyControlBlock-&gt;ExtFlags &amp;= ~<a class="code" href="../../d9/d0/cmdata_8h.html#a12">CM_KCB_SYM_LINK_FOUND</a>;
00522 
00523         KeyControlBlock-&gt;ValueCache.Count = KeyControlBlock-&gt;KeyNode-&gt;ValueList.Count;
00524         KeyControlBlock-&gt;ValueCache.ValueList = (ULONG_PTR) KeyControlBlock-&gt;KeyNode-&gt;ValueList.List;
00525     }
00526 
00527     ChildList = <a class="code" href="../../d4/d3/cmtree_8c.html#a1">CmpGetValueListFromCache</a>(Hive, &amp;(KeyControlBlock-&gt;ValueCache), &amp;IndexCached);
00528     ValueData = <a class="code" href="../../d4/d3/cmtree_8c.html#a2">CmpGetValueKeyFromCache</a>(Hive, ChildList, Index, &amp;ContainingList, IndexCached, &amp;ValueCached);    
00529 
00530     <span class="keywordflow">try</span> {
00531 
00532         <span class="comment">// Trying to catch the BAD guy who writes over our pool.</span>
00533         <a class="code" href="../../d1/d2/cmp_8h.html#a10">CmpMakeValueCacheReadWrite</a>(ValueCached,<a class="code" href="../../d9/d0/cmdata_8h.html#a46">CMP_GET_CACHED_ADDRESS</a>(KeyControlBlock-&gt;ValueCache.ValueList));
00534 
00535         <span class="comment">//</span>
00536         <span class="comment">// call a worker to perform data transfer</span>
00537         <span class="comment">//</span>
00538         status = <a class="code" href="../../d9/d2/cmsubs2_8c.html#a5">CmpQueryKeyValueData</a>(Hive,
00539                                   ContainingList,
00540                                   ValueData,
00541                                   ValueCached,
00542                                   KeyValueInformationClass,
00543                                   KeyValueInformation,
00544                                   Length,
00545                                   ResultLength);
00546 
00547          <span class="comment">// Trying to catch the BAD guy who writes over our pool.</span>
00548         <a class="code" href="../../d1/d2/cmp_8h.html#a9">CmpMakeValueCacheReadOnly</a>(ValueCached,<a class="code" href="../../d9/d0/cmdata_8h.html#a46">CMP_GET_CACHED_ADDRESS</a>(KeyControlBlock-&gt;ValueCache.ValueList));
00549     } finally {
00550 
00551         <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
00552         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00553     }
00554 
00555     <span class="comment">// Mark the hive as read only</span>
00556     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(Hive);
00557 
00558     <span class="keywordflow">return</span> status;
00559 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a228" doxytag="cmp.h::CmFlushKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmFlushKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00564">564</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
References <a class="el" href="../../d1/d2/cmp_8h.html#a178">CMHIVE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00245">CML_WORKER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00660">CmLockHive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02195">CmpDoFlushAll()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00172">CmpMarkAllBinsReadOnly</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00036">CmpMasterHive</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00025">CmpNoWrite</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00262">CMS_CM</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00275">CMS_IO_ERROR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00662">CmUnlockHive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00308">DCmCheckRegistry</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00647">HvSyncHive()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d1/d2/cmp_8h.html#a179">PCMHIVE</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>, and <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00323">CmpWorkerCommand()</a>.
<p>
<pre class="fragment"><div>00570                    :
00571 
00572     Forces changes <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to a key to disk.
00573 
00574     <a class="code" href="../../d8/d9/cmapi_8c.html#a14">CmFlushKey</a> will not <span class="keywordflow">return</span> to its caller until any changed data
00575     associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key has been written <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>.
00576 
00577     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>: <a class="code" href="../../d8/d9/cmapi_8c.html#a14">CmFlushKey</a> will flush <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entire registry tree, and thus will
00578     burn cycles and I/O.
00579 
00580 Arguments:
00581 
00582     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive
00583 
00584     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - supplies index of node to whose sub keys are to be found
00585 
00586 Return Value:
00587 
00588     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
00589 
00590         &lt;TBS&gt;
00591 
00592 --*/
00593 {
00594     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive;
00595     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status = STATUS_SUCCESS;
00596     <span class="keyword">extern</span> <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>;
00597 
00598     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_WORKER, CMS_CM) KdPrint(("CmFlushKey\n"));
00599 
00600     <span class="comment">//</span>
00601     <span class="comment">// If writes are not working, lie and say we succeeded, will</span>
00602     <span class="comment">// clean up in a short time.  Only early system init code</span>
00603     <span class="comment">// will ever know the difference.</span>
00604     <span class="comment">//</span>
00605     if (CmpNoWrite) {
00606         <span class="keywordflow">return</span> STATUS_SUCCESS;
00607     }
00608 
00609 
00610     <span class="comment">// Mark the hive as read only</span>
00611     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(Hive);
00612 
00613     CmHive = CONTAINING_RECORD(Hive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive);
00614 
00615     <span class="comment">//</span>
00616     <span class="comment">// Don't flush the master hive.  If somebody asks for a flushkey on</span>
00617     <span class="comment">// the master hive, do a CmpDoFlushAll instead.  CmpDoFlushAll flushes</span>
00618     <span class="comment">// every hive except the master hive, which is what they REALLY want.</span>
00619     <span class="comment">//</span>
00620     <span class="keywordflow">if</span> (CmHive == <a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>) {
00621         <a class="code" href="../../d1/d2/cmp_8h.html#a243">CmpDoFlushAll</a>();
00622     } <span class="keywordflow">else</span> {
00623         <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>(CONTAINING_RECORD(Hive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive));
00624 
00625         <a class="code" href="../../d1/d2/cmp_8h.html#a94">CmLockHive</a> (CmHive);
00626 
00627         <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a13">HvSyncHive</a>(Hive)) {
00628 
00629             status = STATUS_REGISTRY_IO_FAILED;
00630 
00631             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_IO_ERROR) {
00632                 KdPrint((<span class="stringliteral">"CmFlushKey: HvSyncHive failed\n"</span>));
00633             }
00634         }
00635 
00636         <a class="code" href="../../d1/d2/cmp_8h.html#a95">CmUnlockHive</a> (CmHive);
00637     }
00638 
00639     <span class="comment">// Mark the hive as read only</span>
00640     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(Hive);
00641 
00642     <span class="keywordflow">return</span>  status;
00643 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a240" doxytag="cmp.h::CmLoadKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmLoadKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceFile</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01901">1901</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00748">_REGISTRY_COMMAND::Allocate</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00745">_REGISTRY_COMMAND::CmHive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00496">CmpLinkHiveToMaster()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00029">CmpProfileLoaded</a>, <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00354">CmpSetGlobalQuotaAllowed()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00030">CmpWasSetupBoot</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00738">_REGISTRY_COMMAND::Command</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00744">_REGISTRY_COMMAND::FileAttributes</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00649">_CMHIVE::Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00204">HIVE_NOLAZYFLUSH</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00622">_HHIVE::HiveFlags</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00754">_REGISTRY_COMMAND::ImpersonationContext</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00726">REG_CMD_ADD_HIVE_LIST</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00723">REG_CMD_HIVE_CLOSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00722">REG_CMD_HIVE_OPEN</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a180">REGISTRY_COMMAND</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00750">_REGISTRY_COMMAND::RegistryLockAquired</a>, <a class="el" href="../../d5/d4/seclient_8c-source.html#l00209">SeCreateClientSecurity()</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a60">SECURITY_CLIENT_CONTEXT</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00612">SeDeleteClientSecurity</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00743">_REGISTRY_COMMAND::Status</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02881">NtLoadKey2()</a>.
<p>
<pre class="fragment"><div>01909                    :
01910 
01911     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> hive (file in the format created by NtSaveKey) may be linked
01912     into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> active registry with <span class="keyword">this</span> call.  UNLIKE <a class="code" href="../../d7/d7/ntapi_8c.html#a26">NtRestoreKey</a>,
01913     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> specified to <a class="code" href="../../d7/d7/ntapi_8c.html#a30">NtLoadKey</a> will become <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual backing
01914     store of part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry (that is, it will NOT be copied.)
01915 
01916     The file may have an associated .log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
01917 
01918     If the hive file is marked as needing a .log file, and one is
01919     not present, the call will fail.
01920 
01921     The name specified by SourceFile must be such that <span class="stringliteral">".log"</span> can
01922     be appended to it to generate the name of the log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  Thus,
01923     on FAT file systems, the hive file may not have an <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>.
01924 
01925     This call is used by logon to make the user's profile available
01926     in the registry.  It is not intended <span class="keywordflow">for</span> use doing backup,
01927     restore, etc.  Use NtRestoreKey <span class="keywordflow">for</span> that.
01928 
01929     N.B.  This routine assumes that the object attributes <span class="keywordflow">for</span> the file
01930           to be opened have been captured into kernel space so that
01931           they can safely be passed to the worker thread to open the file
01932           and <span class="keywordflow">do</span> the actual I/O.
01933 
01934 Arguments:
01935 
01936     TargetKey - specifies the path to a key to link the hive to.
01937                 path must be of the form <span class="stringliteral">"\registry\user&lt;username&gt;"</span>
01938 
01939     SourceFile - specifies a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  <span class="keywordflow">while</span> file could be remote,
01940                 that is strongly discouraged.
01941 
01942     Flags - specifies any flags that should be used <span class="keywordflow">for</span> the load operation.
01943             The only valid flag is REG_NO_LAZY_FLUSH.
01944 
01945 Return Value:
01946 
01947     NTSTATUS - values TBS.
01948 
01949 --*/
01950 {
01951     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> NewHive;
01952     NTSTATUS Status;
01953     BOOLEAN Allocate;
01954     <a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html">REGISTRY_COMMAND</a> Command;
01955     SECURITY_QUALITY_OF_SERVICE ServiceQos;
01956     <a class="code" href="../../d8/d0/struct__SECURITY__CLIENT__CONTEXT.html">SECURITY_CLIENT_CONTEXT</a> ClientSecurityContext;
01957 
01958 
01959     <span class="comment">//</span>
01960     <span class="comment">// Obtain the security context here so we can use it</span>
01961     <span class="comment">// later to impersonate the user, which we will do</span>
01962     <span class="comment">// if we cannot access the file as SYSTEM.  This</span>
01963     <span class="comment">// usually occurs if the file is on a remote machine.</span>
01964     <span class="comment">//</span>
01965     ServiceQos.Length = <span class="keyword">sizeof</span>(SECURITY_QUALITY_OF_SERVICE);
01966     ServiceQos.ImpersonationLevel = SecurityImpersonation;
01967     ServiceQos.ContextTrackingMode = SECURITY_DYNAMIC_TRACKING;
01968     ServiceQos.EffectiveOnly = TRUE;
01969     Status = <a class="code" href="../../d0/d5/se_8h.html#a169">SeCreateClientSecurity</a>(CONTAINING_RECORD(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>(),<a class="code" href="../../d5/d6/struct__ETHREAD.html">ETHREAD</a>,Tcb),
01970                                     &amp;ServiceQos,
01971                                     FALSE,
01972                                     &amp;ClientSecurityContext);
01973     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01974         <span class="keywordflow">return</span>(Status);
01975     }
01976 
01977     <span class="comment">//</span>
01978     <span class="comment">// Do not lock the registry; Instead set the RegistryLockAquired member </span>
01979     <span class="comment">// of REGISTRY_COMMAND so CmpWorker can lock it after opening the hive files</span>
01980     <span class="comment">//</span>
01981     <span class="comment">//CmpLockRegistryExclusive();</span>
01982     <span class="comment">//</span>
01983 
01984     Command.RegistryLockAquired = FALSE;
01985     Command.Command = REG_CMD_HIVE_OPEN;
01986     Command.Allocate = TRUE;
01987     Command.FileAttributes = SourceFile;
01988     Command.ImpersonationContext = &amp;ClientSecurityContext;
01989 
01990     <a class="code" href="../../d1/d2/cmp_8h.html#a292">CmpWorker</a>(&amp;Command);
01991     Status = Command.Status;
01992 
01993     <a class="code" href="../../d0/d5/se_8h.html#a12">SeDeleteClientSecurity</a>( &amp;ClientSecurityContext );
01994 
01995     NewHive = Command.CmHive;
01996     Allocate = Command.Allocate;
01997 
01998     if (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01999         <span class="keywordflow">if</span>( Command.RegistryLockAquired ) {
02000             <span class="comment">// if CmpWorker has locked the registry, unlock it now.</span>
02001             <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02002         }
02003         <span class="keywordflow">return</span>(Status);
02004     } <span class="keywordflow">else</span> {
02005         <span class="comment">//</span>
02006         <span class="comment">// if we got here, CmpWorker should have locked the registry exclusive.</span>
02007         <span class="comment">//</span>
02008         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Command.RegistryLockAquired );
02009     }
02010 
02011     <span class="comment">//</span>
02012     <span class="comment">// if this is a NO_LAZY_FLUSH hive, set the appropriate bit.</span>
02013     <span class="comment">//</span>
02014     <span class="keywordflow">if</span> (Flags &amp; REG_NO_LAZY_FLUSH) {
02015         NewHive-&gt;Hive.HiveFlags |= <a class="code" href="../../d6/d0/hive_8h.html#a10">HIVE_NOLAZYFLUSH</a>;
02016     }
02017 
02018     <span class="comment">//</span>
02019     <span class="comment">// We now have a succesfully loaded and initialized CmHive, so we</span>
02020     <span class="comment">// just need to link that into the appropriate spot in the master hive.</span>
02021     <span class="comment">//</span>
02022     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/cmwraper_8c.html#a28">CmpLinkHiveToMaster</a>(TargetKey-&gt;ObjectName,
02023                                  TargetKey-&gt;RootDirectory,
02024                                  NewHive,
02025                                  Allocate,
02026                                  TargetKey-&gt;SecurityDescriptor);
02027 
02028     Command.CmHive = NewHive;
02029     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02030         <span class="comment">//</span>
02031         <span class="comment">// add new hive to hivelist</span>
02032         <span class="comment">//</span>
02033         Command.Command = <a class="code" href="../../d1/d2/cmp_8h.html#a108">REG_CMD_ADD_HIVE_LIST</a>;
02034 
02035     } <span class="keywordflow">else</span> {
02036         <span class="comment">//</span>
02037         <span class="comment">// Close the files we've opened.</span>
02038         <span class="comment">//</span>
02039         Command.Command = <a class="code" href="../../d1/d2/cmp_8h.html#a105">REG_CMD_HIVE_CLOSE</a>;
02040     }
02041     <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
02042 
02043     <span class="comment">//</span>
02044     <span class="comment">// We've given user chance to log on, so turn on quota</span>
02045     <span class="comment">//</span>
02046     <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d9/cmapi_8c.html#a2">CmpProfileLoaded</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
02047         (<a class="code" href="../../d8/d9/cmapi_8c.html#a3">CmpWasSetupBoot</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
02048         <a class="code" href="../../d8/d9/cmapi_8c.html#a2">CmpProfileLoaded</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02049         <a class="code" href="../../d1/d2/cmp_8h.html#a249">CmpSetGlobalQuotaAllowed</a>();
02050     }
02051 
02052     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02053     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02054 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a315" doxytag="cmp.h::CmpAddAcpiAliasEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpAddAcpiAliasEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>IDConfigDB</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html">PPROFILE_ACPI_DOCKING_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NewDockState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ProfileNumber</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>nameBuffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>valueBuffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>valueBufferLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>PreventDuplication</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00544">544</a> of file <a class="el" href="../../d7/d1/hwprofil_8c-source.html">hwprofil.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l01573">CM_HARDWARE_PROFILE_STR_ACPI_ALIAS</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01583">CM_HARDWARE_PROFILE_STR_ACPI_SERIAL_NUMBER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01579">CM_HARDWARE_PROFILE_STR_DOCKING_STATE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01584">CM_HARDWARE_PROFILE_STR_PROFILE_NUMBER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00242">CML_BUGCHECK</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00256">CMS_INIT</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02786">CmpCreateControlSet()</a>, and <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00805">CmSetAcpiHwProfile()</a>.
<p>
<pre class="fragment"><div>00554                    :
00555     Set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acpi Alais entry.
00556 
00557 
00558     Routine <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>:
00559     <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> an alias entry in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IDConfigDB database <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given
00560     hardware profile.
00561 
00562     <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="stringliteral">"AcpiAlias"</span> key <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> does not exist.
00563 
00564 Parameters:
00565 
00566     IDConfigDB - Pointer to <span class="stringliteral">"..\CurrentControlSet\Control\IDConfigDB"</span>
00567 
00568     NewDockState - The <span class="keyword">new</span> docking state <span class="keywordflow">for</span> which <span class="keyword">this</span> alias points.
00569 
00570     ProfileNumber -The profile number to which <span class="keyword">this</span> alias points.
00571 
00572     nameBuffer - a temp scratch space <span class="keywordflow">for</span> writing things.
00573                 (assumed to be at least 128 WCHARS)
00574 
00575 --*/
00576 {
00577     OBJECT_ATTRIBUTES attributes;
00578     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        status = STATUS_SUCCESS;
00579     ANSI_STRING     ansiString;
00580     UNICODE_STRING  name;
00581     HANDLE          aliasKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00582     HANDLE          aliasEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00583     ULONG           value;
00584     ULONG           disposition;
00585     ULONG           aliasNumber = 0;
00586     ULONG           len;
00587     PKEY_VALUE_FULL_INFORMATION   keyInfo;
00588 
00589     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
00590 
00591     keyInfo = (PKEY_VALUE_FULL_INFORMATION) valueBuffer;
00592 
00593     <span class="comment">//</span>
00594     <span class="comment">// Find the Alias Key or Create it if it does not already exist.</span>
00595     <span class="comment">//</span>
00596     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name,CM_HARDWARE_PROFILE_STR_ACPI_ALIAS);
00597 
00598     InitializeObjectAttributes (&amp;attributes,
00599                                 &amp;name,
00600                                 OBJ_CASE_INSENSITIVE,
00601                                 IDConfigDB,
00602                                 NULL);
00603 
00604     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a> (&amp;aliasKey,
00605                         KEY_READ | KEY_WRITE,
00606                         &amp;attributes);
00607 
00608     <span class="keywordflow">if</span> (STATUS_OBJECT_NAME_NOT_FOUND == status) {
00609         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a> (&amp;aliasKey,
00610                               KEY_READ | KEY_WRITE,
00611                               &amp;attributes,
00612                               0, <span class="comment">// no title</span>
00613                               NULL, <span class="comment">// no class</span>
00614                               0, <span class="comment">// no options</span>
00615                               &amp;disposition);
00616     }
00617 
00618     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00619         aliasKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00620         <span class="keywordflow">goto</span> Exit;
00621     }
00622 
00623     <span class="comment">//</span>
00624     <span class="comment">// Create an entry key</span>
00625     <span class="comment">//</span>
00626 
00627     <span class="keywordflow">while</span> (aliasNumber &lt; 200) {
00628         aliasNumber++;
00629 
00630         swprintf (nameBuffer, L<span class="stringliteral">"%04d"</span>, aliasNumber);
00631         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, nameBuffer);
00632 
00633         InitializeObjectAttributes(&amp;attributes,
00634                                    &amp;name,
00635                                    OBJ_CASE_INSENSITIVE,
00636                                    aliasKey,
00637                                    NULL);
00638 
00639         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a> (&amp;aliasEntry,
00640                             KEY_READ | KEY_WRITE,
00641                             &amp;attributes);
00642 
00643         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00644 
00645             <span class="keywordflow">if</span> (PreventDuplication) {
00646                 <span class="comment">//</span>
00647                 <span class="comment">// If we have a matching DockingState, SerialNumber, and</span>
00648                 <span class="comment">// Profile Number, then we should not make this alias</span>
00649                 <span class="comment">//</span>
00650 
00651                 <span class="comment">//</span>
00652                 <span class="comment">// Extract The DockingState to which this alias refers.</span>
00653                 <span class="comment">//</span>
00654                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, CM_HARDWARE_PROFILE_STR_DOCKING_STATE);
00655                 status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(aliasEntry,
00656                                          &amp;name,
00657                                          KeyValueFullInformation,
00658                                          valueBuffer,
00659                                          valueBufferLength,
00660                                          &amp;len);
00661 
00662                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status) || (keyInfo-&gt;Type != REG_DWORD)) {
00663                     status = STATUS_REGISTRY_CORRUPT;
00664                     <span class="keywordflow">goto</span> Exit;
00665                 }
00666 
00667                 <span class="keywordflow">if</span> (NewDockState-&gt;DockingState !=
00668                     * (PULONG) ((PUCHAR) keyInfo + keyInfo-&gt;DataOffset)) {
00669                     <span class="comment">//</span>
00670                     <span class="comment">// Not a dupe</span>
00671                     <span class="comment">//</span>
00672 
00673                     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (aliasEntry);
00674                     aliasEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00675                     <span class="keywordflow">continue</span>;
00676                 }
00677 
00678                 <span class="comment">//</span>
00679                 <span class="comment">// Extract the SerialNumber</span>
00680                 <span class="comment">//</span>
00681                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, CM_HARDWARE_PROFILE_STR_ACPI_SERIAL_NUMBER);
00682                 status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(aliasEntry,
00683                                          &amp;name,
00684                                          KeyValueFullInformation,
00685                                          valueBuffer,
00686                                          valueBufferLength,
00687                                          &amp;len);
00688 
00689                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status) || (keyInfo-&gt;Type != REG_BINARY)) {
00690                     status = STATUS_REGISTRY_CORRUPT;
00691                     <span class="keywordflow">goto</span> Exit;
00692                 }
00693 
00694                 <span class="keywordflow">if</span> (NewDockState-&gt;SerialLength != keyInfo-&gt;DataLength) {
00695                     <span class="comment">//</span>
00696                     <span class="comment">// Not a dupe</span>
00697                     <span class="comment">//</span>
00698 
00699                     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (aliasEntry);
00700                     aliasEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00701                     <span class="keywordflow">continue</span>;
00702                 }
00703 
00704                 <span class="keywordflow">if</span> (!RtlEqualMemory (NewDockState-&gt;SerialNumber,
00705                                      ((PUCHAR) keyInfo + keyInfo-&gt;DataOffset),
00706                                      NewDockState-&gt;SerialLength)) {
00707                     <span class="comment">//</span>
00708                     <span class="comment">// Not a dupe</span>
00709                     <span class="comment">//</span>
00710 
00711                     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (aliasEntry);
00712                     aliasEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00713                     <span class="keywordflow">continue</span>;
00714                 }
00715 
00716                 status = STATUS_SUCCESS;
00717                 <span class="keywordflow">goto</span> Exit;
00718 
00719             }
00720 
00721         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (STATUS_OBJECT_NAME_NOT_FOUND == status) {
00722             status = STATUS_SUCCESS;
00723             <span class="keywordflow">break</span>;
00724 
00725         } <span class="keywordflow">else</span> {
00726             <span class="keywordflow">break</span>;
00727         }
00728 
00729     }
00730     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00731         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT) {
00732             KdPrint((<span class="stringliteral">"CM: cmpCreateAcpiAliasEntry error finding new set %08lx\n"</span>,
00733                      status));
00734         }
00735         aliasEntry = 0;
00736         <span class="keywordflow">goto</span> Exit;
00737     }
00738 
00739     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a> (&amp;aliasEntry,
00740                           KEY_READ | KEY_WRITE,
00741                           &amp;attributes,
00742                           0,
00743                           NULL,
00744                           0,
00745                           &amp;disposition);
00746 
00747     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00748         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT) {
00749             KdPrint((<span class="stringliteral">"CM: cmpCreateAcpiAliasEntry error creating new set %08lx\n"</span>,
00750                      status));
00751         }
00752         aliasEntry = 0;
00753         <span class="keywordflow">goto</span> Exit;
00754     }
00755 
00756     <span class="comment">//</span>
00757     <span class="comment">// Write the Docking State;</span>
00758     <span class="comment">//</span>
00759     value = NewDockState-&gt;DockingState;
00760     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, CM_HARDWARE_PROFILE_STR_DOCKING_STATE);
00761     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (aliasEntry,
00762                             &amp;name,
00763                             0,
00764                             REG_DWORD,
00765                             &amp;value,
00766                             <span class="keyword">sizeof</span> (value));
00767 
00768     <span class="comment">//</span>
00769     <span class="comment">// Write the Serial Number</span>
00770     <span class="comment">//</span>
00771     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, CM_HARDWARE_PROFILE_STR_ACPI_SERIAL_NUMBER);
00772     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (aliasEntry,
00773                             &amp;name,
00774                             0,
00775                             REG_BINARY,
00776                             NewDockState-&gt;SerialNumber,
00777                             NewDockState-&gt;SerialLength);
00778 
00779     <span class="comment">//</span>
00780     <span class="comment">// Write the Profile Number</span>
00781     <span class="comment">//</span>
00782     value = ProfileNumber;
00783     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, CM_HARDWARE_PROFILE_STR_PROFILE_NUMBER);
00784     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (aliasEntry,
00785                             &amp;name,
00786                             0,
00787                             REG_DWORD,
00788                             &amp;value,
00789                             <span class="keyword">sizeof</span> (value));
00790 
00791 Exit:
00792 
00793     <span class="keywordflow">if</span> (aliasKey) {
00794         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (aliasKey);
00795     }
00796 
00797     <span class="keywordflow">if</span> (aliasEntry) {
00798         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (aliasEntry);
00799     }
00800 
00801     <span class="keywordflow">return</span> status;
00802 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a305" doxytag="cmp.h::CmpAddSubKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpAddSubKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Parent</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Child</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00895">895</a> of file <a class="el" href="../../d8/d0/cmindex_8c-source.html">cmindex.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00597">_HHIVE::Allocate</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00376">_CM_INDEX::Cell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00373">CM_KEY_FAST_LEAF</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00372">CM_KEY_INDEX_LEAF</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00371">CM_KEY_INDEX_ROOT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00408">CM_MAX_FAST_INDEX</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00396">CM_MAX_INDEX</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01087">CmpAddToLeaf()</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00121">CmpCompressedNameSize()</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00151">CmpCopyCompressedName()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01257">CmpSelectLeaf()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00268">CMS_INDEX</a>, <a class="el" href="../../d2/d9/tdisp_8c-source.html#l00009">ErrorExit()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00598">_HHIVE::Free</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00386">HvAllocateCell()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00440">KEY_COMP_NAME</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00383">_CM_KEY_FAST_INDEX::List</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00477">_CM_KEY_NODE::Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00475">_CM_KEY_NODE::NameLength</a>, <a class="el" href="../../d0/d2/rtreplac_8c-source.html#l00045">NewName</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00107">PHCELL_INDEX</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00454">_CM_KEY_NODE::SubKeyCounts</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00457">_CM_KEY_NODE::SubKeyLists</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00369">UseFastIndex</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00251">CmpCopySyncTree2()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01252">CmpCreateLinkNode()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00033">CmpDoCreate()</a>, and <a class="el" href="../../d0/d4/edithive_8c-source.html#l00625">EhCreateChild()</a>.
<p>
<pre class="fragment"><div>00902                    :
00903 
00904     Add a <span class="keyword">new</span> child subkey to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkey index <span class="keywordflow">for</span> a cell.  The
00905     child MUST NOT already be present (bugcheck <span class="keywordflow">if</span> so.)
00906 
00907     NOTE:   We expect Parent to already be marked dirty.
00908             We will mark stuff in Index dirty
00909 
00910 Arguments:
00911 
00912     Hive - pointer to hive control structure <span class="keywordflow">for</span> hive of interest
00913 
00914     Parent - cell of key that will be parent of <span class="keyword">new</span> key
00915 
00916     Child - <span class="keyword">new</span> key to put in Paren't sub key list
00917 
00918 Return Value:
00919 
00920     TRUE - it worked
00921 
00922     FALSE - resource problem
00923 
00924 --*/
00925 {
00926     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>    pcell;
00927     HCELL_INDEX     WorkCell;
00928     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   Index;
00929     <a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a> FastIndex;
00930     UNICODE_STRING  NewName;
00931     HCELL_INDEX     LeafCell;
00932     PHCELL_INDEX    RootPointer = NULL;
00933     ULONG           cleanup = 0;
00934     ULONG           Type;
00935     BOOLEAN         IsCompressed;
00936     ULONG           i;
00937 
00938     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INDEX) {
00939         KdPrint((<span class="stringliteral">"CmpAddSubKey:\n\t"</span>));
00940         KdPrint((<span class="stringliteral">"Hive=%08lx Parent=%08lx Child=%08lx\n"</span>,Hive,Parent,Child));
00941     }
00942 
00943     <span class="comment">//</span>
00944     <span class="comment">// build a name string</span>
00945     <span class="comment">//</span>
00946     pcell = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Child);
00947     <span class="keywordflow">if</span> (pcell-&gt;Flags &amp; KEY_COMP_NAME) {
00948         IsCompressed = TRUE;
00949         <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Length = <a class="code" href="../../d9/d1/cmname_8c.html#a2">CmpCompressedNameSize</a>(pcell-&gt;Name, pcell-&gt;NameLength);
00950         <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.MaximumLength = <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Length;
00951         <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Buffer = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Length, FALSE);
00952         if (<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Buffer==NULL) {
00953             <span class="keywordflow">return</span>(FALSE);
00954         }
00955         <a class="code" href="../../d1/d2/cmp_8h.html#a318">CmpCopyCompressedName</a>(<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Buffer,
00956                               <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.MaximumLength,
00957                               pcell-&gt;Name,
00958                               pcell-&gt;NameLength);
00959     } <span class="keywordflow">else</span> {
00960         IsCompressed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00961         <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Length = pcell-&gt;NameLength;
00962         <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.MaximumLength = pcell-&gt;NameLength;
00963         <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Buffer = &amp;(pcell-&gt;Name[0]);
00964     }
00965 
00966     pcell = (<a class="code" href="../../d9/d0/cmdata_8h.html#a79">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Parent);
00967 
00968     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Child);
00969 
00970     <span class="keywordflow">if</span> (pcell-&gt;SubKeyCounts[Type] == 0) {
00971 
00972         ULONG Signature;
00973 
00974         <span class="comment">//</span>
00975         <span class="comment">// we must allocate a leaf</span>
00976         <span class="comment">//</span>
00977         WorkCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(Hive, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">CM_KEY_FAST_INDEX</a>), Type);
00978         <span class="keywordflow">if</span> (WorkCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00979             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00980         }
00981         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, WorkCell);
00982         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature = <a class="code" href="../../d9/d0/cmdata_8h.html#a17">UseFastIndex</a>(Hive) ? <a class="code" href="../../d9/d0/cmdata_8h.html#a20">CM_KEY_FAST_LEAF</a> : <a class="code" href="../../d9/d0/cmdata_8h.html#a19">CM_KEY_INDEX_LEAF</a>;
00983         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Count = 0;
00984         pcell-&gt;SubKeyLists[Type] = WorkCell;
00985         cleanup = 1;
00986     } <span class="keywordflow">else</span> {
00987 
00988         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, pcell-&gt;SubKeyLists[Type]);
00989         <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == <a class="code" href="../../d9/d0/cmdata_8h.html#a20">CM_KEY_FAST_LEAF</a>) &amp;&amp;
00990             (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Count &gt;= (<a class="code" href="../../d9/d0/cmdata_8h.html#a23">CM_MAX_FAST_INDEX</a>))) {
00991 
00992             <span class="comment">//</span>
00993             <span class="comment">// We must change fast index to a slow index to accomodate</span>
00994             <span class="comment">// growth.</span>
00995             <span class="comment">//</span>
00996 
00997             FastIndex = (<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00998             <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Count; i++) {
00999                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[i] = FastIndex-&gt;List[i].Cell;
01000             }
01001             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature = <a class="code" href="../../d9/d0/cmdata_8h.html#a19">CM_KEY_INDEX_LEAF</a>;
01002 
01003         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == <a class="code" href="../../d9/d0/cmdata_8h.html#a19">CM_KEY_INDEX_LEAF</a>) &amp;&amp;
01004                    (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Count &gt;= (<a class="code" href="../../d9/d0/cmdata_8h.html#a21">CM_MAX_INDEX</a> - 1) )) {
01005             <span class="comment">//</span>
01006             <span class="comment">// We must change flat entry to a root/leaf tree</span>
01007             <span class="comment">//</span>
01008             WorkCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(
01009                          Hive,
01010                          <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">CM_KEY_INDEX</a>) + <span class="keyword">sizeof</span>(HCELL_INDEX), <span class="comment">// allow for 2</span>
01011                          Type
01012                          );
01013             <span class="keywordflow">if</span> (WorkCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01014                 <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01015             }
01016 
01017             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, WorkCell);
01018             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature = <a class="code" href="../../d9/d0/cmdata_8h.html#a18">CM_KEY_INDEX_ROOT</a>;
01019             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Count = 1;
01020             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[0] = pcell-&gt;SubKeyLists[Type];
01021             pcell-&gt;SubKeyLists[Type] = WorkCell;
01022             cleanup = 2;
01023 
01024         }
01025     }
01026     LeafCell = pcell-&gt;SubKeyLists[Type];
01027 
01028     <span class="comment">//</span>
01029     <span class="comment">// LeafCell is target for add, or perhaps root</span>
01030     <span class="comment">// Index is pointer to fast leaf, slow Leaf or Root, whichever applies</span>
01031     <span class="comment">//</span>
01032     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == <a class="code" href="../../d9/d0/cmdata_8h.html#a18">CM_KEY_INDEX_ROOT</a>) {
01033         LeafCell = <a class="code" href="../../d7/d1/cmindex_8c.html#a8">CmpSelectLeaf</a>(Hive, pcell, &amp;NewName, Type, &amp;RootPointer);
01034         <span class="keywordflow">if</span> (LeafCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01035             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01036         }
01037     }
01038 
01039     <span class="comment">//</span>
01040     <span class="comment">// Add new cell to Leaf, update pointers</span>
01041     <span class="comment">//</span>
01042     LeafCell = <a class="code" href="../../d7/d1/cmindex_8c.html#a7">CmpAddToLeaf</a>(Hive, LeafCell, Child, &amp;NewName);
01043 
01044     <span class="keywordflow">if</span> (LeafCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01045         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01046     }
01047 
01048     pcell-&gt;SubKeyCounts[Type] += 1;
01049 
01050     <span class="keywordflow">if</span> (RootPointer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01051         *RootPointer = LeafCell;
01052     } <span class="keywordflow">else</span> {
01053         pcell-&gt;SubKeyLists[Type] = LeafCell;
01054     }
01055 
01056     <span class="keywordflow">if</span> (IsCompressed) {
01057         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Buffer, <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Length);
01058     }
01059 
01060     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01061 
01062 
01063 
01064 <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>:
01065     <span class="keywordflow">if</span> (IsCompressed) {
01066         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Buffer, <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Length);
01067     }
01068 
01069     <span class="keywordflow">switch</span> (cleanup) {
01070     <span class="keywordflow">case</span> 1:
01071         <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, pcell-&gt;SubKeyLists[Type]);
01072         pcell-&gt;SubKeyLists[Type] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01073         <span class="keywordflow">break</span>;
01074 
01075     <span class="keywordflow">case</span> 2:
01076         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, pcell-&gt;SubKeyLists[Type]);
01077         pcell-&gt;SubKeyLists[Type] = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[0];
01078         <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, pcell-&gt;SubKeyLists[Type]);
01079         <span class="keywordflow">break</span>;
01080     }
01081 
01082     <span class="keywordflow">return</span>  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01083 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a309" doxytag="cmp.h::CmpAddToHiveFileList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpAddToHiveFileList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>CmHive</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/cmhvlist_8c-source.html#l00042">42</a> of file <a class="el" href="../../d7/d0/cmhvlist_8c-source.html">cmhvlist.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d7/d0/cmhvlist_8c-source.html#l00251">CmpGetHiveName()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00272">CMS_INIT_ERROR</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00650">_CMHIVE::FileHandles</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00568">HFILE_TYPE_PRIMARY</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00649">_CMHIVE::Hive</a>, <a class="el" href="../../d7/d0/cmhvlist_8c-source.html#l00024">HIVE_LIST</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00203">HIVE_VOLATILE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00622">_HHIVE::HiveFlags</a>, <a class="el" href="../../d6/d1/cmhvlist_8c.html#a1">NAME_BUFFER_SIZE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d0/d6/nlsxlat_8c-source.html#l00110">UnicodeNull</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00726">CmpInitializeHiveList()</a>, and <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>.
<p>
<pre class="fragment"><div>00047                    :
00048 
00049     Add <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> to list of hives and their files in
00050     \registry\machine\system\currentcontrolset\<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a>\hivelist
00051 
00052 Arguments:
00053 
00054     HivePath - <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> to root of hive (e.g. \registry\machine\system)
00055 
00056     CmHive - pointer to CM_HIVE structure <span class="keywordflow">for</span> hive.
00057 
00058 Return Value:
00059 
00060     ntstatus
00061 
00062 --*/
00063 {
00064 <span class="comment">//</span>
00065 <span class="comment">//  PERFNOTE - allocate small instead of large buffers after</span>
00066 <span class="comment">//           NtQueryObject is fixec - bryanwi 15may92</span>
00067 <span class="comment">//</span>
00068 <span class="preprocessor">#define NAME_BUFFER_SIZE    512</span>
00069 <span class="preprocessor"></span>    OBJECT_ATTRIBUTES   <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00070     HANDLE              KeyHandle;
00071     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00072     PUCHAR              <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00073     ULONG               Length;
00074     PWSTR               FilePath;
00075     WCHAR               <a class="code" href="../../d9/d6/nlsxlat_8c.html#a30">UnicodeNull</a>=UNICODE_NULL;
00076     UNICODE_STRING      TempName;
00077     UNICODE_STRING      HivePath;
00078 
00079     <span class="comment">//</span>
00080     <span class="comment">// create/open the hive list key</span>
00081     <span class="comment">//</span>
00082     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00083         &amp;TempName,
00084         HIVE_LIST
00085         );
00086 
00087     InitializeObjectAttributes(
00088         &amp;ObjectAttributes,
00089         &amp;TempName,
00090         OBJ_CASE_INSENSITIVE,
00091         (HANDLE)NULL,
00092         NULL
00093         );
00094 
00095     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwCreateKey(
00096                 &amp;KeyHandle,
00097                 KEY_READ | KEY_WRITE,
00098                 &amp;ObjectAttributes,
00099                 0,
00100                 NULL,
00101                 REG_OPTION_VOLATILE,
00102                 NULL
00103                 );
00104 
00105     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00106         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INIT_ERROR) {
00107             KdPrint((<span class="stringliteral">"CmpAddToHiveFileList: "</span>));
00108             KdPrint((<span class="stringliteral">"Create/Open of Hive list failed status = %08lx\n"</span>, Status));
00109         }
00110         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00111     }
00112 
00113     <span class="comment">//</span>
00114     <span class="comment">// allocate work buffers</span>
00115     <span class="comment">//</span>
00116     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, NAME_BUFFER_SIZE);
00117     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00118         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(KeyHandle);
00119         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00120     }
00121 
00122     <span class="comment">//</span>
00123     <span class="comment">// compute name of hive</span>
00124     <span class="comment">//</span>
00125     <span class="keywordflow">if</span> (! <a class="code" href="../../d6/d1/cmhvlist_8c.html#a3">CmpGetHiveName</a>(CmHive, &amp;HivePath)) {
00126         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(KeyHandle);
00127         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Buffer);
00128         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00129     }
00130 
00131 
00132     <span class="comment">//</span>
00133     <span class="comment">// get name of file</span>
00134     <span class="comment">//</span>
00135     <span class="keywordflow">if</span> (!(CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>)) {
00136         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQueryObject(
00137                     CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[HFILE_TYPE_PRIMARY],
00138                     ObjectNameInformation,
00139                     (PVOID)Buffer,
00140                     NAME_BUFFER_SIZE,
00141                     &amp;Length
00142                     );
00143         Length -= <span class="keyword">sizeof</span>(UNICODE_STRING);
00144         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00145             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INIT_ERROR) {
00146                 KdPrint((<span class="stringliteral">"CmpAddToHiveFileList: "</span>));
00147                 KdPrint((<span class="stringliteral">"Query of name2 failed status = %08lx\n"</span>, Status));
00148             }
00149             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(KeyHandle);
00150             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(HivePath.Buffer);
00151             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Buffer);
00152             <span class="keywordflow">return</span>  <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00153         }
00154         FilePath = ((POBJECT_NAME_INFORMATION)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;Name.Buffer;
00155         FilePath[Length/<span class="keyword">sizeof</span>(WCHAR)] = UNICODE_NULL;
00156         Length+=<span class="keyword">sizeof</span>(WCHAR);
00157     } <span class="keywordflow">else</span> {
00158         FilePath = &amp;<a class="code" href="../../d9/d6/nlsxlat_8c.html#a30">UnicodeNull</a>;
00159         Length = <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d6/nlsxlat_8c.html#a30">UnicodeNull</a>);
00160     }
00161 
00162     <span class="comment">//</span>
00163     <span class="comment">// set entry in list</span>
00164     <span class="comment">//</span>
00165     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwSetValueKey(
00166                 KeyHandle,
00167                 &amp;HivePath,
00168                 0,
00169                 REG_SZ,
00170                 FilePath,
00171                 Length
00172                 );
00173     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00174         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INIT_ERROR) {
00175             KdPrint((<span class="stringliteral">"CmpAddToHiveFileList: "</span>));
00176             KdPrint((<span class="stringliteral">"Set of entry in Hive list failed status = %08lx\n"</span>, Status));
00177         }
00178     }
00179 
00180     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(KeyHandle);
00181     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(HivePath.Buffer);
00182     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Buffer);
00183     <span class="keywordflow">return</span>  <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00184 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a216" doxytag="cmp.h::CmpAllocate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID CmpAllocate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Size</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>UseForIo</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00062">62</a> of file <a class="el" href="../../d8/d2/cmwrapr_8c-source.html">cmwrapr.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00204">CmpClaimGlobalQuota()</a>, <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00265">CmpReleaseGlobalQuota()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00264">CMS_POOL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a178">PagedPoolCacheAligned</a>, <a class="el" href="../../d6/d1/ppc_2getcalr_8c-source.html#l00038">RtlGetCallersAddress()</a>, and <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>.
<p>
Referenced by <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>.
<p>
<pre class="fragment"><div>00068                    :
00069 
00070     This routine makes more memory available to a hive.
00071 
00072     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> environment specific.
00073 
00074 Arguments:
00075 
00076     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - amount of space caller wants
00077 
00078     UseForIo - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> object allocated will be target of I/O,
00079                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> not.
00080 
00081 Return Value:
00082 
00083     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>, address of allocated block <span class="keywordflow">if</span> not.
00084 
00085 --*/
00086 {
00087     PVOID   result;
00088     ULONG   pooltype;
00089 <span class="preprocessor">#if DBG</span>
00090 <span class="preprocessor"></span>    PVOID   Caller;
00091     PVOID   CallerCaller;
00092     <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;Caller, &amp;CallerCaller);
00093 <span class="preprocessor">#endif</span>
00094 <span class="preprocessor"></span>
00095     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a247">CmpClaimGlobalQuota</a>(Size) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00096         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00097     }
00098 
00099     pooltype = (UseForIo) ? <a class="code" href="../../d5/d8/ex_8h.html#a329a178">PagedPoolCacheAligned</a> : <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>;
00100     result = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00101                 pooltype,
00102                 Size,
00103                 CM_POOL_TAG
00104                 );
00105 
00106 <span class="preprocessor">#if DBG</span>
00107 <span class="preprocessor"></span>    <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_POOL) {
00108         KdPrint((<span class="stringliteral">"**CmpAllocate: allocate:%08lx, "</span>, Size));
00109         KdPrint((<span class="stringliteral">"type:%d, at:%08lx  "</span>, PagedPool, result));
00110         KdPrint((<span class="stringliteral">"c:%08lx  cc:%08lx\n"</span>, Caller, CallerCaller));
00111     }
00112 <span class="preprocessor">#endif</span>
00113 <span class="preprocessor"></span>
00114     <span class="keywordflow">if</span> (result == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00115         <a class="code" href="../../d1/d2/cmp_8h.html#a248">CmpReleaseGlobalQuota</a>(Size);
00116     }
00117 
00118     <span class="keywordflow">return</span> result;
00119 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a285" doxytag="cmp.h::CmpAllocatePostBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a> CmpAllocatePostBlock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d2/cmp_8h.html#a166">POST_BLOCK_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>BlockType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PostFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyBody</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MasterBlock</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03883">3883</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
References <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00055">ALLOCATE_WITH_QUOTA</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a175">CM_POST_BLOCK</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a173">CM_POST_BLOCK_UNION</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a162">CM_POST_KEY_BODY</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00632">IsMasterPostBlock</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a335a206">PostAsyncKernel</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a335a205">PostAsyncUser</a>, and <a class="el" href="../../d1/d2/cmp_8h.html#a335a204">PostSynchronous</a>.
<p>
<pre class="fragment"><div>03892                    :
03893 
03894     Allocates a post block from <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.  The non-pagable stuff comes from
03895     <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pagable stuff from paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.  Quota will be
03896     charged.
03897 
03898 Arguments:
03899 
03900     BlockType  - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> post block to be allocated
03901                 i.e. : PostSyncrhronous, <a class="code" href="../../d1/d2/cmp_8h.html#a335a205">PostAsyncUser</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a335a206">PostAsyncKernel</a>
03902 
03903     PostFlags      - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flags to be set on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated post block
03904                 vallid flags:
03905                     - <a class="code" href="../../d1/d2/cmp_8h.html#a87">REG_NOTIFY_MASTER_POST</a> - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> post block to be allocated
03906                       <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a master post block.
03907     KeyBody     - The <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> object to whom <span class="keyword">this</span> post block <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> attached. On master blocks
03908                   <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>. When <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> post object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> freed, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> KeyBody object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
03909                   dereferenced (<span class="keywordflow">if</span> not NULL - i.e. <span class="keywordflow">for</span> slave blocks). This allow us to
03910                   perform back-end cleanup <span class="keywordflow">for</span> <span class="stringliteral">"fake-slave"</span> keys opened by NtNotifyMultipleKeys
03911     MasterBlock - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> post block to be allocated <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a slave of <span class="keyword">this</span> master block.
03912                   valid <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> when PostFlags ==  <a class="code" href="../../d1/d2/cmp_8h.html#a87">REG_NOTIFY_MASTER_POST</a>
03913 
03914 
03915 Obs: The <a class="code" href="../../d9/d0/cmdata_8h.html#a104a98">Sync</a>.SystemEvent and AsyncUser.Apc members are allocated <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">for</span> master post blocks
03916 
03917 Return Value:
03918 
03919     Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">CM_POST_BLOCK</a> <span class="keywordflow">if</span> successful
03920 
03921     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> there were not enough resources available.
03922 
03923 --*/
03924 
03925 {
03926     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a> PostBlock;
03927 
03928     <span class="comment">// protection against outrageous calls</span>
03929     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !PostFlags || (!MasterBlock &amp;&amp; !KeyBody) );
03930 
03931     PostBlock = <a class="code" href="../../d7/d7/ntapi_8c.html#a0">ALLOCATE_WITH_QUOTA</a>(PagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">CM_POST_BLOCK</a>),CM_POSTBLOCK_TAG);
03932     <span class="keywordflow">if</span> (PostBlock==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03933         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03934     }
03935 
03936 <span class="preprocessor">#ifdef _CM_ENTRYLIST_MANIPULATION</span>
03937 <span class="preprocessor"></span>    RtlZeroMemory((PVOID)PostBlock, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">CM_POST_BLOCK</a>));
03938 <span class="preprocessor">#endif</span>
03939 <span class="preprocessor"></span>
03940 <span class="preprocessor">#if DBG</span>
03941 <span class="preprocessor"></span>    PostBlock-&gt;TraceIntoDebugger = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03942 <span class="preprocessor">#endif</span>
03943 <span class="preprocessor"></span>
03944     PostBlock-&gt;NotifyType = (ULONG)BlockType;
03945     PostBlock-&gt;NotifyType |= PostFlags;
03946 
03947     <span class="keywordflow">if</span>(<a class="code" href="../../d1/d2/cmp_8h.html#a89">IsMasterPostBlock</a>(PostBlock)) {
03948         PostBlock-&gt;PostKeyBody = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03949         <span class="comment">//</span>
03950         <span class="comment">// master post block ==&gt; allocate the storage</span>
03951         <span class="comment">//</span>
03952         PostBlock-&gt;u = <a class="code" href="../../d7/d7/ntapi_8c.html#a0">ALLOCATE_WITH_QUOTA</a>(NonPagedPool,
03953                                            <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html">CM_POST_BLOCK_UNION</a>),
03954                                            CM_POSTBLOCK_TAG);
03955         <span class="keywordflow">if</span> (PostBlock-&gt;u == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03956             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock);
03957             <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03958         }
03959 
03960          <span class="keywordflow">switch</span> (BlockType) {
03961             <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a335a204">PostSynchronous</a>:
03962                 PostBlock-&gt;u-&gt;Sync.SystemEvent = <a class="code" href="../../d7/d7/ntapi_8c.html#a0">ALLOCATE_WITH_QUOTA</a>(NonPagedPool,
03963                                                                     <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>),
03964                                                                     CM_POSTEVENT_TAG);
03965                 <span class="keywordflow">if</span> (PostBlock-&gt;u-&gt;Sync.SystemEvent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03966                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock-&gt;u);
03967                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock);
03968                     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03969                 }
03970                 <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(PostBlock-&gt;u-&gt;Sync.SystemEvent,
03971                                   SynchronizationEvent,
03972                                   FALSE);
03973                 <span class="keywordflow">break</span>;
03974             <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a335a205">PostAsyncUser</a>:
03975                 PostBlock-&gt;u-&gt;AsyncUser.Apc = <a class="code" href="../../d7/d7/ntapi_8c.html#a0">ALLOCATE_WITH_QUOTA</a>(NonPagedPool,
03976                                                              <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d5/struct__KAPC.html">KAPC</a>),
03977                                                              CM_POSTAPC_TAG);
03978                 <span class="keywordflow">if</span> (PostBlock-&gt;u-&gt;AsyncUser.Apc==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03979                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock-&gt;u);
03980                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock);
03981                     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03982                 }
03983                 <span class="keywordflow">break</span>;
03984             <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a335a206">PostAsyncKernel</a>:
03985                 RtlZeroMemory(&amp;PostBlock-&gt;u-&gt;AsyncKernel, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d3/struct__CM__ASYNC__KERNEL__POST__BLOCK.html">CM_ASYNC_KERNEL_POST_BLOCK</a>));
03986                 <span class="keywordflow">break</span>;
03987         }
03988     } <span class="keywordflow">else</span> {
03989         <span class="comment">//</span>
03990         <span class="comment">// Slave post block ==&gt; copy storage allocated for the master post block</span>
03991         <span class="comment">//</span>
03992         PostBlock-&gt;u = MasterBlock-&gt;u;
03993 
03994         <span class="comment">//</span>
03995         <span class="comment">// allocate a PostKeyBody which will hold this KeyBody, and initialize the head of its KeyBodyList</span>
03996         <span class="comment">//</span>
03997         PostBlock-&gt;PostKeyBody = <a class="code" href="../../d7/d7/ntapi_8c.html#a0">ALLOCATE_WITH_QUOTA</a>(PagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d6/struct__CM__POST__KEY__BODY.html">CM_POST_KEY_BODY</a>),CM_POSTBLOCK_TAG);
03998         <span class="keywordflow">if</span> (PostBlock-&gt;PostKeyBody == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03999             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock);
04000             <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04001         }
04002         PostBlock-&gt;PostKeyBody-&gt;KeyBody = KeyBody;
04003         InitializeListHead(&amp;(PostBlock-&gt;PostKeyBody-&gt;KeyBodyList));
04004     }
04005 
04006     <span class="keywordflow">return</span>(PostBlock);
04007 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a250" doxytag="cmp.h::CmpAssignSecurityDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpAssignSecurityDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Node</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d1/cmse_8c-source.html#l00697">697</a> of file <a class="el" href="../../d8/d1/cmse_8c-source.html">cmse.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00531">ASSERT_NODE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00517">CM_KEY_SECURITY_SIGNATURE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00400">CmpDumpSecurityDescriptor</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01545">CmpFindMatchingDescriptorCell()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01704">CmpInsertSecurityCellList()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00263">CMS_SEC</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00526">_CM_KEY_SECURITY::Descriptor</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00525">_CM_KEY_SECURITY::DescriptorLength</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00386">HvAllocateCell()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">HvMarkCellDirty()</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00524">_CM_KEY_SECURITY::ReferenceCount</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02165">RtlLengthSecurityDescriptor()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00095">SECURITY_CELL_LENGTH</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00520">_CM_KEY_SECURITY::Signature</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00686">CmpCopyKeyPartial()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00158">CmpSecurityMethod()</a>, and <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01338">CmpSyncKeyValues()</a>.
<p>
<pre class="fragment"><div>00706                    :
00707 
00708     This routine assigns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given security descriptor to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00709     node in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> configuration tree.
00710 
00711 Arguments:
00712 
00713     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> node whose security
00714            descriptor will be assigned.
00715 
00716     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> node whose security descriptor
00717            will be assigned.
00718 
00719     Node - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> node whose security descriptor will
00720            be assigned.
00721 
00722     SecurityDescriptor - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor to
00723            be assigned to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> node.
00724 
00725     PoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SecurityDescriptor was a
00726            allocated from.
00727 
00728 Return Value:
00729 
00730     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - STATUS_SUCCESS <span class="keywordflow">if</span> successful and an appropriate error value
00731         otherwise
00732 
00733 --*/
00734 
00735 {
00736     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> SecurityCell;
00737     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> Security;
00738     ULONG DescriptorLength;
00739     ULONG Type;
00740 
00741     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00742     <span class="comment">//</span>
00743     <span class="comment">// Map the node that we need to assign the security descriptor to.</span>
00744     <span class="comment">//</span>
00745     <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, Cell)) {
00746         <span class="keywordflow">return</span> STATUS_NO_LOG_SPACE;
00747     }
00748     <a class="code" href="../../d1/d2/cmp_8h.html#a84">ASSERT_NODE</a>(Node);
00749 
00750     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
00751 <span class="preprocessor">#if DBG</span>
00752 <span class="preprocessor"></span>        UNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
00753 
00754         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.MaximumLength = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length = Node-&gt;NameLength;
00755         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Buffer = Node-&gt;Name;
00756         KdPrint((<span class="stringliteral">"CmpAssignSecurityDescriptor: '%wZ' (H %lx C %lx)\n"</span>,&amp;Name,Hive,Cell ));
00757         KdPrint((<span class="stringliteral">"\tSecurityCell = %lx\n"</span>,Node-&gt;Security));
00758 <span class="preprocessor">#endif</span>
00759 <span class="preprocessor"></span>    }
00760 
00761     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Node-&gt;Security==HCELL_NIL);
00762 
00763     <span class="comment">//</span>
00764     <span class="comment">// This is a CreateKey, so the registry node has just been created and</span>
00765     <span class="comment">// the security descriptor we have been passed needs to be associated</span>
00766     <span class="comment">// with the new registry node and inserted into the hive.</span>
00767     <span class="comment">//</span>
00768     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
00769         <a class="code" href="../../d1/d2/cmp_8h.html#a66">CmpDumpSecurityDescriptor</a>(SecurityDescriptor, <span class="stringliteral">"ASSIGN DESCRIPTOR\n"</span>);
00770     }
00771 
00772     <span class="comment">//</span>
00773     <span class="comment">// Try to find an existing security descriptor that matches this one.</span>
00774     <span class="comment">// If successful, then we don't need to allocate a new cell, we can</span>
00775     <span class="comment">// just point to the existing one and increment its reference count.</span>
00776     <span class="comment">//</span>
00777     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Cell);
00778     <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d2/cmse_8c.html#a5">CmpFindMatchingDescriptorCell</a>( Hive,
00779                                         Node,
00780                                         SecurityDescriptor,
00781                                         Type,
00782                                         &amp;SecurityCell )) {
00783         <span class="comment">//</span>
00784         <span class="comment">// No matching descriptor found, allocate and initialize a new one.</span>
00785         <span class="comment">//</span>
00786         SecurityCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(Hive,
00787                                       <a class="code" href="../../d7/d2/cmse_8c.html#a0">SECURITY_CELL_LENGTH</a>(SecurityDescriptor),
00788                                       Type);
00789         <span class="keywordflow">if</span> (SecurityCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00790             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00791         }
00792 
00793         <span class="comment">//</span>
00794         <span class="comment">// Map the security cell</span>
00795         <span class="comment">//</span>
00796         Security = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, SecurityCell);
00797 
00798         <span class="comment">//</span>
00799         <span class="comment">// Initialize the security cell</span>
00800         <span class="comment">//</span>
00801         DescriptorLength = <a class="code" href="../../d8/d6/sertl_8c.html#a56">RtlLengthSecurityDescriptor</a>(SecurityDescriptor);
00802 
00803         Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o0">Signature</a> = <a class="code" href="../../d9/d0/cmdata_8h.html#a39">CM_KEY_SECURITY_SIGNATURE</a>;
00804         Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o4">ReferenceCount</a> = 1;
00805         Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o5">DescriptorLength</a> = DescriptorLength;
00806         RtlMoveMemory( &amp;(Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o6">Descriptor</a>),
00807                        SecurityDescriptor,
00808                        DescriptorLength );
00809 
00810         <span class="comment">//</span>
00811         <span class="comment">// Insert the new security descriptor into the list of security</span>
00812         <span class="comment">// cells.</span>
00813         <span class="comment">//</span>
00814         <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d2/cmse_8c.html#a6">CmpInsertSecurityCellList</a>(Hive,Cell,SecurityCell))
00815         {
00816             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, SecurityCell);
00817             <span class="keywordflow">return</span> STATUS_NO_LOG_SPACE;
00818         }
00819 
00820     } <span class="keywordflow">else</span> {
00821 
00822         <span class="comment">//</span>
00823         <span class="comment">// Found identical descriptor already existing.  Map it in and</span>
00824         <span class="comment">// increment its reference count.</span>
00825         <span class="comment">//</span>
00826         <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, SecurityCell)) {
00827             <span class="keywordflow">return</span> STATUS_NO_LOG_SPACE;
00828         }
00829         Security = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, SecurityCell);
00830         Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o4">ReferenceCount</a> += 1;
00831     }
00832 
00833     <span class="comment">//</span>
00834     <span class="comment">// Initialize the reference in the node cell</span>
00835     <span class="comment">//</span>
00836     Node-&gt;Security = SecurityCell;
00837 
00838     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
00839         KdPrint((<span class="stringliteral">"\tSecurityCell = %lx\n"</span>,Node-&gt;Security));
00840     }
00841 
00842     <span class="keywordflow">return</span>(STATUS_SUCCESS);
00843 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a251" doxytag="cmp.h::CmpCheckCreateAccess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpCheckCreateAccess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>RelativeName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>Descriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>AdditionalAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PNTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d1/cmse_8c-source.html#l00917">917</a> of file <a class="el" href="../../d8/d1/cmse_8c-source.html">cmse.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00400">CmpDumpSecurityDescriptor</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00263">CMS_SEC</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00168">_OBJECT_TYPE_INITIALIZER::GenericMapping</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03323">SeAccessCheck()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03538">SeCreateObjectAuditAlarm()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00115">SeLockSubjectContext()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00159">SeUnlockSubjectContext()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>.
<p>
Referenced by <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00033">CmpDoCreate()</a>.
<p>
<pre class="fragment"><div>00928                    :
00929 
00930     This routine checks to see <span class="keywordflow">if</span> we are allowed to create a sub-key in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00931     given key, and performs auditing as appropriate.
00932 
00933 Arguments:
00934 
00935     <a class="code" href="../../d2/d2/rtload_8c.html#a7">RelativeName</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relative name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key being created.
00936 
00937     Descriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key in which
00938         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> sub-key <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be created.
00939 
00940     CreateAccess - The access mask corresponding to create access <span class="keywordflow">for</span>
00941         <span class="keyword">this</span> directory <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
00942 
00943     AccessState - Checks <span class="keywordflow">for</span> traverse access will typically be incidental
00944         to some other access attempt.  Information on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current state of
00945         that access attempt <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required so that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> constituent access
00946         attempts may be associated with each other in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> audit log.
00947 
00948     PreviousMode - The previous processor mode.
00949 
00950     AdditionalAccess - access rights in addition to KEY_CREATE_SUB_KEY
00951             that are required.  (e.g. KEY_CREATE_LINK)
00952 
00953     AccessStatus - Pointer to a variable to <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status code of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00954         access attempt.  In <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">case</span> of <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> <span class="keyword">this</span> status code must be
00955         propagated back to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user.
00956 
00957 Return Value:
00958 
00959     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.  AccessStatus
00960     contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status code to be passed back to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
00961     correct to simply pass back STATUS_ACCESS_DENIED, since <span class="keyword">this</span> will have
00962     to change with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> advent of mandatory access <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a>.
00963 
00964 --*/
00965 
00966 {
00967     BOOLEAN AccessAllowed;
00968     ACCESS_MASK GrantedAccess = 0;
00969     BOOLEAN AuditPerformed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00970 
00971     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00972     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
00973         KdPrint((<span class="stringliteral">"CmpCheckCreateAccess:\n"</span>));
00974     }
00975 
00976     <a class="code" href="../../d0/d8/subject_8c.html#a1">SeLockSubjectContext</a>( &amp;AccessState-&gt;SubjectSecurityContext );
00977 
00978     AccessAllowed = <a class="code" href="../../d0/d4/accessck_8c.html#a18">SeAccessCheck</a>(
00979                         Descriptor,
00980                         &amp;AccessState-&gt;SubjectSecurityContext,
00981                         TRUE,                              <span class="comment">// Token is read locked</span>
00982                         (KEY_CREATE_SUB_KEY | AdditionalAccess),
00983                         0,
00984                         NULL,
00985                         &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>,
00986                         PreviousMode,
00987                         &amp;GrantedAccess,
00988                         AccessStatus
00989                         );
00990 
00991     <span class="comment">//</span>
00992     <span class="comment">// if the security guys ever get around to implementing this,</span>
00993     <span class="comment">// put this call back in.</span>
00994     <span class="comment">//</span>
00995 <span class="preprocessor">#if 0</span>
00996 <span class="preprocessor"></span>    <span class="comment">//</span>
00997     <span class="comment">// WARNNOTE John Vert (jvert) 22-Jan-92</span>
00998     <span class="comment">//  We don't have a Directory Object handy, and the auditing currently</span>
00999     <span class="comment">//  ignores it anyway.</span>
01000     <span class="comment">//</span>
01001 
01002     <a class="code" href="../../d3/d5/seaudit_8c.html#a26">SeCreateObjectAuditAlarm</a>(
01003         &amp;AccessState-&gt;OperationID,
01004         NULL,                       <span class="comment">// &lt;- see WARNNOTE</span>
01005         NULL,                       <span class="comment">// Need component name</span>
01006         Descriptor,
01007         &amp;AccessState-&gt;SubjectSecurityContext,
01008         KEY_CREATE_SUB_KEY,
01009         AccessState-&gt;PrivilegesUsed,
01010         AccessAllowed,
01011         &amp;AuditPerformed,
01012         PreviousMode
01013         );
01014 <span class="preprocessor">#endif</span>
01015 <span class="preprocessor"></span>
01016     <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( &amp;AccessState-&gt;SubjectSecurityContext );
01017 
01018     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
01019         KdPrint((<span class="stringliteral">"Create access %s\n"</span>,AccessAllowed ? <span class="stringliteral">"granted"</span> : <span class="stringliteral">"denied"</span>));
01020 <span class="preprocessor">#if DBG</span>
01021 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!AccessAllowed) {
01022             <a class="code" href="../../d1/d2/cmp_8h.html#a66">CmpDumpSecurityDescriptor</a>(Descriptor, <span class="stringliteral">"DENYING DESCRIPTOR"</span>);
01023         }
01024 <span class="preprocessor">#endif</span>
01025 <span class="preprocessor"></span>    }
01026 
01027     <span class="keywordflow">return</span>(AccessAllowed);
01028 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a207" doxytag="cmp.h::CmpCheckLockExceptionFilter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG CmpCheckLockExceptionFilter           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PEXCEPTION_POINTERS&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ExceptionPointers</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00081">81</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, and <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>.
<p>
<pre class="fragment"><div>00084 {
00085     KdPrint((<span class="stringliteral">"CM: Registry exception %lx, ExceptionPointers = %lx\n"</span>,
00086             ExceptionPointers-&gt;ExceptionRecord-&gt;ExceptionCode,
00087             ExceptionPointers));
00088 
00089     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR,12,
00090         (ULONG_PTR)ExceptionPointers-&gt;ExceptionRecord-&gt;ExceptionCode,
00091         (ULONG_PTR)ExceptionPointers-&gt;ExceptionRecord,
00092         (ULONG_PTR)ExceptionPointers-&gt;ContextRecord);
00093 
00094     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>;
00095 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a252" doxytag="cmp.h::CmpCheckNotifyAccess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpCheckNotifyAccess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifyBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Node</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d1/cmse_8c-source.html#l01032">1032</a> of file <a class="el" href="../../d8/d1/cmse_8c-source.html">cmse.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00345">ASSERT_CM_LOCK_OWNED</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00400">CmpDumpSecurityDescriptor</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01165">CmpGetKeySecurity()</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00263">CMS_SEC</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00526">_CM_KEY_SECURITY::Descriptor</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00168">_OBJECT_TYPE_INITIALIZER::GenericMapping</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03323">SeAccessCheck()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00115">SeLockSubjectContext()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00159">SeUnlockSubjectContext()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00281">CmpNotifyTriggerCheck()</a>.
<p>
<pre class="fragment"><div>01039                    :
01040 
01041     Check whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subject process/thread/user specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01042     security data in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NotifyBlock has required access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01043     key specified by <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>.Cell.
01044 
01045 Arguments:
01046 
01047     NotifyBlock - pointer to structure that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify
01048                   operation, including <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> identity of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subject
01049                   that opened <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify.
01050 
01051     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies pointer to hive containing Node.
01052 
01053     Node - Supplies pointer to key of interest.
01054 
01055 Return Value:
01056 
01057     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> RequiredAccess <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in fact possessed by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subject,
01058     <span class="keywordflow">else</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
01059 
01060 --*/
01061 {
01062     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> Security;
01063     PSECURITY_DESCRIPTOR SecurityDescriptor;
01064     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01065     BOOLEAN AccessAllowed;
01066     ACCESS_MASK GrantedAccess = 0;
01067 
01068     <a class="code" href="../../d1/d2/cmp_8h.html#a61">ASSERT_CM_LOCK_OWNED</a>();
01069     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01070 
01071 
01072     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
01073         KdPrint((<span class="stringliteral">"CmpCheckAccessForNotify:\n"</span>));
01074     }
01075     Security = <a class="code" href="../../d7/d2/cmse_8c.html#a3">CmpGetKeySecurity</a>(Hive,
01076                                  Node,
01077                                  NULL);
01078 
01079     <a class="code" href="../../d0/d8/subject_8c.html#a1">SeLockSubjectContext</a>( &amp;NotifyBlock-&gt;SubjectContext );
01080 
01081     SecurityDescriptor = &amp;Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o6">Descriptor</a>;
01082     AccessAllowed = <a class="code" href="../../d0/d4/accessck_8c.html#a18">SeAccessCheck</a>( SecurityDescriptor,
01083                                    &amp;NotifyBlock-&gt;SubjectContext,
01084                                    TRUE,
01085                                    KEY_NOTIFY,
01086                                    0,
01087                                    NULL,
01088                                    &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>,
01089                                    UserMode,
01090                                    &amp;GrantedAccess,
01091                                    &amp;Status );
01092 
01093     <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( &amp;NotifyBlock-&gt;SubjectContext );
01094 
01095     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
01096         KdPrint((<span class="stringliteral">"Notify access %s\n"</span>,AccessAllowed ? <span class="stringliteral">"granted"</span> : <span class="stringliteral">"denied"</span>));
01097 <span class="preprocessor">#if DBG</span>
01098 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!AccessAllowed) {
01099             <a class="code" href="../../d1/d2/cmp_8h.html#a66">CmpDumpSecurityDescriptor</a>(SecurityDescriptor, <span class="stringliteral">"DENYING DESCRIPTOR"</span>);
01100         }
01101 <span class="preprocessor">#endif</span>
01102 <span class="preprocessor"></span>    }
01103 
01104     <span class="keywordflow">return</span> AccessAllowed;
01105 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a247" doxytag="cmp.h::CmpClaimGlobalQuota" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpClaimGlobalQuota           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Size</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00204">204</a> of file <a class="el" href="../../d6/d0/cmgquota_8c-source.html">cmgquota.c</a>.
<p>
References <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00037">CmpGlobalQuotaAllowed</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00063">CmpGlobalQuotaUsed</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00038">CmpGlobalQuotaWarning</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00053">CmpQuotaWarningPopupDisplayed</a>, <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00166">CmpQuotaWarningWorker()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a332a206">DelayedWorkQueue</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01961">ExInitializeWorkItem</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00375">ExQueueWorkItem()</a>, <a class="el" href="../../d7/d7/ex_2harderr_8c-source.html#l00058">ExReadyForErrors</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a113">PWORK_QUEUE_ITEM</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00062">CmpAllocate()</a>.
<p>
<pre class="fragment"><div>00209                    :
00210 
00211     If <a class="code" href="../../d7/d0/cmdat2_8c.html#a9">CmpGlobalQuotaUsed</a> + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &gt;= <a class="code" href="../../d8/d9/cmapi_8c.html#a7">CmpGlobalQuotaAllowed</a>, <span class="keywordflow">return</span>
00212     <span class="keyword">false</span>.  Otherwise, increment <a class="code" href="../../d7/d0/cmdat2_8c.html#a9">CmpGlobalQuotaUsed</a>, in effect claiming
00213     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested GlobalQuota.
00214 
00215 Arguments:
00216 
00217     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - number of bytes of GlobalQuota caller wants to claim
00218 
00219 Return Value:
00220 
00221     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - Claim succeeded, and has been counted in Used GQ
00222 
00223     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - Claim failed, nothing counted in GQ.
00224 
00225 --*/
00226 {
00227     LONG   available;
00228     <a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">PWORK_QUEUE_ITEM</a> WorkItem;
00229 
00230     <span class="comment">//</span>
00231     <span class="comment">// compute available space, then see if size &lt;.  This prevents overflows.</span>
00232     <span class="comment">// Note that this must be signed. Since quota is not enforced until logon,</span>
00233     <span class="comment">// it is possible for the available bytes to be negative.</span>
00234     <span class="comment">//</span>
00235 
00236     available = (LONG)<a class="code" href="../../d8/d9/cmapi_8c.html#a7">CmpGlobalQuotaAllowed</a> - (LONG)<a class="code" href="../../d7/d0/cmdat2_8c.html#a9">CmpGlobalQuotaUsed</a>;
00237 
00238     <span class="keywordflow">if</span> ((LONG)<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &lt; available) {
00239         <a class="code" href="../../d7/d0/cmdat2_8c.html#a9">CmpGlobalQuotaUsed</a> += <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00240         <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d0/cmdat2_8c.html#a9">CmpGlobalQuotaUsed</a> &gt; <a class="code" href="../../d8/d9/cmapi_8c.html#a8">CmpGlobalQuotaWarning</a>) &amp;&amp;
00241             (!<a class="code" href="../../d7/d0/cmdat2_8c.html#a6">CmpQuotaWarningPopupDisplayed</a>) &amp;&amp;
00242             (<a class="code" href="../../d6/d8/ex_2harderr_8c.html#a5">ExReadyForErrors</a>)) {
00243 
00244             <span class="comment">//</span>
00245             <span class="comment">// Queue work item to display popup</span>
00246             <span class="comment">//</span>
00247             WorkItem = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(NonPagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">WORK_QUEUE_ITEM</a>));
00248             <span class="keywordflow">if</span> (WorkItem != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00249 
00250                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a6">CmpQuotaWarningPopupDisplayed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00251                 <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>(WorkItem,
00252                                      CmpQuotaWarningWorker,
00253                                      WorkItem);
00254                 <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>(WorkItem, DelayedWorkQueue);
00255             }
00256         }
00257         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00258     } <span class="keywordflow">else</span> {
00259         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00260     }
00261 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a325" doxytag="cmp.h::CmpCleanUpKcbCacheWithLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpCleanUpKcbCacheWithLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>KeyControlBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00629">629</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00525">ASSERT_KEYBODY_LIST_EMPTY</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00255">CM_KCB_SUBKEY_HINT</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00568">CmpCleanUpKcbValueCache()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00503">CmpDereferenceNameControlBlockWithLock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01260">CmpRemoveKeyControlBlock()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00272">_CM_KEY_CONTROL_BLOCK::Delete</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00291">ExFreePoolWithTag</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00283">_CM_KEY_CONTROL_BLOCK::ExtFlags</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00290">_CM_KEY_CONTROL_BLOCK::IndexHint</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00286">_CM_KEY_CONTROL_BLOCK::NameBlock</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00285">_CM_KEY_CONTROL_BLOCK::ParentKcb</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00281">PROTECTED_POOL</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00273">_CM_KEY_CONTROL_BLOCK::RefCount</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00068">SET_KCB_SIGNATURE</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01853">CmpCacheLookup()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01184">CmpDereferenceKeyControlBlockWithLock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00180">CmpSearchForOpenSubKeys()</a>, and <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01071">CmpSearchKeyControlBlockTree()</a>.
<p>
<pre class="fragment"><div>00634                    :
00635 
00636     Clean up all cached allocations that are associated to <span class="keyword">this</span> key.
00637     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> still open just because of <span class="keyword">this</span> one, Remove <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent as well.
00638 
00639 Arguments:
00640 
00641     KeyControlBlock - pointer to a key <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block.
00642 
00643 Return Value:
00644 
00645     NONE.
00646 
00647 --*/
00648 {
00649     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   Kcb;
00650     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   ParentKcb;
00651 
00652     Kcb = KeyControlBlock;
00653 
00654     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeyControlBlock-&gt;RefCount == 0);
00655 
00656     <span class="keywordflow">while</span> (Kcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o1">RefCount</a> == 0) {
00657         <span class="comment">//</span>
00658         <span class="comment">// First, free allocations for Value/data.</span>
00659         <span class="comment">//</span>
00660     
00661         <a class="code" href="../../d8/d2/cmsubs_8c.html#a16">CmpCleanUpKcbValueCache</a>(Kcb);
00662     
00663         <span class="comment">//</span>
00664         <span class="comment">// Free the kcb and dereference parentkcb and nameblock.</span>
00665         <span class="comment">//</span>
00666     
00667         <a class="code" href="../../d8/d2/cmsubs_8c.html#a11">CmpDereferenceNameControlBlockWithLock</a>(Kcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>);
00668     
00669         <span class="keywordflow">if</span> (Kcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o7">ExtFlags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a11">CM_KCB_SUBKEY_HINT</a>) {
00670             <span class="comment">//</span>
00671             <span class="comment">// Now free the HintIndex allocation</span>
00672             <span class="comment">//</span>
00673             <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(Kcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o13">IndexHint</a>, CM_CACHE_INDEX_TAG | PROTECTED_POOL);
00674         }
00675 
00676         <span class="comment">//</span>
00677         <span class="comment">// Save the ParentKcb before we free the Kcb</span>
00678         <span class="comment">//</span>
00679         ParentKcb = Kcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o9">ParentKcb</a>;
00680         
00681         <span class="comment">//</span>
00682         <span class="comment">// We cannot call CmpDereferenceKeyControlBlockWithLock so we can avoid recurrsion.</span>
00683         <span class="comment">//</span>
00684         
00685         <span class="keywordflow">if</span> (!Kcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o0">Delete</a>) {
00686             <a class="code" href="../../d8/d2/cmsubs_8c.html#a24">CmpRemoveKeyControlBlock</a>(Kcb);
00687         }
00688         <a class="code" href="../../d9/d0/cmdata_8h.html#a4">SET_KCB_SIGNATURE</a>(Kcb, '4FmC');
00689         <a class="code" href="../../d1/d2/cmp_8h.html#a80">ASSERT_KEYBODY_LIST_EMPTY</a>(Kcb);
00690         <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(Kcb, CM_KCB_TAG | PROTECTED_POOL);
00691 
00692         Kcb = ParentKcb;
00693         Kcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o1">RefCount</a>--;
00694     }
00695 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a324" doxytag="cmp.h::CmpCleanUpKcbValueCache" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpCleanUpKcbValueCache           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>KeyControlBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00568">568</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
References <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00258">CM_KCB_NO_DELAY_CLOSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00256">CM_KCB_SYM_LINK_FOUND</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00609">CMP_GET_CACHED_ADDRESS</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00610">CMP_GET_CACHED_CELLDATA</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00608">CMP_IS_CELL_CACHED</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01184">CmpDereferenceKeyControlBlockWithLock()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00143">CmpMakeSpecialPoolReadWrite</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00234">_CACHED_CHILD_LIST::Count</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00272">_CM_KEY_CONTROL_BLOCK::Delete</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00283">_CM_KEY_CONTROL_BLOCK::ExtFlags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00237">_CACHED_CHILD_LIST::RealKcb</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00273">_CM_KEY_CONTROL_BLOCK::RefCount</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00288">_CM_KEY_CONTROL_BLOCK::ValueCache</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00236">_CACHED_CHILD_LIST::ValueList</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00092">CmDeleteValueKey()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00629">CmpCleanUpKcbCacheWithLock()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00963">CmpDoOpen()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01476">CmpGetSymbolicLink()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00097">CmRestoreKey()</a>, and <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01087">CmSetValueKey()</a>.
<p>
<pre class="fragment"><div>00573                    :
00574 
00575     Clean up cached value/data that are associated to <span class="keyword">this</span> key.
00576 
00577 Arguments:
00578 
00579     KeyControlBlock - pointer to a key <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block.
00580 
00581 Return Value:
00582 
00583     NONE.
00584 
00585 --*/
00586 {
00587     ULONG i;
00588     PULONG_PTR CachedList;
00589     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> pcell;
00590     ULONG      realsize;
00591     BOOLEAN    small;
00592 
00593     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/cmdata_8h.html#a45">CMP_IS_CELL_CACHED</a>(KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o12">ValueCache</a>.<a class="code" href="../../d5/d6/struct__CACHED__CHILD__LIST.html#o1">ValueList</a>)) {
00594         CachedList = (PULONG_PTR) <a class="code" href="../../d9/d0/cmdata_8h.html#a47">CMP_GET_CACHED_CELLDATA</a>(KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o12">ValueCache</a>.<a class="code" href="../../d5/d6/struct__CACHED__CHILD__LIST.html#o1">ValueList</a>);
00595         <span class="keywordflow">for</span> (i = 0; i &lt; KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o12">ValueCache</a>.<a class="code" href="../../d5/d6/struct__CACHED__CHILD__LIST.html#o0">Count</a>; i++) {
00596             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/cmdata_8h.html#a45">CMP_IS_CELL_CACHED</a>(CachedList[i])) {
00597 
00598                 <span class="comment">// Trying to catch the BAD guy who writes over our pool.</span>
00599                 <a class="code" href="../../d1/d2/cmp_8h.html#a8">CmpMakeSpecialPoolReadWrite</a>( <a class="code" href="../../d9/d0/cmdata_8h.html#a46">CMP_GET_CACHED_ADDRESS</a>(CachedList[i]) );
00600 
00601                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID) <a class="code" href="../../d9/d0/cmdata_8h.html#a46">CMP_GET_CACHED_ADDRESS</a>(CachedList[i]));
00602                
00603             }
00604         }
00605 
00606         <span class="comment">// Trying to catch the BAD guy who writes over our pool.</span>
00607         <a class="code" href="../../d1/d2/cmp_8h.html#a8">CmpMakeSpecialPoolReadWrite</a>( <a class="code" href="../../d9/d0/cmdata_8h.html#a46">CMP_GET_CACHED_ADDRESS</a>(KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o12">ValueCache</a>.<a class="code" href="../../d5/d6/struct__CACHED__CHILD__LIST.html#o1">ValueList</a>) );
00608 
00609         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID) <a class="code" href="../../d9/d0/cmdata_8h.html#a46">CMP_GET_CACHED_ADDRESS</a>(KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o12">ValueCache</a>.<a class="code" href="../../d5/d6/struct__CACHED__CHILD__LIST.html#o1">ValueList</a>));
00610 
00611         <span class="comment">// Mark the ValueList as NULL </span>
00612         KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o12">ValueCache</a>.<a class="code" href="../../d5/d6/struct__CACHED__CHILD__LIST.html#o1">ValueList</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00613 
00614     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o7">ExtFlags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a12">CM_KCB_SYM_LINK_FOUND</a>) {
00615         <span class="comment">//</span>
00616         <span class="comment">// This is a symbolic link key with symbolic name resolved.</span>
00617         <span class="comment">// Dereference to its real kcb and clear the bit.</span>
00618         <span class="comment">//</span>
00619         <span class="keywordflow">if</span> ((KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o12">ValueCache</a>.<a class="code" href="../../d5/d6/struct__CACHED__CHILD__LIST.html#o2">RealKcb</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o1">RefCount</a> == 1) &amp;&amp; !(KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o12">ValueCache</a>.<a class="code" href="../../d5/d6/struct__CACHED__CHILD__LIST.html#o2">RealKcb</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o0">Delete</a>)) {
00620             KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o12">ValueCache</a>.<a class="code" href="../../d5/d6/struct__CACHED__CHILD__LIST.html#o2">RealKcb</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o7">ExtFlags</a> |= <a class="code" href="../../d9/d0/cmdata_8h.html#a14">CM_KCB_NO_DELAY_CLOSE</a>;
00621         }
00622         <a class="code" href="../../d8/d2/cmsubs_8c.html#a23">CmpDereferenceKeyControlBlockWithLock</a>(KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o12">ValueCache</a>.<a class="code" href="../../d5/d6/struct__CACHED__CHILD__LIST.html#o2">RealKcb</a>);
00623         KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o7">ExtFlags</a> &amp;= ~<a class="code" href="../../d9/d0/cmdata_8h.html#a12">CM_KCB_SYM_LINK_FOUND</a>;
00624     }
00625 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a323" doxytag="cmp.h::CmpCleanUpSubKeyInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpCleanUpSubKeyInfo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>KeyControlBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00537">537</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00346">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00251">CM_KCB_NO_SUBKEY</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00255">CM_KCB_SUBKEY_HINT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00252">CM_KCB_SUBKEY_ONE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00291">ExFreePoolWithTag</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00283">_CM_KEY_CONTROL_BLOCK::ExtFlags</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00290">_CM_KEY_CONTROL_BLOCK::IndexHint</a>, and <a class="el" href="../../d6/d7/ex_8h-source.html#l00281">PROTECTED_POOL</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/cmapi2_8c-source.html#l00031">CmDeleteKey()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01252">CmpCreateLinkNode()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00033">CmpDoCreate()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00180">CmpSearchForOpenSubKeys()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03093">NtUnloadKey()</a>.
<p>
<pre class="fragment"><div>00541                    :
00542 
00543     Clean up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkey information cache due to create or <span class="keyword">delete</span> keys.
00544     Registry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> locked exclusively and no need to lock <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> KCB.
00545 
00546 Arguments:
00547 
00548     KeyControlBlock - pointer to a key <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block.
00549 
00550 Return Value:
00551 
00552     NONE.
00553 
00554 --*/
00555 {
00556     <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
00557 
00558     <span class="keywordflow">if</span> (KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o7">ExtFlags</a> &amp; (<a class="code" href="../../d9/d0/cmdata_8h.html#a9">CM_KCB_NO_SUBKEY</a> | <a class="code" href="../../d9/d0/cmdata_8h.html#a10">CM_KCB_SUBKEY_ONE</a> | <a class="code" href="../../d9/d0/cmdata_8h.html#a11">CM_KCB_SUBKEY_HINT</a>)) {
00559         <span class="keywordflow">if</span> (KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o7">ExtFlags</a> &amp; (<a class="code" href="../../d9/d0/cmdata_8h.html#a11">CM_KCB_SUBKEY_HINT</a>)) {
00560             <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o13">IndexHint</a>, CM_CACHE_INDEX_TAG | PROTECTED_POOL);
00561         }
00562         KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o7">ExtFlags</a> &amp;= ~((<a class="code" href="../../d9/d0/cmdata_8h.html#a9">CM_KCB_NO_SUBKEY</a> | <a class="code" href="../../d9/d0/cmdata_8h.html#a10">CM_KCB_SUBKEY_ONE</a> | <a class="code" href="../../d9/d0/cmdata_8h.html#a11">CM_KCB_SUBKEY_HINT</a>));
00563     }
00564 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a312" doxytag="cmp.h::CmpCloneHwProfile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpCloneHwProfile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>IDConfigDB</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Parent</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>OldProfile</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>OldProfileNumber</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DockingState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>NewProfile</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NewProfileNumber</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01869">1869</a> of file <a class="el" href="../../d7/d1/hwprofil_8c-source.html">hwprofil.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01585">CM_HARDWARE_PROFILE_STR_ALIASABLE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01586">CM_HARDWARE_PROFILE_STR_CLONED</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01592">CM_HARDWARE_PROFILE_STR_FRIENDLY_NAME</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01574">CM_HARDWARE_PROFILE_STR_HARDWARE_PROFILES</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01594">CM_HARDWARE_PROFILE_STR_HW_PROFILE_GUID</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01591">CM_HARDWARE_PROFILE_STR_PREFERENCE_ORDER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00242">CML_BUGCHECK</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01314">CmpCopyTree</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l02529">CmpCreateHwProfileFriendlyName()</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00256">CMS_INIT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d4/d2/uuid_8c-source.html#l00841">ExUuidCreate()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00255">NtQuerySecurityObject()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d2/d6/guid_8c-source.html#l00051">RtlStringFromGUID()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, and <a class="el" href="../../d6/d7/ex_8h-source.html#l03344">UUID</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02786">CmpCreateControlSet()</a>, and <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00805">CmSetAcpiHwProfile()</a>.
<p>
<pre class="fragment"><div>01884       :
01885 
01886     STATUS_SUCCESS - <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> profile has been cloned, in which <span class="keywordflow">case</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span>
01887         profile key has been opened <span class="keywordflow">for</span> read / write privs.  The old profile
01888         will be closed.
01889 
01890     &lt;unsuccessful&gt; - <span class="keywordflow">for</span> a given error.  NewProfile <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invalid and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Old
01891         Profile has also been closed.
01892 
01893 
01894                 (Copied lovingly from <a class="code" href="../../d1/d3/cmsysini_8c.html#a35">CmpCloneControlSet</a>)
01895 
01896 
01897 --*/
01898 {
01899     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
01900     UNICODE_STRING newProfileName;
01901     UNICODE_STRING name;
01902     UNICODE_STRING friendlyName;
01903     UNICODE_STRING guidStr;
01904     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> oldProfileKey;
01905     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> newProfileKey;
01906     OBJECT_ATTRIBUTES attributes;
01907     PSECURITY_DESCRIPTOR security;
01908     ULONG securityLength;
01909     WCHAR nameBuffer [64];
01910     HANDLE IDConfigDBEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01911     ULONG disposition;
01912     ULONG value;
01913     <a class="code" href="../../d5/d8/ex_8h.html#a172">UUID</a>  uuid;
01914     PKEY_BASIC_INFORMATION keyBasicInfo;
01915     PKEY_FULL_INFORMATION keyFullInfo;
01916     PKEY_VALUE_FULL_INFORMATION keyValueInfo;
01917     ULONG  length, profileSubKeys, i;
01918     UCHAR  valueBuffer[256];
01919     HANDLE hardwareProfiles=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01920     HANDLE profileEntry=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01921 
01922     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
01923 
01924     keyFullInfo  = (PKEY_FULL_INFORMATION)  valueBuffer;
01925     keyBasicInfo = (PKEY_BASIC_INFORMATION) valueBuffer;
01926     keyValueInfo = (PKEY_VALUE_FULL_INFORMATION) valueBuffer;
01927 
01928     *NewProfile = 0;
01929     *NewProfileNumber = OldProfileNumber;
01930 
01931     <span class="comment">//</span>
01932     <span class="comment">// Find the new profile number.</span>
01933     <span class="comment">//</span>
01934 
01935     <span class="keywordflow">while</span> (*NewProfileNumber &lt; 200) {
01936         (*NewProfileNumber)++;
01937 
01938         swprintf (nameBuffer, L<span class="stringliteral">"%04d"</span>, *NewProfileNumber);
01939         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;newProfileName, nameBuffer);
01940 
01941         InitializeObjectAttributes(&amp;attributes,
01942                                    &amp;newProfileName,
01943                                    OBJ_CASE_INSENSITIVE,
01944                                    Parent,
01945                                    NULL);
01946 
01947         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a> (NewProfile,
01948                             KEY_READ | KEY_WRITE,
01949                             &amp;attributes);
01950 
01951         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01952             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (*NewProfile);
01953 
01954         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (STATUS_OBJECT_NAME_NOT_FOUND == status) {
01955             status = STATUS_SUCCESS;
01956             <span class="keywordflow">break</span>;
01957 
01958         } <span class="keywordflow">else</span> {
01959             <span class="keywordflow">break</span>;
01960         }
01961 
01962     }
01963     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01964         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT) {
01965             KdPrint((<span class="stringliteral">"CM: CmpCloneHwProfile error finding new profile key %08lx\n"</span>, status));
01966         }
01967         <span class="keywordflow">goto</span> Exit;
01968     }
01969 
01970     <span class="comment">//</span>
01971     <span class="comment">// Get the security descriptor from the old key to create the new clone one.</span>
01972     <span class="comment">//</span>
01973 
01974     status = <a class="code" href="../../d9/d1/obse_8c.html#a2">NtQuerySecurityObject</a> (OldProfile,
01975                                     DACL_SECURITY_INFORMATION,
01976                                     NULL,
01977                                     0,
01978                                     &amp;securityLength);
01979 
01980     <span class="keywordflow">if</span> (STATUS_BUFFER_TOO_SMALL == status) {
01981 
01982         security = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a> (PagedPool, securityLength);
01983 
01984         <span class="keywordflow">if</span> (security != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01985             status = <a class="code" href="../../d9/d1/obse_8c.html#a2">NtQuerySecurityObject</a>(OldProfile,
01986                                            DACL_SECURITY_INFORMATION,
01987                                            security,
01988                                            securityLength,
01989                                            &amp;securityLength);
01990             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01991                 <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT) {
01992                     KdPrint((<span class="stringliteral">"CM: CmpCloneHwProfile"</span>
01993                              <span class="stringliteral">" - NtQuerySecurityObject failed %08lx\n"</span>, status));
01994                 }
01995                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(security);
01996                 security=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01997             }
01998         }
01999     } <span class="keywordflow">else</span> {
02000         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT) {
02001             KdPrint((<span class="stringliteral">"CM: CmpCloneHwProfile"</span>
02002                      <span class="stringliteral">" - NtQuerySecurityObject returned %08lx\n"</span>, status));
02003         }
02004         security=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02005     }
02006 
02007     <span class="comment">//</span>
02008     <span class="comment">// Create the new key</span>
02009     <span class="comment">//</span>
02010     InitializeObjectAttributes  (&amp;attributes,
02011                                  &amp;newProfileName,
02012                                  OBJ_CASE_INSENSITIVE,
02013                                  Parent,
02014                                  security);
02015 
02016     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a> (NewProfile,
02017                           KEY_READ | KEY_WRITE,
02018                           &amp;attributes,
02019                           0,
02020                           NULL,
02021                           0,
02022                           &amp;disposition);
02023 
02024     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != security) {
02025         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (security);
02026     }
02027     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02028         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT) {
02029             KdPrint((<span class="stringliteral">"CM: CmpCloneHwProfile couldn't create Clone %08lx\n"</span>,status));
02030         }
02031         <span class="keywordflow">goto</span> Exit;
02032     }
02033 
02034     <span class="comment">//</span>
02035     <span class="comment">// Check to make sure the key was created.  If it already exists,</span>
02036     <span class="comment">// something is wrong.</span>
02037     <span class="comment">//</span>
02038     <span class="keywordflow">if</span> (disposition != REG_CREATED_NEW_KEY) {
02039         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT) {
02040         <span class="comment">//  KdPrint(("CM: CmpCloneHwProfile: Clone tree already exists!\n"));</span>
02041         }
02042 
02043         <span class="comment">//</span>
02044         <span class="comment">// WARNNOTE:</span>
02045         <span class="comment">//      If somebody somehow managed to create a key in our way,</span>
02046         <span class="comment">//      they'll thwart duplication of the prestine.  Tough luck.</span>
02047         <span class="comment">//      Claim it worked and go on.</span>
02048         <span class="comment">//</span>
02049         status = STATUS_SUCCESS;
02050         <span class="keywordflow">goto</span> Exit;
02051     }
02052 
02053     <span class="comment">//</span>
02054     <span class="comment">// Create the IDConfigDB Entry</span>
02055     <span class="comment">//</span>
02056     swprintf (nameBuffer, L<span class="stringliteral">"Hardware Profiles\\%04d"</span>, *NewProfileNumber);
02057     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, nameBuffer);
02058 
02059     InitializeObjectAttributes  (&amp;attributes,
02060                                  &amp;name,
02061                                  OBJ_CASE_INSENSITIVE,
02062                                  IDConfigDB,
02063                                  NULL);
02064 
02065     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a> (&amp;IDConfigDBEntry,
02066                           KEY_READ | KEY_WRITE,
02067                           &amp;attributes,
02068                           0,
02069                           NULL,
02070                           0,
02071                           &amp;disposition);
02072 
02073     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02074         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT) {
02075             KdPrint((<span class="stringliteral">"CM: CmpCloneHwProfile couldn't create Clone %08lx\n"</span>,status));
02076         }
02077         IDConfigDBEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02078         <span class="keywordflow">goto</span> Exit;
02079     }
02080 
02081     <span class="comment">//</span>
02082     <span class="comment">// Determine the next PreferenceOrder for the new profile.  (The</span>
02083     <span class="comment">// PrefenceOrder for the new profile will be incrementally next from the</span>
02084     <span class="comment">// greatest PreferenceOrder value of all the current profiles; assumes</span>
02085     <span class="comment">// current set of PreferenceOrder values is incremental)</span>
02086     <span class="comment">//</span>
02087 
02088     <span class="comment">//</span>
02089     <span class="comment">// Open the Hardware Profiles key</span>
02090     <span class="comment">//</span>
02091     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, CM_HARDWARE_PROFILE_STR_HARDWARE_PROFILES);
02092 
02093     InitializeObjectAttributes (&amp;attributes,
02094                                 &amp;name,
02095                                 OBJ_CASE_INSENSITIVE,
02096                                 IDConfigDB,
02097                                 NULL);
02098     status = ZwOpenKey (&amp;hardwareProfiles,
02099                         KEY_READ,
02100                         &amp;attributes);
02101     
02102     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02103         hardwareProfiles = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02104         <span class="keywordflow">goto</span> Exit;
02105     }
02106 
02107     <span class="comment">//</span>
02108     <span class="comment">// Find the number of profile Sub Keys</span>
02109     <span class="comment">//</span>
02110     status = ZwQueryKey (hardwareProfiles,
02111                          KeyFullInformation,
02112                          valueBuffer,
02113                          <span class="keyword">sizeof</span> (valueBuffer),
02114                          &amp;length);
02115 
02116     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02117         <span class="keywordflow">goto</span> Exit;
02118     }
02119 
02120     <span class="comment">//</span>
02121     <span class="comment">// At very least, the Pristine and the new profile key we just created,</span>
02122     <span class="comment">// should be there. </span>
02123     <span class="comment">//</span>
02124     profileSubKeys = keyFullInfo-&gt;SubKeys;
02125     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (1 &lt; profileSubKeys);
02126 
02127     <span class="comment">//</span>
02128     <span class="comment">// Initialize the highest PreferenceOrder value found to -1.</span>
02129     <span class="comment">//</span>
02130     value = -1;
02131 
02132     <span class="comment">//</span>
02133     <span class="comment">// Iterrate the profiles</span>
02134     <span class="comment">//</span>
02135     <span class="keywordflow">for</span> (i = 0; i &lt; profileSubKeys; i++) {
02136     
02137         <span class="comment">//</span>
02138         <span class="comment">// Enumerate all profile subkeys, noting their PreferenceOrder values.</span>
02139         <span class="comment">//</span>
02140         status = ZwEnumerateKey (hardwareProfiles,
02141                                  i,
02142                                  KeyBasicInformation,
02143                                  valueBuffer,
02144                                  <span class="keyword">sizeof</span>(valueBuffer) - <span class="keyword">sizeof</span> (UNICODE_NULL), <span class="comment">//term 0</span>
02145                                  &amp;length);
02146         <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02147             <span class="keywordflow">break</span>;
02148         }
02149         
02150         <span class="comment">//</span>
02151         <span class="comment">// Zero-terminate the subkey name just in case.</span>
02152         <span class="comment">//</span>
02153         keyBasicInfo-&gt;Name[keyBasicInfo-&gt;NameLength/<span class="keyword">sizeof</span>(WCHAR)] = 0;
02154 
02155         <span class="comment">//</span>
02156         <span class="comment">// If this is the Pristine, or the NewProfile key, ignore it.</span>
02157         <span class="comment">//</span>
02158         <span class="keywordflow">if</span> ((!_wtoi(keyBasicInfo-&gt;Name)) || 
02159             ((ULONG)(_wtoi(keyBasicInfo-&gt;Name)) == *NewProfileNumber)) {
02160             <span class="keywordflow">continue</span>;
02161         }
02162         
02163         <span class="comment">//</span>
02164         <span class="comment">// Open this profile key</span>
02165         <span class="comment">//</span>
02166         name.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) keyBasicInfo-&gt;NameLength;
02167         name.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) keyBasicInfo-&gt;NameLength + <span class="keyword">sizeof</span> (UNICODE_NULL);
02168         name.Buffer = keyBasicInfo-&gt;Name;
02169 
02170         InitializeObjectAttributes (&amp;attributes,
02171                                     &amp;name,
02172                                     OBJ_CASE_INSENSITIVE,
02173                                     hardwareProfiles,
02174                                     NULL);
02175         status = ZwOpenKey (&amp;profileEntry,
02176                             KEY_READ,
02177                             &amp;attributes);
02178         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02179             profileEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02180             <span class="keywordflow">continue</span>;
02181         }
02182 
02183         <span class="comment">//</span>
02184         <span class="comment">// Extract The PreferenceOrder value for this Profile.</span>
02185         <span class="comment">//</span>
02186         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, CM_HARDWARE_PROFILE_STR_PREFERENCE_ORDER);
02187         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(profileEntry,
02188                                  &amp;name,
02189                                  KeyValueFullInformation,
02190                                  valueBuffer,
02191                                  <span class="keyword">sizeof</span>(valueBuffer),
02192                                  &amp;length);
02193 
02194         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status) || (keyValueInfo-&gt;Type != REG_DWORD)) {
02195             <span class="comment">//</span>
02196             <span class="comment">// No PreferenceOrder; continue on as best we can</span>
02197             <span class="comment">//</span>
02198             ZwClose(profileEntry);
02199             profileEntry=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02200             <span class="keywordflow">continue</span>;
02201         }
02202 
02203         <span class="comment">//</span>
02204         <span class="comment">// If this is a the highest PreferenceOrder so far, reassign value to</span>
02205         <span class="comment">// this PreferenceOrder, OR assign it this valid PreferenceOrder if</span>
02206         <span class="comment">// value is still unassigned.</span>
02207         <span class="comment">//</span>
02208         <span class="keywordflow">if</span> (((*(PULONG) ((PUCHAR)keyValueInfo + keyValueInfo-&gt;DataOffset)) &gt; value) ||
02209             (value == -1)) {
02210             value = (* (PULONG) ((PUCHAR)keyValueInfo + keyValueInfo-&gt;DataOffset));
02211         }
02212         
02213         ZwClose(profileEntry);
02214         profileEntry=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02215     }
02216 
02217     <span class="comment">//</span>
02218     <span class="comment">// Increment value one above the greatest PreferenceOrder found.</span>
02219     <span class="comment">// (If no other profiles were found, (value+=1) == 0, the most preferred</span>
02220     <span class="comment">// profile) </span>
02221     <span class="comment">//</span>
02222     value += 1;
02223 
02224     <span class="comment">//</span>
02225     <span class="comment">// Give the new profile a preference order.</span>
02226     <span class="comment">//</span>
02227     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, CM_HARDWARE_PROFILE_STR_PREFERENCE_ORDER);
02228     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (IDConfigDBEntry,
02229                             &amp;name,
02230                             0,
02231                             REG_DWORD,
02232                             &amp;value,
02233                             <span class="keyword">sizeof</span> (value));
02234 
02235     <span class="comment">//</span>
02236     <span class="comment">// Give the new profile a friendly name, based on the DockingState</span>
02237     <span class="comment">//</span>
02238     status = <a class="code" href="../../d6/d2/hwprofil_8c.html#a8">CmpCreateHwProfileFriendlyName</a>(IDConfigDB,
02239                                             DockingState,
02240                                             *NewProfileNumber,
02241                                             &amp;friendlyName);
02242 
02243     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02244         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, CM_HARDWARE_PROFILE_STR_FRIENDLY_NAME);
02245         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (IDConfigDBEntry,
02246                                 &amp;name,
02247                                 0,
02248                                 REG_SZ,
02249                                 friendlyName.Buffer,
02250                                 friendlyName.Length + <span class="keyword">sizeof</span>(UNICODE_NULL));
02251         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;friendlyName);
02252     }
02253 
02254     <span class="comment">//</span>
02255     <span class="comment">// Set the aliasable flag on the new "cloned profile" to be false</span>
02256     <span class="comment">//</span>
02257     value = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02258     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, CM_HARDWARE_PROFILE_STR_ALIASABLE);
02259     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (IDConfigDBEntry,
02260                             &amp;name,
02261                             0,
02262                             REG_DWORD,
02263                             &amp;value,
02264                             <span class="keyword">sizeof</span> (value));
02265 
02266     <span class="comment">//</span>
02267     <span class="comment">// Set the cloned profile on the new "cloned profile" to be true;</span>
02268     <span class="comment">//</span>
02269     value = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02270     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, CM_HARDWARE_PROFILE_STR_CLONED);
02271     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (IDConfigDBEntry,
02272                             &amp;name,
02273                             0,
02274                             REG_DWORD,
02275                             &amp;value,
02276                             <span class="keyword">sizeof</span> (value));
02277 
02278     <span class="comment">//</span>
02279     <span class="comment">// Set the HwProfileGuid for the brand new profile</span>
02280     <span class="comment">//</span>
02281 
02282     status = <a class="code" href="../../d5/d8/ex_8h.html#a324">ExUuidCreate</a> (&amp;uuid);
02283     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02284 
02285         status = <a class="code" href="../../d1/d7/guid_8c.html#a2">RtlStringFromGUID</a> (&amp;uuid, &amp;guidStr);
02286         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02287             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, CM_HARDWARE_PROFILE_STR_HW_PROFILE_GUID);
02288 
02289             status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (IDConfigDBEntry,
02290                                     &amp;name,
02291                                     0,
02292                                     REG_SZ,
02293                                     guidStr.Buffer,
02294                                     guidStr.MaximumLength);
02295 
02296             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;guidStr);
02297         } <span class="keywordflow">else</span> {
02298             <span class="comment">//</span>
02299             <span class="comment">// What's a fella to do?</span>
02300             <span class="comment">// let's just go on.</span>
02301             <span class="comment">//</span>
02302             status = STATUS_SUCCESS;
02303         }
02304 
02305     } <span class="keywordflow">else</span> {
02306         <span class="comment">//</span>
02307         <span class="comment">// let's just go on.</span>
02308         <span class="comment">//</span>
02309         status = STATUS_SUCCESS;
02310     }
02311 
02312 
02313     <span class="comment">//</span>
02314     <span class="comment">// Clone the key</span>
02315     <span class="comment">//</span>
02316     <span class="comment">// (Copied lovingly from CmpCloneControlSet)</span>
02317     <span class="comment">//</span>
02318     <span class="comment">//</span>
02319     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> (OldProfile,
02320                                         KEY_READ,
02321                                         CmpKeyObjectType,
02322                                         KernelMode,
02323                                         (PVOID *)(&amp;oldProfileKey),
02324                                         NULL);
02325 
02326     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02327         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT) {
02328             KdPrint((<span class="stringliteral">"CM: CmpCloneHWProfile: couldn't reference CurrentHandle %08lx\n"</span>,
02329                      status));
02330         }
02331         <span class="keywordflow">goto</span> Exit;
02332     }
02333 
02334     <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> (*NewProfile,
02335                                KEY_WRITE,
02336                                CmpKeyObjectType,
02337                                KernelMode,
02338                                (PVOID *)(&amp;newProfileKey),
02339                                NULL);
02340 
02341     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02342         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT) {
02343             KdPrint((<span class="stringliteral">"CM: CmpCloneHWProfile: couldn't reference CurrentHandle %08lx\n"</span>,
02344                      status));
02345         }
02346         <span class="keywordflow">goto</span> Exit;
02347     }
02348 
02349     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
02350 
02351     <span class="comment">//</span>
02352     <span class="comment">// Note: This copy tree command does not copy the values in the</span>
02353     <span class="comment">// root keys.  We are relying on this, since the values stored there</span>
02354     <span class="comment">// are things like "pristine" which we do not wish to have moved to the</span>
02355     <span class="comment">// new tree.</span>
02356     <span class="comment">//</span>
02357     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a118">CmpCopyTree</a>(oldProfileKey-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a>,
02358                     oldProfileKey-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o6">KeyCell</a>,
02359                     newProfileKey-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a>,
02360                     newProfileKey-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o6">KeyCell</a>)) {
02361         <span class="comment">//</span>
02362         <span class="comment">// Set the max subkey name property for the new target key.</span>
02363         <span class="comment">//</span>
02364         newProfileKey-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o17">KeyNode</a>-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o11">MaxNameLen</a> = 
02365             oldProfileKey-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o17">KeyNode</a>-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o11">MaxNameLen</a>;
02366         status = STATUS_SUCCESS;
02367     } <span class="keywordflow">else</span> {
02368         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT) {
02369             KdPrint((<span class="stringliteral">"CM: CmpCloneHwProfile: tree copy failed.\n"</span>));
02370         }
02371         status = STATUS_REGISTRY_CORRUPT;
02372     }
02373     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02374 
02375 
02376 Exit:
02377     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (OldProfile);
02378     <span class="keywordflow">if</span> (IDConfigDBEntry) {
02379         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (IDConfigDBEntry);
02380     }
02381     <span class="keywordflow">if</span> (hardwareProfiles) {
02382         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (hardwareProfiles);
02383     }
02384     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02385         <span class="keywordflow">if</span> (*NewProfile) {
02386             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (*NewProfile);
02387         }
02388     }    
02389 
02390     <span class="keywordflow">return</span> status;
02391 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a213" doxytag="cmp.h::CmpCloseKeyObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpCloseKeyObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>GrantedAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandleCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemHandleCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d9/cmclose_8c-source.html#l00028">28</a> of file <a class="el" href="../../d4/d9/cmclose_8c-source.html">cmclose.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00660">CmLockHive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00124">CmpLockRegistry()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00487">CmpPostNotify()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00257">CMS_NTAPI</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00264">CMS_POOL</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00662">CmUnlockHive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00486">KEY_BODY_TYPE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00492">_CM_KEY_BODY::KeyControlBlock</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00279">_CM_KEY_CONTROL_BLOCK::KeyHive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00493">_CM_KEY_BODY::NotifyBlock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a165">PCM_NOTIFY_BLOCK</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00563">_CM_NOTIFY_BLOCK::PostList</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00491">_CM_KEY_BODY::Type</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01074">CmpCreateObjectTypes()</a>.
<p>
<pre class="fragment"><div>00037                    :
00038 
00039     This routine interfaces to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NT Object <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a79">Manager</a>.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked when
00040     a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> object (or Key Root object) <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> closed.
00041 
00042     It's function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to <span class="keywordflow">do</span> cleanup processing by waking up any notifies
00043     pending on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle.  This keeps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key object from hanging around
00044     forever because a synchronous notify <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> stuck on <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> somewhere.
00045 
00046     All other cleanup, in particular, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> freeing of storage, will be
00047     done in <a class="code" href="../../d1/d1/cmdelete_8c.html#a0">CmpDeleteKeyObject</a>.
00048 
00049 Arguments:
00050 
00051     Process - ignored
00052 
00053     Object - supplies a pointer to a KeyRoot or <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>, thus -&gt; KEY_BODY.
00054 
00055     GrantedAccess, ProcessHandleCount, SystemHandleCount - ignored
00056 
00057 Return Value:
00058 
00059     NONE.
00060 
00061 --*/
00062 {
00063     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>        KeyBody;
00064     <a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a>    NotifyBlock;
00065 
00066     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00067     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_NTAPI|CMS_POOL) {
00068         KdPrint((<span class="stringliteral">"CmpCloseKeyObject: Object = %08lx\n"</span>, Object));
00069     }
00070 
00071     <span class="keywordflow">if</span>( SystemHandleCount &gt; 1 ) {
00072         <span class="comment">//</span>
00073         <span class="comment">// There are still has open handles on this key. Do nothing</span>
00074         <span class="comment">//</span>
00075         <span class="keywordflow">return</span>;
00076     }
00077 
00078     <a class="code" href="../../d6/d3/cmwraper_8c.html#a14">CmpLockRegistry</a>();
00079 
00080     KeyBody = (<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)Object;
00081 
00082     <span class="comment">//</span>
00083     <span class="comment">// Check the type, it will be something else if we are closing a predefined</span>
00084     <span class="comment">// handle key</span>
00085     <span class="comment">//</span>
00086     <span class="keywordflow">if</span> (KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o0">Type</a> == <a class="code" href="../../d1/d2/cmp_8h.html#a78">KEY_BODY_TYPE</a>) {
00087         <span class="comment">//</span>
00088         <span class="comment">// Clean up any outstanding notifies attached to the KeyBody</span>
00089         <span class="comment">//</span>
00090         <span class="keywordflow">if</span> (KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o2">NotifyBlock</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00091             <span class="comment">//</span>
00092             <span class="comment">// Post all PostBlocks waiting on the NotifyBlock</span>
00093             <span class="comment">//</span>
00094             NotifyBlock = KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o2">NotifyBlock</a>;
00095             <span class="keywordflow">if</span> (IsListEmpty(&amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o4">PostList</a>)) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00096                 <a class="code" href="../../d1/d2/cmp_8h.html#a94">CmLockHive</a>((<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)(KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a>));
00097                 <a class="code" href="../../d1/d2/cmp_8h.html#a284">CmpPostNotify</a>(NotifyBlock,
00098                               NULL,
00099                               0,
00100                               STATUS_NOTIFY_CLEANUP,
00101                               NULL);
00102                 <a class="code" href="../../d1/d2/cmp_8h.html#a95">CmUnlockHive</a>((<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)(KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a>));
00103             }
00104         }
00105     }
00106 
00107     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00108     <span class="keywordflow">return</span>;
00109 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a319" doxytag="cmp.h::CmpCompareCompressedName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONG CmpCompareCompressedName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>SearchName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>CompressedName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NameLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/cmname_8c-source.html#l00195">195</a> of file <a class="el" href="../../d0/d1/cmname_8c-source.html">cmname.c</a>.
<p>
References <a class="el" href="../../d7/d5/nls_8c-source.html#l01178">RtlUpcaseUnicodeChar()</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01853">CmpCacheLookup()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00722">CmpDoCompareKeyName()</a>, <a class="el" href="../../d5/d2/cmtree_8c-source.html#l00033">CmpFindNameInList()</a>, <a class="el" href="../../d5/d2/cmtree_8c-source.html#l00309">CmpFindValueByNameFromCache()</a>, and <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00368">CmpGetNameControlBlock()</a>.
<p>
<pre class="fragment"><div>00203                    :
00204 
00205     Compares a compressed registry string to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> string.  Does a <span class="keywordflow">case</span>-insensitive
00206     comparison.
00207 
00208 Arguments:
00209 
00210     SearchName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> string to be compared
00211 
00212     CompressedName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> compressed string to be compared
00213 
00214     NameLength - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> compressed string
00215 
00216 Return Value:
00217 
00218     0 = SearchName == CompressedName (of Cell)
00219 
00220     &lt; 0 = SearchName &lt; CompressedName
00221 
00222     &gt; 0 = SearchName &gt; CompressedName
00223 
00224 --*/
00225 
00226 {
00227     WCHAR *s1;
00228     UCHAR *s2;
00229     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> n1, n2;
00230     WCHAR c1;
00231     WCHAR c2;
00232     LONG cDiff;
00233 
00234     s1 = SearchName-&gt;Buffer;
00235     s2 = (UCHAR *)CompressedName;
00236     n1 = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> )(SearchName-&gt;Length / <span class="keyword">sizeof</span>(WCHAR));
00237     n2 = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> )(NameLength);
00238     <span class="keywordflow">while</span> (n1 &amp;&amp; n2) {
00239         c1 = *s1++;
00240         c2 = (WCHAR)(*s2++);
00241 
00242         c1 = <a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(c1);
00243         c2 = <a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(c2);
00244 
00245         <span class="keywordflow">if</span> ((cDiff = ((LONG)c1 - (LONG)c2)) != 0) {
00246             <span class="keywordflow">return</span>( cDiff );
00247         }
00248 
00249         n1--;
00250         n2--;
00251     }
00252 
00253     <span class="keywordflow">return</span>( n1 - n2 );
00254 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a320" doxytag="cmp.h::CmpCompressedNameSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> CmpCompressedNameSize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PWCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Name</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/cmname_8c-source.html#l00121">121</a> of file <a class="el" href="../../d0/d1/cmname_8c-source.html">cmname.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00538">CmpAddDriverToList()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00895">CmpAddSubKey()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01284">CmpFindProfileOption()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01515">CmpInitializeKeyNameString()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01582">CmpInitializeValueNameString()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01608">CmpMarkIndexDirty()</a>, and <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01714">CmpRemoveSubKey()</a>.
<p>
<pre class="fragment"><div>00128                    :
00129 
00130     Computes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unicode string that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given compressed name
00131     expands into.
00132 
00133 Arguments:
00134 
00135     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> compressed name.
00136 
00137     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length in bytes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> compressed name
00138 
00139 Return Value:
00140 
00141     The number of bytes of storage required to hold <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> expanded name.
00142 
00143 --*/
00144 
00145 {
00146     <span class="keywordflow">return</span>((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Length*<span class="keyword">sizeof</span>(WCHAR));
00147 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a246" doxytag="cmp.h::CmpComputeGlobalQuotaAllowed" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpComputeGlobalQuotaAllowed           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00293">293</a> of file <a class="el" href="../../d6/d0/cmgquota_8c-source.html">cmgquota.c</a>.
<p>
References <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00051">CM_DEFAULT_RATIO</a>, <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00052">CM_LIMIT_RATIO</a>, <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00053">CM_MINIMUM_GLOBAL_QUOTA</a>, <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00059">CM_REGISTRY_WARNING_LEVEL</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00422">CM_WRAP_LIMIT</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00051">CmpGlobalQuota</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00038">CmpGlobalQuotaWarning</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00041">CmRegistrySizeLimit</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00042">CmRegistrySizeLimitLength</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00043">CmRegistrySizeLimitType</a>, and <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00074">MmSizeOfPagedPoolInBytes</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>.
<p>
<pre class="fragment"><div>00299                    :
00300 
00301     Compute <a class="code" href="../../d7/d0/cmdat2_8c.html#a4">CmpGlobalQuota</a> based on:
00302         (a) <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> of paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>
00303         (b) Explicit user registry commands to set registry GQ
00304 
00305 Return Value:
00306 
00307     NONE.
00308 
00309 --*/
00310 
00311 {
00312     ULONG   PagedLimit;
00313 
00314     PagedLimit = <a class="code" href="../../d5/d1/cmgquota_8c.html#a1">CM_LIMIT_RATIO</a>(MmSizeOfPagedPoolInBytes);
00315 
00316     <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d0/cmdat2_8c.html#a1">CmRegistrySizeLimitLength</a> != 4) ||
00317         (<a class="code" href="../../d7/d0/cmdat2_8c.html#a2">CmRegistrySizeLimitType</a> != REG_DWORD) ||
00318         (<a class="code" href="../../d7/d0/cmdat2_8c.html#a0">CmRegistrySizeLimit</a> == 0))
00319     {
00320         <span class="comment">//</span>
00321         <span class="comment">// If no value at all, or value of wrong type, or set to</span>
00322         <span class="comment">// zero, use internally computed default</span>
00323         <span class="comment">//</span>
00324         <a class="code" href="../../d7/d0/cmdat2_8c.html#a4">CmpGlobalQuota</a> = <a class="code" href="../../d8/d0/cmdat3_8c.html#a18">MmSizeOfPagedPoolInBytes</a> / <a class="code" href="../../d5/d1/cmgquota_8c.html#a0">CM_DEFAULT_RATIO</a>;
00325 
00326     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a0">CmRegistrySizeLimit</a> &gt;= PagedLimit) {
00327         <span class="comment">//</span>
00328         <span class="comment">// If more than computed upper bound, use computed upper bound</span>
00329         <span class="comment">//</span>
00330         <a class="code" href="../../d7/d0/cmdat2_8c.html#a4">CmpGlobalQuota</a> = PagedLimit;
00331 
00332     } <span class="keywordflow">else</span> {
00333         <span class="comment">//</span>
00334         <span class="comment">// Use the set size</span>
00335         <span class="comment">//</span>
00336         <a class="code" href="../../d7/d0/cmdat2_8c.html#a4">CmpGlobalQuota</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a0">CmRegistrySizeLimit</a>;
00337 
00338     }
00339 
00340     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a4">CmpGlobalQuota</a> &gt; <a class="code" href="../../d1/d2/cmp_8h.html#a69">CM_WRAP_LIMIT</a>) {
00341         <a class="code" href="../../d7/d0/cmdat2_8c.html#a4">CmpGlobalQuota</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a69">CM_WRAP_LIMIT</a>;
00342     }
00343     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a4">CmpGlobalQuota</a> &lt; <a class="code" href="../../d5/d1/cmgquota_8c.html#a2">CM_MINIMUM_GLOBAL_QUOTA</a>) {
00344         <a class="code" href="../../d7/d0/cmdat2_8c.html#a4">CmpGlobalQuota</a> = <a class="code" href="../../d5/d1/cmgquota_8c.html#a2">CM_MINIMUM_GLOBAL_QUOTA</a>;
00345     }
00346 
00347     <a class="code" href="../../d8/d9/cmapi_8c.html#a8">CmpGlobalQuotaWarning</a> = <a class="code" href="../../d5/d1/cmgquota_8c.html#a3">CM_REGISTRY_WARNING_LEVEL</a> * (<a class="code" href="../../d7/d0/cmdat2_8c.html#a4">CmpGlobalQuota</a> / 100);
00348 
00349     <span class="keywordflow">return</span>;
00350 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a327" doxytag="cmp.h::CmpConstructName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PUNICODE_STRING CmpConstructName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>kcb</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00699">699</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
References <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00215">_CM_NAME_CONTROL_BLOCK::Compressed</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d5/d5/regext_8c-source.html#l00458">kcb()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00223">_CM_NAME_CONTROL_BLOCK::Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00286">_CM_KEY_CONTROL_BLOCK::NameBlock</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00222">_CM_NAME_CONTROL_BLOCK::NameLength</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00285">_CM_KEY_CONTROL_BLOCK::ParentKcb</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00281">PROTECTED_POOL</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01476">CmpGetSymbolicLink()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00484">CmpLoadHiveVolatile()</a>, <a class="el" href="../../d6/d1/cmquery_8c-source.html#l00028">CmpQueryKeyName()</a>, and <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00647">CmQueryKey()</a>.
<p>
<pre class="fragment"><div>00704                    :
00705 
00706     Construct <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name given a <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.
00707 
00708 Arguments:
00709 
00710     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> - Kcb <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key
00711 
00712 Return Value:
00713 
00714     Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unicode string constructed.  
00715     Caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> responsible to free <span class="keyword">this</span> storage space.
00716 
00717 --*/
00718 {
00719     PUNICODE_STRING FullName;
00720     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> TmpKcb;
00721     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Length;
00722     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> size;
00723     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> i;
00724     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> BeginPosition;
00725     WCHAR *w1, *w2;
00726     UCHAR *u2;
00727 
00728     <span class="comment">//</span>
00729     <span class="comment">// Calculate the total string length.</span>
00730     <span class="comment">//</span>
00731     Length = 0;
00732     TmpKcb = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00733     <span class="keywordflow">while</span> (TmpKcb) {
00734         <span class="keywordflow">if</span> (TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o0">Compressed</a>) {
00735             Length += TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a> * <span class="keyword">sizeof</span>(WCHAR);
00736         } <span class="keywordflow">else</span> {
00737             Length += TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a>; 
00738         }
00739         <span class="comment">//</span>
00740         <span class="comment">// Add the sapce for OBJ_NAME_PATH_SEPARATOR;</span>
00741         <span class="comment">//</span>
00742         Length += <span class="keyword">sizeof</span>(WCHAR);
00743 
00744         TmpKcb = TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o9">ParentKcb</a>;
00745     }
00746 
00747     <span class="comment">//</span>
00748     <span class="comment">// Allocate the pool for the unicode string</span>
00749     <span class="comment">//</span>
00750     size = <span class="keyword">sizeof</span>(UNICODE_STRING) + Length;
00751 
00752     FullName = (PUNICODE_STRING) <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(PagedPool,
00753                                                        size,
00754                                                        CM_NAME_TAG | PROTECTED_POOL);
00755 
00756     <span class="keywordflow">if</span> (FullName) {
00757         FullName-&gt;Buffer = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> *) ((ULONG_PTR) FullName + <span class="keyword">sizeof</span>(UNICODE_STRING));
00758         FullName-&gt;Length = Length;
00759         FullName-&gt;MaximumLength = Length;
00760 
00761         <span class="comment">//</span>
00762         <span class="comment">// Now fill the name into the buffer.</span>
00763         <span class="comment">//</span>
00764         TmpKcb = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00765         BeginPosition = Length;
00766 
00767         <span class="keywordflow">while</span> (TmpKcb) {
00768             <span class="comment">//</span>
00769             <span class="comment">// Calculate the begin position of each subkey. Then fill in the char.</span>
00770             <span class="comment">//</span>
00771             <span class="comment">//</span>
00772             <span class="keywordflow">if</span> (TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o0">Compressed</a>) {
00773                 BeginPosition -= (TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a> + 1) * <span class="keyword">sizeof</span>(WCHAR);
00774                 w1 = &amp;(FullName-&gt;Buffer[BeginPosition/<span class="keyword">sizeof</span>(WCHAR)]);
00775                 *w1 = OBJ_NAME_PATH_SEPARATOR;
00776                 w1++;
00777 
00778                 u2 = (UCHAR *) &amp;(TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o6">Name</a>[0]);
00779 
00780                 <span class="keywordflow">for</span> (i=0; i&lt;TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a>; i++) {
00781                     *w1 = (WCHAR)(*u2);
00782                     w1++;
00783                     u2++;
00784                 }
00785             } <span class="keywordflow">else</span> {
00786                 BeginPosition -= (TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a> + <span class="keyword">sizeof</span>(WCHAR));
00787                 w1 = &amp;(FullName-&gt;Buffer[BeginPosition/<span class="keyword">sizeof</span>(WCHAR)]);
00788                 *w1 = OBJ_NAME_PATH_SEPARATOR;
00789                 w1++;
00790 
00791                 w2 = TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o6">Name</a>;
00792 
00793                 <span class="keywordflow">for</span> (i=0; i&lt;TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a>; i=i+<span class="keyword">sizeof</span>(WCHAR)) {
00794                     *w1 = *w2;
00795                     w1++;
00796                     w2++;
00797                 }
00798             }
00799             TmpKcb = TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o9">ParentKcb</a>;
00800         }
00801     }
00802     <span class="keywordflow">return</span> (FullName);
00803 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a266" doxytag="cmp.h::CmpCopyCell" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> CmpCopyCell           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceCell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01009">1009</a> of file <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html">cmtrecpy.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00261">CMS_SAVRES</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00386">HvAllocateCell()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, and <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00335">HvGetCellSize()</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00686">CmpCopyKeyPartial()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00895">CmpCopyValue()</a>, and <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01338">CmpSyncKeyValues()</a>.
<p>
<pre class="fragment"><div>01017                    :
01018 
01019     <a class="code" href="../../d9/d0/cmdata_8h.html#a104a97">Copy</a> SourceHive.SourceCell to TargetHive.TargetCell.
01020 
01021 Arguments:
01022 
01023     SourceHive - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> source
01024 
01025     SourceCell - index of cell to copy from
01026 
01027     TargetHive - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> target
01028 
01029     Type - storage <a class="code" href="../../d4/d4/iafptrap_8c.html#a9">type</a> (stable or <span class="keyword">volatile</span>) of <span class="keyword">new</span> cell
01030 
01031 Return Value:
01032 
01033     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> of <span class="keyword">new</span> cell, or <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a> <span class="keywordflow">if</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
01034 
01035 --*/
01036 {
01037     PVOID   psource;
01038     PVOID   ptarget;
01039     ULONG   size;
01040     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newcell;
01041 
01042     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_SAVRES) {
01043         KdPrint((<span class="stringliteral">"CmpCopyCell:\n"</span>));
01044         KdPrint((<span class="stringliteral">"\tSourceHive=%08lx SourceCell=%08lx\n"</span>,SourceHive,SourceCell));
01045         KdPrint((<span class="stringliteral">"\tTargetHive=%08lx\n"</span>,TargetHive));
01046     }
01047 
01048     psource = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SourceHive, SourceCell);
01049     size = <a class="code" href="../../d8/d0/hivecell_8c.html#a15">HvGetCellSize</a>(SourceHive, psource);
01050 
01051     newcell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(TargetHive, size, Type);
01052     <span class="keywordflow">if</span> (newcell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01053         <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01054     }
01055 
01056     ptarget = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(TargetHive, newcell);
01057 
01058     RtlCopyMemory(ptarget, psource, size);
01059 
01060     <span class="keywordflow">return</span> newcell;
01061 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a318" doxytag="cmp.h::CmpCopyCompressedName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpCopyCompressedName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PWCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Destination</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DestinationLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Source</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/cmname_8c-source.html#l00151">151</a> of file <a class="el" href="../../d0/d1/cmname_8c-source.html">cmname.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00538">CmpAddDriverToList()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00895">CmpAddSubKey()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01284">CmpFindProfileOption()</a>, <a class="el" href="../../d7/d0/cmhvlist_8c-source.html#l00251">CmpGetHiveName()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01515">CmpInitializeKeyNameString()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01582">CmpInitializeValueNameString()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00484">CmpLoadHiveVolatile()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01608">CmpMarkIndexDirty()</a>, <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00110">CmpQueryKeyData()</a>, <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00531">CmpQueryKeyValueData()</a>, and <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01714">CmpRemoveSubKey()</a>.
<p>
<pre class="fragment"><div>00160                    :
00161 
00162     Copies a compressed name from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry and expands <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> to <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>.
00163 
00164 Arguments:
00165 
00166     Destination - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> destination <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> buffer
00167 
00168     DestinationLength - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> destination buffer in bytes
00169 
00170     Source - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> compressed string.
00171 
00172     SourceLength - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> compressed string in bytes
00173 
00174 Return Value:
00175 
00176     None.
00177 
00178 --*/
00179 
00180 {
00181     ULONG i;
00182     ULONG Chars;
00183 
00184     Chars = (DestinationLength/<span class="keyword">sizeof</span>(WCHAR) &lt; SourceLength)
00185              ? DestinationLength/<span class="keyword">sizeof</span>(WCHAR)
00186              : SourceLength;
00187 
00188     <span class="keywordflow">for</span> (i=0;i&lt;Chars;i++) {
00189         Destination[i] = (WCHAR)(((PUCHAR)Source)[i]);
00190     }
00191 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a268" doxytag="cmp.h::CmpCopyKeyPartial" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> CmpCopyKeyPartial           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceKeyCell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Parent</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>CopyValues</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00686">686</a> of file <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html">cmtrecpy.c</a>.
<p>
References <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00464">_CM_KEY_NODE::Class</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00476">_CM_KEY_NODE::ClassLength</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00697">CmpAssignSecurityDescriptor()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01009">CmpCopyCell()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00895">CmpCopyValue()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00261">CMS_SAVRES</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00332">_CHILD_LIST::Count</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00526">_CM_KEY_SECURITY::Descriptor</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00386">HvAllocateCell()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00440">KEY_COMP_NAME</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00434">KEY_HIVE_ENTRY</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00437">KEY_NO_DELETE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00541">_CELL_DATA::_u::KeyList</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00537">_CELL_DATA::_u::KeyNode</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00539">_CELL_DATA::_u::KeySecurity</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00333">_CHILD_LIST::List</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00453">_CM_KEY_NODE::Parent</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00463">_CM_KEY_NODE::Security</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00454">_CM_KEY_NODE::SubKeyCounts</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00457">_CM_KEY_NODE::SubKeyLists</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00458">_CM_KEY_NODE::ValueList</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00251">CmpCopySyncTree2()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00484">CmpLoadHiveVolatile()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00097">CmRestoreKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00862">CmSaveKey()</a>, and <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01047">CmSaveMergedKeys()</a>.
<p>
<pre class="fragment"><div>00695                    :
00696 
00697     <a class="code" href="../../d9/d0/cmdata_8h.html#a104a97">Copy</a> a key body and all of its values, but NOT its subkeylist or
00698     subkey entries.  SubKeyList.Count will be set to 0.
00699 
00700 Arguments:
00701 
00702     SourceHive - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> source
00703 
00704     SourceKeyCell - value entry being copied
00705 
00706     TargetHive - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> target
00707 
00708     Parent - parent value to set into newly created key body
00709 
00710     CopyValues - <span class="keywordflow">if</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> value entries will not be copied, <span class="keywordflow">if</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, they will
00711 
00712 Return Value:
00713 
00714     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> of body of <span class="keyword">new</span> key entry, or <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>
00715         <span class="keywordflow">if</span> some error.
00716 
00717 --*/
00718 {
00719     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00720     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newkey = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00721     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newclass = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00722     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newsecurity = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00723     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newlist = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00724     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newvalue;
00725     BOOLEAN success = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00726     ULONG   i;
00727     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> psrckey;
00728     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> ptarkey;
00729     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> psrclist;
00730     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> ptarlist;
00731     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> psrcsecurity;
00732     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> security;
00733     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <span class="keyword">class</span>;
00734     ULONG   classlength;
00735     ULONG   count;
00736     ULONG   Type;
00737 
00738     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_SAVRES) {
00739         KdPrint((<span class="stringliteral">"CmpCopyKeyPartial:\n"</span>));
00740         KdPrint((<span class="stringliteral">"\tSHive=%08lx SCell=%08lx\n"</span>,SourceHive,SourceKeyCell));
00741         KdPrint((<span class="stringliteral">"\tTHive=%08lx\n"</span>,TargetHive));
00742     }
00743 
00744 
00745     <span class="comment">//</span>
00746     <span class="comment">// get description of source</span>
00747     <span class="comment">//</span>
00748     <span class="keywordflow">if</span> (Parent == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00749         <span class="comment">//</span>
00750         <span class="comment">// This is a root node we are creating, so don't make it volatile.</span>
00751         <span class="comment">//</span>
00752         Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>;
00753     } <span class="keywordflow">else</span> {
00754         Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Parent);
00755     }
00756     psrckey = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SourceHive, SourceKeyCell);
00757     security = psrckey-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a>;
00758     <span class="keyword">class </span>= psrckey-&gt;u.KeyNode.Class;
00759     classlength = psrckey-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a>;
00760 
00761     <span class="comment">//</span>
00762     <span class="comment">// Allocate and copy the body</span>
00763     <span class="comment">//</span>
00764     newkey = <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a13">CmpCopyCell</a>(SourceHive, SourceKeyCell, TargetHive, Type);
00765     <span class="keywordflow">if</span> (newkey == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00766         <span class="keywordflow">goto</span> DoFinally;
00767     }
00768 
00769     <span class="comment">//</span>
00770     <span class="comment">// Allocate and copy class</span>
00771     <span class="comment">//</span>
00772     <span class="keywordflow">if</span> (classlength &gt; 0) {
00773         newclass = <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a13">CmpCopyCell</a>(SourceHive, <span class="keyword">class</span>, TargetHive, Type);
00774         <span class="keywordflow">if</span> (newclass == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00775             <span class="keywordflow">goto</span> DoFinally;
00776         }
00777     }
00778 
00779     <span class="comment">//</span>
00780     <span class="comment">// Fill in the target body</span>
00781     <span class="comment">//</span>
00782     ptarkey = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(TargetHive, newkey);
00783 
00784     ptarkey-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o10">Class</a> = newclass;
00785     ptarkey-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00786     ptarkey-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00787     ptarkey-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00788     ptarkey-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] = 0;
00789     ptarkey-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>] = 0;
00790     ptarkey-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a> = Parent;
00791 
00792     ptarkey-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> = (psrckey-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>);
00793     <span class="keywordflow">if</span> (Parent == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00794         ptarkey-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/cmdata_8h.html#a29">KEY_HIVE_ENTRY</a> + <a class="code" href="../../d9/d0/cmdata_8h.html#a30">KEY_NO_DELETE</a>;
00795     }
00796 
00797     <span class="comment">//</span>
00798     <span class="comment">// Allocate and copy security</span>
00799     <span class="comment">//</span>
00800     psrcsecurity = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SourceHive, security);
00801 
00802     status = <a class="code" href="../../d7/d2/cmse_8c.html#a10">CmpAssignSecurityDescriptor</a>(TargetHive,
00803                                          newkey,
00804                                          ptarkey,
00805                                          &amp;(psrcsecurity-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o2">KeySecurity</a>.<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o6">Descriptor</a>));
00806     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00807         <span class="keywordflow">goto</span> DoFinally;
00808     }
00809 
00810 
00811     <span class="comment">//</span>
00812     <span class="comment">// Set up the value list</span>
00813     <span class="comment">//</span>
00814     count = psrckey-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a>;
00815 
00816     <span class="keywordflow">if</span> ((count == 0) || (CopyValues == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00817         ptarkey-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00818         ptarkey-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> = 0;
00819         success = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00820     } <span class="keywordflow">else</span> {
00821 
00822         psrclist = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SourceHive, psrckey-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>);
00823 
00824         newlist = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(
00825                     TargetHive,
00826                     count * <span class="keyword">sizeof</span>(HCELL_INDEX),
00827                     Type
00828                     );
00829         <span class="keywordflow">if</span> (newlist == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00830             <span class="keywordflow">goto</span> DoFinally;
00831         }
00832         ptarkey-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a> = newlist;
00833         ptarlist = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(TargetHive, newlist);
00834 
00835 
00836         <span class="comment">//</span>
00837         <span class="comment">// Copy the values</span>
00838         <span class="comment">//</span>
00839         <span class="keywordflow">for</span> (i = 0; i &lt; count; i++) {
00840 
00841             newvalue = <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a12">CmpCopyValue</a>(
00842                             SourceHive,
00843                             psrclist-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o4">KeyList</a>[i],
00844                             TargetHive,
00845                             Type
00846                             );
00847 
00848             <span class="keywordflow">if</span> (newvalue != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00849 
00850                 ptarlist-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o4">KeyList</a>[i] = newvalue;
00851 
00852             } <span class="keywordflow">else</span> {
00853 
00854                 <span class="keywordflow">for</span> (; i &gt; 0; i--) {
00855                     <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(
00856                         TargetHive,
00857                         ptarlist-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o4">KeyList</a>[i - 1]
00858                         );
00859                 }
00860                 <span class="keywordflow">goto</span> DoFinally;
00861             }
00862         }
00863         success = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00864     }
00865 
00866 DoFinally:
00867     <span class="keywordflow">if</span> (success == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00868 
00869         <span class="keywordflow">if</span> (newlist != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00870             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(TargetHive, newlist);
00871         }
00872 
00873         <span class="keywordflow">if</span> (newsecurity != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00874             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(TargetHive, newsecurity);
00875         }
00876 
00877         <span class="keywordflow">if</span> (newclass != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00878             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(TargetHive, newclass);
00879         }
00880 
00881         <span class="keywordflow">if</span> (newkey != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00882             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(TargetHive, newkey);
00883         }
00884 
00885         <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00886 
00887     } <span class="keywordflow">else</span> {
00888 
00889         <span class="keywordflow">return</span> newkey;
00890     }
00891 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a317" doxytag="cmp.h::CmpCopyName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> CmpCopyName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Destination</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Source</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/cmname_8c-source.html#l00074">74</a> of file <a class="el" href="../../d0/d1/cmname_8c-source.html">cmname.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, and <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00633">_HHIVE::Version</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01252">CmpCreateLinkNode()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01328">CmpCreateRootNode()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00226">CmpDoCreateChild()</a>, and <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01619">CmpSetValueKeyNew()</a>.
<p>
<pre class="fragment"><div>00082                    :
00083 
00084     Copies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given unicode name into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry, applying any relevant compression
00085     at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same time.
00086 
00087 Arguments:
00088 
00089     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure (For version checking)
00090 
00091     Destination - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> destination of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given string.
00092 
00093     Source - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unicode string to copy into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry.
00094 
00095 Return Value:
00096 
00097     Number of bytes of storage copied
00098 
00099 --*/
00100 
00101 {
00102     ULONG i;
00103 
00104     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o21">Version</a>==1) {
00105         RtlCopyMemory(Destination,Source-&gt;Buffer, Source-&gt;Length);
00106         <span class="keywordflow">return</span>(Source-&gt;Length);
00107     }
00108 
00109     <span class="keywordflow">for</span> (i=0;i&lt;Source-&gt;Length/<span class="keyword">sizeof</span>(WCHAR);i++) {
00110         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Source-&gt;Buffer[i] &gt; (UCHAR)-1) {
00111             RtlCopyMemory(Destination,Source-&gt;Buffer, Source-&gt;Length);
00112             <span class="keywordflow">return</span>(Source-&gt;Length);
00113         }
00114         ((PUCHAR)Destination)[i] = (UCHAR)(Source-&gt;Buffer[i]);
00115     }
00116     <span class="keywordflow">return</span>(Source-&gt;Length / <span class="keyword">sizeof</span>(WCHAR));
00117 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a269" doxytag="cmp.h::CmpCopySyncTree" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpCopySyncTree           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceCell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetCell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>CopyVolatile</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d9/d0/cmdata_8h.html#a66">CMP_COPY_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CopyType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00127">127</a> of file <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html">cmtrecpy.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00038">CMP_INITIAL_STACK_SIZE</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00251">CmpCopySyncTree2()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00261">CMS_SAVRES</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, and <a class="el" href="../../d2/d3/cmtrecpy_8c.html#a2">PCMP_COPY_STACK_ENTRY</a>.
<p>
<pre class="fragment"><div>00137                    :
00138 
00139     This routine can perform two distinct (yet similar) tasks:
00140     a tree copy or a tree synchronization (sync). Which task
00141     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> performed <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> determined by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TreeSync parameter.
00142     
00143     For both operations:
00144     --------------------
00145     
00146     The source root key and target root key must exist in advance.
00147     These root nodes and their value entries will NOT be copied/synced.                
00148     
00149     NOTE:   <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a> keys are <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> copied/synced <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CopyVolatile
00150             parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set to <span class="keyword">true</span>.
00151 
00152     
00153     For a tree copy:
00154     ----------------
00155     
00156     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> tree <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> copied from source to destination. The subkeys
00157     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source root key and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full trees under those
00158     subkeys will be copied to a <span class="keyword">new</span> tree at target root key.
00159                            
00160     NOTE:   If <span class="keyword">this</span> call fails part way through, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will NOT undo
00161             any successfully completed key copies, thus a partial
00162             tree copy CAN occur.
00163             
00164     For a tree sync:
00165     ----------------
00166     
00167     The target tree <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keyword">synchronized</span> with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source tree. It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> 
00168     assumed that <span class="keywordflow">for</span> a certain period of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> time <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target tree
00169     has remained unmodified <span class="keywordflow">while</span> modifications may have been <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a>
00170     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source tree. During a sync, any such modifications
00171     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source tree are <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target tree. Thus, at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00172     end of a successful sync, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target tree <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> identical to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00173     source tree.
00174     
00175     Since <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> things that have changed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source tree 
00176     are modified in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target tree, a sync operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> far
00177     more efficient than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">delete</span>/copy operations necessary
00178     to accomplish <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same results.
00179     
00180     NOTE: It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed that no open handles are held
00181           on any target tree keys. Registry in-memory data
00182           structures may be corrupted <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not <span class="keyword">true</span>.
00183         
00184 Arguments:
00185 
00186     SourceHive - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> source
00187 
00188     SourceCell - index of cell at root of tree to copy/sync
00189 
00190     TargetHive - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> target
00191 
00192     TargetCell - pointer to cell at root of target tree
00193     
00194     CopyVolatile - indicates whether <span class="keyword">volatile</span> keys should be
00195                    copied/synced.
00196                    
00197     CopyType - indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> copy operation:
00198                 <a class="code" href="../../d9/d0/cmdata_8h.html#a104a97">Copy</a>  - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> copy <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> requested
00199                 <a class="code" href="../../d9/d0/cmdata_8h.html#a104a98">Sync</a>  - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> sync <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> requested
00200                 <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a91">Merge</a> - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> merge <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> requested i.e.:
00201                     1. <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target nodes that are not present on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source tree are not
00202                     deleted.
00203                     2. <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target nodes that are present in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source tree gets overrided
00204                     no matter what <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LastWriteTime value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>.
00205 Return Value:
00206 
00207     BOOLEAN - Result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
00208         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
00209         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tree copy/sync was not completed (though more than 0
00210                 keys may have been copied/synced)
00211 
00212 --*/
00213 {
00214     BOOLEAN result;
00215     <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a2">PCMP_COPY_STACK_ENTRY</a>   CmpCopyStack;
00216 
00217     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_SAVRES) {
00218         KdPrint((<span class="stringliteral">"CmpCopyTree:\n"</span>));
00219     }
00220 
00221     CmpCopyStack = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
00222                         PagedPool,
00223                         <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d4/structCMP__COPY__STACK__ENTRY.html">CMP_COPY_STACK_ENTRY</a>)*CMP_INITIAL_STACK_SIZE
00224                         );
00225     <span class="keywordflow">if</span> (CmpCopyStack == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00226         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00227     }
00228     CmpCopyStack[0].SourceCell = SourceCell;
00229     CmpCopyStack[0].TargetCell = TargetCell;
00230 
00231     result = <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a3">CmpCopySyncTree2</a>(
00232                 CmpCopyStack,
00233                 CMP_INITIAL_STACK_SIZE,
00234                 0,
00235                 SourceHive,
00236                 TargetHive,
00237                 CopyVolatile,
00238                 CopyType
00239                 );
00240 
00241     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(CmpCopyStack);
00242     <span class="keywordflow">return</span> result;
00243 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a267" doxytag="cmp.h::CmpCopyValue" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> CmpCopyValue           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceValueCell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00895">895</a> of file <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html">cmtrecpy.c</a>.
<p>
References <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00489">CM_KEY_VALUE_SMALL</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00487">CM_KEY_VALUE_SPECIAL_SIZE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01009">CmpCopyCell()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00508">CmpIsHKeyValueSmall</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00261">CMS_SAVRES</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00498">_CM_KEY_VALUE::Data</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00497">_CM_KEY_VALUE::DataLength</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00538">_CELL_DATA::_u::KeyValue</a>, and <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00686">CmpCopyKeyPartial()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01150">CmpMergeKeyValues()</a>, and <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01338">CmpSyncKeyValues()</a>.
<p>
<pre class="fragment"><div>00903                    :
00904 
00905     <a class="code" href="../../d9/d0/cmdata_8h.html#a104a97">Copy</a> a value entry.  Copies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> body of a value entry and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00906     data.  Returns cell of <span class="keyword">new</span> value entry.
00907 
00908 Arguments:
00909 
00910     SourceHive - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> source
00911 
00912     SourceValueCell - value entry being copied
00913 
00914     TargetHive - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> target
00915 
00916     Type - storage <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> to allocate <span class="keywordflow">for</span> target (stable or <span class="keyword">volatile</span>)
00917 
00918 Return Value:
00919 
00920     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> of body of <span class="keyword">new</span> value entry, or <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>
00921         <span class="keywordflow">if</span> some error.
00922 
00923 --*/
00924 {
00925     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newvalue;
00926     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newdata;
00927     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> pvalue;
00928     ULONG       datalength;
00929     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> olddata;
00930     ULONG       tempdata;
00931     BOOLEAN     small;
00932 
00933     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_SAVRES) {
00934         KdPrint((<span class="stringliteral">"CmpCopyValue:\n"</span>));
00935         KdPrint((<span class="stringliteral">"\tSHive=%08lx SCell=%08lx\n"</span>,SourceHive,SourceValueCell));
00936         KdPrint((<span class="stringliteral">"\tTargetHive=%08lx\n"</span>,TargetHive));
00937     }
00938 
00939     <span class="comment">//</span>
00940     <span class="comment">// get source data</span>
00941     <span class="comment">//</span>
00942     pvalue = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SourceHive, SourceValueCell);
00943     small = <a class="code" href="../../d9/d0/cmdata_8h.html#a38">CmpIsHKeyValueSmall</a>(datalength, pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o2">DataLength</a>);
00944     olddata = pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>;
00945 
00946     <span class="comment">//</span>
00947     <span class="comment">// Copy body</span>
00948     <span class="comment">//</span>
00949     newvalue = <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a13">CmpCopyCell</a>(SourceHive, SourceValueCell, TargetHive, Type);
00950     <span class="keywordflow">if</span> (newvalue == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00951         <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00952     }
00953 
00954     <span class="comment">//</span>
00955     <span class="comment">// Copy data (if any)</span>
00956     <span class="comment">//</span>
00957     <span class="keywordflow">if</span> (datalength &gt; 0) {
00958 
00959         <span class="keywordflow">if</span> (datalength &gt; <a class="code" href="../../d9/d0/cmdata_8h.html#a36">CM_KEY_VALUE_SMALL</a>) {
00960 
00961             <span class="comment">//</span>
00962             <span class="comment">// there's data, and it's "big", so do standard copy</span>
00963             <span class="comment">//</span>
00964             newdata = <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a13">CmpCopyCell</a>(SourceHive, olddata, TargetHive, Type);
00965 
00966             <span class="keywordflow">if</span> (newdata == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00967                 <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(TargetHive, newvalue);
00968                 <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00969             }
00970 
00971             pvalue = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(TargetHive, newvalue);
00972             pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a> = newdata;
00973             pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o2">DataLength</a> = datalength;
00974 
00975         } <span class="keywordflow">else</span> {
00976 
00977             <span class="comment">//</span>
00978             <span class="comment">// the data is small, but may be stored in either large or</span>
00979             <span class="comment">// small format for historical reasons</span>
00980             <span class="comment">//</span>
00981             <span class="keywordflow">if</span> (small) {
00982 
00983                 <span class="comment">//</span>
00984                 <span class="comment">// data is already small, so just do a body to body copy</span>
00985                 <span class="comment">//</span>
00986                 tempdata = pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>;
00987 
00988             } <span class="keywordflow">else</span> {
00989 
00990                 <span class="comment">//</span>
00991                 <span class="comment">// data is stored externally in old cell, will be internal in new</span>
00992                 <span class="comment">//</span>
00993                 pvalue = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SourceHive, pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>);
00994                 tempdata = *((PULONG)pvalue);
00995             }
00996             pvalue = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(TargetHive, newvalue);
00997             pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a> = tempdata;
00998             pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o2">DataLength</a> =
00999                 datalength + <a class="code" href="../../d9/d0/cmdata_8h.html#a35">CM_KEY_VALUE_SPECIAL_SIZE</a>;
01000 
01001         }
01002     }
01003 
01004     <span class="keywordflow">return</span> newvalue;
01005 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a223" doxytag="cmp.h::CmpCreateEvent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpCreateEvent           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN EVENT_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>eventType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>eventHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>event</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00313">313</a> of file <a class="el" href="../../d8/d2/cmwrapr_8c-source.html">cmwrapr.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>.
<p>
Referenced by <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00351">CmpFileRead()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00516">CmpFileWrite()</a>, and <a class="el" href="../../d9/d0/cminit_8c-source.html#l00046">CmpOpenHiveFiles()</a>.
<p>
<pre class="fragment"><div>00318 {
00319     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00320     OBJECT_ATTRIBUTES obja;
00321 
00322     InitializeObjectAttributes( &amp;obja, NULL, OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE, NULL, NULL );
00323     status = ZwCreateEvent(
00324         eventHandle,
00325         EVENT_ALL_ACCESS,
00326         &amp;obja,
00327         eventType,
00328         FALSE);
00329     
00330     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00331         <span class="keywordflow">return</span> status;
00332     }
00333     
00334     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00335         *eventHandle,
00336         EVENT_ALL_ACCESS,
00337         NULL,
00338         KernelMode,
00339         event,
00340         NULL);
00341     
00342     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00343         ZwClose(*eventHandle);
00344         <span class="keywordflow">return</span> status;
00345     }
00346     <span class="keywordflow">return</span> status;
00347 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a313" doxytag="cmp.h::CmpCreateHwProfileFriendlyName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpCreateHwProfileFriendlyName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>IDConfigDB</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DockingState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NewProfileNumber</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>FriendlyName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l02529">2529</a> of file <a class="el" href="../../d7/d1/hwprofil_8c-source.html">hwprofil.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l01598">CM_HARDWARE_PROFILE_STR_DOCKED</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01574">CM_HARDWARE_PROFILE_STR_HARDWARE_PROFILES</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01599">CM_HARDWARE_PROFILE_STR_UNDOCKED</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01600">CM_HARDWARE_PROFILE_STR_UNKNOWN</a>, <a class="el" href="../../d7/d6/profiles_8h-source.html#l00045">HW_PROFILE_DOCKSTATE_DOCKED</a>, <a class="el" href="../../d7/d6/profiles_8h-source.html#l00044">HW_PROFILE_DOCKSTATE_UNDOCKED</a>, <a class="el" href="../../d7/d6/profiles_8h-source.html#l00046">HW_PROFILE_DOCKSTATE_UNKNOWN</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02773">KeLoaderBlock</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01844">_LOADER_PARAMETER_BLOCK::LoadOrderListHead</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00035">MAX_FRIENDLY_NAME_LENGTH</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00582">PsLoadedModuleList</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01935">RtlCreateUnicodeString()</a>, <a class="el" href="../../d1/d7/message_8c-source.html#l00030">RtlFindMessage()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00102">RtlInitAnsiString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01869">CmpCloneHwProfile()</a>.
<p>
<pre class="fragment"><div>02537                    :
02538 
02539     <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> a <span class="keyword">new</span> FriendlyName <span class="keywordflow">for</span> a <span class="keyword">new</span> Hardware Profile, given <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DockState.
02540     If a <span class="keyword">new</span> profile name based on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DockState cannot be created, an attempt
02541     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to create a <span class="keywordflow">default</span> FriendlyName based on NewProfileNumber.  If
02542     successful, a unicode string with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> profile friendlyName <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> created.
02543     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> responsibility of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller to free <span class="keyword">this</span> <span class="keyword">using</span>
02544     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>.  If unsuccesful, no string <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
02545 
02546 Arguments:
02547 
02548     IDConfigDB:       <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IDConfigDB registry key.
02549 
02550     DockingState:     The Docking State of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> profile <span class="keywordflow">for</span> which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span>
02551                       FriendlyName <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being created.  This should be one of:
02552                       <a class="code" href="../../d6/d7/profiles_8h.html#a7">HW_PROFILE_DOCKSTATE_DOCKED</a>,
02553                       <a class="code" href="../../d6/d7/profiles_8h.html#a6">HW_PROFILE_DOCKSTATE_UNDOCKED</a>, or
02554                       <a class="code" href="../../d6/d7/profiles_8h.html#a8">HW_PROFILE_DOCKSTATE_UNKNOWN</a>
02555 
02556     NewProfileNumber: The number of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> profile being created.  If unable to
02557                       create a DockState specific FriendlyName, <span class="keyword">this</span> value will
02558                       be used to create a (not-so) FriendlyName.
02559 
02560     FriendlyName:     Supplies a unicode string to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FriendlyName <span class="keywordflow">for</span> <span class="keyword">this</span>
02561                       <span class="keyword">new</span> profile.  The caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expected to free <span class="keyword">this</span> with
02562                       <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>.
02563 
02564 Return:
02565 
02566     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.    Currently returns STATUS_SUCCESS, or STATUS_UNSUCCESSFUL.
02567 
02568 Notes:
02569 
02570     The <span class="keyword">new</span> FriendlyName <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> generated from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DockState and appropriate
02571     counter, and may not necessarily be unique among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> existing Hardware
02572     Profiles.
02573 
02574     The naming scheme used here (including the localized strings in the kernel
02575     message table) should be kept in sync with that provided to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user through
02576     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Hardware Profile <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> panel applet.
02577 
02578 --*/
02579 {
02580     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
02581     ANSI_STRING       ansiString;
02582     UNICODE_STRING    unicodeString;
02583     UNICODE_STRING    labelName, keyName;
02584     PMESSAGE_RESOURCE_ENTRY messageEntry;
02585     PLDR_DATA_TABLE_ENTRY dataTableEntry;
02586     ULONG             messageId;
02587     UCHAR             valueBuffer[256];
02588     WCHAR             friendlyNameBuffer[<a class="code" href="../../d9/d0/cmdata_8h.html#a2">MAX_FRIENDLY_NAME_LENGTH</a>/<span class="keyword">sizeof</span>(WCHAR)];
02589     PKEY_VALUE_FULL_INFORMATION  keyValueInfo;
02590     ULONG             length, index;
02591     HANDLE            hardwareProfiles=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02592     OBJECT_ATTRIBUTES attributes;
02593 
02594     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
02595 
02596     <span class="comment">//</span>
02597     <span class="comment">// Make sure we were given a place to put the FriendlyName</span>
02598     <span class="comment">//</span>
02599     <span class="keywordflow">if</span> (!FriendlyName) {
02600         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
02601     }
02602 
02603     <span class="comment">//</span>
02604     <span class="comment">// If we don't have a handle to IDConfigDB, try to assign a default</span>
02605     <span class="comment">// FriendlyName on the way out.</span>
02606     <span class="comment">//</span>
02607     <span class="keywordflow">if</span> (!IDConfigDB) {
02608         status = STATUS_INVALID_PARAMETER;
02609         <span class="keywordflow">goto</span> Exit;
02610     }
02611 
02612     <span class="comment">//</span>
02613     <span class="comment">// Determine the appropriate message to use, based on the DockState.</span>
02614     <span class="comment">//</span>
02615     <span class="keywordflow">if</span> ((DockingState &amp; <a class="code" href="../../d6/d7/profiles_8h.html#a8">HW_PROFILE_DOCKSTATE_UNKNOWN</a>) == <a class="code" href="../../d6/d7/profiles_8h.html#a8">HW_PROFILE_DOCKSTATE_UNKNOWN</a>){
02616         messageId = HARDWARE_PROFILE_UNKNOWN_STRING;
02617         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;labelName, CM_HARDWARE_PROFILE_STR_UNKNOWN);
02618     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DockingState &amp; <a class="code" href="../../d6/d7/profiles_8h.html#a7">HW_PROFILE_DOCKSTATE_DOCKED</a>) {
02619         messageId = HARDWARE_PROFILE_DOCKED_STRING;
02620         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;labelName, CM_HARDWARE_PROFILE_STR_DOCKED);
02621     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DockingState &amp; <a class="code" href="../../d6/d7/profiles_8h.html#a6">HW_PROFILE_DOCKSTATE_UNDOCKED</a>) {
02622         messageId = HARDWARE_PROFILE_UNDOCKED_STRING;
02623         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;labelName, CM_HARDWARE_PROFILE_STR_UNDOCKED);
02624     } <span class="keywordflow">else</span> {
02625         messageId = HARDWARE_PROFILE_UNKNOWN_STRING;
02626         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;labelName, CM_HARDWARE_PROFILE_STR_UNKNOWN);
02627     }
02628 
02629     <span class="comment">//</span>
02630     <span class="comment">// Find the message entry in the kernel's own message table.  KeLoaderBlock</span>
02631     <span class="comment">// is available when we're creating hardware profiles during system</span>
02632     <span class="comment">// initialization only; for profiles created thereafter, use the the first</span>
02633     <span class="comment">// entry of the PsLoadedModuleList to get the image base of the kernel.</span>
02634     <span class="comment">//</span>
02635     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a130">KeLoaderBlock</a>) {
02636         dataTableEntry = CONTAINING_RECORD(<a class="code" href="../../d4/d9/ke_8h.html#a130">KeLoaderBlock</a>-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o0">LoadOrderListHead</a>.Flink,
02637                                            LDR_DATA_TABLE_ENTRY,
02638                                            InLoadOrderLinks);
02639     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink) {
02640         dataTableEntry = CONTAINING_RECORD(<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink,
02641                                            LDR_DATA_TABLE_ENTRY,
02642                                            InLoadOrderLinks);
02643     } <span class="keywordflow">else</span> {
02644         status = STATUS_UNSUCCESSFUL;
02645         <span class="keywordflow">goto</span> Exit;
02646     }
02647 
02648     status = <a class="code" href="../../d0/d8/message_8c.html#a1">RtlFindMessage</a>(dataTableEntry-&gt;DllBase,
02649                             (ULONG_PTR)11, <span class="comment">// RT_MESSAGETABLE</span>
02650                             MAKELANGID(LANG_NEUTRAL,SUBLANG_SYS_DEFAULT), <span class="comment">// System default language</span>
02651                             messageId,
02652                             &amp;messageEntry);
02653 
02654     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02655         <span class="keywordflow">goto</span> Exit;
02656     }
02657 
02658     <span class="keywordflow">if</span>(!(messageEntry-&gt;Flags &amp; MESSAGE_RESOURCE_UNICODE)) {
02659         <span class="comment">//</span>
02660         <span class="comment">// If the message is not unicode, convert to unicode.</span>
02661         <span class="comment">// Let the conversion routine allocate the buffer.</span>
02662         <span class="comment">//</span>
02663         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;ansiString,messageEntry-&gt;Text);
02664         status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;unicodeString,&amp;ansiString,TRUE);
02665     } <span class="keywordflow">else</span> {
02666         <span class="comment">//</span>
02667         <span class="comment">// Message is already unicode. Make a copy.</span>
02668         <span class="comment">//</span>
02669         status = <a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;unicodeString,(PWSTR)messageEntry-&gt;Text);
02670     }
02671 
02672     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02673         <span class="keywordflow">goto</span> Exit;
02674     }
02675 
02676     <span class="comment">//</span>
02677     <span class="comment">// Strip the trailing CRLF.</span>
02678     <span class="comment">//</span>
02679     <span class="keywordflow">if</span> (unicodeString.Length  &gt; 2 * <span class="keyword">sizeof</span>(WCHAR)) {
02680         unicodeString.Length -= 2 * <span class="keyword">sizeof</span>(WCHAR);
02681         unicodeString.Buffer[unicodeString.Length / <span class="keyword">sizeof</span>(WCHAR)] = UNICODE_NULL;
02682     }
02683 
02684     <span class="comment">//</span>
02685     <span class="comment">// Check that the size of the label, with any numeric tag that may</span>
02686     <span class="comment">// potentially be added (up to 4 digits, preceded by a space) is not too</span>
02687     <span class="comment">// big.</span>
02688     <span class="comment">//</span>
02689     <span class="keywordflow">if</span> ((unicodeString.Length + 5*<span class="keyword">sizeof</span>(WCHAR) + <span class="keyword">sizeof</span>(UNICODE_NULL)) &gt;
02690         <a class="code" href="../../d9/d0/cmdata_8h.html#a2">MAX_FRIENDLY_NAME_LENGTH</a>) {
02691         status = STATUS_UNSUCCESSFUL;
02692         <span class="keywordflow">goto</span> Clean;
02693     }
02694 
02695     <span class="comment">//</span>
02696     <span class="comment">// Open the Hardware Profiles key.</span>
02697     <span class="comment">//</span>
02698     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;keyName, CM_HARDWARE_PROFILE_STR_HARDWARE_PROFILES);
02699     InitializeObjectAttributes(&amp;attributes,
02700                                &amp;keyName,
02701                                OBJ_CASE_INSENSITIVE,
02702                                IDConfigDB,
02703                                NULL);
02704     status = ZwOpenKey(&amp;hardwareProfiles,
02705                        KEY_READ,
02706                        &amp;attributes);
02707     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02708         hardwareProfiles = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02709         <span class="keywordflow">goto</span> Clean;
02710     }
02711 
02712     <span class="comment">//</span>
02713     <span class="comment">// Retrieve the counter of FriendlyNames we have previously assigned, based</span>
02714     <span class="comment">// on this DockState.</span>
02715     <span class="comment">//</span>
02716     keyValueInfo = (PKEY_VALUE_FULL_INFORMATION) valueBuffer;
02717     status = ZwQueryValueKey(hardwareProfiles,
02718                              &amp;labelName,
02719                              KeyValueFullInformation,
02720                              valueBuffer,
02721                              <span class="keyword">sizeof</span>(valueBuffer),
02722                              &amp;length);
02723 
02724     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; (keyValueInfo-&gt;Type == REG_DWORD)) {
02725         <span class="comment">//</span>
02726         <span class="comment">// Increment the counter.</span>
02727         <span class="comment">//</span>
02728         index = (* (PULONG) ((PUCHAR)keyValueInfo + keyValueInfo-&gt;DataOffset));
02729         index++;
02730     } <span class="keywordflow">else</span> {
02731         <span class="comment">//</span>
02732         <span class="comment">// Missing or invalid counter value; start the counter at "1".</span>
02733         <span class="comment">//</span>
02734         index = 1;
02735     }               
02736 
02737     <span class="comment">//</span>
02738     <span class="comment">// Update the counter in the registry.</span>
02739     <span class="comment">//</span>
02740     status = ZwSetValueKey(hardwareProfiles,
02741                            &amp;labelName,
02742                            0,
02743                            REG_DWORD,
02744                            &amp;index,
02745                            <span class="keyword">sizeof</span>(index));
02746     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02747         <span class="keywordflow">goto</span> Clean;
02748     }
02749 
02750     <span class="comment">//</span>
02751     <span class="comment">// Copy the FriendlyName, adding the index if necessary.</span>
02752     <span class="comment">//</span>
02753     <span class="keywordflow">if</span> ((messageId == HARDWARE_PROFILE_UNKNOWN_STRING) || (index &gt; 1)) {
02754         swprintf(friendlyNameBuffer, L<span class="stringliteral">"%s %u"</span>,
02755                  unicodeString.Buffer, index);
02756     } <span class="keywordflow">else</span> {
02757         wcscpy(friendlyNameBuffer, unicodeString.Buffer);
02758     }
02759 
02760  Clean:
02761 
02762     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeString);
02763 
02764     <span class="keywordflow">if</span> (hardwareProfiles!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02765         ZwClose(hardwareProfiles);
02766     }
02767 
02768  Exit:
02769 
02770     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02771         <span class="comment">//</span>
02772         <span class="comment">// If we failed to assign a counter-based FriendlyName for whatever</span>
02773         <span class="comment">// reason, give the new profile a new (not so) friendly name as a last</span>
02774         <span class="comment">// resort.</span>
02775         <span class="comment">//</span>
02776         swprintf (friendlyNameBuffer, L<span class="stringliteral">"%04d"</span>, NewProfileNumber);
02777         status = STATUS_SUCCESS;
02778     }
02779 
02780     <span class="comment">//</span>
02781     <span class="comment">// Create the unicode string to return to the caller.</span>
02782     <span class="comment">//</span>
02783     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(FriendlyName, (PWSTR)friendlyNameBuffer)) {
02784         status = STATUS_UNSUCCESSFUL;
02785     }
02786 
02787     <span class="keywordflow">return</span> status;
02788 
02789 } <span class="comment">// CmpCreateHwProfileFriendlyName</span>
} <span class="comment">// CmpCreateHwProfileFriendlyName</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a279" doxytag="cmp.h::CmpCreateKeyControlBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> CmpCreateKeyControlBlock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Node</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ParentKcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>FakeKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00824">824</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00069">ASSERT_KCB</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00525">ASSERT_KEYBODY_LIST_EMPTY</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00257">CM_KCB_KEY_NON_EXIST</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01184">CmpDereferenceKeyControlBlockWithLock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00368">CmpGetNameControlBlock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01350">CmpInsertKeyHash()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00345">CmpReferenceKeyControlBlock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00807">CmpRemoveFromDelayedClose()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01260">CmpRemoveKeyControlBlock()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00277">_CM_KEY_CONTROL_BLOCK::ConvKey</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00332">_CHILD_LIST::Count</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00272">_CM_KEY_CONTROL_BLOCK::Delete</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00291">ExFreePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00524">INIT_KCB_KEYBODY_LIST</a>, <a class="el" href="../../d5/d5/regext_8c-source.html#l00458">kcb()</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00333">_CHILD_LIST::List</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00230">LOCK_KCB_TREE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00281">PROTECTED_POOL</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01178">RtlUpcaseUnicodeChar()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00463">_CM_KEY_NODE::Security</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00068">SET_KCB_SIGNATURE</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00294">_CM_KEY_CONTROL_BLOCK::TotalLevels</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00231">UNLOCK_KCB_TREE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00458">_CM_KEY_NODE::ValueList</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l02056">CmpAddInfoAfterParseFailure()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01165">CmpCreateRegistryRoot()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00226">CmpDoCreateChild()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00963">CmpDoOpen()</a>, and <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>.
<p>
<pre class="fragment"><div>00834                    :
00835 
00836     Allocate and initialize a key <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block, insert <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> into
00837     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> tree.
00838 
00839     Full <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> will be <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a> + <span class="charliteral">'\'</span> + <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>, unless <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>
00840     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, in which <span class="keywordflow">case</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> simply <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.
00841 
00842     <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a5">RefCount</a> of returned KCB WILL have been incremented to reflect
00843     callers ref.
00844 
00845 Arguments:
00846 
00847     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> that holds <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key we are creating a KCB <span class="keywordflow">for</span>.
00848 
00849     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - Supplies <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> that contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key we are creating a KCB <span class="keywordflow">for</span>.
00850 
00851     Node - Supplies pointer to key node.
00852 
00853     ParentKcb - Parent <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> to be created
00854 
00855     FakeKey - Whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> to be create <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a fake one or not
00856 
00857     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkey name to of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> KCB to be created.
00858  
00859     NOTE:  We need <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parameter instead of just <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> KEY_NODE 
00860            because there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no name in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root cell of a hive.
00861 
00862 Return Value:
00863 
00864     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - <a class="code" href="../../d8/d3/rtvbatcr_8c.html#a1">failure</a> (insufficient memory)
00865     <span class="keywordflow">else</span> a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.
00866 
00867 --*/
00868 {
00869     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00870     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   kcbmatch=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00871     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive;
00872     ULONG namelength;
00873     PUNICODE_STRING         fullname;
00874     ULONG       <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00875     ULONG i;
00876 
00877     UNICODE_STRING         NodeName;
00878     ULONG ConvKey=0;
00879     ULONG Cnt;
00880     WCHAR *Cp;
00881 
00882     <span class="comment">//</span>
00883     <span class="comment">// ParentKCb has the base hash value.</span>
00884     <span class="comment">//</span>
00885     <span class="keywordflow">if</span> (ParentKcb) {
00886         ConvKey = ParentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o3">ConvKey</a>;
00887     }
00888 
00889     NodeName = *<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
00890 
00891     <span class="keywordflow">while</span> ((NodeName.Length &gt; 0) &amp;&amp; (NodeName.Buffer[0] == OBJ_NAME_PATH_SEPARATOR)) {
00892         <span class="comment">//</span>
00893         <span class="comment">// This must be the \REGISTRY.</span>
00894         <span class="comment">// Strip off the leading OBJ_NAME_PATH_SEPARATOR</span>
00895         <span class="comment">//</span>
00896         NodeName.Buffer++;
00897         NodeName.Length -= <span class="keyword">sizeof</span>(WCHAR);
00898     }
00899 
00900     <span class="comment">//</span>
00901     <span class="comment">// Manually compute the hash to use.</span>
00902     <span class="comment">//</span>
00903     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(NodeName.Length &gt; 0);
00904 
00905     <span class="keywordflow">if</span> (NodeName.Length) {
00906         Cp = NodeName.Buffer;
00907         <span class="keywordflow">for</span> (Cnt=0; Cnt&lt;NodeName.Length; Cnt += <span class="keyword">sizeof</span>(WCHAR)) {
00908             <span class="keywordflow">if</span> ((*Cp != OBJ_NAME_PATH_SEPARATOR) &amp;&amp;
00909                 (*Cp != UNICODE_NULL)) {
00910                 ConvKey = 37 * ConvKey + (ULONG)<a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(*Cp);
00911             }
00912             ++Cp;
00913         }
00914     }
00915 
00916     <span class="comment">//</span>
00917     <span class="comment">// Create a new kcb, which we will free if one already exists</span>
00918     <span class="comment">// for this key.</span>
00919     <span class="comment">// Now it is a fixed size structure.</span>
00920     <span class="comment">//</span>
00921     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(PagedPool,
00922                                 <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">CM_KEY_CONTROL_BLOCK</a>),
00923                                 CM_KCB_TAG | PROTECTED_POOL);
00924 
00925 
00926     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00927         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00928     } <span class="keywordflow">else</span> {
00929         <a class="code" href="../../d9/d0/cmdata_8h.html#a4">SET_KCB_SIGNATURE</a>(kcb, KCB_SIGNATURE);
00930         <a class="code" href="../../d1/d2/cmp_8h.html#a79">INIT_KCB_KEYBODY_LIST</a>(kcb);
00931         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;Delete = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00932         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;RefCount = 1;
00933         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyHive = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00934         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyCell = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
00935         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyNode = Node;
00936         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ConvKey = ConvKey;
00937 
00938     }
00939 
00940     <a class="code" href="../../d9/d0/cmdata_8h.html#a5">ASSERT_KCB</a>(kcb);
00941     <span class="comment">//</span>
00942     <span class="comment">// Find location to insert kcb in kcb tree.</span>
00943     <span class="comment">//</span>
00944 
00945 
00946     <a class="code" href="../../d1/d2/cmp_8h.html#a16">LOCK_KCB_TREE</a>();
00947 
00948     <span class="comment">//</span>
00949     <span class="comment">// Add the KCB to the hash table</span>
00950     <span class="comment">//</span>
00951     kcbmatch = <a class="code" href="../../d8/d2/cmsubs_8c.html#a10">CmpInsertKeyHash</a>(&amp;<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyHash, FakeKey);
00952     <span class="keywordflow">if</span> (kcbmatch != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00953         <span class="comment">//</span>
00954         <span class="comment">// A match was found.</span>
00955         <span class="comment">//</span>
00956         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!kcbmatch-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o0">Delete</a>);
00957         <a class="code" href="../../d9/d0/cmdata_8h.html#a4">SET_KCB_SIGNATURE</a>(kcb, '1FmC');
00958         <a class="code" href="../../d1/d2/cmp_8h.html#a80">ASSERT_KEYBODY_LIST_EMPTY</a>(kcb);
00959         <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(kcb, CM_KCB_TAG | PROTECTED_POOL);
00960         <a class="code" href="../../d9/d0/cmdata_8h.html#a5">ASSERT_KCB</a>(kcbmatch);
00961         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = kcbmatch;
00962         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;RefCount == 0) {
00963             <span class="comment">//</span>
00964             <span class="comment">// This kcb is on the delayed close list. Remove it from that</span>
00965             <span class="comment">// list.</span>
00966             <span class="comment">//</span>
00967             <a class="code" href="../../d8/d2/cmsubs_8c.html#a19">CmpRemoveFromDelayedClose</a>(kcb);
00968         }
00969         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;RefCount + 1) == 0) {
00970             <span class="comment">//</span>
00971             <span class="comment">// We have maxed out the ref count on this key. Probably</span>
00972             <span class="comment">// some bogus app has opened the same key 64K times without</span>
00973             <span class="comment">// ever closing it. Just fail the open, they've got enough</span>
00974             <span class="comment">// handles already.</span>
00975             <span class="comment">//</span>
00976             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;RefCount + 1 != 0);
00977             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00978         } <span class="keywordflow">else</span> {
00979             ++<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;RefCount;
00980         }
00981     }
00982     <span class="keywordflow">else</span> {
00983         <span class="comment">//</span>
00984         <span class="comment">// No kcb created previously, fill in all the data.</span>
00985         <span class="comment">//</span>
00986 
00987         <span class="comment">//</span>
00988         <span class="comment">// Now try to reference the parentkcb</span>
00989         <span class="comment">//</span>
00990         
00991         <span class="keywordflow">if</span> (ParentKcb) {
00992             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/cmsubs_8c.html#a13">CmpReferenceKeyControlBlock</a>(ParentKcb)) {
00993                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ParentKcb = ParentKcb;
00994                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;TotalLevels = ParentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o16">TotalLevels</a> + 1;
00995             } <span class="keywordflow">else</span> {
00996                 <span class="comment">//</span>
00997                 <span class="comment">// We have maxed out the ref count on the parent.</span>
00998                 <span class="comment">// Since it has been cached in the cachetable,</span>
00999                 <span class="comment">// remove it first before we free the allocation.</span>
01000                 <span class="comment">//</span>
01001                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a24">CmpRemoveKeyControlBlock</a>(kcb);
01002                 <a class="code" href="../../d9/d0/cmdata_8h.html#a4">SET_KCB_SIGNATURE</a>(kcb, '2FmC');
01003                 <a class="code" href="../../d1/d2/cmp_8h.html#a80">ASSERT_KEYBODY_LIST_EMPTY</a>(kcb);
01004                 <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(kcb, CM_KCB_TAG | PROTECTED_POOL);
01005                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01006             }
01007         } <span class="keywordflow">else</span> {
01008             <span class="comment">//</span>
01009             <span class="comment">// It is the \REGISTRY node.</span>
01010             <span class="comment">//</span>
01011             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ParentKcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01012             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;TotalLevels = 1;
01013         }
01014 
01015         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>) {
01016             <span class="comment">//</span>
01017             <span class="comment">// Now try to find the Name Control block that has the name for this node.</span>
01018             <span class="comment">//</span>
01019     
01020             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;NameBlock = <a class="code" href="../../d8/d2/cmsubs_8c.html#a14">CmpGetNameControlBlock</a> (&amp;NodeName);
01021 
01022             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;NameBlock) {
01023                 <span class="comment">//</span>
01024                 <span class="comment">// Now fill in all the data needed for the cache.</span>
01025                 <span class="comment">//</span>
01026                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ValueCache.Count = Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a>;
01027                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ValueCache.ValueList = (ULONG_PTR) Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>;
01028         
01029                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;Flags = Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a>;
01030                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags = 0;
01031                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;DelayedCloseIndex = 0;
01032         
01033                 <span class="comment">//</span>
01034                 <span class="comment">// Cache the security cells in the kcb</span>
01035                 <span class="comment">//</span>
01036                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;Security = Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a>;
01037         
01038                 <span class="keywordflow">if</span> (FakeKey) {
01039                     <span class="comment">//</span>
01040                     <span class="comment">// The KCb to be created is a fake one</span>
01041                     <span class="comment">//</span>
01042                     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags |= <a class="code" href="../../d9/d0/cmdata_8h.html#a13">CM_KCB_KEY_NON_EXIST</a>;
01043                 }
01044             } <span class="keywordflow">else</span> {
01045                 <span class="comment">//</span>
01046                 <span class="comment">// We have maxed out the ref count on the Name.</span>
01047                 <span class="comment">//</span>
01048                 
01049                 <span class="comment">//</span>
01050                 <span class="comment">// First dereference the parent KCB.</span>
01051                 <span class="comment">//</span>
01052                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a23">CmpDereferenceKeyControlBlockWithLock</a>(ParentKcb);
01053 
01054                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a24">CmpRemoveKeyControlBlock</a>(kcb);
01055                 <a class="code" href="../../d9/d0/cmdata_8h.html#a4">SET_KCB_SIGNATURE</a>(kcb, '3FmC');
01056                 <a class="code" href="../../d1/d2/cmp_8h.html#a80">ASSERT_KEYBODY_LIST_EMPTY</a>(kcb);
01057                 <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(kcb, CM_KCB_TAG | PROTECTED_POOL);
01058                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01059             }
01060         }
01061     }
01062 
01063 
01064     <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
01065     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
01066 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a263" doxytag="cmp.h::CmpDeleteChildByName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpDeleteChildByName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Name</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ChildCell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a212" doxytag="cmp.h::CmpDeleteKeyObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpDeleteKeyObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Object</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/cmdelete_8c-source.html#l00031">31</a> of file <a class="el" href="../../d2/d0/cmdelete_8c-source.html">cmdelete.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01153">CmpDereferenceKeyControlBlock()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01235">CmpFlushNotify()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00124">CmpLockRegistry()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00257">CMS_NTAPI</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00527">DELIST_KEYBODY_FROM_KEYBODY_LIST</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00284">_CM_KEY_CONTROL_BLOCK::Flags</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00486">KEY_BODY_TYPE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00442">KEY_PREDEF_HANDLE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00492">_CM_KEY_BODY::KeyControlBlock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00767">REG_PREDEF_HANDLE_MASK</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00491">_CM_KEY_BODY::Type</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01074">CmpCreateObjectTypes()</a>.
<p>
<pre class="fragment"><div>00036                    :
00037 
00038     This routine interfaces to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NT Object <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a79">Manager</a>.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked when
00039     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last reference to a particular <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> object (or Key Root object)
00040     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> destroyed.
00041 
00042     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> object going away holds <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last reference to
00043     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> associated with, that <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> destroyed.
00044 
00045 Arguments:
00046 
00047     Object - supplies a pointer to a KeyRoot or <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>, thus -&gt; KEY_BODY.
00048 
00049 Return Value:
00050 
00051     NONE.
00052 
00053 --*/
00054 {
00055     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   KeyControlBlock;
00056     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>            KeyBody;
00057 
00058     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00059 
00060     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_NTAPI) {
00061         KdPrint((<span class="stringliteral">"CmpDeleteKeyObject: Object = %08lx\n"</span>, Object));
00062     }
00063 
00064     <a class="code" href="../../d6/d3/cmwraper_8c.html#a14">CmpLockRegistry</a>();
00065 
00066     KeyBody = (<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)Object;
00067 
00068     <span class="keywordflow">if</span> (KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o0">Type</a>==<a class="code" href="../../d1/d2/cmp_8h.html#a78">KEY_BODY_TYPE</a>) {
00069         KeyControlBlock = KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>;
00070 
00071         <span class="comment">//</span>
00072         <span class="comment">// the keybody should be initialized; when kcb is null, something went wrong</span>
00073         <span class="comment">// between the creation and the dereferenciation of the object</span>
00074         <span class="comment">//</span>
00075         <span class="keywordflow">if</span>( KeyControlBlock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00076 
00077             <span class="comment">//</span>
00078             <span class="comment">// Clean up any outstanding notifies attached to the KeyBody</span>
00079             <span class="comment">//</span>
00080             <a class="code" href="../../d1/d2/cmp_8h.html#a288">CmpFlushNotify</a>(KeyBody);
00081 
00082             <span class="comment">//</span>
00083             <span class="comment">// Remove our reference to the KeyControlBlock, clean it up, perform any</span>
00084             <span class="comment">// pend-till-final-close operations.</span>
00085             <span class="comment">//</span>
00086             <span class="comment">// NOTE: Delete notification is seen at the parent of the deleted key,</span>
00087             <span class="comment">//       not the deleted key itself.  If any notify was outstanding on</span>
00088             <span class="comment">//       this key, it was cleared away above us.  Only parent/ancestor</span>
00089             <span class="comment">//       keys will see the report.</span>
00090             <span class="comment">//</span>
00091             <span class="comment">//</span>
00092             <span class="comment">// The dereference will free the KeyControlBlock.  If the key was deleted, it</span>
00093             <span class="comment">// has already been removed from the hash table, and relevent notifications</span>
00094             <span class="comment">// posted then as well.  All we are doing is freeing the tombstone.</span>
00095             <span class="comment">//</span>
00096             <span class="comment">// If it was not deleted, we're both cutting the kcb out of</span>
00097             <span class="comment">// the kcb list/tree, AND freeing its storage.</span>
00098             <span class="comment">//</span>
00099 
00100             <a class="code" href="../../d1/d2/cmp_8h.html#a82">DELIST_KEYBODY_FROM_KEYBODY_LIST</a>(KeyBody);
00101             <a class="code" href="../../d8/d2/cmsubs_8c.html#a22">CmpDereferenceKeyControlBlock</a>(KeyControlBlock);
00102         }
00103     } <span class="keywordflow">else</span> {
00104         <span class="comment">//</span>
00105         <span class="comment">// This must be a predefined handle</span>
00106         <span class="comment">//  some sanity asserts</span>
00107         <span class="comment">//</span>
00108         KeyControlBlock = KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>;
00109 
00110         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o0">Type</a>&amp;REG_PREDEF_HANDLE_MASK);
00111         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o8">Flags</a>&amp;KEY_PREDEF_HANDLE );
00112         
00113         <span class="keywordflow">if</span>( KeyControlBlock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00114             <a class="code" href="../../d8/d2/cmsubs_8c.html#a22">CmpDereferenceKeyControlBlock</a>(KeyControlBlock);
00115         }
00116 
00117     }
00118     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00119     <span class="keywordflow">return</span>;
00120 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a270" doxytag="cmp.h::CmpDeleteTree" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpDeleteTree           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00034">34</a> of file <a class="el" href="../../d4/d2/cmtredel_8c-source.html">cmtredel.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00771">CmpFindSubKeyByNumber()</a>, <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00140">CmpFreeKeyByCell()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00261">CMS_SAVRES</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00453">_CM_KEY_NODE::Parent</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00454">_CM_KEY_NODE::SubKeyCounts</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01648">CmpSyncSubKeysAfterDelete()</a>, and <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00097">CmRestoreKey()</a>.
<p>
<pre class="fragment"><div>00040                    :
00041 
00042     <a class="code" href="../../d9/d0/rtdelkey_8c.html#a5">Delete</a> all child subkeys, recursively, of <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>.Cell.  <a class="code" href="../../d9/d0/rtdelkey_8c.html#a5">Delete</a> all
00043     value entries of <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>.Cell.  Do NOT <span class="keyword">delete</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>.Cell itself.
00044 
00045     NOTE:   If <span class="keyword">this</span> call fails part way through, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will NOT undo
00046             any successfully completed deletes.
00047 
00048     NOTE:   This algorithm can deal with a hive of any depth, at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00049             cost of some <span class="stringliteral">"redundent"</span> scaning and mapping.
00050 
00051 Arguments:
00052 
00053     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> hive to <span class="keyword">delete</span> from
00054 
00055     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - index of cell at root of tree to <span class="keyword">delete</span>
00056 
00057 Return Value:
00058 
00059     BOOLEAN - Result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
00060         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
00061         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tree <span class="keyword">delete</span> was not completed (though more than 0
00062                 keys may have been deleted)
00063 
00064 --*/
00065 {
00066     ULONG  count;
00067     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ptr1;
00068     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ptr2;
00069     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> parent;
00070     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node;
00071 
00072     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_SAVRES) {
00073         KdPrint((<span class="stringliteral">"CmpDeleteTree:\n"</span>));
00074         KdPrint((<span class="stringliteral">"\tHive=%08lx Cell=%08lx\n"</span>,Hive,Cell));
00075     }
00076 
00077     ptr1 = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
00078 
00079     <span class="keywordflow">while</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00080 
00081         Node = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ptr1);
00082         count = Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] +
00083                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>];
00084         parent = Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a>;
00085 
00086         <span class="keywordflow">if</span> (count &gt; 0) {                <span class="comment">// ptr1-&gt;count &gt; 0?</span>
00087 
00088             <span class="comment">//</span>
00089             <span class="comment">// subkeys exist, find and delete them</span>
00090             <span class="comment">//</span>
00091             ptr2 = <a class="code" href="../../d1/d2/cmp_8h.html#a304">CmpFindSubKeyByNumber</a>(Hive, Node, 0);
00092 
00093             Node = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ptr2);
00094             count = Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] +
00095                     Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>];
00096 
00097             <span class="keywordflow">if</span> (count &gt; 0) {            <span class="comment">// ptr2-&gt;count &gt; 0?</span>
00098 
00099                 <span class="comment">//</span>
00100                 <span class="comment">// subkey has subkeys, descend to next level</span>
00101                 <span class="comment">//</span>
00102                 ptr1 = ptr2;
00103                 <span class="keywordflow">continue</span>;
00104 
00105             } <span class="keywordflow">else</span> {
00106 
00107                 <span class="comment">//</span>
00108                 <span class="comment">// have found leaf, delete it</span>
00109                 <span class="comment">//</span>
00110                 <a class="code" href="../../d3/d3/cmtredel_8c.html#a1">CmpFreeKeyByCell</a>(Hive, ptr2, TRUE);
00111                 <span class="keywordflow">continue</span>;
00112             }
00113 
00114         } <span class="keywordflow">else</span> {
00115 
00116             <span class="comment">//</span>
00117             <span class="comment">// no more subkeys at this level, we are now a leaf.</span>
00118             <span class="comment">//</span>
00119             <span class="keywordflow">if</span> (ptr1 != <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>) {
00120 
00121                 <span class="comment">//</span>
00122                 <span class="comment">// we are not at the root cell, so ascend to parent</span>
00123                 <span class="comment">//</span>
00124                 ptr1 = parent;          <span class="comment">// ptr1 = ptr1-&gt;parent</span>
00125                 <span class="keywordflow">continue</span>;
00126 
00127             } <span class="keywordflow">else</span> {
00128 
00129                 <span class="comment">//</span>
00130                 <span class="comment">// we are at the root cell, we are done</span>
00131                 <span class="comment">//</span>
00132                 <span class="keywordflow">return</span>;
00133             }
00134         } <span class="comment">// outer if</span>
00135     } <span class="comment">// while</span>
00136 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a281" doxytag="cmp.h::CmpDereferenceKeyControlBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpDereferenceKeyControlBlock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>KeyControlBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01153">1153</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
References <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01184">CmpDereferenceKeyControlBlockWithLock()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00230">LOCK_KCB_TREE</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00231">UNLOCK_KCB_TREE</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l02056">CmpAddInfoAfterParseFailure()</a>, <a class="el" href="../../d2/d0/cmdelete_8c-source.html#l00031">CmpDeleteKeyObject()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00963">CmpDoOpen()</a>, and <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>.
<p>
<pre class="fragment"><div>01158                    :
01159 
01160     Decrements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count on a key <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block, and frees <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
01161     becomes zero.
01162 
01163     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expected that no notify <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> blocks remain <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count
01164     becomes zero.
01165 
01166 Arguments:
01167 
01168     KeyControlBlock - pointer to a key <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block.
01169 
01170 Return Value:
01171 
01172     NONE.
01173 
01174 --*/
01175 {
01176     <a class="code" href="../../d1/d2/cmp_8h.html#a16">LOCK_KCB_TREE</a>();
01177     <a class="code" href="../../d8/d2/cmsubs_8c.html#a23">CmpDereferenceKeyControlBlockWithLock</a>(KeyControlBlock) ;
01178     <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
01179     <span class="keywordflow">return</span>;
01180 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a322" doxytag="cmp.h::CmpDereferenceKeyControlBlockWithLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpDereferenceKeyControlBlockWithLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>KeyControlBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01184">1184</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00069">ASSERT_KCB</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00258">CM_KCB_NO_DELAY_CLOSE</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00629">CmpCleanUpKcbCacheWithLock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00033">CmpDelayedCloseCurrent</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00031">CmpDelayedCloseSize</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00032">CmpDelayedCloseTable</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00034">CmpDelayedFreeIndex</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00293">_CM_KEY_CONTROL_BLOCK::DelayedCloseIndex</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00272">_CM_KEY_CONTROL_BLOCK::Delete</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00283">_CM_KEY_CONTROL_BLOCK::ExtFlags</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00273">_CM_KEY_CONTROL_BLOCK::RefCount</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00416">CmEnumerateValueKey()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00568">CmpCleanUpKcbValueCache()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00824">CmpCreateKeyControlBlock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01153">CmpDereferenceKeyControlBlock()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00226">CmpDoCreateChild()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>, and <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00804">CmQueryValueKey()</a>.
<p>
<pre class="fragment"><div>01187 {
01188     ULONG_PTR FreeIndex;
01189     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KcbToFree;
01190 
01191 
01192 
01193     <a class="code" href="../../d9/d0/cmdata_8h.html#a5">ASSERT_KCB</a>(KeyControlBlock);
01194 
01195     <span class="keywordflow">if</span> (--KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o1">RefCount</a> == 0) {
01196         <span class="comment">//</span>
01197         <span class="comment">// Remove kcb from the tree</span>
01198         <span class="comment">//</span>
01199         <span class="keywordflow">if</span> (KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o7">ExtFlags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a14">CM_KCB_NO_DELAY_CLOSE</a>) {
01200             <span class="comment">//</span>
01201             <span class="comment">// Free storage directly so we can clean up junk quickly.</span>
01202             <span class="comment">//</span>
01203             <span class="comment">//</span>
01204             <span class="comment">// Need to free all cached Index List, Index Leaf, Value, etc.</span>
01205             <span class="comment">//</span>
01206             <a class="code" href="../../d8/d2/cmsubs_8c.html#a17">CmpCleanUpKcbCacheWithLock</a>(KeyControlBlock);
01207         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o0">Delete</a>) {
01208 
01209             <span class="comment">//</span>
01210             <span class="comment">// Put this kcb on our delayed close list.</span>
01211             <span class="comment">//</span>
01212             <span class="comment">// First check the free list for a free slot.</span>
01213             <span class="comment">//</span>
01214             FreeIndex = <a class="code" href="../../d8/d2/cmsubs_8c.html#a7">CmpDelayedFreeIndex</a>;
01215             <span class="keywordflow">if</span> (FreeIndex != -1) {
01216                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FreeIndex &lt; CmpDelayedCloseSize);
01217                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a7">CmpDelayedFreeIndex</a> = (ULONG_PTR)<a class="code" href="../../d8/d2/cmsubs_8c.html#a5">CmpDelayedCloseTable</a>[FreeIndex];
01218                 KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o15">DelayedCloseIndex</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) FreeIndex;
01219                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((CmpDelayedFreeIndex == -1) ||
01220                        (CmpDelayedFreeIndex &lt; CmpDelayedCloseSize));
01221                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a5">CmpDelayedCloseTable</a>[FreeIndex] = KeyControlBlock;
01222             } <span class="keywordflow">else</span> {
01223 
01224                 <span class="comment">//</span>
01225                 <span class="comment">// Nothing is free, we have to get rid of something.</span>
01226                 <span class="comment">//</span>
01227                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(*CmpDelayedCloseCurrent != NULL);
01228                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(*CmpDelayedCloseCurrent)-&gt;Delete);
01229                 <span class="comment">//</span>
01230                 <span class="comment">// Need to free all cached Index List, Index Leaf, Value, etc.</span>
01231                 <span class="comment">// Change the code sequence for the recurrsive call to dereference the parent.</span>
01232                 <span class="comment">//</span>
01233                 KcbToFree = *<a class="code" href="../../d8/d2/cmsubs_8c.html#a6">CmpDelayedCloseCurrent</a>;
01234                 *<a class="code" href="../../d8/d2/cmsubs_8c.html#a6">CmpDelayedCloseCurrent</a> = KeyControlBlock;
01235                 KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o15">DelayedCloseIndex</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<a class="code" href="../../d8/d2/cmsubs_8c.html#a6">CmpDelayedCloseCurrent</a> - <a class="code" href="../../d8/d2/cmsubs_8c.html#a5">CmpDelayedCloseTable</a>);
01236                 ++<a class="code" href="../../d8/d2/cmsubs_8c.html#a6">CmpDelayedCloseCurrent</a>;
01237                 <span class="keywordflow">if</span> ((ULONG)(<a class="code" href="../../d8/d2/cmsubs_8c.html#a6">CmpDelayedCloseCurrent</a> - <a class="code" href="../../d8/d2/cmsubs_8c.html#a5">CmpDelayedCloseTable</a>) == <a class="code" href="../../d8/d2/cmsubs_8c.html#a4">CmpDelayedCloseSize</a>) {
01238                     <a class="code" href="../../d8/d2/cmsubs_8c.html#a6">CmpDelayedCloseCurrent</a> = <a class="code" href="../../d8/d2/cmsubs_8c.html#a5">CmpDelayedCloseTable</a>;
01239                 }
01240 
01241                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a17">CmpCleanUpKcbCacheWithLock</a>(KcbToFree);
01242             }
01243         } <span class="keywordflow">else</span> {
01244             <span class="comment">//</span>
01245             <span class="comment">// Free storage directly as there is no point in putting this on</span>
01246             <span class="comment">// our delayed close list.</span>
01247             <span class="comment">//</span>
01248             <span class="comment">//</span>
01249             <span class="comment">// Need to free all cached Index List, Index Leaf, Value, etc.</span>
01250             <span class="comment">//</span>
01251             <a class="code" href="../../d8/d2/cmsubs_8c.html#a17">CmpCleanUpKcbCacheWithLock</a>(KeyControlBlock);
01252         }
01253     }
01254 
01255     <span class="keywordflow">return</span>;
01256 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a276" doxytag="cmp.h::CmpDestroyHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpDestroyHive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/cminit_8c-source.html#l00667">667</a> of file <a class="el" href="../../d9/d0/cminit_8c-source.html">cminit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00140">CmpFreeKeyByCell()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00036">CmpMasterHive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d5/d5/regext_8c-source.html#l00033">HiveList</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00537">_CELL_DATA::_u::KeyNode</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00453">_CM_KEY_NODE::Parent</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02079">CmUnloadKey()</a>.
<p>
<pre class="fragment"><div>00674                    :
00675 
00676     This routine tears down a cmhive.
00677 
00678 Arguments:
00679 
00680     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive to be freed.
00681 
00682     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - Supplies index of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive's root cell.
00683 
00684 Return Value:
00685 
00686     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> successful
00687     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> some <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> occurred
00688 
00689 --*/
00690 
00691 {
00692     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> CellData;
00693     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> LinkCell;
00694     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00695 
00696     <span class="comment">//</span>
00697     <span class="comment">// First find the link cell.</span>
00698     <span class="comment">//</span>
00699     CellData = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);
00700     LinkCell = CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a>;
00701 
00702     <span class="comment">//</span>
00703     <span class="comment">// Now delete the link cell.</span>
00704     <span class="comment">//</span>
00705     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FIELD_OFFSET(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive) == 0);
00706     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d3/cmtredel_8c.html#a1">CmpFreeKeyByCell</a>((<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)CmpMasterHive, LinkCell, TRUE);
00707 
00708     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00709         <span class="comment">//</span>
00710         <span class="comment">// Take the hive out of the hive list</span>
00711         <span class="comment">//</span>
00712         RemoveEntryList(&amp;( ((<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)Hive)-&gt;HiveList));
00713         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00714     } <span class="keywordflow">else</span> {
00715         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00716     }
00717 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a209" doxytag="cmp.h::CmpDoCreate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpDoCreate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Name</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">PCM_PARSE_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ParentKcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00033">33</a> of file <a class="el" href="../../d4/d1/cmparse2_8c-source.html">cmparse2.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00346">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00895">CmpAddSubKey()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00917">CmpCheckCreateAccess()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00537">CmpCleanUpSubKeyInfo()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00226">CmpDoCreateChild()</a>, <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00140">CmpFreeKeyByCell()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00260">CMS_PARSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00526">_CM_KEY_SECURITY::Descriptor</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00284">_CM_KEY_CONTROL_BLOCK::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">HvMarkCellDirty()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00439">KEY_SYM_LINK</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00492">_CM_KEY_BODY::KeyControlBlock</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00537">_CELL_DATA::_u::KeyNode</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00539">_CELL_DATA::_u::KeySecurity</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00466">_CM_KEY_NODE::MaxClassLen</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00465">_CM_KEY_NODE::MaxNameLen</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00285">_CM_KEY_CONTROL_BLOCK::ParentKcb</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00463">_CM_KEY_NODE::Security</a>, <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>.
<p>
<pre class="fragment"><div>00045                    :
00046 
00047     Performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first step in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> creation of a registry key.  This
00048     routine checks to make sure <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller has <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> proper access to
00049     create a key here, and allocates space <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> child in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent
00050     cell.  It then calls <a class="code" href="../../d1/d2/cmp_8h.html#a210">CmpDoCreateChild</a> to initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key and
00051     create <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key object.
00052 
00053     This two phase creation allows us to share <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> child creation code
00054     with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> creation of link nodes.
00055 
00056 Arguments:
00057 
00058     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive
00059 
00060     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - supplies index of node to create child under.
00061 
00062     AccessState - <a class="code" href="../../d4/d9/ke_8h.html#a406a193">Running</a> security access state information <span class="keywordflow">for</span> operation.
00063 
00064     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> - supplies pointer to a UNICODE string which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of
00065             <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> child to be created.
00066 
00067     AccessMode - Access mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original caller.
00068 
00069     Context - pointer to <a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">CM_PARSE_CONTEXT</a> structure passed through
00070                 <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object manager
00071 
00072     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a> - <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> of object create <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> relative to
00073 
00074     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> - Relative name (to BaseName)
00075 
00076     Object - The address of a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> created key object, <span class="keywordflow">if</span>
00077              any.
00078 
00079 Return Value:
00080 
00081     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00082 
00083 --*/
00084 {
00085     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00086     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> pparent;
00087     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> pdata;
00088     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> KeyCell;
00089     ULONG       ParentType;
00090     ACCESS_MASK AdditionalAccess;
00091     BOOLEAN CreateAccess;
00092     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> KeyBody;
00093 
00094     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_PARSE) {
00095         KdPrint((<span class="stringliteral">"CmpDoCreate:\n"</span>));
00096     }
00097 
00098     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Context)) {
00099 
00100         <span class="keywordflow">if</span> (Context-&gt;CreateOptions &amp; REG_OPTION_BACKUP_RESTORE) {
00101 
00102             <span class="comment">//</span>
00103             <span class="comment">// we're supposed to be opening for a backup/restore</span>
00104             <span class="comment">// operation, but this is a new create, which makes</span>
00105             <span class="comment">// no sense, so fail.</span>
00106             <span class="comment">//</span>
00107             <span class="keywordflow">return</span> STATUS_OBJECT_NAME_NOT_FOUND;
00108         }
00109 
00110         <span class="comment">//</span>
00111         <span class="comment">// Operation is a create, so set Disposition</span>
00112         <span class="comment">//</span>
00113         Context-&gt;Disposition = REG_CREATED_NEW_KEY;
00114     }
00115 
00116     <span class="comment">//</span>
00117     <span class="comment">// Check to make sure the caller can create a sub-key here.</span>
00118     <span class="comment">//</span>
00119     pparent = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);
00120     pdata = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, pparent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a>);
00121     ParentType = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Cell);
00122 
00123     <span class="keywordflow">if</span> ( (ParentType == <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>) &amp;&amp;
00124          ((Context-&gt;CreateOptions &amp; REG_OPTION_VOLATILE) == 0) )
00125     {
00126         <span class="comment">//</span>
00127         <span class="comment">// Trying to create stable child under volatile parent, report error</span>
00128         <span class="comment">//</span>
00129         <span class="keywordflow">return</span> STATUS_CHILD_MUST_BE_VOLATILE;
00130     }
00131 
00132     <span class="keywordflow">if</span> (pparent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp;   <a class="code" href="../../d9/d0/cmdata_8h.html#a31">KEY_SYM_LINK</a>)
00133     {
00134         <span class="comment">//</span>
00135         <span class="comment">// Disallow attempts to create anything under a symbolic link</span>
00136         <span class="comment">//</span>
00137         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00138     }
00139 
00140     AdditionalAccess = (Context-&gt;CreateOptions &amp; REG_OPTION_CREATE_LINK) ? KEY_CREATE_LINK : 0;
00141 
00142     <span class="comment">//</span>
00143     <span class="comment">// The FullName is not used in the routine CmpCheckCreateAccess,</span>
00144     <span class="comment">// </span>
00145     CreateAccess = <a class="code" href="../../d7/d2/cmse_8c.html#a11">CmpCheckCreateAccess</a>(NULL,
00146                                         &amp;(pdata-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o2">KeySecurity</a>.<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o6">Descriptor</a>),
00147                                         AccessState,
00148                                         AccessMode,
00149                                         AdditionalAccess,
00150                                         &amp;status);
00151 
00152     <span class="keywordflow">if</span> (CreateAccess) {
00153 
00154         <span class="comment">//</span>
00155         <span class="comment">// Security check passed, so we can go ahead and create</span>
00156         <span class="comment">// the sub-key.</span>
00157         <span class="comment">//</span>
00158         <span class="keywordflow">if</span> ( !(Context-&gt;CreateOptions &amp; REG_OPTION_VOLATILE) &amp;&amp;
00159              !<a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, Cell)) {
00160 
00161             <span class="keywordflow">return</span> STATUS_NO_LOG_SPACE;
00162         }
00163 
00164         <span class="comment">//</span>
00165         <span class="comment">// Create and initialize the new sub-key</span>
00166         <span class="comment">//</span>
00167         status = <a class="code" href="../../d3/d2/cmparse2_8c.html#a2">CmpDoCreateChild</a>( Hive,
00168                                    Cell,
00169                                    &amp;(pdata-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o2">KeySecurity</a>.<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o6">Descriptor</a>),
00170                                    AccessState,
00171                                    Name,
00172                                    AccessMode,
00173                                    Context,
00174                                    ParentKcb,
00175                                    0,
00176                                    &amp;KeyCell,
00177                                    Object );
00178 
00179         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00180 
00181             <span class="comment">//</span>
00182             <span class="comment">// Child successfully created, add to parent's list.</span>
00183             <span class="comment">//</span>
00184             <span class="keywordflow">if</span> (! <a class="code" href="../../d1/d2/cmp_8h.html#a305">CmpAddSubKey</a>(Hive, Cell, KeyCell)) {
00185 
00186                 <span class="comment">//</span>
00187                 <span class="comment">// Unable to add child, so free it</span>
00188                 <span class="comment">//</span>
00189                 <a class="code" href="../../d3/d3/cmtredel_8c.html#a1">CmpFreeKeyByCell</a>(Hive, KeyCell, FALSE);
00190                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00191             }
00192 
00193             <span class="comment">//</span>
00194             <span class="comment">// Update max keyname and class name length fields</span>
00195             <span class="comment">//</span>
00196             <span class="keywordflow">if</span> (pparent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o11">MaxNameLen</a> &lt; <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length) {
00197                 pparent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o11">MaxNameLen</a> = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length;
00198             }
00199 
00200             <span class="keywordflow">if</span> (pparent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o12">MaxClassLen</a> &lt; Context-&gt;Class.Length) {
00201                 pparent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o12">MaxClassLen</a> = Context-&gt;Class.Length;
00202             }
00203 
00204             KeyBody = (<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)(*Object);
00205 
00206             <span class="comment">//</span>
00207             <span class="comment">// A new key is created, invalid the subkey info of the parent KCB.</span>
00208             <span class="comment">//</span>
00209             <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
00210 
00211             <a class="code" href="../../d8/d2/cmsubs_8c.html#a15">CmpCleanUpSubKeyInfo</a> (KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o9">ParentKcb</a>);
00212 
00213             <span class="keywordflow">if</span> (Context-&gt;CreateOptions &amp; REG_OPTION_CREATE_LINK) {
00214                 pdata = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, KeyCell);
00215                 pdata-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/cmdata_8h.html#a31">KEY_SYM_LINK</a>;
00216                 KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o8">Flags</a> = pdata-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a>;
00217 
00218             }
00219         }
00220     }
00221     <span class="keywordflow">return</span> status;
00222 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a210" doxytag="cmp.h::CmpDoCreateChild" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpDoCreateChild           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ParentCell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR ParentDescriptor&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Name</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">PCM_PARSE_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ParentKcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyCell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00226">226</a> of file <a class="el" href="../../d4/d1/cmparse2_8c-source.html">cmparse2.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00346">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>, <a class="el" href="../../d0/d5/se_8h.html#a200a111">AssignSecurityDescriptor</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00464">_CM_KEY_NODE::Class</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00476">_CM_KEY_NODE::ClassLength</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00422">CM_KEY_NODE_SIGNATURE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00074">CmpCopyName()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00824">CmpCreateKeyControlBlock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01184">CmpDereferenceKeyControlBlockWithLock()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00683">CmpHKeyNodeSize</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01260">CmpRemoveKeyControlBlock()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00114">CmpReportNotify()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00158">CmpSecurityMethod()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00260">CMS_PARSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00332">_CHILD_LIST::Count</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00526">ENLIST_KEYBODY_IN_KEYBODY_LIST</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00168">_OBJECT_TYPE_INITIALIZER::GenericMapping</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00386">HvAllocateCell()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d5/d5/regext_8c-source.html#l00458">kcb()</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00486">KEY_BODY_TYPE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00440">KEY_COMP_NAME</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00442">KEY_PREDEF_HANDLE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00492">_CM_KEY_BODY::KeyControlBlock</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00542">_CELL_DATA::_u::KeyString</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00451">_CM_KEY_NODE::LastWriteTime</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00333">_CHILD_LIST::List</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00466">_CM_KEY_NODE::MaxClassLen</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00465">_CM_KEY_NODE::MaxNameLen</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00468">_CM_KEY_NODE::MaxValueDataLen</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00467">_CM_KEY_NODE::MaxValueNameLen</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00477">_CM_KEY_NODE::Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00475">_CM_KEY_NODE::NameLength</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00493">_CM_KEY_BODY::NotifyBlock</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00453">_CM_KEY_NODE::Parent</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00173">_OBJECT_TYPE_INITIALIZER::PoolType</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00494">_CM_KEY_BODY::Process</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00766">REG_OPTION_PREDEF_HANDLE</a>, <a class="el" href="../../d2/d4/seassign_8c-source.html#l00089">SeAssignSecurity()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00463">_CM_KEY_NODE::Security</a>, <a class="el" href="../../d2/d4/seassign_8c-source.html#l00373">SeDeassignSecurity()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00449">_CM_KEY_NODE::Signature</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00452">_CM_KEY_NODE::Spare</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00454">_CM_KEY_NODE::SubKeyCounts</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00457">_CM_KEY_NODE::SubKeyLists</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00491">_CM_KEY_BODY::Type</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>, <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00458">_CM_KEY_NODE::ValueList</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01252">CmpCreateLinkNode()</a>, and <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00033">CmpDoCreate()</a>.
<p>
<pre class="fragment"><div>00242                    :
00243 
00244     Creates a <span class="keyword">new</span> sub-key.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by <a class="code" href="../../d1/d2/cmp_8h.html#a209">CmpDoCreate</a> to create child
00245     sub-keys and <a class="code" href="../../d2/d2/cmparse_8c.html#a19">CmpCreateLinkNode</a> to create root sub-keys.
00246 
00247 Arguments:
00248 
00249     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive
00250 
00251     ParentCell - supplies cell index of parent cell
00252 
00253     ParentDescriptor - Supplies security descriptor of parent key, <span class="keywordflow">for</span> use
00254            in inheriting ACLs.
00255 
00256     AccessState - <a class="code" href="../../d4/d9/ke_8h.html#a406a193">Running</a> security access state information <span class="keywordflow">for</span> operation.
00257 
00258     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> - Supplies pointer to a UNICODE string which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00259            child to be created.
00260 
00261     AccessMode - Access mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original caller.
00262 
00263     Context - Supplies pointer to <a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">CM_PARSE_CONTEXT</a> structure passed through
00264            <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object manager.
00265 
00266     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a> - <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> of object create <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> relative to
00267 
00268     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> - Relative name (to BaseName)
00269 
00270     Flags - Supplies any flags to be set in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly created node
00271 
00272     KeyCell - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cell index of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly created sub-key, <span class="keywordflow">if</span> any.
00273 
00274     Object - Receives a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> created key object, <span class="keywordflow">if</span> any.
00275 
00276 Return Value:
00277 
00278     STATUS_SUCCESS - sub-key successfully created.  New object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned in
00279             Object, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> cell's cell index <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned in KeyCell.
00280 
00281     !STATUS_SUCCESS - appropriate error message.
00282 
00283 --*/
00284 
00285 {
00286     ULONG clean=0;
00287     ULONG alloc=0;
00288     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00289     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> KeyBody;
00290     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ClassCell=<a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00291     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> KeyNode;
00292     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> CellData;
00293     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00294     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> fkcb;
00295     LONG found;
00296     ULONG StorageType;
00297     PSECURITY_DESCRIPTOR NewDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00298     LARGE_INTEGER systemtime;
00299 
00300     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_PARSE) {
00301         KdPrint((<span class="stringliteral">"CmpDoCreateChild:\n"</span>));
00302     }
00303     <span class="keywordflow">try</span> {
00304         <span class="comment">//</span>
00305         <span class="comment">// Get allocation type</span>
00306         <span class="comment">//</span>
00307         StorageType = <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>;
00308         <span class="keywordflow">if</span> (Context-&gt;CreateOptions &amp; REG_OPTION_VOLATILE) {
00309             StorageType = <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>;
00310         }
00311 
00312         <span class="comment">//</span>
00313         <span class="comment">// Allocate child cell</span>
00314         <span class="comment">//</span>
00315         *KeyCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(
00316                         Hive,
00317                         <a class="code" href="../../d1/d2/cmp_8h.html#a98">CmpHKeyNodeSize</a>(Hive, Name),
00318                         StorageType
00319                         );
00320         <span class="keywordflow">if</span> (*KeyCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00321                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00322                         __leave;
00323         }
00324         alloc = 1;
00325         KeyNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, *KeyCell);
00326 
00327         <span class="comment">//</span>
00328         <span class="comment">// Allocate cell for class name</span>
00329         <span class="comment">//</span>
00330         <span class="keywordflow">if</span> (Context-&gt;Class.Length &gt; 0) {
00331             ClassCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(Hive, Context-&gt;Class.Length, StorageType);
00332             <span class="keywordflow">if</span> (ClassCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00333                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00334                                 __leave;
00335             }
00336         }
00337         alloc = 2;
00338         <span class="comment">//</span>
00339         <span class="comment">// Allocate the object manager object</span>
00340         <span class="comment">//</span>
00341         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>(AccessMode,
00342                                 CmpKeyObjectType,
00343                                 NULL,
00344                                 AccessMode,
00345                                 NULL,
00346                                 <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">CM_KEY_BODY</a>),
00347                                 0,
00348                                 0,
00349                                 Object);
00350 
00351         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00352 
00353             KeyBody = (<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)(*Object);
00354 
00355             <span class="comment">//</span>
00356             <span class="comment">// We have managed to allocate all of the objects we need to,</span>
00357             <span class="comment">// so initialize them</span>
00358             <span class="comment">//</span>
00359 
00360             <span class="comment">//</span>
00361             <span class="comment">// Mark the object as uninitialized (in case we get an error too soon)</span>
00362             <span class="comment">//</span>
00363             KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o0">Type</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a78">KEY_BODY_TYPE</a>;
00364             KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00365 
00366             <span class="comment">//</span>
00367             <span class="comment">// Fill in the class name</span>
00368             <span class="comment">//</span>
00369             <span class="keywordflow">if</span> (Context-&gt;Class.Length &gt; 0) {
00370 
00371                 CellData = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ClassCell);
00372 
00373                 <span class="keywordflow">try</span> {
00374 
00375                     RtlMoveMemory(
00376                         &amp;(CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o5">KeyString</a>[0]),
00377                         Context-&gt;Class.Buffer,
00378                         Context-&gt;Class.Length
00379                         );
00380 
00381                 } except(EXCEPTION_EXECUTE_HANDLER) {
00382                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(*Object);
00383                     <span class="keywordflow">return</span> GetExceptionCode();
00384                 }
00385             }
00386 
00387             <span class="comment">//</span>
00388             <span class="comment">// Fill in the new key itself</span>
00389             <span class="comment">//</span>
00390             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o0">Signature</a> = <a class="code" href="../../d9/d0/cmdata_8h.html#a25">CM_KEY_NODE_SIGNATURE</a>;
00391             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> = Flags;
00392 
00393             <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;systemtime);
00394             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o2">LastWriteTime</a> = systemtime;
00395 
00396             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o3">Spare</a> = 0;
00397             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a> = ParentCell;
00398             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] = 0;
00399             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>] = 0;
00400             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00401             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00402             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> = 0;
00403             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00404             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00405             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o10">Class</a> = ClassCell;
00406             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a> = Context-&gt;Class.Length;
00407 
00408             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o14">MaxValueDataLen</a> = 0;
00409             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o11">MaxNameLen</a> = 0;
00410             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o13">MaxValueNameLen</a> = 0;
00411             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o12">MaxClassLen</a> = 0;
00412 
00413             KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a317">CmpCopyName</a>(Hive,
00414                                               KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,
00415                                               Name);
00416             <span class="keywordflow">if</span> (KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a> &lt; <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length) {
00417                 KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>;
00418             }
00419 
00420             <span class="keywordflow">if</span> (Context-&gt;CreateOptions &amp; <a class="code" href="../../d1/d2/cmp_8h.html#a112">REG_OPTION_PREDEF_HANDLE</a>) {
00421                 KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> = (ULONG)((ULONG_PTR)Context-&gt;PredefinedHandle);
00422                 KeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/cmdata_8h.html#a33">KEY_PREDEF_HANDLE</a>;
00423             }
00424 
00425             <span class="comment">//</span>
00426             <span class="comment">// Create kcb here so all data are filled in.</span>
00427             <span class="comment">//</span>
00428             <span class="comment">// Allocate a key control block</span>
00429             <span class="comment">//</span>
00430             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = <a class="code" href="../../d8/d2/cmsubs_8c.html#a20">CmpCreateKeyControlBlock</a>(Hive, *KeyCell, KeyNode, ParentKcb, FALSE, Name);
00431             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00432                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(*Object);
00433                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00434             }
00435             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;RefCount == 1);
00436             alloc = 3;
00437 
00438             <span class="comment">//</span>
00439             <span class="comment">// Fill in CM specific fields in the object</span>
00440             <span class="comment">//</span>
00441             KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o0">Type</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a78">KEY_BODY_TYPE</a>;
00442             KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a> = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00443             KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o2">NotifyBlock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00444             KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o3">Process</a> = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00445             <a class="code" href="../../d1/d2/cmp_8h.html#a81">ENLIST_KEYBODY_IN_KEYBODY_LIST</a>(KeyBody);
00446             <span class="comment">//</span>
00447             <span class="comment">// Assign a security descriptor to the object.  Note that since</span>
00448             <span class="comment">// registry keys are container objects, and ObAssignSecurity</span>
00449             <span class="comment">// assumes that the only container object in the world is</span>
00450             <span class="comment">// the ObpDirectoryObjectType, we have to call SeAssignSecurity</span>
00451             <span class="comment">// directly in order to get the right inheritance.</span>
00452             <span class="comment">//</span>
00453 
00454             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d5/seassign_8c.html#a1">SeAssignSecurity</a>(ParentDescriptor,
00455                                       AccessState-&gt;SecurityDescriptor,
00456                                       &amp;NewDescriptor,
00457                                       TRUE,             <span class="comment">// container object</span>
00458                                       &amp;AccessState-&gt;SubjectSecurityContext,
00459                                       &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>,
00460                                       <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a>);
00461             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00462                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d2/cmse_8c.html#a9">CmpSecurityMethod</a>(*Object,
00463                                            AssignSecurityDescriptor,
00464                                            NULL,
00465                                            NewDescriptor,
00466                                            NULL,
00467                                            NULL,
00468                                            <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a>,
00469                                            &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>);
00470             }
00471 
00472             <span class="comment">//</span>
00473             <span class="comment">// Since the security descriptor now lives in the hive,</span>
00474             <span class="comment">// free the in-memory copy</span>
00475             <span class="comment">//</span>
00476             <a class="code" href="../../d1/d5/seassign_8c.html#a3">SeDeassignSecurity</a>( &amp;NewDescriptor );
00477 
00478             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00479 
00480                 <span class="comment">//</span>
00481                 <span class="comment">// Note that the dereference will clean up the kcb, so</span>
00482                 <span class="comment">// make sure and decrement the allocation count here.</span>
00483                 <span class="comment">//</span>
00484                 <span class="comment">// Also mark the kcb as deleted so it does not get </span>
00485                 <span class="comment">// inappropriately cached.</span>
00486                 <span class="comment">//</span>
00487                 <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
00488                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;Delete = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00489                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a24">CmpRemoveKeyControlBlock</a>(kcb);
00490                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(*Object);
00491                 alloc = 2;
00492 
00493             } <span class="keywordflow">else</span> {
00494                 <a class="code" href="../../d6/d3/cmwraper_8c.html#a13">CmpReportNotify</a>(
00495                         kcb,
00496                         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyHive,
00497                         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyCell,
00498                         REG_NOTIFY_CHANGE_NAME
00499                         );
00500             }
00501         }
00502 
00503     } finally {
00504 
00505         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00506 
00507             <span class="comment">//</span>
00508             <span class="comment">// Clean up allocations</span>
00509             <span class="comment">//</span>
00510             <span class="keywordflow">switch</span> (alloc) {
00511             <span class="keywordflow">case</span> 3:
00512                 <span class="comment">//</span>
00513                 <span class="comment">// Mark KCB as deleted so it does not get inadvertently added to </span>
00514                 <span class="comment">// the delayed close list. That would have fairly disastrous effects</span>
00515                 <span class="comment">// as the KCB points to storage we are about to free.</span>
00516                 <span class="comment">//</span>
00517                 <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
00518                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;Delete = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00519                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a24">CmpRemoveKeyControlBlock</a>(kcb);
00520                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a23">CmpDereferenceKeyControlBlockWithLock</a>(kcb);
00521                 <span class="comment">// DELIBERATE FALL</span>
00522 
00523             <span class="keywordflow">case</span> 2:
00524                 <span class="keywordflow">if</span> (Context-&gt;Class.Length &gt; 0) {
00525                     <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, ClassCell);
00526                 }
00527                 <span class="comment">// DELIBERATE FALL</span>
00528 
00529             <span class="keywordflow">case</span> 1:
00530                 <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, *KeyCell);
00531                 <span class="comment">// DELIBERATE FALL</span>
00532             }
00533         }
00534     }
00535 
00536     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00537 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a219" doxytag="cmp.h::CmpDoFileSetSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpDoFileSetSize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00227">227</a> of file <a class="el" href="../../d8/d2/cmwrapr_8c-source.html">cmwrapr.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00360">ASSERT_PASSIVE_LEVEL</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00048">CmpIoFileSetSize</a>, <a class="el" href="../../d7/d0/cmdat2_8c.html#a20">CmRegistryIODebug</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00650">_CMHIVE::FileHandles</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l10281">IoSetThreadHardErrorMode()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00861">ZwSetInformationFile()</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00509">CmpFileSetSize()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00323">CmpWorkerCommand()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00775">HvpDoWriteHive()</a>, and <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01433">HvWriteHive()</a>.
<p>
<pre class="fragment"><div>00234                    :
00235 
00236     This routine sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  It must not <span class="keywordflow">return</span> until
00237     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> guaranteed.
00238 
00239     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> environment specific.
00240 
00241     Must be running in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cmp worker thread.
00242 
00243 Arguments:
00244 
00245     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> we are doing I/O <span class="keywordflow">for</span>
00246 
00247     FileType - which supporting <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to use
00248 
00249     FileSize - 32 bit value to set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>'s size to
00250 
00251 Return Value:
00252 
00253     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>
00254     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> success
00255 
00256 --*/
00257 {
00258     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive;
00259     HANDLE  FileHandle;
00260     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00261     FILE_END_OF_FILE_INFORMATION FileInfo;
00262     IO_STATUS_BLOCK IoStatus;
00263     BOOLEAN oldFlag;
00264 
00265     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FIELD_OFFSET(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive) == 0);
00266 
00267     CmHive = (<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00268     FileHandle = CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[FileType];
00269     <span class="keywordflow">if</span> (FileHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00270         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00271     }
00272 
00273     <span class="comment">//</span>
00274     <span class="comment">// disable hard error popups, to avoid self deadlock on bogus devices</span>
00275     <span class="comment">//</span>
00276     oldFlag = <a class="code" href="../../d4/d6/iosubs_8c.html#a108">IoSetThreadHardErrorMode</a>(FALSE);
00277 
00278     FileInfo.EndOfFile.HighPart = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00279     FileInfo.EndOfFile.LowPart  = FileSize;
00280 
00281     <a class="code" href="../../d1/d2/cmp_8h.html#a63">ASSERT_PASSIVE_LEVEL</a>();
00282 
00283     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a39">ZwSetInformationFile</a>(
00284                 FileHandle,
00285                 &amp;IoStatus,
00286                 (PVOID)&amp;FileInfo,
00287                 <span class="keyword">sizeof</span>(FILE_END_OF_FILE_INFORMATION),
00288                 FileEndOfFileInformation
00289                 );
00290 
00291     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00292         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IoStatus.Status == Status);
00293     } <span class="keywordflow">else</span> {
00294         
00295         <span class="comment">//</span>
00296         <span class="comment">// set debugging info</span>
00297         <span class="comment">//</span>
00298         <a class="code" href="../../d7/d0/cmdat2_8c.html#a20">CmRegistryIODebug</a>.Action = <a class="code" href="../../d7/d3/cmwrapr_8c.html#a3">CmpIoFileSetSize</a>;
00299         <a class="code" href="../../d7/d0/cmdat2_8c.html#a20">CmRegistryIODebug</a>.Handle = FileHandle;
00300         <a class="code" href="../../d7/d0/cmdat2_8c.html#a20">CmRegistryIODebug</a>.Status = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00301         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CmpFileSetSize:\tHandle=%08lx  NewLength=%08lx  \n"</span>, FileHandle, FileSize);
00302     }
00303 
00304     <span class="comment">//</span>
00305     <span class="comment">// restore hard error popups mode</span>
00306     <span class="comment">//</span>
00307     <a class="code" href="../../d4/d6/iosubs_8c.html#a108">IoSetThreadHardErrorMode</a>(oldFlag);
00308 
00309     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00310 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a243" doxytag="cmp.h::CmpDoFlushAll" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpDoFlushAll           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02195">2195</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00660">CmLockHive</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00027">CmpHiveListHead</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00036">CmpMasterHive</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00025">CmpNoWrite</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00662">CmUnlockHive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00649">_CMHIVE::Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00204">HIVE_NOLAZYFLUSH</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00622">_HHIVE::HiveFlags</a>, <a class="el" href="../../d5/d5/regext_8c-source.html#l00033">HiveList</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00647">HvSyncHive()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00564">CmFlushKey()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00461">CmpLazyFlushWorker()</a>, and <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>.
<p>
<pre class="fragment"><div>02200                    :
02201 
02202     Flush all hives.
02203 
02204     Runs in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CmpWorkerThread.
02205 
02206     Runs down list of Hives and applies <a class="code" href="../../d6/d0/hive_8h.html#a34">HvSyncHive</a> to them.
02207 
02208     NOTE: Hives which are marked as HV_NOLAZYFLUSH are *NOT* flushed
02209           by <span class="keyword">this</span> call.  You must call <a class="code" href="../../d6/d0/hive_8h.html#a34">HvSyncHive</a> explicitly to flush
02210           a hive marked as HV_NOLAZYFLUSH.
02211 
02212 Arguments:
02213 
02214 Return Value:
02215 
02216     NONE
02217 
02218 --*/
02219 {
02220     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02221     PLIST_ENTRY p;
02222     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>     h;
02223     BOOLEAN     Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;    
02224 <span class="comment">/*</span>
02225 <span class="comment">    ULONG rc;</span>
02226 <span class="comment">*/</span>
02227     <span class="keyword">extern</span> <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>;
02228 
02229     <span class="comment">//</span>
02230     <span class="comment">// If writes are not working, lie and say we succeeded, will</span>
02231     <span class="comment">// clean up in a short time.  Only early system init code</span>
02232     <span class="comment">// will ever know the difference.</span>
02233     <span class="comment">//</span>
02234     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/cmapi_8c.html#a0">CmpNoWrite</a>) {
02235         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02236     }
02237 
02238     <span class="comment">//</span>
02239     <span class="comment">// traverse list of hives, sync each one</span>
02240     <span class="comment">//</span>
02241     p = <a class="code" href="../../d8/d9/cmapi_8c.html#a1">CmpHiveListHead</a>.Flink;
02242     <span class="keywordflow">while</span> (p != &amp;<a class="code" href="../../d8/d9/cmapi_8c.html#a1">CmpHiveListHead</a>) {
02243 
02244         h = CONTAINING_RECORD(p, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, HiveList);
02245 
02246 <span class="comment">/*</span>
02247 <span class="comment">#if DBG</span>
02248 <span class="comment">        if (h!=CmpMasterHive) {</span>
02249 <span class="comment">            rc = CmCheckRegistry(h, FALSE);</span>
02250 <span class="comment"></span>
02251 <span class="comment">            if (rc!=0) {</span>
02252 <span class="comment">                KdPrint(("CmpDoFlushAll: corrupt hive, rc = %08lx\n",rc));</span>
02253 <span class="comment">                DbgBreakPoint();</span>
02254 <span class="comment">            }</span>
02255 <span class="comment">        }</span>
02256 <span class="comment">#endif</span>
02257 <span class="comment">*/</span>
02258         <span class="keywordflow">if</span> (!(h-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a10">HIVE_NOLAZYFLUSH</a>)) {
02259 
02260             <span class="comment">//</span>
02261             <span class="comment">//Lock the hive before we flush it.</span>
02262             <span class="comment">//-- since we now allow multiple readers</span>
02263             <span class="comment">// during a flush (a flush is considered a read)</span>
02264             <span class="comment">// we have to force a serialization on the vector table</span>
02265             <span class="comment">//</span>
02266             <a class="code" href="../../d1/d2/cmp_8h.html#a94">CmLockHive</a> (h);
02267             
02268             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/hivesync_8c.html#a13">HvSyncHive</a>((<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)h);
02269 
02270             <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) ) {
02271                 Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02272             }
02273             <a class="code" href="../../d1/d2/cmp_8h.html#a95">CmUnlockHive</a> (h);
02274             <span class="comment">//</span>
02275             <span class="comment">// WARNNOTE - the above means that a lazy flush or</span>
02276             <span class="comment">//            or shutdown flush did not work.  we don't</span>
02277             <span class="comment">//            know why.  there is noone to report an error</span>
02278             <span class="comment">//            to, so continue on and hope for the best.</span>
02279             <span class="comment">//            (in theory, worst that can happen is user changes</span>
02280             <span class="comment">//             are lost.)</span>
02281             <span class="comment">//</span>
02282         }
02283 
02284 
02285         p = p-&gt;Flink;
02286     }
02287     
02288     <span class="keywordflow">return</span> Result;
02289 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a222" doxytag="cmp.h::CmpFileFlush" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpFileFlush           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00772">772</a> of file <a class="el" href="../../d8/d2/cmwrapr_8c-source.html">cmwrapr.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00360">ASSERT_PASSIVE_LEVEL</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00049">CmpIoFileFlush</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00025">CmpNoWrite</a>, <a class="el" href="../../d7/d0/cmdat2_8c.html#a20">CmRegistryIODebug</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00259">CMS_IO</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00650">_CMHIVE::FileHandles</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, and <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01261">CmpSaveKeyByFileCopy()</a>.
<p>
<pre class="fragment"><div>00778                    :
00779 
00780     This routine performs a flush on a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> handle.
00781 
00782 Arguments:
00783 
00784     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> we are doing I/O <span class="keywordflow">for</span>
00785 
00786     FileType - which supporting <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to use
00787 
00788 Return Value:
00789 
00790     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>
00791     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> success
00792 
00793 --*/
00794 {
00795     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00796     IO_STATUS_BLOCK IoStatus;
00797     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive;
00798     HANDLE  FileHandle;
00799 
00800     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FIELD_OFFSET(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive) == 0);
00801     CmHive = (<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00802     FileHandle = CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[FileType];
00803     <span class="keywordflow">if</span> (FileHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00804         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00805     }
00806 
00807     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/cmapi_8c.html#a0">CmpNoWrite</a>) {
00808         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00809     }
00810 
00811     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_IO) {
00812         KdPrint((<span class="stringliteral">"CmpFileFlush:\n\tHandle = %08lx\n"</span>, FileHandle));
00813     }
00814 
00815     <a class="code" href="../../d1/d2/cmp_8h.html#a63">ASSERT_PASSIVE_LEVEL</a>();
00816 
00817     status = ZwFlushBuffersFile(
00818                 FileHandle,
00819                 &amp;IoStatus
00820                 );
00821 
00822     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00823         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IoStatus.Status == status);
00824         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00825     } <span class="keywordflow">else</span> {
00826         <span class="comment">//</span>
00827         <span class="comment">// set debugging info</span>
00828         <span class="comment">//</span>
00829         <a class="code" href="../../d7/d0/cmdat2_8c.html#a20">CmRegistryIODebug</a>.Action = <a class="code" href="../../d7/d3/cmwrapr_8c.html#a4">CmpIoFileFlush</a>;
00830         <a class="code" href="../../d7/d0/cmdat2_8c.html#a20">CmRegistryIODebug</a>.Handle = FileHandle;
00831         <a class="code" href="../../d7/d0/cmdat2_8c.html#a20">CmRegistryIODebug</a>.Status = status;
00832         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CmpFileFlush:\tFailure1: status = %08lx  IoStatus = %08lx\n"</span>,status,IoStatus.Status);
00833         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00834     }
00835     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00836 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a221" doxytag="cmp.h::CmpFileRead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpFileRead           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DataBuffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DataLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00351">351</a> of file <a class="el" href="../../d8/d2/cmwrapr_8c-source.html">cmwrapr.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00360">ASSERT_PASSIVE_LEVEL</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00313">CmpCreateEvent()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00046">CmpIoFileRead</a>, <a class="el" href="../../d7/d0/cmdat2_8c.html#a20">CmRegistryIODebug</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00259">CMS_IO</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00275">CMS_IO_ERROR</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00650">_CMHIVE::FileHandles</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00044">MAX_FILE_IO</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, and <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>.
<p>
<pre class="fragment"><div>00360                    :
00361 
00362     This routine reads in a buffer from a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00363 
00364     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> environment specific.
00365 
00366     NOTE:   We assume <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> opened <span class="keywordflow">for</span> asynchronous access,
00367             and that we, and not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IO system, are keeping <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00368             offset pointer.
00369 
00370     NOTE:   Only 32bit offsets are supported, even though <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> underlying
00371             IO system on NT supports 64 bit offsets.
00372 
00373 Arguments:
00374 
00375     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> we are doing I/O <span class="keywordflow">for</span>
00376 
00377     FileType - which supporting <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to use
00378 
00379     FileOffset - pointer to variable providing 32bit offset on input,
00380                  and receiving <span class="keyword">new</span> 32bit offset on output.
00381 
00382     DataBuffer - pointer to buffer
00383 
00384     DataLength - length of buffer
00385 
00386 Return Value:
00387 
00388     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>
00389     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> success
00390 
00391 --*/
00392 {
00393     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00394     LARGE_INTEGER   <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00395     IO_STATUS_BLOCK IoStatus;
00396     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive;
00397     HANDLE  FileHandle;
00398     ULONG LengthToRead;
00399     HANDLE eventHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00400     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> eventObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00401 
00402     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FIELD_OFFSET(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive) == 0);
00403     CmHive = (<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00404     FileHandle = CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[FileType];
00405     <span class="keywordflow">if</span> (FileHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00406         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00407     }
00408 
00409     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_IO) {
00410         KdPrint((<span class="stringliteral">"CmpFileRead:\n"</span>));
00411         KdPrint((<span class="stringliteral">"\tHandle=%08lx  Offset=%08lx  "</span>, FileHandle, *FileOffset));
00412         KdPrint((<span class="stringliteral">"Buffer=%08lx  Length=%08lx\n"</span>, DataBuffer, DataLength));
00413     }
00414 
00415     <span class="comment">//</span>
00416     <span class="comment">// Detect attempt to read off end of 2gig file (this should be irrelevent)</span>
00417     <span class="comment">//</span>
00418     <span class="keywordflow">if</span> ((0xffffffff - *FileOffset) &lt; DataLength) {
00419         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_IO_ERROR) KdPrint(("CmpFileRead: runoff\n"));
00420         return FALSE;
00421     }
00422 
00423     status = CmpCreateEvent(
00424         SynchronizationEvent,
00425         &amp;eventHandle,
00426         &amp;eventObject);
00427     if (!NT_SUCCESS(status))
00428         return FALSE;
00429 
00430     <span class="comment">//</span>
00431     <span class="comment">// We'd really like to just call the filesystems and have them do</span>
00432     <span class="comment">// the right thing.  But the filesystem will attempt to lock our</span>
00433     <span class="comment">// entire buffer into memory, and that may fail for large requests.</span>
00434     <span class="comment">// So we split our reads into 64k chunks and call the filesystem for</span>
00435     <span class="comment">// each one.</span>
00436     <span class="comment">//</span>
00437     ASSERT_PASSIVE_LEVEL();
00438     while (DataLength &gt; 0) {
00439 
00440         <span class="comment">//</span>
00441         <span class="comment">// Convert ULONG to Large</span>
00442         <span class="comment">//</span>
00443         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.LowPart = *FileOffset;
00444         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.HighPart = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00445 
00446         <span class="comment">//</span>
00447         <span class="comment">// trim request down if necessary.</span>
00448         <span class="comment">//</span>
00449         <span class="keywordflow">if</span> (DataLength &gt; <a class="code" href="../../d7/d3/cmwrapr_8c.html#a0">MAX_FILE_IO</a>) {
00450             LengthToRead = <a class="code" href="../../d7/d3/cmwrapr_8c.html#a0">MAX_FILE_IO</a>;
00451         } <span class="keywordflow">else</span> {
00452             LengthToRead = DataLength;
00453         }
00454 
00455         status = ZwReadFile(
00456                     FileHandle,
00457                     eventHandle,
00458                     NULL,               <span class="comment">// apcroutine</span>
00459                     NULL,               <span class="comment">// apccontext</span>
00460                     &amp;IoStatus,
00461                     DataBuffer,
00462                     LengthToRead,
00463                     &amp;Offset,
00464                     NULL                <span class="comment">// key</span>
00465                     );
00466 
00467         <span class="keywordflow">if</span> (STATUS_PENDING == status) {
00468             status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(eventObject, Executive,
00469                                            KernelMode, FALSE, NULL);
00470             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(STATUS_SUCCESS == status);
00471             status = IoStatus.Status;
00472         }
00473 
00474         <span class="comment">//</span>
00475         <span class="comment">// adjust offsets</span>
00476         <span class="comment">//</span>
00477         *FileOffset = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.LowPart + LengthToRead;
00478         DataLength -= LengthToRead;
00479         (PUCHAR)DataBuffer += LengthToRead;
00480 
00481         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00482             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IoStatus.Status == status);
00483             <span class="keywordflow">if</span> (IoStatus.Information != LengthToRead) {
00484                 <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_IO_ERROR) {
00485                     KdPrint((<span class="stringliteral">"CmpFileRead:\n\t"</span>));
00486                     KdPrint((<span class="stringliteral">"Failure1: status = %08lx  "</span>, status));
00487                     KdPrint((<span class="stringliteral">"IoInformation = %08lx\n"</span>, IoStatus.Information));
00488                 }
00489                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(eventObject);
00490                 ZwClose(eventHandle);
00491                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00492             }
00493         } <span class="keywordflow">else</span> {
00494             <span class="comment">//</span>
00495             <span class="comment">// set debugging info</span>
00496             <span class="comment">//</span>
00497             <a class="code" href="../../d7/d0/cmdat2_8c.html#a20">CmRegistryIODebug</a>.Action = <a class="code" href="../../d7/d3/cmwrapr_8c.html#a1">CmpIoFileRead</a>;
00498             <a class="code" href="../../d7/d0/cmdat2_8c.html#a20">CmRegistryIODebug</a>.Handle = FileHandle;
00499             <a class="code" href="../../d7/d0/cmdat2_8c.html#a20">CmRegistryIODebug</a>.Status = status;
00500             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CmpFileRead:\tFailure2: status = %08lx  IoStatus = %08lx\n"</span>, status, IoStatus.Status);
00501 
00502             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(eventObject);
00503             ZwClose(eventHandle);
00504             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00505         }
00506 
00507     }
00508     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(eventObject);
00509     ZwClose(eventHandle);
00510     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00511 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a218" doxytag="cmp.h::CmpFileSetSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpFileSetSize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d2/cmwrapr2_8c-source.html#l00045">45</a> of file <a class="el" href="../../d9/d2/cmwrapr2_8c-source.html">cmwrapr2.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00227">CmpDoFileSetSize()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00275">CMS_IO_ERROR</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, and <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00726">CmpInitializeHiveList()</a>.
<p>
<pre class="fragment"><div>00052                    :
00053 
00054     This routine sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  It must not <span class="keywordflow">return</span> until
00055     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> guaranteed, therefore, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> does a flush.
00056 
00057     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> environment specific.
00058 
00059     This routine will force execution to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> correct thread context.
00060 
00061 Arguments:
00062 
00063     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> we are doing I/O <span class="keywordflow">for</span>
00064 
00065     FileType - which supporting <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to use
00066 
00067     FileSize - 32 bit value to set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>'s size to
00068 
00069 Return Value:
00070 
00071     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>
00072     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> success
00073 
00074 --*/
00075 {
00076     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00077     <a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html">REGISTRY_COMMAND</a> Command;
00078 
00079     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FIELD_OFFSET(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive) == 0);
00080 
00081     <span class="comment">//</span>
00082     <span class="comment">// Wake up worker thread to do real work for us.</span>
00083     <span class="comment">//</span>
00084     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a>  = <a class="code" href="../../d1/d2/cmp_8h.html#a103">REG_CMD_FILE_SET_SIZE</a>;
00085     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o1">Hive</a>     = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00086     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o3">FileType</a> = FileType;
00087     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o4">FileSize</a> = FileSize;
00088     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
00089     <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
00090     status = Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a>;
00091     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00092 
00093     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00094         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_IO_ERROR) {
00095             KdPrint((<span class="stringliteral">"CmpFileSetSize:\n\t"</span>));
00096             KdPrint((<span class="stringliteral">"Failure: status = %08lx "</span>, status));
00097         }
00098         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00099     }
00100 
00101     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00102 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a220" doxytag="cmp.h::CmpFileWrite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpFileWrite           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a66">PCMP_OFFSET_ARRAY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>offsetArray</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>offsetArrayCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileOffset</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00516">516</a> of file <a class="el" href="../../d8/d2/cmwrapr_8c-source.html">cmwrapr.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00360">ASSERT_PASSIVE_LEVEL</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00313">CmpCreateEvent()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00047">CmpIoFileWrite</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00025">CmpNoWrite</a>, <a class="el" href="../../d7/d0/cmdat2_8c.html#a20">CmRegistryIODebug</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00259">CMS_IO</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00275">CMS_IO_ERROR</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00650">_CMHIVE::FileHandles</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00395">KeWaitForMultipleObjects()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00044">MAX_FILE_IO</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00024">perftouchbuffer</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, and <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01261">CmpSaveKeyByFileCopy()</a>.
<p>
<pre class="fragment"><div>00525                    :
00526 
00527     This routine writes an array of buffers <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00528 
00529     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> environment specific.
00530 
00531     NOTE:   We assume <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> opened <span class="keywordflow">for</span> asynchronous access,
00532             and that we, and not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IO system, are keeping <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00533             offset pointer.
00534 
00535     NOTE:   Only 32bit offsets are supported, even though <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> underlying
00536             IO system on NT supports 64 bit offsets.
00537 
00538 Arguments:
00539 
00540     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> we are doing I/O <span class="keywordflow">for</span>
00541 
00542     FileType - which supporting <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to use
00543 
00544     offsetArray - array of structures where each structure holds a 32bit offset
00545                   into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> and pointer <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> a buffer written to that
00546                   <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> offset.
00547 
00548     offsetArrayCount - number of elements in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offsetArray.
00549 
00550     FileOffset - returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> offset after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last write to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00551 
00552 Return Value:
00553 
00554     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>
00555     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> success
00556 
00557 --*/
00558 {
00559     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00560     LARGE_INTEGER   <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00561     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive;
00562     HANDLE  FileHandle;
00563     ULONG LengthToWrite;
00564     LONG WaitBufferCount = 0;
00565     LONG idx;
00566     ULONG arrayCount = 0;
00567     PVOID       DataBuffer;
00568     ULONG       DataLength;
00569     HANDLE eventHandles[MAXIMUM_WAIT_OBJECTS];
00570     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> eventObjects[MAXIMUM_WAIT_OBJECTS];
00571     <a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">KWAIT_BLOCK</a> waitBlockArray[MAXIMUM_WAIT_OBJECTS];
00572     IO_STATUS_BLOCK IoStatus[MAXIMUM_WAIT_OBJECTS];
00573     BOOLEAN ret_val = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00574 
00575     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/cmapi_8c.html#a0">CmpNoWrite</a>) {
00576         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00577     }
00578 
00579     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FIELD_OFFSET(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive) == 0);
00580     CmHive = (<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00581     FileHandle = CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[FileType];
00582     <span class="keywordflow">if</span> (FileHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00583         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00584     }
00585 
00586     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_IO) {
00587         KdPrint((<span class="stringliteral">"CmpFileWrite:\n"</span>));
00588         KdPrint((<span class="stringliteral">"\tHandle=%08lx  "</span>, FileHandle));
00589     }
00590 
00591     <span class="keywordflow">for</span> (idx = 0; idx &lt; MAXIMUM_WAIT_OBJECTS; idx++) {
00592         eventHandles[idx] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00593     }
00594 
00595     <span class="comment">// Bring pages being written into memory first to allow disk to write</span>
00596     <span class="comment">// buffer contiguously.</span>
00597     <span class="keywordflow">for</span> (idx = 0; (ULONG) idx &lt; offsetArrayCount; idx++) {
00598         <span class="keywordtype">char</span> * start = offsetArray[idx].DataBuffer;
00599         <span class="keywordtype">char</span> * end = (<span class="keywordtype">char</span> *) start + offsetArray[idx].DataLength;
00600         <span class="keywordflow">while</span> (start &lt; end) {
00601             <span class="comment">// perftouchbuffer globally declared so that compiler won't try</span>
00602             <span class="comment">// to remove it and this loop (if its smart enough?).</span>
00603             <a class="code" href="../../d7/d3/cmwrapr_8c.html#a5">perftouchbuffer</a> += (ULONG) *start;
00604             start += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00605         }
00606     }
00607 
00608     <span class="comment">//</span>
00609     <span class="comment">// We'd really like to just call the filesystems and have them do</span>
00610     <span class="comment">// the right thing.  But the filesystem will attempt to lock our</span>
00611     <span class="comment">// entire buffer into memory, and that may fail for large requests.</span>
00612     <span class="comment">// So we split our reads into 64k chunks and call the filesystem for</span>
00613     <span class="comment">// each one.</span>
00614     <span class="comment">//</span>
00615     <a class="code" href="../../d1/d2/cmp_8h.html#a63">ASSERT_PASSIVE_LEVEL</a>();
00616     arrayCount = 0;
00617     DataLength = 0;
00618     <span class="comment">// This outer loop is hit more than once if the MAXIMUM_WAIT_OBJECTS limit</span>
00619     <span class="comment">// is hit before the offset array is drained.</span>
00620     <span class="keywordflow">while</span> (arrayCount &lt; offsetArrayCount) {
00621         WaitBufferCount = 0;
00622 
00623         <span class="comment">// This loop fills the wait buffer.</span>
00624         <span class="keywordflow">while</span> ((arrayCount &lt; offsetArrayCount) &amp;&amp;
00625                (WaitBufferCount &lt; MAXIMUM_WAIT_OBJECTS)) {
00626 
00627             <span class="comment">// If data length isn't zero than the wait buffer filled before the</span>
00628             <span class="comment">// buffer in the last offsetArray element was sent to write file.</span>
00629             <span class="keywordflow">if</span> (DataLength == 0) {
00630                 *FileOffset = offsetArray[arrayCount].FileOffset;
00631                 DataBuffer =  offsetArray[arrayCount].DataBuffer;
00632                 DataLength =  offsetArray[arrayCount].DataLength;
00633                 <span class="comment">//</span>
00634                 <span class="comment">// Detect attempt to read off end of 2gig file</span>
00635                 <span class="comment">// (this should be irrelevent)</span>
00636                 <span class="comment">//</span>
00637                 <span class="keywordflow">if</span> ((0xffffffff - *FileOffset) &lt; DataLength) {
00638                     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_IO_ERROR) KdPrint(("CmpFileWrite: runoff\n"));
00639                     goto Error_Exit;
00640                 }
00641             }
00642             <span class="comment">// else still more to write out of last buffer.</span>
00643 
00644             while ((DataLength &gt; 0) &amp;&amp; (WaitBufferCount &lt; MAXIMUM_WAIT_OBJECTS)) {
00645 
00646                 <span class="comment">//</span>
00647                 <span class="comment">// Convert ULONG to Large</span>
00648                 <span class="comment">//</span>
00649                 <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.LowPart = *FileOffset;
00650                 <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.HighPart = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00651 
00652                 <span class="comment">//</span>
00653                 <span class="comment">// trim request down if necessary.</span>
00654                 <span class="comment">//</span>
00655                 <span class="keywordflow">if</span> (DataLength &gt; <a class="code" href="../../d7/d3/cmwrapr_8c.html#a0">MAX_FILE_IO</a>) {
00656                     LengthToWrite = <a class="code" href="../../d7/d3/cmwrapr_8c.html#a0">MAX_FILE_IO</a>;
00657                 } <span class="keywordflow">else</span> {
00658                     LengthToWrite = DataLength;
00659                 }
00660 
00661                 <span class="comment">// Previously created events are reused.</span>
00662                 <span class="keywordflow">if</span> (eventHandles[WaitBufferCount] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00663                     status = <a class="code" href="../../d7/d3/cmwrapr_8c.html#a14">CmpCreateEvent</a>(SynchronizationEvent,
00664                                             &amp;eventHandles[WaitBufferCount],
00665                                             &amp;eventObjects[WaitBufferCount]);
00666                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00667                         <span class="comment">// Make sure we don't try to clean this up.</span>
00668                         eventHandles[WaitBufferCount] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00669                         <span class="keywordflow">goto</span> Error_Exit;
00670                     }
00671                 }
00672                         
00673                 status = ZwWriteFile(FileHandle,
00674                                      eventHandles[WaitBufferCount],
00675                                      NULL,               <span class="comment">// apcroutine</span>
00676                                      NULL,               <span class="comment">// apccontext</span>
00677                                      &amp;IoStatus[WaitBufferCount],
00678                                      DataBuffer,
00679                                      LengthToWrite,
00680                                      &amp;Offset,
00681                                      NULL);
00682                         
00683                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00684                     <span class="keywordflow">goto</span> Error_Exit;
00685                 }
00686 
00687                 WaitBufferCount++;
00688                 
00689                 <span class="comment">//</span>
00690                 <span class="comment">// adjust offsets</span>
00691                 <span class="comment">//</span>
00692                 *FileOffset = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.LowPart + LengthToWrite;
00693                 DataLength -= LengthToWrite;
00694                 (PUCHAR)DataBuffer += LengthToWrite;
00695             } <span class="comment">// while (DataLength &gt; 0 &amp;&amp; WaitBufferCount &lt; MAXIMUM_WAIT_OBJECTS)</span>
00696             
00697             arrayCount++;
00698             
00699         } <span class="comment">// while (arrayCount &lt; offsetArrayCount &amp;&amp; </span>
00700           <span class="comment">//        WaitBufferCount &lt; MAXIMUM_WAIT_OBJECTS)</span>
00701 
00702         status = <a class="code" href="../../d1/d7/wait_8c.html#a3">KeWaitForMultipleObjects</a>(WaitBufferCount, 
00703                                           eventObjects,
00704                                           WaitAll,
00705                                           Executive,
00706                                           KernelMode, 
00707                                           FALSE, 
00708                                           NULL,
00709                                           waitBlockArray);
00710         
00711         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
00712             <span class="keywordflow">goto</span> Error_Exit;
00713         
00714         <span class="keywordflow">for</span> (idx = 0; idx &lt; WaitBufferCount; idx++) {
00715             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IoStatus[idx].Status)) {
00716                 ret_val = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00717                 <span class="keywordflow">goto</span> Done;
00718             }
00719         }
00720         
00721         <span class="comment">// There may still be more to do if the last element held a big buffer</span>
00722         <span class="comment">// and the wait buffer filled before it was all sent to the file.</span>
00723         <span class="keywordflow">if</span> (DataLength &gt; 0) {
00724             arrayCount--;
00725         }
00726 
00727     } <span class="comment">// while (arrayCount &lt; offsetArrayCount)</span>
00728 
00729     ret_val = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00730 
00731     <span class="keywordflow">goto</span> Done;
00732 Error_Exit:
00733     <span class="comment">//</span>
00734     <span class="comment">// set debugging info</span>
00735     <span class="comment">//</span>
00736     <a class="code" href="../../d7/d0/cmdat2_8c.html#a20">CmRegistryIODebug</a>.Action = <a class="code" href="../../d7/d3/cmwrapr_8c.html#a2">CmpIoFileWrite</a>;
00737     <a class="code" href="../../d7/d0/cmdat2_8c.html#a20">CmRegistryIODebug</a>.Handle = FileHandle;
00738     <a class="code" href="../../d7/d0/cmdat2_8c.html#a20">CmRegistryIODebug</a>.Status = status;
00739     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CmpFileWrite: error exiting %d\n"</span>, status);
00740     <span class="comment">//</span>
00741     <span class="comment">// if WaitBufferCount &gt; 0 then we have successfully issued</span>
00742     <span class="comment">// some I/Os, but not all of them. This is an error, but we</span>
00743     <span class="comment">// cannot return from this routine until all the successfully</span>
00744     <span class="comment">// issued I/Os have completed.</span>
00745     <span class="comment">//</span>
00746     <span class="keywordflow">if</span> (WaitBufferCount &gt; 0) {
00747         status = <a class="code" href="../../d1/d7/wait_8c.html#a3">KeWaitForMultipleObjects</a>(WaitBufferCount, 
00748                                           eventObjects,
00749                                           WaitAll,
00750                                           Executive,
00751                                           KernelMode, 
00752                                           FALSE, 
00753                                           NULL,
00754                                           waitBlockArray);
00755     }
00756 
00757 
00758     ret_val = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00759 Done:
00760     idx = 0;
00761     <span class="comment">// Clean up open event handles and objects.</span>
00762     <span class="keywordflow">while</span> ((idx &lt; MAXIMUM_WAIT_OBJECTS) &amp;&amp; (eventHandles[idx] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00763         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(eventObjects[idx]);
00764         ZwClose(eventHandles[idx]);
00765         idx++;
00766     }
00767     <span class="keywordflow">return</span> ret_val;
00768 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a296" doxytag="cmp.h::CmpFindControlSet" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> CmpFindControlSet           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RootCell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>SelectName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AutoSelect</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01082">1082</a> of file <a class="el" href="../../d1/d9/cmboot_8c-source.html">cmboot.c</a>.
<p>
References <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00186">CmpFindSubKeyByName()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01243">CmpFindValueByName</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00078">CmpValueToData</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00107">PHCELL_INDEX</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d6/d9/heappage_8c.html#a68">sprintf()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d7/regtest_8c.html#a2">strlen()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00499">_CM_KEY_VALUE::Type</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/cmcontrl_8c-source.html#l00050">CmGetSystemControlValues()</a>, and <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02169">CmGetSystemDriverList()</a>.
<p>
<pre class="fragment"><div>01091                    :
01092 
01093     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> parses <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SYSTEM hive and <span class="stringliteral">"Select"</span> node
01094     to locate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> set to be used <span class="keywordflow">for</span> booting.
01095 
01096     Note that <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> also updates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of Current to reflect
01097     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> set that was just found.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> what we want to <span class="keywordflow">do</span>
01098     when <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called during boot.  During I/O initialization, <span class="keyword">this</span>
01099     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> irrelevant, since we're just changing <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> to what <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> already <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>.
01100 
01101 Arguments:
01102 
01103     SystemHive - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SYSTEM hive.
01104 
01105     RootCell - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root cell of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive.
01106 
01107     SelectName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Select value to be used in
01108             determining <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> set.  This should be one of <span class="stringliteral">"Current"</span>
01109             <span class="stringliteral">"Default"</span> or <span class="stringliteral">"LastKnownGood"</span>
01110 
01111     AutoSelect - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AutoSelect value under
01112             <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Select node.
01113 
01114 Return Value:
01115 
01116     != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> set to be used <span class="keywordflow">for</span> booting.
01117     == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a> - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> corrupt or inconsistent
01118 
01119 --*/
01120 
01121 {
01122     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Select;
01123     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ValueCell;
01124     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ControlSet;
01125     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> AutoSelectCell;
01126     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01127     UNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
01128     ANSI_STRING AnsiString;
01129     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01130     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> Value;
01131     PULONG ControlSetIndex;
01132     PULONG CurrentControl;
01133     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> AsciiBuffer[128];
01134     WCHAR UnicodeBuffer[128];
01135     ULONG realsize;
01136 
01137     <span class="comment">//</span>
01138     <span class="comment">// Find \SYSTEM\SELECT node.</span>
01139     <span class="comment">//</span>
01140     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"select"</span>);
01141     Select = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(SystemHive,
01142                                 (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive,RootCell),
01143                                 &amp;Name);
01144     <span class="keywordflow">if</span> (Select == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01145         <span class="keywordflow">return</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>);
01146     }
01147 
01148     <span class="comment">//</span>
01149     <span class="comment">// Find AutoSelect value</span>
01150     <span class="comment">//</span>
01151     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"AutoSelect"</span>);
01152     AutoSelectCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(SystemHive,
01153                                         (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive,Select),
01154                                         &amp;Name);
01155     <span class="keywordflow">if</span> (AutoSelectCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01156         <span class="comment">//</span>
01157         <span class="comment">// It's not there, we don't care.  Set autoselect to TRUE</span>
01158         <span class="comment">//</span>
01159         *AutoSelect = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01160     } <span class="keywordflow">else</span> {
01161         Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, AutoSelectCell);
01162         *AutoSelect = *(PBOOLEAN)(<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(SystemHive,Value,realsize));
01163     }
01164 
01165     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(SystemHive,
01166                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive,Select),
01167                                    SelectName);
01168     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01169         <span class="keywordflow">return</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>);
01170     }
01171     Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, ValueCell);
01172     <span class="keywordflow">if</span> (Value-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a> != REG_DWORD) {
01173         <span class="keywordflow">return</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>);
01174     }
01175 
01176     ControlSetIndex = (PULONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(SystemHive, Value,realsize);
01177 
01178     <span class="comment">//</span>
01179     <span class="comment">// Find appropriate control set</span>
01180     <span class="comment">//</span>
01181 
01182     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(AsciiBuffer, <span class="stringliteral">"ControlSet%03d"</span>, *ControlSetIndex);
01183     AnsiString.Length = AnsiString.MaximumLength = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(&amp;(AsciiBuffer[0]));
01184     AnsiString.Buffer = AsciiBuffer;
01185     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.MaximumLength = 128*<span class="keyword">sizeof</span>(WCHAR);
01186     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Buffer = UnicodeBuffer;
01187     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;Name,
01188                                           &amp;AnsiString,
01189                                           FALSE);
01190     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01191         <span class="keywordflow">return</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>);
01192     }
01193     ControlSet = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(SystemHive,
01194                                      (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive,RootCell),
01195                                      &amp;Name);
01196     <span class="keywordflow">if</span> (ControlSet == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01197         <span class="keywordflow">return</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>);
01198     }
01199 
01200     <span class="comment">//</span>
01201     <span class="comment">// Control set was successfully found, so update the value in "Current"</span>
01202     <span class="comment">// to reflect the control set we are going to use.</span>
01203     <span class="comment">//</span>
01204     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"Current"</span>);
01205     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(SystemHive,
01206                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive,Select),
01207                                    &amp;Name);
01208     <span class="keywordflow">if</span> (ValueCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01209         Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, ValueCell);
01210         <span class="keywordflow">if</span> (Value-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a> == REG_DWORD) {
01211             CurrentControl = (PULONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(SystemHive, Value,realsize);
01212             *CurrentControl = *ControlSetIndex;
01213         }
01214     }
01215     <span class="keywordflow">return</span>(ControlSet);
01216 
01217 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a297" doxytag="cmp.h::CmpFindDrivers" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpFindDrivers           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ControlSet</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SERVICE_LOAD_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>LoadType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWSTR BootFileSystem&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLIST_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverListHead</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00333">333</a> of file <a class="el" href="../../d1/d9/cmboot_8c-source.html">cmboot.c</a>.
<p>
References <a class="el" href="../../d1/d2/cmp_8h.html#a157">BOOT_DRIVER_NODE</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00538">CmpAddDriverToList()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00186">CmpFindSubKeyByName()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00771">CmpFindSubKeyByNumber()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00473">CmpIsLoadType()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00456">_BOOT_DRIVER_NODE::ErrorControl</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00107">PHCELL_INDEX</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01821">RtlAppendUnicodeToString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02169">CmGetSystemDriverList()</a>.
<p>
<pre class="fragment"><div>00343                    :
00344 
00345     Traverses a particular <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> set and creates a list of boot drivers
00346     to be loaded.  This list <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> unordered, but complete.
00347 
00348 Arguments:
00349 
00350     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SYSTEM hive.
00351 
00352     ControlSet - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> set.
00353 
00354     LoadType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of drivers to be loaded (BootLoad,
00355             SystemLoad, AutoLoad, etc)
00356 
00357     BootFileSystem - If present, supplies the base name of the boot
00358         filesystem, which is explicitly added to the driver list.
00359 
00360     DriverListHead - Supplies a pointer to the head of the (empty) list
00361             of boot drivers to load.
00362 
00363 Return Value:
00364 
00365     TRUE - List successfully created.
00366 
00367     FALSE - Hive is corrupt.
00368 
00369 --*/
00370 
00371 {
00372     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Services;
00373     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Control;
00374     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> GroupOrder;
00375     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> DriverCell;
00376     UNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
00377     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00378     <span class="keywordtype">int</span> i;
00379     UNICODE_STRING UnicodeString;
00380     UNICODE_STRING BasePath;
00381     WCHAR BaseBuffer[128];
00382     <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">PBOOT_DRIVER_NODE</a> BootFileSystemNode;
00383     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> ControlNode;
00384     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> ServicesNode;
00385 
00386     <span class="comment">//</span>
00387     <span class="comment">// Find SERVICES node.</span>
00388     <span class="comment">//</span>
00389     ControlNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,ControlSet);
00390     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"Services"</span>);
00391     Services = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(Hive,
00392                                    ControlNode,
00393                                    &amp;Name);
00394     <span class="keywordflow">if</span> (Services == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00395         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00396     }
00397     ServicesNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,Services);
00398 
00399     <span class="comment">//</span>
00400     <span class="comment">// Find CONTROL node.</span>
00401     <span class="comment">//</span>
00402     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"Control"</span>);
00403     Control = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(Hive,
00404                                   ControlNode,
00405                                   &amp;Name);
00406     <span class="keywordflow">if</span> (Control == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00407         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00408     }
00409 
00410     <span class="comment">//</span>
00411     <span class="comment">// Find GroupOrderList node.</span>
00412     <span class="comment">//</span>
00413     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"GroupOrderList"</span>);
00414     GroupOrder = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(Hive,
00415                                      (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,Control),
00416                                      &amp;Name);
00417     <span class="keywordflow">if</span> (GroupOrder == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00418         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00419     }
00420 
00421     BasePath.Length = 0;
00422     BasePath.MaximumLength = <span class="keyword">sizeof</span>(BaseBuffer);
00423     BasePath.Buffer = BaseBuffer;
00424     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;BasePath, L<span class="stringliteral">"\\Registry\\Machine\\System\\"</span>);
00425     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;BasePath, L<span class="stringliteral">"CurrentControlSet\\Services\\"</span>);
00426 
00427     i=0;
00428     <span class="keywordflow">do</span> {
00429         DriverCell = <a class="code" href="../../d1/d2/cmp_8h.html#a304">CmpFindSubKeyByNumber</a>(Hive,ServicesNode,i++);
00430         <span class="keywordflow">if</span> (DriverCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00431             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/cmboot_8c.html#a7">CmpIsLoadType</a>(Hive, DriverCell, LoadType)) {
00432                 <a class="code" href="../../d0/d0/cmboot_8c.html#a4">CmpAddDriverToList</a>(Hive,
00433                                    DriverCell,
00434                                    GroupOrder,
00435                                    &amp;BasePath,
00436                                    DriverListHead);
00437 
00438             }
00439         }
00440     } <span class="keywordflow">while</span> ( DriverCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a> );
00441 
00442     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(BootFileSystem)) {
00443         <span class="comment">//</span>
00444         <span class="comment">// Add boot filesystem to boot driver list</span>
00445         <span class="comment">//</span>
00446 
00447         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, BootFileSystem);
00448         DriverCell = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(Hive,
00449                                          ServicesNode,
00450                                          &amp;UnicodeString);
00451         <span class="keywordflow">if</span> (DriverCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00452             <a class="code" href="../../d0/d0/cmboot_8c.html#a4">CmpAddDriverToList</a>(Hive,
00453                                DriverCell,
00454                                GroupOrder,
00455                                &amp;BasePath,
00456                                DriverListHead);
00457 
00458             <span class="comment">//</span>
00459             <span class="comment">// mark the Boot Filesystem critical</span>
00460             <span class="comment">//</span>
00461             BootFileSystemNode = CONTAINING_RECORD(DriverListHead-&gt;Flink,
00462                                                    <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">BOOT_DRIVER_NODE</a>,
00463                                                    ListEntry.Link);
00464             BootFileSystemNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o4">ErrorControl</a> = SERVICE_ERROR_CRITICAL;
00465         }
00466     }
00467     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00468 
00469 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a265" doxytag="cmp.h::CmpFindNameInList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> CmpFindNameInList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__CHILD__LIST.html">PCHILD_LIST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ChildList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Name</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OPTIONAL <a class="el" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>ChildAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OPTIONAL PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ChildIndex</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/cmtree_8c-source.html#l00033">33</a> of file <a class="el" href="../../d5/d2/cmtree_8c-source.html">cmtree.c</a>.
<p>
References <a class="el" href="../../d0/d1/cmname_8c-source.html#l00195">CmpCompareCompressedName()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00500">_CM_KEY_VALUE::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00541">_CELL_DATA::_u::KeyList</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00502">_CM_KEY_VALUE::Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00496">_CM_KEY_VALUE::NameLength</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01520">RtlCompareUnicodeString()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00491">VALUE_COMP_NAME</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00092">CmDeleteValueKey()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01150">CmpMergeKeyValues()</a>, and <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01087">CmSetValueKey()</a>.
<p>
<pre class="fragment"><div>00042                    :
00043 
00044     Find a child object in an object list.
00045 
00046 Arguments:
00047 
00048     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> hive of interest
00049 
00050     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> - pointer to mapped in list structure
00051 
00052     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> - number of elements in list structure
00053 
00054     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> - name of child object to find
00055 
00056     ChildAddress - pointer to variable to receive address of mapped in child
00057 
00058     ChildIndex - pointer to variable to receive index <span class="keywordflow">for</span> child
00059 
00060 Return Value:
00061 
00062     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> found cell
00063     <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a> <span class="keywordflow">if</span> not found
00064 
00065 --*/
00066 {
00067     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00068     ULONG   i;
00069     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> pchild;
00070     UNICODE_STRING Candidate;
00071     BOOLEAN Success;
00072     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>;
00073 
00074     <span class="keywordflow">if</span> (ChildList-&gt;Count != 0) {
00075         <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = (<a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,ChildList-&gt;List);
00076         <span class="keywordflow">for</span> (i = 0; i &lt; ChildList-&gt;Count; i++) {
00077 
00078             pchild = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o4">KeyList</a>[i]);
00079 
00080             <span class="keywordflow">if</span> (pchild-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o5">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a37">VALUE_COMP_NAME</a>) {
00081                 Success = (<a class="code" href="../../d1/d2/cmp_8h.html#a319">CmpCompareCompressedName</a>(Name,
00082                                                     pchild-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o7">Name</a>,
00083                                                     pchild-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o1">NameLength</a>)==0);
00084             } <span class="keywordflow">else</span> {
00085                 Candidate.Length = pchild-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o1">NameLength</a>;
00086                 Candidate.MaximumLength = Candidate.Length;
00087                 Candidate.Buffer = pchild-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o7">Name</a>;
00088                 Success = (<a class="code" href="../../d6/d6/nls_8c.html#a41">RtlCompareUnicodeString</a>(Name,
00089                                                    &amp;Candidate,
00090                                                    TRUE)==0);
00091             }
00092 
00093             <span class="keywordflow">if</span> (Success) {
00094                 <span class="comment">//</span>
00095                 <span class="comment">// Success, return data to caller and exit</span>
00096                 <span class="comment">//</span>
00097 
00098                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ChildIndex)) {
00099                     *ChildIndex = i;
00100                 }
00101                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ChildAddress)) {
00102                     *ChildAddress = (<a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>)pchild;
00103                 }
00104                 <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o4">KeyList</a>[i]);
00105             }
00106         }
00107     }
00108 
00109     <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00110 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a298" doxytag="cmp.h::CmpFindNLSData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpFindNLSData           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ControlSet</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>AnsiFilename</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>OemFilename</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>CaseTableFilename</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>OemHalFilename</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00108">108</a> of file <a class="el" href="../../d1/d9/cmboot_8c-source.html">cmboot.c</a>.
<p>
References <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00186">CmpFindSubKeyByName()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01243">CmpFindValueByName</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00078">CmpValueToData</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00107">PHCELL_INDEX</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>00119                    :
00120 
00121     Traverses a particular <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> set and determines <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filenames <span class="keywordflow">for</span>
00122     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NLS data files that need to be loaded.
00123 
00124 Arguments:
00125 
00126     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SYSTEM hive.
00127 
00128     ControlSet - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> set.
00129 
00130     AnsiFileName - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Ansi codepage <a class="code" href="../../d7/d1/genuedef_8c.html#a9">file</a> (c_1252.nls)
00131 
00132     OemFileName -  Returns the name of the OEM codepage file  (c_437.nls)
00133 
00134     CaseTableFileName - Returns the name of the Unicode upper/lowercase
00135             table for the language (l_intl.nls)
00136 
00137     OemHalfont - Returns the name of the font file to be used by the HAL.
00138 
00139 Return Value:
00140 
00141     TRUE - filenames successfully determined
00142 
00143     FALSE - hive is corrupt
00144 
00145 --*/
00146 
00147 {
00148     UNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
00149     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Control;
00150     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Nls;
00151     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> CodePage;
00152     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Language;
00153     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ValueCell;
00154     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00155     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> Value;
00156     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00157     ULONG realsize;
00158 
00159     <span class="comment">//</span>
00160     <span class="comment">// Find CONTROL node</span>
00161     <span class="comment">//</span>
00162     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"Control"</span>);
00163     Control = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(Hive,
00164                                  (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,ControlSet),
00165                                  &amp;Name);
00166     <span class="keywordflow">if</span> (Control == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00167         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00168     }
00169 
00170     <span class="comment">//</span>
00171     <span class="comment">// Find NLS node</span>
00172     <span class="comment">//</span>
00173     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"NLS"</span>);
00174     Nls = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(Hive,
00175                              (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,Control),
00176                              &amp;Name);
00177     <span class="keywordflow">if</span> (Nls == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00178         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00179     }
00180 
00181     <span class="comment">//</span>
00182     <span class="comment">// Find CodePage node</span>
00183     <span class="comment">//</span>
00184     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"CodePage"</span>);
00185     CodePage = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(Hive,
00186                                   (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,Nls),
00187                                   &amp;Name);
00188     <span class="keywordflow">if</span> (CodePage == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00189         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00190     }
00191 
00192     <span class="comment">//</span>
00193     <span class="comment">// Find ACP value</span>
00194     <span class="comment">//</span>
00195     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"ACP"</span>);
00196     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(Hive,
00197                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,CodePage),
00198                                    &amp;Name);
00199     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00200         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00201     }
00202 
00203     Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ValueCell);
00204     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Buffer = (PWSTR)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(Hive,Value,realsize);
00205     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.MaximumLength=(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realsize;
00206     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length = 0;
00207     <span class="keywordflow">while</span> ((<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length&lt;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.MaximumLength) &amp;&amp;
00208            (<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Buffer[<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length/<span class="keyword">sizeof</span>(WCHAR)] != UNICODE_NULL)) {
00209         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length += <span class="keyword">sizeof</span>(WCHAR);
00210     }
00211 
00212     <span class="comment">//</span>
00213     <span class="comment">// Find ACP filename</span>
00214     <span class="comment">//</span>
00215     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(Hive,
00216                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,CodePage),
00217                                    &amp;Name);
00218     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00219         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00220     }
00221 
00222     Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ValueCell);
00223     AnsiFilename-&gt;Buffer = (PWSTR)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(Hive,Value,realsize);
00224     AnsiFilename-&gt;Length = AnsiFilename-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realsize;
00225 
00226     <span class="comment">//</span>
00227     <span class="comment">// Find OEMCP node</span>
00228     <span class="comment">//</span>
00229     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"OEMCP"</span>);
00230     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(Hive,
00231                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,CodePage),
00232                                    &amp;Name);
00233     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00234         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00235     }
00236 
00237     Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ValueCell);
00238     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Buffer = (PWSTR)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(Hive,Value,realsize);
00239     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realsize;
00240     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length = 0;
00241     <span class="keywordflow">while</span> ((<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length&lt;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.MaximumLength) &amp;&amp;
00242            (<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Buffer[<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length/<span class="keyword">sizeof</span>(WCHAR)] != UNICODE_NULL)) {
00243         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length += <span class="keyword">sizeof</span>(WCHAR);
00244     }
00245 
00246     <span class="comment">//</span>
00247     <span class="comment">// Find OEMCP filename</span>
00248     <span class="comment">//</span>
00249     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(Hive,
00250                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,CodePage),
00251                                    &amp;Name);
00252     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00253         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00254     }
00255 
00256     Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ValueCell);
00257     OemFilename-&gt;Buffer = (PWSTR)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(Hive, Value,realsize);
00258     OemFilename-&gt;Length = OemFilename-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realsize;
00259 
00260     <span class="comment">//</span>
00261     <span class="comment">// Find Language node</span>
00262     <span class="comment">//</span>
00263     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"Language"</span>);
00264     Language = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(Hive,
00265                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,Nls),
00266                                    &amp;Name);
00267     <span class="keywordflow">if</span> (Language == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00268         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00269     }
00270 
00271     <span class="comment">//</span>
00272     <span class="comment">// Find Default value</span>
00273     <span class="comment">//</span>
00274     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"Default"</span>);
00275     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(Hive,
00276                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,Language),
00277                                    &amp;Name);
00278     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00279             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00280     }
00281 
00282     Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ValueCell);
00283     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Buffer = (PWSTR)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(Hive, Value,realsize);
00284     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realsize;
00285     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length = 0;
00286 
00287     <span class="keywordflow">while</span> ((<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length&lt;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.MaximumLength) &amp;&amp;
00288            (<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Buffer[<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length/<span class="keyword">sizeof</span>(WCHAR)] != UNICODE_NULL)) {
00289         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length+=<span class="keyword">sizeof</span>(WCHAR);
00290     }
00291 
00292     <span class="comment">//</span>
00293     <span class="comment">// Find default filename</span>
00294     <span class="comment">//</span>
00295     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(Hive,
00296                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,Language),
00297                                    &amp;Name);
00298     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00299         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00300     }
00301 
00302     Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ValueCell);
00303     CaseTableFilename-&gt;Buffer = (PWSTR)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(Hive, Value,realsize);
00304     CaseTableFilename-&gt;Length = CaseTableFilename-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realsize;
00305 
00306     <span class="comment">//</span>
00307     <span class="comment">// Find OEMHAL filename</span>
00308     <span class="comment">//</span>
00309     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"OEMHAL"</span>);
00310     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(Hive,
00311                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,CodePage),
00312                                    &amp;Name);
00313     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00314 <span class="preprocessor">#ifdef i386</span>
00315 <span class="preprocessor"></span>        OemHalFont-&gt;Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00316         OemHalFont-&gt;Length = 0;
00317         OemHalFont-&gt;MaximumLength = 0;
00318         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00319 <span class="preprocessor">#endif</span>
00320 <span class="preprocessor"></span>        <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00321     }
00322 
00323     Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ValueCell);
00324     OemHalFont-&gt;Buffer = (PWSTR)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(Hive,Value,realsize);
00325     OemHalFont-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realsize;
00326     OemHalFont-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realsize;
00327 
00328     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00329 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a299" doxytag="cmp.h::CmpFindProfileOption" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> CmpFindProfileOption           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ControlSet</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">PCM_HARDWARE_PROFILE_LIST</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>ProfileList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d9/d3/struct__CM__HARDWARE__PROFILE__ALIAS__LIST.html">PCM_HARDWARE_PROFILE_ALIAS_LIST</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>AliasList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Timeout</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01221">CmpSetCurrentProfile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a303" doxytag="cmp.h::CmpFindSubKeyByName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> CmpFindSubKeyByName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Parent</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>SearchName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00186">186</a> of file <a class="el" href="../../d8/d0/cmindex_8c-source.html">cmindex.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00373">CM_KEY_FAST_LEAF</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00372">CM_KEY_INDEX_LEAF</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00371">CM_KEY_INDEX_ROOT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00475">CmpFindSubKeyInLeaf()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00266">CmpFindSubKeyInRoot()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00181">CmpHintHits</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00182">CmpHintMisses</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00268">CMS_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l01453">HvIsCellAllocated()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00387">_CM_KEY_INDEX::Signature</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00629">_HHIVE::StorageTypeCount</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00454">_CM_KEY_NODE::SubKeyCounts</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00457">_CM_KEY_NODE::SubKeyLists</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00470">_CM_KEY_NODE::WorkVar</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/cmcontrl_8c-source.html#l00050">CmGetSystemControlValues()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00251">CmpCopySyncTree2()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01082">CmpFindControlSet()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00333">CmpFindDrivers()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00108">CmpFindNLSData()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01284">CmpFindProfileOption()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00744">CmpSortDriverList()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01648">CmpSyncSubKeysAfterDelete()</a>, and <a class="el" href="../../d6/d9/cmcontrl_8c-source.html#l00256">CmpWalkPath()</a>.
<p>
<pre class="fragment"><div>00193                    :
00194 
00195     Find <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> child cell (either subkey or value) specified by name.
00196 
00197 Arguments:
00198 
00199     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> hive of interest
00200 
00201     Parent - cell of key body which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> parent of child of interest
00202 
00203     SearchName - name of child of interest
00204 
00205 Return Value:
00206 
00207     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a> child key, or <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a> <span class="keywordflow">if</span> none.
00208 
00209 --*/
00210 {
00211     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   IndexRoot;
00212     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     Child;
00213     ULONG           i;
00214     ULONG           FoundIndex;
00215 
00216     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INDEX) {
00217         KdPrint((<span class="stringliteral">"CmpFindSubKeyByName:\n\t"</span>));
00218         KdPrint((<span class="stringliteral">"Hive=%08lx Parent=%08lx SearchName=%08lx\n"</span>, Hive, Parent, SearchName));
00219     }
00220 
00221     <span class="comment">//</span>
00222     <span class="comment">// Try first the Stable, then the Volatile store.  Assumes that</span>
00223     <span class="comment">// all Volatile refs in Stable space are zeroed out at boot.</span>
00224     <span class="comment">//</span>
00225     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o20">StorageTypeCount</a>; i++) {
00226         <span class="keywordflow">if</span> (Parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[i] != 0) {
00227             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d0/hivecell_8c.html#a21">HvIsCellAllocated</a>(Hive, Parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[i]));
00228             IndexRoot = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[i]);
00229 
00230             <span class="keywordflow">if</span> (IndexRoot-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a18">CM_KEY_INDEX_ROOT</a>) {
00231                 <a class="code" href="../../d7/d1/cmindex_8c.html#a2">CmpFindSubKeyInRoot</a>(Hive, IndexRoot, SearchName, &amp;Child);
00232                 <span class="keywordflow">if</span> (Child == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00233                     <span class="keywordflow">continue</span>;
00234                 }
00235                 IndexRoot = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Child);
00236             }
00237             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((IndexRoot-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == CM_KEY_INDEX_LEAF) ||
00238                    (IndexRoot-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == CM_KEY_FAST_LEAF));
00239 
00240             FoundIndex = <a class="code" href="../../d7/d1/cmindex_8c.html#a3">CmpFindSubKeyInLeaf</a>(Hive,
00241                                              IndexRoot,
00242                                              Parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o15">WorkVar</a>,
00243                                              SearchName,
00244                                              &amp;Child);
00245             <span class="keywordflow">if</span> (Child != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00246                 <span class="comment">//</span>
00247                 <span class="comment">// WorkVar is used as a hint for the last successful lookup</span>
00248                 <span class="comment">// to improve our locality when similar keys are opened</span>
00249                 <span class="comment">// repeatedly.</span>
00250                 <span class="comment">//</span>
00251                 <span class="keywordflow">if</span> (FoundIndex == Parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o15">WorkVar</a>) {
00252                     <a class="code" href="../../d7/d1/cmindex_8c.html#a0">CmpHintHits</a>++;
00253                 } <span class="keywordflow">else</span> {
00254                     <a class="code" href="../../d7/d1/cmindex_8c.html#a1">CmpHintMisses</a>++;
00255                 }
00256                 Parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o15">WorkVar</a> = FoundIndex;
00257                 <span class="keywordflow">return</span> Child;
00258             }
00259         }
00260     }
00261     <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00262 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a304" doxytag="cmp.h::CmpFindSubKeyByNumber" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> CmpFindSubKeyByNumber           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Parent</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Number</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00771">771</a> of file <a class="el" href="../../d8/d0/cmindex_8c-source.html">cmindex.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00833">CmpDoFindSubKeyByNumber()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00268">CMS_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00629">_HHIVE::StorageTypeCount</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00454">_CM_KEY_NODE::SubKeyCounts</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00457">_CM_KEY_NODE::SubKeyLists</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00285">CmEnumerateKey()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00210">CmpCheckRegistry2()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00251">CmpCopySyncTree2()</a>, <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00034">CmpDeleteTree()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00333">CmpFindDrivers()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01545">CmpFindMatchingDescriptorCell()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01284">CmpFindProfileOption()</a>, and <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01648">CmpSyncSubKeysAfterDelete()</a>.
<p>
<pre class="fragment"><div>00778                    :
00779 
00780     Find <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Number'th entry in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> index, starting from 0.
00781 
00782 Arguments:
00783 
00784     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> hive of interest
00785 
00786     Node - pointer to key body which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> parent of child of interest
00787 
00788     Number - ordinal of child key to <span class="keywordflow">return</span>
00789 
00790 Return Value:
00791 
00792     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a> child key, or <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a> <span class="keywordflow">if</span> none.
00793 
00794 --*/
00795 {
00796     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00797 
00798     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INDEX) {
00799         KdPrint((<span class="stringliteral">"CmpFindSubKeyByNumber:\n\t"</span>));
00800         KdPrint((<span class="stringliteral">"Hive=%08lx Node=%08lx Number=%08lx\n"</span>,Hive,Node,Number));
00801     }
00802 
00803     <span class="keywordflow">if</span> (Number &lt; Node-&gt;SubKeyCounts[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>]) {
00804 
00805         <span class="comment">//</span>
00806         <span class="comment">// It's in the stable set</span>
00807         <span class="comment">//</span>
00808         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Node-&gt;SubKeyLists[Stable]);
00809         <span class="keywordflow">return</span> (<a class="code" href="../../d7/d1/cmindex_8c.html#a6">CmpDoFindSubKeyByNumber</a>(Hive, Index, Number));
00810 
00811     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o20">StorageTypeCount</a> &gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>) {
00812 
00813         <span class="comment">//</span>
00814         <span class="comment">// It's in the volatile set</span>
00815         <span class="comment">//</span>
00816         Number = Number - Node-&gt;SubKeyCounts[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>];
00817         <span class="keywordflow">if</span> (Number &lt; Node-&gt;SubKeyCounts[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>]) {
00818 
00819             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Node-&gt;SubKeyLists[Volatile]);
00820             <span class="keywordflow">return</span> (<a class="code" href="../../d7/d1/cmindex_8c.html#a6">CmpDoFindSubKeyByNumber</a>(Hive, Index, Number));
00821 
00822         }
00823     }
00824 
00825     <span class="comment">//</span>
00826     <span class="comment">// It's nowhere</span>
00827     <span class="comment">//</span>
00828     <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00829 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a262" doxytag="cmp.h::CmpFindValueByName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> CmpFindValueByName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Name</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a330" doxytag="cmp.h::CmpFindValueByNameFromCache" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> CmpFindValueByNameFromCache           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d6/struct__CACHED__CHILD__LIST.html">PCACHED_CHILD_LIST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ChildList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Name</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PPCM_CACHED_VALUE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>ContainingList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT ULONG *&nbsp;</td>
          <td class="mdname" nowrap> <em>Index</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT BOOLEAN *&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueCached</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/cmtree_8c-source.html#l00309">309</a> of file <a class="el" href="../../d5/d2/cmtree_8c-source.html">cmtree.c</a>.
<p>
References <a class="el" href="../../d0/d1/cmname_8c-source.html#l00195">CmpCompareCompressedName()</a>, <a class="el" href="../../d5/d2/cmtree_8c-source.html#l00200">CmpGetValueKeyFromCache()</a>, <a class="el" href="../../d5/d2/cmtree_8c-source.html#l00115">CmpGetValueListFromCache()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00500">_CM_KEY_VALUE::Flags</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00502">_CM_KEY_VALUE::Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00496">_CM_KEY_VALUE::NameLength</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01520">RtlCompareUnicodeString()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00491">VALUE_COMP_NAME</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00804">CmQueryValueKey()</a>.
<p>
<pre class="fragment"><div>00319                    :
00320 
00321     Find a value node given a value list array and a value name.  It sequentially walk
00322     through each value node to look <span class="keywordflow">for</span> a match.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> array and 
00323     value nodes touched are not already cached, cache them.
00324 
00325 Arguments:
00326 
00327     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> hive of interest
00328 
00329     ChildList - pointer/index to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Value <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> array
00330 
00331     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> - name of value to find
00332 
00333     ContainlingList - The address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entry that will receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> found cached value.
00334 
00335     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - pointer to variable to receive index <span class="keywordflow">for</span> child
00336     
00337     ValueCached - Indicate <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value node <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> cached.
00338 
00339 Return Value:
00340 
00341     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> found cell
00342     <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a> <span class="keywordflow">if</span> not found
00343 
00344 --*/
00345 {
00346     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00347     ULONG   i;
00348     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> pchild;
00349     UNICODE_STRING Candidate;
00350     BOOLEAN Success;
00351     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>;
00352     BOOLEAN IndexCached;
00353 
00354     <span class="keywordflow">if</span> (ChildList-&gt;Count != 0) {
00355         <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = <a class="code" href="../../d4/d3/cmtree_8c.html#a1">CmpGetValueListFromCache</a>(Hive, ChildList, &amp;IndexCached);
00356 
00357         <span class="keywordflow">for</span> (i = 0; i &lt; ChildList-&gt;Count; i++) {
00358             pchild = <a class="code" href="../../d4/d3/cmtree_8c.html#a2">CmpGetValueKeyFromCache</a>(Hive, List, i, ContainingList, IndexCached, ValueCached);
00359 
00360             <span class="keywordflow">if</span> (pchild-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o5">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a37">VALUE_COMP_NAME</a>) {
00361                 Success = (<a class="code" href="../../d1/d2/cmp_8h.html#a319">CmpCompareCompressedName</a>(Name,
00362                                                     pchild-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o7">Name</a>,
00363                                                     pchild-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o1">NameLength</a>)==0);
00364             } <span class="keywordflow">else</span> {
00365                 Candidate.Length = pchild-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o1">NameLength</a>;
00366                 Candidate.MaximumLength = Candidate.Length;
00367                 Candidate.Buffer = pchild-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o7">Name</a>;
00368                 Success = (<a class="code" href="../../d6/d6/nls_8c.html#a41">RtlCompareUnicodeString</a>(Name,
00369                                                    &amp;Candidate,
00370                                                    TRUE)==0);
00371             }
00372 
00373             <span class="keywordflow">if</span> (Success) {
00374                 <span class="comment">//</span>
00375                 <span class="comment">// Success, fill the index, return data to caller and exit</span>
00376                 <span class="comment">//</span>
00377                 *<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = i;
00378                 <span class="keywordflow">return</span>(pchild);
00379             }
00380         }
00381     }
00382 
00383     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00384 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a288" doxytag="cmp.h::CmpFlushNotify" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpFlushNotify           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>KeyBody</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01235">1235</a> of file <a class="el" href="../../d1/d1/cmnotify_8c-source.html">cmnotify.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00345">ASSERT_CM_LOCK_OWNED</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00660">CmLockHive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00054">CmpClearListEntry</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01515">CmpInitializeKeyNameString()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00487">CmpPostNotify()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00266">CMS_NOTIFY</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00662">CmUnlockHive</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00272">_CM_KEY_CONTROL_BLOCK::Delete</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d5/d5/regext_8c-source.html#l00033">HiveList</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00559">_CM_NOTIFY_BLOCK::HiveList</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00492">_CM_KEY_BODY::KeyControlBlock</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00279">_CM_KEY_CONTROL_BLOCK::KeyHive</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00295">_CM_KEY_CONTROL_BLOCK::KeyNode</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00034">MAX_KEY_NAME_LENGTH</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00493">_CM_KEY_BODY::NotifyBlock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00563">_CM_NOTIFY_BLOCK::PostList</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00196">SeReleaseSubjectContext()</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00564">_CM_NOTIFY_BLOCK::SubjectContext</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/cmapi2_8c-source.html#l00031">CmDeleteKey()</a>, <a class="el" href="../../d2/d0/cmdelete_8c-source.html#l00031">CmpDeleteKeyObject()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00731">CmpRefreshHive()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03093">NtUnloadKey()</a>.
<p>
<pre class="fragment"><div>01240                    :
01241 
01242     Clean up notifyblock when a handle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> closed or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> refers
01243     to <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> deleted.
01244 
01245 Arguments:
01246 
01247     KeyBody - supplies pointer to key object body <span class="keywordflow">for</span> handle we
01248                 are cleaning up.
01249 
01250 Return Value:
01251 
01252     NONE
01253 
01254 --*/
01255 {
01256     <a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a>    NotifyBlock;
01257     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
01258 
01259     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01260     <a class="code" href="../../d1/d2/cmp_8h.html#a61">ASSERT_CM_LOCK_OWNED</a>();
01261 
01262     <span class="keywordflow">if</span> (KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o2">NotifyBlock</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01263         <span class="keywordflow">return</span>;
01264     }
01265 
01266 <span class="preprocessor">#ifdef KCB_TO_KEYBODY_LINK</span>
01267 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o0">Delete</a> == FALSE );
01268 <span class="preprocessor">#endif</span>
01269 <span class="preprocessor"></span>
01270     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_NOTIFY) {
01271 <span class="preprocessor">#if DBG</span>
01272 <span class="preprocessor"></span>        WCHAR                   *NameBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01273         UNICODE_STRING          <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
01274 
01275         KdPrint((<span class="stringliteral">"[CM]CmpFlushNotify: NotifyBlock = %08lx\n"</span>,KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o2">NotifyBlock</a>));
01276         NameBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, MAX_KEY_NAME_LENGTH);
01277         <span class="keywordflow">if</span>(NameBuffer &amp;&amp; KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o17">KeyNode</a>) {
01278            <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a14">CmpInitializeKeyNameString</a>(KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o17">KeyNode</a>,&amp;KeyName,NameBuffer);
01279            KdPrint((<span class="stringliteral">"\t[CM]CmpFlushNotify: Key = %.*S\n"</span>,<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length / <span class="keyword">sizeof</span>(WCHAR),<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer));
01280            <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NameBuffer);
01281         }
01282 <span class="preprocessor">#endif</span>
01283 <span class="preprocessor"></span>    }
01284 
01285     <span class="comment">//</span>
01286     <span class="comment">// Lock the hive exclusively to prevent multiple threads from whacking</span>
01287     <span class="comment">// on the list.</span>
01288     <span class="comment">//</span>
01289     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = CONTAINING_RECORD(KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a>,
01290                              <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>,
01291                              Hive);
01292     <a class="code" href="../../d1/d2/cmp_8h.html#a94">CmLockHive</a>(Hive);
01293     <span class="comment">//</span>
01294     <span class="comment">// Reread the notify block in case it has already been freed.</span>
01295     <span class="comment">//</span>
01296     NotifyBlock = KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o2">NotifyBlock</a>;
01297     <span class="keywordflow">if</span> (NotifyBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01298         <a class="code" href="../../d1/d2/cmp_8h.html#a95">CmUnlockHive</a>(Hive);
01299         <span class="keywordflow">return</span>;
01300     }
01301 
01302     <span class="comment">//</span>
01303     <span class="comment">// Clean up all PostBlocks waiting on the NotifyBlock</span>
01304     <span class="comment">//</span>
01305     <span class="keywordflow">if</span> (IsListEmpty(&amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o4">PostList</a>)) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01306         <a class="code" href="../../d1/d2/cmp_8h.html#a284">CmpPostNotify</a>(
01307             NotifyBlock,
01308             NULL,
01309             0,
01310             STATUS_NOTIFY_CLEANUP,
01311             NULL
01312             );
01313     }
01314 
01315     <span class="comment">//</span>
01316     <span class="comment">// Release the subject context</span>
01317     <span class="comment">//</span>
01318     <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a>(&amp;NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o5">SubjectContext</a>);
01319 
01320     <span class="comment">//</span>
01321     <span class="comment">// IMPLEMENTATION NOTE:</span>
01322     <span class="comment">//      If we ever do code to report names and types of events,</span>
01323     <span class="comment">//      this is the place to free the buffer.</span>
01324     <span class="comment">//</span>
01325 
01326     <span class="comment">//</span>
01327     <span class="comment">// Remove the NotifyBlock from the hive chain</span>
01328     <span class="comment">//</span>
01329     NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>.Blink-&gt;Flink = NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>.Flink;
01330     <span class="keywordflow">if</span> (NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>.Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01331         NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>.Flink-&gt;Blink = NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>.Blink;
01332     }
01333 
01334     <span class="comment">// Protect for multiple deletion of the same object</span>
01335     <a class="code" href="../../d1/d2/cmp_8h.html#a2">CmpClearListEntry</a>(&amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>));
01336 
01337     KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o2">NotifyBlock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01338 
01339 <span class="preprocessor">#ifdef _CM_ENTRYLIST_MANIPULATION</span>
01340 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (IsListEmpty(&amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o4">PostList</a>)) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01341         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CmpFlushNotify: NotifyBlock %08lx\n"</span>,NotifyBlock);
01342         DbgBreakPoint();
01343     }
01344     <span class="comment">//check is the notify has been deleted from the hive notify list</span>
01345     {
01346         <a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a> ValidNotifyBlock;
01347         PLIST_ENTRY NotifyPtr;
01348 
01349         NotifyPtr = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;NotifyList);
01350 
01351         <span class="keywordflow">while</span> (NotifyPtr-&gt;Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01352             NotifyPtr = NotifyPtr-&gt;Flink;
01353 
01354             ValidNotifyBlock = CONTAINING_RECORD(NotifyPtr, <a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">CM_NOTIFY_BLOCK</a>, HiveList);
01355             <span class="keywordflow">if</span>( ValidNotifyBlock == NotifyBlock ) {
01356                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CmpFlushNotify: NotifyBlock %08lx is about to be deleted but is still in the hive notify list\n"</span>,NotifyBlock);
01357                 DbgBreakPoint();
01358             }
01359         }
01360     }
01361     RtlZeroMemory((PVOID)NotifyBlock, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">CM_NOTIFY_BLOCK</a>));
01362 <span class="preprocessor">#endif</span>
01363 <span class="preprocessor"></span>    
01364     <a class="code" href="../../d1/d2/cmp_8h.html#a95">CmUnlockHive</a>(Hive);
01365 
01366     <span class="comment">//</span>
01367     <span class="comment">// Free the block, clean up the KeyBody</span>
01368     <span class="comment">//</span>
01369     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NotifyBlock);
01370     <span class="keywordflow">return</span>;
01371 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a217" doxytag="cmp.h::CmpFree" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpFree           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>MemoryBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>GlobalQuotaSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00186">186</a> of file <a class="el" href="../../d8/d2/cmwrapr_8c-source.html">cmwrapr.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00265">CmpReleaseGlobalQuota()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00264">CMS_POOL</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, and <a class="el" href="../../d6/d1/ppc_2getcalr_8c-source.html#l00038">RtlGetCallersAddress()</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01490">CmpDestroyTemporaryHive()</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l04077">CmpValidateAlternate()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02293">CmReplaceKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02079">CmUnloadKey()</a>, <a class="el" href="../../d0/d4/edithive_8c-source.html#l00124">EhCloseHive()</a>, <a class="el" href="../../d3/d0/hivefree_8c-source.html#l00034">HvFreeHive()</a>, <a class="el" href="../../d3/d0/hivefree_8c-source.html#l00160">HvFreeHivePartial()</a>, and <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01433">HvWriteHive()</a>.
<p>
<pre class="fragment"><div>00192                    :
00193 
00194     This routine frees memory that has been allocated by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry.
00195 
00196     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> environment specific
00197 
00198 
00199 Arguments:
00200 
00201     MemoryBlock - supplies address of memory object to free
00202 
00203     GlobalQuotaSize - amount of global quota to release
00204 
00205 Return Value:
00206 
00207     NONE
00208 
00209 --*/
00210 {
00211 <span class="preprocessor">#if DBG</span>
00212 <span class="preprocessor"></span>    PVOID   Caller;
00213     PVOID   CallerCaller;
00214     <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;Caller, &amp;CallerCaller);
00215     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_POOL) {
00216         KdPrint((<span class="stringliteral">"**FREEING:%08lx c,cc:%08lx,%08lx\n"</span>, MemoryBlock, Caller, CallerCaller));
00217     }
00218 <span class="preprocessor">#endif</span>
00219 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(GlobalQuotaSize &gt; 0);
00220     <a class="code" href="../../d1/d2/cmp_8h.html#a248">CmpReleaseGlobalQuota</a>(GlobalQuotaSize);
00221     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(MemoryBlock);
00222     <span class="keywordflow">return</span>;
00223 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a260" doxytag="cmp.h::CmpFreeKeyBody" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpFreeKeyBody           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01297">1297</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00464">_CM_KEY_NODE::Class</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00476">_CM_KEY_NODE::ClassLength</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00428">KEY_HIVE_EXIT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00537">_CELL_DATA::_u::KeyNode</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00463">_CM_KEY_NODE::Security</a>, and <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>.
<p>
Referenced by <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00140">CmpFreeKeyByCell()</a>.
<p>
<pre class="fragment"><div>01303                    :
01304 
01305     Free storage <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key entry <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>.Cell refers to, including
01306     its <span class="keyword">class </span>and security data.  Will NOT free child list or value list.
01307 
01308 Arguments:
01309 
01310     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure for <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive
01311 
01312     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - supplies index of key to free
01313 
01314 Return Value:
01315 
01316     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
01317 
01318         &lt;TBS&gt;
01319 
01320 --*/
01321 {
01322     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> key;
01323 
01324     <span class="comment">//</span>
01325     <span class="comment">// map in the cell</span>
01326     <span class="comment">//</span>
01327     key = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);
01328 
01329     <span class="keywordflow">if</span> (!(key-&gt;u.KeyNode.Flags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a28">KEY_HIVE_EXIT</a>)) {
01330         <span class="keywordflow">if</span> (key-&gt;u.KeyNode.Security != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01331             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, key-&gt;u.KeyNode.Security);
01332         }
01333 
01334         <span class="keywordflow">if</span> (key-&gt;u.KeyNode.ClassLength &gt; 0) {
01335             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, key-&gt;u.KeyNode.Class);
01336         }
01337     }
01338 
01339     <span class="comment">//</span>
01340     <span class="comment">// unmap the cell itself and free it</span>
01341     <span class="comment">//</span>
01342     <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, Cell);
01343 
01344     <span class="keywordflow">return</span>;
01345 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a264" doxytag="cmp.h::CmpFreeKeyByCell" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpFreeKeyByCell           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Unlink</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00140">140</a> of file <a class="el" href="../../d4/d2/cmtredel_8c-source.html">cmtredel.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01297">CmpFreeKeyBody()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00105">CmpFreeSecurityDescriptor()</a>, <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00053">CmpFreeValue()</a>, <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00245">CmpMarkKeyDirty()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01714">CmpRemoveSubKey()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00332">_CHILD_LIST::Count</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00428">KEY_HIVE_EXIT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00442">KEY_PREDEF_HANDLE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00541">_CELL_DATA::_u::KeyList</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00537">_CELL_DATA::_u::KeyNode</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00333">_CHILD_LIST::List</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00466">_CM_KEY_NODE::MaxClassLen</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00465">_CM_KEY_NODE::MaxNameLen</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00453">_CM_KEY_NODE::Parent</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00454">_CM_KEY_NODE::SubKeyCounts</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00458">_CM_KEY_NODE::ValueList</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/cmapi2_8c-source.html#l00031">CmDeleteKey()</a>, <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00034">CmpDeleteTree()</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00667">CmpDestroyHive()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00033">CmpDoCreate()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01648">CmpSyncSubKeysAfterDelete()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00097">CmRestoreKey()</a>, and <a class="el" href="../../d0/d4/edithive_8c-source.html#l00625">EhCreateChild()</a>.
<p>
<pre class="fragment"><div>00147                    :
00148 
00149     Actually free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> storage <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified cell.  We will first
00150     remove <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> from its parent's child key list, then free all of its
00151     values, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key body itself.
00152 
00153 Arguments:
00154 
00155     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> hive of interest
00156 
00157     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - index <span class="keywordflow">for</span> cell to free storage <span class="keywordflow">for</span> (<a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target)
00158 
00159     Unlink - <span class="keywordflow">if</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, target cell will be removed from parent cell's
00160              subkeylist, <span class="keywordflow">if</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will NOT be.
00161 
00162 Return Value:
00163 
00164     NONE.
00165 
00166 --*/
00167 {
00168     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  ptarget;
00169     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  pparent;
00170     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  plist;
00171     ULONG       i;
00172 
00173     <span class="comment">//</span>
00174     <span class="comment">// Mark dirty everything that we might touch</span>
00175     <span class="comment">//</span>
00176     <span class="keywordflow">if</span> (! <a class="code" href="../../d3/d3/cmtredel_8c.html#a2">CmpMarkKeyDirty</a>(Hive, Cell)) {
00177         <span class="keywordflow">return</span> STATUS_NO_LOG_SPACE;
00178     }
00179 
00180     <span class="comment">//</span>
00181     <span class="comment">// Map in the target</span>
00182     <span class="comment">//</span>
00183     ptarget = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);
00184     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[Stable] +
00185             ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[Volatile]) == 0);
00186 
00187 
00188     <span class="keywordflow">if</span> (Unlink == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00189         BOOLEAN Success;
00190 
00191         Success = <a class="code" href="../../d1/d2/cmp_8h.html#a307">CmpRemoveSubKey</a>(Hive, ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a>, Cell);
00192         <span class="keywordflow">if</span> (!Success) {
00193             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00194         }
00195         pparent = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a>);
00196         <span class="keywordflow">if</span> ( (pparent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] +
00197               pparent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>]) == 0)
00198         {
00199             pparent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o11">MaxNameLen</a> = 0;
00200             pparent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o12">MaxClassLen</a> = 0;
00201         }
00202     }
00203 
00204     <span class="comment">//</span>
00205     <span class="comment">// Target is now an unreferenced key, free it's actual storage</span>
00206     <span class="comment">//</span>
00207 
00208     <span class="comment">//</span>
00209     <span class="comment">// Free misc stuff</span>
00210     <span class="comment">//</span>
00211     <span class="keywordflow">if</span> (!(ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a28">KEY_HIVE_EXIT</a>) &amp;&amp;
00212         !(ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a33">KEY_PREDEF_HANDLE</a>) ) {
00213 
00214         <span class="comment">//</span>
00215         <span class="comment">// First, free the value entries</span>
00216         <span class="comment">//</span>
00217         <span class="keywordflow">if</span> (ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> &gt; 0) {
00218 
00219             <span class="comment">// target list</span>
00220             plist = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>);
00221 
00222             <span class="keywordflow">for</span> (i = 0; i &lt; ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a>; i++) {
00223                 <a class="code" href="../../d9/d2/cmsubs2_8c.html#a3">CmpFreeValue</a>(Hive, plist-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o4">KeyList</a>[i]);
00224             }
00225 
00226             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>);
00227         }
00228 
00229         <span class="comment">//</span>
00230         <span class="comment">// Free the security descriptor</span>
00231         <span class="comment">//</span>
00232         <a class="code" href="../../d6/d3/cmwraper_8c.html#a12">CmpFreeSecurityDescriptor</a>(Hive, Cell);
00233     }
00234 
00235     <span class="comment">//</span>
00236     <span class="comment">// Free the key body itself, and Class data.</span>
00237     <span class="comment">//</span>
00238     <a class="code" href="../../d8/d2/cmsubs_8c.html#a25">CmpFreeKeyBody</a>(Hive, Cell);
00239 
00240     <span class="keywordflow">return</span> STATUS_SUCCESS;
00241 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a286" doxytag="cmp.h::CmpFreePostBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpFreePostBlock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PostBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03764">3764</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a175">CM_POST_BLOCK</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00243">CML_API</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00054">CmpClearListEntry</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01515">CmpInitializeKeyNameString()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00266">CMS_NOTIFY</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00257">CMS_NTAPI</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00632">IsMasterPostBlock</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00034">MAX_KEY_NAME_LENGTH</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a335a206">PostAsyncKernel</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a335a205">PostAsyncUser</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00630">PostBlockType</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a335a204">PostSynchronous</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00625">REG_NOTIFY_MASTER_POST</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01028">CmNotifyRunDown()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01634">CmpFreeSlavePost()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01378">CmpNotifyChangeKey()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00804">CmpPostApc()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00922">CmpPostApcRunDown()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00487">CmpPostNotify()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>.
<p>
<pre class="fragment"><div>03770                    :
03771 
03772     Frees <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> various bits of <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> that were allocated <span class="keywordflow">for</span> a postblock
03773 
03774 Arguments:
03775 
03776     None
03777 
03778 Return Value:
03779 
03780     None.
03781 
03782 --*/
03783 
03784 {
03785 
03786     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_NTAPI) {
03787 <span class="preprocessor">#if DBG</span>
03788 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
03789             KdPrint((<span class="stringliteral">"[CM]CmpFreePostBlock: PostBlock:%08lx\t"</span>, PostBlock));
03790             <span class="keywordflow">if</span>( PostBlock-&gt;NotifyType&amp;<a class="code" href="../../d1/d2/cmp_8h.html#a87">REG_NOTIFY_MASTER_POST</a>) {
03791                 KdPrint((<span class="stringliteral">"--MasterBlock\n"</span>));
03792             } <span class="keywordflow">else</span> {
03793                 KdPrint((<span class="stringliteral">"--SlaveBlock\n"</span>));
03794             }
03795         }
03796 <span class="preprocessor">#endif</span>
03797 <span class="preprocessor"></span>    }
03798 
03799 <span class="preprocessor">#ifdef _CM_ENTRYLIST_MANIPULATION</span>
03800 <span class="preprocessor"></span>    <span class="comment">// check if the post block has been removed from the notify and thread list(s)</span>
03801     <span class="keywordflow">if</span>((PostBlock-&gt;NotifyList.Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (PostBlock-&gt;NotifyList.Blink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
03802         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CmpFreePostBlock: Attempt to free post block %08lx not removed from notify list\n"</span>,PostBlock);
03803         DbgBreakPoint();
03804     }
03805     <span class="keywordflow">if</span>((PostBlock-&gt;ThreadList.Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (PostBlock-&gt;ThreadList.Blink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
03806         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CmpFreePostBlock: Attempt to free post block %08lx not removed from thread list\n"</span>,PostBlock);
03807         DbgBreakPoint();
03808     }
03809 
03810 <span class="preprocessor">#endif</span>
03811 <span class="preprocessor"></span>
03812     <span class="comment">// Protect for multiple deletion of the same object</span>
03813     <a class="code" href="../../d1/d2/cmp_8h.html#a2">CmpClearListEntry</a>(&amp;(PostBlock-&gt;CancelPostList));
03814 
03815     <span class="comment">//</span>
03816     <span class="comment">// Cleanup for objects referenced by NtNotifyMultipleKeys</span>
03817     <span class="comment">//</span>
03818     <span class="keywordflow">if</span>( PostBlock-&gt;PostKeyBody) {
03819 
03820         <span class="comment">//</span>
03821         <span class="comment">// If we have a PostKeyBody, the attached key body must not be NULL</span>
03822         <span class="comment">//</span>
03823         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PostBlock-&gt;PostKeyBody-&gt;KeyBody);
03824 
03825         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_NOTIFY) {
03826 <span class="preprocessor">#if DBG</span>
03827 <span class="preprocessor"></span>            WCHAR                   *NameBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03828             UNICODE_STRING          <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
03829 
03830             KdPrint((<span class="stringliteral">"[CM]\tCmpFreePostBlock: Dereferencing KeyBody:%08lx\n"</span>, PostBlock-&gt;PostKeyBody-&gt;KeyBody));
03831             NameBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, MAX_KEY_NAME_LENGTH);
03832             <span class="keywordflow">if</span>(NameBuffer) {
03833                <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a14">CmpInitializeKeyNameString</a>(PostBlock-&gt;PostKeyBody-&gt;KeyBody-&gt;KeyControlBlock-&gt;KeyNode,&amp;KeyName,NameBuffer);
03834                KdPrint((<span class="stringliteral">"[CM]\tCmpFreePostBlock: KeyName:tKey = %.*S\n"</span>,<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length / <span class="keyword">sizeof</span>(WCHAR),<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer));
03835                <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NameBuffer);
03836             }
03837 <span class="preprocessor">#endif</span>
03838 <span class="preprocessor"></span>        }
03839 
03840         <span class="comment">//</span>
03841         <span class="comment">// KeyBodyList must be used only in CmpPostBlock implementation for the delayed dereferencing mechanism.</span>
03842         <span class="comment">//</span>
03843         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IsListEmpty(&amp;(PostBlock-&gt;PostKeyBody-&gt;KeyBodyList)));
03844 
03845         <span class="comment">//</span>
03846         <span class="comment">// dereference the actual keybody</span>
03847         <span class="comment">//</span>
03848         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(PostBlock-&gt;PostKeyBody-&gt;KeyBody);
03849 
03850         <span class="comment">//</span>
03851         <span class="comment">// Free the PostKeyBody structure</span>
03852         <span class="comment">//</span>
03853         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock-&gt;PostKeyBody);
03854     }
03855 
03856     <span class="keywordflow">if</span>( <a class="code" href="../../d1/d2/cmp_8h.html#a89">IsMasterPostBlock</a>(PostBlock) ) {
03857         <span class="comment">//</span>
03858         <span class="comment">// this members are allocated only for master post blocks</span>
03859         <span class="comment">//</span>
03860         <span class="keywordflow">switch</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a88">PostBlockType</a>(PostBlock)) {
03861             <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a335a204">PostSynchronous</a>:
03862                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock-&gt;u-&gt;Sync.SystemEvent);
03863                 <span class="keywordflow">break</span>;
03864             <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a335a205">PostAsyncUser</a>:
03865                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock-&gt;u-&gt;AsyncUser.Apc);
03866                 <span class="keywordflow">break</span>;
03867             <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a335a206">PostAsyncKernel</a>:
03868                 <span class="keywordflow">break</span>;
03869         }
03870         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock-&gt;u);
03871     }
03872 
03873 <span class="preprocessor">#ifdef _CM_ENTRYLIST_MANIPULATION</span>
03874 <span class="preprocessor"></span>    RtlZeroMemory((PVOID)PostBlock, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">CM_POST_BLOCK</a>));
03875 <span class="preprocessor">#endif</span>
03876 <span class="preprocessor"></span>
03877     <span class="comment">// and the storage for the Post object</span>
03878     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock);
03879 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a254" doxytag="cmp.h::CmpFreeSecurityDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpFreeSecurityDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d1/cmse_8c-source.html#l01464">1464</a> of file <a class="el" href="../../d8/d1/cmse_8c-source.html">cmse.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00140">CmpFreeKeyByCell()</a>, and <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01064">CmpFreeKeyValues()</a>.
<p>
<pre class="fragment"><div>01471                    :
01472 
01473     Frees <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor associated with a particular node.  This
01474     can <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> happen when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> node <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> actually being deleted from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01475     registry.
01476 
01477     NOTE:   Caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expected to have already marked relevent cells dirty.
01478 
01479 Arguments:
01480 
01481     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies thepointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> hive of interest
01482 
01483     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - Supplies index <span class="keywordflow">for</span> cell to free storage <span class="keywordflow">for</span> (<a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target)
01484 
01485 Return Value:
01486 
01487     None.
01488 
01489 --*/
01490 
01491 {
01492     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> Node;
01493     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> Security;
01494     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> SecurityCell;
01495 
01496     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01497     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
01498         KdPrint((<span class="stringliteral">"CmpFreeSecurityDescriptor for cell %ld\n"</span>,Cell));
01499     }
01500 
01501     <span class="comment">//</span>
01502     <span class="comment">// Map in the cell whose security descriptor is being freed</span>
01503     <span class="comment">//</span>
01504     Node = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);
01505     <a class="code" href="../../d1/d2/cmp_8h.html#a84">ASSERT_NODE</a>(&amp;(Node-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>));
01506 
01507     <span class="comment">//</span>
01508     <span class="comment">// Map in the cell containing the security descriptor.</span>
01509     <span class="comment">//</span>
01510     SecurityCell = Node-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a>;
01511     Security = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, SecurityCell);
01512     <a class="code" href="../../d1/d2/cmp_8h.html#a85">ASSERT_SECURITY</a>(&amp;(Security-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o2">KeySecurity</a>));
01513 
01514 
01515     <span class="keywordflow">if</span> (Security-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o2">KeySecurity</a>.<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o4">ReferenceCount</a> == 1) {
01516 
01517         <span class="comment">//</span>
01518         <span class="comment">// This is the only cell that references this security descriptor,</span>
01519         <span class="comment">// so it is ok to free it now.</span>
01520         <span class="comment">//</span>
01521         <a class="code" href="../../d7/d2/cmse_8c.html#a7">CmpRemoveSecurityCellList</a>(Hive, SecurityCell);
01522         <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, SecurityCell);
01523         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
01524             KdPrint((<span class="stringliteral">"CmpFreeSecurityDescriptor: freeing security cell\n"</span>));
01525         }
01526     } <span class="keywordflow">else</span> {
01527 
01528         <span class="comment">//</span>
01529         <span class="comment">// More than one node references this security descriptor, so</span>
01530         <span class="comment">// just decrement the reference count.</span>
01531         <span class="comment">//</span>
01532         Security-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o2">KeySecurity</a>.<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o4">ReferenceCount</a> -= 1;
01533         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
01534             KdPrint((<span class="stringliteral">"CmpFreeSecurityDescriptor: decrementing reference count\n"</span>));
01535         }
01536     }
01537 
01538     <span class="comment">//</span>
01539     <span class="comment">// Zero out the pointer to the security descriptdr in the main cell</span>
01540     <span class="comment">//</span>
01541     Node-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01542 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a261" doxytag="cmp.h::CmpFreeValue" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpFreeValue           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00053">53</a> of file <a class="el" href="../../d0/d2/cmsubs2_8c-source.html">cmsubs2.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00508">CmpIsHKeyValueSmall</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00498">_CM_KEY_VALUE::Data</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00497">_CM_KEY_VALUE::DataLength</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00538">_CELL_DATA::_u::KeyValue</a>, and <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00092">CmDeleteValueKey()</a>, <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00140">CmpFreeKeyByCell()</a>, and <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01064">CmpFreeKeyValues()</a>.
<p>
<pre class="fragment"><div>00059                    :
00060 
00061     Free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value entry <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>.Cell refers to, including
00062     its name and data cells.
00063 
00064 Arguments:
00065 
00066     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive
00067 
00068     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - supplies index of value to <span class="keyword">delete</span>
00069 
00070 Return Value:
00071 
00072     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
00073 
00074         &lt;TBS&gt;
00075 
00076 --*/
00077 {
00078     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> value;
00079     ULONG       realsize;
00080     BOOLEAN     small;
00081 
00082     <span class="comment">//</span>
00083     <span class="comment">// map in the cell</span>
00084     <span class="comment">//</span>
00085     value = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);
00086 
00087     <span class="comment">//</span>
00088     <span class="comment">// free data if present</span>
00089     <span class="comment">//</span>
00090     small = <a class="code" href="../../d9/d0/cmdata_8h.html#a38">CmpIsHKeyValueSmall</a>(realsize, value-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o2">DataLength</a>);
00091     <span class="keywordflow">if</span> ((! small) &amp;&amp; (realsize &gt; 0))
00092     {
00093         <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, value-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>);
00094     }
00095 
00096     <span class="comment">//</span>
00097     <span class="comment">// free the cell itself</span>
00098     <span class="comment">//</span>
00099     <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, Cell);
00100 
00101     <span class="keywordflow">return</span>;
00102 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a321" doxytag="cmp.h::CmpGetNameControlBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html">PCM_NAME_CONTROL_BLOCK</a> CmpGetNameControlBlock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PUNICODE_STRING&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>NodeName</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00368">368</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
References <a class="el" href="../../d0/d1/cmname_8c-source.html#l00195">CmpCompareCompressedName()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00035">CmpNameCacheTable</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00215">_CM_NAME_CONTROL_BLOCK::Compressed</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00208">_CM_NAME_HASH::ConvKey</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00220">_CM_NAME_CONTROL_BLOCK::ConvKey</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00474">GET_HASH_INDEX</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00223">_CM_NAME_CONTROL_BLOCK::Name</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00218">_CM_NAME_CONTROL_BLOCK::NameHash</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00222">_CM_NAME_CONTROL_BLOCK::NameLength</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00209">_CM_NAME_HASH::NextHash</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00281">PROTECTED_POOL</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00216">_CM_NAME_CONTROL_BLOCK::RefCount</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01178">RtlUpcaseUnicodeChar()</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00824">CmpCreateKeyControlBlock()</a>.
<p>
<pre class="fragment"><div>00371 {
00372     <a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html">PCM_NAME_CONTROL_BLOCK</a>   Ncb;
00373     ULONG  Cnt;
00374     WCHAR *Cp;
00375     WCHAR *Cp2;
00376     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00377     ULONG i;
00378     ULONG      <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00379     <a class="code" href="../../d1/d6/struct__CM__NAME__HASH.html">PCM_NAME_HASH</a> CurrentName;
00380     ULONG rc;
00381     BOOLEAN NameFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00382     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> NameSize;
00383     BOOLEAN NameCompressed;
00384     ULONG NameConvKey=0;
00385     LONG Result;
00386 
00387     <span class="comment">//</span>
00388     <span class="comment">// Calculate the ConvKey for this NadeName;</span>
00389     <span class="comment">//</span>
00390 
00391     Cp = NodeName-&gt;Buffer;
00392     <span class="keywordflow">for</span> (Cnt=0; Cnt&lt;NodeName-&gt;Length; Cnt += <span class="keyword">sizeof</span>(WCHAR)) {
00393         <span class="keywordflow">if</span> (*Cp != OBJ_NAME_PATH_SEPARATOR) {
00394             NameConvKey = 37 * NameConvKey + (ULONG) <a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(*Cp);
00395         }
00396         ++Cp;
00397     }
00398 
00399     <span class="comment">//</span>
00400     <span class="comment">// Find the Name Size;</span>
00401     <span class="comment">// </span>
00402     NameCompressed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00403     NameSize = NodeName-&gt;Length / <span class="keyword">sizeof</span>(WCHAR);
00404     <span class="keywordflow">for</span> (i=0;i&lt;NodeName-&gt;Length/<span class="keyword">sizeof</span>(WCHAR);i++) {
00405         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)NodeName-&gt;Buffer[i] &gt; (UCHAR)-1) {
00406             NameSize = NodeName-&gt;Length;
00407             NameCompressed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00408         }
00409     }
00410 
00411     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a76">GET_HASH_INDEX</a>(NameConvKey);
00412     CurrentName = <a class="code" href="../../d8/d2/cmsubs_8c.html#a8">CmpNameCacheTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00413 
00414     <span class="keywordflow">while</span> (CurrentName) {
00415         Ncb =  CONTAINING_RECORD(CurrentName, <a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html">CM_NAME_CONTROL_BLOCK</a>, NameHash);
00416 
00417         <span class="keywordflow">if</span> ((NameConvKey == CurrentName-&gt;<a class="code" href="../../d1/d6/struct__CM__NAME__HASH.html#o0">ConvKey</a>) &amp;&amp;
00418             (NameSize == Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a>)) {
00419             <span class="comment">//</span>
00420             <span class="comment">// Hash value matches, compare the names.</span>
00421             <span class="comment">//</span>
00422             NameFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00423             <span class="keywordflow">if</span> (Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o0">Compressed</a>) {
00424                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a319">CmpCompareCompressedName</a>(NodeName, Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o6">Name</a>, NameSize)) {
00425                     NameFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00426                 }
00427             } <span class="keywordflow">else</span> {
00428                 Cp = (WCHAR *) NodeName-&gt;Buffer;
00429                 Cp2 = (WCHAR *) Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o6">Name</a>;
00430                 <span class="keywordflow">for</span> (i=0 ;i&lt;Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a>; i+= <span class="keyword">sizeof</span>(WCHAR)) {
00431                     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(*Cp) != <a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(*Cp2)) {
00432                         NameFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00433                         <span class="keywordflow">break</span>;
00434                     }
00435                     ++Cp;
00436                     ++Cp2;
00437                 }
00438             }
00439             <span class="keywordflow">if</span> (NameFound) {
00440                 <span class="comment">//</span>
00441                 <span class="comment">// Found it, increase the refcount.</span>
00442                 <span class="comment">//</span>
00443                 <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o1">RefCount</a> + 1) == 0) {
00444                     <span class="comment">//</span>
00445                     <span class="comment">// We have maxed out the ref count.</span>
00446                     <span class="comment">// fail the call.</span>
00447                     <span class="comment">//</span>
00448                     Ncb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00449                 } <span class="keywordflow">else</span> {
00450                     ++Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o1">RefCount</a>;
00451                 }
00452                 <span class="keywordflow">break</span>;
00453             }
00454         }
00455         CurrentName = CurrentName-&gt;<a class="code" href="../../d1/d6/struct__CM__NAME__HASH.html#o1">NextHash</a>;
00456     }
00457     
00458     <span class="keywordflow">if</span> (NameFound == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00459         <span class="comment">//</span>
00460         <span class="comment">// Now need to create one Name block for this string.</span>
00461         <span class="comment">//</span>
00462         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = FIELD_OFFSET(<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html">CM_NAME_CONTROL_BLOCK</a>, Name) + NameSize;
00463  
00464         Ncb = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(PagedPool,
00465                                     Size,
00466                                     CM_NAME_TAG | PROTECTED_POOL);
00467  
00468         <span class="keywordflow">if</span> (Ncb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00469             <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00470         }
00471         RtlZeroMemory(Ncb, Size);
00472  
00473         <span class="comment">//</span>
00474         <span class="comment">// Update all the info for this newly created Name block.</span>
00475         <span class="comment">//</span>
00476         <span class="keywordflow">if</span> (NameCompressed) {
00477             Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o0">Compressed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00478             <span class="keywordflow">for</span> (i=0;i&lt;NameSize;i++) {
00479                 ((PUCHAR)Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o6">Name</a>)[i] = (UCHAR)(NodeName-&gt;Buffer[i]);
00480             }
00481         } <span class="keywordflow">else</span> {
00482             Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o0">Compressed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00483             RtlCopyMemory((PVOID)(Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o6">Name</a>), (PVOID)(NodeName-&gt;Buffer), NameSize);
00484         }
00485 
00486         Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o3">ConvKey</a> = NameConvKey;
00487         Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o1">RefCount</a> = 1;
00488         Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a> = NameSize;
00489         
00490         CurrentName = &amp;(Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o2">NameHash</a>);
00491         <span class="comment">//</span>
00492         <span class="comment">// Insert into Name Hash table.</span>
00493         <span class="comment">//</span>
00494         CurrentName-&gt;<a class="code" href="../../d1/d6/struct__CM__NAME__HASH.html#o1">NextHash</a> = <a class="code" href="../../d8/d2/cmsubs_8c.html#a8">CmpNameCacheTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00495         <a class="code" href="../../d8/d2/cmsubs_8c.html#a8">CmpNameCacheTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = CurrentName;
00496     }
00497 
00498     <span class="keywordflow">return</span>(Ncb);
00499 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a308" doxytag="cmp.h::CmpGetNextName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpGetNextName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>RemainingName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>NextName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Last</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00860">860</a> of file <a class="el" href="../../d3/d1/cmparse_8c-source.html">cmparse.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00034">MAX_KEY_NAME_LENGTH</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>, and <a class="el" href="../../d6/d9/cmcontrl_8c-source.html#l00256">CmpWalkPath()</a>.
<p>
<pre class="fragment"><div>00867                    :
00868 
00869     This routine parses off <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next component of a registry <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>, returning
00870     all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> interesting state about <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>, including whether <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>'s legal.
00871 
00872 Arguments:
00873 
00874     Current - supplies pointer to variable which points to <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> to parse.
00875               on input - parsing starts from here
00876               on output - updated to reflect starting position <span class="keywordflow">for</span> next call.
00877 
00878     NextName - supplies pointer to a unicode_string, which will be set up
00879                to point into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parse string.
00880 
00881     Last - supplies a pointer to a <span class="keywordtype">boolean</span> - set to <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00882            last component of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name being parse, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00883 
00884 Return Value:
00885 
00886     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> all <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> well.
00887 
00888     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> illegal name (too <span class="keywordtype">long</span> component, bad character, etc.)
00889         (<span class="keywordflow">if</span> <span class="keyword">false</span>, all out parameter values are bogus.)
00890 
00891 --*/
00892 {
00893     BOOLEAN rc = TRUE;
00894 
00895     <span class="comment">//</span>
00896     <span class="comment">// Deal with NULL paths, and pointers to NULL paths</span>
00897     <span class="comment">//</span>
00898     if ((RemainingName-&gt;Buffer == NULL) || (RemainingName-&gt;Length == 0)) {
00899         *Last = TRUE;
00900         NextName-&gt;Buffer = NULL;
00901         NextName-&gt;Length = 0;
00902         <span class="keywordflow">return</span> TRUE;
00903     }
00904 
00905     <span class="keywordflow">if</span> (*(RemainingName-&gt;Buffer) == UNICODE_NULL) {
00906         *Last = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00907         NextName-&gt;Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00908         NextName-&gt;Length = 0;
00909         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00910     }
00911 
00912     <span class="comment">//</span>
00913     <span class="comment">// Skip over leading path separators</span>
00914     <span class="comment">//</span>
00915     <span class="keywordflow">if</span> (*(RemainingName-&gt;Buffer) == OBJ_NAME_PATH_SEPARATOR) {
00916         RemainingName-&gt;Buffer++;
00917         RemainingName-&gt;Length -= <span class="keyword">sizeof</span>(WCHAR);
00918         RemainingName-&gt;MaximumLength -= <span class="keyword">sizeof</span>(WCHAR);
00919     }
00920 
00921     <span class="comment">//</span>
00922     <span class="comment">// Remember where the component starts, and scan to the end</span>
00923     <span class="comment">//</span>
00924     NextName-&gt;Buffer = RemainingName-&gt;Buffer;
00925     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00926         <span class="keywordflow">if</span> (RemainingName-&gt;Length == 0) {
00927             <span class="keywordflow">break</span>;
00928         }
00929         <span class="keywordflow">if</span> (*RemainingName-&gt;Buffer == OBJ_NAME_PATH_SEPARATOR) {
00930             <span class="keywordflow">break</span>;
00931         }
00932 
00933         <span class="comment">//</span>
00934         <span class="comment">// NOT at end</span>
00935         <span class="comment">// NOT another path sep</span>
00936         <span class="comment">//</span>
00937 
00938         RemainingName-&gt;Buffer++;
00939         RemainingName-&gt;Length -= <span class="keyword">sizeof</span>(WCHAR);
00940         RemainingName-&gt;MaximumLength -= <span class="keyword">sizeof</span>(WCHAR);
00941     }
00942 
00943     <span class="comment">//</span>
00944     <span class="comment">// Compute component length, return error if it's illegal</span>
00945     <span class="comment">//</span>
00946     NextName-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)
00947         ((PUCHAR)RemainingName-&gt;Buffer - (PUCHAR)(NextName-&gt;Buffer));
00948     <span class="keywordflow">if</span> (NextName-&gt;Length &gt; <a class="code" href="../../d9/d0/cmdata_8h.html#a1">MAX_KEY_NAME_LENGTH</a>)
00949     {
00950         rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00951     }
00952     NextName-&gt;MaximumLength = NextName-&gt;Length;
00953 
00954     <span class="comment">//</span>
00955     <span class="comment">// Set last, return success</span>
00956     <span class="comment">//</span>
00957     *Last = (RemainingName-&gt;Length == 0);
00958     <span class="keywordflow">return</span> rc;
00959 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a329" doxytag="cmp.h::CmpGetValueKeyFromCache" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> CmpGetValueKeyFromCache           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>List</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Index</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PPCM_CACHED_VALUE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>ContainingList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IndexCached</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT BOOLEAN *&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueCached</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/cmtree_8c-source.html#l00200">200</a> of file <a class="el" href="../../d5/d2/cmtree_8c-source.html">cmtree.c</a>.
<p>
References <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00585">CM_CACHE_DATA_NOT_CACHED</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00609">CMP_GET_CACHED_ADDRESS</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00611">CMP_GET_CACHED_KEYVALUE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00608">CMP_IS_CELL_CACHED</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00613">CMP_MARK_CELL_CACHED</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00142">CmpMakeSpecialPoolReadOnly</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00143">CmpMakeSpecialPoolReadWrite</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00599">_CM_CACHED_VALUE::DataCacheType</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00335">HvGetCellSize()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00541">_CELL_DATA::_u::KeyList</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00601">_CM_CACHED_VALUE::KeyValue</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00600">_CM_CACHED_VALUE::ValueKeySize</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00416">CmEnumerateValueKey()</a>, and <a class="el" href="../../d5/d2/cmtree_8c-source.html#l00309">CmpFindValueByNameFromCache()</a>.
<p>
<pre class="fragment"><div>00210                    :
00211 
00212     Get <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Valve Node.  Check <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already cached, <span class="keywordflow">if</span> not but <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> index <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> cached, 
00213     cache and <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value node.
00214 
00215 Arguments:
00216 
00217     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> hive of interest.
00218 
00219     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> - pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Value <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> Array (of ULOONG_PTR <span class="keywordflow">if</span> cached and ULONG <span class="keywordflow">if</span> non-cached)
00220 
00221     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Value index array
00222 
00223     ContainlingList - The address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entry that will receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> found cached value.
00224 
00225     IndexCached - Indicate <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> index list <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> cached.  If not, everything <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00226                   original registry data.
00227 
00228     ValueCached - Indicating whether Value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> cached or not.
00229 
00230 Return Value:
00231 
00232     Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Valve Node.
00233 --*/
00234 {
00235     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> pchild;
00236     PULONG_PTR    CachedList;
00237     ULONG AllocSize;
00238     ULONG CopySize;
00239     <a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PCM_CACHED_VALUE</a> CachedValue;
00240 
00241     <span class="keywordflow">if</span> (IndexCached) {
00242         <span class="comment">//</span>
00243         <span class="comment">// The index array is cached, so List is pointing to an array of ULONG_PTR.</span>
00244         <span class="comment">// Use CachedList.</span>
00245         <span class="comment">//</span>
00246         CachedList = (PULONG_PTR) <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>;
00247         *ValueCached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00248         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/cmdata_8h.html#a45">CMP_IS_CELL_CACHED</a>(CachedList[Index])) {
00249             pchild = <a class="code" href="../../d9/d0/cmdata_8h.html#a48">CMP_GET_CACHED_KEYVALUE</a>(CachedList[Index]);
00250             *ContainingList = &amp;((<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PCM_CACHED_VALUE</a>) CachedList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]);
00251         } <span class="keywordflow">else</span> {
00252             pchild = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o4">KeyList</a>[Index]);
00253             <span class="comment">//</span>
00254             <span class="comment">// Allocate a PagedPool to cache the value node.</span>
00255             <span class="comment">//</span>
00256             CopySize = (ULONG) <a class="code" href="../../d8/d0/hivecell_8c.html#a15">HvGetCellSize</a>(Hive, pchild);
00257             AllocSize = CopySize + FIELD_OFFSET(<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html">CM_CACHED_VALUE</a>, KeyValue);
00258             
00259             <span class="comment">// Dragos: Changed to catch the memory violator</span>
00260             <span class="comment">// it didn't work</span>
00261             <span class="comment">//CachedValue = (PCM_CACHED_VALUE) ExAllocatePoolWithTagPriority(PagedPool, AllocSize, CM_CACHE_VALUE_TAG,NormalPoolPrioritySpecialPoolUnderrun);</span>
00262             CachedValue = (<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PCM_CACHED_VALUE</a>) <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(PagedPool, AllocSize, CM_CACHE_VALUE_TAG);
00263 
00264             <span class="keywordflow">if</span> (CachedValue) {
00265                 <span class="comment">//</span>
00266                 <span class="comment">// Set the information for later use if we need to cache data as well.</span>
00267                 <span class="comment">//</span>
00268                 CachedValue-&gt;<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html#o0">DataCacheType</a> = <a class="code" href="../../d9/d0/cmdata_8h.html#a40">CM_CACHE_DATA_NOT_CACHED</a>;
00269                 CachedValue-&gt;<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html#o1">ValueKeySize</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) CopySize;
00270 
00271                 RtlCopyMemory((PVOID)&amp;(CachedValue-&gt;<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html#o2">KeyValue</a>), pchild, CopySize);
00272 
00273 
00274                 <span class="comment">// Trying to catch the BAD guy who writes over our pool.</span>
00275                 <a class="code" href="../../d1/d2/cmp_8h.html#a8">CmpMakeSpecialPoolReadWrite</a>( <a class="code" href="../../d9/d0/cmdata_8h.html#a46">CMP_GET_CACHED_ADDRESS</a>(CachedList) );
00276 
00277                 CachedList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = <a class="code" href="../../d9/d0/cmdata_8h.html#a50">CMP_MARK_CELL_CACHED</a>(CachedValue);
00278 
00279                 <span class="comment">// Trying to catch the BAD guy who writes over our pool.</span>
00280                 <a class="code" href="../../d1/d2/cmp_8h.html#a7">CmpMakeSpecialPoolReadOnly</a>( <a class="code" href="../../d9/d0/cmdata_8h.html#a46">CMP_GET_CACHED_ADDRESS</a>(CachedList) );
00281 
00282 
00283                 <span class="comment">// Trying to catch the BAD guy who writes over our pool.</span>
00284                 <a class="code" href="../../d1/d2/cmp_8h.html#a7">CmpMakeSpecialPoolReadOnly</a>(CachedValue);
00285 
00286                 *ContainingList = &amp;((<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PCM_CACHED_VALUE</a>) CachedList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]);
00287                 <span class="comment">//</span>
00288                 <span class="comment">// Now we have the stuff cached, use the cache data.</span>
00289                 <span class="comment">//</span>
00290                 pchild = <a class="code" href="../../d9/d0/cmdata_8h.html#a48">CMP_GET_CACHED_KEYVALUE</a>(CachedValue);
00291             } <span class="keywordflow">else</span> {
00292                 <span class="comment">//</span>
00293                 <span class="comment">// If the allocation fails, just do not cache it. continue.</span>
00294                 <span class="comment">//</span>
00295                 *ValueCached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00296             }
00297         }
00298     } <span class="keywordflow">else</span> {
00299         <span class="comment">//</span>
00300         <span class="comment">// The Valve Index Array is from the registry hive, just get the cell and move on.</span>
00301         <span class="comment">//</span>
00302         pchild = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o4">KeyList</a>[Index]);
00303         *ValueCached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00304     }
00305     <span class="keywordflow">return</span> (pchild);
00306 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a328" doxytag="cmp.h::CmpGetValueListFromCache" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> CmpGetValueListFromCache           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d6/struct__CACHED__CHILD__LIST.html">PCACHED_CHILD_LIST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ChildList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT BOOLEAN *&nbsp;</td>
          <td class="mdname" nowrap> <em>IndexCached</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a253" doxytag="cmp.h::CmpHiveRootSecurityDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PSECURITY_DESCRIPTOR CmpHiveRootSecurityDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d1/cmse_8c-source.html#l01227">1227</a> of file <a class="el" href="../../d8/d1/cmse_8c-source.html">cmse.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00263">CMS_SEC</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l01607">RtlAddAccessAllowedAce()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00099">RtlCreateAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01945">RtlCreateSecurityDescriptor()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00996">RtlGetAce()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01166">RtlInitializeSid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01030">RtlLengthRequiredSid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02543">RtlSetDaclSecurityDescriptor()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01286">RtlSubAuthoritySid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00810">RtlValidSid()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00109">WorldSid</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01165">CmpCreateRegistryRoot()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00726">CmpInitializeHiveList()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02022">CmpInitializeSystemHive()</a>, and <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01545">CmpSetVersionData()</a>.
<p>
<pre class="fragment"><div>01232                    :
01233 
01234     This routine allocates and initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">default</span> security descriptor
01235     <span class="keywordflow">for</span> a system-created registry key.
01236 
01237     The caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> responsible <span class="keywordflow">for</span> freeing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated security descriptor
01238     when he <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done with <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
01239 
01240 Arguments:
01241 
01242     None
01243 
01244 Return Value:
01245 
01246     Pointer to an initialized security descriptor <span class="keywordflow">if</span> successful.
01247 
01248     Bugcheck otherwise.
01249 
01250 --*/
01251 
01252 {
01253     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01254     PSECURITY_DESCRIPTOR SecurityDescriptor=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01255     PACL Acl=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01256     PACL AclCopy;
01257     PSID <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01258     PSID RestrictedSid=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01259     PSID SystemSid=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01260     PSID AdminSid=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01261     SID_IDENTIFIER_AUTHORITY WorldAuthority = SECURITY_WORLD_SID_AUTHORITY;
01262     SID_IDENTIFIER_AUTHORITY NtAuthority = SECURITY_NT_AUTHORITY;
01263     ULONG AceLength;
01264     ULONG AclLength;
01265     PACE_HEADER AceHeader;
01266 
01267     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01268 
01269     <span class="comment">//</span>
01270     <span class="comment">// Allocate and initialize the SIDs we will need.</span>
01271     <span class="comment">//</span>
01272     <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>  = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>(1));
01273     RestrictedSid  = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>(1));
01274     SystemSid = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>(1));
01275     AdminSid  = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>(2));
01276     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>  == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01277         (RestrictedSid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01278         (SystemSid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01279         (AdminSid  == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01280 
01281         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR, 10, 0, 0, 0);
01282     }
01283 
01284     <span class="keywordflow">if</span> ((!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>(WorldSid, &amp;WorldAuthority, 1))) ||
01285         (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>(RestrictedSid, &amp;NtAuthority, 1))) ||
01286         (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>(SystemSid, &amp;NtAuthority, 1))) ||
01287         (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>(AdminSid, &amp;NtAuthority, 2)))) {
01288         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR, 10, 1, 0, 0);
01289     }
01290 
01291     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>(WorldSid, 0)) = SECURITY_WORLD_RID;
01292 
01293     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>(RestrictedSid, 0)) = SECURITY_RESTRICTED_CODE_RID;
01294 
01295     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>(SystemSid, 0)) = SECURITY_LOCAL_SYSTEM_RID;
01296 
01297     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>(AdminSid, 0)) = SECURITY_BUILTIN_DOMAIN_RID;
01298     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>(AdminSid, 1)) = DOMAIN_ALIAS_RID_ADMINS;
01299 
01300     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>(WorldSid));
01301     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>(RestrictedSid));
01302     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>(SystemSid));
01303     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>(AdminSid));
01304 
01305     <span class="comment">//</span>
01306     <span class="comment">// Compute the size of the ACE list</span>
01307     <span class="comment">//</span>
01308 
01309     AceLength = (<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(WorldSid)  -
01310                  <span class="keyword">sizeof</span>(ULONG)          +
01311                  <span class="keyword">sizeof</span>(ACCESS_ALLOWED_ACE))
01312               + (<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(RestrictedSid)  -
01313                  <span class="keyword">sizeof</span>(ULONG)          +
01314                  <span class="keyword">sizeof</span>(ACCESS_ALLOWED_ACE))
01315               + (<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(SystemSid) -
01316                  <span class="keyword">sizeof</span>(ULONG)          +
01317                  <span class="keyword">sizeof</span>(ACCESS_ALLOWED_ACE))
01318               + (<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(AdminSid)  -
01319                  <span class="keyword">sizeof</span>(ULONG)          +
01320                  <span class="keyword">sizeof</span>(ACCESS_ALLOWED_ACE));
01321 
01322     <span class="comment">//</span>
01323     <span class="comment">// Allocate and initialize the ACL</span>
01324     <span class="comment">//</span>
01325 
01326     AclLength = AceLength + <span class="keyword">sizeof</span>(ACL);
01327     Acl = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, AclLength);
01328     <span class="keywordflow">if</span> (Acl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01329         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_SEC) {
01330             KdPrint((<span class="stringliteral">"CmpHiveRootSecurityDescriptor: couldn't allocate ACL\n"</span>));
01331         }
01332 
01333         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR, 10, 2, 0, 0);
01334     }
01335 
01336     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>(Acl, AclLength, ACL_REVISION);
01337     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01338         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_SEC) {
01339             KdPrint((<span class="stringliteral">"CmpHiveRootSecurityDescriptor: couldn't initialize ACL\n"</span>));
01340         }
01341         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR, 10, 3, 0, 0);
01342     }
01343 
01344     <span class="comment">//</span>
01345     <span class="comment">// Now add the ACEs to the ACL</span>
01346     <span class="comment">//</span>
01347     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a>(Acl,
01348                                     ACL_REVISION,
01349                                     KEY_ALL_ACCESS,
01350                                     SystemSid);
01351     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01352         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a>(Acl,
01353                                         ACL_REVISION,
01354                                         KEY_ALL_ACCESS,
01355                                         AdminSid);
01356     }
01357     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01358         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a>(Acl,
01359                                         ACL_REVISION,
01360                                         KEY_READ,
01361                                         WorldSid);
01362     }
01363     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01364         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a>(Acl,
01365                                         ACL_REVISION,
01366                                         KEY_READ,
01367                                         RestrictedSid);
01368     }
01369     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01370         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_SEC) {
01371             KdPrint((<span class="stringliteral">"CmpHiveRootSecurityDescriptor: RtlAddAce failed status %08lx\n"</span>, Status));
01372         }
01373 
01374         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR, 10, 4, 0, 0);
01375     }
01376 
01377     <span class="comment">//</span>
01378     <span class="comment">// Make the ACEs inheritable</span>
01379     <span class="comment">//</span>
01380     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a12">RtlGetAce</a>(Acl,0,&amp;AceHeader);
01381     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
01382     AceHeader-&gt;AceFlags |= CONTAINER_INHERIT_ACE;
01383 
01384     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a12">RtlGetAce</a>(Acl,1,&amp;AceHeader);
01385     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
01386     AceHeader-&gt;AceFlags |= CONTAINER_INHERIT_ACE;
01387 
01388     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a12">RtlGetAce</a>(Acl,2,&amp;AceHeader);
01389     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
01390     AceHeader-&gt;AceFlags |= CONTAINER_INHERIT_ACE;
01391 
01392     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a12">RtlGetAce</a>(Acl,3,&amp;AceHeader);
01393     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
01394     AceHeader-&gt;AceFlags |= CONTAINER_INHERIT_ACE;
01395     <span class="comment">//</span>
01396     <span class="comment">// We are finally ready to allocate and initialize the security descriptor</span>
01397     <span class="comment">// Allocate enough space to hold both the security descriptor and the</span>
01398     <span class="comment">// ACL.  This allows us to free the whole thing at once when we are</span>
01399     <span class="comment">// done with it.</span>
01400     <span class="comment">//</span>
01401 
01402     SecurityDescriptor = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
01403                             PagedPool,
01404                             <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR) + AclLength
01405                             );
01406 
01407     <span class="keywordflow">if</span> (SecurityDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01408         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_SEC) {
01409             KdPrint((<span class="stringliteral">"CmpHiveRootSecurityDescriptor: Couldn't allocate Sec. Desc.\n"</span>));
01410         }
01411         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR, 10, 5, 0, 0);
01412     }
01413 
01414     AclCopy = (PACL)((PISECURITY_DESCRIPTOR)SecurityDescriptor+1);
01415     RtlMoveMemory(AclCopy, Acl, AclLength);
01416 
01417     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>( SecurityDescriptor,
01418                                           SECURITY_DESCRIPTOR_REVISION );
01419     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01420         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_SEC) {
01421             KdPrint((<span class="stringliteral">"CmpHiveRootSecurityDescriptor: CreateSecDesc failed %08lx\n"</span>,Status));
01422         }
01423         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SecurityDescriptor);
01424         SecurityDescriptor=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01425         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR, 10, 6, 0, 0);
01426     }
01427 
01428     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a>( SecurityDescriptor,
01429                                            TRUE,
01430                                            AclCopy,
01431                                            FALSE );
01432     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01433         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_SEC) {
01434             KdPrint((<span class="stringliteral">"CmpHiveRootSecurityDescriptor: SetDacl failed %08lx\n"</span>,Status));
01435         }
01436         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SecurityDescriptor);
01437         SecurityDescriptor=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01438         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR, 10, 7, 0, 0);
01439     }
01440 
01441     <span class="comment">//</span>
01442     <span class="comment">// free any allocations we made</span>
01443     <span class="comment">//</span>
01444     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01445         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(WorldSid);
01446     }
01447     <span class="keywordflow">if</span> (RestrictedSid!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01448         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(RestrictedSid);
01449     }
01450     <span class="keywordflow">if</span> (SystemSid!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01451         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SystemSid);
01452     }
01453     <span class="keywordflow">if</span> (AdminSid!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01454         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(AdminSid);
01455     }
01456     <span class="keywordflow">if</span> (Acl!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01457         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Acl);
01458     }
01459 
01460     <span class="keywordflow">return</span>(SecurityDescriptor);
01461 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a311" doxytag="cmp.h::CmpInitHiveFromFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpInitHiveFromFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>FileName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>HiveFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>CmHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Allocate</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>RegistryLocked</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02422">2422</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
References <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a290">CmpOpenHiveFiles()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00047">FileName</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00570">HFILE_TYPE_LOG</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00568">HFILE_TYPE_PRIMARY</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00197">HINIT_CREATE</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00199">HINIT_FILE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00726">CmpInitializeHiveList()</a>, and <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>.
<p>
<pre class="fragment"><div>02432                    :
02433 
02434     This routine opens a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> and log, allocates a <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, and initializes
02435     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
02436 
02437 Arguments:
02438 
02439     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> - Supplies name of <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to be loaded.
02440 
02441     HiveFlags - Supplies hive flags to be passed to <a class="code" href="../../d8/d1/cminit_8c.html#a4">CmpInitializeHive</a>
02442 
02443     CmHive   - Returns pointer to initialized hive (<span class="keywordflow">if</span> successful)
02444 
02445     Allocate - IN: <span class="keywordflow">if</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ok to allocate, <span class="keywordflow">if</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> hive must exist
02446                     (bug .log may get created)
02447                OUT: <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> actually created hive, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> existed before
02448 
02449 Return Value:
02450 
02451     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
02452 
02453 --*/
02454 
02455 {
02456     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> NewHive;
02457     ULONG Disposition;
02458     ULONG SecondaryDisposition;
02459     HANDLE PrimaryHandle;
02460     HANDLE LogHandle;
02461     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02462     ULONG FileType;
02463     ULONG Operation;
02464 
02465     BOOLEAN Success;
02466 
02467     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02468     *CmHive = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02469 
02470     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a290">CmpOpenHiveFiles</a>(FileName,
02471                               L<span class="stringliteral">".LOG"</span>,
02472                               &amp;PrimaryHandle,
02473                               &amp;LogHandle,
02474                               &amp;Disposition,
02475                               &amp;SecondaryDisposition,
02476                               *Allocate,
02477                               FALSE,
02478                               NULL);
02479 
02480     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02481         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02482     }
02483 
02484     <span class="keywordflow">if</span> (LogHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02485         FileType = <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>;
02486     } <span class="keywordflow">else</span> {
02487         FileType = <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>;
02488     }
02489 
02490     <span class="keywordflow">if</span> (Disposition == FILE_CREATED) {
02491         Operation = <a class="code" href="../../d6/d0/hive_8h.html#a4">HINIT_CREATE</a>;
02492         *Allocate = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02493     } <span class="keywordflow">else</span> {
02494         Operation = <a class="code" href="../../d6/d0/hive_8h.html#a6">HINIT_FILE</a>;
02495         *Allocate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02496     }
02497 
02498     <span class="keywordflow">if</span>( !(*RegistryLocked) ) {
02499         <span class="comment">//</span>
02500         <span class="comment">// Registry should be locked exclusive</span>
02501         <span class="comment">// if not, lock it now and signal this to the caller</span>
02502         <span class="comment">//</span>
02503         <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
02504         *RegistryLocked = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02505     }
02506 
02507     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a275">CmpInitializeHive</a>(&amp;NewHive,
02508                                 Operation,
02509                                 HiveFlags,
02510                                 FileType,
02511                                 NULL,
02512                                 PrimaryHandle,
02513                                 NULL,
02514                                 LogHandle,
02515                                 NULL,
02516                                 FileName
02517                                 );
02518     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02519         ZwClose(PrimaryHandle);
02520         <span class="keywordflow">if</span> (LogHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02521             ZwClose(LogHandle);
02522         }
02523         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02524     } <span class="keywordflow">else</span> {
02525         *CmHive = NewHive;
02526         <span class="keywordflow">return</span>(STATUS_SUCCESS);
02527     }
02528 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a278" doxytag="cmp.h::CmpInitializeCache" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpInitializeCache           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a272" doxytag="cmp.h::CmpInitializeHardwareConfiguration" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpInitializeHardwareConfiguration           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LoaderBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00087">87</a> of file <a class="el" href="../../d5/d9/cmconfig_8c-source.html">cmconfig.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00064">CmpConfigurationAreaSize</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00065">CmpConfigurationData</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00294">CmpSetupConfigurationTree()</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00169">CmRegistryMachineHardwareDescriptionName</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00171">CmRegistryMachineHardwareDeviceMapName</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01630">_CONFIGURATION_COMPONENT_DATA::ComponentEntry</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l00288">_CONFIGURATION_COMPONENT::Identifier</a>, <a class="el" href="../../d0/d4/config_8c-source.html#l00034">KeFindConfigurationEntry()</a>, <a class="el" href="../../d8/d2/i386init_8c-source.html#l00038">KeI386MachineType</a>, <a class="el" href="../../d1/d9/arc_8h.html#a315a227">MaximumType</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d1/d9/arc_8h.html#a314a179">SystemClass</a>, and <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>.
<p>
<pre class="fragment"><div>00092                    :
00093 
00094     This routine creates \\Registry\Machine\Hardware node in
00095     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry and calls SetupTree routine to put <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hardware
00096     information to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry.
00097 
00098 Arguments:
00099 
00100     LoaderBlock - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LoaderBlock passed in from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00101                   OS Loader.
00102 
00103 Returns:
00104 
00105     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code <span class="keywordflow">for</span> sucess or <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a10">reason</a> of <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
00106 
00107 --*/
00108 {
00109     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00110     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00111     HANDLE BaseHandle;
00112     <a class="code" href="../../d5/d8/struct__CONFIGURATION__COMPONENT__DATA.html">PCONFIGURATION_COMPONENT_DATA</a> ConfigurationRoot;
00113     ULONG Disposition;
00114 
00115     ConfigurationRoot = (<a class="code" href="../../d5/d8/struct__CONFIGURATION__COMPONENT__DATA.html">PCONFIGURATION_COMPONENT_DATA</a>)LoaderBlock-&gt;ConfigurationRoot;
00116     <span class="keywordflow">if</span> (ConfigurationRoot) {
00117 
00118 <span class="preprocessor">#ifdef _X86_</span>
00119 <span class="preprocessor"></span>
00120         <span class="comment">//</span>
00121         <span class="comment">//  The following strings found in the registry identify obscure,</span>
00122         <span class="comment">//  yet market dominant, non PC/AT compatible i386 machine in Japan.</span>
00123         <span class="comment">//</span>
00124 
00125 <span class="preprocessor">#define MACHINE_TYPE_FUJITSU_FMR_NAME_A    "FUJITSU FMR-"</span>
00126 <span class="preprocessor"></span><span class="preprocessor">#define MACHINE_TYPE_NEC_PC98_NAME_A       "NEC PC-98"</span>
00127 <span class="preprocessor"></span>
00128         {
00129             <a class="code" href="../../d5/d8/struct__CONFIGURATION__COMPONENT__DATA.html">PCONFIGURATION_COMPONENT_DATA</a> SystemNode;
00130             ULONG JapanMachineId;
00131 
00132             <span class="comment">//</span>
00133             <span class="comment">// For Japan, we have to special case some non PC/AT machines, so</span>
00134             <span class="comment">// determine at this time what kind of platform we are on:</span>
00135             <span class="comment">//</span>
00136             <span class="comment">// NEC PC9800 Compatibles/Fujitsu FM-R Compatibles/IBM PC/AT Compatibles</span>
00137             <span class="comment">//</span>
00138             <span class="comment">// Default is PC/AT compatible.</span>
00139             <span class="comment">//</span>
00140 
00141             JapanMachineId = MACHINE_TYPE_PC_AT_COMPATIBLE;
00142 
00143             <span class="comment">//</span>
00144             <span class="comment">// Find the hardware description node</span>
00145             <span class="comment">//</span>
00146 
00147             SystemNode = <a class="code" href="../../d9/d4/config_8c.html#a0">KeFindConfigurationEntry</a>(ConfigurationRoot,
00148                                                   SystemClass,
00149                                                   MaximumType,
00150                                                   NULL);
00151 
00152             <span class="comment">//</span>
00153             <span class="comment">// Did we find something?</span>
00154             <span class="comment">//</span>
00155 
00156             <span class="keywordflow">if</span> (SystemNode) {
00157 
00158                 <span class="comment">//</span>
00159                 <span class="comment">// Check platform from identifier string</span>
00160                 <span class="comment">//</span>
00161 
00162                 <span class="keywordflow">if</span> (RtlCompareMemory(SystemNode-&gt;<a class="code" href="../../d5/d8/struct__CONFIGURATION__COMPONENT__DATA.html#o3">ComponentEntry</a>.<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o9">Identifier</a>,
00163                                      MACHINE_TYPE_NEC_PC98_NAME_A,
00164                                      <span class="keyword">sizeof</span>(MACHINE_TYPE_NEC_PC98_NAME_A) - 1) ==
00165                     <span class="keyword">sizeof</span>(MACHINE_TYPE_NEC_PC98_NAME_A) - 1) {
00166 
00167                     <span class="comment">//</span>
00168                     <span class="comment">// we are running on NEC PC-9800 comaptibles.</span>
00169                     <span class="comment">//</span>
00170 
00171                     JapanMachineId = MACHINE_TYPE_PC_9800_COMPATIBLE;
00172                     SetNEC_98;
00173 
00174                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (RtlCompareMemory(SystemNode-&gt;<a class="code" href="../../d5/d8/struct__CONFIGURATION__COMPONENT__DATA.html#o3">ComponentEntry</a>.<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o9">Identifier</a>,
00175                                             MACHINE_TYPE_FUJITSU_FMR_NAME_A,
00176                                             <span class="keyword">sizeof</span>(MACHINE_TYPE_FUJITSU_FMR_NAME_A) - 1) ==
00177                            <span class="keyword">sizeof</span>(MACHINE_TYPE_FUJITSU_FMR_NAME_A) - 1) {
00178 
00179                     <span class="comment">//</span>
00180                     <span class="comment">// we are running on Fujitsu FMR comaptibles.</span>
00181                     <span class="comment">//</span>
00182 
00183                     JapanMachineId = MACHINE_TYPE_FMR_COMPATIBLE;
00184                 }
00185             }
00186 
00187             <span class="comment">//</span>
00188             <span class="comment">//  Now 'or' this value into the kernel global.</span>
00189             <span class="comment">//</span>
00190 
00191             <a class="code" href="../../d7/d3/i386init_8c.html#a1">KeI386MachineType</a> |= JapanMachineId;
00192         }
00193 <span class="preprocessor">#endif //_X86_</span>
00194 <span class="preprocessor"></span>
00195         <span class="comment">//</span>
00196         <span class="comment">// Create \\Registry\Machine\Hardware\DeviceMap</span>
00197         <span class="comment">//</span>
00198 
00199         InitializeObjectAttributes(
00200             &amp;ObjectAttributes,
00201             &amp;CmRegistryMachineHardwareDeviceMapName,
00202             0,
00203             (HANDLE)NULL,
00204             NULL
00205             );
00206         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.Attributes |= OBJ_CASE_INSENSITIVE;
00207 
00208         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(                   <span class="comment">// Paht may already exist</span>
00209                     &amp;BaseHandle,
00210                     KEY_READ | KEY_WRITE,
00211                     &amp;ObjectAttributes,
00212                     TITLE_INDEX_VALUE,
00213                     NULL,
00214                     0,
00215                     &amp;Disposition
00216                     );
00217 
00218         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00219             <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00220         }
00221 
00222         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(BaseHandle);
00223 
00224         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Disposition == REG_CREATED_NEW_KEY);
00225 
00226         <span class="comment">//</span>
00227         <span class="comment">// Create \\Registry\Machine\Hardware\Description and use the</span>
00228         <span class="comment">// returned handle as the BaseHandle to build the hardware tree.</span>
00229         <span class="comment">//</span>
00230 
00231         InitializeObjectAttributes(
00232             &amp;ObjectAttributes,
00233             &amp;CmRegistryMachineHardwareDescriptionName,
00234             0,
00235             (HANDLE)NULL,
00236             NULL
00237             );
00238         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.Attributes |= OBJ_CASE_INSENSITIVE;
00239 
00240         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(                   <span class="comment">// Path may already exist</span>
00241                     &amp;BaseHandle,
00242                     KEY_READ | KEY_WRITE,
00243                     &amp;ObjectAttributes,
00244                     TITLE_INDEX_VALUE,
00245                     NULL,
00246                     0,
00247                     &amp;Disposition
00248                     );
00249 
00250         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00251             <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00252         }
00253 
00254         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Disposition == REG_CREATED_NEW_KEY);
00255 
00256         <span class="comment">//</span>
00257         <span class="comment">// Allocate 16K bytes memory from paged pool for constructing</span>
00258         <span class="comment">// configuration data for controller component.</span>
00259         <span class="comment">// NOTE:  The configuration Data for controller component</span>
00260         <span class="comment">//    usually takes less than 100 bytes.  But on EISA machine, the</span>
00261         <span class="comment">//    EISA configuration information takes more than 10K and up to</span>
00262         <span class="comment">//    64K.  I believe 16K is the reasonable number to handler 99.9%</span>
00263         <span class="comment">//    of the machines.  Therefore, 16K is the initial value.</span>
00264         <span class="comment">//</span>
00265 
00266         <a class="code" href="../../d4/d0/cmconfig_8c.html#a10">CmpConfigurationData</a> = (PCM_FULL_RESOURCE_DESCRIPTOR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
00267                                             PagedPool,
00268                                             CmpConfigurationAreaSize
00269                                             );
00270 
00271         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a10">CmpConfigurationData</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00272             <span class="keywordflow">return</span>(STATUS_INSUFFICIENT_RESOURCES);
00273         }
00274 
00275         <span class="comment">//</span>
00276         <span class="comment">// Call SetupConfigurationTree routine to go over each component</span>
00277         <span class="comment">// of the tree and add component information to registry database.</span>
00278         <span class="comment">//</span>
00279 
00280         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d0/cmconfig_8c.html#a11">CmpSetupConfigurationTree</a>(ConfigurationRoot,
00281                                            BaseHandle,
00282                                            -1,
00283                                            (ULONG)-1
00284                                            );
00285         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)CmpConfigurationData);
00286         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(BaseHandle);
00287         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00288     } <span class="keywordflow">else</span> {
00289         <span class="keywordflow">return</span>(STATUS_SUCCESS);
00290     }
00291 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a275" doxytag="cmp.h::CmpInitializeHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpInitializeHive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>CmHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>OperationType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>HiveFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID HiveData&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Primary</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Alternate</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Log</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>External</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>FileName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">471</a> of file <a class="el" href="../../d9/d0/cminit_8c-source.html">cminit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00360">ASSERT_PASSIVE_LEVEL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00108">CmCheckRegistry()</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a178">CMHIVE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00062">CmpAllocate()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00772">CmpFileFlush()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00351">CmpFileRead()</a>, <a class="el" href="../../d9/d2/cmwrapr2_8c-source.html#l00045">CmpFileSetSize()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00516">CmpFileWrite()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00186">CmpFree()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00027">CmpHiveListHead</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00256">CMS_INIT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00272">CMS_INIT_ERROR</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00367">ExInitializeFastMutex</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00650">_CMHIVE::FileHandles</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00047">FileName</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00569">HFILE_TYPE_ALTERNATE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00571">HFILE_TYPE_EXTERNAL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00570">HFILE_TYPE_LOG</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00572">HFILE_TYPE_MAX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00568">HFILE_TYPE_PRIMARY</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00199">HINIT_FILE</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00198">HINIT_MEMORY</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00200">HINIT_MEMORY_INPLACE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00649">_CMHIVE::Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00203">HIVE_VOLATILE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00652">_CMHIVE::HiveList</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00653">_CMHIVE::HiveLock</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00129">HSECTOR_SIZE</a>, <a class="el" href="../../d3/d0/hivefree_8c-source.html#l00034">HvFreeHive()</a>, <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">HvInitializeHive()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00651">_CMHIVE::NotifyList</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01439">CmpCreateTemporaryHive()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02422">CmpInitHiveFromFile()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02022">CmpInitializeSystemHive()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00484">CmpLoadHiveVolatile()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l04077">CmpValidateAlternate()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00097">CmRestoreKey()</a>, <a class="el" href="../../d0/d4/edithive_8c-source.html#l00156">EhOpenHive()</a>, and <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00405">MyCmpInitHiveFromFile()</a>.
<p>
<pre class="fragment"><div>00485                    :
00486 
00487     Initialize a hive.
00488 
00489 Arguments:
00490 
00491     CmHive - pointer to a variable to receive a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CmHive structure
00492 
00493     OperationType - specifies whether to create a <span class="keyword">new</span> hive from scratch,
00494             from a memory image, or by reading a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> from disk.
00495             [<a class="code" href="../../d6/d0/hive_8h.html#a4">HINIT_CREATE</a> | <a class="code" href="../../d6/d0/hive_8h.html#a5">HINIT_MEMORY</a> | <a class="code" href="../../d6/d0/hive_8h.html#a6">HINIT_FILE</a> ]
00496 
00497     HiveFlags - <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a> - Entire hive <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be <span class="keyword">volatile</span>, regardless
00498                                    of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> types of cells allocated
00499                 HIVE_NO_LAZY_FLUSH - Data in <span class="keyword">this</span> hive <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> never written
00500                                    to disk except by an <span class="keyword">explicit</span> FlushKey
00501 
00502     FileType - HFILE_TYPE_*, <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a> or <a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a> set
00503             up <span class="keywordflow">for</span> logging or alternate support respectively.
00504 
00505     HiveData - <span class="keywordflow">if</span> present, supplies a pointer to an in memory image of
00506             from which to init <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive.  Only useful when OperationType
00507             <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set to <a class="code" href="../../d6/d0/hive_8h.html#a5">HINIT_MEMORY</a>.
00508 
00509     Primary - <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> handle <span class="keywordflow">for</span> primary hive <a class="code" href="../../d7/d1/genuedef_8c.html#a9">file</a> (e.g. SYSTEM)
00510 
00511     Alternate - File handle for alternate hive file (e.g. SYSTEM.ALT)
00512 
00513     Log - File handle for log hive file (e.g. SOFTWARE.LOG)
00514 
00515     External - File handle for primary hive file  (e.g.  BACKUP.REG)
00516 
00517     FileName - some path like "...\system32\config\system", which will
00518                 be written into the base block as an aid to debugging.
00519                 may be NULL.
00520 
00521 Return Value:
00522 
00523     NTSTATUS
00524 
00525 --*/
00526 {
00527     FILE_FS_SIZE_INFORMATION    FsSizeInformation;
00528     IO_STATUS_BLOCK             IoStatusBlock;
00529     ULONG                       Cluster;
00530     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00531     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>                     cmhive2;
00532     ULONG                       rc;
00533 
00534     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INIT) {
00535         KdPrint((<span class="stringliteral">"CmpInitializeHive:\t\n"</span>));
00536     }
00537 
00538     <span class="comment">//</span>
00539     <span class="comment">// Reject illegal parms</span>
00540     <span class="comment">//</span>
00541     <span class="keywordflow">if</span> ( (Alternate &amp;&amp; Log)  ||
00542          (External &amp;&amp; (Primary || Alternate || Log)) ||
00543          (Alternate &amp;&amp; !Primary) ||
00544          (Log &amp;&amp; !Primary) ||
00545          ((HiveFlags &amp; <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>) &amp;&amp; (Alternate || Primary || External || Log)) ||
00546          ((OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a5">HINIT_MEMORY</a>) &amp;&amp; (!ARGUMENT_PRESENT(HiveData))) ||
00547          (Log &amp;&amp; (FileType != <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>)) ||
00548          (Alternate &amp;&amp; (FileType != <a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>))
00549        )
00550     {
00551         <span class="keywordflow">return</span> (STATUS_INVALID_PARAMETER);
00552     }
00553 
00554     <span class="comment">//</span>
00555     <span class="comment">// compute control</span>
00556     <span class="comment">//</span>
00557     <span class="keywordflow">if</span> (Primary) {
00558 
00559         <a class="code" href="../../d1/d2/cmp_8h.html#a63">ASSERT_PASSIVE_LEVEL</a>();
00560         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQueryVolumeInformationFile(
00561                     Primary,
00562                     &amp;IoStatusBlock,
00563                     &amp;FsSizeInformation,
00564                     <span class="keyword">sizeof</span>(FILE_FS_SIZE_INFORMATION),
00565                     FileFsSizeInformation
00566                     );
00567         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00568             <span class="keywordflow">return</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00569         }
00570         <span class="keywordflow">if</span> (FsSizeInformation.BytesPerSector &gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) {
00571             <span class="keywordflow">return</span> (STATUS_REGISTRY_IO_FAILED);
00572         }
00573         Cluster = FsSizeInformation.BytesPerSector / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00574         Cluster = (Cluster &lt; 1) ? 1 : Cluster;
00575     } <span class="keywordflow">else</span> {
00576         Cluster = 1;
00577     }
00578 
00579     cmhive2 = <a class="code" href="../../d7/d3/cmwrapr_8c.html#a11">CmpAllocate</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>), FALSE);
00580     <span class="keywordflow">if</span> (cmhive2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00581         <span class="keywordflow">return</span> (STATUS_INSUFFICIENT_RESOURCES);
00582     }
00583 
00584     <span class="comment">//</span>
00585     <span class="comment">// Allocate the mutex from NonPagedPool so it will not be swapped to the disk</span>
00586     <span class="comment">//</span>
00587     cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a> = (<a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a>), CM_POOL_TAG );
00588     <span class="keywordflow">if</span>( cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00589         <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(cmhive2, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>));
00590         <span class="keywordflow">return</span> (STATUS_INSUFFICIENT_RESOURCES);
00591     }
00592 
00593     <span class="comment">//</span>
00594     <span class="comment">// Initialize the Cm hive control block</span>
00595     <span class="comment">//</span>
00596     <span class="comment">//</span>
00597     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((HFILE_TYPE_EXTERNAL+1) == HFILE_TYPE_MAX);
00598     cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>] = Primary;
00599     cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>] = Alternate;
00600     cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>] = Log;
00601     cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a>] = External;
00602 
00603     cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o2">NotifyList</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00604     cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o2">NotifyList</a>.Blink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00605 
00606     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a>);
00607 
00608     <span class="comment">//</span>
00609     <span class="comment">// Initialize the Hv hive control block</span>
00610     <span class="comment">//</span>
00611     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/hiveinit_8c.html#a3">HvInitializeHive</a>(
00612                 &amp;(cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>),
00613                 OperationType,
00614                 HiveFlags,
00615                 FileType,
00616                 HiveData,
00617                 CmpAllocate,
00618                 CmpFree,
00619                 CmpFileSetSize,
00620                 CmpFileWrite,
00621                 CmpFileRead,
00622                 CmpFileFlush,
00623                 Cluster,
00624                 FileName
00625                 );
00626     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00627         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INIT_ERROR) {
00628             KdPrint((<span class="stringliteral">"CmpInitializeHive: "</span>));
00629             KdPrint((<span class="stringliteral">"HvInitializeHive failed, Status = %08lx\n"</span>, Status));
00630         }
00631         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a> );
00632         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a>);
00633         <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(cmhive2, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>));
00634         <span class="keywordflow">return</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00635     }
00636     <span class="keywordflow">if</span> ( (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a6">HINIT_FILE</a>) ||
00637          (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a5">HINIT_MEMORY</a>) ||
00638          (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a7">HINIT_MEMORY_INPLACE</a>))
00639     {
00640         rc = <a class="code" href="../../d1/d2/cmp_8h.html#a294">CmCheckRegistry</a>(cmhive2, TRUE);
00641         <span class="keywordflow">if</span> (rc != 0) {
00642             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INIT_ERROR) {
00643                 KdPrint((<span class="stringliteral">"CmpInitializeHive: "</span>));
00644                 KdPrint((<span class="stringliteral">"CmCheckRegistry failed, rc = %08lx\n"</span>,rc));
00645             }
00646             <span class="comment">//</span>
00647             <span class="comment">// in theory we should do this for MEMORY and MEMORY_INPLACE</span>
00648             <span class="comment">// as well, but they're only used at init time.</span>
00649             <span class="comment">//</span>
00650             <span class="keywordflow">if</span> (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a6">HINIT_FILE</a>) {
00651                 <a class="code" href="../../d2/d1/hivefree_8c.html#a0">HvFreeHive</a>((<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)cmhive2);
00652             }
00653             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a> );
00654             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a>);
00655             <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(cmhive2, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>));
00656             <span class="keywordflow">return</span>(STATUS_REGISTRY_CORRUPT);
00657         }
00658     }
00659 
00660     InsertHeadList(&amp;CmpHiveListHead, &amp;(cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o3">HiveList</a>));
00661     *CmHive = cmhive2;
00662     <span class="keywordflow">return</span> (STATUS_SUCCESS);
00663 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a333" doxytag="cmp.h::CmpInitializeKeyNameString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpInitializeKeyNameString           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>NameBuffer</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01515">1515</a> of file <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html">cmtrecpy.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00121">CmpCompressedNameSize()</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00151">CmpCopyCompressedName()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00440">KEY_COMP_NAME</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00034">MAX_KEY_NAME_LENGTH</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00251">CmpCopySyncTree2()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01235">CmpFlushNotify()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03764">CmpFreePostBlock()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01378">CmpNotifyChangeKey()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00487">CmpPostNotify()</a>, and <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01648">CmpSyncSubKeysAfterDelete()</a>.
<p>
<pre class="fragment"><div>01521                    :
01522 
01523    Initializes a UNICODE_STRING with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of a given key.
01524    
01525    N.B. The initialized string's buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not meant
01526          to be modified.   
01527 
01528 Arguments:
01529 
01530    <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>       - The body of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key in question
01531    <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>    - The UNICODE_STRING to initialize
01532    NameBuffer - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> buffer <a class="code" href="../../d9/d0/cmdata_8h.html#a1">MAX_KEY_NAME_LENGTH</a> bytes in size 
01533                 that will possibly be used as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> UNICODE_STRING's 
01534                 buffer.
01535 
01536 Return Value:
01537 
01538    NONE.
01539 
01540 --*/
01541 {                        
01542    <span class="comment">// is the name stored in compressed form?</span>
01543 
01544    <span class="keywordflow">if</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Flags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>) {
01545 
01546       <span class="comment">// Name is compressed. </span>
01547 
01548       <span class="comment">// Get the uncompressed length.</span>
01549                         
01550       <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>-&gt;Length = <a class="code" href="../../d1/d2/cmp_8h.html#a320">CmpCompressedNameSize</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Name,
01551                                               <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;NameLength);
01552                         
01553       <span class="comment">// Decompress the name into a buffer.</span>
01554 
01555       <a class="code" href="../../d1/d2/cmp_8h.html#a318">CmpCopyCompressedName</a>(NameBuffer, 
01556                             MAX_KEY_NAME_LENGTH,
01557                             <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Name,                                            
01558                             <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;NameLength);
01559 
01560       <span class="comment">//</span>
01561       <span class="comment">// Use the decompression buffer as the string buffer</span>
01562       <span class="comment">//</span>
01563                         
01564       <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>-&gt;Buffer = NameBuffer;      
01565       <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>-&gt;MaximumLength = <a class="code" href="../../d9/d0/cmdata_8h.html#a1">MAX_KEY_NAME_LENGTH</a>;
01566 
01567    } <span class="keywordflow">else</span> {
01568 
01569       <span class="comment">//</span>
01570       <span class="comment">// Name is not compressed. Just use the name string </span>
01571       <span class="comment">// from the key buffer as the string buffer.</span>
01572       <span class="comment">//</span>
01573                         
01574       <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>-&gt;Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;NameLength;                        
01575       <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>-&gt;Buffer = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Name;
01576       <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;MaxNameLen;
01577                      
01578    }                                             
01579 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a273" doxytag="cmp.h::CmpInitializeMachineDependentConfiguration" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpInitializeMachineDependentConfiguration           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LoaderBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00037">37</a> of file <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html">config/alpha/init.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00170">CmRegistryMachineHardwareDescriptionSystemName</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00102">RtlInitAnsiString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>.
<p>
<pre class="fragment"><div>00042                    :
00043 
00044     This routine creates alpha specific entries in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry.
00045 
00046 Arguments:
00047 
00048     LoaderBlock - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LoaderBlock passed in from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00049                   OS Loader.
00050 
00051 Returns:
00052 
00053     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code <span class="keywordflow">for</span> sucess or <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a10">reason</a> of <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
00054 
00055 --*/
00056 
00057 {
00058 
00059     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00060     UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
00061     UNICODE_STRING <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
00062     UNICODE_STRING ValueData;
00063     ANSI_STRING AnsiString;
00064     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00065     HANDLE ParentHandle;
00066 
00067     InitializeObjectAttributes(&amp;ObjectAttributes,
00068                                                &amp;CmRegistryMachineHardwareDescriptionSystemName,
00069                                                OBJ_CASE_INSENSITIVE,
00070                                                NULL,
00071                                                NULL);
00072 
00073     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;ParentHandle,
00074                                KEY_READ,
00075                                &amp;ObjectAttributes);
00076 
00077     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00078         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;ValueName,
00079                                      L<span class="stringliteral">"SystemBiosVersion"</span>);
00080 
00081         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;AnsiString,
00082                               &amp;LoaderBlock-&gt;u.Alpha.FirmwareVersion[0]);
00083 
00084         <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;ValueData,
00085                                                  &amp;AnsiString,
00086                                                  TRUE);
00087 
00088         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(ParentHandle,
00089                                        &amp;ValueName,
00090                                        TITLE_INDEX_VALUE,
00091                                        REG_SZ,
00092                                        ValueData.Buffer,
00093                                        ValueData.Length + <span class="keyword">sizeof</span>(UNICODE_NULL));
00094 
00095         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;ValueData);
00096 
00097         <span class="comment">//</span>
00098         <span class="comment">// If the firmware build number is included in the loader block,</span>
00099         <span class="comment">// then store it in the registry.</span>
00100         <span class="comment">//</span>
00101 
00102         <span class="keywordflow">if</span> (LoaderBlock-&gt;u.Alpha.FirmwareBuildTimeStamp[0] != 0 ) {
00103             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;ValueName,
00104                                  L<span class="stringliteral">"SystemBiosDate"</span>);
00105 
00106             <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;AnsiString,
00107                               &amp;LoaderBlock-&gt;u.Alpha.FirmwareBuildTimeStamp[0]);
00108 
00109             <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;ValueData,
00110                                                          &amp;AnsiString,
00111                                                          TRUE);
00112 
00113             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(ParentHandle,
00114                                                &amp;ValueName,
00115                                                TITLE_INDEX_VALUE,
00116                                                REG_SZ,
00117                                                ValueData.Buffer,
00118                                                ValueData.Length + <span class="keyword">sizeof</span>(UNICODE_NULL));
00119 
00120             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;ValueData);
00121         }
00122     }
00123 
00124     <span class="keywordflow">return</span> STATUS_SUCCESS;
00125 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a277" doxytag="cmp.h::CmpInitializeRegistryNames" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpInitializeRegistryNames           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/cmdatini_8c-source.html#l00089">89</a> of file <a class="el" href="../../d1/d0/cmdatini_8c-source.html">cmdatini.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00052">CmClassName</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00054">CmClassString</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00198">CmpRegistryMachineHardwareDescriptionString</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00200">CmpRegistryMachineHardwareDescriptionSystemString</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00202">CmpRegistryMachineHardwareDeviceMapString</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00206">CmpRegistryMachineHardwareOwnerMapString</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00204">CmpRegistryMachineHardwareResourceMapString</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00196">CmpRegistryMachineHardwareString</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00195">CmpRegistryMachineString</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00226">CmpRegistryMachineSystemCurrentControlSetControlBootLogString</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00220">CmpRegistryMachineSystemCurrentControlSetControlClassString</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00222">CmpRegistryMachineSystemCurrentControlSetControlSafeBootString</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00224">CmpRegistryMachineSystemCurrentControlSetControlSessionManagerMemoryManagementString</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00214">CmpRegistryMachineSystemCurrentControlSetEnumRootString</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00212">CmpRegistryMachineSystemCurrentControlSetEnumString</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00218">CmpRegistryMachineSystemCurrentControlSetHardwareProfilesCurrentString</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00228">CmpRegistryMachineSystemCurrentControlSetServicesEventLogString</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00216">CmpRegistryMachineSystemCurrentControlSetServicesString</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00210">CmpRegistryMachineSystemCurrentControlSetString</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00208">CmpRegistryMachineSystemString</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00194">CmpRegistryRootString</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00231">CmpRegistrySystemCloneString</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00232">CmpRegistrySystemFileNameString</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00230">CmpRegistryUserString</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00237">CmpSymbolicLinkValueName</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00187">CmpSystemFileName</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00169">CmRegistryMachineHardwareDescriptionName</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00170">CmRegistryMachineHardwareDescriptionSystemName</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00171">CmRegistryMachineHardwareDeviceMapName</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00168">CmRegistryMachineHardwareName</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00173">CmRegistryMachineHardwareOwnerMapName</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00172">CmRegistryMachineHardwareResourceMapName</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00167">CmRegistryMachineName</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00175">CmRegistryMachineSystemCurrentControlSet</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00183">CmRegistryMachineSystemCurrentControlSetControlBootLog</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00180">CmRegistryMachineSystemCurrentControlSetControlClass</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00181">CmRegistryMachineSystemCurrentControlSetControlSafeBoot</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00182">CmRegistryMachineSystemCurrentControlSetControlSessionManagerMemoryManagement</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00177">CmRegistryMachineSystemCurrentControlSetEnumRootName</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00179">CmRegistryMachineSystemCurrentControlSetHardwareProfilesCurrent</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00178">CmRegistryMachineSystemCurrentControlSetServices</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00184">CmRegistryMachineSystemCurrentControlSetServicesEventLog</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00174">CmRegistryMachineSystemName</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00166">CmRegistryRootName</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00186">CmRegistrySystemCloneName</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00185">CmRegistryUserName</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00035">CmSymbolicLinkValueName</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00108">CmTypeName</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00338">CmTypeString</a>, <a class="el" href="../../d1/d9/arc_8h.html#a314a186">MaximumClass</a>, <a class="el" href="../../d1/d9/arc_8h.html#a315a227">MaximumType</a>, and <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>.
<p>
<pre class="fragment"><div>00095                    :
00096 
00097     This routine creates all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> strings <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> various names used
00098     in and by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry
00099 
00100 Arguments:
00101 
00102     None.
00103 
00104 Returns:
00105 
00106     None.
00107 
00108 --*/
00109 {
00110     ULONG i;
00111 
00112     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CmRegistryRootName,
00113                           CmpRegistryRootString );
00114 
00115     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CmRegistryMachineName,
00116                           CmpRegistryMachineString );
00117 
00118     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CmRegistryMachineHardwareName,
00119                           CmpRegistryMachineHardwareString );
00120 
00121     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CmRegistryMachineHardwareDescriptionName,
00122                           CmpRegistryMachineHardwareDescriptionString );
00123 
00124     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CmRegistryMachineHardwareDescriptionSystemName,
00125                           CmpRegistryMachineHardwareDescriptionSystemString );
00126 
00127     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CmRegistryMachineHardwareDeviceMapName,
00128                           CmpRegistryMachineHardwareDeviceMapString );
00129 
00130     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CmRegistryMachineHardwareResourceMapName,
00131                           CmpRegistryMachineHardwareResourceMapString );
00132 
00133     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CmRegistryMachineHardwareOwnerMapName,
00134                           CmpRegistryMachineHardwareOwnerMapString );
00135 
00136     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CmRegistryMachineSystemName,
00137                           CmpRegistryMachineSystemString );
00138 
00139     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CmRegistryMachineSystemCurrentControlSet,
00140                           CmpRegistryMachineSystemCurrentControlSetString);
00141 
00142     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CmRegistryUserName,
00143                           CmpRegistryUserString );
00144 
00145     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CmRegistrySystemCloneName,
00146                           CmpRegistrySystemCloneString );
00147 
00148     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CmpSystemFileName,
00149                           CmpRegistrySystemFileNameString );
00150 
00151     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
00152                           CmpRegistryMachineSystemCurrentControlSetEnumString);
00153 
00154     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CmRegistryMachineSystemCurrentControlSetEnumRootName,
00155                           CmpRegistryMachineSystemCurrentControlSetEnumRootString);
00156 
00157     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CmRegistryMachineSystemCurrentControlSetServices,
00158                           CmpRegistryMachineSystemCurrentControlSetServicesString);
00159 
00160     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CmRegistryMachineSystemCurrentControlSetHardwareProfilesCurrent,
00161                           CmpRegistryMachineSystemCurrentControlSetHardwareProfilesCurrentString);
00162 
00163     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CmRegistryMachineSystemCurrentControlSetControlClass,
00164                           CmpRegistryMachineSystemCurrentControlSetControlClassString);
00165 
00166     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CmRegistryMachineSystemCurrentControlSetControlSafeBoot,
00167                           CmpRegistryMachineSystemCurrentControlSetControlSafeBootString);
00168 
00169     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CmRegistryMachineSystemCurrentControlSetControlSessionManagerMemoryManagement,
00170                           CmpRegistryMachineSystemCurrentControlSetControlSessionManagerMemoryManagementString);
00171 
00172     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CmRegistryMachineSystemCurrentControlSetControlBootLog,
00173                           CmpRegistryMachineSystemCurrentControlSetControlBootLogString);
00174 
00175     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CmRegistryMachineSystemCurrentControlSetServicesEventLog,
00176                           CmpRegistryMachineSystemCurrentControlSetServicesEventLogString);
00177 
00178     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CmSymbolicLinkValueName,
00179                           CmpSymbolicLinkValueName);
00180 
00181 <span class="preprocessor">#ifdef _WANT_MACHINE_IDENTIFICATION</span>
00182 <span class="preprocessor"></span>    <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CmRegistryMachineSystemCurrentControlSetControlBiosInfo,
00183                           CmpRegistryMachineSystemCurrentControlSetControlBiosInfoString);
00184 <span class="preprocessor">#endif</span>
00185 <span class="preprocessor"></span>
00186     <span class="comment">//</span>
00187     <span class="comment">// Initialize the type names for the hardware tree.</span>
00188     <span class="comment">//</span>
00189 
00190     <span class="keywordflow">for</span> (i = 0; i &lt;= <a class="code" href="../../d1/d9/arc_8h.html#a315a227">MaximumType</a>; i++) {
00191 
00192         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;(CmTypeName[i]),
00193                               CmTypeString[i] );
00194 
00195     }
00196 
00197     <span class="comment">//</span>
00198     <span class="comment">// Initialize the class names for the hardware tree.</span>
00199     <span class="comment">//</span>
00200 
00201     <span class="keywordflow">for</span> (i = 0; i &lt;= <a class="code" href="../../d1/d9/arc_8h.html#a314a186">MaximumClass</a>; i++) {
00202 
00203         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;(CmClassName[i]),
00204                               CmClassString[i] );
00205 
00206     }
00207 
00208     <span class="keywordflow">return</span>;
00209 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a274" doxytag="cmp.h::CmpInitializeRegistryNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpInitializeRegistryNode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d8/struct__CONFIGURATION__COMPONENT__DATA.html">PCONFIGURATION_COMPONENT_DATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentEntry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ParentHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>NewHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN INTERFACE_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>InterfaceType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BusNumber</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a22">PUSHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceIndexTable</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00458">458</a> of file <a class="el" href="../../d5/d9/cmconfig_8c-source.html">cmconfig.c</a>.
<p>
References <a class="el" href="../../d1/d9/arc_8h.html#a315a187">ArcSystem</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d3/d6/hal_8h-source.html#l01170">BusNumber</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l00279">_CONFIGURATION_COMPONENT::Class</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00052">CmClassName</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00064">CmpConfigurationAreaSize</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00065">CmpConfigurationData</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00108">CmTypeName</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l00286">_CONFIGURATION_COMPONENT::ConfigurationDataLength</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l00281">_CONFIGURATION_COMPONENT::Flags</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l00288">_CONFIGURATION_COMPONENT::Identifier</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l00287">_CONFIGURATION_COMPONENT::IdentifierLength</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00050">InterfaceType</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00102">RtlInitAnsiString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d0/d3/cnvint_8c-source.html#l00040">RtlIntegerToChar()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d1/d9/arc_8h.html#a314a179">SystemClass</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l00280">_CONFIGURATION_COMPONENT::Type</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00465">CmpInitializeMachineDependentConfiguration()</a>, and <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00294">CmpSetupConfigurationTree()</a>.
<p>
<pre class="fragment"><div>00469                    :
00470 
00471     This routine creates a node <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current firmware component
00472     and puts component data to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> node.
00473 
00474 Arguments:
00475 
00476     CurrentEntry - Supplies a pointer to a configuration component.
00477 
00478     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent handle of CurrentEntry node.
00479 
00480     NewHandle - Suppiles a pointer to a HANDLE to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle of
00481         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly created node.
00482 
00483     <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> - Specify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Interface <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bus that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00484         CurrentEntry component resides. (See <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> also)
00485 
00486     <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> - Specify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Bus Number of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bus that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CurrentEntry
00487         component resides on.  If Bus number <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> -1, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> means <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>
00488         and <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> are meaningless <span class="keywordflow">for</span> <span class="keyword">this</span> component.
00489 
00490 Returns:
00491 
00492     None.
00493 
00494 --*/
00495 {
00496 
00497     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00498     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00499     UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
00500     UNICODE_STRING <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
00501     UNICODE_STRING ValueData;
00502     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00503     HANDLE OldHandle;
00504     ANSI_STRING AnsiString;
00505     UCHAR <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[12];
00506     WCHAR UnicodeBuffer[12];
00507     <a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html">CONFIGURATION_COMPONENT</a> *Component;
00508     ULONG Disposition;
00509     ULONG ConfigurationDataLength;
00510     PCM_FULL_RESOURCE_DESCRIPTOR NewArea;
00511 
00512     Component = &amp;CurrentEntry-&gt;ComponentEntry;
00513 
00514     <span class="comment">//</span>
00515     <span class="comment">// If the component class is SystemClass, we set its Type to be</span>
00516     <span class="comment">// ArcSystem.  The reason is because the detection code sets</span>
00517     <span class="comment">// its type to MaximumType to indicate it is NOT ARC compatible.</span>
00518     <span class="comment">// Here, we are only interested in building a System Node.  So we</span>
00519     <span class="comment">// change its Type to ArcSystem to ease the setup.</span>
00520     <span class="comment">//</span>
00521 
00522     <span class="keywordflow">if</span> (Component-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o0">Class</a> == <a class="code" href="../../d1/d9/arc_8h.html#a314a179">SystemClass</a>) {
00523         Component-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o1">Type</a> = <a class="code" href="../../d1/d9/arc_8h.html#a315a187">ArcSystem</a>;
00524     }
00525 
00526     <span class="comment">//</span>
00527     <span class="comment">// Create a new key to describe the Component.</span>
00528     <span class="comment">//</span>
00529     <span class="comment">// The type of the component will be used as the keyname of the</span>
00530     <span class="comment">// registry node.  The class is the class of the component.</span>
00531     <span class="comment">//</span>
00532 
00533     InitializeObjectAttributes(
00534         &amp;ObjectAttributes,
00535         &amp;(CmTypeName[Component-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o1">Type</a>]),
00536         0,
00537         ParentHandle,
00538         NULL
00539         );
00540     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.Attributes |= OBJ_CASE_INSENSITIVE;
00541 
00542     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(                   <span class="comment">// Paht may already exist</span>
00543                 &amp;Handle,
00544                 KEY_READ | KEY_WRITE,
00545                 &amp;ObjectAttributes,
00546                 TITLE_INDEX_VALUE,
00547                 &amp;(CmClassName[Component-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o0">Class</a>]),
00548                 0,
00549                 &amp;Disposition
00550                 );
00551 
00552     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00553         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00554     }
00555 
00556     <span class="comment">//</span>
00557     <span class="comment">// If this component is NOT a SystemClass component, we will</span>
00558     <span class="comment">// create a subkey to identify the component's ordering.</span>
00559     <span class="comment">//</span>
00560 
00561     <span class="keywordflow">if</span> (Component-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o0">Class</a> != <a class="code" href="../../d1/d9/arc_8h.html#a314a179">SystemClass</a>) {
00562 
00563         <a class="code" href="../../d9/d3/cnvint_8c.html#a2">RtlIntegerToChar</a>(
00564             DeviceIndexTable[Component-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o1">Type</a>]++,
00565             10,
00566             12,
00567             Buffer
00568             );
00569 
00570         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(
00571             &amp;AnsiString,
00572             Buffer
00573             );
00574 
00575         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer = (PWSTR)UnicodeBuffer;
00576         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length = 0;
00577         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.MaximumLength = <span class="keyword">sizeof</span>(UnicodeBuffer);
00578 
00579         <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
00580             &amp;KeyName,
00581             &amp;AnsiString,
00582             FALSE
00583             );
00584 
00585         OldHandle = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00586 
00587         InitializeObjectAttributes(
00588             &amp;ObjectAttributes,
00589             &amp;KeyName,
00590             0,
00591             OldHandle,
00592             NULL
00593             );
00594         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.Attributes |= OBJ_CASE_INSENSITIVE;
00595 
00596         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(
00597                     &amp;Handle,
00598                     KEY_READ | KEY_WRITE,
00599                     &amp;ObjectAttributes,
00600                     TITLE_INDEX_VALUE,
00601                     &amp;(CmClassName[Component-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o0">Class</a>]),
00602                     0,
00603                     &amp;Disposition
00604                     );
00605 
00606         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(OldHandle);
00607 
00608         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00609             <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00610         }
00611 
00612         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Disposition == REG_CREATED_NEW_KEY);
00613     }
00614 
00615     <span class="comment">//</span>
00616     <span class="comment">// Create a value which describes the following component information:</span>
00617     <span class="comment">//     Flags, Cersion, Key, AffinityMask.</span>
00618     <span class="comment">//</span>
00619 
00620     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00621         &amp;ValueName,
00622         L<span class="stringliteral">"Component Information"</span>
00623         );
00624 
00625     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00626                 Handle,
00627                 &amp;ValueName,
00628                 TITLE_INDEX_VALUE,
00629                 REG_BINARY,
00630                 &amp;Component-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o2">Flags</a>,
00631                 FIELD_OFFSET(<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html">CONFIGURATION_COMPONENT</a>, ConfigurationDataLength) -
00632                     FIELD_OFFSET(<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html">CONFIGURATION_COMPONENT</a>, Flags)
00633                 );
00634 
00635     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00636         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Handle);
00637         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00638     }
00639 
00640     <span class="comment">//</span>
00641     <span class="comment">// Create a value which describes the component identifier, if any.</span>
00642     <span class="comment">//</span>
00643 
00644     <span class="keywordflow">if</span> (Component-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o8">IdentifierLength</a>) {
00645 
00646         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00647             &amp;ValueName,
00648             L<span class="stringliteral">"Identifier"</span>
00649             );
00650 
00651         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(
00652             &amp;AnsiString,
00653             Component-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o9">Identifier</a>
00654             );
00655 
00656         <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
00657             &amp;ValueData,
00658             &amp;AnsiString,
00659             TRUE
00660             );
00661 
00662         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00663                     Handle,
00664                     &amp;ValueName,
00665                     TITLE_INDEX_VALUE,
00666                     REG_SZ,
00667                     ValueData.Buffer,
00668                     ValueData.Length + <span class="keyword">sizeof</span>( UNICODE_NULL )
00669                     );
00670 
00671         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;ValueData);
00672 
00673         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00674             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Handle);
00675             <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00676         }
00677     }
00678 
00679     <span class="comment">//</span>
00680     <span class="comment">// Create a value entry for component configuration data.</span>
00681     <span class="comment">//</span>
00682 
00683     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00684         &amp;ValueName,
00685         L<span class="stringliteral">"Configuration Data"</span>
00686         );
00687 
00688     <span class="comment">//</span>
00689     <span class="comment">// Create the configuration data based on CM_FULL_RESOURCE_DESCRIPTOR.</span>
00690     <span class="comment">//</span>
00691     <span class="comment">// Note the configuration data in firmware tree may be in the form of</span>
00692     <span class="comment">// CM_PARTIAL_RESOURCE_LIST or nothing.  In both cases, we need to</span>
00693     <span class="comment">// set up the registry configuration data to be in the form of</span>
00694     <span class="comment">// CM_FULL_RESOURCE_DESCRIPTOR.</span>
00695     <span class="comment">//</span>
00696 
00697     <span class="keywordflow">if</span> (CurrentEntry-&gt;ConfigurationData) {
00698 
00699         <span class="comment">//</span>
00700         <span class="comment">// This component has configuration data, we copy the data</span>
00701         <span class="comment">// to our work area, add some more data items and copy the new</span>
00702         <span class="comment">// configuration data to the registry.</span>
00703         <span class="comment">//</span>
00704 
00705         ConfigurationDataLength = Component-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o7">ConfigurationDataLength</a> +
00706                       FIELD_OFFSET(CM_FULL_RESOURCE_DESCRIPTOR,
00707                       PartialResourceList);
00708 
00709         <span class="comment">//</span>
00710         <span class="comment">// Make sure our reserved area is big enough to hold the data.</span>
00711         <span class="comment">//</span>
00712 
00713         <span class="keywordflow">if</span> (ConfigurationDataLength &gt; <a class="code" href="../../d4/d0/cmconfig_8c.html#a9">CmpConfigurationAreaSize</a>) {
00714 
00715             <span class="comment">//</span>
00716             <span class="comment">// If reserved area is not big enough, we resize our reserved</span>
00717             <span class="comment">// area.  If, unfortunately, the reallocation fails, we simply</span>
00718             <span class="comment">// loss the configuration data of this particular component.</span>
00719             <span class="comment">//</span>
00720 
00721             NewArea = (PCM_FULL_RESOURCE_DESCRIPTOR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
00722                                             PagedPool,
00723                                             ConfigurationDataLength
00724                                             );
00725 
00726             <span class="keywordflow">if</span> (NewArea) {
00727                 <a class="code" href="../../d4/d0/cmconfig_8c.html#a9">CmpConfigurationAreaSize</a> = ConfigurationDataLength;
00728                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(CmpConfigurationData);
00729                 <a class="code" href="../../d4/d0/cmconfig_8c.html#a10">CmpConfigurationData</a> = NewArea;
00730                 RtlMoveMemory(
00731                     (PUCHAR)&amp;<a class="code" href="../../d4/d0/cmconfig_8c.html#a10">CmpConfigurationData</a>-&gt;PartialResourceList.Version,
00732                     CurrentEntry-&gt;ConfigurationData,
00733                     Component-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o7">ConfigurationDataLength</a>
00734                     );
00735             } <span class="keywordflow">else</span> {
00736                 Component-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o7">ConfigurationDataLength</a> = 0;
00737                 CurrentEntry-&gt;ConfigurationData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00738             }
00739         } <span class="keywordflow">else</span> {
00740             RtlMoveMemory(
00741                 (PUCHAR)&amp;<a class="code" href="../../d4/d0/cmconfig_8c.html#a10">CmpConfigurationData</a>-&gt;PartialResourceList.Version,
00742                 CurrentEntry-&gt;ConfigurationData,
00743                 Component-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o7">ConfigurationDataLength</a>
00744                 );
00745         }
00746 
00747     }
00748 
00749     <span class="keywordflow">if</span> (CurrentEntry-&gt;ConfigurationData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00750 
00751         <span class="comment">//</span>
00752         <span class="comment">// This component has NO configuration data (or we can't resize</span>
00753         <span class="comment">// our reserved area to hold the data), we simple add whatever</span>
00754         <span class="comment">// is required to set up a CM_FULL_RESOURCE_LIST.</span>
00755         <span class="comment">//</span>
00756 
00757         <a class="code" href="../../d4/d0/cmconfig_8c.html#a10">CmpConfigurationData</a>-&gt;PartialResourceList.Version = 0;
00758         <a class="code" href="../../d4/d0/cmconfig_8c.html#a10">CmpConfigurationData</a>-&gt;PartialResourceList.Revision = 0;
00759         <a class="code" href="../../d4/d0/cmconfig_8c.html#a10">CmpConfigurationData</a>-&gt;PartialResourceList.Count = 0;
00760         ConfigurationDataLength = FIELD_OFFSET(CM_FULL_RESOURCE_DESCRIPTOR,
00761                                                PartialResourceList) +
00762                                   FIELD_OFFSET(CM_PARTIAL_RESOURCE_LIST,
00763                                                PartialDescriptors);
00764     }
00765 
00766     <span class="comment">//</span>
00767     <span class="comment">// Set up InterfaceType and BusNumber for the component.</span>
00768     <span class="comment">//</span>
00769 
00770     <a class="code" href="../../d4/d0/cmconfig_8c.html#a10">CmpConfigurationData</a>-&gt;InterfaceType = <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>;
00771     <a class="code" href="../../d4/d0/cmconfig_8c.html#a10">CmpConfigurationData</a>-&gt;BusNumber = <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>;
00772 
00773     <span class="comment">//</span>
00774     <span class="comment">// Write the newly constructed configuration data to the hardware registry</span>
00775     <span class="comment">//</span>
00776 
00777     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00778                 Handle,
00779                 &amp;ValueName,
00780                 TITLE_INDEX_VALUE,
00781                 REG_FULL_RESOURCE_DESCRIPTOR,
00782                 CmpConfigurationData,
00783                 ConfigurationDataLength
00784                 );
00785 
00786     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00787         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Handle);
00788         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00789     }
00790 
00791     *NewHandle = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00792     <span class="keywordflow">return</span>(STATUS_SUCCESS);
00793 
00794 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a334" doxytag="cmp.h::CmpInitializeValueNameString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpInitializeValueNameString           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>NameBuffer</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01582">1582</a> of file <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html">cmtrecpy.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00121">CmpCompressedNameSize()</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00151">CmpCopyCompressedName()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00036">MAX_KEY_VALUE_NAME_LENGTH</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00491">VALUE_COMP_NAME</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01150">CmpMergeKeyValues()</a>.
<p>
<pre class="fragment"><div>01587                    :
01588 
01589    Initializes a UNICODE_STRING with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of a given value key.
01590    
01591    N.B. The initialized string's buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not meant
01592          to be modified.   
01593 
01594 Arguments:
01595 
01596    <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>       - The value key in question
01597    <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>    - The UNICODE_STRING to initialize
01598    NameBuffer - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> buffer <a class="code" href="../../d9/d0/cmdata_8h.html#a1">MAX_KEY_NAME_LENGTH</a> bytes in size 
01599                 that will possibly be used as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> UNICODE_STRING's 
01600                 buffer.
01601 
01602 Return Value:
01603 
01604    NONE.
01605 */
01606 
01607 {                        
01608    <span class="comment">// is the name stored in compressed form?</span>
01609 
01610    <span class="keywordflow">if</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Flags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a37">VALUE_COMP_NAME</a>) {
01611 
01612       <span class="comment">// Name is compressed. </span>
01613 
01614       <span class="comment">// Get the uncompressed length.</span>
01615                         
01616       <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>-&gt;Length = <a class="code" href="../../d1/d2/cmp_8h.html#a320">CmpCompressedNameSize</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Name,
01617                                               <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;NameLength);
01618                         
01619       <span class="comment">// Decompress the name into a buffer.</span>
01620 
01621       <a class="code" href="../../d1/d2/cmp_8h.html#a318">CmpCopyCompressedName</a>(NameBuffer, 
01622                             MAX_KEY_VALUE_NAME_LENGTH,
01623                             <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Name,                                            
01624                             <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;NameLength);
01625 
01626       <span class="comment">//</span>
01627       <span class="comment">// Use the decompression buffer as the string buffer</span>
01628       <span class="comment">//</span>
01629                         
01630       <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>-&gt;Buffer = NameBuffer;      
01631       <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>-&gt;MaximumLength = <a class="code" href="../../d9/d0/cmdata_8h.html#a3">MAX_KEY_VALUE_NAME_LENGTH</a>;
01632 
01633    } <span class="keywordflow">else</span> {
01634 
01635       <span class="comment">//</span>
01636       <span class="comment">// Name is not compressed. Just use the name string </span>
01637       <span class="comment">// from the ValueName buffer as the string buffer.</span>
01638       <span class="comment">//</span>
01639                         
01640       <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>-&gt;Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;NameLength;                        
01641       <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>-&gt;Buffer = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Name;
01642       <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>-&gt;MaximumLength = <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>-&gt;Length;
01643                      
01644    }                                             
01645 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a257" doxytag="cmp.h::CmpIsLastKnownGoodBoot" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpIsLastKnownGoodBoot           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03863">3863</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00256">CMS_INIT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d6/rtl_2regutil_8c-source.html#l00744">RtlQueryRegistryValues()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03778">CmBootLastKnownGood()</a>.
<p>
<pre class="fragment"><div>03869                    :
03870 
03871     Determines whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current system boot <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a LastKnownGood boot or
03872     not.  It does <span class="keyword">this</span> by comparing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following two values:
03873 
03874         \registry\machine\system\select:Current
03875         \registry\machine\system\select:LastKnownGood
03876 
03877     If both of these values refer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> set, and <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a>
03878     set <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> different from:
03879 
03880         \registry\machine\system\select:Default
03881 
03882     we are booting LastKnownGood.
03883 
03884 Arguments:
03885 
03886     None.
03887 
03888 Return Value:
03889 
03890     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>  - Booting LastKnownGood
03891     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - Not booting LastKnownGood
03892 
03893 --*/
03894 
03895 {
03896     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03897     ULONG Default;
03898     ULONG Current;
03899     ULONG LKG;
03900     RTL_QUERY_REGISTRY_TABLE QueryTable[] = {
03901         {<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,      RTL_QUERY_REGISTRY_DIRECT,
03902          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Current"</span>, &amp;Current,
03903          REG_DWORD, (PVOID)&amp;Current, 0 },
03904         {<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,      RTL_QUERY_REGISTRY_DIRECT,
03905          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"LastKnownGood"</span>, &amp;LKG,
03906          REG_DWORD, (PVOID)&amp;LKG, 0 },
03907         {<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,      RTL_QUERY_REGISTRY_DIRECT,
03908          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Default"</span>, &amp;Default,
03909          REG_DWORD, (PVOID)&amp;Default, 0 },
03910         {<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,      0,
03911          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03912          REG_NONE, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0 }
03913     };
03914 
03915     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03916 
03917     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a19">RtlQueryRegistryValues</a>(RTL_REGISTRY_ABSOLUTE,
03918                                     L<span class="stringliteral">"\\Registry\\Machine\\System\\Select"</span>,
03919                                     QueryTable,
03920                                     NULL,
03921                                     NULL);
03922     <span class="comment">//</span>
03923     <span class="comment">// If this failed, something is severely wrong.</span>
03924     <span class="comment">//</span>
03925 
03926     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
03927     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03928         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INIT) {
03929             KdPrint((<span class="stringliteral">"CmpIsLastKnownGoodBoot: RtlQueryRegistryValues "</span>));
03930             KdPrint((<span class="stringliteral">"failed, Status %08lx\n"</span>, Status));
03931         }
03932         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03933     }
03934 
03935     <span class="keywordflow">if</span> ((LKG == Current) &amp;&amp; (Current != Default)){
03936         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03937     } <span class="keywordflow">else</span> {
03938         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03939     }
03940 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a244" doxytag="cmp.h::CmpLazyFlush" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpLazyFlush           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00368">368</a> of file <a class="el" href="../../d6/d2/cmworker_8c-source.html">cmworker.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00726">CmpInitializeHiveList()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00461">CmpLazyFlushWorker()</a>, and <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00270">HvMarkDirty()</a>.
<p>
<pre class="fragment"><div>00374                    :
00375 
00376     This routine resets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry timer to go off at a specified interval
00377     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> future (LAZY_FLUSH_INTERVAL_IN_SECONDS).
00378 
00379 Arguments:
00380 
00381     None
00382 
00383 Return Value:
00384 
00385     None.
00386 
00387 --*/
00388 
00389 {
00390     LARGE_INTEGER DueTime;
00391 
00392     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00393     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_IO) {
00394         KdPrint((<span class="stringliteral">"CmpLazyFlush: setting lazy flush timer\n"</span>));
00395     }
00396     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d9/cmapi_8c.html#a0">CmpNoWrite</a>) {
00397 
00398         DueTime.QuadPart = Int32x32To64(LAZY_FLUSH_INTERVAL_IN_SECONDS,
00399                                         - SECOND_MULT);
00400 
00401         <span class="comment">//</span>
00402         <span class="comment">// Indicate relative time</span>
00403         <span class="comment">//</span>
00404 
00405         <a class="code" href="../../d3/d2/timerobj_8c.html#a6">KeSetTimer</a>(&amp;CmpLazyFlushTimer,
00406                    DueTime,
00407                    &amp;CmpLazyFlushDpc);
00408 
00409     }
00410 
00411 
00412 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a291" doxytag="cmp.h::CmpLinkHiveToMaster" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpLinkHiveToMaster           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>LinkName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>RootDirectory</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CmHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Allocate</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01421">1421</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01901">CmLoadKey()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00726">CmpInitializeHiveList()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02022">CmpInitializeSystemHive()</a>, and <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00484">CmpLoadHiveVolatile()</a>.
<p>
<pre class="fragment"><div>01430                    :
01431 
01432     The existing, <span class="stringliteral">"free floating"</span> hive CmHive describes <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> linked into
01433     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name space at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> node named by LinkName.  The node will be created.
01434     The hive <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to already have an appropriate root node.
01435 
01436 Arguments:
01437 
01438     LinkName - supplies a pointer to a unicode string which describes where
01439                 in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry name space <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be linked.
01440                 All components but <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last must exist.  The last must not.
01441 
01442     RootDirectory - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LinkName <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> relative to.
01443 
01444     CmHive - pointer to a <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a> structure describing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive to link in.
01445 
01446     Allocate - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root cell <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be created
01447                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root cell already exists.
01448 
01449     SecurityDescriptor - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor to
01450                be placed on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive root.
01451 
01452 Return Value:
01453 
01454     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> == success, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> == <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>
01455 
01456 --*/
01457 {
01458     OBJECT_ATTRIBUTES   <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
01459     HANDLE              KeyHandle;
01460     <a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">CM_PARSE_CONTEXT</a>    ParseContext;
01461     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01462     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>        KeyBody;
01463 
01464     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01465     <span class="comment">//</span>
01466     <span class="comment">// Fill in special ParseContext to indicate that we are creating</span>
01467     <span class="comment">// a link node and opening or creating a root node.</span>
01468     <span class="comment">//</span>
01469     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o0">TitleIndex</a> = 0;
01470     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o1">Class</a>.Length = 0;
01471     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o1">Class</a>.MaximumLength = 0;
01472     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o1">Class</a>.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01473     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o2">CreateOptions</a> = 0;
01474     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o4">CreateLink</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01475     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o5">ChildHive</a>.<a class="code" href="../../d5/d5/struct__CM__KEY__REFERENCE.html#o1">KeyHive</a> = &amp;CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>;
01476     <span class="keywordflow">if</span> (Allocate) {
01477 
01478         <span class="comment">//</span>
01479         <span class="comment">// Creating a new root node</span>
01480         <span class="comment">//</span>
01481 
01482         ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o5">ChildHive</a>.<a class="code" href="../../d5/d5/struct__CM__KEY__REFERENCE.html#o0">KeyCell</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01483     } <span class="keywordflow">else</span> {
01484 
01485         <span class="comment">//</span>
01486         <span class="comment">// Opening an existing root node</span>
01487         <span class="comment">//</span>
01488 
01489         ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o5">ChildHive</a>.<a class="code" href="../../d5/d5/struct__CM__KEY__REFERENCE.html#o0">KeyCell</a> = CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a>;
01490     }
01491 
01492     <span class="comment">//</span>
01493     <span class="comment">// Create a path to the hive</span>
01494     <span class="comment">//</span>
01495     InitializeObjectAttributes(
01496         &amp;ObjectAttributes,
01497         LinkName,
01498         OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE,
01499         (HANDLE)RootDirectory,
01500         SecurityDescriptor
01501         );
01502 
01503     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>( &amp;ObjectAttributes,
01504                                  CmpKeyObjectType,
01505                                  KernelMode,
01506                                  NULL,
01507                                  KEY_READ | KEY_WRITE,
01508                                  (PVOID)&amp;ParseContext,
01509                                  &amp;KeyHandle );
01510 
01511     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01512         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INIT_ERROR) {
01513             KdPrint((<span class="stringliteral">"CmpLinkHiveToMaster: "</span>));
01514             KdPrint((<span class="stringliteral">"ObOpenObjectByName() failed %08lx\n"</span>, Status));
01515             KdPrint((<span class="stringliteral">"\tLinkName='%ws'\n"</span>, LinkName));
01516         }
01517         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01518     }
01519 
01520     <span class="comment">//</span>
01521     <span class="comment">// Report the notification event</span>
01522     <span class="comment">//</span>
01523     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(KeyHandle,
01524                                        0,
01525                                        CmpKeyObjectType,
01526                                        KernelMode,
01527                                        (PVOID *)&amp;KeyBody,
01528                                        NULL);
01529     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
01530     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01531         <a class="code" href="../../d6/d3/cmwraper_8c.html#a13">CmpReportNotify</a>(KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>,
01532                         KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a>,
01533                         KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o6">KeyCell</a>,
01534                         REG_NOTIFY_CHANGE_NAME);
01535 
01536         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
01537     }
01538 
01539     ZwClose(KeyHandle);
01540     <span class="keywordflow">return</span> STATUS_SUCCESS;
01541 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a256" doxytag="cmp.h::CmpLockRegistry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpLockRegistry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00044">44</a> of file <a class="el" href="../../d1/d2/cmsubs3_8c-source.html">cmsubs3.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00285">CmEnumerateKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00416">CmEnumerateValueKey()</a>, <a class="el" href="../../d4/d9/cmclose_8c-source.html#l00028">CmpCloseKeyObject()</a>, <a class="el" href="../../d2/d0/cmdelete_8c-source.html#l00031">CmpDeleteKeyObject()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00461">CmpLazyFlushWorker()</a>, <a class="el" href="../../d6/d1/cmquery_8c-source.html#l00028">CmpQueryKeyName()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00158">CmpSecurityMethod()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00647">CmQueryKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00940">CmQueryMultipleValueKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00804">CmQueryValueKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01087">CmSetValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00904">NtFlushKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>.
<p>
<pre class="fragment"><div>00049                    :
00050 
00051     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry <span class="keywordflow">for</span> shared (read-only) access
00052 
00053 Arguments:
00054 
00055     None.
00056 
00057 Return Value:
00058 
00059     None, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry lock will be held <span class="keywordflow">for</span> shared access upon <span class="keywordflow">return</span>.
00060 
00061 --*/
00062 {
00063 <span class="preprocessor">    #if DBG</span>
00064 <span class="preprocessor"></span>    PVOID       Caller;
00065     PVOID       CallerCaller;
00066 <span class="preprocessor">    #endif</span>
00067 <span class="preprocessor"></span>
00068     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00069     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;CmpRegistryLock, TRUE);
00070 
00071 <span class="preprocessor">    #if DBG</span>
00072 <span class="preprocessor"></span>    <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;Caller, &amp;CallerCaller);
00073     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_LOCKING) {
00074         KdPrint((<span class="stringliteral">"CmpLockRegistry: c, cc: %08lx  %08lx\n"</span>, Caller, CallerCaller));
00075     }
00076 <span class="preprocessor">    #endif</span>
00077 <span class="preprocessor"></span>
00078 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a255" doxytag="cmp.h::CmpLockRegistryExclusive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpLockRegistryExclusive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">81</a> of file <a class="el" href="../../d1/d2/cmsubs3_8c-source.html">cmsubs3.c</a>.
<p>
References <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00040">CmpCaller</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00041">CmpCallerCaller</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01174">CmpRegistryLock</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d6/d1/ppc_2getcalr_8c-source.html#l00038">RtlGetCallersAddress()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/cmapi2_8c-source.html#l00031">CmDeleteKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00092">CmDeleteValueKey()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02169">CmGetSystemDriverList()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01028">CmNotifyRunDown()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03262">CmpCloneControlSet()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01869">CmpCloneHwProfile()</a>, <a class="el" href="../../d9/d2/cmwrapr2_8c-source.html#l00045">CmpFileSetSize()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02422">CmpInitHiveFromFile()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00484">CmpLoadHiveVolatile()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00731">CmpRefreshHive()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03458">CmpSaveBootControlSet()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01261">CmpSaveKeyByFileCopy()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00158">CmpSecurityMethod()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02293">CmReplaceKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00097">CmRestoreKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00862">CmSaveKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01047">CmSaveMergedKeys()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01841">CmSetLastWriteTimeKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01087">CmSetValueKey()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03944">CmShutdownSystem()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02079">CmUnloadKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00997">NtInitializeRegistry()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l04090">NtQueryOpenSubKeys()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03093">NtUnloadKey()</a>.
<p>
<pre class="fragment"><div>00086                    :
00087 
00088     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry <span class="keywordflow">for</span> exclusive (write) access.
00089 
00090 Arguments:
00091 
00092     CanWait - Supplies whether or not the call should wait
00093               for the resource or return immediately.
00094 
00095               If CanWait is TRUE, this will always return
00096               TRUE.
00097 
00098 Return Value:
00099 
00100     TRUE - Lock was acquired exclusively
00101 
00102     FALSE - Lock is owned by another thread.
00103 
00104 --*/
00105 {
00106     BOOLEAN <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00107 
00108 
00109     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00110     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;CmpRegistryLock,TRUE);
00111 
00112     <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;CmpCaller, &amp;CmpCallerCaller);
00113 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a306" doxytag="cmp.h::CmpMarkIndexDirty" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpMarkIndexDirty           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ParentKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetKey</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01608">1608</a> of file <a class="el" href="../../d8/d0/cmindex_8c-source.html">cmindex.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00597">_HHIVE::Allocate</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00373">CM_KEY_FAST_LEAF</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00372">CM_KEY_INDEX_LEAF</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00371">CM_KEY_INDEX_ROOT</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00121">CmpCompressedNameSize()</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00151">CmpCopyCompressedName()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00475">CmpFindSubKeyInLeaf()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00266">CmpFindSubKeyInRoot()</a>, <a class="el" href="../../d2/d9/tdisp_8c-source.html#l00009">ErrorExit()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00598">_HHIVE::Free</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l01453">HvIsCellAllocated()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">HvMarkCellDirty()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00440">KEY_COMP_NAME</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00477">_CM_KEY_NODE::Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00475">_CM_KEY_NODE::NameLength</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00629">_HHIVE::StorageTypeCount</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00454">_CM_KEY_NODE::SubKeyCounts</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00457">_CM_KEY_NODE::SubKeyLists</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00470">_CM_KEY_NODE::WorkVar</a>.
<p>
Referenced by <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00245">CmpMarkKeyDirty()</a>, and <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01870">CmpMarkKeyParentDirty()</a>.
<p>
<pre class="fragment"><div>01615                    :
01616 
01617     Mark as dirty relevent cells of a subkey index.  The Leaf that
01618     points to TargetKey, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Root index block, <span class="keywordflow">if</span> applicable,
01619     will be marked dirty.  This call assumes we are setting up
01620     <span class="keywordflow">for</span> a subkey <span class="keyword">delete</span>.
01621 
01622 Arguments:
01623 
01624     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> hive of interest
01625 
01626     ParentKey - key from whose subkey list <span class="keyword">delete</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be performed
01627 
01628     TargetKey - key being deleted
01629 
01630 Return Value:
01631 
01632     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> didn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>, some resource problem
01633 
01634 --*/
01635 {
01636     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>    pcell;
01637     ULONG           i;
01638     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     IndexCell;
01639     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01640     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     Child = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01641     UNICODE_STRING  SearchName;
01642     BOOLEAN         IsCompressed;
01643 
01644     pcell = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, TargetKey);
01645     <span class="keywordflow">if</span> (pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>) {
01646         IsCompressed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01647         SearchName.Length = <a class="code" href="../../d1/d2/cmp_8h.html#a320">CmpCompressedNameSize</a>(pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>, pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
01648         SearchName.MaximumLength = SearchName.Length;
01649         SearchName.Buffer = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(SearchName.Length, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01650         <span class="keywordflow">if</span> (SearchName.Buffer==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01651             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01652         }
01653         <a class="code" href="../../d1/d2/cmp_8h.html#a318">CmpCopyCompressedName</a>(SearchName.Buffer,
01654                               SearchName.MaximumLength,
01655                               pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,
01656                               pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
01657     } <span class="keywordflow">else</span> {
01658         IsCompressed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01659         SearchName.Length = pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
01660         SearchName.MaximumLength = pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
01661         SearchName.Buffer = &amp;(pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>[0]);
01662     }
01663 
01664     pcell = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ParentKey);
01665 
01666     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o20">StorageTypeCount</a>; i++) {
01667         <span class="keywordflow">if</span> (pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[i] != 0) {
01668             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d0/hivecell_8c.html#a21">HvIsCellAllocated</a>(Hive, pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[i]));
01669             IndexCell = pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[i];
01670             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, IndexCell);
01671 
01672             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == <a class="code" href="../../d9/d0/cmdata_8h.html#a18">CM_KEY_INDEX_ROOT</a>) {
01673 
01674                 <span class="comment">//</span>
01675                 <span class="comment">// target even in index?</span>
01676                 <span class="comment">//</span>
01677                 <a class="code" href="../../d7/d1/cmindex_8c.html#a2">CmpFindSubKeyInRoot</a>(Hive, Index, &amp;SearchName, &amp;Child);
01678                 <span class="keywordflow">if</span> (Child == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01679                     <span class="keywordflow">continue</span>;
01680                 }
01681 
01682                 <span class="comment">//</span>
01683                 <span class="comment">// mark root dirty</span>
01684                 <span class="comment">//</span>
01685                 <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, IndexCell)) {
01686                     <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01687                 }
01688 
01689                 IndexCell = Child;
01690                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Child);
01691             }
01692             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == CM_KEY_INDEX_LEAF) ||
01693                    (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == CM_KEY_FAST_LEAF));
01694 
01695             <a class="code" href="../../d7/d1/cmindex_8c.html#a3">CmpFindSubKeyInLeaf</a>(Hive, Index, pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o15">WorkVar</a>, &amp;SearchName, &amp;Child);
01696             <span class="keywordflow">if</span> (Child != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01697                 <span class="keywordflow">if</span> (IsCompressed) {
01698                     (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(SearchName.Buffer, SearchName.Length);
01699                 }
01700                 <span class="keywordflow">return</span>(<a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, IndexCell));
01701             }
01702         }
01703     }
01704 
01705 <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>:
01706     <span class="keywordflow">if</span> (IsCompressed) {
01707         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(SearchName.Buffer, SearchName.Length);
01708     }
01709     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01710 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a242" doxytag="cmp.h::CmpMarkKeyDirty" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpMarkKeyDirty           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00245">245</a> of file <a class="el" href="../../d4/d2/cmtredel_8c-source.html">cmtredel.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00523">_CM_KEY_SECURITY::Blink</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00464">_CM_KEY_NODE::Class</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00508">CmpIsHKeyValueSmall</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01608">CmpMarkIndexDirty()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00332">_CHILD_LIST::Count</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00498">_CM_KEY_VALUE::Data</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00497">_CM_KEY_VALUE::DataLength</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00522">_CM_KEY_SECURITY::Flink</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">HvMarkCellDirty()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00434">KEY_HIVE_ENTRY</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00428">KEY_HIVE_EXIT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00442">KEY_PREDEF_HANDLE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00541">_CELL_DATA::_u::KeyList</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00537">_CELL_DATA::_u::KeyNode</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00539">_CELL_DATA::_u::KeySecurity</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00538">_CELL_DATA::_u::KeyValue</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00333">_CHILD_LIST::List</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00453">_CM_KEY_NODE::Parent</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00463">_CM_KEY_NODE::Security</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00454">_CM_KEY_NODE::SubKeyCounts</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00458">_CM_KEY_NODE::ValueList</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00140">CmpFreeKeyByCell()</a>.
<p>
<pre class="fragment"><div>00251                    :
00252 
00253     Mark all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cells related to a key being deleted dirty.
00254     Includes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent's child list, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key body,
00255     <span class="keyword">class</span>, security, all value entry bodies, and all of their data cells.
00256 
00257 Arguments:
00258 
00259     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> hive of interest
00260 
00261     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - index <span class="keywordflow">for</span> cell holding keybody to make dirty
00262 
00263 Return Value:
00264 
00265     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
00266 
00267     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - some error, most likely cannot get log space
00268 
00269 --*/
00270 {
00271     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  ptarget;
00272     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  plist;
00273     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  security;
00274     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  pvalue;
00275     ULONG       i;
00276     ULONG realsize;
00277 
00278 
00279     <span class="comment">//</span>
00280     <span class="comment">// Map in the target</span>
00281     <span class="comment">//</span>
00282     ptarget = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);
00283     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[Stable] == 0);
00284     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[Volatile] == 0);
00285 
00286     <span class="keywordflow">if</span> (ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a28">KEY_HIVE_EXIT</a>) {
00287 
00288         <span class="comment">//</span>
00289         <span class="comment">// If this is a link node, we are done.  Link nodes never have</span>
00290         <span class="comment">// classes, values, subkeys, or security descriptors.  Since</span>
00291         <span class="comment">// they always reside in the master hive, they're always volatile.</span>
00292         <span class="comment">//</span>
00293         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00294     }
00295 
00296     <span class="comment">//</span>
00297     <span class="comment">// mark cell itself</span>
00298     <span class="comment">//</span>
00299     <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, Cell)) {
00300         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00301     }
00302 
00303     <span class="comment">//</span>
00304     <span class="comment">// Mark the class</span>
00305     <span class="comment">//</span>
00306     <span class="keywordflow">if</span> (ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o10">Class</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00307         <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o10">Class</a>)) {
00308             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00309         }
00310     }
00311 
00312     <span class="comment">//</span>
00313     <span class="comment">// Mark security</span>
00314     <span class="comment">//</span>
00315     <span class="keywordflow">if</span> (ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00316         <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a>)) {
00317             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00318         }
00319 
00320         security = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a>);
00321         <span class="keywordflow">if</span> (! (<a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, security-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o2">KeySecurity</a>.<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a>) &amp;&amp;
00322                <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, security-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o2">KeySecurity</a>.<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o3">Blink</a>)))
00323         {
00324             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00325         }
00326     }
00327 
00328     <span class="comment">//</span>
00329     <span class="comment">// Mark the value entries and their data</span>
00330     <span class="comment">//</span>
00331     <span class="keywordflow">if</span> ( !(ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a33">KEY_PREDEF_HANDLE</a>) &amp;&amp; 
00332                   (ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> &gt; 0) 
00333            ) {
00334 
00335         <span class="comment">// target list</span>
00336         <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>)) {
00337             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00338         }
00339         plist = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>);
00340 
00341         <span class="keywordflow">for</span> (i = 0; i &lt; ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a>; i++) {
00342             <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, plist-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o4">KeyList</a>[i])) {
00343                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00344             }
00345 
00346             pvalue = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, plist-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o4">KeyList</a>[i]);
00347 
00348             <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/cmdata_8h.html#a38">CmpIsHKeyValueSmall</a>(realsize, pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o2">DataLength</a>)) {
00349                 <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>)) {
00350                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00351                 }
00352             }
00353         }
00354     }
00355 
00356     <span class="keywordflow">if</span> (ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a29">KEY_HIVE_ENTRY</a>) {
00357 
00358         <span class="comment">//</span>
00359         <span class="comment">// if this is an entry node, we are done.  our parent will</span>
00360         <span class="comment">// be in the master hive (and thus volatile)</span>
00361         <span class="comment">//</span>
00362         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00363     }
00364 
00365     <span class="comment">//</span>
00366     <span class="comment">// Mark the parent's Subkey list</span>
00367     <span class="comment">//</span>
00368     <span class="keywordflow">if</span> (! <a class="code" href="../../d1/d2/cmp_8h.html#a306">CmpMarkIndexDirty</a>(Hive, ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a>, Cell)) {
00369         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00370     }
00371 
00372     <span class="comment">//</span>
00373     <span class="comment">// Mark the parent</span>
00374     <span class="comment">//</span>
00375     <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a>)) {
00376         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00377     }
00378 
00379 
00380     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00381 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a316" doxytag="cmp.h::CmpNameSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> CmpNameSize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Name</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/cmname_8c-source.html#l00033">33</a> of file <a class="el" href="../../d0/d1/cmname_8c-source.html">cmname.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, and <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00633">_HHIVE::Version</a>.
<p>
<pre class="fragment"><div>00040                    :
00041 
00042     Determines <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> space needed to store a given string in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry.  May apply
00043     any relevant compression to compute <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, but <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> compression used <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00044     guaranteed to be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same as <a class="code" href="../../d9/d1/cmname_8c.html#a1">CmpCopyName</a>.
00045 
00046 Arguments:
00047 
00048     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure (<span class="keywordflow">for</span> version checking)
00049 
00050     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unicode string to be copied into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry.
00051 
00052 Return Value:
00053 
00054     The number of bytes of storage required to store <span class="keyword">this</span> name.
00055 
00056 --*/
00057 
00058 {
00059     ULONG i;
00060 
00061     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o21">Version</a> == 1) {
00062         <span class="keywordflow">return</span>(<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length);
00063     }
00064     <span class="keywordflow">for</span> (i=0;i&lt;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length/<span class="keyword">sizeof</span>(WCHAR);i++) {
00065         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[i] &gt; (UCHAR)-1) {
00066             <span class="keywordflow">return</span>(<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length);
00067         }
00068     }
00069     <span class="keywordflow">return</span>(<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length / <span class="keyword">sizeof</span>(WCHAR));
00070 
00071 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a239" doxytag="cmp.h::CmpNotifyChangeKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpNotifyChangeKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyBody</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PostBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CompletionFilter</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>WatchTree</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MasterPostBlock</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01378">1378</a> of file <a class="el" href="../../d1/d1/cmnotify_8c-source.html">cmnotify.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00346">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a164">CM_NOTIFY_BLOCK</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00245">CML_WORKER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03764">CmpFreePostBlock()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01515">CmpInitializeKeyNameString()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00487">CmpPostNotify()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00266">CMS_NOTIFY</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00264">CMS_POOL</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00265">ExAllocatePoolWithQuotaTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00562">_CM_NOTIFY_BLOCK::Filter</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d5/d5/regext_8c-source.html#l00033">HiveList</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00559">_CM_NOTIFY_BLOCK::HiveList</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00632">IsMasterPostBlock</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00561">_CM_NOTIFY_BLOCK::KeyBody</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00560">_CM_NOTIFY_BLOCK::KeyControlBlock</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00034">MAX_KEY_NAME_LENGTH</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00566">_CM_NOTIFY_BLOCK::NotifyPending</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00143">POOL_QUOTA_FAIL_INSTEAD_OF_RAISE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00563">_CM_NOTIFY_BLOCK::PostList</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00046">SeCaptureSubjectContext()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00564">_CM_NOTIFY_BLOCK::SubjectContext</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00294">_CM_KEY_CONTROL_BLOCK::TotalLevels</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00565">_CM_NOTIFY_BLOCK::WatchTree</a>, and <a class="el" href="../../d6/d1/rtnotify_8c-source.html#l00070">WatchTree</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>.
<p>
<pre class="fragment"><div>01389                    :
01390 
01391     This routine sets up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NotifyBlock, and attaches <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PostBlock
01392     to <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.  When <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> returns, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Notify <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> visible to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system,
01393     and will receive event reports.
01394 
01395     If there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already an event report pending, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify
01396     call will be satisified at once.
01397 
01398 Arguments:
01399 
01400     KeyBody - pointer to key object that handle refers to, allows access
01401               to key <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block, notify block, etc.
01402 
01403     PostBlock - pointer to structure that describes how/where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
01404                 <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be notified.
01405 
01406                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>:    PostBlock must come from Pool, THIS routine
01407                             will keep <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>, back side will free <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.  This
01408                             routine WILL free <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> in <span class="keywordflow">case</span> of error.
01409 
01410     CompletionFilter - what types of events <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller wants to see
01411 
01412     <a class="code" href="../../d5/d2/rtnotify_8c.html#a4">WatchTree</a> - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> to watch whole subtree, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> to watch <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> immediate
01413                 key <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> applied to
01414 
01415     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - pointer to area to recieve notify data
01416 
01417     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> - size of buffer, also size user would like to allocate
01418                  <span class="keywordflow">for</span> internal buffer
01419 
01420     MasterPostBlock - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> post block of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> master notification. Used to
01421                       insert <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PostBlock into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CancelPostList list.
01422 
01423 Return Value:
01424 
01425     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>.
01426 
01427 --*/
01428 {
01429     <a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a>    NotifyBlock;
01430     <a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a>    node;
01431     PLIST_ENTRY         ptr;
01432     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
01433     KIRQL               OldIrql;
01434 
01435     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01436     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_WORKER, CMS_NOTIFY) {
01437         KdPrint((<span class="stringliteral">"CmpNotifyChangeKey:\n"</span>));
01438         KdPrint((<span class="stringliteral">"\tKeyBody:%08lx PostBlock:%08lx "</span>, KeyBody, PostBlock));
01439         KdPrint((<span class="stringliteral">"Filter:%08lx WatchTree:%08lx\n"</span>, CompletionFilter, WatchTree));
01440 <span class="preprocessor">#if DBG</span>
01441 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
01442             WCHAR                   *NameBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01443             UNICODE_STRING          <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
01444 
01445             KdPrint((<span class="stringliteral">"[CM]CmpNotifyChangeKey: PostBlock:%08lx\tMasterBlock: %08lx\n"</span>, PostBlock,MasterPostBlock));
01446             NameBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, MAX_KEY_NAME_LENGTH);
01447             <span class="keywordflow">if</span>(NameBuffer&amp;&amp;KeyBody-&gt;KeyControlBlock-&gt;KeyNode) {
01448                <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a14">CmpInitializeKeyNameString</a>(KeyBody-&gt;KeyControlBlock-&gt;KeyNode,&amp;KeyName,NameBuffer);
01449                KdPrint((<span class="stringliteral">"\t[CM]CmpNotifyChangeKey: Key = %.*S\n"</span>,<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length / <span class="keyword">sizeof</span>(WCHAR),<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer));
01450                <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NameBuffer);
01451             }
01452         }
01453 <span class="preprocessor">#endif</span>
01454 <span class="preprocessor"></span>    }
01455 
01456     <span class="comment">//</span>
01457     <span class="comment">// The registry lock should be aquired exclusively by the caller !!!</span>
01458     <span class="comment">//</span>
01459     <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
01460 
01461     <span class="keywordflow">if</span> (KeyBody-&gt;KeyControlBlock-&gt;Delete) {
01462 <span class="preprocessor">#ifdef KCB_TO_KEYBODY_LINK</span>
01463 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( KeyBody-&gt;NotifyBlock == NULL );
01464 <span class="preprocessor">#endif</span>
01465 <span class="preprocessor"></span>        <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(PostBlock);
01466         <span class="keywordflow">return</span> STATUS_KEY_DELETED;
01467     }
01468 
01469     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = (<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)KeyBody-&gt;KeyControlBlock-&gt;KeyHive;
01470     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = CONTAINING_RECORD(Hive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive);
01471     NotifyBlock = KeyBody-&gt;NotifyBlock;
01472 
01473     <span class="keywordflow">if</span> (NotifyBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01474         <span class="comment">//</span>
01475         <span class="comment">// Set up new notify session</span>
01476         <span class="comment">//</span>
01477         NotifyBlock = <a class="code" href="../../d5/d8/ex_8h.html#a5">ExAllocatePoolWithQuotaTag</a>(PagedPool|POOL_QUOTA_FAIL_INSTEAD_OF_RAISE,<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">CM_NOTIFY_BLOCK</a>),CM_NOTIFYBLOCK_TAG);
01478         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_POOL) {
01479             KdPrint((<span class="stringliteral">"**CmpNotifyChangeKey: allocate:%08lx, "</span>, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">CM_NOTIFY_BLOCK</a>)));
01480             KdPrint((<span class="stringliteral">"type:%d, at:%08lx\n"</span>, PagedPool, NotifyBlock));
01481         }
01482 
01483         <span class="keywordflow">if</span> (NotifyBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01484             <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(PostBlock);
01485             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01486         }
01487         NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o1">KeyControlBlock</a> = KeyBody-&gt;KeyControlBlock;
01488         NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o3">Filter</a> = CompletionFilter;
01489         NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o6">WatchTree</a> = <a class="code" href="../../d5/d2/rtnotify_8c.html#a4">WatchTree</a>;
01490         NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o7">NotifyPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01491         InitializeListHead(&amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o4">PostList</a>));
01492         KeyBody-&gt;NotifyBlock = NotifyBlock;
01493         NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o2">KeyBody</a> = KeyBody;
01494         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( KeyBody-&gt;KeyControlBlock-&gt;Delete == FALSE );
01495 
01496         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_WORKER, CMS_NOTIFY) {
01497 <span class="preprocessor">#if DBG</span>
01498 <span class="preprocessor"></span>            <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
01499                 WCHAR                   *NameBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01500                 UNICODE_STRING          <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
01501 
01502                 NameBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, MAX_KEY_NAME_LENGTH);
01503                 <span class="keywordflow">if</span>(NameBuffer) {
01504                    <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a14">CmpInitializeKeyNameString</a>(KeyBody-&gt;KeyControlBlock-&gt;KeyNode,&amp;KeyName,NameBuffer);
01505                    KdPrint((<span class="stringliteral">"[CM]\tCmpNotifyChangeKey: New NotifyBlock at:%08lx was allocated for Key = %.*S\n"</span>,NotifyBlock,<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length / <span class="keyword">sizeof</span>(WCHAR),<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer));
01506                    <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NameBuffer);
01507                 }
01508             }
01509 <span class="preprocessor">#endif</span>
01510 <span class="preprocessor"></span>        }
01511 
01512         <span class="comment">//</span>
01513         <span class="comment">// IMPLEMENTATION NOTE:</span>
01514         <span class="comment">//      If we ever want to actually return the buffers full of</span>
01515         <span class="comment">//      data, the buffer should be allocated and its address</span>
01516         <span class="comment">//      stored in the notify block here.</span>
01517         <span class="comment">//</span>
01518 
01519         <span class="comment">//</span>
01520         <span class="comment">// Capture the subject context so we can do checking once the</span>
01521         <span class="comment">// notify goes off.</span>
01522         <span class="comment">//</span>
01523         <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a>(&amp;NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o5">SubjectContext</a>);
01524 
01525         <span class="comment">//</span>
01526         <span class="comment">// Attach notify block to hive in properly sorted order</span>
01527         <span class="comment">//</span>
01528         ptr = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;NotifyList);
01529         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01530             <span class="keywordflow">if</span> (ptr-&gt;Flink == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01531                 <span class="comment">//</span>
01532                 <span class="comment">// End of list, add self after ptr.</span>
01533                 <span class="comment">//</span>
01534                 ptr-&gt;Flink = &amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>);
01535                 NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01536                 NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>.Blink = ptr;
01537                 <span class="keywordflow">break</span>;
01538             }
01539 
01540             ptr = ptr-&gt;Flink;
01541 
01542             node = CONTAINING_RECORD(ptr, <a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">CM_NOTIFY_BLOCK</a>, HiveList);
01543 
01544             <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o16">TotalLevels</a> &gt;
01545                 KeyBody-&gt;KeyControlBlock-&gt;TotalLevels)
01546             {
01547                 <span class="comment">//</span>
01548                 <span class="comment">// ptr -&gt; notify with longer name than us, insert in FRONT</span>
01549                 <span class="comment">//</span>
01550                 NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>.Flink = ptr;
01551                 ptr-&gt;Blink-&gt;Flink = &amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>);
01552                 NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>.Blink = ptr-&gt;Blink;
01553                 ptr-&gt;Blink = &amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>);
01554                 <span class="keywordflow">break</span>;
01555             }
01556         }
01557     }
01558 
01559 
01560     <span class="comment">//</span>
01561     <span class="comment">// Add post block to front of notify block's list, and add it to thread list.</span>
01562     <span class="comment">//</span>
01563     InsertHeadList(
01564         &amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o4">PostList</a>),
01565         &amp;(PostBlock-&gt;NotifyList)
01566         );
01567 
01568 
01569 
01570     <span class="keywordflow">if</span>( <a class="code" href="../../d1/d2/cmp_8h.html#a89">IsMasterPostBlock</a>(PostBlock) ) {
01571         <span class="comment">//</span>
01572         <span class="comment">// Protect against outrageous calls</span>
01573         <span class="comment">//</span>
01574         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PostBlock == MasterPostBlock);
01575 
01576         <span class="comment">//</span>
01577         <span class="comment">// When the notification is a master one, initialize the CancelPostList list</span>
01578         <span class="comment">//</span>
01579         InitializeListHead(&amp;(PostBlock-&gt;CancelPostList));
01580     } <span class="keywordflow">else</span> {
01581         <span class="comment">//</span>
01582         <span class="comment">// Add PostBlock at the end of the CancelPostList list from the master post</span>
01583         <span class="comment">//</span>
01584         InsertTailList(
01585             &amp;(MasterPostBlock-&gt;CancelPostList),
01586             &amp;(PostBlock-&gt;CancelPostList)
01587             );
01588     }
01589 
01590 
01591     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(APC_LEVEL, &amp;OldIrql);
01592     InsertHeadList(
01593         &amp;(<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;PostBlockList),
01594         &amp;(PostBlock-&gt;ThreadList)
01595         );
01596 
01597     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_WORKER, CMS_NOTIFY) {
01598 <span class="preprocessor">#if DBG</span>
01599 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
01600             KdPrint((<span class="stringliteral">"[CM]\tCmpNotifyChangeKey: Attaching the post:%08lx\t to thread:%08lx\n"</span>,PostBlock,<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()));
01601         }
01602 <span class="preprocessor">#endif</span>
01603 <span class="preprocessor"></span>    }
01604 
01605     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
01606 
01607     <span class="comment">//</span>
01608     <span class="comment">// If there is a notify pending (will not be if we just created</span>
01609     <span class="comment">// the notify block) then post it at once.  Note that this call</span>
01610     <span class="comment">// ALWAYS returns STATUS_PENDING unless it fails.  Caller must</span>
01611     <span class="comment">// ALWAYS look in IoStatusBlock to see what happened.</span>
01612     <span class="comment">//</span>
01613     <span class="keywordflow">if</span> (NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o7">NotifyPending</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01614         <a class="code" href="../../d1/d2/cmp_8h.html#a284">CmpPostNotify</a>(
01615             NotifyBlock,
01616             NULL,
01617             0,
01618             STATUS_NOTIFY_ENUM_DIR,
01619             NULL
01620             );
01621         <span class="comment">//</span>
01622         <span class="comment">// return STATUS_SUCCESS to signal to the caller the the notify already been triggered</span>
01623         <span class="comment">//</span>
01624         <span class="keywordflow">return</span> STATUS_SUCCESS;
01625     }
01626 
01627     <span class="comment">//</span>
01628     <span class="comment">// return STATUS_PENDING to signal to the caller the the notify has not been triggered yet</span>
01629     <span class="comment">//</span>
01630     <span class="keywordflow">return</span> STATUS_PENDING;
01631 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a290" doxytag="cmp.h::CmpOpenHiveFiles" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpOpenHiveFiles           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PWSTR Extension&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Primary</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Secondary</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PrimaryDisposition</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SecondaryDispoition</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>CreateAllowed</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>MarkAsSystemHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ClusterSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02422">CmpInitHiveFromFile()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00726">CmpInitializeHiveList()</a>, <a class="el" href="../../d0/d4/edithive_8c-source.html#l00156">EhOpenHive()</a>, and <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00405">MyCmpInitHiveFromFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a208" doxytag="cmp.h::CmpParseKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpParseKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ParseObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Attributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>CompleteName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>RemainingName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID Context&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_QUALITY_OF_SERVICE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a9">SecurityQos</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">145</a> of file <a class="el" href="../../d3/d1/cmparse_8c-source.html">cmparse.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00030">CM_HASH_STACK_SIZE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00260">CM_KCB_CACHE_MASK</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00257">CM_KCB_KEY_NON_EXIST</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00251">CM_KCB_NO_SUBKEY</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00252">CM_KCB_SUBKEY_ONE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00244">CM_SUBKEY_HINT_LENGTH</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00139">CMP_PARSE_GOTO_CREATE</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00138">CMP_PARSE_GOTO_NONE</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00140">CMP_PARSE_GOTO_RETURN</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00141">CMP_PARSE_GOTO_RETURN2</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l02056">CmpAddInfoAfterParseFailure()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01853">CmpCacheLookup()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01737">CmpComputeHashValue()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00824">CmpCreateKeyControlBlock()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01252">CmpCreateLinkNode()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01153">CmpDereferenceKeyControlBlock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01184">CmpDereferenceKeyControlBlockWithLock()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00033">CmpDoCreate()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00963">CmpDoOpen()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00186">CmpFindSubKeyByName()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00860">CmpGetNextName()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01476">CmpGetSymbolicLink()</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00036">CmpMasterHive</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00276">CmpNoMasterCreates</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00345">CmpReferenceKeyControlBlock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01260">CmpRemoveKeyControlBlock()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00131">CmpStepThroughExit</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00260">CMS_PARSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00774">_CM_PARSE_CONTEXT::CreateLink</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00773">_CM_PARSE_CONTEXT::Disposition</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00649">_CMHIVE::Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d5/d5/regext_8c-source.html#l00458">kcb()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00439">KEY_SYM_LINK</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00280">_CM_KEY_CONTROL_BLOCK::KeyCell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00279">_CM_KEY_CONTROL_BLOCK::KeyHive</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00295">_CM_KEY_CONTROL_BLOCK::KeyNode</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00230">LOCK_KCB_TREE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00107">PHCELL_INDEX</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01178">RtlUpcaseUnicodeChar()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00231">UNLOCK_KCB_TREE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01074">CmpCreateObjectTypes()</a>.
<p>
<pre class="fragment"><div>00159                    :
00160 
00161     This routine interfaces to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NT Object <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a79">Manager</a>.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked when
00162     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object system <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> given <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of an entity to create or open and
00163     a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> or KeyRoot <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> encountered in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.  In practice <span class="keyword">this</span> means
00164     that <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called <span class="keywordflow">for</span> all objects whose names are of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00165     form \REGISTRY\...
00166 
00167     This routine will create a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> object, which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> effectively an open
00168     instance to a registry key node, and <span class="keywordflow">return</span> its address
00169     (<span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> success <span class="keywordflow">case</span>.)
00170 
00171 Arguments:
00172 
00173     ParseObject - Pointer to a KeyRoot or <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>, thus -&gt; KEY_BODY.
00174 
00175     ObjectType - Type of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being opened.
00176 
00177     AccessState - <a class="code" href="../../d4/d9/ke_8h.html#a406a193">Running</a> security access state information <span class="keywordflow">for</span> operation.
00178 
00179     AccessMode - Access mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original caller.
00180 
00181     Attributes - Attributes to be applied to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
00182 
00183     CompleteName - Supplies complete name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
00184 
00185     RemainingName - Remaining name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
00186 
00187     Context - <span class="keywordflow">if</span> create or hive root open, points to a <a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">CM_PARSE_CONTEXT</a>
00188               structure,
00189               <span class="keywordflow">if</span> open, <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
00190 
00191     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a14">SecurityQos</a> - Optional security quality of service indicator.
00192 
00193     Object - The address of a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> created key object, <span class="keywordflow">if</span>
00194         any.
00195 
00196 Return Value:
00197 
00198     The function <span class="keywordflow">return</span> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
00199 
00200         a)  Success - This indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function succeeded and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
00201             parameter contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> created key object.
00202 
00203         b)  STATUS_REPARSE - This indicates that a symbolic link key was
00204             found, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> should be reparsed.
00205 
00206         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>)  <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a> - This indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> was not found or created and
00207             no <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object was created.
00208 
00209 --*/
00210 {
00211     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00212     BOOLEAN     rc;
00213     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>      <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00214     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node;
00215     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
00216     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ParentCell;
00217     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> NextCell;
00218     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00219     <a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">PCM_PARSE_CONTEXT</a> lcontext;
00220     UNICODE_STRING Current;
00221     UNICODE_STRING  NextName;   <span class="comment">// Component last returned by CmpGetNextName,</span>
00222                                 <span class="comment">// will always be behind Current.</span>
00223     BOOLEAN     Last;           <span class="comment">// TRUE if component NextName points to</span>
00224                                 <span class="comment">// is the last one in the path.</span>
00225 
00226     <a class="code" href="../../d1/d4/struct__CM__HASH__ENTRY.html">CM_HASH_ENTRY</a>   HashStack[<a class="code" href="../../d2/d2/cmparse_8c.html#a0">CM_HASH_STACK_SIZE</a>];
00227     ULONG           TotalRemainingSubkeys;
00228     ULONG           MatchRemainSubkeyLevel;
00229     ULONG           TotalSubkeys=0;
00230     ULONG           SubkeyParsed;
00231     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00232     <a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a> PCmpCacheEntry=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00233     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   ParentKcb;
00234     UNICODE_STRING  TmpNodeName;
00235     ULONG   namelength;
00236     ULONG   GoToValue = <a class="code" href="../../d2/d2/cmparse_8c.html#a2">CMP_PARSE_GOTO_NONE</a>;
00237     BOOLEAN CompleteKeyCached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00238     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> i,j;
00239     WCHAR *p1;
00240 
00241     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_PARSE) {
00242         KdPrint((<span class="stringliteral">"CmpParseKey:\n\t"</span>));
00243         KdPrint((<span class="stringliteral">"CompleteName = '%wZ'\n\t"</span>, CompleteName));
00244         KdPrint((<span class="stringliteral">"RemainingName = '%wZ'\n"</span>, RemainingName));
00245     }
00246 
00247     <span class="comment">//</span>
00248     <span class="comment">// Strip off any trailing path separators</span>
00249     <span class="comment">//</span>
00250     <span class="keywordflow">while</span> ((RemainingName-&gt;Length &gt; 0) &amp;&amp;
00251            (RemainingName-&gt;Buffer[(RemainingName-&gt;Length/<span class="keyword">sizeof</span>(WCHAR)) - 1] == OBJ_NAME_PATH_SEPARATOR)) {
00252         RemainingName-&gt;Length -= <span class="keyword">sizeof</span>(WCHAR);
00253     }
00254 
00255     Current = *RemainingName;
00256     <span class="keywordflow">if</span> (ObjectType != <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>) {
00257         <span class="keywordflow">return</span> STATUS_OBJECT_TYPE_MISMATCH;
00258     }
00259 
00260     lcontext = (<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">PCM_PARSE_CONTEXT</a>)Context;
00261 
00262     <span class="comment">//</span>
00263     <span class="comment">// Check to make sure the passed in root key is not marked for deletion.</span>
00264     <span class="comment">//</span>
00265     <span class="keywordflow">if</span> (((<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)ParseObject)-&gt;KeyControlBlock-&gt;Delete == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00266         <span class="keywordflow">return</span>(STATUS_KEY_DELETED);
00267     }
00268 
00269     <span class="comment">//</span>
00270     <span class="comment">// Fetch the starting Hive.Cell.  Because of the way the parse</span>
00271     <span class="comment">// paths work, this will always be defined.  (ObOpenObjectByName</span>
00272     <span class="comment">// had to bounce off of a KeyObject or KeyRootObject to get here)</span>
00273     <span class="comment">//</span>
00274     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = ((<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)ParseObject)-&gt;KeyControlBlock;
00275     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyHive;
00276     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyCell;
00277     Node = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyNode;
00278 
00279     <span class="comment">//</span>
00280     <span class="comment">// Compute the hash values of each subkeys</span>
00281     <span class="comment">//</span>
00282     TotalRemainingSubkeys = <a class="code" href="../../d2/d2/cmparse_8c.html#a13">CmpComputeHashValue</a>(HashStack,
00283                                                 &amp;TotalSubkeys,
00284                                                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ConvKey,
00285                                                 &amp;Current);
00286 
00287 
00288     <span class="comment">// Look up from the cache.  kcb will be changed if we find a partial or exact match</span>
00289     <span class="comment">// PCmpCacheEntry, the entry found, will be move to the front of</span>
00290     <span class="comment">// the Cache.</span>
00291 
00292     <a class="code" href="../../d1/d2/cmp_8h.html#a16">LOCK_KCB_TREE</a>();
00293 
00294     status = <a class="code" href="../../d2/d2/cmparse_8c.html#a14">CmpCacheLookup</a>(HashStack,
00295                             TotalRemainingSubkeys,
00296                             &amp;MatchRemainSubkeyLevel,
00297                             &amp;kcb,
00298                             &amp;Current,
00299                             &amp;Hive,
00300                             &amp;Cell);
00301     <span class="comment">//</span>
00302     <span class="comment">// The RefCount of kcb was increased in the CmpCacheLookup process,</span>
00303     <span class="comment">// It is to protect it from being kicked out of cache.</span>
00304     <span class="comment">// Make sure we dereference it after we are done.</span>
00305     <span class="comment">//</span>
00306 
00307     <span class="comment">//</span>
00308     <span class="comment">// First make sure it is OK to proceed.</span>
00309     <span class="comment">//</span>
00310     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00311         <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
00312         <span class="keywordflow">goto</span> JustReturn;
00313     }
00314 
00315     SubkeyParsed = MatchRemainSubkeyLevel;
00316     ParentKcb = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00317 
00318     <span class="comment">//</span>
00319     <span class="comment">// First check if there are further information in the cached kcb.</span>
00320     <span class="comment">// </span>
00321     <span class="comment">// The additional information can be</span>
00322     <span class="comment">// 1. This cached key is a fake key (CM_KCB_KEY_NON_EXIST), then either let it be created</span>
00323     <span class="comment">//    or return STATUS_OBJECT_NAME_NOT_FOUND.</span>
00324     <span class="comment">// 2. The cached key is not the destination and it has no subkey (CM_KCB_NO_SUBKEY).</span>
00325     <span class="comment">// 3. The cached key is not the destination and it has </span>
00326     <span class="comment">//    the first four characters of its subkeys.  If the flag is CM_KCB_SUBKEY_ONE, there is only one subkey</span>
00327     <span class="comment">//    and the four char is embedded in the KCB.  If the flag is CM_KCB_SUBKEY_INFO, then there is</span>
00328     <span class="comment">//    an allocation for these info. </span>
00329     <span class="comment">//</span>
00330     <span class="comment">// We do need to lock KCB tree to protect the KCB being modified.  Currently there is not lock contention problem</span>
00331     <span class="comment">// on KCBs, We can change KCB lock to a read-write lock if this becomes a problem.</span>
00332     <span class="comment">// </span>
00333 
00334     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a15">CM_KCB_CACHE_MASK</a>) {
00335         <span class="keywordflow">if</span> (MatchRemainSubkeyLevel == TotalRemainingSubkeys) {
00336             <span class="comment">//</span>
00337             <span class="comment">// We have found a cache for the complete path,</span>
00338             <span class="comment">//</span>
00339             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a13">CM_KCB_KEY_NON_EXIST</a>) {
00340                 <span class="comment">//</span>
00341                 <span class="comment">// This key does not exist.</span>
00342                 <span class="comment">//</span>
00343                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT(lcontext)) {
00344                     ULONG LevelToSkip = TotalRemainingSubkeys-1;
00345                     ULONG i=0;
00346                     <span class="comment">//</span>
00347                     <span class="comment">// The non-existing key is the desination key and lcontext is present.</span>
00348                     <span class="comment">// delete this fake kcb and let the real one be created.</span>
00349                     <span class="comment">//</span>
00350                     <span class="comment">// Temporarily increase the RefCount of the ParentKcb so it's </span>
00351                     <span class="comment">// not removed while removing the fake and creating the real KCB.</span>
00352                     <span class="comment">//</span>
00353                     
00354                     ParentKcb = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ParentKcb;
00355                     
00356                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/cmsubs_8c.html#a13">CmpReferenceKeyControlBlock</a>(ParentKcb)) {
00357                     
00358                         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;Delete = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00359                         <a class="code" href="../../d8/d2/cmsubs_8c.html#a24">CmpRemoveKeyControlBlock</a>(kcb);
00360                         <a class="code" href="../../d8/d2/cmsubs_8c.html#a23">CmpDereferenceKeyControlBlockWithLock</a>(kcb);
00361 
00362                         <span class="comment">//</span>
00363                         <span class="comment">// Update Hive, Cell and Node</span>
00364                         <span class="comment">//</span>
00365                         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = ParentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a>;
00366                         <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = ParentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o6">KeyCell</a>;
00367                         Node = ParentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o17">KeyNode</a>;
00368 
00369                         <span class="comment">//</span>
00370                         <span class="comment">// Now get the child name to be created.</span>
00371                         <span class="comment">//</span>
00372    
00373                         NextName = *RemainingName;
00374                         <span class="keywordflow">if</span> ((NextName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (NextName.Length == 0)) {
00375                             KdPrint((<span class="stringliteral">"Something wrong in finding the child name\n"</span>));
00376                             DbgBreakPoint();
00377                         }
00378                         <span class="comment">//</span>
00379                         <span class="comment">// Skip over leading path separators</span>
00380                         <span class="comment">//</span>
00381                         <span class="keywordflow">if</span> (*(NextName.Buffer) == OBJ_NAME_PATH_SEPARATOR) {
00382                             NextName.Buffer++;
00383                             NextName.Length -= <span class="keyword">sizeof</span>(WCHAR);
00384                             NextName.MaximumLength -= <span class="keyword">sizeof</span>(WCHAR);
00385                         }
00386    
00387                         <span class="keywordflow">while</span> (i &lt; LevelToSkip) {
00388                             <span class="keywordflow">if</span> (*(NextName.Buffer) == OBJ_NAME_PATH_SEPARATOR) {
00389                                 i++;
00390                             }
00391                             NextName.Buffer++;
00392                             NextName.Length -= <span class="keyword">sizeof</span>(WCHAR);
00393                             NextName.MaximumLength -= <span class="keyword">sizeof</span>(WCHAR);
00394                         } 
00395                         GoToValue = <a class="code" href="../../d2/d2/cmparse_8c.html#a3">CMP_PARSE_GOTO_CREATE</a>;
00396                     } <span class="keywordflow">else</span> {
00397                         <span class="comment">//</span>
00398                         <span class="comment">// We have maxed the RefCount of ParentKcb; treate it as key cannot be created.</span>
00399                         <span class="comment">// The ParentKcb will not be dereferenced at the end.</span>
00400                         <span class="comment">//</span>
00401                         status = STATUS_INSUFFICIENT_RESOURCES;
00402                         GoToValue = <a class="code" href="../../d2/d2/cmparse_8c.html#a5">CMP_PARSE_GOTO_RETURN2</a>;
00403                     }
00404                 } <span class="keywordflow">else</span> {
00405                     status = STATUS_OBJECT_NAME_NOT_FOUND;
00406                     GoToValue = <a class="code" href="../../d2/d2/cmparse_8c.html#a4">CMP_PARSE_GOTO_RETURN</a>;
00407                 }
00408             }
00409         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a13">CM_KCB_KEY_NON_EXIST</a>) {
00410             <span class="comment">//</span>
00411             <span class="comment">// one subkey (not desination) in the path does not exist. no point to continue.</span>
00412             <span class="comment">//</span>
00413             status = STATUS_OBJECT_NAME_NOT_FOUND;
00414             GoToValue = <a class="code" href="../../d2/d2/cmparse_8c.html#a4">CMP_PARSE_GOTO_RETURN</a>;
00415         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a9">CM_KCB_NO_SUBKEY</a>) {
00416             <span class="comment">//</span>
00417             <span class="comment">// one parent in the path has no subkey. see if it is a create.</span>
00418             <span class="comment">//</span>
00419             <span class="keywordflow">if</span> (((TotalRemainingSubkeys - MatchRemainSubkeyLevel) == 1) &amp;&amp; (ARGUMENT_PRESENT(lcontext))) {
00420                 <span class="comment">//</span>
00421                 <span class="comment">// Now we are going to create this subkey. </span>
00422                 <span class="comment">// The kcb cache will be updated in CmpDoCreate routine.</span>
00423                 <span class="comment">//</span>
00424             } <span class="keywordflow">else</span> {
00425                 status = STATUS_OBJECT_NAME_NOT_FOUND;
00426                 GoToValue = <a class="code" href="../../d2/d2/cmparse_8c.html#a4">CMP_PARSE_GOTO_RETURN</a>;
00427             }
00428         } <span class="keywordflow">else</span> {
00429             <span class="comment">//</span>
00430             <span class="comment">// We have a partial match.  Current is the remaining name to be parsed.</span>
00431             <span class="comment">// The Key has either one or a few subkeys and has index hint. check if it is the candidate.</span>
00432             <span class="comment">//</span>
00433             ULONG HintLength;
00434             ULONG HintCounts;
00435             ULONG CmpCount;
00436             WCHAR c1;
00437             WCHAR c2;
00438             UCHAR *TmpName;
00439             LONG Result;
00440             BOOLEAN NoMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00441             <span class="comment">//</span>
00442             <span class="comment">// When NoMatch is TRUE, we know for sure there is no subkey that can match.</span>
00443             <span class="comment">// When NoMatch is FALSE, it can we either we found a match or</span>
00444             <span class="comment">// there is not enough information.  Either case, we need to continue</span>
00445             <span class="comment">// the parse.</span>
00446             <span class="comment">//</span>
00447 
00448             TmpNodeName = Current;
00449 
00450             rc = <a class="code" href="../../d2/d2/cmparse_8c.html#a21">CmpGetNextName</a>(&amp;TmpNodeName, &amp;NextName, &amp;Last);
00451         
00452             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a10">CM_KCB_SUBKEY_ONE</a>) {
00453                 HintCounts = 1;
00454                 TmpName = &amp;(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;NameHint[0]);
00455             } <span class="keywordflow">else</span> {
00456                 <span class="comment">//</span>
00457                 <span class="comment">// More than one child, the hint info in not inside the kcb but pointed by kcb.</span>
00458                 <span class="comment">//</span>
00459                 HintCounts = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;IndexHint-&gt;Count;
00460                 TmpName = &amp;(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;IndexHint-&gt;NameHint[0]);
00461             }
00462 
00463             <span class="comment">//</span>
00464             <span class="comment">// use the hint to predict if there is a possible match</span>
00465             <span class="comment">//</span>
00466             <span class="keywordflow">if</span> (NextName.Length &lt; (<span class="keyword">sizeof</span>(WCHAR) * <a class="code" href="../../d9/d0/cmdata_8h.html#a7">CM_SUBKEY_HINT_LENGTH</a>) ) {
00467                 HintLength = NextName.Length / <span class="keyword">sizeof</span>(WCHAR);
00468             } <span class="keywordflow">else</span> {
00469                 HintLength = <a class="code" href="../../d9/d0/cmdata_8h.html#a7">CM_SUBKEY_HINT_LENGTH</a>;
00470             }
00471 
00472             <span class="keywordflow">for</span> (CmpCount=0; CmpCount&lt;HintCounts; CmpCount++) {
00473                 NoMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00474                 
00475                 <span class="keywordflow">if</span>( TmpName[0] == 0) {
00476                     <span class="comment">//</span>
00477                     <span class="comment">// No hint available; assume the subkey exist and go on with the parse</span>
00478                     <span class="comment">//</span>
00479                     <span class="keywordflow">break</span>;
00480                 } 
00481                 
00482                 <span class="keywordflow">for</span> (i=0; i&lt;HintLength; i++) {
00483                     c1 = NextName.Buffer[i];
00484                     c2 = (WCHAR) *TmpName;
00485 
00486                     Result = (LONG)<a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(c1) - (LONG)<a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(c2);
00487                     <span class="keywordflow">if</span> (Result != 0) {
00488                         NoMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00489                         TmpName += (<a class="code" href="../../d9/d0/cmdata_8h.html#a7">CM_SUBKEY_HINT_LENGTH</a>-i); 
00490                         <span class="keywordflow">break</span>;
00491                     }
00492                     TmpName++;
00493                 }
00494                 
00495                 <span class="keywordflow">if</span> (NoMatch == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00496                     <span class="comment">//</span>
00497                     <span class="comment">// There is a match.</span>
00498                     <span class="comment">//</span>
00499                     <span class="keywordflow">break</span>;
00500                 }
00501             }
00502 
00503             <span class="keywordflow">if</span> (NoMatch) {
00504                 <span class="keywordflow">if</span> (((TotalRemainingSubkeys - MatchRemainSubkeyLevel) == 1) &amp;&amp; (ARGUMENT_PRESENT(lcontext))) {
00505                     <span class="comment">//</span>
00506                     <span class="comment">// No we are going to create this subkey. </span>
00507                     <span class="comment">// The kcb cache will be updated in CmpDoCreate.</span>
00508                     <span class="comment">//</span>
00509                 } <span class="keywordflow">else</span> {
00510                     status = STATUS_OBJECT_NAME_NOT_FOUND;
00511                     GoToValue = <a class="code" href="../../d2/d2/cmparse_8c.html#a4">CMP_PARSE_GOTO_RETURN</a>;
00512                 }
00513             }
00514         }
00515     }
00516 
00517     <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
00518 
00519 
00520     <span class="keywordflow">if</span> (GoToValue == <a class="code" href="../../d2/d2/cmparse_8c.html#a3">CMP_PARSE_GOTO_CREATE</a>) {
00521         <span class="keywordflow">goto</span> CreateChild;
00522     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (GoToValue == <a class="code" href="../../d2/d2/cmparse_8c.html#a4">CMP_PARSE_GOTO_RETURN</a>) {
00523         <span class="keywordflow">goto</span> FreeAndReturn;
00524     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (GoToValue == <a class="code" href="../../d2/d2/cmparse_8c.html#a5">CMP_PARSE_GOTO_RETURN2</a>) {
00525         <span class="keywordflow">goto</span> JustReturn;
00526     }
00527 
00528     <span class="keywordflow">if</span> (MatchRemainSubkeyLevel) {
00529         <span class="comment">// Found something, update the information to start the search</span>
00530         <span class="comment">// from the new BaseName</span>
00531 
00532         <span class="comment">//</span>
00533         <span class="comment">// Get the Node address from the kcb.</span>
00534         <span class="comment">// (Always try to utilize the KCB to avoid touching the registry data).</span>
00535         <span class="comment">//</span>
00536         Node = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyNode;
00537 
00538         <span class="keywordflow">if</span> (MatchRemainSubkeyLevel == TotalSubkeys) {
00539             <span class="comment">// The complete key has been found in the cache,</span>
00540             <span class="comment">// go directly to the CmpDoOpen.</span>
00541             
00542             <span class="comment">//</span>
00543             <span class="comment">// Found the whole thing cached.</span>
00544             <span class="comment">// </span>
00545             <span class="comment">//</span>
00546             CompleteKeyCached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00547             <span class="keywordflow">goto</span> Found;
00548         }
00549     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TotalRemainingSubkeys == 0) {
00550         <span class="comment">//</span>
00551         <span class="comment">// BUGBUG John Vert (jvert) 10/7/1997</span>
00552         <span class="comment">//</span>
00553         CompleteKeyCached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00554         <span class="keywordflow">goto</span> Found;
00555     }
00556 
00557     <span class="comment">//</span>
00558     <span class="comment">// Parse the path.</span>
00559     <span class="comment">//</span>
00560 
00561     status = STATUS_SUCCESS;
00562     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00563 
00564         <span class="comment">//</span>
00565         <span class="comment">// Parse out next component of name</span>
00566         <span class="comment">//</span>
00567         rc = <a class="code" href="../../d2/d2/cmparse_8c.html#a21">CmpGetNextName</a>(&amp;Current, &amp;NextName, &amp;Last);
00568         <span class="keywordflow">if</span> ((NextName.Length &gt; 0) &amp;&amp; (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00569 
00570             <span class="comment">//</span>
00571             <span class="comment">// As we iterate through, we will create a kcb for each subkey parsed.</span>
00572             <span class="comment">// </span>
00573             <span class="comment">// Always use the information in kcb to avoid</span>
00574             <span class="comment">// touching registry data.</span>
00575             <span class="comment">//</span>
00576             <span class="keywordflow">if</span> (!(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a31">KEY_SYM_LINK</a>)) {
00577                 <span class="comment">//</span>
00578                 <span class="comment">// Got a legal name component, see if we can find a sub key</span>
00579                 <span class="comment">// that actually has such a name.</span>
00580                 <span class="comment">//</span>
00581                 NextCell = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(Hive,
00582                                                Node,
00583                                                &amp;NextName);
00584 
00585                 <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_PARSE) {
00586                     KdPrint((<span class="stringliteral">"CmpParseKey:\n\t"</span>));
00587                     KdPrint((<span class="stringliteral">"NextName = '%wZ'\n\t"</span>, &amp;NextName));
00588                     KdPrint((<span class="stringliteral">"NextCell = %08lx  Last = %01lx\n"</span>, NextCell, Last));
00589                 }
00590                 <span class="keywordflow">if</span> (NextCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00591                     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = NextCell;
00592                     Node = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,Cell);
00593                     <span class="keywordflow">if</span> (Last == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00594 
00595 Found:
00596                         <span class="comment">//</span>
00597                         <span class="comment">// We will open the key regardless of whether the</span>
00598                         <span class="comment">// call was open or create, so step through exit</span>
00599                         <span class="comment">// portholes here.</span>
00600                         <span class="comment">//</span>
00601 
00602                         <span class="keywordflow">if</span> (CompleteKeyCached == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00603                             <span class="comment">//</span>
00604                             <span class="comment">// If the key found is already cached, </span>
00605                             <span class="comment">// do not need to StepThroughExit</span>
00606                             <span class="comment">// (no kcb is created using exit node).</span>
00607                             <span class="comment">// This prevents us from touching the key node just for the Flags.</span>
00608                             <span class="comment">//</span>
00609                         } <span class="keywordflow">else</span> {
00610                             <a class="code" href="../../d2/d2/cmparse_8c.html#a1">CmpStepThroughExit</a>(Hive, Cell, Node);
00611                         }
00612                         <span class="comment">//</span>
00613                         <span class="comment">// We have found the entire path, so we want to open</span>
00614                         <span class="comment">// it (for both Open and Create calls).</span>
00615                         <span class="comment">// Hive,Cell -&gt; the key we are supposed to open.</span>
00616                         <span class="comment">//</span>
00617 
00618                         status = <a class="code" href="../../d2/d2/cmparse_8c.html#a18">CmpDoOpen</a>(Hive,
00619                                            Cell,
00620                                            Node,
00621                                            AccessState,
00622                                            AccessMode,
00623                                            Attributes,
00624                                            lcontext,
00625                                            CompleteKeyCached,
00626                                            &amp;kcb,
00627                                            &amp;NextName,
00628                                            Object);
00629 
00630                         <span class="keywordflow">if</span> (status == STATUS_REPARSE) {
00631                             <span class="comment">//</span>
00632                             <span class="comment">// The given key was a symbolic link.  Find the name of</span>
00633                             <span class="comment">// its link, and return STATUS_REPARSE to the Object Manager.</span>
00634                             <span class="comment">//</span>
00635 
00636                             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d2/cmparse_8c.html#a17">CmpGetSymbolicLink</a>(Hive,
00637                                                     Node,
00638                                                     CompleteName,
00639                                                     kcb,
00640                                                     NULL)) {
00641                                 <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_PARSE) {
00642                                     KdPrint((<span class="stringliteral">"CmpParseKey: couldn't find symbolic link name\n"</span>));
00643                                 }
00644                                 status = STATUS_OBJECT_NAME_NOT_FOUND;
00645                             }
00646                         }
00647 
00648                         <span class="keywordflow">break</span>;
00649                     }
00650                     <span class="comment">// else</span>
00651                     <span class="comment">//   Not at end, so we'll simply iterate and consume</span>
00652                     <span class="comment">//   the next component.</span>
00653                     <span class="comment">//</span>
00654                     <span class="comment">//</span>
00655                     <span class="comment">// Step through exit portholes here.</span>
00656                     <span class="comment">// This ensures that no KCB is created using</span>
00657                     <span class="comment">// the Exit node.</span>
00658                     <span class="comment">//</span>
00659 
00660                     <a class="code" href="../../d2/d2/cmparse_8c.html#a1">CmpStepThroughExit</a>(Hive, Cell, Node);
00661 
00662                     <span class="comment">//</span>
00663                     <span class="comment">// Create a kcb for each subkey parsed.</span>
00664                     <span class="comment">//</span>
00665 
00666                     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = <a class="code" href="../../d8/d2/cmsubs_8c.html#a20">CmpCreateKeyControlBlock</a>(Hive,
00667                                                    Cell,
00668                                                    Node,
00669                                                    ParentKcb,
00670                                                    FALSE,
00671                                                    &amp;NextName);
00672             
00673                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>  == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00674                         status = STATUS_INSUFFICIENT_RESOURCES;
00675                         <span class="keywordflow">goto</span> FreeAndReturn;
00676                         <span class="comment">//</span>
00677                         <span class="comment">// Currently, the kcb has one extra reference conut to be decremented.</span>
00678                         <span class="comment">// So, remember it so we can dereference it properly.</span>
00679                         <span class="comment">//</span>
00680                     }
00681                     <span class="comment">//</span>
00682                     <span class="comment">// Now we have created a kcb for the next level,</span>
00683                     <span class="comment">// the kcb in the previous level is no longer needed.</span>
00684                     <span class="comment">// Dereference the parent kcb.</span>
00685                     <span class="comment">//</span>
00686                     <a class="code" href="../../d8/d2/cmsubs_8c.html#a22">CmpDereferenceKeyControlBlock</a>(ParentKcb);
00687 
00688                     ParentKcb = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00689 
00690 
00691                 } <span class="keywordflow">else</span> {
00692                     <span class="comment">//</span>
00693                     <span class="comment">// We did not find a key matching the name, but no</span>
00694                     <span class="comment">// unexpected error occured</span>
00695                     <span class="comment">//</span>
00696 
00697                     <span class="keywordflow">if</span> ((Last == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp; (ARGUMENT_PRESENT(lcontext))) {
00698 
00699 CreateChild:
00700                         <span class="comment">//</span>
00701                         <span class="comment">// Only unfound component is last one, and operation</span>
00702                         <span class="comment">// is a create, so perform the create.</span>
00703                         <span class="comment">//</span>
00704 
00705                         <span class="comment">//</span>
00706                         <span class="comment">// There are two possibilities here.  The normal one</span>
00707                         <span class="comment">// is that we are simply creating a new node.</span>
00708                         <span class="comment">//</span>
00709                         <span class="comment">// The abnormal one is that we are creating a root</span>
00710                         <span class="comment">// node that is linked to the main hive.  In this</span>
00711                         <span class="comment">// case, we must create the link.  Once the link is</span>
00712                         <span class="comment">// created, we can check to see if the root node</span>
00713                         <span class="comment">// exists, then either create it or open it as</span>
00714                         <span class="comment">// necessary.</span>
00715                         <span class="comment">//</span>
00716                         <span class="comment">// CmpCreateLinkNode creates the link, and calls</span>
00717                         <span class="comment">// back to CmpDoCreate or CmpDoOpen to create or open</span>
00718                         <span class="comment">// the root node as appropriate.</span>
00719                         <span class="comment">//</span>
00720 
00721                         <span class="keywordflow">if</span> (lcontext-&gt;<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o4">CreateLink</a>) {
00722                             status = <a class="code" href="../../d2/d2/cmparse_8c.html#a19">CmpCreateLinkNode</a>(Hive,
00723                                                        Cell,
00724                                                        AccessState,
00725                                                        NextName,
00726                                                        AccessMode,
00727                                                        Attributes,
00728                                                        lcontext,
00729                                                        ParentKcb,
00730                                                        Object);
00731 
00732                         } <span class="keywordflow">else</span> {
00733 
00734                             <span class="keywordflow">if</span> ( (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> == &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>)) &amp;&amp;
00735                                  (<a class="code" href="../../d6/d0/cmdat_8c.html#a64">CmpNoMasterCreates</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) ) {
00736                                 <span class="comment">//</span>
00737                                 <span class="comment">// attempting to create a cell in the master</span>
00738                                 <span class="comment">// hive, and not a link, so blow out of here,</span>
00739                                 <span class="comment">// since it wouldn't work anyway.</span>
00740                                 <span class="comment">//</span>
00741                                 status = STATUS_INVALID_PARAMETER;
00742                                 <span class="keywordflow">break</span>;
00743                             }
00744 
00745                             status = <a class="code" href="../../d3/d2/cmparse2_8c.html#a1">CmpDoCreate</a>(Hive,
00746                                                  Cell,
00747                                                  AccessState,
00748                                                  &amp;NextName,
00749                                                  AccessMode,
00750                                                  lcontext,
00751                                                  ParentKcb,
00752                                                  Object);
00753                         }
00754 
00755                         lcontext-&gt;<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o3">Disposition</a> = REG_CREATED_NEW_KEY;
00756                         <span class="keywordflow">break</span>;
00757 
00758                     } <span class="keywordflow">else</span> {
00759 
00760                         <span class="comment">//</span>
00761                         <span class="comment">// Did not find a key to match the component, and</span>
00762                         <span class="comment">// are not at the end of the path.  Thus, open must</span>
00763                         <span class="comment">// fail because the whole path dosn't exist, create must</span>
00764                         <span class="comment">// fail because more than 1 component doesn't exist.</span>
00765                         <span class="comment">//</span>
00766                         <span class="comment">//</span>
00767                         <span class="comment">// We have a lookup failure here, so having additional information</span>
00768                         <span class="comment">// about this kcb may help us not to go through all the code just to fail again.</span>
00769                         <span class="comment">// </span>
00770                         ParentKcb = <a class="code" href="../../d2/d2/cmparse_8c.html#a16">CmpAddInfoAfterParseFailure</a>(Hive,
00771                                                                 Cell,
00772                                                                 Node,
00773                                                                 kcb,
00774                                                                 &amp;NextName
00775                                                                 );
00776                         
00777                         status = STATUS_OBJECT_NAME_NOT_FOUND;
00778                         <span class="keywordflow">break</span>;
00779                     }
00780 
00781                 }
00782 
00783             } <span class="keywordflow">else</span> {
00784                 <span class="comment">//</span>
00785                 <span class="comment">// The given key was a symbolic link.  Find the name of</span>
00786                 <span class="comment">// its link, and return STATUS_REPARSE to the Object Manager.</span>
00787                 <span class="comment">//</span>
00788                 Current.Buffer = NextName.Buffer;
00789                 Current.Length += NextName.Length;
00790                 Current.MaximumLength += NextName.MaximumLength;
00791                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/cmparse_8c.html#a17">CmpGetSymbolicLink</a>(Hive,
00792                                        Node,
00793                                        CompleteName,
00794                                        kcb,
00795                                        &amp;Current)) {
00796 
00797                     status = STATUS_REPARSE;
00798                     <span class="keywordflow">break</span>;
00799 
00800                 } <span class="keywordflow">else</span> {
00801                     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_PARSE) {
00802                         KdPrint((<span class="stringliteral">"CmpParseKey: couldn't find symbolic link name\n"</span>));
00803                     }
00804                     status = STATUS_OBJECT_NAME_NOT_FOUND;
00805                     <span class="keywordflow">break</span>;
00806                 }
00807             }
00808 
00809         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; Last == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00810             <span class="comment">//</span>
00811             <span class="comment">// We will open the \Registry root.</span>
00812             <span class="comment">// Or some strange remaining name that</span>
00813             <span class="comment">// screw up the lookup.</span>
00814             <span class="comment">//</span>
00815             <a class="code" href="../../d2/d2/cmparse_8c.html#a1">CmpStepThroughExit</a>(Hive, Cell, Node);
00816 
00817             <span class="comment">//</span>
00818             <span class="comment">// We have found the entire path, so we want to open</span>
00819             <span class="comment">// it (for both Open and Create calls).</span>
00820             <span class="comment">// Hive,Cell -&gt; the key we are supposed to open.</span>
00821             <span class="comment">//</span>
00822             status = <a class="code" href="../../d2/d2/cmparse_8c.html#a18">CmpDoOpen</a>(Hive,
00823                                Cell,
00824                                Node,
00825                                AccessState,
00826                                AccessMode,
00827                                Attributes,
00828                                lcontext,
00829                                TRUE,
00830                                &amp;kcb,
00831                                &amp;NextName,
00832                                Object);
00833             <span class="keywordflow">break</span>;
00834 
00835         } <span class="keywordflow">else</span> {
00836 
00837             <span class="comment">//</span>
00838             <span class="comment">// bogus path -&gt; fail</span>
00839             <span class="comment">//</span>
00840             status = STATUS_INVALID_PARAMETER;
00841             <span class="keywordflow">break</span>;
00842         }
00843 
00844     } <span class="comment">// while</span>
00845 
00846 FreeAndReturn:
00847     <span class="comment">//</span>
00848     <span class="comment">// Now we have to free the last kcb that still has one extra reference count to</span>
00849     <span class="comment">// protect it from being freed.</span>
00850     <span class="comment">//</span>
00851 
00852     <a class="code" href="../../d8/d2/cmsubs_8c.html#a22">CmpDereferenceKeyControlBlock</a>(ParentKcb);
00853 JustReturn:
00854 
00855     <span class="keywordflow">return</span> status;
00856 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a287" doxytag="cmp.h::CmpPostApc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpPostApc           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="../../d1/d5/struct__KAPC.html">_KAPC</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>Apc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00804">804</a> of file <a class="el" href="../../d1/d1/cmnotify_8c-source.html">cmnotify.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00607">_CM_POST_BLOCK_UNION::AsyncUser</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00085">CmpCheckPostBlock</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03764">CmpFreePostBlock()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01634">CmpFreeSlavePost()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00048">CmpRemoveEntryList</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l02019">CmpSetIoStatus</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00266">CMS_NOTIFY</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00596">_CM_ASYNC_USER_POST_BLOCK::IoStatusBlock</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00616">_CM_POST_BLOCK::ThreadList</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00620">_CM_POST_BLOCK::u</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00594">_CM_ASYNC_USER_POST_BLOCK::UserEvent</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>.
<p>
<pre class="fragment"><div>00813                    :
00814 
00815     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel apc routine.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called <span class="keywordflow">for</span> all notifies,
00816     regardless of what form of notification <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller requested.
00817 
00818     We compute <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> postblock address from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> apc object address.
00819     IoStatus <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set.  SystemEvent and UserEvent will be signalled
00820     as appropriate.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user requested an APC, then NormalRoutine
00821     will be set at entry and executed when we <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>.  The PostBlock
00822     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> freed here.
00823 
00824 Arguments:
00825 
00826     Apc - pointer to apc object
00827 
00828     NormalRoutine - Will be called when we <span class="keywordflow">return</span>
00829 
00830     NormalContext - will be 1st argument to normal routine, ApcContext
00831                     passed in when <a class="code" href="../../d7/d7/ntapi_8c.html#a21">NtNotifyChangeKey</a> was called
00832 
00833     SystemArgument1 -  IN: <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> value <span class="keywordflow">for</span> IoStatusBlock
00834                       OUT: <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a28">Ptr</a> to IoStatusBlock (2nd arg to user apc routine)
00835 
00836     SystemArgument2 - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PostBlock
00837 
00838 Return Value:
00839 
00840     NONE.
00841 
00842 --*/
00843 {
00844     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>  PostBlock;
00845 
00846     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00847     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_NOTIFY) {
00848         KdPrint((<span class="stringliteral">"CmpPostApc:\n"</span>));
00849         KdPrint((<span class="stringliteral">"\tApc:%08lx "</span>, Apc));
00850         KdPrint((<span class="stringliteral">"NormalRoutine:%08lx\n"</span>, NormalRoutine));
00851         KdPrint((<span class="stringliteral">"\tNormalContext:%08lx"</span>, NormalContext));
00852         KdPrint((<span class="stringliteral">"\tSystemArgument1=IoStatusBlock:%08lx\n"</span>, SystemArgument1));
00853     }
00854 
00855 
00856     PostBlock = *(<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a> *)SystemArgument2;
00857 
00858     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_NOTIFY) {
00859 <span class="preprocessor">#if DBG</span>
00860 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
00861             KdPrint((<span class="stringliteral">"[CM]CmpPostApc: PostBlock:%08lx\n"</span>, PostBlock));
00862         }
00863 <span class="preprocessor">#endif</span>
00864 <span class="preprocessor"></span>    }
00865     <span class="comment">//</span>
00866     <span class="comment">// Fill in IO Status Block</span>
00867     <span class="comment">//</span>
00868     <span class="comment">// IMPLEMENTATION NOTE:</span>
00869     <span class="comment">//      If we ever want to actually implement the code that returns</span>
00870     <span class="comment">//      names of things that changed, this is the place to copy the</span>
00871     <span class="comment">//      buffer into the caller's buffer.</span>
00872     <span class="comment">//</span>
00873     <span class="comment">//  Sundown only: Use a 32bit IO_STATUS_BLOCK if the caller is 32bit.</span>
00874 
00875     <span class="keywordflow">try</span> {
00876         <a class="code" href="../../d1/d2/cmp_8h.html#a151">CmpSetIoStatus</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o2">IoStatusBlock</a>, 
00877                        *((ULONG *)SystemArgument1), 
00878                        0L,
00879                        <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Wow64Process != NULL);
00880     } except (EXCEPTION_EXECUTE_HANDLER) {
00881         NOTHING;
00882     }
00883     *SystemArgument1 = PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o2">IoStatusBlock</a>;
00884 
00885     <span class="comment">//</span>
00886     <span class="comment">// This is an Async notify, do all work here, including</span>
00887     <span class="comment">// cleaning up the post block</span>
00888     <span class="comment">//</span>
00889 
00890     <span class="comment">//</span>
00891     <span class="comment">// Signal UserEvent if present, and deref it.</span>
00892     <span class="comment">//</span>
00893     <span class="keywordflow">if</span> (PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o0">UserEvent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00894         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o0">UserEvent</a>,
00895                    0,
00896                    FALSE);
00897         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o0">UserEvent</a>);
00898     }
00899 
00900     <span class="comment">//</span>
00901     <span class="comment">// remove the post block from the thread list, and free it</span>
00902     <span class="comment">//</span>
00903     <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
00904     <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o1">ThreadList</a>));
00905 
00906     <span class="comment">// debug only checks</span>
00907     <a class="code" href="../../d0/d2/cmnotify_8c.html#a0">CmpCheckPostBlock</a>(PostBlock);
00908     <span class="comment">//</span>
00909         <span class="comment">// Free the slave post block to avoid "dangling" postblocks</span>
00910         <span class="comment">//</span>
00911         <a class="code" href="../../d0/d2/cmnotify_8c.html#a4">CmpFreeSlavePost</a>(PostBlock);
00912     <span class="comment">//</span>
00913         <span class="comment">// free this post block</span>
00914         <span class="comment">// </span>
00915         <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(PostBlock);
00916 
00917     <span class="keywordflow">return</span>;
00918 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a289" doxytag="cmp.h::CmpPostApcRunDown" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpPostApcRunDown           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="../../d1/d5/struct__KAPC.html">_KAPC</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Apc</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00922">922</a> of file <a class="el" href="../../d1/d1/cmnotify_8c-source.html">cmnotify.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00607">_CM_POST_BLOCK_UNION::AsyncUser</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03764">CmpFreePostBlock()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01634">CmpFreeSlavePost()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00048">CmpRemoveEntryList</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l02019">CmpSetIoStatus</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00266">CMS_NOTIFY</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00596">_CM_ASYNC_USER_POST_BLOCK::IoStatusBlock</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00251">_KAPC::SystemArgument2</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00616">_CM_POST_BLOCK::ThreadList</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00620">_CM_POST_BLOCK::u</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00594">_CM_ASYNC_USER_POST_BLOCK::UserEvent</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>.
<p>
<pre class="fragment"><div>00927                    :
00928 
00929     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to clear away apcs in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> apc queue
00930     of a thread that has been terminated.
00931 
00932     Since <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> apc <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> apc queue, we know that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> NOT in
00933     any NotifyBlock's post list.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>, however, in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> threads's
00934     PostBlockList.
00935 
00936     Therefore, poke any user events so that waiters are not stuck,
00937     drop <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> references so <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event can be cleaned up, delist <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00938     PostBlock and free <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
00939 
00940     Since we are cleaning up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread, SystemEvents are not interesting.
00941 
00942     Since <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> apc <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> apc queue, we know that <span class="keywordflow">if</span> there were any other
00943     notifications related to <span class="keyword">this</span> one, they are cleaned up by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00944     CmPostNotify routine
00945 
00946 Arguments:
00947 
00948     Apc - pointer to apc object
00949 
00950 Return Value:
00951 
00952     NONE.
00953 
00954 --*/
00955 {
00956     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>  PostBlock;
00957     KIRQL           OldIrql;
00958 
00959     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00960     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_NOTIFY) {
00961         KdPrint((<span class="stringliteral">"CmpApcRunDown:"</span>));
00962         KdPrint((<span class="stringliteral">"\tApc:%08lx \n"</span>, Apc));
00963     }
00964 
00965     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(APC_LEVEL, &amp;OldIrql);
00966 
00967     PostBlock = (<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>)Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o10">SystemArgument2</a>;
00968 
00969     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_NOTIFY) {
00970 <span class="preprocessor">#if DBG</span>
00971 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
00972             KdPrint((<span class="stringliteral">"[CM]CmpPostApcRunDown: PostBlock:%08lx\n"</span>, PostBlock));
00973         }
00974 <span class="preprocessor">#endif</span>
00975 <span class="preprocessor"></span>    }
00976 
00977     <span class="comment">//</span>
00978     <span class="comment">// report status and wake up any threads that might otherwise</span>
00979     <span class="comment">// be stuck.  also drop any event references we hold</span>
00980     <span class="comment">//</span>
00981     <span class="comment">//  Sundown only: Use a 32bit IO_STATUS_BLOCK if the caller is 32bit. </span>
00982 
00983     <span class="keywordflow">try</span> {
00984         <a class="code" href="../../d1/d2/cmp_8h.html#a151">CmpSetIoStatus</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o2">IoStatusBlock</a>, 
00985                        STATUS_NOTIFY_CLEANUP, 
00986                        0L, 
00987                        <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Wow64Process != NULL);
00988     } except (EXCEPTION_EXECUTE_HANDLER) {
00989         NOTHING;
00990     }
00991 
00992     <span class="keywordflow">if</span> (PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o0">UserEvent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00993         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(
00994             PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o0">UserEvent</a>,
00995             0,
00996             FALSE
00997             );
00998         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o0">UserEvent</a>);
00999     }
01000 
01001     <span class="comment">//</span>
01002     <span class="comment">// delist the post block</span>
01003     <span class="comment">//</span>
01004     <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01005     <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o1">ThreadList</a>));
01006 
01007         <span class="comment">//</span>
01008         <span class="comment">// Free the slave post block to avoid "dangling" postblocks</span>
01009         <span class="comment">//</span>
01010         <a class="code" href="../../d0/d2/cmnotify_8c.html#a4">CmpFreeSlavePost</a>(PostBlock);
01011     <span class="comment">//</span>
01012     <span class="comment">// Free the post block.  Use Ex call because PostBlocks are NOT</span>
01013     <span class="comment">// part of the global registry pool computation, but are instead</span>
01014     <span class="comment">// part of NonPagedPool with Quota.</span>
01015     <span class="comment">//</span>
01016     <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(PostBlock);
01017 
01018     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
01019 
01020     <span class="keywordflow">return</span>;
01021 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a284" doxytag="cmp.h::CmpPostNotify" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpPostNotify           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifyBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUNICODE_STRING <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Filter</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>NTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>Status</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PLIST_ENTRY ExternalKeyDeref&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00487">487</a> of file <a class="el" href="../../d1/d1/cmnotify_8c-source.html">cmnotify.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00595">_CM_ASYNC_USER_POST_BLOCK::Apc</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00345">ASSERT_CM_LOCK_OWNED</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00607">_CM_POST_BLOCK_UNION::AsyncUser</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00617">_CM_POST_BLOCK::CancelPostList</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00634">ClearMasterPostBlockFlag</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01845">CmpAddToDelayedDeref()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01738">CmpCancelSlavePost()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00054">CmpClearListEntry</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01900">CmpDelayedDerefKeys()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03764">CmpFreePostBlock()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01515">CmpInitializeKeyNameString()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00048">CmpRemoveEntryList</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00266">CMS_NOTIFY</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00375">ExQueueWorkItem()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d1/rtnotify_8c-source.html#l00075">Filter</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00632">IsMasterPostBlock</a>, <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00217">KeInsertQueueApc()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00560">_CM_NOTIFY_BLOCK::KeyControlBlock</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00295">_CM_KEY_CONTROL_BLOCK::KeyNode</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00643">LOCK_POST_LIST</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00034">MAX_KEY_NAME_LENGTH</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00615">_CM_POST_BLOCK::NotifyList</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00566">_CM_NOTIFY_BLOCK::NotifyPending</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00619">_CM_POST_BLOCK::NotifyType</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a335a206">PostAsyncKernel</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a335a205">PostAsyncUser</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00630">PostBlockType</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00563">_CM_NOTIFY_BLOCK::PostList</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a335a204">PostSynchronous</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00633">SetMasterPostBlockFlag</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00590">_CM_SYNC_POST_BLOCK::Status</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00606">_CM_POST_BLOCK_UNION::Sync</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00589">_CM_SYNC_POST_BLOCK::SystemEvent</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00616">_CM_POST_BLOCK::ThreadList</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00620">_CM_POST_BLOCK::u</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00644">UNLOCK_POST_LIST</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/cmclose_8c-source.html#l00028">CmpCloseKeyObject()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01235">CmpFlushNotify()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01378">CmpNotifyChangeKey()</a>, and <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00357">CmpReportNotifyHelper()</a>.
<p>
<pre class="fragment"><div>00496                    :
00497 
00498     Actually report <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify event by signalling events, enqueing
00499     APCs, and so forth.
00500 
00501     When <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> STATUS_NOTIFY_CLEANUP:
00502 
00503       - <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> post block <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a slave one, just cancel <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
00504       - <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> post block <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a master one, cancel all slave post blocks
00505         and trigger event on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> master block.
00506 
00507 Comments:
00508     
00509     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keyword">using</span> a <span class="stringliteral">"delayed dereferencing"</span> technique to prevent
00510     deadlocks that may appear when a keybody <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> dereferenced <span class="keywordflow">while</span> holding
00511     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> post block lock. As <span class="keywordflow">for</span> <span class="keyword">this</span>, a list with keybodies that have to be 
00512     dereferenced <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> constructed <span class="keywordflow">while</span> walking <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of postblocks attached
00513     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current notify block and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> related (slave or master) post blocks.
00514     The list <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> built by tricking postblocks. For all postblock about to be 
00515     freed <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PostKeyBody member <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> added to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> local list and then set to <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00516     on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> postblock. This will avoid <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key body dereferencing in <a class="code" href="../../d1/d2/cmp_8h.html#a286">CmpFreePostBlock</a>.
00517     Instead, after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> postblock lock <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> released, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> local list <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> iterated and 
00518     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> keybodies are dereferenced and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> storage <span class="keywordflow">for</span> associated <a class="code" href="../../d6/d6/struct__CM__POST__KEY__BODY.html">CM_POST_KEY_BODY</a> 
00519     objects <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> freed.
00520 
00521   
00522 Arguments:
00523 
00524     NotifyBlock - pointer to structure that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify
00525                   operation.  (Where to post to)
00526 
00527     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> - name of key at which event occurred.
00528 
00529     <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a> - nature of event
00530 
00531     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> - completion status to report
00532 
00533     ExternalKeyDeref - <span class="keyword">this</span> parameter (when not NULL) specifies that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller doesn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> 
00534                     want any keybody to be dereferenced <span class="keywordflow">while</span> in <span class="keyword">this</span> routine
00535 
00536 Return Value:
00537 
00538     NONE.
00539 
00540 --*/
00541 {
00542     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>      PostBlock;
00543     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>      SlavePostBlock;
00544     LIST_ENTRY          LocalDelayedDeref;
00545     KIRQL               OldIrql;
00546     PLIST_ENTRY         DelayedDeref;
00547 
00548     <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>;
00549     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
00550 
00551     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00552     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_NOTIFY) {
00553         KdPrint((<span class="stringliteral">"CmpPostNotify:\n"</span>));
00554         KdPrint((<span class="stringliteral">"\tNotifyBlock:%08lx  "</span>, NotifyBlock));
00555         KdPrint((<span class="stringliteral">"\tName = %wZ\n"</span>, Name));
00556         KdPrint((<span class="stringliteral">"\tFilter:%08lx  Status=%08lx\n"</span>, Filter, Status));
00557     }
00558     <a class="code" href="../../d1/d2/cmp_8h.html#a61">ASSERT_CM_LOCK_OWNED</a>();
00559 
00560     <span class="keywordflow">if</span>( ARGUMENT_PRESENT(ExternalKeyDeref) ) {
00561         <span class="comment">//</span>
00562         <span class="comment">// The caller want to do all keybody dereferencing by himself</span>
00563         <span class="comment">//</span>
00564         DelayedDeref = ExternalKeyDeref;
00565     } <span class="keywordflow">else</span> {
00566         <span class="comment">// local delayed dereferencing (the caller doesn't care!)</span>
00567         DelayedDeref = &amp;LocalDelayedDeref;
00568         InitializeListHead(DelayedDeref);
00569     }
00570 
00571     <span class="comment">//</span>
00572     <span class="comment">// Aquire exclusive access over the postlist(s)</span>
00573     <span class="comment">//</span>
00574     <a class="code" href="../../d1/d2/cmp_8h.html#a92">LOCK_POST_LIST</a>();
00575 
00576     <span class="keywordflow">if</span> (IsListEmpty(&amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o4">PostList</a>)) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00577         <span class="comment">//</span>
00578         <span class="comment">// Nothing to post, set a mark and return</span>
00579         <span class="comment">//</span>
00580         NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o7">NotifyPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00581         <a class="code" href="../../d1/d2/cmp_8h.html#a93">UNLOCK_POST_LIST</a>();
00582         <span class="keywordflow">return</span>;
00583     }
00584     NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o7">NotifyPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00585 
00586     <span class="comment">//</span>
00587     <span class="comment">// IMPLEMENTATION NOTE:</span>
00588     <span class="comment">//      If we ever want to actually implement the code that returns</span>
00589     <span class="comment">//      names of things that changed, this is the place to add the</span>
00590     <span class="comment">//      name and operation type to the buffer.</span>
00591     <span class="comment">//</span>
00592 
00593     <span class="comment">//</span>
00594     <span class="comment">// Pull and post all the entries in the post list</span>
00595     <span class="comment">//</span>
00596     <span class="keywordflow">while</span> (IsListEmpty(&amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o4">PostList</a>)) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00597 
00598         <span class="comment">//</span>
00599         <span class="comment">// Remove from the notify block list, and enqueue the apc.</span>
00600         <span class="comment">// The apc will remove itself from the thread list</span>
00601         <span class="comment">//</span>
00602         PostBlock = (<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>)RemoveHeadList(&amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o4">PostList</a>));
00603         PostBlock = CONTAINING_RECORD(PostBlock,
00604                                       <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">CM_POST_BLOCK</a>,
00605                                       NotifyList);
00606 
00607         <span class="comment">// Protect for multiple deletion of the same object</span>
00608         <a class="code" href="../../d1/d2/cmp_8h.html#a2">CmpClearListEntry</a>(&amp;(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>));
00609         
00610         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_NOTIFY) {
00611 <span class="preprocessor">#if DBG</span>
00612 <span class="preprocessor"></span>            <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
00613                 WCHAR                   *NameBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00614                 UNICODE_STRING          <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
00615 
00616                 NameBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, MAX_KEY_NAME_LENGTH);
00617                 <span class="keywordflow">if</span>(NameBuffer) {
00618                    <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a14">CmpInitializeKeyNameString</a>(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o17">KeyNode</a>,&amp;KeyName,NameBuffer);
00619                    KdPrint((<span class="stringliteral">"[CM]CmpPostNotify: NotifyBlock:%08lx\tKey = %.*S\n"</span>,NotifyBlock,<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length / <span class="keyword">sizeof</span>(WCHAR),<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer));
00620                    <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NameBuffer);
00621                 }
00622                 KdPrint((<span class="stringliteral">"[CM]\tCmpPostNotify: PostBlock:%08lx\n"</span>, PostBlock));
00623             }
00624 <span class="preprocessor">#endif</span>
00625 <span class="preprocessor"></span>        }
00626 
00627         <span class="keywordflow">if</span>( (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NOTIFY_CLEANUP) &amp;&amp; !<a class="code" href="../../d1/d2/cmp_8h.html#a89">IsMasterPostBlock</a>(PostBlock) ) {
00628             <span class="comment">//</span>
00629             <span class="comment">// Cleanup notification (i.e. the key handle was closed or the key was deleted)</span>
00630             <span class="comment">// When the post is a slave one, just cancel it. Canceling means:</span>
00631             <span class="comment">//      1. Removing from the notify PostList (aldready done at this point - see above)</span>
00632             <span class="comment">//      2. Unchaining from the Master Block CancelPostList</span>
00633             <span class="comment">//      3. Delisting from the thread PostBlockList</span>
00634             <span class="comment">//      4. Actually freeing the memory</span>
00635             <span class="comment">//</span>
00636 
00637             <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
00638             <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o2">CancelPostList</a>));
00639             <span class="comment">//</span>
00640             <span class="comment">// FIX 289351</span>
00641             <span class="comment">//</span>
00642             <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
00643             <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(APC_LEVEL, &amp;OldIrql);
00644             <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o1">ThreadList</a>));
00645             <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00646 
00647             <span class="keywordflow">if</span>( PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o4">NotifyType</a> != <a class="code" href="../../d1/d2/cmp_8h.html#a335a204">PostSynchronous</a> ) {
00648 
00649                 <span class="comment">// add to the deref list and clean the post block</span>
00650                 <a class="code" href="../../d0/d2/cmnotify_8c.html#a5">CmpAddToDelayedDeref</a>(PostBlock,DelayedDeref);
00651 
00652                 <span class="comment">//</span>
00653                 <span class="comment">// Front-end routine will do self cleanup for syncrounous notifications</span>
00654                 <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(PostBlock);
00655             }
00656 
00657             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_NOTIFY) {
00658 <span class="preprocessor">#if DBG</span>
00659 <span class="preprocessor"></span>                <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
00660                     KdPrint((<span class="stringliteral">"[CM]\tCmpPostNotify: PostBlock:%08lx is a slave block,and notify is CLEANUP==&gt; just cleanning\n"</span>, PostBlock));
00661                 }
00662 <span class="preprocessor">#endif</span>
00663 <span class="preprocessor"></span>            }
00664 
00665             <span class="keywordflow">continue</span>; <span class="comment">//try the next one</span>
00666         }
00667 
00668         <span class="comment">//</span>
00669         <span class="comment">// Simulate that this block is the master one, so we can free the others</span>
00670         <span class="comment">// Doing that will ensure the right memory dealocation when the master</span>
00671         <span class="comment">// (from now on this block) will be freed.</span>
00672         <span class="comment">//</span>
00673         <span class="keywordflow">if</span>(!<a class="code" href="../../d1/d2/cmp_8h.html#a89">IsMasterPostBlock</a>(PostBlock)) {
00674             <span class="comment">//</span>
00675             <span class="comment">// oops.,this is not the master block, we have some more work to do</span>
00676             <span class="comment">//</span>
00677             SlavePostBlock = PostBlock;
00678             <span class="keywordflow">do</span> {
00679                 SlavePostBlock = (<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>)SlavePostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o2">CancelPostList</a>.Flink;
00680                 SlavePostBlock = CONTAINING_RECORD(SlavePostBlock,
00681                                                    <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">CM_POST_BLOCK</a>,
00682                                                    CancelPostList);
00683                 <span class="comment">//</span>
00684                 <span class="comment">// reset the "master flag" if set</span>
00685                 <span class="comment">//</span>
00686                 <a class="code" href="../../d1/d2/cmp_8h.html#a91">ClearMasterPostBlockFlag</a>(SlavePostBlock);
00687             } <span class="keywordflow">while</span> (SlavePostBlock != PostBlock);
00688 
00689             <span class="comment">//</span>
00690             <span class="comment">// Make this post block the master one</span>
00691             <span class="comment">//</span>
00692             <a class="code" href="../../d1/d2/cmp_8h.html#a90">SetMasterPostBlockFlag</a>(PostBlock);
00693         }
00694 
00695         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_NOTIFY) {
00696 <span class="preprocessor">#if DBG</span>
00697 <span class="preprocessor"></span>            <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
00698                 KdPrint((<span class="stringliteral">"[CM]\tCmpPostNotify: Master block switched to :%08lx\n"</span>, PostBlock));
00699             }
00700 <span class="preprocessor">#endif</span>
00701 <span class="preprocessor"></span>        }
00702 
00703         <span class="comment">//</span>
00704         <span class="comment">// Cancel all slave Post requests that may be linked to self</span>
00705         <span class="comment">//</span>
00706 
00707         <span class="keywordflow">if</span>( <a class="code" href="../../d1/d2/cmp_8h.html#a88">PostBlockType</a>(PostBlock) != <a class="code" href="../../d1/d2/cmp_8h.html#a335a204">PostSynchronous</a> ) {
00708             <span class="comment">//</span>
00709             <span class="comment">// Front-end routine will do self cleanup for syncrounous notifications</span>
00710             <a class="code" href="../../d0/d2/cmnotify_8c.html#a3">CmpCancelSlavePost</a>(PostBlock,DelayedDeref);
00711             <span class="comment">//</span>
00712             <span class="comment">// Do the same for the master (in case master and slave got switched)</span>
00713             <span class="comment">// This will avoid dereferencing the keybody from CmpPostApc</span>
00714             <a class="code" href="../../d0/d2/cmnotify_8c.html#a5">CmpAddToDelayedDeref</a>(PostBlock,DelayedDeref);
00715         }
00716 
00717         <span class="keywordflow">switch</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a88">PostBlockType</a>(PostBlock)) {
00718             <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a335a204">PostSynchronous</a>:
00719                 <span class="comment">//</span>
00720                 <span class="comment">// This is a SYNC notify call.  There will be no user event,</span>
00721                 <span class="comment">// and no user apc routine.  Quick exit here, just fill in</span>
00722                 <span class="comment">// the Status and poke the event.</span>
00723                 <span class="comment">//</span>
00724                 <span class="comment">// Holder of the systemevent will wake up and free the</span>
00725                 <span class="comment">// postblock.  If we free it here, we get a race &amp; bugcheck.</span>
00726                 <span class="comment">//</span>
00727                 <span class="comment">// Set the flink to NULL so that the front side can tell this</span>
00728                 <span class="comment">// has been removed if its wait aborts.</span>
00729                 <span class="comment">//</span>
00730                 PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00731                 PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o0">Sync</a>.<a class="code" href="../../d7/d6/struct__CM__SYNC__POST__BLOCK.html#o1">Status</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00732                 <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o0">Sync</a>.<a class="code" href="../../d7/d6/struct__CM__SYNC__POST__BLOCK.html#o0">SystemEvent</a>,
00733                            0,
00734                            FALSE);
00735                 <span class="keywordflow">break</span>;
00736 
00737             <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a335a205">PostAsyncUser</a>:
00738                 <span class="comment">//</span>
00739                 <span class="comment">// Insert the APC into the queue</span>
00740                 <span class="comment">//</span>
00741                 <a class="code" href="../../d5/d7/apcobj_8c.html#a3">KeInsertQueueApc</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o1">Apc</a>,
00742                                  (PVOID)ULongToPtr(Status),
00743                                  (PVOID)PostBlock,
00744                                  0);
00745                 <span class="keywordflow">break</span>;
00746 
00747             <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a335a206">PostAsyncKernel</a>:
00748                 <span class="comment">//</span>
00749                 <span class="comment">// Queue the work item, then free the post block.</span>
00750                 <span class="comment">//</span>
00751                 <span class="keywordflow">if</span> (PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o2">AsyncKernel</a>.<a class="code" href="../../d0/d3/struct__CM__ASYNC__KERNEL__POST__BLOCK.html#o1">WorkItem</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00752                     <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o2">AsyncKernel</a>.<a class="code" href="../../d0/d3/struct__CM__ASYNC__KERNEL__POST__BLOCK.html#o1">WorkItem</a>,
00753                                     PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o2">AsyncKernel</a>.<a class="code" href="../../d0/d3/struct__CM__ASYNC__KERNEL__POST__BLOCK.html#o2">QueueType</a>);
00754                 }
00755                 <span class="comment">//</span>
00756                 <span class="comment">// Signal Event if present, and deref it.</span>
00757                 <span class="comment">//</span>
00758                 <span class="keywordflow">if</span> (PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o2">AsyncKernel</a>.<a class="code" href="../../d0/d3/struct__CM__ASYNC__KERNEL__POST__BLOCK.html#o0">Event</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00759                     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o2">AsyncKernel</a>.<a class="code" href="../../d0/d3/struct__CM__ASYNC__KERNEL__POST__BLOCK.html#o0">Event</a>,
00760                                0,
00761                                FALSE);
00762                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o2">AsyncKernel</a>.<a class="code" href="../../d0/d3/struct__CM__ASYNC__KERNEL__POST__BLOCK.html#o0">Event</a>);
00763                 }
00764 
00765                                 <span class="comment">//</span>
00766                                 <span class="comment">// Multiple async kernel notification are not allowed</span>
00767                                 <span class="comment">//</span>
00768                                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IsListEmpty(&amp;(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o2">CancelPostList</a>)) == TRUE);
00769                                 <span class="comment">//</span>
00770                 <span class="comment">// remove the post block from the thread list, and free it</span>
00771                 <span class="comment">//</span>
00772                 <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
00773                 <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(APC_LEVEL, &amp;OldIrql);
00774                 <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o1">ThreadList</a>));
00775                 <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00776                 
00777                 <span class="comment">// it was already added to delayed deref.</span>
00778                 <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(PostBlock);
00779                 <span class="keywordflow">break</span>;
00780         }
00781     }
00782 
00783     <a class="code" href="../../d1/d2/cmp_8h.html#a93">UNLOCK_POST_LIST</a>();
00784 
00785     <span class="comment">//</span>
00786     <span class="comment">// At this point we have a list of keybody elements that have to be dereferenciated</span>
00787     <span class="comment">// and the associated storage for the covering objects freed. The keybodies in this </span>
00788     <span class="comment">// list have only one reference count on them (they were referenced only in </span>
00789     <span class="comment">// NtNotifyChangeMultipleKeys), dereferencing them here should free the object</span>
00790     <span class="comment">//</span>
00791 
00792     <span class="keywordflow">if</span>( ARGUMENT_PRESENT(ExternalKeyDeref) ) {
00793         <span class="comment">// do nothing; the caller wants to handle the dereferenciation by himself!</span>
00794     } <span class="keywordflow">else</span> {
00795         <span class="comment">// dereferenciate all keybodies in the delayed list</span>
00796         <a class="code" href="../../d0/d2/cmnotify_8c.html#a6">CmpDelayedDerefKeys</a>(DelayedDeref);
00797     }
00798    
00799     <span class="keywordflow">return</span>;
00800 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a259" doxytag="cmp.h::CmpQueryKeyData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpQueryKeyData           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Node</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>KEY_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ResultLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00110">110</a> of file <a class="el" href="../../d0/d2/cmsubs2_8c-source.html">cmsubs2.c</a>.
<p>
References <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00045">ALIGN_OFFSET</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00464">_CM_KEY_NODE::Class</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00476">_CM_KEY_NODE::ClassLength</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00151">CmpCopyCompressedName()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00673">CmpHKeyNameLen</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00332">_CHILD_LIST::Count</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00440">KEY_COMP_NAME</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00552">_KEY_INFORMATION::KeyBasicInformation</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00554">_KEY_INFORMATION::KeyFullInformation</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00553">_KEY_INFORMATION::KeyNodeInformation</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00451">_CM_KEY_NODE::LastWriteTime</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00466">_CM_KEY_NODE::MaxClassLen</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00465">_CM_KEY_NODE::MaxNameLen</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00468">_CM_KEY_NODE::MaxValueDataLen</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00467">_CM_KEY_NODE::MaxValueNameLen</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00477">_CM_KEY_NODE::Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00475">_CM_KEY_NODE::NameLength</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00454">_CM_KEY_NODE::SubKeyCounts</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00458">_CM_KEY_NODE::ValueList</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00285">CmEnumerateKey()</a>, and <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00647">CmQueryKey()</a>.
<p>
<pre class="fragment"><div>00120                    :
00121 
00122     Do <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual copy of data <span class="keywordflow">for</span> a key into caller's buffer.
00123 
00124     If KeyInformation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not <span class="keywordtype">long</span> enough to hold all requested data,
00125     STATUS_BUFFER_OVERFLOW will be returned, and ResultLength will be
00126     set to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes actually required.
00127 
00128 Arguments:
00129 
00130     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive
00131 
00132     Node - Supplies pointer to node whose subkeys are to be found
00133 
00134     KeyInformationClass - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of information returned in
00135         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>.  One of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following types:
00136 
00137         KeyBasicInformation - <span class="keywordflow">return</span> last write time, title index, and name.
00138             (see KEY_BASIC_INFORMATION structure)
00139 
00140         KeyNodeInformation - <span class="keywordflow">return</span> last write time, title index, name, <span class="keyword">class</span>.
00141             (see KEY_NODE_INFORMATION structure)
00142 
00143     KeyInformation -Supplies pointer to buffer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data.
00144 
00145     Length - Length of KeyInformation in bytes.
00146 
00147     ResultLength - Number of bytes actually written into KeyInformation.
00148 
00149 Return Value:
00150 
00151     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
00152 
00153         &lt;TBS&gt;
00154 
00155 --*/
00156 {
00157     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00158     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  pclass;
00159     ULONG       requiredlength;
00160     LONG        leftlength;
00161     ULONG       offset;
00162     ULONG       minimumlength;
00163     <a class="code" href="../../d5/d6/union__KEY__INFORMATION.html">PKEY_INFORMATION</a> pbuffer;
00164     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>      NameLength;
00165 
00166     pbuffer = (<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html">PKEY_INFORMATION</a>)KeyInformation;
00167     NameLength = <a class="code" href="../../d1/d2/cmp_8h.html#a96">CmpHKeyNameLen</a>(Node);
00168 
00169     <span class="keywordflow">switch</span> (KeyInformationClass) {
00170 
00171     <span class="keywordflow">case</span> KeyBasicInformation:
00172 
00173         <span class="comment">//</span>
00174         <span class="comment">// LastWriteTime, TitleIndex, NameLength, Name</span>
00175 
00176         requiredlength = FIELD_OFFSET(KEY_BASIC_INFORMATION, Name) +
00177                          NameLength;
00178 
00179         minimumlength = FIELD_OFFSET(KEY_BASIC_INFORMATION, Name);
00180 
00181         *ResultLength = requiredlength;
00182 
00183         status = STATUS_SUCCESS;
00184 
00185         <span class="keywordflow">if</span> (Length &lt; minimumlength) {
00186 
00187             status = STATUS_BUFFER_TOO_SMALL;
00188 
00189         } <span class="keywordflow">else</span> {
00190 
00191             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o0">KeyBasicInformation</a>.LastWriteTime =
00192                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o2">LastWriteTime</a>;
00193 
00194             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o0">KeyBasicInformation</a>.TitleIndex = 0;
00195 
00196             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o0">KeyBasicInformation</a>.NameLength =
00197                 NameLength;
00198 
00199             leftlength = Length - minimumlength;
00200 
00201             requiredlength = NameLength;
00202 
00203             <span class="keywordflow">if</span> (leftlength &lt; (LONG)requiredlength) {
00204                 requiredlength = leftlength;
00205                 status = STATUS_BUFFER_OVERFLOW;
00206             }
00207 
00208             <span class="keywordflow">if</span> (Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>) {
00209                 <a class="code" href="../../d1/d2/cmp_8h.html#a318">CmpCopyCompressedName</a>(pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o0">KeyBasicInformation</a>.Name,
00210                                       leftlength,
00211                                       Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,
00212                                       Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
00213             } <span class="keywordflow">else</span> {
00214                 RtlCopyMemory(
00215                     &amp;(pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o0">KeyBasicInformation</a>.Name[0]),
00216                     &amp;(Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>[0]),
00217                     requiredlength
00218                     );
00219             }
00220         }
00221 
00222         <span class="keywordflow">break</span>;
00223 
00224 
00225     <span class="keywordflow">case</span> KeyNodeInformation:
00226 
00227         <span class="comment">//</span>
00228         <span class="comment">// LastWriteTime, TitleIndex, ClassOffset, ClassLength</span>
00229         <span class="comment">// NameLength, Name, Class</span>
00230         <span class="comment">//</span>
00231         requiredlength = FIELD_OFFSET(KEY_NODE_INFORMATION, Name) +
00232                          NameLength +
00233                          Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a>;
00234 
00235         minimumlength = FIELD_OFFSET(KEY_NODE_INFORMATION, Name);
00236 
00237         *ResultLength = requiredlength;
00238 
00239         status = STATUS_SUCCESS;
00240 
00241         <span class="keywordflow">if</span> (Length &lt; minimumlength) {
00242 
00243             status = STATUS_BUFFER_TOO_SMALL;
00244 
00245         } <span class="keywordflow">else</span> {
00246 
00247             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o1">KeyNodeInformation</a>.LastWriteTime =
00248                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o2">LastWriteTime</a>;
00249 
00250             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o1">KeyNodeInformation</a>.TitleIndex = 0;
00251 
00252             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o1">KeyNodeInformation</a>.ClassLength =
00253                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a>;
00254 
00255             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o1">KeyNodeInformation</a>.NameLength =
00256                 NameLength;
00257 
00258             leftlength = Length - minimumlength;
00259             requiredlength = NameLength;
00260 
00261             <span class="keywordflow">if</span> (leftlength &lt; (LONG)requiredlength) {
00262                 requiredlength = leftlength;
00263                 status = STATUS_BUFFER_OVERFLOW;
00264             }
00265 
00266             <span class="keywordflow">if</span> (Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>) {
00267                 <a class="code" href="../../d1/d2/cmp_8h.html#a318">CmpCopyCompressedName</a>(pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o1">KeyNodeInformation</a>.Name,
00268                                       leftlength,
00269                                       Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,
00270                                       Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
00271             } <span class="keywordflow">else</span> {
00272                 RtlCopyMemory(
00273                     &amp;(pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o1">KeyNodeInformation</a>.Name[0]),
00274                     &amp;(Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>[0]),
00275                     requiredlength
00276                     );
00277             }
00278 
00279             <span class="keywordflow">if</span> (Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a> &gt; 0) {
00280 
00281                 offset = FIELD_OFFSET(KEY_NODE_INFORMATION, Name) +
00282                             NameLength;
00283                 offset = <a class="code" href="../../d9/d2/cmsubs2_8c.html#a0">ALIGN_OFFSET</a>(offset);
00284 
00285                 pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o1">KeyNodeInformation</a>.ClassOffset = offset;
00286 
00287                 pclass = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o10">Class</a>);
00288 
00289                 pbuffer = (<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html">PKEY_INFORMATION</a>)((PUCHAR)pbuffer + offset);
00290 
00291                 leftlength = (((LONG)Length - (LONG)offset) &lt; 0) ?
00292                                     0 :
00293                                     Length - offset;
00294 
00295                 requiredlength = Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a>;
00296 
00297                 <span class="keywordflow">if</span> (leftlength &lt; (LONG)requiredlength) {
00298                     requiredlength = leftlength;
00299                     status = STATUS_BUFFER_OVERFLOW;
00300                 }
00301 
00302                 RtlMoveMemory(
00303                     pbuffer,
00304                     pclass,
00305                     requiredlength
00306                     );
00307 
00308             } <span class="keywordflow">else</span> {
00309                 pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o1">KeyNodeInformation</a>.ClassOffset = (ULONG)-1;
00310             }
00311         }
00312 
00313         <span class="keywordflow">break</span>;
00314 
00315 
00316     <span class="keywordflow">case</span> KeyFullInformation:
00317 
00318         <span class="comment">//</span>
00319         <span class="comment">// LastWriteTime, TitleIndex, ClassOffset, ClassLength,</span>
00320         <span class="comment">// SubKeys, MaxNameLen, MaxClassLen, Values, MaxValueNameLen,</span>
00321         <span class="comment">// MaxValueDataLen, Class</span>
00322         <span class="comment">//</span>
00323         requiredlength = FIELD_OFFSET(KEY_FULL_INFORMATION, Class) +
00324                          Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a>;
00325 
00326         minimumlength = FIELD_OFFSET(KEY_FULL_INFORMATION, Class);
00327 
00328         *ResultLength = requiredlength;
00329 
00330         status = STATUS_SUCCESS;
00331 
00332         <span class="keywordflow">if</span> (Length &lt; minimumlength) {
00333 
00334             status = STATUS_BUFFER_TOO_SMALL;
00335 
00336         } <span class="keywordflow">else</span> {
00337 
00338             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.LastWriteTime =
00339                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o2">LastWriteTime</a>;
00340 
00341             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.TitleIndex = 0;
00342 
00343             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.ClassLength =
00344                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a>;
00345 
00346             <span class="keywordflow">if</span> (Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a> &gt; 0) {
00347 
00348                 pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.ClassOffset =
00349                         FIELD_OFFSET(KEY_FULL_INFORMATION, Class);
00350 
00351                 pclass = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o10">Class</a>);
00352 
00353                 leftlength = Length - minimumlength;
00354                 requiredlength = Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a>;
00355 
00356                 <span class="keywordflow">if</span> (leftlength &lt; (LONG)requiredlength) {
00357                     requiredlength = leftlength;
00358                     status = STATUS_BUFFER_OVERFLOW;
00359                 }
00360 
00361                 RtlMoveMemory(
00362                     &amp;(pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.Class[0]),
00363                     pclass,
00364                     requiredlength
00365                     );
00366 
00367             } <span class="keywordflow">else</span> {
00368                 pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.ClassOffset = (ULONG)-1;
00369             }
00370 
00371             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.SubKeys =
00372                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] +
00373                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>];
00374 
00375             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.Values =
00376                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a>;
00377 
00378             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.MaxNameLen =
00379                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o11">MaxNameLen</a>;
00380 
00381             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.MaxClassLen =
00382                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o12">MaxClassLen</a>;
00383 
00384             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.MaxValueNameLen =
00385                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o13">MaxValueNameLen</a>;
00386 
00387             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.MaxValueDataLen =
00388                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o14">MaxValueDataLen</a>;
00389 
00390         }
00391 
00392         <span class="keywordflow">break</span>;
00393 
00394 
00395     <span class="keywordflow">default</span>:
00396         status = STATUS_INVALID_PARAMETER;
00397         <span class="keywordflow">break</span>;
00398     }
00399     <span class="keywordflow">return</span> status;
00400 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a211" doxytag="cmp.h::CmpQueryKeyName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpQueryKeyName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>HasObjectName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT POBJECT_NAME_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectNameInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/cmquery_8c-source.html#l00028">28</a> of file <a class="el" href="../../d6/d1/cmquery_8c-source.html">cmquery.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00699">CmpConstructName()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00124">CmpLockRegistry()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00260">CMS_PARSE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00291">ExFreePoolWithTag</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00281">PROTECTED_POOL</a>, <a class="el" href="../../d5/d0/genmips_8c-source.html#l00109">t()</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01074">CmpCreateObjectTypes()</a>.
<p>
<pre class="fragment"><div>00037                    :
00038 
00039     This routine interfaces to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NT Object <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a79">Manager</a>.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked when
00040     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object system wishes to discover <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of an object that
00041     belongs to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry.
00042 
00043 Arguments:
00044 
00045     Object - pointer to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>, thus -&gt; KEY_BODY.
00046 
00047     HasObjectName - indicates whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object manager knows about a name
00048         <span class="keywordflow">for</span> <span class="keyword">this</span> object
00049 
00050     ObjectNameInfo - place where we report <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name
00051 
00052     Length - maximum length they can deal with
00053 
00054     ReturnLength - supplies variable to receive actual length
00055 
00056 Return Value:
00057 
00058     STATUS_SUCCESS
00059 
00060     STATUS_INFO_LENGTH_MISMATCH
00061 
00062 --*/
00063 
00064 {
00065     PUNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
00066     PWCHAR <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>;
00067     PWCHAR s;
00068     ULONG l;
00069     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00070 
00071     UNREFERENCED_PARAMETER(HasObjectName);
00072 
00073     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_PARSE) {
00074         KdPrint((<span class="stringliteral">"CmpQueryKeyName:\n"</span>));
00075     }
00076 
00077     <a class="code" href="../../d6/d3/cmwraper_8c.html#a14">CmpLockRegistry</a>();
00078 
00079     <span class="keywordflow">if</span> ( ((<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)Object)-&gt;KeyControlBlock-&gt;Delete) {
00080         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00081         <span class="keywordflow">return</span> STATUS_KEY_DELETED;
00082     }
00083     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> = <a class="code" href="../../d8/d2/cmsubs_8c.html#a18">CmpConstructName</a>(((<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)Object)-&gt;KeyControlBlock);
00084     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00085         status = STATUS_INSUFFICIENT_RESOURCES;
00086         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00087         <span class="keywordflow">return</span> status;
00088     }
00089 
00090     <span class="keywordflow">if</span> (Length &lt;= <span class="keyword">sizeof</span>(OBJECT_NAME_INFORMATION)) {
00091         *ReturnLength = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length + <span class="keyword">sizeof</span>(WCHAR) + <span class="keyword">sizeof</span>(OBJECT_NAME_INFORMATION);
00092         <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(Name, CM_NAME_TAG | PROTECTED_POOL);
00093         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00094         <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;  <span class="comment">// they can't even handle null</span>
00095     }
00096 
00097     <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> = (PWCHAR)(ObjectNameInfo + 1);
00098     s = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer;
00099     l = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length;
00100     l += <span class="keyword">sizeof</span>(WCHAR);     <span class="comment">// account for null</span>
00101 
00102 
00103     *ReturnLength = l + <span class="keyword">sizeof</span>(OBJECT_NAME_INFORMATION);
00104     <span class="keywordflow">if</span> (l &gt; Length - <span class="keyword">sizeof</span>(OBJECT_NAME_INFORMATION)) {
00105         l = Length - <span class="keyword">sizeof</span>(OBJECT_NAME_INFORMATION);
00106         status = STATUS_INFO_LENGTH_MISMATCH;
00107     } <span class="keywordflow">else</span> {
00108         status = STATUS_SUCCESS;
00109     }
00110     l -= <span class="keyword">sizeof</span>(WCHAR);
00111 
00112     <span class="comment">//</span>
00113     <span class="comment">// The ObjectNameInfo buffer is a usermode buffer, so make sure we have an</span>
00114     <span class="comment">// exception handler in case a malicious app changes the protection out from</span>
00115     <span class="comment">// under us.</span>
00116     <span class="comment">//</span>
00117     <span class="comment">// Note the object manager is responsible for probing the buffer and ensuring</span>
00118     <span class="comment">// that a top-level exception handler returns the correct error code. We just</span>
00119     <span class="comment">// need to make sure we drop our lock.</span>
00120     <span class="comment">//</span>
00121     <span class="keywordflow">try</span> {
00122         RtlMoveMemory(t, s, l);
00123         <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>[l/<span class="keyword">sizeof</span>(WCHAR)] = UNICODE_NULL;
00124         ObjectNameInfo-&gt;Name.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)l;
00125         ObjectNameInfo-&gt;Name.MaximumLength = ObjectNameInfo-&gt;Name.Length;
00126         ObjectNameInfo-&gt;Name.Buffer = <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>;
00127     } finally {
00128         <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(Name, CM_NAME_TAG | PROTECTED_POOL);
00129         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00130     }
00131     <span class="keywordflow">return</span> status;
00132 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a331" doxytag="cmp.h::CmpQueryKeyValueData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpQueryKeyValueData           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PCM_CACHED_VALUE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>ContainingList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueCached</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>KEY_VALUE_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyValueInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyValueInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ResultLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a245" doxytag="cmp.h::CmpQuotaWarningWorker" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpQuotaWarningWorker           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>WorkItem</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00166">166</a> of file <a class="el" href="../../d6/d0/cmgquota_8c-source.html">cmgquota.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d7/ex_2harderr_8c-source.html#l00700">ExRaiseHardError()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00204">CmpClaimGlobalQuota()</a>.
<p>
<pre class="fragment"><div>00172                    :
00173 
00174     Displays hard error popup that indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry quota <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00175     running <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>.
00176 
00177 Arguments:
00178 
00179     WorkItem - Supplies pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> work item. This routine will
00180                free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> work item.
00181 
00182 Return Value:
00183 
00184     None.
00185 
00186 --*/
00187 
00188 {
00189     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00190     ULONG Response;
00191 
00192     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(WorkItem);
00193 
00194     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d8/ex_8h.html#a306">ExRaiseHardError</a>(STATUS_REGISTRY_QUOTA_LIMIT,
00195                               0,
00196                               0,
00197                               NULL,
00198                               OptionOk,
00199                               &amp;Response);
00200 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a332" doxytag="cmp.h::CmpReferenceKeyControlBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpReferenceKeyControlBlock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>KeyControlBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00345">345</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
References <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00807">CmpRemoveFromDelayedClose()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00273">_CM_KEY_CONTROL_BLOCK::RefCount</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01853">CmpCacheLookup()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00824">CmpCreateKeyControlBlock()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00963">CmpDoOpen()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01476">CmpGetSymbolicLink()</a>, and <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>.
<p>
<pre class="fragment"><div>00348 {
00349     <span class="keywordflow">if</span> (KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o1">RefCount</a> == 0) {
00350         <a class="code" href="../../d8/d2/cmsubs_8c.html#a19">CmpRemoveFromDelayedClose</a>(KeyControlBlock);
00351     }
00352 
00353     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o1">RefCount</a> + 1) == 0) {
00354         <span class="comment">//</span>
00355         <span class="comment">// We have maxed out the ref count on this key. Probably</span>
00356         <span class="comment">// some bogus app has opened the same key 64K times without</span>
00357         <span class="comment">// ever closing it. Just fail the call</span>
00358         <span class="comment">//</span>
00359         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00360     } <span class="keywordflow">else</span> {
00361         ++(KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o1">RefCount</a>);
00362         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00363     }
00364 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a248" doxytag="cmp.h::CmpReleaseGlobalQuota" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpReleaseGlobalQuota           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Size</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00265">265</a> of file <a class="el" href="../../d6/d0/cmgquota_8c-source.html">cmgquota.c</a>.
<p>
References <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00063">CmpGlobalQuotaUsed</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, and <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>.
<p>
Referenced by <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00062">CmpAllocate()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00186">CmpFree()</a>, <a class="el" href="../../d3/d0/hivefree_8c-source.html#l00160">HvFreeHivePartial()</a>, <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">HvInitializeHive()</a>, and <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01433">HvWriteHive()</a>.
<p>
<pre class="fragment"><div>00270                    :
00271 
00272     If <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &lt;= <a class="code" href="../../d7/d0/cmdat2_8c.html#a9">CmpGlobalQuotaUsed</a>, then decrement <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.  Else BugCheck.
00273 
00274 Arguments:
00275 
00276     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - number of bytes of GlobalQuota caller wants to release
00277 
00278 Return Value:
00279 
00280     NONE.
00281 
00282 --*/
00283 {
00284     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &gt; <a class="code" href="../../d7/d0/cmdat2_8c.html#a9">CmpGlobalQuotaUsed</a>) {
00285         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR,2,1,0,0);
00286     }
00287 
00288     <a class="code" href="../../d7/d0/cmdat2_8c.html#a9">CmpGlobalQuotaUsed</a> -= <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00289 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a326" doxytag="cmp.h::CmpRemoveFromDelayedClose" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpRemoveFromDelayedClose           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>kcb</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00807">807</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00031">CmpDelayedCloseSize</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00032">CmpDelayedCloseTable</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00034">CmpDelayedFreeIndex</a>, and <a class="el" href="../../d5/d5/regext_8c-source.html#l00458">kcb()</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01853">CmpCacheLookup()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00824">CmpCreateKeyControlBlock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00345">CmpReferenceKeyControlBlock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00180">CmpSearchForOpenSubKeys()</a>, and <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01071">CmpSearchKeyControlBlockTree()</a>.
<p>
<pre class="fragment"><div>00810 {
00811     ULONG i;
00812     i = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;DelayedCloseIndex;
00813 
00814     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (CmpDelayedCloseTable[i] == kcb);
00815     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(i != CmpDelayedCloseSize);
00816 
00817     <a class="code" href="../../d8/d2/cmsubs_8c.html#a5">CmpDelayedCloseTable</a>[i] = (<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>)<a class="code" href="../../d8/d2/cmsubs_8c.html#a7">CmpDelayedFreeIndex</a>;
00818     <a class="code" href="../../d8/d2/cmsubs_8c.html#a7">CmpDelayedFreeIndex</a> = i;
00819     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;DelayedCloseIndex = 0;
00820 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a310" doxytag="cmp.h::CmpRemoveFromHiveFileList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpRemoveFromHiveFileList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a282" doxytag="cmp.h::CmpRemoveKeyControlBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpRemoveKeyControlBlock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>KeyControlBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01260">1260</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
References <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00069">ASSERT_KCB</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01459">CmpRemoveKeyHash()</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00275">_CM_KEY_CONTROL_BLOCK::KeyHash</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/cmapi2_8c-source.html#l00031">CmDeleteKey()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01853">CmpCacheLookup()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00629">CmpCleanUpKcbCacheWithLock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00824">CmpCreateKeyControlBlock()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00226">CmpDoCreateChild()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00180">CmpSearchForOpenSubKeys()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03093">NtUnloadKey()</a>.
<p>
<pre class="fragment"><div>01265                    :
01266 
01267     Remove a key <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> KCB tree.
01268 
01269     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expected that no notify <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> blocks remain.
01270 
01271     The <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> will NOT be freed, call DereferenceKeyControlBlock <span class="keywordflow">for</span> that.
01272 
01273     This call assumes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> KCB tree <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already locked or registry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> locked exclusively.
01274 
01275 Arguments:
01276 
01277     KeyControlBlock - pointer to a key <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block.
01278 
01279 Return Value:
01280 
01281     NONE.
01282 
01283 --*/
01284 {
01285     <a class="code" href="../../d9/d0/cmdata_8h.html#a5">ASSERT_KCB</a>(KeyControlBlock);
01286 
01287     <span class="comment">//</span>
01288     <span class="comment">// Remove the KCB from the hash table</span>
01289     <span class="comment">//</span>
01290     <a class="code" href="../../d8/d2/cmsubs_8c.html#a9">CmpRemoveKeyHash</a>(&amp;KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o2">KeyHash</a>);
01291 
01292     <span class="keywordflow">return</span>;
01293 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a307" doxytag="cmp.h::CmpRemoveSubKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpRemoveSubKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ParentKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetKey</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01714">1714</a> of file <a class="el" href="../../d8/d0/cmindex_8c-source.html">cmindex.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00597">_HHIVE::Allocate</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00373">CM_KEY_FAST_LEAF</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00372">CM_KEY_INDEX_LEAF</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00371">CM_KEY_INDEX_ROOT</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00121">CmpCompressedNameSize()</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00151">CmpCopyCompressedName()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00475">CmpFindSubKeyInLeaf()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00266">CmpFindSubKeyInRoot()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00382">_CM_KEY_FAST_INDEX::Count</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00388">_CM_KEY_INDEX::Count</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00598">_HHIVE::Free</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l01453">HvIsCellAllocated()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00440">KEY_COMP_NAME</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00383">_CM_KEY_FAST_INDEX::List</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00389">_CM_KEY_INDEX::List</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00477">_CM_KEY_NODE::Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00475">_CM_KEY_NODE::NameLength</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00387">_CM_KEY_INDEX::Signature</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00454">_CM_KEY_NODE::SubKeyCounts</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00457">_CM_KEY_NODE::SubKeyLists</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00470">_CM_KEY_NODE::WorkVar</a>.
<p>
Referenced by <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00140">CmpFreeKeyByCell()</a>.
<p>
<pre class="fragment"><div>01721                    :
01722 
01723     Remove <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkey TargetKey refers to from ParentKey's list.
01724 
01725     NOTE:   Assumes that caller has marked relevent cells dirty,
01726             see <a class="code" href="../../d7/d1/cmindex_8c.html#a13">CmpMarkIndexDirty</a>.
01727 
01728 Arguments:
01729 
01730     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> hive of interest
01731 
01732     ParentKey - key from whose subkey list <span class="keyword">delete</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be performed
01733 
01734     TargetKey - key being deleted
01735 
01736 Return Value:
01737 
01738     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> didn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>, some resource problem
01739 
01740 --*/
01741 {
01742     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>    pcell;
01743     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     LeafCell;
01744     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   Leaf;
01745     <a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a> FastIndex;
01746     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     RootCell = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01747     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   Root = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01748     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     Child;
01749     ULONG           Type;
01750     ULONG           RootSelect;
01751     ULONG           LeafSelect;
01752     UNICODE_STRING  SearchName;
01753     BOOLEAN         IsCompressed;
01754     WCHAR           CompressedBuffer[50];
01755 
01756     pcell = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, TargetKey);
01757     <span class="keywordflow">if</span> (pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>) {
01758         IsCompressed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01759         SearchName.Length = <a class="code" href="../../d1/d2/cmp_8h.html#a320">CmpCompressedNameSize</a>(pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>, pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
01760         SearchName.MaximumLength = SearchName.Length;
01761         <span class="keywordflow">if</span> (SearchName.MaximumLength &gt; <span class="keyword">sizeof</span>(CompressedBuffer)) {
01762             SearchName.Buffer = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(SearchName.Length, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01763             <span class="keywordflow">if</span> (SearchName.Buffer==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01764                 <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01765             }
01766         } <span class="keywordflow">else</span> {
01767             SearchName.Buffer = CompressedBuffer;
01768         }
01769         <a class="code" href="../../d1/d2/cmp_8h.html#a318">CmpCopyCompressedName</a>(SearchName.Buffer,
01770                               SearchName.MaximumLength,
01771                               pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,
01772                               pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
01773     } <span class="keywordflow">else</span> {
01774         IsCompressed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01775         SearchName.Length = pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
01776         SearchName.MaximumLength = pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
01777         SearchName.Buffer = &amp;(pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>[0]);
01778     }
01779 
01780     pcell = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ParentKey);
01781     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(TargetKey);
01782 
01783     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[Type] != 0);
01784     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d0/hivecell_8c.html#a21">HvIsCellAllocated</a>(Hive, pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type]));
01785 
01786     LeafCell = pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type];
01787     Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, LeafCell);
01788 
01789     <span class="keywordflow">if</span> (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a18">CM_KEY_INDEX_ROOT</a>) {
01790         RootSelect = <a class="code" href="../../d7/d1/cmindex_8c.html#a2">CmpFindSubKeyInRoot</a>(Hive, Leaf, &amp;SearchName, &amp;Child);
01791 
01792         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Child != FALSE);
01793 
01794         Root = Leaf;
01795         RootCell = LeafCell;
01796         LeafCell = Child;
01797         Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, LeafCell);
01798 
01799     }
01800 
01801     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == CM_KEY_INDEX_LEAF) ||
01802            (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == CM_KEY_FAST_LEAF));
01803 
01804     LeafSelect = <a class="code" href="../../d7/d1/cmindex_8c.html#a3">CmpFindSubKeyInLeaf</a>(Hive, Leaf, pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o15">WorkVar</a>, &amp;SearchName, &amp;Child);
01805 
01806     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Child != HCELL_NIL);
01807 
01808     <span class="comment">//</span>
01809     <span class="comment">// Leaf points to Index Leaf block</span>
01810     <span class="comment">// Child is Index Leaf block cell</span>
01811     <span class="comment">// LeafSelect is Index for List[]</span>
01812     <span class="comment">//</span>
01813     pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[Type] -= 1;
01814 
01815     Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> -= 1;
01816     <span class="keywordflow">if</span> (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> == 0) {
01817 
01818         <span class="comment">//</span>
01819         <span class="comment">// Empty Leaf, drop it.</span>
01820         <span class="comment">//</span>
01821         <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, LeafCell);
01822 
01823         <span class="keywordflow">if</span> (Root != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01824 
01825             Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> -= 1;
01826             <span class="keywordflow">if</span> (Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> == 0) {
01827 
01828                 <span class="comment">//</span>
01829                 <span class="comment">// Root is empty, free it too.</span>
01830                 <span class="comment">//</span>
01831                 <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, RootCell);
01832                 pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01833 
01834             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (RootSelect &lt; (ULONG)(Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a>)) {
01835 
01836                 <span class="comment">//</span>
01837                 <span class="comment">// Middle entry, squeeze root</span>
01838                 <span class="comment">//</span>
01839                 RtlMoveMemory(
01840                     (PVOID)&amp;(Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[RootSelect]),
01841                     (PVOID)&amp;(Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[RootSelect+1]),
01842                     (Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> - RootSelect) * <span class="keyword">sizeof</span>(HCELL_INDEX)
01843                     );
01844             }
01845             <span class="comment">//</span>
01846             <span class="comment">// Else RootSelect == last entry, so decrementing count</span>
01847             <span class="comment">// was all we needed to do</span>
01848             <span class="comment">//</span>
01849 
01850         } <span class="keywordflow">else</span> {
01851 
01852             pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01853 
01854         }
01855 
01856     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (LeafSelect &lt; (ULONG)(Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a>)) {
01857 
01858         <span class="keywordflow">if</span> (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a19">CM_KEY_INDEX_LEAF</a>) {
01859             RtlMoveMemory((PVOID)&amp;(Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[LeafSelect]),
01860                           (PVOID)&amp;(Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[LeafSelect+1]),
01861                           (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> - LeafSelect) * <span class="keyword">sizeof</span>(HCELL_INDEX));
01862         } <span class="keywordflow">else</span> {
01863             FastIndex = (<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a>)Leaf;
01864             RtlMoveMemory((PVOID)&amp;(FastIndex-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[LeafSelect]),
01865                           (PVOID)&amp;(FastIndex-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[LeafSelect+1]),
01866                           (FastIndex-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o1">Count</a> - LeafSelect) * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__CM__INDEX.html">CM_INDEX</a>));
01867         }
01868     }
01869     <span class="comment">//</span>
01870     <span class="comment">// Else LeafSelect == last entry, so decrementing count was enough</span>
01871     <span class="comment">//</span>
01872 
01873     <span class="keywordflow">if</span> ((IsCompressed) &amp;&amp;
01874         (SearchName.MaximumLength &gt; <span class="keyword">sizeof</span>(CompressedBuffer))) {
01875         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(SearchName.Buffer, SearchName.Length);
01876     }
01877     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01878 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a283" doxytag="cmp.h::CmpReportNotify" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpReportNotify           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyControlBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifyMask</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00191">191</a> of file <a class="el" href="../../d1/d1/cmnotify_8c-source.html">cmnotify.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00245">CML_WORKER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00036">CmpMasterHive</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00357">CmpReportNotifyHelper()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00266">CMS_NOTIFY</a>, <a class="el" href="../../d6/d1/rtnotify_8c-source.html#l00075">Filter</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00649">_CMHIVE::Hive</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00434">KEY_HIVE_ENTRY</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00428">KEY_HIVE_EXIT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00453">_CM_KEY_NODE::Parent</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00285">_CM_KEY_CONTROL_BLOCK::ParentKcb</a>.
<p>
<pre class="fragment"><div>00199                    :
00200 
00201     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when a notifiable event occurs. It will
00202     apply <a class="code" href="../../d0/d2/cmnotify_8c.html#a2">CmpReportNotifyHelper</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event occured in,
00203     and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> master hive <span class="keywordflow">if</span> different.
00204 
00205 Arguments:
00206 
00207     KeyControlBlock - KCB of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key at which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event occured.
00208             For create or <span class="keyword">delete</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> created or deleted key.
00209 
00210     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to hive containing cell of <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> at which event occured.
00211 
00212     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - cell of <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> at which event occured
00213 
00214             (hive and cell correspond with name.)
00215 
00216     <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a> - event to be reported
00217 
00218 Return Value:
00219 
00220     NONE.
00221 
00222 --*/
00223 {
00224     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> pcell;
00225     ULONG       flags;
00226     ULONG       i;
00227 
00228     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00229     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_WORKER, CMS_NOTIFY) {
00230         KdPrint((<span class="stringliteral">"CmpReportNotify:\n"</span>));
00231         KdPrint((<span class="stringliteral">"\tHive:%08lx Cell:%08lx Filter:%08lx\n"</span>, Hive, Cell, Filter));
00232     }
00233 
00234     pcell = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);
00235     <span class="comment">//</span>
00236     <span class="comment">// If the operation was create or delete, treat it as a change</span>
00237     <span class="comment">// to the parent.</span>
00238     <span class="comment">//</span>
00239     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a> == REG_NOTIFY_CHANGE_NAME) {
00240         flags = pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a>;
00241         <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a>;
00242         <span class="keywordflow">if</span> (flags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a29">KEY_HIVE_ENTRY</a>) {
00243             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>);
00244             pcell = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);
00245         }
00246 
00247 
00248         KeyControlBlock = KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o9">ParentKcb</a>;
00249 
00250         <span class="comment">//</span>
00251         <span class="comment">// if we're at an exit/link node, back up the real node</span>
00252         <span class="comment">// that MUST be it's parent.</span>
00253         <span class="comment">//</span>
00254         <span class="keywordflow">if</span> (pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a28">KEY_HIVE_EXIT</a>) {
00255             <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a>;
00256         }
00257         pcell = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);
00258     }
00259 
00260     <span class="comment">//</span>
00261     <span class="comment">// Report to notifies waiting on the event's hive</span>
00262     <span class="comment">//</span>
00263     <a class="code" href="../../d0/d2/cmnotify_8c.html#a2">CmpReportNotifyHelper</a>(KeyControlBlock, Hive, Hive, pcell, Filter);
00264 
00265 
00266     <span class="comment">//</span>
00267     <span class="comment">// If containing hive is not the master hive, apply to master hive</span>
00268     <span class="comment">//</span>
00269     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> != &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>)) {
00270         <a class="code" href="../../d0/d2/cmnotify_8c.html#a2">CmpReportNotifyHelper</a>(KeyControlBlock,
00271                               &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>),
00272                               Hive,
00273                               pcell,
00274                               Filter);
00275     }
00276 
00277     <span class="keywordflow">return</span>;
00278 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a301" doxytag="cmp.h::CmpResolveDriverDependencies" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpResolveDriverDependencies           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLIST_ENTRY&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DriverListHead</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00920">920</a> of file <a class="el" href="../../d1/d9/cmboot_8c-source.html">cmboot.c</a>.
<p>
References <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00997">CmpOrderGroup()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00453">_BOOT_DRIVER_NODE::Group</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02169">CmGetSystemDriverList()</a>.
<p>
<pre class="fragment"><div>00926                    :
00927 
00928     This routine orders driver nodes in a group based on their dependencies
00929     on one another.  It removes any drivers that have circular dependencies
00930     from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list.
00931 
00932 Arguments:
00933 
00934     DriverListHead - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> head of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of
00935             boot drivers to be sorted.
00936 
00937 Return Value:
00938 
00939     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - Dependencies successfully resolved
00940 
00941     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - Corrupt hive.
00942 
00943 --*/
00944 
00945 {
00946     PLIST_ENTRY CurrentEntry;
00947     <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">PBOOT_DRIVER_NODE</a> GroupStart;
00948     <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">PBOOT_DRIVER_NODE</a> GroupEnd;
00949     <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">PBOOT_DRIVER_NODE</a> CurrentNode;
00950 
00951     CurrentEntry = DriverListHead-&gt;Flink;
00952 
00953     <span class="keywordflow">while</span> (CurrentEntry != DriverListHead) {
00954         <span class="comment">//</span>
00955         <span class="comment">// The list is already ordered by groups.  Find the first and</span>
00956         <span class="comment">// last entry in each group, and order each of these sub-lists</span>
00957         <span class="comment">// based on their dependencies.</span>
00958         <span class="comment">//</span>
00959 
00960         GroupStart = CONTAINING_RECORD(CurrentEntry,
00961                                        <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">BOOT_DRIVER_NODE</a>,
00962                                        ListEntry.Link);
00963         <span class="keywordflow">do</span> {
00964             GroupEnd = CONTAINING_RECORD(CurrentEntry,
00965                                          <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">BOOT_DRIVER_NODE</a>,
00966                                          ListEntry.Link);
00967 
00968             CurrentEntry = CurrentEntry-&gt;Flink;
00969             CurrentNode = CONTAINING_RECORD(CurrentEntry,
00970                                             <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">BOOT_DRIVER_NODE</a>,
00971                                             ListEntry.Link);
00972 
00973             <span class="keywordflow">if</span> (CurrentEntry == DriverListHead) {
00974                 <span class="keywordflow">break</span>;
00975             }
00976 
00977             <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(&amp;GroupStart-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o1">Group</a>,
00978                                        &amp;CurrentNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o1">Group</a>,
00979                                        TRUE)) {
00980                 <span class="keywordflow">break</span>;
00981             }
00982 
00983         } <span class="keywordflow">while</span> ( CurrentEntry != DriverListHead );
00984 
00985         <span class="comment">//</span>
00986         <span class="comment">// GroupStart now points to the first driver node in the group,</span>
00987         <span class="comment">// and GroupEnd points to the last driver node in the group.</span>
00988         <span class="comment">//</span>
00989         <a class="code" href="../../d0/d0/cmboot_8c.html#a8">CmpOrderGroup</a>(GroupStart, GroupEnd);
00990 
00991     }
00992     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00993 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a293" doxytag="cmp.h::CmpSaveBootControlSet" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpSaveBootControlSet           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ControlSetNum</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a280" doxytag="cmp.h::CmpSearchForOpenSubKeys" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG CmpSearchForOpenSubKeys           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SearchKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d0/cmdata_8h.html#a67">SUBKEY_SEARCH_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SearchType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a215" doxytag="cmp.h::CmpSearchKeyControlBlockTree" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpSearchKeyControlBlockTree           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d1/d2/cmp_8h.html#a184">PKCB_WORKER_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WorkerRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01071">1071</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00069">ASSERT_KCB</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01982">CmpCacheTable</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00629">CmpCleanUpKcbCacheWithLock()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01981">CmpHashTableSize</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00807">CmpRemoveFromDelayedClose()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00266">Context1</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00266">Context2</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00272">_CM_KEY_CONTROL_BLOCK::Delete</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00855">KCB_WORKER_CONTINUE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00857">KCB_WORKER_DELETE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00856">KCB_WORKER_DONE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00278">_CM_KEY_CONTROL_BLOCK::NextHash</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00273">_CM_KEY_CONTROL_BLOCK::RefCount</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00731">CmpRefreshHive()</a>, and <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02079">CmUnloadKey()</a>.
<p>
<pre class="fragment"><div>01078                    :
01079 
01080     Traverse <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> tree.  We will visit all nodes unless WorkerRoutine
01081     tells us to stop part way through.
01082 
01083     For each node, call WorkerRoutine(..., Context1, Contex2).  If <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> returns
01084     <a class="code" href="../../d1/d2/cmp_8h.html#a115">KCB_WORKER_DONE</a>, we are done, simply <span class="keywordflow">return</span>.  If <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> returns
01085     <a class="code" href="../../d1/d2/cmp_8h.html#a114">KCB_WORKER_CONTINUE</a>, just <span class="keywordflow">continue</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> search. If <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> returns <a class="code" href="../../d1/d2/cmp_8h.html#a116">KCB_WORKER_DELETE</a>,
01086     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified KCB <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> marked as deleted.
01087 
01088     This routine has <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> side-effect of removing all delayed-close KCBs.
01089 
01090 Arguments:
01091 
01092     WorkerRoutine - applied to nodes witch Match.
01093 
01094     <a class="code" href="../../d3/d1/threads_8h.html#a107">Context1</a> - data we pass through
01095 
01096     <a class="code" href="../../d3/d1/threads_8h.html#a108">Context2</a> - data we pass through
01097 
01098 
01099 Return Value:
01100 
01101     NONE.
01102 
01103 --*/
01104 {
01105     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   Current;
01106     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   Next;
01107     <a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a> *Prev;
01108     ULONG                   WorkerResult;
01109     ULONG                   i;
01110 
01111     <span class="comment">//</span>
01112     <span class="comment">// Walk the hash table</span>
01113     <span class="comment">//</span>
01114     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d1/d2/cmp_8h.html#a202">CmpHashTableSize</a>; i++) {
01115         Prev = &amp;<a class="code" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a>[i];
01116         <span class="keywordflow">while</span> (*Prev) {
01117             Current = CONTAINING_RECORD(*Prev,
01118                                         <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">CM_KEY_CONTROL_BLOCK</a>,
01119                                         KeyHash);
01120             <a class="code" href="../../d9/d0/cmdata_8h.html#a5">ASSERT_KCB</a>(Current);
01121             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!Current-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o0">Delete</a>);
01122             <span class="keywordflow">if</span> (Current-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o1">RefCount</a> == 0) {
01123                 <span class="comment">//</span>
01124                 <span class="comment">// This kcb is in DelayClose case, remove it.</span>
01125                 <span class="comment">//</span>
01126                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a19">CmpRemoveFromDelayedClose</a>(Current);
01127                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a17">CmpCleanUpKcbCacheWithLock</a>(Current);
01128 
01129                 <span class="comment">//</span>
01130                 <span class="comment">// The HashTable is changed, start over in this index again.</span>
01131                 <span class="comment">//</span>
01132                 Prev = &amp;<a class="code" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a>[i];
01133                 <span class="keywordflow">continue</span>;
01134             }
01135 
01136             WorkerResult = (WorkerRoutine)(Current, <a class="code" href="../../d3/d1/threads_8h.html#a107">Context1</a>, <a class="code" href="../../d3/d1/threads_8h.html#a108">Context2</a>);
01137             <span class="keywordflow">if</span> (WorkerResult == <a class="code" href="../../d1/d2/cmp_8h.html#a115">KCB_WORKER_DONE</a>) {
01138                 <span class="keywordflow">return</span>;
01139             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (WorkerResult == <a class="code" href="../../d1/d2/cmp_8h.html#a116">KCB_WORKER_DELETE</a>) {
01140                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Current-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o0">Delete</a>);
01141                 *Prev = Current-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o4">NextHash</a>;
01142                 <span class="keywordflow">continue</span>;
01143             } <span class="keywordflow">else</span> {
01144                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(WorkerResult == KCB_WORKER_CONTINUE);
01145                 Prev = &amp;Current-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o4">NextHash</a>;
01146             }
01147         }
01148     }
01149 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a214" doxytag="cmp.h::CmpSecurityMethod" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpSecurityMethod           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d5/se_8h.html#a19">SECURITY_OPERATION_CODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OperationCode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSECURITY_DESCRIPTOR *&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectsSecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d1/cmse_8c-source.html#l00158">158</a> of file <a class="el" href="../../d8/d1/cmse_8c-source.html">cmse.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00346">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00530">ASSERT_KEY_OBJECT</a>, <a class="el" href="../../d0/d5/se_8h.html#a200a111">AssignSecurityDescriptor</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00697">CmpAssignSecurityDescriptor()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00124">CmpLockRegistry()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00847">CmpQuerySecurityDescriptorInfo()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00114">CmpReportNotify()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00117">CmpSecurityExceptionFilter()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00397">CmpSetSecurityDescriptorInfo()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00263">CMS_SEC</a>, <a class="el" href="../../d0/d5/se_8h.html#a200a110">DeleteSecurityDescriptor</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/regext_8c-source.html#l00458">kcb()</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01183">ObAssignObjectSecurityDescriptor()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d5/se_8h.html#a200a109">QuerySecurityDescriptor</a>, <a class="el" href="../../d0/d5/se_8h.html#a200a108">SetSecurityDescriptor</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01074">CmpCreateObjectTypes()</a>, and <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00226">CmpDoCreateChild()</a>.
<p>
<pre class="fragment"><div>00171                    :
00172 
00173     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security method <span class="keywordflow">for</span> registry objects.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> responsible <span class="keywordflow">for</span>
00174     retrieving, setting, and deleting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor of a registry
00175     object.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not used to assign <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original security descriptor to an
00176     object (use SeAssignSecurity <span class="keywordflow">for</span> that purpose).
00177 
00178 
00179     IT IS ASSUMED THAT THE OBJECT MANAGER HAS ALREADY DONE THE ACCESS
00180     VALIDATIONS NECESSARY TO ALLOW THE REQUESTED OPERATIONS TO BE PERFORMED.
00181 
00182 Arguments:
00183 
00184     Object - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being used.
00185 
00186     OperationCode - Indicates <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> setting, querying, or
00187         deleting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object's security descriptor.
00188 
00189     SecurityInformation - Indicates which security information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being
00190         queried or set.  This argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">delete</span> operation.
00191 
00192     SecurityDescriptor - The meaning of <span class="keyword">this</span> parameter depends on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00193         OperationCode:
00194 
00195         <a class="code" href="../../d0/d5/se_8h.html#a200a109">QuerySecurityDescriptor</a> - For <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query operation <span class="keyword">this</span> supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00196             buffer to copy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> descriptor into.  The security descriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00197             assumed to have been probed up to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size passed in in Length.
00198             Since <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> still points into user space, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must always be
00199             accessed in a <span class="keywordflow">try</span> clause in <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> should suddenly disappear.
00200 
00201         <a class="code" href="../../d0/d5/se_8h.html#a200a108">SetSecurityDescriptor</a> - For a set operation <span class="keyword">this</span> supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00202             security descriptor to copy into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.  The security
00203             descriptor must be captured before <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called.
00204 
00205         <a class="code" href="../../d0/d5/se_8h.html#a200a110">DeleteSecurityDescriptor</a> - It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored when deleting a security
00206             descriptor.
00207 
00208         <a class="code" href="../../d0/d5/se_8h.html#a200a111">AssignSecurityDescriptor</a> - For assign operations <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00209             security descriptor that will be assigned to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
00210             It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to be in kernel space, and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> therefore not
00211             probed or captured.
00212 
00213     CapturedLength - For <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query operation <span class="keyword">this</span> specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in
00214         bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor buffer, and upon <span class="keywordflow">return</span> contains
00215         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes needed to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> descriptor.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length
00216         needed <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> greater than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length supplied <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation will fail.
00217         It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> set and <span class="keyword">delete</span> operation.
00218 
00219         This parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to be captured and probed as appropriate.
00220 
00221     ObjectsSecurityDescriptor - For <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Set operation <span class="keyword">this</span> supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address
00222         of a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object's current security descriptor.  This routine
00223         will either modify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor in place or deallocate/
00224         allocate a <span class="keyword">new</span> security descriptor and use <span class="keyword">this</span> variable to indicate
00225         its <span class="keyword">new</span> location.  For <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query operation <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> simply supplies
00226         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor being queried.
00227 
00228     PoolType - For <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> set operation <span class="keyword">this</span> specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> to use <span class="keywordflow">if</span>
00229         a <span class="keyword">new</span> security descriptor needs to be allocated.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored
00230         in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query and <span class="keyword">delete</span> operation.
00231 
00232     GenericMapping - Passed <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> set operation, <span class="keyword">this</span> argument provides
00233         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping of generic to specific/standard access types <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
00234         being accessed.  This mapping structure <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expected to be safe to
00235         access (i.e., captured <span class="keywordflow">if</span> necessary) prior to be passed to <span class="keyword">this</span> routine.
00236 
00237 Return Value:
00238 
00239     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - STATUS_SUCCESS <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> successful and an
00240         appropriate error status otherwise.
00241 
00242 --*/
00243 
00244 {
00245     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00246     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00247     <a class="code" href="../../d5/d5/struct__CM__KEY__REFERENCE.html">CM_KEY_REFERENCE</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
00248 
00249     <span class="comment">//</span>
00250     <span class="comment">//  Make sure the common parts of our input are proper</span>
00251     <span class="comment">//</span>
00252 
00253     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00254     <a class="code" href="../../d1/d2/cmp_8h.html#a83">ASSERT_KEY_OBJECT</a>(Object);
00255 
00256     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (OperationCode == SetSecurityDescriptor) ||
00257             (OperationCode == QuerySecurityDescriptor) ||
00258             (OperationCode == AssignSecurityDescriptor) ||
00259             (OperationCode == DeleteSecurityDescriptor) );
00260 
00261     <span class="comment">//</span>
00262     <span class="comment">// Lock hive for shared or exclusive, depending on what we need</span>
00263     <span class="comment">// to do.</span>
00264     <span class="comment">//</span>
00265     <span class="keywordflow">if</span> (OperationCode == <a class="code" href="../../d0/d5/se_8h.html#a200a109">QuerySecurityDescriptor</a>) {
00266         <a class="code" href="../../d6/d3/cmwraper_8c.html#a14">CmpLockRegistry</a>();
00267     } <span class="keywordflow">else</span> {
00268         <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
00269     }
00270 
00271     <span class="keywordflow">if</span> (((<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)Object)-&gt;KeyControlBlock-&gt;Delete) {
00272         <span class="comment">//</span>
00273         <span class="comment">// Key has been deleted, performing security operations on</span>
00274         <span class="comment">// it is Not Allowed.</span>
00275         <span class="comment">//</span>
00276         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00277         <span class="keywordflow">return</span>(STATUS_KEY_DELETED);
00278     }
00279 
00280     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = ((<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)Object)-&gt;KeyControlBlock;
00281 
00282     <span class="keywordflow">try</span> {
00283         <span class="comment">//</span>
00284         <span class="comment">//  This routine simply cases off of the operation code to decide</span>
00285         <span class="comment">//  which support routine to call</span>
00286         <span class="comment">//</span>
00287 
00288         <span class="keywordflow">switch</span> (OperationCode) {
00289 
00290         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/se_8h.html#a200a108">SetSecurityDescriptor</a>:
00291 
00292             <span class="comment">//</span>
00293             <span class="comment">//  check the rest of our input and call the set security</span>
00294             <span class="comment">//  method</span>
00295             <span class="comment">//</span>
00296             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (PoolType == PagedPool) || (PoolType == NonPagedPool) );
00297 
00298             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d2/cmse_8c.html#a1">CmpSetSecurityDescriptorInfo</a>( kcb,
00299                                                    SecurityInformation,
00300                                                    SecurityDescriptor,
00301                                                    ObjectsSecurityDescriptor,
00302                                                    PoolType,
00303                                                    GenericMapping );
00304 
00305             <span class="comment">//</span>
00306             <span class="comment">// this is the one and only path on which a user could change</span>
00307             <span class="comment">// a security descriptor, therefore, report such changes for</span>
00308             <span class="comment">// notification here.</span>
00309             <span class="comment">//</span>
00310             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00311                 <a class="code" href="../../d6/d3/cmwraper_8c.html#a13">CmpReportNotify</a>(kcb,
00312                                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyHive,
00313                                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyCell,
00314                                 REG_NOTIFY_CHANGE_ATTRIBUTES | REG_NOTIFY_CHANGE_SECURITY);
00315     
00316             }
00317 
00318             <span class="keywordflow">break</span>;
00319 
00320         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/se_8h.html#a200a109">QuerySecurityDescriptor</a>:
00321 
00322             <span class="comment">//</span>
00323             <span class="comment">//  check the rest of our input and call the default query security</span>
00324             <span class="comment">//  method</span>
00325             <span class="comment">//</span>
00326             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( CapturedLength != NULL );
00327             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d2/cmse_8c.html#a2">CmpQuerySecurityDescriptorInfo</a>( kcb,
00328                                                      SecurityInformation,
00329                                                      SecurityDescriptor,
00330                                                      CapturedLength,
00331                                                      ObjectsSecurityDescriptor );
00332             <span class="keywordflow">break</span>;
00333 
00334         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/se_8h.html#a200a110">DeleteSecurityDescriptor</a>:
00335 
00336             <span class="comment">//</span>
00337             <span class="comment">// Nobody should ever call the delete method.  When the key is</span>
00338             <span class="comment">// freed, the security descriptor associated with it is</span>
00339             <span class="comment">// explicitly freed (CmpFreeSecurityDescriptor)</span>
00340             <span class="comment">//</span>
00341             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
00342 
00343             <span class="keywordflow">break</span>;
00344 
00345         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/se_8h.html#a200a111">AssignSecurityDescriptor</a>:
00346 
00347             <span class="comment">//</span>
00348             <span class="comment">// Set the SecurityDescriptor field in the object's header to</span>
00349             <span class="comment">// NULL.  This indicates that our security method needs to be</span>
00350             <span class="comment">// called for any security descriptor operations.</span>
00351             <span class="comment">//</span>
00352 
00353             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a7">ObAssignObjectSecurityDescriptor</a>(Object, NULL, PagedPool);
00354 
00355             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ));
00356 
00357             <span class="comment">//</span>
00358             <span class="comment">// Assign the actual descriptor.</span>
00359             <span class="comment">//</span>
00360             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d2/cmse_8c.html#a10">CmpAssignSecurityDescriptor</a>( <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyHive,
00361                                                   <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyCell,
00362                                                   <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyNode,
00363                                                   SecurityDescriptor );
00364             <span class="comment">//</span>
00365             <span class="comment">// Security has been changed, update the cache.</span>
00366             <span class="comment">//</span>
00367             <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
00368             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;Security = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyNode-&gt;Security;
00369 
00370             <span class="keywordflow">break</span>;
00371 
00372         <span class="keywordflow">default</span>:
00373 
00374             <span class="comment">//</span>
00375             <span class="comment">//  Bugcheck on any other operation code,  We won't get here if</span>
00376             <span class="comment">//  the earlier asserts are still checked.</span>
00377             <span class="comment">//</span>
00378             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( REGISTRY_ERROR,3,1,(ULONG_PTR)kcb,0);
00379 
00380         }
00381     
00382     } except (<a class="code" href="../../d7/d2/cmse_8c.html#a8">CmpSecurityExceptionFilter</a>(GetExceptionInformation())) {
00383         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
00384             KdPrint((<span class="stringliteral">"!!CmpSecurityMethod: code:%08lx\n"</span>, GetExceptionCode()));
00385         }
00386         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00387     }
00388 
00389 
00390     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00391     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00392 
00393 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a300" doxytag="cmp.h::CmpSetCurrentProfile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpSetCurrentProfile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ControlSet</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html">PCM_HARDWARE_PROFILE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Profile</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01221">1221</a> of file <a class="el" href="../../d1/d9/cmboot_8c-source.html">cmboot.c</a>.
<p>
References <a class="el" href="../../d1/d2/cmp_8h.html#a299">CmpFindProfileOption()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01243">CmpFindValueByName</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00078">CmpValueToData</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a190">PCM_HARDWARE_PROFILE</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00499">_CM_KEY_VALUE::Type</a>.
<p>
<pre class="fragment"><div>01229                    :
01230 
01231     Edits <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> in-memory copy of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry to reflect <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hardware
01232     profile that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> booting from.
01233 
01234 Arguments:
01235 
01236     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure
01237 
01238     ControlSet - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> set.
01239 
01240     Profile - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> selected hardware profile
01241 
01242 Return Value:
01243 
01244     None.
01245 
01246 --*/
01247 
01248 {
01249     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> IDConfigDB;
01250     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> IDConfigNode;
01251     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> CurrentConfigCell;
01252     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> CurrentConfigValue;
01253     UNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
01254     PULONG CurrentConfig;
01255     ULONG realsize;
01256 
01257     IDConfigDB = <a class="code" href="../../d1/d2/cmp_8h.html#a299">CmpFindProfileOption</a>(Hive,
01258                                       ControlSet,
01259                                       NULL,
01260                                       NULL,
01261                                       NULL);
01262     <span class="keywordflow">if</span> (IDConfigDB != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01263         IDConfigNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, IDConfigDB);
01264         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"CurrentConfig"</span>);
01265         CurrentConfigCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(Hive,
01266                                                IDConfigNode,
01267                                                &amp;Name);
01268         <span class="keywordflow">if</span> (CurrentConfigCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01269             CurrentConfigValue = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, CurrentConfigCell);
01270             <span class="keywordflow">if</span> (CurrentConfigValue-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a> == REG_DWORD) {
01271                 CurrentConfig = (PULONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(Hive,
01272                                                        CurrentConfigValue,
01273                                                        realsize);
01274                 *CurrentConfig = Profile-&gt;Id;
01275             }
01276         }
01277     }
01278 
01279 
01280 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a249" doxytag="cmp.h::CmpSetGlobalQuotaAllowed" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpSetGlobalQuotaAllowed           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00354">354</a> of file <a class="el" href="../../d6/d0/cmgquota_8c-source.html">cmgquota.c</a>.
<p>
References <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00051">CmpGlobalQuota</a>, and <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00037">CmpGlobalQuotaAllowed</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01901">CmLoadKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00484">CmpLoadHiveVolatile()</a>, and <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00097">CmRestoreKey()</a>.
<p>
<pre class="fragment"><div>00359                    :
00360 
00361     Enables registry quota
00362 
00363     NOTE:   Do NOT put <span class="keyword">this</span> in init segment, we call <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> after
00364             that code has been freed!
00365 
00366 Return Value:
00367 
00368     NONE.
00369 
00370 --*/
00371 {
00372      <a class="code" href="../../d8/d9/cmapi_8c.html#a7">CmpGlobalQuotaAllowed</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a4">CmpGlobalQuota</a>;
00373 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a271" doxytag="cmp.h::CmpSetVersionData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpSetVersionData           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01545">1545</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
References <a class="el" href="../../d9/d0/init_8h-source.html#l00034">CmCSDVersionString</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01986">CmpConfigureProcessors()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01227">CmpHiveRootSecurityDescriptor()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01845">CmpInterlockedFunction()</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00235">CmpProcessorControl</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00033">CmVersionString</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d4/triage_8c-source.html#l00042">NtBuildNumber</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00504">NtDeleteValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00028">NtSystemRoot</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00159">nullclass</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00137">RtlFreeStringRoutine</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00102">RtlInitAnsiString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d6/d9/heappage_8c.html#a68">sprintf()</a>, and <a class="el" href="../../d2/d0/hivedmp_8c-source.html#l00060">ValueBuffer</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00997">NtInitializeRegistry()</a>.
<p>
<pre class="fragment"><div>01550                    :
01551 
01552     <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> \REGISTRY\MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion:
01553                 CurrentVersion = VER_PRODUCTVERSION_STR             <span class="comment">// From ntverp.h</span>
01554                 CurrentBuildNumber = VER_PRODUCTBUILD               <span class="comment">// From ntverp.h</span>
01555                 CurrentType = <span class="stringliteral">"[Multiprocessor|Uniprocessor]        // From NT_UP</span>
01556 <span class="stringliteral">                                [Retail|Free|Checked]"</span>              <span class="comment">// From DBG, DEVL</span>
01557                 SystemRoot = <span class="stringliteral">"[c:\nt]"</span>
01558 
01559 
01560     NOTE:   It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not worth bugchecking over <span class="keyword">this</span>, so <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> doesn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>
01561             work, just fail.
01562 
01563 Arguments:
01564 
01565 Return Value:
01566 
01567 --*/
01568 {
01569     ANSI_STRING     AnsiString;
01570     UNICODE_STRING  NameString;
01571     UNICODE_STRING  ValueString;
01572     HANDLE          key1, key2;
01573     UCHAR           WorkString[128];
01574     WCHAR           <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>[128];
01575     OBJECT_ATTRIBUTES   <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
01576     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            status;
01577     PUCHAR              proctype;
01578     PUCHAR              buildtype;
01579     PSECURITY_DESCRIPTOR SecurityDescriptor;
01580 
01581     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01582     <span class="comment">//</span>
01583     <span class="comment">// Get default security descriptor for the nodes we will create.</span>
01584     <span class="comment">//</span>
01585     SecurityDescriptor = <a class="code" href="../../d7/d2/cmse_8c.html#a13">CmpHiveRootSecurityDescriptor</a>();
01586 
01587     <span class="comment">//</span>
01588     <span class="comment">// Create the key</span>
01589     <span class="comment">//</span>
01590     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
01591         &amp;NameString,
01592         L<span class="stringliteral">"\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft"</span>
01593         );
01594 
01595     InitializeObjectAttributes(
01596         &amp;ObjectAttributes,
01597         &amp;NameString,
01598         OBJ_CASE_INSENSITIVE,
01599         (HANDLE)NULL,
01600         SecurityDescriptor
01601         );
01602 
01603     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(
01604                 &amp;key1,
01605                 KEY_CREATE_SUB_KEY,
01606                 &amp;ObjectAttributes,
01607                 0,
01608                 &amp;nullclass,
01609                 0,
01610                 NULL
01611                 );
01612 
01613     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01614 <span class="preprocessor">#if DBG</span>
01615 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CMINIT: CreateKey of %wZ failed - Status == %lx\n"</span>,
01616                  &amp;NameString, status);
01617 <span class="preprocessor">#endif</span>
01618 <span class="preprocessor"></span>        <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SecurityDescriptor);
01619         <span class="keywordflow">return</span>;
01620     }
01621 
01622     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
01623         &amp;NameString,
01624         L<span class="stringliteral">"Windows NT"</span>
01625         );
01626 
01627     InitializeObjectAttributes(
01628         &amp;ObjectAttributes,
01629         &amp;NameString,
01630         OBJ_CASE_INSENSITIVE,
01631         key1,
01632         SecurityDescriptor
01633         );
01634 
01635     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(
01636                 &amp;key2,
01637                 KEY_SET_VALUE,
01638                 &amp;ObjectAttributes,
01639                 0,
01640                 &amp;nullclass,
01641                 0,
01642                 NULL
01643                 );
01644     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(key1);
01645     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
01646         &amp;NameString,
01647         L<span class="stringliteral">"CurrentVersion"</span>
01648         );
01649 
01650     InitializeObjectAttributes(
01651         &amp;ObjectAttributes,
01652         &amp;NameString,
01653         OBJ_CASE_INSENSITIVE,
01654         key2,
01655         SecurityDescriptor
01656         );
01657 
01658     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(
01659                 &amp;key1,
01660                 KEY_SET_VALUE,
01661                 &amp;ObjectAttributes,
01662                 0,
01663                 &amp;nullclass,
01664                 0,
01665                 NULL
01666                 );
01667     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(key2);
01668     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SecurityDescriptor);
01669     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01670 <span class="preprocessor">#if DBG</span>
01671 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CMINIT: CreateKey of %wZ failed - Status == %lx\n"</span>,
01672                  &amp;NameString, status);
01673 <span class="preprocessor">#endif</span>
01674 <span class="preprocessor"></span>        <span class="keywordflow">return</span>;
01675     }
01676 
01677 
01678     <span class="comment">//</span>
01679     <span class="comment">// Set the value entries for the key</span>
01680     <span class="comment">//</span>
01681     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
01682         &amp;NameString,
01683         L<span class="stringliteral">"CurrentVersion"</span>
01684         );
01685 
01686     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
01687         key1,
01688         &amp;NameString,
01689         0,              <span class="comment">// TitleIndex</span>
01690         REG_SZ,
01691         <a class="code" href="../../d8/d1/init_8h.html#a8">CmVersionString</a>.Buffer,
01692         <a class="code" href="../../d8/d1/init_8h.html#a8">CmVersionString</a>.Length + <span class="keyword">sizeof</span>( UNICODE_NULL )
01693         );
01694 <span class="preprocessor">#if DBG</span>
01695 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01696         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CMINIT: SetValueKey of %wZ failed - Status == %lx\n"</span>,
01697                  &amp;NameString, status);
01698     }
01699 <span class="preprocessor">#endif</span>
01700 <span class="preprocessor"></span>    (<a class="code" href="../../d8/d2/ldrinit_8c.html#a8">RtlFreeStringRoutine</a>)( <a class="code" href="../../d8/d1/init_8h.html#a8">CmVersionString</a>.Buffer );
01701     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CmVersionString, NULL );
01702 
01703     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
01704         &amp;NameString,
01705         L<span class="stringliteral">"CurrentBuildNumber"</span>
01706         );
01707 
01708     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(
01709         WorkString,
01710         <span class="stringliteral">"%u"</span>,
01711         NtBuildNumber &amp; 0xFFFF
01712         );
01713     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;AnsiString, WorkString );
01714 
01715     ValueString.Buffer = <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>;
01716     ValueString.Length = 0;
01717     ValueString.MaximumLength = <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a> );
01718 
01719     <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;ValueString, &amp;AnsiString, FALSE );
01720 
01721     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
01722         key1,
01723         &amp;NameString,
01724         0,              <span class="comment">// TitleIndex</span>
01725         REG_SZ,
01726         ValueString.Buffer,
01727         ValueString.Length + <span class="keyword">sizeof</span>( UNICODE_NULL )
01728         );
01729 <span class="preprocessor">#if DBG</span>
01730 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01731         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CMINIT: SetValueKey of %wZ failed - Status == %lx\n"</span>,
01732                  &amp;NameString, status);
01733     }
01734 <span class="preprocessor">#endif</span>
01735 <span class="preprocessor"></span>
01736     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
01737         &amp;NameString,
01738         L<span class="stringliteral">"CurrentType"</span>
01739         );
01740 
01741 <span class="preprocessor">#if defined(NT_UP)</span>
01742 <span class="preprocessor"></span>    proctype = <span class="stringliteral">"Uniprocessor"</span>;
01743 <span class="preprocessor">#else</span>
01744 <span class="preprocessor"></span>    proctype = <span class="stringliteral">"Multiprocessor"</span>;
01745 <span class="preprocessor">#endif</span>
01746 <span class="preprocessor"></span>
01747 <span class="preprocessor">#if DBG</span>
01748 <span class="preprocessor"></span>    buildtype = <span class="stringliteral">"Checked"</span>;
01749 <span class="preprocessor">#else</span>
01750 <span class="preprocessor"></span><span class="preprocessor">#if DEVL</span>
01751 <span class="preprocessor"></span>    buildtype = <span class="stringliteral">"Free"</span>;
01752 <span class="preprocessor">#else</span>
01753 <span class="preprocessor"></span>    buildtype = <span class="stringliteral">"Retail"</span>;
01754 <span class="preprocessor">#endif</span>
01755 <span class="preprocessor"></span>
01756 <span class="preprocessor">#endif</span>
01757 <span class="preprocessor"></span>
01758     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(
01759         WorkString,
01760         <span class="stringliteral">"%s %s"</span>,
01761         proctype,
01762         buildtype
01763         );
01764     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;AnsiString, WorkString );
01765 
01766     ValueString.Buffer = <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>;
01767     ValueString.Length = 0;
01768     ValueString.MaximumLength = <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a> );
01769 
01770     <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;ValueString, &amp;AnsiString, FALSE );
01771 
01772     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
01773         key1,
01774         &amp;NameString,
01775         0,              <span class="comment">// TitleIndex</span>
01776         REG_SZ,
01777         ValueString.Buffer,
01778         ValueString.Length + <span class="keyword">sizeof</span>( UNICODE_NULL )
01779         );
01780 
01781     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
01782         &amp;NameString,
01783         L<span class="stringliteral">"CSDVersion"</span>
01784         );
01785 
01786     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/init_8h.html#a9">CmCSDVersionString</a>.Length != 0) {
01787         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
01788             key1,
01789             &amp;NameString,
01790             0,              <span class="comment">// TitleIndex</span>
01791             REG_SZ,
01792             <a class="code" href="../../d8/d1/init_8h.html#a9">CmCSDVersionString</a>.Buffer,
01793             <a class="code" href="../../d8/d1/init_8h.html#a9">CmCSDVersionString</a>.Length + <span class="keyword">sizeof</span>( UNICODE_NULL )
01794             );
01795 <span class="preprocessor">#if DBG</span>
01796 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01797             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CMINIT: SetValueKey of %wZ failed - Status == %lx\n"</span>,
01798                      &amp;NameString, status);
01799         }
01800 <span class="preprocessor">#endif</span>
01801 <span class="preprocessor"></span>        (<a class="code" href="../../d8/d2/ldrinit_8c.html#a8">RtlFreeStringRoutine</a>)( <a class="code" href="../../d8/d1/init_8h.html#a9">CmCSDVersionString</a>.Buffer );
01802         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CmCSDVersionString, NULL );
01803     } <span class="keywordflow">else</span> {
01804         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a16">NtDeleteValueKey</a>(
01805             key1,
01806             &amp;NameString
01807             );
01808 <span class="preprocessor">#if DBG</span>
01809 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; status != STATUS_OBJECT_NAME_NOT_FOUND) {
01810             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CMINIT: DeleteValueKey of %wZ failed - Status == %lx\n"</span>,
01811                      &amp;NameString, status);
01812         }
01813 <span class="preprocessor">#endif</span>
01814 <span class="preprocessor"></span>    }
01815     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;NameString,
01816                          L<span class="stringliteral">"SystemRoot"</span>);
01817     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(key1,
01818                            &amp;NameString,
01819                            0,
01820                            REG_SZ,
01821                            <a class="code" href="../../d8/d1/init_8h.html#a3">NtSystemRoot</a>.Buffer,
01822                            <a class="code" href="../../d8/d1/init_8h.html#a3">NtSystemRoot</a>.Length + <span class="keyword">sizeof</span>(UNICODE_NULL));
01823 <span class="preprocessor">#if DBG</span>
01824 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01825         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CMINIT: SetValueKey of %wZ failed - Status == %lx\n"</span>,
01826                  &amp;NameString,
01827                  status);
01828     }
01829 <span class="preprocessor">#endif</span>
01830 <span class="preprocessor"></span>    <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(key1);
01831 
01832     <span class="comment">//</span>
01833     <span class="comment">// Set each processor to it's optimal configuration.</span>
01834     <span class="comment">//</span>
01835     <span class="comment">// Note: this call is performed interlocked such that the user</span>
01836     <span class="comment">// can disable this automatic configuration update.</span>
01837     <span class="comment">//</span>
01838 
01839     <a class="code" href="../../d1/d3/cmsysini_8c.html#a42">CmpInterlockedFunction</a>(CmpProcessorControl, CmpConfigureProcessors);
01840 
01841     <span class="keywordflow">return</span>;
01842 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a302" doxytag="cmp.h::CmpSortDriverList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpSortDriverList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ControlSet</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLIST_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverListHead</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00744">744</a> of file <a class="el" href="../../d1/d9/cmboot_8c-source.html">cmboot.c</a>.
<p>
References <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00837">CmpDoSort()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00186">CmpFindSubKeyByName()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01243">CmpFindValueByName</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00078">CmpValueToData</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00107">PHCELL_INDEX</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00499">_CM_KEY_VALUE::Type</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02169">CmGetSystemDriverList()</a>.
<p>
<pre class="fragment"><div>00752                    :
00753 
00754     Sorts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of boot drivers by their groups based on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group
00755     ordering in &lt;control_set&gt;\CONTROL\SERVICE_GROUP_ORDER:list
00756 
00757     Does NOT <span class="keywordflow">do</span> dependency ordering.
00758 
00759 Arguments:
00760 
00761     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SYSTEM hive.
00762 
00763     ControlSet - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> set.
00764 
00765     DriverListHead - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> head of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of
00766             boot drivers to be sorted.
00767 
00768 Return Value:
00769 
00770     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> successfully sorted
00771 
00772     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> inconsistent and could not be sorted.
00773 
00774 --*/
00775 
00776 {
00777     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Controls;
00778     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> GroupOrder;
00779     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ListCell;
00780     UNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
00781     UNICODE_STRING DependList;
00782     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00783     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00784     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> ListNode;
00785     ULONG realsize;
00786 
00787     <span class="comment">//</span>
00788     <span class="comment">// Find "CONTROL" node.</span>
00789     <span class="comment">//</span>
00790     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"Control"</span>);
00791     Controls = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(Hive,
00792                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,ControlSet),
00793                                    &amp;Name);
00794     <span class="keywordflow">if</span> (Controls == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00795         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00796     }
00797 
00798     <span class="comment">//</span>
00799     <span class="comment">// Find "SERVICE_GROUP_ORDER" subkey</span>
00800     <span class="comment">//</span>
00801     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"ServiceGroupOrder"</span>);
00802     GroupOrder = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(Hive,
00803                                      (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,Controls),
00804                                      &amp;Name);
00805     <span class="keywordflow">if</span> (GroupOrder == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00806         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00807     }
00808 
00809     <span class="comment">//</span>
00810     <span class="comment">// Find "list" value</span>
00811     <span class="comment">//</span>
00812     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"list"</span>);
00813     ListCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(Hive,
00814                                   (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,GroupOrder),
00815                                   &amp;Name);
00816     <span class="keywordflow">if</span> (ListCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00817         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00818     }
00819     ListNode = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ListCell);
00820     <span class="keywordflow">if</span> (ListNode-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a> != REG_MULTI_SZ) {
00821         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00822     }
00823 
00824     DependList.Buffer = (PWSTR)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(Hive,ListNode,realsize);
00825     DependList.Length = DependList.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realsize - <span class="keyword">sizeof</span>(WCHAR);
00826 
00827     <span class="comment">//</span>
00828     <span class="comment">// Dependency list is now pointed to by DependList-&gt;Buffer.  We need</span>
00829     <span class="comment">// to sort the driver entry list.</span>
00830     <span class="comment">//</span>
00831 
00832     <span class="keywordflow">return</span> (<a class="code" href="../../d0/d0/cmboot_8c.html#a5">CmpDoSort</a>(DriverListHead, &amp;DependList));
00833 
00834 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a258" doxytag="cmp.h::CmpUnlockRegistry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpUnlockRegistry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">116</a> of file <a class="el" href="../../d1/d2/cmsubs3_8c-source.html">cmsubs3.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/cmapi2_8c-source.html#l00031">CmDeleteKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00092">CmDeleteValueKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00285">CmEnumerateKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00416">CmEnumerateValueKey()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02169">CmGetSystemDriverList()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01901">CmLoadKey()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01028">CmNotifyRunDown()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03262">CmpCloneControlSet()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01869">CmpCloneHwProfile()</a>, <a class="el" href="../../d4/d9/cmclose_8c-source.html#l00028">CmpCloseKeyObject()</a>, <a class="el" href="../../d2/d0/cmdelete_8c-source.html#l00031">CmpDeleteKeyObject()</a>, <a class="el" href="../../d9/d2/cmwrapr2_8c-source.html#l00045">CmpFileSetSize()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00461">CmpLazyFlushWorker()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00484">CmpLoadHiveVolatile()</a>, <a class="el" href="../../d6/d1/cmquery_8c-source.html#l00028">CmpQueryKeyName()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00731">CmpRefreshHive()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03458">CmpSaveBootControlSet()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01261">CmpSaveKeyByFileCopy()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00158">CmpSecurityMethod()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00647">CmQueryKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00940">CmQueryMultipleValueKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00804">CmQueryValueKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02293">CmReplaceKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00097">CmRestoreKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00862">CmSaveKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01047">CmSaveMergedKeys()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01841">CmSetLastWriteTimeKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01087">CmSetValueKey()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03944">CmShutdownSystem()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02079">CmUnloadKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00904">NtFlushKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00997">NtInitializeRegistry()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l04090">NtQueryOpenSubKeys()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03093">NtUnloadKey()</a>.
<p>
<pre class="fragment"><div>00120                    :
00121 
00122     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry.
00123 
00124 --*/
00125 {
00126     <a class="code" href="../../d1/d2/cmp_8h.html#a61">ASSERT_CM_LOCK_OWNED</a>();
00127     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;CmpRegistryLock);
00128     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00129 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a295" doxytag="cmp.h::CmpValidateHiveSecurityDescriptors" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpValidateHiveSecurityDescriptors           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Hive</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d9/cmchek2_8c-source.html#l00034">34</a> of file <a class="el" href="../../d3/d9/cmchek2_8c-source.html">cmchek2.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00523">_CM_KEY_SECURITY::Blink</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00400">CmpDumpSecurityDescriptor</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00263">CMS_SEC</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00526">_CM_KEY_SECURITY::Descriptor</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00525">_CM_KEY_SECURITY::DescriptorLength</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00522">_CM_KEY_SECURITY::Flink</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l01453">HvIsCellAllocated()</a>, <a class="el" href="../../d9/d0/cmdata_8h.html#a83">PCM_KEY_SECURITY</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00524">_CM_KEY_SECURITY::ReferenceCount</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00343">_HBASE_BLOCK::RootCell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00463">_CM_KEY_NODE::Security</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01555">SetUsed</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l02414">SeValidSecurityDescriptor()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00108">CmCheckRegistry()</a>.
<p>
<pre class="fragment"><div>00039                    :
00040 
00041     Walks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of security descriptors present in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive and passes
00042     each security descriptor to <a class="code" href="../../d8/d6/sertl_8c.html#a55">RtlValidSecurityDescriptor</a>.
00043 
00044     Only applies to descriptors in <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a> store.  Those in <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a> store
00045     cannot have come from disk and therefore <span class="keywordflow">do</span> not need <span class="keyword">this</span> treatment
00046     anyway.
00047 
00048 Arguments:
00049 
00050     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure
00051 
00052 Return Value:
00053 
00054     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>  - All security descriptors are valid
00055     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - At least one security descriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invalid
00056 
00057 --*/
00058 
00059 {
00060     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> RootNode;
00061     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> SecurityCell;
00062     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ListAnchor;
00063     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> NextCell;
00064     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> LastCell;
00065 
00066     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
00067         KdPrint((<span class="stringliteral">"CmpValidateHiveSecurityDescriptor: Hive = %lx\n"</span>,(ULONG_PTR)Hive));
00068     }
00069     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d0/hivecell_8c.html#a21">HvIsCellAllocated</a>(Hive,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a>)) {
00070         <span class="comment">//</span>
00071         <span class="comment">// root cell HCELL_INDEX is bogus</span>
00072         <span class="comment">//</span>
00073         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00074     }
00075     RootNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a>);
00076     ListAnchor = NextCell = RootNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a>;
00077 
00078     <span class="keywordflow">do</span> {
00079         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d0/hivecell_8c.html#a21">HvIsCellAllocated</a>(Hive, NextCell)) {
00080             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_SEC) {
00081                 KdPrint((<span class="stringliteral">"CM: CmpValidateHiveSecurityDescriptors\n"</span>));
00082                 KdPrint((<span class="stringliteral">"    NextCell: %08lx is invalid HCELL_INDEX\n"</span>,NextCell));
00083             }
00084             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00085         }
00086         SecurityCell = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, NextCell);
00087         <span class="keywordflow">if</span> (NextCell != ListAnchor) {
00088             <span class="comment">//</span>
00089             <span class="comment">// Check to make sure that our Blink points to where we just</span>
00090             <span class="comment">// came from.</span>
00091             <span class="comment">//</span>
00092             <span class="keywordflow">if</span> (SecurityCell-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o3">Blink</a> != LastCell) {
00093                 <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_SEC) {
00094                     KdPrint((<span class="stringliteral">"  Invalid Blink (%ld) on security cell %ld\n"</span>,SecurityCell-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o3">Blink</a>, NextCell));
00095                     KdPrint((<span class="stringliteral">"  should point to %ld\n"</span>, LastCell));
00096                 }
00097                 <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00098             }
00099         }
00100         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_SEC) {
00101             KdPrint((<span class="stringliteral">"CmpValidSD:  SD shared by %d nodes\n"</span>,SecurityCell-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o4">ReferenceCount</a>));
00102         }
00103         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d5/se_2capture_8c.html#a17">SeValidSecurityDescriptor</a>(SecurityCell-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o5">DescriptorLength</a>, &amp;SecurityCell-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o6">Descriptor</a>)) {
00104             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_SEC) {
00105                 <a class="code" href="../../d1/d2/cmp_8h.html#a66">CmpDumpSecurityDescriptor</a>(&amp;SecurityCell-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o6">Descriptor</a>,<span class="stringliteral">"INVALID DESCRIPTOR"</span>);
00106             }
00107             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00108         }
00109         <a class="code" href="../../d1/d2/cmp_8h.html#a124">SetUsed</a>(Hive, NextCell);
00110         LastCell = NextCell;
00111         NextCell = SecurityCell-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a>;
00112     } <span class="keywordflow">while</span> ( NextCell != ListAnchor );
00113     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00114 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a292" doxytag="cmp.h::CmpWorker" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpWorker           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d4/d3/struct__REGISTRY__COMMAND.html">PREGISTRY_COMMAND</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Command</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a229" doxytag="cmp.h::CmQueryKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmQueryKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyControlBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KEY_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ResultLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00647">647</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00245">CML_WORKER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00699">CmpConstructName()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00124">CmpLockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00172">CmpMarkAllBinsReadOnly</a>, <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00110">CmpQueryKeyData()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00262">CMS_CM</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00291">ExFreePoolWithTag</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00555">_KEY_INFORMATION::KeyNameInformation</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d0/cmdata_8h.html#a87">PKEY_INFORMATION</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00281">PROTECTED_POOL</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/edithive_8c-source.html#l00785">EhQueryKey()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02018">NtQueryKey()</a>.
<p>
<pre class="fragment"><div>00656                    :
00657 
00658     Data about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">class </span>of a key, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> numbers and sizes of its
00659     children and value entries may be queried with <a class="code" href="../../d8/d9/cmapi_8c.html#a15">CmQueryKey</a>.
00660 
00661     NOTE: The returned lengths are guaranteed to be at least as
00662           long as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> described values, but may be longer in
00663           some circumstances.
00664 
00665 Arguments:
00666 
00667     KeyControlBlock - pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> KCB that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key
00668 
00669     KeyInformationClass - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of information
00670         returned in <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>.  One of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following types:
00671 
00672         KeyBasicInformation - return last write time, title index, and name.
00673             (See KEY_BASIC_INFORMATION)
00674 
00675         KeyNodeInformation - return last write time, title index, name, class.
00676             (See KEY_NODE_INFORMATION)
00677 
00678         KeyFullInformation - return all data except for name and security.
00679             (See KEY_FULL_INFORMATION)
00680 
00681     KeyInformation -Supplies pointer to buffer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data.
00682 
00683     Length - Length of KeyInformation in bytes.
00684 
00685     ResultLength - Number of bytes actually written into KeyInformation.
00686 
00687 Return Value:
00688 
00689     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
00690 
00691         &lt;TBS&gt;
00692 
00693 --*/
00694 {
00695     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00696 
00697     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_WORKER, CMS_CM) KdPrint(("CmQueryKey\n"));
00698 
00699 
00700 
00701     CmpLockRegistry();
00702 
00703     <span class="comment">// Mark the hive as read only</span>
00704     CmpMarkAllBinsReadOnly(KeyControlBlock-&gt;KeyHive);
00705 
00706     try {
00707 
00708         <span class="comment">//</span>
00709         <span class="comment">// request for the FULL path of the key</span>
00710         <span class="comment">//</span>
00711         <span class="keywordflow">if</span>( KeyInformationClass == KeyNameInformation ) {
00712             <span class="keywordflow">if</span> (KeyControlBlock-&gt;Delete ) {
00713                 <span class="comment">//</span>
00714                 <span class="comment">// special case: return key deleted status, but still fill the full name of the key.</span>
00715                 <span class="comment">//</span>
00716                 status = STATUS_KEY_DELETED;
00717             } <span class="keywordflow">else</span> {
00718                 status = STATUS_SUCCESS;
00719             }
00720             
00721             <span class="keywordflow">if</span>( KeyControlBlock-&gt;NameBlock ) {
00722 
00723                 PUNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
00724                 <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> = <a class="code" href="../../d8/d2/cmsubs_8c.html#a18">CmpConstructName</a>(KeyControlBlock);
00725                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00726                     status = STATUS_INSUFFICIENT_RESOURCES;
00727                 } <span class="keywordflow">else</span> {
00728                     ULONG       requiredlength;
00729                     ULONG       minimumlength;
00730                     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>      NameLength;
00731                     LONG        leftlength;
00732                     <a class="code" href="../../d5/d6/union__KEY__INFORMATION.html">PKEY_INFORMATION</a> pbuffer = (<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html">PKEY_INFORMATION</a>)KeyInformation;
00733 
00734                     NameLength = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length;
00735 
00736                     requiredlength = FIELD_OFFSET(KEY_NAME_INFORMATION, Name) + NameLength;
00737                     
00738                     minimumlength = FIELD_OFFSET(KEY_NAME_INFORMATION, Name);
00739 
00740                     *ResultLength = requiredlength;
00741                     <span class="keywordflow">if</span> (Length &lt; minimumlength) {
00742 
00743                         status = STATUS_BUFFER_TOO_SMALL;
00744 
00745                     } <span class="keywordflow">else</span> {
00746                         <span class="comment">//</span>
00747                         <span class="comment">// Fill in the length of the name</span>
00748                         <span class="comment">//</span>
00749                         pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o3">KeyNameInformation</a>.NameLength = NameLength;
00750                         
00751                         <span class="comment">//</span>
00752                         <span class="comment">// Now copy the full name into the user buffer, if enough space</span>
00753                         <span class="comment">//</span>
00754                         leftlength = Length - minimumlength;
00755                         requiredlength = NameLength;
00756                         <span class="keywordflow">if</span> (leftlength &lt; (LONG)requiredlength) {
00757                             requiredlength = leftlength;
00758                             status = STATUS_BUFFER_OVERFLOW;
00759                         }
00760 
00761                         <span class="comment">//</span>
00762                         <span class="comment">// If not enough space, copy how much we can and return overflow</span>
00763                         <span class="comment">//</span>
00764                         RtlCopyMemory(
00765                             &amp;(pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o3">KeyNameInformation</a>.Name[0]),
00766                             <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer,
00767                             requiredlength
00768                             );
00769                     }
00770 
00771                     <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(Name, CM_NAME_TAG | PROTECTED_POOL);
00772                 }
00773             }
00774         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(KeyControlBlock-&gt;Delete ) {
00775             <span class="comment">// </span>
00776             <span class="comment">// key already deleted</span>
00777             <span class="comment">//</span>
00778             status = STATUS_KEY_DELETED;
00779         } <span class="keywordflow">else</span> {
00780             <span class="comment">//</span>
00781             <span class="comment">// call a worker to perform data transfer</span>
00782             <span class="comment">//</span>
00783 
00784             status = <a class="code" href="../../d9/d2/cmsubs2_8c.html#a4">CmpQueryKeyData</a>(KeyControlBlock-&gt;KeyHive,
00785                                      KeyControlBlock-&gt;KeyNode,
00786                                      KeyInformationClass,
00787                                      KeyInformation,
00788                                      Length,
00789                                      ResultLength);
00790         }
00791 
00792     } finally {
00793         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00794     }
00795 
00796     <span class="comment">// Mark the hive as read only</span>
00797     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(KeyControlBlock-&gt;KeyHive);
00798 
00799     <span class="keywordflow">return</span> status;
00800 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a231" doxytag="cmp.h::CmQueryMultipleValueKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmQueryMultipleValueKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyControlBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKEY_VALUE_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueEntries</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>EntryCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueBuffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OPTIONAL PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ResultLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00940">940</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00245">CML_WORKER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01243">CmpFindValueByName</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00508">CmpIsHKeyValueSmall</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00124">CmpLockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00172">CmpMarkAllBinsReadOnly</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00262">CMS_CM</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00498">_CM_KEY_VALUE::Data</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00497">_CM_KEY_VALUE::DataLength</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01417">ProbeAndReadUnicodeString</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00499">_CM_KEY_VALUE::Type</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, <a class="el" href="../../d2/d0/hivedmp_8c-source.html#l00060">ValueBuffer</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03461">NtQueryMultipleValueKey()</a>.
<p>
<pre class="fragment"><div>00950                    :
00951 
00952     Multiple values of any key may be queried atomically with
00953     <span class="keyword">this</span> api.
00954 
00955 Arguments:
00956 
00957     KeyControlBlock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key to be queried.
00958 
00959     ValueEntries - Returns an array of KEY_VALUE_ENTRY structures, one <span class="keywordflow">for</span> each value.
00960 
00961     EntryCount - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of entries in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ValueNames and ValueEntries arrays
00962 
00963     <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a> - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value data <span class="keywordflow">for</span> each value.
00964 
00965     BufferLength - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a> array in bytes.
00966                    Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a> array that was filled in.
00967 
00968     ResultLength - <span class="keywordflow">if</span> present, Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length in bytes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>
00969                     array required to <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested values of <span class="keyword">this</span> key.
00970 
00971 Return Value:
00972 
00973     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00974 
00975 --*/
00976 
00977 {
00978     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00979     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00980     ULONG i;
00981     UNICODE_STRING CurrentName;
00982     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ValueCell;
00983     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> ValueNode;
00984     ULONG RequiredLength = 0;
00985     ULONG UsedLength = 0;
00986     ULONG DataLength;
00987     BOOLEAN BufferFull = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00988     BOOLEAN Small;
00989     PUCHAR Data;
00990     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00991 
00992     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00993     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_WORKER, CMS_CM) KdPrint(("CmQueryMultipleValueKey\n"));
00994 
00995 
00996     CmpLockRegistry();
00997     if (KeyControlBlock-&gt;Delete) {
00998         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00999         <span class="keywordflow">return</span> STATUS_KEY_DELETED;
01000     }
01001     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyControlBlock-&gt;KeyHive;
01002     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01003 
01004     <span class="comment">// Mark the hive as read only</span>
01005     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(Hive);
01006 
01007     PreviousMode = KeGetPreviousMode();
01008     <span class="keywordflow">try</span> {
01009         <span class="keywordflow">for</span> (i=0; i &lt; EntryCount; i++) {
01010             <span class="comment">//</span>
01011             <span class="comment">// find the data</span>
01012             <span class="comment">//</span>
01013             <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
01014                 CurrentName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(ValueEntries[i].ValueName);
01015                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(CurrentName.Buffer,CurrentName.Length,<span class="keyword">sizeof</span>(WCHAR));
01016             } <span class="keywordflow">else</span> {
01017                 CurrentName = *(ValueEntries[i].ValueName);
01018             }
01019             ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(Hive,
01020                                            KeyControlBlock-&gt;KeyNode,
01021                                            &amp;CurrentName);
01022             <span class="keywordflow">if</span> (ValueCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01023 
01024                 ValueNode = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ValueCell);
01025                 Small = <a class="code" href="../../d9/d0/cmdata_8h.html#a38">CmpIsHKeyValueSmall</a>(DataLength, ValueNode-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o2">DataLength</a>);
01026 
01027                 <span class="comment">//</span>
01028                 <span class="comment">// Round up UsedLength and RequiredLength to a ULONG boundary</span>
01029                 <span class="comment">//</span>
01030                 UsedLength = (UsedLength + <span class="keyword">sizeof</span>(ULONG)-1) &amp; ~(<span class="keyword">sizeof</span>(ULONG)-1);
01031                 RequiredLength = (RequiredLength + <span class="keyword">sizeof</span>(ULONG)-1) &amp; ~(<span class="keyword">sizeof</span>(ULONG)-1);
01032 
01033                 <span class="comment">//</span>
01034                 <span class="comment">// If there is enough room for this data value in the buffer,</span>
01035                 <span class="comment">// fill it in now. Otherwise, mark the buffer as full. We must</span>
01036                 <span class="comment">// keep iterating through the values in order to determine the</span>
01037                 <span class="comment">// RequiredLength.</span>
01038                 <span class="comment">//</span>
01039                 <span class="keywordflow">if</span> ((UsedLength + DataLength &lt;= *BufferLength) &amp;&amp;
01040                     (!BufferFull)) {
01041                     <span class="keywordflow">if</span> (DataLength &gt; 0) {
01042                         <span class="keywordflow">if</span> (Small) {
01043                             Data = (PUCHAR)&amp;ValueNode-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>;
01044                         } <span class="keywordflow">else</span> {
01045                             Data = (PUCHAR)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ValueNode-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>);
01046                         }
01047                         RtlCopyMemory((PUCHAR)ValueBuffer + UsedLength,
01048                                       Data,
01049                                       DataLength);
01050                     }
01051                     ValueEntries[i].Type = ValueNode-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a>;
01052                     ValueEntries[i].DataLength = DataLength;
01053                     ValueEntries[i].DataOffset = UsedLength;
01054                     UsedLength += DataLength;
01055                 } <span class="keywordflow">else</span> {
01056                     BufferFull = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01057                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_OVERFLOW;
01058                 }
01059                 RequiredLength += DataLength;
01060 
01061             } <span class="keywordflow">else</span> {
01062                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_NOT_FOUND;
01063                 <span class="keywordflow">break</span>;
01064             }
01065         }
01066 
01067         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ||
01068             (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_OVERFLOW)) {
01069             *BufferLength = UsedLength;
01070             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ResultLength)) {
01071                 *ResultLength = RequiredLength;
01072             }
01073         }
01074 
01075     } finally {
01076         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01077     }
01078 
01079     <span class="comment">// Mark the hive as read only</span>
01080     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(Hive);
01081 
01082     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01083 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a230" doxytag="cmp.h::CmQueryValueKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmQueryValueKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyControlBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KEY_VALUE_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyValueInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyValueInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ResultLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00804">804</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00256">CM_KCB_SYM_LINK_FOUND</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00245">CML_WORKER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00609">CMP_GET_CACHED_ADDRESS</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01184">CmpDereferenceKeyControlBlockWithLock()</a>, <a class="el" href="../../d5/d2/cmtree_8c-source.html#l00309">CmpFindValueByNameFromCache()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00124">CmpLockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00144">CmpMakeValueCacheReadOnly</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00145">CmpMakeValueCacheReadWrite</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00172">CmpMarkAllBinsReadOnly</a>, <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00531">CmpQueryKeyValueData()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00262">CMS_CM</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00230">LOCK_KCB_TREE</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00107">PHCELL_INDEX</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00231">UNLOCK_KCB_TREE</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/edithive_8c-source.html#l00871">EhQueryValueKey()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>.
<p>
<pre class="fragment"><div>00814                    :
00815 
00816     The <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>, TitleIndex, Type, and Data <span class="keywordflow">for</span> any one of a key's
00817     value entries may be queried with <a class="code" href="../../d8/d9/cmapi_8c.html#a16">CmQueryValueKey</a>.
00818 
00819     If KeyValueInformation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not <span class="keywordtype">long</span> enough to hold all requested data,
00820     STATUS_BUFFER_OVERFLOW will be returned, and ResultLength will be
00821     set to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes actually required.
00822 
00823 Arguments:
00824 
00825     KeyControlBlock - pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> KCB that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key
00826 
00827     <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>  - The name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value entry to <span class="keywordflow">return</span> data <span class="keywordflow">for</span>.
00828 
00829     KeyValueInformationClass - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of information
00830         returned in KeyValueInformation.  One of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following types:
00831 
00832         KeyValueBasicInformation - <span class="keywordflow">return</span> time of last write, title
00833             index, and name.  (See KEY_VALUE_BASIC_INFORMATION)
00834 
00835         KeyValueFullInformation - <span class="keywordflow">return</span> time of last write, title
00836             index, name, <span class="keyword">class</span>.  (See KEY_VALUE_FULL_INFORMATION)
00837 
00838     KeyValueInformation -Supplies pointer to buffer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data.
00839 
00840     Length - Length of KeyValueInformation in bytes.
00841 
00842     ResultLength - Number of bytes actually written into KeyValueInformation.
00843 
00844 Return Value:
00845 
00846     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
00847 
00848         &lt;TBS&gt;
00849 
00850 --*/
00851 {
00852     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00853     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> childcell;
00854     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a>  childindex;
00855     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
00856     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> ValueData;
00857     ULONG       <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00858     BOOLEAN     ValueCached;
00859     <a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PPCM_CACHED_VALUE</a> ContainingList;
00860 
00861     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00862     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_WORKER, CMS_CM) KdPrint(("CmQueryValueKey\n"));
00863 
00864 
00865     CmpLockRegistry();
00866 
00867     if (KeyControlBlock-&gt;Delete) {
00868         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00869         <span class="keywordflow">return</span> STATUS_KEY_DELETED;
00870     }
00871 
00872     <span class="comment">// Mark the hive as read only</span>
00873     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(KeyControlBlock-&gt;KeyHive);
00874 
00875     <a class="code" href="../../d1/d2/cmp_8h.html#a16">LOCK_KCB_TREE</a>();
00876 
00877     <span class="keywordflow">if</span> (KeyControlBlock-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a12">CM_KCB_SYM_LINK_FOUND</a>) {
00878         <span class="comment">//</span>
00879         <span class="comment">// The value list is now set to the KCB for symbolic link,</span>
00880         <span class="comment">// Clean it up and set the value right before we do the query.</span>
00881         <span class="comment">//</span>
00882         <a class="code" href="../../d8/d2/cmsubs_8c.html#a23">CmpDereferenceKeyControlBlockWithLock</a>(KeyControlBlock-&gt;ValueCache.RealKcb);
00883         KeyControlBlock-&gt;ExtFlags &amp;= ~<a class="code" href="../../d9/d0/cmdata_8h.html#a12">CM_KCB_SYM_LINK_FOUND</a>;
00884 
00885         KeyControlBlock-&gt;ValueCache.Count = KeyControlBlock-&gt;KeyNode-&gt;ValueList.Count;
00886         KeyControlBlock-&gt;ValueCache.ValueList = (ULONG_PTR) KeyControlBlock-&gt;KeyNode-&gt;ValueList.List;
00887     }
00888 
00889 
00890     <span class="keywordflow">try</span> {
00891         <span class="comment">//</span>
00892         <span class="comment">// Find the data</span>
00893         <span class="comment">//</span>
00894 
00895         ValueData = <a class="code" href="../../d4/d3/cmtree_8c.html#a3">CmpFindValueByNameFromCache</a>(KeyControlBlock-&gt;KeyHive,
00896                                                 &amp;(KeyControlBlock-&gt;ValueCache),
00897                                                 &amp;ValueName,
00898                                                 &amp;ContainingList,
00899                                                 &amp;Index,
00900                                                 &amp;ValueCached
00901                                                 );
00902         <span class="keywordflow">if</span> (ValueData) {
00903 
00904             <span class="comment">// Trying to catch the BAD guy who writes over our pool.</span>
00905             <a class="code" href="../../d1/d2/cmp_8h.html#a10">CmpMakeValueCacheReadWrite</a>(ValueCached,<a class="code" href="../../d9/d0/cmdata_8h.html#a46">CMP_GET_CACHED_ADDRESS</a>(KeyControlBlock-&gt;ValueCache.ValueList));
00906 
00907             <span class="comment">//</span>
00908             <span class="comment">// call a worker to perform data transfer</span>
00909             <span class="comment">//</span>
00910 
00911             status = <a class="code" href="../../d9/d2/cmsubs2_8c.html#a5">CmpQueryKeyValueData</a>(KeyControlBlock-&gt;KeyHive,
00912                                           ContainingList,
00913                                           ValueData,
00914                                           ValueCached,
00915                                           KeyValueInformationClass,
00916                                           KeyValueInformation,
00917                                           Length,
00918                                           ResultLength);
00919 
00920             <span class="comment">// Trying to catch the BAD guy who writes over our pool.</span>
00921             <a class="code" href="../../d1/d2/cmp_8h.html#a9">CmpMakeValueCacheReadOnly</a>(ValueCached,<a class="code" href="../../d9/d0/cmdata_8h.html#a46">CMP_GET_CACHED_ADDRESS</a>(KeyControlBlock-&gt;ValueCache.ValueList));
00922 
00923         } <span class="keywordflow">else</span> {
00924             status = STATUS_OBJECT_NAME_NOT_FOUND;
00925         }
00926 
00927     } finally {
00928         <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
00929         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00930     }
00931 
00932     <span class="comment">// Mark the hive as read only</span>
00933     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(KeyControlBlock-&gt;KeyHive);
00934 
00935     <span class="keywordflow">return</span> status;
00936 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a232" doxytag="cmp.h::CmRenameValueKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmRenameValueKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyControlBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceValueName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetValueName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetIndex</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a233" doxytag="cmp.h::CmReplaceKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmReplaceKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>NewHiveName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>OldFileName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02293">2293</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00748">_REGISTRY_COMMAND::Allocate</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00422">CM_WRAP_LIMIT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00745">_REGISTRY_COMMAND::CmHive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00242">CML_BUGCHECK</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00186">CmpFree()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00037">CmpGlobalQuotaAllowed</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00038">CmpGlobalQuotaWarning</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00261">CMS_SAVRES</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00738">_REGISTRY_COMMAND::Command</a>, <a class="el" href="../../d2/d9/tdisp_8c-source.html#l00009">ErrorExit()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00744">_REGISTRY_COMMAND::FileAttributes</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00205">HIVE_HAS_BEEN_REPLACED</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00622">_HHIVE::HiveFlags</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00652">_CMHIVE::HiveList</a>, <a class="el" href="../../d3/d0/hivefree_8c-source.html#l00034">HvFreeHive()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00754">_REGISTRY_COMMAND::ImpersonationContext</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00753">_REGISTRY_COMMAND::NameInfoLength</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00751">_REGISTRY_COMMAND::NewName</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00752">_REGISTRY_COMMAND::OldName</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00723">REG_CMD_HIVE_CLOSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00722">REG_CMD_HIVE_OPEN</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00725">REG_CMD_RENAME_HIVE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00750">_REGISTRY_COMMAND::RegistryLockAquired</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00743">_REGISTRY_COMMAND::Status</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03336">NtReplaceKey()</a>.
<p>
<pre class="fragment"><div>02302                    :
02303 
02304     Renames <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <span class="keywordflow">for</span> a running system and replaces <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> with a <span class="keyword">new</span>
02305     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  The <span class="keyword">new</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not actually used until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next boot.
02306 
02307 Arguments:
02308 
02309     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies a hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive to be replaced.
02310 
02311     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root cell of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive to be
02312            replaced.
02313 
02314     NewHiveName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be installed
02315             as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> hive.
02316 
02317     OldFileName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> existing hive
02318             <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be renamed to.
02319 
02320 Return Value:
02321 
02322     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
02323 
02324 --*/
02325 
02326 {
02327     <a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html">REGISTRY_COMMAND</a> Command;
02328     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> ObjectInfoBuffer[512];
02329     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02330     OBJECT_ATTRIBUTES Attributes;
02331     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> NewHive;
02332     POBJECT_NAME_INFORMATION NameInfo;
02333     ULONG OldQuotaAllowed;
02334     ULONG OldQuotaWarning;
02335 
02336     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
02337 
02338     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a11">HIVE_HAS_BEEN_REPLACED</a>) {
02339         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02340         <span class="keywordflow">return</span> STATUS_FILE_RENAMED;
02341     }
02342 
02343     <span class="comment">//</span>
02344     <span class="comment">// temporarily disable registry quota as we will be giving this memory back immediately!</span>
02345     <span class="comment">//</span>
02346     OldQuotaAllowed = <a class="code" href="../../d8/d9/cmapi_8c.html#a7">CmpGlobalQuotaAllowed</a>;
02347     OldQuotaWarning = <a class="code" href="../../d8/d9/cmapi_8c.html#a8">CmpGlobalQuotaWarning</a>;
02348     <a class="code" href="../../d8/d9/cmapi_8c.html#a7">CmpGlobalQuotaAllowed</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a69">CM_WRAP_LIMIT</a>;
02349     <a class="code" href="../../d8/d9/cmapi_8c.html#a8">CmpGlobalQuotaWarning</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a69">CM_WRAP_LIMIT</a>;
02350 
02351     <span class="comment">//</span>
02352     <span class="comment">// First open the new hive file and check to make sure it is valid.</span>
02353     <span class="comment">//</span>
02354     InitializeObjectAttributes(&amp;Attributes,
02355                                NewHiveName,
02356                                OBJ_CASE_INSENSITIVE,
02357                                NULL,
02358                                NULL);
02359 
02360     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o12">RegistryLockAquired</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02361     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a104">REG_CMD_HIVE_OPEN</a>;
02362     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o6">FileAttributes</a> = &amp;Attributes;
02363     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o10">Allocate</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02364     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o16">ImpersonationContext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02365     <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
02366     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a>;
02367     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02368         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
02369     }
02370     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o10">Allocate</a> == FALSE);
02371 
02372     NewHive = Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a>;
02373 
02374     <span class="comment">//</span>
02375     <span class="comment">// The new hive exists, and is consistent, and we have it open.</span>
02376     <span class="comment">// Now rename the current hive file.</span>
02377     <span class="comment">//</span>
02378     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a107">REG_CMD_RENAME_HIVE</a>;
02379     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o13">NewName</a> = OldFileName;
02380     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o14">OldName</a> = (POBJECT_NAME_INFORMATION)ObjectInfoBuffer;
02381     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o15">NameInfoLength</a> = <span class="keyword">sizeof</span>(ObjectInfoBuffer);
02382     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a> = CONTAINING_RECORD(Hive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive);
02383     <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
02384     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a>;
02385     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02386             <span class="comment">//</span>
02387         <span class="comment">// rename failed, close the files associated with the new hive</span>
02388         <span class="comment">//</span>
02389         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a> = NewHive;
02390         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a105">REG_CMD_HIVE_CLOSE</a>;
02391         <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
02392         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
02393     }
02394 
02395     <span class="comment">//</span>
02396     <span class="comment">// The existing hive was successfully renamed, so try to rename the</span>
02397     <span class="comment">// new file to what the old hive file was named.  (which was returned</span>
02398     <span class="comment">// into ObjectInfoBuffer by the worker thread)</span>
02399     <span class="comment">//</span>
02400     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> |= <a class="code" href="../../d6/d0/hive_8h.html#a11">HIVE_HAS_BEEN_REPLACED</a>;
02401     NameInfo = (POBJECT_NAME_INFORMATION)ObjectInfoBuffer;
02402     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a107">REG_CMD_RENAME_HIVE</a>;
02403     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o13">NewName</a> = &amp;NameInfo-&gt;Name;
02404     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o14">OldName</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02405     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o15">NameInfoLength</a> = 0;
02406     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a> = NewHive;
02407     <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
02408     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a>;
02409     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02410 
02411         <span class="comment">//</span>
02412         <span class="comment">// Close the handles to the new hive</span>
02413         <span class="comment">//</span>
02414         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a105">REG_CMD_HIVE_CLOSE</a>;
02415         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a> = NewHive;
02416         <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
02417 
02418         <span class="comment">//</span>
02419         <span class="comment">// We are in trouble now.  We have renamed the existing hive file,</span>
02420         <span class="comment">// but we couldn't rename the new hive file!  Try to rename the</span>
02421         <span class="comment">// existing hive file back to where it was.</span>
02422         <span class="comment">//</span>
02423         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a107">REG_CMD_RENAME_HIVE</a>;
02424         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o13">NewName</a> = &amp;NameInfo-&gt;Name;
02425         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o14">OldName</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02426         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o15">NameInfoLength</a> = 0;
02427         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a> = CONTAINING_RECORD(Hive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive);
02428         <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
02429         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a>)) {
02430             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_SAVRES) {
02431                 KdPrint((<span class="stringliteral">"CmReplaceKey: renamed existing hive file, but couldn't\n"</span>));
02432                 KdPrint((<span class="stringliteral">"              rename new hive file (%08lx) "</span>,Status));
02433                 KdPrint((<span class="stringliteral">" or replace old hive file (%08lx)!\n"</span>,Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a>));
02434             }
02435 
02436             <span class="comment">//</span>
02437             <span class="comment">// WARNNOTE:</span>
02438             <span class="comment">//      To get into this state, the user must have relevent</span>
02439             <span class="comment">//      privileges, deliberately screw with system in an attempt</span>
02440             <span class="comment">//      to defeat it, AND get it done in a narrow timing window.</span>
02441             <span class="comment">//</span>
02442             <span class="comment">//      Further, if it's a user profile, the system will</span>
02443             <span class="comment">//      still come up.</span>
02444             <span class="comment">//</span>
02445             <span class="comment">//      Therefore, return an error code and go on.</span>
02446             <span class="comment">//</span>
02447 
02448             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REGISTRY_CORRUPT;
02449 
02450         }
02451     }
02452 
02453     <span class="comment">//</span>
02454     <span class="comment">// All of the renaming is done.  However, we are holding an in-memory</span>
02455     <span class="comment">// image of the new hive.  Release it, since it will not actually</span>
02456     <span class="comment">// be used until next boot.</span>
02457     <span class="comment">//</span>
02458     <span class="comment">// Do not close the open file handles to the new hive, we need to</span>
02459     <span class="comment">// keep it locked exclusively until the system is rebooted to prevent</span>
02460     <span class="comment">// people from mucking with it.</span>
02461     <span class="comment">//</span>
02462     RemoveEntryList(&amp;(NewHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o3">HiveList</a>));
02463 
02464     <a class="code" href="../../d2/d1/hivefree_8c.html#a0">HvFreeHive</a>((<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)NewHive);
02465 
02466     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( NewHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a> );
02467     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NewHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a>);
02468     <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(NewHive, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>));
02469 
02470 <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>:
02471     <span class="comment">//</span>
02472     <span class="comment">// Set global quota back to what it was.</span>
02473     <span class="comment">//</span>
02474     <a class="code" href="../../d8/d9/cmapi_8c.html#a7">CmpGlobalQuotaAllowed</a> = OldQuotaAllowed;
02475     <a class="code" href="../../d8/d9/cmapi_8c.html#a8">CmpGlobalQuotaWarning</a> = OldQuotaWarning;
02476 
02477     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02478     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02479 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a234" doxytag="cmp.h::CmRestoreKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmRestoreKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyControlBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00097">97</a> of file <a class="el" href="../../d7/d1/cmsavres_8c-source.html">cmsavres.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00346">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00376">_CM_INDEX::Cell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00460">_CM_KEY_NODE::ChildHiveReference</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00255">CM_KCB_SUBKEY_HINT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00373">CM_KEY_FAST_LEAF</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00371">CM_KEY_INDEX_ROOT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00568">CmpCleanUpKcbValueCache()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00686">CmpCopyKeyPartial()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01314">CmpCopyTree</a>, <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00034">CmpDeleteTree()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01490">CmpDestroyTemporaryHive()</a>, <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00140">CmpFreeKeyByCell()</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00484">CmpLoadHiveVolatile()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00036">CmpMasterHive</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00029">CmpProfileLoaded</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00731">CmpRefreshHive()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00114">CmpReportNotify()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00180">CmpSearchForOpenSubKeys()</a>, <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00354">CmpSetGlobalQuotaAllowed()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00261">CMS_SAVRES</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00388">_CM_KEY_INDEX::Count</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00382">_CM_KEY_FAST_INDEX::Count</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00308">DCmCheckRegistry</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00291">ExFreePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00568">HFILE_TYPE_PRIMARY</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00199">HINIT_FILE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00649">_CMHIVE::Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00071">HSTORAGE_TYPE</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l01295">HvReallocateCell()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00440">KEY_COMP_NAME</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00434">KEY_HIVE_ENTRY</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00341">_CM_KEY_REFERENCE::KeyCell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00540">_CELL_DATA::_u::KeyIndex</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00537">_CELL_DATA::_u::KeyNode</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00389">_CM_KEY_INDEX::List</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00383">_CM_KEY_FAST_INDEX::List</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00477">_CM_KEY_NODE::Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00475">_CM_KEY_NODE::NameLength</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00453">_CM_KEY_NODE::Parent</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00107">PHCELL_INDEX</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00281">PROTECTED_POOL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00343">_HBASE_BLOCK::RootCell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00387">_CM_KEY_INDEX::Signature</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00454">_CM_KEY_NODE::SubKeyCounts</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00457">_CM_KEY_NODE::SubKeyLists</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02348">NtRestoreKey()</a>.
<p>
<pre class="fragment"><div>00104                    :
00105 
00106     This copies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data from an on-disk hive into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry.  The <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
00107     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not loaded into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system will NOT be <span class="keyword">using</span>
00108     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call returns.
00109 
00110     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flag REG_WHOLE_HIVE_VOLATILE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not set, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given key <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> replaced
00111     by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  The root's name <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> changed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name
00112     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given key.
00113 
00114     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flag REG_WHOLE_HIVE_VOLATILE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set, a <span class="keyword">volatile</span> hive <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> created,
00115     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> copied into <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resulting hive <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> linked to
00116     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> master hive.  The given key must be in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> master hive.  (Usually
00117     will be \Registry\User)
00118 
00119     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flag REG_REFRESH_HIVE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set (must be only flag) then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00120     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> will be restored to its state as of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last flush.
00121     (The hive must be marked NOLAZY_FLUSH, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller must have
00122      TCB privilege, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle must point to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive.
00123      If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> refresh fails, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive will be corrupt, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system
00124      will bugcheck.)
00125 
00126     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flag REG_FORCE_RESTORE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> restore operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done even
00127     <span class="keywordflow">if</span> there areopen handles underneath <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key we are restoring to.
00128 
00129 Arguments:
00130 
00131     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive
00132 
00133     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - supplies index of node at root of tree to restore into
00134 
00135     FileHandle - handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to read from.
00136 
00137 Return Value:
00138 
00139     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
00140 
00141         &lt;TBS&gt;
00142 
00143 --*/
00144 {
00145     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00146     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  ptar;
00147     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  psrc;
00148     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>     TmpCmHive;
00149     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newroot;
00150     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newcell;
00151     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> parent;
00152     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> list;
00153     ULONG       count;
00154     ULONG       i;
00155     ULONG       j;
00156     LONG        size;
00157     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>      <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00158     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
00159     <a class="code" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a> Type;
00160     ULONG       NumberLeaves;
00161     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> LeafArray;
00162     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a> Leaf;
00163     <a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a> FastLeaf;
00164 
00165     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00166     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_SAVRES) {
00167         KdPrint((<span class="stringliteral">"CmRestoreKey:\n"</span>));
00168         KdPrint((<span class="stringliteral">"\tKCB=%08lx\n"</span>,KeyControlBlock));
00169         KdPrint((<span class="stringliteral">"\tFileHandle=%08lx\n"</span>,FileHandle));
00170     }
00171 
00172     <span class="keywordflow">if</span> (Flags &amp; REG_REFRESH_HIVE) {
00173         <span class="keywordflow">if</span> ((Flags &amp; ~REG_REFRESH_HIVE) != 0) {
00174             <span class="comment">//</span>
00175             <span class="comment">// Refresh must be alone</span>
00176             <span class="comment">//</span>
00177             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00178         }
00179     }
00180 
00181     <span class="comment">//</span>
00182     <span class="comment">// If they want to do WHOLE_HIVE_VOLATILE, it's a completely different API.</span>
00183     <span class="comment">//</span>
00184     <span class="keywordflow">if</span> (Flags &amp; REG_WHOLE_HIVE_VOLATILE) {
00185         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d2/cmsavres_8c.html#a9">CmpLoadHiveVolatile</a>(KeyControlBlock, FileHandle));
00186     }
00187 
00188     <span class="comment">//</span>
00189     <span class="comment">// If they want to do REFRESH_HIVE, that's a completely different api too.</span>
00190     <span class="comment">//</span>
00191     <span class="keywordflow">if</span> (Flags &amp; REG_REFRESH_HIVE) {
00192         <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
00193         status = <a class="code" href="../../d6/d2/cmsavres_8c.html#a10">CmpRefreshHive</a>(KeyControlBlock);
00194         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00195         <span class="keywordflow">return</span> status;
00196     }
00197 
00198     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyControlBlock-&gt;KeyHive;
00199     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = KeyControlBlock-&gt;KeyCell;
00200 
00201     <span class="comment">//</span>
00202     <span class="comment">// Disallow attempts to "restore" the master hive</span>
00203     <span class="comment">//</span>
00204     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> == &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>) {
00205         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00206     }
00207 
00208     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
00209 
00210     <span class="comment">//</span>
00211     <span class="comment">// Make sure this key has not been deleted</span>
00212     <span class="comment">//</span>
00213     <span class="keywordflow">if</span> (KeyControlBlock-&gt;Delete) {
00214         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00215         <span class="keywordflow">return</span>(STATUS_CANNOT_DELETE);
00216     }
00217 
00218     <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>(CONTAINING_RECORD(Hive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive));
00219 
00220     <span class="comment">//</span>
00221     <span class="comment">// Check for any open handles underneath the key we are restoring to.</span>
00222     <span class="comment">//</span>
00223     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/cmsubs_8c.html#a12">CmpSearchForOpenSubKeys</a>(KeyControlBlock,(Flags&amp;REG_FORCE_RESTORE)?SearchAndDeref:SearchIfExist) != 0) {
00224 
00225         <span class="comment">//</span>
00226         <span class="comment">// Cannot restore over a subtree with open handles in it, or the open handles to subkeys </span>
00227         <span class="comment">// successfully marked as closed.</span>
00228         <span class="comment">//</span>
00229 
00230         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00231         <span class="keywordflow">return</span>(STATUS_CANNOT_DELETE);
00232     }
00233 
00234     <span class="comment">//</span>
00235     <span class="comment">// Make sure this is the only handle open for this key</span>
00236     <span class="comment">//</span>
00237     <span class="keywordflow">if</span> (KeyControlBlock-&gt;RefCount != 1 &amp;&amp; !(Flags&amp;REG_FORCE_RESTORE)) {
00238         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00239         <span class="keywordflow">return</span>(STATUS_CANNOT_DELETE);
00240     }
00241 
00242     ptar = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);
00243 
00244     <span class="comment">//</span>
00245     <span class="comment">// The subtree the caller wants does not exactly match a</span>
00246     <span class="comment">// subtree.  Make a temporary hive, load the file into it,</span>
00247     <span class="comment">// tree copy the temporary to the active, and free the temporary.</span>
00248     <span class="comment">//</span>
00249 
00250     <span class="comment">//</span>
00251     <span class="comment">// Create the temporary hive</span>
00252     <span class="comment">//</span>
00253     status = <a class="code" href="../../d1/d2/cmp_8h.html#a275">CmpInitializeHive</a>(&amp;TmpCmHive,
00254                            HINIT_FILE,
00255                            0,
00256                            HFILE_TYPE_PRIMARY,
00257                            NULL,
00258                            FileHandle,
00259                            NULL,
00260                            NULL,
00261                            NULL,
00262                            NULL);
00263 
00264     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00265         <span class="keywordflow">goto</span> ErrorExit1;
00266     }                         
00267 
00268     <span class="comment">//</span>
00269     <span class="comment">// Create a new target root, under which we will copy the new tree</span>
00270     <span class="comment">//</span>
00271     <span class="keywordflow">if</span> (ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a29">KEY_HIVE_ENTRY</a>) {
00272         parent = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;                         <span class="comment">// root of hive, so parent is NIL</span>
00273     } <span class="keywordflow">else</span> {
00274         parent = ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a>;
00275     }
00276 
00277     newroot = <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a11">CmpCopyKeyPartial</a>(&amp;(TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>),
00278                                 TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a>,
00279                                 Hive,
00280                                 parent,
00281                                 TRUE);
00282     <span class="keywordflow">if</span> (newroot == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00283         status = STATUS_INSUFFICIENT_RESOURCES;
00284         <span class="keywordflow">goto</span> ErrorExit2;
00285     }
00286 
00287     <span class="comment">//</span>
00288     <span class="comment">// newroot has all the correct stuff, except that it has the</span>
00289     <span class="comment">// source root's name, when it needs to have the target root's.</span>
00290     <span class="comment">// So edit its name.</span>
00291     <span class="comment">//</span>
00292     psrc = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);
00293     ptar = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, newroot);
00294     size = FIELD_OFFSET(<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">CM_KEY_NODE</a>, Name) + psrc-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
00295 
00296     <span class="comment">//</span>
00297     <span class="comment">// make sure that new root has correct amount of space</span>
00298     <span class="comment">// to hold name from old root</span>
00299     <span class="comment">//</span>
00300     newcell = <a class="code" href="../../d8/d0/hivecell_8c.html#a20">HvReallocateCell</a>(Hive, newroot, size);
00301     <span class="keywordflow">if</span> (newcell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00302         status = STATUS_INSUFFICIENT_RESOURCES;
00303         <span class="keywordflow">goto</span> ErrorExit2;
00304     }
00305     newroot = newcell;
00306     ptar = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, newroot);
00307 
00308     status = STATUS_SUCCESS;
00309 
00310     RtlMoveMemory((PVOID)&amp;(ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>[0]),
00311                   (PVOID)&amp;(psrc-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>[0]),
00312                   psrc-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
00313 
00314     ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a> = psrc-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
00315     <span class="keywordflow">if</span> (psrc-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>) {
00316         ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>;
00317     } <span class="keywordflow">else</span> {
00318         ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>;
00319     }
00320 
00321     <span class="comment">//</span>
00322     <span class="comment">// newroot is now ready to have subtree copied under it, do tree copy</span>
00323     <span class="comment">//</span>
00324     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a118">CmpCopyTree</a>(&amp;(TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>),
00325                     TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a>,
00326                     Hive,
00327                     newroot) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)
00328     {
00329         status = STATUS_INSUFFICIENT_RESOURCES;
00330         <span class="keywordflow">goto</span> ErrorExit2;
00331     }
00332 
00333     <span class="comment">//</span>
00334     <span class="comment">// The new root and the tree under it now look the way we want.</span>
00335     <span class="comment">//</span>
00336 
00337     <span class="comment">//</span>
00338     <span class="comment">// Swap the new tree in for the old one.</span>
00339     <span class="comment">//</span>
00340     ptar = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);
00341     parent = ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a>;
00342 
00343     <span class="keywordflow">if</span> (ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a29">KEY_HIVE_ENTRY</a>) {
00344 
00345         <span class="comment">//</span>
00346         <span class="comment">// root is actually the root of the hive.  parent doesn't</span>
00347         <span class="comment">// refer to it via a child list, but rather with an inter hive</span>
00348         <span class="comment">// pointer.  also, must update base block</span>
00349         <span class="comment">//</span>
00350         ptar = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>( (&amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>)), parent);
00351         ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o8">ChildHiveReference</a>.<a class="code" href="../../d5/d5/struct__CM__KEY__REFERENCE.html#o0">KeyCell</a> = newroot;
00352         ptar = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, newroot);
00353         ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a> = parent;
00354         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a> = newroot;
00355 
00356 
00357     } <span class="keywordflow">else</span> {
00358 
00359         <span class="comment">//</span>
00360         <span class="comment">//  Notice that new root is *always* name of existing target,</span>
00361         <span class="comment">//      therefore, even in b-tree, old and new cell can share</span>
00362         <span class="comment">//      the same reference slot in the parent.  So simply edit</span>
00363         <span class="comment">//      the new cell_index on the top of the old.</span>
00364         <span class="comment">//</span>
00365         ptar = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, parent);
00366         Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Cell);
00367         list = ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type];
00368         count = ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[Type];
00369 
00370         ptar = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, list);
00371         <span class="keywordflow">if</span> (ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o3">KeyIndex</a>.<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a18">CM_KEY_INDEX_ROOT</a>) {
00372             NumberLeaves = ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o3">KeyIndex</a>.<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a>;
00373             LeafArray = &amp;ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o3">KeyIndex</a>.<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[0];
00374         } <span class="keywordflow">else</span> {
00375             NumberLeaves = 1;
00376             LeafArray = &amp;list;
00377         }
00378 
00379         <span class="comment">//</span>
00380         <span class="comment">// Look in each leaf for the HCELL_INDEX we need to replace</span>
00381         <span class="comment">//</span>
00382         <span class="keywordflow">for</span> (i = 0; i &lt; NumberLeaves; i++) {
00383             Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, LeafArray[i]);
00384             <span class="keywordflow">if</span> (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a20">CM_KEY_FAST_LEAF</a>) {
00385                 FastLeaf = (<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a>)Leaf;
00386                 <span class="keywordflow">for</span> (j=0; j &lt; FastLeaf-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o1">Count</a>; j++) {
00387                     <span class="keywordflow">if</span> (FastLeaf-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[j].<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o0">Cell</a> == <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>) {
00388                         FastLeaf-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[j].<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o0">Cell</a> = newroot;
00389                         <span class="keywordflow">goto</span> FoundCell;
00390                     }
00391                 }
00392             } <span class="keywordflow">else</span> {
00393                 <span class="keywordflow">for</span> (j=0; j &lt; Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a>; j++) {
00394                     <span class="keywordflow">if</span> (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[j] == <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>) {
00395 
00396                         Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[j] = newroot;
00397                         <span class="keywordflow">goto</span> FoundCell;
00398                     }
00399                 }
00400             }
00401         }
00402         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);      <span class="comment">//  implies we didn't find it</span>
00403                         <span class="comment">//  we should never get here</span>
00404     }
00405 
00406 FoundCell:
00407 
00408 
00409     <span class="comment">//</span>
00410     <span class="comment">// Fix up the key control block to point to the new root</span>
00411     <span class="comment">//</span>
00412     KeyControlBlock-&gt;KeyCell = newroot;
00413     KeyControlBlock-&gt;KeyNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, newroot);
00414 
00415     <span class="comment">//</span>
00416     <span class="comment">// Kcb has changed, update the cache information.</span>
00417     <span class="comment">// Registry locked exclusively, no need for KCB lock.</span>
00418     <span class="comment">//</span>
00419     <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
00420 
00421     <a class="code" href="../../d8/d2/cmsubs_8c.html#a16">CmpCleanUpKcbValueCache</a>(KeyControlBlock);
00422 
00423     <span class="keywordflow">if</span> (KeyControlBlock-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a11">CM_KCB_SUBKEY_HINT</a>) {
00424         <span class="comment">//</span>
00425         <span class="comment">// Now free the HintIndex allocation</span>
00426         <span class="comment">//</span>
00427         <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(KeyControlBlock-&gt;IndexHint, CM_CACHE_INDEX_TAG | PROTECTED_POOL);
00428     }
00429 
00430     KeyControlBlock-&gt;ValueCache.Count = KeyControlBlock-&gt;KeyNode-&gt;ValueList.Count;
00431     KeyControlBlock-&gt;ValueCache.ValueList = (ULONG_PTR) (KeyControlBlock-&gt;KeyNode-&gt;ValueList.List);
00432     KeyControlBlock-&gt;Flags = KeyControlBlock-&gt;KeyNode-&gt;Flags;
00433     KeyControlBlock-&gt;Security = KeyControlBlock-&gt;KeyNode-&gt;Security;
00434 
00435     KeyControlBlock-&gt;ExtFlags = 0;
00436 
00437     <span class="comment">//</span>
00438     <span class="comment">// Delete the old subtree and it's root cell</span>
00439     <span class="comment">//</span>
00440     <a class="code" href="../../d3/d3/cmtredel_8c.html#a0">CmpDeleteTree</a>(Hive, Cell);
00441     <a class="code" href="../../d3/d3/cmtredel_8c.html#a1">CmpFreeKeyByCell</a>(Hive, Cell, FALSE);
00442 
00443     <span class="comment">//</span>
00444     <span class="comment">// Report the notify event</span>
00445     <span class="comment">//</span>
00446     <a class="code" href="../../d6/d3/cmwraper_8c.html#a13">CmpReportNotify</a>(KeyControlBlock,
00447                     KeyControlBlock-&gt;KeyHive,
00448                     KeyControlBlock-&gt;KeyCell,
00449                     REG_NOTIFY_CHANGE_NAME);
00450     
00451 
00452     <span class="comment">//</span>
00453     <span class="comment">// Free the temporary hive</span>
00454     <span class="comment">//</span>
00455     <a class="code" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a>(TmpCmHive);
00456 
00457     <span class="comment">//</span>
00458     <span class="comment">// We've given user chance to log on, so turn on quota</span>
00459     <span class="comment">//</span>
00460     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/cmapi_8c.html#a2">CmpProfileLoaded</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00461         <a class="code" href="../../d8/d9/cmapi_8c.html#a2">CmpProfileLoaded</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00462         <a class="code" href="../../d1/d2/cmp_8h.html#a249">CmpSetGlobalQuotaAllowed</a>();
00463     }
00464 
00465     <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>(CONTAINING_RECORD(Hive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive));
00466     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00467     <span class="keywordflow">return</span> status;
00468 
00469 
00470     <span class="comment">//</span>
00471     <span class="comment">// Error exits</span>
00472     <span class="comment">//</span>
00473 ErrorExit2:
00474     <a class="code" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a>(TmpCmHive);
00475 ErrorExit1:
00476     <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>(CONTAINING_RECORD(Hive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive));
00477     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00478 
00479     <span class="keywordflow">return</span> status;
00480 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a235" doxytag="cmp.h::CmSaveKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmSaveKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyControlBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00862">862</a> of file <a class="el" href="../../d7/d1/cmsavres_8c-source.html">cmsavres.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00422">CM_WRAP_LIMIT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00686">CmpCopyKeyPartial()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01314">CmpCopyTree</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01439">CmpCreateTemporaryHive()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01490">CmpDestroyTemporaryHive()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00037">CmpGlobalQuotaAllowed</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00063">CmpGlobalQuotaUsed</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00038">CmpGlobalQuotaWarning</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00036">CmpMasterHive</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01261">CmpSaveKeyByFileCopy()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00261">CMS_SAVRES</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00308">DCmCheckRegistry</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00608">_HHIVE::DirtyCount</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00650">_CMHIVE::FileHandles</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00571">HFILE_TYPE_EXTERNAL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00649">_CMHIVE::Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00204">HIVE_NOLAZYFLUSH</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00622">_HHIVE::HiveFlags</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01433">HvWriteHive()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00537">_CELL_DATA::_u::KeyNode</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00343">_HBASE_BLOCK::RootCell</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02471">NtSaveKey()</a>.
<p>
<pre class="fragment"><div>00868                    :
00869 
00870 Arguments:
00871 
00872     KeyControlBlock - pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> KCB that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key
00873 
00874     FileHandle - handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to dump to.
00875 
00876 Return Value:
00877 
00878     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
00879 
00880         &lt;TBS&gt;
00881 
00882 --*/
00883 {
00884     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00885     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  proot;
00886     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>      flags;
00887     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>     TmpCmHive;
00888     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>     CmHive;
00889     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newroot;
00890     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00891     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
00892     ULONG OldQuotaAllowed;
00893     ULONG OldQuotaWarning;
00894 <span class="preprocessor">#if DBG</span>
00895 <span class="preprocessor"></span>    ULONG OldQuotaUsed;
00896 <span class="preprocessor">#endif</span>
00897 <span class="preprocessor"></span>
00898     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00899     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_SAVRES) {
00900         KdPrint((<span class="stringliteral">"CmSaveKey:\n"</span>));
00901         KdPrint((<span class="stringliteral">"\tKCB=%08lx"</span>,KeyControlBlock));
00902         KdPrint((<span class="stringliteral">"\tFileHandle=%08lx\n"</span>,FileHandle));
00903     }
00904 
00905     <span class="comment">//</span>
00906     <span class="comment">// Disallow attempts to "save" the master hive</span>
00907     <span class="comment">//</span>
00908     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyControlBlock-&gt;KeyHive;
00909     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = KeyControlBlock-&gt;KeyCell;
00910 
00911     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> == &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>) {
00912         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00913     }
00914 
00915     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
00916 
00917     <span class="keywordflow">if</span> (KeyControlBlock-&gt;Delete) {
00918         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00919         <span class="keywordflow">return</span> STATUS_KEY_DELETED;
00920     }
00921 
00922     <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>(CONTAINING_RECORD(Hive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive));
00923 
00924     <span class="keywordflow">if</span> ( (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a10">HIVE_NOLAZYFLUSH</a>) &amp;&amp;
00925          (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> != 0))
00926     {
00927         <span class="comment">//</span>
00928         <span class="comment">// It's a NOLAZY hive, and there's some dirty data, so writing</span>
00929         <span class="comment">// out a snapshot of what's in memory will not give the caller</span>
00930         <span class="comment">// consistent user data.  Therefore, copy the on disk image</span>
00931         <span class="comment">// instead of the memory image</span>
00932         <span class="comment">//</span>
00933 
00934         <span class="comment">//</span>
00935         <span class="comment">// Note that this will generate weird results if the key</span>
00936         <span class="comment">// being saved is not the root of the hive, since the</span>
00937         <span class="comment">// resulting file will always be a copy of the entire hive, not</span>
00938         <span class="comment">// just the subtree they asked for.</span>
00939         <span class="comment">//</span>
00940         status = <a class="code" href="../../d6/d2/cmsavres_8c.html#a11">CmpSaveKeyByFileCopy</a>((<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)Hive, FileHandle);
00941         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00942         <span class="keywordflow">return</span> status;
00943     }
00944 
00945     proot = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);
00946     flags = proot-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a>;
00947 
00948 
00949     <span class="comment">//</span>
00950     <span class="comment">// Always try to copy the hive and write it out.  This has the</span>
00951     <span class="comment">// effect of compressing out unused free storage.</span>
00952     <span class="comment">// If there isn't space, and the savekey is of the root of the</span>
00953     <span class="comment">// hive, then just write it out directly.  (i.e. don't fail on</span>
00954     <span class="comment">// a whole hive restore just because we're out of memory.)</span>
00955     <span class="comment">//</span>
00956     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SAVRES) KdPrint(("\tSave of partial hive\n"));
00957 
00958     <span class="comment">//</span>
00959     <span class="comment">// The subtree the caller wants does not exactly match a</span>
00960     <span class="comment">// subtree.  Make a temporary hive, tree copy the source</span>
00961     <span class="comment">// to temp, write out the temporary, free the temporary.</span>
00962     <span class="comment">//</span>
00963 
00964     <span class="comment">//</span>
00965     <span class="comment">// temporarily disable registry quota as we will be giving this memory back immediately!</span>
00966     <span class="comment">//</span>
00967     OldQuotaAllowed = CmpGlobalQuotaAllowed;
00968     OldQuotaWarning = CmpGlobalQuotaWarning;
00969     CmpGlobalQuotaAllowed = CM_WRAP_LIMIT;
00970     CmpGlobalQuotaWarning = CM_WRAP_LIMIT;
00971 
00972 #if DBG
00973     OldQuotaUsed = CmpGlobalQuotaUsed;
00974 #endif
00975 
00976     <span class="comment">//</span>
00977     <span class="comment">// Create the temporary hive</span>
00978     <span class="comment">//</span>
00979 
00980     TmpCmHive = CmpCreateTemporaryHive(FileHandle);
00981     if (TmpCmHive == NULL) {
00982         status =  STATUS_INSUFFICIENT_RESOURCES;
00983         <span class="keywordflow">goto</span> ErrorInsufficientResources;
00984     }
00985 
00986     <span class="comment">//</span>
00987     <span class="comment">// Create a root cell, mark it as such</span>
00988     <span class="comment">//</span>
00989 
00990     newroot = <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a11">CmpCopyKeyPartial</a>(
00991                 Hive,
00992                 Cell,
00993                 &amp;(TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>),
00994                 HCELL_NIL,          <span class="comment">// will force KEY_HIVE_ENTRY set</span>
00995                 TRUE);
00996     <span class="keywordflow">if</span> (newroot == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00997         status = STATUS_INSUFFICIENT_RESOURCES;
00998         <span class="keywordflow">goto</span> ErrorInsufficientResources;
00999     }
01000     TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a> = newroot;
01001 
01002     <span class="comment">//</span>
01003     <span class="comment">// Do a tree copy</span>
01004     <span class="comment">//</span>
01005     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a118">CmpCopyTree</a>(Hive, Cell, &amp;(TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>), newroot) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01006         status = STATUS_INSUFFICIENT_RESOURCES;
01007         <span class="keywordflow">goto</span> ErrorInsufficientResources;
01008     }
01009 
01010     <span class="comment">//</span>
01011     <span class="comment">// Write the file</span>
01012     <span class="comment">//</span>
01013     TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a>] = FileHandle;
01014     status = <a class="code" href="../../d0/d2/hivesync_8c.html#a15">HvWriteHive</a>(&amp;(TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>));
01015     TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a>] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01016 
01017     <span class="comment">//</span>
01018     <span class="comment">// Error exits</span>
01019     <span class="comment">//</span>
01020 ErrorInsufficientResources:
01021 
01022     <span class="comment">//</span>
01023     <span class="comment">// Free the temporary hive</span>
01024     <span class="comment">//</span>
01025     <span class="keywordflow">if</span> (TmpCmHive != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01026         <a class="code" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a>(TmpCmHive);
01027     }
01028 
01029 <span class="preprocessor">#if DBG</span>
01030 <span class="preprocessor"></span>    <span class="comment">//</span>
01031     <span class="comment">// Sanity check: when this assert fires, we have leaks in the copy routine.</span>
01032     <span class="comment">//</span>
01033     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( OldQuotaUsed == CmpGlobalQuotaUsed );
01034 <span class="preprocessor">#endif</span>
01035 <span class="preprocessor"></span>
01036     <span class="comment">//</span>
01037     <span class="comment">// Set global quota back to what it was.</span>
01038     <span class="comment">//</span>
01039     <a class="code" href="../../d8/d9/cmapi_8c.html#a7">CmpGlobalQuotaAllowed</a> = OldQuotaAllowed;
01040     <a class="code" href="../../d8/d9/cmapi_8c.html#a8">CmpGlobalQuotaWarning</a> = OldQuotaWarning;
01041     <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>(CONTAINING_RECORD(Hive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive));
01042     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01043     <span class="keywordflow">return</span> status;
01044 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a236" doxytag="cmp.h::CmSaveMergedKeys" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmSaveMergedKeys           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>HighPrecedenceKcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LowPrecedenceKcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01047">1047</a> of file <a class="el" href="../../d7/d1/cmsavres_8c-source.html">cmsavres.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00422">CM_WRAP_LIMIT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00686">CmpCopyKeyPartial()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01314">CmpCopyTree</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01439">CmpCreateTemporaryHive()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01490">CmpDestroyTemporaryHive()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00037">CmpGlobalQuotaAllowed</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00063">CmpGlobalQuotaUsed</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00038">CmpGlobalQuotaWarning</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d2/d3/cmtrecpy_8c.html#a6">CmpMergeKeyValues()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01351">CmpMergeTrees</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00261">CMS_SAVRES</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00308">DCmCheckRegistry</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00608">_HHIVE::DirtyCount</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00650">_CMHIVE::FileHandles</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00571">HFILE_TYPE_EXTERNAL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00649">_CMHIVE::Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00204">HIVE_NOLAZYFLUSH</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00622">_HHIVE::HiveFlags</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01433">HvWriteHive()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00537">_CELL_DATA::_u::KeyNode</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00343">_HBASE_BLOCK::RootCell</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02559">NtSaveMergedKeys()</a>.
<p>
<pre class="fragment"><div>01054                    :
01055 
01056 Arguments:
01057 
01058     HighPrecedenceKcb - pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> KCB that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> High precedence key 
01059                         (<a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> one that wins in a duplicate key <span class="keywordflow">case</span>)
01060 
01061     LowPrecedenceKcb - pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> KCB that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Low precedence key 
01062                         (<a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> one that gets overwritten in a duplicate key <span class="keywordflow">case</span>)
01063 
01064     FileHandle - handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to dump to.
01065 
01066 Return Value:
01067 
01068     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
01069 
01070         &lt;TBS&gt;
01071 
01072 --*/
01073 {
01074     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
01075     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  proot;
01076     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>      flags;
01077     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>     TmpCmHive;
01078     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newroot;
01079     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> HighHive;
01080     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> LowHive;
01081     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> HighCell;
01082     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> LowCell;
01083     ULONG OldQuotaAllowed;
01084     ULONG OldQuotaWarning;
01085     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> HighNode,LowNode;
01086 <span class="preprocessor">#if DBG</span>
01087 <span class="preprocessor"></span>    ULONG OldQuotaUsed;
01088 <span class="preprocessor">#endif</span>
01089 <span class="preprocessor"></span>
01090     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01091     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_SAVRES) {
01092         KdPrint((<span class="stringliteral">"CmSaveMergedKeys:\n"</span>));
01093         KdPrint((<span class="stringliteral">"\tHighKCB=%08lx"</span>,HighPrecedenceKcb));
01094         KdPrint((<span class="stringliteral">"\tLowKCB=%08lx"</span>,LowPrecedenceKcb));
01095         KdPrint((<span class="stringliteral">"\tFileHandle=%08lx\n"</span>,FileHandle));
01096     }
01097 
01098     <span class="comment">//</span>
01099     <span class="comment">// Disallow attempts to "merge" keys located in the same hive</span>
01100     <span class="comment">// A brutal way to avoid recursivity</span>
01101     <span class="comment">//</span>
01102     HighHive = HighPrecedenceKcb-&gt;KeyHive;
01103     HighCell = HighPrecedenceKcb-&gt;KeyCell;
01104     LowHive = LowPrecedenceKcb-&gt;KeyHive;
01105     LowCell = LowPrecedenceKcb-&gt;KeyCell;
01106 
01107     <span class="keywordflow">if</span> (LowHive  == HighHive ) {
01108         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01109     }
01110 
01111     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
01112 
01113     <span class="keywordflow">if</span> (HighPrecedenceKcb-&gt;Delete || LowPrecedenceKcb-&gt;Delete) {
01114         <span class="comment">//</span>
01115         <span class="comment">// Unlock the registry and fail if one of the keys are marked as deleted</span>
01116         <span class="comment">//</span>
01117         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01118         <span class="keywordflow">return</span> STATUS_KEY_DELETED;
01119     }
01120 
01121     <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>(CONTAINING_RECORD(HighHive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive));
01122     <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>(CONTAINING_RECORD(LowHive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive));
01123 
01124 
01125     <span class="keywordflow">if</span>( ((HighHive-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a10">HIVE_NOLAZYFLUSH</a>) &amp;&amp; (HighHive-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> != 0)) ||
01126         ((LowHive-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a10">HIVE_NOLAZYFLUSH</a>) &amp;&amp; (LowHive-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> != 0)) ) {
01127         <span class="comment">//</span>
01128         <span class="comment">// Reject the call when one of the hives is a NOLAZY hive and there's</span>
01129         <span class="comment">// some dirty data. Another alternative will be to save only one of the </span>
01130         <span class="comment">// trees (if a valid one exists) or an entire hive (see CmSaveKey)</span>
01131         <span class="comment">//</span>
01132         status =  STATUS_INVALID_PARAMETER;
01133         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01134         <span class="keywordflow">return</span> status;
01135     }
01136 
01137     proot = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(LowHive, LowCell);
01138     flags = proot-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a>;
01139 
01140 
01141     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SAVRES) KdPrint(("\tCopy of partial HighHive\n"));
01142 
01143     <span class="comment">//</span>
01144     <span class="comment">// Make a temporary hive, tree copy the key subtree from</span>
01145     <span class="comment">// HighHive hive to temp, tree-merge with the key subtree from</span>
01146     <span class="comment">// LowHive hive, write out the temporary, free the temporary.</span>
01147     <span class="comment">// Always write the HighHive subtree first, so its afterwise</span>
01148     <span class="comment">// only add new keys/values</span>
01149     <span class="comment">// </span>
01150 
01151     <span class="comment">//</span>
01152     <span class="comment">// temporarily disable registry quota as we will be giving this memory back immediately!</span>
01153     <span class="comment">//</span>
01154     OldQuotaAllowed = CmpGlobalQuotaAllowed;
01155     OldQuotaWarning = CmpGlobalQuotaWarning;
01156     CmpGlobalQuotaAllowed = CM_WRAP_LIMIT;
01157     CmpGlobalQuotaWarning = CM_WRAP_LIMIT;
01158 
01159 #if DBG
01160     OldQuotaUsed = CmpGlobalQuotaUsed;
01161 #endif
01162 
01163     <span class="comment">//</span>
01164     <span class="comment">// Create the temporary hive</span>
01165     <span class="comment">//</span>
01166 
01167     TmpCmHive = CmpCreateTemporaryHive(FileHandle);
01168     if (TmpCmHive == NULL) {
01169         status =  STATUS_INSUFFICIENT_RESOURCES;
01170         <span class="keywordflow">goto</span> ErrorInsufficientResources;
01171     }
01172 
01173     <span class="comment">//</span>
01174     <span class="comment">// Create a root cell, mark it as such</span>
01175     <span class="comment">//</span>
01176 
01177     newroot = <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a11">CmpCopyKeyPartial</a>(
01178                 HighHive,
01179                 HighCell,
01180                 &amp;(TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>),
01181                 HCELL_NIL,          <span class="comment">// will force KEY_HIVE_ENTRY set</span>
01182                 TRUE);
01183     <span class="keywordflow">if</span> (newroot == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01184         status = STATUS_INSUFFICIENT_RESOURCES;
01185         <span class="keywordflow">goto</span> ErrorInsufficientResources;
01186     }
01187     TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a> = newroot;
01188 
01189     <span class="comment">//</span>
01190     <span class="comment">// Do a tree copy. Copy the HighCell tree from HighHive first.</span>
01191     <span class="comment">//</span>
01192     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a118">CmpCopyTree</a>(HighHive, HighCell, &amp;(TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>), newroot) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01193         status = STATUS_INSUFFICIENT_RESOURCES;
01194         <span class="keywordflow">goto</span> ErrorInsufficientResources;
01195     }
01196 
01197     <span class="comment">//</span>
01198     <span class="comment">// Merge the values in the root node of the merged subtrees</span>
01199     <span class="comment">//</span>
01200     LowNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(LowHive, LowCell);                                         
01201     HighNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(&amp;(TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>),newroot);
01202 
01203     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d3/cmtrecpy_8c.html#a6">CmpMergeKeyValues</a>(LowHive, LowCell, LowNode, &amp;(TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>), newroot, HighNode) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ){
01204         status = STATUS_INSUFFICIENT_RESOURCES;
01205         <span class="keywordflow">goto</span> ErrorInsufficientResources;
01206     }
01207 
01208     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SAVRES) KdPrint(("\tMerge partial LowHive over the HighHive\n"));
01209 
01210     <span class="comment">//</span>
01211     <span class="comment">// Merge the two trees. A Merge operation is a sync that obeys</span>
01212     <span class="comment">// the following aditional rules:</span>
01213     <span class="comment">//      1. keys the exist in the taget tree and does not exist</span>
01214     <span class="comment">//      in the source tree remain as they are (don't get deleted)</span>
01215     <span class="comment">//      2. keys the doesn't exist both in the target tree are added</span>
01216     <span class="comment">//      "as they are" from the source tree (always the target tree</span>
01217     <span class="comment">//      has a higher precedence)</span>
01218     <span class="comment">// </span>
01219     if (CmpMergeTrees(LowHive, LowCell, &amp;(TmpCmHive-&gt;Hive), newroot) == FALSE) {
01220         status = STATUS_INSUFFICIENT_RESOURCES;
01221         <span class="keywordflow">goto</span> ErrorInsufficientResources;
01222     }
01223     
01224     <span class="comment">//</span>
01225     <span class="comment">// Write the file</span>
01226     <span class="comment">//</span>
01227     TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a>] = FileHandle;
01228     status = <a class="code" href="../../d0/d2/hivesync_8c.html#a15">HvWriteHive</a>(&amp;(TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>));
01229     TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a>] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01230 
01231     <span class="comment">//</span>
01232     <span class="comment">// Error exits</span>
01233     <span class="comment">//</span>
01234 ErrorInsufficientResources:
01235     <span class="comment">//</span>
01236     <span class="comment">// Free the temporary hive</span>
01237     <span class="comment">//</span>
01238     <span class="keywordflow">if</span> (TmpCmHive != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01239         <a class="code" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a>(TmpCmHive);
01240     }
01241 
01242 <span class="preprocessor">#if DBG</span>
01243 <span class="preprocessor"></span>    <span class="comment">//</span>
01244     <span class="comment">// Sanity check: when this assert fires, we have leaks in the merge routine.</span>
01245     <span class="comment">//</span>
01246     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( OldQuotaUsed == CmpGlobalQuotaUsed );
01247 <span class="preprocessor">#endif</span>
01248 <span class="preprocessor"></span>    <span class="comment">//</span>
01249     <span class="comment">// Set global quota back to what it was.</span>
01250     <span class="comment">//</span>
01251     <a class="code" href="../../d8/d9/cmapi_8c.html#a7">CmpGlobalQuotaAllowed</a> = OldQuotaAllowed;
01252     <a class="code" href="../../d8/d9/cmapi_8c.html#a8">CmpGlobalQuotaWarning</a> = OldQuotaWarning;
01253     <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>(CONTAINING_RECORD(HighHive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive));
01254     <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>(CONTAINING_RECORD(LowHive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive));
01255     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01256     <span class="keywordflow">return</span> status;
01257 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a314" doxytag="cmp.h::CmSetAcpiHwProfile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmSetAcpiHwProfile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html">PPROFILE_ACPI_DOCKING_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DockState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN&nbsp;</td>
          <td class="mdname" nowrap> <em>PCM_ACPI_SELECTION_ROUTINE</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>NewProfile</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ProfileChanged</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00805">805</a> of file <a class="el" href="../../d7/d1/hwprofil_8c-source.html">hwprofil.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l01659">_CM_HARDWARE_PROFILE_ACPI_ALIAS_LIST::Alias</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01583">CM_HARDWARE_PROFILE_STR_ACPI_SERIAL_NUMBER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01568">CM_HARDWARE_PROFILE_STR_CCS_CURRENT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01567">CM_HARDWARE_PROFILE_STR_CCS_HWPROFILE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01593">CM_HARDWARE_PROFILE_STR_CURRENT_DOCK_INFO</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01566">CM_HARDWARE_PROFILE_STR_DATABASE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01579">CM_HARDWARE_PROFILE_STR_DOCKING_STATE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01628">CM_HP_FLAGS_DUPLICATE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01627">CM_HP_FLAGS_PRISTINE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01626">CM_HP_FLAGS_TRUE_MATCH</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00544">CmpAddAcpiAliasEntry()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01869">CmpCloneHwProfile()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01282">CmpFilterAcpiDockingState()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00076">CmpGetAcpiProfileInformation()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01513">CmpMoveBiosAliasTable()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00035">CmSymbolicLinkValueName</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01658">_CM_HARDWARE_PROFILE_ACPI_ALIAS_LIST::CurrentAliasCount</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01632">_CM_HARDWARE_PROFILE_LIST::CurrentProfileCount</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01622">_CM_HARDWARE_PROFILE::Flags</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01619">_CM_HARDWARE_PROFILE::FriendlyName</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01621">_CM_HARDWARE_PROFILE::Id</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01633">_CM_HARDWARE_PROFILE_LIST::Profile</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01653">_CM_HARDWARE_PROFILE_ACPI_ALIAS::SerialNumber</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02786">CmpCreateControlSet()</a>, and <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l01028">IopExecuteHardwareProfileChange()</a>.
<p>
<pre class="fragment"><div>00813                    :
00814 
00815     The ACPI docking state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> machine has changed.
00816 
00817     Based on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> change calculate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a> Profile(s) consitent with the
00818     new ACPI docking state.
00819 
00820     Pass the list of known profiles to the callers selection routine.
00821 
00822     Set the new current profile.
00823 
00824     Patch up any ACPI alias entries if a new profile for this ACPI state has
00825     been used.
00826 
00827 Arguments:
00828 
00829     NewDockStateArray - The list of possible Docking States that we might enter.
00830 
00831     Select - Call back to select which profile to enter, given the list of
00832              possible profiles.
00833 
00834 --*/
00835 {
00836     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        status = STATUS_SUCCESS;
00837     HANDLE          IDConfigDB = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00838     HANDLE          HardwareProfile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00839     HANDLE          currentInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00840     HANDLE          currentSymLink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00841     HANDLE          parent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00842     WCHAR           nameBuffer[128];
00843     UNICODE_STRING  name;
00844     UCHAR           valueBuffer[256];
00845     ULONG           len;
00846     ULONG           i;
00847     ULONG           selectedElement;
00848     ULONG           profileNum;
00849     ULONG           currentDockingState;
00850     ULONG           currentProfileNumber;
00851     ULONG           disposition;
00852     ULONG           flags;
00853     PWCHAR          currentAcpiSN = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00854     <a class="code" href="../../d7/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS__LIST.html">PCM_HARDWARE_PROFILE_ACPI_ALIAS_LIST</a>  AliasList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00855     <a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">PCM_HARDWARE_PROFILE_LIST</a>             ProfileList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00856     PKEY_VALUE_FULL_INFORMATION           value;
00857     OBJECT_ATTRIBUTES                     attributes;
00858 
00859     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
00860 
00861     *ProfileChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00862 
00863     value = (PKEY_VALUE_FULL_INFORMATION) valueBuffer;
00864 
00865     <span class="comment">//</span>
00866     <span class="comment">// Open The Hardware Profile Database</span>
00867     <span class="comment">//</span>
00868     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, CM_HARDWARE_PROFILE_STR_DATABASE);
00869     InitializeObjectAttributes (&amp;attributes,
00870                                 &amp;name,
00871                                 OBJ_CASE_INSENSITIVE,
00872                                 NULL,
00873                                 NULL);
00874 
00875     status = ZwOpenKey (&amp;IDConfigDB,
00876                         KEY_READ,
00877                         &amp;attributes);
00878 
00879     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00880         IDConfigDB = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00881         <span class="keywordflow">goto</span> Clean;
00882     }
00883 
00884     <span class="comment">//</span>
00885     <span class="comment">// Obtain the total list of profiles</span>
00886     <span class="comment">//</span>
00887     status = <a class="code" href="../../d6/d2/hwprofil_8c.html#a2">CmpGetAcpiProfileInformation</a> (IDConfigDB,
00888                                            &amp;ProfileList,
00889                                            &amp;AliasList,
00890                                            nameBuffer,
00891                                            valueBuffer,
00892                                            <span class="keyword">sizeof</span> (valueBuffer));
00893 
00894     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00895         <span class="keywordflow">goto</span> Clean;
00896     }
00897 
00898     <span class="comment">//</span>
00899     <span class="comment">// Determine the current Dock information.</span>
00900     <span class="comment">//</span>
00901     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, CM_HARDWARE_PROFILE_STR_CCS_CURRENT);
00902     InitializeObjectAttributes (&amp;attributes,
00903                                 &amp;name,
00904                                 OBJ_CASE_INSENSITIVE,
00905                                 NULL,
00906                                 NULL);
00907 
00908     status = ZwOpenKey (&amp;HardwareProfile,
00909                         KEY_READ,
00910                         &amp;attributes);
00911     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00912         HardwareProfile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00913         <span class="keywordflow">goto</span> Clean;
00914     }
00915     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, CM_HARDWARE_PROFILE_STR_CURRENT_DOCK_INFO);
00916     InitializeObjectAttributes (&amp;attributes,
00917                                 &amp;name,
00918                                 OBJ_CASE_INSENSITIVE,
00919                                 IDConfigDB,
00920                                 NULL);
00921 
00922     status = ZwOpenKey (&amp;currentInfo,
00923                         KEY_READ,
00924                         &amp;attributes);
00925     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00926         currentInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00927         <span class="keywordflow">goto</span> Clean;
00928     }
00929 
00930     <span class="comment">//</span>
00931     <span class="comment">// The current Docking State</span>
00932     <span class="comment">//</span>
00933     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, CM_HARDWARE_PROFILE_STR_DOCKING_STATE);
00934     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a> (currentInfo,
00935                               &amp;name,
00936                               KeyValueFullInformation,
00937                               valueBuffer,
00938                               <span class="keyword">sizeof</span> (valueBuffer),
00939                               &amp;len);
00940 
00941     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status) || (value-&gt;Type != REG_DWORD)) {
00942         status = STATUS_REGISTRY_CORRUPT;
00943         <span class="keywordflow">goto</span> Clean;
00944     }
00945     currentDockingState = * (PULONG) ((PUCHAR) value + value-&gt;DataOffset);
00946 
00947     <span class="comment">//</span>
00948     <span class="comment">// The current ACPI Serial Number</span>
00949     <span class="comment">//</span>
00950     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, CM_HARDWARE_PROFILE_STR_ACPI_SERIAL_NUMBER);
00951     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(currentInfo,
00952                              &amp;name,
00953                              KeyValueFullInformation,
00954                              valueBuffer,
00955                              <span class="keyword">sizeof</span> (valueBuffer),
00956                              &amp;len);
00957 
00958     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status) &amp;&amp; (value-&gt;Type == REG_BINARY)) {
00959 
00960         currentAcpiSN = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a> (PagedPool, value-&gt;DataLength);
00961 
00962         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == currentAcpiSN) {
00963             status = STATUS_INSUFFICIENT_RESOURCES;
00964             <span class="keywordflow">goto</span> Clean;
00965         }
00966         RtlCopyMemory (currentAcpiSN,
00967                        (PUCHAR) value + value-&gt;DataOffset,
00968                        value-&gt;DataLength);
00969     } <span class="keywordflow">else</span> {
00970         currentAcpiSN = 0;
00971     }
00972 
00973     <span class="comment">//</span>
00974     <span class="comment">// The current Profile Number</span>
00975     <span class="comment">//</span>
00976     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;name, L<span class="stringliteral">"CurrentConfig"</span>);
00977     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(IDConfigDB,
00978                              &amp;name,
00979                              KeyValueFullInformation,
00980                              valueBuffer,
00981                              <span class="keyword">sizeof</span> (valueBuffer),
00982                              &amp;len);
00983 
00984     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) || (value-&gt;Type != REG_DWORD)) {
00985         status = STATUS_REGISTRY_CORRUPT;
00986         <span class="keywordflow">goto</span> Clean;
00987     }
00988     currentProfileNumber = *(PULONG)((PUCHAR)value + value-&gt;DataOffset);
00989 
00990     <span class="comment">//</span>
00991     <span class="comment">// Filter the current list of hardware profiles based on the current</span>
00992     <span class="comment">// docking state, the new acpi state, and the acpi alias tables</span>
00993     <span class="comment">//</span>
00994     status = <a class="code" href="../../d6/d2/hwprofil_8c.html#a3">CmpFilterAcpiDockingState</a> (NewDockState,
00995                                         currentDockingState,
00996                                         currentAcpiSN,
00997                                         currentProfileNumber,
00998                                         ProfileList,
00999                                         AliasList);
01000 
01001     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01002         <span class="keywordflow">goto</span> Clean;
01003     }
01004 
01005     <span class="comment">//</span>
01006     <span class="comment">// Allow the caller a chance to select from the filtered list.</span>
01007     <span class="comment">//</span>
01008     status = Select (ProfileList, &amp;selectedElement, Context);
01009 
01010     <span class="comment">//</span>
01011     <span class="comment">// If the user selected -1 then he is not interested in selecting any of</span>
01012     <span class="comment">// the profiles.</span>
01013     <span class="comment">//</span>
01014     <span class="keywordflow">if</span> (-1 == selectedElement) {
01015         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (STATUS_MORE_PROCESSING_REQUIRED == status);
01016         <span class="keywordflow">goto</span> Clean;
01017     }
01018 
01019     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01020         <span class="keywordflow">goto</span> Clean;
01021     }
01022 
01023     <span class="comment">//</span>
01024     <span class="comment">// Fine! We have finally made the new selection.</span>
01025     <span class="comment">// Set it.</span>
01026     <span class="comment">//</span>
01027 
01028     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, CM_HARDWARE_PROFILE_STR_CCS_HWPROFILE);
01029     InitializeObjectAttributes (&amp;attributes,
01030                                 &amp;name,
01031                                 OBJ_CASE_INSENSITIVE,
01032                                 NULL,
01033                                 NULL);
01034     status = ZwOpenKey (&amp;parent, KEY_READ, &amp;attributes);
01035     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01036         parent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01037         <span class="keywordflow">goto</span> Clean;
01038     }
01039 
01040     <span class="comment">//</span>
01041     <span class="comment">// How did we get here?</span>
01042     <span class="comment">//</span>
01043     flags = ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o2">Profile</a>[selectedElement].<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o4">Flags</a>;
01044     profileNum = ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o2">Profile</a>[selectedElement].<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o3">Id</a>;
01045 
01046     <span class="comment">//</span>
01047     <span class="comment">// Check for duplicate</span>
01048     <span class="comment">//</span>
01049     <span class="keywordflow">if</span> (flags &amp; <a class="code" href="../../d1/d2/cmp_8h.html#a150">CM_HP_FLAGS_DUPLICATE</a>) {
01050         <span class="comment">//</span>
01051         <span class="comment">// If there is a duplicate then we need to adjust the pnp</span>
01052         <span class="comment">// bios alias table.</span>
01053         <span class="comment">//</span>
01054         <span class="comment">// This happens if we booted PnP bios detected docked, and then</span>
01055         <span class="comment">// we received a set state for ACPI as docked, then we have the</span>
01056         <span class="comment">// potential for duplicates.  See Comment in CmpFilterAcpiDockingState</span>
01057         <span class="comment">// for details.</span>
01058         <span class="comment">//</span>
01059         <span class="comment">// We need to find any pnp bios alias entries that match the current</span>
01060         <span class="comment">// state and point them to the duplicate entry.</span>
01061         <span class="comment">//</span>
01062 
01063         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (flags &amp; CM_HP_FLAGS_TRUE_MATCH);
01064         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (!(flags &amp; CM_HP_FLAGS_PRISTINE));
01065 
01066         status = <a class="code" href="../../d6/d2/hwprofil_8c.html#a4">CmpMoveBiosAliasTable</a> (IDConfigDB,
01067                                         currentInfo,
01068                                         currentProfileNumber,
01069                                         profileNum,
01070                                         nameBuffer,
01071                                         valueBuffer,
01072                                         <span class="keyword">sizeof</span> (valueBuffer));
01073 
01074         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01075             <span class="keywordflow">goto</span> Clean;
01076         }
01077     }
01078 
01079     <span class="keywordflow">if</span> ((flags &amp; <a class="code" href="../../d1/d2/cmp_8h.html#a149">CM_HP_FLAGS_PRISTINE</a>) || (profileNum != currentProfileNumber)){
01080         <span class="comment">//</span>
01081         <span class="comment">// The profile Number Changed or will change.</span>
01082         <span class="comment">//</span>
01083         *ProfileChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01084 
01085         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (currentInfo);
01086         ZwClose (currentInfo);
01087         currentInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01088 
01089         <span class="keywordflow">if</span> (flags &amp; <a class="code" href="../../d1/d2/cmp_8h.html#a149">CM_HP_FLAGS_PRISTINE</a>) {
01090             <span class="comment">//</span>
01091             <span class="comment">// If the selected profile is pristine then we need to clone.</span>
01092             <span class="comment">//</span>
01093             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (!(flags &amp; CM_HP_FLAGS_TRUE_MATCH));
01094             status = <a class="code" href="../../d6/d2/hwprofil_8c.html#a7">CmpCloneHwProfile</a> (IDConfigDB,
01095                                         parent,
01096                                         HardwareProfile,
01097                                         profileNum,
01098                                         NewDockState-&gt;DockingState,
01099                                         &amp;HardwareProfile,
01100                                         &amp;profileNum);
01101             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01102                 HardwareProfile = 0;
01103                 <span class="keywordflow">goto</span> Clean;
01104             }
01105         } <span class="keywordflow">else</span> {
01106             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (HardwareProfile);
01107             ZwClose (HardwareProfile);
01108 
01109             <span class="comment">//</span>
01110             <span class="comment">// Open the new profile</span>
01111             <span class="comment">//</span>
01112             swprintf (nameBuffer, L<span class="stringliteral">"%04d\0"</span>, profileNum);
01113             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, nameBuffer);
01114             InitializeObjectAttributes (&amp;attributes,
01115                                         &amp;name,
01116                                         OBJ_CASE_INSENSITIVE,
01117                                         parent,
01118                                         NULL);
01119             status = ZwOpenKey (&amp;HardwareProfile, KEY_READ, &amp;attributes);
01120             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01121                 HardwareProfile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01122                 <span class="keywordflow">goto</span> Clean;
01123             }
01124         }
01125 
01126         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (currentProfileNumber != profileNum);
01127 
01128         <span class="comment">//</span>
01129         <span class="comment">// Open the current info for the profile.</span>
01130         <span class="comment">//</span>
01131         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, CM_HARDWARE_PROFILE_STR_CURRENT_DOCK_INFO);
01132         InitializeObjectAttributes (&amp;attributes,
01133                                     &amp;name,
01134                                     OBJ_CASE_INSENSITIVE,
01135                                     IDConfigDB,
01136                                     NULL);
01137 
01138         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a> (&amp;currentInfo,
01139                               KEY_READ | KEY_WRITE,
01140                               &amp;attributes,
01141                               0,
01142                               NULL,
01143                               REG_OPTION_VOLATILE,
01144                               &amp;disposition);
01145 
01146         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01147             currentInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01148             <span class="keywordflow">goto</span> Clean;
01149         }
01150 
01151         <span class="comment">//</span>
01152         <span class="comment">// Set CurrentConfig in the Database</span>
01153         <span class="comment">//</span>
01154         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;name, L<span class="stringliteral">"CurrentConfig"</span>);
01155         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(IDConfigDB,
01156                                  &amp;name,
01157                                  0,
01158                                  REG_DWORD,
01159                                  &amp;profileNum,
01160                                  <span class="keyword">sizeof</span> (profileNum));
01161 
01162          <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01163             status = STATUS_REGISTRY_CORRUPT;
01164             <span class="keywordflow">goto</span> Clean;
01165         }
01166     }
01167 
01168     <span class="comment">//</span>
01169     <span class="comment">// Write the new Docking State to the current Info key</span>
01170     <span class="comment">//</span>
01171     i = NewDockState-&gt;DockingState;
01172     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, CM_HARDWARE_PROFILE_STR_DOCKING_STATE);
01173     status = ZwSetValueKey (currentInfo,
01174                             &amp;name,
01175                             0,
01176                             REG_DWORD,
01177                             &amp;i,
01178                             <span class="keyword">sizeof</span> (ULONG));
01179 
01180     <span class="comment">//</span>
01181     <span class="comment">// Write the new ACPI information to the current Info key</span>
01182     <span class="comment">//</span>
01183     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, CM_HARDWARE_PROFILE_STR_ACPI_SERIAL_NUMBER);
01184     status = ZwSetValueKey (currentInfo,
01185                             &amp;name,
01186                             0,
01187                             REG_BINARY,
01188                             NewDockState-&gt;SerialNumber,
01189                             NewDockState-&gt;SerialLength);
01190 
01191     <span class="keywordflow">if</span> (!(flags &amp; <a class="code" href="../../d1/d2/cmp_8h.html#a148">CM_HP_FLAGS_TRUE_MATCH</a>)) {
01192         <span class="comment">//</span>
01193         <span class="comment">// Add the alias entry for this profile.</span>
01194         <span class="comment">//</span>
01195         status = <a class="code" href="../../d6/d2/hwprofil_8c.html#a5">CmpAddAcpiAliasEntry</a> (IDConfigDB,
01196                                        NewDockState,
01197                                        profileNum,
01198                                        nameBuffer,
01199                                        valueBuffer,
01200                                        <span class="keyword">sizeof</span> (valueBuffer),
01201                                        FALSE); <span class="comment">// Don't Prevent Duplication</span>
01202     }
01203 
01204     <span class="keywordflow">if</span> (profileNum != currentProfileNumber) {
01205         <span class="comment">//</span>
01206         <span class="comment">// Move the symbolic link.</span>
01207         <span class="comment">//</span>
01208         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;name, CM_HARDWARE_PROFILE_STR_CCS_CURRENT);
01209         InitializeObjectAttributes(&amp;attributes,
01210                                    &amp;name,
01211                                    OBJ_CASE_INSENSITIVE | OBJ_OPENLINK,
01212                                    NULL,
01213                                    NULL);
01214 
01215         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(&amp;currentSymLink,
01216                              KEY_CREATE_LINK,
01217                              &amp;attributes,
01218                              0,
01219                              NULL,
01220                              REG_OPTION_OPEN_LINK,
01221                              &amp;disposition);
01222 
01223         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (STATUS_SUCCESS == status);
01224         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (REG_OPENED_EXISTING_KEY == disposition);
01225 
01226         swprintf (nameBuffer,
01227                   L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Hardware Profiles\\%04d"</span>,
01228                   profileNum);
01229         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, nameBuffer);
01230         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (currentSymLink,
01231                                 &amp;CmSymbolicLinkValueName,
01232                                 0,
01233                                 REG_LINK,
01234                                 name.Buffer,
01235                                 name.Length);
01236 
01237         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (STATUS_SUCCESS == status);
01238     }
01239 
01240 
01241 Clean:
01242     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01243         <span class="comment">// NB more process required is not a success code.</span>
01244         *NewProfile = HardwareProfile;
01245     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != HardwareProfile) {
01246         ZwClose (HardwareProfile);
01247     }
01248 
01249     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != IDConfigDB) {
01250         ZwClose (IDConfigDB);
01251     }
01252     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != currentInfo) {
01253         ZwClose (currentInfo);
01254     }
01255     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != parent) {
01256         ZwClose (parent);
01257     }
01258     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != currentAcpiSN) {
01259         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (currentAcpiSN);
01260     }
01261     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != ProfileList) {
01262         <span class="keywordflow">for</span> (i = 0; i &lt; ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o1">CurrentProfileCount</a>; i++) {
01263             <span class="keywordflow">if</span> (ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o2">Profile</a>[i].<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o1">FriendlyName</a>) {
01264                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o2">Profile</a>[i].<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o1">FriendlyName</a>);
01265             }
01266         }
01267         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ProfileList);
01268     }
01269     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != AliasList) {
01270         <span class="keywordflow">for</span> (i = 0; i &lt; AliasList-&gt;<a class="code" href="../../d7/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS__LIST.html#o1">CurrentAliasCount</a>; i++) {
01271             <span class="keywordflow">if</span> (AliasList-&gt;<a class="code" href="../../d7/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS__LIST.html#o2">Alias</a>[i].<a class="code" href="../../d6/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS.html#o3">SerialNumber</a>) {
01272                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (AliasList-&gt;<a class="code" href="../../d7/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS__LIST.html#o2">Alias</a>[i].<a class="code" href="../../d6/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS.html#o3">SerialNumber</a>);
01273             }
01274         }
01275         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (AliasList);
01276     }
01277 
01278     <span class="keywordflow">return</span> status;
01279 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a238" doxytag="cmp.h::CmSetLastWriteTimeKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmSetLastWriteTimeKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyControlBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>LastWriteTime</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01841">1841</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00245">CML_WORKER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00262">CMS_CM</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">HvMarkCellDirty()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00451">_CM_KEY_NODE::LastWriteTime</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03235">NtSetInformationKey()</a>.
<p>
<pre class="fragment"><div>01847                    :
01848 
01849     The LastWriteTime associated with a key node can be set with
01850     <a class="code" href="../../d8/d9/cmapi_8c.html#a19">CmSetLastWriteTimeKey</a>
01851 
01852 Arguments:
01853 
01854     KeyControlBlock - pointer to <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key to operate on
01855 
01856     LastWriteTime - <span class="keyword">new</span> time <span class="keywordflow">for</span> key
01857 
01858 Return Value:
01859 
01860     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
01861 
01862         &lt;TBS&gt;
01863 
01864 --*/
01865 {
01866     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> parent;
01867     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>      <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
01868     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
01869     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status = STATUS_SUCCESS;
01870 
01871     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_WORKER, CMS_CM) KdPrint(("CmSetLastWriteTimeKey\n"));
01872 
01873     CmpLockRegistryExclusive();
01874 
01875     <span class="comment">//</span>
01876     <span class="comment">// Check that we are not being asked to modify a key</span>
01877     <span class="comment">// that has been deleted</span>
01878     <span class="comment">//</span>
01879     if (KeyControlBlock-&gt;Delete == TRUE) {
01880         status = STATUS_KEY_DELETED;
01881         <span class="keywordflow">goto</span> Exit;
01882     }
01883 
01884     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyControlBlock-&gt;KeyHive;
01885     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = KeyControlBlock-&gt;KeyCell;
01886     parent = KeyControlBlock-&gt;KeyNode;
01887     <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, Cell)) {
01888         status = STATUS_NO_LOG_SPACE;
01889         <span class="keywordflow">goto</span> Exit;
01890     }
01891 
01892     parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o2">LastWriteTime</a> = *LastWriteTime;
01893 
01894 Exit:
01895     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01896     <span class="keywordflow">return</span> status;
01897 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a237" doxytag="cmp.h::CmSetValueKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmSetValueKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyControlBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Data</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DataSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01087">1087</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00346">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00489">CM_KEY_VALUE_SMALL</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00487">CM_KEY_VALUE_SPECIAL_SIZE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00243">CML_API</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00245">CML_WORKER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00568">CmpCleanUpKcbValueCache()</a>, <a class="el" href="../../d5/d2/cmtree_8c-source.html#l00033">CmpFindNameInList()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00124">CmpLockRegistry()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00172">CmpMarkAllBinsReadOnly</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00114">CmpReportNotify()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01383">CmpSetValueKeyExisting()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01619">CmpSetValueKeyNew()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00262">CMS_CM</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00267">CMS_EXCEPTION</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00035">CmSymbolicLinkValueName</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00332">_CHILD_LIST::Count</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00498">_CM_KEY_VALUE::Data</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00497">_CM_KEY_VALUE::DataLength</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">HvMarkCellDirty()</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00439">KEY_SYM_LINK</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00538">_CELL_DATA::_u::KeyValue</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00451">_CM_KEY_NODE::LastWriteTime</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00333">_CHILD_LIST::List</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00468">_CM_KEY_NODE::MaxValueDataLen</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00467">_CM_KEY_NODE::MaxValueNameLen</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00499">_CM_KEY_VALUE::Type</a>, <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00458">_CM_KEY_NODE::ValueList</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/edithive_8c-source.html#l00515">EhSetValueKey()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>.
<p>
<pre class="fragment"><div>01096                    :
01097 
01098     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value entry may be created or replaced with <a class="code" href="../../d8/d9/cmapi_8c.html#a18">CmSetValueKey</a>.
01099 
01100     If a value entry with a Value <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> (i.e. name) matching the
01101     one specified by ValueName exists, it is deleted and replaced
01102     with the one specified.  If no such value entry exists, a new
01103     one is created.  NULL is a legal Value ID.  While Value IDs must
01104     be unique within any given key, the same Value ID may appear
01105     in many different keys.
01106 
01107 Arguments:
01108 
01109     KeyControlBlock - pointer to kcb for the key to operate on
01110 
01111     ValueName - The unique (relative to the containing key) name
01112         of the value entry.  May be NULL.
01113 
01114     Type - The integer type number of the value entry.
01115 
01116     Data - Pointer to buffer with actual data for the value entry.
01117 
01118     DataSize - Size of Data buffer.
01119 
01120 
01121 Return Value:
01122 
01123     NTSTATUS - Result code from call, among the following:
01124 
01125         &lt;TBS&gt;
01126 
01127 --*/
01128 {
01129     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
01130     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> parent;
01131     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> oldchild;
01132     ULONG       count;
01133     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>      <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
01134     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
01135     ULONG       StorageType;
01136     ULONG       TempData;
01137     BOOLEAN     found;
01138     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  pdata;
01139     LARGE_INTEGER systemtime;
01140     ULONG compareSize,mustChange=<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01141 
01142     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_WORKER, CMS_CM) KdPrint(("CmSetValueKey\n"));
01143 
01144     CmpLockRegistry();
01145     ASSERT(sizeof(ULONG) == CM_KEY_VALUE_SMALL);
01146 
01147     <span class="comment">// Mark the hive as read only</span>
01148     CmpMarkAllBinsReadOnly(KeyControlBlock-&gt;KeyHive);
01149 
01150     while (TRUE) {
01151         <span class="comment">//</span>
01152         <span class="comment">// Check that we are not being asked to add a value to a key</span>
01153         <span class="comment">// that has been deleted</span>
01154         <span class="comment">//</span>
01155         <span class="keywordflow">if</span> (KeyControlBlock-&gt;Delete == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01156             status = STATUS_KEY_DELETED;
01157             <span class="keywordflow">goto</span> Exit;
01158         }
01159 
01160         <span class="comment">//</span>
01161         <span class="comment">// Check to see if this is a symbolic link node.  If so caller</span>
01162         <span class="comment">// is only allowed to create/change the SymbolicLinkValue</span>
01163         <span class="comment">// value name</span>
01164         <span class="comment">//</span>
01165 
01166         <span class="keywordflow">if</span> (KeyControlBlock-&gt;KeyNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a31">KEY_SYM_LINK</a> &amp;&amp;
01167             (Type != REG_LINK ||
01168              <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
01169              !<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(&amp;CmSymbolicLinkValueName, ValueName, TRUE)))
01170         {
01171             <span class="comment">//</span>
01172             <span class="comment">// Disallow attempts to manipulate any value names under a symbolic link</span>
01173             <span class="comment">// except for the "SymbolicLinkValue" value name or type other than REG_LINK</span>
01174             <span class="comment">//</span>
01175 
01176             <span class="comment">// Mark the hive as read only</span>
01177             <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(KeyControlBlock-&gt;KeyHive);
01178 
01179             status = STATUS_ACCESS_DENIED;
01180             <span class="keywordflow">goto</span> Exit;
01181         }
01182 
01183         <span class="comment">//</span>
01184         <span class="comment">// get reference to parent key,</span>
01185         <span class="comment">//</span>
01186         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyControlBlock-&gt;KeyHive;
01187         <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = KeyControlBlock-&gt;KeyCell;
01188         parent = KeyControlBlock-&gt;KeyNode;
01189 
01190         <span class="comment">//</span>
01191         <span class="comment">// try to find an existing value entry by the same name</span>
01192         <span class="comment">//</span>
01193         count = parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a>;
01194         found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01195 
01196         <span class="keywordflow">if</span> (count &gt; 0) {
01197             oldchild = <a class="code" href="../../d4/d3/cmtree_8c.html#a0">CmpFindNameInList</a>(Hive,
01198                                          &amp;parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>,
01199                                          ValueName,
01200                                          &amp;pdata,
01201                                          NULL);
01202 
01203             <span class="keywordflow">if</span> (oldchild != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01204                 found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01205             }
01206         }
01207         <span class="comment">//</span>
01208         <span class="comment">// Performance Hack:</span>
01209         <span class="comment">// If a Set is asking us to set a key to the current value (IE does this a lot)</span>
01210         <span class="comment">// drop it (and, therefore, the last modified time) on the floor, but return success</span>
01211         <span class="comment">// this stops the page from being dirtied, and us having to flush the registry.</span>
01212         <span class="comment">//</span>
01213         <span class="comment">//</span>
01214         <span class="keywordflow">if</span> (mustChange == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01215             <span class="keywordflow">break</span>; <span class="comment">//while</span>
01216         }
01217         <span class="keywordflow">if</span> ((found) &amp;&amp;
01218             (Type == pdata-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a>)) {
01219 
01220             <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> pcmpdata;
01221 
01222             <span class="keywordflow">if</span> (DataSize == (pdata-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o2">DataLength</a> &amp; ~<a class="code" href="../../d9/d0/cmdata_8h.html#a35">CM_KEY_VALUE_SPECIAL_SIZE</a>)) {
01223 
01224                 <span class="keywordflow">if</span> (DataSize &gt; 0) {
01225                     <span class="comment">//</span>
01226                     <span class="comment">//check for small values</span>
01227                     <span class="comment">//</span>
01228                     <span class="keywordflow">if</span> (DataSize &lt;= <a class="code" href="../../d9/d0/cmdata_8h.html#a36">CM_KEY_VALUE_SMALL</a> ) {
01229                         pcmpdata = (<a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>)&amp;pdata-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>;
01230                     } <span class="keywordflow">else</span> {
01231                         pcmpdata = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, pdata-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>);
01232                     }
01233 
01234                     <span class="keywordflow">try</span> {
01235                         compareSize = (ULONG)RtlCompareMemory ((PVOID)pcmpdata,Data,(DataSize &amp; ~CM_KEY_VALUE_SPECIAL_SIZE));
01236                     } except (EXCEPTION_EXECUTE_HANDLER) {
01237                         
01238                         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_EXCEPTION) {
01239                             KdPrint((<span class="stringliteral">"!!CmSetValueKey: code:%08lx\n"</span>, GetExceptionCode()));
01240                         }
01241                         status = GetExceptionCode();
01242                         <span class="keywordflow">goto</span> Exit;
01243                     }
01244                 }<span class="keywordflow">else</span> {
01245                     compareSize = 0;
01246                 }
01247 
01248                 <span class="keywordflow">if</span> (compareSize == DataSize) {
01249                     status = STATUS_SUCCESS;
01250                     <span class="keywordflow">goto</span> Exit;
01251                 }
01252             }
01253 
01254         }
01255 
01256         <span class="comment">//</span>
01257         <span class="comment">// To Get here, we must either be changing a value, or setting a new one</span>
01258         <span class="comment">//</span>
01259         mustChange=<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01260         <span class="comment">//</span>
01261         <span class="comment">// We're going through these gyrations so that if someone does come in and try and delete the</span>
01262         <span class="comment">// key we're setting we're safe. Once we know we have to change the key, take the</span>
01263         <span class="comment">// Exclusive (write) lock then restart</span>
01264         <span class="comment">//</span>
01265         <span class="comment">//</span>
01266         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01267         <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
01268 
01269     }<span class="comment">// while</span>
01270 
01271     <span class="comment">// It's a different or new value, mark it dirty, since we'll</span>
01272     <span class="comment">// at least set its time stamp</span>
01273 
01274     <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, Cell)) {
01275         status = STATUS_NO_LOG_SPACE;
01276         <span class="keywordflow">goto</span> Exit;
01277     }
01278 
01279     StorageType = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Cell);
01280 
01281     <span class="comment">//</span>
01282     <span class="comment">// stash small data if relevent</span>
01283     <span class="comment">//</span>
01284     TempData = 0;
01285     <span class="keywordflow">if</span> ((DataSize &lt;= <a class="code" href="../../d9/d0/cmdata_8h.html#a36">CM_KEY_VALUE_SMALL</a>) &amp;&amp;
01286         (DataSize &gt; 0))
01287     {
01288         <span class="keywordflow">try</span> {
01289             RtlMoveMemory(          <span class="comment">// yes, move memory, could be 1 byte</span>
01290                 &amp;TempData,          <span class="comment">// at the end of a page.</span>
01291                 Data,
01292                 DataSize
01293                 );
01294          } except (EXCEPTION_EXECUTE_HANDLER) {
01295             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_EXCEPTION) {
01296                 KdPrint((<span class="stringliteral">"!!CmSetValueKey: code:%08lx\n"</span>, GetExceptionCode()));
01297             }
01298             status = GetExceptionCode();
01299             <span class="keywordflow">goto</span> Exit;
01300         }
01301     }
01302 
01303     <span class="keywordflow">if</span> (found) {
01304 
01305         <span class="comment">//</span>
01306         <span class="comment">// ----- Existing Value Entry Path -----</span>
01307         <span class="comment">//</span>
01308 
01309         <span class="comment">//</span>
01310         <span class="comment">// An existing value entry of the specified name exists,</span>
01311         <span class="comment">// set our data into it.</span>
01312         <span class="comment">//</span>
01313         status = <a class="code" href="../../d8/d9/cmapi_8c.html#a9">CmpSetValueKeyExisting</a>(Hive,
01314                                         oldchild,
01315                                         pdata,
01316                                         Type,
01317                                         Data,
01318                                         DataSize,
01319                                         StorageType,
01320                                         TempData);
01321 
01322     } <span class="keywordflow">else</span> {
01323 
01324         <span class="comment">//</span>
01325         <span class="comment">// ----- New Value Entry Path -----</span>
01326         <span class="comment">//</span>
01327 
01328         <span class="comment">//</span>
01329         <span class="comment">// Either there are no existing value entries, or the one</span>
01330         <span class="comment">// specified is not in the list.  In either case, create and</span>
01331         <span class="comment">// fill a new one, and add it to the list</span>
01332         <span class="comment">//</span>
01333         status = <a class="code" href="../../d8/d9/cmapi_8c.html#a10">CmpSetValueKeyNew</a>(Hive,
01334                                    parent,
01335                                    ValueName,
01336                                    Type,
01337                                    Data,
01338                                    DataSize,
01339                                    StorageType,
01340                                    TempData);
01341     }
01342 
01343     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01344 
01345         <span class="keywordflow">if</span> (parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o13">MaxValueNameLen</a> &lt; <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>-&gt;Length) {
01346             parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o13">MaxValueNameLen</a> = <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>-&gt;Length;
01347         }
01348 
01349         <span class="keywordflow">if</span> (parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o14">MaxValueDataLen</a> &lt; DataSize) {
01350             parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o14">MaxValueDataLen</a> = DataSize;
01351         }
01352 
01353         <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;systemtime);
01354         parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o2">LastWriteTime</a> = systemtime;
01355 
01356         <span class="comment">//</span>
01357         <span class="comment">// Update the cache, no need for KCB lock as the registry is locked exclusively.</span>
01358         <span class="comment">//</span>
01359         <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
01360 
01361         <a class="code" href="../../d8/d2/cmsubs_8c.html#a16">CmpCleanUpKcbValueCache</a>(KeyControlBlock);
01362 
01363         KeyControlBlock-&gt;ValueCache.Count = parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a>;
01364         KeyControlBlock-&gt;ValueCache.ValueList = (ULONG_PTR) parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>;
01365 
01366         <a class="code" href="../../d6/d3/cmwraper_8c.html#a13">CmpReportNotify</a>(KeyControlBlock,
01367                         KeyControlBlock-&gt;KeyHive,
01368                         KeyControlBlock-&gt;KeyCell,
01369                         REG_NOTIFY_CHANGE_LAST_SET);
01370     }
01371 
01372 Exit:
01373     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01374   
01375     <span class="comment">// Mark the hive as read only</span>
01376     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(KeyControlBlock-&gt;KeyHive);
01377 
01378     <span class="keywordflow">return</span> status;
01379 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a241" doxytag="cmp.h::CmUnloadKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmUnloadKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Kcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02079">2079</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00740">_REGISTRY_COMMAND::Cell</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00745">_REGISTRY_COMMAND::CmHive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00245">CML_WORKER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00667">CmpDestroyHive()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00186">CmpFree()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00180">CmpSearchForOpenSubKeys()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01071">CmpSearchKeyControlBlockTree()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00262">CMS_CM</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00738">_REGISTRY_COMMAND::Command</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00739">_REGISTRY_COMMAND::Hive</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00653">_CMHIVE::HiveLock</a>, <a class="el" href="../../d3/d0/hivefree_8c-source.html#l00034">HvFreeHive()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00720">REG_CMD_FLUSH_KEY</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00723">REG_CMD_HIVE_CLOSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00727">REG_CMD_REMOVE_HIVE_LIST</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00343">_HBASE_BLOCK::RootCell</a>, and <a class="el" href="../../d9/d0/cmdata_8h.html#a105a100">SearchIfExist</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03093">NtUnloadKey()</a>.
<p>
<pre class="fragment"><div>02087                    :
02088 
02089     Unlinks a hive from its location in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry, closes its <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
02090     handles, and deallocates all its memory.
02091 
02092     There must be no key <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> blocks currently referencing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive
02093     to be unloaded.
02094 
02095 Arguments:
02096 
02097     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02098            hive to be unloaded
02099 
02100     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root cell of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive.
02101 
02102     Kcb - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block
02103 
02104 Return Value:
02105 
02106     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
02107 
02108 --*/
02109 
02110 {
02111     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive;
02112     <a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html">REGISTRY_COMMAND</a> Command;
02113     BOOLEAN Success;
02114 
02115     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_WORKER, CMS_CM) KdPrint(("CmUnloadKey\n"));
02116 
02117     CmpLockRegistryExclusive();
02118 
02119     <span class="comment">//</span>
02120     <span class="comment">// Make sure the cell passed in is the root cell of the hive.</span>
02121     <span class="comment">//</span>
02122     if (Cell != Hive-&gt;BaseBlock-&gt;RootCell) {
02123         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02124         <span class="keywordflow">return</span>(STATUS_INVALID_PARAMETER);
02125     }
02126 
02127     <span class="comment">//</span>
02128     <span class="comment">// Make sure there are no open references to key control blocks</span>
02129     <span class="comment">// for this hive.  If there are none, then we can unload the hive.</span>
02130     <span class="comment">//</span>
02131 
02132     CmHive = CONTAINING_RECORD(Hive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive);
02133     <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d2/cmsubs_8c.html#a12">CmpSearchForOpenSubKeys</a>(Kcb,SearchIfExist) != 0) || (Kcb-&gt;RefCount != 1)) {
02134 <span class="preprocessor">#if DBG</span>
02135 <span class="preprocessor"></span>        KdPrint((<span class="stringliteral">"List of keys open against hive unload was attempted on:\n"</span>));
02136         <a class="code" href="../../d8/d2/cmsubs_8c.html#a21">CmpSearchKeyControlBlockTree</a>(
02137             CmpUnloadKeyWorker,
02138             Hive,
02139             NULL
02140             );
02141 <span class="preprocessor">#endif</span>
02142 <span class="preprocessor"></span>        <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02143         <span class="keywordflow">return</span>(STATUS_CANNOT_DELETE);
02144     }
02145 
02146     <span class="comment">//</span>
02147     <span class="comment">// Flush any dirty data to disk. If this fails, too bad.</span>
02148     <span class="comment">//</span>
02149     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a102">REG_CMD_FLUSH_KEY</a>;
02150     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o1">Hive</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
02151     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o2">Cell</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
02152     <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
02153 
02154     <span class="comment">//</span>
02155     <span class="comment">// Remove the hive from the HiveFileList</span>
02156     <span class="comment">//</span>
02157     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a109">REG_CMD_REMOVE_HIVE_LIST</a>;
02158     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a> = (<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
02159     <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
02160 
02161     <span class="comment">//</span>
02162     <span class="comment">// Unlink from master hive, remove from list</span>
02163     <span class="comment">//</span>
02164     Success = <a class="code" href="../../d1/d2/cmp_8h.html#a276">CmpDestroyHive</a>(Hive, Cell);
02165 
02166     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02167 
02168     <span class="keywordflow">if</span> (Success) {
02169         <a class="code" href="../../d2/d1/hivefree_8c.html#a0">HvFreeHive</a>(Hive);
02170 
02171         <span class="comment">//</span>
02172         <span class="comment">// Close the hive files</span>
02173         <span class="comment">//</span>
02174         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a105">REG_CMD_HIVE_CLOSE</a>;
02175         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a> = CmHive;
02176         <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
02177 
02178         <span class="comment">//</span>
02179         <span class="comment">// free the cm level structure</span>
02180         <span class="comment">//</span>
02181         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a> );
02182         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a>);
02183         <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(CmHive, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>));
02184 
02185         <span class="keywordflow">return</span>(STATUS_SUCCESS);
02186     } <span class="keywordflow">else</span> {
02187         <span class="keywordflow">return</span>(STATUS_INSUFFICIENT_RESOURCES);
02188     }
02189 
02190 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a154" doxytag="cmp.h::CmpCacheOnFlag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d2/d2/cmparse_8c.html#a6">CmpCacheOnFlag</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00220">220</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l02056">CmpAddInfoAfterParseFailure()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a203" doxytag="cmp.h::CmpCacheTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a>* <a class="el" href="../../d8/d2/cmsubs_8c.html#a2">CmpCacheTable</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01982">1982</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01853">CmpCacheLookup()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01476">CmpGetSymbolicLink()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01512">CmpInitializeCache()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01350">CmpInsertKeyHash()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01459">CmpRemoveKeyHash()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00180">CmpSearchForOpenSubKeys()</a>, and <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01071">CmpSearchKeyControlBlockTree()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a202" doxytag="cmp.h::CmpHashTableSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d8/d2/cmsubs_8c.html#a3">CmpHashTableSize</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01981">1981</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01476">CmpGetSymbolicLink()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01512">CmpInitializeCache()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01350">CmpInsertKeyHash()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01459">CmpRemoveKeyHash()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00180">CmpSearchForOpenSubKeys()</a>, and <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01071">CmpSearchKeyControlBlockTree()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a155" doxytag="cmp.h::CmpKcbLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="el" href="../../d1/d3/cmsysini_8c.html#a11">CmpKcbLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00229">229</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a159" doxytag="cmp.h::CmpKeyObjectType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="el" href="../../d7/d7/ntapi_8c.html#a4">CmpKeyObjectType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00463">463</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a185" doxytag="cmp.h::CmpLazyFlushPending" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d5/d3/cmworker_8c.html#a8">CmpLazyFlushPending</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01098">1098</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00416">CmpLazyFlushDpcRoutine()</a>, and <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00461">CmpLazyFlushWorker()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a177" doxytag="cmp.h::CmpPostLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="el" href="../../d1/d3/cmsysini_8c.html#a12">CmpPostLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00642">642</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a186" doxytag="cmp.h::CmpRegistryLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a> <a class="el" href="../../d1/d3/cmsysini_8c.html#a10">CmpRegistryLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l01174">1174</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00044">CmpLockRegistry()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, and <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a153" doxytag="cmp.h::CmpTraceRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d7/d9/cm_8h.html#a28">PCM_TRACE_NOTIFY_ROUTINE</a> <a class="el" href="../../d1/d2/cmp_8h.html#a153">CmpTraceRoutine</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00074">74</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a156" doxytag="cmp.h::CmRegistrySystemCloneName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UNICODE_STRING <a class="el" href="../../d1/d2/cmp_8h.html#a156">CmRegistrySystemCloneName</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00409">409</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03747">CmpDeleteCloneTree()</a>, and <a class="el" href="../../d1/d0/cmdatini_8c-source.html#l00089">CmpInitializeRegistryNames()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a152" doxytag="cmp.h::WmiUsePerfClock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d1/d2/cmp_8h.html#a152">WmiUsePerfClock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/cmp_8h-source.html#l00073">73</a> of file <a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:10 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
