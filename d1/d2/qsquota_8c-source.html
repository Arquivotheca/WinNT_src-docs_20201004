<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: qsquota.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>qsquota.c</h1><a href="../../d0/d3/qsquota_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989 - 1995  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    qsquota.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the code to implement the NtQueryQuotaInformationFile</span>
00012 <span class="comment">    and the NtSetQuotaInformationFile system services for the NT I/O system.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Darryl E. Havens (darrylh) 20-Jun-1995</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Kernel mode only</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment"></span>
00025 <span class="comment">--*/</span>
00026 
00027 <span class="preprocessor">#include "<a class="code" href="../../d0/d6/iop_8h.html">iop.h</a>"</span>
00028 
00029 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtQueryQuotaInformationFile)</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtSetQuotaInformationFile)</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00033 <span class="preprocessor"></span>
00034 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00035"></a><a class="code" href="../../d0/d3/qsquota_8c.html#a1">00035</a> <a class="code" href="../../d0/d3/qsquota_8c.html#a1">NtQueryQuotaInformationFile</a>(
00036     IN HANDLE FileHandle,
00037     OUT PIO_STATUS_BLOCK IoStatusBlock,
00038     OUT PVOID Buffer,
00039     IN ULONG Length,
00040     IN BOOLEAN ReturnSingleEntry,
00041     IN PVOID SidList OPTIONAL,
00042     IN ULONG SidListLength,
00043     IN PULONG StartSid OPTIONAL,
00044     IN BOOLEAN RestartScan
00045     )
00046 
00047 <span class="comment">/*++</span>
00048 <span class="comment"></span>
00049 <span class="comment">Routine Description:</span>
00050 <span class="comment"></span>
00051 <span class="comment">    This service returns quota entries associated with the volume specified</span>
00052 <span class="comment">    by the FileHandle parameter.  The amount of information returned is based</span>
00053 <span class="comment">    on the size of the quota information associated with the volume, the size</span>
00054 <span class="comment">    of the buffer, and whether or not a specific set of entries has been</span>
00055 <span class="comment">    requested.</span>
00056 <span class="comment"></span>
00057 <span class="comment">Arguments:</span>
00058 <span class="comment"></span>
00059 <span class="comment">    FileHandle - Supplies a handle to the file/volume for which the quota</span>
00060 <span class="comment">        information is returned.</span>
00061 <span class="comment"></span>
00062 <span class="comment">    IoStatusBlock - Address of the caller's I/O status block.</span>
00063 <span class="comment"></span>
00064 <span class="comment">    Buffer - Supplies a buffer to receive the quota information for the volume.</span>
00065 <span class="comment"></span>
00066 <span class="comment">    Length - Supplies the length, in bytes, of the buffer.</span>
00067 <span class="comment"></span>
00068 <span class="comment">    ReturnSingleEntry - Indicates that only a single entry should be returned</span>
00069 <span class="comment">        rather than filling the buffer with as many entries as possible.</span>
00070 <span class="comment"></span>
00071 <span class="comment">    SidList - Optionally supplies a list of SIDs whose quota information is to</span>
00072 <span class="comment">        be returned.</span>
00073 <span class="comment"></span>
00074 <span class="comment">    SidListLength - Supplies the length of the SID list, if one was specified.</span>
00075 <span class="comment"></span>
00076 <span class="comment">    StartSid - Supplies an optional SID that indicates that the returned</span>
00077 <span class="comment">        information is to start with an entry other than the first.  This</span>
00078 <span class="comment">        parameter is ignored if a SidList is specified.</span>
00079 <span class="comment"></span>
00080 <span class="comment">    RestartScan - Indicates whether the scan of the quota information is to be</span>
00081 <span class="comment">        restarted from the beginning.</span>
00082 <span class="comment"></span>
00083 <span class="comment">Return Value:</span>
00084 <span class="comment"></span>
00085 <span class="comment">    The status returned is the final completion status of the operation.</span>
00086 <span class="comment"></span>
00087 <span class="comment">--*/</span>
00088 
00089 {
00090 
00091 <span class="preprocessor">#define ALIGN_LONG( Address ) ( (Address + 3) &amp; ~3 )</span>
00092 <span class="preprocessor"></span>
00093     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00094     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00095     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> fileObject;
00096     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00097     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> event = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00098     PCHAR auxiliaryBuffer = (PCHAR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00099     ULONG startSidLength = 0;
00100     PSID startSid = (PSID) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00101     PFILE_GET_QUOTA_INFORMATION sidList = (PFILE_GET_QUOTA_INFORMATION) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00102     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> requestorMode;
00103     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00104     IO_STATUS_BLOCK localIoStatus;
00105     BOOLEAN synchronousIo;
00106     UCHAR subCount;
00107 
00108     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00109 
00110     <span class="comment">//</span>
00111     <span class="comment">// Get the previous mode;  i.e., the mode of the caller.</span>
00112     <span class="comment">//</span>
00113 
00114     requestorMode = KeGetPreviousMode();
00115 
00116     <span class="keywordflow">if</span> (requestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00117 
00118         <span class="comment">//</span>
00119         <span class="comment">// The caller's access mode is not kernel so probe each of the arguments</span>
00120         <span class="comment">// and capture them as necessary.  If any failures occur, the condition</span>
00121         <span class="comment">// handler will be invoked to handle them.  It will simply cleanup and</span>
00122         <span class="comment">// return an access violation status code back to the system service</span>
00123         <span class="comment">// dispatcher.</span>
00124         <span class="comment">//</span>
00125 
00126         <span class="keywordflow">try</span> {
00127 
00128             <span class="comment">//</span>
00129             <span class="comment">// The IoStatusBlock parameter must be writeable by the caller.</span>
00130             <span class="comment">//</span>
00131 
00132             <a class="code" href="../../d5/d8/ex_8h.html#a31">ProbeForWriteIoStatus</a>( IoStatusBlock );
00133 
00134             <span class="comment">//</span>
00135             <span class="comment">// The buffer must be writeable by the caller.</span>
00136             <span class="comment">//</span>
00137 
00138 <span class="preprocessor">#if defined(_X86_)</span>
00139 <span class="preprocessor"></span>            <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, Length, <span class="keyword">sizeof</span>( ULONG ) );
00140 <span class="preprocessor">#elif defined(_WIN64)</span>
00141 <span class="preprocessor"></span>
00142             <span class="comment">//</span>
00143             <span class="comment">// If we are a wow64 process, follow the X86 rules</span>
00144             <span class="comment">//</span>
00145 
00146             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Wow64Process) {
00147                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, Length, <span class="keyword">sizeof</span>( ULONG ) );
00148             } <span class="keywordflow">else</span> {
00149                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, Length, <span class="keyword">sizeof</span>( ULONGLONG ) );
00150             }
00151 <span class="preprocessor">#else</span>
00152 <span class="preprocessor"></span>            <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, Length, <span class="keyword">sizeof</span>( ULONGLONG ) );
00153 <span class="preprocessor">#endif</span>
00154 <span class="preprocessor"></span>
00155             <span class="comment">//</span>
00156             <span class="comment">// If the optional StartSid parameter was specified, then it must</span>
00157             <span class="comment">// be readable by the caller.  Begin by capturing the length of</span>
00158             <span class="comment">// the SID so that the SID itself can be captured.</span>
00159             <span class="comment">//</span>
00160 
00161             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( StartSid )) {
00162 
00163                 subCount = <a class="code" href="../../d5/d8/ex_8h.html#a14">ProbeAndReadUchar</a>( &amp;(((SID *)(StartSid))-&gt;SubAuthorityCount) );
00164                 startSidLength = <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( subCount );
00165                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( StartSid, startSidLength, <span class="keyword">sizeof</span>( ULONG ) );
00166             }
00167 
00168             <span class="comment">//</span>
00169             <span class="comment">// If the optional SidList parameter was specified, then it must</span>
00170             <span class="comment">// be readable by the caller.  Validate that the buffer contains</span>
00171             <span class="comment">// a legal get information structure.</span>
00172             <span class="comment">//</span>
00173 
00174             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( SidList ) &amp;&amp; SidListLength) {
00175 
00176                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( SidList, SidListLength, <span class="keyword">sizeof</span>( ULONG ) );
00177                 auxiliaryBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a11">ExAllocatePoolWithQuota</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00178                                                            <a class="code" href="../../d4/d6/iosubs_8c.html#a0">ALIGN_LONG</a>( SidListLength ) +
00179                                                            startSidLength );
00180                 sidList = (PFILE_GET_QUOTA_INFORMATION) auxiliaryBuffer;
00181 
00182                 RtlCopyMemory( auxiliaryBuffer, SidList, SidListLength );
00183 
00184             } <span class="keywordflow">else</span> {
00185 
00186                 <span class="comment">//</span>
00187                 <span class="comment">// No SidList was specified.  Check to see whether or not a</span>
00188                 <span class="comment">// StartSid was specified and, if so, capture it.  Note that</span>
00189                 <span class="comment">// the SID has already been probed.</span>
00190                 <span class="comment">//</span>
00191 
00192                 SidListLength = 0;
00193                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT( StartSid )) {
00194                     auxiliaryBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a11">ExAllocatePoolWithQuota</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00195                                                                startSidLength );
00196                 }
00197             }
00198 
00199             <span class="comment">//</span>
00200             <span class="comment">// If a StartSid was specified tack it onto the end of the auxiliary</span>
00201             <span class="comment">// buffer.</span>
00202             <span class="comment">//</span>
00203 
00204             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( StartSid )) {
00205                 startSid = (PSID) (auxiliaryBuffer + <a class="code" href="../../d4/d6/iosubs_8c.html#a0">ALIGN_LONG</a>( SidListLength ));
00206 
00207                 RtlCopyMemory( startSid, StartSid, startSidLength );
00208                 ((SID *) startSid)-&gt;SubAuthorityCount = subCount;
00209             }
00210 
00211 
00212         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00213 
00214             <span class="comment">//</span>
00215             <span class="comment">// An exception was incurred while probing the caller's</span>
00216             <span class="comment">// parameters, allocating the pool buffer, or copying the</span>
00217             <span class="comment">// caller's EA list to the buffer.  Cleanup and return an</span>
00218             <span class="comment">// appropriate error status code.</span>
00219             <span class="comment">//</span>
00220 
00221             <span class="keywordflow">if</span> (auxiliaryBuffer) {
00222                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( auxiliaryBuffer );
00223             }
00224 
00225             <span class="keywordflow">return</span> GetExceptionCode();
00226 
00227         }
00228 
00229     } <span class="keywordflow">else</span> {
00230 
00231         <span class="comment">//</span>
00232         <span class="comment">// The caller's mode was KernelMode.  Simply allocate pool for the</span>
00233         <span class="comment">// SidList, if one was specified, and copy the string to it.  Also,</span>
00234         <span class="comment">// if a StartSid was specified copy it as well.</span>
00235         <span class="comment">//</span>
00236 
00237         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( SidList ) &amp;&amp; SidListLength) {
00238             sidList = SidList;
00239         }
00240 
00241         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( StartSid )) {
00242             startSid = StartSid;
00243         }
00244     }
00245 
00246     <span class="comment">//</span>
00247     <span class="comment">// Always check the validity of the buffer since the server uses this </span>
00248     <span class="comment">// routine.</span>
00249     <span class="comment">//</span>
00250 
00251     <span class="keywordflow">if</span> (sidList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00252         status = <a class="code" href="../../d0/d6/iop_8h.html#a153">IopCheckGetQuotaBufferValidity</a>( sidList,
00253                                                  SidListLength,
00254                                                  &amp;IoStatusBlock-&gt;Information );
00255         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00256             <span class="keywordflow">if</span> (auxiliaryBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00257                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( auxiliaryBuffer );
00258             }
00259             <span class="keywordflow">return</span> status;
00260 
00261         }
00262     }
00263 
00264     <span class="keywordflow">if</span> (startSid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00265 
00266         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( startSid )) {
00267             <span class="keywordflow">if</span> (auxiliaryBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00268                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( auxiliaryBuffer );
00269             }
00270             <span class="keywordflow">return</span> STATUS_INVALID_SID;
00271         }
00272     }
00273 
00274     <span class="comment">//</span>
00275     <span class="comment">// There were no blatant errors so far, so reference the file object so</span>
00276     <span class="comment">// the target device object can be found.  Note that if the handle does</span>
00277     <span class="comment">// not refer to a file object, or if the caller does not have the required</span>
00278     <span class="comment">// access to the file, then it will fail.</span>
00279     <span class="comment">//</span>
00280 
00281     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( FileHandle,
00282                                         0,
00283                                         <a class="code" href="../../d5/d8/fssup_8c.html#a3">IoFileObjectType</a>,
00284                                         requestorMode,
00285                                         (PVOID *) &amp;fileObject,
00286                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00287     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00288         <span class="keywordflow">if</span> (auxiliaryBuffer) {
00289             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( auxiliaryBuffer );
00290         }
00291         <span class="keywordflow">return</span> status;
00292     }
00293 
00294     <span class="comment">//</span>
00295     <span class="comment">// Make a special check here to determine whether this is a synchronous</span>
00296     <span class="comment">// I/O operation.  If it is, then wait here until the file is owned by</span>
00297     <span class="comment">// the current thread.  If this is not a (serialized) synchronous I/O</span>
00298     <span class="comment">// operation, then allocate and initialize the local event.</span>
00299     <span class="comment">//</span>
00300 
00301     <span class="keywordflow">if</span> (fileObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) {
00302 
00303         BOOLEAN interrupted;
00304 
00305         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a13">IopAcquireFastLock</a>( fileObject )) {
00306             status = <a class="code" href="../../d0/d6/iop_8h.html#a147">IopAcquireFileObjectLock</a>( fileObject,
00307                                                requestorMode,
00308                                                (BOOLEAN) ((fileObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a152">FO_ALERTABLE_IO</a>) != 0),
00309                                                &amp;interrupted );
00310             <span class="keywordflow">if</span> (interrupted) {
00311                 <span class="keywordflow">if</span> (auxiliaryBuffer) {
00312                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( auxiliaryBuffer );
00313                 }
00314                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
00315                 <span class="keywordflow">return</span> status;
00316             }
00317         }
00318         synchronousIo = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00319     } <span class="keywordflow">else</span> {
00320 
00321         <span class="comment">//</span>
00322         <span class="comment">// This is a synchronous API being invoked for a file that is opened</span>
00323         <span class="comment">// for asynchronous I/O.  This means that this system service is</span>
00324         <span class="comment">// to synchronize the completion of the operation before returning</span>
00325         <span class="comment">// to the caller.  A local event is used to do this.</span>
00326         <span class="comment">//</span>
00327 
00328         event = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> ) );
00329         <span class="keywordflow">if</span> (!event) {
00330             <span class="keywordflow">if</span> (auxiliaryBuffer) {
00331                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( auxiliaryBuffer );
00332             }
00333             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
00334             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00335         }
00336         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( event, SynchronizationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00337         synchronousIo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00338     }
00339 
00340     <span class="comment">//</span>
00341     <span class="comment">// Set the file object to the Not-Signaled state.</span>
00342     <span class="comment">//</span>
00343 
00344     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>( &amp;fileObject-&gt;Event );
00345 
00346     <span class="comment">//</span>
00347     <span class="comment">// Get the address of the target device object.</span>
00348     <span class="comment">//</span>
00349 
00350     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( fileObject );
00351 
00352     <span class="comment">//</span>
00353     <span class="comment">// Allocate and initialize the I/O Request Packet (IRP) for this operation.</span>
00354     <span class="comment">// The allocation is performed with an exception handler in case the</span>
00355     <span class="comment">// caller does not have enough quota to allocate the packet.</span>
00356 
00357     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>( deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00358     <span class="keywordflow">if</span> (!irp) {
00359 
00360         <span class="comment">//</span>
00361         <span class="comment">// An IRP could not be allocated.  Cleanup and return an appropriate</span>
00362         <span class="comment">// error status code.</span>
00363         <span class="comment">//</span>
00364 
00365         <span class="keywordflow">if</span> (!(fileObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>)) {
00366             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( event );
00367         }
00368 
00369         <a class="code" href="../../d0/d6/iop_8h.html#a148">IopAllocateIrpCleanup</a>( fileObject, (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00370 
00371         <span class="keywordflow">if</span> (auxiliaryBuffer) {
00372             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( auxiliaryBuffer );
00373         }
00374 
00375         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00376     }
00377     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = fileObject;
00378     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00379     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> = requestorMode;
00380 
00381     <span class="comment">//</span>
00382     <span class="comment">// Fill in the service independent parameters in the IRP.</span>
00383     <span class="comment">//</span>
00384 
00385     <span class="keywordflow">if</span> (synchronousIo) {
00386         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00387         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = IoStatusBlock;
00388     } <span class="keywordflow">else</span> {
00389         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = event;
00390         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = &amp;localIoStatus;
00391         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>;
00392     }
00393     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine = (PIO_APC_ROUTINE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00394 
00395     <span class="comment">//</span>
00396     <span class="comment">// Get a pointer to the stack location for the first driver.  This will be</span>
00397     <span class="comment">// used to pass the original function codes and parameters.</span>
00398     <span class="comment">//</span>
00399 
00400     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
00401     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a38">IRP_MJ_QUERY_QUOTA</a>;
00402     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = fileObject;
00403 
00404     <span class="comment">//</span>
00405     <span class="comment">// If the caller specified an SID list of names to be queried, then pass</span>
00406     <span class="comment">// the address of the intermediary buffer containing the list to the</span>
00407     <span class="comment">// driver.</span>
00408     <span class="comment">//</span>
00409 
00410     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.AuxiliaryBuffer = auxiliaryBuffer;
00411     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryQuota.SidList = sidList;
00412     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryQuota.SidListLength = SidListLength;
00413 
00414     <span class="comment">//</span>
00415     <span class="comment">// Now determine whether this driver expects to have data buffered</span>
00416     <span class="comment">// to it or whether it performs direct I/O.  This is based on the</span>
00417     <span class="comment">// DO_BUFFERED_IO flag in the device object.  If the flag is set,</span>
00418     <span class="comment">// then a system buffer is allocated and the driver's data will be</span>
00419     <span class="comment">// copied to it.  If the DO_DIRECT_IO flag is set in the device</span>
00420     <span class="comment">// object, then a Memory Descriptor List (MDL) is allocated and</span>
00421     <span class="comment">// the caller's buffer is locked down using it.  Finally, if the</span>
00422     <span class="comment">// driver specifies neither of the flags, then simply pass the</span>
00423     <span class="comment">// address and length of the buffer and allow the driver to perform</span>
00424     <span class="comment">// all of the checking and buffering if any is required.</span>
00425     <span class="comment">//</span>
00426 
00427     <span class="keywordflow">if</span> (deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a123">DO_BUFFERED_IO</a>) {
00428 
00429         <span class="comment">//</span>
00430         <span class="comment">// The driver wishes the caller's buffered be copied into an</span>
00431         <span class="comment">// intermediary buffer.  Allocate the system buffer and specify</span>
00432         <span class="comment">// that it should be deallocated on completion.  Also indicate</span>
00433         <span class="comment">// that this is an input operation so the data will be copied</span>
00434         <span class="comment">// into the caller's buffer.  This is done using an exception</span>
00435         <span class="comment">// handler that will perform cleanup if the operation fails.</span>
00436         <span class="comment">//</span>
00437 
00438         <span class="keywordflow">if</span> (Length) {
00439             <span class="keywordflow">try</span> {
00440 
00441                 <span class="comment">//</span>
00442                 <span class="comment">// Allocate the intermediary system buffer from nonpaged</span>
00443                 <span class="comment">// pool and charge quota for it.</span>
00444                 <span class="comment">//</span>
00445 
00446                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer =
00447                     <a class="code" href="../../d5/d5/cc_8h.html#a11">ExAllocatePoolWithQuota</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, Length );
00448 
00449             } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00450 
00451                 <span class="comment">//</span>
00452                 <span class="comment">// An exception was incurred while either probing the</span>
00453                 <span class="comment">// caller's buffer or allocating the system buffer.</span>
00454                 <span class="comment">// Determine what actually happened, clean everything</span>
00455                 <span class="comment">// up, and return an appropriate error status code.</span>
00456                 <span class="comment">//</span>
00457 
00458                 <a class="code" href="../../d0/d6/iop_8h.html#a170">IopExceptionCleanup</a>( fileObject,
00459                                      irp,
00460                                      (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00461                                      event );
00462 
00463                 <span class="keywordflow">if</span> (auxiliaryBuffer) {
00464                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( auxiliaryBuffer );
00465                 }
00466 
00467                 <span class="keywordflow">return</span> GetExceptionCode();
00468             }
00469 
00470             <span class="comment">//</span>
00471             <span class="comment">// Remember the address of the caller's buffer so the copy can</span>
00472             <span class="comment">// take place during I/O completion.  Also, set the flags so</span>
00473             <span class="comment">// that the completion code knows to do the copy and to deallocate</span>
00474             <span class="comment">// the buffer.</span>
00475             <span class="comment">//</span>
00476 
00477             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o26">UserBuffer</a> = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00478             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> |= (ULONG) (<a class="code" href="../../d0/d5/io_8h.html#a178">IRP_BUFFERED_IO</a> |
00479                                    <a class="code" href="../../d0/d5/io_8h.html#a179">IRP_DEALLOCATE_BUFFER</a> |
00480                                    <a class="code" href="../../d0/d5/io_8h.html#a180">IRP_INPUT_OPERATION</a>);
00481         } <span class="keywordflow">else</span> {
00482             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00483             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o26">UserBuffer</a> = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00484         }
00485 
00486     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a125">DO_DIRECT_IO</a>) {
00487 
00488         <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> mdl;
00489 
00490         <span class="comment">//</span>
00491         <span class="comment">// This is a direct I/O operation.  Allocate an MDL and invoke</span>
00492         <span class="comment">// the memory management routine to lock the buffer into memory.</span>
00493         <span class="comment">// This is done using an exception handler that will perform</span>
00494         <span class="comment">// cleanup if the operation fails.</span>
00495         <span class="comment">//</span>
00496 
00497         mdl = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00498 
00499         <span class="keywordflow">if</span> (Length) {
00500             <span class="keywordflow">try</span> {
00501 
00502                 <span class="comment">//</span>
00503                 <span class="comment">// Allocate an MDL, charging quota for it, and hang it off</span>
00504                 <span class="comment">// of the IRP.  Probe and lock the pages associated with</span>
00505                 <span class="comment">// the caller's buffer for write access and fill in the MDL</span>
00506                 <span class="comment">// with the PFNs of those pages.</span>
00507                 <span class="comment">//</span>
00508 
00509                 mdl = <a class="code" href="../../d4/d6/iosubs_8c.html#a19">IoAllocateMdl</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, Length, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, irp );
00510                 <span class="keywordflow">if</span> (!mdl) {
00511                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );
00512                 }
00513                 <a class="code" href="../../d5/d6/iosup_8c.html#a41">MmProbeAndLockPages</a>( mdl, requestorMode, <a class="code" href="../../d2/d1/mm_8h.html#a344a169">IoWriteAccess</a> );
00514 
00515             } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00516 
00517                 <span class="comment">//</span>
00518                 <span class="comment">// An exception was incurred while either probing the</span>
00519                 <span class="comment">// caller's buffer or allocating the MDL.  Determine what</span>
00520                 <span class="comment">// actually happened, clean everything up, and return an</span>
00521                 <span class="comment">// appropriate error status code.</span>
00522                 <span class="comment">//</span>
00523 
00524                 <a class="code" href="../../d0/d6/iop_8h.html#a170">IopExceptionCleanup</a>( fileObject,
00525                                      irp,
00526                                      (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00527                                      event );
00528 
00529                 <span class="keywordflow">if</span> (auxiliaryBuffer) {
00530                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( auxiliaryBuffer );
00531                 }
00532 
00533                 <span class="keywordflow">return</span> GetExceptionCode();
00534 
00535             }
00536         }
00537 
00538     } <span class="keywordflow">else</span> {
00539 
00540         <span class="comment">//</span>
00541         <span class="comment">// Pass the address of the user's buffer so the driver has access</span>
00542         <span class="comment">// to it.  It is now the driver's responsibility to do everything.</span>
00543         <span class="comment">//</span>
00544 
00545         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o26">UserBuffer</a> = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00546 
00547     }
00548 
00549     <span class="comment">//</span>
00550     <span class="comment">// Copy the caller's parameters to the service-specific portion of the</span>
00551     <span class="comment">// IRP.</span>
00552     <span class="comment">//</span>
00553 
00554     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryQuota.Length = Length;
00555     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryQuota.StartSid = StartSid;
00556     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o2">Flags</a> = 0;
00557     <span class="keywordflow">if</span> (RestartScan) {
00558         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o2">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a208">SL_RESTART_SCAN</a>;
00559     }
00560     <span class="keywordflow">if</span> (ReturnSingleEntry) {
00561         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o2">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a209">SL_RETURN_SINGLE_ENTRY</a>;
00562     }
00563     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( StartSid )) {
00564         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o2">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a210">SL_INDEX_SPECIFIED</a>;
00565     }
00566 
00567     <span class="comment">//</span>
00568     <span class="comment">// Queue the packet, call the driver, and synchronize appropriately with</span>
00569     <span class="comment">// I/O completion.</span>
00570     <span class="comment">//</span>
00571 
00572     status = <a class="code" href="../../d0/d6/iop_8h.html#a212">IopSynchronousServiceTail</a>( deviceObject,
00573                                         irp,
00574                                         fileObject,
00575                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00576                                         requestorMode,
00577                                         synchronousIo,
00578                                         <a class="code" href="../../d0/d6/iop_8h.html#a240a140">OtherTransfer</a> );
00579 
00580     <span class="comment">//</span>
00581     <span class="comment">// If the file for this operation was not opened for synchronous I/O, then</span>
00582     <span class="comment">// synchronization of completion of the I/O operation has not yet occurred</span>
00583     <span class="comment">// since the allocated event must be used for synchronous APIs on files</span>
00584     <span class="comment">// opened for asynchronous I/O.  Synchronize the completion of the I/O</span>
00585     <span class="comment">// operation now.</span>
00586     <span class="comment">//</span>
00587 
00588     <span class="keywordflow">if</span> (!synchronousIo) {
00589 
00590         status = <a class="code" href="../../d0/d6/iop_8h.html#a211">IopSynchronousApiServiceTail</a>( status,
00591                                                event,
00592                                                irp,
00593                                                requestorMode,
00594                                                &amp;localIoStatus,
00595                                                IoStatusBlock );
00596     }
00597 
00598     <span class="keywordflow">return</span> status;
00599 }
00600 
00601 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00602"></a><a class="code" href="../../d0/d3/qsquota_8c.html#a2">00602</a> <a class="code" href="../../d0/d3/qsquota_8c.html#a2">NtSetQuotaInformationFile</a>(
00603     IN HANDLE FileHandle,
00604     OUT PIO_STATUS_BLOCK IoStatusBlock,
00605     IN PVOID Buffer,
00606     IN ULONG Length
00607     )
00608 
00609 <span class="comment">/*++</span>
00610 <span class="comment"></span>
00611 <span class="comment">Routine Description:</span>
00612 <span class="comment"></span>
00613 <span class="comment">    This service changes quota entries for the volume associated with the</span>
00614 <span class="comment">    FileHandle parameter.  All of the quota entries in the specified buffer</span>
00615 <span class="comment">    are applied to the volume.</span>
00616 <span class="comment"></span>
00617 <span class="comment">Arguments:</span>
00618 <span class="comment"></span>
00619 <span class="comment">    FileHandle - Supplies a handle to the file/volume for which the quota</span>
00620 <span class="comment">        entries are to be applied.</span>
00621 <span class="comment"></span>
00622 <span class="comment">    IoStatusBlock - Address of the caller's I/O status block.</span>
00623 <span class="comment"></span>
00624 <span class="comment">    Buffer - Supplies a buffer containing the new quota entries that should</span>
00625 <span class="comment">        be applied to the volume.</span>
00626 <span class="comment"></span>
00627 <span class="comment">    Length - Supplies the length, in bytes, of the buffer.</span>
00628 <span class="comment"></span>
00629 <span class="comment">Return Value:</span>
00630 <span class="comment"></span>
00631 <span class="comment">    The status returned is the final completion status of the operation.</span>
00632 <span class="comment"></span>
00633 <span class="comment">--*/</span>
00634 
00635 {
00636     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00637 
00638     <span class="comment">//</span>
00639     <span class="comment">// Simply return the status from the internal common routine for setting</span>
00640     <span class="comment">// EAs on a file or quotas on a volume.</span>
00641     <span class="comment">//</span>
00642 
00643     <span class="keywordflow">return</span> <a class="code" href="../../d0/d6/iop_8h.html#a208">IopSetEaOrQuotaInformationFile</a>( FileHandle,
00644                                            IoStatusBlock,
00645                                            <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00646                                            Length,
00647                                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00648 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:34 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
