<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: hooks.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>hooks.c File Reference</h1><code>#include "<a class="el" href="../../d1/d3/w32_2ntuser_2kernel_2precomp_8h-source.html">precomp.h</a>"</code><br>

<p>
<a href="../../d2/d1/hooks_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a>&nbsp;&nbsp;&nbsp;0x01</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/hooks_8c.html#a1">HKF_TASK</a>&nbsp;&nbsp;&nbsp;0x02</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/hooks_8c.html#a2">HKF_JOURNAL</a>&nbsp;&nbsp;&nbsp;0x04</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/hooks_8c.html#a3">HKF_NZRET</a>&nbsp;&nbsp;&nbsp;0x08</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/hooks_8c.html#a4">HKF_INTERSENDABLE</a>&nbsp;&nbsp;&nbsp;0x10</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/hooks_8c.html#a5">HKF_LOWLEVEL</a>&nbsp;&nbsp;&nbsp;0x20</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/hooks_8c.html#a6">IS_CHAR_MSG</a>(<a class="el" href="../../d2/d1/userexts_8c.html#a129">msg</a>)&nbsp;&nbsp;&nbsp;((<a class="el" href="../../d2/d1/userexts_8c.html#a129">msg</a>) &amp; 0x02)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/hooks_8c.html#a7">DbgValidatefsHook</a>(phk, nFilterType, pti, fGlobal)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/hooks_8c.html#a10">UnlinkHook</a> (<a class="el" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phkFree)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/hooks_8c.html#a11">zzzJournalAttach</a> (<a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti, BOOL fAttach)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/hooks_8c.html#a12">InterQueueMsgCleanup</a> (<a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwTimeFromLastRead)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/hooks_8c.html#a13">zzzCancelJournalling</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PROC&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/hooks_8c.html#a14">zzzSetWindowsHookAW</a> (int nFilterType, PROC pfnFilterProc, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="el" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d5/d6/structtagHOOK.html">PHOOK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/hooks_8c.html#a15">zzzSetWindowsHookEx</a> (HANDLE hmod, PUNICODE_STRING pstrLib, <a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiThread, int nFilterType, PROC pfnFilterProc, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="el" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LRESULT&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/hooks_8c.html#a16">xxxCallNextHookEx</a> (int nCode, WPARAM wParam, LPARAM lParam)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/hooks_8c.html#a17">CheckWHFBits</a> (<a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti, int nFilterType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/hooks_8c.html#a18">zzzUnhookWindowsHook</a> (int nFilterType, PROC pfnFilterProc)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/hooks_8c.html#a19">zzzUnhookWindowsHookEx</a> (<a class="el" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phkFree)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/hooks_8c.html#a20">_CallMsgFilter</a> (LPMSG pmsg, int nCode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>int&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/hooks_8c.html#a21">xxxCallHook</a> (int nCode, WPARAM wParam, LPARAM lParam, int iHook)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LRESULT&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/hooks_8c.html#a22">xxxCallHook2</a> (<a class="el" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phkCall, int nCode, WPARAM wParam, LPARAM lParam, LPBOOL lpbAnsiHook)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/hooks_8c.html#a23">xxxCallMouseHook</a> (UINT message, PMOUSEHOOKSTRUCTEX pmhs, BOOL fRemove)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/hooks_8c.html#a24">xxxCallJournalRecordHook</a> (<a class="el" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsg)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/hooks_8c.html#a25">xxxCallJournalPlaybackHook</a> (<a class="el" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsg)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/hooks_8c.html#a26">FreeHook</a> (<a class="el" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phkFree)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d5/d6/structtagHOOK.html">PHOOK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/hooks_8c.html#a27">PhkFirstGlobalValid</a> (<a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti, int nFilterType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d5/d6/structtagHOOK.html">PHOOK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/hooks_8c.html#a28">PhkFirstValid</a> (<a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti, int nFilterType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/hooks_8c.html#a29">FreeThreadsWindowHooks</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/hooks_8c.html#a30">zzzRegisterSystemThread</a> (<a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="el" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwReserved)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>CONST int&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/hooks_8c.html#a8">ampiHookError</a> [CWINHOOKS]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>CONST <a class="el" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/hooks_8c.html#a9">abHookFlags</a> [CWINHOOKS]</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a7" doxytag="hooks.c::DbgValidatefsHook" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DbgValidatefsHook          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">phk,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>nFilterType,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>pti,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>fGlobal&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/hooks_8c-source.html#l00274">274</a> of file <a class="el" href="../../d2/d1/hooks_8c-source.html">hooks.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d1/hooks_8c-source.html#l02151">PhkFirstGlobalValid()</a>, and <a class="el" href="../../d2/d1/hooks_8c-source.html#l02183">PhkFirstValid()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="hooks.c::HKF_INTERSENDABLE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HKF_INTERSENDABLE&nbsp;&nbsp;&nbsp;0x10          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/hooks_8c-source.html#l00024">24</a> of file <a class="el" href="../../d2/d1/hooks_8c-source.html">hooks.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d1/hooks_8c-source.html#l01288">xxxCallHook2()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l00576">zzzSetWindowsHookEx()</a>, and <a class="el" href="../../d2/d1/hooks_8c-source.html#l01126">zzzUnhookWindowsHookEx()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="hooks.c::HKF_JOURNAL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HKF_JOURNAL&nbsp;&nbsp;&nbsp;0x04          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/hooks_8c-source.html#l00022">22</a> of file <a class="el" href="../../d2/d1/hooks_8c-source.html">hooks.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d1/hooks_8c-source.html#l01288">xxxCallHook2()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l00576">zzzSetWindowsHookEx()</a>, and <a class="el" href="../../d2/d1/hooks_8c-source.html#l01126">zzzUnhookWindowsHookEx()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="hooks.c::HKF_LOWLEVEL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HKF_LOWLEVEL&nbsp;&nbsp;&nbsp;0x20          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/hooks_8c-source.html#l00025">25</a> of file <a class="el" href="../../d2/d1/hooks_8c-source.html">hooks.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d1/hooks_8c-source.html#l01288">xxxCallHook2()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="hooks.c::HKF_NZRET" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HKF_NZRET&nbsp;&nbsp;&nbsp;0x08          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/hooks_8c-source.html#l00023">23</a> of file <a class="el" href="../../d2/d1/hooks_8c-source.html">hooks.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d1/hooks_8c-source.html#l00528">zzzSetWindowsHookAW()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="hooks.c::HKF_SYSTEM" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HKF_SYSTEM&nbsp;&nbsp;&nbsp;0x01          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/hooks_8c-source.html#l00020">20</a> of file <a class="el" href="../../d2/d1/hooks_8c-source.html">hooks.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="hooks.c::HKF_TASK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HKF_TASK&nbsp;&nbsp;&nbsp;0x02          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/hooks_8c-source.html#l00021">21</a> of file <a class="el" href="../../d2/d1/hooks_8c-source.html">hooks.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d1/hooks_8c-source.html#l00576">zzzSetWindowsHookEx()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="hooks.c::IS_CHAR_MSG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IS_CHAR_MSG          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d1/userexts_8c.html#a129">msg</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((<a class="el" href="../../d2/d1/userexts_8c.html#a129">msg</a>) &amp; 0x02)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/hooks_8c-source.html#l00126">126</a> of file <a class="el" href="../../d2/d1/hooks_8c-source.html">hooks.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d1/hooks_8c-source.html#l01797">xxxCallJournalPlaybackHook()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a20" doxytag="hooks.c::_CallMsgFilter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL _CallMsgFilter           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">LPMSG&nbsp;</td>
          <td class="mdname" nowrap> <em>pmsg</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>nCode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/hooks_8c-source.html#l01210">1210</a> of file <a class="el" href="../../d2/d1/hooks_8c-source.html">hooks.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l01266">IsHooked</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02030">WHF_MSGFILTER</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02038">WHF_SYSMSGFILTER</a>, and <a class="el" href="../../d2/d1/hooks_8c-source.html#l01246">xxxCallHook()</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l09413">NtUserCallMsgFilter()</a>, <a class="el" href="../../d2/d2/mnloop_8c-source.html#l00635">xxxMNLoop()</a>, <a class="el" href="../../d9/d2/movesize_8c-source.html#l01053">xxxMoveSize()</a>, <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l02121">xxxOldNextWindow()</a>, <a class="el" href="../../d9/d3/sbctl_8c-source.html#l02123">xxxSBTrackLoop()</a>, and <a class="el" href="../../d4/d2/mnsel_8c-source.html#l00029">xxxSendMenuSelect()</a>.
<p>
<pre class="fragment"><div>01213 {
01214     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
01215 
01216     pti = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01217 
01218     <span class="comment">/*</span>
01219 <span class="comment">     * First call WH_SYSMSGFILTER.  If it returns non-zero, don't</span>
01220 <span class="comment">     * bother calling WH_MSGFILTER, just return TRUE.  Otherwise</span>
01221 <span class="comment">     * return what WH_MSGFILTER gives us.</span>
01222 <span class="comment">     */</span>
01223     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(pti, WHF_SYSMSGFILTER) &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(nCode, 0, (LPARAM)pmsg,
01224             WH_SYSMSGFILTER)) {
01225         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01226     }
01227 
01228     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(pti, WHF_MSGFILTER)) {
01229         <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(nCode, 0, (LPARAM)pmsg, WH_MSGFILTER);
01230     }
01231 
01232     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01233 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="hooks.c::CheckWHFBits" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CheckWHFBits           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pti</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>nFilterType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/hooks_8c-source.html#l00986">986</a> of file <a class="el" href="../../d2/d1/hooks_8c-source.html">hooks.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02079">tagHOOK::flags</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02257">tagDESKTOPINFO::fsHooks</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l00533">_CLIENTINFO::fsHooks</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03368">tagTHREADINFO::fsHooks</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02007">HF_GLOBAL</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03329">tagTHREADINFO::pClientInfo</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03328">tagTHREADINFO::pDeskInfo</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l02151">PhkFirstGlobalValid()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l02183">PhkFirstValid()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03319">tagTHREADINFO::ppi</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00084">PpiCurrent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, and <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02025">WHF_FROM_WH</a>.
<p>
Referenced by <a class="el" href="../../d2/d1/hooks_8c-source.html#l01976">FreeHook()</a>.
<p>
<pre class="fragment"><div>00989 {
00990     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fClearThreadBits;
00991     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fClearDesktopBits;
00992     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phook;
00993 
00994 
00995     <span class="comment">/*</span>
00996 <span class="comment">     * Assume we're are going to clear local(thread) and</span>
00997 <span class="comment">     *   global(desktop) bits.</span>
00998 <span class="comment">     */</span>
00999     fClearThreadBits = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01000     fClearDesktopBits = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01001     <span class="comment">/*</span>
01002 <span class="comment">     * Get the first valid hook for this thread</span>
01003 <span class="comment">     */</span>
01004     phook = <a class="code" href="../../d4/d1/userk_8h.html#a1518">PhkFirstValid</a>(pti, nFilterType);
01005     <span class="keywordflow">if</span> (phook != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01006         <span class="comment">/*</span>
01007 <span class="comment">         * If it found a global hook, don't clear the desktop bits</span>
01008 <span class="comment">         * (that would mean that there are no local(thread) hooks</span>
01009 <span class="comment">         *  so we fall through to clear the thread bits)</span>
01010 <span class="comment">         */</span>
01011         <span class="keywordflow">if</span> (phook-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a502">HF_GLOBAL</a>) {
01012             fClearDesktopBits = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01013         } <span class="keywordflow">else</span> {
01014             <span class="comment">/*</span>
01015 <span class="comment">             * It found a thread hook so don't clear the thread bits</span>
01016 <span class="comment">             */</span>
01017             fClearThreadBits = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01018             <span class="comment">/*</span>
01019 <span class="comment">             * Check for global hooks now. If there is one, don't</span>
01020 <span class="comment">             *  clear the desktop bits</span>
01021 <span class="comment">             */</span>
01022             phook = <a class="code" href="../../d4/d1/userk_8h.html#a1519">PhkFirstGlobalValid</a>(pti, nFilterType);
01023             fClearDesktopBits = (phook == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01024         }
01025     } <span class="comment">/* if (phook != NULL) */</span>
01026 
01027     <span class="keywordflow">if</span> (fClearThreadBits) {
01028         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o31">fsHooks</a> &amp;= ~(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a510">WHF_FROM_WH</a>(nFilterType));
01029         <span class="comment">/*</span>
01030 <span class="comment">         * Set the flags in the thread's TEB</span>
01031 <span class="comment">         */</span>
01032         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>) {
01033             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fAttached;
01034             <span class="comment">/*</span>
01035 <span class="comment">             * If the hooked thread is in another process, attach</span>
01036 <span class="comment">             * to that process to access its address space.</span>
01037 <span class="comment">             */</span>
01038             <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> != <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()) {
01039                 <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>(&amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;Process-&gt;Pcb);
01040                 fAttached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01041             } <span class="keywordflow">else</span>
01042                 fAttached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01043 
01044             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o8">fsHooks</a> = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o31">fsHooks</a>;
01045 
01046             <span class="keywordflow">if</span> (fAttached)
01047                 <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
01048         }
01049     }
01050 
01051     <span class="keywordflow">if</span> (fClearDesktopBits) {
01052         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o7">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o3">fsHooks</a> &amp;= ~(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a510">WHF_FROM_WH</a>(nFilterType));
01053     }
01054 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="hooks.c::FreeHook" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FreeHook           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d6/structtagHOOK.html">PHOOK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>phkFree</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/hooks_8c-source.html#l01976">1976</a> of file <a class="el" href="../../d2/d1/hooks_8c-source.html">hooks.c</a>.
<p>
References <a class="el" href="../../d2/d1/hooks_8c-source.html#l00986">CheckWHFBits()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06024">DbgValidateHooks</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02079">tagHOOK::flags</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02014">HF_DESTROYED</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02007">HF_GLOBAL</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01069">HMFreeObject()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01237">HMMarkObjectDestroy()</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02077">tagHOOK::iHook</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02081">tagHOOK::ptiHooked</a>, <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00158">RemoveHmodDependency()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l02061">UnlinkHook()</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d2/d1/hooks_8c-source.html#l02227">FreeThreadsWindowHooks()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l01288">xxxCallHook2()</a>, and <a class="el" href="../../d2/d1/hooks_8c-source.html#l01126">zzzUnhookWindowsHookEx()</a>.
<p>
<pre class="fragment"><div>01978 {
01979     <span class="comment">/*</span>
01980 <span class="comment">     * Paranoia...</span>
01981 <span class="comment">     */</span>
01982     UserAssert(!(phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; HF_FREED));
01983     <span class="comment">/*</span>
01984 <span class="comment">     * BUGBUG</span>
01985 <span class="comment">     * Unless we come from zzzUnhookWindowsHook, if this was a journaling hook</span>
01986 <span class="comment">     * we don't unattach the threads.  We should reconsider this one day.</span>
01987 <span class="comment">     * MCostea Jan 21, 99</span>
01988 <span class="comment">     */</span>
01989 
01990     <span class="comment">/*</span>
01991 <span class="comment">     * Clear fsHooks bits the first time around (and mark it as destroyed).</span>
01992 <span class="comment">     */</span>
01993     <span class="keywordflow">if</span> (!(phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a509">HF_DESTROYED</a>)) {
01994         <a class="code" href="../../d4/d1/userk_8h.html#a601">DbgValidateHooks</a> (phkFree, phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a>);
01995         phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a509">HF_DESTROYED</a>;
01996         <span class="comment">/*</span>
01997 <span class="comment">         * This hook has been marked as destroyed so CheckWHSBits</span>
01998 <span class="comment">         * won't take it into account when updating the fsHooks bits.</span>
01999 <span class="comment">         * However, this means that right at this moment fsHooks is</span>
02000 <span class="comment">         * out of sync. So we need a flag to make the assertion freaks</span>
02001 <span class="comment">         * (i.e., me) happy.</span>
02002 <span class="comment">         */</span>
02003 <span class="preprocessor">#if DBG</span>
02004 <span class="preprocessor"></span>        phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> |= HF_INCHECKWHF;
02005 <span class="preprocessor">#endif</span>
02006 <span class="preprocessor"></span>        UserAssert((phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o6">ptiHooked</a> != NULL) || (phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; HF_GLOBAL));
02007         <a class="code" href="../../d1/d2/hooks_8c.html#a17">CheckWHFBits</a>(phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o6">ptiHooked</a> != NULL
02008                         ? phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o6">ptiHooked</a>
02009                         : <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkFree),
02010                      phkFree-&gt;iHook);
02011 <span class="preprocessor">#if DBG</span>
02012 <span class="preprocessor"></span>        phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp;= ~HF_INCHECKWHF;
02013 <span class="preprocessor">#endif</span>
02014 <span class="preprocessor"></span>    }
02015     <span class="comment">/*</span>
02016 <span class="comment">     * Mark it for destruction.  If it the object is locked it can't</span>
02017 <span class="comment">     * be freed right now.</span>
02018 <span class="comment">     */</span>
02019     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a971">HMMarkObjectDestroy</a>((PVOID)phkFree)) {
02020         <span class="keywordflow">return</span>;
02021     }
02022     <span class="comment">/*</span>
02023 <span class="comment">     * We're going to free this hook so get it off the list.</span>
02024 <span class="comment">     */</span>
02025     <a class="code" href="../../d1/d2/hooks_8c.html#a10">UnlinkHook</a>(phkFree);
02026     <span class="comment">/*</span>
02027 <span class="comment">     * Now remove the hmod dependency and free the</span>
02028 <span class="comment">     * HOOK structure.</span>
02029 <span class="comment">     */</span>
02030     <span class="keywordflow">if</span> (phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o5">ihmod</a> &gt;= 0) {
02031         <a class="code" href="../../d4/d1/userk_8h.html#a1543">RemoveHmodDependency</a>(phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o5">ihmod</a>);
02032     }
02033 
02034 <span class="preprocessor">#ifdef HOOKBATCH</span>
02035 <span class="preprocessor"></span>    <span class="comment">/*</span>
02036 <span class="comment">     * Free the cached Events</span>
02037 <span class="comment">     */</span>
02038     <span class="keywordflow">if</span> (phkFree-&gt;aEventCache) {
02039         UserFreePool(phkFree-&gt;aEventCache);
02040         phkFree-&gt;aEventCache = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02041     }
02042 <span class="preprocessor">#endif //HOOKBATCH</span>
02043 <span class="preprocessor"></span>
02044 <span class="preprocessor">#if DBG</span>
02045 <span class="preprocessor"></span>    phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> |= HF_FREED;
02046 <span class="preprocessor">#endif</span>
02047 <span class="preprocessor"></span>
02048     <a class="code" href="../../d4/d1/userk_8h.html#a970">HMFreeObject</a>((PVOID)phkFree);
02049     <span class="keywordflow">return</span>;
02050 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="hooks.c::FreeThreadsWindowHooks" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FreeThreadsWindowHooks           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/hooks_8c-source.html#l02227">2227</a> of file <a class="el" href="../../d2/d1/hooks_8c-source.html">hooks.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l03393">tagTHREADINFO::aphkStart</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02158">tagDESKTOPINFO::aphkStart</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02079">tagHOOK::flags</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l01976">FreeHook()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03368">tagTHREADINFO::fsHooks</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02014">HF_DESTROYED</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02007">HF_GLOBAL</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03328">tagTHREADINFO::pDeskInfo</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01988">tagHOOK::phkNext</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02081">tagHOOK::ptiHooked</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03327">tagTHREADINFO::rpdesk</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03369">tagTHREADINFO::sphkCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02826">TIF_INCLEANUP</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l02061">UnlinkHook()</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00368">Unlock</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/queue_8c-source.html#l02552">xxxDestroyThreadInfo()</a>.
<p>
<pre class="fragment"><div>02228 {
02229     <span class="keywordtype">int</span> iHook;
02230     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phk, phkNext;
02231     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
02232 
02233     <span class="comment">/*</span>
02234 <span class="comment">     * If there is not thread info, there are not hooks to worry about</span>
02235 <span class="comment">     */</span>
02236     <span class="keywordflow">if</span> (ptiCurrent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02237         <span class="keywordflow">return</span>;
02238     }
02239     <span class="comment">/*</span>
02240 <span class="comment">     * In case we have a hook locked in as the current hook unlock it</span>
02241 <span class="comment">     * so it can be freed</span>
02242 <span class="comment">     */</span>
02243     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o32">sphkCurrent</a>);
02244 
02245     UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; TIF_INCLEANUP);
02246     <span class="comment">// Why bother doing this? We won't be calling back to user mode again!</span>
02247     <span class="comment">// if (ptiCurrent-&gt;pClientInfo) {</span>
02248     <span class="comment">//    ptiCurrent-&gt;pClientInfo-&gt;phkCurrent = NULL;</span>
02249     <span class="comment">// }</span>
02250 
02251     <span class="comment">/*</span>
02252 <span class="comment">     * Loop through all the hook types.</span>
02253 <span class="comment">     */</span>
02254     <span class="keywordflow">for</span> (iHook = WH_MIN ; iHook &lt;= WH_MAX ; ++iHook) {
02255         <span class="comment">/*</span>
02256 <span class="comment">         * Loop through all the hooks of this type, including the</span>
02257 <span class="comment">         *  ones already marked as destroyed (so don't call</span>
02258 <span class="comment">         *  PhkFirstValid and PhkNextValid).</span>
02259 <span class="comment">         */</span>
02260         phk = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o51">aphkStart</a>[iHook + 1];
02261         <span class="keywordflow">if</span> (phk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02262             phk = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o7">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o4">aphkStart</a>[iHook + 1];
02263             UserAssert((phk == NULL) || (phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; HF_GLOBAL));
02264         }
02265 
02266         <span class="keywordflow">while</span> (phk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02267             <span class="comment">/*</span>
02268 <span class="comment">             * We might free phk below, so grab the next now</span>
02269 <span class="comment">             * If at end of local chain, jump to the global chain</span>
02270 <span class="comment">             */</span>
02271             phkNext = phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o1">phkNext</a>;
02272             <span class="keywordflow">if</span> ((phkNext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; !(phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a502">HF_GLOBAL</a>)) {
02273                 phkNext = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o7">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o4">aphkStart</a>[iHook + 1];
02274                 UserAssert((phkNext == NULL) || (phkNext-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; HF_GLOBAL));
02275             }
02276             <span class="comment">/*</span>
02277 <span class="comment">             * If this is a local(thread) hook, unlink it and mark it as</span>
02278 <span class="comment">             *  destroyed so we won't call it anymore. We want to do</span>
02279 <span class="comment">             *  this even if not calling FreeHook; also note that</span>
02280 <span class="comment">             *  FreeHook won't unlink it if locked so we do it here anyway.</span>
02281 <span class="comment">             */</span>
02282             <span class="keywordflow">if</span> (!(phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a502">HF_GLOBAL</a>)) {
02283                 UserAssert(ptiCurrent == phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o6">ptiHooked</a>);
02284                 <a class="code" href="../../d1/d2/hooks_8c.html#a10">UnlinkHook</a>(phk);
02285                 phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a509">HF_DESTROYED</a>;
02286                 phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o1">phkNext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02287             }
02288             <span class="comment">/*</span>
02289 <span class="comment">             * If this hook was created by this thread, free it</span>
02290 <span class="comment">             */</span>
02291             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phk) == ptiCurrent) {
02292                 <a class="code" href="../../d4/d1/userk_8h.html#a1520">FreeHook</a>(phk);
02293             }
02294 
02295             phk = phkNext;
02296         }
02297        <span class="comment">/*</span>
02298 <span class="comment">        * All local hooks should be unlinked</span>
02299 <span class="comment">        */</span>
02300        UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o51">aphkStart</a>[iHook + 1] == NULL);
02301     } <span class="comment">/* for (iHook = WH_MIN....*/</span>
02302 
02303     <span class="comment">/*</span>
02304 <span class="comment">     * Keep fsHooks in sync.</span>
02305 <span class="comment">     */</span>
02306     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o31">fsHooks</a> = 0;
02307 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="hooks.c::InterQueueMsgCleanup" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void InterQueueMsgCleanup           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>dwTimeFromLastRead</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/hooks_8c-source.html#l00339">339</a> of file <a class="el" href="../../d2/d1/hooks_8c-source.html">hooks.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l01833">CheckCritIn</a>, <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00080">FHungApp()</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00643">gpsmsList</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03297">PSMS</a>, and <a class="el" href="../../d4/d1/userk_8h.html#a1149">ReceiverDied()</a>.
<p>
Referenced by <a class="el" href="../../d2/d1/hooks_8c-source.html#l00404">zzzCancelJournalling()</a>.
<p>
<pre class="fragment"><div>00340 {
00341     <a class="code" href="../../d4/d1/userk_8h.html#a871">PSMS</a> *ppsms;
00342     <a class="code" href="../../d4/d1/userk_8h.html#a871">PSMS</a> psmsNext;
00343 
00344     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00345 
00346     <span class="comment">/*</span>
00347 <span class="comment">     * Walk  gpsmsList</span>
00348 <span class="comment">     */</span>
00349     <span class="keywordflow">for</span> (ppsms = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a238">gpsmsList</a>; *ppsms; ) {
00350         psmsNext = (*ppsms)-&gt;psmsNext;
00351         <span class="comment">/*</span>
00352 <span class="comment">         * If this is an inter queue message</span>
00353 <span class="comment">         */</span>
00354         <span class="keywordflow">if</span> (((*ppsms)-&gt;ptiSender != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00355                 &amp;&amp; ((*ppsms)-&gt;ptiReceiver != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00356                 &amp;&amp; ((*ppsms)-&gt;ptiSender-&gt;pq != (*ppsms)-&gt;ptiReceiver-&gt;pq)) {
00357             <span class="comment">/*</span>
00358 <span class="comment">             * If the receiver has been hung for a while</span>
00359 <span class="comment">             */</span>
00360             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1650">FHungApp</a> ((*ppsms)-&gt;ptiReceiver, dwTimeFromLastRead)) {
00361 
00362                 <span class="keywordflow">switch</span> ((*ppsms)-&gt;message) {
00363                     <span class="comment">/*</span>
00364 <span class="comment">                     * Activation messages</span>
00365 <span class="comment">                     */</span>
00366                     <span class="keywordflow">case</span> WM_NCACTIVATE:
00367                     <span class="keywordflow">case</span> WM_ACTIVATEAPP:
00368                     <span class="keywordflow">case</span> WM_ACTIVATE:
00369                     <span class="keywordflow">case</span> WM_SETFOCUS:
00370                     <span class="keywordflow">case</span> WM_KILLFOCUS:
00371                     <span class="keywordflow">case</span> WM_QUERYNEWPALETTE:
00372                     <span class="comment">/*</span>
00373 <span class="comment">                     * Sent to spwndFocus, which now can be in a different queue</span>
00374 <span class="comment">                     */</span>
00375                     <span class="keywordflow">case</span> WM_INPUTLANGCHANGE:
00376                         RIPMSG3 (RIP_WARNING, <span class="stringliteral">"InterQueueMsgCleanup: ptiSender:%#p ptiReceiver:%#p message:%#lx"</span>,
00377                                     (*ppsms)-&gt;ptiSender, (*ppsms)-&gt;ptiReceiver, (*ppsms)-&gt;message);
00378                         <a class="code" href="../../d4/d1/userk_8h.html#a1149">ReceiverDied</a>(*ppsms, ppsms);
00379                         <span class="keywordflow">break</span>;
00380 
00381                 } <span class="comment">/* switch */</span>
00382 
00383             } <span class="comment">/* If hung receiver */</span>
00384 
00385         } <span class="comment">/* If inter queue message */</span>
00386 
00387          <span class="comment">/*</span>
00388 <span class="comment">          * If the message was not unlinked, go to the next one.</span>
00389 <span class="comment">          */</span>
00390         <span class="keywordflow">if</span> (*ppsms != psmsNext)
00391             ppsms = &amp;(*ppsms)-&gt;psmsNext;
00392 
00393     } <span class="comment">/* for */</span>
00394 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="hooks.c::PhkFirstGlobalValid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d5/d6/structtagHOOK.html">PHOOK</a> PhkFirstGlobalValid           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pti</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>nFilterType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/hooks_8c-source.html#l02151">2151</a> of file <a class="el" href="../../d2/d1/hooks_8c-source.html">hooks.c</a>.
<p>
References <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02158">tagDESKTOPINFO::aphkStart</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01833">CheckCritIn</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l00274">DbgValidatefsHook</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06024">DbgValidateHooks</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02079">tagHOOK::flags</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02014">HF_DESTROYED</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03328">tagTHREADINFO::pDeskInfo</a>, <a class="el" href="../../d7/d8/rtl_2wow_8c-source.html#l01031">PhkNextValid()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d1/hooks_8c-source.html#l00986">CheckWHFBits()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l01416">GetJournallingQueue()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l01797">xxxCallJournalPlaybackHook()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l01695">xxxCallJournalRecordHook()</a>, <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l02802">xxxGetNextSysMsg()</a>, <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l00213">xxxInternalGetMessage()</a>, <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l02982">xxxSkipSysMsg()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l00404">zzzCancelJournalling()</a>, and <a class="el" href="../../d2/d1/hooks_8c-source.html#l01126">zzzUnhookWindowsHookEx()</a>.
<p>
<pre class="fragment"><div>02152 {
02153     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phk;
02154 
02155     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
02156     phk = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o7">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o4">aphkStart</a>[nFilterType + 1];
02157     <span class="comment">/*</span>
02158 <span class="comment">     * Return the first hook that it's not destroyed (i.e, the</span>
02159 <span class="comment">     *  first valid one).</span>
02160 <span class="comment">     */</span>
02161     <span class="keywordflow">if</span> ((phk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a509">HF_DESTROYED</a>)) {
02162         phk = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a22">PhkNextValid</a>(phk);
02163     }
02164     <span class="comment">/*</span>
02165 <span class="comment">     * Good place to check fsHooks. If the bits are out of sync,</span>
02166 <span class="comment">     *  someone must be adjusting them.</span>
02167 <span class="comment">     */</span>
02168     <a class="code" href="../../d1/d2/hooks_8c.html#a7">DbgValidatefsHook</a>(phk, nFilterType, pti, TRUE);
02169     <a class="code" href="../../d4/d1/userk_8h.html#a601">DbgValidateHooks</a>(phk, nFilterType);
02170     <span class="keywordflow">return</span> phk;
02171 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="hooks.c::PhkFirstValid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d5/d6/structtagHOOK.html">PHOOK</a> PhkFirstValid           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pti</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>nFilterType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/hooks_8c-source.html#l02183">2183</a> of file <a class="el" href="../../d2/d1/hooks_8c-source.html">hooks.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l03393">tagTHREADINFO::aphkStart</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02158">tagDESKTOPINFO::aphkStart</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01833">CheckCritIn</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l00274">DbgValidatefsHook</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06024">DbgValidateHooks</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02079">tagHOOK::flags</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02014">HF_DESTROYED</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03328">tagTHREADINFO::pDeskInfo</a>, and <a class="el" href="../../d7/d8/rtl_2wow_8c-source.html#l01031">PhkNextValid()</a>.
<p>
Referenced by <a class="el" href="../../d2/d1/hooks_8c-source.html#l00986">CheckWHFBits()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l00472">xxxButtonEvent()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l01246">xxxCallHook()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l01666">xxxCallMouseHook()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l01020">xxxDoButtonEvent()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l01338">xxxKeyEvent()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l01936">xxxMoveEventAbsolute()</a>, and <a class="el" href="../../d2/d1/hooks_8c-source.html#l01068">zzzUnhookWindowsHook()</a>.
<p>
<pre class="fragment"><div>02186 {
02187     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phk;
02188     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
02189     <span class="comment">/*</span>
02190 <span class="comment">     * Grab the first hook off the local hook-list</span>
02191 <span class="comment">     * for the current queue.</span>
02192 <span class="comment">     */</span>
02193     phk = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o51">aphkStart</a>[nFilterType + 1];
02194     <span class="comment">/*</span>
02195 <span class="comment">     * If there aren't any local hooks, try the global hooks.</span>
02196 <span class="comment">     */</span>
02197     <span class="keywordflow">if</span> (phk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02198         phk = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o7">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o4">aphkStart</a>[nFilterType + 1];
02199     }
02200     <span class="comment">/*</span>
02201 <span class="comment">     * Return the first hook that it's not destroyed (i.e, the</span>
02202 <span class="comment">     *  first valid one).</span>
02203 <span class="comment">     */</span>
02204     <span class="keywordflow">if</span> ((phk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a509">HF_DESTROYED</a>)) {
02205         phk = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a22">PhkNextValid</a>(phk);
02206     }
02207     <span class="comment">/*</span>
02208 <span class="comment">     * Good place to check fsHooks. If the bits are out of sync,</span>
02209 <span class="comment">     *  someone must be adjusting them.</span>
02210 <span class="comment">     */</span>
02211 
02212     <a class="code" href="../../d1/d2/hooks_8c.html#a7">DbgValidatefsHook</a>(phk, nFilterType, pti, FALSE);
02213     <a class="code" href="../../d4/d1/userk_8h.html#a601">DbgValidateHooks</a>(phk, nFilterType);
02214     <span class="keywordflow">return</span> phk;
02215 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="hooks.c::UnlinkHook" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void UnlinkHook           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d6/structtagHOOK.html">PHOOK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>phkFree</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/hooks_8c-source.html#l02061">2061</a> of file <a class="el" href="../../d2/d1/hooks_8c-source.html">hooks.c</a>.
<p>
References <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02158">tagDESKTOPINFO::aphkStart</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03393">tagTHREADINFO::aphkStart</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01833">CheckCritIn</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02079">tagHOOK::flags</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00455">gptiRit</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02075">tagHOOK::head</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02007">HF_GLOBAL</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02077">tagHOOK::iHook</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03328">tagTHREADINFO::pDeskInfo</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02644">tagDESKTOP::pDeskInfo</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01988">tagHOOK::phkNext</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02081">tagHOOK::ptiHooked</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02082">tagHOOK::rpdesk</a>, and <a class="el" href="../../d5/d0/userk_8h-source.html#l01649">UnlockDesktop</a>.
<p>
Referenced by <a class="el" href="../../d2/d1/hooks_8c-source.html#l01976">FreeHook()</a>, and <a class="el" href="../../d2/d1/hooks_8c-source.html#l02227">FreeThreadsWindowHooks()</a>.
<p>
<pre class="fragment"><div>02063 {
02064     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> *pphkNext;
02065     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiT;
02066 
02067     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
02068     <span class="comment">/*</span>
02069 <span class="comment">     * Since we have the HOOK structure, we can tell if this a global</span>
02070 <span class="comment">     * or local hook and start on the right list.</span>
02071 <span class="comment">     */</span>
02072     <span class="keywordflow">if</span> (phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a502">HF_GLOBAL</a>) {
02073         pphkNext = &amp;<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkFree)-&gt;pDeskInfo-&gt;aphkStart[phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a> + 1];
02074     } <span class="keywordflow">else</span> {
02075         ptiT = phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o6">ptiHooked</a>;
02076         <span class="keywordflow">if</span> (ptiT == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02077             <span class="comment">/*</span>
02078 <span class="comment">             * Already unlinked (by FreeThreadsWindowHooks)</span>
02079 <span class="comment">             */</span>
02080             <span class="keywordflow">return</span>;
02081         } <span class="keywordflow">else</span> {
02082             <span class="comment">/*</span>
02083 <span class="comment">             * Clear ptiHooked so we won't try to unlink it again.</span>
02084 <span class="comment">             */</span>
02085             phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o6">ptiHooked</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02086         }
02087         pphkNext = &amp;(ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o51">aphkStart</a>[phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a> + 1]);
02088         <span class="comment">/*</span>
02089 <span class="comment">         * There must be at least one hook in the chain</span>
02090 <span class="comment">         */</span>
02091         UserAssert(*pphkNext != NULL);
02092     }
02093     <span class="comment">/*</span>
02094 <span class="comment">     * Find the address of the phkNext pointing to phkFree</span>
02095 <span class="comment">     */</span>
02096     <span class="keywordflow">while</span> ((*pphkNext != phkFree) &amp;&amp; (*pphkNext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02097        pphkNext = &amp;(*pphkNext)-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o1">phkNext</a>;
02098     }
02099     <span class="comment">/*</span>
02100 <span class="comment">     * If we haven't found it, it must be global hook whose owner is gone or</span>
02101 <span class="comment">     *  has switched desktops.</span>
02102 <span class="comment">     */</span>
02103     <span class="keywordflow">if</span> (*pphkNext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02104         UserAssert(phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; HF_GLOBAL);
02105         <span class="comment">/*</span>
02106 <span class="comment">         * if we saved a pdesk, use it. Else use the one we allocated it from</span>
02107 <span class="comment">         */</span>
02108         <span class="keywordflow">if</span> (phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o7">rpdesk</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02109             UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkFree) == gptiRit);
02110             UserAssert(phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o7">rpdesk</a> != NULL);
02111             UserAssert(phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o7">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a> != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o7">pDeskInfo</a>);
02112 
02113             pphkNext = &amp;phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o7">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o4">aphkStart</a>[phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a> + 1];
02114         } <span class="keywordflow">else</span> {
02115             UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkFree)-&gt;pDeskInfo != phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o0">head</a>.rpdesk-&gt;pDeskInfo);
02116             pphkNext = &amp;phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o0">head</a>.rpdesk-&gt;pDeskInfo-&gt;aphkStart[phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a> + 1];
02117         }
02118 
02119         UserAssert(*pphkNext != NULL);
02120         <span class="keywordflow">while</span> ((*pphkNext != phkFree) &amp;&amp; (*pphkNext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02121            pphkNext = &amp;(*pphkNext)-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o1">phkNext</a>;
02122         }
02123     }
02124     <span class="comment">/*</span>
02125 <span class="comment">     * We're supposed to find it</span>
02126 <span class="comment">     */</span>
02127     UserAssert(*pphkNext == phkFree);
02128     <span class="comment">/*</span>
02129 <span class="comment">     * Unlink it</span>
02130 <span class="comment">     */</span>
02131     *pphkNext = phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o1">phkNext</a>;
02132     phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o1">phkNext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02133     <span class="comment">/*</span>
02134 <span class="comment">     * If we had a desktop, unlock it</span>
02135 <span class="comment">     */</span>
02136     <span class="keywordflow">if</span> (phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o7">rpdesk</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02137         UserAssert(phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; HF_GLOBAL);
02138         UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkFree) == gptiRit);
02139         <a class="code" href="../../d4/d1/userk_8h.html#a127">UnlockDesktop</a>(&amp;phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o7">rpdesk</a>, LDU_HOOK_DESK, 0);
02140     }
02141 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="hooks.c::xxxCallHook" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int xxxCallHook           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">int&nbsp;</td>
          <td class="mdname" nowrap> <em>nCode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>wParam</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>lParam</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>iHook</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/hooks_8c-source.html#l01246">1246</a> of file <a class="el" href="../../d2/d1/hooks_8c-source.html">hooks.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l02183">PhkFirstValid()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, and <a class="el" href="../../d2/d1/hooks_8c-source.html#l01288">xxxCallHook2()</a>.
<p>
Referenced by <a class="el" href="../../d2/d1/hooks_8c-source.html#l01210">_CallMsgFilter()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l00472">xxxActivateThisWindow()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l01288">xxxCallHook2()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l01797">xxxCallJournalPlaybackHook()</a>, <a class="el" href="../../d5/d7/createw_8c-source.html#l00033">xxxCreateWindowEx()</a>, <a class="el" href="../../d9/d2/dwp_8c-source.html#l01264">xxxDefWindowProc()</a>, <a class="el" href="../../d5/d7/createw_8c-source.html#l01591">xxxDestroyWindow()</a>, <a class="el" href="../../d3/d7/swp_8c-source.html#l04773">xxxEndDeferWindowPosEx()</a>, <a class="el" href="../../d0/d7/kernel_2winmgr_8c-source.html#l00027">xxxFlashWindow()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l05238">xxxGetInputEvent()</a>, <a class="el" href="../../d1/d4/ntuser_2kernel_2getset_8c-source.html#l00499">xxxHandleOwnerSwitch()</a>, <a class="el" href="../../d7/d1/kbdlyout_8c-source.html#l01203">xxxInternalActivateKeyboardLayout()</a>, <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l00213">xxxInternalGetMessage()</a>, <a class="el" href="../../d7/d1/kbdlyout_8c-source.html#l01571">xxxInternalUnloadKeyboardLayout()</a>, <a class="el" href="../../d7/d0/dragdrop_8c-source.html#l00354">xxxIsDragging()</a>, <a class="el" href="../../d7/d1/kbdlyout_8c-source.html#l00654">xxxLoadKeyboardLayoutEx()</a>, <a class="el" href="../../d5/d8/minmax_8c-source.html#l01329">xxxMinMaximize()</a>, <a class="el" href="../../d9/d2/movesize_8c-source.html#l01053">xxxMoveSize()</a>, <a class="el" href="../../d9/d2/movesize_8c-source.html#l00437">xxxMS_TrackMove()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l04271">xxxMsgWaitForMultipleObjects()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l02295">xxxNotifyIMEStatus()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l03772">xxxProcessEventMessage()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01964">xxxReceiveMessage()</a>, <a class="el" href="../../d2/d1/drawfrm_8c-source.html#l00205">xxxRedrawFrameAndHook()</a>, <a class="el" href="../../d9/d2/dwp_8c-source.html#l00766">xxxRedrawTitle()</a>, <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l03305">xxxScanSysQueue()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01114">xxxSendMessageCallback()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00764">xxxSendMessageTimeout()</a>, <a class="el" href="../../d5/d4/rare_8c-source.html#l03675">xxxSendMinRectMessages()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l01815">xxxSetFocus()</a>, <a class="el" href="../../d9/d6/winloop2_8c-source.html#l00100">xxxSetTrayWindow()</a>, <a class="el" href="../../d7/d8/taskman_8c-source.html#l00252">xxxSleepTask()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l04382">xxxSleepThread()</a>, <a class="el" href="../../d5/d7/syscmd_8c-source.html#l00193">xxxSysCommand()</a>, and <a class="el" href="../../d5/d4/rare_8c-source.html#l01497">xxxSystemParametersInfo()</a>.
<p>
<pre class="fragment"><div>01251 {
01252     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bAnsiHook;
01253 
01254     <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)<a class="code" href="../../d4/d1/userk_8h.html#a1522">xxxCallHook2</a>(<a class="code" href="../../d4/d1/userk_8h.html#a1518">PhkFirstValid</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), iHook), nCode, wParam, lParam, &amp;bAnsiHook);
01255 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="hooks.c::xxxCallHook2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LRESULT xxxCallHook2           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d6/structtagHOOK.html">PHOOK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>phkCall</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>nCode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>wParam</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>lParam</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPBOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>lpbAnsiHook</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/hooks_8c-source.html#l01288">1288</a> of file <a class="el" href="../../d2/d1/hooks_8c-source.html">hooks.c</a>.
<p>
References <a class="el" href="../../d2/d1/hooks_8c-source.html#l00049">abHookFlags</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l00027">ampiHookError</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">BYTE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01833">CheckCritIn</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03506">CMSHUNGAPPTIMEOUT</a>, <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00080">FHungApp()</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02079">tagHOOK::flags</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l01976">FreeHook()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03744">tagINTERSENDMSGEX::fuCall</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03750">tagINTERSENDMSGEX::fuSend</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00698">gnllHooksTimeout</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00455">gptiRit</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02008">HF_ANSI</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02007">HF_GLOBAL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02011">HF_HOOKFAULTED</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02013">HF_WX86KNOWNDLL</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l00024">HKF_INTERSENDABLE</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l00022">HKF_JOURNAL</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l00025">HKF_LOWLEVEL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01477">HMIsMarkDestroy</a>, <a class="el" href="../../d4/d1/userk_8h.html#a898">HOOKMSGSTRUCT</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02080">tagHOOK::ihmod</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02077">tagHOOK::iHook</a>, <a class="el" href="../../d4/d1/userk_8h.html#a894">INTRSENDMSGEX</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l01266">IsHooked</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03756">ISM_TIMEOUT</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00223">IsRestricted()</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00367">Lock</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03783">tagHOOKMSGSTRUCT::lParam</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03752">tagINTERSENDMSGEX::lpdwResult</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03504">tagPROCESSINFO::luidSession</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00656">luidSystem</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03782">tagHOOKMSGSTRUCT::nCode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03329">tagTHREADINFO::pClientInfo</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03781">tagHOOKMSGSTRUCT::phk</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00515">_CLIENTINFO::phkCurrent</a>, <a class="el" href="../../d7/d8/rtl_2wow_8c-source.html#l01031">PhkNextValid()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03319">tagTHREADINFO::ppi</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02081">tagHOOK::ptiHooked</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03327">tagTHREADINFO::rpdesk</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01824">RtlEqualLuid()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02347">SET_TIME_LAST_READ</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03369">tagTHREADINFO::sphkCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03665">TESTHMODLOADED</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00365">ThreadLockAlwaysWithPti</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00364">ThreadLockWithPti</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00366">ThreadUnlock</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01175">TIDq</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02827">TIF_16BIT</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02849">TIF_ALLOWOTHERACCOUNTHOOK</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02829">TIF_CSRSSTHREAD</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02855">TIF_DISABLEHOOKS</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02843">TIF_DOSEMULATOR</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02826">TIF_INCLEANUP</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02828">TIF_SYSTEMTHREAD</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l03006">TIF_WOW64</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03751">tagINTERSENDMSGEX::uTimeout</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02041">WHF_DEBUG</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l01246">xxxCallHook()</a>, <a class="el" href="../../d0/d4/srvhook_8c-source.html#l00028">xxxHkCallHook()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01296">xxxInterSendMsgEx()</a>, and <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00192">xxxLoadHmodIndex()</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/ntinput_8c-source.html#l00472">xxxButtonEvent()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l01246">xxxCallHook()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l01797">xxxCallJournalPlaybackHook()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l01695">xxxCallJournalRecordHook()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l01666">xxxCallMouseHook()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l00961">xxxCallNextHookEx()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l01020">xxxDoButtonEvent()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l01338">xxxKeyEvent()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l01936">xxxMoveEventAbsolute()</a>, and <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01964">xxxReceiveMessage()</a>.
<p>
<pre class="fragment"><div>01294 {
01295     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>        iHook;
01296     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a>       phkSave;
01297     LONG_PTR     nRet;
01298     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
01299     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fLoadSuccess;
01300     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlphkCall;
01301     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlphkSave;
01302     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>        bHookFlags;
01303     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fMustIntersend;
01304 
01305     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
01306 
01307     <span class="keywordflow">if</span> (phkCall == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01308         <span class="keywordflow">return</span> 0;
01309     }
01310 
01311     iHook = phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a>;
01312 
01313     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01314     <span class="comment">/*</span>
01315 <span class="comment">     * Only low level hooks are allowed in the RIT context</span>
01316 <span class="comment">     * (This check used to be done in PhkFirstValid).</span>
01317 <span class="comment">     */</span>
01318     <span class="keywordflow">if</span> (ptiCurrent == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>) {
01319         <span class="keywordflow">switch</span> (iHook) {
01320         <span class="keywordflow">case</span> WH_MOUSE_LL:
01321         <span class="keywordflow">case</span> WH_KEYBOARD_LL:
01322 
01323 <span class="preprocessor">#ifdef REDIRECTION</span>
01324 <span class="preprocessor"></span>        <span class="keywordflow">case</span> WH_HITTEST:
01325 <span class="preprocessor">#endif // REDIRECTION</span>
01326 <span class="preprocessor"></span>
01327             <span class="keywordflow">break</span>;
01328 
01329         <span class="keywordflow">default</span>:
01330             <span class="keywordflow">return</span> 0;
01331         }
01332     }
01333 
01334     <span class="comment">/*</span>
01335 <span class="comment">     * If this queue is in cleanup, exit: it has no business calling back</span>
01336 <span class="comment">     * a hook proc. Also check if hooks are disabled for the thread.</span>
01337 <span class="comment">     */</span>
01338     <span class="keywordflow">if</span> (    ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a820">TIF_DISABLEHOOKS</a>) ||
01339             ((ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a> != WH_MOUSE_LL))) {
01340         <span class="keywordflow">return</span> <a class="code" href="../../d1/d2/hooks_8c.html#a8">ampiHookError</a>[iHook + 1];
01341     }
01342 
01343     <span class="comment">/*</span>
01344 <span class="comment">     * Try to call each hook in the list until one is successful or</span>
01345 <span class="comment">     * we reach the end of the list.</span>
01346 <span class="comment">     */</span>
01347     <span class="keywordflow">do</span> {
01348         *lpbAnsiHook = phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a503">HF_ANSI</a>;
01349         bHookFlags = <a class="code" href="../../d1/d2/hooks_8c.html#a9">abHookFlags</a>[phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a> + 1];
01350 
01351         <span class="comment">/*</span>
01352 <span class="comment">         * Some WH_SHELL hook types can be called from console</span>
01353 <span class="comment">         * HSHELL_APPCOMMAND added for bug 346575 DefWindowProc invokes a shell hook</span>
01354 <span class="comment">         * for console windows if they don't handle the wm_appcommand message - we need the hook</span>
01355 <span class="comment">         * to go through for csrss.</span>
01356 <span class="comment">         */</span>
01357         <span class="keywordflow">if</span> ((phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a> == WH_SHELL) &amp;&amp; (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a798">TIF_CSRSSTHREAD</a>)) {
01358             <span class="keywordflow">if</span> ((nCode == HSHELL_LANGUAGE) || (nCode == HSHELL_WINDOWACTIVATED) ||
01359                 (nCode == HSHELL_APPCOMMAND)) {
01360                 bHookFlags |= <a class="code" href="../../d1/d2/hooks_8c.html#a4">HKF_INTERSENDABLE</a>;
01361             }
01362         }
01363 
01364         <span class="keywordflow">if</span> ((phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a> == WH_SHELL) &amp;&amp; (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a797">TIF_SYSTEMTHREAD</a>)) {
01365             <span class="keywordflow">if</span> ((nCode == HSHELL_ACCESSIBILITYSTATE) ) {
01366                 bHookFlags |= <a class="code" href="../../d1/d2/hooks_8c.html#a4">HKF_INTERSENDABLE</a>;
01367             }
01368         }
01369 
01370         fMustIntersend =
01371             (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkCall) != ptiCurrent) &amp;&amp;
01372             (
01373                 <span class="comment">/*</span>
01374 <span class="comment">                 * We always want to intersend journal hooks.</span>
01375 <span class="comment">                 * CONSIDER (adams): Why? There's a performance hit by</span>
01376 <span class="comment">                 * doing so, so if we haven't a reason, we shouldn't</span>
01377 <span class="comment">                 * do it.</span>
01378 <span class="comment">                 *</span>
01379 <span class="comment">                 * we also need to intersend low level hooks. They can be called</span>
01380 <span class="comment">                 * from the desktop thread, the raw input thread AND also from</span>
01381 <span class="comment">                 * any thread that calls CallNextHookEx.</span>
01382 <span class="comment">                 */</span>
01383                 (bHookFlags &amp; (<a class="code" href="../../d1/d2/hooks_8c.html#a2">HKF_JOURNAL</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a5">HKF_LOWLEVEL</a>))
01384 
01385                 <span class="comment">/*</span>
01386 <span class="comment">                 * We must intersend if a 16bit app hooks a 32bit app</span>
01387 <span class="comment">                 * because we can't load a 16bit dll into a 32bit process.</span>
01388 <span class="comment">                 * We must also intersend if a 16bit app hooks another 16bit app</span>
01389 <span class="comment">                 * in a different VDM, because we can't load a 16bit dll from</span>
01390 <span class="comment">                 * one VDM into a 16bit app in another VDM (because that</span>
01391 <span class="comment">                 * VDM is actually a 32bit process).</span>
01392 <span class="comment">                 */</span>
01393                 ||
01394                 (   <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkCall)-&gt;TIF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a> &amp;&amp;
01395                     (   !(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) ||
01396                         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkCall)-&gt;ppi))
01397 
01398 <span class="preprocessor">#if defined(_WIN64)</span>
01399 <span class="preprocessor"></span>
01400                 <span class="comment">/*</span>
01401 <span class="comment">                 * Intersend if a 64bit app hooks a 32bit app or</span>
01402 <span class="comment">                 * a 32bit app hooks a 64bit app.</span>
01403 <span class="comment">                 * This is necessary since a hook DLL can not be loaded</span>
01404 <span class="comment">                 * cross bit type.</span>
01405 <span class="comment">                 */</span>
01406                 ||
01407                 (   (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkCall)-&gt;TIF_flags &amp; <a class="code" href="../../d1/d0/inc_2user_8h.html#a796">TIF_WOW64</a>) !=
01408                     (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d1/d0/inc_2user_8h.html#a796">TIF_WOW64</a>)
01409                 )
01410 
01411 <span class="preprocessor">#endif </span><span class="comment">/* defined(_WIN64) */</span>
01412 
01413                 <span class="comment">/*</span>
01414 <span class="comment">                 * We must intersend if a console or system thread is calling a hook</span>
01415 <span class="comment">                 * that is not in the same console or the system process.</span>
01416 <span class="comment">                 */</span>
01417                 ||
01418                 (   ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a798">TIF_CSRSSTHREAD</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a797">TIF_SYSTEMTHREAD</a>) &amp;&amp;
01419                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkCall)-&gt;ppi != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>)
01420 
01421                 <span class="comment">/*</span>
01422 <span class="comment">                 * If this is a global and non-journal hook, do a security</span>
01423 <span class="comment">                 * check on the current desktop to see if we can call here.</span>
01424 <span class="comment">                 * Note that we allow processes with the SYSTEM_LUID to hook</span>
01425 <span class="comment">                 * other processes even if the other process says that it</span>
01426 <span class="comment">                 * doesn't allow other accounts to hook them.  We did this</span>
01427 <span class="comment">                 * because there was a bug in NT 3.x that allowed it and some</span>
01428 <span class="comment">                 * services were written to use it.</span>
01429 <span class="comment">                 */</span>
01430                 ||
01431                 (   phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a502">HF_GLOBAL</a> &amp;&amp;
01432                     !<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkCall)-&gt;ppi-&gt;luidSession, &amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o27">luidSession</a>) &amp;&amp;
01433                     !(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a815">TIF_ALLOWOTHERACCOUNTHOOK</a>) &amp;&amp;
01434                     !<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkCall)-&gt;ppi-&gt;luidSession, &amp;luidSystem))
01435 
01436                 <span class="comment">/*</span>
01437 <span class="comment">                 * We must intersend if the hooking thread is running in</span>
01438 <span class="comment">                 * another process and is restricted.</span>
01439 <span class="comment">                 */</span>
01440                 ||
01441                 (   <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkCall)-&gt;ppi != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> &amp;&amp;
01442                     <a class="code" href="../../d6/d9/restrfil_8c.html#a29">IsRestricted</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkCall)-&gt;pEThread))
01443              );
01444 
01445         <span class="comment">/*</span>
01446 <span class="comment">         * We're calling back... make sure the hook doesn't go away while</span>
01447 <span class="comment">         * we're calling back. We've thread locked here: we must unlock before</span>
01448 <span class="comment">         * returning or enumerating the next hook in the chain.</span>
01449 <span class="comment">         */</span>
01450         <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, phkCall, &amp;tlphkCall);
01451 
01452         <span class="keywordflow">if</span> (!fMustIntersend) {
01453             <span class="comment">/*</span>
01454 <span class="comment">             * Make sure the DLL for this hook, if any, has been loaded</span>
01455 <span class="comment">             * for the current process.</span>
01456 <span class="comment">             */</span>
01457             <span class="keywordflow">if</span> ((phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o5">ihmod</a> != -1) &amp;&amp;
01458                     (<a class="code" href="../../d4/d1/userk_8h.html#a420">TESTHMODLOADED</a>(ptiCurrent, phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o5">ihmod</a>) == 0)) {
01459 
01460                 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bWx86KnownDll;
01461 
01462                 <span class="comment">/*</span>
01463 <span class="comment">                 * Try loading the library, since it isn't loaded in this processes</span>
01464 <span class="comment">                 * context.  First lock this hook so it doesn't go away while we're</span>
01465 <span class="comment">                 * loading this library.</span>
01466 <span class="comment">                 */</span>
01467                 bWx86KnownDll = (phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a508">HF_WX86KNOWNDLL</a>) != 0;
01468                 fLoadSuccess = (<a class="code" href="../../d4/d1/userk_8h.html#a1544">xxxLoadHmodIndex</a>(phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o5">ihmod</a>, bWx86KnownDll) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01469 
01470                 <span class="comment">/*</span>
01471 <span class="comment">                 * If the LoadLibrary() failed, skip to the next hook and try</span>
01472 <span class="comment">                 * again.</span>
01473 <span class="comment">                 */</span>
01474                 <span class="keywordflow">if</span> (!fLoadSuccess) {
01475                     <span class="keywordflow">goto</span> LoopAgain;
01476                 }
01477             }
01478 
01479             <span class="comment">/*</span>
01480 <span class="comment">             * Is WH_DEBUG installed?  If we're not already calling it, do so.</span>
01481 <span class="comment">             */</span>
01482             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(ptiCurrent, WHF_DEBUG) &amp;&amp; (phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a> != WH_DEBUG)) {
01483                 DEBUGHOOKINFO debug;
01484 
01485                 debug.idThread = <a class="code" href="../../d4/d1/userk_8h.html#a107">TIDq</a>(ptiCurrent);
01486                 debug.idThreadInstaller = 0;
01487                 debug.code = nCode;
01488                 debug.wParam = wParam;
01489                 debug.lParam = lParam;
01490 
01491                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HC_ACTION, phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a>, (LPARAM)&amp;debug, WH_DEBUG)) {
01492                     <span class="comment">/*</span>
01493 <span class="comment">                     * If WH_DEBUG returned non-zero, skip this hook and</span>
01494 <span class="comment">                     * try the next one.</span>
01495 <span class="comment">                     */</span>
01496                     <span class="keywordflow">goto</span> LoopAgain;
01497                 }
01498             }
01499 
01500             <span class="comment">/*</span>
01501 <span class="comment">             * Make sure the hook is still around before we</span>
01502 <span class="comment">             * try and call it.</span>
01503 <span class="comment">             */</span>
01504             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a438">HMIsMarkDestroy</a>(phkCall)) {
01505                 <span class="keywordflow">goto</span> LoopAgain;
01506             }
01507 
01508             <span class="comment">/*</span>
01509 <span class="comment">             * Time to call the hook! Lock it first so that it doesn't go away</span>
01510 <span class="comment">             * while we're using it. Thread lock right away in case the lock frees</span>
01511 <span class="comment">             * the previous contents.</span>
01512 <span class="comment">             */</span>
01513 
01514 <span class="preprocessor">#if DBG</span>
01515 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a502">HF_GLOBAL</a>) {
01516                 UserAssert(phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o6">ptiHooked</a> == NULL);
01517             } <span class="keywordflow">else</span> {
01518                 UserAssert(phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o6">ptiHooked</a> == ptiCurrent);
01519             }
01520 <span class="preprocessor">#endif</span>
01521 <span class="preprocessor"></span>            phkSave = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o32">sphkCurrent</a>;
01522             <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, phkSave, &amp;tlphkSave);
01523 
01524             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o32">sphkCurrent</a>, phkCall);
01525             <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>)
01526                 ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o7">phkCurrent</a> = phkCall;
01527 
01528             nRet = <a class="code" href="../../d4/d1/userk_8h.html#a1905">xxxHkCallHook</a>(phkCall, nCode, wParam, lParam);
01529 
01530             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o32">sphkCurrent</a>, phkSave);
01531             <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>)
01532                 ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o7">phkCurrent</a> = phkSave;
01533 
01534             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlphkSave);
01535 
01536             <span class="comment">/*</span>
01537 <span class="comment">             * This hook proc faulted, so unhook it and try the next one.</span>
01538 <span class="comment">             */</span>
01539             <span class="keywordflow">if</span> (phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a506">HF_HOOKFAULTED</a>) {
01540                 <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a>   phkFault;
01541 
01542                 phkCall = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a22">PhkNextValid</a>(phkCall);
01543                 phkFault = <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlphkCall);
01544                 <span class="keywordflow">if</span> (phkFault != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01545                     <a class="code" href="../../d4/d1/userk_8h.html#a1520">FreeHook</a>(phkFault);
01546                 }
01547 
01548                 <span class="keywordflow">continue</span>;
01549             }
01550 
01551             <span class="comment">/*</span>
01552 <span class="comment">             * Lastly, we're done with this hook so it is ok to unlock it (it may</span>
01553 <span class="comment">             * get freed here!</span>
01554 <span class="comment">             */</span>
01555             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlphkCall);
01556 
01557             <span class="keywordflow">return</span> nRet;
01558 
01559         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bHookFlags &amp; <a class="code" href="../../d1/d2/hooks_8c.html#a4">HKF_INTERSENDABLE</a>) {
01560 
01561             <span class="comment">/*</span>
01562 <span class="comment">             * Receiving thread can access this structure since the</span>
01563 <span class="comment">             * sender thread's stack is locked down during xxxInterSendMsgEx</span>
01564 <span class="comment">             */</span>
01565             <a class="code" href="../../d6/d6/structtagHOOKMSGSTRUCT.html">HOOKMSGSTRUCT</a> hkmp;
01566             <span class="keywordtype">int</span>           timeout = 200; <span class="comment">// 1/5 second !!!</span>
01567 
01568             hkmp.<a class="code" href="../../d6/d6/structtagHOOKMSGSTRUCT.html#o2">lParam</a> = lParam;
01569             hkmp.<a class="code" href="../../d6/d6/structtagHOOKMSGSTRUCT.html#o0">phk</a> = phkCall;
01570             hkmp.<a class="code" href="../../d6/d6/structtagHOOKMSGSTRUCT.html#o1">nCode</a> = nCode;
01571 
01572             <span class="comment">/*</span>
01573 <span class="comment">             * Thread lock right away in case the lock frees the previous contents</span>
01574 <span class="comment">             */</span>
01575             phkSave = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o32">sphkCurrent</a>;
01576 
01577             <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, phkSave, &amp;tlphkSave);
01578 
01579             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o32">sphkCurrent</a>, phkCall);
01580             <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>)
01581                 ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o7">phkCurrent</a> = phkCall;
01582 
01583             <span class="comment">/*</span>
01584 <span class="comment">             * Make sure we don't get hung!</span>
01585 <span class="comment">             */</span>
01586             <span class="keywordflow">if</span> (bHookFlags &amp; <a class="code" href="../../d1/d2/hooks_8c.html#a5">HKF_LOWLEVEL</a>)
01587                 timeout = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a259">gnllHooksTimeout</a>;
01588 
01589             <span class="comment">/*</span>
01590 <span class="comment">             * CONSIDER(adams): Why should a journaling hook be allowed to</span>
01591 <span class="comment">             * hang the console or a system thread? Will that interfere with</span>
01592 <span class="comment">             * the user's ability to cancel journaling through Ctrl+Esc?</span>
01593 <span class="comment">             */</span>
01594             <span class="keywordflow">if</span> (((bHookFlags &amp; <a class="code" href="../../d1/d2/hooks_8c.html#a5">HKF_LOWLEVEL</a>) == 0) &amp;&amp;
01595                 (   (bHookFlags &amp; <a class="code" href="../../d1/d2/hooks_8c.html#a2">HKF_JOURNAL</a>) ||
01596                     !(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a798">TIF_CSRSSTHREAD</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a797">TIF_SYSTEMTHREAD</a>)))) {
01597 
01598                 nRet = <a class="code" href="../../d4/d1/userk_8h.html#a1150">xxxInterSendMsgEx</a>(NULL, WM_HOOKMSG, wParam,
01599                     (LPARAM)&amp;hkmp, ptiCurrent, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkCall), NULL);
01600             } <span class="keywordflow">else</span> {
01601                 <span class="comment">/*</span>
01602 <span class="comment">                 * We are a server thread (console/desktop) and we aren't</span>
01603 <span class="comment">                 * journalling, so we can't allow the hookproc to hang us -</span>
01604 <span class="comment">                 * we must use a timeout.</span>
01605 <span class="comment">                 */</span>
01606                 <a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html">INTRSENDMSGEX</a> ism;
01607 
01608                 ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o0">fuCall</a>     = <a class="code" href="../../d4/d1/userk_8h.html#a437">ISM_TIMEOUT</a>;
01609                 ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o4">fuSend</a>     = SMTO_ABORTIFHUNG | SMTO_NORMAL;
01610                 ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o5">uTimeout</a>   = timeout;
01611                 ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o6">lpdwResult</a> = &amp;nRet;
01612 
01613                 <span class="comment">/*</span>
01614 <span class="comment">                 * Don't hook DOS apps connected to the emulator - they often</span>
01615 <span class="comment">                 * grab too much CPU for the callback to the hookproc to</span>
01616 <span class="comment">                 * complete in a timely fashion, causing poor response.</span>
01617 <span class="comment">                 */</span>
01618                 <span class="keywordflow">if</span> ((ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a811">TIF_DOSEMULATOR</a>) ||
01619                     <a class="code" href="../../d4/d1/userk_8h.html#a1650">FHungApp</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkCall), CMSHUNGAPPTIMEOUT) ||
01620                     !<a class="code" href="../../d4/d1/userk_8h.html#a1150">xxxInterSendMsgEx</a>(NULL, WM_HOOKMSG, wParam,
01621                             (LPARAM)&amp;hkmp, ptiCurrent, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkCall), &amp;ism)) {
01622                     nRet = <a class="code" href="../../d1/d2/hooks_8c.html#a8">ampiHookError</a>[iHook + 1];
01623                 }
01624 
01625                 <span class="comment">/*</span>
01626 <span class="comment">                 * If the low-level hook is eaten, the app may wake up from</span>
01627 <span class="comment">                 * MsgWaitForMultipleObjects, clear the wake mask, but not get</span>
01628 <span class="comment">                 * anything in GetMessage / PeekMessage and we will think it's</span>
01629 <span class="comment">                 * hung. This causes problems in DirectInput because then the</span>
01630 <span class="comment">                 * app may miss some hooks if FHungApp returns true, see bug</span>
01631 <span class="comment">                 * 430342 for more details on this.</span>
01632 <span class="comment">                 */</span>
01633                 <span class="keywordflow">if</span> ((bHookFlags &amp; <a class="code" href="../../d1/d2/hooks_8c.html#a5">HKF_LOWLEVEL</a>) &amp;&amp; nRet) {
01634                     <a class="code" href="../../d4/d1/userk_8h.html#a257">SET_TIME_LAST_READ</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkCall));
01635                 }
01636             }
01637 
01638             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o32">sphkCurrent</a>, phkSave);
01639             <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>)
01640                 ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o7">phkCurrent</a> = phkSave;
01641 
01642             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlphkSave);
01643             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlphkCall);
01644             <span class="keywordflow">return</span> nRet;
01645         }
01646         <span class="comment">// fall-through</span>
01647 
01648 LoopAgain:
01649         phkCall = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a22">PhkNextValid</a>(phkCall);
01650         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlphkCall);
01651     } <span class="keywordflow">while</span> (phkCall != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01652 
01653     <span class="keywordflow">return</span> <a class="code" href="../../d1/d2/hooks_8c.html#a8">ampiHookError</a>[iHook + 1];
01654 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="hooks.c::xxxCallJournalPlaybackHook" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> xxxCallJournalPlaybackHook           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d8/d4/structtagQMSG.html">PQMSG</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pqmsg</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/hooks_8c-source.html#l01797">1797</a> of file <a class="el" href="../../d2/d1/hooks_8c-source.html">hooks.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">BYTE</a>, <a class="el" href="../../d8/d3/conexts_8c-source.html#l00650">dt()</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d2/d7/clglobal_8c-source.html#l00051">gpsi</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l00126">IS_CHAR_MSG</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00590">IS_DBCS_ENABLED</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06472">IsWinEventNotifyDeferredOK</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00183">LOBYTE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02979">tagQMSG::msg</a>, <a class="el" href="../../d0/d5/gettickc_8c-source.html#l00026">NtGetTickCount()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01990">tagHOOK::offPfn</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l02151">PhkFirstGlobalValid()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03321">tagTHREADINFO::pq</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00194">RevalidateHwnd</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03111">tagQ::spwndActive</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l04831">StoreQMessage()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02955">TestKeyStateDown</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00364">ThreadLockWithPti</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00366">ThreadUnlock</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02848">TIF_IGNOREPLAYBACKDELAY</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03385">tagTHREADINFO::wchInjected</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l01246">xxxCallHook()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l01288">xxxCallHook2()</a>, and <a class="el" href="../../d8/d0/ntuser_2kernel_2cursor_8c-source.html#l00114">zzzInternalSetCursorPos()</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l02802">xxxGetNextSysMsg()</a>.
<p>
<pre class="fragment"><div>01799 {
01800     EVENTMSG emsg;
01801     LONG <a class="code" href="../../d7/d4/conexts_8c.html#a26">dt</a>;
01802     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
01803     WPARAM wParam;
01804     LPARAM lParam;
01805     POINT pt;
01806     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
01807     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bAnsiHook;
01808     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phkCall;
01809     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlphkCall;
01810 
01811     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
01812 
01813 TryNextEvent:
01814 
01815     <span class="comment">/*</span>
01816 <span class="comment">     * Initialized to the current time for compatibility with</span>
01817 <span class="comment">     * &lt;= 3.0.</span>
01818 <span class="comment">     */</span>
01819     emsg.time = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>();
01820     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01821     pwnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01822 
01823     phkCall = <a class="code" href="../../d4/d1/userk_8h.html#a1519">PhkFirstGlobalValid</a>(ptiCurrent, WH_JOURNALPLAYBACK);
01824     <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, phkCall, &amp;tlphkCall);
01825 
01826     <a class="code" href="../../d7/d4/conexts_8c.html#a26">dt</a> = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d4/d1/userk_8h.html#a1522">xxxCallHook2</a>(phkCall, HC_GETNEXT, 0, (LPARAM)&amp;emsg, &amp;bAnsiHook);
01827 
01828     <span class="comment">/*</span>
01829 <span class="comment">     * -1 means some error occured. Return -1 for error.</span>
01830 <span class="comment">     */</span>
01831     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/conexts_8c.html#a26">dt</a> == 0xFFFFFFFF) {
01832         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlphkCall);
01833         <span class="keywordflow">return</span> <a class="code" href="../../d7/d4/conexts_8c.html#a26">dt</a>;
01834     }
01835 
01836     <span class="comment">/*</span>
01837 <span class="comment">     * Update the message id. Need this if we decide to sleep.</span>
01838 <span class="comment">     */</span>
01839     pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message = emsg.message;
01840 
01841     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/conexts_8c.html#a26">dt</a> &gt; 0) {
01842         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a814">TIF_IGNOREPLAYBACKDELAY</a>) {
01843             <span class="comment">/*</span>
01844 <span class="comment">             * This flag tells us to ignore the requested delay (set in mnloop)</span>
01845 <span class="comment">             * We clear it to indicate that we did so.</span>
01846 <span class="comment">             */</span>
01847             RIPMSG1(RIP_WARNING, <span class="stringliteral">"Journal Playback delay ignored (%lx)"</span>, emsg.message);
01848             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a814">TIF_IGNOREPLAYBACKDELAY</a>;
01849             <a class="code" href="../../d7/d4/conexts_8c.html#a26">dt</a> = 0;
01850         } <span class="keywordflow">else</span> {
01851             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlphkCall);
01852             <span class="keywordflow">return</span> <a class="code" href="../../d7/d4/conexts_8c.html#a26">dt</a>;
01853         }
01854     }
01855 
01856     <span class="comment">/*</span>
01857 <span class="comment">     * The app is ready to be asked for the next event</span>
01858 <span class="comment">     */</span>
01859 
01860     <span class="keywordflow">if</span> ((emsg.message &gt;= WM_MOUSEFIRST) &amp;&amp; (emsg.message &lt;= WM_MOUSELAST)) {
01861 
01862         pt.x = (<span class="keywordtype">int</span>)emsg.paramL;
01863         pt.y = (<span class="keywordtype">int</span>)emsg.paramH;
01864 
01865         lParam = MAKELONG(LOWORD(pt.x), LOWORD(pt.y));
01866         wParam = 0;
01867 
01868         <span class="comment">/*</span>
01869 <span class="comment">         * If the message has changed the mouse position,</span>
01870 <span class="comment">         * update the cursor.</span>
01871 <span class="comment">         */</span>
01872         <span class="keywordflow">if</span> (pt.x != <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor.x || pt.y != <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor.y) {
01873             <a class="code" href="../../d4/d1/userk_8h.html#a1179">zzzInternalSetCursorPos</a>(pt.x, pt.y);
01874         }
01875 
01876     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((emsg.message &gt;= WM_KEYFIRST) &amp;&amp; (emsg.message &lt;= WM_KEYLAST)) {
01877         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> wExtraStuff = 0;
01878 
01879         <span class="keywordflow">if</span> ((emsg.message == WM_KEYUP) || (emsg.message == WM_SYSKEYUP)) {
01880             wExtraStuff |= 0x8000;
01881         }
01882 
01883         <span class="keywordflow">if</span> ((emsg.message == WM_SYSKEYUP) || (emsg.message == WM_SYSKEYDOWN)) {
01884             wExtraStuff |= 0x2000;
01885         }
01886 
01887         <span class="keywordflow">if</span> (emsg.paramH &amp; 0x8000) {
01888             wExtraStuff |= 0x0100;
01889         }
01890 
01891         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, (BYTE)emsg.paramL)) {
01892             wExtraStuff |= 0x4000;
01893         }
01894         lParam = MAKELONG(1, (UINT)((emsg.paramH &amp; 0xFF) | wExtraStuff));
01895 
01896         <span class="keywordflow">if</span> ((LOWORD(emsg.paramL) == VK_PACKET) &amp;&amp; (<a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(emsg.paramH) == 0)) {
01897             <span class="comment">/*</span>
01898 <span class="comment">             * We are playing back an injected Unicode char (see SendInput)</span>
01899 <span class="comment">             * save the character for TranslateMessage to pick up.</span>
01900 <span class="comment">             */</span>
01901             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o45">wchInjected</a> = HIWORD(emsg.paramL);
01902         } <span class="keywordflow">else</span> {
01903             <span class="comment">/*</span>
01904 <span class="comment">             * Raid# 65331</span>
01905 <span class="comment">             * WM_KEY* and WM_SYSKEY* messages should only contain 8bit Virtual Keys.</span>
01906 <span class="comment">             * Some applications passes scan code in HIBYTE and could screw up</span>
01907 <span class="comment">             * the system. E.g. Tab Keydown, paramL: 0x0f09 where 0f is scan code</span>
01908 <span class="comment">             */</span>
01909             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwMask = 0xff;
01910 
01911             <span class="comment">/*</span>
01912 <span class="comment">             * There are old ANSI apps that only fill in the byte for when</span>
01913 <span class="comment">             * they generate journal playback so we used to strip everything</span>
01914 <span class="comment">             * else off.  That however breaks unicode journalling; 22645</span>
01915 <span class="comment">             * (Yes, some apps apparently do Playback WM_*CHAR msgs!)</span>
01916 <span class="comment">             *</span>
01917 <span class="comment">             */</span>
01918             <span class="keywordflow">if</span> (!bAnsiHook || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a125">IS_DBCS_ENABLED</a>()) {
01919                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/hooks_8c.html#a6">IS_CHAR_MSG</a>(emsg.message)) {
01920                     RIPMSG1(RIP_VERBOSE, <span class="stringliteral">"Unusual char message(%x) passed through JournalPlayback."</span>, emsg.message);
01921                     <span class="comment">/*</span>
01922 <span class="comment">                     * Don't mask off HIBYTE(LOWORD(paramL)) for DBCS and UNICODE.</span>
01923 <span class="comment">                     */</span>
01924                     dwMask = 0xffff;
01925                 }
01926             }
01927 
01928             wParam = emsg.paramL &amp; dwMask;
01929         }
01930 
01931     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (emsg.message == WM_QUEUESYNC) {
01932         <span class="keywordflow">if</span> (emsg.paramL == 0) {
01933             pwnd = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>;
01934         } <span class="keywordflow">else</span> {
01935             <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>((HWND)IntToPtr( emsg.paramL ))) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01936                 pwnd = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>;
01937         }
01938 
01939     } <span class="keywordflow">else</span> {
01940         <span class="comment">/*</span>
01941 <span class="comment">         * This event doesn't match up with what we're looking</span>
01942 <span class="comment">         * for. If the hook is still valid, then skip this message</span>
01943 <span class="comment">         * and try the next.</span>
01944 <span class="comment">         */</span>
01945         <span class="keywordflow">if</span> (phkCall == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o3">offPfn</a> == 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) {
01946             <span class="comment">/* Hook is nolonger valid, return -1 */</span>
01947             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlphkCall);
01948             <span class="keywordflow">return</span> 0xFFFFFFFF;
01949         }
01950 
01951         RIPMSG1(RIP_WARNING,
01952                 <span class="stringliteral">"Bad journal playback message=0x%08lx"</span>,
01953                 emsg.message);
01954 
01955         <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HC_SKIP, 0, 0, WH_JOURNALPLAYBACK);
01956         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlphkCall);
01957         <span class="keywordflow">goto</span> TryNextEvent;
01958     }
01959 
01960     <a class="code" href="../../d4/d1/userk_8h.html#a1503">StoreQMessage</a>(pqmsg, pwnd, emsg.message, wParam, lParam, 0, 0, 0);
01961 
01962     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlphkCall);
01963     <span class="keywordflow">return</span> 0;
01964 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="hooks.c::xxxCallJournalRecordHook" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void xxxCallJournalRecordHook           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d8/d4/structtagQMSG.html">PQMSG</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pqmsg</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/hooks_8c-source.html#l01695">1695</a> of file <a class="el" href="../../d2/d1/hooks_8c-source.html">hooks.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">BYTE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02981">tagQMSG::dwQEvent</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00184">HIBYTE</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00183">LOBYTE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02979">tagQMSG::msg</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">PBYTE</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l02151">PhkFirstGlobalValid()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00194">RevalidateHwnd</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>, and <a class="el" href="../../d2/d1/hooks_8c-source.html#l01288">xxxCallHook2()</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l02982">xxxSkipSysMsg()</a>.
<p>
<pre class="fragment"><div>01697 {
01698     EVENTMSG emsg;
01699     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bAnsiHook;
01700 
01701     <span class="comment">/*</span>
01702 <span class="comment">     * Setup the EVENTMSG structure.</span>
01703 <span class="comment">     */</span>
01704     emsg.message = pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message;
01705     emsg.time = pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.time;
01706 
01707     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.hwnd)) {
01708         emsg.hwnd = pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.hwnd;
01709     } <span class="keywordflow">else</span> {
01710         emsg.hwnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01711     }
01712 
01713     <span class="keywordflow">if</span> ((emsg.message &gt;= WM_MOUSEFIRST) &amp;&amp; (emsg.message &lt;= WM_MOUSELAST)) {
01714         emsg.paramL = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.pt.x;
01715         emsg.paramH = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.pt.y;
01716 
01717     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((emsg.message &gt;= WM_KEYFIRST) &amp;&amp; (emsg.message &lt;= WM_KEYLAST)) {
01718         <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> bScanCode = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(HIWORD(pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam));
01719         <span class="comment">/*</span>
01720 <span class="comment">         * Build up a Win 3.1 compatible journal record key</span>
01721 <span class="comment">         * Win 3.1  ParamL 00 00 SC VK  (SC=scan code VK=virtual key)</span>
01722 <span class="comment">         * Also set ParamH 00 00 00 SC  to be compatible with our Playback</span>
01723 <span class="comment">         *</span>
01724 <span class="comment">         * If WM_*CHAR messages ever come this way we would have a problem</span>
01725 <span class="comment">         * because we would lose the top byte of the Unicode character. We'd</span>
01726 <span class="comment">         * We'd get ParamL 00 00 SC CH  (SC=scan code, CH = low byte of WCHAR)</span>
01727 <span class="comment">         *</span>
01728 <span class="comment">         */</span>
01729         <span class="keywordflow">if</span> ((LOWORD(pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam) == VK_PACKET) &amp;&amp; (bScanCode == 0)) {
01730             <span class="comment">/*</span>
01731 <span class="comment">             * If we have an injected Unicode char (from SendInput), the</span>
01732 <span class="comment">             * character value was cached, let's give that to them too.</span>
01733 <span class="comment">             */</span>
01734             emsg.paramL = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)MAKELONG(pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam, <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;wchInjected);
01735         } <span class="keywordflow">else</span> {
01736             emsg.paramL = MAKELONG(MAKEWORD(pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam, bScanCode),0);
01737         }
01738         emsg.paramH = bScanCode;
01739 
01740         UserAssert((emsg.message != WM_CHAR) &amp;&amp;
01741                    (emsg.message != WM_DEADCHAR) &amp;&amp;
01742                    (emsg.message != WM_SYSCHAR) &amp;&amp;
01743                    (emsg.message != WM_SYSDEADCHAR));
01744         <span class="comment">/*</span>
01745 <span class="comment">         * Set extended-key bit.</span>
01746 <span class="comment">         */</span>
01747         <span class="keywordflow">if</span> (pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam &amp; 0x01000000) {
01748             emsg.paramH |= 0x8000;
01749         }
01750 
01751     } <span class="keywordflow">else</span> {
01752         RIPMSG2(RIP_WARNING,
01753                 <span class="stringliteral">"Bad journal record message!\n"</span>
01754                 <span class="stringliteral">"   message  = 0x%08lx\n"</span>
01755                 <span class="stringliteral">"   dwQEvent = 0x%08lx"</span>,
01756                 pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message,
01757                 pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o4">dwQEvent</a>);
01758     }
01759 
01760     <span class="comment">/*</span>
01761 <span class="comment">     * Call the journal recording hook.</span>
01762 <span class="comment">     */</span>
01763     <a class="code" href="../../d4/d1/userk_8h.html#a1522">xxxCallHook2</a>(<a class="code" href="../../d4/d1/userk_8h.html#a1519">PhkFirstGlobalValid</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), WH_JOURNALRECORD), HC_ACTION, 0,
01764             (LPARAM)&amp;emsg, &amp;bAnsiHook);
01765 
01766     <span class="comment">/*</span>
01767 <span class="comment">     * Write the MSG parameters back because the app may have modified it.</span>
01768 <span class="comment">     * AfterDark's screen saver password actually zero's out the keydown</span>
01769 <span class="comment">     * chars.</span>
01770 <span class="comment">     *</span>
01771 <span class="comment">     * If it was a mouse message patch up the mouse point.  If it was a</span>
01772 <span class="comment">     * WM_KEYxxx message convert the Win 3.1 compatible journal record key</span>
01773 <span class="comment">     * back into a half backed WM_KEYxxx format.  Only the VK and SC fields</span>
01774 <span class="comment">     * where initialized at this point.</span>
01775 <span class="comment">     *</span>
01776 <span class="comment">     *      wParam  00 00 00 VK   lParam 00 SC 00 00</span>
01777 <span class="comment">     */</span>
01778     <span class="keywordflow">if</span> ((pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message &gt;= WM_MOUSEFIRST) &amp;&amp; (pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message &lt;= WM_MOUSELAST)) {
01779         pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.pt.x = emsg.paramL;
01780         pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.pt.y = emsg.paramH;
01781 
01782     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message &gt;= WM_KEYFIRST) &amp;&amp; (pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message &lt;= WM_KEYLAST)) {
01783         (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)emsg.paramL;
01784         ((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam)[2] = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a5">HIBYTE</a>(LOWORD(emsg.paramL));
01785     }
01786 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="hooks.c::xxxCallMouseHook" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL xxxCallMouseHook           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>message</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PMOUSEHOOKSTRUCTEX&nbsp;</td>
          <td class="mdname" nowrap> <em>pmhs</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>fRemove</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/hooks_8c-source.html#l01666">1666</a> of file <a class="el" href="../../d2/d1/hooks_8c-source.html">hooks.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l02183">PhkFirstValid()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d1/hooks_8c-source.html#l01288">xxxCallHook2()</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l03305">xxxScanSysQueue()</a>.
<p>
<pre class="fragment"><div>01670 {
01671     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bAnsiHook;
01672 
01673     <span class="comment">/*</span>
01674 <span class="comment">     * Call the mouse hook.</span>
01675 <span class="comment">     */</span>
01676     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1522">xxxCallHook2</a>(<a class="code" href="../../d4/d1/userk_8h.html#a1518">PhkFirstValid</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), WH_MOUSE), fRemove ?
01677             HC_ACTION : HC_NOREMOVE, (DWORD)message, (LPARAM)pmhs, &amp;bAnsiHook)) {
01678         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01679     }
01680 
01681     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01682 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="hooks.c::xxxCallNextHookEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LRESULT xxxCallNextHookEx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">int&nbsp;</td>
          <td class="mdname" nowrap> <em>nCode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>wParam</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>lParam</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/hooks_8c-source.html#l00961">961</a> of file <a class="el" href="../../d2/d1/hooks_8c-source.html">hooks.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d8/rtl_2wow_8c-source.html#l01031">PhkNextValid()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, and <a class="el" href="../../d2/d1/hooks_8c-source.html#l01288">xxxCallHook2()</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/srvhook_8c-source.html#l00490">fnHkINLPCWPEXSTRUCT()</a>, <a class="el" href="../../d0/d4/srvhook_8c-source.html#l00512">fnHkINLPCWPRETEXSTRUCT()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l12441">NtUserCallNextHookEx()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l12414">NtUserfnHkINLPCBTACTIVATESTRUCT()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l12075">NtUserfnHkINLPCBTCREATESTRUCT()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l12235">NtUserfnHkINLPDEBUGHOOKSTRUCT()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l12331">NtUserfnHkINLPKBDLLHOOKSTRUCT()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l12304">NtUserfnHkINLPMOUSEHOOKSTRUCTEX()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l12195">NtUserfnHkINLPMSG()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l12358">NtUserfnHkINLPMSLLHOOKSTRUCT()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l12138">NtUserfnHkINLPRECT()</a>, and <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l12266">NtUserfnHkOPTINLPEVENTMSG()</a>.
<p>
<pre class="fragment"><div>00965 {
00966     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bAnsiHook;
00967 
00968     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;sphkCurrent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00969         <span class="keywordflow">return</span> 0;
00970     }
00971 
00972     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1522">xxxCallHook2</a>(<a class="code" href="../../d6/d9/rtl_2wow_8c.html#a22">PhkNextValid</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;sphkCurrent), nCode, wParam, lParam, &amp;bAnsiHook);
00973 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="hooks.c::zzzCancelJournalling" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void zzzCancelJournalling           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/hooks_8c-source.html#l00404">404</a> of file <a class="el" href="../../d2/d1/hooks_8c-source.html">hooks.c</a>.
<p>
References <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l01123">_PostThreadMessage()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02557">ClrWF</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03508">CMSWAITTOKILLTIMEOUT</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06469">DeferWinEventNotify</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00201">gppiLockSFW</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00455">gptiRit</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00456">grpdeskRitInput</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00221">gwMouseOwnerButton</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02075">tagHOOK::head</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l00339">InterQueueMsgCleanup()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03328">tagTHREADINFO::pDeskInfo</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02644">tagDESKTOP::pDeskInfo</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l02151">PhkFirstGlobalValid()</a>, <a class="el" href="../../d7/d8/rtl_2wow_8c-source.html#l01031">PhkNextValid()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l02364">SendMsgCleanup()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02156">tagDESKTOPINFO::spwnd</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02555">TestWF</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02418">WFDISABLED</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06473">zzzEndDeferWinEventNotify</a>, and <a class="el" href="../../d2/d1/hooks_8c-source.html#l01126">zzzUnhookWindowsHookEx()</a>.
<p>
Referenced by <a class="el" href="../../d4/d1/hotkeys_8c-source.html#l00434">xxxDoHotKeyStuff()</a>, and <a class="el" href="../../d0/d6/desktop_8c-source.html#l03358">xxxSwitchDesktop()</a>.
<p>
<pre class="fragment"><div>00405 {
00406     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCancelJournal;
00407     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phook;
00408     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phookNext;
00409 
00410     <span class="comment">/*</span>
00411 <span class="comment">     * Mouse buttons sometimes get stuck down due to hardware glitches,</span>
00412 <span class="comment">     * usually due to input concentrator switchboxes or faulty serial</span>
00413 <span class="comment">     * mouse COM ports, so clear the global button state here just in case,</span>
00414 <span class="comment">     * otherwise we may not be able to change focus with the mouse.</span>
00415 <span class="comment">     * Also do this in Alt-Tab processing.</span>
00416 <span class="comment">     */</span>
00417 <span class="preprocessor">#if DBG</span>
00418 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a92">gwMouseOwnerButton</a>)
00419         RIPMSG1(RIP_WARNING,
00420                 <span class="stringliteral">"gwMouseOwnerButton=%x, being cleared forcibly\n"</span>,
00421                 gwMouseOwnerButton);
00422 <span class="preprocessor">#endif</span>
00423 <span class="preprocessor"></span>    <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a92">gwMouseOwnerButton</a> = 0;
00424 
00425     <span class="comment">/*</span>
00426 <span class="comment">     * Remove journal hooks. This'll cause threads to associate with</span>
00427 <span class="comment">     * different queues.</span>
00428 <span class="comment">     * DeferWinEventNotify() so we can traverse the phook list safely</span>
00429 <span class="comment">     */</span>
00430     <a class="code" href="../../d4/d1/userk_8h.html#a614">DeferWinEventNotify</a>();
00431     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o7">pDeskInfo</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>);
00432     phook = <a class="code" href="../../d4/d1/userk_8h.html#a1519">PhkFirstGlobalValid</a>(gptiRit, WH_JOURNALPLAYBACK);
00433     <span class="keywordflow">while</span> (phook != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00434         ptiCancelJournal = phook-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o0">head</a>.pti;
00435 
00436         <span class="keywordflow">if</span> (ptiCancelJournal != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00437             <span class="comment">/*</span>
00438 <span class="comment">             * Let the thread that set the journal hook know this is happening.</span>
00439 <span class="comment">             */</span>
00440             <a class="code" href="../../d4/d1/userk_8h.html#a1645">_PostThreadMessage</a>(ptiCancelJournal, WM_CANCELJOURNAL, 0, 0);
00441 
00442             <span class="comment">/*</span>
00443 <span class="comment">             * If there was an app waiting for a response back from the journal</span>
00444 <span class="comment">             * application, cancel that request so the app can continue running</span>
00445 <span class="comment">             * (for example, we don't want winlogon or console to wait for an</span>
00446 <span class="comment">             * app that may be hung!)</span>
00447 <span class="comment">             */</span>
00448             <a class="code" href="../../d4/d1/userk_8h.html#a1148">SendMsgCleanup</a>(ptiCancelJournal);
00449         }
00450 
00451         phookNext = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a22">PhkNextValid</a>(phook);
00452         <a class="code" href="../../d4/d1/userk_8h.html#a1815">zzzUnhookWindowsHookEx</a>(phook);        <span class="comment">// May free phook memory</span>
00453         phook = phookNext;
00454     }
00455     <a class="code" href="../../d4/d1/userk_8h.html#a617">zzzEndDeferWinEventNotify</a>();
00456 
00457     <span class="comment">/*</span>
00458 <span class="comment">     * DeferWinEventNotify() so we can traverse the phook list safely</span>
00459 <span class="comment">     */</span>
00460     <a class="code" href="../../d4/d1/userk_8h.html#a614">DeferWinEventNotify</a>();
00461     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o7">pDeskInfo</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>);
00462     phook = <a class="code" href="../../d4/d1/userk_8h.html#a1519">PhkFirstGlobalValid</a>(gptiRit, WH_JOURNALRECORD);
00463     <span class="keywordflow">while</span> (phook != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00464         ptiCancelJournal = phook-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o0">head</a>.pti;
00465 
00466         <span class="keywordflow">if</span> (ptiCancelJournal != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00467             <span class="comment">/*</span>
00468 <span class="comment">             * Let the thread that set the journal hook know this is happening.</span>
00469 <span class="comment">             */</span>
00470             <a class="code" href="../../d4/d1/userk_8h.html#a1645">_PostThreadMessage</a>(ptiCancelJournal, WM_CANCELJOURNAL, 0, 0);
00471 
00472             <span class="comment">/*</span>
00473 <span class="comment">             * If there was an app waiting for a response back from the journal</span>
00474 <span class="comment">             * application, cancel that request so the app can continue running</span>
00475 <span class="comment">             * (for example, we don't want winlogon or console to wait for an</span>
00476 <span class="comment">             * app that may be hung!)</span>
00477 <span class="comment">             */</span>
00478             <a class="code" href="../../d4/d1/userk_8h.html#a1148">SendMsgCleanup</a>(ptiCancelJournal);
00479         }
00480 
00481         phookNext = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a22">PhkNextValid</a>(phook);
00482         <a class="code" href="../../d4/d1/userk_8h.html#a1815">zzzUnhookWindowsHookEx</a>(phook);        <span class="comment">// May free phook memory</span>
00483         phook = phookNext;
00484     }
00485     <a class="code" href="../../d4/d1/userk_8h.html#a617">zzzEndDeferWinEventNotify</a>();
00486 
00487 
00488     <span class="comment">/*</span>
00489 <span class="comment">     * Make sure journalling ssync mode didn't hose any one</span>
00490 <span class="comment">     */</span>
00491     <a class="code" href="../../d1/d2/hooks_8c.html#a12">InterQueueMsgCleanup</a>(CMSWAITTOKILLTIMEOUT);
00492 
00493     <span class="comment">/*</span>
00494 <span class="comment">     * Unlock SetForegroundWindow (if locked)</span>
00495 <span class="comment">     */</span>
00496     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a81">gppiLockSFW</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00497 
00498     <span class="comment">/*</span>
00499 <span class="comment">     * NT5's last minute hack for evil applications, who disables the desktop window</span>
00500 <span class="comment">     * (perhaps by accidents though) leaving the system pretty unusable.</span>
00501 <span class="comment">     * See Raid #423704.</span>
00502 <span class="comment">     */</span>
00503     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>) {
00504         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndDesktop = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>;
00505 
00506         <span class="keywordflow">if</span> (pwndDesktop &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndDesktop, WFDISABLED)) {
00507             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwndDesktop, WFDISABLED);
00508         }
00509     }
00510 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="hooks.c::zzzJournalAttach" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL zzzJournalAttach           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pti</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>fAttach</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/hooks_8c-source.html#l00285">285</a> of file <a class="el" href="../../d2/d1/hooks_8c-source.html">hooks.c</a>.
<p>
References <a class="el" href="../../d7/d2/queue_8c-source.html#l02102">AllocQueue()</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03131">tagQ::cThreads</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03361">tagTHREADINFO::pqAttach</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02668">tagDESKTOP::PtiList</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03327">tagTHREADINFO::rpdesk</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02833">TIF_DONTJOURNALATTACH</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02826">TIF_INCLEANUP</a>, and <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l06158">zzzReattachThreads()</a>.
<p>
Referenced by <a class="el" href="../../d2/d1/hooks_8c-source.html#l02318">zzzRegisterSystemThread()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l00576">zzzSetWindowsHookEx()</a>, and <a class="el" href="../../d2/d1/hooks_8c-source.html#l01126">zzzUnhookWindowsHookEx()</a>.
<p>
<pre class="fragment"><div>00288 {
00289     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiT;
00290     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pq;
00291     PLIST_ENTRY pHead, pEntry;
00292 
00293     <span class="comment">/*</span>
00294 <span class="comment">     * If we're attaching, calculate the pqAttach for all threads journalling.</span>
00295 <span class="comment">     * If we're unattaching, just call zzzReattachThreads() and it will calculate</span>
00296 <span class="comment">     * the non-journalling queues to attach to.</span>
00297 <span class="comment">     */</span>
00298     <span class="keywordflow">if</span> (fAttach) {
00299         <span class="keywordflow">if</span> ((pq = <a class="code" href="../../d4/d1/userk_8h.html#a1204">AllocQueue</a>(pti, NULL)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00300             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00301 
00302         pHead = &amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o20">PtiList</a>;
00303         <span class="keywordflow">for</span> (pEntry = pHead-&gt;Flink; pEntry != pHead; pEntry = pEntry-&gt;Flink) {
00304             ptiT = CONTAINING_RECORD(pEntry, <a class="code" href="../../d2/d8/structtagTHREADINFO.html">THREADINFO</a>, PtiLink);
00305 
00306             <span class="comment">/*</span>
00307 <span class="comment">             * This is the Q to attach to for all threads that will do</span>
00308 <span class="comment">             * journalling.</span>
00309 <span class="comment">             */</span>
00310             <span class="keywordflow">if</span> (!(ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a802">TIF_DONTJOURNALATTACH</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>))) {
00311                 ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o28">pqAttach</a> = pq;
00312                 ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o28">pqAttach</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a>++;
00313             }
00314         }
00315     }
00316 
00317     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1203">zzzReattachThreads</a>(fAttach);
00318 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="hooks.c::zzzRegisterSystemThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID zzzRegisterSystemThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>dwFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>dwReserved</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/hooks_8c-source.html#l02318">2318</a> of file <a class="el" href="../../d2/d1/hooks_8c-source.html">hooks.c</a>.
<p>
References <a class="el" href="../../d4/d7/propapi_8h-source.html#l00043">dwFlags</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03663">FJOURNALPLAYBACK</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03662">FJOURNALRECORD</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02832">TIF_DONTATTACHQUEUE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02833">TIF_DONTJOURNALATTACH</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, and <a class="el" href="../../d2/d1/hooks_8c-source.html#l00285">zzzJournalAttach()</a>.
<p>
<pre class="fragment"><div>02319 {
02320     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
02321 
02322     UserAssert(dwReserved == 0);
02323 
02324     <span class="keywordflow">if</span> (dwReserved != 0)
02325         <span class="keywordflow">return</span>;
02326 
02327     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
02328 
02329     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; RST_DONTATTACHQUEUE)
02330         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a801">TIF_DONTATTACHQUEUE</a>;
02331 
02332     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; RST_DONTJOURNALATTACH) {
02333         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a802">TIF_DONTJOURNALATTACH</a>;
02334 
02335         <span class="comment">/*</span>
02336 <span class="comment">         * If we are already journaling, then this queue was already</span>
02337 <span class="comment">         * journal attached.  We need to unattach and reattach journaling</span>
02338 <span class="comment">         * so that we are removed from the journal attached queues.</span>
02339 <span class="comment">         */</span>
02340         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a419">FJOURNALPLAYBACK</a>() || <a class="code" href="../../d4/d1/userk_8h.html#a418">FJOURNALRECORD</a>()) {
02341             <a class="code" href="../../d1/d2/hooks_8c.html#a11">zzzJournalAttach</a>(ptiCurrent, FALSE);
02342             <a class="code" href="../../d1/d2/hooks_8c.html#a11">zzzJournalAttach</a>(ptiCurrent, TRUE);
02343         }
02344     }
02345 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="hooks.c::zzzSetWindowsHookAW" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PROC zzzSetWindowsHookAW           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">int&nbsp;</td>
          <td class="mdname" nowrap> <em>nFilterType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PROC&nbsp;</td>
          <td class="mdname" nowrap> <em>pfnFilterProc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>dwFlags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/hooks_8c-source.html#l00528">528</a> of file <a class="el" href="../../d2/d1/hooks_8c-source.html">hooks.c</a>.
<p>
References <a class="el" href="../../d2/d1/hooks_8c-source.html#l00049">abHookFlags</a>, <a class="el" href="../../d4/d7/propapi_8h-source.html#l00043">dwFlags</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l00023">HKF_NZRET</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01988">tagHOOK::phkNext</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, and <a class="el" href="../../d2/d1/hooks_8c-source.html#l00576">zzzSetWindowsHookEx()</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l06203">NtUserSetWindowsHookAW()</a>.
<p>
<pre class="fragment"><div>00532 {
00533     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phk;
00534 
00535     phk = <a class="code" href="../../d4/d1/userk_8h.html#a1906">zzzSetWindowsHookEx</a>(NULL, NULL, <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(),
00536             nFilterType, pfnFilterProc, dwFlags);
00537 
00538     <span class="comment">/*</span>
00539 <span class="comment">     * If we get an error from zzzSetWindowsHookEx() then we return</span>
00540 <span class="comment">     * -1 to be compatible with older version of Windows.</span>
00541 <span class="comment">     */</span>
00542     <span class="keywordflow">if</span> (phk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00543         <span class="keywordflow">return</span> (PROC)-1;
00544     }
00545 
00546     <span class="comment">/*</span>
00547 <span class="comment">     * Handle the backwards compatibility return value cases for</span>
00548 <span class="comment">     * SetWindowsHook.  If this was the first hook in the chain,</span>
00549 <span class="comment">     * then return NULL, else return something non-zero.  HKF_NZRET</span>
00550 <span class="comment">     * is a special case where SetWindowsHook would always return</span>
00551 <span class="comment">     * something because there was a default hook installed.  Some</span>
00552 <span class="comment">     * apps relied on a non-zero return value in those cases.</span>
00553 <span class="comment">     */</span>
00554     <span class="keywordflow">if</span> ((phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o1">phkNext</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (<a class="code" href="../../d1/d2/hooks_8c.html#a9">abHookFlags</a>[nFilterType + 1] &amp; <a class="code" href="../../d1/d2/hooks_8c.html#a3">HKF_NZRET</a>)) {
00555         <span class="keywordflow">return</span> (PROC)phk;
00556     }
00557 
00558     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00559 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="hooks.c::zzzSetWindowsHookEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d5/d6/structtagHOOK.html">PHOOK</a> zzzSetWindowsHookEx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>hmod</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>pstrLib</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ptiThread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>nFilterType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PROC&nbsp;</td>
          <td class="mdname" nowrap> <em>pfnFilterProc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>dwFlags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/hooks_8c-source.html#l00576">576</a> of file <a class="el" href="../../d2/d1/hooks_8c-source.html">hooks.c</a>.
<p>
References <a class="el" href="../../d2/d1/hooks_8c-source.html#l00049">abHookFlags</a>, <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00136">AddHmodDependency()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03389">tagTHREADINFO::amdesk</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03393">tagTHREADINFO::aphkStart</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02158">tagDESKTOPINFO::aphkStart</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06024">DbgValidateHooks</a>, <a class="el" href="../../d4/d7/propapi_8h-source.html#l00043">dwFlags</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02718">tagWINDOWSTATION::dwWSF_Flags</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02079">tagHOOK::flags</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03368">tagTHREADINFO::fsHooks</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l00533">_CLIENTINFO::fsHooks</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02257">tagDESKTOPINFO::fsHooks</a>, <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00053">GetHmodTableIndex()</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00200">gppiInputProvider</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02008">HF_ANSI</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02007">HF_GLOBAL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02013">HF_WX86KNOWNDLL</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l00024">HKF_INTERSENDABLE</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l00022">HKF_JOURNAL</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l00021">HKF_TASK</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00828">HMAllocObject()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01069">HMFreeObject()</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02080">tagHOOK::ihmod</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02077">tagHOOK::iHook</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01838">KeSetPriorityThread()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03504">tagPROCESSINFO::luidSession</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01990">tagHOOK::offPfn</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03329">tagTHREADINFO::pClientInfo</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03328">tagTHREADINFO::pDeskInfo</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01988">tagHOOK::phkNext</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03319">tagTHREADINFO::ppi</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02081">tagHOOK::ptiHooked</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03327">tagTHREADINFO::rpdesk</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02648">tagDESKTOP::rpwinstaParent</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03309">RtlAreAllAccessesGranted()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01824">RtlEqualLuid()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00638">THREAD_TO_PROCESS</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00365">ThreadLockAlwaysWithPti</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00366">ThreadUnlock</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02849">TIF_ALLOWOTHERACCOUNTHOOK</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02829">TIF_CSRSSTHREAD</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02844">TIF_GLOBALHOOKER</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02828">TIF_SYSTEMTHREAD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00910">TYPE_HOOK</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02025">WHF_FROM_WH</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02704">WSF_NOIO</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l00285">zzzJournalAttach()</a>, <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l01363">zzzSetFMouseMoved()</a>, and <a class="el" href="../../d2/d1/hooks_8c-source.html#l01126">zzzUnhookWindowsHookEx()</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l03376">NtUserSetWindowsHookEx()</a>, and <a class="el" href="../../d2/d1/hooks_8c-source.html#l00528">zzzSetWindowsHookAW()</a>.
<p>
<pre class="fragment"><div>00583 {
00584     ACCESS_MASK amDesired;
00585     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a>       phkNew;
00586     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlphkNew;
00587     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a>       *pphkStart;
00588     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
00589 
00590     <span class="comment">/*</span>
00591 <span class="comment">     * Check to see if filter type is valid.</span>
00592 <span class="comment">     */</span>
00593     <span class="keywordflow">if</span> ((nFilterType &lt; WH_MIN) || (nFilterType &gt; WH_MAX)) {
00594         RIPERR0(ERROR_INVALID_HOOK_FILTER, RIP_VERBOSE, <span class="stringliteral">""</span>);
00595         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00596     }
00597 
00598     <span class="comment">/*</span>
00599 <span class="comment">     * Check to see if filter proc is valid.</span>
00600 <span class="comment">     */</span>
00601     <span class="keywordflow">if</span> (pfnFilterProc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00602         RIPERR0(ERROR_INVALID_FILTER_PROC, RIP_VERBOSE, <span class="stringliteral">""</span>);
00603         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00604     }
00605 
00606     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00607 
00608     <span class="keywordflow">if</span> (ptiThread == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00609         <span class="comment">/*</span>
00610 <span class="comment">         * Is the app trying to set a global hook without a library?</span>
00611 <span class="comment">         * If so return an error.</span>
00612 <span class="comment">         */</span>
00613          <span class="keywordflow">if</span> (hmod == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00614              RIPERR0(ERROR_HOOK_NEEDS_HMOD, RIP_VERBOSE, <span class="stringliteral">""</span>);
00615              <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00616          }
00617     } <span class="keywordflow">else</span> {
00618         <span class="comment">/*</span>
00619 <span class="comment">         * Is the app trying to set a local hook that is global-only?</span>
00620 <span class="comment">         * If so return an error.</span>
00621 <span class="comment">         */</span>
00622         <span class="keywordflow">if</span> (!(<a class="code" href="../../d1/d2/hooks_8c.html#a9">abHookFlags</a>[nFilterType + 1] &amp; <a class="code" href="../../d1/d2/hooks_8c.html#a1">HKF_TASK</a>)) {
00623             RIPERR0(ERROR_GLOBAL_ONLY_HOOK, RIP_VERBOSE, <span class="stringliteral">""</span>);
00624             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00625         }
00626 
00627         <span class="comment">/*</span>
00628 <span class="comment">         * Can't hook outside our own desktop.</span>
00629 <span class="comment">         */</span>
00630         <span class="keywordflow">if</span> (ptiThread-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>) {
00631             RIPERR0(ERROR_ACCESS_DENIED,
00632                    RIP_WARNING,
00633                    <span class="stringliteral">"Access denied to desktop in zzzSetWindowsHookEx - can't hook other desktops"</span>);
00634 
00635             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00636         }
00637 
00638         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> != ptiThread-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>) {
00639             <span class="comment">/*</span>
00640 <span class="comment">             * Is the app trying to set hook in another process without a library?</span>
00641 <span class="comment">             * If so return an error.</span>
00642 <span class="comment">             */</span>
00643             <span class="keywordflow">if</span> (hmod == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00644                 RIPERR0(ERROR_HOOK_NEEDS_HMOD, RIP_VERBOSE, <span class="stringliteral">""</span>);
00645                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00646             }
00647 
00648             <span class="comment">/*</span>
00649 <span class="comment">             * Is the app hooking another user without access?</span>
00650 <span class="comment">             * If so return an error. Note that this check is done</span>
00651 <span class="comment">             * for global hooks every time the hook is called.</span>
00652 <span class="comment">             */</span>
00653             <span class="keywordflow">if</span> ((!<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;ptiThread-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o27">luidSession</a>,
00654                                &amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o27">luidSession</a>)) &amp;&amp;
00655                         !(ptiThread-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a815">TIF_ALLOWOTHERACCOUNTHOOK</a>)) {
00656 
00657                 RIPERR0(ERROR_ACCESS_DENIED,
00658                         RIP_WARNING,
00659                         <span class="stringliteral">"Access denied to other user in zzzSetWindowsHookEx"</span>);
00660 
00661                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00662             }
00663 
00664             <span class="keywordflow">if</span> ((ptiThread-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a798">TIF_CSRSSTHREAD</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a797">TIF_SYSTEMTHREAD</a>)) &amp;&amp;
00665                     !(<a class="code" href="../../d1/d2/hooks_8c.html#a9">abHookFlags</a>[nFilterType + 1] &amp; <a class="code" href="../../d1/d2/hooks_8c.html#a4">HKF_INTERSENDABLE</a>)) {
00666 
00667                 <span class="comment">/*</span>
00668 <span class="comment">                 * Can't hook console or GUI system thread if inter-thread</span>
00669 <span class="comment">                 * calling isn't implemented for this hook type.</span>
00670 <span class="comment">                 */</span>
00671                  RIPERR1(ERROR_HOOK_TYPE_NOT_ALLOWED,
00672                          RIP_WARNING,
00673                          <span class="stringliteral">"nFilterType (%ld) not allowed in zzzSetWindowsHookEx"</span>,
00674                          nFilterType);
00675 
00676                  <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00677             }
00678         }
00679     }
00680 
00681     <span class="comment">/*</span>
00682 <span class="comment">     * Check if this thread has access to hook its desktop.</span>
00683 <span class="comment">     */</span>
00684     <span class="keywordflow">switch</span>( nFilterType ) {
00685     <span class="keywordflow">case</span> WH_JOURNALRECORD:
00686         amDesired = DESKTOP_JOURNALRECORD;
00687         <span class="keywordflow">break</span>;
00688 
00689     <span class="keywordflow">case</span> WH_JOURNALPLAYBACK:
00690         amDesired = DESKTOP_JOURNALPLAYBACK;
00691         <span class="keywordflow">break</span>;
00692 
00693     <span class="keywordflow">default</span>:
00694         amDesired = DESKTOP_HOOKCONTROL;
00695         <span class="keywordflow">break</span>;
00696     }
00697 
00698     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a68">RtlAreAllAccessesGranted</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o48">amdesk</a>, amDesired)) {
00699          RIPERR0(ERROR_ACCESS_DENIED,
00700                 RIP_WARNING,
00701                 <span class="stringliteral">"Access denied to desktop in zzzSetWindowsHookEx"</span>);
00702 
00703          <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00704     }
00705 
00706     <span class="keywordflow">if</span> (amDesired != DESKTOP_HOOKCONTROL &amp;&amp;
00707         (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>)) {
00708         RIPERR0(ERROR_REQUIRES_INTERACTIVE_WINDOWSTATION,
00709                 RIP_WARNING,
00710                 <span class="stringliteral">"Journal hooks invalid on a desktop belonging to a non-interactive WindowStation."</span>);
00711 
00712         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00713     }
00714 
00715 <span class="preprocessor">#if 0</span>
00716 <span class="preprocessor"></span>    <span class="comment">/*</span>
00717 <span class="comment">     * Is this a journal hook?</span>
00718 <span class="comment">     */</span>
00719     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/hooks_8c.html#a9">abHookFlags</a>[nFilterType + 1] &amp; <a class="code" href="../../d1/d2/hooks_8c.html#a2">HKF_JOURNAL</a>) {
00720         <span class="comment">/*</span>
00721 <span class="comment">         * Is a journal hook of this type already installed?</span>
00722 <span class="comment">         * If so it's an error.</span>
00723 <span class="comment">         * If this code is enabled, use PhkFirstGlobalValid instead</span>
00724 <span class="comment">         *  of checking phkStart directly</span>
00725 <span class="comment">         */</span>
00726         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o7">pDeskInfo</a>-&gt;asphkStart[nFilterType + 1] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00727             RIPERR0(ERROR_JOURNAL_HOOK_SET, RIP_VERBOSE, <span class="stringliteral">""</span>);
00728             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00729         }
00730     }
00731 <span class="preprocessor">#endif</span>
00732 <span class="preprocessor"></span>
00733     <span class="comment">/*</span>
00734 <span class="comment">     * Allocate the new HOOK structure.</span>
00735 <span class="comment">     */</span>
00736     phkNew = (<a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a>)<a class="code" href="../../d4/d1/userk_8h.html#a969">HMAllocObject</a>(ptiCurrent, ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>,
00737             TYPE_HOOK, <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d6/structtagHOOK.html">HOOK</a>));
00738     <span class="keywordflow">if</span> (phkNew == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00739         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00740     }
00741 
00742     <span class="comment">/*</span>
00743 <span class="comment">     * If a DLL is required for this hook, register the library with</span>
00744 <span class="comment">     * the library management routines so we can assure it's loaded</span>
00745 <span class="comment">     * into all the processes necessary.</span>
00746 <span class="comment">     */</span>
00747     phkNew-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o5">ihmod</a> = -1;
00748     <span class="keywordflow">if</span> (hmod != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00749 
00750 <span class="preprocessor">#if defined(WX86)</span>
00751 <span class="preprocessor"></span>
00752         phkNew-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> |= (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a508">HF_WX86KNOWNDLL</a>);
00753 
00754 <span class="preprocessor">#endif</span>
00755 <span class="preprocessor"></span>
00756         phkNew-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o5">ihmod</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1541">GetHmodTableIndex</a>(pstrLib);
00757 
00758         <span class="keywordflow">if</span> (phkNew-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o5">ihmod</a> == -1) {
00759             RIPERR0(ERROR_MOD_NOT_FOUND, RIP_VERBOSE, <span class="stringliteral">""</span>);
00760             <a class="code" href="../../d4/d1/userk_8h.html#a970">HMFreeObject</a>((PVOID)phkNew);
00761             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00762         }
00763 
00764         <span class="comment">/*</span>
00765 <span class="comment">         * Add a dependency on this module - meaning, increment a count</span>
00766 <span class="comment">         * that simply counts the number of hooks set into this module.</span>
00767 <span class="comment">         */</span>
00768         <span class="keywordflow">if</span> (phkNew-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o5">ihmod</a> &gt;= 0) {
00769             <a class="code" href="../../d4/d1/userk_8h.html#a1542">AddHmodDependency</a>(phkNew-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o5">ihmod</a>);
00770         }
00771     }
00772 
00773     <span class="comment">/*</span>
00774 <span class="comment">     * Depending on whether we're setting a global or local hook,</span>
00775 <span class="comment">     * get the start of the appropriate linked-list of HOOKs.  Also</span>
00776 <span class="comment">     * set the HF_GLOBAL flag if it's a global hook.</span>
00777 <span class="comment">     */</span>
00778     <span class="keywordflow">if</span> (ptiThread != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00779         pphkStart = &amp;ptiThread-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o51">aphkStart</a>[nFilterType + 1];
00780 
00781         <span class="comment">/*</span>
00782 <span class="comment">         * Set the WHF_* in the THREADINFO so we know it's hooked.</span>
00783 <span class="comment">         */</span>
00784         ptiThread-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o31">fsHooks</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a510">WHF_FROM_WH</a>(nFilterType);
00785 
00786         <span class="comment">/*</span>
00787 <span class="comment">         * Set the flags in the thread's TEB</span>
00788 <span class="comment">         */</span>
00789         <span class="keywordflow">if</span> (ptiThread-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>) {
00790             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fAttached;
00791 
00792             <span class="comment">/*</span>
00793 <span class="comment">             * If the thread being hooked is in another process, attach</span>
00794 <span class="comment">             * to that process so that we can access its ClientInfo.</span>
00795 <span class="comment">             */</span>
00796             <span class="keywordflow">if</span> (ptiThread-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>) {
00797                 <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>(&amp;ptiThread-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;Process-&gt;Pcb);
00798                 fAttached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00799             } <span class="keywordflow">else</span>
00800                 fAttached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00801 
00802             ptiThread-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o8">fsHooks</a> = ptiThread-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o31">fsHooks</a>;
00803 
00804             <span class="keywordflow">if</span> (fAttached)
00805                 <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00806         }
00807 
00808         <span class="comment">/*</span>
00809 <span class="comment">         * Remember which thread we're hooking.</span>
00810 <span class="comment">         */</span>
00811         phkNew-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o6">ptiHooked</a> = ptiThread;
00812 
00813     } <span class="keywordflow">else</span> {
00814         pphkStart = &amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o7">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o4">aphkStart</a>[nFilterType + 1];
00815         phkNew-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a502">HF_GLOBAL</a>;
00816 
00817         <span class="comment">/*</span>
00818 <span class="comment">         * Set the WHF_* in the SERVERINFO so we know it's hooked.</span>
00819 <span class="comment">         */</span>
00820         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o7">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o3">fsHooks</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a510">WHF_FROM_WH</a>(nFilterType);
00821 
00822         phkNew-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o6">ptiHooked</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00823     }
00824 
00825     <span class="comment">/*</span>
00826 <span class="comment">     * Does the hook function expect ANSI or Unicode text?</span>
00827 <span class="comment">     */</span>
00828     phkNew-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> |= (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a503">HF_ANSI</a>);
00829 
00830     <span class="comment">/*</span>
00831 <span class="comment">     * Initialize the HOOK structure.  Unreferenced parameters are assumed</span>
00832 <span class="comment">     * to be initialized to zero by LocalAlloc().</span>
00833 <span class="comment">     */</span>
00834     phkNew-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a> = nFilterType;
00835 
00836     <span class="comment">/*</span>
00837 <span class="comment">     * Libraries are loaded at different linear addresses in different</span>
00838 <span class="comment">     * process contexts.  For this reason, we need to convert the filter</span>
00839 <span class="comment">     * proc address into an offset while setting the hook, and then convert</span>
00840 <span class="comment">     * it back to a real per-process function pointer when calling a</span>
00841 <span class="comment">     * hook.  Do this by subtracting the 'hmod' (which is a pointer to the</span>
00842 <span class="comment">     * linear and contiguous .exe header) from the function index.</span>
00843 <span class="comment">     */</span>
00844     phkNew-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o3">offPfn</a> = ((ULONG_PTR)pfnFilterProc) - ((ULONG_PTR)hmod);
00845 
00846 <span class="preprocessor">#ifdef HOOKBATCH</span>
00847 <span class="preprocessor"></span>    phkNew-&gt;cEventMessages = 0;
00848     phkNew-&gt;iCurrentEvent  = 0;
00849     phkNew-&gt;CacheTimeOut = 0;
00850     phkNew-&gt;aEventCache = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00851 <span class="preprocessor">#endif //HOOKBATCH</span>
00852 <span class="preprocessor"></span>
00853     <span class="comment">/*</span>
00854 <span class="comment">     * Link this hook into the front of the hook-list.</span>
00855 <span class="comment">     */</span>
00856     phkNew-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o1">phkNext</a> = *pphkStart;
00857     *pphkStart = phkNew;
00858 
00859     <span class="comment">/*</span>
00860 <span class="comment">     * If this is a journal hook, setup synchronized input processing</span>
00861 <span class="comment">     * AFTER we set the hook - so this synchronization can be cancelled</span>
00862 <span class="comment">     * with control-esc.</span>
00863 <span class="comment">     */</span>
00864     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/hooks_8c.html#a9">abHookFlags</a>[nFilterType + 1] &amp; <a class="code" href="../../d1/d2/hooks_8c.html#a2">HKF_JOURNAL</a>) {
00865         <span class="comment">/*</span>
00866 <span class="comment">         * Attach everyone to us so journal-hook processing</span>
00867 <span class="comment">         * will be synchronized.</span>
00868 <span class="comment">         * No need to DeferWinEventNotify() here, since we lock phkNew.</span>
00869 <span class="comment">         */</span>
00870         <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, phkNew, &amp;tlphkNew);
00871         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d2/hooks_8c.html#a11">zzzJournalAttach</a>(ptiCurrent, TRUE)) {
00872             RIPMSG1(RIP_WARNING, <span class="stringliteral">"zzzJournalAttach failed, so abort hook %#p"</span>, phkNew);
00873             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlphkNew) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00874                 <a class="code" href="../../d4/d1/userk_8h.html#a1815">zzzUnhookWindowsHookEx</a>(phkNew);
00875             }
00876             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00877         }
00878         <span class="keywordflow">if</span> ((phkNew = <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlphkNew)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00879             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00880         }
00881     }
00882 
00883     UserAssert(phkNew != NULL);
00884 
00885     <span class="comment">/*</span>
00886 <span class="comment">     * Later 5.0 GerardoB: The old code just to check this but</span>
00887 <span class="comment">     *  I think it's some left over stuff from server side days.</span>
00888 <span class="comment">    .* Let's assert on it for a while</span>
00889 <span class="comment">     * Also, I added the assertions in the else's below because I reorganized</span>
00890 <span class="comment">     *  the code and want to make sure we don't change behavior</span>
00891 <span class="comment">     */</span>
00892     UserAssert(ptiCurrent-&gt;pEThread &amp;&amp; <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>(ptiCurrent-&gt;pEThread));
00893 
00894     <span class="comment">/*</span>
00895 <span class="comment">     * Can't allow a process that has set a global hook that works</span>
00896 <span class="comment">     * on server-side winprocs to run at background priority! Bump</span>
00897 <span class="comment">     * up it's dynamic priority and mark it so it doesn't get reset.</span>
00898 <span class="comment">     */</span>
00899     <span class="keywordflow">if</span> ((phkNew-&gt;flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a502">HF_GLOBAL</a>) &amp;&amp;
00900             (<a class="code" href="../../d1/d2/hooks_8c.html#a9">abHookFlags</a>[nFilterType + 1] &amp; <a class="code" href="../../d1/d2/hooks_8c.html#a4">HKF_INTERSENDABLE</a>)) {
00901 
00902         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a812">TIF_GLOBALHOOKER</a>;
00903         <a class="code" href="../../d9/d1/thredobj_8c.html#a24">KeSetPriorityThread</a>(&amp;ptiCurrent-&gt;pEThread-&gt;Tcb, LOW_REALTIME_PRIORITY-2);
00904 
00905         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/hooks_8c.html#a9">abHookFlags</a>[nFilterType + 1] &amp; <a class="code" href="../../d1/d2/hooks_8c.html#a2">HKF_JOURNAL</a>) {
00906             <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, phkNew, &amp;tlphkNew);
00907             <span class="comment">/*</span>
00908 <span class="comment">             * If we're changing the journal hooks, jiggle the mouse.</span>
00909 <span class="comment">             * This way the first event will always be a mouse move, which</span>
00910 <span class="comment">             * will ensure that the cursor is set properly.</span>
00911 <span class="comment">             */</span>
00912             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a32">zzzSetFMouseMoved</a>();
00913             phkNew = <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlphkNew);
00914             <span class="comment">/*</span>
00915 <span class="comment">             * If setting a journal playback hook, this process is the input</span>
00916 <span class="comment">             *  provider. This gives it the right to call SetForegroundWindow</span>
00917 <span class="comment">             */</span>
00918             <span class="keywordflow">if</span> (nFilterType == WH_JOURNALPLAYBACK) {
00919                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a80">gppiInputProvider</a> = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>;
00920             }
00921         } <span class="keywordflow">else</span> {
00922             UserAssert(nFilterType != WH_JOURNALPLAYBACK);
00923         }
00924     } <span class="keywordflow">else</span> {
00925         UserAssert(!(abHookFlags[nFilterType + 1] &amp; HKF_JOURNAL));
00926         UserAssert(nFilterType != WH_JOURNALPLAYBACK);
00927     }
00928 
00929 
00930 
00931 
00932     <span class="comment">/*</span>
00933 <span class="comment">     * Return pointer to our internal hook structure so we know</span>
00934 <span class="comment">     * which hook to call next in CallNextHookEx().</span>
00935 <span class="comment">     */</span>
00936     <a class="code" href="../../d4/d1/userk_8h.html#a601">DbgValidateHooks</a>(phkNew, phkNew-&gt;iHook);
00937     <span class="keywordflow">return</span> phkNew;
00938 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="hooks.c::zzzUnhookWindowsHook" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL zzzUnhookWindowsHook           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">int&nbsp;</td>
          <td class="mdname" nowrap> <em>nFilterType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PROC&nbsp;</td>
          <td class="mdname" nowrap> <em>pfnFilterProc</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/hooks_8c-source.html#l01068">1068</a> of file <a class="el" href="../../d2/d1/hooks_8c-source.html">hooks.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03670">PFNHOOK</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l02183">PhkFirstValid()</a>, <a class="el" href="../../d7/d8/rtl_2wow_8c-source.html#l01031">PhkNextValid()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, and <a class="el" href="../../d2/d1/hooks_8c-source.html#l01126">zzzUnhookWindowsHookEx()</a>.
<p>
<pre class="fragment"><div>01071 {
01072     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phk;
01073     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
01074 
01075     <span class="keywordflow">if</span> ((nFilterType &lt; WH_MIN) || (nFilterType &gt; WH_MAX)) {
01076         RIPERR0(ERROR_INVALID_HOOK_FILTER, RIP_VERBOSE, <span class="stringliteral">""</span>);
01077         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01078     }
01079 
01080     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01081 
01082     <span class="keywordflow">for</span> (phk = <a class="code" href="../../d4/d1/userk_8h.html#a1518">PhkFirstValid</a>(ptiCurrent, nFilterType); phk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; phk = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a22">PhkNextValid</a>(phk)) {
01083         <span class="comment">/*</span>
01084 <span class="comment">         * Is this the hook we're looking for?</span>
01085 <span class="comment">         */</span>
01086         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a423">PFNHOOK</a>(phk) == pfnFilterProc) {
01087 
01088             <span class="comment">/*</span>
01089 <span class="comment">             * Are we on the thread that set the hook?</span>
01090 <span class="comment">             * If not return an error.</span>
01091 <span class="comment">             */</span>
01092             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phk) != ptiCurrent) {
01093                 RIPERR0(ERROR_ACCESS_DENIED,
01094                         RIP_WARNING,
01095                         <span class="stringliteral">"Access denied in zzzUnhookWindowsHook: "</span>
01096                         <span class="stringliteral">"this thread is not the same as that which set the hook"</span>);
01097 
01098                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01099             }
01100 
01101             <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1815">zzzUnhookWindowsHookEx</a>( phk );
01102         }
01103     }
01104 
01105     <span class="comment">/*</span>
01106 <span class="comment">     * Didn't find the hook we were looking for so return FALSE.</span>
01107 <span class="comment">     */</span>
01108     RIPERR0(ERROR_HOOK_NOT_INSTALLED, RIP_VERBOSE, <span class="stringliteral">""</span>);
01109     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01110 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="hooks.c::zzzUnhookWindowsHookEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL zzzUnhookWindowsHookEx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d6/structtagHOOK.html">PHOOK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>phkFree</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d1/hooks_8c-source.html#l01126">1126</a> of file <a class="el" href="../../d2/d1/hooks_8c-source.html">hooks.c</a>.
<p>
References <a class="el" href="../../d2/d1/hooks_8c-source.html#l00049">abHookFlags</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02079">tagHOOK::flags</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l01976">FreeHook()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02014">HF_DESTROYED</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l00024">HKF_INTERSENDABLE</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l00022">HKF_JOURNAL</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02077">tagHOOK::iHook</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l02151">PhkFirstGlobalValid()</a>, <a class="el" href="../../d7/d8/rtl_2wow_8c-source.html#l01031">PhkNextValid()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02844">TIF_GLOBALHOOKER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d1/hooks_8c-source.html#l00285">zzzJournalAttach()</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l06423">NtUserUnhookWindowsHookEx()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l00404">zzzCancelJournalling()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l00576">zzzSetWindowsHookEx()</a>, and <a class="el" href="../../d2/d1/hooks_8c-source.html#l01068">zzzUnhookWindowsHook()</a>.
<p>
<pre class="fragment"><div>01128 {
01129     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
01130 
01131     pti = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkFree);
01132 
01133     <span class="comment">/*</span>
01134 <span class="comment">     * If this hook is already destroyed, bail</span>
01135 <span class="comment">     */</span>
01136     <span class="keywordflow">if</span> (phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a509">HF_DESTROYED</a>) {
01137         RIPMSG1(RIP_WARNING, <span class="stringliteral">"_UnhookWindowsHookEx(%#p) already destroyed"</span>, phkFree);
01138         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01139     }
01140 
01141     <span class="comment">/*</span>
01142 <span class="comment">     * Clear the journaling flags in all the queues.</span>
01143 <span class="comment">     */</span>
01144     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/hooks_8c.html#a9">abHookFlags</a>[phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a> + 1] &amp; <a class="code" href="../../d1/d2/hooks_8c.html#a2">HKF_JOURNAL</a>) {
01145         <a class="code" href="../../d1/d2/hooks_8c.html#a11">zzzJournalAttach</a>(pti, FALSE);
01146         <span class="comment">/*</span>
01147 <span class="comment">         * If someone got stuck because of the hook, let him go</span>
01148 <span class="comment">         *</span>
01149 <span class="comment">         * I want to get some performance numbers before checking this in.</span>
01150 <span class="comment">         * MSTest hooks and unhooks all the time when running a script.</span>
01151 <span class="comment">         * This code has never been in. 5/22/96. GerardoB</span>
01152 <span class="comment">         */</span>
01153         <span class="comment">// InterQueueMsgCleanup(3 * CMSWAITTOKILLTIMEOUT);</span>
01154     }
01155 
01156     <span class="comment">/*</span>
01157 <span class="comment">     * If no one is currently calling this hook,</span>
01158 <span class="comment">     * go ahead and free it now.</span>
01159 <span class="comment">     */</span>
01160     <a class="code" href="../../d4/d1/userk_8h.html#a1520">FreeHook</a>(phkFree);
01161 
01162     <span class="comment">/*</span>
01163 <span class="comment">     * If this thread has no more global hooks that are able to hook</span>
01164 <span class="comment">     * server-side window procs, we must clear it's TIF_GLOBALHOOKER bit.</span>
01165 <span class="comment">     */</span>
01166     <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a812">TIF_GLOBALHOOKER</a>) {
01167         <span class="keywordtype">int</span> iHook;
01168         <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phk;
01169         <span class="keywordflow">for</span> (iHook = WH_MIN ; iHook &lt;= WH_MAX ; ++iHook) {
01170             <span class="comment">/*</span>
01171 <span class="comment">             * Ignore those that can't hook server-side winprocs</span>
01172 <span class="comment">             */</span>
01173             <span class="keywordflow">if</span> (!(<a class="code" href="../../d1/d2/hooks_8c.html#a9">abHookFlags</a>[iHook + 1] &amp; <a class="code" href="../../d1/d2/hooks_8c.html#a4">HKF_INTERSENDABLE</a>)) {
01174                 <span class="keywordflow">continue</span>;
01175             }
01176 
01177             <span class="comment">/*</span>
01178 <span class="comment">             * Scan the global hooks</span>
01179 <span class="comment">             */</span>
01180             <span class="keywordflow">for</span> (phk = <a class="code" href="../../d4/d1/userk_8h.html#a1519">PhkFirstGlobalValid</a>(pti, iHook);
01181                     phk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; phk = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a22">PhkNextValid</a>(phk)) {
01182 
01183                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phk) == pti) {
01184                     <span class="keywordflow">goto</span> StillHasGlobalHooks;
01185                 }
01186             }
01187         }
01188         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a812">TIF_GLOBALHOOKER</a>;
01189     }
01190 
01191 StillHasGlobalHooks:
01192     <span class="comment">/*</span>
01193 <span class="comment">     * Success, return TRUE.</span>
01194 <span class="comment">     */</span>
01195     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01196 }
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a9" doxytag="hooks.c::abHookFlags" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> CONST <a class="el" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> <a class="el" href="../../d1/d2/hooks_8c.html#a9">abHookFlags</a>[CWINHOOKS]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><pre class="fragment"><div> {
    <a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a1">HKF_TASK</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a3">HKF_NZRET</a>                       , 
    <a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a2">HKF_JOURNAL</a>          | <a class="code" href="../../d1/d2/hooks_8c.html#a4">HKF_INTERSENDABLE</a>   , 
    <a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a2">HKF_JOURNAL</a>          | <a class="code" href="../../d1/d2/hooks_8c.html#a4">HKF_INTERSENDABLE</a>   , 
    <a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a1">HKF_TASK</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a3">HKF_NZRET</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a4">HKF_INTERSENDABLE</a>   , 
    <a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a1">HKF_TASK</a>                                   , 
    <a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a1">HKF_TASK</a>                                   , 
    <a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a1">HKF_TASK</a>                                   , 
    <a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a>                                              , 
    <a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a1">HKF_TASK</a>             | <a class="code" href="../../d1/d2/hooks_8c.html#a4">HKF_INTERSENDABLE</a>   , 
    <a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a1">HKF_TASK</a>                                   , 
    <a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a1">HKF_TASK</a>                                   , 
    <a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a1">HKF_TASK</a>                                   , 
    <a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a1">HKF_TASK</a>                                   , 
    <a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a1">HKF_TASK</a>                                   , 
    <a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a5">HKF_LOWLEVEL</a>         | <a class="code" href="../../d1/d2/hooks_8c.html#a4">HKF_INTERSENDABLE</a>   , 
    <a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a5">HKF_LOWLEVEL</a>         | <a class="code" href="../../d1/d2/hooks_8c.html#a4">HKF_INTERSENDABLE</a>     



 
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d1/hooks_8c-source.html#l00049">49</a> of file <a class="el" href="../../d2/d1/hooks_8c-source.html">hooks.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d1/hooks_8c-source.html#l01288">xxxCallHook2()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l00528">zzzSetWindowsHookAW()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l00576">zzzSetWindowsHookEx()</a>, and <a class="el" href="../../d2/d1/hooks_8c-source.html#l01126">zzzUnhookWindowsHookEx()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="hooks.c::ampiHookError" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> CONST int <a class="el" href="../../d1/d2/hooks_8c.html#a8">ampiHookError</a>[CWINHOOKS]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><pre class="fragment"><div> {
    0,                                   
    0,                                   
    -1,                                  
    0,                                   
    0,                                   
    0,                                   
    0,                                   
    0,                                   
    0,                                   
    0,                                   
    0,                                   
    0,                                   
    0,                                   
    0,                                   
    0,                                   
    0                                    


 
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d1/hooks_8c-source.html#l00027">27</a> of file <a class="el" href="../../d2/d1/hooks_8c-source.html">hooks.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d1/hooks_8c-source.html#l01288">xxxCallHook2()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:06 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
