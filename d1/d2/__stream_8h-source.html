<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: _stream.h Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>_stream.h</h1><a href="../../d0/d3/__stream_8h.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    _stream.h</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Performance critical routine for Single Binary</span>
00012 <span class="comment"></span>
00013 <span class="comment">    Each function will be created with two flavors FE and non FE</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    KazuM Jun.09.1997</span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
<a name="l00023"></a><a class="code" href="../../d0/d3/__stream_8h.html#a0">00023</a> <span class="preprocessor">#define WWSB_NEUTRAL_FILE 1</span>
00024 <span class="preprocessor"></span>
00025 <span class="preprocessor">#if !defined(FE_SB)</span>
00026 <span class="preprocessor"></span><span class="preprocessor">#error This header file should be included with FE_SB</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00028 <span class="preprocessor"></span>
00029 <span class="preprocessor">#if !defined(WWSB_FE) &amp;&amp; !defined(WWSB_NOFE)</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#error Either WWSB_FE and WWSB_NOFE must be defined.</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00032 <span class="preprocessor"></span>
00033 <span class="preprocessor">#if defined(WWSB_FE) &amp;&amp; defined(WWSB_NOFE)</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#error Both WWSB_FE and WWSB_NOFE defined.</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00036 <span class="preprocessor"></span>
00037 <span class="preprocessor">#ifdef WWSB_FE</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, FE_AdjustCursorPosition)</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, FE_WriteChars)</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, FE_DoWriteConsole)</span>
00041 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, FE_DoSrvWriteConsole)</span>
00042 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00043 <span class="preprocessor"></span>
00044 
00045 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00046"></a><a class="code" href="../../d0/d3/__stream_8h.html#a2">00046</a> <a class="code" href="../../d0/d3/__stream_8h.html#a2">WWSB_AdjustCursorPosition</a>(
00047     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
00048     IN COORD CursorPosition,
00049     IN BOOL KeepCursorVisible,
00050     OUT <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a21">PSHORT</a> ScrollY OPTIONAL
00051     )
00052 
00053 <span class="comment">/*++</span>
00054 <span class="comment"></span>
00055 <span class="comment">Routine Description:</span>
00056 <span class="comment"></span>
00057 <span class="comment">    This routine updates the cursor position.  Its input is the non-special</span>
00058 <span class="comment">    cased new location of the cursor.  For example, if the cursor were being</span>
00059 <span class="comment">    moved one space backwards from the left edge of the screen, the X</span>
00060 <span class="comment">    coordinate would be -1.  This routine would set the X coordinate to</span>
00061 <span class="comment">    the right edge of the screen and decrement the Y coordinate by one.</span>
00062 <span class="comment"></span>
00063 <span class="comment">Arguments:</span>
00064 <span class="comment"></span>
00065 <span class="comment">    ScreenInfo - Pointer to screen buffer information structure.</span>
00066 <span class="comment"></span>
00067 <span class="comment">    CursorPosition - New location of cursor.</span>
00068 <span class="comment"></span>
00069 <span class="comment">    KeepCursorVisible - TRUE if changing window origin desirable when hit right edge</span>
00070 <span class="comment"></span>
00071 <span class="comment">Return Value:</span>
00072 <span class="comment"></span>
00073 <span class="comment">--*/</span>
00074 
00075 {
00076     COORD WindowOrigin;
00077     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00078 <span class="preprocessor">#ifdef WWSB_FE</span>
00079 <span class="preprocessor"></span>    <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console = ScreenInfo-&gt;Console;
00080 
00081     <span class="keywordflow">if</span> (!(ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>))
00082         <span class="keywordflow">return</span> STATUS_SUCCESS;
00083 <span class="preprocessor">#endif</span>
00084 <span class="preprocessor"></span>
00085     <span class="keywordflow">if</span> (CursorPosition.X &lt; 0) {
00086         <span class="keywordflow">if</span> (CursorPosition.Y &gt; 0) {
00087             CursorPosition.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;ScreenBufferSize.X+CursorPosition.X);
00088             CursorPosition.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(CursorPosition.Y-1);
00089         }
00090         <span class="keywordflow">else</span> {
00091             CursorPosition.X = 0;
00092         }
00093     }
00094     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CursorPosition.X &gt;= ScreenInfo-&gt;ScreenBufferSize.X) {
00095 
00096         <span class="comment">//</span>
00097         <span class="comment">// at end of line. if wrap mode, wrap cursor.  otherwise leave it</span>
00098         <span class="comment">// where it is.</span>
00099         <span class="comment">//</span>
00100 
00101         <span class="keywordflow">if</span> (ScreenInfo-&gt;OutputMode &amp; ENABLE_WRAP_AT_EOL_OUTPUT) {
00102             CursorPosition.Y += CursorPosition.X / ScreenInfo-&gt;ScreenBufferSize.X;
00103             CursorPosition.X = CursorPosition.X % ScreenInfo-&gt;ScreenBufferSize.X;
00104         }
00105         <span class="keywordflow">else</span> {
00106             CursorPosition.X = ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.X;
00107         }
00108     }
00109 <span class="preprocessor">#ifdef WWSB_FE</span>
00110 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CursorPosition.Y &gt;= ScreenInfo-&gt;ScreenBufferSize.Y &amp;&amp;
00111         !(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o3">InputBuffer</a>.ImeMode.Open)
00112        )
00113 <span class="preprocessor">#else</span>
00114 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CursorPosition.Y &gt;= ScreenInfo-&gt;ScreenBufferSize.Y)
00115 <span class="preprocessor">#endif</span>
00116 <span class="preprocessor"></span>    {
00117 
00118         <span class="comment">//</span>
00119         <span class="comment">// at end of buffer.  scroll contents of screen buffer so new</span>
00120         <span class="comment">// position is visible.</span>
00121         <span class="comment">//</span>
00122 
00123         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (CursorPosition.Y == ScreenInfo-&gt;ScreenBufferSize.Y);
00124         <a class="code" href="../../d6/d2/output_8c.html#a64">StreamScrollRegion</a>(ScreenInfo);
00125 
00126         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ScrollY)) {
00127             *ScrollY += (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;ScreenBufferSize.Y - CursorPosition.Y - 1);
00128         }
00129         CursorPosition.Y += (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;ScreenBufferSize.Y - CursorPosition.Y - 1);
00130     }
00131 <span class="preprocessor">#ifdef WWSB_FE</span>
00132 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o3">InputBuffer</a>.ImeMode.Disable) &amp;&amp; Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o3">InputBuffer</a>.ImeMode.Open)
00133     {
00134         <span class="keywordflow">if</span> (CursorPosition.Y == (ScreenInfo-&gt;ScreenBufferSize.Y-1)) {
00135             ConsoleImeBottomLineUse(ScreenInfo,2);
00136             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ScrollY)) {
00137                 *ScrollY += (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;ScreenBufferSize.Y - CursorPosition.Y - 2);
00138             }
00139             CursorPosition.Y += (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;ScreenBufferSize.Y - CursorPosition.Y - 2);
00140             <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(ScrollY) &amp;&amp; Console-&gt;lpCookedReadData) {
00141                 ((<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html">PCOOKED_READ_DATA</a>)(Console-&gt;lpCookedReadData))-&gt;OriginalCursorPosition.Y--;
00142             }
00143         }
00144         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CursorPosition.Y == ScreenInfo-&gt;Window.Bottom) {
00145             ;
00146         }
00147     }
00148 <span class="preprocessor">#endif</span>
00149 <span class="preprocessor"></span>
00150     <span class="comment">//</span>
00151     <span class="comment">// if at right or bottom edge of window, scroll right or down one char.</span>
00152     <span class="comment">//</span>
00153 
00154 <span class="preprocessor">#ifdef WWSB_FE</span>
00155 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CursorPosition.Y &gt; ScreenInfo-&gt;Window.Bottom &amp;&amp;
00156         !(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o3">InputBuffer</a>.ImeMode.Open)
00157        )
00158 <span class="preprocessor">#else</span>
00159 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CursorPosition.Y &gt; ScreenInfo-&gt;Window.Bottom)
00160 <span class="preprocessor">#endif</span>
00161 <span class="preprocessor"></span>    {
00162         WindowOrigin.X = 0;
00163         WindowOrigin.Y = CursorPosition.Y - ScreenInfo-&gt;Window.Bottom;
00164         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/output_8c.html#a66">SetWindowOrigin</a>(ScreenInfo,
00165                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00166                                WindowOrigin
00167                               );
00168         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00169             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00170         }
00171     }
00172 <span class="preprocessor">#ifdef WWSB_FE</span>
00173 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o3">InputBuffer</a>.ImeMode.Open)
00174     {
00175         <span class="keywordflow">if</span> (CursorPosition.Y &gt;= ScreenInfo-&gt;Window.Bottom &amp;&amp;
00176             <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo) &gt; 1
00177            ) {
00178             WindowOrigin.X = 0;
00179             WindowOrigin.Y = CursorPosition.Y - ScreenInfo-&gt;Window.Bottom + 1;
00180             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/output_8c.html#a66">SetWindowOrigin</a>(ScreenInfo,
00181                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00182                                         WindowOrigin
00183                                        );
00184             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00185                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00186             }
00187         }
00188     }
00189 <span class="preprocessor">#endif</span>
00190 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (KeepCursorVisible) {
00191         <a class="code" href="../../d0/d7/server_2stream_8c.html#a28">MakeCursorVisible</a>(ScreenInfo,CursorPosition);
00192     }
00193     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a7">SetCursorPosition</a>(ScreenInfo,
00194                                CursorPosition,
00195                                KeepCursorVisible
00196                               );
00197     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00198 }
00199 
<a name="l00200"></a><a class="code" href="../../d0/d3/__stream_8h.html#a1">00200</a> <span class="preprocessor">#define LOCAL_BUFFER_SIZE 100</span>
00201 <span class="preprocessor"></span>
00202 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00203"></a><a class="code" href="../../d0/d3/__stream_8h.html#a3">00203</a> <a class="code" href="../../d0/d3/__stream_8h.html#a3">WWSB_WriteChars</a>(
00204     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
00205     IN PWCHAR lpBufferBackupLimit,
00206     IN PWCHAR lpBuffer,
00207     IN PWCHAR lpRealUnicodeString,
00208     IN OUT PDWORD NumBytes,
00209     OUT PLONG NumSpaces OPTIONAL,
00210     IN SHORT OriginalXPosition,
00211     IN DWORD <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>,
00212     OUT PSHORT ScrollY OPTIONAL
00213     )
00214 
00215 <span class="comment">/*++</span>
00216 <span class="comment"></span>
00217 <span class="comment">Routine Description:</span>
00218 <span class="comment"></span>
00219 <span class="comment">    This routine writes a string to the screen, processing any embedded</span>
00220 <span class="comment">    unicode characters.  The string is also copied to the input buffer, if</span>
00221 <span class="comment">    the output mode is line mode.</span>
00222 <span class="comment"></span>
00223 <span class="comment">Arguments:</span>
00224 <span class="comment"></span>
00225 <span class="comment">    ScreenInfo - Pointer to screen buffer information structure.</span>
00226 <span class="comment"></span>
00227 <span class="comment">    lpBufferBackupLimit - Pointer to beginning of buffer.</span>
00228 <span class="comment"></span>
00229 <span class="comment">    lpBuffer - Pointer to buffer to copy string to.  assumed to be at least</span>
00230 <span class="comment">    as long as lpRealUnicodeString.  This pointer is updated to point to the</span>
00231 <span class="comment">    next position in the buffer.</span>
00232 <span class="comment"></span>
00233 <span class="comment">    lpRealUnicodeString - Pointer to string to write.</span>
00234 <span class="comment"></span>
00235 <span class="comment">    NumBytes - On input, number of bytes to write.  On output, number of</span>
00236 <span class="comment">    bytes written.</span>
00237 <span class="comment"></span>
00238 <span class="comment">    NumSpaces - On output, the number of spaces consumed by the written characters.</span>
00239 <span class="comment"></span>
00240 <span class="comment">    dwFlags -</span>
00241 <span class="comment">      WC_DESTRUCTIVE_BACKSPACE backspace overwrites characters.</span>
00242 <span class="comment">      WC_KEEP_CURSOR_VISIBLE   change window origin desirable when hit rt. edge</span>
00243 <span class="comment">      WC_ECHO                  if called by Read (echoing characters)</span>
00244 <span class="comment">      WC_FALSIFY_UNICODE       if RealUnicodeToFalseUnicode need be called.</span>
00245 <span class="comment"></span>
00246 <span class="comment">Return Value:</span>
00247 <span class="comment"></span>
00248 <span class="comment">Note:</span>
00249 <span class="comment"></span>
00250 <span class="comment">    This routine does not process tabs and backspace properly.  That code</span>
00251 <span class="comment">    will be implemented as part of the line editing services.</span>
00252 <span class="comment"></span>
00253 <span class="comment">--*/</span>
00254 
00255 {
00256     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
00257     COORD CursorPosition;
00258     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00259     ULONG NumChars;
00260     <span class="keyword">static</span> WCHAR Blanks[<a class="code" href="../../d9/d3/input_8h.html#a9">TAB_SIZE</a>] = { <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>,
00261                                       <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>,
00262                                       <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>,
00263                                       <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>,
00264                                       <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>,
00265                                       <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>,
00266                                       <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>,
00267                                       <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a> };
00268     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> XPosition;
00269     WCHAR LocalBuffer[<a class="code" href="../../d0/d3/__stream_8h.html#a1">LOCAL_BUFFER_SIZE</a>];
00270     PWCHAR LocalBufPtr;
00271     ULONG i,j;
00272     SMALL_RECT Region;
00273     ULONG TabSize;
00274     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> TempNumSpaces;
00275     WCHAR Char;
00276     WCHAR RealUnicodeChar;
00277     WORD Attributes;
00278     PWCHAR lpString;
00279     PWCHAR lpAllocatedString;
00280     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fUnprocessed = ((ScreenInfo-&gt;OutputMode &amp; ENABLE_PROCESSED_OUTPUT) == 0);
00281 <span class="preprocessor">#ifdef WWSB_FE</span>
00282 <span class="preprocessor"></span>    <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> LocalBufferA[<a class="code" href="../../d0/d3/__stream_8h.html#a1">LOCAL_BUFFER_SIZE</a>];
00283     PCHAR LocalBufPtrA;
00284 <span class="preprocessor">#endif</span>
00285 <span class="preprocessor"></span>
00286     <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a3">ConsoleHideCursor</a>(ScreenInfo);
00287 
00288     Attributes = ScreenInfo-&gt;Attributes;
00289     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> = *NumBytes;
00290     *NumBytes = 0;
00291     TempNumSpaces = 0;
00292 
00293     lpAllocatedString = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00294     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d4/d1/cmdline_8h.html#a20">WC_FALSIFY_UNICODE</a>) {
00295         <span class="comment">// translation from OEM -&gt; ANSI -&gt; OEM doesn't</span>
00296         <span class="comment">// necessarily yield the same value, so do</span>
00297         <span class="comment">// translation in a separate buffer.</span>
00298 
00299         lpString = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>);
00300         <span class="keywordflow">if</span> (lpString == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00301             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00302             <span class="keywordflow">goto</span> ExitWriteChars;
00303         }
00304 
00305         lpAllocatedString = lpString;
00306         RtlCopyMemory(lpString, lpRealUnicodeString, <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>);
00307         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a42">RealUnicodeToFalseUnicode</a>(lpString,
00308                                          <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> / <span class="keyword">sizeof</span>(WCHAR),
00309                                          ScreenInfo-&gt;Console-&gt;OutputCP
00310                                         );
00311         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00312             <span class="keywordflow">goto</span> ExitWriteChars;
00313         }
00314     } <span class="keywordflow">else</span> {
00315        lpString = lpRealUnicodeString;
00316     }
00317 
00318     <span class="keywordflow">while</span> (*NumBytes &lt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) {
00319 
00320         <span class="comment">//</span>
00321         <span class="comment">// as an optimization, collect characters in buffer and</span>
00322         <span class="comment">// print out all at once.</span>
00323         <span class="comment">//</span>
00324 
00325         XPosition = ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.X;
00326         i=0;
00327         LocalBufPtr = LocalBuffer;
00328 <span class="preprocessor">#ifdef WWSB_FE</span>
00329 <span class="preprocessor"></span>        LocalBufPtrA = LocalBufferA;
00330 <span class="preprocessor">#endif</span>
00331 <span class="preprocessor"></span>        <span class="keywordflow">while</span> (*NumBytes &lt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> &amp;&amp;
00332                i &lt; <a class="code" href="../../d0/d3/__stream_8h.html#a1">LOCAL_BUFFER_SIZE</a> &amp;&amp;
00333                XPosition &lt; ScreenInfo-&gt;ScreenBufferSize.X) {
00334             Char = *lpString;
00335             RealUnicodeChar = *lpRealUnicodeString;
00336             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d7/server_2stream_8c.html#a1">IS_GLYPH_CHAR</a>(RealUnicodeChar) || fUnprocessed) {
00337 <span class="preprocessor">#ifdef WWSB_FE</span>
00338 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (IsConsoleFullWidth(ScreenInfo-&gt;Console-&gt;hDC,
00339                                        ScreenInfo-&gt;Console-&gt;OutputCP,Char)) {
00340                     <span class="keywordflow">if</span> (i &lt; (<a class="code" href="../../d0/d3/__stream_8h.html#a1">LOCAL_BUFFER_SIZE</a>-1) &amp;&amp;
00341                         XPosition &lt; (ScreenInfo-&gt;ScreenBufferSize.X-1)) {
00342                         *LocalBufPtr++ = Char;
00343                         *LocalBufPtrA++ = ATTR_LEADING_BYTE;
00344                         *LocalBufPtr++ = Char;
00345                         *LocalBufPtrA++ = ATTR_TRAILING_BYTE;
00346                         XPosition+=2;
00347                         i+=2;
00348                         lpBuffer++;
00349                     }
00350                     <span class="keywordflow">else</span>
00351                         <span class="keywordflow">goto</span> EndWhile;
00352                 }
00353                 <span class="keywordflow">else</span> {
00354 <span class="preprocessor">#endif</span>
00355 <span class="preprocessor"></span>                    *LocalBufPtr = Char;
00356                     LocalBufPtr++;
00357                     XPosition++;
00358                     i++;
00359                     lpBuffer++;
00360 <span class="preprocessor">#ifdef WWSB_FE</span>
00361 <span class="preprocessor"></span>                    *LocalBufPtrA++ = 0;
00362                 }
00363 <span class="preprocessor">#endif</span>
00364 <span class="preprocessor"></span>            } <span class="keywordflow">else</span> {
00365                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ScreenInfo-&gt;OutputMode &amp; ENABLE_PROCESSED_OUTPUT);
00366                 <span class="keywordflow">switch</span> (RealUnicodeChar) {
00367                     <span class="keywordflow">case</span> <a class="code" href="../../d4/d5/conimep_8h.html#a55">UNICODE_BELL</a>:
00368                         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d4/d1/cmdline_8h.html#a19">WC_ECHO</a>) {
00369                             <span class="keywordflow">goto</span> CtrlChar;
00370                         } <span class="keywordflow">else</span> {
00371                             <a class="code" href="../../d0/d8/ntcftxt_8h.html#a28">SendNotifyMessage</a>(ScreenInfo-&gt;Console-&gt;hWnd,
00372                                               <a class="code" href="../../d1/d7/server_8h.html#a70">CM_BEEP</a>,
00373                                               0,
00374                                               0x47474747);
00375                         }
00376                         <span class="keywordflow">break</span>;
00377                     <span class="keywordflow">case</span> <a class="code" href="../../d4/d5/conimep_8h.html#a51">UNICODE_BACKSPACE</a>:
00378 
00379                         <span class="comment">// automatically go to EndWhile.  this is because</span>
00380                         <span class="comment">// backspace is not destructive, so "aBkSp" prints</span>
00381                         <span class="comment">// a with the cursor on the "a". we could achieve</span>
00382                         <span class="comment">// this behavior staying in this loop and figuring out</span>
00383                         <span class="comment">// the string that needs to be printed, but it would</span>
00384                         <span class="comment">// be expensive and it's the exceptional case.</span>
00385 
00386                         <span class="keywordflow">goto</span> EndWhile;
00387                         <span class="keywordflow">break</span>;
00388                     <span class="keywordflow">case</span> <a class="code" href="../../d9/d5/verifier_8c.html#a3">UNICODE_TAB</a>:
00389                         TabSize = <a class="code" href="../../d9/d3/input_8h.html#a11">NUMBER_OF_SPACES_IN_TAB</a>(XPosition);
00390                         XPosition = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(XPosition + TabSize);
00391                         <span class="keywordflow">if</span> (XPosition &gt;= ScreenInfo-&gt;ScreenBufferSize.X) {
00392                             <span class="keywordflow">goto</span> EndWhile;
00393                         }
00394                         <span class="keywordflow">for</span> (j=0;j&lt;TabSize &amp;&amp; i&lt;<a class="code" href="../../d0/d3/__stream_8h.html#a1">LOCAL_BUFFER_SIZE</a>;j++,i++) {
00395                             *LocalBufPtr = (WCHAR)<span class="charliteral">' '</span>;
00396                             LocalBufPtr++;
00397 <span class="preprocessor">#ifdef WWSB_FE</span>
00398 <span class="preprocessor"></span>                            *LocalBufPtrA++ = 0;
00399 <span class="preprocessor">#endif</span>
00400 <span class="preprocessor"></span>                        }
00401                         lpBuffer++;
00402                         <span class="keywordflow">break</span>;
00403                     <span class="keywordflow">case</span> <a class="code" href="../../d4/d5/conimep_8h.html#a54">UNICODE_LINEFEED</a>:
00404                     <span class="keywordflow">case</span> <a class="code" href="../../d4/d5/conimep_8h.html#a53">UNICODE_CARRIAGERETURN</a>:
00405                         <span class="keywordflow">goto</span> EndWhile;
00406                     <span class="keywordflow">default</span>:
00407 
00408                         <span class="comment">//</span>
00409                         <span class="comment">// if char is ctrl char, write ^char.</span>
00410                         <span class="comment">//</span>
00411 
00412                         <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d4/d1/cmdline_8h.html#a19">WC_ECHO</a>) &amp;&amp; (<a class="code" href="../../d0/d7/server_2stream_8c.html#a0">IS_CONTROL_CHAR</a>(RealUnicodeChar))) {
00413 
00414 CtrlChar:                   <span class="keywordflow">if</span> (i &lt; (<a class="code" href="../../d0/d3/__stream_8h.html#a1">LOCAL_BUFFER_SIZE</a>-1)) {
00415                                 *LocalBufPtr = (WCHAR)<span class="charliteral">'^'</span>;
00416                                 LocalBufPtr++;
00417                                 XPosition++;
00418                                 i++;
00419                                 *LocalBufPtr = (WCHAR)(RealUnicodeChar+(WCHAR)<span class="charliteral">'@'</span>);
00420                                 LocalBufPtr++;
00421                                 XPosition++;
00422                                 i++;
00423                                 lpBuffer++;
00424 <span class="preprocessor">#ifdef WWSB_FE</span>
00425 <span class="preprocessor"></span>                                *LocalBufPtrA++ = 0;
00426                                 *LocalBufPtrA++ = 0;
00427 <span class="preprocessor">#endif</span>
00428 <span class="preprocessor"></span>                            }
00429                             <span class="keywordflow">else</span> {
00430                                 <span class="keywordflow">goto</span> EndWhile;
00431                             }
00432                         } <span class="keywordflow">else</span> {
00433                             <span class="keywordflow">if</span> (!(ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) ||
00434                                     (ScreenInfo-&gt;Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN)) {
00435                                 <span class="comment">/*</span>
00436 <span class="comment">                                 * As a special favor to incompetent apps</span>
00437 <span class="comment">                                 * that attempt to display control chars,</span>
00438 <span class="comment">                                 * convert to corresponding OEM Glyph Chars</span>
00439 <span class="comment">                                 */</span>
00440 <span class="preprocessor">#ifdef WWSB_FE</span>
00441 <span class="preprocessor"></span>                                WORD CharType;
00442 
00443                                 GetStringTypeW(CT_CTYPE1,&amp;RealUnicodeChar,1,&amp;CharType);
00444                                 <span class="keywordflow">if</span> (CharType == C1_CNTRL)
00445                                     <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a37">ConvertOutputToUnicode</a>(ScreenInfo-&gt;Console-&gt;OutputCP,
00446                                                            &amp;(<span class="keywordtype">char</span>)RealUnicodeChar,
00447                                                            1,
00448                                                            LocalBufPtr,
00449                                                            1);
00450                                 <span class="keywordflow">else</span>
00451                                     *LocalBufPtr = Char;
00452 <span class="preprocessor">#else</span>
00453 <span class="preprocessor"></span>                                *LocalBufPtr = SB_CharToWcharGlyph(
00454                                         ScreenInfo-&gt;Console-&gt;OutputCP,
00455                                         (<span class="keywordtype">char</span>)RealUnicodeChar);
00456 <span class="preprocessor">#endif</span>
00457 <span class="preprocessor"></span>                            } <span class="keywordflow">else</span> {
00458                                 *LocalBufPtr = Char;
00459                             }
00460                             LocalBufPtr++;
00461                             XPosition++;
00462                             i++;
00463                             lpBuffer++;
00464 <span class="preprocessor">#ifdef WWSB_FE</span>
00465 <span class="preprocessor"></span>                            *LocalBufPtrA++ = 0;
00466 <span class="preprocessor">#endif</span>
00467 <span class="preprocessor"></span>                        }
00468                 }
00469             }
00470             lpString++;
00471             lpRealUnicodeString++;
00472             *NumBytes += <span class="keyword">sizeof</span>(WCHAR);
00473         }
00474 EndWhile:
00475         <span class="keywordflow">if</span> (i != 0) {
00476 
00477             <span class="comment">//</span>
00478             <span class="comment">// Make sure we don't write past the end of the buffer.</span>
00479             <span class="comment">//</span>
00480 
00481             <span class="keywordflow">if</span> (i &gt; (ULONG)ScreenInfo-&gt;ScreenBufferSize.X - ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.X) {
00482                 i = (ULONG)ScreenInfo-&gt;ScreenBufferSize.X - ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.X;
00483             }
00484 
00485 <span class="preprocessor">#ifdef WWSB_FE</span>
00486 <span class="preprocessor"></span>            <a class="code" href="../../d6/d8/dispatch_8h.html#a26">FE_StreamWriteToScreenBuffer</a>(LocalBuffer,
00487                                          (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)i,
00488                                          ScreenInfo,
00489                                          LocalBufferA
00490                                         );
00491 <span class="preprocessor">#else</span>
00492 <span class="preprocessor"></span>            <a class="code" href="../../d6/d8/dispatch_8h.html#a27">SB_StreamWriteToScreenBuffer</a>(LocalBuffer,
00493                                          (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)i,
00494                                          ScreenInfo
00495                                         );
00496 <span class="preprocessor">#endif</span>
00497 <span class="preprocessor"></span>            Region.Left = ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.X;
00498             Region.Right = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.X + i - 1);
00499             Region.Top = ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.Y;
00500             Region.Bottom = ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.Y;
00501             <a class="code" href="../../d8/d2/__output_8h.html#a16">WWSB_WriteToScreen</a>(ScreenInfo,&amp;Region);
00502             TempNumSpaces += i;
00503             CursorPosition.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.X + i);
00504             CursorPosition.Y = ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.Y;
00505             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d3/__stream_8h.html#a2">WWSB_AdjustCursorPosition</a>(ScreenInfo,CursorPosition,
00506                     <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d4/d1/cmdline_8h.html#a18">WC_KEEP_CURSOR_VISIBLE</a>,ScrollY);
00507             <span class="keywordflow">if</span> (*NumBytes == <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) {
00508                 <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a2">ConsoleShowCursor</a>(ScreenInfo);
00509                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT(NumSpaces)) {
00510                     *NumSpaces = TempNumSpaces;
00511                 }
00512                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00513                 <span class="keywordflow">goto</span> ExitWriteChars;
00514             }
00515             <span class="keywordflow">continue</span>;
00516         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*NumBytes == <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) {
00517 
00518             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ScreenInfo-&gt;OutputMode &amp; ENABLE_PROCESSED_OUTPUT);
00519             <span class="comment">// this catches the case where the number of backspaces ==</span>
00520             <span class="comment">// the number of characters.</span>
00521             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(NumSpaces)) {
00522                 *NumSpaces = TempNumSpaces;
00523             }
00524             <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a2">ConsoleShowCursor</a>(ScreenInfo);
00525             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00526             <span class="keywordflow">goto</span> ExitWriteChars;
00527         }
00528 
00529         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ScreenInfo-&gt;OutputMode &amp; ENABLE_PROCESSED_OUTPUT);
00530         <span class="keywordflow">switch</span> (*lpString) {
00531             <span class="keywordflow">case</span> <a class="code" href="../../d4/d5/conimep_8h.html#a51">UNICODE_BACKSPACE</a>:
00532 
00533                 <span class="comment">//</span>
00534                 <span class="comment">// move cursor backwards one space. overwrite current char with blank.</span>
00535                 <span class="comment">//</span>
00536                 <span class="comment">// we get here because we have to backspace from the beginning of the line</span>
00537 
00538                 CursorPosition = ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition;
00539                 TempNumSpaces -= 1;
00540                 <span class="keywordflow">if</span> (lpBuffer == lpBufferBackupLimit) {
00541                     CursorPosition.X-=1;
00542                 }
00543                 <span class="keywordflow">else</span> {
00544                     PWCHAR pBuffer;
00545                     WCHAR TmpBuffer[<a class="code" href="../../d0/d3/__stream_8h.html#a1">LOCAL_BUFFER_SIZE</a>];
00546                     PWCHAR Tmp,Tmp2;
00547                     WCHAR LastChar;
00548                     ULONG i;
00549 
00550                     <span class="keywordflow">if</span> (lpBuffer-lpBufferBackupLimit &gt; <a class="code" href="../../d0/d3/__stream_8h.html#a1">LOCAL_BUFFER_SIZE</a>) {
00551                         pBuffer = (PWCHAR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),(ULONG)(lpBuffer-lpBufferBackupLimit) * <span class="keyword">sizeof</span>(WCHAR));
00552                         <span class="keywordflow">if</span> (pBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00553                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00554                             <span class="keywordflow">goto</span> ExitWriteChars;
00555                         }
00556                     } <span class="keywordflow">else</span> {
00557                         pBuffer = TmpBuffer;
00558                     }
00559 
00560                     <span class="keywordflow">for</span> (i=0,Tmp2=pBuffer,Tmp=lpBufferBackupLimit;
00561                          i&lt;(ULONG)(lpBuffer-lpBufferBackupLimit);
00562                          i++,Tmp++) {
00563                         <span class="keywordflow">if</span> (*Tmp == <a class="code" href="../../d4/d5/conimep_8h.html#a51">UNICODE_BACKSPACE</a>) {
00564                             <span class="keywordflow">if</span> (Tmp2 &gt; pBuffer) {
00565                                 Tmp2--;
00566                             }
00567                         } <span class="keywordflow">else</span> {
00568                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Tmp2 &gt;= pBuffer);
00569                             *Tmp2++ = *Tmp;
00570                         }
00571 
00572                     }
00573                     <span class="keywordflow">if</span> (Tmp2 == pBuffer) {
00574                         LastChar = (WCHAR)<span class="charliteral">' '</span>;
00575                     } <span class="keywordflow">else</span> {
00576                         LastChar = *(Tmp2-1);
00577                     }
00578                     <span class="keywordflow">if</span> (pBuffer != TmpBuffer) {
00579                         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(pBuffer);
00580                     }
00581 
00582                     <span class="keywordflow">if</span> (LastChar == <a class="code" href="../../d9/d5/verifier_8c.html#a3">UNICODE_TAB</a>) {
00583                         CursorPosition.X -=
00584                             (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(<a class="code" href="../../d0/d7/server_2stream_8c.html#a22">RetrieveNumberOfSpaces</a>(OriginalXPosition,
00585                                                            lpBufferBackupLimit,
00586                                                            (ULONG)(lpBuffer - lpBufferBackupLimit - 1),
00587                                                            ScreenInfo-&gt;Console,
00588                                                            ScreenInfo-&gt;Console-&gt;OutputCP
00589                                                           ));
00590                         <span class="keywordflow">if</span> (CursorPosition.X &lt; 0) {
00591                             CursorPosition.X = (ScreenInfo-&gt;ScreenBufferSize.X - 1)/<a class="code" href="../../d9/d3/input_8h.html#a9">TAB_SIZE</a>;
00592                             CursorPosition.X *= <a class="code" href="../../d9/d3/input_8h.html#a9">TAB_SIZE</a>;
00593                             CursorPosition.X += 1;
00594                             CursorPosition.Y -= 1;
00595                         }
00596                     }
00597                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d7/server_2stream_8c.html#a0">IS_CONTROL_CHAR</a>(LastChar)) {
00598                         CursorPosition.X-=1;
00599                         TempNumSpaces -= 1;
00600 
00601                         <span class="comment">//</span>
00602                         <span class="comment">// overwrite second character of ^x sequence.</span>
00603                         <span class="comment">//</span>
00604 
00605                         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d4/d1/cmdline_8h.html#a17">WC_DESTRUCTIVE_BACKSPACE</a>) {
00606                             NumChars = 1;
00607                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d2/__output_8h.html#a17">WWSB_WriteOutputString</a>(ScreenInfo,
00608                                 Blanks, CursorPosition,
00609                                 <a class="code" href="../../d5/d5/conmsg_8h.html#a12">CONSOLE_FALSE_UNICODE</a>, <span class="comment">// faster than real unicode</span>
00610                                 &amp;NumChars, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00611                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d2/__output_8h.html#a18">WWSB_FillOutput</a>(ScreenInfo,
00612                                 Attributes, CursorPosition,
00613                                 <a class="code" href="../../d5/d5/conmsg_8h.html#a11">CONSOLE_ATTRIBUTE</a>, &amp;NumChars);
00614                         }
00615                         CursorPosition.X-=1;
00616                     }
00617 <span class="preprocessor">#ifdef WWSB_FE</span>
00618 <span class="preprocessor"></span>                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IsConsoleFullWidth(ScreenInfo-&gt;Console-&gt;hDC,
00619                                                 ScreenInfo-&gt;Console-&gt;OutputCP,LastChar))
00620                     {
00621                         CursorPosition.X-=1;
00622                         TempNumSpaces -= 1;
00623 
00624                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d3/__stream_8h.html#a2">WWSB_AdjustCursorPosition</a>(ScreenInfo,CursorPosition,
00625                                      <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d4/d1/cmdline_8h.html#a18">WC_KEEP_CURSOR_VISIBLE</a>,ScrollY);
00626                         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d4/d1/cmdline_8h.html#a17">WC_DESTRUCTIVE_BACKSPACE</a>) { <span class="comment">// bug 7672</span>
00627                             NumChars = 1;
00628                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d2/__output_8h.html#a17">WWSB_WriteOutputString</a>(ScreenInfo,
00629                                 Blanks, ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition,
00630                                 <a class="code" href="../../d5/d5/conmsg_8h.html#a12">CONSOLE_FALSE_UNICODE</a>, <span class="comment">// faster than real unicode</span>
00631                                 &amp;NumChars, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00632                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d2/__output_8h.html#a18">WWSB_FillOutput</a>(ScreenInfo,
00633                                 Attributes, ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition,
00634                                 <a class="code" href="../../d5/d5/conmsg_8h.html#a11">CONSOLE_ATTRIBUTE</a>, &amp;NumChars);
00635                         }
00636                         CursorPosition.X-=1;
00637                     }
00638 <span class="preprocessor">#endif</span>
00639 <span class="preprocessor"></span>                    <span class="keywordflow">else</span> {
00640                         CursorPosition.X--;
00641                     }
00642                 }
00643                 <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d4/d1/cmdline_8h.html#a21">WC_LIMIT_BACKSPACE</a>) &amp;&amp; (CursorPosition.X &lt; 0)) {
00644                     CursorPosition.X = 0;
00645                     KdPrint((<span class="stringliteral">"CONSRV: Ignoring backspace to previous line\n"</span>));
00646                 }
00647                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d3/__stream_8h.html#a2">WWSB_AdjustCursorPosition</a>(ScreenInfo,CursorPosition,
00648                         (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d4/d1/cmdline_8h.html#a18">WC_KEEP_CURSOR_VISIBLE</a>) != 0,ScrollY);
00649                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d4/d1/cmdline_8h.html#a17">WC_DESTRUCTIVE_BACKSPACE</a>) {
00650                     NumChars = 1;
00651                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d2/__output_8h.html#a17">WWSB_WriteOutputString</a>(ScreenInfo,
00652                         Blanks, ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition,
00653                         <a class="code" href="../../d5/d5/conmsg_8h.html#a12">CONSOLE_FALSE_UNICODE</a>, <span class="comment">//faster than real unicode</span>
00654                         &amp;NumChars, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00655                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d2/__output_8h.html#a18">WWSB_FillOutput</a>(ScreenInfo,
00656                         Attributes, ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition,
00657                         <a class="code" href="../../d5/d5/conmsg_8h.html#a11">CONSOLE_ATTRIBUTE</a>, &amp;NumChars);
00658                 }
00659 <span class="preprocessor">#ifdef WWSB_FE</span>
00660 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.X == 0 &amp;&amp;
00661                     (ScreenInfo-&gt;OutputMode &amp; ENABLE_WRAP_AT_EOL_OUTPUT) &amp;&amp;
00662                     lpBuffer &gt; lpBufferBackupLimit) {
00663                     <span class="keywordflow">if</span> (CheckBisectProcessW(ScreenInfo,
00664                                             ScreenInfo-&gt;Console-&gt;OutputCP,
00665                                             lpBufferBackupLimit,
00666                                             (ULONG)(lpBuffer+1-lpBufferBackupLimit),
00667                                             ScreenInfo-&gt;ScreenBufferSize.X-OriginalXPosition,
00668                                             OriginalXPosition,
00669                                             <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d4/d1/cmdline_8h.html#a19">WC_ECHO</a>)) {
00670                         CursorPosition.X = ScreenInfo-&gt;ScreenBufferSize.X-1;
00671                         CursorPosition.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.Y-1);
00672                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d3/__stream_8h.html#a2">WWSB_AdjustCursorPosition</a>(ScreenInfo,CursorPosition,
00673                                      <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d4/d1/cmdline_8h.html#a18">WC_KEEP_CURSOR_VISIBLE</a>,ScrollY);
00674                     }
00675                 }
00676 <span class="preprocessor">#endif</span>
00677 <span class="preprocessor"></span>                <span class="keywordflow">break</span>;
00678             <span class="keywordflow">case</span> <a class="code" href="../../d9/d5/verifier_8c.html#a3">UNICODE_TAB</a>:
00679                 TabSize = <a class="code" href="../../d9/d3/input_8h.html#a11">NUMBER_OF_SPACES_IN_TAB</a>(ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.X);
00680                 CursorPosition.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.X + TabSize);
00681 
00682                 <span class="comment">//</span>
00683                 <span class="comment">// move cursor forward to next tab stop.  fill space with blanks.</span>
00684                 <span class="comment">// we get here when the tab extends beyond the right edge of the</span>
00685                 <span class="comment">// window.  if the tab goes wraps the line, set the cursor to the first</span>
00686                 <span class="comment">// position in the next line.</span>
00687                 <span class="comment">//</span>
00688 
00689                 lpBuffer++;
00690 
00691                 TempNumSpaces += TabSize;
00692                 <span class="keywordflow">if</span> (CursorPosition.X &gt;= ScreenInfo-&gt;ScreenBufferSize.X) {
00693                     NumChars = ScreenInfo-&gt;ScreenBufferSize.X - ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.X;
00694                     CursorPosition.X = 0;
00695                     CursorPosition.Y = ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.Y+1;
00696                 }
00697                 <span class="keywordflow">else</span> {
00698                     NumChars = CursorPosition.X - ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.X;
00699                     CursorPosition.Y = ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.Y;
00700                 }
00701                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d2/__output_8h.html#a17">WWSB_WriteOutputString</a>(ScreenInfo,
00702                                                 Blanks,
00703                                                 ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition,
00704                                                 <a class="code" href="../../d5/d5/conmsg_8h.html#a12">CONSOLE_FALSE_UNICODE</a>, <span class="comment">// faster than real unicode</span>
00705                                                 &amp;NumChars,
00706                                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00707                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d2/__output_8h.html#a18">WWSB_FillOutput</a>(ScreenInfo,
00708                                          Attributes, ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition,
00709                                          <a class="code" href="../../d5/d5/conmsg_8h.html#a11">CONSOLE_ATTRIBUTE</a>,
00710                                          &amp;NumChars);
00711                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d3/__stream_8h.html#a2">WWSB_AdjustCursorPosition</a>(ScreenInfo,CursorPosition,
00712                         (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d4/d1/cmdline_8h.html#a18">WC_KEEP_CURSOR_VISIBLE</a>) != 0,ScrollY);
00713                 <span class="keywordflow">break</span>;
00714             <span class="keywordflow">case</span> <a class="code" href="../../d4/d5/conimep_8h.html#a53">UNICODE_CARRIAGERETURN</a>:
00715 
00716                 <span class="comment">//</span>
00717                 <span class="comment">// Carriage return moves the cursor to the beginning of the line.</span>
00718                 <span class="comment">// We don't need to worry about handling cr or lf for</span>
00719                 <span class="comment">// backspace because input is sent to the user on cr or lf.</span>
00720                 <span class="comment">//</span>
00721 
00722                 lpBuffer++;
00723                 CursorPosition.X = 0;
00724                 CursorPosition.Y = ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.Y;
00725                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d3/__stream_8h.html#a2">WWSB_AdjustCursorPosition</a>(ScreenInfo,CursorPosition,
00726                         (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d4/d1/cmdline_8h.html#a18">WC_KEEP_CURSOR_VISIBLE</a>) != 0,ScrollY);
00727                 <span class="keywordflow">break</span>;
00728             <span class="keywordflow">case</span> <a class="code" href="../../d4/d5/conimep_8h.html#a54">UNICODE_LINEFEED</a>:
00729 
00730                 <span class="comment">//</span>
00731                 <span class="comment">// move cursor to the beginning of the next line.</span>
00732                 <span class="comment">//</span>
00733 
00734                 lpBuffer++;
00735                 CursorPosition.X = 0;
00736                 CursorPosition.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.Y+1);
00737                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d3/__stream_8h.html#a2">WWSB_AdjustCursorPosition</a>(ScreenInfo,CursorPosition,
00738                         (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d4/d1/cmdline_8h.html#a18">WC_KEEP_CURSOR_VISIBLE</a>) != 0,ScrollY);
00739                 <span class="keywordflow">break</span>;
00740             <span class="keywordflow">default</span>:
00741 <span class="preprocessor">#ifdef WWSB_FE</span>
00742 <span class="preprocessor"></span>                Char = *lpString;
00743                 <span class="keywordflow">if</span> (Char &gt;= (WCHAR)<span class="charliteral">' '</span> &amp;&amp;
00744                     IsConsoleFullWidth(ScreenInfo-&gt;Console-&gt;hDC,
00745                                        ScreenInfo-&gt;Console-&gt;OutputCP,Char) &amp;&amp;
00746                     XPosition &gt;= (ScreenInfo-&gt;ScreenBufferSize.X-1) &amp;&amp;
00747                     (ScreenInfo-&gt;OutputMode &amp; ENABLE_WRAP_AT_EOL_OUTPUT)) {
00748 
00749                     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> RowIndex;
00750                     <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a> Row;
00751                     PWCHAR Char;
00752                     COORD TargetPoint;
00753                     PCHAR AttrP;
00754 
00755                     TargetPoint = ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition;
00756                     RowIndex = (ScreenInfo-&gt;BufferInfo.TextInfo.FirstRow+TargetPoint.Y) % ScreenInfo-&gt;ScreenBufferSize.Y;
00757                     Row = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[RowIndex];
00758                     Char = &amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[TargetPoint.X];
00759                     AttrP = &amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[TargetPoint.X];
00760 
00761                     <span class="keywordflow">if</span> (*AttrP &amp; ATTR_TRAILING_BYTE)
00762                     {
00763                         *(Char-1) = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
00764                         *Char = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
00765                         *AttrP = 0;
00766                         *(AttrP-1) = 0;
00767 
00768                         Region.Left = ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.X-1;
00769                         Region.Right = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.X);
00770                         Region.Top = ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.Y;
00771                         Region.Bottom = ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.Y;
00772                         <a class="code" href="../../d8/d2/__output_8h.html#a16">WWSB_WriteToScreen</a>(ScreenInfo,&amp;Region);
00773                     }
00774 
00775                     CursorPosition.X = 0;
00776                     CursorPosition.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.Y+1);
00777                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d3/__stream_8h.html#a2">WWSB_AdjustCursorPosition</a>(ScreenInfo,CursorPosition,
00778                                  <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d4/d1/cmdline_8h.html#a18">WC_KEEP_CURSOR_VISIBLE</a>,ScrollY);
00779                     <span class="keywordflow">continue</span>;
00780                 }
00781 <span class="preprocessor">#endif</span>
00782 <span class="preprocessor"></span>                <span class="keywordflow">break</span>;
00783         }
00784         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00785             <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a2">ConsoleShowCursor</a>(ScreenInfo);
00786             <span class="keywordflow">goto</span> ExitWriteChars;
00787         }
00788 
00789        *NumBytes += <span class="keyword">sizeof</span>(WCHAR);
00790        lpString++;
00791        lpRealUnicodeString++;
00792     }
00793 
00794     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(NumSpaces)) {
00795         *NumSpaces = TempNumSpaces;
00796     }
00797     <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a2">ConsoleShowCursor</a>(ScreenInfo);
00798 
00799     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00800 
00801 ExitWriteChars:
00802     <span class="keywordflow">if</span> (lpAllocatedString) {
00803         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(lpAllocatedString);
00804     }
00805     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00806 }
00807 
00808 ULONG
<a name="l00809"></a><a class="code" href="../../d0/d3/__stream_8h.html#a4">00809</a> <a class="code" href="../../d0/d3/__stream_8h.html#a4">WWSB_DoWriteConsole</a>(
00810     IN OUT PCSR_API_MSG m,
00811     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00812     IN PCSR_THREAD Thread
00813     )
00814 
00815 <span class="comment">//</span>
00816 <span class="comment">// NOTE: console lock must be held when calling this routine</span>
00817 <span class="comment">//</span>
00818 <span class="comment">// string has been translated to unicode at this point</span>
00819 <span class="comment">//</span>
00820 
00821 {
00822     <a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html">PCONSOLE_WRITECONSOLE_MSG</a> a = (<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html">PCONSOLE_WRITECONSOLE_MSG</a>)&amp;m-&gt;u.ApiMessageData;
00823     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
00824     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00825     <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo;
00826     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> NumCharsToWrite;
00827 <span class="preprocessor">#ifdef WWSB_FE</span>
00828 <span class="preprocessor"></span>    <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> i;
00829     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> j;
00830 <span class="preprocessor">#endif</span>
00831 <span class="preprocessor"></span>
00832     <span class="keywordflow">if</span> (Console-&gt;Flags &amp; (<a class="code" href="../../d1/d7/server_8h.html#a25">CONSOLE_SUSPENDED</a> | <a class="code" href="../../d1/d7/server_8h.html#a4">CONSOLE_SELECTING</a> | <a class="code" href="../../d1/d7/server_8h.html#a21">CONSOLE_SCROLLBAR_TRACKING</a>)) {
00833         PWCHAR TransBuffer;
00834 
00835         TransBuffer = (PWCHAR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a>);
00836         <span class="keywordflow">if</span> (TransBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00837             <span class="keywordflow">return</span> (ULONG)STATUS_NO_MEMORY;
00838         }
00839         RtlCopyMemory(TransBuffer,a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o5">TransBuffer</a>,a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a>);
00840         a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o5">TransBuffer</a> = TransBuffer;
00841         a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o8">StackBuffer</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00842         <span class="keywordflow">if</span> (!CsrCreateWait(&amp;Console-&gt;OutputQueue,
00843                           <a class="code" href="../../d0/d7/server_2stream_8c.html#a15">WriteConsoleWaitRoutine</a>,
00844                           Thread,
00845                           m,
00846                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00847                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00848                          )) {
00849             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TransBuffer);
00850             <span class="keywordflow">return</span> (ULONG)STATUS_NO_MEMORY;
00851         }
00852         <span class="keywordflow">return</span> (ULONG)<a class="code" href="../../d1/d7/server_8h.html#a64">CONSOLE_STATUS_WAIT</a>;
00853     }
00854 
00855     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a31">DereferenceIoHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a83">CONSOLE_FROMTHREADPERPROCESSDATA</a>(Thread),
00856                                  a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o1">OutputHandle</a>,
00857                                  <a class="code" href="../../d5/d5/conmsg_8h.html#a1">CONSOLE_OUTPUT_HANDLE</a>,
00858                                  GENERIC_WRITE,
00859                                  &amp;HandleData
00860                                 );
00861     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00862         a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a> = 0;
00863         <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00864     }
00865 
00866     ScreenInfo = HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer;
00867 
00868     <span class="comment">//</span>
00869     <span class="comment">// see if we're the typical case - a string containing no special</span>
00870     <span class="comment">// characters, optionally terminated with CRLF.  if so, skip the</span>
00871     <span class="comment">// special processing.</span>
00872     <span class="comment">//</span>
00873 
00874     NumCharsToWrite=a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a>/<span class="keyword">sizeof</span>(WCHAR);
00875     <span class="keywordflow">if</span> ((ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o2">OutputMode</a> &amp; ENABLE_PROCESSED_OUTPUT) &amp;&amp;
00876         ((LONG)(ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X + NumCharsToWrite) &lt;
00877           ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X) ) {
00878         SMALL_RECT Region;
00879         COORD CursorPosition;
00880 
00881         <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o7">Unicode</a>) {
00882 <span class="preprocessor">#ifdef WWSB_FE</span>
00883 <span class="preprocessor"></span>            a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o9">WriteFlags</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a11">WRITE_SPECIAL_CHARS</a>;
00884 <span class="preprocessor">#else</span>
00885 <span class="preprocessor"></span>            a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o9">WriteFlags</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a29">FastStreamWrite</a>(a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o5">TransBuffer</a>,NumCharsToWrite);
00886 <span class="preprocessor">#endif</span>
00887 <span class="preprocessor"></span>        }
00888         <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o9">WriteFlags</a> == <a class="code" href="../../d0/d7/server_2stream_8c.html#a11">WRITE_SPECIAL_CHARS</a>) {
00889             <span class="keywordflow">goto</span> ProcessedWrite;
00890         }
00891 
00892         <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a3">ConsoleHideCursor</a>(ScreenInfo);
00893 
00894         <span class="comment">//</span>
00895         <span class="comment">// WriteFlags is designed so that the number of special characters</span>
00896         <span class="comment">// is also the flag value.</span>
00897         <span class="comment">//</span>
00898 
00899         NumCharsToWrite -= a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o9">WriteFlags</a>;
00900 
00901         <span class="keywordflow">if</span> (NumCharsToWrite) {
00902 <span class="preprocessor">#ifdef WWSB_FE</span>
00903 <span class="preprocessor"></span>            PWCHAR TransBuffer,TransBufPtr,<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>;
00904             <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> TransBufferA,TransBufPtrA;
00905             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fLocalHeap = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00906             COORD TargetPoint;
00907 
00908             <span class="keywordflow">if</span> (NumCharsToWrite &gt; (ULONG)(ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X * ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y)) {
00909 
00910                 TransBuffer = (PWCHAR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TMP_DBCS_TAG ),NumCharsToWrite * 2 * <span class="keyword">sizeof</span>(WCHAR));
00911                 <span class="keywordflow">if</span> (TransBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00912                     <span class="keywordflow">return</span> (ULONG)STATUS_NO_MEMORY;
00913                 }
00914                 TransBufferA = (PCHAR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TMP_DBCS_TAG ),NumCharsToWrite * 2 * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
00915                 <span class="keywordflow">if</span> (TransBufferA == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00916                     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TransBuffer);
00917                     <span class="keywordflow">return</span> (ULONG)STATUS_NO_MEMORY;
00918                 }
00919 
00920                 fLocalHeap = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00921             }
00922             <span class="keywordflow">else</span> {
00923                 TransBuffer  = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.DbcsScreenBuffer.TransBufferCharacter;
00924                 TransBufferA = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.DbcsScreenBuffer.TransBufferAttribute;
00925             }
00926 
00927             <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> = a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o5">TransBuffer</a>;
00928             TransBufPtr = TransBuffer;
00929             TransBufPtrA = TransBufferA;
00930             <span class="keywordflow">for</span> (i = 0 , j = 0 ; i &lt; NumCharsToWrite ; i++,j++){
00931                 <span class="keywordflow">if</span> (IsConsoleFullWidth(ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a>-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>,
00932                                        ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a>-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o62">OutputCP</a>,*<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>)){
00933                     *TransBuffer++ = *<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> ;
00934                     *TransBufferA++ = ATTR_LEADING_BYTE;
00935                     *TransBuffer++ = *<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>++ ;
00936                     *TransBufferA++ = ATTR_TRAILING_BYTE;
00937                     j++;
00938                 }
00939                 <span class="keywordflow">else</span>{
00940                     *TransBuffer++ = *<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>++ ;
00941                     *TransBufferA++ = 0;
00942                 }
00943             }
00944             TargetPoint = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition;
00945             <a class="code" href="../../d0/d3/dbcs_8h.html#a31">BisectWrite</a>(j,TargetPoint,ScreenInfo);
00946             <span class="keywordflow">if</span> (TargetPoint.Y == ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y-1 &amp;&amp;
00947                 TargetPoint.X+j &gt;= ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X &amp;&amp;
00948                 *(TransBufPtrA+j) &amp; ATTR_LEADING_BYTE){
00949                 *(TransBufPtr+ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X-TargetPoint.X-1) = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
00950                 *(TransBufPtrA+ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X-TargetPoint.X-1) = 0;
00951                 <span class="keywordflow">if</span> (j &gt; ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X-TargetPoint.X-1) {
00952                     *(TransBufPtr+ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X-TargetPoint.X) = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
00953                     *(TransBufPtrA+ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X-TargetPoint.X) = 0;
00954                 }
00955             }
00956             <a class="code" href="../../d6/d8/dispatch_8h.html#a26">FE_StreamWriteToScreenBuffer</a>(TransBufPtr,
00957                                          (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)j,
00958                                          ScreenInfo,
00959                                          TransBufPtrA
00960                                         );
00961             <span class="keywordflow">if</span> (fLocalHeap){
00962                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TransBufPtr);
00963                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TransBufPtrA);
00964             }
00965 <span class="preprocessor">#else</span>
00966 <span class="preprocessor"></span>            <a class="code" href="../../d6/d8/dispatch_8h.html#a27">SB_StreamWriteToScreenBuffer</a>(a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o5">TransBuffer</a>,
00967                                          (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)NumCharsToWrite,
00968                                          ScreenInfo
00969                                         );
00970 <span class="preprocessor">#endif</span>
00971 <span class="preprocessor"></span>            Region.Left = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X;
00972 <span class="preprocessor">#ifdef WWSB_FE</span>
00973 <span class="preprocessor"></span>            Region.Right = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X + j - 1);
00974 <span class="preprocessor">#else</span>
00975 <span class="preprocessor"></span>            Region.Right = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X + NumCharsToWrite - 1);
00976 <span class="preprocessor">#endif</span>
00977 <span class="preprocessor"></span>            Region.Top = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y;
00978             Region.Bottom = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y;
00979             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Region.Right &lt; ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X);
00980             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d2/output_8h.html#a12">ACTIVE_SCREEN_BUFFER</a>(ScreenInfo) &amp;&amp;
00981                 !(ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a>-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a0">CONSOLE_IS_ICONIC</a> &amp;&amp; ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a>-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> == 0)) {
00982                 <a class="code" href="../../d8/d2/__output_8h.html#a15">WWSB_WriteRegionToScreen</a>(ScreenInfo,&amp;Region);
00983             }
00984         }
00985         <span class="keywordflow">switch</span> (a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o9">WriteFlags</a>) {
00986             <span class="keywordflow">case</span> <a class="code" href="../../d0/d7/server_2stream_8c.html#a8">WRITE_NO_CR_LF</a>:
00987                 CursorPosition.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X + NumCharsToWrite);
00988                 CursorPosition.Y = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y;
00989                 <span class="keywordflow">break</span>;
00990             <span class="keywordflow">case</span> <a class="code" href="../../d0/d7/server_2stream_8c.html#a9">WRITE_CR</a>:
00991                 CursorPosition.X = 0;
00992                 CursorPosition.Y = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y;
00993                 <span class="keywordflow">break</span>;
00994             <span class="keywordflow">case</span> <a class="code" href="../../d0/d7/server_2stream_8c.html#a10">WRITE_CR_LF</a>:
00995                 CursorPosition.X = 0;
00996                 CursorPosition.Y = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y+1;
00997                 <span class="keywordflow">break</span>;
00998             <span class="keywordflow">default</span>:
00999                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01000                 <span class="keywordflow">break</span>;
01001         }
01002         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d3/__stream_8h.html#a2">WWSB_AdjustCursorPosition</a>(ScreenInfo,CursorPosition,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01003         <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a2">ConsoleShowCursor</a>(ScreenInfo);
01004         <span class="keywordflow">return</span> STATUS_SUCCESS;
01005     }
01006 ProcessedWrite:
01007     <span class="keywordflow">return</span> <a class="code" href="../../d0/d3/__stream_8h.html#a3">WWSB_WriteChars</a>(ScreenInfo,
01008                       a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o5">TransBuffer</a>,
01009                       a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o5">TransBuffer</a>,
01010                       a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o5">TransBuffer</a>,
01011                       &amp;a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a>,
01012                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01013                       ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X,
01014                       <a class="code" href="../../d4/d1/cmdline_8h.html#a21">WC_LIMIT_BACKSPACE</a>,
01015                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01016                      );
01017 }
01018 
01019 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01020"></a><a class="code" href="../../d0/d3/__stream_8h.html#a5">01020</a> <a class="code" href="../../d0/d3/__stream_8h.html#a5">WWSB_DoSrvWriteConsole</a>(
01021     IN OUT PCSR_API_MSG m,
01022     IN OUT PCSR_REPLY_STATUS ReplyStatus,
01023     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
01024     IN <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData
01025     )
01026 {
01027     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01028     <a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html">PCONSOLE_WRITECONSOLE_MSG</a> a = (<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html">PCONSOLE_WRITECONSOLE_MSG</a>)&amp;m-&gt;u.ApiMessageData;
01029     <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo;
01030     WCHAR StackBuffer[<a class="code" href="../../d1/d7/server_8h.html#a95">STACK_BUFFER_SIZE</a>];
01031 <span class="preprocessor">#ifdef WWSB_FE</span>
01032 <span class="preprocessor"></span>    <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  fLocalHeap = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01033 <span class="preprocessor">#endif</span>
01034 <span class="preprocessor"></span>
01035     ScreenInfo = HandleData-&gt;Buffer.ScreenBuffer;
01036 
01037 <span class="preprocessor">#ifdef WWSB_FE</span>
01038 <span class="preprocessor"></span>    <span class="comment">// Check code for must CONSOLE_TEXTMODE_BUFFER !!</span>
01039     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a1">CONSOLE_GRAPHICS_BUFFER</a>));
01040 <span class="preprocessor">#endif</span>
01041 <span class="preprocessor"></span>
01042     <span class="comment">//</span>
01043     <span class="comment">// if the string was passed in the message, rather than in</span>
01044     <span class="comment">// a capture buffer, adjust the pointer.</span>
01045     <span class="comment">//</span>
01046 
01047     <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o6">BufferInMessage</a>) {
01048         a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o3">BufPtr</a> = a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o2">Buffer</a>;
01049     }
01050 
01051     <span class="comment">//</span>
01052     <span class="comment">// if ansi, translate string.  for speed, we don't allocate a</span>
01053     <span class="comment">// capture buffer if the ansi string was &lt;= 80 chars.  if it's</span>
01054     <span class="comment">// greater than 80 / sizeof(WCHAR), the translated string won't</span>
01055     <span class="comment">// fit into the capture buffer, so reset a-&gt;BufPtr to point to</span>
01056     <span class="comment">// a heap buffer and set a-&gt;CaptureBufferSize so that we don't</span>
01057     <span class="comment">// think the buffer is in the message.</span>
01058     <span class="comment">//</span>
01059 
01060     <span class="keywordflow">if</span> (!a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o7">Unicode</a>) {
01061         PWCHAR TransBuffer;
01062         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> Length;
01063         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> SpecialChars = 0;
01064         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> Codepage;
01065 <span class="preprocessor">#ifdef WWSB_FE</span>
01066 <span class="preprocessor"></span>        PWCHAR TmpTransBuffer;
01067         ULONG NumBytes1 = 0;
01068         ULONG NumBytes2 = 0;
01069 <span class="preprocessor">#endif</span>
01070 <span class="preprocessor"></span>
01071         <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a> &lt;= <a class="code" href="../../d1/d7/server_8h.html#a95">STACK_BUFFER_SIZE</a>) {
01072             TransBuffer = StackBuffer;
01073             a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o8">StackBuffer</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01074 <span class="preprocessor">#ifdef WWSB_FE</span>
01075 <span class="preprocessor"></span>            TmpTransBuffer = TransBuffer;
01076 <span class="preprocessor">#endif</span>
01077 <span class="preprocessor"></span>        }
01078 <span class="preprocessor">#ifdef WWSB_FE</span>
01079 <span class="preprocessor"></span>        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a> &gt; (ULONG)(ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X * ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y)) {
01080             TransBuffer = (PWCHAR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TMP_DBCS_TAG ),(a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a>+2) * <span class="keyword">sizeof</span>(WCHAR));
01081             <span class="keywordflow">if</span> (TransBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01082                 <span class="keywordflow">return</span> (ULONG)STATUS_NO_MEMORY;
01083             }
01084             TmpTransBuffer = TransBuffer;
01085             a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o8">StackBuffer</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01086             fLocalHeap = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01087         }
01088         <span class="keywordflow">else</span> {
01089             TransBuffer = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.DbcsScreenBuffer.TransWriteConsole;
01090             TmpTransBuffer = TransBuffer;
01091         }
01092 <span class="preprocessor">#else</span>
01093 <span class="preprocessor"></span>        <span class="keywordflow">else</span> {
01094             TransBuffer = (PWCHAR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a> * <span class="keyword">sizeof</span>(WCHAR));
01095             <span class="keywordflow">if</span> (TransBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01096                 <span class="keywordflow">return</span> (ULONG)STATUS_NO_MEMORY;
01097             }
01098             a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o8">StackBuffer</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01099         }
01100 <span class="preprocessor">#endif</span>
01101 <span class="preprocessor"></span>        <span class="comment">//a-&gt;NumBytes = ConvertOutputToUnicode(Console-&gt;OutputCP,</span>
01102         <span class="comment">//                        Buffer,</span>
01103         <span class="comment">//                        a-&gt;NumBytes,</span>
01104         <span class="comment">//                        TransBuffer,</span>
01105         <span class="comment">//                        a-&gt;NumBytes);</span>
01106         <span class="comment">// same as ConvertOutputToUnicode</span>
01107 <span class="preprocessor">#ifdef WWSB_FE</span>
01108 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (! ScreenInfo-&gt;WriteConsoleDbcsLeadByte[0]) {
01109             NumBytes1 = 0;
01110             NumBytes2 = a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a>;
01111         }
01112         <span class="keywordflow">else</span> {
01113             <span class="keywordflow">if</span> (*(PUCHAR)a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o3">BufPtr</a> &lt; (UCHAR)<span class="charliteral">' '</span>) {
01114                 NumBytes1 = 0;
01115                 NumBytes2 = a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a>;
01116             }
01117             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a>) {
01118                 ScreenInfo-&gt;WriteConsoleDbcsLeadByte[1] = *(PCHAR)a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o3">BufPtr</a>;
01119                 NumBytes1 = <span class="keyword">sizeof</span>(ScreenInfo-&gt;WriteConsoleDbcsLeadByte);
01120                 <span class="keywordflow">if</span> (Console-&gt;OutputCP == <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a>) {
01121                     <span class="keywordflow">if</span> ((ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) &amp;&amp;
01122                             ((Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN) == 0)) {
01123                         <span class="comment">/*</span>
01124 <span class="comment">                         * Translate OEM characters into False Unicode for Window-mode</span>
01125 <span class="comment">                         * OEM font. If OutputCP != OEMCP, characters will not appear</span>
01126 <span class="comment">                         * correctly, because the OEM fonts are designed to support</span>
01127 <span class="comment">                         * only OEMCP (we can't switch fonts in Windowed mode).</span>
01128 <span class="comment">                         * Fullscreen or TT "Unicode" fonts should be used for</span>
01129 <span class="comment">                         * non-OEMCP output</span>
01130 <span class="comment">                         */</span>
01131                         <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"SrvWriteConsole ACP-&gt;U %.*s\n"</span>,
01132                                 <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(NumBytes1,10), a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o3">BufPtr</a>));
01133                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d6/nlsxlat_8c.html#a31">RtlConsoleMultiByteToUnicodeN</a>(TransBuffer,
01134                                 NumBytes1 * <span class="keyword">sizeof</span>(WCHAR), &amp;NumBytes1,
01135                                 ScreenInfo-&gt;WriteConsoleDbcsLeadByte, NumBytes1, &amp;SpecialChars);
01136                     } <span class="keywordflow">else</span> {
01137                         <span class="comment">/*</span>
01138 <span class="comment">                         * Good! We have Fullscreen or TT "Unicode" fonts, so convert</span>
01139 <span class="comment">                         * the OEM characters to real Unicode according to OutputCP.</span>
01140 <span class="comment">                         * First find out if any special chars are involved.</span>
01141 <span class="comment">                         */</span>
01142                         <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"SrvWriteConsole %d-&gt;U %.*s\n"</span>, Console-&gt;OutputCP,
01143                                 <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(NumBytes1,10), a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o3">BufPtr</a>));
01144                         NumBytes1 = <span class="keyword">sizeof</span>(WCHAR) * MultiByteToWideChar(Console-&gt;OutputCP,
01145                                 0, ScreenInfo-&gt;WriteConsoleDbcsLeadByte, NumBytes1, TransBuffer, NumBytes1);
01146                         <span class="keywordflow">if</span> (NumBytes1 == 0) {
01147                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
01148                         }
01149                     }
01150                 }
01151                 <span class="keywordflow">else</span> {
01152                     <span class="keywordflow">if</span> ((ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) &amp;&amp;
01153                         !(Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN)) {
01154                         <span class="keywordflow">if</span> (Console-&gt;OutputCP != <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a3">WINDOWSCP</a>)
01155                             Codepage = <a class="code" href="../../d0/d3/dbcs_8h.html#a5">USACP</a>;
01156                         <span class="keywordflow">else</span>
01157                             Codepage = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a3">WINDOWSCP</a>;
01158                     } <span class="keywordflow">else</span> {
01159                         Codepage = Console-&gt;OutputCP;
01160                     }
01161 
01162                     <span class="keywordflow">if</span> ((ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) &amp;&amp;
01163                             ((Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN) == 0)) {
01164                         NumBytes1 = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a37">ConvertOutputToUnicode</a>(Codepage,
01165                                                            ScreenInfo-&gt;WriteConsoleDbcsLeadByte,
01166                                                            NumBytes1,
01167                                                            TransBuffer,
01168                                                            NumBytes1);
01169                     }
01170                     <span class="keywordflow">else</span> {
01171                         NumBytes1 = MultiByteToWideChar(Console-&gt;OutputCP,
01172                                 0, ScreenInfo-&gt;WriteConsoleDbcsLeadByte, NumBytes1, TransBuffer, NumBytes1);
01173                         <span class="keywordflow">if</span> (NumBytes1 == 0) {
01174                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
01175                         }
01176                     }
01177                     NumBytes1 *= <span class="keyword">sizeof</span>(WCHAR);
01178                 }
01179                 TransBuffer++;
01180                 (PCHAR)a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o3">BufPtr</a> += (NumBytes1 / <span class="keyword">sizeof</span>(WCHAR));
01181                 NumBytes2 = a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a> - 1;
01182             }
01183             <span class="keywordflow">else</span> {
01184                 NumBytes2 = 0;
01185             }
01186             ScreenInfo-&gt;WriteConsoleDbcsLeadByte[0] = 0;
01187         }
01188 
01189         <span class="keywordflow">if</span> (NumBytes2 &amp;&amp;
01190             <a class="code" href="../../d0/d3/dbcs_8h.html#a30">CheckBisectStringA</a>(Console-&gt;OutputCP,a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o3">BufPtr</a>,NumBytes2,&amp;Console-&gt;OutputCPInfo)) {
01191             ScreenInfo-&gt;WriteConsoleDbcsLeadByte[0] = *((PCHAR)a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o3">BufPtr</a>+NumBytes2-1);
01192             NumBytes2--;
01193         }
01194 
01195         Length = NumBytes2;
01196 <span class="preprocessor">#else</span>
01197 <span class="preprocessor"></span>        Length = a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a>;
01198         <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a> &gt;= 2 &amp;&amp;
01199             ((PCHAR)a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o3">BufPtr</a>)[a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a>-1] == <span class="charliteral">'\n'</span> &amp;&amp;
01200             ((PCHAR)a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o3">BufPtr</a>)[a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a>-2] == <span class="charliteral">'\r'</span>) {
01201             Length -= 2;
01202             a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o9">WriteFlags</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a10">WRITE_CR_LF</a>;
01203         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a> &gt;= 1 &amp;&amp;
01204                    ((PCHAR)a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o3">BufPtr</a>)[a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a>-1] == <span class="charliteral">'\r'</span>) {
01205             Length -= 1;
01206             a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o9">WriteFlags</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a9">WRITE_CR</a>;
01207         } <span class="keywordflow">else</span> {
01208             a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o9">WriteFlags</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a8">WRITE_NO_CR_LF</a>;
01209         }
01210 <span class="preprocessor">#endif</span>
01211 <span class="preprocessor"></span>
01212         <span class="keywordflow">if</span> (Length != 0) {
01213             <span class="keywordflow">if</span> (Console-&gt;OutputCP == <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a>) {
01214                 <span class="keywordflow">if</span> ((ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) &amp;&amp;
01215                         ((Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN) == 0)) {
01216                     <span class="comment">/*</span>
01217 <span class="comment">                     * Translate OEM characters into UnicodeOem for the Window-mode</span>
01218 <span class="comment">                     * OEM font. If OutputCP != OEMCP, characters will not appear</span>
01219 <span class="comment">                     * correctly, because the OEM fonts are designed to support</span>
01220 <span class="comment">                     * only OEMCP (we can't switch fonts in Windowed mode).</span>
01221 <span class="comment">                     * Fullscreen or TT "Unicode" fonts should be used for</span>
01222 <span class="comment">                     * non-OEMCP output</span>
01223 <span class="comment">                     */</span>
01224                     <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"SrvWriteConsole ACP-&gt;U %.*s\n"</span>,
01225                             <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(Length,10), a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o3">BufPtr</a>));
01226                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d6/nlsxlat_8c.html#a31">RtlConsoleMultiByteToUnicodeN</a>(TransBuffer,
01227                             Length * <span class="keyword">sizeof</span>(WCHAR), &amp;Length,
01228                             a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o3">BufPtr</a>, Length, &amp;SpecialChars);
01229                 } <span class="keywordflow">else</span> {
01230                     <span class="comment">/*</span>
01231 <span class="comment">                     * Good! We have Fullscreen or TT "Unicode" fonts, so convert</span>
01232 <span class="comment">                     * the OEM characters to real Unicode according to OutputCP.</span>
01233 <span class="comment">                     * First find out if any special chars are involved.</span>
01234 <span class="comment">                     */</span>
01235 <span class="preprocessor">#ifdef WWSB_NOFE</span>
01236 <span class="preprocessor"></span>                    <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> i;
01237                     <span class="keywordflow">for</span> (i = 0; i &lt; Length; i++) {
01238                         <span class="keywordflow">if</span> (((PCHAR)a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o3">BufPtr</a>)[i] &lt; 0x20) {
01239                             SpecialChars = 1;
01240                             <span class="keywordflow">break</span>;
01241                         }
01242                     }
01243 <span class="preprocessor">#endif</span>
01244 <span class="preprocessor"></span>                    <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"SrvWriteConsole %d-&gt;U %.*s\n"</span>, Console-&gt;OutputCP,
01245                             <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(Length,10), a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o3">BufPtr</a>));
01246                     Length = <span class="keyword">sizeof</span>(WCHAR) * MultiByteToWideChar(Console-&gt;OutputCP,
01247                             0, a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o3">BufPtr</a>, Length, TransBuffer, Length);
01248                     <span class="keywordflow">if</span> (Length == 0) {
01249                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
01250                     }
01251                 }
01252             }
01253             <span class="keywordflow">else</span>
01254             {
01255                 <span class="keywordflow">if</span> ((ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) &amp;&amp;
01256                     !(Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN)) {
01257                     <span class="keywordflow">if</span> (Console-&gt;OutputCP != <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a3">WINDOWSCP</a>)
01258                         Codepage = <a class="code" href="../../d0/d3/dbcs_8h.html#a5">USACP</a>;
01259                     <span class="keywordflow">else</span>
01260                         Codepage = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a3">WINDOWSCP</a>;
01261                 } <span class="keywordflow">else</span> {
01262                     Codepage = Console-&gt;OutputCP;
01263                 }
01264 
01265                 <span class="keywordflow">if</span> ((ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) &amp;&amp;
01266                         ((Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN) == 0)) {
01267                     Length = <span class="keyword">sizeof</span>(WCHAR) * <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a37">ConvertOutputToUnicode</a>(Codepage,
01268                                                                     a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o3">BufPtr</a>,
01269                                                                     Length,
01270                                                                     TransBuffer,
01271                                                                     Length);
01272                 }
01273                 <span class="keywordflow">else</span> {
01274                     Length = <span class="keyword">sizeof</span>(WCHAR) * MultiByteToWideChar(Console-&gt;OutputCP,
01275                             0, a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o3">BufPtr</a>, Length, TransBuffer, Length);
01276                     <span class="keywordflow">if</span> (Length == 0) {
01277                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
01278                     }
01279                 }
01280 
01281 <span class="preprocessor">#ifdef WWSB_NOFE</span>
01282 <span class="preprocessor"></span>                SpecialChars = 1;
01283 <span class="preprocessor">#endif</span>
01284 <span class="preprocessor"></span>            }
01285         }
01286 
01287 <span class="preprocessor">#ifdef WWSB_FE</span>
01288 <span class="preprocessor"></span>        NumBytes2 = Length;
01289 
01290         <span class="keywordflow">if</span> ((NumBytes1+NumBytes2) == 0) {
01291             <span class="keywordflow">if</span> (!a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o8">StackBuffer</a> &amp;&amp; fLocalHeap) {
01292                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o5">TransBuffer</a>);
01293             }
01294             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01295         }
01296 <span class="preprocessor">#else</span>
01297 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01298             <span class="keywordflow">if</span> (!a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o8">StackBuffer</a>) {
01299                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TransBuffer);
01300             }
01301             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01302         }
01303 <span class="preprocessor">#endif</span>
01304 <span class="preprocessor"></span>
01305 <span class="preprocessor">#ifdef WWSB_FE</span>
01306 <span class="preprocessor"></span>        Console-&gt;WriteConOutNumBytesTemp = a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a>;
01307         a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a> = Console-&gt;WriteConOutNumBytesUnicode = NumBytes1 + NumBytes2;
01308         a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o9">WriteFlags</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a11">WRITE_SPECIAL_CHARS</a>;
01309         a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o5">TransBuffer</a> = TmpTransBuffer;
01310 <span class="preprocessor">#else</span>
01311 <span class="preprocessor"></span>        <a class="code" href="../../d8/d5/consrv_8h.html#a3">DBGOUTPUT</a>((<span class="stringliteral">"TransBuffer=%lx, Length = %x(bytes), SpecialChars=%lx\n"</span>,
01312                 TransBuffer, Length, SpecialChars));
01313         a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a> = Length + (a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o9">WriteFlags</a> * <span class="keyword">sizeof</span>(WCHAR));
01314         <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o9">WriteFlags</a> == <a class="code" href="../../d0/d7/server_2stream_8c.html#a10">WRITE_CR_LF</a>) {
01315             TransBuffer[(Length+<span class="keyword">sizeof</span>(WCHAR))/<span class="keyword">sizeof</span>(WCHAR)] = <a class="code" href="../../d4/d5/conimep_8h.html#a54">UNICODE_LINEFEED</a>;
01316             TransBuffer[Length/<span class="keyword">sizeof</span>(WCHAR)] = <a class="code" href="../../d4/d5/conimep_8h.html#a53">UNICODE_CARRIAGERETURN</a>;
01317         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o9">WriteFlags</a> == <a class="code" href="../../d0/d7/server_2stream_8c.html#a9">WRITE_CR</a>) {
01318             TransBuffer[Length/<span class="keyword">sizeof</span>(WCHAR)] = <a class="code" href="../../d4/d5/conimep_8h.html#a53">UNICODE_CARRIAGERETURN</a>;
01319         }
01320         <span class="keywordflow">if</span> (SpecialChars) {
01321             <span class="comment">// CRLF didn't get translated</span>
01322             a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o9">WriteFlags</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a11">WRITE_SPECIAL_CHARS</a>;
01323         }
01324         a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o5">TransBuffer</a> = TransBuffer;
01325 <span class="preprocessor">#endif</span>
01326 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
01327         <span class="keywordflow">if</span> ((ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) &amp;&amp;
01328                     ((Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN) == 0)) {
01329             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a42">RealUnicodeToFalseUnicode</a>(a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o3">BufPtr</a>,
01330                     a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a> / <span class="keyword">sizeof</span>(WCHAR), Console-&gt;OutputCP);
01331             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01332                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01333             }
01334         }
01335         a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o9">WriteFlags</a> = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1;
01336         a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o5">TransBuffer</a> = a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o3">BufPtr</a>;
01337     }
01338     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d3/__stream_8h.html#a4">WWSB_DoWriteConsole</a>(m,Console,CSR_SERVER_QUERYCLIENTTHREAD());
01339     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d1/d7/server_8h.html#a64">CONSOLE_STATUS_WAIT</a>) {
01340         *ReplyStatus = CsrReplyPending;
01341         <span class="keywordflow">return</span> (ULONG)STATUS_SUCCESS;
01342     } <span class="keywordflow">else</span> {
01343         <span class="keywordflow">if</span> (!a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o7">Unicode</a>) {
01344 <span class="preprocessor">#ifdef WWSB_FE</span>
01345 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a> == Console-&gt;WriteConOutNumBytesUnicode)
01346                 a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a> = Console-&gt;WriteConOutNumBytesTemp;
01347             <span class="keywordflow">else</span>
01348                 a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a> /= <span class="keyword">sizeof</span>(WCHAR);
01349             <span class="keywordflow">if</span> (!a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o8">StackBuffer</a> &amp;&amp; fLocalHeap) {
01350                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o5">TransBuffer</a>);
01351             }
01352 <span class="preprocessor">#else</span>
01353 <span class="preprocessor"></span>            a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a> /= <span class="keyword">sizeof</span>(WCHAR);
01354             <span class="keywordflow">if</span> (!a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o8">StackBuffer</a>) {
01355                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o5">TransBuffer</a>);
01356             }
01357 <span class="preprocessor">#endif</span>
01358 <span class="preprocessor"></span>        }
01359     }
01360     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01361 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:12 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
