<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ppc/setdirty.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>setdirty.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d2/d7/ppc_2setdirty_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/ppc_2setdirty_8c.html#a0">MiSetDirtyBit</a> (IN PVOID FaultingAddress, IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte, IN ULONG PfnHeld)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a0" doxytag="ppc/setdirty.c::MiSetDirtyBit" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiSetDirtyBit           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>FaultingAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PointerPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PfnHeld</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/ppc_2setdirty_8c-source.html#l00029">29</a> of file <a class="el" href="../../d2/d7/ppc_2setdirty_8c-source.html">ppc/setdirty.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01313">MI_SET_ACCESSED_IN_PTE</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l01014">MiReleasePageFileSpace()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00439">MM_PTE_DIRTY</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>.
<p>
<pre class="fragment"><div>00037                    :
00038 
00039     This routine sets dirty in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified PTE and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> modify bit in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00040     correpsonding PFN element.  If any page <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> space <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allocated, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
00041     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> deallocated.
00042 
00043 Arguments:
00044 
00045     FaultingAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> faulting address.
00046 
00047     PointerPte - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding valid PTE.
00048 
00049     PfnHeld - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN mutex <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already held.
00050 
00051 Return Value:
00052 
00053     None.
00054 
00055 Environment:
00056 
00057     Kernel mode, APC's disabled, Working set mutex held.
00058 
00059 --*/
00060 
00061 {
00062     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00063     ULONG PageFrameIndex;
00064     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00065     KIRQL OldIrql;
00066 
00067     <span class="comment">//</span>
00068     <span class="comment">// The page is NOT copy on write, update the PTE setting both the</span>
00069     <span class="comment">// dirty bit and the accessed bit. Note, that as this PTE is in</span>
00070     <span class="comment">// the TB, the TB must be flushed.</span>
00071     <span class="comment">//</span>
00072 
00073     PageFrameIndex = PointerPte-&gt;u.Hard.PageFrameNumber;
00074     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
00075 
00076     TempPte = *PointerPte;
00077     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Dirty = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a99">MM_PTE_DIRTY</a>;
00078     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a137">MI_SET_ACCESSED_IN_PTE</a> (&amp;TempPte, 1);
00079     *PointerPte = TempPte;
00080 
00081     <span class="comment">//</span>
00082     <span class="comment">// Check state of PFN mutex and if not held, don't update PFN database.</span>
00083     <span class="comment">//</span>
00084 
00085 
00086     <span class="keywordflow">if</span> (PfnHeld) {
00087 
00088         <span class="comment">//</span>
00089         <span class="comment">// Set the modified field in the PFN database, also, if the phyiscal</span>
00090         <span class="comment">// page is currently in a paging file, free up the page file space</span>
00091         <span class="comment">// as the contents are now worthless.</span>
00092         <span class="comment">//</span>
00093 
00094         <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
00095                              (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress == 0)) {
00096 
00097             <span class="comment">//</span>
00098             <span class="comment">// This page is in page file format, deallocate the page file space.</span>
00099             <span class="comment">//</span>
00100 
00101             <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
00102 
00103             <span class="comment">//</span>
00104             <span class="comment">// Change original PTE to indicate no page file space is reserved,</span>
00105             <span class="comment">// otherwise the space will be deallocated when the PTE is</span>
00106             <span class="comment">// deleted.</span>
00107             <span class="comment">//</span>
00108 
00109             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh = 0;
00110         }
00111 
00112         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 1;
00113     }
00114 
00115     <span class="comment">//</span>
00116     <span class="comment">// The TB entry must be flushed as the valid PTE with the dirty bit clear</span>
00117     <span class="comment">// has been fetched into the TB. If it isn't flushed, another fault</span>
00118     <span class="comment">// is generated as the dirty bit is not set in the cached TB entry.</span>
00119     <span class="comment">//</span>
00120 
00121     KeFillEntryTb ((PHARDWARE_PTE)PointerPte, FaultingAddress, TRUE);
00122 
00123     <span class="keywordflow">return</span>;
00124 }
}
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:38 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
