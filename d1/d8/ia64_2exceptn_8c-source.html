<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: exceptn.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>exceptn.c</h1><a href="../../d0/d9/ia64_2exceptn_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Module Name:</span>
00004 <span class="comment"></span>
00005 <span class="comment">    exceptn.c</span>
00006 <span class="comment"></span>
00007 <span class="comment">Abstract:</span>
00008 <span class="comment"></span>
00009 <span class="comment">    This module implement the code necessary to dispatch expections to the</span>
00010 <span class="comment">    proper mode and invoke the exception dispatcher.</span>
00011 <span class="comment"></span>
00012 <span class="comment">Author:</span>
00013 <span class="comment"></span>
00014 <span class="comment">    William K. Cheung (wcheung) 10-Nov-1995</span>
00015 <span class="comment"></span>
00016 <span class="comment">Environment:</span>
00017 <span class="comment"></span>
00018 <span class="comment">    Kernel mode only.</span>
00019 <span class="comment"></span>
00020 <span class="comment">Revision History:</span>
00021 <span class="comment"></span>
00022 <span class="comment">--*/</span>
00023 
00024 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00025 <span class="preprocessor">#include "<a class="code" href="../../d1/d8/ntfpia64_8h.html">ntfpia64.h</a>"</span>
00026 
00027 <span class="comment">//</span>
00028 <span class="comment">// IA64 data misalignment exception (auto alignment fixup) control.</span>
00029 <span class="comment">//</span>
00030 <span class="comment">// If KiEnableAlignmentFaultExceptions is 0, then no alignment</span>
00031 <span class="comment">// exceptions are raised and all misaligned user and kernel mode data</span>
00032 <span class="comment">// references are emulated. This is consistent with NT/Alpha version</span>
00033 <span class="comment">// 3.1 behavior.</span>
00034 <span class="comment">//</span>
00035 <span class="comment">// If KiEnableAlignmentFaultExceptions is 1, then the</span>
00036 <span class="comment">// current thread automatic alignment fixup enable determines whether</span>
00037 <span class="comment">// emulation is attempted in user mode. This is consistent with NT/Mips</span>
00038 <span class="comment">// behavior.</span>
00039 <span class="comment">//</span>
00040 <span class="comment">// If KiEnableAlignmentFaultExceptions is 2 and the process is being</span>
00041 <span class="comment">// debugged, the current thread automatic alignment fixup enable determines</span>
00042 <span class="comment">// whether emulation is attempted in user mode. This allows developers to</span>
00043 <span class="comment">// easily find and fix alignment problems.</span>
00044 <span class="comment">//</span>
00045 <span class="comment">// If KiEnableAlignmentFaultExceptions is 2 and the process is NOT being</span>
00046 <span class="comment">// debugged, then no alignment exceptions are raised and all misaligned</span>
00047 <span class="comment">// user and kernel mode data references are emulated.</span>
00048 <span class="comment">//</span>
00049 <span class="comment">// N.B. This default value may be reset from the Registry during init.</span>
00050 <span class="comment">//</span>
00051 
<a name="l00052"></a><a class="code" href="../../d0/d9/ia64_2exceptn_8c.html#a0">00052</a> <span class="preprocessor">#define DEFAULT_NO_ALIGNMENT_FIXUPS FALSE</span>
00053 <span class="preprocessor"></span>
<a name="l00054"></a><a class="code" href="../../d0/d9/ia64_2exceptn_8c.html#a1">00054</a> ULONG <a class="code" href="../../d8/d8/alpha_2exceptn_8c.html#a1">KiEnableAlignmentFaultExceptions</a> = <a class="code" href="../../d8/d8/alpha_2exceptn_8c.html#a0">DEFAULT_NO_ALIGNMENT_FIXUPS</a> ? 1 : 2;
00055 
00056 <span class="preprocessor">#if DBG</span>
00057 <span class="preprocessor"></span>
00058 <span class="comment">//</span>
00059 <span class="comment">// Set KiBreakOnAlignmentFault to TRUE to stop the debugger on each alignment</span>
00060 <span class="comment">// fault.</span>
00061 <span class="comment">//</span>
00062 
00063 BOOLEAN KiBreakOnAlignmentFault = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00064 
00065 <span class="comment">//</span>
00066 <span class="comment">// Alignment fixups are counted by mode and reported at intervals.</span>
00067 <span class="comment">//</span>
00068 <span class="comment">// N.B. Set masks to 0 to see every exception (set to 0x7 to see every</span>
00069 <span class="comment">//      8th, etc.).</span>
00070 <span class="comment">//</span>
00071 
00072 ULONG KiKernelFixupCount = 0;
00073 ULONG KiKernelFixupMask = <a class="code" href="../../d8/d8/alpha_2exceptn_8c.html#a0">DEFAULT_NO_ALIGNMENT_FIXUPS</a> ? 0 : 0x7f;
00074 
00075 ULONG KiUserFixupCount = 0;
00076 ULONG KiUserFixupMask = <a class="code" href="../../d8/d8/alpha_2exceptn_8c.html#a0">DEFAULT_NO_ALIGNMENT_FIXUPS</a> ? 0 : 0x3ff;
00077 
00078 <span class="preprocessor">#endif</span>
00079 <span class="preprocessor"></span>
00080 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00081 <a class="code" href="../../d0/d9/ia64_2exceptn_8c.html#a2">KiRestoreHigherFPVolatile</a>(
00082     VOID
00083     );
00084 
00085 LONG
00086 <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a91">fp_emulate</a> (
00087     ULONG trap_type,
00088     PVOID pbundle,
00089     ULONGLONG *pipsr,
00090     ULONGLONG *pfpsr,
00091     ULONGLONG *pisr,
00092     ULONGLONG *ppreds,
00093     ULONGLONG *pifs,
00094     PVOID fp_state
00095     );
00096 
00097 BOOLEAN
<a name="l00098"></a><a class="code" href="../../d0/d9/ia64_2exceptn_8c.html#a4">00098</a> <a class="code" href="../../d0/d9/ia64_2exceptn_8c.html#a4">KiEmulateFloat</a> (
00099     PEXCEPTION_RECORD ExceptionRecord,
00100     PKEXCEPTION_FRAME ExceptionFrame,
00101     PKTRAP_FRAME TrapFrame
00102     )
00103 {
00104 
00105     <a class="code" href="../../d8/d2/struct__FLOATING__POINT__STATE.html">FLOATING_POINT_STATE</a> FpState;
00106     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a>;
00107     ULONG TrapType;
00108     PVOID ExceptionAddress;
00109     LONG <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = -1;
00110 
00111     FpState.<a class="code" href="../../d8/d2/struct__FLOATING__POINT__STATE.html#o1">ExceptionFrame</a> = (PVOID)ExceptionFrame;
00112     FpState.<a class="code" href="../../d8/d2/struct__FLOATING__POINT__STATE.html#o0">TrapFrame</a> = (PVOID)TrapFrame;
00113 
00114     <span class="keywordflow">if</span> (ExceptionRecord-&gt;ExceptionCode == STATUS_FLOAT_MULTIPLE_FAULTS) {
00115         TrapType = 1;
00116         ExceptionAddress = (PVOID)TrapFrame-&gt;StIIP;
00117     } <span class="keywordflow">else</span> {
00118         TrapType = 0;
00119         ExceptionAddress = (PVOID)TrapFrame-&gt;StIIPA;
00120     }
00121 
00122     <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a91">fp_emulate</a>(TrapType, ExceptionAddress,
00123                       &amp;TrapFrame-&gt;StIPSR, &amp;TrapFrame-&gt;StFPSR, &amp;TrapFrame-&gt;StISR,
00124                       &amp;TrapFrame-&gt;Preds, &amp;TrapFrame-&gt;StIFS, (PVOID)&amp;FpState)) == 0) {
00125 
00126        <span class="comment">//</span>
00127        <span class="comment">// Exception was handled and state modified.</span>
00128        <span class="comment">// Therefore the context frame does not need to</span>
00129        <span class="comment">// be transfered to the trap and exception frames.</span>
00130        <span class="comment">//</span>
00131        <span class="comment">// Since it was fault, PC should be advanced</span>
00132        <span class="comment">//</span>
00133 
00134        <span class="keywordflow">if</span> (TrapType == 1) {
00135            <a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a13">KiAdvanceInstPointer</a>(TrapFrame);
00136        }
00137 
00138        <span class="keywordflow">if</span> (TrapFrame-&gt;StIPSR &amp; (1 &lt;&lt; PSR_MFH)) {
00139 
00140            <span class="comment">//</span>
00141            <span class="comment">// high fp set is modified, reload high fp register set</span>
00142            <span class="comment">// must prevent interrupt during restore</span>
00143            <span class="comment">//</span>
00144 
00145            __rsm ((1 &lt;&lt; PSR_DFH) | (1 &lt;&lt; PSR_I));
00146            <a class="code" href="../../d0/d9/ia64_2exceptn_8c.html#a2">KiRestoreHigherFPVolatile</a>();
00147            __ssm ((1 &lt;&lt; PSR_DFH) | (1 &lt;&lt; PSR_I));
00148            __dsrlz();
00149        }
00150 
00151        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00152     }
00153 
00154     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == -1) {
00155         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(FP_EMULATION_ERROR, 
00156                      (ULONG_PTR)TrapFrame, 
00157                      (ULONG_PTR)ExceptionFrame, 0, 0);
00158     } 
00159 
00160     <a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)TrapFrame-&gt;StISR;
00161 
00162     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> &amp; 0x1) {
00163 
00164         ExceptionRecord-&gt;ExceptionInformation[4] = TrapFrame-&gt;StISR;
00165 
00166         <span class="keywordflow">if</span> (!(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> &amp; 0x4)) {
00167             <span class="keywordflow">if</span> (TrapType == 1) {
00168 
00169                 <span class="comment">//</span>
00170                 <span class="comment">// FP Fault</span>
00171                 <span class="comment">//</span>
00172 
00173                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a> &amp; 0x11) {
00174                     ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_INVALID_OPERATION;
00175                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a> &amp; 0x22) {
00176                     ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_DENORMAL_OPERAND;
00177                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a> &amp; 0x44) {
00178                     ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_DIVIDE_BY_ZERO;
00179                 }
00180 
00181             } <span class="keywordflow">else</span> {
00182 
00183                 <span class="comment">//</span>
00184                 <span class="comment">// FP Trap</span>
00185                 <span class="comment">//</span>
00186 
00187                 <a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a> = <a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a> &gt;&gt; 7;
00188                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a> &amp; 0x11) {
00189                     ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_OVERFLOW;
00190                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a> &amp; 0x22) {
00191                     ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_UNDERFLOW;
00192                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a> &amp; 0x44) {
00193                     ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_INEXACT_RESULT;
00194                 }
00195 
00196             }
00197         }
00198 
00199         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> &amp; 0x2) {
00200 
00201             <span class="comment">//</span>
00202             <span class="comment">// FP Fault To Trap</span>
00203             <span class="comment">//</span>
00204 
00205             <a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a13">KiAdvanceInstPointer</a>(TrapFrame);
00206             ExceptionRecord-&gt;ExceptionAddress =
00207                 (PVOID) RtlIa64InsertIPSlotNumber
00208                             (TrapFrame-&gt;StIIP,
00209                              ((TrapFrame-&gt;StISR &amp; ISR_EI_MASK) &gt;&gt; ISR_EI)
00210                             );
00211             <span class="keywordflow">if</span> (!(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> &amp; 0x4)) {
00212                 <a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a> = <a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a> &gt;&gt; 7;
00213                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a> &amp; 0x11) {
00214                     ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_OVERFLOW;
00215                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a> &amp; 0x22) {
00216                     ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_UNDERFLOW;
00217                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a> &amp; 0x44) {
00218                     ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_INEXACT_RESULT;
00219                 }
00220             } <span class="keywordflow">else</span> {
00221                 ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_MULTIPLE_TRAPS;
00222             }
00223         }
00224     }
00225 
00226     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00227 }
00228 
00229 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00230"></a><a class="code" href="../../d0/d9/ia64_2exceptn_8c.html#a5">00230</a> <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a11">KiDispatchException</a> (
00231     IN PEXCEPTION_RECORD ExceptionRecord,
00232     IN PKEXCEPTION_FRAME ExceptionFrame,
00233     IN PKTRAP_FRAME TrapFrame,
00234     IN KPROCESSOR_MODE PreviousMode,
00235     IN BOOLEAN FirstChance
00236     )
00237 
00238 <span class="comment">/*++</span>
00239 <span class="comment"></span>
00240 <span class="comment">Routine Description:</span>
00241 <span class="comment"></span>
00242 <span class="comment">    This function is called to dispatch an exception to the proper mode and</span>
00243 <span class="comment">    to cause the exception dispatcher to be called.</span>
00244 <span class="comment"></span>
00245 <span class="comment">    If the exception is a data misalignment, this is the first chance for</span>
00246 <span class="comment">    handling the exception, and the current thread has enabled automatic</span>
00247 <span class="comment">    alignment fixup, then an attempt is made to emulate the unaligned</span>
00248 <span class="comment">    reference.</span>
00249 <span class="comment"></span>
00250 <span class="comment">    If the exception is a floating exception (N.B. the pseudo status</span>
00251 <span class="comment">    STATUS_FLOAT_STACK_CHECK is used to signify this and is converted to the</span>
00252 <span class="comment">    proper code by examiningg the main status field of the floating point </span>
00253 <span class="comment">    status register).</span>
00254 <span class="comment"></span>
00255 <span class="comment">    If the exception is neither a data misalignment nor a floating point</span>
00256 <span class="comment">    exception and the the previous mode is kernel, then the exception</span>
00257 <span class="comment">    dispatcher is called directly to process the exception. Otherwise the</span>
00258 <span class="comment">    exception record, exception frame, and trap frame contents are copied</span>
00259 <span class="comment">    to the user mode stack. The contents of the exception frame and trap</span>
00260 <span class="comment">    are then modified such that when control is returned, execution will</span>
00261 <span class="comment">    commense in user mode in a routine which will call the exception</span>
00262 <span class="comment">    dispatcher.</span>
00263 <span class="comment"></span>
00264 <span class="comment">Arguments:</span>
00265 <span class="comment"></span>
00266 <span class="comment">    ExceptionRecord - Supplies a pointer to an exception record.</span>
00267 <span class="comment"></span>
00268 <span class="comment">    ExceptionFrame - Supplies a pointer to an exception frame.</span>
00269 <span class="comment"></span>
00270 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame.</span>
00271 <span class="comment"></span>
00272 <span class="comment">    PreviousMode - Supplies the previous processor mode.</span>
00273 <span class="comment"></span>
00274 <span class="comment">    FirstChance - Supplies a boolean variable that specifies whether this</span>
00275 <span class="comment">        is the first (TRUE) or second (FALSE) time that this exception has</span>
00276 <span class="comment">        been processed.</span>
00277 <span class="comment"></span>
00278 <span class="comment">Return Value:</span>
00279 <span class="comment"></span>
00280 <span class="comment">    None.</span>
00281 <span class="comment"></span>
00282 <span class="comment">--*/</span>
00283 
00284 {
00285 
00286     CONTEXT ContextFrame;
00287     EXCEPTION_RECORD ExceptionRecord1;
00288     PPLABEL_DESCRIPTOR Plabel;
00289     BOOLEAN UserApcPending;
00290 
00291     <span class="comment">//</span>
00292     <span class="comment">// If the exception is a data misalignment, the previous mode was user,</span>
00293     <span class="comment">// this is the first chance for handling the exception, and the current</span>
00294     <span class="comment">// thread has enabled automatic alignment fixup, then attempt to emulate</span>
00295     <span class="comment">// the unaligned reference.</span>
00296     <span class="comment">//</span>
00297 
00298 <span class="preprocessor">#if DBG</span>
00299 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (KiBreakOnAlignmentFault != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00300 
00301         <span class="keywordflow">if</span> (ExceptionRecord-&gt;ExceptionCode == STATUS_DATATYPE_MISALIGNMENT) {
00302 
00303             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KI: Alignment fault exr = %p Pc = %p Address = %p\n"</span>,
00304                      ExceptionRecord,
00305                      ExceptionRecord-&gt;ExceptionAddress,
00306                      ExceptionRecord-&gt;ExceptionInformation[2]);
00307 
00308             DbgBreakPoint();
00309         }
00310     }
00311 <span class="preprocessor">#endif</span>
00312 <span class="preprocessor"></span>
00313     <span class="keywordflow">if</span> ((ExceptionRecord-&gt;ExceptionCode == STATUS_DATATYPE_MISALIGNMENT) &amp;&amp;
00314         (FirstChance != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00315 
00316 <span class="preprocessor">#if DBG</span>
00317 <span class="preprocessor"></span>
00318         <span class="comment">//</span>
00319         <span class="comment">// Count alignment faults by mode and display them at intervals.</span>
00320         <span class="comment">//</span>
00321 
00322         <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00323             KiKernelFixupCount += 1;
00324             <span class="keywordflow">if</span> ((KiKernelFixupCount &amp; KiKernelFixupMask) == 0) {
00325                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KI: Kernel Fixup: Pid=0x%.3lx, Pc=%.16p, Address=%.16p ... Total=%ld\n"</span>,
00326                          <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;UniqueProcessId,
00327                          ExceptionRecord-&gt;ExceptionAddress,
00328                          ExceptionRecord-&gt;ExceptionInformation[1],
00329                          KiKernelFixupCount);
00330             }
00331 
00332         } <span class="keywordflow">else</span> {
00333             KiUserFixupCount += 1;
00334             <span class="keywordflow">if</span> ((KiUserFixupCount &amp; KiUserFixupMask) == 0) {
00335                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KI: User  Fixup: Pid=0x%.3lx, Pc=%.16p, Address=%.16p ... Total=%ld\n"</span>,
00336                          <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;UniqueProcessId,
00337                          ExceptionRecord-&gt;ExceptionAddress,
00338                          ExceptionRecord-&gt;ExceptionInformation[1],
00339                          KiUserFixupCount);
00340             }
00341         }
00342 
00343 <span class="preprocessor">#endif</span>
00344 <span class="preprocessor"></span>
00345         <span class="comment">//</span>
00346         <span class="comment">// If alignment fault exceptions are not enabled, then no exception</span>
00347         <span class="comment">// should be raised and the data reference should be emulated.</span>
00348         <span class="comment">//</span>
00349         <span class="comment">// We will emulate the reference if</span>
00350         <span class="comment">//      KiEnableAlignmentFaultExceptions == 0 (always fix up all faults, the default)</span>
00351         <span class="comment">// OR   The thread has explicitly enabled alignment fixups</span>
00352         <span class="comment">// OR   KiEnableAlignmentFaultExceptions == 2 and the process is not being debugged</span>
00353         <span class="comment">//</span>
00354 
00355         <span class="keywordflow">if</span> ( (<a class="code" href="../../d8/d8/alpha_2exceptn_8c.html#a1">KiEnableAlignmentFaultExceptions</a> == 0) ||
00356 
00357              ((<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;AutoAlignment != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ||
00358               (<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ApcState.Process-&gt;AutoAlignment != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) ||
00359 
00360              (((<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;DebugPort == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>)) &amp;&amp;
00361               (<a class="code" href="../../d8/d8/alpha_2exceptn_8c.html#a1">KiEnableAlignmentFaultExceptions</a> == 2)) ) {
00362 
00363             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a18">KiEmulateReference</a>(ExceptionRecord,
00364                                    ExceptionFrame,
00365                                    TrapFrame) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) 
00366             {
00367                 <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;KeAlignmentFixupCount += 1;
00368                 <span class="keywordflow">goto</span> Handled2;
00369             }
00370         }
00371     }
00372 
00373     <span class="comment">//</span>
00374     <span class="comment">// N.B. BREAKIN_BREAKPOINT check is in KdpTrap()</span>
00375     <span class="comment">//</span>
00376 
00377     <span class="comment">//</span>
00378     <span class="comment">// If the exception is a floating point exception, then the</span>
00379     <span class="comment">// ExceptionCode was set to STATUS_FLOAT_MULTIPLE_TRAPS or </span>
00380     <span class="comment">// STATUS_FLOAT_MULTIPLE_FAULTS.</span>
00381     <span class="comment">//</span>
00382 
00383     <span class="keywordflow">if</span> ((ExceptionRecord-&gt;ExceptionCode == STATUS_FLOAT_MULTIPLE_FAULTS) ||
00384         (ExceptionRecord-&gt;ExceptionCode == STATUS_FLOAT_MULTIPLE_TRAPS)) {
00385 
00386         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d9/ia64_2exceptn_8c.html#a4">KiEmulateFloat</a>(ExceptionRecord, ExceptionFrame, TrapFrame)) {
00387 
00388             <span class="comment">//</span>
00389             <span class="comment">// Emulation is successful; continue execution</span>
00390             <span class="comment">//</span>
00391 
00392             <span class="keywordflow">return</span>;
00393         }
00394     }
00395 
00396     <span class="comment">//</span>
00397     <span class="comment">// Move machine state from trap and exception frames to a context frame,</span>
00398     <span class="comment">// and increment the number of exceptions dispatched.</span>
00399     <span class="comment">//</span>
00400 
00401     ContextFrame.ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a152">CONTEXT_FULL</a>;
00402     <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a9">KeContextFromKframes</a>(TrapFrame, ExceptionFrame, &amp;ContextFrame);
00403     <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;KeExceptionDispatchCount += 1;
00404 
00405     <span class="comment">//</span>
00406     <span class="comment">// Select the method of handling the exception based on the previous mode.</span>
00407     <span class="comment">//</span>
00408 
00409     <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00410 
00411         <span class="comment">//</span>
00412         <span class="comment">// Previous mode was kernel.</span>
00413         <span class="comment">//</span>
00414         <span class="comment">// If this is the first chance, the kernel debugger is active, and</span>
00415         <span class="comment">// the exception is a kernel breakpoint, then give the kernel debugger</span>
00416         <span class="comment">// a chance to handle the exception.</span>
00417         <span class="comment">//</span>
00418         <span class="comment">// If this is the first chance and the kernel debugger is not active</span>
00419         <span class="comment">// or does not handle the exception, then attempt to find a frame</span>
00420         <span class="comment">// handler to handle the exception.</span>
00421         <span class="comment">//</span>
00422         <span class="comment">// If this is the second chance or the exception is not handled, then</span>
00423         <span class="comment">// if the kernel debugger is active, then give the kernel debugger a</span>
00424         <span class="comment">// second chance to handle the exception. If the kernel debugger does</span>
00425         <span class="comment">// not handle the exception, then bug check.</span>
00426         <span class="comment">//</span>
00427 
00428         <span class="keywordflow">if</span> (FirstChance != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00429 
00430             <span class="comment">//</span>
00431             <span class="comment">// This is the first chance to handle the exception.</span>
00432             <span class="comment">//</span>
00433             <span class="comment">// Note: RtlpCaptureRnats() flushes the RSE and captures the</span>
00434             <span class="comment">//       Nat bits of stacked registers in the RSE frame at</span>
00435             <span class="comment">//       which exception happens.</span>
00436             <span class="comment">//</span>
00437 
00438             <a class="code" href="../../d8/d0/rtl_2ia64_2miscc_8c.html#a1">RtlpCaptureRnats</a>(&amp;ContextFrame);
00439             TrapFrame-&gt;RsRNAT = ContextFrame.RsRNAT;
00440 
00441             <span class="comment">//</span>
00442             <span class="comment">// If the kernel debugger is active, the exception is a breakpoint,</span>
00443             <span class="comment">// and the breakpoint is handled by the kernel debugger, then give</span>
00444             <span class="comment">// the kernel debugger a chance to handle the exception.</span>
00445             <span class="comment">//</span>
00446 
00447             <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00448                (ExceptionRecord-&gt;ExceptionCode == STATUS_BREAKPOINT) &amp;&amp;
00449                (<a class="code" href="../../d3/d9/4_2ia64_2kdtrap_8c.html#a1">KdIsThisAKdTrap</a>(ExceptionRecord,
00450                                 &amp;ContextFrame,
00451                                 <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00452 
00453                 <span class="keywordflow">if</span> (((<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a>) (TrapFrame,
00454                                        ExceptionFrame,
00455                                        ExceptionRecord,
00456                                        &amp;ContextFrame,
00457                                        <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00458                                        <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00459 
00460                     <span class="keywordflow">goto</span> Handled1;
00461                 }
00462             }
00463 
00464             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a7">RtlDispatchException</a>(ExceptionRecord, &amp;ContextFrame) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00465                 <span class="keywordflow">goto</span> Handled1;
00466             }
00467         }
00468 
00469         <span class="comment">//</span>
00470         <span class="comment">// This is the second chance to handle the exception.</span>
00471         <span class="comment">//</span>
00472 
00473         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00474             <span class="keywordflow">if</span> (((<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a>) (TrapFrame,
00475                                    ExceptionFrame,
00476                                    ExceptionRecord,
00477                                    &amp;ContextFrame,
00478                                    PreviousMode,
00479                                    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00480                 <span class="keywordflow">goto</span> Handled1;
00481             }
00482         }
00483 
00484         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a13">KMODE_EXCEPTION_NOT_HANDLED</a>,
00485                      ExceptionRecord-&gt;ExceptionCode,
00486                      (ULONG_PTR)ExceptionRecord-&gt;ExceptionAddress,
00487                      ExceptionRecord-&gt;ExceptionInformation[0],
00488                      ExceptionRecord-&gt;ExceptionInformation[1]);
00489 
00490     } <span class="keywordflow">else</span> {
00491 
00492         <span class="comment">//</span>
00493         <span class="comment">// Previous mode was user.</span>
00494         <span class="comment">//</span>
00495         <span class="comment">// If this is the first chance, the kernel debugger is active, the</span>
00496         <span class="comment">// exception is a kernel breakpoint, and the current process is not</span>
00497         <span class="comment">// being debugged, or the current process is being debugged, but the</span>
00498         <span class="comment">// the breakpoint is not a kernel breakpoint instruction, then give</span>
00499         <span class="comment">// the kernel debugger a chance to handle the exception.</span>
00500         <span class="comment">//</span>
00501         <span class="comment">// If this is the first chance and the current process has a debugger</span>
00502         <span class="comment">// port, then send a message to the debugger port and wait for a reply.</span>
00503         <span class="comment">// If the debugger handles the exception, then continue execution. Else</span>
00504         <span class="comment">// transfer the exception information to the user stack, transition to</span>
00505         <span class="comment">// user mode, and attempt to dispatch the exception to a frame based</span>
00506         <span class="comment">// handler. If a frame based handler handles the exception, then continue</span>
00507         <span class="comment">// execution. Otherwise, execute the raise exception system service</span>
00508         <span class="comment">// which will call this routine a second time to process the exception.</span>
00509         <span class="comment">//</span>
00510         <span class="comment">// If this is the second chance and the current process has a debugger</span>
00511         <span class="comment">// port, then send a message to the debugger port and wait for a reply.</span>
00512         <span class="comment">// If the debugger handles the exception, then continue execution. Else</span>
00513         <span class="comment">// if the current process has a subsystem port, then send a message to</span>
00514         <span class="comment">// the subsystem port and wait for a reply. If the subsystem handles the</span>
00515         <span class="comment">// exception, then continue execution. Else terminate the thread.</span>
00516         <span class="comment">//</span>
00517 
00518         <span class="keywordflow">if</span> (FirstChance != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00519 
00520             <span class="comment">//</span>
00521             <span class="comment">// If the kernel debugger is active, the exception is a kernel</span>
00522             <span class="comment">// breakpoint, and the current process is not being debugged,</span>
00523             <span class="comment">// or the current process is being debugged, but the breakpoint</span>
00524             <span class="comment">// is not a kernel breakpoint instruction, then give the kernel</span>
00525             <span class="comment">// debugger a chance to handle the exception.</span>
00526             <span class="comment">//</span>
00527 
00528             <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00529                 (ExceptionRecord-&gt;ExceptionCode == STATUS_BREAKPOINT) &amp;&amp;
00530                 (<a class="code" href="../../d3/d9/4_2ia64_2kdtrap_8c.html#a1">KdIsThisAKdTrap</a>(ExceptionRecord,
00531                                  &amp;ContextFrame,
00532                                  <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
00533                 ((<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;DebugPort == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00534                 ((<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;DebugPort != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00535                 (ExceptionRecord-&gt;ExceptionInformation[0] !=
00536                                             DEBUG_STOP_BREAKPOINT)))) {
00537 
00538                 <span class="keywordflow">if</span> (((<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a>) (TrapFrame,
00539                                        ExceptionFrame,
00540                                        ExceptionRecord,
00541                                        &amp;ContextFrame,
00542                                        <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
00543                                        <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00544 
00545                     <span class="keywordflow">goto</span> Handled1;
00546                 }
00547             }
00548 
00549             <span class="comment">//</span>
00550             <span class="comment">// This is the first chance to handle the exception.</span>
00551             <span class="comment">//</span>
00552 
00553             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/dbgk_8h.html#a5">DbgkForwardException</a>(ExceptionRecord, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00554                 TrapFrame-&gt;StFPSR = SANITIZE_FSR(TrapFrame-&gt;StFPSR, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00555                 <span class="keywordflow">goto</span> Handled2;
00556             }
00557 
00558             <span class="comment">//</span>
00559             <span class="comment">// Transfer exception information to the user stack, transition</span>
00560             <span class="comment">// to user mode, and attempt to dispatch the exception to a frame</span>
00561             <span class="comment">// based handler.</span>
00562             <span class="comment">//</span>
00563             <span class="comment">//</span>
00564             <span class="comment">// We are running on the kernel stack now.  On the user stack, we</span>
00565             <span class="comment">// build a stack frame containing the following:</span>
00566             <span class="comment">//</span>
00567             <span class="comment">//               |                                   |</span>
00568             <span class="comment">//               |-----------------------------------|</span>
00569             <span class="comment">//               |                                   |</span>
00570             <span class="comment">//               |   User's stack frame              |</span>
00571             <span class="comment">//               |                                   |</span>
00572             <span class="comment">//               |-----------------------------------|</span>
00573             <span class="comment">//               |                                   |</span>
00574             <span class="comment">//               |   Context record                  |</span>
00575             <span class="comment">//               |                                   |</span>
00576             <span class="comment">//               |                                   |</span>
00577             <span class="comment">//               |- - - - - - - - - - - - - - - - - -|</span>
00578             <span class="comment">//               |                                   |</span>
00579             <span class="comment">//               |   Exception record                |</span>
00580             <span class="comment">//               |                                   |</span>
00581             <span class="comment">//               |- - - - - - - - - - - - - - - - - -|</span>
00582             <span class="comment">//               |   Stack Scratch Area              |</span>
00583             <span class="comment">//               |-----------------------------------|</span>
00584             <span class="comment">//               |                                   |</span>
00585             <span class="comment">//</span>
00586             <span class="comment">// This stack frame is for KiUserExceptionDispatcher, the assembly</span>
00587             <span class="comment">// langauge routine that effects transfer in user mode to</span>
00588             <span class="comment">// RtlDispatchException.  KiUserExceptionDispatcher is passed</span>
00589             <span class="comment">// pointers to the Exception Record and Context Record as</span>
00590             <span class="comment">// parameters.</span>
00591             <span class="comment">//</span>
00592 
00593         repeat:
00594             <span class="keywordflow">try</span> {
00595 
00596                 <span class="comment">//</span>
00597                 <span class="comment">// Compute length of exception record and new aligned stack</span>
00598                 <span class="comment">// address.</span>
00599                 <span class="comment">//</span>
00600 
00601                 ULONG Length = (STACK_SCRATCH_AREA + 15 +
00602                                 <span class="keyword">sizeof</span>(EXCEPTION_REGISTRATION_RECORD) +
00603                                 <span class="keyword">sizeof</span>(EXCEPTION_RECORD) + <span class="keyword">sizeof</span>(CONTEXT)) &amp; ~(15);
00604                 ULONGLONG UserStack = (ContextFrame.IntSp &amp; (~15)) - Length;
00605                 ULONGLONG ContextSlot = UserStack + STACK_SCRATCH_AREA;
00606                 ULONGLONG ExceptSlot = ContextSlot + <span class="keyword">sizeof</span>(CONTEXT);
00607                 PULONGLONG PUserStack = (PULONGLONG) UserStack;
00608                 
00609                 <span class="comment">//</span>
00610                 <span class="comment">// Probe user stack area for writeability and then transfer the</span>
00611                 <span class="comment">// exception record and conext record to the user stack area.</span>
00612                 <span class="comment">//</span>
00613 
00614                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>((PCHAR)UserStack, Length, <span class="keyword">sizeof</span>(QUAD));
00615                 RtlMoveMemory((PVOID)ContextSlot, &amp;ContextFrame, 
00616                               <span class="keyword">sizeof</span>(CONTEXT));
00617                 RtlMoveMemory((PVOID)ExceptSlot, ExceptionRecord, 
00618                               <span class="keyword">sizeof</span>(EXCEPTION_RECORD));
00619 
00620                 <span class="comment">//</span>
00621                 <span class="comment">// Set address of exception record and context record in</span>
00622                 <span class="comment">// the exception frame and the new stack pointer in the </span>
00623                 <span class="comment">// current trap frame.  Also set the initial frame size</span>
00624                 <span class="comment">// to be zero.</span>
00625                 <span class="comment">//</span>
00626                 <span class="comment">// N.B. User exception dispatcher flushes the RSE</span>
00627                 <span class="comment">//      and updates the BSPStore field upon entry.</span>
00628                 <span class="comment">//</span>
00629 
00630                 TrapFrame-&gt;RsPFS = TrapFrame-&gt;StIFS;
00631                 TrapFrame-&gt;StIFS &amp;= 0xffffffc000000000;
00632                 TrapFrame-&gt;StIPSR &amp;= ~((0x3i64 &lt;&lt; PSR_RI) | (0x1i64 &lt;&lt; PSR_IS));
00633                 TrapFrame-&gt;IntSp = UserStack;
00634                 TrapFrame-&gt;IntNats = 0;
00635 
00636                 ExceptionFrame-&gt;IntS0 = ExceptSlot;
00637                 ExceptionFrame-&gt;IntS1 = ContextSlot;
00638                 ExceptionFrame-&gt;IntNats = 0;
00639 
00640                 <span class="comment">//</span>
00641                 <span class="comment">// Set the address and the gp of the exception routine that </span>
00642                 <span class="comment">// will call the exception dispatcher and then return to the </span>
00643                 <span class="comment">// trap handler.  The trap handler will restore the exception </span>
00644                 <span class="comment">// and trap frame context and continue execution in the routine</span>
00645                 <span class="comment">// that will call the exception dispatcher.</span>
00646                 <span class="comment">//</span>
00647 
00648                 Plabel = (PPLABEL_DESCRIPTOR)<a class="code" href="../../d4/d9/ke_8h.html#a150">KeUserExceptionDispatcher</a>;
00649                 TrapFrame-&gt;StIIP = Plabel-&gt;EntryPoint;
00650                 TrapFrame-&gt;IntGp = Plabel-&gt;GlobalPointer;
00651 
00652                 <span class="keywordflow">return</span>;
00653 
00654             <span class="comment">//</span>
00655             <span class="comment">// If an exception occurs, then copy the new exception information</span>
00656             <span class="comment">// to an exception record and handle the exception.</span>
00657             <span class="comment">//</span>
00658 
00659             } except (<a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a12">KiCopyInformation</a>(&amp;ExceptionRecord1,
00660                                (GetExceptionInformation())-&gt;ExceptionRecord)) {
00661 
00662                 <span class="comment">//</span>
00663                 <span class="comment">// If the exception is a stack overflow, then attempt</span>
00664                 <span class="comment">// to raise the stack overflow exception. Otherwise,</span>
00665                 <span class="comment">// the user's stack is not accessible, or is misaligned,</span>
00666                 <span class="comment">// and second chance processing is performed.</span>
00667                 <span class="comment">//</span>
00668 
00669                 <span class="keywordflow">if</span> (ExceptionRecord1.ExceptionCode == STATUS_STACK_OVERFLOW) {
00670                     ExceptionRecord1.ExceptionAddress = ExceptionRecord-&gt;ExceptionAddress;
00671                     RtlMoveMemory((PVOID)ExceptionRecord,
00672                                   &amp;ExceptionRecord1, <span class="keyword">sizeof</span>(EXCEPTION_RECORD));
00673                     <span class="keywordflow">goto</span> repeat;
00674                 }
00675             }
00676         }
00677 
00678         <span class="comment">//</span>
00679         <span class="comment">// This is the second chance to handle the exception.</span>
00680         <span class="comment">//</span>
00681 
00682         UserApcPending = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ApcState.UserApcPending;
00683         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/dbgk_8h.html#a5">DbgkForwardException</a>(ExceptionRecord, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00684             TrapFrame-&gt;StFPSR = SANITIZE_FSR(TrapFrame-&gt;StFPSR, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00685             <span class="keywordflow">goto</span> Handled2;
00686 
00687         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/dbgk_8h.html#a5">DbgkForwardException</a>(ExceptionRecord, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00688             TrapFrame-&gt;StFPSR = SANITIZE_FSR(TrapFrame-&gt;StFPSR, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00689             <span class="keywordflow">goto</span> Handled2;
00690 
00691         } <span class="keywordflow">else</span> {
00692             ZwTerminateProcess(NtCurrentProcess(), ExceptionRecord-&gt;ExceptionCode);
00693             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a13">KMODE_EXCEPTION_NOT_HANDLED</a>,
00694                          ExceptionRecord-&gt;ExceptionCode,
00695                          (ULONG_PTR)ExceptionRecord-&gt;ExceptionAddress,
00696                          ExceptionRecord-&gt;ExceptionInformation[0],
00697                          ExceptionRecord-&gt;ExceptionInformation[1]);
00698         }
00699     }
00700 
00701     <span class="comment">//</span>
00702     <span class="comment">// Move machine state from context frame to trap and exception frames and</span>
00703     <span class="comment">// then return to continue execution with the restored state.</span>
00704     <span class="comment">//</span>
00705 
00706 Handled1:
00707     <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a10">KeContextToKframes</a>(TrapFrame, ExceptionFrame, &amp;ContextFrame,
00708                        ContextFrame.ContextFlags, PreviousMode);
00709 
00710     <span class="comment">//</span>
00711     <span class="comment">// Exception was handled by the debugger or the associated subsystem</span>
00712     <span class="comment">// and state was modified, if necessary, using the get state and set</span>
00713     <span class="comment">// state capabilities. Therefore the context frame does not need to</span>
00714     <span class="comment">// be transfered to the trap and exception frames.</span>
00715     <span class="comment">//</span>
00716 
00717 Handled2:
00718     <span class="keywordflow">return</span>;
00719 }
00720 
00721 ULONG
<a name="l00722"></a><a class="code" href="../../d0/d9/ia64_2exceptn_8c.html#a6">00722</a> <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a12">KiCopyInformation</a> (
00723     IN OUT PEXCEPTION_RECORD ExceptionRecord1,
00724     IN PEXCEPTION_RECORD ExceptionRecord2
00725     )
00726 
00727 <span class="comment">/*++</span>
00728 <span class="comment"></span>
00729 <span class="comment">Routine Description:</span>
00730 <span class="comment"></span>
00731 <span class="comment">    This function is called from an exception filter to copy the exception</span>
00732 <span class="comment">    information from one exception record to another when an exception occurs.</span>
00733 <span class="comment"></span>
00734 <span class="comment">Arguments:</span>
00735 <span class="comment"></span>
00736 <span class="comment">    ExceptionRecord1 - Supplies a pointer to the destination exception record.</span>
00737 <span class="comment"></span>
00738 <span class="comment">    ExceptionRecord2 - Supplies a pointer to the source exception record.</span>
00739 <span class="comment"></span>
00740 <span class="comment">Return Value:</span>
00741 <span class="comment"></span>
00742 <span class="comment">    A value of EXCEPTION_EXECUTE_HANDLER is returned as the function value.</span>
00743 <span class="comment"></span>
00744 <span class="comment">--*/</span>
00745 
00746 {
00747     <span class="comment">//</span>
00748     <span class="comment">// Copy one exception record to another and return value that causes</span>
00749     <span class="comment">// an exception handler to be executed.</span>
00750     <span class="comment">//</span>
00751 
00752     RtlMoveMemory((PVOID)ExceptionRecord1,
00753                   (PVOID)ExceptionRecord2,
00754                   <span class="keyword">sizeof</span>(EXCEPTION_RECORD));
00755 
00756     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>;
00757 }
00758 
00759 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00760"></a><a class="code" href="../../d0/d9/ia64_2exceptn_8c.html#a7">00760</a> <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a13">KeRaiseUserException</a>(
00761     IN NTSTATUS ExceptionCode
00762     )
00763 
00764 <span class="comment">/*++</span>
00765 <span class="comment"></span>
00766 <span class="comment">Routine Description:</span>
00767 <span class="comment"></span>
00768 <span class="comment">    This function causes an exception to be raised in the calling thread's user-mode</span>
00769 <span class="comment">    context. It does this by editing the trap frame the kernel was entered with to</span>
00770 <span class="comment">    point to trampoline code that raises the requested exception.</span>
00771 <span class="comment"></span>
00772 <span class="comment">Arguments:</span>
00773 <span class="comment"></span>
00774 <span class="comment">    ExceptionCode - Supplies the status value to be used as the exception</span>
00775 <span class="comment">        code for the exception that is to be raised.</span>
00776 <span class="comment"></span>
00777 <span class="comment">Return Value:</span>
00778 <span class="comment"></span>
00779 <span class="comment">    The status value that should be returned by the caller.</span>
00780 <span class="comment"></span>
00781 <span class="comment">--*/</span>
00782 
00783 {
00784     PKTRAP_FRAME TrapFrame;
00785 
00786     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetPreviousMode() == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00787 
00788     TrapFrame = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;TrapFrame;
00789 
00790     <span class="keywordflow">try</span> {
00791         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a> ((PVOID)TrapFrame-&gt;IntSp, 16, <span class="keyword">sizeof</span>(QUAD));
00792         *(PULONGLONG)TrapFrame-&gt;IntSp = TrapFrame-&gt;BrRp;
00793         *(PULONGLONG)(TrapFrame-&gt;IntSp + 8) = TrapFrame-&gt;RsPFS;
00794     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00795         <span class="keywordflow">return</span> (ExceptionCode);
00796     }
00797 
00798     TrapFrame-&gt;StIIP = ((PPLABEL_DESCRIPTOR)<a class="code" href="../../d4/d9/ke_8h.html#a151">KeRaiseUserExceptionDispatcher</a>)-&gt;EntryPoint;
00799     TrapFrame-&gt;StIFS &amp;= (0x3i64 &lt;&lt; 62);
00800     <span class="keywordflow">return</span>(ExceptionCode);
00801 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:57 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
