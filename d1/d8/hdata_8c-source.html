<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: hdata.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>hdata.c</h1><a href="../../d0/d9/hdata_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: hdata.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* DDE Manager data handle functions</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* Created: 11/12/91 Sanford Staab</span>
00009 <span class="comment">*</span>
00010 <span class="comment">\***************************************************************************/</span>
00011 
<a name="l00012"></a><a class="code" href="../../d0/d9/hdata_8c.html#a0">00012</a> <span class="preprocessor">#define DDEMLDB</span>
00013 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="../../d7/d3/w32_2ntuser_2client_2precomp_8h.html">precomp.h</a>"</span>
00014 <span class="preprocessor">#pragma hdrstop</span>
00015 <span class="preprocessor"></span>
00016 
00017 <span class="comment">/***************************************************************************\</span>
00018 <span class="comment">* DdeCreateDataHandle (DDEML API)</span>
00019 <span class="comment">*</span>
00020 <span class="comment">* Description</span>
00021 <span class="comment">*</span>
00022 <span class="comment">* History:</span>
00023 <span class="comment">* 11-1-91 sanfords Created.</span>
00024 <span class="comment">\***************************************************************************/</span>
<a name="l00025"></a><a class="code" href="../../d0/d9/hdata_8c.html#a1">00025</a> HDDEDATA <a class="code" href="../../d0/d9/hdata_8c.html#a1">DdeCreateDataHandle</a>(
00026 DWORD idInst,
00027 LPBYTE pSrc,
00028 DWORD cb,
00029 DWORD cbOff,
00030 HSZ hszItem,
00031 UINT wFmt,
00032 UINT afCmd)
00033 {
00034     <a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html">PCL_INSTANCE_INFO</a> pcii;
00035     HDDEDATA hRet = 0;
00036 
00037     <span class="keywordflow">if</span> (cb == -1) {
00038         RIPMSG0(RIP_ERROR, <span class="stringliteral">"DdeCreateDataHandle called with cb == -1\n"</span>);
00039         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00040     }
00041 
00042     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a6">EnterDDECrit</a>;
00043 
00044     pcii = <a class="code" href="../../d0/d4/instance_8c.html#a7">ValidateInstance</a>((HANDLE)LongToHandle( idInst ));
00045     <span class="keywordflow">if</span> (pcii == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00046         <a class="code" href="../../d3/d8/handles_8c.html#a14">BestSetLastDDEMLError</a>(DMLERR_INVALIDPARAMETER);
00047         <span class="keywordflow">goto</span> Exit;
00048     }
00049     <span class="keywordflow">if</span> (afCmd &amp; ~HDATA_APPOWNED) {
00050         <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(pcii, DMLERR_INVALIDPARAMETER);
00051         <span class="keywordflow">goto</span> Exit;
00052     }
00053 
00054     <span class="keywordflow">if</span> (cb + cbOff &lt; <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) &amp;&amp; pSrc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00055             (wFmt == CF_METAFILEPICT ||
00056              wFmt == CF_DSPMETAFILEPICT ||
00057              wFmt == CF_DIB ||
00058              wFmt == CF_BITMAP ||
00059              wFmt == CF_DSPBITMAP ||
00060              wFmt == CF_PALETTE ||
00061              wFmt == CF_ENHMETAFILE ||
00062              wFmt == CF_DSPENHMETAFILE)) {
00063         <span class="comment">/*</span>
00064 <span class="comment">         * We have the nasty possibility of blowing up in FreeDDEData if we</span>
00065 <span class="comment">         * don't initialize the data for formats with indirect data to 0.</span>
00066 <span class="comment">         * This is because GlobalLock/GlobalSize do not adequately validate</span>
00067 <span class="comment">         * random numbers given to them.</span>
00068 <span class="comment">         */</span>
00069         cb += 4;
00070     }
00071     hRet = <a class="code" href="../../d0/d9/hdata_8c.html#a2">InternalCreateDataHandle</a>(pcii, pSrc, cb, cbOff,
00072             hszItem ? afCmd : (afCmd | HDATA_EXECUTE),
00073             (WORD)((afCmd &amp; HDATA_APPOWNED) ? 0 : DDE_FRELEASE), (WORD)wFmt);
00074 
00075     <span class="keywordflow">if</span> (!hRet) {
00076         <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(pcii, DMLERR_MEMORY_ERROR);
00077     }
00078 Exit:
00079     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a7">LeaveDDECrit</a>;
00080     <span class="keywordflow">return</span> (hRet);
00081 }
00082 
00083 
00084 <span class="comment">/***************************************************************************\</span>
00085 <span class="comment">* InternalCreateDataHandle</span>
00086 <span class="comment">*</span>
00087 <span class="comment">* Description:</span>
00088 <span class="comment">* Worker function for creating a data handle. If cb is -1, pSrc is</span>
00089 <span class="comment">* a GMEM_DDESHARE data handle. 0 is return ed on error.</span>
00090 <span class="comment">*</span>
00091 <span class="comment">* History:</span>
00092 <span class="comment">* 11-19-91 sanfords Created.</span>
00093 <span class="comment">\***************************************************************************/</span>
<a name="l00094"></a><a class="code" href="../../d0/d9/hdata_8c.html#a2">00094</a> HDDEDATA <a class="code" href="../../d0/d9/hdata_8c.html#a2">InternalCreateDataHandle</a>(
00095 <a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html">PCL_INSTANCE_INFO</a> pcii,
00096 LPBYTE pSrc,
00097 DWORD cb, <span class="comment">// cb of actual data to initialize with</span>
00098 DWORD cbOff, <span class="comment">// offset from start of data</span>
00099 DWORD flags,
00100 WORD wStatus,
00101 WORD wFmt)
00102 {
00103     <a class="code" href="../../d8/d2/structtagDDEMLDATA.html">PDDEMLDATA</a> pdd;
00104     HDDEDATA hRet;
00105     LPBYTE p;
00106     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbOff2;
00107 
00108     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a8">CheckDDECritIn</a>;
00109 
00110     pdd = (<a class="code" href="../../d8/d2/structtagDDEMLDATA.html">PDDEMLDATA</a>)<a class="code" href="../../d0/d4/ddemlcli_8h.html#a0">DDEMLAlloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d8/d2/structtagDDEMLDATA.html">DDEMLDATA</a>));
00111     <span class="keywordflow">if</span> (pdd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00112         <span class="keywordflow">return</span> (0);
00113     }
00114     <span class="keywordflow">if</span> (cb == -1) {
00115         pdd-&gt;<a class="code" href="../../d8/d2/structtagDDEMLDATA.html#o0">hDDE</a> = (HANDLE)pSrc;
00116     } <span class="keywordflow">else</span> {
00117         <span class="keywordflow">if</span> (flags &amp; HDATA_EXECUTE) {
00118             cbOff2 = 0;
00119         } <span class="keywordflow">else</span> {
00120             cbOff2 = <span class="keyword">sizeof</span>(WORD) + <span class="keyword">sizeof</span>(WORD); <span class="comment">// skip wStatus, wFmt</span>
00121         }
00122         pdd-&gt;<a class="code" href="../../d8/d2/structtagDDEMLDATA.html#o0">hDDE</a> = <a class="code" href="../../d6/d0/usercli_8h.html#a3">UserGlobalAlloc</a>(GMEM_DDESHARE | GMEM_MOVEABLE | GMEM_ZEROINIT,
00123                 cb + cbOff + cbOff2);
00124         <span class="keywordflow">if</span> (pdd-&gt;<a class="code" href="../../d8/d2/structtagDDEMLDATA.html#o0">hDDE</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00125             <a class="code" href="../../d0/d4/ddemlcli_8h.html#a2">DDEMLFree</a>(pdd);
00126             <span class="keywordflow">return</span> (0);
00127         }
00128 
00129         <span class="keywordflow">if</span> (!(flags &amp; HDATA_EXECUTE)) {
00130             <a class="code" href="../../d4/d2/structtagDDE__DATA.html">PDDE_DATA</a> pdde;
00131 
00132             <a class="code" href="../../d6/d0/usercli_8h.html#a4">USERGLOBALLOCK</a>(pdd-&gt;<a class="code" href="../../d8/d2/structtagDDEMLDATA.html#o0">hDDE</a>, pdde);
00133             UserAssert(pdde);
00134             pdde-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o0">wStatus</a> = wStatus;
00135             pdde-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o1">wFmt</a> = wFmt;
00136             <a class="code" href="../../d6/d0/usercli_8h.html#a1">USERGLOBALUNLOCK</a>(pdd-&gt;<a class="code" href="../../d8/d2/structtagDDEMLDATA.html#o0">hDDE</a>);
00137         }
00138     }
00139     pdd-&gt;<a class="code" href="../../d8/d2/structtagDDEMLDATA.html#o1">flags</a> = (WORD)flags;
00140     hRet = (HDDEDATA)<a class="code" href="../../d3/d8/handles_8c.html#a6">CreateHandle</a>((ULONG_PTR)pdd, <a class="code" href="../../d0/d4/ddemlcli_8h.html#a39">HTYPE_DATA_HANDLE</a>,
00141             <a class="code" href="../../d0/d4/ddemlcli_8h.html#a28">InstFromHandle</a>(pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o2">hInstClient</a>));
00142     <span class="keywordflow">if</span> (!hRet) {
00143         <a class="code" href="../../d6/d0/usercli_8h.html#a7">WOWGLOBALFREE</a>(pdd-&gt;hDDE);
00144         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a2">DDEMLFree</a>(pdd);
00145         <span class="keywordflow">return</span> (0);
00146     }
00147     <span class="keywordflow">if</span> (cb != -1 &amp;&amp; pSrc != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00148         <a class="code" href="../../d6/d0/usercli_8h.html#a4">USERGLOBALLOCK</a>(pdd-&gt;hDDE, p);
00149         UserAssert(p);
00150         RtlCopyMemory(p + cbOff + cbOff2, pSrc, cb);
00151         <a class="code" href="../../d6/d0/usercli_8h.html#a1">USERGLOBALUNLOCK</a>(pdd-&gt;hDDE);
00152         pdd-&gt;flags |= HDATA_INITIALIZED;
00153     }
00154     <span class="keywordflow">return</span> (hRet);
00155 }
00156 
00157 <span class="comment">/***************************************************************************\</span>
00158 <span class="comment">* DdeAddData (DDEML API)</span>
00159 <span class="comment">*</span>
00160 <span class="comment">* Description:</span>
00161 <span class="comment">* Copys data from a user buffer to a data handles. Reallocates if needed.</span>
00162 <span class="comment">*</span>
00163 <span class="comment">* History:</span>
00164 <span class="comment">* 11-1-91 sanfords Created.</span>
00165 <span class="comment">\***************************************************************************/</span>
<a name="l00166"></a><a class="code" href="../../d0/d9/hdata_8c.html#a3">00166</a> HDDEDATA <a class="code" href="../../d0/d9/hdata_8c.html#a3">DdeAddData</a>(
00167 HDDEDATA hData,
00168 LPBYTE pSrc,
00169 DWORD cb,
00170 DWORD cbOff)
00171 {
00172     LPSTR pMem;
00173     <a class="code" href="../../d8/d2/structtagDDEMLDATA.html">PDDEMLDATA</a> pdd;
00174     <a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html">PCL_INSTANCE_INFO</a> pcii;
00175     HDDEDATA hRet = 0;
00176 
00177     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a6">EnterDDECrit</a>;
00178 
00179     pdd = (<a class="code" href="../../d8/d2/structtagDDEMLDATA.html">PDDEMLDATA</a>)<a class="code" href="../../d3/d8/handles_8c.html#a10">ValidateCHandle</a>((HANDLE)hData, <a class="code" href="../../d0/d4/ddemlcli_8h.html#a39">HTYPE_DATA_HANDLE</a>, <a class="code" href="../../d0/d4/ddemlcli_8h.html#a42">HINST_ANY</a>);
00180     <span class="keywordflow">if</span> (pdd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00181         <span class="keywordflow">goto</span> Exit;
00182     }
00183     pcii = <a class="code" href="../../d3/d8/handles_8c.html#a11">PciiFromHandle</a>((HANDLE)hData);
00184     <span class="keywordflow">if</span> (pcii == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00185         <a class="code" href="../../d3/d8/handles_8c.html#a14">BestSetLastDDEMLError</a>(DMLERR_INVALIDPARAMETER);
00186         <span class="keywordflow">goto</span> Exit;
00187     }
00188     <span class="keywordflow">if</span> (!(pdd-&gt;<a class="code" href="../../d8/d2/structtagDDEMLDATA.html#o1">flags</a> &amp; HDATA_EXECUTE)) {
00189         cbOff += 4;
00190     }
00191     <span class="keywordflow">if</span> (cb + cbOff &gt; <a class="code" href="../../d6/d0/usercli_8h.html#a6">UserGlobalSize</a>(pdd-&gt;<a class="code" href="../../d8/d2/structtagDDEMLDATA.html#o0">hDDE</a>)) {
00192         pdd-&gt;<a class="code" href="../../d8/d2/structtagDDEMLDATA.html#o0">hDDE</a> = <a class="code" href="../../d6/d0/usercli_8h.html#a5">UserGlobalReAlloc</a>(pdd-&gt;<a class="code" href="../../d8/d2/structtagDDEMLDATA.html#o0">hDDE</a>, cb + cbOff,
00193                 GMEM_MOVEABLE | GMEM_ZEROINIT);
00194     }
00195 
00196     <a class="code" href="../../d6/d0/usercli_8h.html#a4">USERGLOBALLOCK</a>(pdd-&gt;<a class="code" href="../../d8/d2/structtagDDEMLDATA.html#o0">hDDE</a>, pMem);
00197 
00198     <span class="keywordflow">if</span> (pMem == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00199         <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(pcii, DMLERR_MEMORY_ERROR);
00200         <span class="keywordflow">goto</span> Exit;
00201     }
00202 
00203     hRet = hData;
00204 
00205     <span class="keywordflow">if</span> (pSrc != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00206         <span class="keywordflow">try</span> {
00207             RtlCopyMemory(pMem + cbOff, pSrc, cb);
00208             pdd-&gt;<a class="code" href="../../d8/d2/structtagDDEMLDATA.html#o1">flags</a> |= HDATA_INITIALIZED;
00209         } except(W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
00210             <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(pcii, DMLERR_INVALIDPARAMETER);
00211             hRet = 0;
00212         }
00213     }
00214 
00215     <a class="code" href="../../d6/d0/usercli_8h.html#a1">USERGLOBALUNLOCK</a>(pdd-&gt;<a class="code" href="../../d8/d2/structtagDDEMLDATA.html#o0">hDDE</a>);
00216 
00217 Exit:
00218     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a7">LeaveDDECrit</a>;
00219     <span class="keywordflow">return</span> (hRet);
00220 }
00221 
00222 
00223 
00224 
00225 <span class="comment">/***************************************************************************\</span>
00226 <span class="comment">* DdeGetData (DDEML API)</span>
00227 <span class="comment">*</span>
00228 <span class="comment">* Description:</span>
00229 <span class="comment">* Copys data from a data handle into a user buffer.</span>
00230 <span class="comment">*</span>
00231 <span class="comment">* History:</span>
00232 <span class="comment">* 11-1-91 sanfords Created.</span>
00233 <span class="comment">\***************************************************************************/</span>
<a name="l00234"></a><a class="code" href="../../d0/d9/hdata_8c.html#a4">00234</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d0/d9/hdata_8c.html#a4">DdeGetData</a>(
00235 HDDEDATA hData,
00236 LPBYTE pDst,
00237 DWORD cbMax,
00238 DWORD cbOff)
00239 {
00240     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbCopied = 0;
00241     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbSize;
00242     <a class="code" href="../../d8/d2/structtagDDEMLDATA.html">PDDEMLDATA</a> pdd;
00243     <a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html">PCL_INSTANCE_INFO</a> pcii;
00244 
00245     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a6">EnterDDECrit</a>;
00246 
00247     pdd = (<a class="code" href="../../d8/d2/structtagDDEMLDATA.html">PDDEMLDATA</a>)<a class="code" href="../../d3/d8/handles_8c.html#a10">ValidateCHandle</a>((HANDLE)hData,
00248             <a class="code" href="../../d0/d4/ddemlcli_8h.html#a39">HTYPE_DATA_HANDLE</a>, <a class="code" href="../../d0/d4/ddemlcli_8h.html#a42">HINST_ANY</a>);
00249     <span class="keywordflow">if</span> (pdd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00250         <a class="code" href="../../d3/d8/handles_8c.html#a14">BestSetLastDDEMLError</a>(DMLERR_INVALIDPARAMETER);
00251         <span class="keywordflow">goto</span> Exit;
00252     }
00253     pcii = <a class="code" href="../../d3/d8/handles_8c.html#a11">PciiFromHandle</a>((HANDLE)hData);
00254     <span class="keywordflow">if</span> (pcii == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00255         <a class="code" href="../../d3/d8/handles_8c.html#a14">BestSetLastDDEMLError</a>(DMLERR_INVALIDPARAMETER);
00256         <span class="keywordflow">goto</span> Exit;
00257     }
00258     <span class="keywordflow">if</span> (!(pdd-&gt;<a class="code" href="../../d8/d2/structtagDDEMLDATA.html#o1">flags</a> &amp; HDATA_EXECUTE)) {
00259         cbOff += 4;
00260     }
00261     cbSize = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d6/d0/usercli_8h.html#a6">UserGlobalSize</a>(pdd-&gt;<a class="code" href="../../d8/d2/structtagDDEMLDATA.html#o0">hDDE</a>);
00262     <span class="keywordflow">if</span> (cbOff &gt;= cbSize) {
00263         <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(pcii, DMLERR_INVALIDPARAMETER);
00264         <span class="keywordflow">goto</span> Exit;
00265     }
00266     <span class="keywordflow">if</span> (pDst == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00267         cbCopied = cbSize - cbOff;
00268         <span class="keywordflow">goto</span> Exit;
00269     } <span class="keywordflow">else</span> {
00270         LPSTR pMem;
00271 
00272         cbCopied = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(cbMax, cbSize - cbOff);
00273         <a class="code" href="../../d6/d0/usercli_8h.html#a4">USERGLOBALLOCK</a>(pdd-&gt;<a class="code" href="../../d8/d2/structtagDDEMLDATA.html#o0">hDDE</a>, pMem);
00274         UserAssert(pMem);
00275         <span class="keywordflow">try</span> {
00276             RtlCopyMemory(pDst, pMem + cbOff, cbCopied);
00277         } except(W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
00278             <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>(pcii, DMLERR_INVALIDPARAMETER);
00279             cbCopied = 0;
00280         }
00281         <span class="keywordflow">if</span> (pMem != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00282             <a class="code" href="../../d6/d0/usercli_8h.html#a1">USERGLOBALUNLOCK</a>(pdd-&gt;<a class="code" href="../../d8/d2/structtagDDEMLDATA.html#o0">hDDE</a>);
00283         }
00284     }
00285 
00286 Exit:
00287     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a7">LeaveDDECrit</a>;
00288     <span class="keywordflow">return</span> (cbCopied);
00289 }
00290 
00291 
00292 
00293 
00294 
00295 <span class="comment">/***************************************************************************\</span>
00296 <span class="comment">* DdeAccessData (DDEML API)</span>
00297 <span class="comment">*</span>
00298 <span class="comment">* Description:</span>
00299 <span class="comment">* Locks a data handle for access.</span>
00300 <span class="comment">*</span>
00301 <span class="comment">* History:</span>
00302 <span class="comment">* 11-1-91 sanfords Created.</span>
00303 <span class="comment">\***************************************************************************/</span>
<a name="l00304"></a><a class="code" href="../../d0/d9/hdata_8c.html#a5">00304</a> LPBYTE <a class="code" href="../../d0/d9/hdata_8c.html#a5">DdeAccessData</a>(
00305 HDDEDATA hData,
00306 LPDWORD pcbDataSize)
00307 {
00308     <a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html">PCL_INSTANCE_INFO</a> pcii;
00309     <a class="code" href="../../d8/d2/structtagDDEMLDATA.html">PDDEMLDATA</a> pdd;
00310     LPBYTE pRet = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00311     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbOff;
00312 
00313     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a6">EnterDDECrit</a>;
00314 
00315     pdd = (<a class="code" href="../../d8/d2/structtagDDEMLDATA.html">PDDEMLDATA</a>)<a class="code" href="../../d3/d8/handles_8c.html#a10">ValidateCHandle</a>((HANDLE)hData,
00316             <a class="code" href="../../d0/d4/ddemlcli_8h.html#a39">HTYPE_DATA_HANDLE</a>, <a class="code" href="../../d0/d4/ddemlcli_8h.html#a42">HINST_ANY</a>);
00317     <span class="keywordflow">if</span> (pdd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00318         <span class="keywordflow">goto</span> Exit;
00319     }
00320     pcii = <a class="code" href="../../d3/d8/handles_8c.html#a11">PciiFromHandle</a>((HANDLE)hData);
00321     cbOff = pdd-&gt;<a class="code" href="../../d8/d2/structtagDDEMLDATA.html#o1">flags</a> &amp; HDATA_EXECUTE ? 0 : 4;
00322     <span class="keywordflow">if</span> (pcbDataSize != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00323         *pcbDataSize = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d6/d0/usercli_8h.html#a6">UserGlobalSize</a>(pdd-&gt;<a class="code" href="../../d8/d2/structtagDDEMLDATA.html#o0">hDDE</a>) - cbOff;
00324     }
00325     <a class="code" href="../../d6/d0/usercli_8h.html#a4">USERGLOBALLOCK</a>(pdd-&gt;<a class="code" href="../../d8/d2/structtagDDEMLDATA.html#o0">hDDE</a>, pRet);
00326     UserAssert(pRet);
00327     pRet = (LPBYTE)pRet + cbOff;
00328 
00329 Exit:
00330     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a7">LeaveDDECrit</a>;
00331     <span class="keywordflow">return</span> (pRet);
00332 }
00333 
00334 
00335 
00336 
00337 <span class="comment">/***************************************************************************\</span>
00338 <span class="comment">* DdeUnaccessData (DDEML API)</span>
00339 <span class="comment">*</span>
00340 <span class="comment">* Description:</span>
00341 <span class="comment">* Unlocks a data handle</span>
00342 <span class="comment">*</span>
00343 <span class="comment">* History:</span>
00344 <span class="comment">* 11-1-91 sanfords Created.</span>
00345 <span class="comment">\***************************************************************************/</span>
<a name="l00346"></a><a class="code" href="../../d0/d9/hdata_8c.html#a6">00346</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d9/hdata_8c.html#a6">DdeUnaccessData</a>(
00347 HDDEDATA hData)
00348 {
00349     <a class="code" href="../../d8/d2/structtagDDEMLDATA.html">PDDEMLDATA</a> pdd;
00350     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00351 
00352     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a6">EnterDDECrit</a>;
00353 
00354     pdd = (<a class="code" href="../../d8/d2/structtagDDEMLDATA.html">PDDEMLDATA</a>)<a class="code" href="../../d3/d8/handles_8c.html#a10">ValidateCHandle</a>((HANDLE)hData,
00355             <a class="code" href="../../d0/d4/ddemlcli_8h.html#a39">HTYPE_DATA_HANDLE</a>, <a class="code" href="../../d0/d4/ddemlcli_8h.html#a42">HINST_ANY</a>);
00356     <span class="keywordflow">if</span> (pdd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00357         <span class="keywordflow">goto</span> Exit;
00358     }
00359     <a class="code" href="../../d6/d0/usercli_8h.html#a1">USERGLOBALUNLOCK</a>(pdd-&gt;<a class="code" href="../../d8/d2/structtagDDEMLDATA.html#o0">hDDE</a>);
00360     fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00361 
00362 Exit:
00363     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a7">LeaveDDECrit</a>;
00364     <span class="keywordflow">return</span> (fSuccess);
00365 }
00366 
00367 
00368 
00369 <span class="comment">/***************************************************************************\</span>
00370 <span class="comment">* DdeFreeDataHandle (DDEML API)</span>
00371 <span class="comment">*</span>
00372 <span class="comment">* Description:</span>
00373 <span class="comment">* Releases application interest in a data handle.</span>
00374 <span class="comment">*</span>
00375 <span class="comment">* History:</span>
00376 <span class="comment">* 11-1-91 sanfords Created.</span>
00377 <span class="comment">\***************************************************************************/</span>
<a name="l00378"></a><a class="code" href="../../d0/d9/hdata_8c.html#a7">00378</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d9/hdata_8c.html#a7">DdeFreeDataHandle</a>(
00379 HDDEDATA hData)
00380 {
00381     <a class="code" href="../../d8/d2/structtagDDEMLDATA.html">PDDEMLDATA</a> pdd;
00382     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00383 
00384     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a6">EnterDDECrit</a>;
00385 
00386     pdd = (<a class="code" href="../../d8/d2/structtagDDEMLDATA.html">PDDEMLDATA</a>)<a class="code" href="../../d3/d8/handles_8c.html#a10">ValidateCHandle</a>((HANDLE)hData,
00387             <a class="code" href="../../d0/d4/ddemlcli_8h.html#a39">HTYPE_DATA_HANDLE</a>, <a class="code" href="../../d0/d4/ddemlcli_8h.html#a42">HINST_ANY</a>);
00388     <span class="keywordflow">if</span> (pdd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00389         <span class="keywordflow">goto</span> Exit;
00390     }
00391     <span class="keywordflow">if</span> (pdd-&gt;<a class="code" href="../../d8/d2/structtagDDEMLDATA.html#o1">flags</a> &amp; HDATA_NOAPPFREE) {
00392         fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00393         <span class="keywordflow">goto</span> Exit;
00394     }
00395 
00396     fSuccess = <a class="code" href="../../d0/d9/hdata_8c.html#a8">InternalFreeDataHandle</a>(hData, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00397 
00398 Exit:
00399     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a7">LeaveDDECrit</a>;
00400     <span class="keywordflow">return</span> (fSuccess);
00401 }
00402 
00403 
00404 
00405 
00406 <span class="comment">/***************************************************************************\</span>
00407 <span class="comment">* InternalFreeDataHandle</span>
00408 <span class="comment">*</span>
00409 <span class="comment">* Description:</span>
00410 <span class="comment">* Frees a data handle and its contents. The contents are NOT freed for</span>
00411 <span class="comment">* APPOWNED data handles unless fIgnorefRelease is set.</span>
00412 <span class="comment">*</span>
00413 <span class="comment">* History:</span>
00414 <span class="comment">* 11-19-91 sanfords Created.</span>
00415 <span class="comment">\***************************************************************************/</span>
<a name="l00416"></a><a class="code" href="../../d0/d9/hdata_8c.html#a8">00416</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d9/hdata_8c.html#a8">InternalFreeDataHandle</a>(
00417 HDDEDATA hData,
00418 BOOL fIgnorefRelease)
00419 {
00420     <a class="code" href="../../d8/d2/structtagDDEMLDATA.html">PDDEMLDATA</a> pdd;
00421 
00422     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a8">CheckDDECritIn</a>;
00423 
00424     pdd = (<a class="code" href="../../d8/d2/structtagDDEMLDATA.html">PDDEMLDATA</a>)<a class="code" href="../../d3/d8/handles_8c.html#a10">ValidateCHandle</a>((HANDLE)hData,
00425             <a class="code" href="../../d0/d4/ddemlcli_8h.html#a39">HTYPE_DATA_HANDLE</a>, <a class="code" href="../../d0/d4/ddemlcli_8h.html#a42">HINST_ANY</a>);
00426     <span class="keywordflow">if</span> (pdd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00427         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00428     }
00429     <span class="keywordflow">if</span> (pdd-&gt;<a class="code" href="../../d8/d2/structtagDDEMLDATA.html#o1">flags</a> &amp; HDATA_EXECUTE) {
00430         <span class="keywordflow">if</span> (!(pdd-&gt;<a class="code" href="../../d8/d2/structtagDDEMLDATA.html#o1">flags</a> &amp; HDATA_APPOWNED) || fIgnorefRelease) {
00431             <a class="code" href="../../d6/d0/usercli_8h.html#a7">WOWGLOBALFREE</a>(pdd-&gt;<a class="code" href="../../d8/d2/structtagDDEMLDATA.html#o0">hDDE</a>);
00432         }
00433     } <span class="keywordflow">else</span> {
00434         <a class="code" href="../../d0/d9/hdata_8c.html#a10">FreeDDEData</a>(pdd-&gt;<a class="code" href="../../d8/d2/structtagDDEMLDATA.html#o0">hDDE</a>, fIgnorefRelease, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00435     }
00436     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a2">DDEMLFree</a>(pdd);
00437     <a class="code" href="../../d3/d8/handles_8c.html#a7">DestroyHandle</a>((HANDLE)hData);
00438     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00439 }
00440 
00441 
00442 <span class="comment">/***************************************************************************\</span>
00443 <span class="comment">* ApplyFreeDataHandle</span>
00444 <span class="comment">*</span>
00445 <span class="comment">* Description:</span>
00446 <span class="comment">* Used during data handle cleanup.</span>
00447 <span class="comment">*</span>
00448 <span class="comment">* History:</span>
00449 <span class="comment">* 11-19-91 sanfords Created.</span>
00450 <span class="comment">\***************************************************************************/</span>
<a name="l00451"></a><a class="code" href="../../d0/d9/hdata_8c.html#a9">00451</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d9/hdata_8c.html#a9">ApplyFreeDataHandle</a>(
00452 HANDLE hData)
00453 {
00454     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRet;
00455 
00456     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a9">CheckDDECritOut</a>;
00457     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a6">EnterDDECrit</a>;
00458     fRet = <a class="code" href="../../d0/d9/hdata_8c.html#a8">InternalFreeDataHandle</a>((HDDEDATA)hData, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00459     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a7">LeaveDDECrit</a>;
00460     <span class="keywordflow">return</span>(fRet);
00461 }
00462 
00463 
00464 <span class="comment">/***************************************************************************\</span>
00465 <span class="comment">* FreeDDEData</span>
00466 <span class="comment">*</span>
00467 <span class="comment">* Description:</span>
00468 <span class="comment">* Used for freeing DDE data including any special indirect objects</span>
00469 <span class="comment">* associated with the data depending on the format. This function</span>
00470 <span class="comment">* SHOULD NOT BE USED TO FREE EXECUTE DATA!</span>
00471 <span class="comment">*</span>
00472 <span class="comment">* The data is not freed if the fRelease bit is clear and fIgnoreRelease</span>
00473 <span class="comment">* is FALSE.</span>
00474 <span class="comment">*</span>
00475 <span class="comment">*   The fFreeTruelyGlobalObjects parameter is used to distinguish tracking</span>
00476 <span class="comment">*   layer frees from DDEML frees.  Data in certain formats (CF_BITMAP,</span>
00477 <span class="comment">*   CF_PALETTE) is maintained on the gdi CSR server side.  When this is</span>
00478 <span class="comment">*   passed between processes, gdi is not able to maintain multiple process</span>
00479 <span class="comment">*   ownership on these objects so the objects must be made global.  Thus</span>
00480 <span class="comment">*   the tracking layer should NOT free these objects on behalf of another</span>
00481 <span class="comment">*   process because they are truely global- however, DDEML can do this</span>
00482 <span class="comment">*   because it is following the protocol which delclares who is in charge</span>
00483 <span class="comment">*   of freeing global data.  (YUCK!)</span>
00484 <span class="comment">*</span>
00485 <span class="comment">* History:</span>
00486 <span class="comment">* 11-19-91 sanfords Created.</span>
00487 <span class="comment">\***************************************************************************/</span>
00488 <span class="comment">/*</span>
00489 <span class="comment"> * WARNING: This is exported for NetDDE use - DO NOT CHANGE THE PARAMETERS!</span>
00490 <span class="comment"> */</span>
<a name="l00491"></a><a class="code" href="../../d0/d9/hdata_8c.html#a10">00491</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d0/d9/hdata_8c.html#a10">FreeDDEData</a>(
00492 HANDLE hDDE,
00493 BOOL fIgnorefRelease,
00494 BOOL fFreeTruelyGlobalObjects)
00495 {
00496     <a class="code" href="../../d4/d2/structtagDDE__DATA.html">PDDE_DATA</a> pdde;
00497     LPMETAFILEPICT pmfPict;
00498     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cb;
00499 
00500     <a class="code" href="../../d6/d0/usercli_8h.html#a4">USERGLOBALLOCK</a>(hDDE, pdde);
00501     <span class="keywordflow">if</span> (pdde == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00502         <span class="keywordflow">return</span> ;
00503     }
00504 
00505     <span class="keywordflow">if</span> ((pdde-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o0">wStatus</a> &amp; DDE_FRELEASE) || fIgnorefRelease) {
00506         cb = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)GlobalSize(hDDE);
00507         <span class="comment">/*</span>
00508 <span class="comment">         * Because there is the possibility that the data never got</span>
00509 <span class="comment">         * initialized we need to do this in a try-except so we</span>
00510 <span class="comment">         * behave nicely.</span>
00511 <span class="comment">         */</span>
00512         <span class="keywordflow">switch</span> (pdde-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o1">wFmt</a>) {
00513         <span class="keywordflow">case</span> CF_BITMAP:
00514         <span class="keywordflow">case</span> CF_DSPBITMAP:
00515         <span class="keywordflow">case</span> CF_PALETTE:
00516             <span class="keywordflow">if</span> (cb &gt;= <span class="keyword">sizeof</span>(HANDLE)) {
00517                 <span class="keywordflow">if</span> (fFreeTruelyGlobalObjects) {
00518                     <span class="keywordflow">if</span> (pdde-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o2">Data</a> != 0) {
00519                         DeleteObject((HANDLE)pdde-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o2">Data</a>);
00520                     }
00521                 } <span class="keywordflow">else</span> {
00522                     <span class="comment">/*</span>
00523 <span class="comment">                     * !fFreeTruelyGlobalObject implies we are only freeing</span>
00524 <span class="comment">                     * the Gdi proxy.  (another process may still have this</span>
00525 <span class="comment">                     * object in use.)</span>
00526 <span class="comment">                     *</span>
00527 <span class="comment">                     * ChrisWil: removed this call.  No longer</span>
00528 <span class="comment">                     *           applicable in KMode.</span>
00529 <span class="comment">                     *</span>
00530 <span class="comment">                     * GdiDeleteLocalObject((ULONG)pdde-&gt;Data);</span>
00531 <span class="comment">                     *</span>
00532 <span class="comment">                     */</span>
00533                 }
00534             }
00535             <span class="keywordflow">break</span>;
00536 
00537         <span class="keywordflow">case</span> CF_DIB:
00538             <span class="keywordflow">if</span> (cb &gt;= <span class="keyword">sizeof</span>(HANDLE)) {
00539                 <span class="keywordflow">if</span> (pdde-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o2">Data</a> != 0) {
00540                     <a class="code" href="../../d6/d0/usercli_8h.html#a7">WOWGLOBALFREE</a>((HANDLE)pdde-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o2">Data</a>);
00541                 }
00542             }
00543             <span class="keywordflow">break</span>;
00544 
00545         <span class="keywordflow">case</span> CF_METAFILEPICT:
00546         <span class="keywordflow">case</span> CF_DSPMETAFILEPICT:
00547             <span class="keywordflow">if</span> (cb &gt;= <span class="keyword">sizeof</span>(HANDLE)) {
00548                 <span class="keywordflow">if</span> (pdde-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o2">Data</a> != 0) {
00549                     <a class="code" href="../../d6/d0/usercli_8h.html#a4">USERGLOBALLOCK</a>(pdde-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o2">Data</a>, pmfPict);
00550                     <span class="keywordflow">if</span> (pmfPict != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00551                         <span class="keywordflow">if</span> (GlobalSize((HANDLE)pdde-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o2">Data</a>) &gt;= <span class="keyword">sizeof</span>(METAFILEPICT)) {
00552                             DeleteMetaFile(pmfPict-&gt;hMF);
00553                         }
00554                         <a class="code" href="../../d6/d0/usercli_8h.html#a1">USERGLOBALUNLOCK</a>((HANDLE)pdde-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o2">Data</a>);
00555                         <a class="code" href="../../d6/d0/usercli_8h.html#a7">WOWGLOBALFREE</a>((HANDLE)pdde-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o2">Data</a>);
00556                     }
00557                 }
00558             }
00559             <span class="keywordflow">break</span>;
00560 
00561         <span class="keywordflow">case</span> CF_ENHMETAFILE:
00562         <span class="keywordflow">case</span> CF_DSPENHMETAFILE:
00563             <span class="keywordflow">if</span> (cb &gt;= <span class="keyword">sizeof</span>(HANDLE)) {
00564                 <span class="keywordflow">if</span> (pdde-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o2">Data</a> != 0) {
00565                     DeleteEnhMetaFile((HANDLE)pdde-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o2">Data</a>);
00566                 }
00567             }
00568             <span class="keywordflow">break</span>;
00569         }
00570         <a class="code" href="../../d6/d0/usercli_8h.html#a1">USERGLOBALUNLOCK</a>(hDDE);
00571         <a class="code" href="../../d6/d0/usercli_8h.html#a7">WOWGLOBALFREE</a>(hDDE);
00572     } <span class="keywordflow">else</span> {
00573         <a class="code" href="../../d6/d0/usercli_8h.html#a1">USERGLOBALUNLOCK</a>(hDDE);
00574     }
00575 }
00576 
00577 
00578 
<a name="l00579"></a><a class="code" href="../../d0/d9/hdata_8c.html#a11">00579</a> HBITMAP <a class="code" href="../../d0/d9/hdata_8c.html#a11">CopyBitmap</a>(
00580 HBITMAP hbm)
00581 {
00582     BITMAP bm;
00583     HBITMAP hbm2, hbmOld1, hbmOld2;
00584     HDC hdc, hdcMem1, hdcMem2;
00585 
00586     <span class="keywordflow">if</span> (!GetObject(hbm, <span class="keyword">sizeof</span>(BITMAP), &amp;bm)) {
00587         <span class="keywordflow">return</span>(0);
00588     }
00589     hdc = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a250">NtUserGetDC</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);  <span class="comment">// screen DC</span>
00590     <span class="keywordflow">if</span> (!hdc) {
00591         <span class="keywordflow">return</span>(0);
00592     }
00593     hdcMem1 = CreateCompatibleDC(hdc);
00594     <span class="keywordflow">if</span> (!hdcMem1) {
00595         <span class="keywordflow">goto</span> Cleanup3;
00596     }
00597     hdcMem2 = CreateCompatibleDC(hdc);
00598     <span class="keywordflow">if</span> (!hdcMem2) {
00599         <span class="keywordflow">goto</span> Cleanup2;
00600     }
00601     hbmOld1 = SelectObject(hdcMem1, hbm);
00602     hbm2 = CreateCompatibleBitmap(hdcMem1, bm.bmWidth, bm.bmHeight);
00603     <span class="keywordflow">if</span> (!hbm2) {
00604         <span class="keywordflow">goto</span> Cleanup1;
00605     }
00606     hbmOld2 = SelectObject(hdcMem2, hbm2);
00607     BitBlt(hdcMem2, 0, 0, bm.bmWidth, bm.bmHeight, hdcMem1, 0, 0, SRCCOPY);
00608     SelectObject(hdcMem1, hbmOld1);
00609     SelectObject(hdcMem2, hbmOld2);
00610 Cleanup1:
00611     DeleteDC(hdcMem2);
00612 Cleanup2:
00613     DeleteDC(hdcMem1);
00614 Cleanup3:
00615     <a class="code" href="../../d6/d0/usercli_8h.html#a211">NtUserReleaseDC</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hdc);
00616     <span class="keywordflow">return</span>(hbm2);
00617 }
00618 
00619 
<a name="l00620"></a><a class="code" href="../../d0/d9/hdata_8c.html#a12">00620</a> HPALETTE <a class="code" href="../../d0/d9/hdata_8c.html#a12">CopyPalette</a>(
00621 HPALETTE hpal)
00622 {
00623     <span class="keywordtype">int</span> cPalEntries;
00624     LOGPALETTE *plp;
00625 
00626     <span class="keywordflow">if</span> (!GetObject(hpal, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), &amp;cPalEntries)) {
00627         <span class="keywordflow">return</span>(0);
00628     }
00629     plp = (LOGPALETTE *)<a class="code" href="../../d0/d4/ddemlcli_8h.html#a0">DDEMLAlloc</a>(<span class="keyword">sizeof</span>(LOGPALETTE) +
00630             (cPalEntries - 1) * <span class="keyword">sizeof</span>(PALETTEENTRY));
00631     <span class="keywordflow">if</span> (!plp) {
00632         <span class="keywordflow">return</span>(0);
00633     }
00634     <span class="keywordflow">if</span> (!GetPaletteEntries(hpal, 0, cPalEntries, plp-&gt;palPalEntry)) {
00635         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a2">DDEMLFree</a>(plp);
00636         <span class="keywordflow">return</span>(0);
00637     }
00638     plp-&gt;palVersion = 0x300;
00639     plp-&gt;palNumEntries = (WORD)cPalEntries;
00640     hpal = CreatePalette(plp);
00641     <span class="keywordflow">if</span> (hpal  &amp;&amp;
00642             !SetPaletteEntries(hpal, 0, cPalEntries, plp-&gt;palPalEntry)) {
00643         hpal = 0;
00644     }
00645     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a2">DDEMLFree</a>(plp);
00646     <span class="keywordflow">return</span>(hpal);
00647 }
00648 
00649 
00650 
00651 <span class="comment">/***************************************************************************\</span>
00652 <span class="comment">* CopyDDEData</span>
00653 <span class="comment">*</span>
00654 <span class="comment">* Description:</span>
00655 <span class="comment">* Used to copy DDE data apropriately.</span>
00656 <span class="comment">*</span>
00657 <span class="comment">* History:</span>
00658 <span class="comment">* 11-19-91 sanfords Created.</span>
00659 <span class="comment">\***************************************************************************/</span>
<a name="l00660"></a><a class="code" href="../../d0/d9/hdata_8c.html#a13">00660</a> HANDLE <a class="code" href="../../d0/d9/hdata_8c.html#a13">CopyDDEData</a>(
00661 HANDLE hDDE,
00662 BOOL fIsExecute)
00663 {
00664     HANDLE hDDENew;
00665     <a class="code" href="../../d4/d2/structtagDDE__DATA.html">PDDE_DATA</a> pdde, pddeNew;
00666     LPMETAFILEPICT pmfPict;
00667     HANDLE hmfPict;
00668 
00669     hDDENew = <a class="code" href="../../d6/d0/usercli_8h.html#a3">UserGlobalAlloc</a>(GMEM_DDESHARE | GMEM_MOVEABLE,
00670             <a class="code" href="../../d6/d0/usercli_8h.html#a6">UserGlobalSize</a>(hDDE));
00671     <span class="keywordflow">if</span> (!hDDENew) {
00672         <span class="keywordflow">return</span> (0);
00673     }
00674     <a class="code" href="../../d6/d0/usercli_8h.html#a4">USERGLOBALLOCK</a>(hDDE, pdde);
00675     <span class="keywordflow">if</span> (pdde == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00676         <a class="code" href="../../d6/d0/usercli_8h.html#a2">UserGlobalFree</a>(hDDENew);
00677         <span class="keywordflow">return</span> (0);
00678     }
00679     <a class="code" href="../../d6/d0/usercli_8h.html#a4">USERGLOBALLOCK</a>(hDDENew, pddeNew);
00680     UserAssert(pddeNew);
00681     RtlCopyMemory(pddeNew, pdde, <a class="code" href="../../d6/d0/usercli_8h.html#a6">UserGlobalSize</a>(hDDE));
00682 
00683     <span class="keywordflow">if</span> (!fIsExecute) {
00684         <span class="keywordflow">switch</span> (pdde-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o1">wFmt</a>) {
00685         <span class="keywordflow">case</span> CF_BITMAP:
00686         <span class="keywordflow">case</span> CF_DSPBITMAP:
00687             pddeNew-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o2">Data</a> = (ULONG_PTR)<a class="code" href="../../d0/d9/hdata_8c.html#a11">CopyBitmap</a>((HBITMAP)pdde-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o2">Data</a>);
00688             <span class="keywordflow">break</span>;
00689 
00690         <span class="keywordflow">case</span> CF_PALETTE:
00691             pddeNew-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o2">Data</a> = (ULONG_PTR)<a class="code" href="../../d0/d9/hdata_8c.html#a12">CopyPalette</a>((HPALETTE)pdde-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o2">Data</a>);
00692             <span class="keywordflow">break</span>;
00693 
00694         <span class="keywordflow">case</span> CF_DIB:
00695             pddeNew-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o2">Data</a> = (ULONG_PTR)<a class="code" href="../../d0/d9/hdata_8c.html#a13">CopyDDEData</a>((HANDLE)pdde-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o2">Data</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00696             <span class="keywordflow">break</span>;
00697 
00698         <span class="keywordflow">case</span> CF_METAFILEPICT:
00699         <span class="keywordflow">case</span> CF_DSPMETAFILEPICT:
00700             hmfPict = <a class="code" href="../../d0/d9/hdata_8c.html#a13">CopyDDEData</a>((HANDLE)pdde-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o2">Data</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00701             <a class="code" href="../../d6/d0/usercli_8h.html#a4">USERGLOBALLOCK</a>(hmfPict, pmfPict);
00702             <span class="keywordflow">if</span> (pmfPict == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00703                 <a class="code" href="../../d6/d0/usercli_8h.html#a7">WOWGLOBALFREE</a>(hmfPict);
00704                 <a class="code" href="../../d6/d0/usercli_8h.html#a1">USERGLOBALUNLOCK</a>(hDDENew);
00705                 <a class="code" href="../../d6/d0/usercli_8h.html#a7">WOWGLOBALFREE</a>(hDDENew);
00706                 <a class="code" href="../../d6/d0/usercli_8h.html#a1">USERGLOBALUNLOCK</a>(hDDE);
00707                 <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00708             }
00709             pmfPict-&gt;hMF = CopyMetaFile(pmfPict-&gt;hMF, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00710             <a class="code" href="../../d6/d0/usercli_8h.html#a1">USERGLOBALUNLOCK</a>(hmfPict);
00711             pddeNew-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o2">Data</a> = (ULONG_PTR)hmfPict;
00712             <span class="keywordflow">break</span>;
00713 
00714         <span class="keywordflow">case</span> CF_ENHMETAFILE:
00715         <span class="keywordflow">case</span> CF_DSPENHMETAFILE:
00716             pddeNew-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o2">Data</a> = (ULONG_PTR)CopyEnhMetaFile((HANDLE)pdde-&gt;<a class="code" href="../../d4/d2/structtagDDE__DATA.html#o2">Data</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00717             <span class="keywordflow">break</span>;
00718         }
00719     }
00720     <a class="code" href="../../d6/d0/usercli_8h.html#a1">USERGLOBALUNLOCK</a>(hDDENew);
00721     <a class="code" href="../../d6/d0/usercli_8h.html#a1">USERGLOBALUNLOCK</a>(hDDE);
00722     <span class="keywordflow">return</span> (hDDENew);
00723 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:15 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
