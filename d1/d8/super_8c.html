<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: super.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>super.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>
<code>#include "zwapi.h"</code><br>

<p>
<a href="../../d2/d7/super_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/struct__MMSUPER__SECTION.html">_MMSUPER_SECTION</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/super_8c.html#a0">MM_MAX_SUPERSECTION_COUNT</a>&nbsp;&nbsp;&nbsp;(32)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/super_8c.html#a1">STATUS_TOO_MANY_SECTIONS</a>&nbsp;&nbsp;&nbsp;((NTSTATUS)0xC0033333)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/super_8c.html#a2">STATUS_INCOMPLETE_MAP</a>&nbsp;&nbsp;&nbsp;((NTSTATUS)0xC0033334)</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d2/d6/struct__MMSUPER__SECTION.html">_MMSUPER_SECTION</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/super_8c.html#a5">MMSUPER_SECTION</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d2/d6/struct__MMSUPER__SECTION.html">_MMSUPER_SECTION</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/super_8c.html#a6">PMMSUPER_SECTION</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/super_8c.html#a7">MiSuperSectionDelete</a> (PVOID Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/super_8c.html#a8">MiSuperSectionInitialization</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/super_8c.html#a9">NtCreateSuperSection</a> (OUT PHANDLE SuperSectionHandle, IN ACCESS_MASK DesiredAccess, IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a> OPTIONAL, IN ULONG <a class="el" href="../../d6/d0/cmdat_8c.html#a5">Count</a>, IN HANDLE SectionHandles[])</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/super_8c.html#a10">NtOpenSuperSection</a> (OUT PHANDLE SuperSectionHandle, IN ACCESS_MASK DesiredAccess, IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a> OPTIONAL,)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/super_8c.html#a11">NtMapViewOfSuperSection</a> (IN HANDLE SuperSectionHandle, IN HANDLE ProcessHandle, IN OUT PULONG <a class="el" href="../../d6/d0/cmdat_8c.html#a5">Count</a>, OUT PVOID BaseAddress[], OUT ULONG ViewSize[], IN SECTION_INHERIT InheritDisposition,)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/super_8c.html#a3">MmSuperSectionObjectType</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>GENERIC_MAPPING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/super_8c.html#a4">MiSectionMapping</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="super.c::MM_MAX_SUPERSECTION_COUNT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MM_MAX_SUPERSECTION_COUNT&nbsp;&nbsp;&nbsp;(32)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/super_8c-source.html#l00039">39</a> of file <a class="el" href="../../d2/d7/super_8c-source.html">super.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/super_8c-source.html#l00056">NtCreateSuperSection()</a>, and <a class="el" href="../../d2/d7/super_8c-source.html#l00311">NtMapViewOfSuperSection()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="super.c::STATUS_INCOMPLETE_MAP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define STATUS_INCOMPLETE_MAP&nbsp;&nbsp;&nbsp;((NTSTATUS)0xC0033334)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/super_8c-source.html#l00044">44</a> of file <a class="el" href="../../d2/d7/super_8c-source.html">super.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/super_8c-source.html#l00311">NtMapViewOfSuperSection()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="super.c::STATUS_TOO_MANY_SECTIONS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define STATUS_TOO_MANY_SECTIONS&nbsp;&nbsp;&nbsp;((NTSTATUS)0xC0033333)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/super_8c-source.html#l00043">43</a> of file <a class="el" href="../../d2/d7/super_8c-source.html">super.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/super_8c-source.html#l00056">NtCreateSuperSection()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a5" doxytag="super.c::MMSUPER_SECTION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d2/d6/struct__MMSUPER__SECTION.html">_MMSUPER_SECTION</a>  <a class="el" href="../../d2/d6/struct__MMSUPER__SECTION.html">MMSUPER_SECTION</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d2/d7/super_8c-source.html#l00056">NtCreateSuperSection()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="super.c::PMMSUPER_SECTION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d2/d6/struct__MMSUPER__SECTION.html">_MMSUPER_SECTION</a> * <a class="el" href="../../d2/d6/struct__MMSUPER__SECTION.html">PMMSUPER_SECTION</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d2/d7/super_8c-source.html#l00535">MiSuperSectionDelete()</a>, <a class="el" href="../../d2/d7/super_8c-source.html#l00056">NtCreateSuperSection()</a>, and <a class="el" href="../../d2/d7/super_8c-source.html#l00311">NtMapViewOfSuperSection()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a7" doxytag="super.c::MiSuperSectionDelete" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiSuperSectionDelete           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Object</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/super_8c-source.html#l00535">535</a> of file <a class="el" href="../../d2/d7/super_8c-source.html">super.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d2/d7/super_8c-source.html#l00535">MiSuperSectionDelete()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/super_8c.html#a6">PMMSUPER_SECTION</a>, <a class="el" href="../../d2/d7/super_8c-source.html#l00051">_MMSUPER_SECTION::SectionPointers</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/super_8c-source.html#l00535">MiSuperSectionDelete()</a>, and <a class="el" href="../../d2/d7/super_8c-source.html#l00588">MiSuperSectionInitialization()</a>.
<p>
<pre class="fragment"><div>00541                    :
00542 
00543 
00544     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object management procedures whenever
00545     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last reference to a super section object has been removed.
00546     This routine dereferences <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> associated segment objects.
00547 
00548 Arguments:
00549 
00550     Object - a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> body of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supersection object.
00551 
00552 Return Value:
00553 
00554     None.
00555 
00556 --*/
00557 
00558 {
00559     <a class="code" href="../../d2/d6/struct__MMSUPER__SECTION.html">PMMSUPER_SECTION</a> SuperSection;
00560     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
00561     KIRQL OldIrql;
00562     ULONG i = 0;
00563 
00564     SuperSection = (<a class="code" href="../../d2/d6/struct__MMSUPER__SECTION.html">PMMSUPER_SECTION</a>)Object;
00565 
00566     <span class="keywordflow">do</span> {
00567 
00568         <span class="comment">//</span>
00569         <span class="comment">// For each section increment the number of section references</span>
00570         <span class="comment">// count.</span>
00571         <span class="comment">//</span>
00572 
00573         ControlArea = SuperSection-&gt;<a class="code" href="../../d2/d6/struct__MMSUPER__SECTION.html#o1">SectionPointers</a>[i]-&gt;Segment-&gt;ControlArea;
00574 
00575         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00576         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o2">NumberOfSectionReferences</a> -= 1;
00577         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o7">NumberOfUserReferences</a> -= 1;
00578         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00579         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (SuperSection-&gt;<a class="code" href="../../d2/d6/struct__MMSUPER__SECTION.html#o1">SectionPointers</a>[i]);
00580         i++;
00581 
00582     } <span class="keywordflow">while</span> (i &lt; SuperSection-&gt;<a class="code" href="../../d2/d6/struct__MMSUPER__SECTION.html#o0">NumberOfSections</a>);
00583 
00584     <span class="keywordflow">return</span>;
00585 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="super.c::MiSuperSectionInitialization" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN MiSuperSectionInitialization           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/super_8c-source.html#l00588">588</a> of file <a class="el" href="../../d2/d7/super_8c-source.html">super.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l00056">MiSectionMapping</a>, <a class="el" href="../../d2/d7/super_8c-source.html#l00535">MiSuperSectionDelete()</a>, <a class="el" href="../../d2/d7/super_8c-source.html#l00041">MmSuperSectionObjectType</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d1/obtype_8c-source.html#l00069">ObCreateObjectType()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00593                    :
00594 
00595     This function creates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> descriptor at system
00596     initialization and stores <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> descriptor
00597     in global storage.
00598 
00599 Arguments:
00600 
00601     None.
00602 
00603 Return Value:
00604 
00605     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - Initialization was successful.
00606 
00607     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - Initialization Failed.
00608 
00609 
00610 
00611 --*/
00612 
00613 {
00614     <a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html">OBJECT_TYPE_INITIALIZER</a> ObjectTypeInitializer;
00615     UNICODE_STRING TypeName;
00616 
00617     <span class="comment">//</span>
00618     <span class="comment">// Initialize the common fields of the Object Type Initializer record</span>
00619     <span class="comment">//</span>
00620 
00621     RtlZeroMemory( &amp;ObjectTypeInitializer, <span class="keyword">sizeof</span>( ObjectTypeInitializer ) );
00622     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o0">Length</a> = <span class="keyword">sizeof</span>( ObjectTypeInitializer );
00623     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o3">InvalidAttributes</a> = OBJ_OPENLINK;
00624     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> = <a class="code" href="../../d5/d5/sectsup_8c.html#a7">MiSectionMapping</a>;
00625     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a> = <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>;
00626 
00627     <span class="comment">//</span>
00628     <span class="comment">// Initialize string descriptor.</span>
00629     <span class="comment">//</span>
00630 
00631     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;TypeName, L<span class="stringliteral">"SuperSection"</span>);
00632 
00633     <span class="comment">//</span>
00634     <span class="comment">// Create the section object type descriptor</span>
00635     <span class="comment">//</span>
00636 
00637     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o5">ValidAccessMask</a> = SECTION_ALL_ACCESS;
00638     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o15">DeleteProcedure</a> = <a class="code" href="../../d1/d8/super_8c.html#a7">MiSuperSectionDelete</a>;
00639     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> = <a class="code" href="../../d5/d5/sectsup_8c.html#a7">MiSectionMapping</a>;
00640     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o1">UseDefaultObject</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00641     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>(&amp;TypeName,
00642                                      &amp;ObjectTypeInitializer,
00643                                      (PSECURITY_DESCRIPTOR) NULL,
00644                                      &amp;MmSuperSectionObjectType
00645                                      )) ) {
00646         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00647     }
00648 
00649     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00650 
00651 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="super.c::NtCreateSuperSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtCreateSuperSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>SuperSectionHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Count</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionHandles</em>[]</td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/super_8c-source.html#l00056">56</a> of file <a class="el" href="../../d2/d7/super_8c-source.html">super.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l02001">_SEGMENT::ControlArea</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d2/d7/super_8c-source.html#l00039">MM_MAX_SUPERSECTION_COUNT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00381">MmSectionObjectType</a>, <a class="el" href="../../d1/d8/super_8c.html#a5">MMSUPER_SECTION</a>, <a class="el" href="../../d2/d7/super_8c-source.html#l00041">MmSuperSectionObjectType</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02060">_CONTROL_AREA::NumberOfSectionReferences</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02065">_CONTROL_AREA::NumberOfUserReferences</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/super_8c.html#a6">PMMSUPER_SECTION</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01564">ProbeForWriteHandle</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00036">PSECTION</a>, <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00562">RefCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02058">_CONTROL_AREA::Segment</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d7/super_8c-source.html#l00043">STATUS_TOO_MANY_SECTIONS</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
<pre class="fragment"><div>00066                    :
00067 
00068     This routine creates a super section object.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> supersection
00069     object consists a group of sections that are mapped as images.
00070 
00071 Arguments:
00072 
00073     SuperSectionHandle - Returns a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> created supersection.
00074 
00075     DesiredAccess - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> super section.
00076 
00077     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object attributes <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> super
00078                        section.
00079 
00080     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of sections contained in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section
00081             handle array.
00082 
00083     SectionHandles[] - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section handles to place into
00084                        <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supersection.
00085 
00086 
00087 Return Value:
00088 
00089     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status
00090 
00091     TBS
00092 
00093 --*/
00094 
00095 {
00096     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00097     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a> Section;
00098     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
00099     HANDLE CapturedHandle;
00100     HANDLE CapturedHandles[<a class="code" href="../../d1/d8/super_8c.html#a0">MM_MAX_SUPERSECTION_COUNT</a>];
00101     <a class="code" href="../../d2/d6/struct__MMSUPER__SECTION.html">PMMSUPER_SECTION</a> SuperSection;
00102     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00103     ULONG <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a5">RefCount</a>;
00104     ULONG i;
00105     KIRQL OldIrql;
00106 
00107     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> &gt; <a class="code" href="../../d1/d8/super_8c.html#a0">MM_MAX_SUPERSECTION_COUNT</a>) {
00108         <span class="keywordflow">return</span> <a class="code" href="../../d1/d8/super_8c.html#a1">STATUS_TOO_MANY_SECTIONS</a>;
00109     }
00110 
00111     <span class="keywordflow">try</span> {
00112 
00113         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00114             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a> (SuperSectionHandle);
00115         }
00116 
00117         i= 0;
00118         <span class="keywordflow">do</span> {
00119             CapturedHandles[i] = SectionHandles[i];
00120             i += 1;
00121         } <span class="keywordflow">while</span> (i &lt; <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>);
00122 
00123     } except (<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00124 
00125         <span class="comment">//</span>
00126         <span class="comment">// If an exception occurs during the probe or capture</span>
00127         <span class="comment">// of the initial values, then handle the exception and</span>
00128         <span class="comment">// return the exception code as the status value.</span>
00129         <span class="comment">//</span>
00130 
00131         <span class="keywordflow">return</span> GetExceptionCode();
00132     }
00133 
00134     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a> (PreviousMode,
00135                              MmSuperSectionObjectType,
00136                              ObjectAttributes,
00137                              PreviousMode,
00138                              NULL,
00139                              <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/struct__MMSUPER__SECTION.html">MMSUPER_SECTION</a>) +
00140                                        (<span class="keyword">sizeof</span>(PSECTION) * (Count - 1)),
00141                              <span class="keyword">sizeof</span>(MMSUPER_SECTION) +
00142                                        (<span class="keyword">sizeof</span>(PSECTION) * (Count - 1)),
00143                              0,
00144                              (PVOID *)&amp;SuperSection);
00145 
00146     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00147         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00148     }
00149 
00150     SuperSection-&gt;<a class="code" href="../../d2/d6/struct__MMSUPER__SECTION.html#o0">NumberOfSections</a> = <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00151 
00152     i = 0;
00153     <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a5">RefCount</a> = 0;
00154     <span class="keywordflow">do</span> {
00155 
00156         <span class="comment">//</span>
00157         <span class="comment">// Get a referenced pointer to the specified objects with</span>
00158         <span class="comment">// the desired access.</span>
00159         <span class="comment">//</span>
00160 
00161         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(CapturedHandles[i],
00162                                            DesiredAccess,
00163                                            MmSectionObjectType,
00164                                            PreviousMode,
00165                                            (PVOID *)&amp;Section,
00166                                            NULL);
00167 
00168         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00169             <span class="keywordflow">if</span> (Section-&gt;u.Flags.Image == 0) {
00170 
00171                 <span class="comment">//</span>
00172                 <span class="comment">// This is not an image section, return an error.</span>
00173                 <span class="comment">//</span>
00174 
00175                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SECTION_NOT_IMAGE;
00176                 <span class="keywordflow">goto</span> ServiceFailed;
00177             }
00178             <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a5">RefCount</a> += 1;
00179             SuperSection-&gt;<a class="code" href="../../d2/d6/struct__MMSUPER__SECTION.html#o1">SectionPointers</a>[i] = Section;
00180         } <span class="keywordflow">else</span> {
00181             <span class="keywordflow">goto</span> ServiceFailed;
00182         }
00183 
00184         i += 1;
00185     } <span class="keywordflow">while</span> (i &lt; <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>);
00186 
00187     i= 0;
00188     <span class="keywordflow">do</span> {
00189 
00190         <span class="comment">//</span>
00191         <span class="comment">// For each section increment the number of section references</span>
00192         <span class="comment">// count.</span>
00193         <span class="comment">//</span>
00194 
00195         ControlArea = SuperSection-&gt;<a class="code" href="../../d2/d6/struct__MMSUPER__SECTION.html#o1">SectionPointers</a>[i]-&gt;Segment-&gt;ControlArea;
00196 
00197         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00198         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o2">NumberOfSectionReferences</a> += 1;
00199         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o7">NumberOfUserReferences</a> += 1;
00200         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00201         i++;
00202 
00203     } <span class="keywordflow">while</span> (i &lt; <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>);
00204 
00205 
00206     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a> (SuperSection,
00207                              NULL,
00208                              DesiredAccess,
00209                              0,
00210                              (PVOID *)NULL,
00211                              &amp;CapturedHandle);
00212 
00213     <span class="keywordflow">try</span> {
00214         *SuperSectionHandle = CapturedHandle;
00215     } except (EXCEPTION_EXECUTE_HANDLER) {
00216         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00217     }
00218     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00219 
00220 ServiceFailed:
00221     <span class="keywordflow">while</span> (<a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a5">RefCount</a> &gt; 0) {
00222         <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a5">RefCount</a> -= 1;
00223         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(SuperSection-&gt;<a class="code" href="../../d2/d6/struct__MMSUPER__SECTION.html#o1">SectionPointers</a>[RefCount]);
00224     }
00225 
00226     <span class="comment">//</span>
00227     <span class="comment">// Delete the supersection object as it was never inserted into</span>
00228     <span class="comment">// a handle table.</span>
00229     <span class="comment">//</span>
00230 
00231     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (SuperSection);
00232     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00233 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="super.c::NtMapViewOfSuperSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtMapViewOfSuperSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>SuperSectionHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Count</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>[], </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ViewSize</em>[], </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SECTION_INHERIT&nbsp;</td>
          <td class="mdname" nowrap> <em>InheritDisposition</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/super_8c-source.html#l00311">311</a> of file <a class="el" href="../../d2/d7/super_8c-source.html">super.c</a>.
<p>
References <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d2/d7/super_8c-source.html#l00039">MM_MAX_SUPERSECTION_COUNT</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00753">MmMapViewOfSection()</a>, <a class="el" href="../../d2/d7/super_8c-source.html#l00041">MmSuperSectionObjectType</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/super_8c.html#a6">PMMSUPER_SECTION</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01649">ProbeForWriteUlong</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00088">PsProcessType</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d2/d7/super_8c-source.html#l00044">STATUS_INCOMPLETE_MAP</a>.
<p>
<pre class="fragment"><div>00322                    :
00323 
00324     This routine maps into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process a view of each
00325     section contained within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supersection.
00326 
00327 Arguments:
00328 
00329     SuperSectionHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supersection.
00330 
00331     ProcessHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process in which to
00332                     map <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supersection's sections.
00333 
00334     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of elements in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> BaseAddress and
00335             ViewSize arrays, returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of views actually
00336             mapped.
00337 
00338 
00339     BaseAddresses[] - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address of each view that was mapped.
00340 
00341     ViewSize[] - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view size of each view that was mapped.
00342 
00343     InheritDisposition - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> inherit disposition to be applied
00344                          to each section which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> contained in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00345                          super section.
00346 
00347 Return Value:
00348 
00349     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status
00350 
00351     TBS
00352 
00353 --*/
00354 
00355 {
00356     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00357     PVOID CapturedBases[<a class="code" href="../../d1/d8/super_8c.html#a0">MM_MAX_SUPERSECTION_COUNT</a>];
00358     ULONG CapturedViews[<a class="code" href="../../d1/d8/super_8c.html#a0">MM_MAX_SUPERSECTION_COUNT</a>];
00359     <a class="code" href="../../d2/d6/struct__MMSUPER__SECTION.html">PMMSUPER_SECTION</a> SuperSection;
00360     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00361     ULONG i;
00362     ULONG CapturedCount;
00363     ULONG NumberMapped;
00364     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00365     LARGE_INTEGER LargeZero = {0,0};
00366 
00367 
00368     PreviousMode = KeGetPreviousMode();
00369 
00370     <span class="keywordflow">try</span> {
00371         <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a> (Count);
00372         CapturedCount = *<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00373 
00374         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00375             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a> (BaseAddress,
00376                            <span class="keyword">sizeof</span>(PVOID) * CapturedCount,
00377                            <span class="keyword">sizeof</span>(PVOID));
00378             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a> (ViewSize,
00379                            <span class="keyword">sizeof</span>(ULONG) * CapturedCount,
00380                            <span class="keyword">sizeof</span>(ULONG));
00381         }
00382 
00383     } except (<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00384 
00385         <span class="comment">//</span>
00386         <span class="comment">// If an exception occurs during the probe or capture</span>
00387         <span class="comment">// of the initial values, then handle the exception and</span>
00388         <span class="comment">// return the exception code as the status value.</span>
00389         <span class="comment">//</span>
00390 
00391         <span class="keywordflow">return</span> GetExceptionCode();
00392     }
00393 
00394     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> ( ProcessHandle,
00395                                          PROCESS_VM_OPERATION,
00396                                          PsProcessType,
00397                                          PreviousMode,
00398                                          (PVOID *)&amp;Process,
00399                                          NULL );
00400     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00401         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00402     }
00403 
00404     <span class="comment">//</span>
00405     <span class="comment">// Reference the supersection object.</span>
00406     <span class="comment">//</span>
00407 
00408     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> ( SuperSectionHandle,
00409                                          SECTION_MAP_EXECUTE,
00410                                          MmSuperSectionObjectType,
00411                                          PreviousMode,
00412                                          (PVOID *)&amp;SuperSection,
00413                                          NULL );
00414 
00415     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00416         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (Process);
00417         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00418     }
00419 
00420     <span class="keywordflow">if</span> (CapturedCount &lt; SuperSection-&gt;<a class="code" href="../../d2/d6/struct__MMSUPER__SECTION.html#o0">NumberOfSections</a>) {
00421         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (Process);
00422         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (SuperSection);
00423         <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00424     }
00425 
00426     NumberMapped = 0;
00427     <span class="keywordflow">do</span> {
00428 
00429         <span class="comment">//</span>
00430         <span class="comment">// For each section within the supersection, map a view in</span>
00431         <span class="comment">// the specified process.</span>
00432         <span class="comment">//</span>
00433 
00434         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a21">MmMapViewOfSection</a> (SuperSection-&gt;<a class="code" href="../../d2/d6/struct__MMSUPER__SECTION.html#o1">SectionPointers</a>[i],
00435                                      Process,
00436                                      &amp;CapturedBases[i],
00437                                      0,
00438                                      0,
00439                                      &amp;LargeZero,
00440                                      &amp;CapturedViews[i],
00441                                      InheritDisposition,
00442                                      0,
00443                                      PAGE_EXECUTE);
00444 
00445         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (Status) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00446             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d8/super_8c.html#a2">STATUS_INCOMPLETE_MAP</a>;
00447             <span class="keywordflow">break</span>;
00448         }
00449         NumberMapped++;
00450     } <span class="keywordflow">while</span> (NumberMapped &lt; SuperSection-&gt;<a class="code" href="../../d2/d6/struct__MMSUPER__SECTION.html#o0">NumberOfSections</a>);
00451 
00452     <span class="comment">//</span>
00453     <span class="comment">// Dereference the supersection and the process.</span>
00454     <span class="comment">//</span>
00455 
00456     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (SuperSection);
00457     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (Process);
00458 
00459     <span class="keywordflow">try</span> {
00460         *<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = NumberMapped;
00461         i = 0;
00462 
00463         <span class="keywordflow">do</span> {
00464 
00465             <span class="comment">//</span>
00466             <span class="comment">// Store the captured view base and sizes for each section</span>
00467             <span class="comment">// that was mapped.</span>
00468             <span class="comment">//</span>
00469 
00470             BaseAddress[i] = CapturedBases[i];
00471             ViewSize[i] = CapturedViews[i];
00472 
00473             i++;
00474         } <span class="keywordflow">while</span> (i &lt; NumberMapped);
00475 
00476     } except (<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00477         NOTHING;
00478     }
00479 
00480     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00481 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="super.c::NtOpenSuperSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtOpenSuperSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>SuperSectionHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/super_8c-source.html#l00237">237</a> of file <a class="el" href="../../d2/d7/super_8c-source.html">super.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d2/d7/super_8c-source.html#l00041">MmSuperSectionObjectType</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00095">ObOpenObjectByName()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01564">ProbeForWriteHandle</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>00245                    :
00246 
00247     This routine opens a super section object.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> supersection
00248     object consists a group of sections that are mapped as images.
00249 
00250 Arguments:
00251 
00252     SuperSectionHandle - Returns a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> created supersection.
00253 
00254     DesiredAccess - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> super section.
00255 
00256     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object attributes <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> super
00257                        section.
00258 
00259 
00260 Return Value:
00261 
00262     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status
00263 
00264     TBS
00265 
00266 --*/
00267 
00268 {
00269     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00270     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00271     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00272 
00273     <span class="comment">//</span>
00274     <span class="comment">// Get previous processor mode and probe output arguments if necessary.</span>
00275     <span class="comment">//</span>
00276 
00277     PreviousMode = KeGetPreviousMode();
00278     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00279         <span class="keywordflow">try</span> {
00280             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>(SuperSectionHandle);
00281         } except (EXCEPTION_EXECUTE_HANDLER) {
00282             <span class="keywordflow">return</span> GetExceptionCode();
00283         }
00284     }
00285 
00286     <span class="comment">//</span>
00287     <span class="comment">// Open handle to the super section object with the specified desired</span>
00288     <span class="comment">// access.</span>
00289     <span class="comment">//</span>
00290 
00291     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a> (ObjectAttributes,
00292                                  MmSuperSectionObjectType,
00293                                  PreviousMode,
00294                                  NULL,
00295                                  DesiredAccess,
00296                                  NULL,
00297                                  &amp;Handle
00298                                  );
00299 
00300     <span class="keywordflow">try</span> {
00301         *SuperSectionHandle = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00302     } except (EXCEPTION_EXECUTE_HANDLER) {
00303         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00304     }
00305 
00306     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00307 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a4" doxytag="super.c::MiSectionMapping" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> GENERIC_MAPPING <a class="el" href="../../d1/d8/super_8c.html#a4">MiSectionMapping</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/super_8c-source.html#l00047">47</a> of file <a class="el" href="../../d2/d7/super_8c-source.html">super.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d4/sectsup_8c-source.html#l00768">MiSectionInitialization()</a>, and <a class="el" href="../../d2/d7/super_8c-source.html#l00588">MiSuperSectionInitialization()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="super.c::MmSuperSectionObjectType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="el" href="../../d1/d8/super_8c.html#a3">MmSuperSectionObjectType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/super_8c-source.html#l00041">41</a> of file <a class="el" href="../../d2/d7/super_8c-source.html">super.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/super_8c-source.html#l00588">MiSuperSectionInitialization()</a>, <a class="el" href="../../d2/d7/super_8c-source.html#l00056">NtCreateSuperSection()</a>, <a class="el" href="../../d2/d7/super_8c-source.html#l00311">NtMapViewOfSuperSection()</a>, and <a class="el" href="../../d2/d7/super_8c-source.html#l00237">NtOpenSuperSection()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:42 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
