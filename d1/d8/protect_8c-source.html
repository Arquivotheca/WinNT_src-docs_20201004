<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: protect.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>protect.c</h1><a href="../../d0/d9/protect_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">   protect.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the routines which implement the</span>
00012 <span class="comment">    NtProtectVirtualMemory service.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Lou Perazzoli (loup) 18-Aug-1989</span>
00017 <span class="comment">    Landy Wang (landyw) 02-June-1997</span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
00023 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00024 
00025 <span class="preprocessor">#if DBG</span>
00026 <span class="preprocessor"></span><a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> MmWatchProcess;
00027 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> MmFooBar(VOID);
00028 <span class="preprocessor">#endif // DBG</span>
00029 <span class="preprocessor"></span>
00030 HARDWARE_PTE
00031 <a class="code" href="../../d0/d9/protect_8c.html#a1">MiFlushTbAndCapture</a>(
00032     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PtePointer,
00033     IN HARDWARE_PTE TempPte,
00034     IN <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1
00035     );
00036 
00037 ULONG
00038 <a class="code" href="../../d8/d8/sysload_8c.html#a41">MiSetProtectionOnTransitionPte</a> (
00039     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
00040     IN ULONG ProtectionMask
00041     );
00042 
00043 <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>
00044 <a class="code" href="../../d5/d3/queryvm_8c.html#a2">MiCaptureSystemPte</a> (
00045     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerProtoPte,
00046     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
00047     );
00048 
00049 <span class="preprocessor">#if PFN_CONSISTENCY</span>
00050 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00051 MiSetOriginalPteProtection (
00052     IN <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1,
00053     IN ULONG ProtectionMask
00054     )
00055 #endif <span class="comment">// PFN_CONSISTENCY</span>
00056 
<a name="l00057"></a><a class="code" href="../../d0/d9/protect_8c.html#a0">00057</a> <span class="keyword">extern</span> CCHAR <a class="code" href="../../d5/d3/acceschk_8c.html#a0">MmReadWrite</a>[32];
00058 
00059 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00060 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtProtectVirtualMemory)</span>
00061 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiProtectVirtualMemory)</span>
00062 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiSetProtectionOnSection)</span>
00063 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiGetPageProtection)</span>
00064 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiChangeNoAccessForkPte)</span>
00065 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00066 <span class="preprocessor"></span>
00067 
00068 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00069"></a><a class="code" href="../../d0/d9/protect_8c.html#a4">00069</a> <a class="code" href="../../d0/d9/protect_8c.html#a4">NtProtectVirtualMemory</a>(
00070      IN HANDLE ProcessHandle,
00071      IN OUT PVOID *BaseAddress,
00072      IN OUT PSIZE_T RegionSize,
00073      IN ULONG NewProtect,
00074      OUT PULONG OldProtect
00075      )
00076 
00077 <span class="comment">/*++</span>
00078 <span class="comment"></span>
00079 <span class="comment">Routine Description:</span>
00080 <span class="comment"></span>
00081 <span class="comment">    This routine changes the protection on a region of committed pages</span>
00082 <span class="comment">    within the virtual address space of the subject process.  Setting</span>
00083 <span class="comment">    the protection on a range of pages causes the old protection to be</span>
00084 <span class="comment">    replaced by the specified protection value.</span>
00085 <span class="comment"></span>
00086 <span class="comment">Arguments:</span>
00087 <span class="comment"></span>
00088 <span class="comment">     ProcessHandle - An open handle to a process object.</span>
00089 <span class="comment"></span>
00090 <span class="comment">     BaseAddress - The base address of the region of pages</span>
00091 <span class="comment">          whose protection is to be changed. This value is</span>
00092 <span class="comment">          rounded down to the next host page address</span>
00093 <span class="comment">          boundary.</span>
00094 <span class="comment"></span>
00095 <span class="comment">     RegionSize - A pointer to a variable that will receive</span>
00096 <span class="comment">          the actual size in bytes of the protected region</span>
00097 <span class="comment">          of pages. The initial value of this argument is</span>
00098 <span class="comment">          rounded up to the next host page size boundary.</span>
00099 <span class="comment"></span>
00100 <span class="comment">     NewProtect - The new protection desired for the</span>
00101 <span class="comment">          specified region of pages.</span>
00102 <span class="comment"></span>
00103 <span class="comment">     Protect Values</span>
00104 <span class="comment"></span>
00105 <span class="comment">          PAGE_NOACCESS - No access to the specified region</span>
00106 <span class="comment">               of pages is allowed. An attempt to read,</span>
00107 <span class="comment">               write, or execute the specified region</span>
00108 <span class="comment">               results in an access violation (i.e. a GP</span>
00109 <span class="comment">               fault).</span>
00110 <span class="comment"></span>
00111 <span class="comment">          PAGE_EXECUTE - Execute access to the specified</span>
00112 <span class="comment">               region of pages is allowed. An attempt to</span>
00113 <span class="comment">               read or write the specified region results in</span>
00114 <span class="comment">               an access violation.</span>
00115 <span class="comment"></span>
00116 <span class="comment">          PAGE_READONLY - Read only and execute access to the</span>
00117 <span class="comment">               specified region of pages is allowed. An</span>
00118 <span class="comment">               attempt to write the specified region results</span>
00119 <span class="comment">               in an access violation.</span>
00120 <span class="comment"></span>
00121 <span class="comment">          PAGE_READWRITE - Read, write, and execute access to</span>
00122 <span class="comment">               the specified region of pages is allowed. If</span>
00123 <span class="comment">               write access to the underlying section is</span>
00124 <span class="comment">               allowed, then a single copy of the pages are</span>
00125 <span class="comment">               shared. Otherwise the pages are shared read</span>
00126 <span class="comment">               only/copy on write.</span>
00127 <span class="comment"></span>
00128 <span class="comment">          PAGE_GUARD - Read, write, and execute access to the</span>
00129 <span class="comment">               specified region of pages is allowed,</span>
00130 <span class="comment">               however, access to the region causes a "guard</span>
00131 <span class="comment">               region entered" condition to be raised in the</span>
00132 <span class="comment">               subject process. If write access to the</span>
00133 <span class="comment">               underlying section is allowed, then a single</span>
00134 <span class="comment">               copy of the pages are shared. Otherwise the</span>
00135 <span class="comment">               pages are shared read only/copy on write.</span>
00136 <span class="comment"></span>
00137 <span class="comment">          PAGE_NOCACHE - The page should be treated as uncached.</span>
00138 <span class="comment">               This is only valid for non-shared pages.</span>
00139 <span class="comment"></span>
00140 <span class="comment"></span>
00141 <span class="comment">     OldProtect - A pointer to a variable that will receive</span>
00142 <span class="comment">          the old protection of the first page within the</span>
00143 <span class="comment">          specified region of pages.</span>
00144 <span class="comment"></span>
00145 <span class="comment">Return Value:</span>
00146 <span class="comment"></span>
00147 <span class="comment">    Returns the status</span>
00148 <span class="comment"></span>
00149 <span class="comment">    TBS</span>
00150 <span class="comment"></span>
00151 <span class="comment"></span>
00152 <span class="comment">Environment:</span>
00153 <span class="comment"></span>
00154 <span class="comment">    Kernel mode.</span>
00155 <span class="comment"></span>
00156 <span class="comment">--*/</span>
00157 
00158 
00159 {
00160     <span class="comment">//</span>
00161     <span class="comment">// note - special treatment for the following cases...</span>
00162     <span class="comment">//</span>
00163     <span class="comment">// if a page is locked in the working set (memory?) and the</span>
00164     <span class="comment">// protection is changed to no access, the page should be</span>
00165     <span class="comment">// removed from the working set... valid pages can't be no access.</span>
00166     <span class="comment">//</span>
00167     <span class="comment">// if page is going to be read only or no access? and is demand</span>
00168     <span class="comment">// zero, make sure it is changed to a page of zeroes.</span>
00169     <span class="comment">//</span>
00170     <span class="comment">// update the vm spec to explain locked pages are unlocked when</span>
00171     <span class="comment">// freed or protection is changed to no-access (this may be a nasty</span>
00172     <span class="comment">// problem if we don't want to do this!!</span>
00173     <span class="comment">//</span>
00174 
00175     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00176     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00177     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00178     ULONG Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00179     PVOID CapturedBase;
00180     SIZE_T CapturedRegionSize;
00181     ULONG ProtectionMask;
00182 
00183     ULONG LastProtect;
00184 
00185     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00186 
00187     <span class="comment">//</span>
00188     <span class="comment">// Check the protection field.  This could raise an exception.</span>
00189     <span class="comment">//</span>
00190 
00191     <span class="keywordflow">try</span> {
00192         ProtectionMask = <a class="code" href="../../d0/d2/mmsup_8c.html#a5">MiMakeProtectionMask</a> (NewProtect);
00193     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00194         <span class="keywordflow">return</span> GetExceptionCode();
00195     }
00196 
00197     PreviousMode = KeGetPreviousMode();
00198 
00199     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00200 
00201         <span class="comment">//</span>
00202         <span class="comment">// Capture the region size and base address under an exception handler.</span>
00203         <span class="comment">//</span>
00204 
00205         <span class="keywordflow">try</span> {
00206 
00207             <a class="code" href="../../d5/d8/ex_8h.html#a37">ProbeForWritePointer</a> (BaseAddress);
00208             <a class="code" href="../../d5/d8/ex_8h.html#a41">ProbeForWriteUlong_ptr</a> (RegionSize);
00209             <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a> (OldProtect);
00210 
00211             <span class="comment">//</span>
00212             <span class="comment">// Capture the region size and base address.</span>
00213             <span class="comment">//</span>
00214 
00215             CapturedBase = *BaseAddress;
00216             CapturedRegionSize = *RegionSize;
00217 
00218         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00219 
00220             <span class="comment">//</span>
00221             <span class="comment">// If an exception occurs during the probe or capture</span>
00222             <span class="comment">// of the initial values, then handle the exception and</span>
00223             <span class="comment">// return the exception code as the status value.</span>
00224             <span class="comment">//</span>
00225 
00226             <span class="keywordflow">return</span> GetExceptionCode();
00227         }
00228 
00229     } <span class="keywordflow">else</span> {
00230 
00231         <span class="comment">//</span>
00232         <span class="comment">// Capture the region size and base address.</span>
00233         <span class="comment">//</span>
00234 
00235         CapturedRegionSize = *RegionSize;
00236         CapturedBase = *BaseAddress;
00237     }
00238 
00239 <span class="preprocessor">#if DBG</span>
00240 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a81">MM_DBG_SHOW_NT_CALLS</a>) {
00241         <span class="keywordflow">if</span> ( !MmWatchProcess ) {
00242             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"protectvm process handle %lx base address %lx size %lx protect %lx\n"</span>,
00243                 ProcessHandle, CapturedBase, CapturedRegionSize, NewProtect);
00244         }
00245     }
00246 <span class="preprocessor">#endif</span>
00247 <span class="preprocessor"></span>
00248     <span class="comment">//</span>
00249     <span class="comment">// Make sure the specified starting and ending addresses are</span>
00250     <span class="comment">// within the user part of the virtual address space.</span>
00251     <span class="comment">//</span>
00252 
00253     <span class="keywordflow">if</span> (CapturedBase &gt; MM_HIGHEST_USER_ADDRESS) {
00254 
00255         <span class="comment">//</span>
00256         <span class="comment">// Invalid base address.</span>
00257         <span class="comment">//</span>
00258 
00259         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
00260     }
00261 
00262     <span class="keywordflow">if</span> ((ULONG_PTR)MM_HIGHEST_USER_ADDRESS - (ULONG_PTR)CapturedBase &lt;
00263                   CapturedRegionSize) {
00264 
00265         <span class="comment">//</span>
00266         <span class="comment">// Invalid region size;</span>
00267         <span class="comment">//</span>
00268 
00269         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_3;
00270     }
00271 
00272     <span class="keywordflow">if</span> (CapturedRegionSize == 0) {
00273         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_3;
00274     }
00275 
00276     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> ( ProcessHandle,
00277                                          PROCESS_VM_OPERATION,
00278                                          <a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>,
00279                                          PreviousMode,
00280                                          (PVOID *)&amp;Process,
00281                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00282 
00283     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00284         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00285     }
00286 
00287     <span class="comment">//</span>
00288     <span class="comment">// If the specified process is not the current process, attach</span>
00289     <span class="comment">// to the specified process.</span>
00290     <span class="comment">//</span>
00291 
00292     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != Process) {
00293         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;Process-&gt;Pcb);
00294         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00295     }
00296 
00297     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d9/protect_8c.html#a5">MiProtectVirtualMemory</a> (Process,
00298                                      &amp;CapturedBase,
00299                                      &amp;CapturedRegionSize,
00300                                      NewProtect,
00301                                      &amp;LastProtect);
00302 
00303 
00304     <span class="keywordflow">if</span> (Attached) {
00305         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00306     }
00307 
00308     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (Process);
00309 
00310     <span class="comment">//</span>
00311     <span class="comment">// Establish an exception handler and write the size and base</span>
00312     <span class="comment">// address.</span>
00313     <span class="comment">//</span>
00314 
00315     <span class="keywordflow">try</span> {
00316 
00317         <span class="comment">//</span>
00318         <span class="comment">// Reprobe the addresses as certain architectures (intel 386 for one)</span>
00319         <span class="comment">// do not trap kernel writes.  This is the one service which allows</span>
00320         <span class="comment">// the protection of the page to change between the initial probe</span>
00321         <span class="comment">// and the final argument update.</span>
00322         <span class="comment">//</span>
00323 
00324         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00325 
00326             <a class="code" href="../../d5/d8/ex_8h.html#a37">ProbeForWritePointer</a> (BaseAddress);
00327             <a class="code" href="../../d5/d8/ex_8h.html#a41">ProbeForWriteUlong_ptr</a> (RegionSize);
00328             <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a> (OldProtect);
00329         }
00330 
00331         *RegionSize = CapturedRegionSize;
00332         *BaseAddress = CapturedBase;
00333         *OldProtect = LastProtect;
00334 
00335     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00336         NOTHING;
00337     }
00338 
00339     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00340 }
00341 
00342 
00343 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00344"></a><a class="code" href="../../d0/d9/protect_8c.html#a5">00344</a> <a class="code" href="../../d0/d9/protect_8c.html#a5">MiProtectVirtualMemory</a> (
00345     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00346     IN PVOID *BaseAddress,
00347     IN PSIZE_T RegionSize,
00348     IN ULONG NewProtect,
00349     IN PULONG LastProtect
00350     )
00351 
00352 <span class="comment">/*++</span>
00353 <span class="comment"></span>
00354 <span class="comment">Routine Description:</span>
00355 <span class="comment"></span>
00356 <span class="comment">    This routine changes the protection on a region of committed pages</span>
00357 <span class="comment">    within the virtual address space of the subject process.  Setting</span>
00358 <span class="comment">    the protection on a range of pages causes the old protection to be</span>
00359 <span class="comment">    replaced by the specified protection value.</span>
00360 <span class="comment"></span>
00361 <span class="comment">Arguments:</span>
00362 <span class="comment"></span>
00363 <span class="comment">    Process - Supplies a pointer to the current process.</span>
00364 <span class="comment"></span>
00365 <span class="comment">    BaseAddress - Supplies the starting address to protect.</span>
00366 <span class="comment"></span>
00367 <span class="comment">    RegionsSize - Supplies the size of the region to protect.</span>
00368 <span class="comment"></span>
00369 <span class="comment">    NewProtect - Supplies the new protection to set.</span>
00370 <span class="comment"></span>
00371 <span class="comment">    LastProtect - Supplies the address of a kernel owned pointer to</span>
00372 <span class="comment">                store (without probing) the old protection into.</span>
00373 <span class="comment"></span>
00374 <span class="comment"></span>
00375 <span class="comment">Return Value:</span>
00376 <span class="comment"></span>
00377 <span class="comment">    the status of the protect operation.</span>
00378 <span class="comment"></span>
00379 <span class="comment">Environment:</span>
00380 <span class="comment"></span>
00381 <span class="comment">    Kernel mode</span>
00382 <span class="comment"></span>
00383 <span class="comment">--*/</span>
00384 
00385 {
00386     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> FoundVad;
00387     PVOID StartingAddress;
00388     PVOID EndingAddress;
00389     PVOID CapturedBase;
00390     SIZE_T CapturedRegionSize;
00391     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00392     ULONG Attached;
00393     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00394     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
00395     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00396     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00397     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerProtoPte;
00398     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastProtoPte;
00399     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00400     ULONG CapturedOldProtect;
00401     ULONG ProtectionMask;
00402     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00403     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
00404     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PreviousPte;
00405     ULONG Locked;
00406     PVOID Va;
00407     ULONG DoAgain;
00408     ULONG Waited;
00409     PVOID UsedPageTableHandle;
00410     PVOID UsedPageDirectoryHandle;
00411     ULONG WorkingSetIndex;
00412 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00413 <span class="preprocessor"></span>    PVOID OriginalBase;
00414     SIZE_T OriginalRegionSize;
00415     ULONG OriginalProtectionMask;
00416     PVOID StartingAddressFor4k;
00417     PVOID EndingAddressFor4k;
00418     SIZE_T CapturedRegionSizeFor4k;
00419     ULONG CapturedOldProtectFor4k;
00420     BOOLEAN EmulationFor4kPage = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>; 
00421 <span class="preprocessor">#endif</span>
00422 <span class="preprocessor"></span>
00423     Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00424     Locked = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00425 
00426     <span class="comment">//</span>
00427     <span class="comment">// Get the address creation mutex to block multiple threads from</span>
00428     <span class="comment">// creating or deleting address space at the same time.</span>
00429     <span class="comment">// Get the working set mutex so PTEs can be modified.</span>
00430     <span class="comment">// Block APCs so an APC which takes a page</span>
00431     <span class="comment">// fault does not corrupt various structures.</span>
00432     <span class="comment">//</span>
00433 
00434     CapturedBase = *BaseAddress;
00435     CapturedRegionSize = *RegionSize;
00436 
00437 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00438 <span class="preprocessor"></span>    OriginalBase = CapturedBase;
00439     OriginalRegionSize = CapturedRegionSize;
00440 
00441     <span class="keywordflow">if</span> (Process-&gt;Wow64Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00442 
00443         StartingAddressFor4k = (PVOID)<a class="code" href="../../d2/d9/miia64_8h.html#a230">PAGE_4K_ALIGN</a>(OriginalBase);
00444 
00445         EndingAddressFor4k = (PVOID)(((ULONG_PTR)OriginalBase +
00446                                       OriginalRegionSize - 1) | (<a class="code" href="../../d2/d9/miia64_8h.html#a227">PAGE_4K</a> - 1));
00447             
00448         CapturedRegionSizeFor4k = (ULONG_PTR)EndingAddressFor4k - 
00449             (ULONG_PTR)StartingAddressFor4k + 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00450 
00451         OriginalProtectionMask = <a class="code" href="../../d0/d2/mmsup_8c.html#a5">MiMakeProtectionMask</a>(NewProtect);
00452 
00453         EmulationFor4kPage = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00454 
00455     }
00456 <span class="preprocessor">#endif</span>
00457 <span class="preprocessor"></span>
00458     <span class="keywordflow">try</span> {
00459         ProtectionMask = <a class="code" href="../../d0/d2/mmsup_8c.html#a5">MiMakeProtectionMask</a> (NewProtect);
00460     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00461         <span class="keywordflow">return</span> GetExceptionCode();
00462     }
00463 
00464     <a class="code" href="../../d4/d8/mi_8h.html#a161">LOCK_WS_AND_ADDRESS_SPACE</a> (Process);
00465 
00466     <span class="comment">//</span>
00467     <span class="comment">// Make sure the address space was not deleted, if so, return an error.</span>
00468     <span class="comment">//</span>
00469 
00470     <span class="keywordflow">if</span> (Process-&gt;AddressSpaceDeleted != 0) {
00471         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PROCESS_IS_TERMINATING;
00472         <span class="keywordflow">goto</span> ErrorFound;
00473     }
00474 
00475     EndingAddress = (PVOID)(((ULONG_PTR)CapturedBase +
00476                                 CapturedRegionSize - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>));
00477     StartingAddress = (PVOID)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(CapturedBase);
00478     FoundVad = <a class="code" href="../../d4/d8/mi_8h.html#a98">MiCheckForConflictingVad</a> (StartingAddress, EndingAddress);
00479 
00480     <span class="keywordflow">if</span> (FoundVad == (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00481 
00482         <span class="comment">//</span>
00483         <span class="comment">// No virtual address is reserved at the specified base address,</span>
00484         <span class="comment">// return an error.</span>
00485         <span class="comment">//</span>
00486 
00487         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_CONFLICTING_ADDRESSES;
00488         <span class="keywordflow">goto</span> ErrorFound;
00489     }
00490 
00491     <span class="comment">//</span>
00492     <span class="comment">// Ensure that the starting and ending addresses are all within</span>
00493     <span class="comment">// the same virtual address descriptor.</span>
00494     <span class="comment">//</span>
00495 
00496     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (StartingAddress) &lt; FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>) ||
00497         (<a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndingAddress) &gt; FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>)) {
00498 
00499         <span class="comment">//</span>
00500         <span class="comment">// Not within the section virtual address descriptor,</span>
00501         <span class="comment">// return an error.</span>
00502         <span class="comment">//</span>
00503 
00504         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_CONFLICTING_ADDRESSES;
00505         <span class="keywordflow">goto</span> ErrorFound;
00506     }
00507 
00508     <span class="keywordflow">if</span> (FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.UserPhysicalPages == 1) {
00509 
00510         <span class="comment">//</span>
00511         <span class="comment">// These must always be readwrite.</span>
00512         <span class="comment">//</span>
00513 
00514         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_CONFLICTING_ADDRESSES;
00515         <span class="keywordflow">goto</span> ErrorFound;
00516     }
00517 
00518     <span class="keywordflow">if</span> (FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PhysicalMapping == 1) {
00519 
00520         <span class="comment">//</span>
00521         <span class="comment">// Setting the protection of a physically mapped section is</span>
00522         <span class="comment">// not allowed as there is no corresponding PFN database element.</span>
00523         <span class="comment">//</span>
00524 
00525         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_CONFLICTING_ADDRESSES;
00526         <span class="keywordflow">goto</span> ErrorFound;
00527     }
00528 
00529     <span class="keywordflow">if</span> (FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange == 1) {
00530 
00531         <span class="comment">//</span>
00532         <span class="comment">// An attempt is made at changing the protection</span>
00533         <span class="comment">// of a secured VAD, check to see if the address range</span>
00534         <span class="comment">// to change allows the change.</span>
00535         <span class="comment">//</span>
00536 
00537         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d9/protect_8c.html#a9">MiCheckSecuredVad</a> (FoundVad,
00538                                     CapturedBase,
00539                                     CapturedRegionSize,
00540                                     ProtectionMask);
00541 
00542         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00543             <span class="keywordflow">goto</span> ErrorFound;
00544         }
00545     }
00546 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00547 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (EmulationFor4kPage == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00548         <span class="comment">//</span>
00549         <span class="comment">// if not secured, relax the protection</span>
00550         <span class="comment">//</span>
00551 
00552         NewProtect = <a class="code" href="../../d2/d9/miia64_8h.html#a317">MiMakeProtectForNativePage</a>(StartingAddressFor4k, 
00553                                                 NewProtect, 
00554                                                 Process);
00555 
00556         ProtectionMask = <a class="code" href="../../d0/d2/mmsup_8c.html#a5">MiMakeProtectionMask</a> (NewProtect);
00557     }
00558 <span class="preprocessor">#endif</span>
00559 <span class="preprocessor"></span>
00560     <span class="keywordflow">if</span> (FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PrivateMemory == 0) {
00561 
00562 
00563         <span class="comment">//</span>
00564         <span class="comment">// For mapped sections, the NO_CACHE attribute is not allowed.</span>
00565         <span class="comment">//</span>
00566 
00567         <span class="keywordflow">if</span> (NewProtect &amp; PAGE_NOCACHE) {
00568 
00569             <span class="comment">//</span>
00570             <span class="comment">// Not allowed.</span>
00571             <span class="comment">//</span>
00572 
00573             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_4;
00574             <span class="keywordflow">goto</span> ErrorFound;
00575         }
00576 
00577         <span class="comment">//</span>
00578         <span class="comment">// If this is a file mapping, then all pages must be</span>
00579         <span class="comment">// committed as there can be no sparse file maps. Images</span>
00580         <span class="comment">// can have non-committed pages if the alignment is greater</span>
00581         <span class="comment">// than the page size.</span>
00582         <span class="comment">//</span>
00583 
00584         <span class="keywordflow">if</span> ((FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.File == 0) ||
00585             (FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Image == 1)) {
00586 
00587             PointerProtoPte = <a class="code" href="../../d4/d8/mi_8h.html#a246">MiGetProtoPteAddress</a> (FoundVad,
00588                                         <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (StartingAddress));
00589             LastProtoPte = <a class="code" href="../../d4/d8/mi_8h.html#a246">MiGetProtoPteAddress</a> (FoundVad,
00590                                         <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndingAddress));
00591 
00592             <span class="comment">//</span>
00593             <span class="comment">// Release the working set mutex and acquire the section</span>
00594             <span class="comment">// commit mutex.  Check all the prototype PTEs described by</span>
00595             <span class="comment">// the virtual address range to ensure they are committed.</span>
00596             <span class="comment">//</span>
00597 
00598             <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
00599             <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a677">MmSectionCommitMutex</a>);
00600 
00601             <span class="keywordflow">while</span> (PointerProtoPte &lt;= LastProtoPte) {
00602 
00603                 <span class="comment">//</span>
00604                 <span class="comment">// Check to see if the prototype PTE is committed, if</span>
00605                 <span class="comment">// not return an error.</span>
00606                 <span class="comment">//</span>
00607 
00608                 <span class="keywordflow">if</span> (PointerProtoPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
00609 
00610                     <span class="comment">//</span>
00611                     <span class="comment">// Error, this prototype PTE is not committed.</span>
00612                     <span class="comment">//</span>
00613 
00614                     <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a677">MmSectionCommitMutex</a>);
00615                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_COMMITTED;
00616                     <a class="code" href="../../d4/d8/mi_8h.html#a163">UNLOCK_ADDRESS_SPACE</a> (Process);
00617                     <span class="keywordflow">goto</span> ErrorFoundNoWs;
00618                 }
00619                 PointerProtoPte += 1;
00620             }
00621 
00622             <span class="comment">//</span>
00623             <span class="comment">// The range is committed, release the section commitment</span>
00624             <span class="comment">// mutex, acquire the working set mutex and update the local PTEs.</span>
00625             <span class="comment">//</span>
00626 
00627             <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a677">MmSectionCommitMutex</a>);
00628 
00629             <span class="comment">//</span>
00630             <span class="comment">// Set the protection on the section pages.  This could</span>
00631             <span class="comment">// get a quota exceeded exception.</span>
00632             <span class="comment">//</span>
00633 
00634             <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
00635         }
00636 
00637 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00638 <span class="preprocessor"></span>
00639         <span class="comment">//</span>
00640         <span class="comment">// We need to change the alternate table before PTEs are created for the protection </span>
00641         <span class="comment">// change.</span>
00642         <span class="comment">//</span>
00643 
00644         <span class="keywordflow">if</span> (EmulationFor4kPage == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00645 
00646             <span class="comment">//</span>
00647             <span class="comment">// Before accessing Alternate Table, unlock the working set mutex</span>
00648             <span class="comment">//</span>
00649 
00650             <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
00651 
00652             <span class="comment">//</span>
00653             <span class="comment">// Get the old protection</span>
00654             <span class="comment">//</span>
00655 
00656             CapturedOldProtectFor4k = 
00657                 <a class="code" href="../../d2/d9/miia64_8h.html#a310">MiQueryProtectionFor4kPage</a>(StartingAddressFor4k, Process);
00658             
00659             <span class="keywordflow">if</span> (CapturedOldProtectFor4k != 0) {
00660  
00661                 CapturedOldProtectFor4k = 
00662                     <a class="code" href="../../d4/d8/mi_8h.html#a86">MI_CONVERT_FROM_PTE_PROTECTION</a>(CapturedOldProtectFor4k);
00663 
00664             }
00665 
00666             <span class="comment">//</span>
00667             <span class="comment">// Set the alternate permission table</span>
00668             <span class="comment">//</span>
00669 
00670             <span class="keywordflow">if</span> ((FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.ImageMap == 1) ||
00671                 (FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.CopyOnWrite == 1)) {
00672 
00673                 OriginalProtectionMask |= <a class="code" href="../../d4/d8/mi_8h.html#a52">MM_PROTECTION_COPY_MASK</a>;
00674 
00675             }
00676 
00677             <a class="code" href="../../d2/d9/miia64_8h.html#a303">MiProtectFor4kPage</a> (StartingAddressFor4k, 
00678                                 CapturedRegionSizeFor4k, 
00679                                 OriginalProtectionMask, 
00680                                 <a class="code" href="../../d2/d9/miia64_8h.html#a242">ALT_CHANGE</a>,
00681                                 Process);
00682 
00683             <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
00684         }
00685 <span class="preprocessor">#endif</span>
00686 <span class="preprocessor"></span>
00687         <span class="keywordflow">try</span> {
00688             Locked = <a class="code" href="../../d0/d9/protect_8c.html#a6">MiSetProtectionOnSection</a> ( Process,
00689                                                 FoundVad,
00690                                                 StartingAddress,
00691                                                 EndingAddress,
00692                                                 NewProtect,
00693                                                 &amp;CapturedOldProtect,
00694                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00695 
00696         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00697 
00698             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00699             <span class="keywordflow">goto</span> ErrorFound;
00700         }
00701     } <span class="keywordflow">else</span> {
00702 
00703         <span class="comment">//</span>
00704         <span class="comment">// Not a section, private.</span>
00705         <span class="comment">// For private pages, the WRITECOPY attribute is not allowed.</span>
00706         <span class="comment">//</span>
00707 
00708         <span class="keywordflow">if</span> ((NewProtect &amp; PAGE_WRITECOPY) ||
00709             (NewProtect &amp; PAGE_EXECUTE_WRITECOPY)) {
00710 
00711             <span class="comment">//</span>
00712             <span class="comment">// Not allowed.</span>
00713             <span class="comment">//</span>
00714 
00715             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_4;
00716             <span class="keywordflow">goto</span> ErrorFound;
00717         }
00718 
00719         <span class="comment">//</span>
00720         <span class="comment">// Ensure all of the pages are already committed as described</span>
00721         <span class="comment">// in the virtual address descriptor.</span>
00722         <span class="comment">//</span>
00723 
00724         <span class="keywordflow">if</span> ( !<a class="code" href="../../d4/d8/mi_8h.html#a906">MiIsEntireRangeCommitted</a>(StartingAddress,
00725                                          EndingAddress,
00726                                          FoundVad,
00727                                          Process)) {
00728 
00729             <span class="comment">//</span>
00730             <span class="comment">// Previously reserved pages have been decommitted, or an error</span>
00731             <span class="comment">// occurred, release mutex and return status.</span>
00732             <span class="comment">//</span>
00733 
00734             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_COMMITTED;
00735             <span class="keywordflow">goto</span> ErrorFound;
00736         }
00737 
00738 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00739 <span class="preprocessor"></span>
00740         <span class="comment">//</span>
00741         <span class="comment">// We need to change the alternate table before PTEs are created for the protection </span>
00742         <span class="comment">// change.</span>
00743         <span class="comment">//</span>
00744 
00745         <span class="keywordflow">if</span> (EmulationFor4kPage == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00746 
00747             <span class="comment">//</span>
00748             <span class="comment">// Before accessing Alternate Table, unlock the working set mutex</span>
00749             <span class="comment">//</span>
00750 
00751             <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
00752 
00753             <span class="comment">//</span>
00754             <span class="comment">// Get the old protection</span>
00755             <span class="comment">//</span>
00756 
00757             CapturedOldProtectFor4k = 
00758                 <a class="code" href="../../d2/d9/miia64_8h.html#a310">MiQueryProtectionFor4kPage</a>(StartingAddressFor4k, Process);
00759             
00760             <span class="keywordflow">if</span> (CapturedOldProtectFor4k != 0) {
00761  
00762                 CapturedOldProtectFor4k = 
00763                     <a class="code" href="../../d4/d8/mi_8h.html#a86">MI_CONVERT_FROM_PTE_PROTECTION</a>(CapturedOldProtectFor4k);
00764 
00765             }
00766 
00767             <span class="comment">//</span>
00768             <span class="comment">// Set the alternate permission table</span>
00769             <span class="comment">//</span>
00770 
00771             <a class="code" href="../../d2/d9/miia64_8h.html#a303">MiProtectFor4kPage</a> (StartingAddressFor4k, 
00772                                 CapturedRegionSizeFor4k, 
00773                                 OriginalProtectionMask, 
00774                                 <a class="code" href="../../d2/d9/miia64_8h.html#a242">ALT_CHANGE</a>,
00775                                 Process);
00776 
00777             <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
00778         }
00779 <span class="preprocessor">#endif</span>
00780 <span class="preprocessor"></span>
00781         <span class="comment">//</span>
00782         <span class="comment">// The address range is committed, change the protection.</span>
00783         <span class="comment">//</span>
00784 
00785         PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (StartingAddress);
00786         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (StartingAddress);
00787         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (StartingAddress);
00788         LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (EndingAddress);
00789 
00790 <span class="preprocessor">#if defined (_WIN64)</span>
00791 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a245">MiMakePpeExistAndMakeValid</a> (PointerPpe, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00792         <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
00793             UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
00794             <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
00795         }
00796 <span class="preprocessor">#endif</span>
00797 <span class="preprocessor"></span>
00798         <a class="code" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a>(PointerPde, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00799 
00800         <span class="comment">//</span>
00801         <span class="comment">// Capture the protection for the first page.</span>
00802         <span class="comment">//</span>
00803 
00804         <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0) {
00805 
00806             CapturedOldProtect = <a class="code" href="../../d0/d9/protect_8c.html#a7">MiGetPageProtection</a> (PointerPte, Process);
00807 
00808             <span class="comment">//</span>
00809             <span class="comment">// Make sure the page directory &amp; table pages are still resident.</span>
00810             <span class="comment">//</span>
00811 
00812 <span class="preprocessor">#if defined (_WIN64)</span>
00813 <span class="preprocessor"></span>            <a class="code" href="../../d4/d8/mi_8h.html#a245">MiMakePpeExistAndMakeValid</a> (PointerPpe, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00814             <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
00815                 UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
00816                 <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
00817             }
00818 <span class="preprocessor">#endif</span>
00819 <span class="preprocessor"></span>
00820             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a>(PointerPde, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00821 
00822         } <span class="keywordflow">else</span> {
00823 
00824             <span class="comment">//</span>
00825             <span class="comment">// Get the protection from the VAD.</span>
00826             <span class="comment">//</span>
00827 
00828             CapturedOldProtect =
00829                <a class="code" href="../../d4/d8/mi_8h.html#a86">MI_CONVERT_FROM_PTE_PROTECTION</a>(FoundVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection);
00830         }
00831 
00832         <span class="comment">//</span>
00833         <span class="comment">// For all the PTEs in the specified address range, set the</span>
00834         <span class="comment">// protection depending on the state of the PTE.</span>
00835         <span class="comment">//</span>
00836 
00837         <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
00838 
00839             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPte)) {
00840 
00841                 PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
00842                 PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (PointerPte);
00843 
00844 <span class="preprocessor">#if defined (_WIN64)</span>
00845 <span class="preprocessor"></span>                <a class="code" href="../../d4/d8/mi_8h.html#a245">MiMakePpeExistAndMakeValid</a> (PointerPpe, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00846                 <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
00847                     UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
00848                     <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
00849                 }
00850 <span class="preprocessor">#endif</span>
00851 <span class="preprocessor"></span>
00852                 <a class="code" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a>(PointerPde, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00853             }
00854 
00855             PteContents = *PointerPte;
00856 
00857             <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
00858 
00859                 <span class="comment">//</span>
00860                 <span class="comment">// Increment the count of non-zero page table entries</span>
00861                 <span class="comment">// for this page table and the number of private pages</span>
00862                 <span class="comment">// for the process.  The protection will be set as</span>
00863                 <span class="comment">// if the PTE was demand zero.</span>
00864                 <span class="comment">//</span>
00865 
00866                 UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte));
00867 
00868                 <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageTableHandle);
00869             }
00870 
00871             <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
00872 
00873                 <span class="comment">//</span>
00874                 <span class="comment">// Set the protection into both the PTE and the original PTE</span>
00875                 <span class="comment">// in the PFN database.</span>
00876                 <span class="comment">//</span>
00877 
00878                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
00879 
00880                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte == 1) {
00881 
00882                     <span class="comment">//</span>
00883                     <span class="comment">// This PTE refers to a fork prototype PTE, make it</span>
00884                     <span class="comment">// private.</span>
00885                     <span class="comment">//</span>
00886 
00887                     <a class="code" href="../../d3/d0/wrtfault_8c.html#a0">MiCopyOnWrite</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte),
00888                                     PointerPte);
00889 
00890                     <span class="comment">//</span>
00891                     <span class="comment">// This may have released the working set mutex and</span>
00892                     <span class="comment">// the page directory and table pages may no longer be</span>
00893                     <span class="comment">// in memory.</span>
00894                     <span class="comment">//</span>
00895 
00896                     <span class="keywordflow">do</span> {
00897 
00898                         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde),
00899                                                           Process,
00900                                                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00901                                                           &amp;Waited);
00902 
00903                         Waited = 0;
00904 
00905                         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
00906                                                           Process,
00907                                                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00908                                                           &amp;Waited);
00909 
00910                     } <span class="keywordflow">while</span> (Waited != 0);
00911 
00912                     <span class="comment">//</span>
00913                     <span class="comment">// Do the loop again for the same PTE.</span>
00914                     <span class="comment">//</span>
00915 
00916                     <span class="keywordflow">continue</span>;
00917                 } <span class="keywordflow">else</span> {
00918 
00919                     <span class="comment">//</span>
00920                     <span class="comment">// The PTE is a private page which is valid, if the</span>
00921                     <span class="comment">// specified protection is no-access or guard page</span>
00922                     <span class="comment">// remove the PTE from the working set.</span>
00923                     <span class="comment">//</span>
00924 
00925                     <span class="keywordflow">if</span> ((NewProtect &amp; PAGE_NOACCESS) ||
00926                         (NewProtect &amp; PAGE_GUARD)) {
00927 
00928                         <span class="comment">//</span>
00929                         <span class="comment">// Remove the page from the working set.</span>
00930                         <span class="comment">//</span>
00931 
00932                         Locked = <a class="code" href="../../d4/d0/wslist_8c.html#a23">MiRemovePageFromWorkingSet</a> (PointerPte,
00933                                                              Pfn1,
00934                                                              &amp;Process-&gt;Vm);
00935 
00936 
00937                         <span class="keywordflow">continue</span>;
00938                     } <span class="keywordflow">else</span> {
00939 
00940 <span class="preprocessor">#if PFN_CONSISTENCY</span>
00941 <span class="preprocessor"></span>                        MiSetOriginalPteProtection (Pfn1, ProtectionMask);
00942 <span class="preprocessor">#else</span>
00943 <span class="preprocessor"></span>                        Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = ProtectionMask;
00944 <span class="preprocessor">#endif</span>
00945 <span class="preprocessor"></span>                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
00946                                            PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber,
00947                                            ProtectionMask,
00948                                            PointerPte);
00949 
00950                         WorkingSetIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a110">MI_GET_WORKING_SET_FROM_PTE</a> (&amp;PteContents);
00951                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a109">MI_SET_PTE_IN_WORKING_SET</a> (&amp;TempPte, WorkingSetIndex);
00952 
00953                         <span class="comment">//</span>
00954                         <span class="comment">// Flush the TB as we have changed the protection</span>
00955                         <span class="comment">// of a valid PTE.</span>
00956                         <span class="comment">//</span>
00957 
00958                         PreviousPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush = <a class="code" href="../../d0/d9/protect_8c.html#a1">MiFlushTbAndCapture</a> (PointerPte,
00959                                                                TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush,
00960                                                                Pfn1);
00961                     }
00962                 }
00963             } <span class="keywordflow">else</span> {
00964 
00965                 <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1) {
00966 
00967                     <span class="comment">//</span>
00968                     <span class="comment">// This PTE refers to a fork prototype PTE, make the</span>
00969                     <span class="comment">// page private.  This is accomplished by releasing</span>
00970                     <span class="comment">// the working set mutex, reading the page thereby</span>
00971                     <span class="comment">// causing a fault, and re-executing the loop, hopefully,</span>
00972                     <span class="comment">// this time, we'll find the page present and will</span>
00973                     <span class="comment">// turn it into a private page.</span>
00974                     <span class="comment">//</span>
00975                     <span class="comment">// Note, that a TRY is used to catch guard</span>
00976                     <span class="comment">// page exceptions and no-access exceptions.</span>
00977                     <span class="comment">//</span>
00978 
00979                     Va = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
00980 
00981                     DoAgain = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00982 
00983                     <span class="keywordflow">while</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
00984 
00985                         <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
00986 
00987                         <span class="keywordflow">try</span> {
00988 
00989                             *(<span class="keyword">volatile</span> ULONG *)Va;
00990                         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00991 
00992                             <span class="keywordflow">if</span> (GetExceptionCode() ==
00993                                                 STATUS_ACCESS_VIOLATION) {
00994 
00995                                 <span class="comment">//</span>
00996                                 <span class="comment">// The prototype PTE must be noaccess.</span>
00997                                 <span class="comment">//</span>
00998 
00999                                 DoAgain = <a class="code" href="../../d0/d9/protect_8c.html#a8">MiChangeNoAccessForkPte</a> (PointerPte,
01000                                                                 ProtectionMask);
01001                             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (GetExceptionCode() ==
01002                                                     STATUS_IN_PAGE_ERROR) {
01003                                 <span class="comment">//</span>
01004                                 <span class="comment">// Ignore this page and go onto the next one.</span>
01005                                 <span class="comment">//</span>
01006 
01007                                 PointerPte += 1;
01008                                 DoAgain = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01009 
01010                                 <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
01011                                     <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
01012                                     <span class="keywordflow">break</span>;
01013                                 }
01014                             }
01015                         }
01016 
01017                         <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
01018 
01019                         <span class="keywordflow">do</span> {
01020 
01021                             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde),
01022                                                               Process,
01023                                                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01024                                                               &amp;Waited);
01025 
01026                             Waited = 0;
01027 
01028                             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
01029                                                               Process,
01030                                                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01031                                                               &amp;Waited);
01032 
01033                         } <span class="keywordflow">while</span> (Waited != 0);
01034 
01035                         PteContents = *(<span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> *)PointerPte;
01036                     }
01037 
01038                     <span class="keywordflow">if</span> (DoAgain) {
01039                         <span class="keywordflow">continue</span>;
01040                     }
01041 
01042                 } <span class="keywordflow">else</span> {
01043 
01044                     <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1) {
01045 
01046                         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/sysload_8c.html#a41">MiSetProtectionOnTransitionPte</a> (
01047                                                     PointerPte,
01048                                                     ProtectionMask)) {
01049                             <span class="keywordflow">continue</span>;
01050                         }
01051                     } <span class="keywordflow">else</span> {
01052 
01053                         <span class="comment">//</span>
01054                         <span class="comment">// Must be page file space or demand zero.</span>
01055                         <span class="comment">//</span>
01056 
01057                         PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = ProtectionMask;
01058                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Long != 0);
01059                     }
01060                 }
01061             }
01062             PointerPte += 1;
01063         } <span class="comment">//end while</span>
01064     }
01065 
01066     <span class="comment">//</span>
01067     <span class="comment">// Common completion code.</span>
01068     <span class="comment">//</span>
01069 
01070 <span class="preprocessor">#if defined(_MIALT4K_)</span>
01071 <span class="preprocessor"></span>
01072     <span class="keywordflow">if</span> (EmulationFor4kPage == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01073 
01074         StartingAddress = StartingAddressFor4k;
01075 
01076         EndingAddress = EndingAddressFor4k;
01077             
01078         <span class="keywordflow">if</span> (CapturedOldProtectFor4k != 0) {
01079 
01080             <span class="comment">//</span>
01081             <span class="comment">// change CapturedOldProtect when CapturedOldProtectFor4k</span>
01082             <span class="comment">// contains the true protection for the 4k page</span>
01083             <span class="comment">//</span>
01084 
01085             CapturedOldProtect = CapturedOldProtectFor4k;
01086 
01087         }
01088     }
01089 <span class="preprocessor">#endif</span>
01090 <span class="preprocessor"></span>
01091     *RegionSize = (PCHAR)EndingAddress - (PCHAR)StartingAddress + 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
01092     *BaseAddress = StartingAddress;
01093     *LastProtect = CapturedOldProtect;
01094 
01095     <span class="keywordflow">if</span> (Locked) {
01096         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_WAS_UNLOCKED;
01097     } <span class="keywordflow">else</span> {
01098         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01099     }
01100 
01101 ErrorFound:
01102     <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
01103 
01104 ErrorFoundNoWs:
01105     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01106 }
01107 
01108 
01109 ULONG
<a name="l01110"></a><a class="code" href="../../d0/d9/protect_8c.html#a6">01110</a> <a class="code" href="../../d0/d9/protect_8c.html#a6">MiSetProtectionOnSection</a> (
01111     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
01112     IN <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> FoundVad,
01113     IN PVOID StartingAddress,
01114     IN PVOID EndingAddress,
01115     IN ULONG NewProtect,
01116     OUT PULONG CapturedOldProtect,
01117     IN ULONG DontCharge
01118     )
01119 
01120 <span class="comment">/*++</span>
01121 <span class="comment"></span>
01122 <span class="comment">Routine Description:</span>
01123 <span class="comment"></span>
01124 <span class="comment">    This routine changes the protection on a region of committed pages</span>
01125 <span class="comment">    within the virtual address space of the subject process.  Setting</span>
01126 <span class="comment">    the protection on a range of pages causes the old protection to be</span>
01127 <span class="comment">    replaced by the specified protection value.</span>
01128 <span class="comment"></span>
01129 <span class="comment">Arguments:</span>
01130 <span class="comment"></span>
01131 <span class="comment">    Process - Supplies a pointer to the current process.</span>
01132 <span class="comment"></span>
01133 <span class="comment">    FoundVad - Supplies a pointer to the VAD containing the range to protect.</span>
01134 <span class="comment"></span>
01135 <span class="comment">    StartingAddress - Supplies the starting address to protect.</span>
01136 <span class="comment"></span>
01137 <span class="comment">    EndingAddress - Supplies the ending address to protect.</span>
01138 <span class="comment"></span>
01139 <span class="comment">    NewProtect - Supplies the new protection to set.</span>
01140 <span class="comment"></span>
01141 <span class="comment">    CapturedOldProtect - Supplies the address of a kernel owned pointer to</span>
01142 <span class="comment">                store (without probing) the old protection into.</span>
01143 <span class="comment"></span>
01144 <span class="comment">    DontCharge - Supplies TRUE if no quota or commitment should be charged.</span>
01145 <span class="comment"></span>
01146 <span class="comment">Return Value:</span>
01147 <span class="comment"></span>
01148 <span class="comment">    Returns TRUE if a locked page was removed from the working set (protection</span>
01149 <span class="comment">    was guard page or no-access, FALSE otherwise.</span>
01150 <span class="comment"></span>
01151 <span class="comment">Exceptions raised for page file quota or commitment violations.</span>
01152 <span class="comment"></span>
01153 <span class="comment">Environment:</span>
01154 <span class="comment"></span>
01155 <span class="comment">    Kernel mode, working set mutex held, address creation mutex held</span>
01156 <span class="comment">    APCs disabled.</span>
01157 <span class="comment"></span>
01158 <span class="comment">--*/</span>
01159 
01160 {
01161     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01162     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
01163     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
01164     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
01165     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerProtoPte;
01166     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01167     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
01168     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PreviousPte;
01169     ULONG Locked;
01170     ULONG ProtectionMask;
01171     ULONG ProtectionMaskNotCopy;
01172     ULONG NewProtectionMask;
01173     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
01174     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01175     PULONG Va;
01176     ULONG WriteCopy;
01177     ULONG DoAgain;
01178     ULONG Waited;
01179     SIZE_T QuotaCharge;
01180     PVOID UsedPageTableHandle;
01181     PVOID UsedPageDirectoryHandle;
01182     ULONG WorkingSetIndex;
01183 
01184     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01185 
01186     Locked = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01187     WriteCopy = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01188     QuotaCharge = 0;
01189 
01190     <span class="comment">//</span>
01191     <span class="comment">// Make the protection field.</span>
01192     <span class="comment">//</span>
01193 
01194     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FoundVad-&gt;u.VadFlags.PrivateMemory == 0);
01195 
01196     <span class="keywordflow">if</span> ((FoundVad-&gt;u.VadFlags.ImageMap == 1) ||
01197         (FoundVad-&gt;u2.VadFlags2.CopyOnWrite == 1)) {
01198 
01199         <span class="keywordflow">if</span> (NewProtect &amp; PAGE_READWRITE) {
01200             NewProtect &amp;= ~PAGE_READWRITE;
01201             NewProtect |= PAGE_WRITECOPY;
01202         }
01203 
01204         <span class="keywordflow">if</span> (NewProtect &amp; PAGE_EXECUTE_READWRITE) {
01205             NewProtect &amp;= ~PAGE_EXECUTE_READWRITE;
01206             NewProtect |= PAGE_EXECUTE_WRITECOPY;
01207         }
01208     }
01209 
01210     ProtectionMask = <a class="code" href="../../d0/d2/mmsup_8c.html#a5">MiMakeProtectionMask</a> (NewProtect);
01211 
01212     <span class="comment">//</span>
01213     <span class="comment">// Determine if copy on write is being set.</span>
01214     <span class="comment">//</span>
01215 
01216     ProtectionMaskNotCopy = ProtectionMask;
01217     <span class="keywordflow">if</span> ((ProtectionMask &amp; <a class="code" href="../../d4/d8/mi_8h.html#a84">MM_COPY_ON_WRITE_MASK</a>) == <a class="code" href="../../d4/d8/mi_8h.html#a84">MM_COPY_ON_WRITE_MASK</a>) {
01218         WriteCopy = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01219         ProtectionMaskNotCopy &amp;= ~<a class="code" href="../../d4/d8/mi_8h.html#a52">MM_PROTECTION_COPY_MASK</a>;
01220     }
01221 
01222 <span class="preprocessor">#if defined(_MIALT4K_)</span>
01223 <span class="preprocessor"></span>
01224     <span class="keywordflow">if</span> ((Process-&gt;Wow64Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; 
01225         (FoundVad-&gt;u.VadFlags.ImageMap == 0) &amp;&amp;
01226         (FoundVad-&gt;u2.VadFlags2.CopyOnWrite == 0) &amp;&amp; 
01227         (WriteCopy)) {
01228         
01229         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01230 
01231         status = MiSetCopyPagesFor4kPage(Process,
01232                                          &amp;FoundVad,
01233                                          &amp;StartingAddress,
01234                                          &amp;EndingAddress,
01235                                          ProtectionMask);
01236 
01237         <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
01238             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (status);
01239         }
01240 
01241     }
01242         
01243 <span class="preprocessor">#endif</span>
01244 <span class="preprocessor"></span>
01245     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (StartingAddress);
01246     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (StartingAddress);
01247     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (StartingAddress);
01248     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (EndingAddress);
01249 
01250 <span class="preprocessor">#if defined (_WIN64)</span>
01251 <span class="preprocessor"></span>    <a class="code" href="../../d4/d8/mi_8h.html#a245">MiMakePpeExistAndMakeValid</a> (PointerPpe, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01252     <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
01253         UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
01254         <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
01255     }
01256 <span class="preprocessor">#endif</span>
01257 <span class="preprocessor"></span>
01258     <a class="code" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a>(PointerPde, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01259 
01260     <span class="comment">//</span>
01261     <span class="comment">// Capture the protection for the first page.</span>
01262     <span class="comment">//</span>
01263 
01264     <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0) {
01265 
01266         *CapturedOldProtect = <a class="code" href="../../d0/d9/protect_8c.html#a7">MiGetPageProtection</a> (PointerPte, Process);
01267 
01268         <span class="comment">//</span>
01269         <span class="comment">// Make sure the Page table page is still resident.</span>
01270         <span class="comment">//</span>
01271 
01272         PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
01273 
01274         <span class="keywordflow">do</span> {
01275 
01276             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;Waited);
01277             Waited = 0;
01278 
01279             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;Waited);
01280         } <span class="keywordflow">while</span> (Waited != 0);
01281 
01282     } <span class="keywordflow">else</span> {
01283 
01284         <span class="comment">//</span>
01285         <span class="comment">// Get the protection from the VAD, unless image file.</span>
01286         <span class="comment">//</span>
01287 
01288         <span class="keywordflow">if</span> (FoundVad-&gt;u.VadFlags.ImageMap == 0) {
01289 
01290             <span class="comment">//</span>
01291             <span class="comment">// This is not an image file, the protection is in the VAD.</span>
01292             <span class="comment">//</span>
01293 
01294             *CapturedOldProtect =
01295                 <a class="code" href="../../d4/d8/mi_8h.html#a86">MI_CONVERT_FROM_PTE_PROTECTION</a>(FoundVad-&gt;u.VadFlags.Protection);
01296         } <span class="keywordflow">else</span> {
01297 
01298             <span class="comment">//</span>
01299             <span class="comment">// This is an image file, the protection is in the</span>
01300             <span class="comment">// prototype PTE.</span>
01301             <span class="comment">//</span>
01302 
01303             PointerProtoPte = <a class="code" href="../../d4/d8/mi_8h.html#a246">MiGetProtoPteAddress</a> (FoundVad,
01304                                     <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (
01305                                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte)));
01306 
01307             TempPte = <a class="code" href="../../d5/d3/queryvm_8c.html#a2">MiCaptureSystemPte</a> (PointerProtoPte, Process);
01308 
01309             *CapturedOldProtect = <a class="code" href="../../d0/d9/protect_8c.html#a7">MiGetPageProtection</a> (&amp;TempPte,
01310                                                        Process);
01311 
01312             <span class="comment">//</span>
01313             <span class="comment">// Make sure the Page directory and table pages are still resident.</span>
01314             <span class="comment">//</span>
01315 
01316             PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
01317 
01318             <span class="keywordflow">do</span> {
01319 
01320                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a>(PointerPpe, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;Waited);
01321                 Waited = 0;
01322 
01323                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a>(PointerPde, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;Waited);
01324             } <span class="keywordflow">while</span> (Waited != 0);
01325         }
01326     }
01327 
01328     <span class="comment">//</span>
01329     <span class="comment">// If the page protection is being change to be copy-on-write, the</span>
01330     <span class="comment">// commitment and page file quota for the potentially dirty private pages</span>
01331     <span class="comment">// must be calculated and charged.  This must be done before any</span>
01332     <span class="comment">// protections are changed as the changes cannot be undone.</span>
01333     <span class="comment">//</span>
01334 
01335     <span class="keywordflow">if</span> (WriteCopy) {
01336 
01337         <span class="comment">//</span>
01338         <span class="comment">// Calculate the charges.  If the page is shared and not write copy</span>
01339         <span class="comment">// it is counted as a charged page.</span>
01340         <span class="comment">//</span>
01341 
01342         <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
01343 
01344             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPte)) {
01345 
01346                 PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
01347                 PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
01348 
01349                 <span class="keywordflow">do</span> {
01350 
01351                     <span class="keywordflow">while</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a>(PointerPpe, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;Waited)) {
01352 
01353                         <span class="comment">//</span>
01354                         <span class="comment">// No PPE exists for this address.  Therefore</span>
01355                         <span class="comment">// all the PTEs are shared and not copy on write.</span>
01356                         <span class="comment">// go to the next PPE.</span>
01357                         <span class="comment">//</span>
01358 
01359                         PointerPpe += 1;
01360                         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPpe);
01361                         PointerProtoPte = PointerPte;
01362                         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
01363 
01364                         <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
01365                             QuotaCharge += 1 + LastPte - PointerProtoPte;
01366                             <span class="keywordflow">goto</span> Done;
01367                         }
01368                         QuotaCharge += PointerPte - PointerProtoPte;
01369                     }
01370 
01371                     Waited = 0;
01372 
01373                     <span class="keywordflow">while</span> (!<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a>(PointerPde, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;Waited)) {
01374 
01375                         <span class="comment">//</span>
01376                         <span class="comment">// No PDE exists for this address.  Therefore</span>
01377                         <span class="comment">// all the PTEs are shared and not copy on write.</span>
01378                         <span class="comment">// go to the next PDE.</span>
01379                         <span class="comment">//</span>
01380 
01381                         PointerPde += 1;
01382                         PointerProtoPte = PointerPte;
01383                         PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
01384                         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
01385 
01386                         <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
01387                             QuotaCharge += 1 + LastPte - PointerProtoPte;
01388                             <span class="keywordflow">goto</span> Done;
01389                         }
01390                         QuotaCharge += PointerPte - PointerProtoPte;
01391 <span class="preprocessor">#if defined (_WIN64)</span>
01392 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPde)) {
01393                             Waited = 1;
01394                             <span class="keywordflow">break</span>;
01395                         }
01396 <span class="preprocessor">#endif</span>
01397 <span class="preprocessor"></span>                    }
01398                 } <span class="keywordflow">while</span> (Waited != 0);
01399             }
01400 
01401             PteContents = *PointerPte;
01402 
01403             <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
01404 
01405                 <span class="comment">//</span>
01406                 <span class="comment">// The PTE has not been evaluated, assume copy on write.</span>
01407                 <span class="comment">//</span>
01408 
01409                 QuotaCharge += 1;
01410 
01411             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) &amp;&amp;
01412                 (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.CopyOnWrite == 0)) {
01413 
01414                 <span class="comment">//</span>
01415                 <span class="comment">// See if this is a prototype PTE, if so charge it.</span>
01416                 <span class="comment">//</span>
01417 
01418                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01419 
01420                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte == 1) {
01421                     QuotaCharge += 1;
01422                 }
01423             } <span class="keywordflow">else</span> {
01424 
01425                 <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1) {
01426 
01427                     <span class="comment">//</span>
01428                     <span class="comment">// This is a prototype PTE.  Charge if it is not</span>
01429                     <span class="comment">// in copy on write format.</span>
01430                     <span class="comment">//</span>
01431 
01432                     <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a181">MI_PTE_LOOKUP_NEEDED</a>) {
01433 
01434                         <span class="comment">//</span>
01435                         <span class="comment">// Page protection is within the PTE.</span>
01436                         <span class="comment">//</span>
01437 
01438                         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d8/mi_8h.html#a88">MI_IS_PTE_PROTECTION_COPY_WRITE</a>(PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection)) {
01439                             QuotaCharge += 1;
01440                         }
01441                     } <span class="keywordflow">else</span> {
01442 
01443                         <span class="comment">//</span>
01444                         <span class="comment">// The PTE references the prototype directly, therefore</span>
01445                         <span class="comment">// it can't be copy on write.  Charge.</span>
01446                         <span class="comment">//</span>
01447 
01448                         QuotaCharge += 1;
01449                     }
01450                 }
01451             }
01452             PointerPte += 1;
01453         }
01454 
01455 Done:
01456         NOTHING;
01457 
01458         <span class="comment">//</span>
01459         <span class="comment">// Charge for the quota.</span>
01460         <span class="comment">//</span>
01461 
01462         <span class="keywordflow">if</span> (!DontCharge) {
01463             <a class="code" href="../../d6/d1/mmquota_8c.html#a15">MiChargePageFileQuota</a> (QuotaCharge, Process);
01464 
01465             <span class="keywordflow">if</span> (Process-&gt;CommitChargeLimit) {
01466                 <span class="keywordflow">if</span> (Process-&gt;CommitCharge + QuotaCharge &gt; Process-&gt;CommitChargeLimit) {
01467                     <a class="code" href="../../d0/d2/psquota_8c.html#a5">MiReturnPageFileQuota</a> (QuotaCharge, Process);
01468                     <span class="keywordflow">if</span> (Process-&gt;Job) {
01469                         <a class="code" href="../../d1/d1/psjob_8c.html#a21">PsReportProcessMemoryLimitViolation</a> ();
01470                     }
01471                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_COMMITMENT_LIMIT);
01472                 }
01473             }
01474             <span class="keywordflow">if</span> (Process-&gt;JobStatus &amp; <a class="code" href="../../d1/d9/ps_8h.html#a13">PS_JOB_STATUS_REPORT_COMMIT_CHANGES</a>) {
01475                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/psjob_8c.html#a20">PsChangeJobMemoryUsage</a>(QuotaCharge) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01476                     <a class="code" href="../../d0/d2/psquota_8c.html#a5">MiReturnPageFileQuota</a> (QuotaCharge, Process);
01477                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_COMMITMENT_LIMIT);
01478                 }
01479             }
01480 
01481             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a17">MiChargeCommitment</a> (QuotaCharge, Process) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01482                 <span class="keywordflow">if</span> (Process-&gt;JobStatus &amp; <a class="code" href="../../d1/d9/ps_8h.html#a13">PS_JOB_STATUS_REPORT_COMMIT_CHANGES</a>) {
01483 
01484                     <span class="comment">//</span>
01485                     <span class="comment">// Temporarily up the process commit charge as the</span>
01486                     <span class="comment">// job code will be referencing it as though everything</span>
01487                     <span class="comment">// has succeeded.</span>
01488                     <span class="comment">//</span>
01489 
01490                     Process-&gt;CommitCharge += QuotaCharge;
01491                     <a class="code" href="../../d1/d1/psjob_8c.html#a20">PsChangeJobMemoryUsage</a>(-(SSIZE_T)QuotaCharge);
01492                     Process-&gt;CommitCharge -= QuotaCharge;
01493                 }
01494                 <a class="code" href="../../d0/d2/psquota_8c.html#a5">MiReturnPageFileQuota</a> (QuotaCharge, Process);
01495                 <a class="code" href="../../d0/d4/ex_2alpha_2raisests_8c.html#a3">ExRaiseStatus</a> STATUS_COMMITMENT_LIMIT;
01496             }
01497 
01498             <span class="comment">//</span>
01499             <span class="comment">// Add the quota into the charge to the VAD.</span>
01500             <span class="comment">//</span>
01501 
01502             <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a276">MM_DBG_COMMIT_SET_PROTECTION</a>, QuotaCharge);
01503             FoundVad-&gt;u.VadFlags.CommitCharge += QuotaCharge;
01504             Process-&gt;CommitCharge += QuotaCharge;
01505             <span class="keywordflow">if</span> (Process-&gt;CommitCharge &gt; Process-&gt;CommitChargePeak) {
01506                 Process-&gt;CommitChargePeak = Process-&gt;CommitCharge;
01507             }
01508         }
01509     }
01510 
01511     <span class="comment">//</span>
01512     <span class="comment">// For all the PTEs in the specified address range, set the</span>
01513     <span class="comment">// protection depending on the state of the PTE.</span>
01514     <span class="comment">//</span>
01515 
01516     <span class="comment">//</span>
01517     <span class="comment">// If the PTE was copy on write (but not written) and the</span>
01518     <span class="comment">// new protection is NOT copy-on-write, return page file quota</span>
01519     <span class="comment">// and commitment.</span>
01520     <span class="comment">//</span>
01521 
01522     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (StartingAddress);
01523     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (StartingAddress);
01524     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (StartingAddress);
01525 
01526     <span class="keywordflow">do</span> {
01527 
01528         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;Waited);
01529 
01530         Waited = 0;
01531 
01532         <a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;Waited);
01533 
01534     } <span class="keywordflow">while</span> (Waited != 0);
01535 
01536     QuotaCharge = 0;
01537 
01538     <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
01539 
01540         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPte)) {
01541             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
01542             PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (PointerPte);
01543 
01544 <span class="preprocessor">#if defined (_WIN64)</span>
01545 <span class="preprocessor"></span>            <a class="code" href="../../d4/d8/mi_8h.html#a245">MiMakePpeExistAndMakeValid</a> (PointerPpe, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01546             <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
01547                 UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
01548                 <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
01549             }
01550 <span class="preprocessor">#endif</span>
01551 <span class="preprocessor"></span>
01552             <a class="code" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a> (PointerPde, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01553         }
01554 
01555         PteContents = *PointerPte;
01556 
01557         <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
01558 
01559             <span class="comment">//</span>
01560             <span class="comment">// The PTE is zero, set it into prototype PTE format</span>
01561             <span class="comment">// with the protection in the prototype PTE.</span>
01562             <span class="comment">//</span>
01563 
01564             TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a12">PrototypePte</a>;
01565             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = ProtectionMask;
01566             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, TempPte);
01567 
01568             <span class="comment">//</span>
01569             <span class="comment">// Increment the count of non-zero page table entries</span>
01570             <span class="comment">// for this page table and the number of private pages</span>
01571             <span class="comment">// for the process.</span>
01572             <span class="comment">//</span>
01573 
01574             UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte));
01575 
01576             <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageTableHandle);
01577 
01578         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
01579 
01580             <span class="comment">//</span>
01581             <span class="comment">// Set the protection into both the PTE and the original PTE</span>
01582             <span class="comment">// in the PFN database for private pages only.</span>
01583             <span class="comment">//</span>
01584 
01585             NewProtectionMask = ProtectionMask;
01586 
01587             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01588 
01589             <span class="keywordflow">if</span> ((NewProtect &amp; PAGE_NOACCESS) ||
01590                 (NewProtect &amp; PAGE_GUARD)) {
01591 
01592                 Locked = <a class="code" href="../../d4/d0/wslist_8c.html#a23">MiRemovePageFromWorkingSet</a> (PointerPte,
01593                                                      Pfn1,
01594                                                      &amp;Process-&gt;Vm );
01595                 <span class="keywordflow">continue</span>;
01596 
01597             } <span class="keywordflow">else</span> {
01598 
01599                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte == 1) {
01600 
01601                     <span class="comment">//</span>
01602                     <span class="comment">// The true protection may be in the WSLE, locate</span>
01603                     <span class="comment">// the WSLE.</span>
01604                     <span class="comment">//</span>
01605 
01606                     Va = (PULONG)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
01607                     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d7/d0/wstree_8c.html#a7">MiLocateWsle</a> ((PVOID)Va, <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>,
01608                                             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex);
01609 
01610                     <span class="comment">//</span>
01611                     <span class="comment">// Check to see if this is a prototype PTE.  This</span>
01612                     <span class="comment">// is done by comparing the PTE address in the</span>
01613                     <span class="comment">// PFN database to the PTE address indicated by the</span>
01614                     <span class="comment">// VAD.  If they are not equal, this is a prototype</span>
01615                     <span class="comment">// PTE.</span>
01616                     <span class="comment">//</span>
01617 
01618                     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> !=
01619                                   <a class="code" href="../../d4/d8/mi_8h.html#a246">MiGetProtoPteAddress</a> (FoundVad,
01620                                               <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> ((PVOID)Va))) {
01621 
01622                         <span class="comment">//</span>
01623                         <span class="comment">// This PTE refers to a fork prototype PTE, make it</span>
01624                         <span class="comment">// private.</span>
01625                         <span class="comment">//</span>
01626 
01627                         <a class="code" href="../../d3/d0/wrtfault_8c.html#a0">MiCopyOnWrite</a> ((PVOID)Va, PointerPte);
01628 
01629                         <span class="keywordflow">if</span> (WriteCopy) {
01630                             QuotaCharge += 1;
01631                         }
01632 
01633                         <span class="comment">//</span>
01634                         <span class="comment">// This may have released the working set mutex and</span>
01635                         <span class="comment">// the page table page may no longer be in memory.</span>
01636                         <span class="comment">//</span>
01637 
01638                         PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
01639 
01640                         <span class="keywordflow">do</span> {
01641 
01642                             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
01643                                                               Process,
01644                                                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01645                                                               &amp;Waited);
01646 
01647                             Waited = 0;
01648 
01649                             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
01650                                                               Process,
01651                                                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01652                                                               &amp;Waited);
01653 
01654                         } <span class="keywordflow">while</span> (Waited != 0);
01655 
01656                         <span class="comment">//</span>
01657                         <span class="comment">// Do the loop again.</span>
01658                         <span class="comment">//</span>
01659 
01660                         <span class="keywordflow">continue</span>;
01661 
01662                     } <span class="keywordflow">else</span> {
01663 
01664                         <span class="comment">//</span>
01665                         <span class="comment">// Update the protection field in the WSLE and</span>
01666                         <span class="comment">// the PTE.</span>
01667                         <span class="comment">//</span>
01668                         <span class="comment">//</span>
01669                         <span class="comment">// If the PTE is copy on write uncharge the</span>
01670                         <span class="comment">// previously charged quota.</span>
01671                         <span class="comment">//</span>
01672 
01673                         <span class="keywordflow">if</span> ((!WriteCopy) &amp;&amp; (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.CopyOnWrite == 1)) {
01674                             QuotaCharge += 1;
01675                         }
01676 
01677                         <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Protection = ProtectionMask;
01678                         <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.SameProtectAsProto = 0;
01679                     }
01680 
01681                 } <span class="keywordflow">else</span> {
01682 
01683                     <span class="comment">//</span>
01684                     <span class="comment">// Page is private (copy on written), protection mask</span>
01685                     <span class="comment">// is stored in the original pte field.</span>
01686                     <span class="comment">//</span>
01687 
01688 <span class="preprocessor">#if PFN_CONSISTENCY</span>
01689 <span class="preprocessor"></span>                    MiSetOriginalPteProtection (Pfn1, ProtectionMaskNotCopy);
01690 <span class="preprocessor">#else</span>
01691 <span class="preprocessor"></span>                    Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = ProtectionMaskNotCopy;
01692 <span class="preprocessor">#endif</span>
01693 <span class="preprocessor"></span>                    NewProtectionMask = ProtectionMaskNotCopy;
01694                 }
01695 
01696                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
01697                                    PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber,
01698                                    NewProtectionMask,
01699                                    PointerPte);
01700 
01701                 WorkingSetIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a110">MI_GET_WORKING_SET_FROM_PTE</a> (&amp;PteContents);
01702 
01703                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a109">MI_SET_PTE_IN_WORKING_SET</a> (&amp;TempPte, WorkingSetIndex);
01704             }
01705 
01706             <span class="comment">//</span>
01707             <span class="comment">// Flush the TB as we have changed the protection</span>
01708             <span class="comment">// of a valid PTE.</span>
01709             <span class="comment">//</span>
01710 
01711             PreviousPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush = <a class="code" href="../../d0/d9/protect_8c.html#a1">MiFlushTbAndCapture</a> (PointerPte,
01712                                                        TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush,
01713                                                        Pfn1);
01714         } <span class="keywordflow">else</span> {
01715 
01716             <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1) {
01717 
01718                 <span class="comment">//</span>
01719                 <span class="comment">// The PTE is in prototype PTE format.</span>
01720                 <span class="comment">//</span>
01721 
01722                 <span class="comment">//</span>
01723                 <span class="comment">// Is it a fork prototype PTE?</span>
01724                 <span class="comment">//</span>
01725 
01726                 Va = (PULONG)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
01727 
01728                 <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a181">MI_PTE_LOOKUP_NEEDED</a>) &amp;&amp;
01729                    (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a144">MiPteToProto</a> (PointerPte) !=
01730                                      <a class="code" href="../../d4/d8/mi_8h.html#a246">MiGetProtoPteAddress</a> (FoundVad,
01731                                          <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> ((PVOID)Va)))) {
01732 
01733                     <span class="comment">//</span>
01734                     <span class="comment">// This PTE refers to a fork prototype PTE, make the</span>
01735                     <span class="comment">// page private.  This is accomplished by releasing</span>
01736                     <span class="comment">// the working set mutex, reading the page thereby</span>
01737                     <span class="comment">// causing a fault, and re-executing the loop, hopefully,</span>
01738                     <span class="comment">// this time, we'll find the page present and will</span>
01739                     <span class="comment">// turn it into a private page.</span>
01740                     <span class="comment">//</span>
01741                     <span class="comment">// Note, that page with prototype = 1 cannot be</span>
01742                     <span class="comment">// no-access.</span>
01743                     <span class="comment">//</span>
01744 
01745                     DoAgain = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01746 
01747                     <span class="keywordflow">while</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
01748 
01749                         <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
01750 
01751                         <span class="keywordflow">try</span> {
01752 
01753                             *(<span class="keyword">volatile</span> ULONG *)Va;
01754                         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01755 
01756                             <span class="keywordflow">if</span> (GetExceptionCode() !=
01757                                                 STATUS_GUARD_PAGE_VIOLATION) {
01758 
01759                                 <span class="comment">//</span>
01760                                 <span class="comment">// The prototype PTE must be noaccess.</span>
01761                                 <span class="comment">//</span>
01762 
01763                                 DoAgain = <a class="code" href="../../d0/d9/protect_8c.html#a8">MiChangeNoAccessForkPte</a> (PointerPte,
01764                                                                 ProtectionMask);
01765                             }
01766                         }
01767 
01768                         PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
01769 
01770                         <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
01771 
01772                         <span class="keywordflow">do</span> {
01773 
01774                             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
01775                                                               Process,
01776                                                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01777                                                               &amp;Waited);
01778 
01779                             Waited = 0;
01780 
01781                             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
01782                                                               Process,
01783                                                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01784                                                               &amp;Waited);
01785 
01786                         } <span class="keywordflow">while</span> (Waited != 0);
01787 
01788                         PteContents = *(<span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> *)PointerPte;
01789                     }
01790 
01791                     <span class="keywordflow">if</span> (DoAgain) {
01792                         <span class="keywordflow">continue</span>;
01793                     }
01794 
01795                 } <span class="keywordflow">else</span> {
01796 
01797                     <span class="comment">//</span>
01798                     <span class="comment">// If the new protection is not write-copy, the PTE</span>
01799                     <span class="comment">// protection is not in the prototype PTE (can't be</span>
01800                     <span class="comment">// write copy for sections), and the protection in</span>
01801                     <span class="comment">// the PTE is write-copy, release the page file</span>
01802                     <span class="comment">// quota and commitment for this page.</span>
01803                     <span class="comment">//</span>
01804 
01805                     <span class="keywordflow">if</span> ((!WriteCopy) &amp;&amp;
01806                         (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a181">MI_PTE_LOOKUP_NEEDED</a>)) {
01807                         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a88">MI_IS_PTE_PROTECTION_COPY_WRITE</a>(PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection)) {
01808                             QuotaCharge += 1;
01809                         }
01810 
01811                     }
01812 
01813                     <span class="comment">//</span>
01814                     <span class="comment">// The PTE is a prototype PTE.  Make the high part</span>
01815                     <span class="comment">// of the PTE indicate that the protection field</span>
01816                     <span class="comment">// is in the PTE itself.</span>
01817                     <span class="comment">//</span>
01818 
01819                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, <a class="code" href="../../d4/d2/datalpha_8c.html#a12">PrototypePte</a>);
01820                     PointerPte-&gt;u.Soft.Protection = ProtectionMask;
01821                 }
01822 
01823             } <span class="keywordflow">else</span> {
01824 
01825                 <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1) {
01826 
01827                     <span class="comment">//</span>
01828                     <span class="comment">// This is a transition PTE. (Page is private)</span>
01829                     <span class="comment">//</span>
01830 
01831                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/sysload_8c.html#a41">MiSetProtectionOnTransitionPte</a> (
01832                                                 PointerPte,
01833                                                 ProtectionMaskNotCopy)) {
01834                         <span class="keywordflow">continue</span>;
01835                     }
01836 
01837                 } <span class="keywordflow">else</span> {
01838 
01839                     <span class="comment">//</span>
01840                     <span class="comment">// Must be page file space or demand zero.</span>
01841                     <span class="comment">//</span>
01842 
01843                     PointerPte-&gt;u.Soft.Protection = ProtectionMaskNotCopy;
01844                 }
01845             }
01846         }
01847 
01848         PointerPte += 1;
01849     }
01850 
01851     <span class="comment">//</span>
01852     <span class="comment">// Return the quota charge and the commitment, if any.</span>
01853     <span class="comment">//</span>
01854 
01855     <span class="keywordflow">if</span> ((QuotaCharge &gt; 0) &amp;&amp; (!DontCharge)) {
01856 
01857         <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (QuotaCharge);
01858         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a302">MM_DBG_COMMIT_RETURN_PROTECTION</a>, QuotaCharge);
01859         <a class="code" href="../../d0/d2/psquota_8c.html#a5">MiReturnPageFileQuota</a> (QuotaCharge, Process);
01860 
01861         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (QuotaCharge &lt;= FoundVad-&gt;u.VadFlags.CommitCharge);
01862 
01863         FoundVad-&gt;u.VadFlags.CommitCharge -= QuotaCharge;
01864         <span class="keywordflow">if</span> (Process-&gt;JobStatus &amp; <a class="code" href="../../d1/d9/ps_8h.html#a13">PS_JOB_STATUS_REPORT_COMMIT_CHANGES</a>) {
01865             <a class="code" href="../../d1/d1/psjob_8c.html#a20">PsChangeJobMemoryUsage</a>(-(SSIZE_T)QuotaCharge);
01866         }
01867         Process-&gt;CommitCharge -= QuotaCharge;
01868     }
01869 
01870     <span class="keywordflow">return</span> Locked;
01871 }
01872 
01873 ULONG
<a name="l01874"></a><a class="code" href="../../d0/d9/protect_8c.html#a7">01874</a> <a class="code" href="../../d0/d9/protect_8c.html#a7">MiGetPageProtection</a> (
01875     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
01876     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
01877     )
01878 
01879 <span class="comment">/*++</span>
01880 <span class="comment"></span>
01881 <span class="comment">Routine Description:</span>
01882 <span class="comment"></span>
01883 <span class="comment">    This routine returns the page protection of a non-zero PTE.</span>
01884 <span class="comment">    It may release and reacquire the working set mutex.</span>
01885 <span class="comment"></span>
01886 <span class="comment">Arguments:</span>
01887 <span class="comment"></span>
01888 <span class="comment">    PointerPte - Supplies a pointer to a non-zero PTE.</span>
01889 <span class="comment"></span>
01890 <span class="comment">Return Value:</span>
01891 <span class="comment"></span>
01892 <span class="comment">    Returns the protection code.</span>
01893 <span class="comment"></span>
01894 <span class="comment">Environment:</span>
01895 <span class="comment"></span>
01896 <span class="comment">    Kernel mode, working set and address creation mutex held.</span>
01897 <span class="comment">    Note, that the address creation mutex does not need to be held</span>
01898 <span class="comment">    if the working set mutex does not need to be released in the</span>
01899 <span class="comment">    case of a prototype PTE.</span>
01900 <span class="comment"></span>
01901 <span class="comment">--*/</span>
01902 
01903 {
01904 
01905     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
01906     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> ProtoPteContents;
01907     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01908     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ProtoPteAddress;
01909     PVOID Va;
01910     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01911 
01912     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01913 
01914     PteContents = *PointerPte;
01915 
01916     <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Valid == 0) &amp;&amp; (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1)) {
01917 
01918         <span class="comment">//</span>
01919         <span class="comment">// This pte is in prototype format, the protection is</span>
01920         <span class="comment">// stored in the prototype PTE.</span>
01921         <span class="comment">//</span>
01922 
01923         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a195">MI_IS_PTE_PROTOTYPE</a>(PointerPte) ||
01924 <span class="preprocessor">#ifdef _X86_</span>
01925 <span class="preprocessor"></span>            (<a class="code" href="../../d2/d2/data386_8c.html#a27">MiNumberOfExtraSystemPdes</a> &amp;&amp; (PointerPte &gt;= (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d6/d8/mi386_8h.html#a5">KSTACK_POOL_START</a> &amp;&amp; PointerPte &lt; (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(<a class="code" href="../../d6/d8/mi386_8h.html#a5">KSTACK_POOL_START</a> + <a class="code" href="../../d2/d2/data386_8c.html#a27">MiNumberOfExtraSystemPdes</a> * <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a50">MM_VA_MAPPED_BY_PDE</a>))) ||
01926 <span class="preprocessor">#endif</span>
01927 <span class="preprocessor"></span>            (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a181">MI_PTE_LOOKUP_NEEDED</a>)) {
01928 
01929             <span class="comment">//</span>
01930             <span class="comment">// The protection is within this PTE.</span>
01931             <span class="comment">//</span>
01932 
01933             <span class="keywordflow">return</span> <a class="code" href="../../d4/d8/mi_8h.html#a86">MI_CONVERT_FROM_PTE_PROTECTION</a> (
01934                                             PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection);
01935         }
01936 
01937         ProtoPteAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a144">MiPteToProto</a> (PointerPte);
01938 
01939         <span class="comment">//</span>
01940         <span class="comment">// Capture protopte PTE contents.</span>
01941         <span class="comment">//</span>
01942 
01943         ProtoPteContents = <a class="code" href="../../d5/d3/queryvm_8c.html#a2">MiCaptureSystemPte</a> (ProtoPteAddress, Process);
01944 
01945         <span class="comment">//</span>
01946         <span class="comment">// The working set mutex may have been released and the</span>
01947         <span class="comment">// page may no longer be in prototype format, get the</span>
01948         <span class="comment">// new contents of the PTE and obtain the protection mask.</span>
01949         <span class="comment">//</span>
01950 
01951         PteContents = <a class="code" href="../../d5/d3/queryvm_8c.html#a2">MiCaptureSystemPte</a> (PointerPte, Process);
01952     }
01953 
01954     <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Valid == 0) &amp;&amp; (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1)) {
01955 
01956         <span class="comment">//</span>
01957         <span class="comment">// Pte is still prototype, return the protection captured</span>
01958         <span class="comment">// from the prototype PTE.</span>
01959         <span class="comment">//</span>
01960 
01961         <span class="keywordflow">if</span> (ProtoPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
01962 
01963             <span class="comment">//</span>
01964             <span class="comment">// The prototype PTE is valid, get the protection from</span>
01965             <span class="comment">// the PFN database.</span>
01966             <span class="comment">//</span>
01967 
01968             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (ProtoPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01969             <span class="keywordflow">return</span> <a class="code" href="../../d4/d8/mi_8h.html#a86">MI_CONVERT_FROM_PTE_PROTECTION</a>(
01970                                       Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection);
01971 
01972         } <span class="keywordflow">else</span> {
01973 
01974             <span class="comment">//</span>
01975             <span class="comment">// The prototype PTE is not valid, return the protection from the</span>
01976             <span class="comment">// PTE.</span>
01977             <span class="comment">//</span>
01978 
01979             <span class="keywordflow">return</span> <a class="code" href="../../d4/d8/mi_8h.html#a86">MI_CONVERT_FROM_PTE_PROTECTION</a> (
01980                                      ProtoPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection);
01981         }
01982     }
01983 
01984     <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
01985 
01986         <span class="comment">//</span>
01987         <span class="comment">// The page is valid, the protection field is either in the</span>
01988         <span class="comment">// PFN database original PTE element or the WSLE.  If</span>
01989         <span class="comment">// the page is private, get it from the PFN original PTE</span>
01990         <span class="comment">// element, else use the WSLE.</span>
01991         <span class="comment">//</span>
01992 
01993         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01994 
01995         <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte == 0) ||
01996 <span class="preprocessor">#ifdef _X86_</span>
01997 <span class="preprocessor"></span>            (<a class="code" href="../../d2/d2/data386_8c.html#a27">MiNumberOfExtraSystemPdes</a> &amp;&amp; (PointerPte &gt;= (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d6/d8/mi386_8h.html#a5">KSTACK_POOL_START</a> &amp;&amp; PointerPte &lt; (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(<a class="code" href="../../d6/d8/mi386_8h.html#a5">KSTACK_POOL_START</a> + <a class="code" href="../../d2/d2/data386_8c.html#a27">MiNumberOfExtraSystemPdes</a> * <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a50">MM_VA_MAPPED_BY_PDE</a>))) ||
01998 <span class="preprocessor">#endif</span>
01999 <span class="preprocessor"></span>            (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a195">MI_IS_PTE_PROTOTYPE</a>(PointerPte))) {
02000 
02001             <span class="comment">//</span>
02002             <span class="comment">// This is a private PTE or the PTE address is that of a</span>
02003             <span class="comment">// prototype PTE, hence the protection is in</span>
02004             <span class="comment">// the original PTE.</span>
02005             <span class="comment">//</span>
02006 
02007             <span class="keywordflow">return</span> <a class="code" href="../../d4/d8/mi_8h.html#a86">MI_CONVERT_FROM_PTE_PROTECTION</a>(
02008                                       Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection);
02009         }
02010 
02011         <span class="comment">//</span>
02012         <span class="comment">// The PTE was a hardware PTE, get the protection</span>
02013         <span class="comment">// from the WSLE.</span>
02014 
02015         Va = (PULONG)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
02016         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d7/d0/wstree_8c.html#a7">MiLocateWsle</a> ((PVOID)Va, <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>,
02017                                             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex);
02018 
02019         <span class="keywordflow">return</span> <a class="code" href="../../d4/d8/mi_8h.html#a86">MI_CONVERT_FROM_PTE_PROTECTION</a> (<a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].u1.e1.Protection);
02020     }
02021 
02022     <span class="comment">//</span>
02023     <span class="comment">// PTE is either demand zero or transition, in either</span>
02024     <span class="comment">// case protection is in PTE.</span>
02025     <span class="comment">//</span>
02026 
02027     <span class="keywordflow">return</span> <a class="code" href="../../d4/d8/mi_8h.html#a86">MI_CONVERT_FROM_PTE_PROTECTION</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection);
02028 
02029 }
02030 
02031 ULONG
<a name="l02032"></a><a class="code" href="../../d0/d9/protect_8c.html#a8">02032</a> <a class="code" href="../../d0/d9/protect_8c.html#a8">MiChangeNoAccessForkPte</a> (
02033     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
02034     IN ULONG ProtectionMask
02035     )
02036 
02037 <span class="comment">/*++</span>
02038 <span class="comment"></span>
02039 <span class="comment">Routine Description:</span>
02040 <span class="comment"></span>
02041 <span class="comment"></span>
02042 <span class="comment">Arguments:</span>
02043 <span class="comment"></span>
02044 <span class="comment">    PointerPte - Supplies a pointer to the current PTE.</span>
02045 <span class="comment"></span>
02046 <span class="comment">    ProtectionMask - Supplies the protection mask to set.</span>
02047 <span class="comment"></span>
02048 <span class="comment">Return Value:</span>
02049 <span class="comment"></span>
02050 <span class="comment">    FALSE if the loop should be repeated for this PTE, TRUE</span>
02051 <span class="comment">    if protection has been set.</span>
02052 <span class="comment"></span>
02053 <span class="comment"></span>
02054 <span class="comment">Environment:</span>
02055 <span class="comment"></span>
02056 <span class="comment">    Kernel mode, address creation mutex held, APCs disabled.</span>
02057 <span class="comment"></span>
02058 <span class="comment">--*/</span>
02059 
02060 {
02061     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02062 
02063     <span class="keywordflow">if</span> (ProtectionMask == <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>) {
02064 
02065         <span class="comment">//</span>
02066         <span class="comment">// No need to change the page protection.</span>
02067         <span class="comment">//</span>
02068 
02069         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02070     }
02071 
02072     PointerPte-&gt;u.Proto.ReadOnly = 1;
02073 
02074     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02075 }
02076 
02077 
02078 HARDWARE_PTE
<a name="l02079"></a><a class="code" href="../../d0/d9/protect_8c.html#a1">02079</a> <a class="code" href="../../d0/d9/protect_8c.html#a1">MiFlushTbAndCapture</a>(
02080     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
02081     IN HARDWARE_PTE TempPte,
02082     IN <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1
02083     )
02084 
02085 <span class="comment">// non pagable helper routine.</span>
02086 
02087 {
02088     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PreviousPte;
02089     KIRQL OldIrql;
02090     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
02091     PVOID VirtualAddress;
02092 
02093     <span class="comment">//</span>
02094     <span class="comment">// Flush the TB as we have changed the protection</span>
02095     <span class="comment">// of a valid PTE.</span>
02096     <span class="comment">//</span>
02097 
02098     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02099 
02100     PreviousPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush = <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (
02101                             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte),
02102                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
02103                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
02104                             (PHARDWARE_PTE)PointerPte,
02105                             TempPte);
02106 
02107     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PreviousPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
02108 
02109     <span class="comment">//</span>
02110     <span class="comment">// A page protection is being changed, on certain</span>
02111     <span class="comment">// hardware the dirty bit should be ORed into the</span>
02112     <span class="comment">// modify bit in the PFN element.</span>
02113     <span class="comment">//</span>
02114 
02115     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a177">MI_CAPTURE_DIRTY_BIT_TO_PFN</a> (&amp;PreviousPte, Pfn1);
02116 
02117     <span class="comment">//</span>
02118     <span class="comment">// If the PTE indicates the page has been modified (this is different</span>
02119     <span class="comment">// from the PFN indicating this), then ripple it back to the write watch</span>
02120     <span class="comment">// bitmap now since we are still in the correct process context.</span>
02121     <span class="comment">//</span>
02122 
02123     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a495">MiActiveWriteWatch</a> != 0) {
02124         <span class="keywordflow">if</span> ((Pfn1-&gt;u3.e1.PrototypePte == 0) &amp;&amp;
02125             (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a114">MI_IS_PTE_DIRTY</a>(PreviousPte))) {
02126 
02127             Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
02128 
02129             <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.WriteWatch == 1) {
02130 
02131                 <span class="comment">//</span>
02132                 <span class="comment">// This process has (or had) write watch VADs.  Search now</span>
02133                 <span class="comment">// for a write watch region encapsulating the PTE being</span>
02134                 <span class="comment">// invalidated.</span>
02135                 <span class="comment">//</span>
02136 
02137                 VirtualAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
02138                 <a class="code" href="../../d4/d8/mi_8h.html#a772">MiCaptureWriteWatchDirtyBit</a> (Process, VirtualAddress);
02139             }
02140         }
02141     }
02142 <span class="preprocessor">#if DBG</span>
02143 <span class="preprocessor"></span>    <span class="keywordflow">else</span> {
02144         Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
02145         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.WriteWatch == 0);
02146     }
02147 <span class="preprocessor">#endif</span>
02148 <span class="preprocessor"></span>
02149     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02150     <span class="keywordflow">return</span> PreviousPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush;
02151 }
02152 
02153 ULONG
<a name="l02154"></a><a class="code" href="../../d0/d9/protect_8c.html#a2">02154</a> <a class="code" href="../../d8/d8/sysload_8c.html#a41">MiSetProtectionOnTransitionPte</a> (
02155     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
02156     IN ULONG ProtectionMask
02157     )
02158 
02159     <span class="comment">// nonpaged helper routine.</span>
02160 
02161 {
02162     KIRQL OldIrql;
02163     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
02164     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
02165 
02166     <span class="comment">//</span>
02167     <span class="comment">// This is a transition PTE. (Page is private)</span>
02168     <span class="comment">//</span>
02169 
02170     <span class="comment">//</span>
02171     <span class="comment">// Need pfn mutex to ensure page doesn't become</span>
02172     <span class="comment">// non-transition.</span>
02173     <span class="comment">//</span>
02174 
02175     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02176 
02177     <span class="comment">//</span>
02178     <span class="comment">// Make sure the page is still a transition page.</span>
02179     <span class="comment">//</span>
02180 
02181     PteContents = *(<span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> *)PointerPte;
02182 
02183     <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
02184                      (PointerPte-&gt;u.Soft.Transition == 1)) {
02185 
02186         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (
02187                       PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Trans.PageFrameNumber);
02188 
02189         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = ProtectionMask;
02190         PointerPte-&gt;u.Soft.Protection = ProtectionMask;
02191         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02192         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02193     }
02194 
02195     <span class="comment">//</span>
02196     <span class="comment">// Do this loop again for the same PTE.</span>
02197     <span class="comment">//</span>
02198 
02199     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02200     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02201 }
02202 
02203 <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>
<a name="l02204"></a><a class="code" href="../../d0/d9/protect_8c.html#a3">02204</a> <a class="code" href="../../d5/d3/queryvm_8c.html#a2">MiCaptureSystemPte</a> (
02205     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerProtoPte,
02206     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
02207     )
02208 
02209 <span class="comment">/*++</span>
02210 <span class="comment"></span>
02211 <span class="comment">Routine Description:</span>
02212 <span class="comment"></span>
02213 <span class="comment">    Nonpagable helper routine to capture the contents of a pagable PTE.</span>
02214 <span class="comment"></span>
02215 <span class="comment">Arguments:</span>
02216 <span class="comment"></span>
02217 <span class="comment">    PointerProtoPte - Supplies a pointer to the prototype PTE.</span>
02218 <span class="comment"></span>
02219 <span class="comment">    Process - Supplies the relevant process.</span>
02220 <span class="comment"></span>
02221 <span class="comment">Return Value:</span>
02222 <span class="comment"></span>
02223 <span class="comment">    PTE contents.</span>
02224 <span class="comment"></span>
02225 <span class="comment">Environment:</span>
02226 <span class="comment"></span>
02227 <span class="comment">    Kernel mode.  Caller holds address space and working set mutexes if</span>
02228 <span class="comment">    Process is set.  Working set mutex was acquired unsafe.</span>
02229 <span class="comment"></span>
02230 <span class="comment">--*/</span>
02231 
02232 {
02233     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
02234     KIRQL OldIrql;
02235 
02236     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02237     <a class="code" href="../../d0/d2/mmsup_8c.html#a9">MiMakeSystemAddressValidPfnWs</a> (PointerProtoPte, Process);
02238     TempPte = *PointerProtoPte;
02239     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02240     <span class="keywordflow">return</span> TempPte;
02241 }
02242 
02243 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02244"></a><a class="code" href="../../d0/d9/protect_8c.html#a9">02244</a> <a class="code" href="../../d0/d9/protect_8c.html#a9">MiCheckSecuredVad</a> (
02245     IN <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad,
02246     IN PVOID Base,
02247     IN SIZE_T Size,
02248     IN ULONG ProtectionMask
02249     )
02250 
02251 <span class="comment">/*++</span>
02252 <span class="comment"></span>
02253 <span class="comment">Routine Description:</span>
02254 <span class="comment"></span>
02255 <span class="comment">    This routine checks to see if the specified VAD is secured in such</span>
02256 <span class="comment">    a way as to conflict with the address range and protection mask</span>
02257 <span class="comment">    specified.</span>
02258 <span class="comment"></span>
02259 <span class="comment">Arguments:</span>
02260 <span class="comment"></span>
02261 <span class="comment">    Vad - Supplies a pointer to the VAD containing the address range.</span>
02262 <span class="comment"></span>
02263 <span class="comment">    Base - Supplies the base of the range the protection starts at.</span>
02264 <span class="comment"></span>
02265 <span class="comment">    Size - Supplies the size of the range.</span>
02266 <span class="comment"></span>
02267 <span class="comment">    ProtectionMask - Supplies the protection mask being set.</span>
02268 <span class="comment"></span>
02269 <span class="comment">Return Value:</span>
02270 <span class="comment"></span>
02271 <span class="comment">    Status value.</span>
02272 <span class="comment"></span>
02273 <span class="comment">Environment:</span>
02274 <span class="comment"></span>
02275 <span class="comment">    Kernel mode.</span>
02276 <span class="comment"></span>
02277 <span class="comment">--*/</span>
02278 
02279 {
02280     PVOID <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
02281     PLIST_ENTRY Next;
02282     <a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">PMMSECURE_ENTRY</a> Entry;
02283     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02284 
02285     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = (PVOID)((PCHAR)Base + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
02286 
02287     <span class="keywordflow">if</span> (ProtectionMask &lt; <a class="code" href="../../d4/d8/mi_8h.html#a55">MM_SECURE_DELETE_CHECK</a>) {
02288         <span class="keywordflow">if</span> ((Vad-&gt;u.VadFlags.NoChange == 1) &amp;&amp;
02289             (Vad-&gt;u2.VadFlags2.SecNoChange == 1) &amp;&amp;
02290             (Vad-&gt;u.VadFlags.Protection != ProtectionMask)) {
02291 
02292             <span class="comment">//</span>
02293             <span class="comment">// An attempt is made at changing the protection</span>
02294             <span class="comment">// of a SEC_NO_CHANGE section - return an error.</span>
02295             <span class="comment">//</span>
02296 
02297             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PAGE_PROTECTION;
02298             <span class="keywordflow">goto</span> done;
02299         }
02300     } <span class="keywordflow">else</span> {
02301 
02302         <span class="comment">//</span>
02303         <span class="comment">// Deletion - set to no-access for check.  SEC_NOCHANGE allows</span>
02304         <span class="comment">// deletion, but does not allow page protection changes.</span>
02305         <span class="comment">//</span>
02306 
02307         ProtectionMask = 0;
02308     }
02309 
02310     <span class="keywordflow">if</span> (Vad-&gt;u2.VadFlags2.OneSecured) {
02311 
02312         <span class="keywordflow">if</span> (((ULONG_PTR)Base &lt;= Vad-&gt;u3.Secured.EndVpn) &amp;&amp;
02313              ((ULONG_PTR)<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> &gt;= Vad-&gt;u3.Secured.StartVpn)) {
02314 
02315             <span class="comment">//</span>
02316             <span class="comment">// This region conflicts, check the protections.</span>
02317             <span class="comment">//</span>
02318 
02319             <span class="keywordflow">if</span> (ProtectionMask &amp; <a class="code" href="../../d4/d8/mi_8h.html#a44">MM_GUARD_PAGE</a>) {
02320                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PAGE_PROTECTION;
02321                 <span class="keywordflow">goto</span> done;
02322             }
02323 
02324             <span class="keywordflow">if</span> (Vad-&gt;u2.VadFlags2.ReadOnly) {
02325                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d3/acceschk_8c.html#a0">MmReadWrite</a>[ProtectionMask] &lt; 10) {
02326                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PAGE_PROTECTION;
02327                     <span class="keywordflow">goto</span> done;
02328                 }
02329             } <span class="keywordflow">else</span> {
02330                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d3/acceschk_8c.html#a0">MmReadWrite</a>[ProtectionMask] &lt; 11) {
02331                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PAGE_PROTECTION;
02332                     <span class="keywordflow">goto</span> done;
02333                 }
02334             }
02335         }
02336 
02337     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Vad-&gt;u2.VadFlags2.MultipleSecured) {
02338 
02339         Next = Vad-&gt;u3.List.Flink;
02340         <span class="keywordflow">do</span> {
02341             Entry = CONTAINING_RECORD( Next,
02342                                        <a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">MMSECURE_ENTRY</a>,
02343                                        <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>);
02344 
02345             <span class="keywordflow">if</span> (((ULONG_PTR)Base &lt;= Entry-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o4">EndVpn</a>) &amp;&amp;
02346                 ((ULONG_PTR)<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> &gt;= Entry-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o3">StartVpn</a>)) {
02347 
02348                 <span class="comment">//</span>
02349                 <span class="comment">// This region conflicts, check the protections.</span>
02350                 <span class="comment">//</span>
02351 
02352                 <span class="keywordflow">if</span> (ProtectionMask &amp; <a class="code" href="../../d4/d8/mi_8h.html#a44">MM_GUARD_PAGE</a>) {
02353                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PAGE_PROTECTION;
02354                     <span class="keywordflow">goto</span> done;
02355                 }
02356     
02357                 <span class="keywordflow">if</span> (Entry-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o2">u2</a>.VadFlags2.ReadOnly) {
02358                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d3/acceschk_8c.html#a0">MmReadWrite</a>[ProtectionMask] &lt; 10) {
02359                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PAGE_PROTECTION;
02360                         <span class="keywordflow">goto</span> done;
02361                     }
02362                 } <span class="keywordflow">else</span> {
02363                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d3/acceschk_8c.html#a0">MmReadWrite</a>[ProtectionMask] &lt; 11) {
02364                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PAGE_PROTECTION;
02365                         <span class="keywordflow">goto</span> done;
02366                     }
02367                 }
02368             }
02369             Next = Entry-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o5">List</a>.Flink;
02370         } <span class="keywordflow">while</span> (Entry-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o5">List</a>.Flink != &amp;Vad-&gt;u3.List);
02371     }
02372 
02373 done:
02374     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02375 }
02376 
02377 <span class="preprocessor">#ifdef PFN_CONSISTENCY</span>
02378 <span class="preprocessor"></span>
02379 BOOLEAN MiCheckPfnState = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02380 
02381 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02382 MiMapInPfnDatabase (
02383     VOID
02384     )
02385 
02386 <span class="comment">/*++</span>
02387 <span class="comment"></span>
02388 <span class="comment">Routine Description:</span>
02389 <span class="comment"></span>
02390 <span class="comment">    This routine allows PFN database access (removes write-protection).</span>
02391 <span class="comment"></span>
02392 <span class="comment">Arguments:</span>
02393 <span class="comment"></span>
02394 <span class="comment">    None.</span>
02395 <span class="comment"></span>
02396 <span class="comment">Return Value:</span>
02397 <span class="comment"></span>
02398 <span class="comment">    None.</span>
02399 <span class="comment"></span>
02400 <span class="comment">Environment:</span>
02401 <span class="comment"></span>
02402 <span class="comment">    Kernel mode.  The PFN database must be locked at DISPATCH level on entry.</span>
02403 <span class="comment"></span>
02404 <span class="comment">--*/</span>
02405 
02406 {
02407     PFN_NUMBER i;
02408     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02409 
02410     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
02411 
02412     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiPfnStartPte);
02413 
02414     PointerPte = MiPfnStartPte;
02415 
02416     <span class="keywordflow">for</span> (i = 0; i &lt; MiPfnPtes; i += 1) {
02417 
02418         <span class="comment">//</span>
02419         <span class="comment">// Account for a sparse database</span>
02420         <span class="comment">//</span>
02421 
02422         <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
02423 <span class="preprocessor">#if defined (_ALPHA_)</span>
02424 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (MiCheckPfnState == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02425                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Dirty == 0);
02426             }
02427             PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Dirty = 1;
02428 <span class="preprocessor">#elif defined (NT_UP)</span>
02429 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (MiCheckPfnState == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02430                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write == 0);
02431             }
02432             PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write = 1;
02433 <span class="preprocessor">#else</span>
02434 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (MiCheckPfnState == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02435                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Writable == 0);
02436             }
02437             PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Writable = 1;
02438 <span class="preprocessor">#endif</span>
02439 <span class="preprocessor"></span>        }
02440         PointerPte += 1;
02441     }
02442     <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (TRUE, TRUE);
02443 }
02444 
02445 
02446 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02447 MiUnMapPfnDatabase (
02448     VOID
02449     )
02450 
02451 <span class="comment">/*++</span>
02452 <span class="comment"></span>
02453 <span class="comment">Routine Description:</span>
02454 <span class="comment"></span>
02455 <span class="comment">    This routine write protects the PFN database to catch errant pointers.</span>
02456 <span class="comment"></span>
02457 <span class="comment">Arguments:</span>
02458 <span class="comment"></span>
02459 <span class="comment">    None.</span>
02460 <span class="comment"></span>
02461 <span class="comment">Return Value:</span>
02462 <span class="comment"></span>
02463 <span class="comment">    None.</span>
02464 <span class="comment"></span>
02465 <span class="comment">Environment:</span>
02466 <span class="comment"></span>
02467 <span class="comment">    Kernel mode.  The PFN database must be locked at DISPATCH level on entry.</span>
02468 <span class="comment"></span>
02469 <span class="comment">--*/</span>
02470 
02471 {
02472     PFN_NUMBER i;
02473     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02474 
02475     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
02476 
02477     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiPfnStartPte);
02478 
02479     <span class="keywordflow">if</span> (MiPfnProtectionEnabled == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02480         <span class="comment">//</span>
02481         <span class="comment">// We're bugchecking, so don't unmap this anymore.</span>
02482         <span class="comment">//</span>
02483         <span class="keywordflow">return</span>;
02484     }
02485 
02486     PointerPte = MiPfnStartPte;
02487 
02488     <span class="keywordflow">for</span> (i = 0; i &lt; MiPfnPtes; i += 1) {
02489 
02490         <span class="comment">//</span>
02491         <span class="comment">// Account for a sparse database</span>
02492         <span class="comment">//</span>
02493 
02494         <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
02495 <span class="preprocessor">#if defined (_ALPHA_)</span>
02496 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (MiCheckPfnState == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02497                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Dirty == 1);
02498             }
02499             PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Dirty = 0;
02500 <span class="preprocessor">#elif defined (NT_UP)</span>
02501 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (MiCheckPfnState == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02502                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write == 1);
02503             }
02504             PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write = 0;
02505 <span class="preprocessor">#else</span>
02506 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (MiCheckPfnState == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02507                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Writable == 1);
02508             }
02509             PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Writable = 0;
02510 <span class="preprocessor">#endif</span>
02511 <span class="preprocessor"></span>            PointerPte += 1;
02512         }
02513     }
02514     <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (TRUE, TRUE);
02515 }
02516 
02517 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02518 MiSetOriginalPteProtection (
02519     IN <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1,
02520     IN ULONG ProtectionMask
02521     )
02522 
02523 <span class="comment">/*++</span>
02524 <span class="comment"></span>
02525 <span class="comment">Routine Description:</span>
02526 <span class="comment"></span>
02527 <span class="comment">    This routine updates the OriginalPte's protection in the</span>
02528 <span class="comment">    specified PFN database entry.</span>
02529 <span class="comment"></span>
02530 <span class="comment">Arguments:</span>
02531 <span class="comment"></span>
02532 <span class="comment">    Pfn1 - Supplies a pointer to the PFN database entry.</span>
02533 <span class="comment"></span>
02534 <span class="comment">    OriginalPteProtection - Supplies the requested original PTE protection.</span>
02535 <span class="comment"></span>
02536 <span class="comment">Return Value:</span>
02537 <span class="comment"></span>
02538 <span class="comment">    None.</span>
02539 <span class="comment"></span>
02540 <span class="comment">Environment:</span>
02541 <span class="comment"></span>
02542 <span class="comment">    Kernel mode.</span>
02543 <span class="comment"></span>
02544 <span class="comment">--*/</span>
02545 
02546 {
02547     KIRQL OldIrql;
02548 
02549     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02550     Pfn1-&gt;OriginalPte.u.Soft.Protection = ProtectionMask;
02551     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02552 }
02553 
02554 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02555 MiSetModified (
02556     IN <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1,
02557     IN ULONG Dirty
02558     )
02559 
02560 <span class="comment">/*++</span>
02561 <span class="comment"></span>
02562 <span class="comment">Routine Description:</span>
02563 <span class="comment"></span>
02564 <span class="comment">    This routine marks the specified PFN database entry as modified or clean.</span>
02565 <span class="comment"></span>
02566 <span class="comment">Arguments:</span>
02567 <span class="comment"></span>
02568 <span class="comment">    Pfn1 - Supplies a pointer to the PFN database entry.</span>
02569 <span class="comment"></span>
02570 <span class="comment">    Dirty - Supplies TRUE if the PFN should be marked modified, FALSE if clean.</span>
02571 <span class="comment"></span>
02572 <span class="comment">Return Value:</span>
02573 <span class="comment"></span>
02574 <span class="comment">    None.</span>
02575 <span class="comment"></span>
02576 <span class="comment">Environment:</span>
02577 <span class="comment"></span>
02578 <span class="comment">    Kernel mode.</span>
02579 <span class="comment"></span>
02580 <span class="comment">--*/</span>
02581 
02582 {
02583     KIRQL OldIrql;
02584 
02585     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02586     Pfn1-&gt;u3.e1.Modified = Dirty;
02587     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02588 }
02589 
02590 <span class="preprocessor">#endif // PFN_CONSISTENCY</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:30 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
