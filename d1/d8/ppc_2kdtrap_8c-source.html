<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: kdtrap.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>kdtrap.c</h1><a href="../../d0/d9/ppc_2kdtrap_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    kdtrap.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains code to implement the target side of the portable</span>
00012 <span class="comment">    kernel debugger.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Chuck Bauman 10-Jan-1994</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Based on David N. Cutler MIPS version 27-July-1990</span>
00021 <span class="comment"></span>
00022 <span class="comment">--*/</span>
00023 
00024 <span class="preprocessor">#include "<a class="code" href="../../d1/d7/4_2kdp_8h.html">kdp.h</a>"</span>
00025 
00026 
00027 <span class="comment">//</span>
00028 <span class="comment">// Define breakpoint instruction masks.</span>
00029 <span class="comment">//</span>
<a name="l00030"></a><a class="code" href="../../d0/d9/ppc_2kdtrap_8c.html#a0">00030</a> <span class="preprocessor">#define BREAKPOINT_CODE_MASK 0xffff</span>
00031 <span class="preprocessor"></span>
00032 <span class="comment">//</span>
00033 <span class="comment">// globals</span>
00034 <span class="comment">//</span>
<a name="l00035"></a><a class="code" href="../../d0/d9/ppc_2kdtrap_8c.html#a1">00035</a> ULONG           <a class="code" href="../../d9/d8/mips_2kdtrap_8c.html#a2">KdpPageInAddress</a>;
<a name="l00036"></a><a class="code" href="../../d0/d9/ppc_2kdtrap_8c.html#a2">00036</a> <a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">WORK_QUEUE_ITEM</a> <a class="code" href="../../d9/d8/mips_2kdtrap_8c.html#a3">KdpPageInWorkItem</a>;
00037 
00038 <span class="comment">//</span>
00039 <span class="comment">// externs</span>
00040 <span class="comment">//</span>
<a name="l00041"></a><a class="code" href="../../d0/d9/ppc_2kdtrap_8c.html#a3">00041</a> <span class="keyword">extern</span>  BOOLEAN <a class="code" href="../../d8/d5/kddata_8c.html#a90">KdpControlCPressed</a>;
00042 
00043 
00044 
00045 <span class="preprocessor">#pragma optimize( "", off )</span>
00046 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00047"></a><a class="code" href="../../d0/d9/ppc_2kdtrap_8c.html#a4">00047</a> <a class="code" href="../../d0/d9/ppc_2kdtrap_8c.html#a4">KdpPageInData</a> (
00048     IN PUCHAR <span class="keyword">volatile</span> DataAddress
00049     )
00050 
00051 <span class="comment">/*++</span>
00052 <span class="comment"></span>
00053 <span class="comment">Routine Description:</span>
00054 <span class="comment"></span>
00055 <span class="comment">    This routine is called to page in data at the supplied address.</span>
00056 <span class="comment">    It is called either directly from KdpTrap() or from a worker</span>
00057 <span class="comment">    thread that is queued by KdpTrap().</span>
00058 <span class="comment"></span>
00059 <span class="comment">Arguments:</span>
00060 <span class="comment"></span>
00061 <span class="comment">    DataAddress - Supplies a pointer to the data to be paged in.</span>
00062 <span class="comment"></span>
00063 <span class="comment">Return Value:</span>
00064 <span class="comment"></span>
00065 <span class="comment">    None.</span>
00066 <span class="comment"></span>
00067 <span class="comment">--*/</span>
00068 
00069 {
00070     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a336">MmIsSystemAddressAccessable</a>(DataAddress)) {
00071         UCHAR <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> = *DataAddress;
00072         DataAddress = &amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
00073     }
00074     <a class="code" href="../../d8/d5/kddata_8c.html#a89">KdpControlCPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00075 }
00076 <span class="preprocessor">#pragma optimize( "", on )</span>
00077 <span class="preprocessor"></span>
00078 
00079 BOOLEAN
<a name="l00080"></a><a class="code" href="../../d0/d9/ppc_2kdtrap_8c.html#a5">00080</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a118">KdpTrap</a> (
00081     IN PKTRAP_FRAME TrapFrame,
00082     IN PKEXCEPTION_FRAME ExceptionFrame,
00083     IN PEXCEPTION_RECORD ExceptionRecord,
00084     IN PCONTEXT ContextRecord,
00085     IN KPROCESSOR_MODE PreviousMode,
00086     IN BOOLEAN SecondChance
00087     )
00088 
00089 <span class="comment">/*++</span>
00090 <span class="comment"></span>
00091 <span class="comment">Routine Description:</span>
00092 <span class="comment"></span>
00093 <span class="comment">    This routine is called whenever a exception is dispatched and the kernel</span>
00094 <span class="comment">    debugger is active.</span>
00095 <span class="comment"></span>
00096 <span class="comment">Arguments:</span>
00097 <span class="comment"></span>
00098 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame that describes the</span>
00099 <span class="comment">        trap.</span>
00100 <span class="comment"></span>
00101 <span class="comment">    ExceptionFrame - Supplies a pointer to a exception frame that describes</span>
00102 <span class="comment">        the trap.</span>
00103 <span class="comment"></span>
00104 <span class="comment">    ExceptionRecord - Supplies a pointer to an exception record that</span>
00105 <span class="comment">        describes the exception.</span>
00106 <span class="comment"></span>
00107 <span class="comment">    ContextRecord - Supplies the context at the time of the exception.</span>
00108 <span class="comment"></span>
00109 <span class="comment">    PreviousMode - Supplies the previous processor mode.</span>
00110 <span class="comment"></span>
00111 <span class="comment">    SecondChance - Supplies a boolean value that determines whether this is</span>
00112 <span class="comment">        the second chance (TRUE) that the exception has been raised.</span>
00113 <span class="comment"></span>
00114 <span class="comment">Return Value:</span>
00115 <span class="comment"></span>
00116 <span class="comment">    A value of TRUE is returned if the exception is handled. Otherwise a</span>
00117 <span class="comment">    value of FALSE is returned.</span>
00118 <span class="comment"></span>
00119 <span class="comment">--*/</span>
00120 
00121 {
00122 
00123     BOOLEAN Completion;
00124     BOOLEAN Enable;
00125     BOOLEAN UnloadSymbols = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00126     ULONG OldIar;
00127     STRING Input;
00128     STRING Output;
00129     PKPRCB Prcb;
00130 
00131     <span class="comment">//</span>
00132     <span class="comment">// Synchronize processor execution, save processor state, enter debugger,</span>
00133     <span class="comment">// and flush the current TB.</span>
00134     <span class="comment">//</span>
00135 
00136 re_enter_debugger:
00137     Enable = <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a17">KdEnterDebugger</a>(TrapFrame, ExceptionFrame);
00138     Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00139     <a class="code" href="../../d9/d6/ppc_2ipi_8c.html#a3">KiSaveProcessorState</a>(TrapFrame, ExceptionFrame);
00140     <a class="code" href="../../d4/d9/ke_8h.html#a374">KeFlushCurrentTb</a>();
00141 
00142     <span class="comment">//</span>
00143     <span class="comment">// If this is a breakpoint instruction, then check to determine if is</span>
00144     <span class="comment">// an internal command.</span>
00145     <span class="comment">//</span>
00146 
00147     <span class="keywordflow">if</span> ((ExceptionRecord-&gt;ExceptionCode == STATUS_BREAKPOINT) &amp;&amp;
00148        ((ExceptionRecord-&gt;ExceptionInformation[0] &amp; <a class="code" href="../../d9/d8/mips_2kdtrap_8c.html#a1">BREAKPOINT_CODE_MASK</a>)
00149                               &gt;= DEBUG_PRINT_BREAKPOINT)) {
00150 
00151         <span class="comment">//</span>
00152         <span class="comment">// Switch on the breakpoint code.</span>
00153         <span class="comment">//</span>
00154 
00155         <span class="keywordflow">switch</span> (ExceptionRecord-&gt;ExceptionInformation[0] &amp; <a class="code" href="../../d9/d8/mips_2kdtrap_8c.html#a1">BREAKPOINT_CODE_MASK</a>) {
00156 
00157             <span class="comment">//</span>
00158             <span class="comment">// Print a debug string.</span>
00159             <span class="comment">//</span>
00160             <span class="comment">// Arguments:</span>
00161             <span class="comment">//</span>
00162             <span class="comment">//   a0 - Supplies a pointer to an output string buffer.</span>
00163             <span class="comment">//   a1 - Supplies the length of the output string buffer.</span>
00164             <span class="comment">//</span>
00165 
00166         <span class="keywordflow">case</span> DEBUG_PRINT_BREAKPOINT:
00167             ContextRecord-&gt;Iar += 4;
00168             Output.Buffer = (PCHAR)ContextRecord-&gt;Gpr3;
00169             Output.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)ContextRecord-&gt;Gpr4;
00170             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/kd_8h.html#a12">KdDebuggerNotPresent</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00171                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a102">KdpPrintString</a>(&amp;Output)) {
00172                     ContextRecord-&gt;Gpr3 = (ULONG)STATUS_BREAKPOINT;
00173 
00174                 } <span class="keywordflow">else</span> {
00175                     ContextRecord-&gt;Gpr3 = (ULONG)STATUS_SUCCESS;
00176                 }
00177 
00178             } <span class="keywordflow">else</span> {
00179                 ContextRecord-&gt;Gpr3 = (ULONG)STATUS_DEVICE_NOT_CONNECTED;
00180             }
00181 
00182             <a class="code" href="../../d9/d6/ppc_2ipi_8c.html#a2">KiRestoreProcessorState</a>(TrapFrame, ExceptionFrame);
00183             <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a18">KdExitDebugger</a>(Enable);
00184             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00185 
00186             <span class="comment">//</span>
00187             <span class="comment">// Print a debug prompt string, then input a string.</span>
00188             <span class="comment">//</span>
00189             <span class="comment">//   r.3 - Supplies a pointer to an output string buffer.</span>
00190             <span class="comment">//   r.4 - Supplies the length of the output string buffer..</span>
00191             <span class="comment">//   r.5 - supplies a pointer to an input string buffer.</span>
00192             <span class="comment">//   r.6 - Supplies the length of the input string bufffer.</span>
00193             <span class="comment">//</span>
00194 
00195         <span class="keywordflow">case</span> DEBUG_PROMPT_BREAKPOINT:
00196             ContextRecord-&gt;Iar += 4;
00197             Output.Buffer = (PCHAR)ContextRecord-&gt;Gpr3;
00198             Output.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)ContextRecord-&gt;Gpr4;
00199             Input.Buffer = (PCHAR)ContextRecord-&gt;Gpr5;
00200             Input.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)ContextRecord-&gt;Gpr6;
00201             <a class="code" href="../../d1/d7/4_2kdp_8h.html#a103">KdpPromptString</a>(&amp;Output, &amp;Input);
00202             ContextRecord-&gt;Gpr3 = Input.Length;
00203             <a class="code" href="../../d9/d6/ppc_2ipi_8c.html#a2">KiRestoreProcessorState</a>(TrapFrame, ExceptionFrame);
00204             <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a18">KdExitDebugger</a>(Enable);
00205             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00206 
00207             <span class="comment">//</span>
00208             <span class="comment">// Load the symbolic information for an image.</span>
00209             <span class="comment">//</span>
00210             <span class="comment">// Arguments:</span>
00211             <span class="comment">//</span>
00212             <span class="comment">//    r.3 - Supplies a pointer to an output string descriptor.</span>
00213             <span class="comment">//    r.4 - Supplies a the base address of the image.</span>
00214             <span class="comment">//</span>
00215 
00216         <span class="keywordflow">case</span> DEBUG_UNLOAD_SYMBOLS_BREAKPOINT:
00217             UnloadSymbols = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00218 
00219             <span class="comment">//</span>
00220             <span class="comment">// Fall through</span>
00221             <span class="comment">//</span>
00222 
00223         <span class="keywordflow">case</span> DEBUG_LOAD_SYMBOLS_BREAKPOINT:
00224             OldIar = ContextRecord-&gt;Iar;
00225             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/kd_8h.html#a12">KdDebuggerNotPresent</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00226                 <a class="code" href="../../d1/d7/4_2kdp_8h.html#a121">KdpReportLoadSymbolsStateChange</a>((PSTRING)ContextRecord-&gt;Gpr3,
00227                                                 (<a class="code" href="../../d6/d5/struct__KD__SYMBOLS__INFO.html">PKD_SYMBOLS_INFO</a>) ContextRecord-&gt;Gpr4,
00228                                                 UnloadSymbols,
00229                                                 &amp;Prcb-&gt;ProcessorState.ContextFrame);
00230 
00231             }
00232 
00233             RtlCopyMemory(ContextRecord,
00234                           &amp;Prcb-&gt;ProcessorState.ContextFrame,
00235                           <span class="keyword">sizeof</span>(CONTEXT));
00236 
00237             <a class="code" href="../../d9/d6/ppc_2ipi_8c.html#a2">KiRestoreProcessorState</a>(TrapFrame, ExceptionFrame);
00238             <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a18">KdExitDebugger</a>(Enable);
00239 
00240             <span class="comment">//</span>
00241             <span class="comment">// If the kernel debugger did not update the IAR, then increment</span>
00242             <span class="comment">// past the breakpoint instruction.</span>
00243             <span class="comment">//</span>
00244 
00245             <span class="keywordflow">if</span> (ContextRecord-&gt;Iar == OldIar) {
00246                 ContextRecord-&gt;Iar += 4;
00247             }
00248 
00249             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00250 
00251             <span class="comment">//</span>
00252             <span class="comment">// Unknown internal command.</span>
00253             <span class="comment">//</span>
00254 
00255         <span class="keywordflow">default</span>:
00256             <span class="keywordflow">break</span>;
00257         }
00258     }
00259 
00260     <span class="comment">//</span>
00261     <span class="comment">// Report state change to kernel debugger on host machine.</span>
00262     <span class="comment">//</span>
00263 
00264     Completion = <a class="code" href="../../d1/d7/4_2kdp_8h.html#a120">KdpReportExceptionStateChange</a>(
00265                     ExceptionRecord,
00266                     &amp;Prcb-&gt;ProcessorState.ContextFrame,
00267                     SecondChance);
00268 
00269     RtlCopyMemory(ContextRecord,
00270                   &amp;Prcb-&gt;ProcessorState.ContextFrame,
00271                   <span class="keyword">sizeof</span>(CONTEXT));
00272 
00273     <a class="code" href="../../d9/d6/ppc_2ipi_8c.html#a2">KiRestoreProcessorState</a>(TrapFrame, ExceptionFrame);
00274     <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a18">KdExitDebugger</a>(Enable);
00275 
00276     <span class="comment">//</span>
00277     <span class="comment">// check to see if the user of the remote debugger</span>
00278     <span class="comment">// requested memory to be paged in</span>
00279     <span class="comment">//</span>
00280     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d8/mips_2kdtrap_8c.html#a2">KdpPageInAddress</a>) {
00281 
00282         <span class="keywordflow">if</span> (KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) {
00283 
00284             <span class="comment">//</span>
00285             <span class="comment">// if the IQRL is below DPC level then cause</span>
00286             <span class="comment">// the page fault to occur and then re-enter</span>
00287             <span class="comment">// the debugger.  this whole process is transparent</span>
00288             <span class="comment">// to the user.</span>
00289             <span class="comment">//</span>
00290             <a class="code" href="../../d0/d9/ppc_2kdtrap_8c.html#a4">KdpPageInData</a>( (PUCHAR)<a class="code" href="../../d9/d8/mips_2kdtrap_8c.html#a2">KdpPageInAddress</a> );
00291             <a class="code" href="../../d9/d8/mips_2kdtrap_8c.html#a2">KdpPageInAddress</a> = 0;
00292             <a class="code" href="../../d8/d5/kddata_8c.html#a89">KdpControlCPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00293             <span class="keywordflow">goto</span> re_enter_debugger;
00294 
00295         } <span class="keywordflow">else</span> {
00296 
00297             <span class="comment">//</span>
00298             <span class="comment">// we cannot take a page fault</span>
00299             <span class="comment">// here so a worker item is queued to take the</span>
00300             <span class="comment">// page fault.  after the worker item takes the</span>
00301             <span class="comment">// page fault it sets the contol-c flag so that</span>
00302             <span class="comment">// the user re-enters the debugger just as if</span>
00303             <span class="comment">// control-c was pressed.</span>
00304             <span class="comment">//</span>
00305             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a90">KdpControlCPressed</a>) {
00306                 <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>(
00307                     &amp;<a class="code" href="../../d9/d8/mips_2kdtrap_8c.html#a3">KdpPageInWorkItem</a>,
00308                     (<a class="code" href="../../d5/d8/ex_8h.html#a111">PWORKER_THREAD_ROUTINE</a>) <a class="code" href="../../d9/d8/mips_2kdtrap_8c.html#a5">KdpPageInData</a>,
00309                     (PVOID) <a class="code" href="../../d9/d8/mips_2kdtrap_8c.html#a2">KdpPageInAddress</a>
00310                     );
00311                 <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>( &amp;<a class="code" href="../../d9/d8/mips_2kdtrap_8c.html#a3">KdpPageInWorkItem</a>, <a class="code" href="../../d5/d8/ex_8h.html#a332a206">DelayedWorkQueue</a> );
00312                 <a class="code" href="../../d9/d8/mips_2kdtrap_8c.html#a2">KdpPageInAddress</a> = 0;
00313             }
00314         }
00315     }
00316 
00317     <a class="code" href="../../d8/d5/kddata_8c.html#a90">KdpControlCPressed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00318 
00319     <span class="keywordflow">return</span> Completion;
00320 }
00321 
00322 BOOLEAN
<a name="l00323"></a><a class="code" href="../../d0/d9/ppc_2kdtrap_8c.html#a6">00323</a> <a class="code" href="../../d3/d9/4_2ia64_2kdtrap_8c.html#a1">KdIsThisAKdTrap</a> (
00324     IN PEXCEPTION_RECORD ExceptionRecord,
00325     IN PCONTEXT ContextRecord,
00326     IN KPROCESSOR_MODE PreviousMode
00327     )
00328 
00329 <span class="comment">/*++</span>
00330 <span class="comment"></span>
00331 <span class="comment">Routine Description:</span>
00332 <span class="comment"></span>
00333 <span class="comment">    This routine is called whenever a user-mode exception occurs and</span>
00334 <span class="comment">    it might be a kernel debugger exception (Like DbgPrint/DbgPrompt ).</span>
00335 <span class="comment"></span>
00336 <span class="comment">Arguments:</span>
00337 <span class="comment"></span>
00338 <span class="comment">    ExceptionRecord - Supplies a pointer to an exception record that</span>
00339 <span class="comment">        describes the exception.</span>
00340 <span class="comment"></span>
00341 <span class="comment">    ContextRecord - Supplies the context at the time of the exception.</span>
00342 <span class="comment"></span>
00343 <span class="comment">    PreviousMode - Supplies the previous processor mode.</span>
00344 <span class="comment"></span>
00345 <span class="comment">Return Value:</span>
00346 <span class="comment"></span>
00347 <span class="comment">    A value of TRUE is returned if this is for the kernel debugger.</span>
00348 <span class="comment">    Otherwise, a value of FALSE is returned.</span>
00349 <span class="comment"></span>
00350 <span class="comment">--*/</span>
00351 
00352 {
00353 
00354     ULONG BreakpointCode;
00355 
00356     <span class="comment">//</span>
00357     <span class="comment">// Determine if this is hardware debug register breakpoint</span>
00358     <span class="comment">//</span>
00359 
00360     <span class="keywordflow">if</span> (ContextRecord-&gt;Dr6 !=0) {      <span class="comment">// Debug Register Breakpoint</span>
00361         <span class="keywordflow">if</span> ((PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) ||
00362             (<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;DebugActive == 0)) { <span class="comment">// No DR set for thread</span>
00363             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00364         } <span class="keywordflow">else</span> {                       <span class="comment">// User mode and DR set for thread</span>
00365             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00366         }
00367     }
00368 
00369     <span class="comment">//</span>
00370     <span class="comment">// Isolate the breakpoint code from the breakpoint instruction which</span>
00371     <span class="comment">// is stored by the exception dispatch code in the information field</span>
00372     <span class="comment">// of the exception record.</span>
00373     <span class="comment">//</span>
00374 
00375     BreakpointCode = ExceptionRecord-&gt;ExceptionInformation[0] &amp; <a class="code" href="../../d9/d8/mips_2kdtrap_8c.html#a1">BREAKPOINT_CODE_MASK</a>;
00376 
00377     <span class="comment">//</span>
00378     <span class="comment">// Switch on the breakpoint code.</span>
00379     <span class="comment">//</span>
00380 
00381     <span class="keywordflow">switch</span> (BreakpointCode) {
00382 
00383         <span class="comment">//</span>
00384         <span class="comment">// Kernel breakpoint codes.</span>
00385         <span class="comment">//</span>
00386 
00387     <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/halmips_8h.html#a454">BREAKIN_BREAKPOINT</a>:
00388     <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/halmips_8h.html#a453">KERNEL_BREAKPOINT</a>:
00389 
00390 <span class="preprocessor">#if DEVL</span>
00391 <span class="preprocessor"></span>
00392         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00393 
00394 <span class="preprocessor">#else</span>
00395 <span class="preprocessor"></span>
00396         <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00397             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00398 
00399         } <span class="keywordflow">else</span> {
00400             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00401         }
00402 
00403 <span class="preprocessor">#endif</span>
00404 <span class="preprocessor"></span>
00405         <span class="comment">//</span>
00406         <span class="comment">// Debug print code.</span>
00407         <span class="comment">//</span>
00408 
00409     <span class="keywordflow">case</span> DEBUG_PRINT_BREAKPOINT:
00410         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00411 
00412         <span class="comment">//</span>
00413         <span class="comment">// Debug prompt code.</span>
00414         <span class="comment">//</span>
00415 
00416     <span class="keywordflow">case</span> DEBUG_PROMPT_BREAKPOINT:
00417         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00418 
00419         <span class="comment">//</span>
00420         <span class="comment">// Debug stop code.</span>
00421         <span class="comment">//</span>
00422 
00423     <span class="keywordflow">case</span> SINGLE_STEP_BREAKPOINT:
00424     <span class="keywordflow">case</span> DEBUG_STOP_BREAKPOINT:
00425 
00426 <span class="preprocessor">#if DEVL</span>
00427 <span class="preprocessor"></span>
00428         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00429 
00430 <span class="preprocessor">#else</span>
00431 <span class="preprocessor"></span>
00432         <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00433             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00434 
00435         } <span class="keywordflow">else</span> {
00436             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00437         }
00438 
00439 <span class="preprocessor">#endif</span>
00440 <span class="preprocessor"></span>
00441         <span class="comment">//</span>
00442         <span class="comment">// Debug load symbols code.</span>
00443         <span class="comment">//</span>
00444 
00445     <span class="keywordflow">case</span> DEBUG_LOAD_SYMBOLS_BREAKPOINT:
00446         <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00447             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00448 
00449         } <span class="keywordflow">else</span> {
00450             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00451         }
00452 
00453         <span class="comment">//</span>
00454         <span class="comment">// Debug unload symbols code.</span>
00455         <span class="comment">//</span>
00456 
00457     <span class="keywordflow">case</span> DEBUG_UNLOAD_SYMBOLS_BREAKPOINT:
00458         <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00459             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00460 
00461         } <span class="keywordflow">else</span> {
00462             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00463         }
00464 
00465         <span class="comment">//</span>
00466         <span class="comment">// All other codes.</span>
00467         <span class="comment">//</span>
00468 
00469     <span class="keywordflow">default</span>:
00470         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00471     }
00472 }
00473 
00474 BOOLEAN
<a name="l00475"></a><a class="code" href="../../d0/d9/ppc_2kdtrap_8c.html#a7">00475</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a117">KdpStub</a> (
00476     IN PKTRAP_FRAME TrapFrame,
00477     IN PKEXCEPTION_FRAME ExceptionFrame,
00478     IN PEXCEPTION_RECORD ExceptionRecord,
00479     IN PCONTEXT ContextRecord,
00480     IN KPROCESSOR_MODE PreviousMode,
00481     IN BOOLEAN SecondChance
00482     )
00483 
00484 <span class="comment">/*++</span>
00485 <span class="comment"></span>
00486 <span class="comment">Routine Description:</span>
00487 <span class="comment"></span>
00488 <span class="comment">    This routine provides a kernel debugger stub routine that catchs debug</span>
00489 <span class="comment">    prints in checked systems when the kernel debugger is not active.</span>
00490 <span class="comment"></span>
00491 <span class="comment">Arguments:</span>
00492 <span class="comment"></span>
00493 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame that describes the</span>
00494 <span class="comment">        trap.</span>
00495 <span class="comment"></span>
00496 <span class="comment">    ExceptionFrame - Supplies a pointer to a exception frame that describes</span>
00497 <span class="comment">        the trap.</span>
00498 <span class="comment"></span>
00499 <span class="comment">    ExceptionRecord - Supplies a pointer to an exception record that</span>
00500 <span class="comment">        describes the exception.</span>
00501 <span class="comment"></span>
00502 <span class="comment">    ContextRecord - Supplies the context at the time of the exception.</span>
00503 <span class="comment"></span>
00504 <span class="comment">    PreviousMode - Supplies the previous processor mode.</span>
00505 <span class="comment"></span>
00506 <span class="comment">    SecondChance - Supplies a boolean value that determines whether this is</span>
00507 <span class="comment">        the second chance (TRUE) that the exception has been raised.</span>
00508 <span class="comment"></span>
00509 <span class="comment">Return Value:</span>
00510 <span class="comment"></span>
00511 <span class="comment">    A value of TRUE is returned if the exception is handled. Otherwise a</span>
00512 <span class="comment">    value of FALSE is returned.</span>
00513 <span class="comment"></span>
00514 <span class="comment">--*/</span>
00515 
00516 {
00517 
00518     ULONG BreakpointCode;
00519 
00520     <span class="comment">//</span>
00521     <span class="comment">// If it isn't a real breakpoint or doesn't have any params, get out.</span>
00522     <span class="comment">//</span>
00523 
00524     <span class="keywordflow">if</span> ((ExceptionRecord-&gt;ExceptionCode != STATUS_BREAKPOINT) ||
00525         (ExceptionRecord-&gt;NumberParameters == 0)) {
00526         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00527     }
00528 
00529     <span class="comment">//</span>
00530     <span class="comment">// Isolate the breakpoint code from the breakpoint instruction which</span>
00531     <span class="comment">// is stored by the exception dispatch code in the information field</span>
00532     <span class="comment">// of the exception record.</span>
00533     <span class="comment">//</span>
00534 
00535     BreakpointCode = ExceptionRecord-&gt;ExceptionInformation[0] &amp; <a class="code" href="../../d9/d8/mips_2kdtrap_8c.html#a1">BREAKPOINT_CODE_MASK</a>;
00536 
00537 
00538     <span class="comment">//</span>
00539     <span class="comment">// If the breakpoint is a debug print, debug load symbols, or debug</span>
00540     <span class="comment">// unload symbols, then return TRUE. Otherwise, return FALSE;</span>
00541     <span class="comment">//</span>
00542 
00543     <span class="keywordflow">if</span> ((BreakpointCode == DEBUG_PRINT_BREAKPOINT) ||
00544         (BreakpointCode == DEBUG_LOAD_SYMBOLS_BREAKPOINT) ||
00545         (BreakpointCode == DEBUG_UNLOAD_SYMBOLS_BREAKPOINT)) {
00546         ContextRecord-&gt;Iar += 4;
00547         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00548 
00549     } <span class="keywordflow">else</span> {
00550         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00551     }
00552 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:35 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
