<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: fsrtl.h File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>fsrtl.h File Reference</h1>
<p>
<a href="../../d2/d7/fsrtl_8h-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">_FSRTL_COMMON_FCB_HEADER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/struct__FSRTL__ADVANCED__FCB__HEADER.html">_FSRTL_ADVANCED_FCB_HEADER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/struct__EOF__WAIT__BLOCK.html">_EOF_WAIT_BLOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d1/struct__FSRTL__AUXILIARY__BUFFER.html">_FSRTL_AUXILIARY_BUFFER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/struct__FILE__LOCK__INFO.html">_FILE_LOCK_INFO</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/struct__FILE__LOCK.html">_FILE_LOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d1/structTUNNEL.html">TUNNEL</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/struct__LARGE__MCB.html">_LARGE_MCB</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/struct__MCB.html">_MCB</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">_FSRTL_FILTER_CONTEXT</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a0">FSRTL_FLAG_FILE_MODIFIED</a>&nbsp;&nbsp;&nbsp;(0x01)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a1">FSRTL_FLAG_FILE_LENGTH_CHANGED</a>&nbsp;&nbsp;&nbsp;(0x02)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a2">FSRTL_FLAG_LIMIT_MODIFIED_PAGES</a>&nbsp;&nbsp;&nbsp;(0x04)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a3">FSRTL_FLAG_ACQUIRE_MAIN_RSRC_EX</a>&nbsp;&nbsp;&nbsp;(0x08)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a4">FSRTL_FLAG_ACQUIRE_MAIN_RSRC_SH</a>&nbsp;&nbsp;&nbsp;(0x10)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a5">FSRTL_FLAG_USER_MAPPED_FILE</a>&nbsp;&nbsp;&nbsp;(0x20)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a6">FSRTL_FLAG_ADVANCED_HEADER</a>&nbsp;&nbsp;&nbsp;(0x40)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a7">FSRTL_FLAG_EOF_ADVANCE_ACTIVE</a>&nbsp;&nbsp;&nbsp;(0x80)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a8">FSRTL_FLAG2_DO_MODIFIED_WRITE</a>&nbsp;&nbsp;&nbsp;(0x01)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a9">FSRTL_FLAG2_SUPPORTS_FILTER_CONTEXTS</a>&nbsp;&nbsp;&nbsp;(0x02)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a10">FSRTL_FLAG2_PURGE_WHEN_MAPPED</a>&nbsp;&nbsp;&nbsp;(0x04)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a11">FSRTL_FSP_TOP_LEVEL_IRP</a>&nbsp;&nbsp;&nbsp;0x01</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a12">FSRTL_CACHE_TOP_LEVEL_IRP</a>&nbsp;&nbsp;&nbsp;0x02</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a13">FSRTL_MOD_WRITE_TOP_LEVEL_IRP</a>&nbsp;&nbsp;&nbsp;0x03</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a14">FSRTL_FAST_IO_TOP_LEVEL_IRP</a>&nbsp;&nbsp;&nbsp;0x04</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a15">FSRTL_MAX_TOP_LEVEL_IRP_FLAG</a>&nbsp;&nbsp;&nbsp;0x04</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a16">FSRTL_AUXILIARY_FLAG_DEALLOCATE</a>&nbsp;&nbsp;&nbsp;0x00000001</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a17">FsRtlSetTopLevelIrpForModWriter</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a18">FsRtlFastLock</a>(A1, A2, A3, A4, A5, A6, A7, A8, A9, A10, A11)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a19">FsRtlAreThereCurrentFileLocks</a>(FL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a20">LEGAL_ANSI_CHARACTER_ARRAY</a>&nbsp;&nbsp;&nbsp;<a class="el" href="../../d4/d8/fsrtlpc_8c.html#a13">FsRtlLegalAnsiCharacterArray</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a21">NLS_MB_CODE_PAGE_TAG</a>&nbsp;&nbsp;&nbsp;<a class="el" href="../../d9/d6/nlsxlat_8c.html#a26">NlsMbOemCodePageTag</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a22">NLS_OEM_LEAD_BYTE_INFO</a>&nbsp;&nbsp;&nbsp;<a class="el" href="../../d9/d6/nlsxlat_8c.html#a21">NlsOemLeadByteInfo</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a23">FSRTL_FAT_LEGAL</a>&nbsp;&nbsp;&nbsp;0x01</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a24">FSRTL_HPFS_LEGAL</a>&nbsp;&nbsp;&nbsp;0x02</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a25">FSRTL_NTFS_LEGAL</a>&nbsp;&nbsp;&nbsp;0x04</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a26">FSRTL_WILD_CHARACTER</a>&nbsp;&nbsp;&nbsp;0x08</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a27">FSRTL_OLE_LEGAL</a>&nbsp;&nbsp;&nbsp;0x10</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a28">FSRTL_NTFS_STREAM_LEGAL</a>&nbsp;&nbsp;&nbsp;(FSRTL_NTFS_LEGAL | FSRTL_OLE_LEGAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a29">FsRtlIsAnsiCharacterWild</a>(C)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a30">FsRtlIsAnsiCharacterLegalFat</a>(C, WILD_OK)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a31">FsRtlIsAnsiCharacterLegalHpfs</a>(C, WILD_OK)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a32">FsRtlIsAnsiCharacterLegalNtfs</a>(C, WILD_OK)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a33">FsRtlIsAnsiCharacterLegalNtfsStream</a>(C, WILD_OK)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a34">FsRtlIsAnsiCharacterLegal</a>(C, FLAGS)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a35">FsRtlTestAnsiCharacter</a>(C, DEFAULT_RET, WILD_OK, FLAGS)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a36">FsRtlIsLeadDbcsCharacter</a>(DBCS_CHAR)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a37">FsRtlAllocatePoolWithTag</a>(PoolType, NumberOfBytes, Tag)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a38">FsRtlAllocatePoolWithQuotaTag</a>(PoolType, NumberOfBytes, Tag)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a39">FSRTL_VOLUME_DISMOUNT</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a40">FSRTL_VOLUME_DISMOUNT_FAILED</a>&nbsp;&nbsp;&nbsp;2</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a41">FSRTL_VOLUME_LOCK</a>&nbsp;&nbsp;&nbsp;3</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a42">FSRTL_VOLUME_LOCK_FAILED</a>&nbsp;&nbsp;&nbsp;4</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a43">FSRTL_VOLUME_UNLOCK</a>&nbsp;&nbsp;&nbsp;5</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a44">FSRTL_VOLUME_MOUNT</a>&nbsp;&nbsp;&nbsp;6</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a45">FsRtlIsUnicodeCharacterWild</a>(C)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a46">FsRtlLookupFilterContext</a>(fo, oid, iid)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>(<a class="el" href="../../d0/d2/struct__IRP.html">IRP</a>, STATUS)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>()</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a51">PLBN</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a53">PVBN</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d1/d8/fsrtl_8h.html#a188">_FAST_IO_POSSIBLE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a54">FAST_IO_POSSIBLE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">_FSRTL_COMMON_FCB_HEADER</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a55">FSRTL_COMMON_FCB_HEADER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">FSRTL_COMMON_FCB_HEADER</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a56">PFSRTL_COMMON_FCB_HEADER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d0/struct__FSRTL__ADVANCED__FCB__HEADER.html">_FSRTL_ADVANCED_FCB_HEADER</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a57">FSRTL_ADVANCED_FCB_HEADER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d0/struct__FSRTL__ADVANCED__FCB__HEADER.html">FSRTL_ADVANCED_FCB_HEADER</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a58">PFSRTL_ADVANCED_FCB_HEADER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d3/struct__EOF__WAIT__BLOCK.html">_EOF_WAIT_BLOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a59">EOF_WAIT_BLOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d3/struct__EOF__WAIT__BLOCK.html">EOF_WAIT_BLOCK</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a60">PEOF_WAIT_BLOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d1/struct__FSRTL__AUXILIARY__BUFFER.html">_FSRTL_AUXILIARY_BUFFER</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a61">FSRTL_AUXILIARY_BUFFER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d1/struct__FSRTL__AUXILIARY__BUFFER.html">FSRTL_AUXILIARY_BUFFER</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a62">PFSRTL_AUXILIARY_BUFFER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d1/struct__FILE__LOCK__INFO.html">_FILE_LOCK_INFO</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a63">FILE_LOCK_INFO</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d1/struct__FILE__LOCK__INFO.html">FILE_LOCK_INFO</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a64">PFILE_LOCK_INFO</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef NTSTATUS(*&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a65">PCOMPLETE_LOCK_IRP_ROUTINE</a> )(IN PVOID Context, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef VOID(*&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a66">PUNLOCK_ROUTINE</a> )(IN PVOID Context, IN <a class="el" href="../../d8/d1/struct__FILE__LOCK__INFO.html">PFILE_LOCK_INFO</a> FileLockInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">_FILE_LOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a67">FILE_LOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">FILE_LOCK</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a68">PFILE_LOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a69">PTUNNEL</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d1/d8/fsrtl_8h.html#a189">_FSRTL_COMPARISON_RESULT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a70">FSRTL_COMPARISON_RESULT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d9/struct__LARGE__MCB.html">_LARGE_MCB</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a73">LARGE_MCB</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d9/struct__LARGE__MCB.html">LARGE_MCB</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a74">PLARGE_MCB</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d2/d7/struct__MCB.html">_MCB</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a75">MCB</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d2/d7/struct__MCB.html">MCB</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a76">PMCB</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a77">OPLOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef PVOID *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a78">POPLOCK</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef VOID(*&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a79">POPLOCK_WAIT_COMPLETE_ROUTINE</a> )(IN PVOID Context, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef VOID(*&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a80">POPLOCK_FS_PREPOST_IRP</a> )(IN PVOID Context, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef BOOLEAN(*&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a82">PCHECK_FOR_TRAVERSE_ACCESS</a> )(IN PVOID NotifyContext, IN PVOID TargetContext, IN <a class="el" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef VOID(*&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a83">PFSRTL_STACK_OVERFLOW_ROUTINE</a> )(IN PVOID Context, IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> Event)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">_FSRTL_FILTER_CONTEXT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a84">FSRTL_FILTER_CONTEXT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">_FSRTL_FILTER_CONTEXT</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a85">PFSRTL_FILTER_CONTEXT</a></td></tr>

<tr><td colspan=2><br><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a188">_FAST_IO_POSSIBLE</a> { <a class="el" href="../../d1/d8/fsrtl_8h.html#a188a86">FastIoIsNotPossible</a> =  0, 
<a class="el" href="../../d1/d8/fsrtl_8h.html#a188a87">FastIoIsPossible</a>, 
<a class="el" href="../../d1/d8/fsrtl_8h.html#a188a88">FastIoIsQuestionable</a>
 }</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a189">_FSRTL_COMPARISON_RESULT</a> { <a class="el" href="../../d1/d8/fsrtl_8h.html#a189a89">LessThan</a> =  -1, 
<a class="el" href="../../d1/d8/fsrtl_8h.html#a189a90">EqualTo</a> =  0, 
<a class="el" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a> =  1
 }</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a92">FsRtlInitSystem</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a93">FsRtlCopyRead</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN PLARGE_INTEGER FileOffset, IN ULONG Length, IN BOOLEAN Wait, IN ULONG LockKey, OUT PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, OUT PIO_STATUS_BLOCK IoStatus, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a94">FsRtlCopyWrite</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN PLARGE_INTEGER FileOffset, IN ULONG Length, IN BOOLEAN Wait, IN ULONG LockKey, IN PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, OUT PIO_STATUS_BLOCK IoStatus, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a95">FsRtlMdlRead</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN PLARGE_INTEGER FileOffset, IN ULONG Length, IN ULONG LockKey, OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> *MdlChain, OUT PIO_STATUS_BLOCK IoStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a96">FsRtlMdlReadComplete</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MdlChain)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a97">FsRtlPrepareMdlWrite</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN PLARGE_INTEGER FileOffset, IN ULONG Length, IN ULONG LockKey, OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> *MdlChain, OUT PIO_STATUS_BLOCK IoStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a98">FsRtlMdlWriteComplete</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN PLARGE_INTEGER FileOffset, IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MdlChain)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a99">FsRtlMdlReadDev</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN PLARGE_INTEGER FileOffset, IN ULONG Length, IN ULONG LockKey, OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> *MdlChain, OUT PIO_STATUS_BLOCK IoStatus, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a100">FsRtlMdlReadCompleteDev</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MdlChain, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a101">FsRtlPrepareMdlWriteDev</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN PLARGE_INTEGER FileOffset, IN ULONG Length, IN ULONG LockKey, OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> *MdlChain, OUT PIO_STATUS_BLOCK IoStatus, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a102">FsRtlMdlWriteCompleteDev</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN PLARGE_INTEGER FileOffset, IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MdlChain, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a103">FsRtlAcquireFileForModWrite</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN PLARGE_INTEGER StartingOffset, OUT <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> *ResourceToRelease)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a104">FsRtlReleaseFileForModWrite</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> ResourceToRelease)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a105">FsRtlAcquireFileForCcFlush</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a106">FsRtlReleaseFileForCcFlush</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a107">FsRtlAcquireFileExclusive</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a108">FsRtlReleaseFile</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a109">FsRtlGetFileSize</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN OUT PLARGE_INTEGER FileSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a110">FsRtlSetFileSize</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN OUT PLARGE_INTEGER FileSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a111">FsRtlIsTotalDeviceFailure</a> (IN NTSTATUS <a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a112">FsRtlAllocateFileLock</a> (IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a65">PCOMPLETE_LOCK_IRP_ROUTINE</a> CompleteLockIrpRoutine OPTIONAL, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a66">PUNLOCK_ROUTINE</a> UnlockRoutine OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a113">FsRtlFreeFileLock</a> (IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FileLock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a114">FsRtlInitializeFileLock</a> (IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FileLock, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a65">PCOMPLETE_LOCK_IRP_ROUTINE</a> CompleteLockIrpRoutine OPTIONAL, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a66">PUNLOCK_ROUTINE</a> UnlockRoutine OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a115">FsRtlUninitializeFileLock</a> (IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FileLock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a116">FsRtlProcessFileLock</a> (IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FileLock, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN PVOID Context OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a117">FsRtlCheckLockForReadAccess</a> (IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FileLock, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a118">FsRtlCheckLockForWriteAccess</a> (IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FileLock, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a119">FsRtlFastCheckLockForRead</a> (IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FileLock, IN PLARGE_INTEGER StartingByte, IN PLARGE_INTEGER Length, IN ULONG <a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>, IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN PVOID ProcessId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a120">FsRtlFastCheckLockForWrite</a> (IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FileLock, IN PLARGE_INTEGER StartingByte, IN PLARGE_INTEGER Length, IN ULONG <a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>, IN PVOID FileObject, IN PVOID ProcessId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI <a class="el" href="../../d8/d1/struct__FILE__LOCK__INFO.html">PFILE_LOCK_INFO</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a121">FsRtlGetNextFileLock</a> (IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FileLock, IN BOOLEAN Restart)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a122">FsRtlFastUnlockSingle</a> (IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FileLock, IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN LARGE_INTEGER UNALIGNED *FileOffset, IN PLARGE_INTEGER Length, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessId, IN ULONG <a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>, IN PVOID Context OPTIONAL, IN BOOLEAN AlreadySynchronized)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a123">FsRtlFastUnlockAll</a> (IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FileLock, IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessId, IN PVOID Context OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a124">FsRtlFastUnlockAllByKey</a> (IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FileLock, IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessId, IN ULONG <a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>, IN PVOID Context OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a125">FsRtlPrivateLock</a> (IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FileLock, IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN PLARGE_INTEGER FileOffset, IN PLARGE_INTEGER Length, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessId, IN ULONG <a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>, IN BOOLEAN FailImmediately, IN BOOLEAN ExclusiveLock, OUT PIO_STATUS_BLOCK Iosb, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN PVOID Context, IN BOOLEAN AlreadySynchronized)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a126">FsRtlInitializeTunnelCache</a> (IN <a class="el" href="../../d4/d1/structTUNNEL.html">TUNNEL</a> *Cache)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a127">FsRtlAddToTunnelCache</a> (IN <a class="el" href="../../d4/d1/structTUNNEL.html">TUNNEL</a> *Cache, IN ULONGLONG DirectoryKey, IN UNICODE_STRING *ShortName, IN UNICODE_STRING *LongName, IN BOOLEAN KeyByShortName, IN ULONG DataLength, IN VOID *Data)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a128">FsRtlFindInTunnelCache</a> (IN <a class="el" href="../../d4/d1/structTUNNEL.html">TUNNEL</a> *Cache, IN ULONGLONG DirectoryKey, IN UNICODE_STRING *<a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>, OUT UNICODE_STRING *ShortName, OUT UNICODE_STRING *LongName, IN OUT ULONG *DataLength, OUT VOID *Data)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a129">FsRtlDeleteKeyFromTunnelCache</a> (IN <a class="el" href="../../d4/d1/structTUNNEL.html">TUNNEL</a> *Cache, IN ULONGLONG DirectoryKey)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a130">FsRtlDeleteTunnelCache</a> (IN <a class="el" href="../../d4/d1/structTUNNEL.html">TUNNEL</a> *Cache)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a131">FsRtlDissectDbcs</a> (IN ANSI_STRING InputName, OUT PANSI_STRING FirstPart, OUT PANSI_STRING RemainingPart)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a132">FsRtlDoesDbcsContainWildCards</a> (IN PANSI_STRING <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a133">FsRtlIsDbcsInExpression</a> (IN PANSI_STRING Expression, IN PANSI_STRING <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a134">FsRtlIsFatDbcsLegal</a> (IN ANSI_STRING DbcsName, IN BOOLEAN WildCardsPermissible, IN BOOLEAN PathNamePermissible, IN BOOLEAN LeadingBackslashPermissible)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a135">FsRtlIsHpfsDbcsLegal</a> (IN ANSI_STRING DbcsName, IN BOOLEAN WildCardsPermissible, IN BOOLEAN PathNamePermissible, IN BOOLEAN LeadingBackslashPermissible)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a136">FsRtlNormalizeNtstatus</a> (IN NTSTATUS Exception, IN NTSTATUS GenericException)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a137">FsRtlIsNtstatusExpected</a> (IN NTSTATUS Exception)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a138">FsRtlAllocateResource</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a139">FsRtlInitializeLargeMcb</a> (IN <a class="el" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a> Mcb, IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a140">FsRtlUninitializeLargeMcb</a> (IN <a class="el" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a> Mcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a141">FsRtlResetLargeMcb</a> (IN <a class="el" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a> Mcb, IN BOOLEAN SelfSynchronized)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a142">FsRtlTruncateLargeMcb</a> (IN <a class="el" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a> Mcb, IN LONGLONG Vbn)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a143">FsRtlAddLargeMcbEntry</a> (IN <a class="el" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a> Mcb, IN LONGLONG Vbn, IN LONGLONG Lbn, IN LONGLONG SectorCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a144">FsRtlRemoveLargeMcbEntry</a> (IN <a class="el" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a> Mcb, IN LONGLONG Vbn, IN LONGLONG SectorCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a145">FsRtlLookupLargeMcbEntry</a> (IN <a class="el" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a> Mcb, IN LONGLONG Vbn, OUT PLONGLONG Lbn OPTIONAL, OUT PLONGLONG SectorCountFromLbn OPTIONAL, OUT PLONGLONG StartingLbn OPTIONAL, OUT PLONGLONG SectorCountFromStartingLbn OPTIONAL, OUT PULONG <a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a> OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a146">FsRtlLookupLastLargeMcbEntry</a> (IN <a class="el" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a> Mcb, OUT PLONGLONG Vbn, OUT PLONGLONG Lbn)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a147">FsRtlLookupLastLargeMcbEntryAndIndex</a> (IN <a class="el" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a> OpaqueMcb, OUT PLONGLONG LargeVbn, OUT PLONGLONG LargeLbn, OUT PULONG <a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a148">FsRtlNumberOfRunsInLargeMcb</a> (IN <a class="el" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a> Mcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a149">FsRtlGetNextLargeMcbEntry</a> (IN <a class="el" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a> Mcb, IN ULONG RunIndex, OUT PLONGLONG Vbn, OUT PLONGLONG Lbn, OUT PLONGLONG SectorCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a150">FsRtlSplitLargeMcb</a> (IN <a class="el" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a> Mcb, IN LONGLONG Vbn, IN LONGLONG Amount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a151">FsRtlInitializeMcb</a> (IN <a class="el" href="../../d2/d7/struct__MCB.html">PMCB</a> Mcb, IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a152">FsRtlUninitializeMcb</a> (IN <a class="el" href="../../d2/d7/struct__MCB.html">PMCB</a> Mcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a153">FsRtlTruncateMcb</a> (IN <a class="el" href="../../d2/d7/struct__MCB.html">PMCB</a> Mcb, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a> Vbn)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a154">FsRtlAddMcbEntry</a> (IN <a class="el" href="../../d2/d7/struct__MCB.html">PMCB</a> Mcb, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a> Vbn, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a> Lbn, IN ULONG SectorCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a155">FsRtlRemoveMcbEntry</a> (IN <a class="el" href="../../d2/d7/struct__MCB.html">PMCB</a> Mcb, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a> Vbn, IN ULONG SectorCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a156">FsRtlLookupMcbEntry</a> (IN <a class="el" href="../../d2/d7/struct__MCB.html">PMCB</a> Mcb, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a> Vbn, OUT <a class="el" href="../../d1/d8/fsrtl_8h.html#a51">PLBN</a> Lbn, OUT PULONG SectorCount OPTIONAL, OUT PULONG <a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a157">FsRtlLookupLastMcbEntry</a> (IN <a class="el" href="../../d2/d7/struct__MCB.html">PMCB</a> Mcb, OUT <a class="el" href="../../d1/d8/fsrtl_8h.html#a53">PVBN</a> Vbn, OUT <a class="el" href="../../d1/d8/fsrtl_8h.html#a51">PLBN</a> Lbn)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a158">FsRtlNumberOfRunsInMcb</a> (IN <a class="el" href="../../d2/d7/struct__MCB.html">PMCB</a> Mcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a159">FsRtlGetNextMcbEntry</a> (IN <a class="el" href="../../d2/d7/struct__MCB.html">PMCB</a> Mcb, IN ULONG RunIndex, OUT <a class="el" href="../../d1/d8/fsrtl_8h.html#a53">PVBN</a> Vbn, OUT <a class="el" href="../../d1/d8/fsrtl_8h.html#a51">PLBN</a> Lbn, OUT PULONG SectorCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a160">FsRtlBalanceReads</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> TargetDevice)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a161">FsRtlSyncVolumes</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> TargetDevice, IN PLARGE_INTEGER ByteOffset OPTIONAL, IN PLARGE_INTEGER ByteCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a162">FsRtlInitializeOplock</a> (IN OUT <a class="el" href="../../d1/d8/fsrtl_8h.html#a78">POPLOCK</a> Oplock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a163">FsRtlUninitializeOplock</a> (IN OUT <a class="el" href="../../d1/d8/fsrtl_8h.html#a78">POPLOCK</a> Oplock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a164">FsRtlOplockFsctrl</a> (IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a78">POPLOCK</a> Oplock, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN ULONG OpenCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a165">FsRtlCheckOplock</a> (IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a78">POPLOCK</a> Oplock, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN PVOID Context, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a79">POPLOCK_WAIT_COMPLETE_ROUTINE</a> CompletionRoutine OPTIONAL, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a80">POPLOCK_FS_PREPOST_IRP</a> PostIrpRoutine OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a166">FsRtlOplockIsFastIoPossible</a> (IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a78">POPLOCK</a> Oplock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a167">FsRtlCurrentBatchOplock</a> (IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a78">POPLOCK</a> Oplock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a168">FsRtlNotifyVolumeEvent</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN ULONG EventCode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a169">FsRtlNotifyInitializeSync</a> (IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a> *NotifySync)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a170">FsRtlNotifyUninitializeSync</a> (IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a> *NotifySync)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a171">FsRtlNotifyChangeDirectory</a> (IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a> NotifySync, IN PVOID FsContext, IN PSTRING FullDirectoryName, IN PLIST_ENTRY NotifyList, IN BOOLEAN <a class="el" href="../../d5/d2/rtnotify_8c.html#a4">WatchTree</a>, IN ULONG CompletionFilter, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> NotifyIrp)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a172">FsRtlNotifyFullChangeDirectory</a> (IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a> NotifySync, IN PLIST_ENTRY NotifyList, IN PVOID FsContext, IN PSTRING FullDirectoryName, IN BOOLEAN <a class="el" href="../../d5/d2/rtnotify_8c.html#a4">WatchTree</a>, IN BOOLEAN IgnoreBuffer, IN ULONG CompletionFilter, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> NotifyIrp, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a82">PCHECK_FOR_TRAVERSE_ACCESS</a> TraverseCallback OPTIONAL, IN <a class="el" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectContext OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a173">FsRtlNotifyReportChange</a> (IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a> NotifySync, IN PLIST_ENTRY NotifyList, IN PSTRING FullTargetName, IN PSTRING TargetName, IN ULONG FilterMatch)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a174">FsRtlNotifyFullReportChange</a> (IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a> NotifySync, IN PLIST_ENTRY NotifyList, IN PSTRING FullTargetName, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> TargetNameOffset, IN PSTRING StreamName OPTIONAL, IN PSTRING NormalizedParentName OPTIONAL, IN ULONG FilterMatch, IN ULONG <a class="el" href="../../d9/d3/rules_8c.html#a7">Action</a>, IN PVOID TargetContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a175">FsRtlNotifyCleanup</a> (IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a> NotifySync, IN PLIST_ENTRY NotifyList, IN PVOID FsContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a176">FsRtlDissectName</a> (IN UNICODE_STRING Path, OUT PUNICODE_STRING FirstName, OUT PUNICODE_STRING RemainingName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a177">FsRtlDoesNameContainWildCards</a> (IN PUNICODE_STRING <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a178">FsRtlAreNamesEqual</a> (PCUNICODE_STRING ConstantNameA, PCUNICODE_STRING ConstantNameB, IN BOOLEAN IgnoreCase, IN PCWCH UpcaseTable OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a179">FsRtlIsNameInExpression</a> (IN PUNICODE_STRING Expression, IN PUNICODE_STRING <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>, IN BOOLEAN IgnoreCase, IN PWCH UpcaseTable OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a180">FsRtlPostStackOverflow</a> (IN PVOID Context, IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> Event, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a83">PFSRTL_STACK_OVERFLOW_ROUTINE</a> StackOverflowRoutine)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a181">FsRtlPostPagingFileStackOverflow</a> (IN PVOID Context, IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> Event, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a83">PFSRTL_STACK_OVERFLOW_ROUTINE</a> StackOverflowRoutine)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a182">FsRtlRegisterUncProvider</a> (IN OUT PHANDLE <a class="el" href="../../d5/d9/unc_8c.html#a6">MupHandle</a>, IN PUNICODE_STRING RedirectorDeviceName, IN BOOLEAN <a class="el" href="../../d5/d9/unc_8c.html#a9">MailslotsSupported</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a183">FsRtlDeregisterUncProvider</a> (IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a184">FsRtlInsertFilterContext</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN <a class="el" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">PFSRTL_FILTER_CONTEXT</a> <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a28">Ptr</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI <a class="el" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">PFSRTL_FILTER_CONTEXT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a185">FsRtlLookupFilterContextInternal</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN PVOID OwnerId OPTIONAL, IN PVOID InstanceId OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI <a class="el" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">PFSRTL_FILTER_CONTEXT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a186">FsRtlRemoveFilterContext</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN PVOID OwnerId OPTIONAL, IN PVOID InstanceId OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a187">FsRtlTeardownFilterContexts</a> (IN PLIST_ENTRY FilterContexts)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>PUCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a71">LEGAL_ANSI_CHARACTER_ARRAY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a22">PUSHORT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/fsrtl_8h.html#a72">NLS_OEM_LEAD_BYTE_INFO</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a16" doxytag="fsrtl.h::FSRTL_AUXILIARY_FLAG_DEALLOCATE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSRTL_AUXILIARY_FLAG_DEALLOCATE&nbsp;&nbsp;&nbsp;0x00000001          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00453">453</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="fsrtl.h::FSRTL_CACHE_TOP_LEVEL_IRP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSRTL_CACHE_TOP_LEVEL_IRP&nbsp;&nbsp;&nbsp;0x02          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00283">283</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/resrcsup_8c-source.html#l00136">UdfAcquireForCache()</a>, and <a class="el" href="../../d5/d8/resrcsup_8c-source.html#l00172">UdfReleaseFromCache()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="fsrtl.h::FSRTL_FAST_IO_TOP_LEVEL_IRP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSRTL_FAST_IO_TOP_LEVEL_IRP&nbsp;&nbsp;&nbsp;0x04          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00285">285</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d0/fastio_8c-source.html#l00054">FsRtlCopyRead()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l00330">FsRtlCopyWrite()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l01064">FsRtlMdlReadDev()</a>, and <a class="el" href="../../d4/d0/fastio_8c-source.html#l01474">FsRtlPrepareMdlWriteDev()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="fsrtl.h::FSRTL_FAT_LEGAL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSRTL_FAT_LEGAL&nbsp;&nbsp;&nbsp;0x01          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00935">935</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="fsrtl.h::FSRTL_FLAG2_DO_MODIFIED_WRITE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSRTL_FLAG2_DO_MODIFIED_WRITE&nbsp;&nbsp;&nbsp;(0x01)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00256">256</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d7/fssup_8c-source.html#l00387">CcInitializeCacheMap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="fsrtl.h::FSRTL_FLAG2_PURGE_WHEN_MAPPED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSRTL_FLAG2_PURGE_WHEN_MAPPED&nbsp;&nbsp;&nbsp;(0x04)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00272">272</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d7/fssup_8c-source.html#l02804">CcZeroEndOfLastPage()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="fsrtl.h::FSRTL_FLAG2_SUPPORTS_FILTER_CONTEXTS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSRTL_FLAG2_SUPPORTS_FILTER_CONTEXTS&nbsp;&nbsp;&nbsp;(0x02)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00265">265</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d3/filtrctx_8c-source.html#l00058">FsRtlInsertFilterContext()</a>, <a class="el" href="../../d0/d3/filtrctx_8c-source.html#l00108">FsRtlLookupFilterContextInternal()</a>, and <a class="el" href="../../d0/d3/filtrctx_8c-source.html#l00189">FsRtlRemoveFilterContext()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="fsrtl.h::FSRTL_FLAG_ACQUIRE_MAIN_RSRC_EX" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSRTL_FLAG_ACQUIRE_MAIN_RSRC_EX&nbsp;&nbsp;&nbsp;(0x08)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00221">221</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d0/fastio_8c-source.html#l02064">FsRtlAcquireFileForModWrite()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="fsrtl.h::FSRTL_FLAG_ACQUIRE_MAIN_RSRC_SH" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSRTL_FLAG_ACQUIRE_MAIN_RSRC_SH&nbsp;&nbsp;&nbsp;(0x10)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00222">222</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d0/fastio_8c-source.html#l02064">FsRtlAcquireFileForModWrite()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="fsrtl.h::FSRTL_FLAG_ADVANCED_HEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSRTL_FLAG_ADVANCED_HEADER&nbsp;&nbsp;&nbsp;(0x40)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00236">236</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/copysup_8c-source.html#l01075">CcCopyWrite()</a>, and <a class="el" href="../../d6/d7/fssup_8c-source.html#l02804">CcZeroEndOfLastPage()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="fsrtl.h::FSRTL_FLAG_EOF_ADVANCE_ACTIVE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSRTL_FLAG_EOF_ADVANCE_ACTIVE&nbsp;&nbsp;&nbsp;(0x80)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00243">243</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="fsrtl.h::FSRTL_FLAG_FILE_LENGTH_CHANGED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSRTL_FLAG_FILE_LENGTH_CHANGED&nbsp;&nbsp;&nbsp;(0x02)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00210">210</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="fsrtl.h::FSRTL_FLAG_FILE_MODIFIED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSRTL_FLAG_FILE_MODIFIED&nbsp;&nbsp;&nbsp;(0x01)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00209">209</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="fsrtl.h::FSRTL_FLAG_LIMIT_MODIFIED_PAGES" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSRTL_FLAG_LIMIT_MODIFIED_PAGES&nbsp;&nbsp;&nbsp;(0x04)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00211">211</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/copysup_8c-source.html#l01790">CcCanIWrite()</a>, <a class="el" href="../../d6/d6/copysup_8c-source.html#l01982">CcDeferWrite()</a>, and <a class="el" href="../../d6/d7/fssup_8c-source.html#l02747">CcSetDirtyPageThreshold()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="fsrtl.h::FSRTL_FLAG_USER_MAPPED_FILE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSRTL_FLAG_USER_MAPPED_FILE&nbsp;&nbsp;&nbsp;(0x20)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00229">229</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cachesub_8c-source.html#l04411">CcFlushCache()</a>, and <a class="el" href="../../d6/d7/fssup_8c-source.html#l02804">CcZeroEndOfLastPage()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="fsrtl.h::FSRTL_FSP_TOP_LEVEL_IRP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSRTL_FSP_TOP_LEVEL_IRP&nbsp;&nbsp;&nbsp;0x01          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00282">282</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/stackovf_8c-source.html#l00294">FsRtlStackOverflowRead()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l02748">MiRemoveUnusedSegments()</a>, and <a class="el" href="../../d1/d7/creasect_8c-source.html#l00390">MmCreateSection()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="fsrtl.h::FSRTL_HPFS_LEGAL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSRTL_HPFS_LEGAL&nbsp;&nbsp;&nbsp;0x02          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00936">936</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="fsrtl.h::FSRTL_MAX_TOP_LEVEL_IRP_FLAG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSRTL_MAX_TOP_LEVEL_IRP_FLAG&nbsp;&nbsp;&nbsp;0x04          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00286">286</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="fsrtl.h::FSRTL_MOD_WRITE_TOP_LEVEL_IRP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSRTL_MOD_WRITE_TOP_LEVEL_IRP&nbsp;&nbsp;&nbsp;0x03          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00284">284</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="fsrtl.h::FSRTL_NTFS_LEGAL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSRTL_NTFS_LEGAL&nbsp;&nbsp;&nbsp;0x04          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00937">937</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="fsrtl.h::FSRTL_NTFS_STREAM_LEGAL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSRTL_NTFS_STREAM_LEGAL&nbsp;&nbsp;&nbsp;(FSRTL_NTFS_LEGAL | FSRTL_OLE_LEGAL)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00940">940</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="fsrtl.h::FSRTL_OLE_LEGAL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSRTL_OLE_LEGAL&nbsp;&nbsp;&nbsp;0x10          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00939">939</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="fsrtl.h::FSRTL_VOLUME_DISMOUNT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSRTL_VOLUME_DISMOUNT&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01421">1421</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d8/fsrtl_2pnp_8c-source.html#l00041">FsRtlNotifyVolumeEvent()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00966">UdfDismountVolume()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="fsrtl.h::FSRTL_VOLUME_DISMOUNT_FAILED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSRTL_VOLUME_DISMOUNT_FAILED&nbsp;&nbsp;&nbsp;2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01422">1422</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d8/fsrtl_2pnp_8c-source.html#l00041">FsRtlNotifyVolumeEvent()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00966">UdfDismountVolume()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="fsrtl.h::FSRTL_VOLUME_LOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSRTL_VOLUME_LOCK&nbsp;&nbsp;&nbsp;3          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01423">1423</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d8/fsrtl_2pnp_8c-source.html#l00041">FsRtlNotifyVolumeEvent()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00780">UdfLockVolume()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a42" doxytag="fsrtl.h::FSRTL_VOLUME_LOCK_FAILED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSRTL_VOLUME_LOCK_FAILED&nbsp;&nbsp;&nbsp;4          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01424">1424</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d8/fsrtl_2pnp_8c-source.html#l00041">FsRtlNotifyVolumeEvent()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00780">UdfLockVolume()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="fsrtl.h::FSRTL_VOLUME_MOUNT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSRTL_VOLUME_MOUNT&nbsp;&nbsp;&nbsp;6          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01426">1426</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d8/fsrtl_2pnp_8c-source.html#l00041">FsRtlNotifyVolumeEvent()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01444">UdfMountVolume()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02043">UdfVerifyVolume()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="fsrtl.h::FSRTL_VOLUME_UNLOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSRTL_VOLUME_UNLOCK&nbsp;&nbsp;&nbsp;5          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01425">1425</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d8/fsrtl_2pnp_8c-source.html#l00041">FsRtlNotifyVolumeEvent()</a>, <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html#l00042">UdfCommonCleanup()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00877">UdfUnlockVolume()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="fsrtl.h::FSRTL_WILD_CHARACTER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSRTL_WILD_CHARACTER&nbsp;&nbsp;&nbsp;0x08          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00938">938</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="fsrtl.h::FsRtlAllocatePoolWithQuotaTag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FsRtlAllocatePoolWithQuotaTag          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PoolType,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>NumberOfBytes,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Tag&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><a class="code" href="../../d5/d8/ex_8h.html#a5">ExAllocatePoolWithQuotaTag</a>((POOL_TYPE)((PoolType) | POOL_RAISE_IF_ALLOCATION_FAILURE), \
                               NumberOfBytes,                                 \
                               Tag)
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01107">1107</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="fsrtl.h::FsRtlAllocatePoolWithTag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FsRtlAllocatePoolWithTag          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PoolType,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>NumberOfBytes,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Tag&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>((POOL_TYPE)((PoolType) | POOL_RAISE_IF_ALLOCATION_FAILURE), \
                          NumberOfBytes,                                      \
                          Tag)
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01101">1101</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d8/pinsup_8c-source.html#l01230">CcAllocateObcb()</a>, <a class="el" href="../../d6/d2/vacbsup_8c-source.html#l01377">CcExtendVacbArray()</a>, <a class="el" href="../../d6/d2/vacbsup_8c-source.html#l00188">CcInitializeVacbs()</a>, <a class="el" href="../../d2/d6/tunnel_8c-source.html#l00913">FsRtlFindInTunnelCache()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l04411">UdfAllocateTable()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01357">UdfCreatePcb()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l03817">UdfDetermineVolumeBounding()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01500">UdfEnumerateIndex()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l03307">UdfFindAnchorVolumeDescriptor()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00726">UdfFindDirEntry()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02558">UdfFindFileSetDescriptor()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02832">UdfFindVolumeDescriptors()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l01083">UdfInitializeCrc16()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01003">UdfInitializeEnumeration()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l00367">UdfInitializePcb()</a>, <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00064">UdfInsertPrefix()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01406">UdfLoadSparingTables()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00916">UdfLookupDirEntryPostProcessing()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00809">UdfNormalizeFileNames()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00883">UdfPrepareBuffers()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l03457">UdfRecognizeVolume()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00235">UdfStoreVolumeDescriptorIfPrevailing()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00360">UdfUpdateDirNames()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">UdfUpdateVcbPhase0()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="fsrtl.h::FsRtlAreThereCurrentFileLocks" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FsRtlAreThereCurrentFileLocks          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">FL&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>( \
    ((FL)-&gt;FastIoIsQuestionable))
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00807">807</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00297">UdfFastUnlockSingle()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00470">UdfOplockRequest()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a47" doxytag="fsrtl.h::FsRtlCompleteRequest" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FsRtlCompleteRequest          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d2/struct__IRP.html">IRP</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>STATUS&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{         \
    (<a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>)-&gt;IoStatus.Status = (STATUS);             \
    <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>( (<a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>), IO_DISK_INCREMENT ); \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01745">1745</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/oplock_8c-source.html#l01678">FsRtlAcknowledgeOplockBreak()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03519">FsRtlCancelExclusiveIrp()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l02555">FsRtlCancelNotify()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00507">FsRtlCompleteLockIrpReal()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l02000">FsRtlNotifyCompleteIrp()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03698">FsRtlNotifyCompletion()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00547">FsRtlNotifyFullChangeDirectory()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01937">FsRtlOpBatchBreakClosePending()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02111">FsRtlOplockBreakNotify()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02454">FsRtlOplockBreakToII()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02690">FsRtlOplockBreakToNone()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02249">FsRtlOplockCleanup()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00581">FsRtlOplockFsctrl()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01173">FsRtlProcessFileLock()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02952">FsRtlRemoveAndCompleteIrp()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01299">FsRtlRequestExclusiveOplock()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01514">FsRtlRequestOplockII()</a>, and <a class="el" href="../../d6/d1/oplock_8c-source.html#l00413">FsRtlUninitializeOplock()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a48" doxytag="fsrtl.h::FsRtlEnterFileSystem" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FsRtlEnterFileSystem          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{ \
    <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();     \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01772">1772</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d0/fastio_8c-source.html#l02555">FsRtlAcquireFileExclusive()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l02402">FsRtlAcquireFileForCcFlush()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l02555">FsRtlCancelNotify()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l00054">FsRtlCopyRead()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l00330">FsRtlCopyWrite()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l01064">FsRtlMdlReadDev()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l01474">FsRtlPrepareMdlWriteDev()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00152">UdfFastLock()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00496">UdfFastQueryBasicInfo()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00740">UdfFastQueryNetworkInfo()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00614">UdfFastQueryStdInfo()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00436">UdfFastUnlockAll()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00557">UdfFastUnlockAllByKey()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00297">UdfFastUnlockSingle()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00218">UdfFsdDispatch()</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00099">UdfFspClose()</a>, and <a class="el" href="../../d1/d7/fspdisp_8c-source.html#l00038">UdfFspDispatch()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a49" doxytag="fsrtl.h::FsRtlExitFileSystem" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FsRtlExitFileSystem          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{ \
    <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();    \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01795">1795</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d6/notify_8c-source.html#l02555">FsRtlCancelNotify()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l00054">FsRtlCopyRead()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l00330">FsRtlCopyWrite()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l01064">FsRtlMdlReadDev()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l01474">FsRtlPrepareMdlWriteDev()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l02628">FsRtlReleaseFile()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l02483">FsRtlReleaseFileForCcFlush()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00152">UdfFastLock()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00496">UdfFastQueryBasicInfo()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00740">UdfFastQueryNetworkInfo()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00614">UdfFastQueryStdInfo()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00436">UdfFastUnlockAll()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00557">UdfFastUnlockAllByKey()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00297">UdfFastUnlockSingle()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00218">UdfFsdDispatch()</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00099">UdfFspClose()</a>, and <a class="el" href="../../d1/d7/fspdisp_8c-source.html#l00038">UdfFspDispatch()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="fsrtl.h::FsRtlFastLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FsRtlFastLock          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">A1,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>A2,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>A3,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>A4,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>A5,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>A6,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>A7,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>A8,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>A9,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>A10,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>A11&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>( \
    <a class="code" href="../../d5/d3/filelock_8c.html#a76">FsRtlPrivateLock</a>( A1,   <span class="comment">/* FileLock            */</span>       \
                      A2,   <span class="comment">/* FileObject          */</span>       \
                      A3,   <span class="comment">/* FileOffset          */</span>       \
                      A4,   <span class="comment">/* Length              */</span>       \
                      A5,   <span class="comment">/* ProcessId           */</span>       \
                      A6,   <span class="comment">/* Key                 */</span>       \
                      A7,   <span class="comment">/* FailImmediately     */</span>       \
                      A8,   <span class="comment">/* ExclusiveLock       */</span>       \
                      A9,   <span class="comment">/* Iosb                */</span>       \
                      NULL, <span class="comment">/* Irp                 */</span>       \
                      A10,  <span class="comment">/* Context             */</span>       \
                      A11   <span class="comment">/* AlreadySynchronized */</span> )     \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00785">785</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00152">UdfFastLock()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="fsrtl.h::FsRtlIsAnsiCharacterLegal" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FsRtlIsAnsiCharacterLegal          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">C,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>FLAGS&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(          \
    <a class="code" href="../../d1/d8/fsrtl_8h.html#a35">FsRtlTestAnsiCharacter</a>((C), TRUE, FALSE, (FLAGS)) \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00988">988</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="fsrtl.h::FsRtlIsAnsiCharacterLegalFat" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FsRtlIsAnsiCharacterLegalFat          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">C,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WILD_OK&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                 \
    <a class="code" href="../../d1/d8/fsrtl_8h.html#a35">FsRtlTestAnsiCharacter</a>((C), TRUE, (WILD_OK), FSRTL_FAT_LEGAL) \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00954">954</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/dbcsname_8c-source.html#l00081">FsRtlIsFatDbcsLegal()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="fsrtl.h::FsRtlIsAnsiCharacterLegalHpfs" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FsRtlIsAnsiCharacterLegalHpfs          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">C,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WILD_OK&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                 \
    <a class="code" href="../../d1/d8/fsrtl_8h.html#a35">FsRtlTestAnsiCharacter</a>((C), TRUE, (WILD_OK), FSRTL_HPFS_LEGAL) \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00962">962</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/dbcsname_8c-source.html#l00345">FsRtlIsHpfsDbcsLegal()</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01208">UdfIsCharacterLegal()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="fsrtl.h::FsRtlIsAnsiCharacterLegalNtfs" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FsRtlIsAnsiCharacterLegalNtfs          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">C,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WILD_OK&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                 \
    <a class="code" href="../../d1/d8/fsrtl_8h.html#a35">FsRtlTestAnsiCharacter</a>((C), TRUE, (WILD_OK), FSRTL_NTFS_LEGAL) \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00970">970</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="fsrtl.h::FsRtlIsAnsiCharacterLegalNtfsStream" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FsRtlIsAnsiCharacterLegalNtfsStream          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">C,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WILD_OK&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                    \
    <a class="code" href="../../d1/d8/fsrtl_8h.html#a35">FsRtlTestAnsiCharacter</a>((C), TRUE, (WILD_OK), FSRTL_NTFS_STREAM_LEGAL)   \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00979">979</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="fsrtl.h::FsRtlIsAnsiCharacterWild" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FsRtlIsAnsiCharacterWild          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">C&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                               \
    <a class="code" href="../../d1/d8/fsrtl_8h.html#a35">FsRtlTestAnsiCharacter</a>((C), FALSE, FALSE, FSRTL_WILD_CHARACTER) \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00946">946</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/dbcsname_8c-source.html#l00694">FsRtlDoesDbcsContainWildCards()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="fsrtl.h::FsRtlIsLeadDbcsCharacter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FsRtlIsLeadDbcsCharacter          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">DBCS_CHAR&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                      \
    (BOOLEAN)((UCHAR)(DBCS_CHAR) &lt; 0x80 ? <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> :                  \
              (<a class="code" href="../../d1/d8/fsrtl_8h.html#a21">NLS_MB_CODE_PAGE_TAG</a> &amp;&amp;                             \
               (<a class="code" href="../../d1/d8/fsrtl_8h.html#a22">NLS_OEM_LEAD_BYTE_INFO</a>[(UCHAR)(DBCS_CHAR)] != 0))) \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01033">1033</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/dbcsname_8c-source.html#l00542">FsRtlDissectDbcs()</a>, <a class="el" href="../../d2/d2/dbcsname_8c-source.html#l00694">FsRtlDoesDbcsContainWildCards()</a>, <a class="el" href="../../d2/d2/dbcsname_8c-source.html#l00771">FsRtlIsDbcsInExpression()</a>, <a class="el" href="../../d2/d2/dbcsname_8c-source.html#l00081">FsRtlIsFatDbcsLegal()</a>, and <a class="el" href="../../d2/d2/dbcsname_8c-source.html#l00345">FsRtlIsHpfsDbcsLegal()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a45" doxytag="fsrtl.h::FsRtlIsUnicodeCharacterWild" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FsRtlIsUnicodeCharacterWild          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">C&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                \
      (((C) &gt;= 0x40) ? <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> : <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( LEGAL_ANSI_CHARACTER_ARRAY[(C)], \
                                       FSRTL_WILD_CHARACTER ) )         \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01538">1538</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/name_8c-source.html#l00229">FsRtlDoesNameContainWildCards()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a46" doxytag="fsrtl.h::FsRtlLookupFilterContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FsRtlLookupFilterContext          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">fo,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>oid,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>iid&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>((     (fo)-&gt;FsContext                                                     \
     &amp;&amp; ( ((<a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a>)(fo)-&gt;FsContext)-&gt;Flags2  &amp;            \
                                <a class="code" href="../../d1/d8/fsrtl_8h.html#a9">FSRTL_FLAG2_SUPPORTS_FILTER_CONTEXTS</a> )      \
     &amp;&amp; !IsListEmpty( (PLIST_ENTRY)                                         \
          &amp;((<a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a>)(fo)-&gt;FsContext)-&gt;FilterContexts )    \
  ) ? <a class="code" href="../../d9/d3/filtrctx_8c.html#a3">FsRtlLookupFilterContextInternal</a>(fo, oid, iid)                        \
    : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01682">1682</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="fsrtl.h::FsRtlSetTopLevelIrpForModWriter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FsRtlSetTopLevelIrpForModWriter          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{            \
    <a class="code" href="../../d0/d5/io_8h.html#a547">IoSetTopLevelIrp</a>((<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>)FSRTL_MOD_WRITE_TOP_LEVEL_IRP); \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00465">465</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04239">MiMappedPageWriter()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="fsrtl.h::FsRtlTestAnsiCharacter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FsRtlTestAnsiCharacter          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">C,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>DEFAULT_RET,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WILD_OK,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>FLAGS&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(            \
        ((SCHAR)(C) &lt; 0) ? DEFAULT_RET :                                    \
                           <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( LEGAL_ANSI_CHARACTER_ARRAY[(C)],         \
                                   (FLAGS) |                                \
                                   ((WILD_OK) ? FSRTL_WILD_CHARACTER : 0) ) \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00997">997</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="fsrtl.h::LEGAL_ANSI_CHARACTER_ARRAY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define <a class="el" href="../../d1/d8/fsrtl_8h.html#a71">LEGAL_ANSI_CHARACTER_ARRAY</a>&nbsp;&nbsp;&nbsp;<a class="el" href="../../d4/d8/fsrtlpc_8c.html#a13">FsRtlLegalAnsiCharacterArray</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00921">921</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="fsrtl.h::NLS_MB_CODE_PAGE_TAG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define NLS_MB_CODE_PAGE_TAG&nbsp;&nbsp;&nbsp;<a class="el" href="../../d9/d6/nlsxlat_8c.html#a26">NlsMbOemCodePageTag</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00922">922</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="fsrtl.h::NLS_OEM_LEAD_BYTE_INFO" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define <a class="el" href="../../d1/d8/fsrtl_8h.html#a72">NLS_OEM_LEAD_BYTE_INFO</a>&nbsp;&nbsp;&nbsp;<a class="el" href="../../d9/d6/nlsxlat_8c.html#a21">NlsOemLeadByteInfo</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00923">923</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a59" doxytag="fsrtl.h::EOF_WAIT_BLOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d9/d3/struct__EOF__WAIT__BLOCK.html">_EOF_WAIT_BLOCK</a>  <a class="el" href="../../d9/d3/struct__EOF__WAIT__BLOCK.html">EOF_WAIT_BLOCK</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a54" doxytag="fsrtl.h::FAST_IO_POSSIBLE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d1/d8/fsrtl_8h.html#a188">_FAST_IO_POSSIBLE</a>  <a class="el" href="../../d1/d8/fsrtl_8h.html#a54">FAST_IO_POSSIBLE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a67" doxytag="fsrtl.h::FILE_LOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">_FILE_LOCK</a>  <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">FILE_LOCK</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l00744">FsRtlInitializeFileLocks()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a63" doxytag="fsrtl.h::FILE_LOCK_INFO" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d1/struct__FILE__LOCK__INFO.html">_FILE_LOCK_INFO</a>  <a class="el" href="../../d8/d1/struct__FILE__LOCK__INFO.html">FILE_LOCK_INFO</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a57" doxytag="fsrtl.h::FSRTL_ADVANCED_FCB_HEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d9/d0/struct__FSRTL__ADVANCED__FCB__HEADER.html">_FSRTL_ADVANCED_FCB_HEADER</a>  <a class="el" href="../../d9/d0/struct__FSRTL__ADVANCED__FCB__HEADER.html">FSRTL_ADVANCED_FCB_HEADER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a61" doxytag="fsrtl.h::FSRTL_AUXILIARY_BUFFER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d1/struct__FSRTL__AUXILIARY__BUFFER.html">_FSRTL_AUXILIARY_BUFFER</a>  <a class="el" href="../../d0/d1/struct__FSRTL__AUXILIARY__BUFFER.html">FSRTL_AUXILIARY_BUFFER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a55" doxytag="fsrtl.h::FSRTL_COMMON_FCB_HEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">_FSRTL_COMMON_FCB_HEADER</a>  <a class="el" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">FSRTL_COMMON_FCB_HEADER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a70" doxytag="fsrtl.h::FSRTL_COMPARISON_RESULT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d1/d8/fsrtl_8h.html#a189">_FSRTL_COMPARISON_RESULT</a>  <a class="el" href="../../d1/d8/fsrtl_8h.html#a70">FSRTL_COMPARISON_RESULT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00557">UdfFindNameLink()</a>, <a class="el" href="../../d6/d4/namesup_8c-source.html#l01274">UdfFullCompareNames()</a>, and <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00660">UdfInsertNameLink()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a84" doxytag="fsrtl.h::FSRTL_FILTER_CONTEXT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">_FSRTL_FILTER_CONTEXT</a>  <a class="el" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">FSRTL_FILTER_CONTEXT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d3/filtrctx_8c-source.html#l00108">FsRtlLookupFilterContextInternal()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a73" doxytag="fsrtl.h::LARGE_MCB" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d9/struct__LARGE__MCB.html">_LARGE_MCB</a>  <a class="el" href="../../d0/d9/struct__LARGE__MCB.html">LARGE_MCB</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a50" doxytag="fsrtl.h::LBN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef ULONG <a class="el" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00029">29</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00977">FsRtlAddLargeMcbEntry()</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l01600">FsRtlLookupLargeMcbEntry()</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l02297">FsRtlRemoveMcbEntryPrivate()</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l02066">FsRtlSplitLargeMcb()</a>, <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00637">UdfAddVmcbMapping()</a>, and <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00867">UdfRemoveVmcbMapping()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a75" doxytag="fsrtl.h::MCB" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d2/d7/struct__MCB.html">_MCB</a>  <a class="el" href="../../d2/d7/struct__MCB.html">MCB</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d8/d1/tmcb_8c-source.html#l00040">main()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a77" doxytag="fsrtl.h::OPLOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef PVOID <a class="el" href="../../d1/d8/fsrtl_8h.html#a77">OPLOCK</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01355">1355</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a82" doxytag="fsrtl.h::PCHECK_FOR_TRAVERSE_ACCESS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef BOOLEAN(* <a class="el" href="../../d1/d8/fsrtl_8h.html#a82">PCHECK_FOR_TRAVERSE_ACCESS</a>)(IN PVOID NotifyContext, IN PVOID TargetContext, IN <a class="el" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectContext)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01446">1446</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a65" doxytag="fsrtl.h::PCOMPLETE_LOCK_IRP_ROUTINE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef NTSTATUS(* <a class="el" href="../../d1/d8/fsrtl_8h.html#a65">PCOMPLETE_LOCK_IRP_ROUTINE</a>)(IN PVOID Context, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00591">591</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l00507">FsRtlCompleteLockIrpReal()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a60" doxytag="fsrtl.h::PEOF_WAIT_BLOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef <a class="el" href="../../d9/d3/struct__EOF__WAIT__BLOCK.html">EOF_WAIT_BLOCK</a>* <a class="el" href="../../d9/d3/struct__EOF__WAIT__BLOCK.html">PEOF_WAIT_BLOCK</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00300">300</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a68" doxytag="fsrtl.h::PFILE_LOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">FILE_LOCK</a>* <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00641">641</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03713">UdfCreateFileLock()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a64" doxytag="fsrtl.h::PFILE_LOCK_INFO" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef <a class="el" href="../../d8/d1/struct__FILE__LOCK__INFO.html">FILE_LOCK_INFO</a>* <a class="el" href="../../d8/d1/struct__FILE__LOCK__INFO.html">PFILE_LOCK_INFO</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00579">579</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a58" doxytag="fsrtl.h::PFSRTL_ADVANCED_FCB_HEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef <a class="el" href="../../d9/d0/struct__FSRTL__ADVANCED__FCB__HEADER.html">FSRTL_ADVANCED_FCB_HEADER</a>* <a class="el" href="../../d9/d0/struct__FSRTL__ADVANCED__FCB__HEADER.html">PFSRTL_ADVANCED_FCB_HEADER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00202">202</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/copysup_8c-source.html#l01075">CcCopyWrite()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a62" doxytag="fsrtl.h::PFSRTL_AUXILIARY_BUFFER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef <a class="el" href="../../d0/d1/struct__FSRTL__AUXILIARY__BUFFER.html">FSRTL_AUXILIARY_BUFFER</a>* <a class="el" href="../../d0/d1/struct__FSRTL__AUXILIARY__BUFFER.html">PFSRTL_AUXILIARY_BUFFER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00442">442</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a56" doxytag="fsrtl.h::PFSRTL_COMMON_FCB_HEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef <a class="el" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">FSRTL_COMMON_FCB_HEADER</a>* <a class="el" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00147">147</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cachesub_8c-source.html#l04411">CcFlushCache()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a85" doxytag="fsrtl.h::PFSRTL_FILTER_CONTEXT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">_FSRTL_FILTER_CONTEXT</a> * <a class="el" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">PFSRTL_FILTER_CONTEXT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d3/filtrctx_8c-source.html#l00058">FsRtlInsertFilterContext()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a83" doxytag="fsrtl.h::PFSRTL_STACK_OVERFLOW_ROUTINE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef VOID(* <a class="el" href="../../d1/d8/fsrtl_8h.html#a83">PFSRTL_STACK_OVERFLOW_ROUTINE</a>)(IN PVOID Context, IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> Event)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01582">1582</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a74" doxytag="fsrtl.h::PLARGE_MCB" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef <a class="el" href="../../d0/d9/struct__LARGE__MCB.html">LARGE_MCB</a>* <a class="el" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01140">1140</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00370">UdfResetVmcb()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a51" doxytag="fsrtl.h::PLBN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef <a class="el" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a>* <a class="el" href="../../d1/d8/fsrtl_8h.html#a51">PLBN</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00030">30</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a76" doxytag="fsrtl.h::PMCB" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef <a class="el" href="../../d2/d7/struct__MCB.html">MCB</a>* <a class="el" href="../../d2/d7/struct__MCB.html">PMCB</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01251">1251</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a81" doxytag="fsrtl.h::PNOTIFY_SYNC" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef PVOID <a class="el" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01443">1443</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d6/notify_8c-source.html#l02555">FsRtlCancelNotify()</a>, and <a class="el" href="../../d3/d6/notify_8c-source.html#l00371">FsRtlNotifyInitializeSync()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a78" doxytag="fsrtl.h::POPLOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef PVOID * <a class="el" href="../../d1/d8/fsrtl_8h.html#a78">POPLOCK</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01355">1355</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a80" doxytag="fsrtl.h::POPLOCK_FS_PREPOST_IRP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef VOID(* <a class="el" href="../../d1/d8/fsrtl_8h.html#a80">POPLOCK_FS_PREPOST_IRP</a>)(IN PVOID Context, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01366">1366</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a79" doxytag="fsrtl.h::POPLOCK_WAIT_COMPLETE_ROUTINE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef VOID(* <a class="el" href="../../d1/d8/fsrtl_8h.html#a79">POPLOCK_WAIT_COMPLETE_ROUTINE</a>)(IN PVOID Context, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01359">1359</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a69" doxytag="fsrtl.h::PTUNNEL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef   * <a class="el" href="../../d1/d8/fsrtl_8h.html#a69">PTUNNEL</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a66" doxytag="fsrtl.h::PUNLOCK_ROUTINE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef VOID(* <a class="el" href="../../d1/d8/fsrtl_8h.html#a66">PUNLOCK_ROUTINE</a>)(IN PVOID Context, IN <a class="el" href="../../d8/d1/struct__FILE__LOCK__INFO.html">PFILE_LOCK_INFO</a> FileLockInfo)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00596">596</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l00829">FsRtlInitializeFileLock()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a53" doxytag="fsrtl.h::PVBN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef <a class="el" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a>* <a class="el" href="../../d1/d8/fsrtl_8h.html#a53">PVBN</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00033">33</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a52" doxytag="fsrtl.h::VBN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef ULONG <a class="el" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00032">32</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00977">FsRtlAddLargeMcbEntry()</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l01528">FsRtlRemoveLargeMcbEntry()</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l02066">FsRtlSplitLargeMcb()</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00743">FsRtlTruncateLargeMcb()</a>, and <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00637">UdfAddVmcbMapping()</a>.    </td>
  </tr>
</table>
<hr><h2>Enumeration Type Documentation</h2>
<a class="anchor" name="a188" doxytag="fsrtl.h::_FAST_IO_POSSIBLE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d1/d8/fsrtl_8h.html#a188">_FAST_IO_POSSIBLE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a188a86" doxytag="FastIoIsNotPossible" ></a>FastIoIsNotPossible</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a188a87" doxytag="FastIoIsPossible" ></a>FastIoIsPossible</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a188a88" doxytag="FastIoIsQuestionable" ></a>FastIoIsQuestionable</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00058">58</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
<pre class="fragment"><div>00058                                {
00059     <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a86">FastIoIsNotPossible</a> = 0,
00060     <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a87">FastIoIsPossible</a>,
00061     <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a88">FastIoIsQuestionable</a>
00062 } <a class="code" href="../../d1/d8/fsrtl_8h.html#a54">FAST_IO_POSSIBLE</a>;
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a189" doxytag="fsrtl.h::_FSRTL_COMPARISON_RESULT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d1/d8/fsrtl_8h.html#a189">_FSRTL_COMPARISON_RESULT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a189a89" doxytag="LessThan" ></a>LessThan</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a189a90" doxytag="EqualTo" ></a>EqualTo</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a189a91" doxytag="GreaterThan" ></a>GreaterThan</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00900">900</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.
<p>
<pre class="fragment"><div>00900                                       {
00901     <a class="code" href="../../d1/d8/fsrtl_8h.html#a189a89">LessThan</a> = -1,
00902     <a class="code" href="../../d1/d8/fsrtl_8h.html#a189a90">EqualTo</a> = 0,
00903     <a class="code" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a> = 1
00904 } <a class="code" href="../../d1/d8/fsrtl_8h.html#a70">FSRTL_COMPARISON_RESULT</a>;
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a107" doxytag="fsrtl.h::FsRtlAcquireFileExclusive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlAcquireFileExclusive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>FileObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/fastio_8c-source.html#l02555">2555</a> of file <a class="el" href="../../d4/d0/fastio_8c-source.html">fastio.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l00953">_FAST_IO_DISPATCH::AcquireFileForNtCreateSection</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01403">_DRIVER_OBJECT::FastIoDispatch</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01772">FsRtlEnterFileSystem</a>, <a class="el" href="../../d4/d2/dumpuser_8c-source.html#l00048">Header</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06862">IoGetBaseFileSystemDeviceObject()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00942">_FAST_IO_DISPATCH::SizeOfFastIoDispatch</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cachesub_8c-source.html#l03880">CcWriteBehind()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l02804">CcZeroEndOfLastPage()</a>, and <a class="el" href="../../d1/d7/creasect_8c-source.html#l00390">MmCreateSection()</a>.
<p>
<pre class="fragment"><div>02561                    :
02562 
02563     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used by <a class="code" href="../../d0/d8/creasect_8c.html#a19">NtCreateSection</a> to pre-acquire <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system
02564     resources in order to avoid deadlocks.  If there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a FastIo entry
02565     <span class="keywordflow">for</span> AcquireFileForNtCreateSection then that routine will be called.
02566     Otherwise, we will simply acquire <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d9/arcinst_8c.html#a19">main</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> resource exclusive.
02567     If there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no <a class="code" href="../../d3/d9/arcinst_8c.html#a19">main</a> resource then we acquire nothing and <span class="keywordflow">return</span>
02568     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.  In <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cases that we acquire a resource, we also set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02569     TopLevelIrp field in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread local storage to indicate to <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
02570     systems beneath us that we have acquired <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system resources.
02571 
02572 Arguments:
02573 
02574     FileObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object being written.
02575 
02576 Return Value:
02577 
02578     NONE
02579 
02580 --*/
02581 
02582 {
02583     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject;
02584     <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> FastIoDispatch;
02585     <a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
02586 
02587     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02588 
02589     <span class="comment">//</span>
02590     <span class="comment">//  First see if we have to call the file system.</span>
02591     <span class="comment">//</span>
02592 
02593     DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a68">IoGetBaseFileSystemDeviceObject</a>( FileObject );
02594 
02595     <span class="keywordflow">if</span> ((FastIoDispatch = DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>) &amp;&amp;
02596         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> &gt;
02597          FIELD_OFFSET( <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a>, AcquireFileForNtCreateSection )) &amp;&amp;
02598         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o11">AcquireFileForNtCreateSection</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02599 
02600         <a class="code" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>();
02601         FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o11">AcquireFileForNtCreateSection</a>( FileObject );
02602 
02603         <span class="keywordflow">return</span>;
02604     }
02605 
02606     <span class="comment">//</span>
02607     <span class="comment">//  If there is a main file resource, acquire that.</span>
02608     <span class="comment">//</span>
02609 
02610     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = (<a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a>)FileObject-&gt;FsContext) &amp;&amp;
02611         (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02612 
02613         <a class="code" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>();
02614         <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource, TRUE );
02615 
02616         <span class="keywordflow">return</span>;
02617     }
02618 
02619     <span class="comment">//</span>
02620     <span class="comment">//  Nothing to acquire.</span>
02621     <span class="comment">//</span>
02622 
02623     <span class="keywordflow">return</span>;
02624 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a105" doxytag="fsrtl.h::FsRtlAcquireFileForCcFlush" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlAcquireFileForCcFlush           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>FileObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/fastio_8c-source.html#l02402">2402</a> of file <a class="el" href="../../d4/d0/fastio_8c-source.html">fastio.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l00968">_FAST_IO_DISPATCH::AcquireForCcFlush</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02480">ExIsResourceAcquiredShared</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01403">_DRIVER_OBJECT::FastIoDispatch</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01772">FsRtlEnterFileSystem</a>, <a class="el" href="../../d4/d2/dumpuser_8c-source.html#l00048">Header</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06862">IoGetBaseFileSystemDeviceObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00942">_FAST_IO_DISPATCH::SizeOfFastIoDispatch</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d4/sectsup_8c-source.html#l02748">MiRemoveUnusedSegments()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00668">MmFlushSection()</a>, and <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00297">MmFlushVirtualMemory()</a>.
<p>
<pre class="fragment"><div>02408                    :
02409 
02410     This routine acquires a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system resource prior to a call to CcFlush.
02411 
02412 Arguments:
02413 
02414     FileObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object being written.
02415 
02416 Return Value:
02417 
02418     None.
02419 
02420 --*/
02421 
02422 {
02423     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject;
02424     <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> FastIoDispatch;
02425     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_DEVICE_REQUEST;
02426 
02427     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02428 
02429     <span class="comment">//</span>
02430     <span class="comment">//  First see if we have to call the file system. Note that in the case</span>
02431     <span class="comment">//  of layered file systems, the layered file system might have the</span>
02432     <span class="comment">//  dispatch routine, but the file system on which it is layered on may</span>
02433     <span class="comment">//  not. In that case, the layered file system will return</span>
02434     <span class="comment">//  STATUS_INVALID_DEVICE_REQUEST.</span>
02435     <span class="comment">//</span>
02436 
02437     DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a68">IoGetBaseFileSystemDeviceObject</a>( FileObject );
02438 
02439     <a class="code" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>();
02440 
02441     <span class="keywordflow">if</span> ((FastIoDispatch = DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>) &amp;&amp;
02442         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> &gt;
02443          FIELD_OFFSET( <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a>, AcquireForCcFlush )) &amp;&amp;
02444         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o26">AcquireForCcFlush</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02445 
02446         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o26">AcquireForCcFlush</a>( FileObject, DeviceObject );
02447 
02448     }
02449 
02450 
02451     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (Status == STATUS_SUCCESS) || (Status == STATUS_INVALID_DEVICE_REQUEST) );
02452 
02453     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INVALID_DEVICE_REQUEST) {
02454 
02455         <a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = FileObject-&gt;FsContext;
02456 
02457         <span class="comment">//</span>
02458         <span class="comment">//  If not already owned get the main resource exclusive because me may</span>
02459         <span class="comment">//  extend ValidDataLength.  Otherwise acquire it one more time recursively.</span>
02460         <span class="comment">//</span>
02461 
02462         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02463             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a75">ExIsResourceAcquiredShared</a>(<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource)) {
02464                 <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource, TRUE );
02465             } <span class="keywordflow">else</span> {
02466                 <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource, TRUE );
02467             }
02468         }
02469 
02470         <span class="comment">//</span>
02471         <span class="comment">//  Also get the paging I/O resource ahead of any MM resources.</span>
02472         <span class="comment">//</span>
02473 
02474         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02475             <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource, TRUE );
02476         }
02477     }
02478 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a103" doxytag="fsrtl.h::FsRtlAcquireFileForModWrite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlAcquireFileForModWrite           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceToRelease</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/fastio_8c-source.html#l02064">2064</a> of file <a class="el" href="../../d4/d0/fastio_8c-source.html">fastio.c</a>.
<p>
References <a class="el" href="../../d3/d8/udfprocs_8h.html#a264a119">AcquireExclusive</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00957">_FAST_IO_DISPATCH::AcquireForModWrite</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l01165">ExAcquireSharedWaitForExclusive()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02477">ExConvertExclusiveToShared</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01403">_DRIVER_OBJECT::FastIoDispatch</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00221">FSRTL_FLAG_ACQUIRE_MAIN_RSRC_EX</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00222">FSRTL_FLAG_ACQUIRE_MAIN_RSRC_SH</a>, <a class="el" href="../../d4/d2/dumpuser_8c-source.html#l00048">Header</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06862">IoGetBaseFileSystemDeviceObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00942">_FAST_IO_DISPATCH::SizeOfFastIoDispatch</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l03198">MiGatherMappedPages()</a>, and <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04239">MiMappedPageWriter()</a>.
<p>
<pre class="fragment"><div>02072                    :
02073 
02074     This routine decides which <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system resource <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> modified page
02075     writer should acquire and acquires <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <span class="keywordflow">if</span> possible.  Wait <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> always
02076     specified as <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.  We pass back <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource Mm has to release
02077     when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> write completes.
02078 
02079 Arguments:
02080 
02081     FileObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object being written.
02082 
02083     EndingOffset - The offset of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last byte being written + 1.
02084 
02085     ByteCount - Length of data in bytes.
02086 
02087     ResourceToRelease - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource to release.  Not defined <span class="keywordflow">if</span>
02088         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
02089 
02090 Return Value:
02091 
02092     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - The resource could not be acquired without waiting.
02093 
02094     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - The returned resource has been acquired.
02095 
02096 --*/
02097 
02098 {
02099     <a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
02100     <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> ResourceAcquired;
02101     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject;
02102     <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> FastIoDispatch;
02103 
02104     BOOLEAN <a class="code" href="../../d3/d8/udfprocs_8h.html#a264a119">AcquireExclusive</a>;
02105 
02106     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02107 
02108     <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = (<a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a>)FileObject-&gt;FsContext;
02109 
02110     <span class="comment">//</span>
02111     <span class="comment">//  First see if we have to call the file system.</span>
02112     <span class="comment">//</span>
02113 
02114     DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a68">IoGetBaseFileSystemDeviceObject</a>( FileObject );
02115 
02116     FastIoDispatch = DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>;
02117     <span class="keywordflow">if</span> ((FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> &gt;
02118          FIELD_OFFSET( <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a>, AcquireForModWrite )) &amp;&amp;
02119         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o15">AcquireForModWrite</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02120 
02121         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02122 
02123         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o15">AcquireForModWrite</a>(FileObject,
02124                                                   EndingOffset,
02125                                                   ResourceToRelease,
02126                                                   DeviceObject);
02127 
02128         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
02129             <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
02130         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_CANT_WAIT) {
02131             <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
02132         } <span class="keywordflow">else</span> {
02133 
02134             <span class="comment">//</span>
02135             <span class="comment">// Fall through. When dealing with layered file systems, it might</span>
02136             <span class="comment">// be the case that the layered file system has the above dispatch</span>
02137             <span class="comment">// routine, but the FS it is layered on top of does not. In that</span>
02138             <span class="comment">// case, the layered file system will return an error code other</span>
02139             <span class="comment">// than STATUS_SUCCESS or STATUS_CANT_WAIT, and we simply handle</span>
02140             <span class="comment">// it as if the file system did not have the dispatch routine to</span>
02141             <span class="comment">// begin with.</span>
02142             <span class="comment">//</span>
02143 
02144             NOTHING;
02145         }
02146     }
02147 
02148     <span class="comment">//</span>
02149     <span class="comment">//  We follow the following rules to determine which resource</span>
02150     <span class="comment">//  to acquire.  We use the flags in the common header.  These</span>
02151     <span class="comment">//  flags can't change once we have acquired any resource.</span>
02152     <span class="comment">//  This means we can do an unsafe test and optimisticly</span>
02153     <span class="comment">//  acquire a resource.  At that point we can test the bits</span>
02154     <span class="comment">//  to see if we have what we want.</span>
02155     <span class="comment">//</span>
02156     <span class="comment">//  0 - If there is no main resource, acquire nothing.</span>
02157     <span class="comment">//</span>
02158     <span class="comment">//  1 - Acquire the main resource exclusively if the</span>
02159     <span class="comment">//      ACQUIRE_MAIN_RSRC_EX flag is set or we are extending</span>
02160     <span class="comment">//      valid data.</span>
02161     <span class="comment">//</span>
02162     <span class="comment">//  2 - Acquire the main resource shared if there is</span>
02163     <span class="comment">//      no paging io resource or the</span>
02164     <span class="comment">//      ACQUIRE_MAIN_RSRC_SH flag is set.</span>
02165     <span class="comment">//</span>
02166     <span class="comment">//  3 - Otherwise acquire the paging io resource shared.</span>
02167     <span class="comment">//</span>
02168 
02169     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02170 
02171         *ResourceToRelease = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02172 
02173         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02174     }
02175 
02176     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Flags, FSRTL_FLAG_ACQUIRE_MAIN_RSRC_EX ) ||
02177         (EndingOffset-&gt;QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.QuadPart &amp;&amp;
02178          <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.QuadPart != <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.QuadPart)) {
02179 
02180         ResourceAcquired = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource;
02181         <a class="code" href="../../d3/d8/udfprocs_8h.html#a264a119">AcquireExclusive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02182 
02183     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Flags, FSRTL_FLAG_ACQUIRE_MAIN_RSRC_SH ) ||
02184                <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02185 
02186         ResourceAcquired = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource;
02187         <a class="code" href="../../d3/d8/udfprocs_8h.html#a264a119">AcquireExclusive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02188 
02189     } <span class="keywordflow">else</span> {
02190 
02191         ResourceAcquired = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource;
02192         <a class="code" href="../../d3/d8/udfprocs_8h.html#a264a119">AcquireExclusive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02193     }
02194 
02195     <span class="comment">//</span>
02196     <span class="comment">//  Perform the following in a loop in case we need to back and</span>
02197     <span class="comment">//  check the state of the resource acquisition.  In most cases</span>
02198     <span class="comment">//  the initial checks will succeed and we can proceed immediately.</span>
02199     <span class="comment">//  We have to worry about the two FsRtl bits changing but</span>
02200     <span class="comment">//  if there is no paging io resource before there won't ever be</span>
02201     <span class="comment">//  one.</span>
02202     <span class="comment">//</span>
02203 
02204     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02205 
02206         <span class="comment">//</span>
02207         <span class="comment">//  Now acquire the desired resource.</span>
02208         <span class="comment">//</span>
02209 
02210         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a264a119">AcquireExclusive</a>) {
02211 
02212             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( ResourceAcquired, FALSE )) {
02213 
02214                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02215             }
02216 
02217         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a271">ExAcquireSharedWaitForExclusive</a>( ResourceAcquired, FALSE )) {
02218 
02219             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02220         }
02221 
02222         <span class="comment">//</span>
02223         <span class="comment">//  If the valid data length is changing or the exclusive bit is</span>
02224         <span class="comment">//  set and we don't have the main resource exclusive then</span>
02225         <span class="comment">//  release the current resource and acquire the main resource</span>
02226         <span class="comment">//  exclusively and move to the top of the loop.</span>
02227         <span class="comment">//</span>
02228 
02229         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Flags, FSRTL_FLAG_ACQUIRE_MAIN_RSRC_EX ) ||
02230             (EndingOffset-&gt;QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.QuadPart &amp;&amp;
02231              <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.QuadPart != <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.QuadPart)) {
02232 
02233             <span class="comment">//</span>
02234             <span class="comment">//  If we don't have the main resource exclusively then</span>
02235             <span class="comment">//  release the current resource and attempt to acquire</span>
02236             <span class="comment">//  the main resource exclusively.</span>
02237             <span class="comment">//</span>
02238 
02239             <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d8/udfprocs_8h.html#a264a119">AcquireExclusive</a>) {
02240 
02241                 <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( ResourceAcquired );
02242                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a264a119">AcquireExclusive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02243                 ResourceAcquired = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource;
02244                 <span class="keywordflow">continue</span>;
02245             }
02246 
02247             <span class="comment">//</span>
02248             <span class="comment">//  We have the correct resource.  Exit the loop.</span>
02249             <span class="comment">//</span>
02250 
02251         <span class="comment">//</span>
02252         <span class="comment">//  If we should be acquiring the main resource shared then move</span>
02253         <span class="comment">//  to acquire the correct resource and proceed to the top of the loop.</span>
02254         <span class="comment">//</span>
02255 
02256         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Flags, FSRTL_FLAG_ACQUIRE_MAIN_RSRC_SH )) {
02257 
02258             <span class="comment">//</span>
02259             <span class="comment">//  If we have the main resource exclusively then downgrade to</span>
02260             <span class="comment">//  shared and exit the loop.</span>
02261             <span class="comment">//</span>
02262 
02263             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a264a119">AcquireExclusive</a>) {
02264 
02265                 <a class="code" href="../../d5/d8/ex_8h.html#a72">ExConvertExclusiveToShared</a>( ResourceAcquired );
02266 
02267             <span class="comment">//</span>
02268             <span class="comment">//  If we have the paging io resource then give up this resource</span>
02269             <span class="comment">//  and acquire the main resource exclusively.  This is going</span>
02270             <span class="comment">//  at it with a large hammer but is guaranteed to be resolved</span>
02271             <span class="comment">//  in the next pass through the loop.</span>
02272             <span class="comment">//</span>
02273 
02274             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ResourceAcquired != <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource) {
02275 
02276                 <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( ResourceAcquired );
02277                 ResourceAcquired = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource;
02278                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a264a119">AcquireExclusive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02279                 <span class="keywordflow">continue</span>;
02280             }
02281 
02282             <span class="comment">//</span>
02283             <span class="comment">//  We have the correct resource.  Exit the loop.</span>
02284             <span class="comment">//</span>
02285 
02286         <span class="comment">//</span>
02287         <span class="comment">//  At this point we should have the paging Io resource shared</span>
02288         <span class="comment">//  if it exists.  If not then acquire it shared and release the</span>
02289         <span class="comment">//  other resource and exit the loop.</span>
02290         <span class="comment">//</span>
02291 
02292         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02293                    &amp;&amp; ResourceAcquired != <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource) {
02294 
02295             ResourceAcquired = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02296 
02297             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d8/ex_8h.html#a271">ExAcquireSharedWaitForExclusive</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource, FALSE )) {
02298 
02299                 ResourceAcquired = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource;
02300             }
02301 
02302             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
02303 
02304             <span class="keywordflow">if</span> (ResourceAcquired == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02305 
02306                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02307             }
02308 
02309             <span class="comment">//</span>
02310             <span class="comment">//  We now have the correct resource.  Exit the loop.</span>
02311             <span class="comment">//</span>
02312 
02313         <span class="comment">//</span>
02314         <span class="comment">//  We should have the main resource shared.  If we don't then</span>
02315         <span class="comment">//  degrade our lock to shared access.</span>
02316         <span class="comment">//</span>
02317 
02318         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a264a119">AcquireExclusive</a>) {
02319 
02320             <a class="code" href="../../d5/d8/ex_8h.html#a72">ExConvertExclusiveToShared</a>( ResourceAcquired );
02321 
02322             <span class="comment">//</span>
02323             <span class="comment">//  We now have the correct resource.  Exit the loop.</span>
02324             <span class="comment">//</span>
02325         }
02326 
02327         <span class="comment">//</span>
02328         <span class="comment">//  We have the correct resource.  Exit the loop.</span>
02329         <span class="comment">//</span>
02330 
02331         <span class="keywordflow">break</span>;
02332     }
02333 
02334     *ResourceToRelease = ResourceAcquired;
02335 
02336     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02337 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a143" doxytag="fsrtl.h::FsRtlAddLargeMcbEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlAddLargeMcbEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Mcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Vbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Lbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SectorCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00977">977</a> of file <a class="el" href="../../d2/d0/largemcb_8c-source.html">largemcb.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00147">ASSERTMSG</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00214">EndingLbn</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00195">EndingVbn</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00158">_NONOPAQUE_MCB::FastMutex</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l02852">FsRtlAddLargeEntry()</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l02748">FsRtlFindLargeIndex()</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l02986">FsRtlRemoveLargeEntry()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00029">LBN</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00162">_NONOPAQUE_MCB::Mapping</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00222">NextStartingLbn</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00199">NextStartingVbn</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00160">_NONOPAQUE_MCB::PairCount</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00164">PNONOPAQUE_MCB</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00206">PreviousEndingLbn</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00187">PreviousEndingVbn</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00210">StartingLbn</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00191">StartingVbn</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02154">try_return</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00149">UNUSED_LBN</a>, and <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00032">VBN</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00375">FsRtlAddMcbEntry()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03388">UdfInitializeAllocations()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01406">UdfLoadSparingTables()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00997">UdfUpdateVcbPhase1()</a>.
<p>
<pre class="fragment"><div>00986                    :
00987 
00988     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to add a <span class="keyword">new</span> mapping of VBNs to LBNs to an existing
00989     Mcb. The information added will map
00990 
00991         Vbn to Lbn,
00992 
00993         Vbn+1 to Lbn+1,...
00994 
00995         Vbn+(SectorCount-1) to Lbn+(SectorCount-1).
00996 
00997     The mapping <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> VBNs must not already exist in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Mcb.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00998     mapping continues a previous run, then <span class="keyword">this</span> routine will actually coalesce
00999     them into 1 run.
01000 
01001     If <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not available to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information <span class="keyword">this</span> routine will raise a
01002     status value indicating insufficient resources.
01003 
01004     An input Lbn value of zero <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> illegal (i.e., the Mcb structure will never
01005     map a Vbn to a zero Lbn value).
01006 
01007 Arguments:
01008 
01009     OpaqueMcb - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Mcb in which to add <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> mapping.
01010 
01011     Vbn - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting Vbn of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> mapping run to add to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Mcb.
01012 
01013     Lbn - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting Lbn of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> mapping run to add to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Mcb.
01014 
01015     SectorCount - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> mapping run (in sectors).
01016 
01017 Return Value:
01018 
01019     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping was added successfully (i.e., the <span class="keyword">new</span>
01020         Vbns did not collide with existing Vbns), and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.  If
01021         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Mcb <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not changed.
01022 
01023 --*/
01024 
01025 {
01026     <a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html">PNONOPAQUE_MCB</a> Mcb = (<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html">PNONOPAQUE_MCB</a>)OpaqueMcb;
01027 
01028     <a class="code" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a> Vbn = ((ULONG)LargeVbn);
01029     <a class="code" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a> Lbn = ((ULONG)LargeLbn);
01030     ULONG SectorCount = ((ULONG)LargeSectorCount);
01031 
01032     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01033 
01034     <a class="code" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a> LastVbn;
01035 
01036     BOOLEAN Result;
01037 
01038     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>(<span class="stringliteral">"LargeInteger not supported yet "</span>, ((PLARGE_INTEGER)&amp;LargeVbn)-&gt;HighPart == 0);
01039     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>(<span class="stringliteral">"LargeInteger not supported yet "</span>, ((PLARGE_INTEGER)&amp;LargeLbn)-&gt;HighPart == 0);
01040     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>(<span class="stringliteral">"LargeInteger not supported yet "</span>, ((PLARGE_INTEGER)&amp;LargeSectorCount)-&gt;HighPart == 0);
01041 
01042     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01043 
01044     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlAddLargeMcbEntry, Mcb = %08lx\n"</span>, Mcb );
01045     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">" Vbn         = %08lx\n"</span>, Vbn );
01046     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">" Lbn         = %08lx\n"</span>, Lbn );
01047     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">" SectorCount = %08lx\n"</span>, SectorCount );
01048 
01049     ExAcquireFastMutex( Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o0">FastMutex</a> );
01050 
01051     <span class="keywordflow">try</span> {
01052 
01053         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/largemcb_8c.html#a25">FsRtlFindLargeIndex</a>(Mcb, Vbn, &amp;Index)) {
01054 
01055             ULONG EndVbn = Vbn + SectorCount - 1;
01056             ULONG EndIndex;
01057 
01058             <span class="comment">//</span>
01059             <span class="comment">//  First check the case where we are adding to an existing mcb run</span>
01060             <span class="comment">//  and if so then we will modify the insertion to complete the run</span>
01061             <span class="comment">//</span>
01062             <span class="comment">//      --ExistingRun--|      ==becomes==&gt;  --ExistingRun--|</span>
01063             <span class="comment">//              |--NewRun--|                               |---|</span>
01064             <span class="comment">//</span>
01065             <span class="comment">//      --ExistingRun----|    ==becomes==&gt; a noop</span>
01066             <span class="comment">//          |--NewRun--|</span>
01067             <span class="comment">//</span>
01068 
01069             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/largemcb_8c.html#a8">StartingLbn</a>(Mcb, Index) != <a class="code" href="../../d1/d1/largemcb_8c.html#a1">UNUSED_LBN</a>) {
01070 
01071                 <span class="comment">//</span>
01072                 <span class="comment">//  Check that the Lbn's line up between the new and existing run</span>
01073                 <span class="comment">//</span>
01074 
01075                 <span class="keywordflow">if</span> (Lbn != (<a class="code" href="../../d1/d1/largemcb_8c.html#a8">StartingLbn</a>(Mcb, Index) + (Vbn - <a class="code" href="../../d1/d1/largemcb_8c.html#a4">StartingVbn</a>(Mcb, Index)))) {
01076 
01077                     <span class="comment">//</span>
01078                     <span class="comment">//  Let our caller know we couldn't insert the run.</span>
01079                     <span class="comment">//</span>
01080 
01081                     <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>(Result = FALSE);
01082                 }
01083 
01084                 <span class="comment">//</span>
01085                 <span class="comment">//  Check if the new run is contained in the existing run</span>
01086                 <span class="comment">//</span>
01087 
01088                 <span class="keywordflow">if</span> (EndVbn &lt;= <a class="code" href="../../d1/d1/largemcb_8c.html#a5">EndingVbn</a>(Mcb, Index)) {
01089 
01090                     <span class="comment">//</span>
01091                     <span class="comment">//  Do nothing because the run is contained within the existing run</span>
01092                     <span class="comment">//</span>
01093 
01094                     <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>(Result = TRUE);
01095                 }
01096 
01097                 <span class="comment">//</span>
01098                 <span class="comment">//  Otherwise we will simply trim off the request for the new run</span>
01099                 <span class="comment">//  to not overlap with the existing run</span>
01100                 <span class="comment">//</span>
01101 
01102                 Vbn = <a class="code" href="../../d1/d1/largemcb_8c.html#a6">NextStartingVbn</a>(Mcb, Index);
01103                 Lbn = <a class="code" href="../../d1/d1/largemcb_8c.html#a9">EndingLbn</a>(Mcb, Index) + 1;
01104 
01105                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(EndVbn &gt;= Vbn);
01106 
01107                 SectorCount = EndVbn - Vbn + 1;
01108 
01109             <span class="comment">//</span>
01110             <span class="comment">//  At this point the new run start in a hole, now check that if</span>
01111             <span class="comment">//  crosses into a non hole and if so then adjust new run to fit</span>
01112             <span class="comment">//  in the hole</span>
01113             <span class="comment">//</span>
01114             <span class="comment">//</span>
01115             <span class="comment">//            |--ExistingRun--  ==becomes==&gt;        |--ExistingRun--</span>
01116             <span class="comment">//      |--NewRun--|                          |--New|</span>
01117             <span class="comment">//</span>
01118 
01119             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/largemcb_8c.html#a25">FsRtlFindLargeIndex</a>(Mcb, EndVbn, &amp;EndIndex) &amp;&amp; (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> == (EndIndex-1))) {
01120 
01121                 <span class="comment">//</span>
01122                 <span class="comment">//  Check that the Lbn's line up in the overlap</span>
01123                 <span class="comment">//</span>
01124 
01125                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/largemcb_8c.html#a8">StartingLbn</a>(Mcb, EndIndex) != Lbn + (<a class="code" href="../../d1/d1/largemcb_8c.html#a4">StartingVbn</a>(Mcb, EndIndex) - Vbn)) {
01126 
01127                     <span class="comment">//</span>
01128                     <span class="comment">//  Let our caller know we couldn't insert the run.</span>
01129                     <span class="comment">//</span>
01130 
01131                     <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>(Result = FALSE);
01132                 }
01133 
01134                 <span class="comment">//</span>
01135                 <span class="comment">//  Truncate the sector count to go up to but not include</span>
01136                 <span class="comment">//  the existing run</span>
01137                 <span class="comment">//</span>
01138 
01139                 SectorCount = <a class="code" href="../../d1/d1/largemcb_8c.html#a4">StartingVbn</a>(Mcb, EndIndex) - Vbn;
01140             }
01141         }
01142 
01143         <span class="comment">//</span>
01144         <span class="comment">//  Find the index for the starting Vbn of our new run, if there isn't</span>
01145         <span class="comment">//  a hole found then index will be set to paircount.</span>
01146         <span class="comment">//</span>
01147 
01148         <span class="keywordflow">if</span> (((<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o2">PairCount</a>) == 0) ||
01149             (<a class="code" href="../../d1/d1/largemcb_8c.html#a3">PreviousEndingVbn</a>(Mcb,Index)+1 &lt;= Vbn) ||
01150             !<a class="code" href="../../d1/d1/largemcb_8c.html#a25">FsRtlFindLargeIndex</a>(Mcb, Vbn, &amp;Index)) {
01151 
01152             <span class="comment">//</span>
01153             <span class="comment">//  We didn't find a mapping, therefore this new mapping must</span>
01154             <span class="comment">//  go on at the end of the current mapping.</span>
01155             <span class="comment">//</span>
01156             <span class="comment">//  See if we can just grow the last mapping in the current mcb.</span>
01157             <span class="comment">//  We can grow the last entry if (1) the Vbns follow on, and (2)</span>
01158             <span class="comment">//  the Lbns follow on.  We can only grow the last mapping if the</span>
01159             <span class="comment">//  index is not 0.</span>
01160             <span class="comment">//</span>
01161 
01162             <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> != 0) &amp;&amp;
01163                 (<a class="code" href="../../d1/d1/largemcb_8c.html#a3">PreviousEndingVbn</a>(Mcb,Index) + 1 == Vbn) &amp;&amp;
01164                 (<a class="code" href="../../d1/d1/largemcb_8c.html#a7">PreviousEndingLbn</a>(Mcb,Index) + 1 == Lbn)) {
01165 
01166                 <span class="comment">//</span>
01167                 <span class="comment">//      --LastRun--|---NewRun--|</span>
01168                 <span class="comment">//</span>
01169 
01170                 <span class="comment">//</span>
01171                 <span class="comment">//  Extend the last run in the mcb</span>
01172                 <span class="comment">//</span>
01173 
01174                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"Continuing last run\n"</span>, 0);
01175 
01176                 (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o2">PairCount</a>-1].NextVbn += SectorCount;
01177 
01178                 <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a> (Result = TRUE);
01179             }
01180 
01181             <span class="comment">//</span>
01182             <span class="comment">//  We couldn't grow the last mapping, now check to see if</span>
01183             <span class="comment">//  this is a continuation of the last Vbn (i.e., there isn't</span>
01184             <span class="comment">//  going to be a hole in the mapping).  Or if this is the first</span>
01185             <span class="comment">//  run in the mapping</span>
01186             <span class="comment">//</span>
01187 
01188             <span class="keywordflow">if</span> ((Vbn == 0) ||
01189                 (<a class="code" href="../../d1/d1/largemcb_8c.html#a3">PreviousEndingVbn</a>(Mcb,Index) + 1 == Vbn)) {
01190 
01191                 <span class="comment">//</span>
01192                 <span class="comment">//      --LastRun--||---NewRun--|</span>
01193                 <span class="comment">//</span>
01194                 <span class="comment">//      0:|--NewRun--|</span>
01195                 <span class="comment">//</span>
01196 
01197                 <span class="comment">//</span>
01198                 <span class="comment">//  We only need to add one more run to the mcb, so make sure</span>
01199                 <span class="comment">//  there is enough room for one.</span>
01200                 <span class="comment">//</span>
01201 
01202                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"Adding new contiguous last run\n"</span>, 0);
01203 
01204                 <a class="code" href="../../d1/d1/largemcb_8c.html#a26">FsRtlAddLargeEntry</a>( Mcb, Index, 1 );
01205 
01206                 <span class="comment">//</span>
01207                 <span class="comment">//  Add the new mapping</span>
01208                 <span class="comment">//</span>
01209 
01210                 (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Lbn = Lbn;
01211                 (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].NextVbn = Vbn + SectorCount;
01212 
01213                 <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a> (Result = TRUE);
01214             }
01215 
01216             <span class="comment">//</span>
01217             <span class="comment">//  If we reach this point then there is going to be a hole in the</span>
01218             <span class="comment">//  mapping. and the mapping gets appended to the end of the current</span>
01219             <span class="comment">//  allocation.  So need to make room for two more runs in the mcb.</span>
01220             <span class="comment">//</span>
01221 
01222             <span class="comment">//</span>
01223             <span class="comment">//      --LastRun--|   hole   |---NewRun--|</span>
01224             <span class="comment">//</span>
01225             <span class="comment">//      0:  hole  |--NewRun--|</span>
01226             <span class="comment">//</span>
01227 
01228             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"Adding new noncontiguous last run\n"</span>, 0);
01229 
01230             <a class="code" href="../../d1/d1/largemcb_8c.html#a26">FsRtlAddLargeEntry</a>( Mcb, Index, 2 );
01231 
01232             <span class="comment">//</span>
01233             <span class="comment">//  Add the hole</span>
01234             <span class="comment">//</span>
01235 
01236             (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Lbn = (<a class="code" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a>)<a class="code" href="../../d1/d1/largemcb_8c.html#a1">UNUSED_LBN</a>;
01237             (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].NextVbn = Vbn;
01238 
01239             <span class="comment">//</span>
01240             <span class="comment">//  Add the new mapping</span>
01241             <span class="comment">//</span>
01242 
01243             (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>+1].Lbn = Lbn;
01244             (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>+1].NextVbn = Vbn + SectorCount;
01245 
01246             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a> (Result = TRUE);
01247         }
01248 
01249         <span class="comment">//</span>
01250         <span class="comment">//  We found an index for the Vbn therefore we must be trying</span>
01251         <span class="comment">//  to fill up a hole in the mcb.  So first we need to check to make</span>
01252         <span class="comment">//  sure there really is a hole to be filled</span>
01253         <span class="comment">//</span>
01254 
01255         LastVbn = Vbn + SectorCount - 1;
01256 
01257         <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d1/largemcb_8c.html#a8">StartingLbn</a>(Mcb,Index) == <a class="code" href="../../d1/d1/largemcb_8c.html#a1">UNUSED_LBN</a>) &amp;&amp;
01258             (<a class="code" href="../../d1/d1/largemcb_8c.html#a4">StartingVbn</a>(Mcb,Index) &lt;= Vbn) &amp;&amp; (LastVbn &lt;= <a class="code" href="../../d1/d1/largemcb_8c.html#a5">EndingVbn</a>(Mcb,Index))) {
01259 
01260             <span class="comment">//</span>
01261             <span class="comment">//  The mapping fits in this hole, but now here are the following</span>
01262             <span class="comment">//  cases we must consider for the new mapping</span>
01263             <span class="comment">//</span>
01264 
01265             <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d1/largemcb_8c.html#a4">StartingVbn</a>(Mcb,Index) &lt; Vbn) &amp;&amp; (LastVbn &lt; <a class="code" href="../../d1/d1/largemcb_8c.html#a5">EndingVbn</a>(Mcb,Index))) {
01266 
01267                 <span class="comment">//  Leaves a hole are both ends</span>
01268                 <span class="comment">//</span>
01269                 <span class="comment">//  --PreviousRun--|  hole  |--NewRun--|  hole  |--FollowingRun--</span>
01270                 <span class="comment">//</span>
01271                 <span class="comment">//  0:  hole  |--NewRun--|  hole  |--FollowingRun--</span>
01272                 <span class="comment">//</span>
01273 
01274                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"Hole at both ends\n"</span>, 0);
01275 
01276                 <span class="comment">//</span>
01277                 <span class="comment">//  Make room for two more entries.  The NextVbn field of the</span>
01278                 <span class="comment">//  one we're shifting remains valid.</span>
01279                 <span class="comment">//</span>
01280 
01281                 <a class="code" href="../../d1/d1/largemcb_8c.html#a26">FsRtlAddLargeEntry</a>( Mcb, Index, 2 );
01282 
01283                 <span class="comment">//</span>
01284                 <span class="comment">//  Add the first hole</span>
01285                 <span class="comment">//</span>
01286 
01287                 (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Lbn = (<a class="code" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a>)<a class="code" href="../../d1/d1/largemcb_8c.html#a1">UNUSED_LBN</a>;
01288                 (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].NextVbn = Vbn;
01289 
01290                 <span class="comment">//</span>
01291                 <span class="comment">//  Add the new mapping</span>
01292                 <span class="comment">//</span>
01293 
01294                 (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>+1].Lbn = Lbn;
01295                 (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>+1].NextVbn = Vbn + SectorCount;
01296 
01297                 <span class="comment">//</span>
01298                 <span class="comment">//  The second hole is already set up by the add entry call, because</span>
01299                 <span class="comment">//  that call just shift over the original hole to that slot</span>
01300                 <span class="comment">//</span>
01301 
01302                 <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a> (Result = TRUE);
01303             }
01304 
01305             <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d1/largemcb_8c.html#a4">StartingVbn</a>(Mcb,Index) == Vbn) &amp;&amp; (LastVbn &lt; <a class="code" href="../../d1/d1/largemcb_8c.html#a5">EndingVbn</a>(Mcb,Index))) {
01306 
01307                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/largemcb_8c.html#a7">PreviousEndingLbn</a>(Mcb,Index) + 1 == Lbn) {
01308 
01309                     <span class="comment">//</span>
01310                     <span class="comment">//  Leaves a hole at the rear, and continues the earlier run</span>
01311                     <span class="comment">//</span>
01312                     <span class="comment">//  --PreviousRun--|--NewRun--|  hole  |--FollowingRun--</span>
01313                     <span class="comment">//</span>
01314 
01315                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"Hole at rear and continue\n"</span>, 0);
01316 
01317                     <span class="comment">//</span>
01318                     <span class="comment">//  We just need to extend the previous run</span>
01319                     <span class="comment">//</span>
01320 
01321                     (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-1].NextVbn += SectorCount;
01322 
01323                     <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a> (Result = TRUE);
01324 
01325                 } <span class="keywordflow">else</span> {
01326 
01327                     <span class="comment">//</span>
01328                     <span class="comment">//  Leaves a hole at the rear, and does not continue the</span>
01329                     <span class="comment">//  earlier run.  As occurs if index is zero.</span>
01330                     <span class="comment">//</span>
01331                     <span class="comment">//  --PreviousRun--||--NewRun--|  hole  |--FollowingRun--</span>
01332                     <span class="comment">//</span>
01333                     <span class="comment">//  0:|--NewRun--|  hole  |--FollowingRun--</span>
01334                     <span class="comment">//</span>
01335 
01336                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"Hole at rear and not continue\n"</span>, 0);
01337 
01338                     <span class="comment">//</span>
01339                     <span class="comment">//  Make room for one more entry.  The NextVbn field of the</span>
01340                     <span class="comment">//  one we're shifting remains valid.</span>
01341                     <span class="comment">//</span>
01342 
01343                     <a class="code" href="../../d1/d1/largemcb_8c.html#a26">FsRtlAddLargeEntry</a>( Mcb, Index, 1 );
01344 
01345                     <span class="comment">//</span>
01346                     <span class="comment">//  Add the new mapping</span>
01347                     <span class="comment">//</span>
01348 
01349                     (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Lbn = Lbn;
01350                     (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].NextVbn = Vbn + SectorCount;
01351 
01352                     <span class="comment">//</span>
01353                     <span class="comment">//  The hole is already set up by the add entry call, because</span>
01354                     <span class="comment">//  that call just shift over the original hole to that slot</span>
01355                     <span class="comment">//</span>
01356 
01357                     <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a> (Result = TRUE);
01358                 }
01359             }
01360 
01361             <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d1/largemcb_8c.html#a4">StartingVbn</a>(Mcb,Index) &lt; Vbn) &amp;&amp; (LastVbn == <a class="code" href="../../d1/d1/largemcb_8c.html#a5">EndingVbn</a>(Mcb,Index))) {
01362 
01363                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/largemcb_8c.html#a10">NextStartingLbn</a>(Mcb,Index) == Lbn + SectorCount) {
01364 
01365                     <span class="comment">//</span>
01366                     <span class="comment">//  Leaves a hole at the front, and continues the following run</span>
01367                     <span class="comment">//</span>
01368                     <span class="comment">//  --PreviousRun--|  hole  |--NewRun--|--FollowingRun--</span>
01369                     <span class="comment">//</span>
01370                     <span class="comment">//  0:  hole  |--NewRun--|--FollowingRun--</span>
01371                     <span class="comment">//</span>
01372 
01373                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"Hole at front and continue\n"</span>, 0);
01374 
01375                     <span class="comment">//</span>
01376                     <span class="comment">//  We just need to extend the following run</span>
01377                     <span class="comment">//</span>
01378 
01379                     (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].NextVbn = Vbn;
01380                     (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>+1].Lbn = Lbn;
01381 
01382                     <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a> (Result = TRUE);
01383 
01384                 } <span class="keywordflow">else</span> {
01385 
01386                     <span class="comment">//</span>
01387                     <span class="comment">//  Leaves a hole at the front, and does not continue the following</span>
01388                     <span class="comment">//  run</span>
01389                     <span class="comment">//</span>
01390                     <span class="comment">//  --PreviousRun--|  hole  |--NewRun--||--FollowingRun--</span>
01391                     <span class="comment">//</span>
01392                     <span class="comment">//  0:  hole  |--NewRun--||--FollowingRun--</span>
01393                     <span class="comment">//</span>
01394 
01395                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"Hole at front and not continue\n"</span>, 0);
01396 
01397                     <span class="comment">//</span>
01398                     <span class="comment">//  Make room for one more entry.  The NextVbn field of the</span>
01399                     <span class="comment">//  one we're shifting remains valid.</span>
01400                     <span class="comment">//</span>
01401 
01402                     <a class="code" href="../../d1/d1/largemcb_8c.html#a26">FsRtlAddLargeEntry</a>( Mcb, Index, 1 );
01403 
01404                     <span class="comment">//</span>
01405                     <span class="comment">//  Add the hole</span>
01406                     <span class="comment">//</span>
01407 
01408                     (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Lbn = (<a class="code" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a>)<a class="code" href="../../d1/d1/largemcb_8c.html#a1">UNUSED_LBN</a>;
01409                     (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].NextVbn = Vbn;
01410 
01411                     <span class="comment">//</span>
01412                     <span class="comment">//  Add the new mapping</span>
01413                     <span class="comment">//</span>
01414 
01415                     (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>+1].Lbn = Lbn;
01416 
01417                     <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a> (Result = TRUE);
01418                 }
01419 
01420             }
01421 
01422             <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d1/largemcb_8c.html#a7">PreviousEndingLbn</a>(Mcb,Index) + 1 == Lbn) &amp;&amp;
01423                 (<a class="code" href="../../d1/d1/largemcb_8c.html#a10">NextStartingLbn</a>(Mcb,Index) == Lbn + SectorCount)) {
01424 
01425                 <span class="comment">//</span>
01426                 <span class="comment">//  Leaves no holes, and continues both runs</span>
01427                 <span class="comment">//</span>
01428                 <span class="comment">//  --PreviousRun--|--NewRun--|--FollowingRun--</span>
01429                 <span class="comment">//</span>
01430 
01431                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"No holes, and continues both runs\n"</span>, 0);
01432 
01433                 <span class="comment">//</span>
01434                 <span class="comment">//  We need to collapse the current index and the following index</span>
01435                 <span class="comment">//  but first we copy the NextVbn of the follwing run into</span>
01436                 <span class="comment">//  the NextVbn field of the previous run to so it all becomes</span>
01437                 <span class="comment">//  one run</span>
01438                 <span class="comment">//</span>
01439 
01440                 (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-1].NextVbn = (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>+1].NextVbn;
01441 
01442                 <a class="code" href="../../d1/d1/largemcb_8c.html#a27">FsRtlRemoveLargeEntry</a>( Mcb, Index, 2 );
01443 
01444                 <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a> (Result = TRUE);
01445             }
01446 
01447             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/largemcb_8c.html#a10">NextStartingLbn</a>(Mcb,Index) == Lbn + SectorCount) {
01448 
01449                 <span class="comment">//</span>
01450                 <span class="comment">//  Leaves no holes, and continues only following run</span>
01451                 <span class="comment">//</span>
01452                 <span class="comment">//  --PreviousRun--||--NewRun--|--FollowingRun--</span>
01453                 <span class="comment">//</span>
01454                 <span class="comment">//  0:|--NewRun--|--FollowingRun--</span>
01455                 <span class="comment">//</span>
01456 
01457                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"No holes, and continues following\n"</span>, 0);
01458 
01459                 <span class="comment">//</span>
01460                 <span class="comment">//  This index is going away so we need to stretch the</span>
01461                 <span class="comment">//  following run to meet up with the previous run</span>
01462                 <span class="comment">//</span>
01463 
01464                 (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>+1].Lbn = Lbn;
01465 
01466                 <a class="code" href="../../d1/d1/largemcb_8c.html#a27">FsRtlRemoveLargeEntry</a>( Mcb, Index, 1 );
01467 
01468                 <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a> (Result = TRUE);
01469             }
01470 
01471             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/largemcb_8c.html#a7">PreviousEndingLbn</a>(Mcb,Index) + 1 == Lbn) {
01472 
01473                 <span class="comment">//</span>
01474                 <span class="comment">//  Leaves no holes, and continues only earlier run</span>
01475                 <span class="comment">//</span>
01476                 <span class="comment">//  --PreviousRun--|--NewRun--||--FollowingRun--</span>
01477                 <span class="comment">//</span>
01478 
01479                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"No holes, and continues earlier\n"</span>, 0);
01480 
01481                 <span class="comment">//</span>
01482                 <span class="comment">//  This index is going away so we need to stretch the</span>
01483                 <span class="comment">//  previous run to meet up with the following run</span>
01484                 <span class="comment">//</span>
01485 
01486                 (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-1].NextVbn = (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].NextVbn;
01487 
01488                 <a class="code" href="../../d1/d1/largemcb_8c.html#a27">FsRtlRemoveLargeEntry</a>( Mcb, Index, 1 );
01489 
01490                 <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a> (Result = TRUE);
01491             }
01492 
01493             <span class="comment">//</span>
01494             <span class="comment">//  Leaves no holes, and continues neither run</span>
01495             <span class="comment">//</span>
01496             <span class="comment">//      --PreviousRun--||--NewRun--||--FollowingRun--</span>
01497             <span class="comment">//</span>
01498             <span class="comment">//      0:|--NewRun--||--FollowingRun--</span>
01499             <span class="comment">//</span>
01500 
01501             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"No holes, and continues none\n"</span>, 0);
01502 
01503             (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Lbn = Lbn;
01504 
01505             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a> (Result = TRUE);
01506         }
01507 
01508         <span class="comment">//</span>
01509         <span class="comment">//  We tried to overwrite an existing mapping so we'll have to</span>
01510         <span class="comment">//  tell our caller that it's not possible</span>
01511         <span class="comment">//</span>
01512 
01513         Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01514 
01515     try_exit: NOTHING;
01516     } finally {
01517 
01518         ExReleaseFastMutex( Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o0">FastMutex</a> );
01519 
01520         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlAddLargeMcbEntry -&gt; %08lx\n"</span>, Result );
01521     }
01522 
01523     <span class="keywordflow">return</span> Result;
01524 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a154" doxytag="fsrtl.h::FsRtlAddMcbEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlAddMcbEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d7/struct__MCB.html">PMCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Mcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SectorCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00375">375</a> of file <a class="el" href="../../d2/d0/largemcb_8c-source.html">largemcb.c</a>.
<p>
References <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00977">FsRtlAddLargeMcbEntry()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00637">UdfAddVmcbMapping()</a>.
<p>
<pre class="fragment"><div>00382 {
00383     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00384 
00385     <span class="keywordflow">return</span> <a class="code" href="../../d1/d8/fsrtl_8h.html#a143">FsRtlAddLargeMcbEntry</a>( (<a class="code" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a>)Mcb,
00386                                   (LONGLONG)(Vbn),
00387                                   (LONGLONG)(Lbn),
00388                                   (LONGLONG)(SectorCount) );
00389 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a127" doxytag="fsrtl.h::FsRtlAddToTunnelCache" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlAddToTunnelCache           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d1/structTUNNEL.html">TUNNEL</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>Cache</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DirectoryKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UNICODE_STRING *&nbsp;</td>
          <td class="mdname" nowrap> <em>ShortName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UNICODE_STRING *&nbsp;</td>
          <td class="mdname" nowrap> <em>LongName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyByShortName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DataLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN VOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Data</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a112" doxytag="fsrtl.h::FsRtlAllocateFileLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FsRtlAllocateFileLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a65">PCOMPLETE_LOCK_IRP_ROUTINE</a> CompleteLockIrpRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a66">PUNLOCK_ROUTINE</a> UnlockRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l01141">1141</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00906">ExAllocateFromPagedLookasideList()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00137">FsRtlFileLockLookasideList</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00829">FsRtlInitializeFileLock()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03713">UdfCreateFileLock()</a>.
<p>
<pre class="fragment"><div>01146 {
01147     <a class="code" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FileLock;
01148 
01149     FileLock = <a class="code" href="../../d5/d8/ex_8h.html#a252">ExAllocateFromPagedLookasideList</a>( &amp;FsRtlFileLockLookasideList );
01150 
01151     <span class="keywordflow">if</span> (FileLock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01152 
01153         <a class="code" href="../../d1/d8/fsrtl_8h.html#a114">FsRtlInitializeFileLock</a>( FileLock,
01154                                  CompleteLockIrpRoutine,
01155                                  UnlockRoutine );
01156     }
01157 
01158     <span class="keywordflow">return</span> FileLock;
01159 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a138" doxytag="fsrtl.h::FsRtlAllocateResource" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> FsRtlAllocateResource           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/fsrtlpc_8c-source.html#l00293">293</a> of file <a class="el" href="../../d5/d7/fsrtlpc_8c-source.html">fsrtlpc.c</a>.
<p>
References <a class="el" href="../../d5/d7/fsrtlpc_8c-source.html#l00057">FSRTL_NUMBER_OF_RESOURCES</a>, <a class="el" href="../../d5/d7/fsrtlpc_8c-source.html#l00059">FsRtlPagingIoResources</a>, <a class="el" href="../../d5/d7/fsrtlpc_8c-source.html#l00061">FsRtlPagingIoResourceSelector</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
<pre class="fragment"><div>00298                    :
00299 
00300     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to allocate a resource from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FsRtl <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
00301 
00302 Arguments:
00303 
00304 Return Value:
00305 
00306     <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> provided resource.
00307 
00308 --*/
00309 
00310 {
00311     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00312 
00313     <span class="keywordflow">return</span> &amp;<a class="code" href="../../d4/d8/fsrtlpc_8c.html#a9">FsRtlPagingIoResources</a>[ <a class="code" href="../../d4/d8/fsrtlpc_8c.html#a10">FsRtlPagingIoResourceSelector</a>++ %
00314                                     <a class="code" href="../../d4/d8/fsrtlpc_8c.html#a3">FSRTL_NUMBER_OF_RESOURCES</a>];
00315 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a178" doxytag="fsrtl.h::FsRtlAreNamesEqual" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlAreNamesEqual           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PCUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ConstantNameA</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PCUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ConstantNameB</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IgnoreCase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCWCH UpcaseTable&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/name_8c-source.html#l00288">288</a> of file <a class="el" href="../../d5/d4/name_8c-source.html">name.c</a>.
<p>
References <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01038">RtlUpcaseUnicodeString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00297                    :
00298 
00299     This routine simple returns whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> two names are exactly equal.
00300     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> two names are known to be constant, <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> much
00301     faster than <a class="code" href="../../d4/d5/name_8c.html#a8">FsRtlIsNameInExpression</a>.
00302 
00303 Arguments:
00304 
00305     ConstantNameA - Constant name.
00306 
00307     ConstantNameB - Constant name.
00308 
00309     IgnoreCase - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Names should be Upcased before comparing.
00310 
00311     UpcaseTable - If supplied, use <span class="keyword">this</span> table <span class="keywordflow">for</span> <span class="keywordflow">case</span> insensitive compares,
00312         otherwise, use <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">default</span> system <a class="code" href="../../d7/d6/nlsboot_8c.html#a0">upcase</a> table.
00313 
00314 Return Value:
00315 
00316     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> two names are lexically equal.
00317 
00318 --*/
00319 
00320 {
00321     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00322     ULONG NameLength;
00323     BOOLEAN FreeStrings = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00324 
00325     UNICODE_STRING LocalNameA;
00326     UNICODE_STRING LocalNameB;
00327 
00328     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00329 
00330     <span class="comment">//</span>
00331     <span class="comment">// If the names aren't even the same size, then return FALSE right away.</span>
00332     <span class="comment">//</span>
00333 
00334     <span class="keywordflow">if</span> ( ConstantNameA-&gt;Length != ConstantNameB-&gt;Length ) {
00335 
00336         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00337     }
00338 
00339     NameLength = ConstantNameA-&gt;Length / <span class="keyword">sizeof</span>(WCHAR);
00340 
00341     <span class="comment">//</span>
00342     <span class="comment">//  If we weren't given an upcase table, we have to upcase the names</span>
00343     <span class="comment">//  ourselves.</span>
00344     <span class="comment">//</span>
00345 
00346     <span class="keywordflow">if</span> ( IgnoreCase &amp;&amp; !ARGUMENT_PRESENT(UpcaseTable) ) {
00347 
00348         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00349 
00350         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a31">RtlUpcaseUnicodeString</a>( &amp;LocalNameA, ConstantNameA, TRUE );
00351 
00352         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00353 
00354             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( Status );
00355         }
00356 
00357         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a31">RtlUpcaseUnicodeString</a>( &amp;LocalNameB, ConstantNameB, TRUE );
00358 
00359         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00360 
00361             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;LocalNameA );
00362 
00363             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( Status );
00364         }
00365 
00366         ConstantNameA = &amp;LocalNameA;
00367         ConstantNameB = &amp;LocalNameB;
00368 
00369         IgnoreCase = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00370         FreeStrings = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00371     }
00372 
00373     <span class="comment">//</span>
00374     <span class="comment">//  Do either case sensitive or insensitive compare.</span>
00375     <span class="comment">//</span>
00376 
00377     <span class="keywordflow">if</span> ( !IgnoreCase ) {
00378 
00379         BOOLEAN BytesEqual;
00380 
00381         BytesEqual = (BOOLEAN) RtlEqualMemory( ConstantNameA-&gt;Buffer,
00382                                                ConstantNameB-&gt;Buffer,
00383                                                ConstantNameA-&gt;Length );
00384 
00385         <span class="keywordflow">if</span> ( FreeStrings ) {
00386 
00387             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;LocalNameA );
00388             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;LocalNameB );
00389         }
00390 
00391         <span class="keywordflow">return</span> BytesEqual;
00392 
00393     } <span class="keywordflow">else</span> {
00394 
00395         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; NameLength; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00396 
00397             <span class="keywordflow">if</span> ( UpcaseTable[ConstantNameA-&gt;Buffer[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]] !=
00398                  UpcaseTable[ConstantNameB-&gt;Buffer[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]] ) {
00399 
00400                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00401             }
00402         }
00403 
00404         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00405     }
00406 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a160" doxytag="fsrtl.h::FsRtlBalanceReads" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI NTSTATUS FsRtlBalanceReads           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>TargetDevice</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/faulttol_8c-source.html#l00031">31</a> of file <a class="el" href="../../d8/d0/faulttol_8c-source.html">faulttol.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01552">IoBuildDeviceIoControlRequest()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>00037                    :
00038 
00039     This routine signals a device driver that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> now OK to start
00040     balancing reads from a mirrored drive.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> typically called
00041     after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system determines that a volume <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> clean.
00042 
00043 Arguments:
00044 
00045     TargetDevice - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device to start balanced read from.
00046 
00047 Return Value:
00048 
00049     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The result of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.  This will be
00050         STATUS_INVALID_DEVICE_REQUEST <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not a mirror.
00051 
00052 --*/
00053 
00054 {
00055     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
00056     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00057     IO_STATUS_BLOCK Iosb;
00058     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00059 
00060     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;Event, NotificationEvent, FALSE );
00061 
00062     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a25">IoBuildDeviceIoControlRequest</a>( FT_BALANCED_READ_MODE,
00063                                          TargetDevice,
00064                                          NULL,
00065                                          0,
00066                                          NULL,
00067                                          0,
00068                                          FALSE,
00069                                          &amp;Event,
00070                                          &amp;Iosb );
00071 
00072     <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00073 
00074         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00075     }
00076 
00077     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( TargetDevice, Irp );
00078 
00079 
00080     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
00081         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;Event,
00082                                         Executive,
00083                                         KernelMode,
00084                                         FALSE,
00085                                         NULL );
00086 
00087         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Status == STATUS_SUCCESS );
00088 
00089         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = Iosb.Status;
00090     }
00091 
00092     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00093 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a117" doxytag="fsrtl.h::FsRtlCheckLockForReadAccess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlCheckLockForReadAccess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileLock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l01315">1315</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00141">_LOCK_QUEUE::ExclusiveLockTree</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l02582">FsRtlFastCheckLockForRead()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07374">IoGetRequestorProcess()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00184">_LOCK_INFO::LockQueue</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00166">_LOCK_INFO::LowestLockOffset</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a30">PLOCK_INFO</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>.
<p>
<pre class="fragment"><div>01322                    :
01323 
01324     This routine checks to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller has read access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01325     range indicated in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> due to <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> locks.  This call does not
01326     complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> uses <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> to get <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock information and read
01327     information.  The <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> must be <span class="keywordflow">for</span> a read operation.
01328 
01329 Arguments:
01330 
01331     FileLock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> to check.
01332 
01333     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> being processed.
01334 
01335 Return Value:
01336 
01337     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> indicated user/request has read access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01338         entire specified byte range, and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
01339 
01340 --*/
01341 
01342 {
01343     BOOLEAN Result;
01344 
01345     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
01346 
01347     <a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>     LockInfo;
01348     LARGE_INTEGER  StartingByte;
01349     LARGE_INTEGER  Length;
01350     ULONG          <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
01351     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>   FileObject;
01352     PVOID          ProcessId;
01353     LARGE_INTEGER  BeyondLastByte;
01354 
01355     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlCheckLockForReadAccess, FileLock = %08lx\n"</span>, FileLock);
01356 
01357     <span class="keywordflow">if</span> ((LockInfo = (<a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>) FileLock-&gt;LockInformation) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01358         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlCheckLockForReadAccess (No current lock info) -&gt; TRUE\n"</span>, 0);
01359         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01360     }
01361 
01362     <span class="comment">//</span>
01363     <span class="comment">//  Do a really fast test to see if there are any exclusive locks to start with</span>
01364     <span class="comment">//</span>
01365 
01366     <span class="keywordflow">if</span> (LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o2">ExclusiveLockTree</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01367         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlCheckLockForReadAccess (No current locks) -&gt; TRUE\n"</span>, 0);
01368         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01369     }
01370 
01371     <span class="comment">//</span>
01372     <span class="comment">//  Get the read offset and compare it to the lowest existing lock.</span>
01373     <span class="comment">//</span>
01374 
01375     IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
01376 
01377     StartingByte  = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Read.ByteOffset;
01378     (ULONGLONG)Length.QuadPart = (ULONGLONG)IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Read.Length;
01379 
01380     (ULONGLONG)BeyondLastByte.QuadPart = (ULONGLONG)StartingByte.QuadPart + Length.LowPart;
01381     <span class="keywordflow">if</span> ( (ULONGLONG)BeyondLastByte.QuadPart &lt;= (ULONGLONG)LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o0">LowestLockOffset</a> ) {
01382         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlCheckLockForReadAccess (Below lowest lock) -&gt; TRUE\n"</span>, 0);
01383         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01384     }
01385 
01386     <span class="comment">//</span>
01387     <span class="comment">//  Get remaining parameters.</span>
01388     <span class="comment">//</span>
01389 
01390     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>           = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Read.Key;
01391     FileObject    = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>;
01392     ProcessId     = <a class="code" href="../../d4/d6/iosubs_8c.html#a78">IoGetRequestorProcess</a>( Irp );
01393 
01394     <span class="comment">//</span>
01395     <span class="comment">//  Call our private work routine to do the real check</span>
01396     <span class="comment">//</span>
01397 
01398     Result = <a class="code" href="../../d1/d8/fsrtl_8h.html#a119">FsRtlFastCheckLockForRead</a>( FileLock,
01399                                         &amp;StartingByte,
01400                                         &amp;Length,
01401                                         Key,
01402                                         FileObject,
01403                                         ProcessId );
01404 
01405     <span class="comment">//</span>
01406     <span class="comment">//  And return to our caller</span>
01407     <span class="comment">//</span>
01408 
01409     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlCheckLockForReadAccess -&gt; %08lx\n"</span>, Result);
01410 
01411     <span class="keywordflow">return</span> Result;
01412 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a118" doxytag="fsrtl.h::FsRtlCheckLockForWriteAccess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlCheckLockForWriteAccess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileLock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l01416">1416</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00141">_LOCK_QUEUE::ExclusiveLockTree</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l02718">FsRtlFastCheckLockForWrite()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07374">IoGetRequestorProcess()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00184">_LOCK_INFO::LockQueue</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00166">_LOCK_INFO::LowestLockOffset</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a30">PLOCK_INFO</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00140">_LOCK_QUEUE::SharedLockTree</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>01423                    :
01424 
01425     This routine checks to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller has write access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01426     indicated range due to <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> locks.  This call does not complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01427     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> uses <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> to get <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock information and write information.
01428     The <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> must be <span class="keywordflow">for</span> a write operation.
01429 
01430 Arguments:
01431 
01432     FileLock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> to check.
01433 
01434     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> being processed.
01435 
01436 Return Value:
01437 
01438     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> indicated user/request has write access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01439         entire specified byte range, and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
01440 
01441 --*/
01442 
01443 {
01444     BOOLEAN Result;
01445 
01446     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
01447 
01448     <a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>      LockInfo;
01449     LARGE_INTEGER   StartingByte;
01450     LARGE_INTEGER   Length;
01451     ULONG           <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
01452     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>    FileObject;
01453     PVOID           ProcessId;
01454     LARGE_INTEGER   BeyondLastByte;
01455 
01456     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlCheckLockForWriteAccess, FileLock = %08lx\n"</span>, FileLock);
01457 
01458     <span class="keywordflow">if</span> ((LockInfo = (<a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>) FileLock-&gt;LockInformation) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01459         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlCheckLockForWriteAccess (No current lock info) -&gt; TRUE\n"</span>, 0);
01460         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01461     }
01462 
01463     <span class="comment">//</span>
01464     <span class="comment">//  Do a really fast test to see if there are any locks to start with</span>
01465     <span class="comment">//</span>
01466 
01467     <span class="keywordflow">if</span> (LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o2">ExclusiveLockTree</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o1">SharedLockTree</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01468         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlCheckLockForWriteAccess (No current locks) -&gt; TRUE\n"</span>, 0);
01469         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01470     }
01471 
01472     <span class="comment">//</span>
01473     <span class="comment">//  Get the write offset and compare it to the lowest existing lock.</span>
01474     <span class="comment">//</span>
01475 
01476     IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
01477 
01478     StartingByte  = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Write.ByteOffset;
01479     (ULONGLONG)Length.QuadPart = (ULONGLONG)IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Write.Length;
01480 
01481     (ULONGLONG)BeyondLastByte.QuadPart = (ULONGLONG)StartingByte.QuadPart + Length.LowPart;
01482     <span class="keywordflow">if</span> ( (ULONGLONG)BeyondLastByte.QuadPart &lt;= (ULONGLONG)LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o0">LowestLockOffset</a> ) {
01483         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlCheckLockForWriteAccess (Below lowest lock) -&gt; TRUE\n"</span>, 0);
01484         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01485     }
01486 
01487     <span class="comment">//</span>
01488     <span class="comment">//  Get remaining parameters.</span>
01489     <span class="comment">//</span>
01490 
01491     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>           = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Write.Key;
01492     FileObject    = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>;
01493     ProcessId     = <a class="code" href="../../d4/d6/iosubs_8c.html#a78">IoGetRequestorProcess</a>( Irp );
01494 
01495     <span class="comment">//</span>
01496     <span class="comment">//  Call our private work routine to do the real work</span>
01497     <span class="comment">//</span>
01498 
01499     Result = <a class="code" href="../../d1/d8/fsrtl_8h.html#a120">FsRtlFastCheckLockForWrite</a>( FileLock,
01500                                          &amp;StartingByte,
01501                                          &amp;Length,
01502                                          Key,
01503                                          FileObject,
01504                                          ProcessId );
01505 
01506     <span class="comment">//</span>
01507     <span class="comment">//  And return to our caller</span>
01508     <span class="comment">//</span>
01509 
01510     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlCheckLockForWriteAccess -&gt; %08lx\n"</span>, Result);
01511 
01512     <span class="keywordflow">return</span> Result;
01513 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a165" doxytag="fsrtl.h::FsRtlCheckOplock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI NTSTATUS FsRtlCheckOplock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a78">POPLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Oplock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a79">POPLOCK_WAIT_COMPLETE_ROUTINE</a> CompletionRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a80">POPLOCK_FS_PREPOST_IRP</a> PostIrpRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00823">823</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
References <a class="el" href="../../d6/d1/oplock_8c-source.html#l00078">BATCH_OPLOCK</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00217">_NONOPAQUE_OPLOCK::FileObject</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00079">FILTER_OPLOCK</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00057">FILTER_OPLOCK_VALID_FLAGS</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02454">FsRtlOplockBreakToII()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02690">FsRtlOplockBreakToNone()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02249">FsRtlOplockCleanup()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00073">IRP_MJ_CLEANUP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00055">IRP_MJ_CREATE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00068">IRP_MJ_FILE_SYSTEM_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00064">IRP_MJ_FLUSH_BUFFERS</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00072">IRP_MJ_LOCK_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00058">IRP_MJ_READ</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00061">IRP_MJ_SET_INFORMATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00059">IRP_MJ_WRITE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01550">IRP_PAGING_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00100">NoOplocksHeld</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00128">OPLOCK_STATE</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00122">OplockIIGranted</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00237">_NONOPAQUE_OPLOCK::OplockState</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html#l00042">UdfCommonCleanup()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00046">UdfCommonLockControl()</a>, <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>, and <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01955">UdfCompleteFcbOpen()</a>.
<p>
<pre class="fragment"><div>00833                    :
00834 
00835     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called as a support routine from a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system.
00836     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to synchronize I/O requests with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current Oplock
00837     state of a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O operation will cause <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Oplock to
00838     <span class="keywordflow">break</span>, that action <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> initiated.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation cannot <span class="keywordflow">continue</span>
00839     until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Oplock <span class="keywordflow">break</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> complete, STATUS_PENDING <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned and
00840     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller supplied routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called.
00841 
00842 Arguments:
00843 
00844     Oplock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-opaque oplock structure <span class="keywordflow">for</span>
00845              <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00846 
00847     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> which declares <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested
00848           operation.
00849 
00850     Context - This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> passed as a parameter to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> completion routine.
00851 
00852     CompletionRoutine - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called <span class="keywordflow">if</span> <span class="keyword">this</span>
00853                         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> must wait <span class="keywordflow">for</span> an Oplock to <span class="keywordflow">break</span>.  This
00854                         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a synchronous operation <span class="keywordflow">if</span> not specified
00855                         and we block in <span class="keyword">this</span> thread waiting on
00856                         an event.
00857 
00858     PostIrpRoutine - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine to call before we put anything
00859                      on our waiting <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> queue.
00860 
00861 Return Value:
00862 
00863     STATUS_SUCCESS <span class="keywordflow">if</span> we can complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation on exiting <span class="keyword">this</span> thread.
00864     STATUS_PENDING <span class="keywordflow">if</span> we <span class="keywordflow">return</span> here but hold <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>.
00865     STATUS_CANCELLED <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> cancelled before we <span class="keywordflow">return</span>.
00866 
00867 --*/
00868 
00869 {
00870     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00871     <a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a> ThisOplock = *Oplock;
00872 
00873     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
00874 
00875     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlCheckOplock:  Entered\n"</span>, 0 );
00876     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Oplock    -&gt; %08lx\n"</span>, Oplock );
00877     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Irp       -&gt; %08lx\n"</span>, Irp );
00878 
00879     <span class="comment">//</span>
00880     <span class="comment">//  If there is no oplock structure or this is system I/O, we allow</span>
00881     <span class="comment">//  the operation to continue.  Otherwise we check the major function code.</span>
00882     <span class="comment">//</span>
00883 
00884     <span class="keywordflow">if</span> ((ThisOplock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00885         !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a>, IRP_PAGING_IO )) {
00886 
00887         <a class="code" href="../../d5/d2/oplock_8c.html#a34">OPLOCK_STATE</a> OplockState;
00888         <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> OplockFileObject;
00889 
00890         BOOLEAN BreakToII;
00891         BOOLEAN BreakToNone;
00892 
00893         ULONG CreateDisposition;
00894 
00895         <span class="comment">//</span>
00896         <span class="comment">//  Capture the file object first and then the oplock state to perform</span>
00897         <span class="comment">//  the unsafe checks below.  We capture the file object first in case</span>
00898         <span class="comment">//  there is an exclusive oplock break in progress.  Otherwise the oplock</span>
00899         <span class="comment">//  state may indicate break in progress but it could complete by</span>
00900         <span class="comment">//  the time we snap the file object.</span>
00901         <span class="comment">//</span>
00902 
00903         OplockFileObject = ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o1">FileObject</a>;
00904         OplockState = ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o4">OplockState</a>;
00905 
00906         <span class="comment">//</span>
00907         <span class="comment">//  Examine the Irp for the appropriate action provided there are</span>
00908         <span class="comment">//  current oplocks on the file.</span>
00909         <span class="comment">//</span>
00910 
00911         <span class="keywordflow">if</span> (OplockState != <a class="code" href="../../d5/d2/oplock_8c.html#a16">NoOplocksHeld</a>) {
00912 
00913             BreakToII = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00914             BreakToNone = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00915 
00916             IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00917 
00918             <span class="comment">//</span>
00919             <span class="comment">//  Determine whether we are going to BreakToII or BreakToNone.</span>
00920             <span class="comment">//</span>
00921 
00922             <span class="keywordflow">switch</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a>) {
00923 
00924             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a13">IRP_MJ_CREATE</a> :
00925 
00926                 <span class="comment">//</span>
00927                 <span class="comment">//  If we are opening for attribute access only, we</span>
00928                 <span class="comment">//  return status success.  Always break the oplock if this caller</span>
00929                 <span class="comment">//  wants a filter oplock.</span>
00930                 <span class="comment">//</span>
00931 
00932                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.SecurityContext-&gt;DesiredAccess,
00933                              ~(FILE_READ_ATTRIBUTES | FILE_WRITE_ATTRIBUTES | SYNCHRONIZE) ) &amp;&amp;
00934                     !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options, FILE_RESERVE_OPFILTER )) {
00935 
00936                     <span class="keywordflow">break</span>;
00937                 }
00938 
00939                 <span class="comment">//</span>
00940                 <span class="comment">//  If there is a filter oplock granted and this create iS reading</span>
00941                 <span class="comment">//  the file then don't break the oplock as long as we share</span>
00942                 <span class="comment">//  for reads.</span>
00943                 <span class="comment">//</span>
00944 
00945                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( OplockState, FILTER_OPLOCK ) &amp;&amp;
00946                     !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.SecurityContext-&gt;DesiredAccess,
00947                              ~FILTER_OPLOCK_VALID_FLAGS ) &amp;&amp;
00948                     <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.ShareAccess, FILE_SHARE_READ )) {
00949 
00950                     <span class="keywordflow">break</span>;
00951                 }
00952 
00953                 <span class="comment">//</span>
00954                 <span class="comment">//  We we are superseding or overwriting, then break to none.</span>
00955                 <span class="comment">//</span>
00956 
00957                 CreateDisposition = (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options &gt;&gt; 24) &amp; 0x000000ff;
00958 
00959                 <span class="keywordflow">if</span> ((CreateDisposition == FILE_SUPERSEDE) ||
00960                     (CreateDisposition == FILE_OVERWRITE) ||
00961                     (CreateDisposition == FILE_OVERWRITE_IF) ||
00962                     <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options, FILE_RESERVE_OPFILTER )) {
00963 
00964                     BreakToNone = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00965 
00966                 } <span class="keywordflow">else</span> {
00967 
00968                     BreakToII = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00969                 }
00970 
00971                 <span class="keywordflow">break</span>;
00972 
00973             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a16">IRP_MJ_READ</a> :
00974 
00975                 <span class="comment">//</span>
00976                 <span class="comment">//  If a filter oplock has been granted then do nothing.</span>
00977                 <span class="comment">//  We will assume the oplock will have been broken</span>
00978                 <span class="comment">//  if this create needed to do that.</span>
00979                 <span class="comment">//</span>
00980 
00981                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( OplockState, FILTER_OPLOCK )) {
00982 
00983                     BreakToII = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00984                 }
00985 
00986                 <span class="keywordflow">break</span>;
00987 
00988             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a22">IRP_MJ_FLUSH_BUFFERS</a> :
00989 
00990                 BreakToII = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00991                 <span class="keywordflow">break</span>;
00992 
00993             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a31">IRP_MJ_CLEANUP</a> :
00994 
00995                 <a class="code" href="../../d5/d2/oplock_8c.html#a45">FsRtlOplockCleanup</a>( (<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>) *Oplock,
00996                                     IrpSp );
00997 
00998                 <span class="keywordflow">break</span>;
00999 
01000             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a30">IRP_MJ_LOCK_CONTROL</a> :
01001 
01002                 <span class="comment">//</span>
01003                 <span class="comment">//  If a filter oplock has been granted then do nothing.</span>
01004                 <span class="comment">//  We will assume the oplock will have been broken</span>
01005                 <span class="comment">//  if this create needed to do that.</span>
01006                 <span class="comment">//</span>
01007 
01008                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( OplockState, FILTER_OPLOCK )) {
01009 
01010                     <span class="keywordflow">break</span>;
01011                 }
01012 
01013             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a17">IRP_MJ_WRITE</a> :
01014 
01015                 BreakToNone = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01016                 <span class="keywordflow">break</span>;
01017 
01018             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a19">IRP_MJ_SET_INFORMATION</a> :
01019 
01020                 <span class="comment">//</span>
01021                 <span class="comment">//  We are only interested in calls that shrink the file size</span>
01022                 <span class="comment">//  or breaking batch oplocks for the rename case.</span>
01023                 <span class="comment">//</span>
01024 
01025                 <span class="keywordflow">switch</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.SetFile.FileInformationClass) {
01026 
01027                 <span class="keywordflow">case</span> FileEndOfFileInformation :
01028 
01029                     <span class="comment">//</span>
01030                     <span class="comment">//  Break immediately if this is the lazy writer callback.</span>
01031                     <span class="comment">//</span>
01032 
01033                     <span class="keywordflow">if</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.SetFile.AdvanceOnly) {
01034 
01035                         <span class="keywordflow">break</span>;
01036                     }
01037 
01038                 <span class="keywordflow">case</span> FileAllocationInformation :
01039 
01040                     BreakToNone = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01041                     <span class="keywordflow">break</span>;
01042 
01043                 <span class="keywordflow">case</span> FileRenameInformation :
01044                 <span class="keywordflow">case</span> FileLinkInformation :
01045 
01046                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( OplockState, BATCH_OPLOCK | FILTER_OPLOCK )) {
01047 
01048                         BreakToNone = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01049                     }
01050 
01051                     <span class="keywordflow">break</span>;
01052                 }
01053 
01054             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a26">IRP_MJ_FILE_SYSTEM_CONTROL</a> :
01055 
01056                 <span class="comment">//</span>
01057                 <span class="comment">//  We need to break to none if this is a zeroing operation.</span>
01058                 <span class="comment">//</span>
01059 
01060                 <span class="keywordflow">if</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.FileSystemControl.FsControlCode == FSCTL_SET_ZERO_DATA) {
01061 
01062                     BreakToNone = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01063                 }
01064             }
01065 
01066             <span class="keywordflow">if</span> (BreakToII) {
01067 
01068                 <span class="comment">//</span>
01069                 <span class="comment">//  If there are no outstanding oplocks or level II oplocks are held,</span>
01070                 <span class="comment">//  we can return immediately.  If the first two tests fail then there</span>
01071                 <span class="comment">//  is an exclusive oplock.  If the file objects match we allow the</span>
01072                 <span class="comment">//  operation to continue.</span>
01073                 <span class="comment">//</span>
01074 
01075                 <span class="keywordflow">if</span> ((OplockState != <a class="code" href="../../d5/d2/oplock_8c.html#a32">OplockIIGranted</a>) &amp;&amp;
01076                     (OplockFileObject != IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>)) {
01077 
01078                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a46">FsRtlOplockBreakToII</a>( (<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>) *Oplock,
01079                                                     IrpSp,
01080                                                     Irp,
01081                                                     Context,
01082                                                     CompletionRoutine,
01083                                                     PostIrpRoutine );
01084                 }
01085 
01086             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (BreakToNone) {
01087 
01088                 <span class="comment">//</span>
01089                 <span class="comment">//  If there are no oplocks, we can return immediately.</span>
01090                 <span class="comment">//  Otherwise if there is no level 2 oplock and this file</span>
01091                 <span class="comment">//  object matches the owning file object then this write is</span>
01092                 <span class="comment">//  on behalf of the owner of the oplock.</span>
01093                 <span class="comment">//</span>
01094 
01095                 <span class="keywordflow">if</span> ((OplockState == <a class="code" href="../../d5/d2/oplock_8c.html#a32">OplockIIGranted</a>) ||
01096                     (OplockFileObject != IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>)) {
01097 
01098                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a47">FsRtlOplockBreakToNone</a>( (<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>) *Oplock,
01099                                                       IrpSp,
01100                                                       Irp,
01101                                                       Context,
01102                                                       CompletionRoutine,
01103                                                       PostIrpRoutine );
01104                 }
01105             }
01106         }
01107     }
01108 
01109     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlCheckOplock:  Exit -&gt; %08lx\n"</span>, Status );
01110 
01111     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01112 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a93" doxytag="fsrtl.h::FsRtlCopyRead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlCopyRead           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>FileOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Wait</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>LockKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/fastio_8c-source.html#l00054">54</a> of file <a class="el" href="../../d4/d0/fastio_8c-source.html">fastio.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d6/d6/copysup_8c-source.html#l00031">CcCopyRead()</a>, <a class="el" href="../../d6/d6/copysup_8c-source.html#l00588">CcFastCopyRead()</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00169">CcFastReadNotPossible</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00166">CcFastReadNoWait</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00168">CcFastReadResourceMiss</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00167">CcFastReadWait</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00221">COMPUTE_PAGES_SPANNED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00056">EXCEPTION_CONTINUE_SEARCH</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00943">_FAST_IO_DISPATCH::FastIoCheckIfPossible</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01403">_DRIVER_OBJECT::FastIoDispatch</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a188a86">FastIoIsNotPossible</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a188a88">FastIoIsQuestionable</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01509">FO_FILE_FAST_IO_READ</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00285">FSRTL_FAST_IO_TOP_LEVEL_IRP</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01772">FsRtlEnterFileSystem</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01795">FsRtlExitFileSystem</a>, <a class="el" href="../../d8/d2/fsrtl_2filter_8c-source.html#l00082">FsRtlIsNtstatusExpected()</a>, <a class="el" href="../../d4/d2/dumpuser_8c-source.html#l00048">Header</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00385">HOT_STATISTIC</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d5/io_8h.html#a320">PFAST_IO_DISPATCH</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/udfinit_8c-source.html#l00183">UdfInitializeGlobalData()</a>.
<p>
<pre class="fragment"><div>00067                    :
00068 
00069     This routine does a fast cached read bypassing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> usual <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system
00070     entry routine (i.e., without the Irp).  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to <span class="keywordflow">do</span> a copy read
00071     of a cached <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.  For a complete description of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> arguments
00072     see <a class="code" href="../../d5/d7/copysup_8c.html#a1">CcCopyRead</a>.
00073 
00074 Arguments:
00075 
00076     FileObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object being read.
00077 
00078     FileOffset - Byte offset in <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <span class="keywordflow">for</span> desired data.
00079 
00080     Length - Length of desired data in bytes.
00081 
00082     Wait - <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> caller may not block, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> otherwise
00083 
00084     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Pointer to output buffer to which data should be copied.
00085 
00086     IoStatus - Pointer to standard I/O status block to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status
00087                <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> transfer.
00088 
00089 Return Value:
00090 
00091     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - <span class="keywordflow">if</span> Wait was supplied as <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data was not delivered, or
00092         <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an I/O error.
00093 
00094     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being delivered
00095 
00096 --*/
00097 
00098 {
00099     <a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
00100     BOOLEAN <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00101     ULONG PageCount = <a class="code" href="../../d2/d1/mm_8h.html#a9">COMPUTE_PAGES_SPANNED</a>( FileOffset-&gt;QuadPart, Length );
00102     LARGE_INTEGER BeyondLastByte;
00103     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> targetVdo;
00104 
00105     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00106 
00107     <span class="comment">//</span>
00108     <span class="comment">//  Special case a read of zero length</span>
00109     <span class="comment">//</span>
00110 
00111     <span class="keywordflow">if</span> (Length != 0) {
00112 
00113         <span class="comment">//</span>
00114         <span class="comment">//  Check for overflow. Returning false here will re-route this request through the</span>
00115         <span class="comment">//  IRP based path, but this isn't performance critical.</span>
00116         <span class="comment">//</span>
00117 
00118         <span class="keywordflow">if</span> (MAXLONGLONG - FileOffset-&gt;QuadPart &lt; (LONGLONG)Length) {
00119 
00120             IoStatus-&gt;Status = STATUS_INVALID_PARAMETER;
00121             IoStatus-&gt;Information = 0;
00122             
00123             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00124         }
00125         
00126         BeyondLastByte.QuadPart = FileOffset-&gt;QuadPart + (LONGLONG)Length;
00127         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = (<a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a>)FileObject-&gt;FsContext;
00128 
00129         <span class="comment">//</span>
00130         <span class="comment">//  Enter the file system</span>
00131         <span class="comment">//</span>
00132 
00133         <a class="code" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>();
00134 
00135         <span class="comment">//</span>
00136         <span class="comment">//  Increment performance counters and get the resource</span>
00137         <span class="comment">//</span>
00138 
00139         <span class="keywordflow">if</span> (Wait) {
00140 
00141             <a class="code" href="../../d0/d9/ntosdef_8h.html#a11">HOT_STATISTIC</a>(CcFastReadWait) += 1;
00142 
00143             <span class="comment">//</span>
00144             <span class="comment">//  Acquired shared on the common fcb header</span>
00145             <span class="comment">//</span>
00146 
00147             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource, TRUE );
00148 
00149         } <span class="keywordflow">else</span> {
00150 
00151             <a class="code" href="../../d0/d9/ntosdef_8h.html#a11">HOT_STATISTIC</a>(CcFastReadNoWait) += 1;
00152 
00153             <span class="comment">//</span>
00154             <span class="comment">//  Acquired shared on the common fcb header, and return if we</span>
00155             <span class="comment">//  don't get it</span>
00156             <span class="comment">//</span>
00157 
00158             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource, FALSE )) {
00159 
00160                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00161 
00162                 <a class="code" href="../../d5/d2/cachedat_8c.html#a46">CcFastReadResourceMiss</a> += 1;
00163 
00164                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00165             }
00166         }
00167 
00168         <span class="comment">//</span>
00169         <span class="comment">//  Now that the File is acquired shared, we can safely test if it</span>
00170         <span class="comment">//  is really cached and if we can do fast i/o and if not, then</span>
00171         <span class="comment">//  release the fcb and return.</span>
00172         <span class="comment">//</span>
00173 
00174         <span class="keywordflow">if</span> ((FileObject-&gt;PrivateCacheMap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00175             (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;IsFastIoPossible == <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a86">FastIoIsNotPossible</a>)) {
00176 
00177             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
00178             <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00179 
00180             <a class="code" href="../../d0/d9/ntosdef_8h.html#a11">HOT_STATISTIC</a>(CcFastReadNotPossible) += 1;
00181 
00182             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00183         }
00184 
00185         <span class="comment">//</span>
00186         <span class="comment">//  Check if fast I/O is questionable and if so then go ask the</span>
00187         <span class="comment">//  file system the answer</span>
00188         <span class="comment">//</span>
00189 
00190         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;IsFastIoPossible == <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a88">FastIoIsQuestionable</a>) {
00191 
00192             <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> FastIoDispatch;
00193 
00194             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!KeIsExecutingDpc());
00195 
00196             targetVdo = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject );
00197             FastIoDispatch = targetVdo-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>;
00198 
00199 
00200             <span class="comment">//</span>
00201             <span class="comment">//  All file systems that set "Is Questionable" had better support</span>
00202             <span class="comment">// fast I/O</span>
00203             <span class="comment">//</span>
00204 
00205             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FastIoDispatch != NULL);
00206             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o1">FastIoCheckIfPossible</a> != NULL);
00207 
00208             <span class="comment">//</span>
00209             <span class="comment">//  Call the file system to check for fast I/O.  If the answer is</span>
00210             <span class="comment">//  anything other than GoForIt then we cannot take the fast I/O</span>
00211             <span class="comment">//  path.</span>
00212             <span class="comment">//</span>
00213 
00214             <span class="keywordflow">if</span> (!FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o1">FastIoCheckIfPossible</a>( FileObject,
00215                                                         FileOffset,
00216                                                         Length,
00217                                                         Wait,
00218                                                         LockKey,
00219                                                         TRUE, <span class="comment">// read operation</span>
00220                                                         IoStatus,
00221                                                         targetVdo )) {
00222 
00223                 <span class="comment">//</span>
00224                 <span class="comment">//  Fast I/O is not possible so release the Fcb and return.</span>
00225                 <span class="comment">//</span>
00226 
00227                 <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
00228                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00229 
00230                 <a class="code" href="../../d0/d9/ntosdef_8h.html#a11">HOT_STATISTIC</a>(CcFastReadNotPossible) += 1;
00231 
00232                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00233             }
00234         }
00235 
00236         <span class="comment">//</span>
00237         <span class="comment">//  Check for read past file size.</span>
00238         <span class="comment">//</span>
00239 
00240         <span class="keywordflow">if</span> ( BeyondLastByte.QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.QuadPart ) {
00241 
00242             <span class="keywordflow">if</span> ( FileOffset-&gt;QuadPart &gt;= <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.QuadPart ) {
00243                 IoStatus-&gt;Status = STATUS_END_OF_FILE;
00244                 IoStatus-&gt;Information = 0;
00245 
00246                 <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
00247                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00248 
00249                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00250             }
00251 
00252             Length = (ULONG)( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.QuadPart - FileOffset-&gt;QuadPart );
00253         }
00254 
00255         <span class="comment">//</span>
00256         <span class="comment">//  We can do fast i/o so call the cc routine to do the work and then</span>
00257         <span class="comment">//  release the fcb when we've done.  If for whatever reason the</span>
00258         <span class="comment">//  copy read fails, then return FALSE to our caller.</span>
00259         <span class="comment">//</span>
00260         <span class="comment">//  Also mark this as the top level "Irp" so that lower file system</span>
00261         <span class="comment">//  levels will not attempt a pop-up</span>
00262         <span class="comment">//</span>
00263 
00264         <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;TopLevelIrp = <a class="code" href="../../d1/d8/fsrtl_8h.html#a14">FSRTL_FAST_IO_TOP_LEVEL_IRP</a>;
00265 
00266         <span class="keywordflow">try</span> {
00267 
00268             <span class="keywordflow">if</span> (Wait &amp;&amp; ((BeyondLastByte.HighPart | <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.HighPart) == 0)) {
00269 
00270                 <a class="code" href="../../d4/d2/cache_8h.html#a75">CcFastCopyRead</a>( FileObject,
00271                                 FileOffset-&gt;LowPart,
00272                                 Length,
00273                                 PageCount,
00274                                 Buffer,
00275                                 IoStatus );
00276 
00277                 FileObject-&gt;Flags |= <a class="code" href="../../d0/d5/io_8h.html#a169">FO_FILE_FAST_IO_READ</a>;
00278 
00279                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (IoStatus-&gt;Status == STATUS_END_OF_FILE) ||
00280                         ((FileOffset-&gt;LowPart + IoStatus-&gt;Information) &lt;= <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.LowPart));
00281 
00282             } <span class="keywordflow">else</span> {
00283 
00284                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d2/cache_8h.html#a74">CcCopyRead</a>( FileObject,
00285                                      FileOffset,
00286                                      Length,
00287                                      Wait,
00288                                      Buffer,
00289                                      IoStatus );
00290 
00291                 FileObject-&gt;Flags |= <a class="code" href="../../d0/d5/io_8h.html#a169">FO_FILE_FAST_IO_READ</a>;
00292 
00293                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !Status || (IoStatus-&gt;Status == STATUS_END_OF_FILE) ||
00294                         ((LONGLONG)(FileOffset-&gt;QuadPart + IoStatus-&gt;Information) &lt;= <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.QuadPart));
00295             }
00296 
00297             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
00298 
00299                 FileObject-&gt;CurrentByteOffset.QuadPart = FileOffset-&gt;QuadPart + IoStatus-&gt;Information;
00300             }
00301 
00302         } except( <a class="code" href="../../d1/d8/fsrtl_8h.html#a137">FsRtlIsNtstatusExpected</a>(GetExceptionCode())
00303                                         ? EXCEPTION_EXECUTE_HANDLER
00304                                         : EXCEPTION_CONTINUE_SEARCH ) {
00305 
00306             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00307         }
00308 
00309         <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;TopLevelIrp = 0;
00310 
00311         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
00312         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00313         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00314 
00315     } <span class="keywordflow">else</span> {
00316 
00317         <span class="comment">//</span>
00318         <span class="comment">//  A zero length transfer was requested.</span>
00319         <span class="comment">//</span>
00320 
00321         IoStatus-&gt;Status = STATUS_SUCCESS;
00322         IoStatus-&gt;Information = 0;
00323 
00324         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00325     }
00326 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a94" doxytag="fsrtl.h::FsRtlCopyWrite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlCopyWrite           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>FileOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Wait</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>LockKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/fastio_8c-source.html#l00330">330</a> of file <a class="el" href="../../d4/d0/fastio_8c-source.html">fastio.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d4/d2/cache_8h.html#a72">CcCanIWrite()</a>, <a class="el" href="../../d6/d6/copysup_8c-source.html#l01075">CcCopyWrite()</a>, <a class="el" href="../../d5/d1/cache_8h-source.html#l00375">CcCopyWriteWontFlush</a>, <a class="el" href="../../d6/d6/copysup_8c-source.html#l01482">CcFastCopyWrite()</a>, <a class="el" href="../../d5/d1/cache_8h-source.html#l00277">CcGetFileSizePointer</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l02952">CcZeroData()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00056">EXCEPTION_CONTINUE_SEARCH</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00943">_FAST_IO_DISPATCH::FastIoCheckIfPossible</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01403">_DRIVER_OBJECT::FastIoDispatch</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a188a86">FastIoIsNotPossible</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a188a88">FastIoIsQuestionable</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01502">FO_FILE_MODIFIED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01503">FO_FILE_SIZE_CHANGED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01494">FO_WRITE_THROUGH</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00285">FSRTL_FAST_IO_TOP_LEVEL_IRP</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01772">FsRtlEnterFileSystem</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01795">FsRtlExitFileSystem</a>, <a class="el" href="../../d8/d2/fsrtl_2filter_8c-source.html#l00082">FsRtlIsNtstatusExpected()</a>, <a class="el" href="../../d4/d2/dumpuser_8c-source.html#l00048">Header</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
<pre class="fragment"><div>00343                    :
00344 
00345     This routine does a fast cached write bypassing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> usual <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system
00346     entry routine (i.e., without the Irp).  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to <span class="keywordflow">do</span> a copy write
00347     of a cached <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.  For a complete description of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> arguments
00348     see <a class="code" href="../../d5/d7/copysup_8c.html#a3">CcCopyWrite</a>.
00349 
00350 Arguments:
00351 
00352     FileObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object being write.
00353 
00354     FileOffset - Byte offset in <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <span class="keywordflow">for</span> desired data.
00355 
00356     Length - Length of desired data in bytes.
00357 
00358     Wait - <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> caller may not block, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> otherwise
00359 
00360     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Pointer to output buffer to which data should be copied.
00361 
00362     IoStatus - Pointer to standard I/O status block to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status
00363                <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> transfer.
00364 
00365 Return Value:
00366 
00367     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - <span class="keywordflow">if</span> Wait was supplied as <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data was not delivered, or
00368         <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an I/O error.
00369 
00370     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being delivered
00371 
00372 --*/
00373 
00374 {
00375     <a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
00376     BOOLEAN AcquiredShared = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00377     BOOLEAN <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00378     BOOLEAN FileSizeChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00379     BOOLEAN WriteToEndOfFile = (BOOLEAN)((FileOffset-&gt;LowPart == FILE_WRITE_TO_END_OF_FILE) &amp;&amp;
00380                                          (FileOffset-&gt;HighPart == -1));
00381 
00382     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00383 
00384     <span class="comment">//</span>
00385     <span class="comment">//  Get a real pointer to the common fcb header</span>
00386     <span class="comment">//</span>
00387 
00388     <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = (<a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a>)FileObject-&gt;FsContext;
00389 
00390     <span class="comment">//</span>
00391     <span class="comment">//  Do we need to verify the volume?  If so, we must go to the file</span>
00392     <span class="comment">//  system.  Also return FALSE if FileObject is write through, the</span>
00393     <span class="comment">//  File System must do that.</span>
00394     <span class="comment">//</span>
00395 
00396     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d2/cache_8h.html#a72">CcCanIWrite</a>( FileObject, Length, Wait, FALSE ) &amp;&amp;
00397         !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>(FileObject-&gt;Flags, FO_WRITE_THROUGH) &amp;&amp;
00398         <a class="code" href="../../d4/d2/cache_8h.html#a4">CcCopyWriteWontFlush</a>(FileObject, FileOffset, Length)) {
00399 
00400         <span class="comment">//</span>
00401         <span class="comment">//  Assume our transfer will work</span>
00402         <span class="comment">//</span>
00403 
00404         IoStatus-&gt;Status = STATUS_SUCCESS;
00405         IoStatus-&gt;Information = Length;
00406 
00407         <span class="comment">//</span>
00408         <span class="comment">//  Special case the zero byte length</span>
00409         <span class="comment">//</span>
00410 
00411         <span class="keywordflow">if</span> (Length != 0) {
00412 
00413             <span class="comment">//</span>
00414             <span class="comment">//  Enter the file system</span>
00415             <span class="comment">//</span>
00416 
00417             <a class="code" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>();
00418 
00419             <span class="comment">//</span>
00420             <span class="comment">//  Split into separate paths for increased performance.  First</span>
00421             <span class="comment">//  we have the faster path which only supports Wait == TRUE and</span>
00422             <span class="comment">//  32 bits.  We will make an unsafe test on whether the fast path</span>
00423             <span class="comment">//  is ok, then just return FALSE later if we were wrong.  This</span>
00424             <span class="comment">//  should virtually never happen.</span>
00425             <span class="comment">//</span>
00426             <span class="comment">//  IMPORTANT NOTE: It is very important that any changes made to</span>
00427             <span class="comment">//                  this path also be applied to the 64-bit path</span>
00428             <span class="comment">//                  which is the else of this test!</span>
00429             <span class="comment">//</span>
00430 
00431             <span class="keywordflow">if</span> (Wait &amp;&amp; (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;AllocationSize.HighPart == 0)) {
00432 
00433                 ULONG <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>, NewFileSize;
00434                 ULONG OldFileSize;
00435                 ULONG OldValidDataLength;
00436                 BOOLEAN Wrapped;
00437 
00438                 <span class="comment">//</span>
00439                 <span class="comment">//  Make our best guess on whether we need the file exclusive</span>
00440                 <span class="comment">//  or shared.  Note that we do not check FileOffset-&gt;HighPart</span>
00441                 <span class="comment">//  until below.</span>
00442                 <span class="comment">//</span>
00443 
00444                 NewFileSize = FileOffset-&gt;LowPart + Length;
00445 
00446                 <span class="keywordflow">if</span> (WriteToEndOfFile || (NewFileSize &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.LowPart)) {
00447 
00448                     <span class="comment">//</span>
00449                     <span class="comment">//  Acquired shared on the common fcb header</span>
00450                     <span class="comment">//</span>
00451 
00452                     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource, TRUE );
00453 
00454                 } <span class="keywordflow">else</span> {
00455 
00456                     <span class="comment">//</span>
00457                     <span class="comment">//  Acquired shared on the common fcb header</span>
00458                     <span class="comment">//</span>
00459 
00460                     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource, TRUE );
00461 
00462                     AcquiredShared = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00463                 }
00464 
00465                 <span class="comment">//</span>
00466                 <span class="comment">//  We have the fcb shared now check if we can do fast i/o</span>
00467                 <span class="comment">//  and if the file space is allocated, and if not then</span>
00468                 <span class="comment">//  release the fcb and return.</span>
00469                 <span class="comment">//</span>
00470 
00471                 <span class="keywordflow">if</span> (WriteToEndOfFile) {
00472 
00473                     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.LowPart;
00474                     NewFileSize = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.LowPart + Length;
00475                     Wrapped = NewFileSize &lt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.LowPart;
00476 
00477                 } <span class="keywordflow">else</span> {
00478 
00479                     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = FileOffset-&gt;LowPart;
00480                     NewFileSize = FileOffset-&gt;LowPart + Length;
00481                     Wrapped = (NewFileSize &lt; FileOffset-&gt;LowPart) || (FileOffset-&gt;HighPart != 0);
00482                 }
00483 
00484                 <span class="comment">//</span>
00485                 <span class="comment">//  Now that the File is acquired shared, we can safely test</span>
00486                 <span class="comment">//  if it is really cached and if we can do fast i/o and we</span>
00487                 <span class="comment">//  do not have to extend. If not then release the fcb and</span>
00488                 <span class="comment">//  return.</span>
00489                 <span class="comment">//</span>
00490                 <span class="comment">//  Get out if we have too much to zero.  This case is not important</span>
00491                 <span class="comment">//  for performance, and a file system supporting sparseness may have</span>
00492                 <span class="comment">//  a way to do this more efficiently.</span>
00493                 <span class="comment">//</span>
00494 
00495                 <span class="keywordflow">if</span> ((FileObject-&gt;PrivateCacheMap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00496                     (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;IsFastIoPossible == <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a86">FastIoIsNotPossible</a>) ||
00497                     (NewFileSize &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;AllocationSize.LowPart) ||
00498                     (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &gt;= (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.LowPart + 0x2000)) ||
00499                     (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;AllocationSize.HighPart != 0) || Wrapped) {
00500 
00501                     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
00502                     <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00503 
00504                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00505                 }
00506 
00507                 <span class="comment">//</span>
00508                 <span class="comment">//  If we will be extending ValidDataLength, we will have to</span>
00509                 <span class="comment">//  get the Fcb exclusive, and make sure that FastIo is still</span>
00510                 <span class="comment">//  possible.  We should only execute this block of code very</span>
00511                 <span class="comment">//  rarely, when the unsafe test for ValidDataLength failed</span>
00512                 <span class="comment">//  above.</span>
00513                 <span class="comment">//</span>
00514 
00515                 <span class="keywordflow">if</span> (AcquiredShared &amp;&amp; (NewFileSize &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.LowPart)) {
00516 
00517                     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
00518 
00519                     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource, TRUE );
00520 
00521                     <span class="comment">//</span>
00522                     <span class="comment">// If writing to end of file, we must recalculate new size.</span>
00523                     <span class="comment">//</span>
00524 
00525                     <span class="keywordflow">if</span> (WriteToEndOfFile) {
00526 
00527                         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.LowPart;
00528                         NewFileSize = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.LowPart + Length;
00529                         Wrapped = NewFileSize &lt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.LowPart;
00530                     }
00531 
00532                     <span class="keywordflow">if</span> ((FileObject-&gt;PrivateCacheMap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00533                         (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;IsFastIoPossible == <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a86">FastIoIsNotPossible</a>) ||
00534                         (NewFileSize &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;AllocationSize.LowPart) ||
00535                         (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;AllocationSize.HighPart != 0) || Wrapped) {
00536 
00537                         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
00538                         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00539 
00540                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00541                     }
00542                 }
00543 
00544                 <span class="comment">//</span>
00545                 <span class="comment">//  Check if fast I/O is questionable and if so then go ask</span>
00546                 <span class="comment">//  the file system the answer</span>
00547                 <span class="comment">//</span>
00548 
00549                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;IsFastIoPossible == <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a88">FastIoIsQuestionable</a>) {
00550 
00551                     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> targetVdo = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject );
00552                     <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> FastIoDispatch = targetVdo-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>;
00553                     IO_STATUS_BLOCK IoStatus;
00554 
00555                     <span class="comment">//</span>
00556                     <span class="comment">//  All file system then set "Is Questionable" had better</span>
00557                     <span class="comment">//  support fast I/O</span>
00558                     <span class="comment">//</span>
00559 
00560                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FastIoDispatch != NULL);
00561                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o1">FastIoCheckIfPossible</a> != NULL);
00562 
00563                     <span class="comment">//</span>
00564                     <span class="comment">//  Call the file system to check for fast I/O.  If the</span>
00565                     <span class="comment">//  answer is anything other than GoForIt then we cannot</span>
00566                     <span class="comment">//  take the fast I/O path.</span>
00567                     <span class="comment">//</span>
00568 
00569                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FILE_WRITE_TO_END_OF_FILE == 0xffffffff);
00570 
00571                     <span class="keywordflow">if</span> (!FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o1">FastIoCheckIfPossible</a>( FileObject,
00572                                                                 FileOffset-&gt;QuadPart != (LONGLONG)-1 ?
00573                                                                   FileOffset : &amp;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize,
00574                                                                 Length,
00575                                                                 TRUE,
00576                                                                 LockKey,
00577                                                                 FALSE, <span class="comment">// write operation</span>
00578                                                                 &amp;IoStatus,
00579                                                                 targetVdo )) {
00580 
00581                         <span class="comment">//</span>
00582                         <span class="comment">//  Fast I/O is not possible so release the Fcb and</span>
00583                         <span class="comment">//  return.</span>
00584                         <span class="comment">//</span>
00585 
00586                         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
00587                         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00588 
00589                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00590                     }
00591                 }
00592 
00593                 <span class="comment">//</span>
00594                 <span class="comment">//  Now see if we will change FileSize.  We have to do it now</span>
00595                 <span class="comment">//  so that our reads are not nooped.</span>
00596                 <span class="comment">//</span>
00597 
00598                 <span class="keywordflow">if</span> (NewFileSize &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.LowPart) {
00599 
00600                     FileSizeChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00601                     OldFileSize = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.LowPart;
00602                     OldValidDataLength = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.LowPart;
00603                     <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.LowPart = NewFileSize;
00604                 }
00605 
00606                 <span class="comment">//</span>
00607                 <span class="comment">//  We can do fast i/o so call the cc routine to do the work</span>
00608                 <span class="comment">//  and then release the fcb when we've done.  If for whatever</span>
00609                 <span class="comment">//  reason the copy write fails, then return FALSE to our</span>
00610                 <span class="comment">//  caller.</span>
00611                 <span class="comment">//</span>
00612                 <span class="comment">//  Also mark this as the top level "Irp" so that lower file</span>
00613                 <span class="comment">//  system levels will not attempt a pop-up</span>
00614                 <span class="comment">//</span>
00615 
00616                 <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;TopLevelIrp = <a class="code" href="../../d1/d8/fsrtl_8h.html#a14">FSRTL_FAST_IO_TOP_LEVEL_IRP</a>;
00617 
00618                 <span class="keywordflow">try</span> {
00619 
00620                     <span class="comment">//</span>
00621                     <span class="comment">//  See if we have to do some zeroing</span>
00622                     <span class="comment">//</span>
00623 
00624                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.LowPart) {
00625 
00626                         LARGE_INTEGER ZeroEnd;
00627 
00628                         ZeroEnd.LowPart = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00629                         ZeroEnd.HighPart = 0;
00630 
00631                         <a class="code" href="../../d4/d2/cache_8h.html#a66">CcZeroData</a>( FileObject,
00632                                     &amp;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength,
00633                                     &amp;ZeroEnd,
00634                                     TRUE );
00635                     }
00636 
00637                     <a class="code" href="../../d4/d2/cache_8h.html#a77">CcFastCopyWrite</a>( FileObject,
00638                                      Offset,
00639                                      Length,
00640                                      Buffer );
00641 
00642                 } except( <a class="code" href="../../d1/d8/fsrtl_8h.html#a137">FsRtlIsNtstatusExpected</a>(GetExceptionCode())
00643                                                 ? EXCEPTION_EXECUTE_HANDLER
00644                                                 : EXCEPTION_CONTINUE_SEARCH ) {
00645 
00646                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00647                 }
00648 
00649                 <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;TopLevelIrp = 0;
00650 
00651                 <span class="comment">//</span>
00652                 <span class="comment">//  If we succeeded, see if we have to update FileSize or</span>
00653                 <span class="comment">//  ValidDataLength.</span>
00654                 <span class="comment">//</span>
00655 
00656                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
00657 
00658                     <span class="comment">//</span>
00659                     <span class="comment">//  In the case of ValidDataLength, we really have to</span>
00660                     <span class="comment">//  check again since we did not do this when we acquired</span>
00661                     <span class="comment">//  the resource exclusive.</span>
00662                     <span class="comment">//</span>
00663 
00664                     <span class="keywordflow">if</span> (NewFileSize &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.LowPart) {
00665 
00666                         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.LowPart = NewFileSize;
00667                     }
00668 
00669                     <span class="comment">//</span>
00670                     <span class="comment">//  Set this handle as having modified the file</span>
00671                     <span class="comment">//</span>
00672 
00673                     FileObject-&gt;Flags |= <a class="code" href="../../d0/d5/io_8h.html#a162">FO_FILE_MODIFIED</a>;
00674 
00675                     <span class="keywordflow">if</span> (FileSizeChanged) {
00676 
00677                         <a class="code" href="../../d4/d2/cache_8h.html#a3">CcGetFileSizePointer</a>(FileObject)-&gt;LowPart = NewFileSize;
00678 
00679                         FileObject-&gt;Flags |= <a class="code" href="../../d0/d5/io_8h.html#a163">FO_FILE_SIZE_CHANGED</a>;
00680                     }
00681 
00682                     <span class="comment">//</span>
00683                     <span class="comment">//  Also update the file position pointer</span>
00684                     <span class="comment">//</span>
00685 
00686                     FileObject-&gt;CurrentByteOffset.LowPart = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> + Length;
00687                     FileObject-&gt;CurrentByteOffset.HighPart = 0;
00688 
00689                 <span class="comment">//</span>
00690                 <span class="comment">//  If we did not succeed, then we must restore the original</span>
00691                 <span class="comment">//  FileSize while holding the PagingIoResource exclusive if</span>
00692                 <span class="comment">//  it exists.</span>
00693                 <span class="comment">//</span>
00694 
00695                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (FileSizeChanged) {
00696 
00697                     <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00698 
00699                         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource, TRUE );
00700                         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.LowPart = OldFileSize;
00701                         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.LowPart = OldValidDataLength;
00702                         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource );
00703 
00704                     } <span class="keywordflow">else</span> {
00705 
00706                         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.LowPart = OldFileSize;
00707                         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.LowPart = OldValidDataLength;
00708                     }
00709                 }
00710 
00711             <span class="comment">//</span>
00712             <span class="comment">//  Here is the 64-bit or no-wait path.</span>
00713             <span class="comment">//</span>
00714 
00715             } <span class="keywordflow">else</span> {
00716 
00717                 LARGE_INTEGER <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>, NewFileSize;
00718                 LARGE_INTEGER OldFileSize;
00719                 LARGE_INTEGER OldValidDataLength;
00720 
00721                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!KeIsExecutingDpc());
00722 
00723                 <span class="comment">//</span>
00724                 <span class="comment">//  Make our best guess on whether we need the file exclusive</span>
00725                 <span class="comment">//  or shared.</span>
00726                 <span class="comment">//</span>
00727 
00728                 NewFileSize.QuadPart = FileOffset-&gt;QuadPart + (LONGLONG)Length;
00729 
00730                 <span class="keywordflow">if</span> (WriteToEndOfFile || (NewFileSize.QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.QuadPart)) {
00731 
00732                     <span class="comment">//</span>
00733                     <span class="comment">//  Acquired shared on the common fcb header, and return</span>
00734                     <span class="comment">//  if we don't get it.</span>
00735                     <span class="comment">//</span>
00736 
00737                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource, Wait )) {
00738 
00739                         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00740 
00741                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00742                     }
00743 
00744                 } <span class="keywordflow">else</span> {
00745 
00746                     <span class="comment">//</span>
00747                     <span class="comment">//  Acquired shared on the common fcb header, and return</span>
00748                     <span class="comment">//  if we don't get it.</span>
00749                     <span class="comment">//</span>
00750 
00751                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource, Wait )) {
00752 
00753                         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00754 
00755                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00756                     }
00757 
00758                     AcquiredShared = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00759                 }
00760 
00761 
00762                 <span class="comment">//</span>
00763                 <span class="comment">//  We have the fcb shared now check if we can do fast i/o</span>
00764                 <span class="comment">//  and if the file space is allocated, and if not then</span>
00765                 <span class="comment">//  release the fcb and return.</span>
00766                 <span class="comment">//</span>
00767 
00768                 <span class="keywordflow">if</span> (WriteToEndOfFile) {
00769 
00770                     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize;
00771                     NewFileSize.QuadPart = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.QuadPart + (LONGLONG)Length;
00772 
00773                 } <span class="keywordflow">else</span> {
00774 
00775                     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = *FileOffset;
00776                     NewFileSize.QuadPart = FileOffset-&gt;QuadPart + (LONGLONG)Length;
00777                 }
00778 
00779                 <span class="comment">//</span>
00780                 <span class="comment">//  Now that the File is acquired shared, we can safely test</span>
00781                 <span class="comment">//  if it is really cached and if we can do fast i/o and we</span>
00782                 <span class="comment">//  do not have to extend. If not then release the fcb and</span>
00783                 <span class="comment">//  return.</span>
00784                 <span class="comment">//</span>
00785                 <span class="comment">//  Get out if we are about to zero too much as well, as commented above.</span>
00786                 <span class="comment">//  Likewise, for NewFileSizes that exceed MAXLONGLONG.</span>
00787                 <span class="comment">//</span>
00788 
00789                 <span class="keywordflow">if</span> ((FileObject-&gt;PrivateCacheMap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00790                     (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;IsFastIoPossible == <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a86">FastIoIsNotPossible</a>) ||
00791                       (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart &gt;= (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.QuadPart + 0x2000)) ||
00792                       (MAXLONGLONG - <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart &lt; (LONGLONG)Length) ||
00793                       (NewFileSize.QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;AllocationSize.QuadPart) ) {
00794 
00795                     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
00796                     <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00797 
00798                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00799                 }
00800 
00801                 <span class="comment">//</span>
00802                 <span class="comment">//  If we will be extending ValidDataLength, we will have to</span>
00803                 <span class="comment">//  get the Fcb exclusive, and make sure that FastIo is still</span>
00804                 <span class="comment">//  possible.  We should only execute this block of code very</span>
00805                 <span class="comment">//  rarely, when the unsafe test for ValidDataLength failed</span>
00806                 <span class="comment">//  above.</span>
00807                 <span class="comment">//</span>
00808 
00809                 <span class="keywordflow">if</span> (AcquiredShared &amp;&amp; ( NewFileSize.QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.QuadPart )) {
00810 
00811                     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
00812 
00813                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource, Wait )) {
00814 
00815                         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00816 
00817                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00818                     }
00819 
00820                     <span class="comment">//</span>
00821                     <span class="comment">// If writing to end of file, we must recalculate new size.</span>
00822                     <span class="comment">//</span>
00823 
00824                     <span class="keywordflow">if</span> (WriteToEndOfFile) {
00825 
00826                         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize;
00827                         NewFileSize.QuadPart = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.QuadPart + (LONGLONG)Length;
00828                     }
00829 
00830                     <span class="keywordflow">if</span> ((FileObject-&gt;PrivateCacheMap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00831                         (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;IsFastIoPossible == <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a86">FastIoIsNotPossible</a>) ||
00832                         ( NewFileSize.QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;AllocationSize.QuadPart ) ) {
00833 
00834                         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
00835                         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00836 
00837                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00838                     }
00839                 }
00840 
00841                 <span class="comment">//</span>
00842                 <span class="comment">//  Check if fast I/O is questionable and if so then go ask</span>
00843                 <span class="comment">//  the file system the answer</span>
00844                 <span class="comment">//</span>
00845 
00846                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;IsFastIoPossible == <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a88">FastIoIsQuestionable</a>) {
00847 
00848                     <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> FastIoDispatch = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject )-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>;
00849                     IO_STATUS_BLOCK IoStatus;
00850 
00851                     <span class="comment">//</span>
00852                     <span class="comment">//  All file system then set "Is Questionable" had better</span>
00853                     <span class="comment">//  support fast I/O</span>
00854                     <span class="comment">//</span>
00855 
00856                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FastIoDispatch != NULL);
00857                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o1">FastIoCheckIfPossible</a> != NULL);
00858 
00859                     <span class="comment">//</span>
00860                     <span class="comment">//  Call the file system to check for fast I/O.  If the</span>
00861                     <span class="comment">//  answer is anything other than GoForIt then we cannot</span>
00862                     <span class="comment">//  take the fast I/O path.</span>
00863                     <span class="comment">//</span>
00864 
00865                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FILE_WRITE_TO_END_OF_FILE == 0xffffffff);
00866 
00867                     <span class="keywordflow">if</span> (!FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o1">FastIoCheckIfPossible</a>( FileObject,
00868                                                                 FileOffset-&gt;QuadPart != (LONGLONG)-1 ?
00869                                                                   FileOffset : &amp;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize,
00870                                                                 Length,
00871                                                                 Wait,
00872                                                                 LockKey,
00873                                                                 FALSE, <span class="comment">// write operation</span>
00874                                                                 &amp;IoStatus,
00875                                                                 DeviceObject )) {
00876 
00877                         <span class="comment">//</span>
00878                         <span class="comment">//  Fast I/O is not possible so release the Fcb and</span>
00879                         <span class="comment">//  return.</span>
00880                         <span class="comment">//</span>
00881 
00882                         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
00883                         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00884 
00885                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00886                     }
00887                 }
00888 
00889                 <span class="comment">//</span>
00890                 <span class="comment">//  Now see if we will change FileSize.  We have to do it now</span>
00891                 <span class="comment">//  so that our reads are not nooped.</span>
00892                 <span class="comment">//</span>
00893 
00894                 <span class="keywordflow">if</span> ( NewFileSize.QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.QuadPart ) {
00895 
00896                     FileSizeChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00897                     OldFileSize = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize;
00898                     OldValidDataLength = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength;
00899 
00900                     <span class="comment">//</span>
00901                     <span class="comment">//  Deal with an extremely rare pathalogical case here the</span>
00902                     <span class="comment">//  file size wraps.</span>
00903                     <span class="comment">//</span>
00904 
00905                     <span class="keywordflow">if</span> ( (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.HighPart != NewFileSize.HighPart) &amp;&amp;
00906                          (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
00907 
00908                         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource, TRUE );
00909                         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize = NewFileSize;
00910                         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource );
00911 
00912                     } <span class="keywordflow">else</span> {
00913 
00914                         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize = NewFileSize;
00915                     }
00916                 }
00917 
00918                 <span class="comment">//</span>
00919                 <span class="comment">//  We can do fast i/o so call the cc routine to do the work</span>
00920                 <span class="comment">//  and then release the fcb when we've done.  If for whatever</span>
00921                 <span class="comment">//  reason the copy write fails, then return FALSE to our</span>
00922                 <span class="comment">//  caller.</span>
00923                 <span class="comment">//</span>
00924                 <span class="comment">//  Also mark this as the top level "Irp" so that lower file</span>
00925                 <span class="comment">//  system levels will not attempt a pop-up</span>
00926                 <span class="comment">//</span>
00927 
00928                 <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;TopLevelIrp = <a class="code" href="../../d1/d8/fsrtl_8h.html#a14">FSRTL_FAST_IO_TOP_LEVEL_IRP</a>;
00929 
00930                 <span class="keywordflow">try</span> {
00931 
00932                     <span class="comment">//</span>
00933                     <span class="comment">//  See if we have to do some zeroing</span>
00934                     <span class="comment">//</span>
00935 
00936                     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.QuadPart ) {
00937 
00938                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d2/cache_8h.html#a66">CcZeroData</a>( FileObject,
00939                                              &amp;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength,
00940                                              &amp;Offset,
00941                                              Wait );
00942                     }
00943 
00944                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
00945 
00946                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d2/cache_8h.html#a76">CcCopyWrite</a>( FileObject,
00947                                               &amp;Offset,
00948                                               Length,
00949                                               Wait,
00950                                               Buffer );
00951                     }
00952 
00953                 } except( <a class="code" href="../../d1/d8/fsrtl_8h.html#a137">FsRtlIsNtstatusExpected</a>(GetExceptionCode())
00954                                                 ? EXCEPTION_EXECUTE_HANDLER
00955                                                 : EXCEPTION_CONTINUE_SEARCH ) {
00956 
00957                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00958                 }
00959 
00960                 <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;TopLevelIrp = 0;
00961 
00962                 <span class="comment">//</span>
00963                 <span class="comment">//  If we succeeded, see if we have to update FileSize or</span>
00964                 <span class="comment">//  ValidDataLength.</span>
00965                 <span class="comment">//</span>
00966 
00967                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
00968 
00969                     <span class="comment">//</span>
00970                     <span class="comment">//  In the case of ValidDataLength, we really have to</span>
00971                     <span class="comment">//  check again since we did not do this when we acquired</span>
00972                     <span class="comment">//  the resource exclusive.</span>
00973                     <span class="comment">//</span>
00974 
00975                     <span class="keywordflow">if</span> ( NewFileSize.QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.QuadPart ) {
00976 
00977                         <span class="comment">//</span>
00978                         <span class="comment">//  Deal with an extremely rare pathalogical case here</span>
00979                         <span class="comment">//  the ValidDataLength wraps.</span>
00980                         <span class="comment">//</span>
00981 
00982                         <span class="keywordflow">if</span> ( (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.HighPart != NewFileSize.HighPart) &amp;&amp;
00983                              (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
00984 
00985                             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource, TRUE );
00986                             <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength = NewFileSize;
00987                             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource );
00988 
00989                         } <span class="keywordflow">else</span> {
00990 
00991                             <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength = NewFileSize;
00992                         }
00993                     }
00994 
00995                     <span class="comment">//</span>
00996                     <span class="comment">//  Set this handle as having modified the file</span>
00997                     <span class="comment">//</span>
00998 
00999                     FileObject-&gt;Flags |= <a class="code" href="../../d0/d5/io_8h.html#a162">FO_FILE_MODIFIED</a>;
01000 
01001                     <span class="keywordflow">if</span> (FileSizeChanged) {
01002 
01003                         *<a class="code" href="../../d4/d2/cache_8h.html#a3">CcGetFileSizePointer</a>(FileObject) = NewFileSize;
01004 
01005                         FileObject-&gt;Flags |= <a class="code" href="../../d0/d5/io_8h.html#a163">FO_FILE_SIZE_CHANGED</a>;
01006                     }
01007 
01008                     <span class="comment">//</span>
01009                     <span class="comment">//  Also update the current file position pointer</span>
01010                     <span class="comment">//</span>
01011 
01012                     FileObject-&gt;CurrentByteOffset.QuadPart = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart + Length;
01013 
01014                 <span class="comment">//</span>
01015                 <span class="comment">// If we did not succeed, then we must restore the original</span>
01016                 <span class="comment">// FileSize while holding the PagingIoResource exclusive if</span>
01017                 <span class="comment">// it exists.</span>
01018                 <span class="comment">//</span>
01019 
01020                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (FileSizeChanged) {
01021 
01022                     <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01023 
01024                         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource, TRUE );
01025                         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize = OldFileSize;
01026                         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength = OldValidDataLength;
01027                         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource );
01028 
01029                     } <span class="keywordflow">else</span> {
01030 
01031                         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize = OldFileSize;
01032                         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength = OldValidDataLength;
01033                     }
01034                 }
01035 
01036             }
01037 
01038             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
01039             <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
01040 
01041             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01042 
01043         } <span class="keywordflow">else</span> {
01044 
01045             <span class="comment">//</span>
01046             <span class="comment">//  A zero length transfer was requested.</span>
01047             <span class="comment">//</span>
01048 
01049             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01050         }
01051 
01052     } <span class="keywordflow">else</span> {
01053 
01054         <span class="comment">//</span>
01055         <span class="comment">// The volume must be verified or the file is write through.</span>
01056         <span class="comment">//</span>
01057 
01058         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01059     }
01060 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a167" doxytag="fsrtl.h::FsRtlCurrentBatchOplock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlCurrentBatchOplock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a78">POPLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Oplock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l01169">1169</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
References <a class="el" href="../../d6/d1/oplock_8c-source.html#l00078">BATCH_OPLOCK</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00079">FILTER_OPLOCK</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01955">UdfCompleteFcbOpen()</a>.
<p>
<pre class="fragment"><div>01175                    :
01176 
01177     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> indicates whether there are current outstanding
01178     batch oplocks.
01179 
01180 Arguments:
01181 
01182     OpLock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> oplock being queried
01183 
01184 Return Value:
01185 
01186     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> there are outstanding batch oplocks and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
01187 
01188 --*/
01189 
01190 {
01191     BOOLEAN BatchOplocks = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01192 
01193     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01194 
01195     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlCurrentBatchOplock: Oplock -&gt; %08lx\n"</span>, *Oplock);
01196 
01197     <span class="comment">//</span>
01198     <span class="comment">//  There are not any current oplocks if the variable is null or</span>
01199     <span class="comment">//  the state is no oplocks held.  We check whether there are batch</span>
01200     <span class="comment">//  oplocks or filter oplocks which have not been broken.</span>
01201     <span class="comment">//</span>
01202 
01203     <span class="keywordflow">if</span> ((*Oplock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01204         <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ((<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>) *Oplock)-&gt;OplockState,
01205                 BATCH_OPLOCK | FILTER_OPLOCK )) {
01206 
01207         BatchOplocks = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01208     }
01209 
01210     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlCurrentBatchOplock: Exit -&gt; %08lx\n"</span>, BatchOplocks);
01211 
01212     <span class="keywordflow">return</span> BatchOplocks;
01213 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a129" doxytag="fsrtl.h::FsRtlDeleteKeyFromTunnelCache" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlDeleteKeyFromTunnelCache           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d1/structTUNNEL.html">TUNNEL</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>Cache</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DirectoryKey</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a130" doxytag="fsrtl.h::FsRtlDeleteTunnelCache" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlDeleteTunnelCache           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d1/structTUNNEL.html">TUNNEL</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Cache</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a183" doxytag="fsrtl.h::FsRtlDeregisterUncProvider" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlDeregisterUncProvider           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Handle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/unc_8c-source.html#l00418">418</a> of file <a class="el" href="../../d6/d8/unc_8c-source.html">unc.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00099">FsRtlpRedirs</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00231">FsRtlpSetSymbolicLink()</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00094">FsRtlpUncSemaphore</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
<pre class="fragment"><div>00424                    :
00425 
00426     This routine deregisters a redir as a UNC provider.
00427 
00428 Arguments:
00429 
00430     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Multiple UNC router, returned by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00431         registration call.
00432 
00433 Return Value:
00434 
00435     None.
00436 
00437 --*/
00438 
00439 {
00440     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00441 
00442     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00443 
00444     <span class="keywordflow">if</span>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> == (HANDLE)-1 || <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
00445         <span class="keywordflow">return</span>;
00446 
00447     status = ZwClose( Handle );
00448 
00449     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) ) {
00450         <span class="keywordflow">return</span>;
00451     }
00452 
00453     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;FsRtlpUncSemaphore, Executive, KernelMode, FALSE, NULL );
00454 
00455     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FsRtlpRedirs &gt; 0 );
00456 
00457     <span class="keywordflow">if</span>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> == <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.ReturnedHandle ) {
00458 
00459         <span class="comment">//</span>
00460         <span class="comment">// The first redir in the system is closing.  Release the state we saved</span>
00461         <span class="comment">//  for it, and pass the close on to the MUP if necessary</span>
00462         <span class="comment">//</span>
00463 
00464         <span class="keywordflow">if</span>( <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00465             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.Buffer );
00466             <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00467         }
00468 
00469         <span class="keywordflow">if</span>( <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.MupHandle != (HANDLE)-1 ) {
00470             ZwClose( <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.MupHandle );
00471             <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.MupHandle = (HANDLE)-1;
00472         }
00473 
00474         <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.ReturnedHandle = (HANDLE)-1;
00475 
00476     }
00477 
00478     <span class="keywordflow">if</span>( --<a class="code" href="../../d5/d9/unc_8c.html#a12">FsRtlpRedirs</a> == 0 ) {
00479         <a class="code" href="../../d5/d9/unc_8c.html#a15">FsRtlpSetSymbolicLink</a>( (PUNICODE_STRING)NULL );
00480     }
00481 
00482     <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(&amp;FsRtlpUncSemaphore, 0, 1, FALSE );
00483 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a131" doxytag="fsrtl.h::FsRtlDissectDbcs" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlDissectDbcs           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ANSI_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>InputName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PANSI_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>FirstPart</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PANSI_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>RemainingPart</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/dbcsname_8c-source.html#l00542">542</a> of file <a class="el" href="../../d2/d2/dbcsname_8c-source.html">dbcsname.c</a>.
<p>
References <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01033">FsRtlIsLeadDbcsCharacter</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/dbcsname_8c-source.html#l00081">FsRtlIsFatDbcsLegal()</a>, and <a class="el" href="../../d2/d2/dbcsname_8c-source.html#l00345">FsRtlIsHpfsDbcsLegal()</a>.
<p>
<pre class="fragment"><div>00550                    :
00551 
00552     This routine takes an input Dbcs string and dissects <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> into two
00553     substrings.  The first output string contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name that appears at
00554     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> beginning of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input string, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second output string contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00555     remainder of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input string.
00556 
00557     In <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input string backslashes are used to separate names.  The input
00558     string must not start with a backslash.  Both output strings will not
00559     begin with a backslash.
00560 
00561     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input string does not contain any names then both output strings
00562     are empty.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input string contains <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> one name then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first
00563     output string contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second string <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> empty.
00564 
00565     Note that both output strings use <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same string buffer memory of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00566     input string.
00567 
00568     Example of its results are:
00569 
00570 <span class="comment">//. .     InputString    FirstPart    RemainingPart</span>
00571 <span class="comment">//</span>
00572 <span class="comment">//. .     empty          empty        empty</span>
00573 <span class="comment">//</span>
00574 <span class="comment">//. .     A              A            empty</span>
00575 <span class="comment">//</span>
00576 <span class="comment">//. .     A\B\C\D\E      A            B\C\D\E</span>
00577 <span class="comment">//</span>
00578 <span class="comment">//. .     *A?            *A?          empty</span>
00579 <span class="comment">//</span>
00580 <span class="comment">//. .     \A             A            empty</span>
00581 <span class="comment">//</span>
00582 <span class="comment">//. .     A[,]           A[,]         empty</span>
00583 <span class="comment">//</span>
00584 <span class="comment">//. .     A\\B+;\C       A            \B+;\C</span>
00585 
00586 Arguments:
00587 
00588     InputName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input string being dissected
00589 
00590     Is8dot3 - Indicates <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input name must be 8.3
00591         or can be <span class="keywordtype">long</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> name.
00592 
00593     FirstPart - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first name in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input string
00594 
00595     RemainingPart - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remaining part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input string
00596 
00597 Return Value:
00598 
00599     NONE
00600 
00601 --*/
00602 
00603 {
00604     ULONG i = 0;
00605     ULONG PathLength;
00606     ULONG FirstNameStart;
00607 
00608     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00609 
00610     <span class="comment">//</span>
00611     <span class="comment">//  Make both output strings empty for now</span>
00612     <span class="comment">//</span>
00613 
00614     FirstName-&gt;Length = 0;
00615     FirstName-&gt;MaximumLength = 0;
00616     FirstName-&gt;Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00617 
00618     RemainingName-&gt;Length = 0;
00619     RemainingName-&gt;MaximumLength = 0;
00620     RemainingName-&gt;Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00621 
00622     PathLength = Path.Length;
00623 
00624     <span class="comment">//</span>
00625     <span class="comment">//  Check for an empty input string</span>
00626     <span class="comment">//</span>
00627 
00628     <span class="keywordflow">if</span> (PathLength == 0) {
00629 
00630         <span class="keywordflow">return</span>;
00631     }
00632 
00633     <span class="comment">//</span>
00634     <span class="comment">//  Skip over a starting backslash, and make sure there is more.</span>
00635     <span class="comment">//</span>
00636 
00637     <span class="keywordflow">if</span> ( Path.Buffer[0] == <span class="charliteral">'\\'</span> ) {
00638 
00639         i = 1;
00640     }
00641 
00642     <span class="comment">//</span>
00643     <span class="comment">//  Now run down the input string until we hit a backslash or the end</span>
00644     <span class="comment">//  of the string, remembering where we started;</span>
00645     <span class="comment">//</span>
00646 
00647     <span class="keywordflow">for</span> ( FirstNameStart = i;
00648           (i &lt; PathLength) &amp;&amp; (Path.Buffer[i] != <span class="charliteral">'\\'</span>);
00649           i += 1 ) {
00650 
00651         <span class="comment">//</span>
00652         <span class="comment">//  If this is the first byte of a Dbcs character, skip over the</span>
00653         <span class="comment">//  next byte as well.</span>
00654         <span class="comment">//</span>
00655 
00656         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d8/fsrtl_8h.html#a36">FsRtlIsLeadDbcsCharacter</a>( Path.Buffer[i] ) ) {
00657 
00658             i += 1;
00659         }
00660     }
00661 
00662     <span class="comment">//</span>
00663     <span class="comment">//  At this point all characters up to (but not including) i are</span>
00664     <span class="comment">//  in the first part.   So setup the first name</span>
00665     <span class="comment">//</span>
00666 
00667     FirstName-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(i - FirstNameStart);
00668     FirstName-&gt;MaximumLength = FirstName-&gt;Length;
00669     FirstName-&gt;Buffer = &amp;Path.Buffer[FirstNameStart];
00670 
00671     <span class="comment">//</span>
00672     <span class="comment">//  Now the remaining part needs a string only if the first part didn't</span>
00673     <span class="comment">//  exhaust the entire input string.  We know that if anything is left</span>
00674     <span class="comment">//  that is must start with a backslash.  Note that if there is only</span>
00675     <span class="comment">//  a trailing backslash, the length will get correctly set to zero.</span>
00676     <span class="comment">//</span>
00677 
00678     <span class="keywordflow">if</span> (i &lt; PathLength) {
00679 
00680         RemainingName-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(PathLength - (i + 1));
00681         RemainingName-&gt;MaximumLength = RemainingName-&gt;Length;
00682         RemainingName-&gt;Buffer = &amp;Path.Buffer[i + 1];
00683     }
00684 
00685     <span class="comment">//</span>
00686     <span class="comment">//  And return to our caller</span>
00687     <span class="comment">//</span>
00688 
00689     <span class="keywordflow">return</span>;
00690 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a176" doxytag="fsrtl.h::FsRtlDissectName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlDissectName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN UNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Path</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>FirstName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>RemainingName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/name_8c-source.html#l00093">93</a> of file <a class="el" href="../../d5/d4/name_8c-source.html">name.c</a>.
<p>
References <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>00101                    :
00102 
00103     This routine cracks a <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.  It picks off <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first element in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00104     given <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> name and provides both <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remaining part.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>
00105     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a set of <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> names separated by backslashes.  If a name begins
00106     with a backslash, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FirstName <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> string immediately following
00107     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> backslash.  Here are some examples:
00108 
00109         Path           FirstName    RemainingName
00110         ----           ---------    -------------
00111         empty          empty        empty
00112 
00113         \              empty        empty
00114 
00115         <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a>              <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a>            empty
00116 
00117         \<a class="code" href="../../d2/d1/bench_8h.html#a5">A</a>             <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a>            empty
00118 
00119         <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a>\B\C\<a class="code" href="../../d2/d0/imemenu_8c.html#a0">D</a>\E      <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a>            B\C\<a class="code" href="../../d2/d0/imemenu_8c.html#a0">D</a>\E
00120 
00121         *<a class="code" href="../../d2/d1/bench_8h.html#a5">A</a>?            *<a class="code" href="../../d2/d1/bench_8h.html#a5">A</a>?          empty
00122 
00123 
00124     Note that both output strings use <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same string buffer memory of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00125     input string, and are not necessarily null terminated.
00126 
00127     Also, <span class="keyword">this</span> routine makes no judgement as to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> legality of each
00128     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> name componant.  This must be done separatly when each <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> name
00129     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> extracted.
00130 
00131 Arguments:
00132 
00133     Path - The full <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> name to crack.
00134 
00135     FirstName - The first name in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.  Don'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> allocate a buffer <span class="keywordflow">for</span>
00136         <span class="keyword">this</span> string.
00137 
00138     RemainingName - The rest of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.  Don'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> allocate a buffer <span class="keywordflow">for</span> <span class="keyword">this</span>
00139         string.
00140 
00141 Return Value:
00142 
00143     None.
00144 
00145 --*/
00146 
00147 {
00148     ULONG i = 0;
00149     ULONG PathLength;
00150     ULONG FirstNameStart;
00151 
00152     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00153 
00154     <span class="comment">//</span>
00155     <span class="comment">//  Make both output strings empty for now</span>
00156     <span class="comment">//</span>
00157 
00158     FirstName-&gt;Length = 0;
00159     FirstName-&gt;MaximumLength = 0;
00160     FirstName-&gt;Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00161 
00162     RemainingName-&gt;Length = 0;
00163     RemainingName-&gt;MaximumLength = 0;
00164     RemainingName-&gt;Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00165 
00166     PathLength = Path.Length / <span class="keyword">sizeof</span>(WCHAR);
00167 
00168     <span class="comment">//</span>
00169     <span class="comment">//  Check for an empty input string</span>
00170     <span class="comment">//</span>
00171 
00172     <span class="keywordflow">if</span> (PathLength == 0) {
00173 
00174         <span class="keywordflow">return</span>;
00175     }
00176 
00177     <span class="comment">//</span>
00178     <span class="comment">//  Skip over a starting backslash, and make sure there is more.</span>
00179     <span class="comment">//</span>
00180 
00181     <span class="keywordflow">if</span> ( Path.Buffer[0] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span> ) {
00182 
00183         i = 1;
00184     }
00185 
00186     <span class="comment">//</span>
00187     <span class="comment">//  Now run down the input string until we hit a backslash or the end</span>
00188     <span class="comment">//  of the string, remembering where we started;</span>
00189     <span class="comment">//</span>
00190 
00191     <span class="keywordflow">for</span> ( FirstNameStart = i;
00192           (i &lt; PathLength) &amp;&amp; (Path.Buffer[i] != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>);
00193           i += 1 ) {
00194 
00195         NOTHING;
00196     }
00197 
00198     <span class="comment">//</span>
00199     <span class="comment">//  At this point all characters up to (but not including) i are</span>
00200     <span class="comment">//  in the first part.   So setup the first name</span>
00201     <span class="comment">//</span>
00202 
00203     FirstName-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((i - FirstNameStart) * <span class="keyword">sizeof</span>(WCHAR));
00204     FirstName-&gt;MaximumLength = FirstName-&gt;Length;
00205     FirstName-&gt;Buffer = &amp;Path.Buffer[FirstNameStart];
00206 
00207     <span class="comment">//</span>
00208     <span class="comment">//  Now the remaining part needs a string only if the first part didn't</span>
00209     <span class="comment">//  exhaust the entire input string.  We know that if anything is left</span>
00210     <span class="comment">//  that is must start with a backslash.  Note that if there is only</span>
00211     <span class="comment">//  a trailing backslash, the length will get correctly set to zero.</span>
00212     <span class="comment">//</span>
00213 
00214     <span class="keywordflow">if</span> (i &lt; PathLength) {
00215 
00216         RemainingName-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((PathLength - (i + 1)) * <span class="keyword">sizeof</span>(WCHAR));
00217         RemainingName-&gt;MaximumLength = RemainingName-&gt;Length;
00218         RemainingName-&gt;Buffer = &amp;Path.Buffer[i + 1];
00219     }
00220 
00221     <span class="comment">//</span>
00222     <span class="comment">//  And return to our caller</span>
00223     <span class="comment">//</span>
00224 
00225     <span class="keywordflow">return</span>;
00226 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a132" doxytag="fsrtl.h::FsRtlDoesDbcsContainWildCards" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlDoesDbcsContainWildCards           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PANSI_STRING&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Name</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/dbcsname_8c-source.html#l00694">694</a> of file <a class="el" href="../../d2/d2/dbcsname_8c-source.html">dbcsname.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00946">FsRtlIsAnsiCharacterWild</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01033">FsRtlIsLeadDbcsCharacter</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/dbcsname_8c-source.html#l00771">FsRtlIsDbcsInExpression()</a>, and <a class="el" href="../../d2/d2/dbcsname_8c-source.html#l00081">FsRtlIsFatDbcsLegal()</a>.
<p>
<pre class="fragment"><div>00700                    :
00701 
00702     This routine checks <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input Dbcs name contains any wild card
00703     characters (i.e., *, ?, ANSI_DOS_STAR, or ANSI_DOS_QM).
00704 
00705 Arguments:
00706 
00707     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name to examine
00708 
00709 Return Value:
00710 
00711     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input name contains any wildcard characters and
00712         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00713 
00714 --*/
00715 
00716 {
00717     CLONG i;
00718 
00719     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00720 
00721     <span class="comment">//</span>
00722     <span class="comment">//  Check each character in the name to see if it's a wildcard</span>
00723     <span class="comment">//  character</span>
00724     <span class="comment">//</span>
00725 
00726     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length; i += 1) {
00727 
00728         <span class="comment">//</span>
00729         <span class="comment">//  check for dbcs character because we'll just skip over those</span>
00730         <span class="comment">//</span>
00731 
00732         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a36">FsRtlIsLeadDbcsCharacter</a>( <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[i] )) {
00733 
00734             i += 1;
00735 
00736         <span class="comment">//</span>
00737         <span class="comment">//  else check for a wild card character</span>
00738         <span class="comment">//</span>
00739 
00740         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a29">FsRtlIsAnsiCharacterWild</a>( <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[i] )) {
00741 
00742             <span class="comment">//</span>
00743             <span class="comment">//  Tell caller that this name contains wild cards</span>
00744             <span class="comment">//</span>
00745 
00746             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00747         }
00748     }
00749 
00750     <span class="comment">//</span>
00751     <span class="comment">//  No wildcard characters were found, so return to our caller</span>
00752     <span class="comment">//</span>
00753 
00754     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00755 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a177" doxytag="fsrtl.h::FsRtlDoesNameContainWildCards" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlDoesNameContainWildCards           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Name</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/name_8c-source.html#l00229">229</a> of file <a class="el" href="../../d5/d4/name_8c-source.html">name.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01538">FsRtlIsUnicodeCharacterWild</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00085">PUSHORT</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/name_8c-source.html#l00482">FsRtlIsNameInExpressionPrivate()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01003">UdfInitializeEnumeration()</a>, and <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00809">UdfNormalizeFileNames()</a>.
<p>
<pre class="fragment"><div>00235                    :
00236 
00237     This routine simply scans <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> string looking <span class="keywordflow">for</span> any Nt
00238     wild card characters.
00239 
00240 Arguments:
00241 
00242     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> - The string to check.
00243 
00244 Return Value:
00245 
00246     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> one or more wild card characters was found.
00247 
00248 --*/
00249 {
00250     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a> p;
00251 
00252     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00253 
00254     <span class="comment">//</span>
00255     <span class="comment">//  Check each character in the name to see if it's a wildcard</span>
00256     <span class="comment">//  character.</span>
00257     <span class="comment">//</span>
00258 
00259     <span class="keywordflow">if</span>( <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length ) {
00260         <span class="keywordflow">for</span>( p = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer + (<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length / <span class="keyword">sizeof</span>(WCHAR)) - 1;
00261              p &gt;= <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer &amp;&amp; *p != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span> ;
00262              p-- ) {
00263 
00264             <span class="comment">//</span>
00265             <span class="comment">//  check for a wild card character</span>
00266             <span class="comment">//</span>
00267 
00268             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a45">FsRtlIsUnicodeCharacterWild</a>( *p )) {
00269 
00270                 <span class="comment">//</span>
00271                 <span class="comment">//  Tell caller that this name contains wild cards</span>
00272                 <span class="comment">//</span>
00273 
00274                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00275             }
00276         }
00277     }
00278 
00279     <span class="comment">//</span>
00280     <span class="comment">//  No wildcard characters were found, so return to our caller</span>
00281     <span class="comment">//</span>
00282 
00283     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00284 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a119" doxytag="fsrtl.h::FsRtlFastCheckLockForRead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlFastCheckLockForRead           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileLock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingByte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Key</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessId</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l02582">2582</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00576">_FILE_LOCK_INFO::EndingByte</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00141">_LOCK_QUEUE::ExclusiveLockTree</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l02469">FsRtlCheckNoExclusiveConflict()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00484">FsRtlReacquireLockQueue</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00487">FsRtlReleaseLockQueue</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00568">_FILE_LOCK_INFO::Key</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00184">_LOCK_INFO::LockQueue</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00166">_LOCK_INFO::LowestLockOffset</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a30">PLOCK_INFO</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a28">PLOCK_QUEUE</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00570">_FILE_LOCK_INFO::ProcessId</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00560">_FILE_LOCK_INFO::StartingByte</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l01315">FsRtlCheckLockForReadAccess()</a>.
<p>
<pre class="fragment"><div>02593                    :
02594 
02595     This routine checks to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller has read access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02596     indicated range due to <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> locks.
02597 
02598 Arguments:
02599 
02600     FileLock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> to check
02601 
02602     StartingByte - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first byte (zero based) to check
02603 
02604     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, to check
02605 
02606     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> to use in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> check
02607 
02608     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object to use in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> check
02609 
02610     ProcessId - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Process Id to use in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> check
02611 
02612 Return Value:
02613 
02614     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> indicated user/request has read access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02615         entire specified byte range, and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
02616 
02617 --*/
02618 
02619 {
02620     LARGE_INTEGER Starting;
02621     LARGE_INTEGER Ending;
02622 
02623     <a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>            LockInfo;
02624     <a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html">PLOCK_QUEUE</a>           LockQueue;
02625     KIRQL                 OldIrql;
02626     <a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html">PFILE_LOCK_INFO</a>       LastLock;
02627     BOOLEAN               <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02628 
02629     <span class="keywordflow">if</span> ((LockInfo = (<a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>) FileLock-&gt;LockInformation) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02630 
02631         <span class="comment">//</span>
02632         <span class="comment">// No lock information on this FileLock</span>
02633         <span class="comment">//</span>
02634 
02635         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"FsRtlFastCheckLockForRead, No lock info\n"</span>, 0);
02636         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02637     }
02638 
02639     <span class="comment">//</span>
02640     <span class="comment">// If there isn't an exclusive lock then we can immediately grant access</span>
02641     <span class="comment">//</span>
02642 
02643     <span class="keywordflow">if</span> (LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o2">ExclusiveLockTree</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02644         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"FsRtlFastCheckLockForRead, No exlocks present\n"</span>, 0);
02645         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02646     }
02647 
02648     <span class="comment">//</span>
02649     <span class="comment">// If length is zero then automatically give grant access</span>
02650     <span class="comment">//</span>
02651 
02652     <span class="keywordflow">if</span> ((ULONGLONG)Length-&gt;QuadPart == 0) {
02653 
02654         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"FsRtlFastCheckLockForRead, Length == 0\n"</span>, 0);
02655         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02656     }
02657 
02658     <span class="comment">//</span>
02659     <span class="comment">//  Get our starting and ending byte position</span>
02660     <span class="comment">//</span>
02661 
02662     Starting = *StartingByte;
02663     (ULONGLONG)Ending.QuadPart = (ULONGLONG)Starting.QuadPart + (ULONGLONG)Length-&gt;QuadPart - 1;
02664 
02665     <span class="comment">//</span>
02666     <span class="comment">// Now check lock queue</span>
02667     <span class="comment">//</span>
02668 
02669     LockQueue = &amp;LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>;
02670 
02671     <span class="comment">//</span>
02672     <span class="comment">//  Grab the waiting lock queue spinlock to exclude anyone from messing</span>
02673     <span class="comment">//  with the queue while we're using it</span>
02674     <span class="comment">//</span>
02675 
02676     <a class="code" href="../../d5/d3/filelock_8c.html#a9">FsRtlReacquireLockQueue</a>(LockInfo, LockQueue, &amp;OldIrql);
02677 
02678     <span class="comment">//</span>
02679     <span class="comment">//  If the range ends below the lowest existing lock, this read is OK.</span>
02680     <span class="comment">//</span>
02681 
02682     <span class="keywordflow">if</span> ( ((ULONGLONG)Ending.QuadPart &lt; (ULONGLONG)LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o0">LowestLockOffset</a>) ) {
02683         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"FsRtlFastCheckLockForRead (below lowest lock)\n"</span>, 0);
02684 
02685         <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>(LockQueue, OldIrql);
02686         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02687     }
02688 
02689     <span class="comment">//</span>
02690     <span class="comment">//  If the caller just locked this range, he can read it.</span>
02691     <span class="comment">//</span>
02692 
02693     LastLock = (<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html">PFILE_LOCK_INFO</a>)FileObject-&gt;LastLock;
02694     <span class="keywordflow">if</span> ((LastLock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
02695         ((ULONGLONG)Starting.QuadPart &gt;= (ULONGLONG)LastLock-&gt;<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o0">StartingByte</a>.QuadPart) &amp;&amp;
02696         ((ULONGLONG)Ending.QuadPart &lt;= (ULONGLONG)LastLock-&gt;<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o6">EndingByte</a>.QuadPart) &amp;&amp;
02697         (LastLock-&gt;<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o3">Key</a> == <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>) &amp;&amp;
02698         (LastLock-&gt;<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o5">ProcessId</a> == ProcessId)) {
02699 
02700         <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>(LockQueue, OldIrql);
02701         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02702     }
02703 
02704     <span class="comment">//</span>
02705     <span class="comment">//  Check the exclusive locks for a conflict. It is impossible to have</span>
02706     <span class="comment">//  a read conflict with any shared lock.</span>
02707     <span class="comment">//</span>
02708 
02709     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/filelock_8c.html#a57">FsRtlCheckNoExclusiveConflict</a>(LockQueue, &amp;Starting, &amp;Ending, Key, FileObject, ProcessId);
02710 
02711     <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>(LockQueue, OldIrql);
02712 
02713     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02714 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a120" doxytag="fsrtl.h::FsRtlFastCheckLockForWrite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlFastCheckLockForWrite           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileLock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingByte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Key</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessId</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l02718">2718</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00576">_FILE_LOCK_INFO::EndingByte</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00562">_FILE_LOCK_INFO::ExclusiveLock</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00141">_LOCK_QUEUE::ExclusiveLockTree</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l02469">FsRtlCheckNoExclusiveConflict()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l02392">FsRtlCheckNoSharedConflict()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00484">FsRtlReacquireLockQueue</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00487">FsRtlReleaseLockQueue</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00568">_FILE_LOCK_INFO::Key</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00184">_LOCK_INFO::LockQueue</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00166">_LOCK_INFO::LowestLockOffset</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a30">PLOCK_INFO</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a28">PLOCK_QUEUE</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00570">_FILE_LOCK_INFO::ProcessId</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00140">_LOCK_QUEUE::SharedLockTree</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00560">_FILE_LOCK_INFO::StartingByte</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l01416">FsRtlCheckLockForWriteAccess()</a>.
<p>
<pre class="fragment"><div>02729                    :
02730 
02731     This routine checks to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller has write access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02732     indicated range due to <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> locks
02733 
02734 Arguments:
02735 
02736     FileLock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> to check
02737 
02738     StartingByte - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first byte (zero based) to check
02739 
02740     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, to check
02741 
02742     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> to use in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> check
02743 
02744     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object to use in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> check
02745 
02746     ProcessId - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Process Id to use in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> check
02747 
02748 Return Value:
02749 
02750     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> indicated user/request has write access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02751         entire specified byte range, and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
02752 
02753 --*/
02754 
02755 {
02756     LARGE_INTEGER Starting;
02757     LARGE_INTEGER Ending;
02758 
02759     <a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>              LockInfo;
02760     <a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html">PLOCK_QUEUE</a>             LockQueue;
02761     KIRQL                   OldIrql;
02762     <a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html">PFILE_LOCK_INFO</a>         LastLock;
02763     BOOLEAN                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02764 
02765     <span class="keywordflow">if</span> ((LockInfo = (<a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>) FileLock-&gt;LockInformation) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02766 
02767         <span class="comment">//</span>
02768         <span class="comment">// No lock information on this FileLock</span>
02769         <span class="comment">//</span>
02770 
02771         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"FsRtlFastCheckLockForRead, No lock info\n"</span>, 0);
02772         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02773     }
02774 
02775     <span class="comment">//</span>
02776     <span class="comment">//  If there isn't a lock then we can immediately grant access</span>
02777     <span class="comment">//</span>
02778 
02779     <span class="keywordflow">if</span> (LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o1">SharedLockTree</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o2">ExclusiveLockTree</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02780 
02781         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"FsRtlFastCheckLockForWrite, No locks present\n"</span>, 0);
02782         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02783     }
02784 
02785     <span class="comment">//</span>
02786     <span class="comment">//  If length is zero then automatically grant access</span>
02787     <span class="comment">//</span>
02788 
02789     <span class="keywordflow">if</span> ((ULONGLONG)Length-&gt;QuadPart == 0) {
02790 
02791         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"FsRtlFastCheckLockForWrite, Length == 0\n"</span>, 0);
02792         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02793     }
02794 
02795     <span class="comment">//</span>
02796     <span class="comment">//  Get our starting and ending byte position</span>
02797     <span class="comment">//</span>
02798 
02799     Starting = *StartingByte;
02800     (ULONGLONG)Ending.QuadPart = (ULONGLONG)Starting.QuadPart + (ULONGLONG)Length-&gt;QuadPart - 1;
02801 
02802     <span class="comment">//</span>
02803     <span class="comment">//  Now check lock queue</span>
02804     <span class="comment">//</span>
02805 
02806     LockQueue = &amp;LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>;
02807 
02808     <span class="comment">//</span>
02809     <span class="comment">//  Grab the waiting lock queue spinlock to exclude anyone from messing</span>
02810     <span class="comment">//  with the queue while we're using it</span>
02811     <span class="comment">//</span>
02812 
02813     <a class="code" href="../../d5/d3/filelock_8c.html#a9">FsRtlReacquireLockQueue</a>(LockInfo, LockQueue, &amp;OldIrql);
02814 
02815     <span class="comment">//</span>
02816     <span class="comment">//  If the range ends below the lowest existing lock, this write is OK.</span>
02817     <span class="comment">//</span>
02818 
02819     <span class="keywordflow">if</span> ( ((ULONGLONG)Ending.QuadPart &lt; (ULONGLONG)LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o0">LowestLockOffset</a>) ) {
02820 
02821         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"FsRtlFastCheckLockForWrite (below lowest lock)\n"</span>, 0);
02822 
02823         <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>(LockQueue, OldIrql);
02824         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02825     }
02826 
02827     <span class="comment">//</span>
02828     <span class="comment">//  If the caller just locked this range exclusively, he can write it.</span>
02829     <span class="comment">//</span>
02830 
02831     LastLock = (<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html">PFILE_LOCK_INFO</a>)((<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>)FileObject)-&gt;LastLock;
02832     <span class="keywordflow">if</span> ((LastLock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
02833         ((ULONGLONG)Starting.QuadPart &gt;= (ULONGLONG)LastLock-&gt;<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o0">StartingByte</a>.QuadPart) &amp;&amp;
02834         ((ULONGLONG)Ending.QuadPart &lt;= (ULONGLONG)LastLock-&gt;<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o6">EndingByte</a>.QuadPart) &amp;&amp;
02835         (LastLock-&gt;<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o3">Key</a> == <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>) &amp;&amp;
02836         (LastLock-&gt;<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o5">ProcessId</a> == ProcessId) &amp;&amp;
02837         LastLock-&gt;<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o2">ExclusiveLock</a>) {
02838 
02839         <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>(LockQueue, OldIrql);
02840         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02841     }
02842 
02843     <span class="comment">//</span>
02844     <span class="comment">//  Check the shared locks for overlap. Any overlap in the shared locks is fatal.</span>
02845     <span class="comment">//</span>
02846 
02847     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/filelock_8c.html#a56">FsRtlCheckNoSharedConflict</a>(LockQueue, &amp;Starting, &amp;Ending);
02848 
02849     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02850 
02851         <span class="comment">//</span>
02852         <span class="comment">//  No overlap in the shared locks, so check the exclusive locks for overlap.</span>
02853         <span class="comment">//</span>
02854 
02855         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/filelock_8c.html#a57">FsRtlCheckNoExclusiveConflict</a>(LockQueue, &amp;Starting, &amp;Ending, Key, FileObject, ProcessId);
02856     }
02857 
02858     <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>(LockQueue, OldIrql);
02859 
02860     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02861 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a123" doxytag="fsrtl.h::FsRtlFastUnlockAll" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI NTSTATUS FsRtlFastUnlockAll           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileLock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID Context&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l03770">3770</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l05254">FsRtlPrivateFastUnlockAll()</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l01173">FsRtlProcessFileLock()</a>, <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html#l00042">UdfCommonCleanup()</a>, and <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00436">UdfFastUnlockAll()</a>.
<p>
<pre class="fragment"><div>03779                    :
03780 
03781     This routine performs an <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a> all operation on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current locks
03782     associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock.  Only those locks with
03783     a <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object and process <span class="keywordtype">id</span> are freed.
03784 
03785 Arguments:
03786 
03787     FileLock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock being freed.
03788 
03789     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock
03790 
03791     ProcessId - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Process Id assoicated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> locks to be
03792         freed
03793 
03794     Context - Supplies an optional context to use when completing waiting
03795         lock irps.
03796 
03797 Return Value:
03798 
03799     None
03800 
03801 --*/
03802 
03803 {
03804     <span class="keywordflow">return</span> <a class="code" href="../../d5/d3/filelock_8c.html#a53">FsRtlPrivateFastUnlockAll</a>(
03805                 FileLock,
03806                 FileObject,
03807                 ProcessId,
03808                 0, FALSE,           <span class="comment">// No Key</span>
03809                 Context );
03810 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a124" doxytag="fsrtl.h::FsRtlFastUnlockAllByKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI NTSTATUS FsRtlFastUnlockAllByKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileLock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Key</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID Context&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l03814">3814</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d6/d2/filelock_8c-source.html#l05254">FsRtlPrivateFastUnlockAll()</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l01173">FsRtlProcessFileLock()</a>, and <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00557">UdfFastUnlockAllByKey()</a>.
<p>
<pre class="fragment"><div>03824                    :
03825 
03826     This routine performs an <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a> All by <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> operation on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current locks
03827     associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock.  Only those locks with
03828     a <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object, process <span class="keywordtype">id</span>, and key are freed.  The input <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>
03829     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> completed by <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a>
03830 
03831 Arguments:
03832 
03833     FileLock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock being freed.
03834 
03835     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock
03836 
03837     ProcessId - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Process Id assoicated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> locks to be
03838         freed
03839 
03840     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> to use in <span class="keyword">this</span> operation
03841 
03842     Context - Supplies an optional context to use when completing waiting
03843         lock irps.
03844 
03845 Return Value:
03846 
03847     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The <span class="keywordflow">return</span> status <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
03848 
03849 --*/
03850 
03851 {
03852     <span class="keywordflow">return</span> <a class="code" href="../../d5/d3/filelock_8c.html#a53">FsRtlPrivateFastUnlockAll</a>(
03853                 FileLock,
03854                 FileObject,
03855                 ProcessId,
03856                 Key, TRUE,
03857                 Context );
03858 
03859 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a122" doxytag="fsrtl.h::FsRtlFastUnlockSingle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI NTSTATUS FsRtlFastUnlockSingle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileLock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LARGE_INTEGER UNALIGNED *&nbsp;</td>
          <td class="mdname" nowrap> <em>FileOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Key</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID Context&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AlreadySynchronized</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l03241">3241</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03589">FsRtlFastUnlockSingleExclusive()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03337">FsRtlFastUnlockSingleShared()</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l01173">FsRtlProcessFileLock()</a>, and <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00297">UdfFastUnlockSingle()</a>.
<p>
<pre class="fragment"><div>03254                    :
03255 
03256     This routine performs an <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a> Single operation on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current locks
03257     associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock.  Only <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock with a <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a>
03258     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object, process <span class="keywordtype">id</span>, key, and range <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> freed.
03259 
03260 Arguments:
03261 
03262     FileLock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock being freed.
03263 
03264     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object holding <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> locks
03265 
03266     FileOffset - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offset to be unlocked
03267 
03268     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length in bytes to be unlocked
03269 
03270     ProcessId - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process Id to use in <span class="keyword">this</span> operation
03271 
03272     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key to use in <span class="keyword">this</span> operation
03273 
03274     Context - Optionally supplies context to use when completing Irps
03275 
03276     AlreadySynchronized - Indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller has already <span class="keyword">synchronized</span>
03277         access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock so <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fields in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock and
03278         be updated without further locking, but not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> queues.
03279 
03280 Return Value:
03281 
03282     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The completion status <span class="keywordflow">for</span> <span class="keyword">this</span> operation
03283 
03284 --*/
03285 
03286 {
03287     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03288 
03289     <span class="comment">//</span>
03290     <span class="comment">//  XXX AlreadySynchronized is obsolete. It was apparently added for the dead</span>
03291     <span class="comment">//  XXX SoloLock code.</span>
03292     <span class="comment">//</span>
03293 
03294     <span class="keywordflow">if</span> (FileLock-&gt;LockInformation == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03295 
03296         <span class="comment">//</span>
03297         <span class="comment">//  Fast exit - no locks are applied</span>
03298         <span class="comment">//</span>
03299 
03300         <span class="keywordflow">return</span> STATUS_RANGE_NOT_LOCKED;
03301     }
03302 
03303     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/filelock_8c.html#a60">FsRtlFastUnlockSingleExclusive</a>( FileLock-&gt;LockInformation,
03304                                              FileObject,
03305                                              FileOffset,
03306                                              Length,
03307                                              ProcessId,
03308                                              Key,
03309                                              Context,
03310                                              FALSE,
03311                                              TRUE );
03312 
03313     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
03314 
03315         <span class="comment">//</span>
03316         <span class="comment">//  Found and unlocked in the exclusive tree, so we're done</span>
03317         <span class="comment">//</span>
03318 
03319         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03320     }
03321 
03322     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/filelock_8c.html#a59">FsRtlFastUnlockSingleShared</a>( FileLock-&gt;LockInformation,
03323                                           FileObject,
03324                                           FileOffset,
03325                                           Length,
03326                                           ProcessId,
03327                                           Key,
03328                                           Context,
03329                                           FALSE,
03330                                           TRUE );
03331 
03332     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03333 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a128" doxytag="fsrtl.h::FsRtlFindInTunnelCache" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlFindInTunnelCache           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d1/structTUNNEL.html">TUNNEL</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>Cache</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DirectoryKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UNICODE_STRING *&nbsp;</td>
          <td class="mdname" nowrap> <em>Name</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT UNICODE_STRING *&nbsp;</td>
          <td class="mdname" nowrap> <em>ShortName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT UNICODE_STRING *&nbsp;</td>
          <td class="mdname" nowrap> <em>LongName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT ULONG *&nbsp;</td>
          <td class="mdname" nowrap> <em>DataLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT VOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Data</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a113" doxytag="fsrtl.h::FsRtlFreeFileLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlFreeFileLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>FileLock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l01162">1162</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00947">ExFreeToPagedLookasideList()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00137">FsRtlFileLockLookasideList</a>, and <a class="el" href="../../d6/d2/filelock_8c-source.html#l00995">FsRtlUninitializeFileLock()</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02178">UdfDeleteFcb()</a>.
<p>
<pre class="fragment"><div>01165 {
01166     <a class="code" href="../../d1/d8/fsrtl_8h.html#a115">FsRtlUninitializeFileLock</a>( FileLock );
01167 
01168     <a class="code" href="../../d5/d8/ex_8h.html#a253">ExFreeToPagedLookasideList</a>( &amp;FsRtlFileLockLookasideList, FileLock );
01169 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a109" doxytag="fsrtl.h::FsRtlGetFileSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FsRtlGetFileSize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>FileSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/fastio_8c-source.html#l02691">2691</a> of file <a class="el" href="../../d4/d0/fastio_8c-source.html">fastio.c</a>.
<p>
References <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02488">_IO_STACK_LOCATION::DeviceObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01403">_DRIVER_OBJECT::FastIoDispatch</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00947">_FAST_IO_DISPATCH::FastIoQueryStandardInfo</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00652">IoAllocateIrp()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00060">IRP_MJ_QUERY_INFORMATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01550">IRP_PAGING_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01557">IRP_SYNCHRONOUS_PAGING_IO</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01641">_IRP::RequestorMode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01189">_DEVICE_OBJECT::StackSize</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/creasect_8c-source.html#l03553">MiCreateDataFileMap()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l01424">MiCreateImageFileMap()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l00390">MmCreateSection()</a>, and <a class="el" href="../../d9/d9/extsect_8c-source.html#l00201">MmExtendSection()</a>.
<p>
<pre class="fragment"><div>02698                    :
02699 
02700     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to call <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> System to get <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FileSize
02701     <span class="keywordflow">for</span> a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
02702 
02703     It does <span class="keyword">this</span> without acquiring <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object lock on synchronous <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
02704     objects.  This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> therefore safe to call <span class="keywordflow">if</span> you already own
02705     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system resources, <span class="keywordflow">while</span> <a class="code" href="../../d0/d5/io_8h.html#a526">IoQueryFileInformation</a> could (and does)
02706     lead to deadlocks.
02707 
02708 Arguments:
02709 
02710     FileObject - The <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to query
02711     FileSize - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> size.
02712 
02713 Return Value:
02714 
02715     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The <span class="keyword">final</span> I/O status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FileObject
02716         refers to a directory, STATUS_FILE_IS_A_DIRECTORY <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
02717 
02718 --*/
02719 {
02720     IO_STATUS_BLOCK IoStatus;
02721     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject;
02722     <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> FastIoDispatch;
02723     FILE_STANDARD_INFORMATION FileInformation;
02724 
02725     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02726 
02727     <span class="comment">//</span>
02728     <span class="comment">// Get the address of the target device object.</span>
02729     <span class="comment">//</span>
02730 
02731     DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject );
02732 
02733     <span class="comment">//</span>
02734     <span class="comment">// Try the fast query call if it exists.</span>
02735     <span class="comment">//</span>
02736 
02737     FastIoDispatch = DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>;
02738 
02739     <span class="keywordflow">if</span> (FastIoDispatch &amp;&amp;
02740         FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o5">FastIoQueryStandardInfo</a> &amp;&amp;
02741         FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o5">FastIoQueryStandardInfo</a>( FileObject,
02742                                                  TRUE,
02743                                                  &amp;FileInformation,
02744                                                  &amp;IoStatus,
02745                                                  DeviceObject )) {
02746         <span class="comment">//</span>
02747         <span class="comment">//  Cool, it worked.</span>
02748         <span class="comment">//</span>
02749 
02750     } <span class="keywordflow">else</span> {
02751 
02752         <span class="comment">//</span>
02753         <span class="comment">//  Life's tough, take the long path.</span>
02754         <span class="comment">//</span>
02755 
02756         <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
02757         <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
02758         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02759         <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
02760 
02761         <span class="comment">//</span>
02762         <span class="comment">//  Initialize the event.</span>
02763         <span class="comment">//</span>
02764 
02765         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;Event, NotificationEvent, FALSE );
02766 
02767         <span class="comment">//</span>
02768         <span class="comment">//  Allocate an I/O Request Packet (IRP) for this in-page operation.</span>
02769         <span class="comment">//</span>
02770 
02771         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>( DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a>, FALSE );
02772         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02773 
02774             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02775         }
02776 
02777         <span class="comment">//</span>
02778         <span class="comment">//  Get a pointer to the first stack location in the packet.  This location</span>
02779         <span class="comment">//  will be used to pass the function codes and parameters to the first</span>
02780         <span class="comment">//  driver.</span>
02781         <span class="comment">//</span>
02782 
02783         IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( Irp );
02784 
02785         <span class="comment">//</span>
02786         <span class="comment">//  Fill in the IRP according to this request, setting the flags to</span>
02787         <span class="comment">//  just cause IO to set the event and deallocate the Irp.</span>
02788         <span class="comment">//</span>
02789 
02790         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a174">IRP_PAGING_IO</a> | <a class="code" href="../../d0/d5/io_8h.html#a181">IRP_SYNCHRONOUS_PAGING_IO</a>;
02791         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>;
02792         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = &amp;IoStatus;
02793         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
02794         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = FileObject;
02795         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
02796         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = &amp;FileInformation;
02797 
02798         <span class="comment">//</span>
02799         <span class="comment">//  Fill in the normal query parameters.</span>
02800         <span class="comment">//</span>
02801 
02802         IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a18">IRP_MJ_QUERY_INFORMATION</a>;
02803         IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = FileObject;
02804         IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o57">DeviceObject</a> = DeviceObject;
02805         IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.SetFile.Length = <span class="keyword">sizeof</span>(FILE_STANDARD_INFORMATION);
02806         IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.SetFile.FileInformationClass = FileStandardInformation;
02807 
02808         <span class="comment">//</span>
02809         <span class="comment">//  Queue the packet to the appropriate driver based.  This routine</span>
02810         <span class="comment">//  should not raise.</span>
02811         <span class="comment">//</span>
02812 
02813         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( DeviceObject, Irp );
02814 
02815         <span class="comment">//</span>
02816         <span class="comment">//  If pending is returned (which is a successful status),</span>
02817         <span class="comment">//  we must wait for the request to complete.</span>
02818         <span class="comment">//</span>
02819 
02820         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
02821             <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;Event,
02822                                    Executive,
02823                                    KernelMode,
02824                                    FALSE,
02825                                    (PLARGE_INTEGER)NULL);
02826         }
02827 
02828         <span class="comment">//</span>
02829         <span class="comment">//  If we got an error back in Status, then the Iosb</span>
02830         <span class="comment">//  was not written, so we will just copy the status</span>
02831         <span class="comment">//  there, then test the final status after that.</span>
02832         <span class="comment">//</span>
02833 
02834         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02835             IoStatus.Status = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02836         }
02837     }
02838 
02839     <span class="comment">//</span>
02840     <span class="comment">//  If the call worked, check to make sure it wasn't a directory and</span>
02841     <span class="comment">//  if not, fill in the FileSize parameter.</span>
02842     <span class="comment">//</span>
02843 
02844     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IoStatus.Status)) {
02845 
02846         <span class="keywordflow">if</span> (FileInformation.Directory) {
02847 
02848             <span class="comment">//</span>
02849             <span class="comment">// Can't get file size for a directory. Return error.</span>
02850             <span class="comment">//</span>
02851 
02852             IoStatus.Status = STATUS_FILE_IS_A_DIRECTORY;
02853 
02854         } <span class="keywordflow">else</span> {
02855 
02856             *FileSize = FileInformation.EndOfFile;
02857         }
02858     }
02859 
02860     <span class="keywordflow">return</span> IoStatus.Status;
02861 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a121" doxytag="fsrtl.h::FsRtlGetNextFileLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI <a class="el" href="../../d8/d1/struct__FILE__LOCK__INFO.html">PFILE_LOCK_INFO</a> FsRtlGetNextFileLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileLock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Restart</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l01951">1951</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00576">_FILE_LOCK_INFO::EndingByte</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00562">_FILE_LOCK_INFO::ExclusiveLock</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00141">_LOCK_QUEUE::ExclusiveLockTree</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00569">_FILE_LOCK_INFO::FileObject</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00481">FsRtlAcquireLockQueue</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01687">FsRtlFindFirstOverlappingExclusiveNode()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01517">FsRtlFindFirstOverlappingSharedNode()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00487">FsRtlReleaseLockQueue</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00568">_FILE_LOCK_INFO::Key</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00561">_FILE_LOCK_INFO::Length</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00068">_SH_LOCK::LockInfo</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00089">_EX_LOCK::LockInfo</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00184">_LOCK_INFO::LockQueue</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00008">_LOCKTREE_NODE::Locks</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a24">PEX_LOCK</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a30">PLOCK_INFO</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a20">PLOCKTREE_NODE</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00570">_FILE_LOCK_INFO::ProcessId</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a22">PSH_LOCK</a>, <a class="el" href="../../d4/d3/splay_8c-source.html#l00759">RtlRealSuccessor()</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00140">_LOCK_QUEUE::SharedLockTree</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00560">_FILE_LOCK_INFO::StartingByte</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>01958                    :
01959 
01960     This routine enumerates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> individual <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> locks denoted by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock
01961     variable. It returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock information stored <span class="keywordflow">for</span> each lock.
01962     The caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> responsible <span class="keywordflow">for</span> synchronizing call to <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> and <span class="keywordflow">for</span> not
01963     altering any of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data returned by <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a>. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller does not
01964     synchronize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration will not be reliably complete.
01965 
01966     The way a programmer will use <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> to enumerate all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> locks
01967     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> as follows:
01968 
01969     <span class="keywordflow">for</span> (p = <a class="code" href="../../d1/d8/fsrtl_8h.html#a121">FsRtlGetNextFileLock</a>( FileLock, TRUE );
01970          p != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01971          p = <a class="code" href="../../d1/d8/fsrtl_8h.html#a121">FsRtlGetNextFileLock</a>( FileLock, FALSE )) {
01972 
01973             <span class="comment">// Process the lock information referenced by p</span>
01974     }
01975 
01976     Order <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> *not* guaranteed.
01977 
01978 Arguments:
01979 
01980     FileLock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> to enumerate.  The current
01981         enumeration state <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock variable so <span class="keywordflow">if</span> multiple
01982         threads are enumerating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same time <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> results will
01983         be unpredictable.
01984 
01985     Restart - Indicates <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to start at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> beginning of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01986         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock tree or <span class="keywordflow">if</span> we are continuing from a previous call.
01987 
01988 Return Value:
01989 
01990     <a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html">PFILE_LOCK_INFO</a> - Either <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock
01991         record <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock or <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> returns <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> there
01992         are not more locks.
01993 
01994 --*/
01995 
01996 {
01997     <a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html">FILE_LOCK_INFO</a>      FileLockInfo;
01998     PVOID               ContinuationPointer;
01999     <a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>          LockInfo;
02000     <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">PLOCKTREE_NODE</a>      Node;
02001     PSINGLE_LIST_ENTRY  Link;
02002     PRTL_SPLAY_LINKS    SplayLinks, LastSplayLinks;
02003     <a class="code" href="../../d8/d2/struct__SH__LOCK.html">PSH_LOCK</a>            ShLock;
02004     <a class="code" href="../../d7/d7/struct__EX__LOCK.html">PEX_LOCK</a>            ExLock;
02005     BOOLEAN             FoundReturnable, <a class="code" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a>;
02006     KIRQL               OldIrql;
02007 
02008     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlGetNextFileLock, FileLock = %08lx\n"</span>, FileLock);
02009 
02010     <span class="keywordflow">if</span> ((LockInfo = (<a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>) FileLock-&gt;LockInformation) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02011         <span class="comment">//</span>
02012         <span class="comment">//  No lock information on this FileLock</span>
02013         <span class="comment">//</span>
02014 
02015         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02016     }
02017 
02018     FoundReturnable = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02019 
02020     <span class="comment">//</span>
02021     <span class="comment">//  Before getting the spinlock, copy pagable info onto stack</span>
02022     <span class="comment">//</span>
02023 
02024     FileLockInfo = FileLock-&gt;LastReturnedLockInfo;
02025     ContinuationPointer = FileLock-&gt;LastReturnedLock;
02026 
02027     <a class="code" href="../../d5/d3/filelock_8c.html#a8">FsRtlAcquireLockQueue</a> (&amp;LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>, &amp;OldIrql);
02028 
02029     <span class="keywordflow">if</span> (!Restart) {
02030         <span class="comment">//</span>
02031         <span class="comment">//  Given the last returned lock, find its current successor in the tree.</span>
02032         <span class="comment">//  Previous implementations would reset the enumeration if the last returned</span>
02033         <span class="comment">//  lock had been removed from the tree but I think we can be better in that</span>
02034         <span class="comment">//  case since every other structure modifying event (add new locks, delete</span>
02035         <span class="comment">//  other locks) would *not* have caused the reset. Possible minor performance</span>
02036         <span class="comment">//  enhancement.</span>
02037         <span class="comment">//</span>
02038 
02039         <span class="comment">//</span>
02040         <span class="comment">//  Find the node which could contain the last returned lock. We enumerate the</span>
02041         <span class="comment">//  exclusive lock tree, then the shared lock tree. Find the one we're enumerating.</span>
02042         <span class="comment">//</span>
02043 
02044         <span class="keywordflow">if</span> (FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o2">ExclusiveLock</a>) {
02045 
02046             <span class="comment">//</span>
02047             <span class="comment">//  Continue enumeration in the exclusive lock tree</span>
02048             <span class="comment">//</span>
02049 
02050             ExLock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02051 
02052             SplayLinks = <a class="code" href="../../d5/d3/filelock_8c.html#a44">FsRtlFindFirstOverlappingExclusiveNode</a>( LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o2">ExclusiveLockTree</a>,
02053                                                                  &amp;FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o0">StartingByte</a>,
02054                                                                  &amp;FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o6">EndingByte</a>,
02055                                                                  &amp;LastSplayLinks,
02056                                                                  &amp;GreaterThan );
02057 
02058             <span class="keywordflow">if</span> (SplayLinks == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02059 
02060                 <span class="comment">//</span>
02061                 <span class="comment">//  No overlapping nodes were found, try to find successor</span>
02062                 <span class="comment">//</span>
02063 
02064                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a>) {
02065 
02066                     <span class="comment">//</span>
02067                     <span class="comment">//  Last node looked at was greater than the lock so it is</span>
02068                     <span class="comment">//  the place to pick up the enumeration</span>
02069                     <span class="comment">//</span>
02070 
02071                     SplayLinks = LastSplayLinks;
02072 
02073                 } <span class="keywordflow">else</span> {
02074 
02075                     <span class="comment">//</span>
02076                     <span class="comment">// Last node looked at was less than the lock so grab its successor</span>
02077                     <span class="comment">//</span>
02078 
02079                     <span class="keywordflow">if</span> (LastSplayLinks) {
02080 
02081                         SplayLinks = <a class="code" href="../../d3/d4/splay_8c.html#a8">RtlRealSuccessor</a>(LastSplayLinks);
02082                     }
02083                 }
02084 
02085             } <span class="keywordflow">else</span> {
02086 
02087                 <span class="comment">//</span>
02088                 <span class="comment">//  Found an overlapping lock, see if it is the last returned</span>
02089                 <span class="comment">//</span>
02090 
02091                 <span class="keywordflow">for</span> (;
02092                     SplayLinks;
02093                     SplayLinks = <a class="code" href="../../d3/d4/splay_8c.html#a8">RtlRealSuccessor</a>(SplayLinks)) {
02094 
02095                     ExLock = CONTAINING_RECORD( SplayLinks, <a class="code" href="../../d7/d7/struct__EX__LOCK.html">EX_LOCK</a>, Links );
02096 
02097                     <span class="keywordflow">if</span> (ContinuationPointer == ExLock &amp;&amp;
02098                         (ULONGLONG)FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o0">StartingByte</a>.QuadPart == (ULONGLONG)ExLock-&gt;<a class="code" href="../../d7/d7/struct__EX__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o0">StartingByte</a>.QuadPart &amp;&amp;
02099                         (ULONGLONG)FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o1">Length</a>.QuadPart == (ULONGLONG)ExLock-&gt;<a class="code" href="../../d7/d7/struct__EX__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o1">Length</a>.QuadPart &amp;&amp;
02100                         FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o3">Key</a> == ExLock-&gt;<a class="code" href="../../d7/d7/struct__EX__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o3">Key</a> &amp;&amp;
02101                         FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o4">FileObject</a> == ExLock-&gt;<a class="code" href="../../d7/d7/struct__EX__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o4">FileObject</a> &amp;&amp;
02102                         FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o5">ProcessId</a> == ExLock-&gt;<a class="code" href="../../d7/d7/struct__EX__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o5">ProcessId</a>) {
02103 
02104                         <span class="comment">//</span>
02105                         <span class="comment">//  Found last returned, dig up its successor</span>
02106                         <span class="comment">//</span>
02107 
02108                         SplayLinks = <a class="code" href="../../d3/d4/splay_8c.html#a8">RtlRealSuccessor</a>(SplayLinks);
02109 
02110                         <span class="comment">//</span>
02111                         <span class="comment">//  Got the node cold, so we're done</span>
02112                         <span class="comment">//</span>
02113 
02114                         <span class="keywordflow">break</span>;
02115                     }
02116 
02117                     <span class="comment">//</span>
02118                     <span class="comment">//  This lock overlapped and was not the last returned. In fact, since this lock would</span>
02119                     <span class="comment">//  have conflicted with the last returned we know it could not have been returned</span>
02120                     <span class="comment">//  before, so this should be returned to the caller.</span>
02121                     <span class="comment">//</span>
02122                     <span class="comment">//  However, if it is a zero length lock we are looking for and a zero length lock we hit,</span>
02123                     <span class="comment">//  we are at the beginning of a run we need to inspect. If we cannot find the last lock</span>
02124                     <span class="comment">//  we returned, resume the enumeration at the beginning of the run.</span>
02125                     <span class="comment">//</span>
02126 
02127                     <span class="keywordflow">if</span> (ExLock-&gt;<a class="code" href="../../d7/d7/struct__EX__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o1">Length</a>.QuadPart != 0 || FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o1">Length</a>.QuadPart != 0) {
02128 
02129                         <span class="keywordflow">break</span>;
02130                     }
02131 
02132                     <span class="comment">//</span>
02133                     <span class="comment">//  Keep wandering down the run</span>
02134                     <span class="comment">//</span>
02135                 }
02136             }
02137 
02138             <span class="comment">//</span>
02139             <span class="comment">//  Were we able to find a lock to return?</span>
02140             <span class="comment">//</span>
02141 
02142             <span class="keywordflow">if</span> (SplayLinks == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02143 
02144                 <span class="comment">//</span>
02145                 <span class="comment">//  There aren't any more exclusive locks, fall over to the shared tree</span>
02146                 <span class="comment">//</span>
02147 
02148                 SplayLinks = LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o1">SharedLockTree</a>;
02149 
02150                 <span class="keywordflow">if</span> (SplayLinks) {
02151 
02152                     <span class="keywordflow">while</span> (RtlLeftChild(SplayLinks)) {
02153 
02154                         SplayLinks = RtlLeftChild(SplayLinks);
02155                     }
02156 
02157                     Node = CONTAINING_RECORD(SplayLinks, <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">LOCKTREE_NODE</a>, Links);
02158                     ShLock = CONTAINING_RECORD(Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o0">Locks</a>.Next, <a class="code" href="../../d8/d2/struct__SH__LOCK.html">SH_LOCK</a>, Link);
02159 
02160                     FileLockInfo = ShLock-&gt;<a class="code" href="../../d8/d2/struct__SH__LOCK.html#o1">LockInfo</a>;
02161                     ContinuationPointer = ShLock;
02162                     FoundReturnable = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02163                 }
02164 
02165             } <span class="keywordflow">else</span> {
02166 
02167                 <span class="comment">//</span>
02168                 <span class="comment">//  This is the lock to return</span>
02169                 <span class="comment">//</span>
02170 
02171                 ExLock = CONTAINING_RECORD( SplayLinks, <a class="code" href="../../d7/d7/struct__EX__LOCK.html">EX_LOCK</a>, Links );
02172 
02173                 FileLockInfo = ExLock-&gt;<a class="code" href="../../d7/d7/struct__EX__LOCK.html#o1">LockInfo</a>;
02174                 ContinuationPointer = ExLock;
02175                 FoundReturnable = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02176             }
02177 
02178         } <span class="keywordflow">else</span> {
02179 
02180             <span class="comment">//</span>
02181             <span class="comment">//  Continue enumeration in the shared lock tree</span>
02182             <span class="comment">//</span>
02183 
02184             Node = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02185 
02186             SplayLinks = <a class="code" href="../../d5/d3/filelock_8c.html#a43">FsRtlFindFirstOverlappingSharedNode</a>( LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o1">SharedLockTree</a>,
02187                                                               &amp;FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o0">StartingByte</a>,
02188                                                               &amp;FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o6">EndingByte</a>,
02189                                                               &amp;LastSplayLinks,
02190                                                               &amp;GreaterThan );
02191 
02192             <span class="keywordflow">if</span> (SplayLinks == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02193 
02194                 <span class="comment">//</span>
02195                 <span class="comment">//  No overlapping nodes were found</span>
02196                 <span class="comment">//</span>
02197 
02198                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a>) {
02199 
02200                     <span class="comment">//</span>
02201                     <span class="comment">//  Last node looked at was greater than the lock so it is</span>
02202                     <span class="comment">//  the place to pick up the enumeration</span>
02203                     <span class="comment">//</span>
02204 
02205                     <span class="keywordflow">if</span> (LastSplayLinks) {
02206 
02207                         SplayLinks = LastSplayLinks;
02208                         Node = CONTAINING_RECORD( LastSplayLinks, <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">LOCKTREE_NODE</a>, Links );
02209                     }
02210 
02211                 } <span class="keywordflow">else</span> {
02212 
02213                     <span class="comment">//</span>
02214                     <span class="comment">// Last node looked at was less than the lock so grab its successor</span>
02215                     <span class="comment">//</span>
02216 
02217                     <span class="keywordflow">if</span> (LastSplayLinks) {
02218 
02219                         SplayLinks = <a class="code" href="../../d3/d4/splay_8c.html#a8">RtlRealSuccessor</a>(LastSplayLinks);
02220 
02221                         <span class="keywordflow">if</span> (SplayLinks) {
02222 
02223                             Node = CONTAINING_RECORD( SplayLinks, <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">LOCKTREE_NODE</a>, Links );
02224                         }
02225                     }
02226                 }
02227 
02228             } <span class="keywordflow">else</span> {
02229 
02230                 <span class="comment">//</span>
02231                 <span class="comment">//  Grab the node we found</span>
02232                 <span class="comment">//</span>
02233 
02234                 Node = CONTAINING_RECORD( SplayLinks, <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">LOCKTREE_NODE</a>, Links );
02235             }
02236 
02237             <span class="comment">//</span>
02238             <span class="comment">//  If we have a node to look at, it may still not contain the the last returned lock</span>
02239             <span class="comment">//  if this isn't synchronized.</span>
02240             <span class="comment">//</span>
02241 
02242             <span class="keywordflow">if</span> (Node != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02243 
02244                 <span class="comment">//</span>
02245                 <span class="comment">//    Walk down the locks at this node looking for the last returned lock</span>
02246                 <span class="comment">//</span>
02247 
02248                 <span class="keywordflow">for</span> (Link = Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o0">Locks</a>.Next;
02249                      Link;
02250                      Link = Link-&gt;Next) {
02251 
02252                     <span class="comment">//</span>
02253                     <span class="comment">//  Get a pointer to the current lock record</span>
02254                     <span class="comment">//</span>
02255 
02256                     ShLock = CONTAINING_RECORD( Link, <a class="code" href="../../d8/d2/struct__SH__LOCK.html">SH_LOCK</a>, Link );
02257 
02258                     <span class="comment">//</span>
02259                     <span class="comment">// See if it's a match</span>
02260                     <span class="comment">//</span>
02261 
02262                     <span class="keywordflow">if</span> (ContinuationPointer == ShLock &amp;&amp;
02263                         (ULONGLONG)FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o0">StartingByte</a>.QuadPart == (ULONGLONG)ShLock-&gt;<a class="code" href="../../d8/d2/struct__SH__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o0">StartingByte</a>.QuadPart &amp;&amp;
02264                         (ULONGLONG)FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o1">Length</a>.QuadPart == (ULONGLONG)ShLock-&gt;<a class="code" href="../../d8/d2/struct__SH__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o1">Length</a>.QuadPart &amp;&amp;
02265                         FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o3">Key</a> == ShLock-&gt;<a class="code" href="../../d8/d2/struct__SH__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o3">Key</a> &amp;&amp;
02266                         FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o4">FileObject</a> == ShLock-&gt;<a class="code" href="../../d8/d2/struct__SH__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o4">FileObject</a> &amp;&amp;
02267                         FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o5">ProcessId</a> == ShLock-&gt;<a class="code" href="../../d8/d2/struct__SH__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o5">ProcessId</a>) {
02268 
02269                         Link = Link-&gt;Next;
02270                         <span class="keywordflow">break</span>;
02271                     }
02272 
02273                     <span class="comment">//</span>
02274                     <span class="comment">// See if we passed by its slot</span>
02275                     <span class="comment">//</span>
02276 
02277                     <span class="keywordflow">if</span> ((ULONGLONG)FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o0">StartingByte</a>.QuadPart &lt; (ULONGLONG)ShLock-&gt;<a class="code" href="../../d8/d2/struct__SH__LOCK.html#o1">LockInfo</a>.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o0">StartingByte</a>.QuadPart) {
02278 
02279                         <span class="keywordflow">break</span>;
02280                     }
02281                 }
02282 
02283                 <span class="keywordflow">if</span> (Link == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02284 
02285                     <span class="comment">//</span>
02286                     <span class="comment">//  This node doesn't contain the successor, so move</span>
02287                     <span class="comment">//  up to the successor node in the tree and return the</span>
02288                     <span class="comment">//  first lock. If we're actually at the end of the tree</span>
02289                     <span class="comment">//  we just fall off the end correctly.</span>
02290                     <span class="comment">//</span>
02291 
02292                     SplayLinks = <a class="code" href="../../d3/d4/splay_8c.html#a8">RtlRealSuccessor</a>(SplayLinks);
02293 
02294                     <span class="keywordflow">if</span> (SplayLinks) {
02295 
02296                         Node = CONTAINING_RECORD( SplayLinks, <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">LOCKTREE_NODE</a>, Links );
02297 
02298                         Link = Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o0">Locks</a>.Next;
02299                     }
02300                 }
02301 
02302                 <span class="keywordflow">if</span> (Link) {
02303 
02304                     <span class="comment">//</span>
02305                     <span class="comment">//  Found a Lock to return, copy it to the stack</span>
02306                     <span class="comment">//</span>
02307 
02308                     ShLock = CONTAINING_RECORD( Link, <a class="code" href="../../d8/d2/struct__SH__LOCK.html">SH_LOCK</a>, Link );
02309 
02310                     FileLockInfo = ShLock-&gt;<a class="code" href="../../d8/d2/struct__SH__LOCK.html#o1">LockInfo</a>;
02311                     ContinuationPointer = ShLock;
02312                     FoundReturnable = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02313                 }
02314 
02315             }
02316         }
02317 
02318     } <span class="keywordflow">else</span> {
02319 
02320         <span class="comment">//</span>
02321         <span class="comment">//  Restarting the enumeration. Find leftmost node in the exclusive tree and hand back</span>
02322         <span class="comment">//  the first lock, falling over to the shared if no exlcusive locks are applied</span>
02323         <span class="comment">//</span>
02324 
02325         <span class="keywordflow">if</span> (LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o2">ExclusiveLockTree</a>) {
02326 
02327             SplayLinks = LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o2">ExclusiveLockTree</a>;
02328 
02329             <span class="keywordflow">while</span> (RtlLeftChild(SplayLinks) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02330 
02331                 SplayLinks = RtlLeftChild(SplayLinks);
02332             }
02333 
02334             ExLock = CONTAINING_RECORD( SplayLinks, <a class="code" href="../../d7/d7/struct__EX__LOCK.html">EX_LOCK</a>, Links );
02335 
02336             FileLockInfo = ExLock-&gt;<a class="code" href="../../d7/d7/struct__EX__LOCK.html#o1">LockInfo</a>;
02337             ContinuationPointer = ExLock;
02338             FoundReturnable = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02339 
02340         } <span class="keywordflow">else</span> {
02341 
02342             <span class="keywordflow">if</span> (LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o1">SharedLockTree</a>) {
02343 
02344                 SplayLinks = LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o1">SharedLockTree</a>;
02345 
02346                 <span class="keywordflow">while</span> (RtlLeftChild(SplayLinks) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02347 
02348                     SplayLinks = RtlLeftChild(SplayLinks);
02349                 }
02350 
02351                 Node = CONTAINING_RECORD( SplayLinks, <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">LOCKTREE_NODE</a>, Links );
02352                 ShLock = CONTAINING_RECORD( Node-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o0">Locks</a>.Next, <a class="code" href="../../d8/d2/struct__SH__LOCK.html">SH_LOCK</a>, Link );
02353 
02354                 FileLockInfo = ShLock-&gt;<a class="code" href="../../d8/d2/struct__SH__LOCK.html#o1">LockInfo</a>;
02355                 ContinuationPointer = ShLock;
02356                 FoundReturnable = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02357             }
02358         }
02359     }
02360 
02361     <span class="comment">//</span>
02362     <span class="comment">//  Release all the lock queues</span>
02363     <span class="comment">//</span>
02364 
02365     <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a> (&amp;LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>, OldIrql);
02366 
02367     <span class="keywordflow">if</span> (!FoundReturnable) {
02368 
02369         <span class="comment">//</span>
02370         <span class="comment">//  No returnable lock was found, end of list</span>
02371         <span class="comment">//</span>
02372 
02373         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02374     }
02375 
02376     <span class="comment">//</span>
02377     <span class="comment">// Update current enum location information</span>
02378     <span class="comment">//</span>
02379 
02380     FileLock-&gt;LastReturnedLockInfo = FileLockInfo;
02381     FileLock-&gt;LastReturnedLock = ContinuationPointer;
02382 
02383     <span class="comment">//</span>
02384     <span class="comment">// Return lock record to caller</span>
02385     <span class="comment">//</span>
02386 
02387     <span class="keywordflow">return</span> &amp;FileLock-&gt;LastReturnedLockInfo;
02388 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a149" doxytag="fsrtl.h::FsRtlGetNextLargeMcbEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlGetNextLargeMcbEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Mcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>RunIndex</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Vbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Lbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SectorCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/largemcb_8c-source.html#l01970">1970</a> of file <a class="el" href="../../d2/d0/largemcb_8c-source.html">largemcb.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00158">_NONOPAQUE_MCB::FastMutex</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00160">_NONOPAQUE_MCB::PairCount</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00164">PNONOPAQUE_MCB</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00242">SectorsWithinRun</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00210">StartingLbn</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00191">StartingVbn</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02154">try_return</a>, and <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00149">UNUSED_LBN</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00490">FsRtlGetNextMcbEntry()</a>.
<p>
<pre class="fragment"><div>01980                    :
01981 
01982     This routine returns to its caller <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Vbn, Lbn, and SectorCount <span class="keywordflow">for</span>
01983     distinct runs mapped by an Mcb.  Holes are counted as runs.  For example,
01984     to construct to <a class="code" href="../../d0/d1/rtdeltre_8c.html#a5">print</a> <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> runs in a a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>:
01985 
01986 <span class="comment">//. .   for (i = 0; FsRtlGetNextLargeMcbEntry(Mcb,i,&amp;Vbn,&amp;Lbn,&amp;Count); i++) {</span>
01987 <span class="comment">//</span>
01988 <span class="comment">//. .       // print out vbn, lbn, and count</span>
01989 <span class="comment">//</span>
01990 <span class="comment">//. .       }</span>
01991 
01992 Arguments:
01993 
01994     OpaqueMcb - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Mcb being examined.
01995 
01996     RunIndex - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> index of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> run (zero based) to <span class="keywordflow">return</span> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01997         caller.
01998 
01999     Vbn - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting Vbn of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned run, or zero <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02000         run does not exist.
02001 
02002     Lbn - Recieves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting Lbn of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned run, or zero <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02003         run does not exist.
02004 
02005     SectorCount - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of sectors within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned run,
02006         or zero <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> run does not exist.
02007 
02008 Return Value:
02009 
02010     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified run (i.e., RunIndex) exists in the Mcb,
02011         and FALSE otherwise.  If FALSE is returned then the Vbn, Lbn, and
02012         SectorCount parameters receive zero.
02013 
02014 --*/
02015 
02016 {
02017     <a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html">PNONOPAQUE_MCB</a> Mcb = (<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html">PNONOPAQUE_MCB</a>)OpaqueMcb;
02018 
02019     BOOLEAN Result;
02020 
02021     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02022 
02023     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlGetNextLargeMcbEntry, Mcb = %08lx\n"</span>, Mcb );
02024     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">" RunIndex = %08lx\n"</span>, RunIndex );
02025 
02026     ExAcquireFastMutex( Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o0">FastMutex</a> );
02027 
02028     <span class="keywordflow">try</span> {
02029 
02030         <span class="comment">//</span>
02031         <span class="comment">//  Make sure the run index is within range</span>
02032         <span class="comment">//</span>
02033 
02034         <span class="keywordflow">if</span> (RunIndex &gt;= Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o2">PairCount</a>) {
02035 
02036             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a> (Result = FALSE);
02037         }
02038 
02039         <span class="comment">//</span>
02040         <span class="comment">//  Set the return variables</span>
02041         <span class="comment">//</span>
02042 
02043         *((PULONG)LargeVbn) = <a class="code" href="../../d1/d1/largemcb_8c.html#a4">StartingVbn</a>(Mcb,RunIndex);
02044         *((PULONG)LargeLbn) = <a class="code" href="../../d1/d1/largemcb_8c.html#a8">StartingLbn</a>(Mcb,RunIndex);
02045         *((PULONG)LargeSectorCount) = <a class="code" href="../../d1/d1/largemcb_8c.html#a11">SectorsWithinRun</a>(Mcb,RunIndex);
02046 
02047         Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02048 
02049     try_exit: NOTHING;
02050     } finally {
02051 
02052         ExReleaseFastMutex( Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o0">FastMutex</a> );
02053 
02054         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlGetNextLargeMcbEntry -&gt; %08lx\n"</span>, Result );
02055     }
02056 
02057     ((PLARGE_INTEGER)LargeVbn)-&gt;HighPart = (*((PULONG)LargeVbn) == <a class="code" href="../../d1/d1/largemcb_8c.html#a1">UNUSED_LBN</a> ? <a class="code" href="../../d1/d1/largemcb_8c.html#a1">UNUSED_LBN</a> : 0);
02058     ((PLARGE_INTEGER)LargeLbn)-&gt;HighPart = (*((PULONG)LargeLbn) == <a class="code" href="../../d1/d1/largemcb_8c.html#a1">UNUSED_LBN</a> ? <a class="code" href="../../d1/d1/largemcb_8c.html#a1">UNUSED_LBN</a> : 0);
02059     ((PLARGE_INTEGER)LargeSectorCount)-&gt;HighPart = 0;
02060 
02061     <span class="keywordflow">return</span> Result;
02062 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a159" doxytag="fsrtl.h::FsRtlGetNextMcbEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlGetNextMcbEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d7/struct__MCB.html">PMCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Mcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>RunIndex</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d1/d8/fsrtl_8h.html#a53">PVBN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d1/d8/fsrtl_8h.html#a51">PLBN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SectorCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00490">490</a> of file <a class="el" href="../../d2/d0/largemcb_8c-source.html">largemcb.c</a>.
<p>
References <a class="el" href="../../d2/d0/largemcb_8c-source.html#l01970">FsRtlGetNextLargeMcbEntry()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
<pre class="fragment"><div>00498 {
00499     BOOLEAN Results;
00500     LONGLONG LiVbn;
00501     LONGLONG LiLbn;
00502     LONGLONG LiSectorCount;
00503 
00504     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00505 
00506     Results = <a class="code" href="../../d1/d8/fsrtl_8h.html#a149">FsRtlGetNextLargeMcbEntry</a>( (<a class="code" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a>)Mcb,
00507                                          RunIndex,
00508                                          &amp;LiVbn,
00509                                          &amp;LiLbn,
00510                                          &amp;LiSectorCount );
00511 
00512     *Vbn = ((ULONG)LiVbn);
00513     *Lbn = (((ULONG)LiLbn) == -1 ? 0 : ((ULONG)LiLbn));
00514     *SectorCount = ((ULONG)LiSectorCount);
00515 
00516     <span class="keywordflow">return</span> Results;
00517 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a114" doxytag="fsrtl.h::FsRtlInitializeFileLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlInitializeFileLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileLock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a65">PCOMPLETE_LOCK_IRP_ROUTINE</a> CompleteLockIrpRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a66">PUNLOCK_ROUTINE</a> UnlockRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00829">829</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00596">PUNLOCK_ROUTINE</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l01141">FsRtlAllocateFileLock()</a>.
<p>
<pre class="fragment"><div>00837                    :
00838 
00839     This routine initializes a <span class="keyword">new</span> <a class="code" href="../../d7/d1/struct__FILE__LOCK.html">FILE_LOCK</a> structure.  The caller must
00840     supply <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure.  This call must precede all other
00841     calls that utilize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/struct__FILE__LOCK.html">FILE_LOCK</a> variable.
00842 
00843 Arguments:
00844 
00845     FileLock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/struct__FILE__LOCK.html">FILE_LOCK</a> structure to
00846         initialize.
00847 
00848     CompleteLockIrpRoutine - Optionally supplies an alternate routine to
00849         call <span class="keywordflow">for</span> completing IRPs.  <a class="code" href="../../d5/d3/filelock_8c.html#a66">FsRtlProcessFileLock</a> by <span class="keywordflow">default</span> will
00850         call <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a> to finish up an <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>; however <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
00851         want to process <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> completion itself then <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> needs to specify
00852         a completion routine here.  This routine will then be called in
00853         place of <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>.
00854 
00855     UnlockRoutine - Optionally supplies a routine to call when removing
00856         a lock.
00857 
00858 Return Value:
00859 
00860     None.
00861 
00862 --*/
00863 
00864 {
00865     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlInitializeFileLock, FileLock = %08lx\n"</span>, FileLock);
00866 
00867     <span class="comment">//</span>
00868     <span class="comment">// Clear non-paged pool pointer</span>
00869     <span class="comment">//</span>
00870 
00871     FileLock-&gt;LockInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00872     FileLock-&gt;CompleteLockIrpRoutine = CompleteLockIrpRoutine;
00873     FileLock-&gt;UnlockRoutine = UnlockRoutine;
00874 
00875     FileLock-&gt;FastIoIsQuestionable = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00876 
00877     <span class="comment">//</span>
00878     <span class="comment">//  and return to our caller</span>
00879     <span class="comment">//</span>
00880 
00881     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlInitializeFileLock -&gt; VOID\n"</span>, 0 );
00882 
00883     <span class="keywordflow">return</span>;
00884 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a139" doxytag="fsrtl.h::FsRtlInitializeLargeMcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlInitializeLargeMcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Mcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00572">572</a> of file <a class="el" href="../../d2/d0/largemcb_8c-source.html">largemcb.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00367">ExInitializeFastMutex</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00158">_NONOPAQUE_MCB::FastMutex</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00295">FsRtlAllocateFastMutex</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00289">FsRtlAllocateFirstMapping</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00298">FsRtlFreeFastMutex</a>, <a class="el" href="../../d4/d7/fsrtlp_8h-source.html#l00040">FsRtlpAllocatePool</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00313">INITIAL_MAXIMUM_PAIR_COUNT</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00162">_NONOPAQUE_MCB::Mapping</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00159">_NONOPAQUE_MCB::MaximumPairCount</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00160">_NONOPAQUE_MCB::PairCount</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00164">PNONOPAQUE_MCB</a>, and <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00161">_NONOPAQUE_MCB::PoolType</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00334">FsRtlInitializeMcb()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00181">UdfInitializeFcbMcb()</a>, and <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01406">UdfLoadSparingTables()</a>.
<p>
<pre class="fragment"><div>00579                    :
00580 
00581     This routine initializes a <span class="keyword">new</span> Mcb structure.  The caller must
00582     supply <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Mcb structure.  This call must precede all
00583     other calls that set/query <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Mcb structure.
00584 
00585     If <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not available <span class="keyword">this</span> routine will raise a status value
00586     indicating insufficient resources.
00587 
00588 Arguments:
00589 
00590     OpaqueMcb - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Mcb structure to initialize.
00591 
00592     PoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> to use when allocating additional
00593         internal Mcb memory.
00594 
00595 Return Value:
00596 
00597     None.
00598 
00599 --*/
00600 
00601 {
00602     <a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html">PNONOPAQUE_MCB</a> Mcb = (<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html">PNONOPAQUE_MCB</a>)OpaqueMcb;
00603 
00604     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlInitializeLargeMcb, Mcb = %08lx\n"</span>, Mcb );
00605 
00606     <span class="comment">//</span>
00607     <span class="comment">//  Preset the following fields to null so we know to deallocate them</span>
00608     <span class="comment">//  during an abnormal termination</span>
00609     <span class="comment">//</span>
00610 
00611     Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o0">FastMutex</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00612     Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00613 
00614     <span class="keywordflow">try</span> {
00615 
00616         <span class="comment">//</span>
00617         <span class="comment">//  Initialize the fields in the Mcb</span>
00618         <span class="comment">//</span>
00619 
00620         Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o0">FastMutex</a> = <a class="code" href="../../d1/d1/largemcb_8c.html#a15">FsRtlAllocateFastMutex</a>();
00621 
00622         <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>( Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o0">FastMutex</a> );
00623 
00624         Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o2">PairCount</a> = 0;
00625         Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o3">PoolType</a> = PoolType;
00626 
00627         <span class="comment">//</span>
00628         <span class="comment">//  Allocate a new buffer an initial size is one that will hold</span>
00629         <span class="comment">//  16 runs</span>
00630         <span class="comment">//</span>
00631 
00632         <span class="keywordflow">if</span> (PoolType == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
00633 
00634             Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a> = <a class="code" href="../../d1/d1/largemcb_8c.html#a13">FsRtlAllocateFirstMapping</a>();
00635 
00636         } <span class="keywordflow">else</span> {
00637 
00638             Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a> = <a class="code" href="../../d3/d8/fsrtlp_8h.html#a2">FsRtlpAllocatePool</a>( Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o3">PoolType</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d6/struct__MAPPING.html">MAPPING</a>) * INITIAL_MAXIMUM_PAIR_COUNT );
00639         }
00640 
00641         <span class="comment">//**** RtlZeroMemory( Mcb-&gt;Mapping, sizeof(MAPPING) * INITIAL_MAXIMUM_PAIR_COUNT );</span>
00642 
00643         Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o1">MaximumPairCount</a> = <a class="code" href="../../d1/d1/largemcb_8c.html#a17">INITIAL_MAXIMUM_PAIR_COUNT</a>;
00644 
00645     } finally {
00646 
00647         <span class="comment">//</span>
00648         <span class="comment">//  If this is an abnormal termination then we need to deallocate</span>
00649         <span class="comment">//  the FastMutex and/or mapping (but once the mapping is allocated,</span>
00650         <span class="comment">//  we can't raise).</span>
00651         <span class="comment">//</span>
00652 
00653         <span class="keywordflow">if</span> (AbnormalTermination()) {
00654 
00655             <span class="keywordflow">if</span> (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o0">FastMutex</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) { <a class="code" href="../../d1/d1/largemcb_8c.html#a16">FsRtlFreeFastMutex</a>( Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o0">FastMutex</a> ); }
00656         }
00657 
00658         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlInitializeLargeMcb -&gt; VOID\n"</span>, 0 );
00659     }
00660 
00661     <span class="comment">//</span>
00662     <span class="comment">//  And return to our caller</span>
00663     <span class="comment">//</span>
00664 
00665     <span class="keywordflow">return</span>;
00666 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a151" doxytag="fsrtl.h::FsRtlInitializeMcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlInitializeMcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d7/struct__MCB.html">PMCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Mcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00334">334</a> of file <a class="el" href="../../d2/d0/largemcb_8c-source.html">largemcb.c</a>.
<p>
References <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00572">FsRtlInitializeLargeMcb()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00219">UdfInitializeVmcb()</a>.
<p>
<pre class="fragment"><div>00338 {
00339     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00340 
00341     <a class="code" href="../../d1/d8/fsrtl_8h.html#a139">FsRtlInitializeLargeMcb</a>( (<a class="code" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a>)Mcb,
00342                              PoolType );
00343 
00344     <span class="keywordflow">return</span>;
00345 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a162" doxytag="fsrtl.h::FsRtlInitializeOplock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlInitializeOplock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d1/d8/fsrtl_8h.html#a78">POPLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Oplock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00373">373</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
<pre class="fragment"><div>00379                    :
00380 
00381     This routine initializes a <span class="keyword">new</span> <a class="code" href="../../d1/d8/fsrtl_8h.html#a77">OPLOCK</a> structure.  This call must
00382     precede any other call to <span class="keyword">this</span> entry point with <span class="keyword">this</span> <a class="code" href="../../d1/d8/fsrtl_8h.html#a77">OPLOCK</a>
00383     structure.  In addition, <span class="keyword">this</span> routine will have exclusive access
00384     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Oplock structure.
00385 
00386 Arguments:
00387 
00388     Oplock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of an opaque <a class="code" href="../../d1/d8/fsrtl_8h.html#a77">OPLOCK</a> structure.
00389 
00390 Return Value:
00391 
00392     None.
00393 
00394 --*/
00395 
00396 {
00397     UNREFERENCED_PARAMETER( Oplock );
00398 
00399     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00400 
00401     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlInitializeOplock:  Oplock -&gt; %08lx\n"</span>, *Oplock );
00402 
00403     <span class="comment">//</span>
00404     <span class="comment">//  No action is taken at this time.</span>
00405     <span class="comment">//</span>
00406 
00407     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlInitializeOplock:  Exit\n"</span>, 0);
00408     <span class="keywordflow">return</span>;
00409 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a126" doxytag="fsrtl.h::FsRtlInitializeTunnelCache" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlInitializeTunnelCache           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d1/structTUNNEL.html">TUNNEL</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Cache</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a92" doxytag="fsrtl.h::FsRtlInitSystem" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlInitSystem           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/fsrtlpc_8c-source.html#l00215">215</a> of file <a class="el" href="../../d5/d7/fsrtlpc_8c-source.html">fsrtlpc.c</a>.
<p>
References <a class="el" href="../../d5/d7/fsrtlpc_8c-source.html#l00024">COMPATIBILITY_MODE_VALUE_NAME</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02473">ExInitializeResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/fsrtlpc_8c-source.html#l00057">FSRTL_NUMBER_OF_RESOURCES</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00120">FsRtlAllocatePool</a>, <a class="el" href="../../d5/d7/fsrtlpc_8c-source.html#l00323">FsRtlGetCompatibilityModeValue()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00744">FsRtlInitializeFileLocks()</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00521">FsRtlInitializeLargeMcbs()</a>, <a class="el" href="../../d2/d6/tunnel_8c-source.html#l00382">FsRtlInitializeTunnels()</a>, <a class="el" href="../../d5/d4/stackovf_8c-source.html#l00099">FsRtlInitializeWorkerThread()</a>, <a class="el" href="../../d5/d7/fsrtlpc_8c-source.html#l00059">FsRtlPagingIoResources</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00094">FsRtlpUncSemaphore</a>, <a class="el" href="../../d5/d7/fsrtlpc_8c-source.html#l00062">FsRtlSafeExtensions</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00039">KeInitializeSemaphore()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
<pre class="fragment"><div>00217 {
00218     ULONG i;
00219 
00220     ULONG Value;
00221     UNICODE_STRING <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
00222 
00223     <span class="keyword">extern</span> <a class="code" href="../../d8/d7/struct__KSEMAPHORE.html">KSEMAPHORE</a> <a class="code" href="../../d5/d9/unc_8c.html#a11">FsRtlpUncSemaphore</a>;
00224 
00225     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00226 
00227     <span class="comment">//</span>
00228     <span class="comment">//  Allocate and initialize all the paging Io resources</span>
00229     <span class="comment">//</span>
00230 
00231     <a class="code" href="../../d4/d8/fsrtlpc_8c.html#a9">FsRtlPagingIoResources</a> = <a class="code" href="../../d5/d5/cc_8h.html#a8">FsRtlAllocatePool</a>( NonPagedPool,
00232                                                 FSRTL_NUMBER_OF_RESOURCES *
00233                                                 <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a>) );
00234 
00235     <span class="keywordflow">for</span> (i=0; i &lt; <a class="code" href="../../d4/d8/fsrtlpc_8c.html#a3">FSRTL_NUMBER_OF_RESOURCES</a>; i++) {
00236 
00237         <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a>( &amp;FsRtlPagingIoResources[i] );
00238     }
00239 
00240     <span class="comment">//</span>
00241     <span class="comment">//  Initialize the global tunneling structures.</span>
00242     <span class="comment">//</span>
00243 
00244     <a class="code" href="../../d1/d7/tunnel_8c.html#a19">FsRtlInitializeTunnels</a>();
00245 
00246     <span class="comment">//</span>
00247     <span class="comment">//  Initialize the global filelock structures.</span>
00248     <span class="comment">//</span>
00249 
00250     <a class="code" href="../../d3/d8/fsrtlp_8h.html#a25">FsRtlInitializeFileLocks</a>();
00251 
00252     <span class="comment">//</span>
00253     <span class="comment">//  Initialize the global largemcb structures.</span>
00254     <span class="comment">//</span>
00255 
00256     <a class="code" href="../../d1/d1/largemcb_8c.html#a37">FsRtlInitializeLargeMcbs</a>();
00257 
00258     <span class="comment">//</span>
00259     <span class="comment">// Initialize the semaphore used to guard loading of the MUP</span>
00260     <span class="comment">//</span>
00261 
00262     <a class="code" href="../../d1/d6/semphobj_8c.html#a1">KeInitializeSemaphore</a>( &amp;FsRtlpUncSemaphore, 1, MAXLONG );
00263 
00264     <span class="comment">//</span>
00265     <span class="comment">// Pull the bit from the registry telling us whether to do a safe</span>
00266     <span class="comment">// or dangerous extension truncation.</span>
00267     <span class="comment">//</span>
00268 
00269     <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>.Buffer = <a class="code" href="../../d4/d8/fsrtlpc_8c.html#a1">COMPATIBILITY_MODE_VALUE_NAME</a>;
00270     <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>.Length = <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/fsrtlpc_8c.html#a1">COMPATIBILITY_MODE_VALUE_NAME</a>) - <span class="keyword">sizeof</span>(WCHAR);
00271     <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>.MaximumLength = <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/fsrtlpc_8c.html#a1">COMPATIBILITY_MODE_VALUE_NAME</a>);
00272 
00273     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d4/d8/fsrtlpc_8c.html#a14">FsRtlGetCompatibilityModeValue</a>( &amp;ValueName, &amp;Value )) &amp;&amp;
00274         (Value != 0)) {
00275 
00276         <a class="code" href="../../d4/d8/fsrtlpc_8c.html#a11">FsRtlSafeExtensions</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00277     }
00278 
00279     <span class="comment">//</span>
00280     <span class="comment">// Initialize the FsRtl stack overflow work QueueObject and thread.</span>
00281     <span class="comment">//</span>
00282 
00283     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d4/d5/stackovf_8c.html#a7">FsRtlInitializeWorkerThread</a>())) {
00284 
00285         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00286     }
00287 
00288     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00289 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a184" doxytag="fsrtl.h::FsRtlInsertFilterContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI NTSTATUS FsRtlInsertFilterContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">PFSRTL_FILTER_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Ptr</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/filtrctx_8c-source.html#l00058">58</a> of file <a class="el" href="../../d0/d3/filtrctx_8c-source.html">filtrctx.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00265">FSRTL_FLAG2_SUPPORTS_FILTER_CONTEXTS</a>, <a class="el" href="../../d4/d2/dumpuser_8c-source.html#l00048">Header</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a85">PFSRTL_FILTER_CONTEXT</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00052">Ptr</a>.
<p>
<pre class="fragment"><div>00064                    :
00065 
00066     This routine associates filter driver context with a stream.
00067 
00068 Arguments:
00069 
00070     FileObject - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stream of interest.
00071 
00072     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a28">Ptr</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filter-specific context structure.
00073         The common header fields OwnerId and InstanceId should
00074         be filled in by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filter driver before calling.
00075 
00076 Return Value:
00077 
00078     STATUS_SUCCESS - operation succeeded.
00079 
00080     STATUS_INVALID_DEVICE_REQUEST - underlying filesystem does not support
00081         filter contexts.
00082 
00083 --*/
00084 
00085 {
00086     <a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a>  <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
00087 
00088     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FileObject);
00089     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FileObject-&gt;FsContext);
00090 
00091     <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = FileObject-&gt;FsContext;
00092 
00093     <span class="keywordflow">if</span> (! (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Flags2 &amp; <a class="code" href="../../d1/d8/fsrtl_8h.html#a9">FSRTL_FLAG2_SUPPORTS_FILTER_CONTEXTS</a>) ) {
00094         <span class="keywordflow">return</span> STATUS_INVALID_DEVICE_REQUEST;
00095     }
00096 
00097     ExAcquireFastMutex (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FastMutex);
00098 
00099     InsertHeadList (&amp;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FilterContexts, &amp;<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a28">Ptr</a>-&gt;Links);
00100 
00101     ExReleaseFastMutex(<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FastMutex);
00102     <span class="keywordflow">return</span> STATUS_SUCCESS;
00103 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a133" doxytag="fsrtl.h::FsRtlIsDbcsInExpression" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlIsDbcsInExpression           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PANSI_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Expression</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PANSI_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Name</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/dbcsname_8c-source.html#l00771">771</a> of file <a class="el" href="../../d2/d2/dbcsname_8c-source.html">dbcsname.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d2/dbcsname_8c-source.html#l00694">FsRtlDoesDbcsContainWildCards()</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01033">FsRtlIsLeadDbcsCharacter</a>, <a class="el" href="../../d4/d7/fsrtlp_8h-source.html#l00040">FsRtlpAllocatePool</a>, <a class="el" href="../../d2/d2/dbcsname_8c-source.html#l00757">GetDbcs</a>, <a class="el" href="../../d2/d2/dbcsname_8c-source.html#l00768">MATCHES_ARRAY_SIZE</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d6/d8/gen8dot3_8c-source.html#l00032">NlsMbOemCodePageTag</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>00778                    :
00779 
00780     This routine compares a Dbcs name and an expression and tells <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
00781     <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> language defined by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> expression.  The input name
00782     cannot contain wildcards, <span class="keywordflow">while</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> expression may contain wildcards.
00783 
00784     Expression wild cards are evaluated as shown in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> nondeterministic
00785     finite automatons below.  Note that ~* and ~? are DOS_STAR and DOS_QM.
00786 
00787 
00788              ~* <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> DOS_STAR, ~? <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> DOS_QM, and ~. <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> DOS_DOT
00789 
00790 
00791                                        S
00792                                     &lt;-----&lt;
00793                                  X  |     |  e       Y
00794              X * Y ==       (0)-----&gt;-(1)-&gt;-----(2)-----(3)
00795 
00796 
00797                                       S-.
00798                                     &lt;-----&lt;
00799                                  X  |     |  e       Y
00800              X ~* Y ==      (0)-----&gt;-(1)-&gt;-----(2)-----(3)
00801 
00802 
00803 
00804                                 X     S     S     Y
00805              X ?? Y ==      (0)---(1)---(2)---(3)---(4)
00806 
00807 
00808 
00809                                 X     .        .      Y
00810              X ~.~. Y ==    (0)---(1)----(2)------(3)---(4)
00811                                    |      |________|
00812                                    |           ^   |
00813                                    |_______________|
00814                                       ^EOF or .^
00815 
00816 
00817                                 X     S-.     S-.     Y
00818              X ~?~? Y ==    (0)---(1)-----(2)-----(3)---(4)
00819                                    |      |________|
00820                                    |           ^   |
00821                                    |_______________|
00822                                       ^EOF or .^
00823 
00824 
00825 
00826          where S <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> any single character
00827 
00828                S-. <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> any single character except <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> .
00829 
00830                e <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a null character transition
00831 
00832                EOF <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name string
00833 
00834     In words:
00835 
00836         * matches 0 or more characters.
00837 
00838         ? matches exactly 1 character.
00839 
00840         DOS_STAR matches 0 or more characters until encountering and <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a>
00841             <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> . in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name.
00842 
00843         DOS_QM matches any single character, or upon encountering a period or
00844             end of name string, advances <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> expression to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00845             set of contiguous DOS_QMs.
00846 
00847         DOS_DOT matches either a . or zero characters beyond name string.
00848 
00849 Arguments:
00850 
00851     Expression - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input expression to check against
00852 
00853     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input name to check <span class="keywordflow">for</span>.
00854 
00855 Return Value:
00856 
00857     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an element in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> set of strings denoted
00858         by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input Expression and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00859 
00860 --*/
00861 
00862 {
00863     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> NameOffset;
00864     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> ExprOffset;
00865     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Length;
00866 
00867     ULONG SrcCount;
00868     ULONG DestCount;
00869     ULONG PreviousDestCount;
00870     ULONG MatchesCount;
00871 
00872     WCHAR NameChar, ExprChar;
00873 
00874     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> LocalBuffer[<a class="code" href="../../d1/d3/dbcsname_8c.html#a4">MATCHES_ARRAY_SIZE</a> * 2];
00875 
00876     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> *AuxBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00877     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> *PreviousMatches;
00878     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> *CurrentMatches;
00879 
00880     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> MaxState;
00881     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> CurrentState;
00882 
00883     BOOLEAN NameFinished = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00884 
00885     <span class="comment">//</span>
00886     <span class="comment">//  The idea behind the algorithm is pretty simple.  We keep track of</span>
00887     <span class="comment">//  all possible locations in the regular expression that are matching</span>
00888     <span class="comment">//  the name.  If when the name has been exhausted one of the locations</span>
00889     <span class="comment">//  in the expression is also just exhausted, the name is in the language</span>
00890     <span class="comment">//  defined by the regular expression.</span>
00891     <span class="comment">//</span>
00892 
00893     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00894 
00895     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlIsDbcsInExpression\n"</span>, 0);
00896     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">" Expression      = %Z\n"</span>, Expression );
00897     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">" Name            = %Z\n"</span>, Name );
00898 
00899     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length != 0 );
00900     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Expression-&gt;Length != 0 );
00901 
00902     <span class="comment">//</span>
00903     <span class="comment">//  If one string is empty return FALSE.  If both are empty return TRUE.</span>
00904     <span class="comment">//</span>
00905 
00906     <span class="keywordflow">if</span> ( (<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length == 0) || (Expression-&gt;Length == 0) ) {
00907 
00908         <span class="keywordflow">return</span> (BOOLEAN)(!(<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length + Expression-&gt;Length));
00909     }
00910 
00911     <span class="comment">//</span>
00912     <span class="comment">//  Special case by far the most common wild card search of *</span>
00913     <span class="comment">//</span>
00914 
00915     <span class="keywordflow">if</span> ((Expression-&gt;Length == 1) &amp;&amp; (Expression-&gt;Buffer[0] == <span class="charliteral">'*'</span>)) {
00916 
00917         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00918     }
00919 
00920     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d1/d8/fsrtl_8h.html#a132">FsRtlDoesDbcsContainWildCards</a>( Expression ) );
00921 
00922     <span class="comment">//</span>
00923     <span class="comment">//  Also special case expressions of the form *X.  With this and the prior</span>
00924     <span class="comment">//  case we have covered virtually all normal queries.</span>
00925     <span class="comment">//</span>
00926 
00927     <span class="keywordflow">if</span> (Expression-&gt;Buffer[0] == <span class="charliteral">'*'</span>) {
00928 
00929         ANSI_STRING LocalExpression;
00930 
00931         LocalExpression = *Expression;
00932 
00933         LocalExpression.Buffer += 1;
00934         LocalExpression.Length -= 1;
00935 
00936         <span class="comment">//</span>
00937         <span class="comment">//  Only special case an expression with a single *</span>
00938         <span class="comment">//</span>
00939 
00940         <span class="keywordflow">if</span> ( !<a class="code" href="../../d1/d8/fsrtl_8h.html#a132">FsRtlDoesDbcsContainWildCards</a>( &amp;LocalExpression ) ) {
00941 
00942             ULONG StartingNameOffset;
00943 
00944             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length &lt; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(Expression-&gt;Length - 1)) {
00945 
00946                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00947             }
00948 
00949             StartingNameOffset = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length - LocalExpression.Length;
00950 
00951             <span class="comment">//</span>
00952             <span class="comment">//  FsRtlIsDbcsInExpression(): bug fix "expression[0] == *" case</span>
00953             <span class="comment">//</span>
00954             <span class="comment">//  StatingNameOffset must not bisect DBCS characters.</span>
00955             <span class="comment">//</span>
00956 
00957             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9/gen8dot3_8c.html#a5">NlsMbOemCodePageTag</a>) {
00958 
00959                 ULONG i = 0;
00960 
00961                 <span class="keywordflow">while</span> ( i &lt; StartingNameOffset ) {
00962 
00963                     i += <a class="code" href="../../d1/d8/fsrtl_8h.html#a36">FsRtlIsLeadDbcsCharacter</a>( <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[i] ) ? 2 : 1;
00964                 }
00965 
00966                 <span class="keywordflow">if</span> ( i &gt; StartingNameOffset ) {
00967 
00968                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00969                 }
00970             }
00971 
00972             <span class="comment">//</span>
00973             <span class="comment">//  Do a simple memory compare if case sensitive, otherwise</span>
00974             <span class="comment">//  we have got to check this one character at a time.</span>
00975             <span class="comment">//</span>
00976 
00977             <span class="keywordflow">return</span> (BOOLEAN) RtlEqualMemory( LocalExpression.Buffer,
00978                                              <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer + StartingNameOffset,
00979                                              LocalExpression.Length );
00980         }
00981     }
00982 
00983     <span class="comment">//</span>
00984     <span class="comment">//  Walk through the name string, picking off characters.  We go one</span>
00985     <span class="comment">//  character beyond the end because some wild cards are able to match</span>
00986     <span class="comment">//  zero characters beyond the end of the string.</span>
00987     <span class="comment">//</span>
00988     <span class="comment">//  With each new name character we determine a new set of states that</span>
00989     <span class="comment">//  match the name so far.  We use two arrays that we swap back and forth</span>
00990     <span class="comment">//  for this purpose.  One array lists the possible expression states for</span>
00991     <span class="comment">//  all name characters up to but not including the current one, and other</span>
00992     <span class="comment">//  array is used to build up the list of states considering the current</span>
00993     <span class="comment">//  name character as well.  The arrays are then switched and the process</span>
00994     <span class="comment">//  repeated.</span>
00995     <span class="comment">//</span>
00996     <span class="comment">//  There is not a one-to-one correspondence between state number and</span>
00997     <span class="comment">//  offset into the expression.  This is evident from the NFAs in the</span>
00998     <span class="comment">//  initial comment to this function.  State numbering is not continuous.</span>
00999     <span class="comment">//  This allows a simple conversion between state number and expression</span>
01000     <span class="comment">//  offset.  Each character in the expression can represent one or two</span>
01001     <span class="comment">//  states.  * and DOS_STAR generate two states: ExprOffset*2 and</span>
01002     <span class="comment">//  ExprOffset*2 + 1.  All other expreesion characters can produce only</span>
01003     <span class="comment">//  a single state.  Thus ExprOffset = State/2.</span>
01004     <span class="comment">//</span>
01005     <span class="comment">//</span>
01006     <span class="comment">//  Here is a short description of the variables involved:</span>
01007     <span class="comment">//</span>
01008     <span class="comment">//  NameOffset  - The offset of the current name char being processed.</span>
01009     <span class="comment">//</span>
01010     <span class="comment">//  ExprOffset  - The offset of the current expression char being processed.</span>
01011     <span class="comment">//</span>
01012     <span class="comment">//  SrcCount    - Prior match being investigated with current name char</span>
01013     <span class="comment">//</span>
01014     <span class="comment">//  DestCount   - Next location to put a matching assuming current name char</span>
01015     <span class="comment">//</span>
01016     <span class="comment">//  NameFinished - Allows one more itteration through the Matches array</span>
01017     <span class="comment">//                 after the name is exhusted (to come *s for example)</span>
01018     <span class="comment">//</span>
01019     <span class="comment">//  PreviousDestCount - This is used to prevent entry duplication, see coment</span>
01020     <span class="comment">//</span>
01021     <span class="comment">//  PreviousMatches   - Holds the previous set of matches (the Src array)</span>
01022     <span class="comment">//</span>
01023     <span class="comment">//  CurrentMatches    - Holds the current set of matches (the Dest array)</span>
01024     <span class="comment">//</span>
01025     <span class="comment">//  AuxBuffer, LocalBuffer - the storage for the Matches arrays</span>
01026     <span class="comment">//</span>
01027 
01028     <span class="comment">//</span>
01029     <span class="comment">//  Set up the initial variables</span>
01030     <span class="comment">//</span>
01031 
01032     PreviousMatches = &amp;LocalBuffer[0];
01033     CurrentMatches = &amp;LocalBuffer[<a class="code" href="../../d1/d3/dbcsname_8c.html#a4">MATCHES_ARRAY_SIZE</a>];
01034 
01035     PreviousMatches[0] = 0;
01036     MatchesCount = 1;
01037 
01038     NameOffset = 0;
01039 
01040     MaxState = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(Expression-&gt;Length * 2);
01041 
01042     <span class="keywordflow">while</span> ( !NameFinished ) {
01043 
01044         <span class="keywordflow">if</span> ( NameOffset &lt; <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length ) {
01045 
01046             <a class="code" href="../../d1/d3/dbcsname_8c.html#a3">GetDbcs</a>( <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer, NameOffset, &amp;NameChar, &amp;Length );
01047             NameOffset += Length;
01048 
01049         } <span class="keywordflow">else</span> {
01050 
01051             NameFinished = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01052 
01053             <span class="comment">//</span>
01054             <span class="comment">//  if we have already exhasted the expression, cool.  Don't</span>
01055             <span class="comment">//  continue.</span>
01056             <span class="comment">//</span>
01057 
01058             <span class="keywordflow">if</span> ( PreviousMatches[MatchesCount-1] == MaxState ) {
01059 
01060                 <span class="keywordflow">break</span>;
01061             }
01062         }
01063 
01064 
01065         <span class="comment">//</span>
01066         <span class="comment">//  Now, for each of the previous stored expression matches, see what</span>
01067         <span class="comment">//  we can do with this name character.</span>
01068         <span class="comment">//</span>
01069 
01070         SrcCount = 0;
01071         DestCount = 0;
01072         PreviousDestCount = 0;
01073 
01074         <span class="keywordflow">while</span> ( SrcCount &lt; MatchesCount ) {
01075 
01076             <span class="comment">//</span>
01077             <span class="comment">//  We have to carry on our expression analysis as far as possible</span>
01078             <span class="comment">//  for each character of name, so we loop here until the</span>
01079             <span class="comment">//  expression stops matching.  A clue here is that expression</span>
01080             <span class="comment">//  cases that can match zero or more characters end with a</span>
01081             <span class="comment">//  continue, while those that can accept only a single character</span>
01082             <span class="comment">//  end with a break.</span>
01083             <span class="comment">//</span>
01084 
01085             ExprOffset = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((PreviousMatches[SrcCount++] + 1) / 2);
01086 
01087             Length = 0;
01088 
01089 
01090             <span class="keywordflow">while</span> ( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ) {
01091 
01092                 <span class="keywordflow">if</span> ( ExprOffset == Expression-&gt;Length ) {
01093 
01094                     <span class="keywordflow">break</span>;
01095                 }
01096 
01097                 <span class="comment">//</span>
01098                 <span class="comment">//  The first time through the loop we don't want</span>
01099                 <span class="comment">//  to increment ExprOffset.</span>
01100                 <span class="comment">//</span>
01101 
01102                 ExprOffset += Length;
01103 
01104                 CurrentState = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(ExprOffset * 2);
01105 
01106                 <span class="keywordflow">if</span> ( ExprOffset == Expression-&gt;Length ) {
01107 
01108                     CurrentMatches[DestCount++] = MaxState;
01109                     <span class="keywordflow">break</span>;
01110                 }
01111 
01112                 <a class="code" href="../../d1/d3/dbcsname_8c.html#a3">GetDbcs</a>(Expression-&gt;Buffer, ExprOffset, &amp;ExprChar, &amp;Length);
01113 
01114                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !((ExprChar &gt;= <span class="charliteral">'a'</span>) &amp;&amp; (ExprChar &lt;= <span class="charliteral">'z'</span>)) );
01115 
01116                 <span class="comment">//</span>
01117                 <span class="comment">//  Before we get started, we have to check for something</span>
01118                 <span class="comment">//  really gross.  We may be about to exhaust the local</span>
01119                 <span class="comment">//  space for ExpressionMatches[][], so we have to allocate</span>
01120                 <span class="comment">//  some pool if this is the case.  Yuk!</span>
01121                 <span class="comment">//</span>
01122 
01123                 <span class="keywordflow">if</span> ( (DestCount &gt;= <a class="code" href="../../d1/d3/dbcsname_8c.html#a4">MATCHES_ARRAY_SIZE</a> - 2) &amp;&amp;
01124                      (AuxBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
01125 
01126                     AuxBuffer = <a class="code" href="../../d3/d8/fsrtlp_8h.html#a2">FsRtlpAllocatePool</a>( PagedPool,
01127                                                     (Expression-&gt;Length+1) *
01128                                                     <span class="keyword">sizeof</span>(USHORT)*2*2 );
01129 
01130                     RtlCopyMemory( AuxBuffer,
01131                                    CurrentMatches,
01132                                    MATCHES_ARRAY_SIZE * <span class="keyword">sizeof</span>(USHORT) );
01133 
01134                     CurrentMatches = AuxBuffer;
01135 
01136                     RtlCopyMemory( AuxBuffer + (Expression-&gt;Length+1)*2,
01137                                    PreviousMatches,
01138                                    MATCHES_ARRAY_SIZE * <span class="keyword">sizeof</span>(USHORT) );
01139 
01140                     PreviousMatches = AuxBuffer + (Expression-&gt;Length+1)*2;
01141 
01142                 }
01143 
01144                 <span class="comment">//</span>
01145                 <span class="comment">//  * matches any character zero or more times.</span>
01146                 <span class="comment">//</span>
01147 
01148                 <span class="keywordflow">if</span> (ExprChar == <span class="charliteral">'*'</span>) {
01149 
01150                     CurrentMatches[DestCount++] = CurrentState;
01151                     CurrentMatches[DestCount++] = CurrentState + 1;
01152                     <span class="keywordflow">continue</span>;
01153                 }
01154 
01155                 <span class="comment">//</span>
01156                 <span class="comment">//  DOS_STAR matches any character except . zero or more times.</span>
01157                 <span class="comment">//</span>
01158 
01159                 <span class="keywordflow">if</span> (ExprChar == ANSI_DOS_STAR) {
01160 
01161                     BOOLEAN ICanEatADot = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01162 
01163                     <span class="comment">//</span>
01164                     <span class="comment">//  If we are at a period, determine if we are allowed to</span>
01165                     <span class="comment">//  consume it, ie. make sure it is not the last one.</span>
01166                     <span class="comment">//</span>
01167 
01168                     <span class="keywordflow">if</span> ( !NameFinished &amp;&amp; (NameChar == <span class="charliteral">'.'</span>) ) {
01169 
01170                         WCHAR NameChar;
01171                         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01172                         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Length;
01173 
01174                         <span class="keywordflow">for</span> ( <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = NameOffset;
01175                               <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &lt; <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length;
01176                               <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> += Length ) {
01177 
01178                             <a class="code" href="../../d1/d3/dbcsname_8c.html#a3">GetDbcs</a>( <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer, Offset, &amp;NameChar, &amp;Length );
01179 
01180                             <span class="keywordflow">if</span> (NameChar == <span class="charliteral">'.'</span>) {
01181 
01182                                 ICanEatADot = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01183                                 <span class="keywordflow">break</span>;
01184                             }
01185                         }
01186                     }
01187 
01188                     <span class="keywordflow">if</span> (NameFinished || (NameChar != <span class="charliteral">'.'</span>) || ICanEatADot) {
01189 
01190                         CurrentMatches[DestCount++] = CurrentState;
01191                         CurrentMatches[DestCount++] = CurrentState + 1;
01192                         <span class="keywordflow">continue</span>;
01193 
01194                     } <span class="keywordflow">else</span> {
01195 
01196                         <span class="comment">//</span>
01197                         <span class="comment">//  We are at a period.  We can only match zero</span>
01198                         <span class="comment">//  characters (ie. the epsilon transition).</span>
01199                         <span class="comment">//</span>
01200 
01201                         CurrentMatches[DestCount++] = CurrentState + 1;
01202                         <span class="keywordflow">continue</span>;
01203                     }
01204                 }
01205 
01206                 <span class="comment">//</span>
01207                 <span class="comment">//  The following expreesion characters all match by consuming</span>
01208                 <span class="comment">//  a character, thus force the expression, and thus state</span>
01209                 <span class="comment">//  forward.</span>
01210                 <span class="comment">//</span>
01211 
01212                 CurrentState += (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(Length * 2);
01213 
01214                 <span class="comment">//</span>
01215                 <span class="comment">//  DOS_QM is the most complicated.  If the name is finished,</span>
01216                 <span class="comment">//  we can match zero characters.  If this name is a '.', we</span>
01217                 <span class="comment">//  don't match, but look at the next expression.  Otherwise</span>
01218                 <span class="comment">//  we match a single character.</span>
01219                 <span class="comment">//</span>
01220 
01221                 <span class="keywordflow">if</span> ( ExprChar == ANSI_DOS_QM ) {
01222 
01223                     <span class="keywordflow">if</span> ( NameFinished || (NameChar == <span class="charliteral">'.'</span>) ) {
01224 
01225                         <span class="keywordflow">continue</span>;
01226                     }
01227 
01228                     CurrentMatches[DestCount++] = CurrentState;
01229                     <span class="keywordflow">break</span>;
01230                 }
01231 
01232                 <span class="comment">//</span>
01233                 <span class="comment">//  A DOS_DOT can match either a period, or zero characters</span>
01234                 <span class="comment">//  beyond the end of name.</span>
01235                 <span class="comment">//</span>
01236 
01237                 <span class="keywordflow">if</span> (ExprChar == DOS_DOT) {
01238 
01239                     <span class="keywordflow">if</span> ( NameFinished ) {
01240 
01241                         <span class="keywordflow">continue</span>;
01242                     }
01243 
01244                     <span class="keywordflow">if</span> (NameChar == <span class="charliteral">'.'</span>) {
01245 
01246                         CurrentMatches[DestCount++] = CurrentState;
01247                         <span class="keywordflow">break</span>;
01248                     }
01249                 }
01250 
01251                 <span class="comment">//</span>
01252                 <span class="comment">//  From this point on a name character is required to even</span>
01253                 <span class="comment">//  continue, let alone make a match.</span>
01254                 <span class="comment">//</span>
01255 
01256                 <span class="keywordflow">if</span> ( NameFinished ) {
01257 
01258                     <span class="keywordflow">break</span>;
01259                 }
01260 
01261                 <span class="comment">//</span>
01262                 <span class="comment">//  If this expression was a '?' we can match it once.</span>
01263                 <span class="comment">//</span>
01264 
01265                 <span class="keywordflow">if</span> (ExprChar == <span class="charliteral">'?'</span>) {
01266 
01267                     CurrentMatches[DestCount++] = CurrentState;
01268                     <span class="keywordflow">break</span>;
01269                 }
01270 
01271                 <span class="comment">//</span>
01272                 <span class="comment">//  Finally, check if the expression char matches the name char</span>
01273                 <span class="comment">//</span>
01274 
01275                 <span class="keywordflow">if</span> (ExprChar == NameChar) {
01276 
01277                     CurrentMatches[DestCount++] = CurrentState;
01278                     <span class="keywordflow">break</span>;
01279                 }
01280 
01281                 <span class="comment">//</span>
01282                 <span class="comment">//  The expression didn't match so go look at the next</span>
01283                 <span class="comment">//  previous match.</span>
01284                 <span class="comment">//</span>
01285 
01286                 <span class="keywordflow">break</span>;
01287             }
01288 
01289 
01290             <span class="comment">//</span>
01291             <span class="comment">//  Prevent duplication in the destination array.</span>
01292             <span class="comment">//</span>
01293             <span class="comment">//  Each of the arrays is montonically increasing and non-</span>
01294             <span class="comment">//  duplicating, thus we skip over any source element in the src</span>
01295             <span class="comment">//  array if we just added the same element to the destination</span>
01296             <span class="comment">//  array.  This guarentees non-duplication in the dest. array.</span>
01297             <span class="comment">//</span>
01298 
01299             <span class="keywordflow">if</span> ((SrcCount &lt; MatchesCount) &amp;&amp;
01300                 (PreviousDestCount &lt; DestCount) ) {
01301 
01302                 <span class="keywordflow">while</span> (PreviousDestCount &lt; DestCount) {
01303 
01304                     <span class="keywordflow">while</span> ( PreviousMatches[SrcCount] &lt;
01305                          CurrentMatches[PreviousDestCount] ) {
01306 
01307 
01308                         SrcCount += 1;
01309                     }
01310 
01311                     PreviousDestCount += 1;
01312                 }
01313             }
01314         }
01315 
01316         <span class="comment">//</span>
01317         <span class="comment">//  If we found no matches in the just finished itteration, it's time</span>
01318         <span class="comment">//  to bail.</span>
01319         <span class="comment">//</span>
01320 
01321         <span class="keywordflow">if</span> ( DestCount == 0 ) {
01322 
01323 
01324             <span class="keywordflow">if</span> (AuxBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) { <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( AuxBuffer ); }
01325 
01326             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01327         }
01328 
01329         <span class="comment">//</span>
01330         <span class="comment">//  Swap the meaning the two arrays</span>
01331         <span class="comment">//</span>
01332 
01333         {
01334             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> *Tmp;
01335 
01336             Tmp = PreviousMatches;
01337 
01338             PreviousMatches = CurrentMatches;
01339 
01340             CurrentMatches = Tmp;
01341         }
01342 
01343         MatchesCount = DestCount;
01344     }
01345 
01346 
01347     CurrentState = PreviousMatches[MatchesCount-1];
01348 
01349     <span class="keywordflow">if</span> (AuxBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) { <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( AuxBuffer ); }
01350 
01351 
01352     <span class="keywordflow">return</span> (BOOLEAN)(CurrentState == MaxState);
01353 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a134" doxytag="fsrtl.h::FsRtlIsFatDbcsLegal" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlIsFatDbcsLegal           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ANSI_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>DbcsName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>WildCardsPermissible</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>PathNamePermissible</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>LeadingBackslashPermissible</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/dbcsname_8c-source.html#l00081">81</a> of file <a class="el" href="../../d2/d2/dbcsname_8c-source.html">dbcsname.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d2/dbcsname_8c-source.html#l00542">FsRtlDissectDbcs()</a>, <a class="el" href="../../d2/d2/dbcsname_8c-source.html#l00694">FsRtlDoesDbcsContainWildCards()</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00954">FsRtlIsAnsiCharacterLegalFat</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01033">FsRtlIsLeadDbcsCharacter</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d4/namesup_8c-source.html#l00176">UdfIs8dot3Name()</a>.
<p>
<pre class="fragment"><div>00090                    :
00091 
00092     This routine simple returns whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> names conforms
00093     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system specific rules <span class="keywordflow">for</span> legal <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> names.  This routine
00094     will check <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> single name, or <span class="keywordflow">if</span> PathNamePermissible <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified as
00095     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> whole <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a legal name.
00096 
00097     For FAT, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following rules apply:
00098 
00099     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a>. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> Fat <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> name may not contain any of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following characters:
00100 
00101        0x00-0x1F <span class="stringliteral">" / : | + , ; = [ ]</span>
00102 <span class="stringliteral"></span>
00103 <span class="stringliteral">    B. A Fat file name is either of the form N.E or just N, where N is a</span>
00104 <span class="stringliteral">       string of 1-8 bytes and E is a string of 1-3 bytes conformant to</span>
00105 <span class="stringliteral">       rule A above. In addition, neither N nor E may contain a period</span>
00106 <span class="stringliteral">       character or end with a space character.</span>
00107 <span class="stringliteral"></span>
00108 <span class="stringliteral">       Incidently, N corresponds to name and E to extension.</span>
00109 <span class="stringliteral"></span>
00110 <span class="stringliteral">    Case: Lower case characters are taken as valid, but are up-shifted upon</span>
00111 <span class="stringliteral">          receipt, ie. Fat only deals with upper case file names.</span>
00112 <span class="stringliteral"></span>
00113 <span class="stringliteral">    For example, the files "</span>.foo<span class="stringliteral">", "</span><a class="code" href="../../d8/d7/udbgk_8c.html#a2">foo</a>.<span class="stringliteral">", and "</span>foo .b<span class="stringliteral">" are illegal, while</span>
00114 <span class="stringliteral">    "</span><a class="code" href="../../d8/d7/udbgk_8c.html#a2">foo</a>. b<span class="stringliteral">" and "</span> <a class="code" href="../../d0/d3/utxcpt2_8c.html#a5">bar</a><span class="stringliteral">" are legal.</span>
00115 <span class="stringliteral"></span>
00116 <span class="stringliteral">Arguments:</span>
00117 <span class="stringliteral"></span>
00118 <span class="stringliteral">    DbcsName - Supllies the name/path to check.</span>
00119 <span class="stringliteral"></span>
00120 <span class="stringliteral">    WildCardsPermissible - Specifies if Nt wild card characters are to be</span>
00121 <span class="stringliteral">        considered considered legal.</span>
00122 <span class="stringliteral"></span>
00123 <span class="stringliteral">    PathNamePermissible - Spcifes if Name may be a path name separated by</span>
00124 <span class="stringliteral">        backslash characters, or just a simple file name.</span>
00125 <span class="stringliteral"></span>
00126 <span class="stringliteral">    LeadingBackSlashPermissible - Specifies if a single leading backslash</span>
00127 <span class="stringliteral">        is permissible in the file/path name.</span>
00128 <span class="stringliteral"></span>
00129 <span class="stringliteral">Return Value:</span>
00130 <span class="stringliteral"></span>
00131 <span class="stringliteral">    BOOLEAN - TRUE if the name is legal, FALSE otherwise.</span>
00132 <span class="stringliteral"></span>
00133 <span class="stringliteral">--*/</span>
00134 <span class="stringliteral">{</span>
00135 <span class="stringliteral">    BOOLEAN ExtensionPresent = FALSE;</span>
00136 <span class="stringliteral"></span>
00137 <span class="stringliteral">    ULONG Index;</span>
00138 <span class="stringliteral"></span>
00139 <span class="stringliteral">    UCHAR Char;</span>
00140 <span class="stringliteral"></span>
00141 <span class="stringliteral">    PAGED_CODE();</span>
00142 <span class="stringliteral"></span>
00143 <span class="stringliteral">    //</span>
00144 <span class="stringliteral">    //  Empty names are not valid.</span>
00145 <span class="stringliteral">    //</span>
00146 <span class="stringliteral"></span>
00147 <span class="stringliteral">    if ( DbcsName.Length == 0 ) { return FALSE; }</span>
00148 <span class="stringliteral"></span>
00149 <span class="stringliteral">    //</span>
00150 <span class="stringliteral">    //  If Wild Cards are OK, then for directory enumeration to work</span>
00151 <span class="stringliteral">    //  correctly we have to accept . and ..</span>
00152 <span class="stringliteral">    //</span>
00153 <span class="stringliteral"></span>
00154 <span class="stringliteral">    if ( WildCardsPermissible &amp;&amp;</span>
00155 <span class="stringliteral">         ( ( (DbcsName.Length == 1) &amp;&amp;</span>
00156 <span class="stringliteral">             ((DbcsName.Buffer[0] == '.') ||</span>
00157 <span class="stringliteral">              (DbcsName.Buffer[0] == ANSI_DOS_DOT)) )</span>
00158 <span class="stringliteral">           ||</span>
00159 <span class="stringliteral">           ( (DbcsName.Length == 2) &amp;&amp;</span>
00160 <span class="stringliteral">             ( ((DbcsName.Buffer[0] == '.') &amp;&amp;</span>
00161 <span class="stringliteral">                (DbcsName.Buffer[1] == '.')) ||</span>
00162 <span class="stringliteral">               ((DbcsName.Buffer[0] == ANSI_DOS_DOT) &amp;&amp;</span>
00163 <span class="stringliteral">                (DbcsName.Buffer[1] == ANSI_DOS_DOT)) ) ) ) ) {</span>
00164 <span class="stringliteral"></span>
00165 <span class="stringliteral">        return TRUE;</span>
00166 <span class="stringliteral">    }</span>
00167 <span class="stringliteral"></span>
00168 <span class="stringliteral">    //</span>
00169 <span class="stringliteral">    //  If a leading \ is OK, skip over it (if there's more)</span>
00170 <span class="stringliteral">    //</span>
00171 <span class="stringliteral"></span>
00172 <span class="stringliteral">    if ( DbcsName.Buffer[0] == '\\' ) {</span>
00173 <span class="stringliteral"></span>
00174 <span class="stringliteral">        if ( LeadingBackslashPermissible ) {</span>
00175 <span class="stringliteral"></span>
00176 <span class="stringliteral">            if ( (DbcsName.Length &gt; 1) ) {</span>
00177 <span class="stringliteral"></span>
00178 <span class="stringliteral">                DbcsName.Buffer += 1;</span>
00179 <span class="stringliteral">                DbcsName.Length -= 1;</span>
00180 <span class="stringliteral"></span>
00181 <span class="stringliteral">            } else { return TRUE; }</span>
00182 <span class="stringliteral"></span>
00183 <span class="stringliteral">        } else { return FALSE; }</span>
00184 <span class="stringliteral">    }</span>
00185 <span class="stringliteral"></span>
00186 <span class="stringliteral">    //</span>
00187 <span class="stringliteral">    //  If we got a path name, check each componant.</span>
00188 <span class="stringliteral">    //</span>
00189 <span class="stringliteral"></span>
00190 <span class="stringliteral">    if ( PathNamePermissible ) {</span>
00191 <span class="stringliteral"></span>
00192 <span class="stringliteral">        ANSI_STRING FirstName;</span>
00193 <span class="stringliteral">        ANSI_STRING RemainingName;</span>
00194 <span class="stringliteral"></span>
00195 <span class="stringliteral">        RemainingName = DbcsName;</span>
00196 <span class="stringliteral"></span>
00197 <span class="stringliteral">        while ( RemainingName.Length != 0 ) {</span>
00198 <span class="stringliteral"></span>
00199 <span class="stringliteral">            //</span>
00200 <span class="stringliteral">            //  This will catch the case of an illegal double backslash.</span>
00201 <span class="stringliteral">            //</span>
00202 <span class="stringliteral"></span>
00203 <span class="stringliteral">            if ( RemainingName.Buffer[0] == '\\' ) { return FALSE; }</span>
00204 <span class="stringliteral"></span>
00205 <span class="stringliteral">            FsRtlDissectDbcs(RemainingName, &amp;FirstName, &amp;RemainingName);</span>
00206 <span class="stringliteral"></span>
00207 <span class="stringliteral">            if ( !FsRtlIsFatDbcsLegal( FirstName,</span>
00208 <span class="stringliteral">                                       WildCardsPermissible,</span>
00209 <span class="stringliteral">                                       FALSE,</span>
00210 <span class="stringliteral">                                       FALSE) ) {</span>
00211 <span class="stringliteral"></span>
00212 <span class="stringliteral">                return FALSE;</span>
00213 <span class="stringliteral">            }</span>
00214 <span class="stringliteral">        }</span>
00215 <span class="stringliteral"></span>
00216 <span class="stringliteral">        //</span>
00217 <span class="stringliteral">        //  All the componants were OK, so the path is OK.</span>
00218 <span class="stringliteral">        //</span>
00219 <span class="stringliteral"></span>
00220 <span class="stringliteral">        return TRUE;</span>
00221 <span class="stringliteral">    }</span>
00222 <span class="stringliteral"></span>
00223 <span class="stringliteral">    //</span>
00224 <span class="stringliteral">    //  If this name contains wild cards, just check for invalid characters.</span>
00225 <span class="stringliteral">    //</span>
00226 <span class="stringliteral"></span>
00227 <span class="stringliteral">    if ( WildCardsPermissible &amp;&amp; FsRtlDoesDbcsContainWildCards(&amp;DbcsName) ) {</span>
00228 <span class="stringliteral"></span>
00229 <span class="stringliteral">        for ( Index = 0; Index &lt; DbcsName.Length; Index += 1 ) {</span>
00230 <span class="stringliteral"></span>
00231 <span class="stringliteral">            Char = DbcsName.Buffer[ Index ];</span>
00232 <span class="stringliteral"></span>
00233 <span class="stringliteral">            //</span>
00234 <span class="stringliteral">            //  Skip over any Dbcs chacters</span>
00235 <span class="stringliteral">            //</span>
00236 <span class="stringliteral"></span>
00237 <span class="stringliteral">            if ( FsRtlIsLeadDbcsCharacter( Char ) ) {</span>
00238 <span class="stringliteral"></span>
00239 <span class="stringliteral">                ASSERT( Index != (ULONG)(DbcsName.Length - 1) );</span>
00240 <span class="stringliteral">                Index += 1;</span>
00241 <span class="stringliteral">                continue;</span>
00242 <span class="stringliteral">            }</span>
00243 <span class="stringliteral"></span>
00244 <span class="stringliteral">            //</span>
00245 <span class="stringliteral">            //  Make sure this character is legal, and if a wild card, that</span>
00246 <span class="stringliteral">            //  wild cards are permissible.</span>
00247 <span class="stringliteral">            //</span>
00248 <span class="stringliteral"></span>
00249 <span class="stringliteral">            if ( !FsRtlIsAnsiCharacterLegalFat(Char, WildCardsPermissible) ) {</span>
00250 <span class="stringliteral">                return FALSE;</span>
00251 <span class="stringliteral">            }</span>
00252 <span class="stringliteral">        }</span>
00253 <span class="stringliteral"></span>
00254 <span class="stringliteral">        return TRUE;</span>
00255 <span class="stringliteral">    }</span>
00256 <span class="stringliteral"></span>
00257 <span class="stringliteral"></span>
00258 <span class="stringliteral">    //</span>
00259 <span class="stringliteral">    //  At this point we should only have a single name, which can't have</span>
00260 <span class="stringliteral">    //  more than 12 characters (including a single period)</span>
00261 <span class="stringliteral">    //</span>
00262 <span class="stringliteral"></span>
00263 <span class="stringliteral">    if ( DbcsName.Length &gt; 12 ) { return FALSE; }</span>
00264 <span class="stringliteral"></span>
00265 <span class="stringliteral">    for ( Index = 0; Index &lt; DbcsName.Length; Index += 1 ) {</span>
00266 <span class="stringliteral"></span>
00267 <span class="stringliteral">        Char = DbcsName.Buffer[ Index ];</span>
00268 <span class="stringliteral"></span>
00269 <span class="stringliteral">        //</span>
00270 <span class="stringliteral">        //  Skip over and Dbcs chacters</span>
00271 <span class="stringliteral">        //</span>
00272 <span class="stringliteral"></span>
00273 <span class="stringliteral">        if ( FsRtlIsLeadDbcsCharacter( Char ) ) {</span>
00274 <span class="stringliteral"></span>
00275 <span class="stringliteral">            //</span>
00276 <span class="stringliteral">            //  FsRtlIsFatDbcsLegal(): fat name part and extension part dbcs check</span>
00277 <span class="stringliteral">            //</span>
00278 <span class="stringliteral">            //  1) if we're looking at base part ( !ExtensionPresent ) and the 8th byte</span>
00279 <span class="stringliteral">            //     is in the dbcs leading byte range, it's error ( Index == 7 ). If the</span>
00280 <span class="stringliteral">            //     length of base part is more than 8 ( Index &gt; 7 ), it's definitely error.</span>
00281 <span class="stringliteral">            //</span>
00282 <span class="stringliteral">            //  2) if the last byte ( Index == DbcsName.Length - 1 ) is in the dbcs leading</span>
00283 <span class="stringliteral">            //     byte range, it's error</span>
00284 <span class="stringliteral">            //</span>
00285 <span class="stringliteral"></span>
00286 <span class="stringliteral">            if ( (!ExtensionPresent &amp;&amp; (Index &gt;= 7)) ||</span>
00287 <span class="stringliteral">                 ( Index == (ULONG)(DbcsName.Length - 1) ) ) {</span>
00288 <span class="stringliteral">                return FALSE;</span>
00289 <span class="stringliteral">            }</span>
00290 <span class="stringliteral"></span>
00291 <span class="stringliteral">            Index += 1;</span>
00292 <span class="stringliteral"></span>
00293 <span class="stringliteral">            continue;</span>
00294 <span class="stringliteral">        }</span>
00295 <span class="stringliteral"></span>
00296 <span class="stringliteral">        //</span>
00297 <span class="stringliteral">        //  Make sure this character is legal, and if a wild card, that</span>
00298 <span class="stringliteral">        //  wild cards are permissible.</span>
00299 <span class="stringliteral">        //</span>
00300 <span class="stringliteral"></span>
00301 <span class="stringliteral">        if ( !FsRtlIsAnsiCharacterLegalFat(Char, WildCardsPermissible) ) {</span>
00302 <span class="stringliteral"></span>
00303 <span class="stringliteral">            return FALSE;</span>
00304 <span class="stringliteral">        }</span>
00305 <span class="stringliteral"></span>
00306 <span class="stringliteral">        if ( (Char == '.') || (Char == ANSI_DOS_DOT) ) {</span>
00307 <span class="stringliteral"></span>
00308 <span class="stringliteral">            //</span>
00309 <span class="stringliteral">            //  We stepped onto a period.  We require the following things:</span>
00310 <span class="stringliteral">            //</span>
00311 <span class="stringliteral">            //      - It can't be the first character</span>
00312 <span class="stringliteral">            //      - There can only be one</span>
00313 <span class="stringliteral">            //      - There can't be more than three characters following</span>
00314 <span class="stringliteral">            //      - The previous character can't be a space.</span>
00315 <span class="stringliteral">            //</span>
00316 <span class="stringliteral"></span>
00317 <span class="stringliteral">            if ( (Index == 0) ||</span>
00318 <span class="stringliteral">                 ExtensionPresent ||</span>
00319 <span class="stringliteral">                 (DbcsName.Length - (Index + 1) &gt; 3) ||</span>
00320 <span class="stringliteral">                 (DbcsName.Buffer[Index - 1] == ' ') ) {</span>
00321 <span class="stringliteral"></span>
00322 <span class="stringliteral">                return FALSE;</span>
00323 <span class="stringliteral">            }</span>
00324 <span class="stringliteral"></span>
00325 <span class="stringliteral">            ExtensionPresent = TRUE;</span>
00326 <span class="stringliteral">        }</span>
00327 <span class="stringliteral"></span>
00328 <span class="stringliteral">        //</span>
00329 <span class="stringliteral">        //  The base part of the name can't be more than 8 characters long.</span>
00330 <span class="stringliteral">        //</span>
00331 <span class="stringliteral"></span>
00332 <span class="stringliteral">        if ( (Index &gt;= 8) &amp;&amp; !ExtensionPresent ) { return FALSE; }</span>
00333 <span class="stringliteral">    }</span>
00334 <span class="stringliteral"></span>
00335 <span class="stringliteral">    //</span>
00336 <span class="stringliteral">    //  The name cannot end in a space or a period.</span>
00337 <span class="stringliteral">    //</span>
00338 <span class="stringliteral"></span>
00339 <span class="stringliteral">    if ( (Char == ' ') || (Char == '.') || (Char == ANSI_DOS_DOT)) { return FALSE; }</span>
00340 <span class="stringliteral"></span>
00341 <span class="stringliteral">    return TRUE;</span>
00342 <span class="stringliteral">}</span>
</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a135" doxytag="fsrtl.h::FsRtlIsHpfsDbcsLegal" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlIsHpfsDbcsLegal           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ANSI_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>DbcsName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>WildCardsPermissible</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>PathNamePermissible</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>LeadingBackslashPermissible</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/dbcsname_8c-source.html#l00345">345</a> of file <a class="el" href="../../d2/d2/dbcsname_8c-source.html">dbcsname.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d2/dbcsname_8c-source.html#l00542">FsRtlDissectDbcs()</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00962">FsRtlIsAnsiCharacterLegalHpfs</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01033">FsRtlIsLeadDbcsCharacter</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00354                    :
00355 
00356     This routine simple returns whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> names conforms
00357     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system specific rules <span class="keywordflow">for</span> legal <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> names.  This routine
00358     will check <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> single name, or <span class="keywordflow">if</span> PathNamePermissible <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified as
00359     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> whole <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a legal name.
00360 
00361     For HPFS, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following rules apply:
00362 
00363     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a>. An HPFS <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> name may not contain any of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following characters:
00364 
00365        0x0000 - 0x001F  <span class="stringliteral">" / : &lt; &gt; ? | *</span>
00366 <span class="stringliteral"></span>
00367 <span class="stringliteral">    B. An HPFS file name may not end in a period or a space.</span>
00368 <span class="stringliteral"></span>
00369 <span class="stringliteral">    C. An HPFS file name must contain no more than 255 bytes.</span>
00370 <span class="stringliteral"></span>
00371 <span class="stringliteral">    Case: HPFS is case preserving, but not case sensitive.  Case is</span>
00372 <span class="stringliteral">          preserved on creates, but not checked for on file name compares.</span>
00373 <span class="stringliteral"></span>
00374 <span class="stringliteral">    For example, the files "</span><a class="code" href="../../d8/d7/udbgk_8c.html#a2">foo</a> <span class="stringliteral">" and "</span><a class="code" href="../../d8/d7/udbgk_8c.html#a2">foo</a>.<span class="stringliteral">" are illegal, while "</span>.<a class="code" href="../../d8/d7/udbgk_8c.html#a2">foo</a><span class="stringliteral">",</span>
00375 <span class="stringliteral">    "</span> <a class="code" href="../../d8/d7/udbgk_8c.html#a2">foo</a><span class="stringliteral">" and "</span><a class="code" href="../../d8/d7/udbgk_8c.html#a2">foo</a>.bar.foo<span class="stringliteral">" are legal.</span>
00376 <span class="stringliteral"></span>
00377 <span class="stringliteral">Arguments:</span>
00378 <span class="stringliteral"></span>
00379 <span class="stringliteral">    DbcsName - Supllies the name/path to check.</span>
00380 <span class="stringliteral"></span>
00381 <span class="stringliteral">    WildCardsPermissible - Specifies if Nt wild card characters are to be</span>
00382 <span class="stringliteral">        considered considered legal.</span>
00383 <span class="stringliteral"></span>
00384 <span class="stringliteral">    PathNamePermissible - Spcifes if Name may be a path name separated by</span>
00385 <span class="stringliteral">        backslash characters, or just a simple file name.</span>
00386 <span class="stringliteral"></span>
00387 <span class="stringliteral">    LeadingBackSlashPermissible - Specifies if a single leading backslash</span>
00388 <span class="stringliteral">        is permissible in the file/path name.</span>
00389 <span class="stringliteral"></span>
00390 <span class="stringliteral">Return Value:</span>
00391 <span class="stringliteral"></span>
00392 <span class="stringliteral">    BOOLEAN - TRUE if the name is legal, FALSE otherwise.</span>
00393 <span class="stringliteral"></span>
00394 <span class="stringliteral">--*/</span>
00395 <span class="stringliteral">{</span>
00396 <span class="stringliteral">    BOOLEAN ExtensionPresent = FALSE;</span>
00397 <span class="stringliteral"></span>
00398 <span class="stringliteral">    ULONG Index;</span>
00399 <span class="stringliteral"></span>
00400 <span class="stringliteral">    UCHAR Char;</span>
00401 <span class="stringliteral"></span>
00402 <span class="stringliteral">    PAGED_CODE();</span>
00403 <span class="stringliteral"></span>
00404 <span class="stringliteral">    //</span>
00405 <span class="stringliteral">    //  Empty names are not valid.</span>
00406 <span class="stringliteral">    //</span>
00407 <span class="stringliteral"></span>
00408 <span class="stringliteral">    if ( DbcsName.Length == 0 ) { return FALSE; }</span>
00409 <span class="stringliteral"></span>
00410 <span class="stringliteral">    //</span>
00411 <span class="stringliteral">    //  If Wild Cards are OK, then for directory enumeration to work</span>
00412 <span class="stringliteral">    //  correctly we have to accept . and ..</span>
00413 <span class="stringliteral">    //</span>
00414 <span class="stringliteral"></span>
00415 <span class="stringliteral">    if ( WildCardsPermissible &amp;&amp;</span>
00416 <span class="stringliteral">         ( ( (DbcsName.Length == 1) &amp;&amp;</span>
00417 <span class="stringliteral">             ((DbcsName.Buffer[0] == '.') ||</span>
00418 <span class="stringliteral">              (DbcsName.Buffer[0] == ANSI_DOS_DOT)) )</span>
00419 <span class="stringliteral">           ||</span>
00420 <span class="stringliteral">           ( (DbcsName.Length == 2) &amp;&amp;</span>
00421 <span class="stringliteral">             ( ((DbcsName.Buffer[0] == '.') &amp;&amp;</span>
00422 <span class="stringliteral">                (DbcsName.Buffer[1] == '.')) ||</span>
00423 <span class="stringliteral">               ((DbcsName.Buffer[0] == ANSI_DOS_DOT) &amp;&amp;</span>
00424 <span class="stringliteral">                (DbcsName.Buffer[1] == ANSI_DOS_DOT)) ) ) ) ) {</span>
00425 <span class="stringliteral"></span>
00426 <span class="stringliteral">        return TRUE;</span>
00427 <span class="stringliteral">    }</span>
00428 <span class="stringliteral"></span>
00429 <span class="stringliteral">    //</span>
00430 <span class="stringliteral">    //  If a leading \ is OK, skip over it (if there's more)</span>
00431 <span class="stringliteral">    //</span>
00432 <span class="stringliteral"></span>
00433 <span class="stringliteral">    if ( DbcsName.Buffer[0] == '\\' ) {</span>
00434 <span class="stringliteral"></span>
00435 <span class="stringliteral">        if ( LeadingBackslashPermissible ) {</span>
00436 <span class="stringliteral"></span>
00437 <span class="stringliteral">            if ( (DbcsName.Length &gt; 1) ) {</span>
00438 <span class="stringliteral"></span>
00439 <span class="stringliteral">                DbcsName.Buffer += 1;</span>
00440 <span class="stringliteral">                DbcsName.Length -= 1;</span>
00441 <span class="stringliteral"></span>
00442 <span class="stringliteral">            } else { return TRUE; }</span>
00443 <span class="stringliteral"></span>
00444 <span class="stringliteral">        } else { return FALSE; }</span>
00445 <span class="stringliteral">    }</span>
00446 <span class="stringliteral"></span>
00447 <span class="stringliteral">    //</span>
00448 <span class="stringliteral">    //  If we got a path name, check each componant.</span>
00449 <span class="stringliteral">    //</span>
00450 <span class="stringliteral"></span>
00451 <span class="stringliteral">    if ( PathNamePermissible ) {</span>
00452 <span class="stringliteral"></span>
00453 <span class="stringliteral">        ANSI_STRING FirstName;</span>
00454 <span class="stringliteral">        ANSI_STRING RemainingName;</span>
00455 <span class="stringliteral"></span>
00456 <span class="stringliteral">        RemainingName = DbcsName;</span>
00457 <span class="stringliteral"></span>
00458 <span class="stringliteral">        while ( RemainingName.Length != 0 ) {</span>
00459 <span class="stringliteral"></span>
00460 <span class="stringliteral">            //</span>
00461 <span class="stringliteral">            //  This will catch the case of an illegal double backslash.</span>
00462 <span class="stringliteral">            //</span>
00463 <span class="stringliteral"></span>
00464 <span class="stringliteral">            if ( RemainingName.Buffer[0] == '\\' ) { return FALSE; }</span>
00465 <span class="stringliteral"></span>
00466 <span class="stringliteral">            FsRtlDissectDbcs(RemainingName, &amp;FirstName, &amp;RemainingName);</span>
00467 <span class="stringliteral"></span>
00468 <span class="stringliteral">            if ( !FsRtlIsHpfsDbcsLegal( FirstName,</span>
00469 <span class="stringliteral">                                       WildCardsPermissible,</span>
00470 <span class="stringliteral">                                       FALSE,</span>
00471 <span class="stringliteral">                                       FALSE) ) {</span>
00472 <span class="stringliteral"></span>
00473 <span class="stringliteral">                return FALSE;</span>
00474 <span class="stringliteral">            }</span>
00475 <span class="stringliteral">        }</span>
00476 <span class="stringliteral"></span>
00477 <span class="stringliteral">        //</span>
00478 <span class="stringliteral">        //  All the componants were OK, so the path is OK.</span>
00479 <span class="stringliteral">        //</span>
00480 <span class="stringliteral"></span>
00481 <span class="stringliteral">        return TRUE;</span>
00482 <span class="stringliteral">    }</span>
00483 <span class="stringliteral"></span>
00484 <span class="stringliteral">    //</span>
00485 <span class="stringliteral">    //  At this point we should only have a single name, which can't have</span>
00486 <span class="stringliteral">    //  more than 255 characters</span>
00487 <span class="stringliteral">    //</span>
00488 <span class="stringliteral"></span>
00489 <span class="stringliteral">    if ( DbcsName.Length &gt; 255 ) { return FALSE; }</span>
00490 <span class="stringliteral"></span>
00491 <span class="stringliteral">    for ( Index = 0; Index &lt; DbcsName.Length; Index += 1 ) {</span>
00492 <span class="stringliteral"></span>
00493 <span class="stringliteral">        Char = DbcsName.Buffer[ Index ];</span>
00494 <span class="stringliteral"></span>
00495 <span class="stringliteral">        //</span>
00496 <span class="stringliteral">        //  Skip over and Dbcs chacters</span>
00497 <span class="stringliteral">        //</span>
00498 <span class="stringliteral"></span>
00499 <span class="stringliteral">        if ( FsRtlIsLeadDbcsCharacter( Char ) ) {</span>
00500 <span class="stringliteral"></span>
00501 <span class="stringliteral">            //</span>
00502 <span class="stringliteral">            //  FsRtlIsHpfsDbcsLegal () hpfs dbcs check</span>
00503 <span class="stringliteral">            //</span>
00504 <span class="stringliteral">            //  If the last byte ( Index == DbcsName.Length - 1 ) is in the</span>
00505 <span class="stringliteral">            //  dbcs leading byte range, it's error.</span>
00506 <span class="stringliteral">            //</span>
00507 <span class="stringliteral"></span>
00508 <span class="stringliteral">            if ( Index == (ULONG)(DbcsName.Length - 1) ) {</span>
00509 <span class="stringliteral"></span>
00510 <span class="stringliteral">                return FALSE;</span>
00511 <span class="stringliteral">            }</span>
00512 <span class="stringliteral"></span>
00513 <span class="stringliteral">            Index += 1;</span>
00514 <span class="stringliteral">            continue;</span>
00515 <span class="stringliteral">        }</span>
00516 <span class="stringliteral"></span>
00517 <span class="stringliteral">        //</span>
00518 <span class="stringliteral">        //  Make sure this character is legal, and if a wild card, that</span>
00519 <span class="stringliteral">        //  wild cards are permissible.</span>
00520 <span class="stringliteral">        //</span>
00521 <span class="stringliteral"></span>
00522 <span class="stringliteral">        if ( !FsRtlIsAnsiCharacterLegalHpfs(Char, WildCardsPermissible) ) {</span>
00523 <span class="stringliteral"></span>
00524 <span class="stringliteral">            return FALSE;</span>
00525 <span class="stringliteral">        }</span>
00526 <span class="stringliteral">    }</span>
00527 <span class="stringliteral"></span>
00528 <span class="stringliteral">    //</span>
00529 <span class="stringliteral">    //  The name cannot end in a space or a period.</span>
00530 <span class="stringliteral">    //</span>
00531 <span class="stringliteral"></span>
00532 <span class="stringliteral">    if ( (Char == ' ') || (Char == '.') || (Char == ANSI_DOS_DOT) ) {</span>
00533 <span class="stringliteral"></span>
00534 <span class="stringliteral">        return FALSE;</span>
00535 <span class="stringliteral">    }</span>
00536 <span class="stringliteral"></span>
00537 <span class="stringliteral">    return TRUE;</span>
00538 <span class="stringliteral">}</span>
</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a179" doxytag="fsrtl.h::FsRtlIsNameInExpression" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlIsNameInExpression           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Expression</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Name</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IgnoreCase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWCH UpcaseTable&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/name_8c-source.html#l00415">415</a> of file <a class="el" href="../../d5/d4/name_8c-source.html">name.c</a>.
<p>
References <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d4/name_8c-source.html#l00482">FsRtlIsNameInExpressionPrivate()</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01038">RtlUpcaseUnicodeString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d4/namesup_8c-source.html#l01203">UdfIsNameInExpression()</a>.
<p>
<pre class="fragment"><div>00422 {
00423     BOOLEAN Result;
00424     UNICODE_STRING LocalName;
00425 
00426     <span class="comment">//</span>
00427     <span class="comment">//  If we weren't given an upcase table, we have to upcase the names</span>
00428     <span class="comment">//  ourselves.</span>
00429     <span class="comment">//</span>
00430 
00431     <span class="keywordflow">if</span> ( IgnoreCase &amp;&amp; !ARGUMENT_PRESENT(UpcaseTable) ) {
00432 
00433         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00434 
00435         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a31">RtlUpcaseUnicodeString</a>( &amp;LocalName, Name, TRUE );
00436 
00437         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00438 
00439             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( Status );
00440         }
00441 
00442         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> = &amp;LocalName;
00443 
00444         IgnoreCase = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00445 
00446     } <span class="keywordflow">else</span> {
00447 
00448         LocalName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00449     }
00450 
00451     <span class="comment">//</span>
00452     <span class="comment">//  Now call the main routine, remembering to free the upcased string</span>
00453     <span class="comment">//  if we allocated one.</span>
00454     <span class="comment">//</span>
00455 
00456     <span class="keywordflow">try</span> {
00457 
00458         Result = <a class="code" href="../../d4/d5/name_8c.html#a4">FsRtlIsNameInExpressionPrivate</a>( Expression,
00459                                                  Name,
00460                                                  IgnoreCase,
00461                                                  UpcaseTable );
00462 
00463     } finally {
00464 
00465         <span class="keywordflow">if</span> (LocalName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00466 
00467             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;LocalName );
00468         }
00469     }
00470 
00471     <span class="keywordflow">return</span> Result;
00472 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a137" doxytag="fsrtl.h::FsRtlIsNtstatusExpected" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlIsNtstatusExpected           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN NTSTATUS&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Exception</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/fsrtl_2filter_8c-source.html#l00082">82</a> of file <a class="el" href="../../d8/d2/fsrtl_2filter_8c-source.html">fsrtl/filter.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/lazyrite_8c-source.html#l00619">CcExceptionFilter()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l02555">FsRtlCancelNotify()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l00054">FsRtlCopyRead()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l00330">FsRtlCopyWrite()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l01064">FsRtlMdlReadDev()</a>, <a class="el" href="../../d8/d2/fsrtl_2filter_8c-source.html#l00049">FsRtlNormalizeNtstatus()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00973">FsRtlNotifyFullReportChange()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l01474">FsRtlPrepareMdlWriteDev()</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00058">LfsExceptionFilter()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00474">UdfCreateUserMdl()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00448">UdfExceptionFilter()</a>, and <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00334">UdfQueryDirectory()</a>.
<p>
<pre class="fragment"><div>00088                    :
00089 
00090     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to decide <span class="keywordflow">if</span> a status <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> set of values
00091     handled by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception filter.
00092 
00093 Arguments:
00094 
00095     Exception - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception being queried
00096 
00097 Return Value:
00098 
00099     BOOLEAN - Returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> handled by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filter, and
00100         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00101 
00102 --*/
00103 
00104 {
00105     <span class="keywordflow">switch</span> (Exception) {
00106 
00107     <span class="keywordflow">case</span> STATUS_DATATYPE_MISALIGNMENT:
00108     <span class="keywordflow">case</span> STATUS_ACCESS_VIOLATION:
00109     <span class="keywordflow">case</span> STATUS_ILLEGAL_INSTRUCTION:
00110     <span class="keywordflow">case</span> STATUS_INSTRUCTION_MISALIGNMENT:
00111 
00112         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00113 
00114     <span class="keywordflow">default</span>:
00115 
00116         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00117     }
00118 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a111" doxytag="fsrtl.h::FsRtlIsTotalDeviceFailure" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlIsTotalDeviceFailure           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN NTSTATUS&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Status</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/fsrtl_2filter_8c-source.html#l00304">304</a> of file <a class="el" href="../../d8/d2/fsrtl_2filter_8c-source.html">fsrtl/filter.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l04282">IopMountVolume()</a>.
<p>
<pre class="fragment"><div>00310                    :
00311 
00312     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> given an <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> value and make a determination as to
00313     <span class="keywordflow">if</span> <span class="keyword">this</span> value indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> complete device has failed and therefore
00314     should no longer be used, or <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> one that indicates that
00315     continued use of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ok (i.e. a sector failure).
00316 
00317 Arguments:
00318 
00319     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> value to test.
00320 
00321 Return Value:
00322 
00323     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>  - The status value given <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> believed to be a fatal device error.
00324     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - The status value given <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> believed to be a sector <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>, but not
00325             a complete device <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
00326 --*/
00327 
00328 {
00329     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00330 
00331         <span class="comment">//</span>
00332         <span class="comment">// All warning and informational errors will be resolved here.</span>
00333         <span class="comment">//</span>
00334 
00335         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00336     }
00337 
00338     <span class="keywordflow">switch</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
00339     <span class="keywordflow">case</span> STATUS_CRC_ERROR:
00340     <span class="keywordflow">case</span> STATUS_DEVICE_DATA_ERROR:
00341         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00342     <span class="keywordflow">default</span>:
00343         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00344     }
00345 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a185" doxytag="fsrtl.h::FsRtlLookupFilterContextInternal" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI <a class="el" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">PFSRTL_FILTER_CONTEXT</a> FsRtlLookupFilterContextInternal           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID OwnerId&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID InstanceId&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/filtrctx_8c-source.html#l00108">108</a> of file <a class="el" href="../../d0/d3/filtrctx_8c-source.html">filtrctx.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a84">FSRTL_FILTER_CONTEXT</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00265">FSRTL_FLAG2_SUPPORTS_FILTER_CONTEXTS</a>, <a class="el" href="../../d4/d2/dumpuser_8c-source.html#l00048">Header</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01648">_FSRTL_FILTER_CONTEXT::InstanceId</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d0/d3/filtrctx_8c-source.html#l00046">MySearchList</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01647">_FSRTL_FILTER_CONTEXT::OwnerId</a>.
<p>
<pre class="fragment"><div>00115                    :
00116 
00117     This routine lookups filter driver context associated with a stream.
00118 
00119     The macro <a class="code" href="../../d1/d8/fsrtl_8h.html#a46">FsRtlLookupFilterContext</a> should be used instead of calling
00120     <span class="keyword">this</span> routine directly.  The macro optimizes <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> common <span class="keywordflow">case</span>
00121     of an empty list.
00122 
00123 Arguments:
00124 
00125     FileObject - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stream of interest.
00126 
00127     OwnerId - Used to identify context information belonging to a particular
00128         filter driver.
00129 
00130     InstanceId - Used to search <span class="keywordflow">for</span> a particular instance of a filter driver
00131         context.  If not provided, any of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> contexts owned by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filter
00132         driver <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00133 
00134     If neither <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> OwnerId nor <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> InstanceId <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> provided, any associated
00135         filter context will be returned.
00136 
00137 Return Value:
00138 
00139     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filter context, or <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> no match found.
00140 
00141 --*/
00142 
00143 {
00144     <a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a>  <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
00145     <a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">PFSRTL_FILTER_CONTEXT</a>     Ctx, RtnCtx;
00146     PLIST_ENTRY               <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>;
00147 
00148     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FileObject);
00149     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FileObject-&gt;FsContext);
00150 
00151     <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = FileObject-&gt;FsContext;
00152 
00153     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Flags2 &amp; FSRTL_FLAG2_SUPPORTS_FILTER_CONTEXTS);
00154 
00155     ExAcquireFastMutex (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FastMutex);
00156     RtnCtx = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00157 
00158   <span class="comment">// Use different loops depending on whether we are comparing both Ids or not.</span>
00159     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(InstanceId) ) {
00160 
00161         <a class="code" href="../../d9/d3/filtrctx_8c.html#a0">MySearchList</a> (&amp;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FilterContexts, List) {
00162             Ctx  = CONTAINING_RECORD (List, <a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">FSRTL_FILTER_CONTEXT</a>, Links);
00163             <span class="keywordflow">if</span> (Ctx-&gt;<a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html#o1">OwnerId</a> == OwnerId &amp;&amp; Ctx-&gt;<a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html#o2">InstanceId</a> == InstanceId) {
00164                 RtnCtx = Ctx;
00165                 <span class="keywordflow">break</span>;
00166             }
00167         }
00168     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(OwnerId) ) {
00169 
00170         <a class="code" href="../../d9/d3/filtrctx_8c.html#a0">MySearchList</a> (&amp;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FilterContexts, List) {
00171             Ctx  = CONTAINING_RECORD (List, <a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">FSRTL_FILTER_CONTEXT</a>, Links);
00172             <span class="keywordflow">if</span> (Ctx-&gt;<a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html#o1">OwnerId</a> == OwnerId) {
00173                 RtnCtx = Ctx;
00174                 <span class="keywordflow">break</span>;
00175             }
00176         }
00177     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!IsListEmpty(&amp;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FilterContexts)) {
00178 
00179         RtnCtx = (<a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">PFSRTL_FILTER_CONTEXT</a>) <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FilterContexts.Flink;
00180     }
00181 
00182     ExReleaseFastMutex(<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FastMutex);
00183     <span class="keywordflow">return</span> RtnCtx;
00184 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a145" doxytag="fsrtl.h::FsRtlLookupLargeMcbEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlLookupLargeMcbEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Mcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Vbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLONGLONG Lbn&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLONGLONG SectorCountFromLbn&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLONGLONG StartingLbn&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLONGLONG SectorCountFromStartingLbn&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG <a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00426">FsRtlLookupMcbEntry()</a>, <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00337">UdfDvdReadStructure()</a>, <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00227">UdfDvdTransferKey()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l00069">UdfLookupAllocation()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00685">UdfReadSectors()</a>, and <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00964">UdfVmcbLookupMcbEntry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a146" doxytag="fsrtl.h::FsRtlLookupLastLargeMcbEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlLookupLastLargeMcbEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Mcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Vbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Lbn</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/largemcb_8c-source.html#l01763">1763</a> of file <a class="el" href="../../d2/d0/largemcb_8c-source.html">largemcb.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00214">EndingLbn</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00195">EndingVbn</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00158">_NONOPAQUE_MCB::FastMutex</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00160">_NONOPAQUE_MCB::PairCount</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00164">PNONOPAQUE_MCB</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02154">try_return</a>, and <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00149">UNUSED_LBN</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00455">FsRtlLookupLastMcbEntry()</a>.
<p>
<pre class="fragment"><div>01771                    :
01772 
01773     This routine retrieves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last Vbn to Lbn mapping stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Mcb.
01774     It returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last sector or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last run in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01775     Mcb.  The results of <span class="keyword">this</span> function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> useful when extending an existing
01776     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> and needing to a hint on where to <span class="keywordflow">try</span> and allocate sectors on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01777     disk.
01778 
01779 Arguments:
01780 
01781     OpaqueMcb - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Mcb being examined.
01782 
01783     Vbn - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last Vbn value mapped.
01784 
01785     Lbn - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lbn corresponding to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Vbn.
01786 
01787 Return Value:
01788 
01789     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a mapping within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Mcb and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
01790         (i.e., <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Mcb does not contain any mapping).
01791 
01792 --*/
01793 
01794 {
01795     <a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html">PNONOPAQUE_MCB</a> Mcb = (<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html">PNONOPAQUE_MCB</a>)OpaqueMcb;
01796 
01797     BOOLEAN Result;
01798 
01799     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01800 
01801     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlLookupLastLargeMcbEntry, Mcb = %08lx\n"</span>, Mcb );
01802 
01803     ExAcquireFastMutex( Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o0">FastMutex</a> );
01804 
01805     <span class="keywordflow">try</span> {
01806 
01807         <span class="comment">//</span>
01808         <span class="comment">//  Check to make sure there is at least one run in the mcb</span>
01809         <span class="comment">//</span>
01810 
01811         <span class="keywordflow">if</span> (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o2">PairCount</a> &lt;= 0) {
01812 
01813             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a> (Result = FALSE);
01814         }
01815 
01816         <span class="comment">//</span>
01817         <span class="comment">//  Return the last mapping of the last run</span>
01818         <span class="comment">//</span>
01819 
01820         *((PULONG)LargeLbn) = <a class="code" href="../../d1/d1/largemcb_8c.html#a9">EndingLbn</a>(Mcb,Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o2">PairCount</a>-1);
01821         *((PULONG)LargeVbn) = <a class="code" href="../../d1/d1/largemcb_8c.html#a5">EndingVbn</a>(Mcb,Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o2">PairCount</a>-1);
01822 
01823         Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01824 
01825     try_exit: NOTHING;
01826     } finally {
01827 
01828         ExReleaseFastMutex( Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o0">FastMutex</a> );
01829 
01830         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlLookupLastLargeMcbEntry -&gt; %08lx\n"</span>, Result );
01831     }
01832 
01833     ((PLARGE_INTEGER)LargeVbn)-&gt;HighPart = (*((PULONG)LargeVbn) == <a class="code" href="../../d1/d1/largemcb_8c.html#a1">UNUSED_LBN</a> ? <a class="code" href="../../d1/d1/largemcb_8c.html#a1">UNUSED_LBN</a> : 0);
01834     ((PLARGE_INTEGER)LargeLbn)-&gt;HighPart = (*((PULONG)LargeLbn) == <a class="code" href="../../d1/d1/largemcb_8c.html#a1">UNUSED_LBN</a> ? <a class="code" href="../../d1/d1/largemcb_8c.html#a1">UNUSED_LBN</a> : 0);
01835 
01836     <span class="keywordflow">return</span> Result;
01837 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a147" doxytag="fsrtl.h::FsRtlLookupLastLargeMcbEntryAndIndex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlLookupLastLargeMcbEntryAndIndex           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OpaqueMcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>LargeVbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>LargeLbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Index</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/largemcb_8c-source.html#l01841">1841</a> of file <a class="el" href="../../d2/d0/largemcb_8c-source.html">largemcb.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00214">EndingLbn</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00195">EndingVbn</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00158">_NONOPAQUE_MCB::FastMutex</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00160">_NONOPAQUE_MCB::PairCount</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00164">PNONOPAQUE_MCB</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02154">try_return</a>, and <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00149">UNUSED_LBN</a>.
<p>
<pre class="fragment"><div>01850                    :
01851 
01852     This routine retrieves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last Vbn to Lbn mapping stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Mcb.
01853     It returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last sector or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last run in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01854     Mcb.  The results of <span class="keyword">this</span> function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> useful when extending an existing
01855     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> and needing to a hint on where to <span class="keywordflow">try</span> and allocate sectors on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01856     disk.
01857 
01858 Arguments:
01859 
01860     OpaqueMcb - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Mcb being examined.
01861 
01862     Vbn - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last Vbn value mapped.
01863 
01864     Lbn - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lbn corresponding to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Vbn.
01865     
01866     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> index of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last run.
01867 
01868 Return Value:
01869 
01870     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a mapping within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Mcb and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
01871         (i.e., <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Mcb does not contain any mapping).
01872 
01873 --*/
01874 
01875 {
01876     <a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html">PNONOPAQUE_MCB</a> Mcb = (<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html">PNONOPAQUE_MCB</a>)OpaqueMcb;
01877 
01878     BOOLEAN Result;
01879 
01880     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01881 
01882     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlLookupLastLargeMcbEntryAndIndex, Mcb = %08lx\n"</span>, Mcb );
01883 
01884     ExAcquireFastMutex( Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o0">FastMutex</a> );
01885 
01886     <span class="keywordflow">try</span> {
01887 
01888         <span class="comment">//</span>
01889         <span class="comment">//  Check to make sure there is at least one run in the mcb</span>
01890         <span class="comment">//</span>
01891 
01892         <span class="keywordflow">if</span> (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o2">PairCount</a> &lt;= 0) {
01893 
01894             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a> (Result = FALSE);
01895         }
01896 
01897         <span class="comment">//</span>
01898         <span class="comment">//  Return the last mapping of the last run</span>
01899         <span class="comment">//</span>
01900 
01901         *((PULONG)LargeLbn) = <a class="code" href="../../d1/d1/largemcb_8c.html#a9">EndingLbn</a>(Mcb,Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o2">PairCount</a>-1);
01902         *((PULONG)LargeVbn) = <a class="code" href="../../d1/d1/largemcb_8c.html#a5">EndingVbn</a>(Mcb,Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o2">PairCount</a>-1);
01903 
01904         *<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o2">PairCount</a> - 1;
01905 
01906         Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01907 
01908     try_exit: NOTHING;
01909     } finally {
01910 
01911         ExReleaseFastMutex( Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o0">FastMutex</a> );
01912 
01913         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlLookupLastLargeMcbEntryAndIndex -&gt; %08lx\n"</span>, Result );
01914     }
01915 
01916     ((PLARGE_INTEGER)LargeVbn)-&gt;HighPart = (*((PULONG)LargeVbn) == <a class="code" href="../../d1/d1/largemcb_8c.html#a1">UNUSED_LBN</a> ? <a class="code" href="../../d1/d1/largemcb_8c.html#a1">UNUSED_LBN</a> : 0);
01917     ((PLARGE_INTEGER)LargeLbn)-&gt;HighPart = (*((PULONG)LargeLbn) == <a class="code" href="../../d1/d1/largemcb_8c.html#a1">UNUSED_LBN</a> ? <a class="code" href="../../d1/d1/largemcb_8c.html#a1">UNUSED_LBN</a> : 0);
01918 
01919     <span class="keywordflow">return</span> Result;
01920 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a157" doxytag="fsrtl.h::FsRtlLookupLastMcbEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlLookupLastMcbEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d7/struct__MCB.html">PMCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Mcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d1/d8/fsrtl_8h.html#a53">PVBN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d1/d8/fsrtl_8h.html#a51">PLBN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lbn</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00455">455</a> of file <a class="el" href="../../d2/d0/largemcb_8c-source.html">largemcb.c</a>.
<p>
References <a class="el" href="../../d2/d0/largemcb_8c-source.html#l01763">FsRtlLookupLastLargeMcbEntry()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00637">UdfAddVmcbMapping()</a>.
<p>
<pre class="fragment"><div>00461 {
00462     BOOLEAN Results;
00463     LONGLONG LiVbn;
00464     LONGLONG LiLbn;
00465 
00466     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00467 
00468     Results = <a class="code" href="../../d1/d8/fsrtl_8h.html#a146">FsRtlLookupLastLargeMcbEntry</a>( (<a class="code" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a>)Mcb,
00469                                             &amp;LiVbn,
00470                                             &amp;LiLbn );
00471 
00472     *Vbn = ((ULONG)LiVbn);
00473     *Lbn = (((ULONG)LiLbn) == -1 ? 0 : ((ULONG)LiLbn));
00474 
00475     <span class="keywordflow">return</span> Results;
00476 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a156" doxytag="fsrtl.h::FsRtlLookupMcbEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlLookupMcbEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d7/struct__MCB.html">PMCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Mcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d1/d8/fsrtl_8h.html#a51">PLBN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG SectorCount&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Index</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00426">426</a> of file <a class="el" href="../../d2/d0/largemcb_8c-source.html">largemcb.c</a>.
<p>
References <a class="el" href="../../d1/d8/fsrtl_8h.html#a145">FsRtlLookupLargeMcbEntry()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
<pre class="fragment"><div>00434 {
00435     BOOLEAN Results;
00436     LONGLONG LiLbn;
00437     LONGLONG LiSectorCount;
00438 
00439     Results = <a class="code" href="../../d1/d8/fsrtl_8h.html#a145">FsRtlLookupLargeMcbEntry</a>( (<a class="code" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a>)Mcb,
00440                                         (LONGLONG)(Vbn),
00441                                         &amp;LiLbn,
00442                                         ARGUMENT_PRESENT(SectorCount) ? &amp;LiSectorCount : NULL,
00443                                         NULL,
00444                                         NULL,
00445                                         Index );
00446 
00447     *Lbn = (((ULONG)LiLbn) == -1 ? 0 : ((ULONG)LiLbn));
00448 
00449     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(SectorCount)) { *SectorCount = ((ULONG)LiSectorCount); }
00450 
00451     <span class="keywordflow">return</span> Results;
00452 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a95" doxytag="fsrtl.h::FsRtlMdlRead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlMdlRead           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>FileOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>LockKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>MdlChain</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/fastio_8c-source.html#l01277">1277</a> of file <a class="el" href="../../d4/d0/fastio_8c-source.html">fastio.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d5/io_8h.html#a319">FAST_IO_DISPATCH</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01403">_DRIVER_OBJECT::FastIoDispatch</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l01064">FsRtlMdlReadDev()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06862">IoGetBaseFileSystemDeviceObject()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00958">_FAST_IO_DISPATCH::MdlRead</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l00942">_FAST_IO_DISPATCH::SizeOfFastIoDispatch</a>.
<p>
<pre class="fragment"><div>01288                    :
01289 
01290     This routine does a fast cached mdl read bypassing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> usual <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system
01291     entry routine (i.e., without the Irp).  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to <span class="keywordflow">do</span> a copy read
01292     of a cached <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.  For a complete description of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> arguments
01293     see <a class="code" href="../../d7/d5/mdlsup_8c.html#a1">CcMdlRead</a>.
01294 
01295 Arguments:
01296 
01297     FileObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object being read.
01298 
01299     FileOffset - Byte offset in <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <span class="keywordflow">for</span> desired data.
01300 
01301     Length - Length of desired data in bytes.
01302 
01303     MdlChain - On output <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> returns a pointer to an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> chain describing
01304         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired data.
01305 
01306     IoStatus - Pointer to standard I/O status block to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status
01307                <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> transfer.
01308 
01309 Return Value:
01310 
01311     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data was not delivered, or <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an I/O error.
01312 
01313     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being delivered
01314 
01315 --*/
01316 
01317 {
01318     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, VolumeDeviceObject;
01319     <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> FastIoDispatch;
01320 
01321     DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject );
01322     FastIoDispatch = DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>;
01323 
01324     <span class="comment">//</span>
01325     <span class="comment">//  See if the (top-level) FileSystem has a FastIo routine, and if so, call it.</span>
01326     <span class="comment">//</span>
01327 
01328     <span class="keywordflow">if</span> ((FastIoDispatch != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01329         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> &gt; FIELD_OFFSET(<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a>, MdlRead)) &amp;&amp;
01330         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o16">MdlRead</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01331 
01332         <span class="keywordflow">return</span> FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o16">MdlRead</a>( FileObject, FileOffset, Length, LockKey, MdlChain, IoStatus, DeviceObject );
01333 
01334     } <span class="keywordflow">else</span> {
01335 
01336         <span class="comment">//</span>
01337         <span class="comment">//  Get the DeviceObject for the volume.  If that DeviceObject is different, and</span>
01338         <span class="comment">//  it specifies the FastIo routine, then we have to return FALSE here and cause</span>
01339         <span class="comment">//  an Irp to get generated.</span>
01340         <span class="comment">//</span>
01341 
01342         VolumeDeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a68">IoGetBaseFileSystemDeviceObject</a>( FileObject );
01343         <span class="keywordflow">if</span> ((VolumeDeviceObject != DeviceObject) &amp;&amp;
01344             (FastIoDispatch = VolumeDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>) &amp;&amp;
01345             (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> &gt; FIELD_OFFSET(<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a>, MdlRead)) &amp;&amp;
01346             (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o16">MdlRead</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01347 
01348             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01349 
01350         <span class="comment">//</span>
01351         <span class="comment">//  Otherwise, call the default routine.</span>
01352         <span class="comment">//</span>
01353 
01354         } <span class="keywordflow">else</span> {
01355 
01356             <span class="keywordflow">return</span> <a class="code" href="../../d1/d8/fsrtl_8h.html#a99">FsRtlMdlReadDev</a>( FileObject, FileOffset, Length, LockKey, MdlChain, IoStatus, DeviceObject );
01357         }
01358     }
01359 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a96" doxytag="fsrtl.h::FsRtlMdlReadComplete" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN FsRtlMdlReadComplete           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MdlChain</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/fastio_8c-source.html#l01367">1367</a> of file <a class="el" href="../../d4/d0/fastio_8c-source.html">fastio.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01403">_DRIVER_OBJECT::FastIoDispatch</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l01438">FsRtlMdlReadCompleteDev()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06862">IoGetBaseFileSystemDeviceObject()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00959">_FAST_IO_DISPATCH::MdlReadComplete</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l00942">_FAST_IO_DISPATCH::SizeOfFastIoDispatch</a>.
<p>
<pre class="fragment"><div>01374                    :
01375 
01376     This routine does a fast cached mdl read bypassing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> usual <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system
01377     entry routine (i.e., without the Irp).  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to <span class="keywordflow">do</span> a copy read
01378     of a cached <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.
01379 
01380 Arguments:
01381 
01382     FileObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object being read.
01383 
01384     MdlChain - Supplies a pointer to an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> chain returned from <a class="code" href="../../d7/d5/mdlsup_8c.html#a1">CcMdlRead</a>.
01385 
01386 Return Value:
01387 
01388     None
01389 
01390 --*/
01391 
01392 {
01393     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, VolumeDeviceObject;
01394     <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> FastIoDispatch;
01395 
01396     DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject );
01397     FastIoDispatch = DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>;
01398 
01399     <span class="comment">//</span>
01400     <span class="comment">//  See if the (top-level) FileSystem has a FastIo routine, and if so, call it.</span>
01401     <span class="comment">//</span>
01402 
01403     <span class="keywordflow">if</span> ((FastIoDispatch != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01404         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> &gt; FIELD_OFFSET(<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a>, MdlReadComplete)) &amp;&amp;
01405         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o17">MdlReadComplete</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01406 
01407         <span class="keywordflow">return</span> FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o17">MdlReadComplete</a>( FileObject, MdlChain, DeviceObject );
01408 
01409     } <span class="keywordflow">else</span> {
01410 
01411         <span class="comment">//</span>
01412         <span class="comment">//  Get the DeviceObject for the volume.  If that DeviceObject is different, and</span>
01413         <span class="comment">//  it specifies the FastIo routine, then we have to return FALSE here and cause</span>
01414         <span class="comment">//  an Irp to get generated.</span>
01415         <span class="comment">//</span>
01416 
01417         VolumeDeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a68">IoGetBaseFileSystemDeviceObject</a>( FileObject );
01418         <span class="keywordflow">if</span> ((VolumeDeviceObject != DeviceObject) &amp;&amp;
01419             (FastIoDispatch = VolumeDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>) &amp;&amp;
01420             (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> &gt; FIELD_OFFSET(<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a>, MdlReadComplete)) &amp;&amp;
01421             (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o17">MdlReadComplete</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01422 
01423             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01424 
01425         <span class="comment">//</span>
01426         <span class="comment">//  Otherwise, call the default routine.</span>
01427         <span class="comment">//</span>
01428 
01429         } <span class="keywordflow">else</span> {
01430 
01431             <span class="keywordflow">return</span> <a class="code" href="../../d1/d8/fsrtl_8h.html#a100">FsRtlMdlReadCompleteDev</a>( FileObject, MdlChain, DeviceObject );
01432         }
01433     }
01434 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a100" doxytag="fsrtl.h::FsRtlMdlReadCompleteDev" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlMdlReadCompleteDev           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MdlChain</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/fastio_8c-source.html#l01438">1438</a> of file <a class="el" href="../../d4/d0/fastio_8c-source.html">fastio.c</a>.
<p>
References <a class="el" href="../../d8/d4/mdlsup_8c-source.html#l00406">CcMdlReadComplete2()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d4/d0/fastio_8c-source.html#l01367">FsRtlMdlReadComplete()</a>.
<p>
<pre class="fragment"><div>01446                    :
01447 
01448     This routine does a fast cached mdl read bypassing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> usual <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system
01449     entry routine (i.e., without the Irp).  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to <span class="keywordflow">do</span> a copy read
01450     of a cached <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.
01451 
01452 Arguments:
01453 
01454     FileObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object being read.
01455 
01456     MdlChain - Supplies a pointer to an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> chain returned from <a class="code" href="../../d7/d5/mdlsup_8c.html#a1">CcMdlRead</a>.
01457 
01458     DeviceObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DeviceObject <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callee.
01459 
01460 Return Value:
01461 
01462     None
01463 
01464 --*/
01465 
01466 
01467 {
01468     <a class="code" href="../../d4/d2/cache_8h.html#a80">CcMdlReadComplete2</a>( FileObject, MdlChain );
01469     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01470 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a99" doxytag="fsrtl.h::FsRtlMdlReadDev" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlMdlReadDev           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>FileOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>LockKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>MdlChain</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/fastio_8c-source.html#l01064">1064</a> of file <a class="el" href="../../d4/d0/fastio_8c-source.html">fastio.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00174">CcFastMdlReadNotPossible</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00172">CcFastMdlReadWait</a>, <a class="el" href="../../d8/d4/mdlsup_8c-source.html#l00030">CcMdlRead()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00056">EXCEPTION_CONTINUE_SEARCH</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00943">_FAST_IO_DISPATCH::FastIoCheckIfPossible</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01403">_DRIVER_OBJECT::FastIoDispatch</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a188a86">FastIoIsNotPossible</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a188a88">FastIoIsQuestionable</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01509">FO_FILE_FAST_IO_READ</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00285">FSRTL_FAST_IO_TOP_LEVEL_IRP</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01772">FsRtlEnterFileSystem</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01795">FsRtlExitFileSystem</a>, <a class="el" href="../../d8/d2/fsrtl_2filter_8c-source.html#l00082">FsRtlIsNtstatusExpected()</a>, <a class="el" href="../../d4/d2/dumpuser_8c-source.html#l00048">Header</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d4/d0/fastio_8c-source.html#l01277">FsRtlMdlRead()</a>.
<p>
<pre class="fragment"><div>01076                    :
01077 
01078     This routine does a fast cached mdl read bypassing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> usual <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system
01079     entry routine (i.e., without the Irp).  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to <span class="keywordflow">do</span> a copy read
01080     of a cached <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.  For a complete description of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> arguments
01081     see <a class="code" href="../../d7/d5/mdlsup_8c.html#a1">CcMdlRead</a>.
01082 
01083 Arguments:
01084 
01085     FileObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object being read.
01086 
01087     FileOffset - Byte offset in <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <span class="keywordflow">for</span> desired data.
01088 
01089     Length - Length of desired data in bytes.
01090 
01091     MdlChain - On output <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> returns a pointer to an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> chain describing
01092         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired data.
01093 
01094     IoStatus - Pointer to standard I/O status block to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status
01095                <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> transfer.
01096 
01097     DeviceObject - Supplies DeviceObject <span class="keywordflow">for</span> callee.
01098 
01099 Return Value:
01100 
01101     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data was not delivered, or <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an I/O error.
01102 
01103     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being delivered
01104 
01105 --*/
01106 
01107 {
01108     <a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
01109     BOOLEAN <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01110     LARGE_INTEGER BeyondLastByte;
01111 
01112     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01113 
01114     <span class="comment">//</span>
01115     <span class="comment">//  Special case a read of zero length</span>
01116     <span class="comment">//</span>
01117 
01118     <span class="keywordflow">if</span> (Length == 0) {
01119 
01120         IoStatus-&gt;Status = STATUS_SUCCESS;
01121         IoStatus-&gt;Information = 0;
01122 
01123         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01124     }
01125 
01126     <span class="comment">//</span>
01127     <span class="comment">//  Overflows should've been handled by caller.</span>
01128     <span class="comment">//</span>
01129 
01130     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(MAXLONGLONG - FileOffset-&gt;QuadPart &gt;= (LONGLONG)Length);
01131 
01132        
01133     <span class="comment">//</span>
01134     <span class="comment">//  Get a real pointer to the common fcb header</span>
01135     <span class="comment">//</span>
01136 
01137     BeyondLastByte.QuadPart = FileOffset-&gt;QuadPart + (LONGLONG)Length;
01138     <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = (<a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a>)FileObject-&gt;FsContext;
01139 
01140     <span class="comment">//</span>
01141     <span class="comment">//  Enter the file system</span>
01142     <span class="comment">//</span>
01143 
01144     <a class="code" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>();
01145 
01146     <a class="code" href="../../d5/d2/cachedat_8c.html#a49">CcFastMdlReadWait</a> += 1;
01147 
01148     <span class="comment">//</span>
01149     <span class="comment">//  Acquired shared on the common fcb header</span>
01150     <span class="comment">//</span>
01151 
01152     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource, TRUE );
01153 
01154     <span class="comment">//</span>
01155     <span class="comment">//  Now that the File is acquired shared, we can safely test if it is</span>
01156     <span class="comment">//  really cached and if we can do fast i/o and if not</span>
01157     <span class="comment">//  then release the fcb and return.</span>
01158     <span class="comment">//</span>
01159 
01160     <span class="keywordflow">if</span> ((FileObject-&gt;PrivateCacheMap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01161         (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;IsFastIoPossible == <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a86">FastIoIsNotPossible</a>)) {
01162 
01163         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
01164         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
01165 
01166         <a class="code" href="../../d5/d2/cachedat_8c.html#a51">CcFastMdlReadNotPossible</a> += 1;
01167 
01168         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01169     }
01170 
01171     <span class="comment">//</span>
01172     <span class="comment">//  Check if fast I/O is questionable and if so then go ask the file system</span>
01173     <span class="comment">//  the answer</span>
01174     <span class="comment">//</span>
01175 
01176     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;IsFastIoPossible == <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a88">FastIoIsQuestionable</a>) {
01177 
01178         <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> FastIoDispatch;
01179 
01180         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!KeIsExecutingDpc());
01181 
01182         FastIoDispatch = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject )-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>;
01183 
01184 
01185         <span class="comment">//</span>
01186         <span class="comment">//  All file system then set "Is Questionable" had better support fast I/O</span>
01187         <span class="comment">//</span>
01188 
01189         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FastIoDispatch != NULL);
01190         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o1">FastIoCheckIfPossible</a> != NULL);
01191 
01192         <span class="comment">//</span>
01193         <span class="comment">//  Call the file system to check for fast I/O.  If the answer is anything</span>
01194         <span class="comment">//  other than GoForIt then we cannot take the fast I/O path.</span>
01195         <span class="comment">//</span>
01196 
01197         <span class="keywordflow">if</span> (!FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o1">FastIoCheckIfPossible</a>( FileObject,
01198                                                     FileOffset,
01199                                                     Length,
01200                                                     TRUE,
01201                                                     LockKey,
01202                                                     TRUE, <span class="comment">// read operation</span>
01203                                                     IoStatus,
01204                                                     <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject ) )) {
01205 
01206             <span class="comment">//</span>
01207             <span class="comment">//  Fast I/O is not possible so release the Fcb and return.</span>
01208             <span class="comment">//</span>
01209 
01210             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
01211             <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
01212 
01213             <a class="code" href="../../d5/d2/cachedat_8c.html#a51">CcFastMdlReadNotPossible</a> += 1;
01214 
01215             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01216         }
01217     }
01218 
01219     <span class="comment">//</span>
01220     <span class="comment">//  Check for read past file size.</span>
01221     <span class="comment">//</span>
01222 
01223     <span class="keywordflow">if</span> ( BeyondLastByte.QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.QuadPart ) {
01224 
01225         <span class="keywordflow">if</span> ( FileOffset-&gt;QuadPart &gt;= <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.QuadPart ) {
01226             IoStatus-&gt;Status = STATUS_END_OF_FILE;
01227             IoStatus-&gt;Information = 0;
01228 
01229             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
01230             <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
01231 
01232             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01233         }
01234 
01235         Length = (ULONG)( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.QuadPart - FileOffset-&gt;QuadPart );
01236     }
01237 
01238     <span class="comment">//</span>
01239     <span class="comment">//  We can do fast i/o so call the cc routine to do the work and then</span>
01240     <span class="comment">//  release the fcb when we've done.  If for whatever reason the</span>
01241     <span class="comment">//  mdl read fails, then return FALSE to our caller.</span>
01242     <span class="comment">//</span>
01243     <span class="comment">//</span>
01244     <span class="comment">//  Also mark this as the top level "Irp" so that lower file system levels</span>
01245     <span class="comment">//  will not attempt a pop-up</span>
01246     <span class="comment">//</span>
01247 
01248     <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;TopLevelIrp = <a class="code" href="../../d1/d8/fsrtl_8h.html#a14">FSRTL_FAST_IO_TOP_LEVEL_IRP</a>;
01249 
01250     <span class="keywordflow">try</span> {
01251 
01252         <a class="code" href="../../d4/d2/cache_8h.html#a78">CcMdlRead</a>( FileObject, FileOffset, Length, MdlChain, IoStatus );
01253 
01254         FileObject-&gt;Flags |= <a class="code" href="../../d0/d5/io_8h.html#a169">FO_FILE_FAST_IO_READ</a>;
01255 
01256     } except( <a class="code" href="../../d1/d8/fsrtl_8h.html#a137">FsRtlIsNtstatusExpected</a>(GetExceptionCode())
01257                                    ? EXCEPTION_EXECUTE_HANDLER
01258                                    : EXCEPTION_CONTINUE_SEARCH ) {
01259 
01260         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01261     }
01262 
01263     <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;TopLevelIrp = 0;
01264 
01265     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
01266     <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
01267 
01268     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01269 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a98" doxytag="fsrtl.h::FsRtlMdlWriteComplete" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN FsRtlMdlWriteComplete           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>FileOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MdlChain</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/fastio_8c-source.html#l01950">1950</a> of file <a class="el" href="../../d4/d0/fastio_8c-source.html">fastio.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01403">_DRIVER_OBJECT::FastIoDispatch</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l02020">FsRtlMdlWriteCompleteDev()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06862">IoGetBaseFileSystemDeviceObject()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00961">_FAST_IO_DISPATCH::MdlWriteComplete</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l00942">_FAST_IO_DISPATCH::SizeOfFastIoDispatch</a>.
<p>
<pre class="fragment"><div>01958                    :
01959 
01960     This routine completes an Mdl write.
01961 
01962 Arguments:
01963 
01964     FileObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object being read.
01965 
01966     MdlChain - Supplies a pointer to an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> chain returned from CcMdlPrepareMdlWrite.
01967 
01968 Return Value:
01969 
01970 
01971 
01972 --*/
01973 
01974 {
01975     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, VolumeDeviceObject;
01976     <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> FastIoDispatch;
01977 
01978     DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject );
01979     FastIoDispatch = DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>;
01980 
01981     <span class="comment">//</span>
01982     <span class="comment">//  See if the (top-level) FileSystem has a FastIo routine, and if so, call it.</span>
01983     <span class="comment">//</span>
01984 
01985     <span class="keywordflow">if</span> ((FastIoDispatch != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01986         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> &gt; FIELD_OFFSET(<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a>, MdlWriteComplete)) &amp;&amp;
01987         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o19">MdlWriteComplete</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01988 
01989         <span class="keywordflow">return</span> FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o19">MdlWriteComplete</a>( FileObject, FileOffset, MdlChain, DeviceObject );
01990 
01991     } <span class="keywordflow">else</span> {
01992 
01993         <span class="comment">//</span>
01994         <span class="comment">//  Get the DeviceObject for the volume.  If that DeviceObject is different, and</span>
01995         <span class="comment">//  it specifies the FastIo routine, then we have to return FALSE here and cause</span>
01996         <span class="comment">//  an Irp to get generated.</span>
01997         <span class="comment">//</span>
01998 
01999         VolumeDeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a68">IoGetBaseFileSystemDeviceObject</a>( FileObject );
02000         <span class="keywordflow">if</span> ((VolumeDeviceObject != DeviceObject) &amp;&amp;
02001             (FastIoDispatch = VolumeDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>) &amp;&amp;
02002             (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> &gt; FIELD_OFFSET(<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a>, MdlWriteComplete)) &amp;&amp;
02003             (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o19">MdlWriteComplete</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02004 
02005             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02006 
02007         <span class="comment">//</span>
02008         <span class="comment">//  Otherwise, call the default routine.</span>
02009         <span class="comment">//</span>
02010 
02011         } <span class="keywordflow">else</span> {
02012 
02013             <span class="keywordflow">return</span> <a class="code" href="../../d1/d8/fsrtl_8h.html#a102">FsRtlMdlWriteCompleteDev</a>( FileObject, FileOffset, MdlChain, DeviceObject );
02014         }
02015     }
02016 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a102" doxytag="fsrtl.h::FsRtlMdlWriteCompleteDev" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlMdlWriteCompleteDev           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>FileOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MdlChain</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/fastio_8c-source.html#l02020">2020</a> of file <a class="el" href="../../d4/d0/fastio_8c-source.html">fastio.c</a>.
<p>
References <a class="el" href="../../d8/d4/mdlsup_8c-source.html#l00838">CcMdlWriteComplete2()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01494">FO_WRITE_THROUGH</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d4/d0/fastio_8c-source.html#l01950">FsRtlMdlWriteComplete()</a>.
<p>
<pre class="fragment"><div>02029                    :
02030 
02031     This routine completes an Mdl write.
02032 
02033 Arguments:
02034 
02035     FileObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object being read.
02036 
02037     MdlChain - Supplies a pointer to an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> chain returned from CcMdlPrepareMdlWrite.
02038 
02039     DeviceObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DeviceObject <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callee.
02040 
02041 Return Value:
02042 
02043 
02044 
02045 --*/
02046 
02047 
02048 {
02049     <span class="comment">//</span>
02050     <span class="comment">//  Do not support WRITE_THROUGH in the fast path call.</span>
02051     <span class="comment">//</span>
02052 
02053     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( FileObject-&gt;Flags, FO_WRITE_THROUGH )) {
02054         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02055     }
02056 
02057     <a class="code" href="../../d4/d2/cache_8h.html#a83">CcMdlWriteComplete2</a>( FileObject, FileOffset, MdlChain );
02058     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02059 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a136" doxytag="fsrtl.h::FsRtlNormalizeNtstatus" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI NTSTATUS FsRtlNormalizeNtstatus           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN NTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>Exception</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN NTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericException</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/fsrtl_2filter_8c-source.html#l00049">49</a> of file <a class="el" href="../../d8/d2/fsrtl_2filter_8c-source.html">fsrtl/filter.c</a>.
<p>
References <a class="el" href="../../d8/d2/fsrtl_2filter_8c-source.html#l00082">FsRtlIsNtstatusExpected()</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/copysup_8c-source.html#l00031">CcCopyRead()</a>, <a class="el" href="../../d6/d6/copysup_8c-source.html#l01075">CcCopyWrite()</a>, <a class="el" href="../../d6/d6/copysup_8c-source.html#l00588">CcFastCopyRead()</a>, <a class="el" href="../../d6/d6/copysup_8c-source.html#l01482">CcFastCopyWrite()</a>, <a class="el" href="../../d6/d2/vacbsup_8c-source.html#l00401">CcGetVacbMiss()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00387">CcInitializeCacheMap()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l06024">CcMapAndCopy()</a>, <a class="el" href="../../d8/d4/mdlsup_8c-source.html#l00838">CcMdlWriteComplete2()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l01821">CcSetFileSizes()</a>, <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00418">UdfNormalizeAndRaiseStatus()</a>.
<p>
<pre class="fragment"><div>00056                    :
00057 
00058     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to normalize an <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> into a status
00059     that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> handled by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system's top level exception handlers.
00060 
00061 Arguments:
00062 
00063     Exception - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception being normalized
00064 
00065     GenericException - Supplies a second exception to translate to
00066         <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> set of exceptions
00067         handled by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filter
00068 
00069 Return Value:
00070 
00071     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Returns Exception <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already handled
00072         by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filter, and GenericException otherwise.
00073 
00074 --*/
00075 
00076 {
00077     <span class="keywordflow">return</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a137">FsRtlIsNtstatusExpected</a>(Exception) ? Exception : GenericException);
00078 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a171" doxytag="fsrtl.h::FsRtlNotifyChangeDirectory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlNotifyChangeDirectory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifySync</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>FsContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>FullDirectoryName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLIST_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifyList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>WatchTree</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CompletionFilter</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifyIrp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l00469">469</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00547">FsRtlNotifyFullChangeDirectory()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d6/d1/rtnotify_8c-source.html#l00070">WatchTree</a>.
<p>
<pre class="fragment"><div>00481                    :
00482 
00483     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system which has received a NotifyChange
00484     request.  This routine checks <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already a notify structure and
00485     inserts one <span class="keywordflow">if</span> not present.  With a notify structure in hand, we check
00486     whether we already have a pending notify and report <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <span class="keywordflow">if</span> so.  If there
00487     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no pending notify, we check <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> has already been cancelled and
00488     completes <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <span class="keywordflow">if</span> so.  Otherwise we add <span class="keyword">this</span> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of Irps waiting
00489     <span class="keywordflow">for</span> notification.
00490 
00491 Arguments:
00492 
00493     NotifySync  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> controlling fast mutex <span class="keywordflow">for</span> <span class="keyword">this</span> notify list.
00494         It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> stored here so that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> can be found <span class="keywordflow">for</span> an <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being
00495         cancelled.
00496 
00497     FsContext  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> supplied by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system so that <span class="keyword">this</span> notify
00498                   structure can be uniquely identified.
00499 
00500     FullDirectoryName  -  Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full name <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory associated
00501                           with <span class="keyword">this</span> notify structure.
00502 
00503     NotifyList  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify list to add <span class="keyword">this</span>
00504                    structure to.
00505 
00506     <a class="code" href="../../d5/d2/rtnotify_8c.html#a4">WatchTree</a>  -  This indicates whether all subdirectories <span class="keywordflow">for</span> <span class="keyword">this</span> directory
00507                   should be watched, or just <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory itself.
00508 
00509     CompletionFilter  -  This provides <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mask to determine which operations
00510                          will trigger <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify operations.
00511 
00512     NotifyIrp  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to complete on notify change.
00513 
00514 Return Value:
00515 
00516     None.
00517 
00518 --*/
00519 
00520 {
00521     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00522 
00523     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlNotifyChangeDirectory:  Entered\n"</span>, 0 );
00524 
00525     <span class="comment">//</span>
00526     <span class="comment">//  We will simply call the full notify routine to do the real work.</span>
00527     <span class="comment">//</span>
00528 
00529     <a class="code" href="../../d1/d8/fsrtl_8h.html#a172">FsRtlNotifyFullChangeDirectory</a>( NotifySync,
00530                                     NotifyList,
00531                                     FsContext,
00532                                     FullDirectoryName,
00533                                     WatchTree,
00534                                     TRUE,
00535                                     CompletionFilter,
00536                                     NotifyIrp,
00537                                     NULL,
00538                                     NULL );
00539 
00540     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlNotifyChangeDirectory:  Exit\n"</span>, 0 );
00541 
00542     <span class="keywordflow">return</span>;
00543 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a175" doxytag="fsrtl.h::FsRtlNotifyCleanup" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlNotifyCleanup           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifySync</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLIST_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifyList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>FsContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l01795">1795</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00274">AcquireNotifySync</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00187">_NOTIFY_CHANGE::AllocatedBuffer</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00159">_NOTIFY_CHANGE::Flags</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l01920">FsRtlIsNotifyOnList()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l02467">FsRtlNotifyCompleteIrpList()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00139">_NOTIFY_CHANGE::FullDirectoryName</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00216">NOTIFY_CLEANUP_CALLED</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00153">_NOTIFY_CHANGE::NotifyIrps</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00146">_NOTIFY_CHANGE::NotifyList</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00210">_NOTIFY_CHANGE::OwningProcess</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d7/notify_8c.html#a17">PNOTIFY_CHANGE</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00356">PsReturnPoolQuota()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00203">_NOTIFY_CHANGE::ReferenceCount</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00284">ReleaseNotifySync</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00196">SeReleaseSubjectContext()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00130">_NOTIFY_CHANGE::SubjectContext</a>, and <a class="el" href="../../d3/d6/notify_8c-source.html#l00190">_NOTIFY_CHANGE::ThisBufferLength</a>.
<p>
Referenced by <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html#l00042">UdfCommonCleanup()</a>.
<p>
<pre class="fragment"><div>01803                    :
01804 
01805     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called <span class="keywordflow">for</span> a cleanup of a user directory handle.  We
01806     walk through our notify structures looking <span class="keywordflow">for</span> a <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a> context field.
01807     We complete all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pending notify Irps <span class="keywordflow">for</span> <span class="keyword">this</span> Notify structure, remove
01808     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify structure and deallocate <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
01809 
01810 Arguments:
01811 
01812     NotifySync  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> controlling fast mutex <span class="keywordflow">for</span> <span class="keyword">this</span> notify list.
01813         It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> stored here so that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> can be found <span class="keywordflow">for</span> an <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being
01814         cancelled.
01815 
01816     NotifyList  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify list to add <span class="keyword">this</span>
01817                    structure to.
01818 
01819     FsContext  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a unique value assigned by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system to
01820                   identify a particular notify structure.
01821 
01822 Return Value:
01823 
01824     None.
01825 
01826 --*/
01827 
01828 {
01829     <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html">PNOTIFY_CHANGE</a> Notify;
01830     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectContext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01831 
01832     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01833 
01834     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlNotifyCleanup:  Entered\n"</span>, 0 );
01835     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Mutex             -&gt; %08lx\n"</span>, Mutex );
01836     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Notify List       -&gt; %08lx\n"</span>, NotifyList );
01837     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"FsContext         -&gt; %08lx\n"</span>, FsContext );
01838 
01839     <span class="comment">//</span>
01840     <span class="comment">//  Acquire exclusive access to the list by acquiring the mutex.</span>
01841     <span class="comment">//</span>
01842 
01843     <a class="code" href="../../d2/d7/notify_8c.html#a11">AcquireNotifySync</a>( NotifySync );
01844 
01845     <span class="comment">//</span>
01846     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
01847     <span class="comment">//</span>
01848 
01849     <span class="keywordflow">try</span> {
01850 
01851         <span class="comment">//</span>
01852         <span class="comment">//  Search for a match on the list.</span>
01853         <span class="comment">//</span>
01854 
01855         Notify = <a class="code" href="../../d2/d7/notify_8c.html#a18">FsRtlIsNotifyOnList</a>( NotifyList, FsContext );
01856 
01857         <span class="comment">//</span>
01858         <span class="comment">//  If found, then complete all the Irps with STATUS_NOTIFY_CLEANUP</span>
01859         <span class="comment">//</span>
01860 
01861         <span class="keywordflow">if</span> (Notify != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01862 
01863             <span class="comment">//</span>
01864             <span class="comment">//  Set the flag to indicate that we have been called with cleanup.</span>
01865             <span class="comment">//</span>
01866 
01867             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_CLEANUP_CALLED );
01868 
01869             <span class="keywordflow">if</span> (!IsListEmpty( &amp;Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o7">NotifyIrps</a> )) {
01870 
01871                 <a class="code" href="../../d2/d7/notify_8c.html#a32">FsRtlNotifyCompleteIrpList</a>( Notify, STATUS_NOTIFY_CLEANUP );
01872             }
01873 
01874             RemoveEntryList( &amp;Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o6">NotifyList</a> );
01875 
01876             InterlockedDecrement( &amp;Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o17">ReferenceCount</a> );
01877 
01878             <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o17">ReferenceCount</a> == 0) {
01879                 
01880                 <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o11">AllocatedBuffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01881 
01882                     <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o18">OwningProcess</a>,
01883                                        PagedPool,
01884                                        Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o14">ThisBufferLength</a> );
01885 
01886                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o11">AllocatedBuffer</a> );
01887                 }
01888 
01889                 <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01890 
01891                     SubjectContext = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o4">SubjectContext</a>;
01892                 }
01893 
01894                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Notify );
01895             }
01896         }
01897 
01898     } finally {
01899 
01900         <a class="code" href="../../d2/d7/notify_8c.html#a12">ReleaseNotifySync</a>( NotifySync );
01901 
01902         <span class="keywordflow">if</span> (SubjectContext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01903 
01904             <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a>( SubjectContext );
01905             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( SubjectContext );
01906         }
01907 
01908         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlNotifyCleanup:  Exit\n"</span>, 0 );
01909     }
01910 
01911     <span class="keywordflow">return</span>;
01912 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a172" doxytag="fsrtl.h::FsRtlNotifyFullChangeDirectory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlNotifyFullChangeDirectory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifySync</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLIST_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifyList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>FsContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>FullDirectoryName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>WatchTree</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IgnoreBuffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CompletionFilter</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifyIrp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a82">PCHECK_FOR_TRAVERSE_ACCESS</a> TraverseCallback&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectContext&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l00547">547</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00274">AcquireNotifySync</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00189">_NOTIFY_CHANGE::BufferLength</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00166">_NOTIFY_CHANGE::CharacterSize</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00173">_NOTIFY_CHANGE::CompletionFilter</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00191">_NOTIFY_CHANGE::DataLength</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00159">_NOTIFY_CHANGE::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01533">_FILE_OBJECT::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01504">FO_CLEANUP_COMPLETE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01519">_FILE_OBJECT::FsContext</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00103">_NOTIFY_CHANGE::FsContext</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l02873">FsRtlCheckNotifyForDelete()</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01745">FsRtlCompleteRequest</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l01920">FsRtlIsNotifyOnList()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l02000">FsRtlNotifyCompleteIrp()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l02195">FsRtlNotifySetCancelRoutine()</a>, <a class="el" href="../../d4/d7/fsrtlp_8h-source.html#l00040">FsRtlpAllocatePool</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00139">_NOTIFY_CHANGE::FullDirectoryName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03620">IoMarkIrpPending</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00192">_NOTIFY_CHANGE::LastEntry</a>, <a class="el" href="../../d2/d7/notify_8c.html#a16">NOTIFY_CHANGE</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00216">NOTIFY_CLEANUP_CALLED</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00217">NOTIFY_DEFER_NOTIFY</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00218">NOTIFY_DIR_IS_ROOT</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00215">NOTIFY_IMMEDIATE_NOTIFY</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00219">NOTIFY_STREAM_IS_DELETED</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00214">NOTIFY_WATCH_TREE</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00153">_NOTIFY_CHANGE::NotifyIrps</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00146">_NOTIFY_CHANGE::NotifyList</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00094">_NOTIFY_CHANGE::NotifySync</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00210">_NOTIFY_CHANGE::OwningProcess</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d2/d7/notify_8c.html#a17">PNOTIFY_CHANGE</a>, <a class="el" href="../../d2/d7/notify_8c.html#a15">PREAL_NOTIFY_SYNC</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00203">_NOTIFY_CHANGE::ReferenceCount</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00284">ReleaseNotifySync</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00196">SeReleaseSubjectContext()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00111">_NOTIFY_CHANGE::StreamID</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00130">_NOTIFY_CHANGE::SubjectContext</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00638">THREAD_TO_PROCESS</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00120">_NOTIFY_CHANGE::TraverseCallback</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02154">try_return</a>, and <a class="el" href="../../d6/d1/rtnotify_8c-source.html#l00070">WatchTree</a>.
<p>
Referenced by <a class="el" href="../../d3/d6/notify_8c-source.html#l00469">FsRtlNotifyChangeDirectory()</a>, and <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00904">UdfNotifyChangeDirectory()</a>.
<p>
<pre class="fragment"><div>00562                    :
00563 
00564     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system which has received a NotifyChange
00565     request.  This routine checks <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already a notify structure and
00566     inserts one <span class="keywordflow">if</span> not present.  With a notify structure in hand, we check
00567     whether we already have a pending notify and report <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <span class="keywordflow">if</span> so.  If there
00568     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no pending notify, we check <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> has already been cancelled and
00569     completes <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <span class="keywordflow">if</span> so.  Otherwise we add <span class="keyword">this</span> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of Irps waiting
00570     <span class="keywordflow">for</span> notification.
00571 
00572     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> version of <span class="keyword">this</span> routine which understands about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user's
00573     buffer and will fill <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> in on a reported change.
00574 
00575 Arguments:
00576 
00577     NotifySync  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> controlling fast mutex <span class="keywordflow">for</span> <span class="keyword">this</span> notify list.
00578         It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> stored here so that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> can be found <span class="keywordflow">for</span> an <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being
00579         cancelled.
00580 
00581     NotifyList  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify list to add <span class="keyword">this</span>
00582         structure to.
00583 
00584     FsContext  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> supplied by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system so that <span class="keyword">this</span> notify
00585         structure can be uniquely identified.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NotifyIrp <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified
00586         then <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to identify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stream and <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will match <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FsContext
00587         field in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object of a stream being deleted.
00588 
00589     FullDirectoryName  -  Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full name <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory associated
00590         with <span class="keyword">this</span> notify structure.  Ignored <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NotifyIrp <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified.
00591 
00592     <a class="code" href="../../d5/d2/rtnotify_8c.html#a4">WatchTree</a>  -  This indicates whether all subdirectories <span class="keywordflow">for</span> <span class="keyword">this</span> directory
00593         should be watched, or just <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory itself.  Ignored <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00594         NotifyIrp <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified.
00595 
00596     IgnoreBuffer  -  Indicates whether we will always ignore any user buffer
00597         and force <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory to be reenumerated.  This will speed up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00598         operation.  Ignored <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NotifyIrp <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified.
00599 
00600     CompletionFilter  -  This provides <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mask to determine which operations
00601         will trigger <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify operations.  Ignored <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NotifyIrp <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
00602         specified.
00603 
00604     NotifyIrp  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to complete on notify change.  If <span class="keyword">this</span> irp <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00605         not specified <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> means that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stream represented by <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object
00606         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being deleted.
00607 
00608     TraverseCallback  -  If specified we must call <span class="keyword">this</span> routine when a change
00609         has occurred in a subdirectory being watched in a tree.  This will
00610         let <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filesystem check <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> watcher has traverse access to that
00611         directory.  Ignored <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NotifyIrp <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified.
00612 
00613     SubjectContext - If there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a traverse callback routine then we will
00614         pass <span class="keyword">this</span> subject context as a parameter to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call.  We will release
00615         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context and free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure when done with <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.  Ignored <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00616         NotifyIrp <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified.
00617 
00618 Return Value:
00619 
00620     None.
00621 
00622 --*/
00623 
00624 {
00625     <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html">PNOTIFY_CHANGE</a> Notify;
00626     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
00627 
00628     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00629 
00630     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlNotifyFullChangeDirectory:  Entered\n"</span>, 0 );
00631 
00632     <span class="comment">//</span>
00633     <span class="comment">//  Acquire exclusive access to the list by acquiring the mutex.</span>
00634     <span class="comment">//</span>
00635 
00636     <a class="code" href="../../d2/d7/notify_8c.html#a11">AcquireNotifySync</a>( NotifySync );
00637 
00638     <span class="comment">//</span>
00639     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00640     <span class="comment">//</span>
00641 
00642     <span class="keywordflow">try</span> {
00643 
00644         <span class="comment">//</span>
00645         <span class="comment">//  If there is no Irp then find all of the pending Irps whose file objects</span>
00646         <span class="comment">//  refer to the same stream and complete them with STATUS_DELETE_PENDING.</span>
00647         <span class="comment">//</span>
00648 
00649         <span class="keywordflow">if</span> (NotifyIrp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00650 
00651             <a class="code" href="../../d2/d7/notify_8c.html#a24">FsRtlCheckNotifyForDelete</a>( NotifyList, FsContext );
00652             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
00653         }
00654 
00655         <span class="comment">//</span>
00656         <span class="comment">//  Get the current Stack location</span>
00657         <span class="comment">//</span>
00658 
00659         IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( NotifyIrp );
00660 
00661         <span class="comment">//</span>
00662         <span class="comment">//  Clear the Iosb in the Irp.</span>
00663         <span class="comment">//</span>
00664 
00665         NotifyIrp-&gt;IoStatus.Status = STATUS_SUCCESS;
00666         NotifyIrp-&gt;IoStatus.Information = 0;
00667 
00668         <span class="comment">//</span>
00669         <span class="comment">//  If the file object has already gone through cleanup, then complete</span>
00670         <span class="comment">//  the request immediately.</span>
00671         <span class="comment">//</span>
00672 
00673         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a>, FO_CLEANUP_COMPLETE )) {
00674 
00675             <span class="comment">//</span>
00676             <span class="comment">//  Always mark this Irp as pending returned.</span>
00677             <span class="comment">//</span>
00678 
00679             <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( NotifyIrp );
00680 
00681             <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( NotifyIrp, STATUS_NOTIFY_CLEANUP );
00682             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
00683         }
00684 
00685         <span class="comment">//</span>
00686         <span class="comment">//  If the notify structure is not already in the list, add it</span>
00687         <span class="comment">//  now.</span>
00688         <span class="comment">//</span>
00689 
00690         Notify = <a class="code" href="../../d2/d7/notify_8c.html#a18">FsRtlIsNotifyOnList</a>( NotifyList, FsContext );
00691 
00692         <span class="keywordflow">if</span> (Notify == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00693 
00694             <span class="comment">//</span>
00695             <span class="comment">//  Allocate and initialize the structure.</span>
00696             <span class="comment">//</span>
00697 
00698             Notify = <a class="code" href="../../d3/d8/fsrtlp_8h.html#a2">FsRtlpAllocatePool</a>( PagedPool, <span class="keyword">sizeof</span>( <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html">NOTIFY_CHANGE</a> ));
00699             RtlZeroMemory( Notify, <span class="keyword">sizeof</span>( <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html">NOTIFY_CHANGE</a> ));
00700 
00701             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o0">NotifySync</a> = (<a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html">PREAL_NOTIFY_SYNC</a>) NotifySync;
00702             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o1">FsContext</a> = FsContext;
00703             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o2">StreamID</a> = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o4">FsContext</a>;
00704 
00705             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o3">TraverseCallback</a> = TraverseCallback;
00706             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o4">SubjectContext</a> = SubjectContext;
00707             SubjectContext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00708 
00709             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a> = FullDirectoryName;
00710 
00711             InitializeListHead( &amp;Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o7">NotifyIrps</a> );
00712 
00713             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/rtnotify_8c.html#a4">WatchTree</a>) {
00714 
00715                 <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_WATCH_TREE );
00716             }
00717 
00718             <span class="keywordflow">if</span> (FullDirectoryName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00719 
00720                 <span class="comment">//</span>
00721                 <span class="comment">//  In the view index we aren't using this buffer to hold a</span>
00722                 <span class="comment">//  unicode string.</span>
00723                 <span class="comment">//</span>
00724 
00725                 Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> );
00726 
00727             } <span class="keywordflow">else</span> {
00728 
00729                 <span class="comment">//</span>
00730                 <span class="comment">//  We look at the directory name to decide if we have a unicode</span>
00731                 <span class="comment">//  name.</span>
00732                 <span class="comment">//</span>
00733 
00734                 <span class="keywordflow">if</span> (FullDirectoryName-&gt;Length &gt;= 2
00735                     &amp;&amp; FullDirectoryName-&gt;Buffer[1] == <span class="charliteral">'\0'</span>) {
00736 
00737                     Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a> = <span class="keyword">sizeof</span>( WCHAR );
00738 
00739                 } <span class="keywordflow">else</span> {
00740 
00741                     Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> );
00742                 }
00743 
00744                 <span class="keywordflow">if</span> (FullDirectoryName-&gt;Length == Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a>) {
00745 
00746                     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_DIR_IS_ROOT );
00747                 }
00748             }
00749 
00750             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o10">CompletionFilter</a> = CompletionFilter;
00751 
00752             <span class="comment">//</span>
00753             <span class="comment">//  If we are to return data to the user then look for the length</span>
00754             <span class="comment">//  of the original buffer in the IrpSp.</span>
00755             <span class="comment">//</span>
00756 
00757             <span class="keywordflow">if</span> (!IgnoreBuffer) {
00758 
00759                 Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o13">BufferLength</a> = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.NotifyDirectory.Length;
00760             }
00761 
00762             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o18">OwningProcess</a> = <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>( NotifyIrp-&gt;Tail.Overlay.Thread );
00763             InsertTailList( NotifyList, &amp;Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o6">NotifyList</a> );
00764 
00765             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o17">ReferenceCount</a> = 1;
00766 
00767         <span class="comment">//</span>
00768         <span class="comment">//  If we have already been called with cleanup then complete</span>
00769         <span class="comment">//  the request immediately.</span>
00770         <span class="comment">//</span>
00771 
00772         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_CLEANUP_CALLED )) {
00773 
00774             <span class="comment">//</span>
00775             <span class="comment">//  Always mark this Irp as pending returned.</span>
00776             <span class="comment">//</span>
00777 
00778             <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( NotifyIrp );
00779 
00780             <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( NotifyIrp, STATUS_NOTIFY_CLEANUP );
00781             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
00782 
00783         <span class="comment">//</span>
00784         <span class="comment">//  If this file has been deleted then complete with STATUS_DELETE_PENDING.</span>
00785         <span class="comment">//</span>
00786 
00787         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_STREAM_IS_DELETED )) {
00788 
00789             <span class="comment">//</span>
00790             <span class="comment">//  Always mark this Irp as pending returned.</span>
00791             <span class="comment">//</span>
00792 
00793             <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( NotifyIrp );
00794 
00795             <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( NotifyIrp, STATUS_DELETE_PENDING );
00796             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
00797 
00798         <span class="comment">//</span>
00799         <span class="comment">//  If the notify pending flag is set or there is data in an internal buffer</span>
00800         <span class="comment">//  we complete this Irp immediately and exit.</span>
00801         <span class="comment">//</span>
00802 
00803         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_IMMEDIATE_NOTIFY )
00804                    &amp;&amp; !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_DEFER_NOTIFY )) {
00805 
00806             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"Notify has been pending\n"</span>, 0 );
00807 
00808             <span class="comment">//</span>
00809             <span class="comment">//  Clear the flag in our notify structure before completing the</span>
00810             <span class="comment">//  Irp.  This will prevent a caller who reposts in his completion</span>
00811             <span class="comment">//  routine from looping in the completion routine.</span>
00812             <span class="comment">//</span>
00813 
00814             <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_IMMEDIATE_NOTIFY );
00815 
00816             <span class="comment">//</span>
00817             <span class="comment">//  Always mark this Irp as pending returned.</span>
00818             <span class="comment">//</span>
00819 
00820             <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( NotifyIrp );
00821 
00822             <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( NotifyIrp, STATUS_NOTIFY_ENUM_DIR );
00823             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
00824 
00825         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o15">DataLength</a> != 0
00826                    &amp;&amp; !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_DEFER_NOTIFY )) {
00827 
00828             ULONG ThisDataLength = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o15">DataLength</a>;
00829 
00830             <span class="comment">//</span>
00831             <span class="comment">//  Now set our buffer pointers back to indicate an empty buffer.</span>
00832             <span class="comment">//</span>
00833 
00834             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o15">DataLength</a> = 0;
00835             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o16">LastEntry</a> = 0;
00836 
00837             <a class="code" href="../../d2/d7/notify_8c.html#a19">FsRtlNotifyCompleteIrp</a>( NotifyIrp,
00838                                     Notify,
00839                                     ThisDataLength,
00840                                     STATUS_SUCCESS,
00841                                     FALSE );
00842 
00843             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
00844         }
00845 
00846         <span class="comment">//</span>
00847         <span class="comment">//  Add the Irp to the tail of the notify queue.</span>
00848         <span class="comment">//</span>
00849 
00850         NotifyIrp-&gt;IoStatus.Information = (ULONG_PTR) Notify;
00851         <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( NotifyIrp );
00852         InsertTailList( &amp;Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o7">NotifyIrps</a>, &amp;NotifyIrp-&gt;Tail.Overlay.ListEntry );
00853 
00854         <span class="comment">//</span>
00855         <span class="comment">//  Increment the reference count to indicate that Irp might go through cancel.</span>
00856         <span class="comment">//</span>
00857 
00858         InterlockedIncrement( &amp;Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o17">ReferenceCount</a> );
00859 
00860         <span class="comment">//</span>
00861         <span class="comment">//  Call the routine to set the cancel routine.</span>
00862         <span class="comment">//</span>
00863 
00864         <a class="code" href="../../d2/d7/notify_8c.html#a20">FsRtlNotifySetCancelRoutine</a>( NotifyIrp, NULL );
00865 
00866     try_exit:  NOTHING;
00867     } finally {
00868 
00869         <span class="comment">//</span>
00870         <span class="comment">//  Release the mutex.</span>
00871         <span class="comment">//</span>
00872 
00873         <a class="code" href="../../d2/d7/notify_8c.html#a12">ReleaseNotifySync</a>( NotifySync );
00874 
00875         <span class="comment">//</span>
00876         <span class="comment">//  If there is still a subject context then release it and deallocate</span>
00877         <span class="comment">//  the structure.  Remember that if FullDirectoryName is null, it means</span>
00878         <span class="comment">//  this is a view index, not a directory index, and the SubjectContext</span>
00879         <span class="comment">//  is really a piece of file system context information.</span>
00880         <span class="comment">//</span>
00881 
00882         <span class="keywordflow">if</span> ((SubjectContext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00883             (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00884 
00885             <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a>( SubjectContext );
00886             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( SubjectContext );
00887         }
00888 
00889         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlNotifyFullChangeDirectory:  Exit\n"</span>, 0 );
00890     }
00891 
00892     <span class="keywordflow">return</span>;
00893 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a174" doxytag="fsrtl.h::FsRtlNotifyFullReportChange" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlNotifyFullReportChange           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifySync</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLIST_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifyList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>FullTargetName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetNameOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING StreamName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING NormalizedParentName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FilterMatch</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Action</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l00973">973</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00274">AcquireNotifySync</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00090">Action</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00187">_NOTIFY_CHANGE::AllocatedBuffer</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00147">ASSERTMSG</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00188">_NOTIFY_CHANGE::Buffer</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00189">_NOTIFY_CHANGE::BufferLength</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00166">_NOTIFY_CHANGE::CharacterSize</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00173">_NOTIFY_CHANGE::CompletionFilter</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00191">_NOTIFY_CHANGE::DataLength</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00056">EXCEPTION_CONTINUE_SEARCH</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00047">FileName</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00159">_NOTIFY_CHANGE::Flags</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00103">_NOTIFY_CHANGE::FsContext</a>, <a class="el" href="../../d8/d2/fsrtl_2filter_8c-source.html#l00082">FsRtlIsNtstatusExpected()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l02467">FsRtlNotifyCompleteIrpList()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l02286">FsRtlNotifyUpdateBuffer()</a>, <a class="el" href="../../d4/d7/fsrtlp_8h-source.html#l00040">FsRtlpAllocatePool</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00139">_NOTIFY_CHANGE::FullDirectoryName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00192">_NOTIFY_CHANGE::LastEntry</a>, <a class="el" href="../../d4/d7/fsrtlp_8h-source.html#l00194">LongAlign</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01596">_IRP::MdlAddress</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01874">MmGetSystemAddressForMdl</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00217">NOTIFY_DEFER_NOTIFY</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00218">NOTIFY_DIR_IS_ROOT</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00215">NOTIFY_IMMEDIATE_NOTIFY</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00214">NOTIFY_WATCH_TREE</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00153">_NOTIFY_CHANGE::NotifyIrps</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00210">_NOTIFY_CHANGE::OwningProcess</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d2/d7/notify_8c.html#a17">PNOTIFY_CHANGE</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00246">PsChargePoolQuota()</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00356">PsReturnPoolQuota()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00284">ReleaseNotifySync</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00130">_NOTIFY_CHANGE::SubjectContext</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00190">_NOTIFY_CHANGE::ThisBufferLength</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00120">_NOTIFY_CHANGE::TraverseCallback</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d6/notify_8c-source.html#l00897">FsRtlNotifyReportChange()</a>.
<p>
<pre class="fragment"><div>00987                    :
00988 
00989     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system when a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> has been modified in
00990     such a way that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will cause a notify change <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to complete.  We walk
00991     through all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify structures looking <span class="keywordflow">for</span> those structures which
00992     would be associated with an ancestor directory of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> name.
00993 
00994     We look <span class="keywordflow">for</span> all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify structures which have a filter match and
00995     then check that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory name in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify structure <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a
00996     proper prefix of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full target name.
00997 
00998     If we find a notify structure which matches <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> above conditions, we
00999     complete all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Irps <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify structure.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure has
01000     no Irps, we mark <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify pending field.
01001 
01002 Arguments:
01003 
01004     NotifySync  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> controlling fast mutex <span class="keywordflow">for</span> <span class="keyword">this</span> notify list.
01005         It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> stored here so that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> can be found <span class="keywordflow">for</span> an <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being
01006         cancelled.
01007 
01008     NotifyList  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify list to add <span class="keyword">this</span>
01009         structure to.
01010 
01011     FullTargetName - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume.
01012 
01013     TargetNameOffset - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offset in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> component
01014         of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name.
01015 
01016     StreamName  -  If present then <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stream name to store with
01017         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filename.
01018 
01019     NormalizedParentName  -  If present <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent name
01020         but <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DOS-ONLY names have been replaced with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> associated <span class="keywordtype">long</span> name.
01021 
01022     FilterMatch  -  This flag field <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> compared with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> completion filter
01023         in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify structure.  If any of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding bits in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01024         completion filter are set, then a notify condition exists.
01025 
01026     <a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a>  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> action code to store in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user's buffer <span class="keywordflow">if</span>
01027         present.
01028 
01029     TargetContext  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context pointers to pass to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
01030         system <span class="keywordflow">if</span> performing a traverse check in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">case</span> of a tree being
01031         watched.
01032 
01033 Return Value:
01034 
01035     None.
01036 
01037 --*/
01038 
01039 {
01040     PLIST_ENTRY NotifyLinks;
01041 
01042     STRING NormalizedParent;
01043     STRING ParentName;
01044     STRING TargetName;
01045 
01046     <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html">PNOTIFY_CHANGE</a> Notify;
01047     STRING TargetParent;
01048     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> NotifyIrp;
01049 
01050     BOOLEAN NotifyIsParent;
01051     BOOLEAN ViewIndex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01052     UCHAR ComponentCount;
01053     ULONG SizeOfEntry;
01054     ULONG CurrentOffset;
01055     ULONG NextEntryOffset;
01056     ULONG ExceptionCode;
01057 
01058     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01059 
01060     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlNotifyFullReportChange:  Entered\n"</span>, 0 );
01061 
01062     <span class="comment">//</span>
01063     <span class="comment">//  If this is a change to the root directory then return immediately.</span>
01064     <span class="comment">//</span>
01065 
01066     <span class="keywordflow">if</span> ((TargetNameOffset == 0) &amp;&amp; (FullTargetName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01067 
01068         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlNotifyFullReportChange:  Exit\n"</span>, 0 );
01069         <span class="keywordflow">return</span>;
01070     }
01071 
01072     ParentName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01073     TargetName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01074 
01075     <span class="comment">//</span>
01076     <span class="comment">//  Acquire exclusive access to the list by acquiring the mutex.</span>
01077     <span class="comment">//</span>
01078 
01079     <a class="code" href="../../d2/d7/notify_8c.html#a11">AcquireNotifySync</a>( NotifySync );
01080 
01081     <span class="comment">//</span>
01082     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
01083     <span class="comment">//</span>
01084 
01085     <span class="keywordflow">try</span> {
01086 
01087         <span class="comment">//</span>
01088         <span class="comment">//  Walk through all the notify blocks.</span>
01089         <span class="comment">//</span>
01090 
01091         <span class="keywordflow">for</span> (NotifyLinks = NotifyList-&gt;Flink;
01092              NotifyLinks != NotifyList;
01093              NotifyLinks = NotifyLinks-&gt;Flink) {
01094 
01095             <span class="comment">//</span>
01096             <span class="comment">//  Obtain the Notify structure from the list entry.</span>
01097             <span class="comment">//</span>
01098 
01099             Notify = CONTAINING_RECORD( NotifyLinks, <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html">NOTIFY_CHANGE</a>, NotifyList );
01100 
01101             <span class="comment">//</span>
01102             <span class="comment">//  The rules for deciding whether this notification applies are</span>
01103             <span class="comment">//  different for view indices versus file name indices (directories).</span>
01104             <span class="comment">//</span>
01105 
01106             <span class="keywordflow">if</span> (FullTargetName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01107 
01108                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>( <span class="stringliteral">"Directory notify handle in view index notify list!"</span>, Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a> == NULL);
01109 
01110                 <span class="comment">//</span>
01111                 <span class="comment">//  Make sure this is the Fcb being watched.</span>
01112                 <span class="comment">//</span>
01113 
01114                 <span class="keywordflow">if</span> (TargetContext != Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o4">SubjectContext</a>) {
01115 
01116                     <span class="keywordflow">continue</span>;
01117                 }
01118 
01119                 TargetParent.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01120                 TargetParent.Length = 0;
01121 
01122                 ViewIndex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01123 
01124             <span class="comment">//</span>
01125             <span class="comment">//  Handle the directory case.</span>
01126             <span class="comment">//</span>
01127 
01128             } <span class="keywordflow">else</span> {
01129 
01130                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>( <span class="stringliteral">"View index notify handle in directory notify list!"</span>, Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a> != NULL);
01131 
01132                 <span class="comment">//</span>
01133                 <span class="comment">//  If the length of the name in the notify block is currently zero then</span>
01134                 <span class="comment">//  someone is doing a rename and we can skip this block.</span>
01135                 <span class="comment">//</span>
01136 
01137                 <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Length == 0) {
01138 
01139                     <span class="keywordflow">continue</span>;
01140                 }
01141 
01142                 <span class="comment">//</span>
01143                 <span class="comment">//  If this filter match is not part of the completion filter then continue.</span>
01144                 <span class="comment">//</span>
01145 
01146                 <span class="keywordflow">if</span> (!(FilterMatch &amp; Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o10">CompletionFilter</a>)) {
01147 
01148                     <span class="keywordflow">continue</span>;
01149                 }
01150 
01151                 <span class="comment">//</span>
01152                 <span class="comment">//  If there is no normalized name then set its value from the full</span>
01153                 <span class="comment">//  file name.</span>
01154                 <span class="comment">//</span>
01155 
01156                 <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( NormalizedParentName )) {
01157                     NormalizedParent.Buffer = FullTargetName-&gt;Buffer;
01158                     NormalizedParent.Length = TargetNameOffset;
01159 
01160                     <span class="keywordflow">if</span> (NormalizedParent.Length != Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a>) {
01161 
01162                         NormalizedParent.Length -= Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a>;
01163                     }
01164 
01165                     NormalizedParent.MaximumLength = NormalizedParent.Length;
01166 
01167                     NormalizedParentName = &amp;NormalizedParent;
01168                 }
01169 
01170                 <span class="comment">//</span>
01171                 <span class="comment">//  If the length of the directory being watched is longer than the</span>
01172                 <span class="comment">//  parent of the modified file then it can't be an ancestor of the</span>
01173                 <span class="comment">//  modified file.</span>
01174                 <span class="comment">//</span>
01175 
01176                 <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Length &gt; NormalizedParentName-&gt;Length) {
01177 
01178                     <span class="keywordflow">continue</span>;
01179                 }
01180 
01181                 <span class="comment">//</span>
01182                 <span class="comment">//  If the lengths match exactly then this can only be the parent of</span>
01183                 <span class="comment">//  the modified file.</span>
01184                 <span class="comment">//</span>
01185 
01186                 <span class="keywordflow">if</span> (NormalizedParentName-&gt;Length == Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Length) {
01187 
01188                     NotifyIsParent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01189 
01190                 <span class="comment">//</span>
01191                 <span class="comment">//  If we are not watching the subtree of this directory then continue.</span>
01192                 <span class="comment">//</span>
01193 
01194                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_WATCH_TREE )) {
01195 
01196                     <span class="keywordflow">continue</span>;
01197 
01198                 <span class="comment">//</span>
01199                 <span class="comment">//  The watched directory can only be an ancestor of the modified</span>
01200                 <span class="comment">//  file.  Make sure that there is legal pathname separator immediately</span>
01201                 <span class="comment">//  after the end of the watched directory name within the normalized name.</span>
01202                 <span class="comment">//  If the watched directory is the root then we know this condition is TRUE.</span>
01203                 <span class="comment">//</span>
01204 
01205                 } <span class="keywordflow">else</span> {
01206 
01207                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_DIR_IS_ROOT )) {
01208 
01209                         <span class="comment">//</span>
01210                         <span class="comment">//  Check for the character size.</span>
01211                         <span class="comment">//</span>
01212 
01213                         <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a> == <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> )) {
01214 
01215                             <span class="keywordflow">if</span> (*(<a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NormalizedParentName-&gt;Buffer,
01216                                            Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Length,
01217                                            PCHAR )) != <span class="charliteral">'\\'</span>) {
01218 
01219                                 <span class="keywordflow">continue</span>;
01220                             }
01221 
01222                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*(<a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NormalizedParentName-&gt;Buffer,
01223                                               Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Length,
01224                                               PWCHAR )) != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>) {
01225 
01226                             <span class="keywordflow">continue</span>;
01227                         }
01228                     }
01229 
01230                     NotifyIsParent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01231                 }
01232 
01233                 <span class="comment">//</span>
01234                 <span class="comment">//  We now have a correct match of the name lengths.  Now verify that the</span>
01235                 <span class="comment">//  characters match exactly.</span>
01236                 <span class="comment">//</span>
01237 
01238                 <span class="keywordflow">if</span> (!RtlEqualMemory( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Buffer,
01239                                      NormalizedParentName-&gt;Buffer,
01240                                      Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Length )) {
01241 
01242                     <span class="keywordflow">continue</span>;
01243                 }
01244 
01245                 <span class="comment">//</span>
01246                 <span class="comment">//  The characters are correct.  Now check in the case of a non-parent</span>
01247                 <span class="comment">//  notify that we have traverse callback.</span>
01248                 <span class="comment">//</span>
01249 
01250                 <span class="keywordflow">if</span> (!NotifyIsParent &amp;&amp;
01251                     Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o3">TraverseCallback</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
01252                     !Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o3">TraverseCallback</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o1">FsContext</a>,
01253                                                TargetContext,
01254                                                Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o4">SubjectContext</a> )) {
01255 
01256                     <span class="keywordflow">continue</span>;
01257                 }
01258             }
01259 
01260             <span class="comment">//</span>
01261             <span class="comment">//  If this entry is going into a buffer then check that</span>
01262             <span class="comment">//  it will fit.</span>
01263             <span class="comment">//</span>
01264 
01265             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_IMMEDIATE_NOTIFY )
01266                 &amp;&amp; Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o13">BufferLength</a> != 0) {
01267 
01268                 ULONG AllocationLength;
01269 
01270                 AllocationLength = 0;
01271                 NotifyIrp = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01272 
01273                 <span class="comment">//</span>
01274                 <span class="comment">//  If we don't already have a buffer then check to see</span>
01275                 <span class="comment">//  if we have any Irps in the list and use the buffer</span>
01276                 <span class="comment">//  length in the Irp.</span>
01277                 <span class="comment">//</span>
01278 
01279                 <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o14">ThisBufferLength</a> == 0) {
01280 
01281                     <span class="comment">//</span>
01282                     <span class="comment">//  If there is an entry in the list then get the length.</span>
01283                     <span class="comment">//</span>
01284 
01285                     <span class="keywordflow">if</span> (!IsListEmpty( &amp;Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o7">NotifyIrps</a> )) {
01286 
01287                         <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
01288 
01289                         NotifyIrp = CONTAINING_RECORD( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o7">NotifyIrps</a>.Flink,
01290                                                        <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>,
01291                                                        Tail.Overlay.ListEntry );
01292 
01293                         IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( NotifyIrp );
01294 
01295                         AllocationLength = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.NotifyDirectory.Length;
01296 
01297                     <span class="comment">//</span>
01298                     <span class="comment">//  Otherwise use the caller's last buffer size.</span>
01299                     <span class="comment">//</span>
01300 
01301                     } <span class="keywordflow">else</span> {
01302 
01303                         AllocationLength = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o13">BufferLength</a>;
01304                     }
01305 
01306                 <span class="comment">//</span>
01307                 <span class="comment">//  Otherwise use the length of the current buffer.</span>
01308                 <span class="comment">//</span>
01309 
01310                 } <span class="keywordflow">else</span> {
01311 
01312                     AllocationLength = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o14">ThisBufferLength</a>;
01313                 }
01314 
01315                 <span class="comment">//</span>
01316                 <span class="comment">//  Build the strings for the relative name.  This includes</span>
01317                 <span class="comment">//  the strings for the parent name, file name and stream</span>
01318                 <span class="comment">//  name.</span>
01319                 <span class="comment">//</span>
01320 
01321                 <span class="keywordflow">if</span> (!NotifyIsParent) {
01322 
01323                     <span class="comment">//</span>
01324                     <span class="comment">//  We need to find the string for the ancestor of this</span>
01325                     <span class="comment">//  file from the watched directory.  If the normalized parent</span>
01326                     <span class="comment">//  name is the same as the parent name then we can use</span>
01327                     <span class="comment">//  the tail of the parent directly.  Otherwise we need to</span>
01328                     <span class="comment">//  count the matching name components and capture the</span>
01329                     <span class="comment">//  final components.</span>
01330                     <span class="comment">//</span>
01331 
01332                     <span class="keywordflow">if</span> (!ViewIndex) {
01333 
01334                         <span class="comment">//</span>
01335                         <span class="comment">//  If the watched directory is the root then we just use the full</span>
01336                         <span class="comment">//  parent name.</span>
01337                         <span class="comment">//</span>
01338 
01339                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_DIR_IS_ROOT ) ||
01340                             NormalizedParentName-&gt;Buffer != FullTargetName-&gt;Buffer) {
01341 
01342                             <span class="comment">//</span>
01343                             <span class="comment">//  If we don't have a string for the parent then construct</span>
01344                             <span class="comment">//  it now.</span>
01345                             <span class="comment">//</span>
01346 
01347                             <span class="keywordflow">if</span> (ParentName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01348 
01349                                 ParentName.Buffer = FullTargetName-&gt;Buffer;
01350                                 ParentName.Length = TargetNameOffset;
01351 
01352                                 <span class="keywordflow">if</span> (ParentName.Length != Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a>) {
01353 
01354                                     ParentName.Length -= Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a>;
01355                                 }
01356 
01357                                 ParentName.MaximumLength = ParentName.Length;
01358                             }
01359 
01360                             <span class="comment">//</span>
01361                             <span class="comment">//  Count through the components of the parent until we have</span>
01362                             <span class="comment">//  swallowed the same number of name components as in the</span>
01363                             <span class="comment">//  watched directory name.  We have the unicode version and</span>
01364                             <span class="comment">//  the Ansi version to watch for.</span>
01365                             <span class="comment">//</span>
01366 
01367                             ComponentCount = 0;
01368                             CurrentOffset = 0;
01369 
01370                             <span class="comment">//</span>
01371                             <span class="comment">//  If this is the root then there is no more to do.</span>
01372                             <span class="comment">//</span>
01373 
01374                             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_DIR_IS_ROOT )) {
01375 
01376                                 NOTHING;
01377 
01378                             } <span class="keywordflow">else</span> {
01379 
01380                                 ULONG ParentComponentCount;
01381                                 ULONG ParentOffset;
01382 
01383                                 ParentComponentCount = 1;
01384                                 ParentOffset = 0;
01385 
01386                                 <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a> == <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> )) {
01387 
01388                                     <span class="comment">//</span>
01389                                     <span class="comment">//  Find the number of components in the parent.  We</span>
01390                                     <span class="comment">//  have to do this for each one because this name and</span>
01391                                     <span class="comment">//  the number of components could have changed.</span>
01392                                     <span class="comment">//</span>
01393 
01394                                     <span class="keywordflow">while</span> (ParentOffset &lt; Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Length) {
01395 
01396                                         <span class="keywordflow">if</span> (*((PCHAR) Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Buffer + ParentOffset) == <span class="charliteral">'\\'</span>) {
01397 
01398                                             ParentComponentCount += 1;
01399                                         }
01400 
01401                                         ParentOffset += 1;
01402                                     }
01403 
01404                                     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01405 
01406                                         <span class="keywordflow">if</span> (*((PCHAR) ParentName.Buffer + CurrentOffset) == <span class="charliteral">'\\'</span>) {
01407 
01408                                             ComponentCount += 1;
01409 
01410                                             <span class="keywordflow">if</span> (ComponentCount == ParentComponentCount) {
01411 
01412                                                 <span class="keywordflow">break</span>;
01413                                             }
01414 
01415                                         }
01416 
01417                                         CurrentOffset += 1;
01418                                     }
01419 
01420                                 } <span class="keywordflow">else</span> {
01421 
01422                                     <span class="comment">//</span>
01423                                     <span class="comment">//  Find the number of components in the parent.  We</span>
01424                                     <span class="comment">//  have to do this for each one because this name and</span>
01425                                     <span class="comment">//  the number of components could have changed.</span>
01426                                     <span class="comment">//</span>
01427 
01428                                     <span class="keywordflow">while</span> (ParentOffset &lt; Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Length / <span class="keyword">sizeof</span>( WCHAR )) {
01429 
01430                                         <span class="keywordflow">if</span> (*((PWCHAR) Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Buffer + ParentOffset) == <span class="charliteral">'\\'</span>) {
01431 
01432                                             ParentComponentCount += 1;
01433                                         }
01434 
01435                                         ParentOffset += 1;
01436                                     }
01437 
01438                                     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01439 
01440                                         <span class="keywordflow">if</span> (*((PWCHAR) ParentName.Buffer + CurrentOffset) == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>) {
01441 
01442                                             ComponentCount += 1;
01443 
01444                                             <span class="keywordflow">if</span> (ComponentCount == ParentComponentCount) {
01445 
01446                                                 <span class="keywordflow">break</span>;
01447                                             }
01448                                         }
01449 
01450                                         CurrentOffset += 1;
01451                                     }
01452 
01453                                     <span class="comment">//</span>
01454                                     <span class="comment">//  Convert characters to bytes.</span>
01455                                     <span class="comment">//</span>
01456 
01457                                     CurrentOffset *= Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a>;
01458                                 }
01459                             }
01460 
01461                             <span class="comment">//</span>
01462                             <span class="comment">//  We now know the offset into the parent name of the separator</span>
01463                             <span class="comment">//  immediately preceding the relative parent name.  Construct the</span>
01464                             <span class="comment">//  target parent name for the buffer.</span>
01465                             <span class="comment">//</span>
01466 
01467                             CurrentOffset += Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a>;
01468 
01469                             TargetParent.Buffer = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( ParentName.Buffer,
01470                                                            CurrentOffset,
01471                                                            PCHAR );
01472                             TargetParent.MaximumLength =
01473                             TargetParent.Length = ParentName.Length - (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) CurrentOffset;
01474 
01475                         <span class="comment">//</span>
01476                         <span class="comment">//  If the normalized is the same as the parent name use the portion</span>
01477                         <span class="comment">//  after the match with the watched directory.</span>
01478                         <span class="comment">//</span>
01479 
01480                         } <span class="keywordflow">else</span> {
01481 
01482                             TargetParent.Buffer = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NormalizedParentName-&gt;Buffer,
01483                                                            (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Length +
01484                                                             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a>),
01485                                                            PCHAR );
01486 
01487                             TargetParent.MaximumLength =
01488                             TargetParent.Length = NormalizedParentName-&gt;Length -
01489                                                   Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Length -
01490                                                   Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a>;
01491 
01492                         }
01493                     }
01494 
01495                 } <span class="keywordflow">else</span> {
01496 
01497                     <span class="comment">//</span>
01498                     <span class="comment">//  The length of the target parent is zero.</span>
01499                     <span class="comment">//</span>
01500 
01501                     TargetParent.Length = 0;
01502                 }
01503 
01504                 <span class="comment">//</span>
01505                 <span class="comment">//  Compute how much buffer space this report will take.</span>
01506                 <span class="comment">//</span>
01507 
01508                 SizeOfEntry = FIELD_OFFSET( FILE_NOTIFY_INFORMATION, FileName );
01509 
01510                 <span class="keywordflow">if</span> (ViewIndex) {
01511 
01512                     <span class="comment">//</span>
01513                     <span class="comment">//  In the view index case, the information to copy to the</span>
01514                     <span class="comment">//  buffer comes to us in the stream name, and that is all</span>
01515                     <span class="comment">//  the room we need to worry about having.</span>
01516                     <span class="comment">//</span>
01517 
01518                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ARGUMENT_PRESENT( StreamName ));
01519 
01520                     SizeOfEntry += StreamName-&gt;Length;
01521 
01522                 } <span class="keywordflow">else</span> {
01523 
01524                     <span class="comment">//</span>
01525                     <span class="comment">//  If there is a parent to report, find the size and include a separator</span>
01526                     <span class="comment">//  character.</span>
01527                     <span class="comment">//</span>
01528 
01529                     <span class="keywordflow">if</span> (!NotifyIsParent) {
01530 
01531                         <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a> == <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> )) {
01532 
01533                             SizeOfEntry += RtlOemStringToCountedUnicodeSize( &amp;TargetParent );
01534 
01535                         } <span class="keywordflow">else</span> {
01536 
01537                             SizeOfEntry += TargetParent.Length;
01538                         }
01539 
01540                         <span class="comment">//</span>
01541                         <span class="comment">//  Include the separator.  This is always a unicode character.</span>
01542                         <span class="comment">//</span>
01543 
01544                         SizeOfEntry += <span class="keyword">sizeof</span>( WCHAR );
01545                     }
01546 
01547                     <span class="comment">//</span>
01548                     <span class="comment">//  If we don't have the string for the target then construct it now.</span>
01549                     <span class="comment">//</span>
01550 
01551                     <span class="keywordflow">if</span> (TargetName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01552 
01553                         TargetName.Buffer = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( FullTargetName-&gt;Buffer, TargetNameOffset, PCHAR );
01554                         TargetName.MaximumLength =
01555                         TargetName.Length = FullTargetName-&gt;Length - TargetNameOffset;
01556                     }
01557 
01558                     <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a> == <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> )) {
01559 
01560                         SizeOfEntry += RtlOemStringToCountedUnicodeSize( &amp;TargetName );
01561 
01562                     } <span class="keywordflow">else</span> {
01563 
01564                         SizeOfEntry += TargetName.Length;
01565                     }
01566 
01567                     <span class="comment">//</span>
01568                     <span class="comment">//  If there is a stream name then add the bytes needed</span>
01569                     <span class="comment">//  for that.</span>
01570                     <span class="comment">//</span>
01571 
01572                     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( StreamName )) {
01573 
01574                         <span class="comment">//</span>
01575                         <span class="comment">//  Add the space needed for the ':' separator.</span>
01576                         <span class="comment">//</span>
01577 
01578                         <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a> == <span class="keyword">sizeof</span>( WCHAR )) {
01579 
01580                             SizeOfEntry += (StreamName-&gt;Length + <span class="keyword">sizeof</span>( WCHAR ));
01581 
01582                         } <span class="keywordflow">else</span> {
01583 
01584                             SizeOfEntry += (RtlOemStringToCountedUnicodeSize( StreamName )
01585                                             + <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> ));
01586                         }
01587                     }
01588                 }
01589 
01590                 <span class="comment">//</span>
01591                 <span class="comment">//  Remember if this report would overflow the buffer.</span>
01592                 <span class="comment">//</span>
01593 
01594                 NextEntryOffset = (ULONG)<a class="code" href="../../d3/d8/fsrtlp_8h.html#a10">LongAlign</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o15">DataLength</a> );
01595 
01596                 <span class="keywordflow">if</span> (SizeOfEntry &lt;= AllocationLength
01597                     &amp;&amp; (NextEntryOffset + SizeOfEntry) &lt;= AllocationLength) {
01598 
01599                     PFILE_NOTIFY_INFORMATION NotifyInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01600 
01601                     <span class="comment">//</span>
01602                     <span class="comment">//  If there is already a notify buffer, we append this</span>
01603                     <span class="comment">//  data to it.</span>
01604                     <span class="comment">//</span>
01605 
01606                     <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01607 
01608                         NotifyInfo = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a>,
01609                                               Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o16">LastEntry</a>,
01610                                               PFILE_NOTIFY_INFORMATION );
01611 
01612                         NotifyInfo-&gt;NextEntryOffset = NextEntryOffset - Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o16">LastEntry</a>;
01613 
01614                         Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o16">LastEntry</a> = NextEntryOffset;
01615 
01616                         NotifyInfo = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a>,
01617                                               Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o16">LastEntry</a>,
01618                                               PFILE_NOTIFY_INFORMATION );
01619 
01620                     <span class="comment">//</span>
01621                     <span class="comment">//  If there is an Irp list we check whether we will need</span>
01622                     <span class="comment">//  to allocate a new buffer.</span>
01623                     <span class="comment">//</span>
01624 
01625                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NotifyIrp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01626 
01627                         <span class="keywordflow">if</span> (NotifyIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01628 
01629                             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a> =
01630                             NotifyInfo = NotifyIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer;
01631 
01632                             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o14">ThisBufferLength</a> = AllocationLength;
01633 
01634                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NotifyIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01635 
01636                             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a> =
01637                             NotifyInfo = <a class="code" href="../../d2/d1/mm_8h.html#a26">MmGetSystemAddressForMdl</a>( NotifyIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> );
01638 
01639                             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o14">ThisBufferLength</a> = AllocationLength;
01640                         }
01641                     }
01642 
01643                     <span class="comment">//</span>
01644                     <span class="comment">//  If we need to allocate a buffer, we will charge quota</span>
01645                     <span class="comment">//  to the original process and allocate paged pool.</span>
01646                     <span class="comment">//</span>
01647 
01648                     <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01649 
01650                         BOOLEAN ChargedQuota = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01651 
01652                         <span class="keywordflow">try</span> {
01653 
01654                             <a class="code" href="../../d0/d2/psquota_8c.html#a2">PsChargePoolQuota</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o18">OwningProcess</a>,
01655                                                PagedPool,
01656                                                AllocationLength );
01657 
01658                             ChargedQuota = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01659 
01660                             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o11">AllocatedBuffer</a> =
01661                             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a> = <a class="code" href="../../d3/d8/fsrtlp_8h.html#a2">FsRtlpAllocatePool</a>( PagedPool,
01662                                                                  AllocationLength );
01663 
01664                             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o14">ThisBufferLength</a> = AllocationLength;
01665 
01666                             NotifyInfo = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a>;
01667 
01668                         } except(( ExceptionCode = GetExceptionCode(), <a class="code" href="../../d1/d8/fsrtl_8h.html#a137">FsRtlIsNtstatusExpected</a>(ExceptionCode))
01669                                   ? EXCEPTION_EXECUTE_HANDLER
01670                                   : EXCEPTION_CONTINUE_SEARCH ) {
01671 
01672                             
01673                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (ExceptionCode == STATUS_INSUFFICIENT_RESOURCES) ||
01674                                     (ExceptionCode == STATUS_QUOTA_EXCEEDED) );
01675 
01676                             <span class="comment">//</span>
01677                             <span class="comment">//  Return quota if we allocated the buffer.</span>
01678                             <span class="comment">//</span>
01679 
01680                             <span class="keywordflow">if</span> (ChargedQuota) {
01681 
01682                                 <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o18">OwningProcess</a>,
01683                                                    PagedPool,
01684                                                    AllocationLength );
01685 
01686                             }
01687 
01688                             <span class="comment">//</span>
01689                             <span class="comment">//  Forget any current buffer and resort to immediate</span>
01690                             <span class="comment">//  notify.</span>
01691                             <span class="comment">//</span>
01692 
01693                             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_IMMEDIATE_NOTIFY );
01694                         }
01695                     }
01696 
01697                     <span class="comment">//</span>
01698                     <span class="comment">//  If we have a buffer then fill in the results</span>
01699                     <span class="comment">//  from this operation.  Otherwise we remember</span>
01700                     <span class="comment">//  to simply alert the caller.</span>
01701                     <span class="comment">//</span>
01702 
01703                     <span class="keywordflow">if</span> (NotifyInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01704 
01705                         <span class="comment">//</span>
01706                         <span class="comment">//  Update the buffer with the current data.</span>
01707                         <span class="comment">//</span>
01708 
01709                         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/notify_8c.html#a21">FsRtlNotifyUpdateBuffer</a>( NotifyInfo,
01710                                                      Action,
01711                                                      &amp;TargetParent,
01712                                                      &amp;TargetName,
01713                                                      StreamName,
01714                                                      (BOOLEAN) (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a> == <span class="keyword">sizeof</span>( WCHAR )),
01715                                                      SizeOfEntry )) {
01716 
01717                             <span class="comment">//</span>
01718                             <span class="comment">//  Update the buffer data length.</span>
01719                             <span class="comment">//</span>
01720 
01721                             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o15">DataLength</a> = NextEntryOffset + SizeOfEntry;
01722 
01723                         <span class="comment">//</span>
01724                         <span class="comment">//  We couldn't copy the data into the buffer.  Just</span>
01725                         <span class="comment">//  notify without any additional information.</span>
01726                         <span class="comment">//</span>
01727 
01728                         } <span class="keywordflow">else</span> {
01729 
01730                             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_IMMEDIATE_NOTIFY );
01731                         }
01732                     }
01733 
01734                 } <span class="keywordflow">else</span> {
01735 
01736                     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_IMMEDIATE_NOTIFY );
01737                 }
01738 
01739                 <span class="comment">//</span>
01740                 <span class="comment">//  If we have a buffer but can't use it then clear all of the</span>
01741                 <span class="comment">//  buffer related fields.  Also deallocate any buffer allocated</span>
01742                 <span class="comment">//  by us.</span>
01743                 <span class="comment">//</span>
01744 
01745                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_IMMEDIATE_NOTIFY )
01746                     &amp;&amp; Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01747 
01748                     <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o11">AllocatedBuffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01749 
01750                         <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o18">OwningProcess</a>,
01751                                            PagedPool,
01752                                            Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o14">ThisBufferLength</a> );
01753 
01754                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o11">AllocatedBuffer</a> );
01755                     }
01756 
01757                     Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o11">AllocatedBuffer</a> = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01758 
01759                     Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o14">ThisBufferLength</a> = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o15">DataLength</a> = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o16">LastEntry</a> = 0;
01760                 }
01761             }
01762 
01763             <span class="comment">//</span>
01764             <span class="comment">//  Complete the next entry on the list if we aren't holding</span>
01765             <span class="comment">//  up notification.</span>
01766             <span class="comment">//</span>
01767 
01768             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> == FILE_ACTION_RENAMED_OLD_NAME) {
01769 
01770                 <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_DEFER_NOTIFY );
01771 
01772             } <span class="keywordflow">else</span> {
01773 
01774                 <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_DEFER_NOTIFY );
01775 
01776                 <span class="keywordflow">if</span> (!IsListEmpty( &amp;Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o7">NotifyIrps</a> )) {
01777 
01778                     <a class="code" href="../../d2/d7/notify_8c.html#a32">FsRtlNotifyCompleteIrpList</a>( Notify, STATUS_SUCCESS );
01779                 }
01780             }
01781         }
01782 
01783     } finally {
01784 
01785         <a class="code" href="../../d2/d7/notify_8c.html#a12">ReleaseNotifySync</a>( NotifySync );
01786 
01787         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlNotifyFullReportChange:  Exit\n"</span>, 0 );
01788     }
01789 
01790     <span class="keywordflow">return</span>;
01791 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a169" doxytag="fsrtl.h::FsRtlNotifyInitializeSync" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlNotifyInitializeSync           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>NotifySync</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l00371">371</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02274">ERESOURCE_THREAD</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00367">ExInitializeFastMutex</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00076">_REAL_NOTIFY_SYNC::FastMutex</a>, <a class="el" href="../../d4/d7/fsrtlp_8h-source.html#l00040">FsRtlpAllocatePool</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00078">_REAL_NOTIFY_SYNC::OwnerCount</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00077">_REAL_NOTIFY_SYNC::OwningThread</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01443">PNOTIFY_SYNC</a>, and <a class="el" href="../../d2/d7/notify_8c.html#a15">PREAL_NOTIFY_SYNC</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00331">UdfInitializeVcb()</a>.
<p>
<pre class="fragment"><div>00377                    :
00378 
00379     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to allocate and initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> synchronization object
00380     <span class="keywordflow">for</span> <span class="keyword">this</span> notify list.
00381 
00382 Arguments:
00383 
00384     NotifySync  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure we allocate.
00385 
00386 Return Value:
00387 
00388     None.
00389 
00390 --*/
00391 
00392 {
00393     <a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html">PREAL_NOTIFY_SYNC</a> RealSync;
00394 
00395     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00396 
00397     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlNotifyInitializeSync:  Entered\n"</span>, 0 );
00398 
00399     <span class="comment">//</span>
00400     <span class="comment">//  Clear the pointer and then attempt to allocate a non-paged</span>
00401     <span class="comment">//  structure.</span>
00402     <span class="comment">//</span>
00403 
00404     *NotifySync = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00405 
00406     RealSync = (<a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html">PREAL_NOTIFY_SYNC</a>) <a class="code" href="../../d3/d8/fsrtlp_8h.html#a2">FsRtlpAllocatePool</a>( NonPagedPool,
00407                                                        <span class="keyword">sizeof</span>( <a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html">REAL_NOTIFY_SYNC</a> ));
00408 
00409     <span class="comment">//</span>
00410     <span class="comment">//  Initialize the structure.</span>
00411     <span class="comment">//</span>
00412 
00413     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>( &amp;RealSync-&gt;<a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html#o0">FastMutex</a> );
00414     RealSync-&gt;<a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html#o1">OwningThread</a> = (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>) 0;
00415     RealSync-&gt;<a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html#o2">OwnerCount</a> = 0;
00416 
00417     *NotifySync = (<a class="code" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a>) RealSync;
00418 
00419     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlNotifyInitializeSync:  Exit\n"</span>, 0 );
00420     <span class="keywordflow">return</span>;
00421 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a173" doxytag="fsrtl.h::FsRtlNotifyReportChange" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlNotifyReportChange           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifySync</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLIST_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifyList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>FullTargetName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FilterMatch</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l00897">897</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00973">FsRtlNotifyFullReportChange()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>00907                    :
00908 
00909     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system when a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> has been modified in
00910     such a way that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will cause a notify change <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to complete.  We walk
00911     through all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify structures looking <span class="keywordflow">for</span> those structures which
00912     would be associated with an ancestor directory of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> name.
00913 
00914     We look <span class="keywordflow">for</span> all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify structures which have a filter match and
00915     then check that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory name in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify structure <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a
00916     proper prefix of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full target name.
00917 
00918     If we find a notify structure which matches <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> above conditions, we
00919     complete all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Irps <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify structure.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure has
00920     no Irps, we mark <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify pending field.
00921 
00922 Arguments:
00923 
00924     NotifySync  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> controlling fast mutex <span class="keywordflow">for</span> <span class="keyword">this</span> notify list.
00925         It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> stored here so that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> can be found <span class="keywordflow">for</span> an <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being
00926         cancelled.
00927 
00928     NotifyList  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify list to add <span class="keyword">this</span>
00929                    structure to.
00930 
00931     FullTargetName  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> which has been
00932                        changed.
00933 
00934     TargetName  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> component of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> modified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00935 
00936     FilterMatch  -  This flag field <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> compared with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> completion filter
00937                     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify structure.  If any of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding
00938                     bits in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> completion filter are set, then a notify
00939                     condition exists.
00940 
00941 Return Value:
00942 
00943     None.
00944 
00945 --*/
00946 
00947 {
00948     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00949 
00950     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlNotifyReportChange:  Entered\n"</span>, 0 );
00951 
00952     <span class="comment">//</span>
00953     <span class="comment">//  Call the full notify routine to do the actual work.</span>
00954     <span class="comment">//</span>
00955 
00956     <a class="code" href="../../d1/d8/fsrtl_8h.html#a174">FsRtlNotifyFullReportChange</a>( NotifySync,
00957                                  NotifyList,
00958                                  FullTargetName,
00959                                  (USHORT) (FullTargetName-&gt;Length - TargetName-&gt;Length),
00960                                  NULL,
00961                                  NULL,
00962                                  FilterMatch,
00963                                  0,
00964                                  NULL );
00965 
00966     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlNotifyReportChange:  Exit\n"</span>, 0 );
00967 
00968     <span class="keywordflow">return</span>;
00969 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a170" doxytag="fsrtl.h::FsRtlNotifyUninitializeSync" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlNotifyUninitializeSync           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>NotifySync</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l00426">426</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01210">UdfDeleteVcb()</a>.
<p>
<pre class="fragment"><div>00432                    :
00433 
00434     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to uninitialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> synchronization object
00435     <span class="keywordflow">for</span> <span class="keyword">this</span> notify list.
00436 
00437 Arguments:
00438 
00439     NotifySync  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to our synchronization
00440         object.
00441 
00442 Return Value:
00443 
00444     None.
00445 
00446 --*/
00447 
00448 {
00449     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00450 
00451     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlNotifyUninitializeSync:  Entered\n"</span>, 0 );
00452 
00453     <span class="comment">//</span>
00454     <span class="comment">//  Free the structure if present and clear the pointer.</span>
00455     <span class="comment">//</span>
00456 
00457     <span class="keywordflow">if</span> (*NotifySync != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00458 
00459         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( *NotifySync );
00460         *NotifySync = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00461     }
00462 
00463     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlNotifyUninitializeSync:  Exit\n"</span>, 0 );
00464     <span class="keywordflow">return</span>;
00465 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a168" doxytag="fsrtl.h::FsRtlNotifyVolumeEvent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI NTSTATUS FsRtlNotifyVolumeEvent           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>EventCode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d8/fsrtl_2pnp_8c-source.html#l00041">41</a> of file <a class="el" href="../../d4/d8/fsrtl_2pnp_8c-source.html">fsrtl/pnp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01421">FSRTL_VOLUME_DISMOUNT</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01422">FSRTL_VOLUME_DISMOUNT_FAILED</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01423">FSRTL_VOLUME_LOCK</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01424">FSRTL_VOLUME_LOCK_FAILED</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01426">FSRTL_VOLUME_MOUNT</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01425">FSRTL_VOLUME_UNLOCK</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08120">IoGetRelatedTargetDevice()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06017">IoReportTargetDeviceChange()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06118">IoReportTargetDeviceChangeAsynchronous()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a81">TARGET_DEVICE_CUSTOM_NOTIFICATION</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html#l00042">UdfCommonCleanup()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00966">UdfDismountVolume()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00780">UdfLockVolume()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01444">UdfMountVolume()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00877">UdfUnlockVolume()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02043">UdfVerifyVolume()</a>.
<p>
<pre class="fragment"><div>00048                    :
00049 
00050     This routine notifies any registered applications that a 
00051     volume <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being locked, unlocked, etc.  
00052 
00053 Arguments:
00054 
00055     FileeObject - Supplies a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume being
00056         locked.
00057 
00058     EventCode - Which event <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> occuring -- e.g. <a class="code" href="../../d1/d8/fsrtl_8h.html#a41">FSRTL_VOLUME_LOCK</a>
00059         
00060 Return Value:
00061 
00062     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notification.
00063 
00064 --*/
00065 
00066 {
00067     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00068 
00069     <a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html">TARGET_DEVICE_CUSTOM_NOTIFICATION</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00070     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> Pdo;
00071 
00072     <span class="comment">//</span>
00073     <span class="comment">//  Retrieve the device object associated with this file object.</span>
00074     <span class="comment">//</span>
00075 
00076     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a108">IoGetRelatedTargetDevice</a>( FileObject, &amp;Pdo );
00077 
00078     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00079 
00080         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Pdo != NULL);
00081 
00082         <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.Version = 1;
00083         <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.FileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00084         <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.NameBufferOffset = -1;
00085         <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.Size = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)FIELD_OFFSET( <a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html">TARGET_DEVICE_CUSTOM_NOTIFICATION</a>, CustomDataBuffer );
00086 
00087         <span class="keywordflow">switch</span> (EventCode) {
00088 
00089         <span class="keywordflow">case</span> <a class="code" href="../../d1/d8/fsrtl_8h.html#a39">FSRTL_VOLUME_DISMOUNT</a>:
00090             
00091             RtlCopyMemory( &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.Event, &amp;GUID_IO_VOLUME_DISMOUNT, <span class="keyword">sizeof</span>( GUID ));
00092             <span class="keywordflow">break</span>;
00093             
00094         <span class="keywordflow">case</span> <a class="code" href="../../d1/d8/fsrtl_8h.html#a40">FSRTL_VOLUME_DISMOUNT_FAILED</a>:
00095             
00096             RtlCopyMemory( &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.Event, &amp;GUID_IO_VOLUME_DISMOUNT_FAILED, <span class="keyword">sizeof</span>( GUID ));
00097             <span class="keywordflow">break</span>;            
00098 
00099         <span class="keywordflow">case</span> <a class="code" href="../../d1/d8/fsrtl_8h.html#a41">FSRTL_VOLUME_LOCK</a>:
00100         
00101             RtlCopyMemory( &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.Event, &amp;GUID_IO_VOLUME_LOCK, <span class="keyword">sizeof</span>( GUID ));
00102             <span class="keywordflow">break</span>;
00103 
00104         <span class="keywordflow">case</span> <a class="code" href="../../d1/d8/fsrtl_8h.html#a42">FSRTL_VOLUME_LOCK_FAILED</a>:
00105         
00106             RtlCopyMemory( &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.Event, &amp;GUID_IO_VOLUME_LOCK_FAILED, <span class="keyword">sizeof</span>( GUID ));
00107             <span class="keywordflow">break</span>;
00108         
00109         <span class="keywordflow">case</span> <a class="code" href="../../d1/d8/fsrtl_8h.html#a44">FSRTL_VOLUME_MOUNT</a>:
00110             
00111             <span class="comment">//</span>
00112             <span class="comment">//  Mount notification is asynchronous to avoid deadlocks when someone </span>
00113             <span class="comment">//  unwittingly causes a mount in the course of handling some other</span>
00114             <span class="comment">//  PnP notification, e.g. MountMgr's device arrival code.</span>
00115             <span class="comment">//</span>
00116             
00117             RtlCopyMemory( &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.Event, &amp;GUID_IO_VOLUME_MOUNT, <span class="keyword">sizeof</span>( GUID ));
00118             <a class="code" href="../../d8/d0/pnpioapi_8c.html#a99">IoReportTargetDeviceChangeAsynchronous</a>( Pdo, &amp;Event, NULL, NULL );
00119             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Pdo );
00120             <span class="keywordflow">return</span> STATUS_SUCCESS;
00121             <span class="keywordflow">break</span>;
00122 
00123         <span class="keywordflow">case</span> <a class="code" href="../../d1/d8/fsrtl_8h.html#a43">FSRTL_VOLUME_UNLOCK</a>:
00124         
00125             RtlCopyMemory( &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.Event, &amp;GUID_IO_VOLUME_UNLOCK, <span class="keyword">sizeof</span>( GUID ));
00126             <span class="keywordflow">break</span>;
00127             
00128         <span class="keywordflow">default</span>:
00129 
00130             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Pdo );
00131             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00132         }
00133         
00134         <a class="code" href="../../d8/d0/pnpioapi_8c.html#a98">IoReportTargetDeviceChange</a>( Pdo, &amp;Event );
00135         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Pdo );
00136     }
00137 
00138     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00139 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a148" doxytag="fsrtl.h::FsRtlNumberOfRunsInLargeMcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI ULONG FsRtlNumberOfRunsInLargeMcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Mcb</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/largemcb_8c-source.html#l01924">1924</a> of file <a class="el" href="../../d2/d0/largemcb_8c-source.html">largemcb.c</a>.
<p>
References <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00158">_NONOPAQUE_MCB::FastMutex</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00160">_NONOPAQUE_MCB::PairCount</a>, and <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00164">PNONOPAQUE_MCB</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00479">FsRtlNumberOfRunsInMcb()</a>.
<p>
<pre class="fragment"><div>01930                    :
01931 
01932     This routine returns to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> its caller <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of distinct runs
01933     mapped by an Mcb.  Holes (i.e., Vbns that map to Lbn=UNUSED_LBN) are counted
01934     as runs.  For example, an Mcb containing a mapping <span class="keywordflow">for</span> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> Vbns 0 and 3
01935     will have 3 runs, one <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first mapped sector, a second <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01936     hole covering Vbns 1 and 2, and a third <span class="keywordflow">for</span> Vbn 3.
01937 
01938 Arguments:
01939 
01940     OpaqueMcb - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Mcb being examined.
01941 
01942 Return Value:
01943 
01944     ULONG - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of distinct runs mapped by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input Mcb.
01945 
01946 --*/
01947 
01948 {
01949     <a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html">PNONOPAQUE_MCB</a> Mcb = (<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html">PNONOPAQUE_MCB</a>)OpaqueMcb;
01950 
01951     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
01952 
01953     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01954 
01955     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlNumberOfRunsInLargeMcb, Mcb = %08lx\n"</span>, Mcb );
01956 
01957     ExAcquireFastMutex( Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o0">FastMutex</a> );
01958 
01959     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o2">PairCount</a>;
01960 
01961     ExReleaseFastMutex( Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o0">FastMutex</a> );
01962 
01963     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlNumberOfRunsInLargeMcb -&gt; %08lx\n"</span>, Count );
01964 
01965     <span class="keywordflow">return</span> <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
01966 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a158" doxytag="fsrtl.h::FsRtlNumberOfRunsInMcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI ULONG FsRtlNumberOfRunsInMcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d7/struct__MCB.html">PMCB</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Mcb</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00479">479</a> of file <a class="el" href="../../d2/d0/largemcb_8c-source.html">largemcb.c</a>.
<p>
References <a class="el" href="../../d2/d0/largemcb_8c-source.html#l01924">FsRtlNumberOfRunsInLargeMcb()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
<pre class="fragment"><div>00483 {
00484     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00485 
00486     <span class="keywordflow">return</span> <a class="code" href="../../d1/d8/fsrtl_8h.html#a148">FsRtlNumberOfRunsInLargeMcb</a>( (<a class="code" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a>)Mcb );
00487 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a164" doxytag="fsrtl.h::FsRtlOplockFsctrl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI NTSTATUS FsRtlOplockFsctrl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a78">POPLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Oplock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>OpenCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00581">581</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00084">EXCLUSIVE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01533">_FILE_OBJECT::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01504">FO_CLEANUP_COMPLETE</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01678">FsRtlAcknowledgeOplockBreak()</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01745">FsRtlCompleteRequest</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01937">FsRtlOpBatchBreakClosePending()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l02111">FsRtlOplockBreakNotify()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01299">FsRtlRequestExclusiveOplock()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01514">FsRtlRequestOplockII()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07615">IoIsOperationSynchronous()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01556">IRP_INPUT_OPERATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00055">IRP_MJ_CREATE</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00077">LEVEL_I_OPLOCK</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00105">OpFilterReqPending</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00128">OPLOCK_STATE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00470">UdfOplockRequest()</a>.
<p>
<pre class="fragment"><div>00589                    :
00590 
00591     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> interface with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filesystems <span class="keywordflow">for</span> Fsctl calls, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> handles
00592     oplock requests, <span class="keywordflow">break</span> acknowledgement and <span class="keywordflow">break</span> notify.
00593 
00594 Arguments:
00595 
00596     Oplock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> opaque <a class="code" href="../../d1/d8/fsrtl_8h.html#a77">OPLOCK</a> structure.
00597 
00598     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> which declares <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested
00599           operation.
00600 
00601     OpenCount - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of user handles on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <span class="keywordflow">if</span> we are requsting
00602         an exclusive oplock.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> non-zero value <span class="keywordflow">for</span> a level II request indicates
00603         that there are locks on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00604 
00605 Return Value:
00606 
00607     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> result of <span class="keyword">this</span> operation.  If <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an Oplock
00608                request which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> granted, then STATUS_PENDING <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00609                If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Oplock isn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> granted then STATUS_OPLOCK_NOT_GRANTED
00610                <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.  If <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an Oplock I <span class="keywordflow">break</span> to no oplock,
00611                then STATUS_SUCCESS.  If <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an Oplock I <span class="keywordflow">break</span> to
00612                Oplock II then STATUS_PENDING <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.  Other
00613                error codes returned depend on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> nature of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error.
00614 
00615                STATUS_CANCELLED <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> cancelled during
00616                <span class="keyword">this</span> operation.
00617 
00618                STATUS_SUCCESS <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a create asking <span class="keywordflow">for</span>
00619                a filter oplock.
00620 
00621 --*/
00622 
00623 {
00624     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00625     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
00626     <a class="code" href="../../d5/d2/oplock_8c.html#a34">OPLOCK_STATE</a> OplockState;
00627 
00628     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00629 
00630     <span class="comment">//</span>
00631     <span class="comment">//  Get the current IRP stack location</span>
00632     <span class="comment">//</span>
00633 
00634     IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00635 
00636     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlOplockFsctrl:  Entered\n"</span>, 0);
00637     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"FsRtlOplockFsctrl:  Oplock      -&gt; %08lx\n"</span>, *Oplock );
00638     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"FsRtlOplockFsctrl:  Irp         -&gt; %08lx\n"</span>, Irp );
00639 
00640     <span class="comment">//</span>
00641     <span class="comment">//  Check if this is the create case where the user is requesting a pending</span>
00642     <span class="comment">//  filter oplock.</span>
00643     <span class="comment">//</span>
00644 
00645     <span class="keywordflow">if</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> == <a class="code" href="../../d0/d5/io_8h.html#a13">IRP_MJ_CREATE</a>) {
00646 
00647         <span class="comment">//</span>
00648         <span class="comment">//  Check that all the conditions hold to grant this oplock.</span>
00649         <span class="comment">//  The conditions that must hold are:</span>
00650         <span class="comment">//</span>
00651         <span class="comment">//      - This is the only opener of the file.</span>
00652         <span class="comment">//      - Desired Access must be exactly FILE_READ_ATTRIBUTES.</span>
00653         <span class="comment">//          This will insure an asynch open since the SYNCHRONIZE</span>
00654         <span class="comment">//          flag can't be set.</span>
00655         <span class="comment">//      - Share access is precisely</span>
00656         <span class="comment">//          (FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE)</span>
00657         <span class="comment">//</span>
00658 
00659         <span class="keywordflow">if</span> ((OpenCount != 1) ||
00660             (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.SecurityContext-&gt;DesiredAccess,
00661                      ~(FILE_READ_ATTRIBUTES))) ||
00662             ((IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.ShareAccess &amp;
00663               (FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE)) !=
00664              (FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE))) {
00665 
00666             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OPLOCK_NOT_GRANTED;
00667 
00668         } <span class="keywordflow">else</span> {
00669 
00670             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a40">FsRtlRequestExclusiveOplock</a>( (<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a> *) Oplock,
00671                                                   IrpSp,
00672                                                   NULL,
00673                                                   OpFilterReqPending );
00674         }
00675 
00676     <span class="comment">//</span>
00677     <span class="comment">//  Case on the FsControlFile code control code.</span>
00678     <span class="comment">//</span>
00679 
00680     } <span class="keywordflow">else</span> {
00681 
00682         <span class="comment">//</span>
00683         <span class="comment">//  Assume this is an OplockLevel I.</span>
00684         <span class="comment">//</span>
00685         <span class="comment">//  NOTE - This code depends on the defined bits for these oplock types.</span>
00686         <span class="comment">//      FILTER_OPLOCK = 4 * LEVEL_I_OPLOCK</span>
00687         <span class="comment">//      BATCH_OPLOCK = 2 * LEVEL_I_OPLOCK</span>
00688         <span class="comment">//</span>
00689 
00690         OplockState = <a class="code" href="../../d5/d2/oplock_8c.html#a3">LEVEL_I_OPLOCK</a>;
00691 
00692         <span class="keywordflow">switch</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.FileSystemControl.FsControlCode) {
00693 
00694         <span class="keywordflow">case</span> FSCTL_REQUEST_FILTER_OPLOCK :
00695 
00696             OplockState *= 2;
00697 
00698         <span class="keywordflow">case</span> FSCTL_REQUEST_BATCH_OPLOCK :
00699 
00700             OplockState *= 2;
00701 
00702         <span class="keywordflow">case</span> FSCTL_REQUEST_OPLOCK_LEVEL_1 :
00703 
00704             <span class="comment">//</span>
00705             <span class="comment">//  Set the other flags for an exclusive oplock.</span>
00706             <span class="comment">//</span>
00707 
00708             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( OplockState, EXCLUSIVE );
00709 
00710             <span class="comment">//</span>
00711             <span class="comment">//  We short circuit the request if this request is treated</span>
00712             <span class="comment">//  synchronously or the open count is not 1.  Otherwise the Io system</span>
00713             <span class="comment">//  will hold the return code until the Irp is completed.</span>
00714             <span class="comment">//</span>
00715             <span class="comment">//  Also fail this if the flag is set which indicates that</span>
00716             <span class="comment">//  the IO system should copy data back to a user's buffer.</span>
00717             <span class="comment">//</span>
00718             <span class="comment">//  If cleanup has occurrred on this file, then we refuse</span>
00719             <span class="comment">//  the oplock request.</span>
00720             <span class="comment">//</span>
00721 
00722             <span class="keywordflow">if</span> ((OpenCount != 1) ||
00723                 <a class="code" href="../../d4/d6/iosubs_8c.html#a83">IoIsOperationSynchronous</a>( Irp ) ||
00724                 <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a>, IRP_INPUT_OPERATION ) ||
00725                 <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a>, FO_CLEANUP_COMPLETE )) {
00726 
00727                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Irp, STATUS_OPLOCK_NOT_GRANTED );
00728                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OPLOCK_NOT_GRANTED;
00729 
00730             } <span class="keywordflow">else</span> {
00731 
00732                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a40">FsRtlRequestExclusiveOplock</a>( (<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a> *) Oplock,
00733                                                       IrpSp,
00734                                                       Irp,
00735                                                       OplockState );
00736             }
00737 
00738             <span class="keywordflow">break</span>;
00739 
00740         <span class="keywordflow">case</span> FSCTL_REQUEST_OPLOCK_LEVEL_2 :
00741 
00742             <span class="comment">//</span>
00743             <span class="comment">//  We short circuit the request if this request is treated</span>
00744             <span class="comment">//  synchronously.  Otherwise the Io system will hold the return</span>
00745             <span class="comment">//  code until the Irp is completed.</span>
00746             <span class="comment">//</span>
00747             <span class="comment">//  If cleanup has occurrred on this file, then we refuse</span>
00748             <span class="comment">//  the oplock request.</span>
00749             <span class="comment">//</span>
00750             <span class="comment">//  Also fail this if the flag is set which indicates that</span>
00751             <span class="comment">//  the IO system should copy data back to a user's buffer.</span>
00752             <span class="comment">//</span>
00753             <span class="comment">//  A non-zero open count in this case indicates that there are</span>
00754             <span class="comment">//  file locks on the file.  We will also fail the request in</span>
00755             <span class="comment">//  this case.</span>
00756             <span class="comment">//</span>
00757 
00758             <span class="keywordflow">if</span> ((OpenCount != 0) ||
00759                 <a class="code" href="../../d4/d6/iosubs_8c.html#a83">IoIsOperationSynchronous</a>( Irp ) ||
00760                 <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a>, IRP_INPUT_OPERATION ) ||
00761                 <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a>, FO_CLEANUP_COMPLETE )) {
00762 
00763                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Irp, STATUS_OPLOCK_NOT_GRANTED );
00764                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OPLOCK_NOT_GRANTED;
00765 
00766             } <span class="keywordflow">else</span> {
00767 
00768                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a41">FsRtlRequestOplockII</a>( (<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a> *) Oplock,
00769                                                IrpSp,
00770                                                Irp );
00771             }
00772 
00773             <span class="keywordflow">break</span>;
00774 
00775         <span class="keywordflow">case</span> FSCTL_OPLOCK_BREAK_ACKNOWLEDGE :
00776 
00777             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a42">FsRtlAcknowledgeOplockBreak</a>( (<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>) *Oplock,
00778                                                   IrpSp,
00779                                                   Irp,
00780                                                   TRUE );
00781             <span class="keywordflow">break</span>;
00782 
00783         <span class="keywordflow">case</span> FSCTL_OPLOCK_BREAK_ACK_NO_2 :
00784 
00785             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a42">FsRtlAcknowledgeOplockBreak</a>( (<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>) *Oplock,
00786                                                   IrpSp,
00787                                                   Irp,
00788                                                   FALSE );
00789             <span class="keywordflow">break</span>;
00790 
00791         <span class="keywordflow">case</span> FSCTL_OPBATCH_ACK_CLOSE_PENDING :
00792 
00793             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a43">FsRtlOpBatchBreakClosePending</a>( (<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>) *Oplock,
00794                                                     IrpSp,
00795                                                     Irp );
00796             <span class="keywordflow">break</span>;
00797 
00798         <span class="keywordflow">case</span> FSCTL_OPLOCK_BREAK_NOTIFY :
00799 
00800             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d2/oplock_8c.html#a44">FsRtlOplockBreakNotify</a>( (<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>) *Oplock,
00801                                              IrpSp,
00802                                              Irp );
00803             <span class="keywordflow">break</span>;
00804 
00805         <span class="keywordflow">default</span> :
00806 
00807             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0,
00808                         Dbg,
00809                         <span class="stringliteral">"Invalid Control Code\n"</span>,
00810                         0);
00811 
00812             <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Irp, STATUS_INVALID_PARAMETER );
00813             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00814         }
00815     }
00816 
00817     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlOplockFsctrl:  Exit -&gt; %08lx\n"</span>, Status );
00818     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00819 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a166" doxytag="fsrtl.h::FsRtlOplockIsFastIoPossible" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlOplockIsFastIoPossible           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a78">POPLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Oplock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l01116">1116</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00080">LEVEL_II_OPLOCK</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00094">OPLOCK_BREAK_MASK</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00128">OPLOCK_STATE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00152">UdfFastLock()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00436">UdfFastUnlockAll()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00557">UdfFastUnlockAllByKey()</a>, and <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00297">UdfFastUnlockSingle()</a>.
<p>
<pre class="fragment"><div>01122                    :
01123 
01124     This routine indicates to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller where there are any outstanding
01125     oplocks which prevent fast Io from happening.
01126 
01127 Arguments:
01128 
01129     OpLock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> oplock being queried
01130 
01131 Return Value:
01132 
01133     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> there are outstanding oplocks and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
01134 
01135 --*/
01136 
01137 {
01138     BOOLEAN FastIoPossible = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01139 
01140     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01141 
01142     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlOplockIsFastIoPossible: Oplock -&gt; %08lx\n"</span>, *Oplock);
01143 
01144     <span class="comment">//</span>
01145     <span class="comment">//  There are not any current oplocks if the variable is null or</span>
01146     <span class="comment">//  the state is no oplocks held.  If an exclusive oplock was granted</span>
01147     <span class="comment">//  but no break is in progress then allow the Fast IO.</span>
01148     <span class="comment">//</span>
01149 
01150     <span class="keywordflow">if</span> (*Oplock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01151 
01152         <a class="code" href="../../d5/d2/oplock_8c.html#a34">OPLOCK_STATE</a> OplockState;
01153 
01154         OplockState = ((<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>) *Oplock)-&gt;OplockState;
01155 
01156         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( OplockState, LEVEL_II_OPLOCK | OPLOCK_BREAK_MASK )) {
01157 
01158             FastIoPossible = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01159         }
01160     }
01161 
01162     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlOplockIsFastIoPossible: Exit -&gt; %08lx\n"</span>, FastIoPossible);
01163 
01164     <span class="keywordflow">return</span> FastIoPossible;
01165 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a181" doxytag="fsrtl.h::FsRtlPostPagingFileStackOverflow" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlPostPagingFileStackOverflow           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Event</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a83">PFSRTL_STACK_OVERFLOW_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>StackOverflowRoutine</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/stackovf_8c-source.html#l00177">177</a> of file <a class="el" href="../../d5/d4/stackovf_8c-source.html">stackovf.c</a>.
<p>
References <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d5/d4/stackovf_8c-source.html#l00215">FsRtlpPostStackOverflow()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00185                    :
00186 
00187     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> posts a stack overflow item to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack overflow
00188     thread and returns.
00189 
00190 Arguments:
00191 
00192     Context - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context to pass to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack overflow
00193         call back routine.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d3/fetypes_8h.html#a457a418">low</a> order bit <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set, then
00194         <span class="keyword">this</span> overflow was a read to a paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00195 
00196     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> - Supplies a pointer to an event to pass to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack
00197         overflow call back routine.
00198 
00199     StackOverflowRoutine - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call back to use when
00200         processing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> overflow thread.
00201 
00202 Return Value:
00203 
00204     None.
00205 
00206 --*/
00207 
00208 {
00209     <a class="code" href="../../d4/d5/stackovf_8c.html#a5">FsRtlpPostStackOverflow</a>( Context, Event, StackOverflowRoutine, TRUE );
00210     <span class="keywordflow">return</span>;
00211 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a180" doxytag="fsrtl.h::FsRtlPostStackOverflow" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlPostStackOverflow           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Event</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a83">PFSRTL_STACK_OVERFLOW_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>StackOverflowRoutine</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/stackovf_8c-source.html#l00139">139</a> of file <a class="el" href="../../d5/d4/stackovf_8c-source.html">stackovf.c</a>.
<p>
References <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, and <a class="el" href="../../d5/d4/stackovf_8c-source.html#l00215">FsRtlpPostStackOverflow()</a>.
<p>
<pre class="fragment"><div>00147                    :
00148 
00149     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> posts a stack overflow item to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack overflow
00150     thread and returns.
00151 
00152 Arguments:
00153 
00154     Context - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context to pass to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack overflow
00155         call back routine.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d3/fetypes_8h.html#a457a418">low</a> order bit <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set, then
00156         <span class="keyword">this</span> overflow was a read to a paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00157 
00158     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> - Supplies a pointer to an event to pass to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack
00159         overflow call back routine.
00160 
00161     StackOverflowRoutine - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call back to use when
00162         processing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> overflow thread.
00163 
00164 Return Value:
00165 
00166     None.
00167 
00168 --*/
00169 
00170 {
00171     <a class="code" href="../../d4/d5/stackovf_8c.html#a5">FsRtlpPostStackOverflow</a>( Context, Event, StackOverflowRoutine, FALSE );
00172     <span class="keywordflow">return</span>;
00173 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a97" doxytag="fsrtl.h::FsRtlPrepareMdlWrite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlPrepareMdlWrite           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>FileOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>LockKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>MdlChain</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/fastio_8c-source.html#l01860">1860</a> of file <a class="el" href="../../d4/d0/fastio_8c-source.html">fastio.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01403">_DRIVER_OBJECT::FastIoDispatch</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l01474">FsRtlPrepareMdlWriteDev()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06862">IoGetBaseFileSystemDeviceObject()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00960">_FAST_IO_DISPATCH::PrepareMdlWrite</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l00942">_FAST_IO_DISPATCH::SizeOfFastIoDispatch</a>.
<p>
<pre class="fragment"><div>01871                    :
01872 
01873     This routine does a fast cached mdl read bypassing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> usual <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system
01874     entry routine (i.e., without the Irp).  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to <span class="keywordflow">do</span> a copy read
01875     of a cached <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.  For a complete description of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> arguments
01876     see <a class="code" href="../../d7/d5/mdlsup_8c.html#a1">CcMdlRead</a>.
01877 
01878 Arguments:
01879 
01880     FileObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object being read.
01881 
01882     FileOffset - Byte offset in <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <span class="keywordflow">for</span> desired data.
01883 
01884     Length - Length of desired data in bytes.
01885 
01886     MdlChain - On output <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> returns a pointer to an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> chain describing
01887         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired data.
01888 
01889     IoStatus - Pointer to standard I/O status block to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status
01890                <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> transfer.
01891 
01892 Return Value:
01893 
01894     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data was not written, or <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an I/O error.
01895 
01896     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being written
01897 
01898 --*/
01899 
01900 {
01901     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, VolumeDeviceObject;
01902     <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> FastIoDispatch;
01903 
01904     DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject );
01905     FastIoDispatch = DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>;
01906 
01907     <span class="comment">//</span>
01908     <span class="comment">//  See if the (top-level) FileSystem has a FastIo routine, and if so, call it.</span>
01909     <span class="comment">//</span>
01910 
01911     <span class="keywordflow">if</span> ((FastIoDispatch != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01912         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> &gt; FIELD_OFFSET(<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a>, PrepareMdlWrite)) &amp;&amp;
01913         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o18">PrepareMdlWrite</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01914 
01915         <span class="keywordflow">return</span> FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o18">PrepareMdlWrite</a>( FileObject, FileOffset, Length, LockKey, MdlChain, IoStatus, DeviceObject );
01916 
01917     } <span class="keywordflow">else</span> {
01918 
01919         <span class="comment">//</span>
01920         <span class="comment">//  Get the DeviceObject for the volume.  If that DeviceObject is different, and</span>
01921         <span class="comment">//  it specifies the FastIo routine, then we have to return FALSE here and cause</span>
01922         <span class="comment">//  an Irp to get generated.</span>
01923         <span class="comment">//</span>
01924 
01925         VolumeDeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a68">IoGetBaseFileSystemDeviceObject</a>( FileObject );
01926         <span class="keywordflow">if</span> ((VolumeDeviceObject != DeviceObject) &amp;&amp;
01927             (FastIoDispatch = VolumeDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>) &amp;&amp;
01928             (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> &gt; FIELD_OFFSET(<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a>, PrepareMdlWrite)) &amp;&amp;
01929             (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o18">PrepareMdlWrite</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01930 
01931             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01932 
01933         <span class="comment">//</span>
01934         <span class="comment">//  Otherwise, call the default routine.</span>
01935         <span class="comment">//</span>
01936 
01937         } <span class="keywordflow">else</span> {
01938 
01939             <span class="keywordflow">return</span> <a class="code" href="../../d1/d8/fsrtl_8h.html#a101">FsRtlPrepareMdlWriteDev</a>( FileObject, FileOffset, Length, LockKey, MdlChain, IoStatus, DeviceObject );
01940         }
01941     }
01942 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a101" doxytag="fsrtl.h::FsRtlPrepareMdlWriteDev" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlPrepareMdlWriteDev           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>FileOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>LockKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>MdlChain</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/fastio_8c-source.html#l01474">1474</a> of file <a class="el" href="../../d4/d0/fastio_8c-source.html">fastio.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d4/d2/cache_8h.html#a72">CcCanIWrite()</a>, <a class="el" href="../../d5/d1/cache_8h-source.html#l00277">CcGetFileSizePointer</a>, <a class="el" href="../../d8/d4/mdlsup_8c-source.html#l00466">CcPrepareMdlWrite()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l02952">CcZeroData()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00056">EXCEPTION_CONTINUE_SEARCH</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00943">_FAST_IO_DISPATCH::FastIoCheckIfPossible</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01403">_DRIVER_OBJECT::FastIoDispatch</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a188a86">FastIoIsNotPossible</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a188a88">FastIoIsQuestionable</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01502">FO_FILE_MODIFIED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01503">FO_FILE_SIZE_CHANGED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01494">FO_WRITE_THROUGH</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00285">FSRTL_FAST_IO_TOP_LEVEL_IRP</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01772">FsRtlEnterFileSystem</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01795">FsRtlExitFileSystem</a>, <a class="el" href="../../d8/d2/fsrtl_2filter_8c-source.html#l00082">FsRtlIsNtstatusExpected()</a>, <a class="el" href="../../d4/d2/dumpuser_8c-source.html#l00048">Header</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d4/d0/fastio_8c-source.html#l01860">FsRtlPrepareMdlWrite()</a>.
<p>
<pre class="fragment"><div>01486                    :
01487 
01488     This routine does a fast cached mdl read bypassing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> usual <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system
01489     entry routine (i.e., without the Irp).  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to <span class="keywordflow">do</span> a copy read
01490     of a cached <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.  For a complete description of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> arguments
01491     see <a class="code" href="../../d7/d5/mdlsup_8c.html#a1">CcMdlRead</a>.
01492 
01493 Arguments:
01494 
01495     FileObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object being read.
01496 
01497     FileOffset - Byte offset in <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <span class="keywordflow">for</span> desired data.
01498 
01499     Length - Length of desired data in bytes.
01500 
01501     MdlChain - On output <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> returns a pointer to an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> chain describing
01502         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired data.
01503 
01504     IoStatus - Pointer to standard I/O status block to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status
01505                <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> transfer.
01506 
01507     DeviceObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DeviceObject <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callee.
01508 
01509 Return Value:
01510 
01511     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data was not written, or <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an I/O error.
01512 
01513     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being written
01514 
01515 --*/
01516 
01517 {
01518     <a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
01519     LARGE_INTEGER <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>, NewFileSize;
01520     LARGE_INTEGER OldFileSize;
01521     LARGE_INTEGER OldValidDataLength;
01522     BOOLEAN <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01523     BOOLEAN AcquiredShared = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01524     BOOLEAN FileSizeChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01525     BOOLEAN WriteToEndOfFile = (BOOLEAN)((FileOffset-&gt;LowPart == FILE_WRITE_TO_END_OF_FILE) &amp;&amp;
01526                                          (FileOffset-&gt;HighPart == -1));
01527 
01528     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01529 
01530     <span class="comment">//</span>
01531     <span class="comment">//  Call CcCanIWrite.  Also return FALSE if FileObject is write through,</span>
01532     <span class="comment">//  the File System must do that.</span>
01533     <span class="comment">//</span>
01534 
01535     <span class="keywordflow">if</span> ( !<a class="code" href="../../d4/d2/cache_8h.html#a72">CcCanIWrite</a>( FileObject, Length, TRUE, FALSE ) ||
01536          <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( FileObject-&gt;Flags, FO_WRITE_THROUGH )) {
01537 
01538         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01539     }
01540 
01541     <span class="comment">//</span>
01542     <span class="comment">//  Assume our transfer will work</span>
01543     <span class="comment">//</span>
01544 
01545     IoStatus-&gt;Status = STATUS_SUCCESS;
01546 
01547     <span class="comment">//</span>
01548     <span class="comment">//  Special case the zero byte length</span>
01549     <span class="comment">//</span>
01550 
01551     <span class="keywordflow">if</span> (Length == 0) {
01552 
01553         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01554     }
01555 
01556     <span class="comment">//</span>
01557     <span class="comment">//  Get a real pointer to the common fcb header</span>
01558     <span class="comment">//</span>
01559 
01560     <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = (<a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a>)FileObject-&gt;FsContext;
01561 
01562     <span class="comment">//</span>
01563     <span class="comment">//  Enter the file system</span>
01564     <span class="comment">//</span>
01565 
01566     <a class="code" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>();
01567 
01568     <span class="comment">//</span>
01569     <span class="comment">//  Make our best guess on whether we need the file exclusive or</span>
01570     <span class="comment">//  shared.</span>
01571     <span class="comment">//</span>
01572 
01573     NewFileSize.QuadPart = FileOffset-&gt;QuadPart + (LONGLONG)Length;
01574 
01575     <span class="keywordflow">if</span> (WriteToEndOfFile || (NewFileSize.QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.QuadPart)) {
01576 
01577         <span class="comment">//</span>
01578         <span class="comment">//  Acquired exclusive on the common fcb header, and return if we don't</span>
01579         <span class="comment">//  get it.</span>
01580         <span class="comment">//</span>
01581 
01582         <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource, TRUE );
01583 
01584     } <span class="keywordflow">else</span> {
01585 
01586         <span class="comment">//</span>
01587         <span class="comment">//  Acquired shared on the common fcb header, and return if we don't</span>
01588         <span class="comment">//  get it.</span>
01589         <span class="comment">//</span>
01590 
01591         <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource, TRUE );
01592 
01593         AcquiredShared = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01594     }
01595 
01596 
01597     <span class="comment">//</span>
01598     <span class="comment">//  We have the fcb shared now check if we can do fast i/o  and if the file</span>
01599     <span class="comment">//  space is allocated, and if not then release the fcb and return.</span>
01600     <span class="comment">//</span>
01601 
01602     <span class="keywordflow">if</span> (WriteToEndOfFile) {
01603 
01604         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize;
01605         NewFileSize.QuadPart = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.QuadPart + (LONGLONG)Length;
01606 
01607     } <span class="keywordflow">else</span> {
01608 
01609         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = *FileOffset;
01610         NewFileSize.QuadPart = FileOffset-&gt;QuadPart + (LONGLONG)Length;
01611     }
01612 
01613     <span class="comment">//</span>
01614     <span class="comment">//  Now that the File is acquired shared, we can safely test if it is</span>
01615     <span class="comment">//  really cached and if we can do fast i/o and we do not have to extend.</span>
01616     <span class="comment">//  If not then release the fcb and return.</span>
01617     <span class="comment">//</span>
01618 
01619     <span class="keywordflow">if</span> ((FileObject-&gt;PrivateCacheMap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01620         (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;IsFastIoPossible == <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a86">FastIoIsNotPossible</a>) ||
01621         (MAXLONGLONG - <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart &lt; (LONGLONG)Length) ||
01622         ( NewFileSize.QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;AllocationSize.QuadPart ) ) {
01623 
01624         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
01625         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
01626 
01627         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01628     }
01629 
01630     <span class="comment">//</span>
01631     <span class="comment">//  If we will be extending ValidDataLength, we will have to get the</span>
01632     <span class="comment">//  Fcb exclusive, and make sure that FastIo is still possible.</span>
01633     <span class="comment">//</span>
01634 
01635     <span class="keywordflow">if</span> (AcquiredShared &amp;&amp; ( NewFileSize.QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.QuadPart )) {
01636 
01637         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
01638 
01639         <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource, TRUE );
01640 
01641         AcquiredShared = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01642 
01643         <span class="comment">//</span>
01644         <span class="comment">//  If writing to end of file, we must recalculate new size.</span>
01645         <span class="comment">//</span>
01646 
01647         <span class="keywordflow">if</span> (WriteToEndOfFile) {
01648 
01649             <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize;
01650             NewFileSize.QuadPart = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.QuadPart + (LONGLONG)Length;
01651         }
01652 
01653         <span class="keywordflow">if</span> ((FileObject-&gt;PrivateCacheMap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01654             (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;IsFastIoPossible == <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a86">FastIoIsNotPossible</a>) ||
01655             ( NewFileSize.QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;AllocationSize.QuadPart )) {
01656 
01657             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
01658             <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
01659 
01660             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01661         }
01662     }
01663 
01664     <span class="comment">//</span>
01665     <span class="comment">//  Check if fast I/O is questionable and if so then go ask the file system</span>
01666     <span class="comment">//  the answer</span>
01667     <span class="comment">//</span>
01668 
01669     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;IsFastIoPossible == <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a88">FastIoIsQuestionable</a>) {
01670 
01671         <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> FastIoDispatch = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject )-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>;
01672 
01673         <span class="comment">//</span>
01674         <span class="comment">//  All file system then set "Is Questionable" had better support fast I/O</span>
01675         <span class="comment">//</span>
01676 
01677         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FastIoDispatch != NULL);
01678         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o1">FastIoCheckIfPossible</a> != NULL);
01679 
01680         <span class="comment">//</span>
01681         <span class="comment">//  Call the file system to check for fast I/O.  If the answer is anything</span>
01682         <span class="comment">//  other than GoForIt then we cannot take the fast I/O path.</span>
01683         <span class="comment">//</span>
01684 
01685         <span class="keywordflow">if</span> (!FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o1">FastIoCheckIfPossible</a>( FileObject,
01686                                                     FileOffset,
01687                                                     Length,
01688                                                     TRUE,
01689                                                     LockKey,
01690                                                     FALSE, <span class="comment">// write operation</span>
01691                                                     IoStatus,
01692                                                     <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject ) )) {
01693 
01694             <span class="comment">//</span>
01695             <span class="comment">//  Fast I/O is not possible so release the Fcb and return.</span>
01696             <span class="comment">//</span>
01697 
01698             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
01699             <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
01700 
01701             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01702         }
01703     }
01704 
01705     <span class="comment">//</span>
01706     <span class="comment">// Now see if we will change FileSize.  We have to do it now so that our</span>
01707     <span class="comment">// reads are not nooped.</span>
01708     <span class="comment">//</span>
01709 
01710     <span class="keywordflow">if</span> ( NewFileSize.QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.QuadPart ) {
01711 
01712         FileSizeChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01713         OldFileSize = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize;
01714         OldValidDataLength = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength;
01715 
01716         <span class="comment">//</span>
01717         <span class="comment">//  Deal with an extremely rare pathalogical case here the file</span>
01718         <span class="comment">//  size wraps.</span>
01719         <span class="comment">//</span>
01720 
01721         <span class="keywordflow">if</span> ( (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.HighPart != NewFileSize.HighPart) &amp;&amp;
01722              (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
01723 
01724             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource, TRUE );
01725             <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize = NewFileSize;
01726             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource );
01727 
01728         } <span class="keywordflow">else</span> {
01729 
01730             <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize = NewFileSize;
01731         }
01732     }
01733 
01734     <span class="comment">//</span>
01735     <span class="comment">//  We can do fast i/o so call the cc routine to do the work and then</span>
01736     <span class="comment">//  release the fcb when we've done.  If for whatever reason the</span>
01737     <span class="comment">//  copy write fails, then return FALSE to our caller.</span>
01738     <span class="comment">//</span>
01739     <span class="comment">//</span>
01740     <span class="comment">//  Also mark this as the top level "Irp" so that lower file system levels</span>
01741     <span class="comment">//  will not attempt a pop-up</span>
01742     <span class="comment">//</span>
01743 
01744     <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;TopLevelIrp = <a class="code" href="../../d1/d8/fsrtl_8h.html#a14">FSRTL_FAST_IO_TOP_LEVEL_IRP</a>;
01745 
01746     <span class="keywordflow">try</span> {
01747 
01748         <span class="comment">//</span>
01749         <span class="comment">//  See if we have to do some zeroing</span>
01750         <span class="comment">//</span>
01751 
01752         <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.QuadPart ) {
01753 
01754             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d2/cache_8h.html#a66">CcZeroData</a>( FileObject,
01755                                  &amp;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength,
01756                                  &amp;Offset,
01757                                  TRUE );
01758         }
01759 
01760         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
01761 
01762             <a class="code" href="../../d4/d2/cache_8h.html#a81">CcPrepareMdlWrite</a>( FileObject, &amp;Offset, Length, MdlChain, IoStatus );
01763         }
01764 
01765     } except( <a class="code" href="../../d1/d8/fsrtl_8h.html#a137">FsRtlIsNtstatusExpected</a>(GetExceptionCode())
01766                                     ? EXCEPTION_EXECUTE_HANDLER
01767                                     : EXCEPTION_CONTINUE_SEARCH ) {
01768 
01769         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01770     }
01771 
01772     <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;TopLevelIrp = 0;
01773 
01774     <span class="comment">//</span>
01775     <span class="comment">//  If we succeeded, see if we have to update FileSize or ValidDataLength.</span>
01776     <span class="comment">//</span>
01777 
01778     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
01779 
01780         <span class="comment">//</span>
01781         <span class="comment">// In the case of ValidDataLength, we really have to check again</span>
01782         <span class="comment">// since we did not do this when we acquired the resource exclusive.</span>
01783         <span class="comment">//</span>
01784 
01785         <span class="keywordflow">if</span> ( NewFileSize.QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.QuadPart ) {
01786 
01787             <span class="comment">//</span>
01788             <span class="comment">//  Deal with an extremely rare pathalogical case here the</span>
01789             <span class="comment">//  ValidDataLength wraps.</span>
01790             <span class="comment">//</span>
01791 
01792             <span class="keywordflow">if</span> ( (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.HighPart != NewFileSize.HighPart) &amp;&amp;
01793                  (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
01794 
01795                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource, TRUE );
01796                 <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength = NewFileSize;
01797                 <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource );
01798 
01799             } <span class="keywordflow">else</span> {
01800 
01801                 <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength = NewFileSize;
01802             }
01803         }
01804 
01805         <span class="comment">//</span>
01806         <span class="comment">//  Set this handle as having modified the file</span>
01807         <span class="comment">//</span>
01808 
01809         FileObject-&gt;Flags |= <a class="code" href="../../d0/d5/io_8h.html#a162">FO_FILE_MODIFIED</a>;
01810 
01811         <span class="keywordflow">if</span> (FileSizeChanged) {
01812 
01813             *<a class="code" href="../../d4/d2/cache_8h.html#a3">CcGetFileSizePointer</a>(FileObject) = NewFileSize;
01814 
01815             FileObject-&gt;Flags |= <a class="code" href="../../d0/d5/io_8h.html#a163">FO_FILE_SIZE_CHANGED</a>;
01816         }
01817 
01818     <span class="comment">//</span>
01819     <span class="comment">//  If we did not succeed, then we must restore the original FileSize</span>
01820     <span class="comment">//  and release the resource.  In the success path, the cache manager</span>
01821     <span class="comment">//  will release the resource.</span>
01822     <span class="comment">//</span>
01823 
01824     } <span class="keywordflow">else</span> {
01825 
01826         <span class="keywordflow">if</span> (FileSizeChanged) {
01827 
01828             <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01829 
01830                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource, TRUE );
01831                 <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize = OldFileSize;
01832                 <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength = OldValidDataLength;
01833                 <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource );
01834 
01835             } <span class="keywordflow">else</span> {
01836 
01837                 <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize = OldFileSize;
01838                 <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength = OldValidDataLength;
01839             }
01840         }
01841     }
01842 
01843     <span class="comment">//</span>
01844     <span class="comment">//  Now we can release the resource.</span>
01845     <span class="comment">//</span>
01846 
01847     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
01848 
01849     <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
01850 
01851     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01852 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a125" doxytag="fsrtl.h::FsRtlPrivateLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlPrivateLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileLock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>FileOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Key</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>FailImmediately</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ExclusiveLock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>Iosb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AlreadySynchronized</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l03867">3867</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01661">_IRP::Cancel</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01667">_IRP::CancelIrql</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00112">_WAITING_LOCK::Context</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00576">_FILE_LOCK_INFO::EndingByte</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00562">_FILE_LOCK_INFO::ExclusiveLock</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00569">_FILE_LOCK_INFO::FileObject</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00481">FsRtlAcquireLockQueue</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00409">FsRtlAllocateWaitingLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00497">FsRtlCompleteLockIrp</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05721">FsRtlPrivateCancelFileLockIrp()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l04934">FsRtlPrivateCheckForExclusiveLockAccess()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l05046">FsRtlPrivateCheckForSharedLockAccess()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00888">FsRtlPrivateInitializeFileLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l04253">FsRtlPrivateInsertLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03162">FsRtlPrivateRemoveLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00487">FsRtlReleaseLockQueue</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03620">IoMarkIrpPending</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03867">IoSetCancelRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00118">_WAITING_LOCK::Irp</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00568">_FILE_LOCK_INFO::Key</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00561">_FILE_LOCK_INFO::Length</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00105">_WAITING_LOCK::Link</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00184">_LOCK_INFO::LockQueue</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a30">PLOCK_INFO</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a28">PLOCK_QUEUE</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00570">_FILE_LOCK_INFO::ProcessId</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a26">PWAITING_LOCK</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00560">_FILE_LOCK_INFO::StartingByte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02154">try_return</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00142">_LOCK_QUEUE::WaitingLocks</a>, and <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00143">_LOCK_QUEUE::WaitingLocksTail</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l01173">FsRtlProcessFileLock()</a>.
<p>
<pre class="fragment"><div>03884                    :
03885 
03886     This routine preforms a lock operation request.  This handles both <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fast
03887     get lock and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> based get lock.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> supplied then
03888     <span class="keyword">this</span> routine will either complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> or enqueue <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> as a waiting
03889     lock request.
03890 
03891 Arguments:
03892 
03893     FileLock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> to work against
03894 
03895     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object used in <span class="keyword">this</span> operation
03896 
03897     FileOffset - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> offset used in <span class="keyword">this</span> operation
03898 
03899     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length used in <span class="keyword">this</span> operation
03900 
03901     ProcessId - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> used in <span class="keyword">this</span> operation
03902 
03903     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key used in <span class="keyword">this</span> operation
03904 
03905     FailImmediately - Indicates <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request should fail immediately
03906         <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock cannot be granted.
03907 
03908     ExclusiveLock - Indicates <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a request <span class="keywordflow">for</span> an exclusive or
03909         shared lock
03910 
03911     Iosb - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> <span class="keywordflow">if</span> <span class="keyword">this</span> operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> successful
03912 
03913     Context - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context with which to complete <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> with
03914 
03915     AlreadySynchronized - Indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller has already <span class="keyword">synchronized</span>
03916         access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock so <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fields in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock and
03917         be updated without further locking, but not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> queues.
03918 
03919 Return Value:
03920 
03921     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <span class="keyword">this</span> operation completed and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
03922 
03923 --*/
03924 
03925 {
03926     BOOLEAN Results;
03927     BOOLEAN AccessGranted;
03928     BOOLEAN ViaFastCall;
03929     BOOLEAN ReleaseQueue = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03930 
03931     <a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>  LockInfo;
03932     <a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html">PLOCK_QUEUE</a> LockQueue;
03933     KIRQL       OldIrql;
03934     <a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html">FILE_LOCK_INFO</a> FileLockInfo;
03935 
03936     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlPrivateLock, FileLock = %08lx\n"</span>, FileLock);
03937 
03938     <span class="comment">//</span>
03939     <span class="comment">//  If the irp is null then this is being called via the fast call method.</span>
03940     <span class="comment">//</span>
03941 
03942     ViaFastCall = (BOOLEAN) !ARGUMENT_PRESENT( Irp );
03943 
03944     <span class="keywordflow">if</span> ((LockInfo = (<a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>) FileLock-&gt;LockInformation) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03945         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+2, Dbg, <span class="stringliteral">"FsRtlPrivateLock, New LockInfo required\n"</span>, 0);
03946 
03947         <span class="comment">//</span>
03948         <span class="comment">// No lock information on this FileLock, create the structure.</span>
03949         <span class="comment">//</span>
03950         <span class="comment">//</span>
03951 
03952         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d3/filelock_8c.html#a54">FsRtlPrivateInitializeFileLock</a> (FileLock, ViaFastCall)) {
03953 
03954             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03955         }
03956 
03957         <span class="comment">//</span>
03958         <span class="comment">// Set flag so file locks will be checked on the fast io</span>
03959         <span class="comment">// code paths</span>
03960         <span class="comment">//</span>
03961 
03962         FileLock-&gt;FastIoIsQuestionable = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03963 
03964         <span class="comment">//</span>
03965         <span class="comment">// Pickup allocated lockinfo structure</span>
03966         <span class="comment">//</span>
03967 
03968         LockInfo = (<a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>) FileLock-&gt;LockInformation;
03969     }
03970 
03971     <span class="comment">//</span>
03972     <span class="comment">// Assume success and build LockData structure prior to acquiring</span>
03973     <span class="comment">// the lock queue spinlock.  (mp perf enhancement)</span>
03974     <span class="comment">//</span>
03975 
03976     FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o0">StartingByte</a> = *FileOffset;
03977     FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o1">Length</a> = *Length;
03978     (ULONGLONG)FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o6">EndingByte</a>.QuadPart =
03979             (ULONGLONG)FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o0">StartingByte</a>.QuadPart + (ULONGLONG)FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o1">Length</a>.QuadPart - 1;
03980 
03981     FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o3">Key</a> = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
03982     FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o4">FileObject</a> = FileObject;
03983     FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o5">ProcessId</a> = ProcessId;
03984     FileLockInfo.<a class="code" href="../../d8/d1/struct__FILE__LOCK__INFO.html#o2">ExclusiveLock</a> = ExclusiveLock;
03985 
03986     LockQueue = &amp;LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>;
03987 
03988     <span class="comment">//</span>
03989     <span class="comment">//  Now we need to actually run through our current lock queue.</span>
03990     <span class="comment">//</span>
03991 
03992     <a class="code" href="../../d5/d3/filelock_8c.html#a8">FsRtlAcquireLockQueue</a>(LockQueue, &amp;OldIrql);
03993     ReleaseQueue = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03994 
03995     <span class="keywordflow">try</span> {
03996 
03997         <span class="comment">//</span>
03998         <span class="comment">//  Case on whether we're trying to take out an exclusive lock or</span>
03999         <span class="comment">//  a shared lock.  And in both cases try to get appropriate access.</span>
04000         <span class="comment">//</span>
04001 
04002         <span class="keywordflow">if</span> (ExclusiveLock) {
04003 
04004             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"Check for write access\n"</span>, 0);
04005 
04006             AccessGranted = <a class="code" href="../../d5/d3/filelock_8c.html#a51">FsRtlPrivateCheckForExclusiveLockAccess</a>(
04007                                 LockQueue,
04008                                 &amp;FileLockInfo );
04009 
04010         } <span class="keywordflow">else</span> {
04011 
04012             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"Check for read access\n"</span>, 0);
04013 
04014             AccessGranted = <a class="code" href="../../d5/d3/filelock_8c.html#a52">FsRtlPrivateCheckForSharedLockAccess</a>(
04015                                 LockQueue,
04016                                 &amp;FileLockInfo );
04017         }
04018 
04019         <span class="comment">//</span>
04020         <span class="comment">//  Now AccessGranted tells us whether we can really get the access</span>
04021         <span class="comment">//  for the range we want</span>
04022         <span class="comment">//</span>
04023 
04024         <span class="keywordflow">if</span> (!AccessGranted) {
04025 
04026             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"We do not have access\n"</span>, 0);
04027 
04028             <span class="comment">//</span>
04029             <span class="comment">//  We cannot read/write to the range, so we cannot take out</span>
04030             <span class="comment">//  the lock.  Now if the user wanted to fail immediately then</span>
04031             <span class="comment">//  we'll complete the Irp, otherwise we'll enqueue this Irp</span>
04032             <span class="comment">//  to the waiting lock queue</span>
04033             <span class="comment">//</span>
04034 
04035             <span class="keywordflow">if</span> (FailImmediately) {
04036 
04037                 <span class="comment">//</span>
04038                 <span class="comment">//  Set our status and return, the finally clause will</span>
04039                 <span class="comment">//  complete the request</span>
04040                 <span class="comment">//</span>
04041 
04042                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"And we fail immediately\n"</span>, 0);
04043 
04044                 Iosb-&gt;Status = STATUS_LOCK_NOT_GRANTED;
04045                 <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( Results = TRUE );
04046 
04047             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Irp)) {
04048 
04049                 <a class="code" href="../../d1/d8/struct__WAITING__LOCK.html">PWAITING_LOCK</a> WaitingLock;
04050 
04051                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"And we enqueue the Irp for later\n"</span>, 0);
04052 
04053                 <span class="comment">//</span>
04054                 <span class="comment">//  Allocate a new waiting record, set it to point to the</span>
04055                 <span class="comment">//  waiting Irp, and insert it in the tail of the waiting</span>
04056                 <span class="comment">//  locks queue</span>
04057                 <span class="comment">//</span>
04058 
04059                 WaitingLock = <a class="code" href="../../d5/d3/filelock_8c.html#a33">FsRtlAllocateWaitingLock</a>();
04060 
04061                 <span class="comment">//</span>
04062                 <span class="comment">//  Simply raise out if we can't allocate.</span>
04063                 <span class="comment">//</span>
04064 
04065                 <span class="keywordflow">if</span> (WaitingLock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04066 
04067                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );
04068                 }
04069 
04070                 WaitingLock-&gt;<a class="code" href="../../d1/d8/struct__WAITING__LOCK.html#o2">Irp</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
04071                 WaitingLock-&gt;<a class="code" href="../../d1/d8/struct__WAITING__LOCK.html#o1">Context</a> = Context;
04072                 <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( Irp );
04073 
04074                 <span class="comment">//</span>
04075                 <span class="comment">// Add WaitingLock WaitingLockQueue</span>
04076                 <span class="comment">//</span>
04077 
04078                 WaitingLock-&gt;<a class="code" href="../../d1/d8/struct__WAITING__LOCK.html#o0">Link</a>.Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04079                 <span class="keywordflow">if</span> (LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o3">WaitingLocks</a>.Next == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04080 
04081                     <span class="comment">//</span>
04082                     <span class="comment">// Create new list</span>
04083                     <span class="comment">//</span>
04084 
04085                     LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o3">WaitingLocks</a>.Next = &amp;WaitingLock-&gt;<a class="code" href="../../d1/d8/struct__WAITING__LOCK.html#o0">Link</a>;
04086                     LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o4">WaitingLocksTail</a>.Next = &amp;WaitingLock-&gt;<a class="code" href="../../d1/d8/struct__WAITING__LOCK.html#o0">Link</a>;
04087 
04088                 } <span class="keywordflow">else</span> {
04089 
04090                     <span class="comment">//</span>
04091                     <span class="comment">// Add waiter to tail of list</span>
04092                     <span class="comment">//</span>
04093 
04094                     LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o4">WaitingLocksTail</a>.Next-&gt;Next = &amp;WaitingLock-&gt;<a class="code" href="../../d1/d8/struct__WAITING__LOCK.html#o0">Link</a>;
04095                     LockQueue-&gt;<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o4">WaitingLocksTail</a>.Next = &amp;WaitingLock-&gt;<a class="code" href="../../d1/d8/struct__WAITING__LOCK.html#o0">Link</a>;
04096                 }
04097 
04098 
04099                 <span class="comment">//</span>
04100                 <span class="comment">//  Setup IRP in case it's canceled - then set the</span>
04101                 <span class="comment">//  IRP's cancel routine</span>
04102                 <span class="comment">//</span>
04103 
04104                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = (ULONG_PTR)LockInfo;
04105                 <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( Irp, FsRtlPrivateCancelFileLockIrp );
04106 
04107                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a>) {
04108 
04109                     <span class="comment">//</span>
04110                     <span class="comment">// Pull the cancel routine off of the IRP - if it is not</span>
04111                     <span class="comment">// NULL, this means we won the race with IoCancelIrp and</span>
04112                     <span class="comment">// will be responsible for cancelling the IRP synchronously.</span>
04113                     <span class="comment">// If NULL, we lost and our cancel routine is already being</span>
04114                     <span class="comment">// called for us.</span>
04115                     <span class="comment">//</span>
04116                     <span class="comment">// This must be done while holding the lock queue down since</span>
04117                     <span class="comment">// this is how we synchronize with the cancel.</span>
04118                     <span class="comment">//</span>
04119 
04120                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( Irp, NULL )) {
04121 
04122                         <span class="comment">//</span>
04123                         <span class="comment">// Irp's cancel routine was not called, do it ourselves.</span>
04124                         <span class="comment">// Indicate to the cancel routine that he does not need</span>
04125                         <span class="comment">// to release the cancel spinlock by passing a NULL DO.</span>
04126                         <span class="comment">//</span>
04127                         <span class="comment">// The queue will be dropped in order to complete the Irp.</span>
04128                         <span class="comment">// We communicate the previous IRQL through the Irp itself.</span>
04129                         <span class="comment">//</span>
04130 
04131                         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> = OldIrql;
04132                         <a class="code" href="../../d5/d3/filelock_8c.html#a50">FsRtlPrivateCancelFileLockIrp</a>( NULL, Irp );
04133                         ReleaseQueue = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04134                     }
04135                 }
04136 
04137                 Iosb-&gt;Status = STATUS_PENDING;
04138                 <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( Results = TRUE );
04139 
04140             } <span class="keywordflow">else</span> {
04141 
04142                 <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( Results = FALSE );
04143             }
04144         }
04145 
04146         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, Dbg, <span class="stringliteral">"We have access\n"</span>, 0);
04147 
04148         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d3/filelock_8c.html#a46">FsRtlPrivateInsertLock</a>( LockInfo, FileObject, &amp;FileLockInfo )) {
04149 
04150             <span class="comment">//</span>
04151             <span class="comment">//  Resource exhaustion will cause us to fail here.  Via the fast call, indicate</span>
04152             <span class="comment">//  that it may be worthwhile to go around again via the Irp based path.  If we</span>
04153             <span class="comment">//  are already there, simply raise out.</span>
04154             <span class="comment">//</span>
04155 
04156             <span class="keywordflow">if</span> (ViaFastCall) {
04157 
04158                 <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( Results = FALSE );
04159 
04160             } <span class="keywordflow">else</span> {
04161 
04162                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );
04163             }
04164 
04165         } <span class="keywordflow">else</span> {
04166 
04167             Iosb-&gt;Status = STATUS_SUCCESS;
04168         }
04169 
04170         <span class="comment">//</span>
04171         <span class="comment">//  At long last, we're done.</span>
04172         <span class="comment">//</span>
04173 
04174         Results = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04175 
04176     try_exit: NOTHING;
04177     } finally {
04178 
04179         <span class="keywordflow">if</span> (ReleaseQueue) {
04180             
04181             <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>(LockQueue, OldIrql);
04182         }
04183 
04184         <span class="comment">//</span>
04185         <span class="comment">//  Complete the request provided we were given one and it is not a pending status</span>
04186         <span class="comment">//</span>
04187 
04188         <span class="keywordflow">if</span> (!AbnormalTermination() &amp;&amp; ARGUMENT_PRESENT(Irp) &amp;&amp; (Iosb-&gt;Status != STATUS_PENDING)) {
04189 
04190             <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> NewStatus;
04191 
04192             <span class="comment">//</span>
04193             <span class="comment">//  We must reference the fileobject for the case that the IRP completion</span>
04194             <span class="comment">//  fails and we need to lift the lock.  Although the only reason we have</span>
04195             <span class="comment">//  to touch the fileobject in the remove case is to unset the LastLock field,</span>
04196             <span class="comment">//  we have no way of knowing if we will race with a reference count drop</span>
04197             <span class="comment">//  and lose.</span>
04198             <span class="comment">//</span>
04199 
04200             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( FileObject );
04201 
04202             <span class="comment">//</span>
04203             <span class="comment">//  Complete the request, if the don't get back success then</span>
04204             <span class="comment">//  we need to possibly remove the lock that we just</span>
04205             <span class="comment">//  inserted.</span>
04206             <span class="comment">//</span>
04207 
04208             <a class="code" href="../../d5/d3/filelock_8c.html#a11">FsRtlCompleteLockIrp</a>(
04209                 LockInfo,
04210                 Context,
04211                 Irp,
04212                 Iosb-&gt;Status,
04213                 &amp;NewStatus,
04214                 FileObject );
04215 
04216             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NewStatus) &amp;&amp; <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Iosb-&gt;Status) ) {
04217 
04218                 <span class="comment">//</span>
04219                 <span class="comment">// Irp failed, remove the lock which was added</span>
04220                 <span class="comment">//</span>
04221 
04222                 <a class="code" href="../../d5/d3/filelock_8c.html#a55">FsRtlPrivateRemoveLock</a> (
04223                     LockInfo,
04224                     &amp;FileLockInfo,
04225                     TRUE );
04226             }
04227 
04228             <span class="comment">//</span>
04229             <span class="comment">//  Lift our private reference to the fileobject. This may induce deletion.</span>
04230             <span class="comment">//</span>
04231 
04232             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( FileObject );
04233 
04234             Iosb-&gt;Status = NewStatus;
04235         }
04236 
04237         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlPrivateLock -&gt; %08lx\n"</span>, Results);
04238     }
04239 
04240     <span class="comment">//</span>
04241     <span class="comment">//  and return to our caller</span>
04242     <span class="comment">//</span>
04243 
04244     <span class="keywordflow">return</span> Results;
04245 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a116" doxytag="fsrtl.h::FsRtlProcessFileLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI NTSTATUS FsRtlProcessFileLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileLock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID Context&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l01173">1173</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00501">BooleanFlagOn</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02030">_IO_STACK_LOCATION::Flags</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00497">FsRtlCompleteLockIrp</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01745">FsRtlCompleteRequest</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03770">FsRtlFastUnlockAll()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03814">FsRtlFastUnlockAllByKey()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03241">FsRtlFastUnlockSingle()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03867">FsRtlPrivateLock()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07374">IoGetRequestorProcess()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00072">IRP_MJ_LOCK_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00123">IRP_MN_LOCK</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00125">IRP_MN_UNLOCK_ALL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00126">IRP_MN_UNLOCK_ALL_BY_KEY</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00124">IRP_MN_UNLOCK_SINGLE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01890">SL_EXCLUSIVE_LOCK</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01889">SL_FAIL_IMMEDIATELY</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00046">UdfCommonLockControl()</a>.
<p>
<pre class="fragment"><div>01181                    :
01182 
01183     This routine processes a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> does either a lock request,
01184     or an unlock request.  It also completes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>.  Once called <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user
01185     (i.e., <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> System) has relinquished <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>.
01186 
01187     If <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not available to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information <span class="keyword">this</span> routine will raise a
01188     status value indicating insufficient resources.
01189 
01190 Arguments:
01191 
01192     FileLock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> lock being modified/queried.
01193 
01194     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> being processed.
01195 
01196     Context - Optionally supplies a context to use when calling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user
01197         alternate <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> completion routine.
01198 
01199 Return Value:
01200 
01201     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The <span class="keywordflow">return</span> status <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
01202 
01203 --*/
01204 
01205 {
01206     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
01207 
01208     IO_STATUS_BLOCK Iosb;
01209     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01210     LARGE_INTEGER   ByteOffset;
01211 
01212     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlProcessFileLock, FileLock = %08lx\n"</span>, FileLock);
01213 
01214     Iosb.Information = 0;
01215 
01216     <span class="comment">//</span>
01217     <span class="comment">//  Get a pointer to the current Irp stack location and assert that</span>
01218     <span class="comment">//  the major function code is for a lock operation</span>
01219     <span class="comment">//</span>
01220 
01221     IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
01222 
01223     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> == IRP_MJ_LOCK_CONTROL );
01224 
01225     <span class="comment">//</span>
01226     <span class="comment">//  Now process the different minor lock operations</span>
01227     <span class="comment">//</span>
01228 
01229     <span class="keywordflow">switch</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a>) {
01230 
01231     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a52">IRP_MN_LOCK</a>:
01232 
01233         ByteOffset = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.LockControl.ByteOffset;
01234 
01235         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d8/fsrtl_8h.html#a125">FsRtlPrivateLock</a>( FileLock,
01236                                  IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>,
01237                                  &amp;ByteOffset,
01238                                  IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.LockControl.Length,
01239                                  <a class="code" href="../../d0/d5/io_8h.html#a512">IoGetRequestorProcess</a>(Irp),
01240                                  IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.LockControl.Key,
01241                                  <a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>(IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o2">Flags</a>, SL_FAIL_IMMEDIATELY),
01242                                  <a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>(IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o2">Flags</a>, SL_EXCLUSIVE_LOCK),
01243                                  &amp;Iosb,
01244                                  Irp,
01245                                  Context,
01246                                  FALSE );
01247 
01248         <span class="keywordflow">break</span>;
01249 
01250     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a53">IRP_MN_UNLOCK_SINGLE</a>:
01251 
01252         ByteOffset = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.LockControl.ByteOffset;
01253 
01254         Iosb.Status = <a class="code" href="../../d1/d8/fsrtl_8h.html#a122">FsRtlFastUnlockSingle</a>( FileLock,
01255                                              IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>,
01256                                              &amp;ByteOffset,
01257                                              IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.LockControl.Length,
01258                                              <a class="code" href="../../d0/d5/io_8h.html#a512">IoGetRequestorProcess</a>(Irp),
01259                                              IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.LockControl.Key,
01260                                              Context,
01261                                              FALSE );
01262 
01263         <a class="code" href="../../d5/d3/filelock_8c.html#a11">FsRtlCompleteLockIrp</a>( FileLock, Context, Irp, Iosb.Status, &amp;Status, NULL );
01264         <span class="keywordflow">break</span>;
01265 
01266     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a54">IRP_MN_UNLOCK_ALL</a>:
01267 
01268         Iosb.Status = <a class="code" href="../../d1/d8/fsrtl_8h.html#a123">FsRtlFastUnlockAll</a>( FileLock,
01269                                           IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>,
01270                                           <a class="code" href="../../d0/d5/io_8h.html#a512">IoGetRequestorProcess</a>(Irp),
01271                                           Context );
01272 
01273         <a class="code" href="../../d5/d3/filelock_8c.html#a11">FsRtlCompleteLockIrp</a>( FileLock, Context, Irp, Iosb.Status, &amp;Status, NULL );
01274         <span class="keywordflow">break</span>;
01275 
01276     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a55">IRP_MN_UNLOCK_ALL_BY_KEY</a>:
01277 
01278         Iosb.Status = <a class="code" href="../../d1/d8/fsrtl_8h.html#a124">FsRtlFastUnlockAllByKey</a>( FileLock,
01279                                                IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>,
01280                                                <a class="code" href="../../d0/d5/io_8h.html#a512">IoGetRequestorProcess</a>(Irp),
01281                                                IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.LockControl.Key,
01282                                                Context );
01283 
01284         <a class="code" href="../../d5/d3/filelock_8c.html#a11">FsRtlCompleteLockIrp</a>( FileLock, Context, Irp, Iosb.Status, &amp;Status, NULL );
01285         <span class="keywordflow">break</span>;
01286 
01287     <span class="keywordflow">default</span>:
01288 
01289         <span class="comment">//</span>
01290         <span class="comment">//  For all other minor function codes we say they're invalid and</span>
01291         <span class="comment">//  complete the request.  Note that the IRP has not been marked</span>
01292         <span class="comment">//  pending so this error will be returned directly to the caller.</span>
01293         <span class="comment">//</span>
01294 
01295         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, 1, <span class="stringliteral">"Invalid LockFile Minor Function Code %08lx\n"</span>, IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a>);
01296 
01297 
01298         <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Irp, STATUS_INVALID_DEVICE_REQUEST );
01299 
01300         Iosb.Status = STATUS_INVALID_DEVICE_REQUEST;
01301         <span class="keywordflow">break</span>;
01302     }
01303 
01304     <span class="comment">//</span>
01305     <span class="comment">//  And return to our caller</span>
01306     <span class="comment">//</span>
01307 
01308     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlProcessFileLock -&gt; %08lx\n"</span>, Iosb.Status);
01309 
01310     <span class="keywordflow">return</span> Iosb.Status;
01311 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a182" doxytag="fsrtl.h::FsRtlRegisterUncProvider" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI NTSTATUS FsRtlRegisterUncProvider           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>MupHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>RedirectorDeviceName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>MailslotsSupported</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/unc_8c-source.html#l00247">247</a> of file <a class="el" href="../../d6/d8/unc_8c-source.html">unc.c</a>.
<p>
References <a class="el" href="../../d6/d8/unc_8c-source.html#l00036">DevMup</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00035">DevNull</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00487">FsRtlpIsDfsEnabled()</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00183">FsRtlpOpenDev()</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00099">FsRtlpRedirs</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00104">FsRtlpRegisterProviderWithMUP()</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00231">FsRtlpSetSymbolicLink()</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00094">FsRtlpUncSemaphore</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00088">MailslotsSupported</a>, <a class="el" href="../../d2/d2/dbcsname_8c-source.html#l00069">MODULE_POOL_TAG</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00085">MupHandle</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00033">MupRegKey</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00087">RedirDevName</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, and <a class="el" href="../../d7/d7/fs__rec_8h.html#a37">ZwLoadDriver()</a>.
<p>
<pre class="fragment"><div>00254                    :
00255 
00256     This routine registers a redir as a UNC provider.
00257 
00258 Arguments:
00259 
00260     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Pointer to a handle.  The handle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine
00261         to be used when calling <a class="code" href="../../d5/d9/unc_8c.html#a18">FsRtlDeregisterUncProvider</a>.
00262         It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> returns STATUS_SUCCESS.
00263 
00264     <a class="code" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a> - The device name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> redir.
00265 
00266     <a class="code" href="../../d5/d9/unc_8c.html#a9">MailslotsSupported</a> - If <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <span class="keyword">this</span> redir supports mailslots.
00267 
00268 Return Value:
00269 
00270     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
00271 
00272 --*/
00273 {
00274     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00275     HANDLE mupHandle = (HANDLE)-1;
00276     UNICODE_STRING mupDriverName;
00277     BOOLEAN dfsEnabled;
00278 
00279     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00280 
00281     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;FsRtlpUncSemaphore, Executive, KernelMode, FALSE, NULL );
00282 
00283     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9/unc_8c.html#a12">FsRtlpRedirs</a> == 0) {
00284 
00285         dfsEnabled = <a class="code" href="../../d5/d9/unc_8c.html#a16">FsRtlpIsDfsEnabled</a>();
00286 
00287         <span class="keywordflow">if</span> (dfsEnabled) {
00288             <a class="code" href="../../d5/d9/unc_8c.html#a12">FsRtlpRedirs</a> = 1;
00289             RtlZeroMemory((PVOID) &amp;FsRtlpDRD, <span class="keyword">sizeof</span>(FsRtlpDRD));
00290         }
00291 
00292     }
00293 
00294     <span class="keywordflow">switch</span>( <a class="code" href="../../d5/d9/unc_8c.html#a12">FsRtlpRedirs</a> ) {
00295     <span class="keywordflow">case</span> 0:
00296         <span class="comment">//</span>
00297         <span class="comment">// Ok, the MUP isn't there and we don't need to use the</span>
00298         <span class="comment">//   MUP for the first redir.</span>
00299         <span class="comment">//</span>
00300         <span class="comment">// We need to return a handle, but we're not really using the MUP yet.</span>
00301         <span class="comment">//   And we may never use it (if there's only 1 redir).  Return</span>
00302         <span class="comment">//   a handle to the NULL device object, since we're committed to returning</span>
00303         <span class="comment">//   a handle to our caller.  Our caller isn't supposed to do anything with</span>
00304         <span class="comment">//   the handle except to call FsRtlDeregisterUncProvider() with it.</span>
00305         <span class="comment">//</span>
00306         status = <a class="code" href="../../d5/d9/unc_8c.html#a14">FsRtlpOpenDev</a>( &amp;mupHandle, DevNull );
00307 
00308         <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) )
00309             <span class="keywordflow">break</span>;
00310 
00311         <span class="comment">//</span>
00312         <span class="comment">// Save up enough state to allow us to call the MUP later with</span>
00313         <span class="comment">// this registration info if necessary.</span>
00314         <span class="comment">//</span>
00315         <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( NonPagedPool, 
00316                                                                <a class="code" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a>-&gt;MaximumLength, 
00317                                                                MODULE_POOL_TAG );
00318 
00319         <span class="keywordflow">if</span>( <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00320             status =  STATUS_INSUFFICIENT_RESOURCES;
00321             <span class="keywordflow">break</span>;
00322         }
00323 
00324         <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.Length = <a class="code" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a>-&gt;Length;
00325         <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.MaximumLength = <a class="code" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a>-&gt;MaximumLength;
00326 
00327         RtlMoveMemory(
00328                 (PCHAR)<a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.Buffer,
00329                 <a class="code" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a>-&gt;Buffer,
00330                 <a class="code" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a>-&gt;MaximumLength
00331         );
00332 
00333         <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.MailslotsSupported = <a class="code" href="../../d5/d9/unc_8c.html#a9">MailslotsSupported</a>;
00334         <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.ReturnedHandle = mupHandle;
00335         <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.MupHandle = (HANDLE)-1;
00336 
00337         <span class="comment">//</span>
00338         <span class="comment">// Set the UNC symbolic link to point to the redir we just loaded</span>
00339         <span class="comment">//</span>
00340         <a class="code" href="../../d5/d9/unc_8c.html#a15">FsRtlpSetSymbolicLink</a>( RedirDevName );
00341 
00342         <span class="keywordflow">break</span>;
00343 
00344     <span class="keywordflow">default</span>:
00345         <span class="comment">//</span>
00346         <span class="comment">// This is the second or later redir load -- MUST use the MUP</span>
00347         <span class="comment">//</span>
00348         status = <a class="code" href="../../d5/d9/unc_8c.html#a14">FsRtlpOpenDev</a>( &amp;mupHandle, DevMup );
00349 
00350         <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) ) {
00351 
00352             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;mupDriverName, MupRegKey );
00353 
00354             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d7/d7/fs__rec_8h.html#a37">ZwLoadDriver</a>( &amp;mupDriverName );
00355 
00356             status = <a class="code" href="../../d5/d9/unc_8c.html#a14">FsRtlpOpenDev</a>( &amp;mupHandle, DevMup );
00357             <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) )
00358                 <span class="keywordflow">break</span>;
00359         }
00360 
00361         <span class="comment">//</span>
00362         <span class="comment">// See if we need to tell the MUP about the first redir that registered</span>
00363         <span class="comment">//</span>
00364         <span class="keywordflow">if</span>( <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.Buffer ) {
00365 
00366             status = <a class="code" href="../../d5/d9/unc_8c.html#a13">FsRtlpRegisterProviderWithMUP</a>( mupHandle,
00367                     &amp;<a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName,
00368                     <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.MailslotsSupported );
00369 
00370             <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) )
00371                 <span class="keywordflow">break</span>;
00372 
00373             <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.MupHandle = mupHandle;
00374 
00375             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.Buffer );
00376             <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00377 
00378             <span class="comment">//</span>
00379             <span class="comment">// Set the UNC symbolic link to point to the MUP</span>
00380             <span class="comment">//</span>
00381             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(  &amp;mupDriverName, DevMup );
00382             <a class="code" href="../../d5/d9/unc_8c.html#a15">FsRtlpSetSymbolicLink</a>( &amp;mupDriverName );
00383 
00384             status = <a class="code" href="../../d5/d9/unc_8c.html#a14">FsRtlpOpenDev</a>( &amp;mupHandle, DevMup );
00385 
00386             <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) )
00387                 <span class="keywordflow">break</span>;
00388         }
00389 
00390         <span class="comment">//</span>
00391         <span class="comment">//  Pass the request to the MUP for this redir</span>
00392         <span class="comment">//</span>
00393         status = <a class="code" href="../../d5/d9/unc_8c.html#a13">FsRtlpRegisterProviderWithMUP</a>( mupHandle,
00394                         RedirDevName,
00395                         MailslotsSupported );
00396         <span class="keywordflow">break</span>;
00397 
00398     }
00399 
00400     <span class="keywordflow">if</span>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) ) {
00401         <a class="code" href="../../d5/d9/unc_8c.html#a12">FsRtlpRedirs</a>++;
00402         *<a class="code" href="../../d5/d9/unc_8c.html#a6">MupHandle</a> = mupHandle;
00403 
00404     } <span class="keywordflow">else</span> {
00405         <span class="keywordflow">if</span>( mupHandle != (HANDLE)-1 &amp;&amp; mupHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00406             ZwClose( mupHandle );
00407         }
00408 
00409         *<a class="code" href="../../d5/d9/unc_8c.html#a6">MupHandle</a> = (HANDLE)-1;
00410     }
00411 
00412     <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(&amp;FsRtlpUncSemaphore, 0, 1, FALSE );
00413     <span class="keywordflow">return</span> status;
00414 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a108" doxytag="fsrtl.h::FsRtlReleaseFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlReleaseFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>FileObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/fastio_8c-source.html#l02628">2628</a> of file <a class="el" href="../../d4/d0/fastio_8c-source.html">fastio.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01403">_DRIVER_OBJECT::FastIoDispatch</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01795">FsRtlExitFileSystem</a>, <a class="el" href="../../d4/d2/dumpuser_8c-source.html#l00048">Header</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06862">IoGetBaseFileSystemDeviceObject()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00954">_FAST_IO_DISPATCH::ReleaseFileForNtCreateSection</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l00942">_FAST_IO_DISPATCH::SizeOfFastIoDispatch</a>.
<p>
Referenced by <a class="el" href="../../d6/d7/fssup_8c-source.html#l01517">CcDeleteSharedCacheMap()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l03880">CcWriteBehind()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l02804">CcZeroEndOfLastPage()</a>, and <a class="el" href="../../d1/d7/creasect_8c-source.html#l00390">MmCreateSection()</a>.
<p>
<pre class="fragment"><div>02634                    :
02635 
02636     This routine releases resources acquired by <a class="code" href="../../d3/d1/fastio_8c.html#a15">FsRtlAcquireFileExclusive</a>.
02637 
02638 Arguments:
02639 
02640     FileObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object being written.
02641 
02642 Return Value:
02643 
02644     None.
02645 
02646 --*/
02647 
02648 {
02649     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject;
02650     <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> FastIoDispatch;
02651     <a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
02652 
02653     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02654 
02655     <span class="comment">//</span>
02656     <span class="comment">//  First see if we have to call the file system.</span>
02657     <span class="comment">//</span>
02658 
02659     DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a68">IoGetBaseFileSystemDeviceObject</a>( FileObject );
02660 
02661     <span class="keywordflow">if</span> ((FastIoDispatch = DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>) &amp;&amp;
02662         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> &gt;
02663          FIELD_OFFSET( <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a>, ReleaseFileForNtCreateSection )) &amp;&amp;
02664         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o12">ReleaseFileForNtCreateSection</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02665 
02666         FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o12">ReleaseFileForNtCreateSection</a>( FileObject );
02667         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
02668         <span class="keywordflow">return</span>;
02669     }
02670 
02671     <span class="comment">//</span>
02672     <span class="comment">//  If there is a main file resource, release that.</span>
02673     <span class="comment">//</span>
02674 
02675     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = (<a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a>)FileObject-&gt;FsContext) &amp;&amp;
02676         (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02677 
02678         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
02679         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
02680         <span class="keywordflow">return</span>;
02681     }
02682 
02683     <span class="comment">//</span>
02684     <span class="comment">//  Nothing to release.</span>
02685     <span class="comment">//</span>
02686 
02687     <span class="keywordflow">return</span>;
02688 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a106" doxytag="fsrtl.h::FsRtlReleaseFileForCcFlush" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlReleaseFileForCcFlush           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>FileObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/fastio_8c-source.html#l02483">2483</a> of file <a class="el" href="../../d4/d0/fastio_8c-source.html">fastio.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01403">_DRIVER_OBJECT::FastIoDispatch</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01795">FsRtlExitFileSystem</a>, <a class="el" href="../../d4/d2/dumpuser_8c-source.html#l00048">Header</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06862">IoGetBaseFileSystemDeviceObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00969">_FAST_IO_DISPATCH::ReleaseForCcFlush</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00942">_FAST_IO_DISPATCH::SizeOfFastIoDispatch</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d6/d4/sectsup_8c-source.html#l02748">MiRemoveUnusedSegments()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00668">MmFlushSection()</a>, and <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00297">MmFlushVirtualMemory()</a>.
<p>
<pre class="fragment"><div>02489                    :
02490 
02491     This routine releases a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system resource previously acquired <span class="keywordflow">for</span>
02492     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CcFlush.
02493 
02494 Arguments:
02495 
02496     FileObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object being written.
02497 
02498 Return Value:
02499 
02500     None.
02501 
02502 --*/
02503 
02504 {
02505     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject;
02506     <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> FastIoDispatch;
02507     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_DEVICE_REQUEST;
02508 
02509     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02510 
02511     <span class="comment">//</span>
02512     <span class="comment">//  First see if we have to call the file system. Note that in the case</span>
02513     <span class="comment">//  of layered file systems, the layered file system might have the</span>
02514     <span class="comment">//  dispatch routine, but the file system on which it is layered on may</span>
02515     <span class="comment">//  not. In that case, the layered file system will return</span>
02516     <span class="comment">//  STATUS_INVALID_DEVICE_REQUEST.</span>
02517     <span class="comment">//</span>
02518 
02519     DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a68">IoGetBaseFileSystemDeviceObject</a>( FileObject );
02520 
02521     <span class="keywordflow">if</span> ((FastIoDispatch = DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>) &amp;&amp;
02522         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> &gt;
02523          FIELD_OFFSET( <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a>, ReleaseForCcFlush )) &amp;&amp;
02524         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o27">ReleaseForCcFlush</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02525 
02526         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o27">ReleaseForCcFlush</a>( FileObject, DeviceObject );
02527 
02528     }
02529 
02530     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (Status == STATUS_SUCCESS) || (Status == STATUS_INVALID_DEVICE_REQUEST) );
02531 
02532     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INVALID_DEVICE_REQUEST) {
02533 
02534         <a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = FileObject-&gt;FsContext;
02535 
02536         <span class="comment">//</span>
02537         <span class="comment">//  Free whatever we acquired.</span>
02538         <span class="comment">//</span>
02539 
02540         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02541             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource );
02542         }
02543 
02544         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02545             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
02546         }
02547     }
02548 
02549     <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
02550 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a104" doxytag="fsrtl.h::FsRtlReleaseFileForModWrite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlReleaseFileForModWrite           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceToRelease</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/fastio_8c-source.html#l02342">2342</a> of file <a class="el" href="../../d4/d0/fastio_8c-source.html">fastio.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01403">_DRIVER_OBJECT::FastIoDispatch</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06862">IoGetBaseFileSystemDeviceObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00967">_FAST_IO_DISPATCH::ReleaseForModWrite</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00942">_FAST_IO_DISPATCH::SizeOfFastIoDispatch</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02234">MiWriteComplete()</a>.
<p>
<pre class="fragment"><div>02349                    :
02350 
02351     This routine releases a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system resource previously acquired <span class="keywordflow">for</span>
02352     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> modified page writer.
02353 
02354 Arguments:
02355 
02356     FileObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object being written.
02357 
02358     ResourceToRelease - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource to release.  Not defined <span class="keywordflow">if</span>
02359         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
02360 
02361 Return Value:
02362 
02363     None.
02364 
02365 --*/
02366 
02367 {
02368     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject;
02369     <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> FastIoDispatch;
02370     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_DEVICE_REQUEST;
02371 
02372     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02373 
02374     <span class="comment">//</span>
02375     <span class="comment">//  First see if we have to call the file system. Note that in the case</span>
02376     <span class="comment">//  of layered file systems, the layered file system might have the</span>
02377     <span class="comment">//  dispatch routine, but the file system on which it is layered on may</span>
02378     <span class="comment">//  not. In that case, the layered file system will return</span>
02379     <span class="comment">//  STATUS_INVALID_DEVICE_REQUEST.</span>
02380     <span class="comment">//</span>
02381 
02382     DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a68">IoGetBaseFileSystemDeviceObject</a>( FileObject );
02383 
02384     FastIoDispatch = DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>;
02385     <span class="keywordflow">if</span> ((FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> &gt;
02386          FIELD_OFFSET( <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a>, ReleaseForModWrite )) &amp;&amp;
02387         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o25">ReleaseForModWrite</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02388 
02389         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o25">ReleaseForModWrite</a>( FileObject, ResourceToRelease, DeviceObject );
02390     }
02391 
02392     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (Status == STATUS_SUCCESS) || (Status == STATUS_INVALID_DEVICE_REQUEST) );
02393 
02394     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INVALID_DEVICE_REQUEST) {
02395         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( ResourceToRelease );
02396     }
02397 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a186" doxytag="fsrtl.h::FsRtlRemoveFilterContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI <a class="el" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">PFSRTL_FILTER_CONTEXT</a> FsRtlRemoveFilterContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID OwnerId&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID InstanceId&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/filtrctx_8c-source.html#l00189">189</a> of file <a class="el" href="../../d0/d3/filtrctx_8c-source.html">filtrctx.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00265">FSRTL_FLAG2_SUPPORTS_FILTER_CONTEXTS</a>, <a class="el" href="../../d4/d2/dumpuser_8c-source.html#l00048">Header</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01648">_FSRTL_FILTER_CONTEXT::InstanceId</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01646">_FSRTL_FILTER_CONTEXT::Links</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d0/d3/filtrctx_8c-source.html#l00046">MySearchList</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01647">_FSRTL_FILTER_CONTEXT::OwnerId</a>.
<p>
<pre class="fragment"><div>00196                    :
00197 
00198     This routine deletes filter driver context associated with a stream.
00199 
00200     <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a> drivers must explicitly remove all context they associate with
00201     a stream (otherwise the underlying filesystem will BugCheck at close).
00202 
00203     <a class="code" href="../../d9/d3/filtrctx_8c.html#a4">FsRtlRemoveFilterContext</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a> identically to <a class="code" href="../../d1/d8/fsrtl_8h.html#a46">FsRtlLookupFilterContext</a>,
00204     except that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned context has been removed from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list.
00205 
00206 Arguments:
00207 
00208     FileObject - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stream of interest.
00209 
00210     OwnerId - Used to identify context information belonging to a particular
00211         filter driver.
00212 
00213     InstanceId - Used to search <span class="keywordflow">for</span> a particular instance of a filter driver
00214         context.  If not provided, any of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> contexts owned by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filter
00215         driver <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> removed and returned.
00216 
00217     If neither <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> OwnerId nor <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> InstanceId <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> provided, any associated
00218         filter context will be removed and returned.
00219 
00220 Return Value:
00221 
00222     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filter context, or <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> no match found.
00223 
00224 --*/
00225 
00226 {
00227     <a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a>  <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
00228     <a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">PFSRTL_FILTER_CONTEXT</a>     Ctx, RtnCtx;
00229     PLIST_ENTRY               <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>;
00230 
00231     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FileObject);
00232 
00233     <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = FileObject-&gt;FsContext;
00234 
00235     <span class="keywordflow">if</span> ( !<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> || !(<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Flags2 &amp; <a class="code" href="../../d1/d8/fsrtl_8h.html#a9">FSRTL_FLAG2_SUPPORTS_FILTER_CONTEXTS</a>) ) {
00236         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00237     }
00238 
00239     ExAcquireFastMutex (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FastMutex);
00240     RtnCtx = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00241 
00242   <span class="comment">// Use different loops depending on whether we are comparing both Ids or not.</span>
00243     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(InstanceId) ) {
00244 
00245         <a class="code" href="../../d9/d3/filtrctx_8c.html#a0">MySearchList</a> (&amp;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FilterContexts, List) {
00246             Ctx  = CONTAINING_RECORD (List, <a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">FSRTL_FILTER_CONTEXT</a>, Links);
00247             <span class="keywordflow">if</span> (Ctx-&gt;<a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html#o1">OwnerId</a> == OwnerId &amp;&amp; Ctx-&gt;<a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html#o2">InstanceId</a> == InstanceId) {
00248                 RtnCtx = Ctx;
00249                 <span class="keywordflow">break</span>;
00250             }
00251         }
00252     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(OwnerId) ) {
00253 
00254         <a class="code" href="../../d9/d3/filtrctx_8c.html#a0">MySearchList</a> (&amp;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FilterContexts, List) {
00255             Ctx  = CONTAINING_RECORD (List, <a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">FSRTL_FILTER_CONTEXT</a>, Links);
00256             <span class="keywordflow">if</span> (Ctx-&gt;<a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html#o1">OwnerId</a> == OwnerId) {
00257                 RtnCtx = Ctx;
00258                 <span class="keywordflow">break</span>;
00259             }
00260         }
00261     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!IsListEmpty(&amp;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FilterContexts)) {
00262 
00263         RtnCtx = (<a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">PFSRTL_FILTER_CONTEXT</a>) <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FilterContexts.Flink;
00264     }
00265 
00266     <span class="keywordflow">if</span> (RtnCtx) {
00267         RemoveEntryList(&amp;RtnCtx-&gt;<a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html#o0">Links</a>);   <span class="comment">// remove the matched entry</span>
00268     }
00269     ExReleaseFastMutex(<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FastMutex);
00270     <span class="keywordflow">return</span> RtnCtx;
00271 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a144" doxytag="fsrtl.h::FsRtlRemoveLargeMcbEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlRemoveLargeMcbEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Mcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Vbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SectorCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/largemcb_8c-source.html#l01528">1528</a> of file <a class="el" href="../../d2/d0/largemcb_8c-source.html">largemcb.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00147">ASSERTMSG</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00158">_NONOPAQUE_MCB::FastMutex</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l02297">FsRtlRemoveMcbEntryPrivate()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00164">PNONOPAQUE_MCB</a>, and <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00032">VBN</a>.
<p>
<pre class="fragment"><div>01536                    :
01537 
01538     This routine removes a mapping of VBNs to LBNs from an Mcb.  The mappings
01539     removed are <span class="keywordflow">for</span>
01540 
01541         Vbn,
01542 
01543         Vbn+1, to
01544 
01545         Vbn+(SectorCount-1).
01546 
01547     The operation works even <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping <span class="keywordflow">for</span> a Vbn in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified range
01548     does not already exist in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Mcb.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified range of Vbn includes
01549     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last mapped Vbn in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Mcb then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Mcb mapping shrinks accordingly.
01550 
01551     If <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not available to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information <span class="keyword">this</span> routine will raise
01552     a status value indicating insufficient resources.
01553 
01554 Arguments:
01555 
01556     OpaqueMcb - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Mcb from which to remove <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping.
01557 
01558     Vbn - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting Vbn of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mappings to remove.
01559 
01560     SectorCount - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mappings to remove (in sectors).
01561 
01562 Return Value:
01563 
01564     None.
01565 
01566 --*/
01567 
01568 {
01569     <a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html">PNONOPAQUE_MCB</a> Mcb = (<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html">PNONOPAQUE_MCB</a>)OpaqueMcb;
01570 
01571     <a class="code" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a> Vbn = ((ULONG)LargeVbn);
01572     ULONG SectorCount = ((ULONG)LargeSectorCount);
01573 
01574     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01575 
01576     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>(<span class="stringliteral">"LargeInteger not supported yet "</span>, ((PLARGE_INTEGER)&amp;LargeVbn)-&gt;HighPart == 0);
01577 
01578     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlRemoveLargeMcbEntry, Mcb = %08lx\n"</span>, Mcb );
01579     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">" Vbn         = %08lx\n"</span>, Vbn );
01580     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">" SectorCount = %08lx\n"</span>, SectorCount );
01581 
01582     ExAcquireFastMutex( Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o0">FastMutex</a> );
01583 
01584     <span class="keywordflow">try</span> {
01585 
01586         <a class="code" href="../../d1/d1/largemcb_8c.html#a24">FsRtlRemoveMcbEntryPrivate</a>( Mcb, Vbn, SectorCount );
01587 
01588     } finally {
01589 
01590         ExReleaseFastMutex( Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o0">FastMutex</a> );
01591 
01592         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlRemoveLargeMcbEntry -&gt; VOID\n"</span>, 0 );
01593     }
01594 
01595     <span class="keywordflow">return</span>;
01596 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a155" doxytag="fsrtl.h::FsRtlRemoveMcbEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlRemoveMcbEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d7/struct__MCB.html">PMCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Mcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SectorCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00392">392</a> of file <a class="el" href="../../d2/d0/largemcb_8c-source.html">largemcb.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00158">_NONOPAQUE_MCB::FastMutex</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l02297">FsRtlRemoveMcbEntryPrivate()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00164">PNONOPAQUE_MCB</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00637">UdfAddVmcbMapping()</a>, and <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00867">UdfRemoveVmcbMapping()</a>.
<p>
<pre class="fragment"><div>00398 {
00399     <a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html">PNONOPAQUE_MCB</a> Mcb = (<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html">PNONOPAQUE_MCB</a>)OpaqueMcb;
00400 
00401     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00402 
00403     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlRemoveMcbEntry, Mcb = %08lx\n"</span>, Mcb );
00404     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">" Vbn         = %08lx\n"</span>, Vbn );
00405     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">" SectorCount = %08lx\n"</span>, SectorCount );
00406 
00407     ExAcquireFastMutex( Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o0">FastMutex</a> );
00408 
00409     <span class="keywordflow">try</span> {
00410 
00411         <a class="code" href="../../d1/d1/largemcb_8c.html#a24">FsRtlRemoveMcbEntryPrivate</a>( Mcb,
00412                                     Vbn,
00413                                     SectorCount );
00414 
00415     } finally {
00416 
00417         ExReleaseFastMutex( Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o0">FastMutex</a> );
00418 
00419         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlRemoveMcbEntry -&gt; VOID\n"</span>, 0 );
00420     }
00421 
00422     <span class="keywordflow">return</span>;
00423 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a141" doxytag="fsrtl.h::FsRtlResetLargeMcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlResetLargeMcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Mcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SelfSynchronized</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00922">922</a> of file <a class="el" href="../../d2/d0/largemcb_8c-source.html">largemcb.c</a>.
<p>
References <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00158">_NONOPAQUE_MCB::FastMutex</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00160">_NONOPAQUE_MCB::PairCount</a>, and <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00164">PNONOPAQUE_MCB</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00181">UdfInitializeFcbMcb()</a>, and <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00370">UdfResetVmcb()</a>.
<p>
<pre class="fragment"><div>00929                    :
00930 
00931     This routine truncates an Mcb structure to contain zero mapping
00932     pairs.  It does not shrink <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping pairs array.
00933 
00934 Arguments:
00935 
00936     OpaqueMcb - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Mcb structure to truncate.
00937 
00938     SelfSynchronized - Indicates whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already <span class="keyword">synchronized</span>
00939         with respect to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Mcb.
00940 
00941 Return Value:
00942 
00943     None.
00944 
00945 --*/
00946 
00947 {
00948     <a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html">PNONOPAQUE_MCB</a> Mcb = (<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html">PNONOPAQUE_MCB</a>)OpaqueMcb;
00949 
00950     <span class="keywordflow">if</span> (SelfSynchronized) {
00951         
00952         <span class="comment">//</span>
00953         <span class="comment">//  If we are self-synchronized, then all we do is clear out the </span>
00954         <span class="comment">//  current mapping pair count.</span>
00955         <span class="comment">//</span>
00956         
00957         Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o2">PairCount</a> = 0;
00958     
00959     } <span class="keywordflow">else</span> {
00960         
00961         <span class="comment">//</span>
00962         <span class="comment">//  Since we are not self-synchronized, we must serialize access to</span>
00963         <span class="comment">//  the Mcb before clearing the pair count</span>
00964         <span class="comment">//</span>
00965         
00966         ExAcquireFastMutex( Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o0">FastMutex</a> );
00967         Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o2">PairCount</a> = 0;
00968         ExReleaseFastMutex( Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o0">FastMutex</a> );
00969     
00970     }
00971 
00972     <span class="keywordflow">return</span>;
00973 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a110" doxytag="fsrtl.h::FsRtlSetFileSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FsRtlSetFileSize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>FileSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/fastio_8c-source.html#l02864">2864</a> of file <a class="el" href="../../d4/d0/fastio_8c-source.html">fastio.c</a>.
<p>
References <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02488">_IO_STACK_LOCATION::DeviceObject</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00652">IoAllocateIrp()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00061">IRP_MJ_SET_INFORMATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01550">IRP_PAGING_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01557">IRP_SYNCHRONOUS_PAGING_IO</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01641">_IRP::RequestorMode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01189">_DEVICE_OBJECT::StackSize</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/creasect_8c-source.html#l03553">MiCreateDataFileMap()</a>, and <a class="el" href="../../d9/d9/extsect_8c-source.html#l00201">MmExtendSection()</a>.
<p>
<pre class="fragment"><div>02871                    :
02872 
02873     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to call <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> System to update FileSize
02874     <span class="keywordflow">for</span> a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
02875 
02876     It does <span class="keyword">this</span> without acquiring <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object lock on synchronous <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
02877     objects.  This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> therefore safe to call <span class="keywordflow">if</span> you already own
02878     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system resources, <span class="keywordflow">while</span> <a class="code" href="../../d0/d5/io_8h.html#a545">IoSetInformation</a> could (and does) lead
02879     to deadlocks.
02880 
02881 Arguments:
02882 
02883     FileObject - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to a referenced <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.
02884 
02885     ValidDataLength - Pointer to <span class="keyword">new</span> FileSize.
02886 
02887 Return Value:
02888 
02889     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of operation.
02890 
02891 --*/
02892 
02893 {
02894     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
02895     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject;
02896     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02897     FILE_END_OF_FILE_INFORMATION <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
02898     IO_STATUS_BLOCK IoStatus;
02899     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
02900     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
02901 
02902     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02903 
02904     <span class="comment">//</span>
02905     <span class="comment">//  Copy FileSize to our buffer.</span>
02906     <span class="comment">//</span>
02907 
02908     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>.EndOfFile = *FileSize;
02909 
02910     <span class="comment">//</span>
02911     <span class="comment">//  Initialize the event.</span>
02912     <span class="comment">//</span>
02913 
02914     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;Event, NotificationEvent, FALSE );
02915 
02916     <span class="comment">//</span>
02917     <span class="comment">//  Begin by getting a pointer to the device object that the file resides</span>
02918     <span class="comment">//  on.</span>
02919     <span class="comment">//</span>
02920 
02921     DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject );
02922 
02923     <span class="comment">//</span>
02924     <span class="comment">//  Allocate an I/O Request Packet (IRP) for this in-page operation.</span>
02925     <span class="comment">//</span>
02926 
02927     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>( DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a>, FALSE );
02928     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02929 
02930         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02931     }
02932 
02933     <span class="comment">//</span>
02934     <span class="comment">//  Get a pointer to the first stack location in the packet.  This location</span>
02935     <span class="comment">//  will be used to pass the function codes and parameters to the first</span>
02936     <span class="comment">//  driver.</span>
02937     <span class="comment">//</span>
02938 
02939     IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( Irp );
02940 
02941     <span class="comment">//</span>
02942     <span class="comment">//  Fill in the IRP according to this request, setting the flags to</span>
02943     <span class="comment">//  just cause IO to set the event and deallocate the Irp.</span>
02944     <span class="comment">//</span>
02945 
02946     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a174">IRP_PAGING_IO</a> | <a class="code" href="../../d0/d5/io_8h.html#a181">IRP_SYNCHRONOUS_PAGING_IO</a>;
02947     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>;
02948     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = &amp;IoStatus;
02949     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
02950     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = FileObject;
02951     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
02952     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = &amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
02953 
02954     <span class="comment">//</span>
02955     <span class="comment">//  Fill in the normal set file parameters.</span>
02956     <span class="comment">//</span>
02957 
02958     IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a19">IRP_MJ_SET_INFORMATION</a>;
02959     IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = FileObject;
02960     IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o57">DeviceObject</a> = DeviceObject;
02961     IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.SetFile.Length = <span class="keyword">sizeof</span>(FILE_END_OF_FILE_INFORMATION);
02962     IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.SetFile.FileInformationClass = FileEndOfFileInformation;
02963 
02964     <span class="comment">//</span>
02965     <span class="comment">//  Queue the packet to the appropriate driver based on whether or not there</span>
02966     <span class="comment">//  is a VPB associated with the device.  This routine should not raise.</span>
02967     <span class="comment">//</span>
02968 
02969     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( DeviceObject, Irp );
02970 
02971     <span class="comment">//</span>
02972     <span class="comment">//  If pending is returned (which is a successful status),</span>
02973     <span class="comment">//  we must wait for the request to complete.</span>
02974     <span class="comment">//</span>
02975 
02976     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
02977         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;Event,
02978                                Executive,
02979                                KernelMode,
02980                                FALSE,
02981                                (PLARGE_INTEGER)NULL);
02982     }
02983 
02984     <span class="comment">//</span>
02985     <span class="comment">//  If we got an error back in Status, then the Iosb</span>
02986     <span class="comment">//  was not written, so we will just copy the status</span>
02987     <span class="comment">//  there, then test the final status after that.</span>
02988     <span class="comment">//</span>
02989 
02990     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02991         IoStatus.Status = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02992     }
02993 
02994     <span class="keywordflow">return</span> IoStatus.Status;
02995 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a150" doxytag="fsrtl.h::FsRtlSplitLargeMcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN FsRtlSplitLargeMcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Mcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Vbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Amount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/largemcb_8c-source.html#l02066">2066</a> of file <a class="el" href="../../d2/d0/largemcb_8c-source.html">largemcb.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00147">ASSERTMSG</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00158">_NONOPAQUE_MCB::FastMutex</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l02852">FsRtlAddLargeEntry()</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l02748">FsRtlFindLargeIndex()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00029">LBN</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00162">_NONOPAQUE_MCB::Mapping</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00160">_NONOPAQUE_MCB::PairCount</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00164">PNONOPAQUE_MCB</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00206">PreviousEndingLbn</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00210">StartingLbn</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00191">StartingVbn</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02154">try_return</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00149">UNUSED_LBN</a>, and <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00032">VBN</a>.
<p>
<pre class="fragment"><div>02074                    :
02075 
02076     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to create a hole within an <a class="code" href="../../d2/d7/struct__MCB.html">MCB</a>, by shifting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02077     mapping of Vbns.  All mappings above <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input vbn are shifted by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02078     amount specified and <span class="keywordflow">while</span> keeping their current lbn value.  Pictorially
02079     we have as input <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following <a class="code" href="../../d1/d8/fsrtl_8h.html#a75">MCB</a>
02080 
02081         <a class="code" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a> :       LargeVbn-1 LargeVbn         N
02082             +-----------------+------------------+
02083         <a class="code" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a> :             X        Y
02084 
02085     And after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> split we have
02086 
02087         <a class="code" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a> :       LargeVbn-1               LargeVbn+Amount    N+Amount
02088             +-----------------+.............+---------------------------+
02089         <a class="code" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a> :             X      UnusedLbn       Y
02090 
02091     When doing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> split we have a few cases to consider.  They are:
02092 
02093     1. The input Vbn <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> beyond <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last run.  In <span class="keyword">this</span> <span class="keywordflow">case</span> <span class="keyword">this</span> operation
02094        <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a noop.
02095 
02096     2. The input Vbn <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> within or adjacent to a existing run of unused Lbns.
02097        In <span class="keyword">this</span> <span class="keywordflow">case</span> we simply need to extend <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> existing hole
02098        and shift succeeding runs.
02099 
02100     3. The input Vbn <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> between two existing runs, including <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> an input vbn
02101        value of zero.  In <span class="keyword">this</span> <span class="keywordflow">case</span> we need to add a <span class="keyword">new</span> entry <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hole
02102        and shift succeeding runs.
02103 
02104     4. The input Vbn <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> within an existing run.  In <span class="keyword">this</span> <span class="keywordflow">case</span> we need to add
02105        two <span class="keyword">new</span> entries to contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> split run and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hole.
02106 
02107     If <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not available to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information <span class="keyword">this</span> routine will raise a
02108     status value indicating insufficient resources.
02109 
02110 Arguments:
02111 
02112     OpaqueMcb - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Mcb in which to add <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> mapping.
02113 
02114     Vbn - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting Vbn that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be shifted.
02115 
02116     Amount - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> amount to shift by.
02117 
02118 Return Value:
02119 
02120     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping was successfully shifted, and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
02121         If <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Mcb <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not changed.
02122 
02123 --*/
02124 
02125 {
02126     <a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html">PNONOPAQUE_MCB</a> Mcb = (<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html">PNONOPAQUE_MCB</a>)OpaqueMcb;
02127 
02128     <a class="code" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a> Vbn = ((ULONG)LargeVbn);
02129     ULONG Amount = ((ULONG)LargeAmount);
02130 
02131     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02132 
02133     BOOLEAN Result;
02134 
02135     ULONG i;
02136 
02137     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02138 
02139     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlSplitLargeMcb, Mcb = %08lx\n"</span>, Mcb );
02140     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">" Vbn    = %08lx\n"</span>, Vbn );
02141     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">" Amount = %08lx\n"</span>, Amount );
02142 
02143     ExAcquireFastMutex( Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o0">FastMutex</a> );
02144 
02145     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>(<span class="stringliteral">"LargeInteger not supported yet "</span>, ((((PLARGE_INTEGER)&amp;LargeVbn)-&gt;HighPart == 0) ||
02146                                                   (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o2">PairCount</a> == 0)));
02147     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>(<span class="stringliteral">"LargeInteger not supported yet "</span>, ((((PLARGE_INTEGER)&amp;LargeAmount)-&gt;HighPart == 0) ||
02148                                                   (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o2">PairCount</a> == 0)));
02149 
02150     <span class="keywordflow">try</span> {
02151 
02152         <span class="comment">//</span>
02153         <span class="comment">//  First lookup the index for the entry that we are going to split.</span>
02154         <span class="comment">//  If we can't find the entry then there is nothing to split.  This</span>
02155         <span class="comment">//  takes care of the case where the input vbn is beyond the last run</span>
02156         <span class="comment">//  in the mcb</span>
02157         <span class="comment">//</span>
02158 
02159         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d1/largemcb_8c.html#a25">FsRtlFindLargeIndex</a>( Mcb, Vbn, &amp;Index)) {
02160 
02161             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>(Result = FALSE);
02162         }
02163 
02164         <span class="comment">//</span>
02165         <span class="comment">//  Now check if the input Vbn is within a hole</span>
02166         <span class="comment">//</span>
02167 
02168         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/largemcb_8c.html#a8">StartingLbn</a>(Mcb,Index) == <a class="code" href="../../d1/d1/largemcb_8c.html#a1">UNUSED_LBN</a>) {
02169 
02170             <span class="comment">//</span>
02171             <span class="comment">//  Before: --PreviousRun--||--IndexHole--||--FollowingRun--</span>
02172             <span class="comment">//  After:  --PreviousRun--||----IndexHole----||--FollowingRun--</span>
02173             <span class="comment">//</span>
02174             <span class="comment">//      In this case the vbn is somewhere within the hole and we</span>
02175             <span class="comment">//      simply need to added the amount of each existing run</span>
02176             <span class="comment">//      beyond the hole.</span>
02177             <span class="comment">//</span>
02178 
02179             <span class="comment">//</span>
02180             <span class="comment">//  In this case there is really nothing to do here because the</span>
02181             <span class="comment">//  ending code will already shift the runs by proper amount</span>
02182             <span class="comment">//  starting at index</span>
02183             <span class="comment">//</span>
02184 
02185             NOTHING;
02186 
02187         <span class="comment">//</span>
02188         <span class="comment">//  Now check if the input vbn is between a hole and an existing run.</span>
02189         <span class="comment">//</span>
02190 
02191         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d1/largemcb_8c.html#a4">StartingVbn</a>(Mcb,Index) == Vbn) &amp;&amp; (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> != 0) &amp;&amp; (<a class="code" href="../../d1/d1/largemcb_8c.html#a7">PreviousEndingLbn</a>(Mcb,Index) == <a class="code" href="../../d1/d1/largemcb_8c.html#a1">UNUSED_LBN</a>)) {
02192 
02193             <span class="comment">//</span>
02194             <span class="comment">//  Before: --Hole--||--IndexRun--</span>
02195             <span class="comment">//  After:  --Hole------||--IndexRun--</span>
02196             <span class="comment">//</span>
02197             <span class="comment">//      In this case the vbn points to the start of the existing</span>
02198             <span class="comment">//      run and we need to do the split between the hole and the</span>
02199             <span class="comment">//      existing run by simply adding the amount to each existing</span>
02200             <span class="comment">//      run beyond the hole.</span>
02201             <span class="comment">//</span>
02202 
02203             <span class="comment">//</span>
02204             <span class="comment">//  In this case we need to decement the index by 1 and then</span>
02205             <span class="comment">//  fall to the bottom code which will do the shifting for us</span>
02206             <span class="comment">//</span>
02207 
02208             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> -= 1;
02209 
02210         <span class="comment">//</span>
02211         <span class="comment">//  Now check if the input vbn is between two existing runs</span>
02212         <span class="comment">//</span>
02213 
02214         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/largemcb_8c.html#a4">StartingVbn</a>(Mcb,Index) == Vbn) {
02215 
02216             <span class="comment">//</span>
02217             <span class="comment">//  Before: --PreviousRun--||--IndexRun--</span>
02218             <span class="comment">//  After:  --PreviousRun--||--NewHole--||--IndexRun--</span>
02219             <span class="comment">//</span>
02220             <span class="comment">//  Before: 0:|--IndexRun--</span>
02221             <span class="comment">//  After:  0:|--NewHole--||--IndexRun--</span>
02222             <span class="comment">//</span>
02223             <span class="comment">//      In this case the vbn points to the start of an existing</span>
02224             <span class="comment">//      run and the preceeding is either a real run or the start</span>
02225             <span class="comment">//      of mapping pairs We simply add a new entry for the hole</span>
02226             <span class="comment">//      and shift succeeding runs.</span>
02227             <span class="comment">//</span>
02228 
02229             <a class="code" href="../../d1/d1/largemcb_8c.html#a26">FsRtlAddLargeEntry</a>( Mcb, Index, 1 );
02230 
02231             (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Lbn = (<a class="code" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a>)<a class="code" href="../../d1/d1/largemcb_8c.html#a1">UNUSED_LBN</a>;
02232             (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].NextVbn = Vbn + Amount;
02233 
02234             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
02235 
02236         <span class="comment">//</span>
02237         <span class="comment">//  Otherwise the input vbn is inside an existing run</span>
02238         <span class="comment">//</span>
02239 
02240         } <span class="keywordflow">else</span> {
02241 
02242             <span class="comment">//</span>
02243             <span class="comment">//  Before: --IndexRun--</span>
02244             <span class="comment">//  After:  --SplitRun--||--NewHole--||--SplitRun--</span>
02245             <span class="comment">//</span>
02246             <span class="comment">//      In this case the vbn points within an existing run</span>
02247             <span class="comment">//      we need to add two new extries for hole and split</span>
02248             <span class="comment">//      run and shift succeeding runs</span>
02249             <span class="comment">//</span>
02250 
02251             <a class="code" href="../../d1/d1/largemcb_8c.html#a26">FsRtlAddLargeEntry</a>( Mcb, Index, 2 );
02252 
02253             (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Lbn = (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>+2].Lbn;
02254             (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].NextVbn = Vbn;
02255 
02256             (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>+1].Lbn = (<a class="code" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a>)<a class="code" href="../../d1/d1/largemcb_8c.html#a1">UNUSED_LBN</a>;
02257             (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>+1].NextVbn = Vbn + Amount;
02258 
02259             (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>+2].Lbn = (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>+2].Lbn +
02260                                           <a class="code" href="../../d1/d1/largemcb_8c.html#a4">StartingVbn</a>(Mcb, Index+1) -
02261                                           <a class="code" href="../../d1/d1/largemcb_8c.html#a4">StartingVbn</a>(Mcb, Index);
02262 
02263             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 2;
02264 
02265         }
02266 
02267         <span class="comment">//</span>
02268         <span class="comment">//  At this point we have completed most of the work we now need to</span>
02269         <span class="comment">//  shift existing runs from the index to the end of the mappings</span>
02270         <span class="comment">//  by the specified amount</span>
02271         <span class="comment">//</span>
02272 
02273         <span class="keywordflow">for</span> (i = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>; i &lt; Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o2">PairCount</a>; i += 1) {
02274 
02275             (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[i].NextVbn += Amount;
02276         }
02277 
02278         Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02279 
02280     try_exit: NOTHING;
02281     } finally {
02282 
02283         ExReleaseFastMutex( Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o0">FastMutex</a> );
02284 
02285         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlSplitLargeMcb -&gt; %08lx\n"</span>, Result );
02286     }
02287 
02288     <span class="keywordflow">return</span> Result;
02289 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a161" doxytag="fsrtl.h::FsRtlSyncVolumes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI NTSTATUS FsRtlSyncVolumes           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetDevice</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER ByteOffset&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>ByteCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/faulttol_8c-source.html#l00096">96</a> of file <a class="el" href="../../d8/d0/faulttol_8c-source.html">faulttol.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01552">IoBuildDeviceIoControlRequest()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00104                    :
00105 
00106     This routine signals a device driver that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must sync redundant
00107     members of a mirror from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary member.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> typically
00108     called after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system determines that a volume <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> dirty.
00109 
00110 Arguments:
00111 
00112     TargetDevice - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device to sync.
00113 
00114     ByteOffset - If specified, gives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> location to start syncing
00115 
00116     ByteCount - Gives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> byte count to sync.  Ignored <span class="keywordflow">if</span> StartingOffset
00117         not specified.
00118 
00119 Return Value:
00120 
00121     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The result of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.  This will be
00122         STATUS_INVALID_DEVICE_REQUEST <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not a mirror.
00123 
00124 --*/
00125 
00126 {
00127 
00128 <span class="preprocessor">#if 0  // Mike Glass says we no longer need to do this.  3/3/94</span>
00129 <span class="preprocessor"></span>
00130     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
00131     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00132     IO_STATUS_BLOCK Iosb;
00133     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00134     BOOLEAN RangeSpecified;
00135     FT_SYNC_INFORMATION SyncInfo;
00136 
00137     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;Event, NotificationEvent, FALSE );
00138 
00139     <span class="comment">//</span>
00140     <span class="comment">//  If the user specified a range, capture it.</span>
00141     <span class="comment">//</span>
00142 
00143     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ByteOffset)) {
00144 
00145         SyncInfo.ByteOffset = *ByteOffset;
00146         SyncInfo.ByteCount = *ByteCount;
00147 
00148         RangeSpecified = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00149 
00150     } <span class="keywordflow">else</span> {
00151 
00152         RangeSpecified = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00153     }
00154 
00155     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a25">IoBuildDeviceIoControlRequest</a>( FT_SYNC_REDUNDANT_COPY,
00156                                          TargetDevice,
00157                                          RangeSpecified ? &amp;SyncInfo : NULL,
00158                                          RangeSpecified ?
00159                                          <span class="keyword">sizeof</span>(FT_SYNC_INFORMATION) : 0,
00160                                          NULL,
00161                                          0,
00162                                          FALSE,
00163                                          &amp;Event,
00164                                          &amp;Iosb );
00165 
00166     <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00167 
00168         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00169     }
00170 
00171     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( TargetDevice, Irp );
00172 
00173 
00174     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
00175         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;Event,
00176                                         Executive,
00177                                         KernelMode,
00178                                         FALSE,
00179                                         NULL );
00180 
00181         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Status == STATUS_SUCCESS );
00182 
00183         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = Iosb.Status;
00184     }
00185 
00186     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00187 <span class="preprocessor">#else</span>
00188 <span class="preprocessor"></span>    <span class="keywordflow">return</span> STATUS_SUCCESS;
00189 
00190 <span class="preprocessor">#endif //0</span>
00191 <span class="preprocessor"></span>}

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a187" doxytag="fsrtl.h::FsRtlTeardownFilterContexts" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlTeardownFilterContexts           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLIST_ENTRY&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>FilterContexts</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/filtrctx_8c-source.html#l00276">276</a> of file <a class="el" href="../../d0/d3/filtrctx_8c-source.html">filtrctx.c</a>.
<p>
References <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01649">_FSRTL_FILTER_CONTEXT::FreeCallback</a>.
<p>
<pre class="fragment"><div>00281                    :
00282 
00283     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by filesystems to free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filter contexts
00284     associated with an <a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">FSRTL_COMMON_FCB_HEADER</a> by calling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FreeCallback
00285     routine <span class="keywordflow">for</span> each FilterContext.
00286 
00287     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed that we <span class="keywordflow">do</span> not need to acquire <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FastMutex.
00288 
00289 Arguments:
00290 
00291     FilterContexts - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FilterContexts field within
00292         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">FSRTL_COMMON_FCB_HEADER</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure being torn down
00293         by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filesystem.
00294 
00295 Return Value:
00296 
00297     None.
00298 
00299 --*/
00300 
00301 {
00302     <a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">PFSRTL_FILTER_CONTEXT</a> ctx;
00303     PLIST_ENTRY           ptr;
00304 
00305     ptr = FilterContexts-&gt;Flink;
00306 
00307     <span class="keywordflow">while</span> ( ptr != FilterContexts ) {
00308         ctx = CONTAINING_RECORD (ptr, <a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html">FSRTL_FILTER_CONTEXT</a>, Links);
00309         ptr = ptr-&gt;Flink;
00310         (*ctx-&gt;<a class="code" href="../../d2/d1/struct__FSRTL__FILTER__CONTEXT.html#o3">FreeCallback</a>)(ctx);
00311     }
00312 
00313     InitializeListHead( FilterContexts );
00314     <span class="keywordflow">return</span>;
00315 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a142" doxytag="fsrtl.h::FsRtlTruncateLargeMcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlTruncateLargeMcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Mcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Vbn</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00743">743</a> of file <a class="el" href="../../d2/d0/largemcb_8c-source.html">largemcb.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00147">ASSERTMSG</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00158">_NONOPAQUE_MCB::FastMutex</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00289">FsRtlAllocateFirstMapping</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l02748">FsRtlFindLargeIndex()</a>, <a class="el" href="../../d4/d7/fsrtlp_8h-source.html#l00040">FsRtlpAllocatePool</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00313">INITIAL_MAXIMUM_PAIR_COUNT</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00162">_NONOPAQUE_MCB::Mapping</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00159">_NONOPAQUE_MCB::MaximumPairCount</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00199">NextStartingVbn</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00160">_NONOPAQUE_MCB::PairCount</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00155">PMAPPING</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00164">PNONOPAQUE_MCB</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00161">_NONOPAQUE_MCB::PoolType</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00210">StartingLbn</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00149">UNUSED_LBN</a>, and <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00032">VBN</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00361">FsRtlTruncateMcb()</a>.
<p>
<pre class="fragment"><div>00750                    :
00751 
00752     This routine truncates an Mcb structure to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified Vbn.
00753     After calling <span class="keyword">this</span> routine <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Mcb will <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> contain mappings
00754     up to and not including <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input vbn.
00755 
00756 Arguments:
00757 
00758     OpaqueMcb - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Mcb structure to truncate.
00759 
00760     LargeVbn - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last Vbn at which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no longer to be
00761       mapped.
00762 
00763 Return Value:
00764 
00765     None.
00766 
00767 --*/
00768 
00769 {
00770     <a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html">PNONOPAQUE_MCB</a> Mcb = (<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html">PNONOPAQUE_MCB</a>)OpaqueMcb;
00771 
00772     <a class="code" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a> Vbn = ((ULONG)LargeVbn);
00773     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00774 
00775     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00776 
00777     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlTruncateLargeMcb, Mcb = %08lx\n"</span>, Mcb );
00778 
00779     ExAcquireFastMutex( Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o0">FastMutex</a> );
00780 
00781     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>(<span class="stringliteral">"LargeInteger not supported yet "</span>, ((((PLARGE_INTEGER)&amp;LargeVbn)-&gt;HighPart == 0) ||
00782                                                   (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o2">PairCount</a> == 0) ||
00783                                                   ((((PLARGE_INTEGER)&amp;LargeVbn)-&gt;HighPart == 0x7FFFFFFF) &amp;&amp;
00784                                                    (((ULONG)LargeVbn) == 0xFFFFFFFF))));
00785 
00786     <span class="keywordflow">try</span> {
00787 
00788         <span class="comment">//</span>
00789         <span class="comment">//  Do a quick test to see if we are truncating the entire Mcb.</span>
00790         <span class="comment">//</span>
00791 
00792         <span class="keywordflow">if</span> (Vbn == 0) {
00793 
00794             Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o2">PairCount</a> = 0;
00795 
00796         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o2">PairCount</a> &gt; 0) {
00797 
00798             <span class="comment">//</span>
00799             <span class="comment">//  Find the index for the entry with the last Vcn we want to keep.</span>
00800             <span class="comment">//  There is nothing to do if the Mcb already ends prior to</span>
00801             <span class="comment">//  this point.</span>
00802             <span class="comment">//</span>
00803 
00804             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/largemcb_8c.html#a25">FsRtlFindLargeIndex</a>(Mcb, Vbn - 1, &amp;Index)) {
00805 
00806                 <span class="comment">//</span>
00807                 <span class="comment">//  If this entry currently describes a hole then</span>
00808                 <span class="comment">//  truncate to the previous entry.</span>
00809                 <span class="comment">//</span>
00810 
00811                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/largemcb_8c.html#a8">StartingLbn</a>(Mcb, Index) == <a class="code" href="../../d1/d1/largemcb_8c.html#a1">UNUSED_LBN</a>) {
00812 
00813                     Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o2">PairCount</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00814 
00815                 <span class="comment">//</span>
00816                 <span class="comment">//  Otherwise we will truncate the Mcb to this point.  Truncate</span>
00817                 <span class="comment">//  the number of Vbns of this run if necessary.</span>
00818                 <span class="comment">//</span>
00819 
00820                 } <span class="keywordflow">else</span> {
00821 
00822                     Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o2">PairCount</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> + 1;
00823 
00824                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/largemcb_8c.html#a6">NextStartingVbn</a>(Mcb, Index) &gt; Vbn) {
00825 
00826                         (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].NextVbn = Vbn;
00827                     }
00828                 }
00829             }
00830         }
00831 
00832         <span class="comment">//</span>
00833         <span class="comment">//  Now see if we can shrink the allocation for the mapping pairs.</span>
00834         <span class="comment">//  We'll shrink the mapping pair buffer if the new pair count will</span>
00835         <span class="comment">//  fit within a quarter of the current maximum pair count and the</span>
00836         <span class="comment">//  current maximum is greater than the initial pair count.</span>
00837         <span class="comment">//</span>
00838 
00839         <span class="keywordflow">if</span> ((Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o2">PairCount</a> &lt; (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o1">MaximumPairCount</a> / 4)) &amp;&amp;
00840             (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o1">MaximumPairCount</a> &gt; <a class="code" href="../../d1/d1/largemcb_8c.html#a17">INITIAL_MAXIMUM_PAIR_COUNT</a>)) {
00841 
00842             ULONG NewMax;
00843             <a class="code" href="../../d8/d6/struct__MAPPING.html">PMAPPING</a> Mapping;
00844 
00845             <span class="comment">//</span>
00846             <span class="comment">//  We need to allocate a new mapping so compute a new maximum pair</span>
00847             <span class="comment">//  count.  We'll allocate double the current pair count, but never</span>
00848             <span class="comment">//  less than the initial pair count.</span>
00849             <span class="comment">//</span>
00850 
00851             NewMax = Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o2">PairCount</a> * 2;
00852 
00853             <span class="keywordflow">if</span> (NewMax &lt; <a class="code" href="../../d1/d1/largemcb_8c.html#a17">INITIAL_MAXIMUM_PAIR_COUNT</a>) {
00854                 NewMax = <a class="code" href="../../d1/d1/largemcb_8c.html#a17">INITIAL_MAXIMUM_PAIR_COUNT</a>;
00855             }
00856 
00857             <span class="comment">//</span>
00858             <span class="comment">//  Be careful to trap failures due to resource exhaustion.</span>
00859             <span class="comment">//</span>
00860                 
00861             <span class="keywordflow">try</span> {
00862                     
00863                 <span class="keywordflow">if</span> (NewMax == <a class="code" href="../../d1/d1/largemcb_8c.html#a17">INITIAL_MAXIMUM_PAIR_COUNT</a> &amp;&amp; Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o3">PoolType</a> == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
00864 
00865                     Mapping = <a class="code" href="../../d1/d1/largemcb_8c.html#a13">FsRtlAllocateFirstMapping</a>();
00866 
00867                 } <span class="keywordflow">else</span> {
00868             
00869                     Mapping = <a class="code" href="../../d3/d8/fsrtlp_8h.html#a2">FsRtlpAllocatePool</a>( Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o3">PoolType</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d6/struct__MAPPING.html">MAPPING</a>) * NewMax );
00870                 }
00871 
00872             } except (EXCEPTION_EXECUTE_HANDLER) {
00873 
00874                   Mapping = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00875             }
00876 
00877             <span class="comment">//</span>
00878             <span class="comment">//  Now check if we really got a new buffer</span>
00879             <span class="comment">//</span>
00880 
00881             <span class="keywordflow">if</span> (Mapping != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00882 
00883                 <span class="comment">//</span>
00884                 <span class="comment">//  Now copy over the old mapping to the new buffer</span>
00885                 <span class="comment">//</span>
00886 
00887                 RtlCopyMemory( Mapping, Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d6/struct__MAPPING.html">MAPPING</a>) * Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o2">PairCount</a> );
00888 
00889                 <span class="comment">//</span>
00890                 <span class="comment">//  Deallocate the old buffer.  This should never be the size of an</span>
00891                 <span class="comment">//  initial mapping ...</span>
00892                 <span class="comment">//</span>
00893 
00894                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a> );
00895 
00896                 <span class="comment">//</span>
00897                 <span class="comment">//  And set up the new buffer in the Mcb</span>
00898                 <span class="comment">//</span>
00899 
00900                 Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a> = Mapping;
00901                 Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o1">MaximumPairCount</a> = NewMax;
00902             }
00903         }
00904 
00905     } finally {
00906 
00907         ExReleaseFastMutex( Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o0">FastMutex</a> );
00908     }
00909 
00910     <span class="comment">//</span>
00911     <span class="comment">//  And return to our caller</span>
00912     <span class="comment">//</span>
00913 
00914     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlTruncateLargeMcb -&gt; VOID\n"</span>, 0 );
00915 
00916     <span class="keywordflow">return</span>;
00917 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a153" doxytag="fsrtl.h::FsRtlTruncateMcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlTruncateMcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d7/struct__MCB.html">PMCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Mcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vbn</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00361">361</a> of file <a class="el" href="../../d2/d0/largemcb_8c-source.html">largemcb.c</a>.
<p>
References <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00743">FsRtlTruncateLargeMcb()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
<pre class="fragment"><div>00365 {
00366    <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00367 
00368    <a class="code" href="../../d1/d8/fsrtl_8h.html#a142">FsRtlTruncateLargeMcb</a>( (<a class="code" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a>)Mcb,
00369                           (LONGLONG)(Vbn) );
00370 
00371    <span class="keywordflow">return</span>;
00372 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a115" doxytag="fsrtl.h::FsRtlUninitializeFileLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlUninitializeFileLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>FileLock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/filelock_8c-source.html#l00995">995</a> of file <a class="el" href="../../d6/d2/filelock_8c-source.html">filelock.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01667">_IRP::CancelIrql</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00112">_WAITING_LOCK::Context</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00141">_LOCK_QUEUE::ExclusiveLockTree</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00481">FsRtlAcquireLockQueue</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00497">FsRtlCompleteLockIrp</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00446">FsRtlFreeExclusiveLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00473">FsRtlFreeLockInfo()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00464">FsRtlFreeLockTreeNode()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00437">FsRtlFreeSharedLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00455">FsRtlFreeWaitingLock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l00487">FsRtlReleaseLockQueue</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00100">IoAcquireCancelSpinLock()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09613">IoReleaseCancelSpinLock()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03867">IoSetCancelRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00118">_WAITING_LOCK::Irp</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00083">_EX_LOCK::Links</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00036">_LOCKTREE_NODE::Links</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00184">_LOCK_INFO::LockQueue</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00008">_LOCKTREE_NODE::Locks</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a24">PEX_LOCK</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a30">PLOCK_INFO</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a20">PLOCKTREE_NODE</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a22">PSH_LOCK</a>, <a class="el" href="../../d5/d3/filelock_8c.html#a26">PWAITING_LOCK</a>, <a class="el" href="../../d4/d3/splay_8c-source.html#l00502">RtlDeleteNoSplay()</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00140">_LOCK_QUEUE::SharedLockTree</a>, and <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00142">_LOCK_QUEUE::WaitingLocks</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/filelock_8c-source.html#l01162">FsRtlFreeFileLock()</a>.
<p>
<pre class="fragment"><div>01001                    :
01002 
01003     This routine uninitializes a <a class="code" href="../../d7/d1/struct__FILE__LOCK.html">FILE_LOCK</a> structure.  After calling <span class="keyword">this</span>
01004     routine <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> lock must be reinitialized before being used again.
01005 
01006     This routine will free all files locks and completes any outstanding
01007     lock requests as a result of cleaning itself up.
01008 
01009 Arguments:
01010 
01011     FileLock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/struct__FILE__LOCK.html">FILE_LOCK</a> struture being
01012         decommissioned.
01013 
01014 Return Value:
01015 
01016     None.
01017 
01018 --*/
01019 
01020 {
01021     <a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>          LockInfo;
01022     <a class="code" href="../../d8/d2/struct__SH__LOCK.html">PSH_LOCK</a>            ShLock;
01023     <a class="code" href="../../d7/d7/struct__EX__LOCK.html">PEX_LOCK</a>            ExLock;
01024     PSINGLE_LIST_ENTRY  Link;
01025     <a class="code" href="../../d1/d8/struct__WAITING__LOCK.html">PWAITING_LOCK</a>       WaitingLock;
01026     <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">PLOCKTREE_NODE</a>      LockTreeNode;
01027     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>                <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
01028     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            NewStatus;
01029     KIRQL               OldIrql;
01030     PKPRCB              Prcb;
01031 
01032     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlUninitializeFileLock, FileLock = %08lx\n"</span>, FileLock);
01033 
01034     <span class="keywordflow">if</span> ((LockInfo = (<a class="code" href="../../d6/d2/struct__LOCK__INFO.html">PLOCK_INFO</a>) FileLock-&gt;LockInformation) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01035         <span class="keywordflow">return</span> ;
01036     }
01037 
01038     <span class="comment">//</span>
01039     <span class="comment">//  Lock the queue</span>
01040     <span class="comment">//</span>
01041 
01042     <a class="code" href="../../d5/d3/filelock_8c.html#a8">FsRtlAcquireLockQueue</a>(&amp;LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>, &amp;OldIrql);
01043 
01044     <span class="comment">//</span>
01045     <span class="comment">//  Free lock trees</span>
01046     <span class="comment">//</span>
01047 
01048     <span class="keywordflow">while</span> (LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o1">SharedLockTree</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01049 
01050         LockTreeNode = CONTAINING_RECORD(LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o1">SharedLockTree</a>, <a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html">LOCKTREE_NODE</a>, Links);
01051 
01052         <span class="comment">//</span>
01053         <span class="comment">//  Remove all locks associated with the root node</span>
01054         <span class="comment">//</span>
01055 
01056         <span class="keywordflow">while</span> (LockTreeNode-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o0">Locks</a>.Next != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01057             Link = PopEntryList (&amp;LockTreeNode-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o0">Locks</a>);
01058             ShLock = CONTAINING_RECORD( Link, <a class="code" href="../../d8/d2/struct__SH__LOCK.html">SH_LOCK</a>, Link );
01059 
01060             <a class="code" href="../../d5/d3/filelock_8c.html#a36">FsRtlFreeSharedLock</a>(ShLock);
01061         }
01062 
01063         <span class="comment">//</span>
01064         <span class="comment">//  Slice off the root node of the tree</span>
01065         <span class="comment">//</span>
01066 
01067         <a class="code" href="../../d3/d4/splay_8c.html#a5">RtlDeleteNoSplay</a>(&amp;LockTreeNode-&gt;<a class="code" href="../../d2/d3/struct__LOCKTREE__NODE.html#o3">Links</a>, &amp;LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o1">SharedLockTree</a>);
01068 
01069         <a class="code" href="../../d5/d3/filelock_8c.html#a39">FsRtlFreeLockTreeNode</a>(LockTreeNode);
01070     }
01071 
01072     <span class="keywordflow">while</span> (LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o2">ExclusiveLockTree</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01073 
01074         ExLock = CONTAINING_RECORD(LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o2">ExclusiveLockTree</a>, <a class="code" href="../../d7/d7/struct__EX__LOCK.html">EX_LOCK</a>, Links);
01075 
01076         <a class="code" href="../../d3/d4/splay_8c.html#a5">RtlDeleteNoSplay</a>(&amp;ExLock-&gt;<a class="code" href="../../d7/d7/struct__EX__LOCK.html#o0">Links</a>, &amp;LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o2">ExclusiveLockTree</a>);
01077 
01078         <a class="code" href="../../d5/d3/filelock_8c.html#a37">FsRtlFreeExclusiveLock</a>(ExLock);
01079     }
01080 
01081     <span class="comment">//</span>
01082     <span class="comment">//  Free WaitingLockQueue</span>
01083     <span class="comment">//</span>
01084 
01085     <span class="keywordflow">while</span> (LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o3">WaitingLocks</a>.Next != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01086 
01087         Link = PopEntryList( &amp;LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>.<a class="code" href="../../d8/d2/struct__LOCK__QUEUE.html#o3">WaitingLocks</a> );
01088         WaitingLock = CONTAINING_RECORD( Link, <a class="code" href="../../d1/d8/struct__WAITING__LOCK.html">WAITING_LOCK</a>, Link );
01089 
01090         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = WaitingLock-&gt;<a class="code" href="../../d1/d8/struct__WAITING__LOCK.html#o2">Irp</a>;
01091 
01092         <span class="comment">//</span>
01093         <span class="comment">//  To complete an irp in the waiting queue we need to</span>
01094         <span class="comment">//  void the cancel routine (protected by a spinlock) before</span>
01095         <span class="comment">//  we can complete the irp</span>
01096         <span class="comment">//</span>
01097 
01098         <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a> (&amp;LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>, OldIrql);
01099 
01100         <a class="code" href="../../d4/d6/iosubs_8c.html#a9">IoAcquireCancelSpinLock</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
01101         <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( Irp, NULL );
01102         <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
01103 
01104         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = 0;
01105 
01106         <a class="code" href="../../d5/d3/filelock_8c.html#a11">FsRtlCompleteLockIrp</a>(
01107              LockInfo,
01108              WaitingLock-&gt;<a class="code" href="../../d1/d8/struct__WAITING__LOCK.html#o1">Context</a>,
01109              Irp,
01110              STATUS_RANGE_NOT_LOCKED,
01111              &amp;NewStatus,
01112              NULL );
01113 
01114         <a class="code" href="../../d5/d3/filelock_8c.html#a8">FsRtlAcquireLockQueue</a>(&amp;LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>, &amp;OldIrql);
01115         <a class="code" href="../../d5/d3/filelock_8c.html#a38">FsRtlFreeWaitingLock</a>( WaitingLock );
01116     }
01117 
01118     <span class="comment">//</span>
01119     <span class="comment">// Free pool used to track the lock info on this file</span>
01120     <span class="comment">//</span>
01121 
01122     <a class="code" href="../../d5/d3/filelock_8c.html#a10">FsRtlReleaseLockQueue</a>( &amp;LockInfo-&gt;<a class="code" href="../../d6/d2/struct__LOCK__INFO.html#o3">LockQueue</a>, OldIrql );
01123     <a class="code" href="../../d5/d3/filelock_8c.html#a40">FsRtlFreeLockInfo</a>( LockInfo );
01124 
01125     <span class="comment">//</span>
01126     <span class="comment">// Unlink LockInfo from FileLock</span>
01127     <span class="comment">//</span>
01128 
01129     FileLock-&gt;LockInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01130 
01131     <span class="comment">//</span>
01132     <span class="comment">//  And return to our caller</span>
01133     <span class="comment">//</span>
01134 
01135     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlUninitializeFileLock -&gt; VOID\n"</span>, 0 );
01136     <span class="keywordflow">return</span>;
01137 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a140" doxytag="fsrtl.h::FsRtlUninitializeLargeMcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlUninitializeLargeMcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Mcb</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00670">670</a> of file <a class="el" href="../../d2/d0/largemcb_8c-source.html">largemcb.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00158">_NONOPAQUE_MCB::FastMutex</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00298">FsRtlFreeFastMutex</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00292">FsRtlFreeFirstMapping</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00313">INITIAL_MAXIMUM_PAIR_COUNT</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00162">_NONOPAQUE_MCB::Mapping</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00159">_NONOPAQUE_MCB::MaximumPairCount</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00164">PNONOPAQUE_MCB</a>, and <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00161">_NONOPAQUE_MCB::PoolType</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00348">FsRtlUninitializeMcb()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l00309">UdfDeletePcb()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00207">UdfUninitializeFcbMcb()</a>.
<p>
<pre class="fragment"><div>00676                    :
00677 
00678     This routine uninitializes an Mcb structure.  After calling <span class="keyword">this</span> routine
00679     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input Mcb structure must be re-initialized before being used again.
00680 
00681 Arguments:
00682 
00683     OpaqueMcb - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Mcb structure to uninitialize.
00684 
00685 Return Value:
00686 
00687     None.
00688 
00689 --*/
00690 
00691 {
00692     <a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html">PNONOPAQUE_MCB</a> Mcb = (<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html">PNONOPAQUE_MCB</a>)OpaqueMcb;
00693 
00694     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlUninitializeLargeMcb, Mcb = %08lx\n"</span>, Mcb );
00695 
00696     <span class="comment">//</span>
00697     <span class="comment">//  Protect against some user calling us to uninitialize an mcb twice</span>
00698     <span class="comment">//</span>
00699 
00700     <span class="keywordflow">if</span> (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o0">FastMutex</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00701 
00702         <span class="comment">// ASSERTMSG("Being called to uninitialize an Mcb that is already Uninitialized ", FALSE);</span>
00703 
00704         <span class="keywordflow">return</span>;
00705     }
00706 
00707     <span class="comment">//</span>
00708     <span class="comment">//  Deallocate the FastMutex and mapping buffer</span>
00709     <span class="comment">//</span>
00710 
00711     <a class="code" href="../../d1/d1/largemcb_8c.html#a16">FsRtlFreeFastMutex</a>( Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o0">FastMutex</a> );
00712 
00713     Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o0">FastMutex</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00714 
00715     <span class="keywordflow">if</span> ((Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o3">PoolType</a> == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) &amp;&amp; (Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o1">MaximumPairCount</a> == <a class="code" href="../../d1/d1/largemcb_8c.html#a17">INITIAL_MAXIMUM_PAIR_COUNT</a>)) {
00716 
00717         <a class="code" href="../../d1/d1/largemcb_8c.html#a14">FsRtlFreeFirstMapping</a>( Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a> );
00718 
00719     } <span class="keywordflow">else</span> {
00720 
00721         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Mcb-&gt;<a class="code" href="../../d5/d3/struct__NONOPAQUE__MCB.html#o4">Mapping</a> );
00722     }
00723 
00724     <span class="comment">//</span>
00725     <span class="comment">//  Now zero our all of the fields in the Mcb</span>
00726     <span class="comment">//</span>
00727 
00728     <span class="comment">//**** Mcb-&gt;MaximumPairCount = 0;</span>
00729     <span class="comment">//**** Mcb-&gt;PairCount = 0;</span>
00730     <span class="comment">//**** Mcb-&gt;Mapping = NULL;</span>
00731 
00732     <span class="comment">//</span>
00733     <span class="comment">//  And return to our caller</span>
00734     <span class="comment">//</span>
00735 
00736     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, Dbg, <span class="stringliteral">"FsRtlUninitializeLargeMcb -&gt; VOID\n"</span>, 0 );
00737 
00738     <span class="keywordflow">return</span>;
00739 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a152" doxytag="fsrtl.h::FsRtlUninitializeMcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlUninitializeMcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d7/struct__MCB.html">PMCB</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Mcb</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00348">348</a> of file <a class="el" href="../../d2/d0/largemcb_8c-source.html">largemcb.c</a>.
<p>
References <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00670">FsRtlUninitializeLargeMcb()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00219">UdfInitializeVmcb()</a>, and <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00325">UdfUninitializeVmcb()</a>.
<p>
<pre class="fragment"><div>00352 {
00353     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00354 
00355     <a class="code" href="../../d1/d8/fsrtl_8h.html#a140">FsRtlUninitializeLargeMcb</a>( (<a class="code" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a>)Mcb );
00356 
00357     <span class="keywordflow">return</span>;
00358 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a163" doxytag="fsrtl.h::FsRtlUninitializeOplock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlUninitializeOplock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d1/d8/fsrtl_8h.html#a78">POPLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Oplock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/oplock_8c-source.html#l00413">413</a> of file <a class="el" href="../../d6/d1/oplock_8c-source.html">oplock.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01667">_IRP::CancelIrql</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00284">_WAITING_IRP::CompletionRoutine</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00290">_WAITING_IRP::Context</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe()</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00243">_NONOPAQUE_OPLOCK::FastMutex</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00217">_NONOPAQUE_OPLOCK::FileObject</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01745">FsRtlCompleteRequest</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00100">IoAcquireCancelSpinLock()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09613">IoReleaseCancelSpinLock()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03867">IoSetCancelRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00277">_WAITING_IRP::Irp</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00210">_NONOPAQUE_OPLOCK::IrpExclusiveOplock</a>, <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00224">_NONOPAQUE_OPLOCK::IrpOplocksII</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d2/oplock_8c.html#a36">PNONOPAQUE_OPLOCK</a>, <a class="el" href="../../d5/d2/oplock_8c.html#a38">PWAITING_IRP</a>, and <a class="el" href="../../d3/d7/fsrtllks_8h-source.html#l00231">_NONOPAQUE_OPLOCK::WaitingIrps</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02178">UdfDeleteFcb()</a>.
<p>
<pre class="fragment"><div>00419                    :
00420 
00421     This routine uninitializes an <a class="code" href="../../d1/d8/fsrtl_8h.html#a77">OPLOCK</a> structure.  After calling <span class="keyword">this</span>
00422     routine, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a77">OPLOCK</a> structure must be reinitialized before being
00423     used again.
00424 
00425 Arguments:
00426 
00427     Oplock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of an opaque <a class="code" href="../../d1/d8/fsrtl_8h.html#a77">OPLOCK</a> structure.
00428 
00429 Return Value:
00430 
00431     None.
00432 
00433 --*/
00434 
00435 
00436 {
00437     <a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a> ThisOplock;
00438 
00439     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, Dbg, <span class="stringliteral">"FsRtlUninitializeOplock:  Oplock -&gt; %08lx\n"</span>, *Oplock );
00440 
00441     <span class="comment">//</span>
00442     <span class="comment">//  If the Oplock structure has not been allocated, there is no action</span>
00443     <span class="comment">//  to take.</span>
00444     <span class="comment">//</span>
00445 
00446     <span class="keywordflow">if</span> (*Oplock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00447 
00448         <span class="comment">//</span>
00449         <span class="comment">//  Remove this from the user's structure.</span>
00450         <span class="comment">//</span>
00451 
00452         ThisOplock = (<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html">PNONOPAQUE_OPLOCK</a>) *Oplock;
00453 
00454         *Oplock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00455 
00456         <span class="comment">//</span>
00457         <span class="comment">//  Grab the waiting lock queue mutex to exclude anyone from messing</span>
00458         <span class="comment">//  with the queue while we're using it</span>
00459         <span class="comment">//</span>
00460 
00461         <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> );
00462 
00463         <span class="keywordflow">try</span> {
00464 
00465             <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
00466 
00467             <span class="comment">//</span>
00468             <span class="comment">//  Release any waiting Irps held.</span>
00469             <span class="comment">//</span>
00470 
00471             <span class="keywordflow">while</span> (!IsListEmpty( &amp;ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o3">WaitingIrps</a> )) {
00472 
00473                 <a class="code" href="../../d0/d8/struct__WAITING__IRP.html">PWAITING_IRP</a> WaitingIrp;
00474                 <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> ThisIrp;
00475 
00476                 WaitingIrp = CONTAINING_RECORD( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o3">WaitingIrps</a>.Flink,
00477                                                 <a class="code" href="../../d0/d8/struct__WAITING__IRP.html">WAITING_IRP</a>,
00478                                                 Links );
00479 
00480                 RemoveHeadList( &amp;ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o3">WaitingIrps</a> );
00481 
00482                 ThisIrp = WaitingIrp-&gt;<a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o1">Irp</a>;
00483 
00484                 <a class="code" href="../../d4/d6/iosubs_8c.html#a9">IoAcquireCancelSpinLock</a>( &amp;ThisIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
00485 
00486                 <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( ThisIrp, NULL );
00487                 <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( ThisIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
00488 
00489                 ThisIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = 0;
00490 
00491                 <span class="comment">//</span>
00492                 <span class="comment">//  Call the completion routine in the Waiting Irp.</span>
00493                 <span class="comment">//</span>
00494 
00495                 WaitingIrp-&gt;<a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o2">CompletionRoutine</a>( WaitingIrp-&gt;<a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o3">Context</a>,
00496                                                WaitingIrp-&gt;<a class="code" href="../../d0/d8/struct__WAITING__IRP.html#o1">Irp</a> );
00497 
00498                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( WaitingIrp );
00499             }
00500 
00501             <span class="comment">//</span>
00502             <span class="comment">//  Release any oplock II irps held.</span>
00503             <span class="comment">//</span>
00504 
00505             <span class="keywordflow">while</span> (!IsListEmpty( &amp;ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o2">IrpOplocksII</a> )) {
00506 
00507                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = CONTAINING_RECORD( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o2">IrpOplocksII</a>.Flink,
00508                                          <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>,
00509                                          Tail.Overlay.ListEntry );
00510 
00511                 RemoveHeadList( &amp;ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o2">IrpOplocksII</a> );
00512 
00513                 <a class="code" href="../../d4/d6/iosubs_8c.html#a9">IoAcquireCancelSpinLock</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
00514 
00515                 <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( Irp, NULL );
00516                 <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
00517 
00518                 <span class="comment">//</span>
00519                 <span class="comment">//  Complete the oplock II Irp.</span>
00520                 <span class="comment">//</span>
00521 
00522                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp )-&gt;FileObject );
00523 
00524                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = FILE_OPLOCK_BROKEN_TO_NONE;
00525                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Irp, STATUS_SUCCESS );
00526             }
00527 
00528             <span class="comment">//</span>
00529             <span class="comment">//  Release any exclusive oplock held.</span>
00530             <span class="comment">//</span>
00531 
00532             <span class="keywordflow">if</span> (ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o0">IrpExclusiveOplock</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00533 
00534                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o0">IrpExclusiveOplock</a>;
00535 
00536                 <a class="code" href="../../d4/d6/iosubs_8c.html#a9">IoAcquireCancelSpinLock</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
00537 
00538                 <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( Irp, NULL );
00539                 <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o15">CancelIrql</a> );
00540 
00541                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = FILE_OPLOCK_BROKEN_TO_NONE;
00542                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( Irp, STATUS_SUCCESS );
00543 
00544                 ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o0">IrpExclusiveOplock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00545 
00546                 <span class="keywordflow">if</span> (ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o1">FileObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00547 
00548                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o1">FileObject</a> );
00549                 }
00550             }
00551 
00552         } finally {
00553 
00554             <span class="comment">//</span>
00555             <span class="comment">//  No matter how we complete the preceding statements we will</span>
00556             <span class="comment">//  now release the waiting lock queue mutex</span>
00557             <span class="comment">//</span>
00558 
00559             <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> );
00560         }
00561 
00562         <span class="comment">//</span>
00563         <span class="comment">//  Deallocate the mutex.</span>
00564         <span class="comment">//</span>
00565 
00566         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ThisOplock-&gt;<a class="code" href="../../d6/d3/struct__NONOPAQUE__OPLOCK.html#o5">FastMutex</a> );
00567 
00568         <span class="comment">//</span>
00569         <span class="comment">//  Deallocate the Oplock structure.</span>
00570         <span class="comment">//</span>
00571 
00572         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ThisOplock );
00573     }
00574 
00575     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlUninitializeOplock:  Exit\n"</span>, 0 );
00576     <span class="keywordflow">return</span>;
00577 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a71" doxytag="fsrtl.h::LEGAL_ANSI_CHARACTER_ARRAY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PUCHAR <a class="el" href="../../d1/d8/fsrtl_8h.html#a71">LEGAL_ANSI_CHARACTER_ARRAY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00928">928</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a72" doxytag="fsrtl.h::NLS_OEM_LEAD_BYTE_INFO" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a22">PUSHORT</a> <a class="el" href="../../d1/d8/fsrtl_8h.html#a72">NLS_OEM_LEAD_BYTE_INFO</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00929">929</a> of file <a class="el" href="../../d2/d7/fsrtl_8h-source.html">fsrtl.h</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:47 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
