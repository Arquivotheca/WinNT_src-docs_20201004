<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: clmsg.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>clmsg.c</h1><a href="../../d0/d9/clmsg_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: ClMsg.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Includes the mapping table for messages when calling the server.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* 04-11-91 ScottLu Created.</span>
00009 <span class="comment">\***************************************************************************/</span>
00010 
00011 <span class="preprocessor">#include "<a class="code" href="../../d7/d3/w32_2ntuser_2client_2precomp_8h.html">precomp.h</a>"</span>
00012 <span class="preprocessor">#pragma hdrstop</span>
00013 <span class="preprocessor"></span>
00014 
<a name="l00015"></a><a class="code" href="../../d0/d9/clmsg_8c.html#a0">00015</a> <span class="preprocessor">#define fnINDESTROYCLIPBRD      fnDWORD</span>
<a name="l00016"></a><a class="code" href="../../d0/d9/clmsg_8c.html#a1">00016</a> <span class="preprocessor"></span><span class="preprocessor">#define fnOUTDWORDDWORD         fnDWORD</span>
<a name="l00017"></a><a class="code" href="../../d0/d9/clmsg_8c.html#a2">00017</a> <span class="preprocessor"></span><span class="preprocessor">#define fnPOWERBROADCAST        fnDWORD</span>
<a name="l00018"></a><a class="code" href="../../d0/d9/clmsg_8c.html#a3">00018</a> <span class="preprocessor"></span><span class="preprocessor">#define fnLOGONNOTIFY           fnKERNELONLY</span>
<a name="l00019"></a><a class="code" href="../../d0/d9/clmsg_8c.html#a4">00019</a> <span class="preprocessor"></span><span class="preprocessor">#define fnINLPKDRAWSWITCHWND    fnKERNELONLY</span>
00020 <span class="preprocessor"></span>
<a name="l00021"></a><a class="code" href="../../d0/d9/clmsg_8c.html#a5">00021</a> <span class="preprocessor">#define MSGFN(func) fn ## func</span>
<a name="l00022"></a><a class="code" href="../../d0/d9/clmsg_8c.html#a6">00022</a> <span class="preprocessor"></span><span class="preprocessor">#define FNSCSENDMESSAGE CFNSCSENDMESSAGE</span>
00023 <span class="preprocessor"></span>
00024 <span class="preprocessor">#include "<a class="code" href="../../d1/d8/messages_8h.html">messages.h</a>"</span>
00025 
00026 <span class="preprocessor">#if DBG</span>
00027 <span class="preprocessor"></span><a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> gfTurboDWP = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00028 <span class="preprocessor">#endif</span>
00029 <span class="preprocessor"></span>
00030 <span class="comment">/***************************************************************************\</span>
00031 <span class="comment">* GetMouseKeyState</span>
00032 <span class="comment">*</span>
00033 <span class="comment">* Returns the state of mouse and keyboard keys that are sent</span>
00034 <span class="comment">* in a mouse message.</span>
00035 <span class="comment">*</span>
00036 <span class="comment">* History:</span>
00037 <span class="comment">* 12-Nov-1998 adams     Created.</span>
00038 <span class="comment">\***************************************************************************/</span>
00039 
00040 WORD
<a name="l00041"></a><a class="code" href="../../d0/d9/clmsg_8c.html#a9">00041</a> <a class="code" href="../../d0/d9/clmsg_8c.html#a9">GetMouseKeyState</a>(<span class="keywordtype">void</span>)
00042 {
00043     WORD keystate;
00044 
00045     <span class="comment">/*</span>
00046 <span class="comment">     * Note that it is more efficient to call GetKeyState for each</span>
00047 <span class="comment">     * key than to call GetKeyboardState, since the keys we are testing</span>
00048 <span class="comment">     * are cached and don't require a trip to the kernel to fetch.</span>
00049 <span class="comment">     */</span>
00050 
00051 <span class="preprocessor">#define TESTANDSETKEYSTATE(x)            \</span>
00052 <span class="preprocessor">    if (GetKeyState(VK_##x) &amp; 0x8000) {  \</span>
00053 <span class="preprocessor">        keystate |= MK_##x;              \</span>
00054 <span class="preprocessor">    }</span>
00055 <span class="preprocessor"></span>
00056     keystate = 0;
00057     <a class="code" href="../../d0/d9/clmsg_8c.html#a7">TESTANDSETKEYSTATE</a>(LBUTTON)
00058     <a class="code" href="../../d0/d9/clmsg_8c.html#a7">TESTANDSETKEYSTATE</a>(RBUTTON)
00059     <a class="code" href="../../d0/d9/clmsg_8c.html#a7">TESTANDSETKEYSTATE</a>(MBUTTON)
00060     <a class="code" href="../../d0/d9/clmsg_8c.html#a7">TESTANDSETKEYSTATE</a>(XBUTTON1)
00061     <a class="code" href="../../d0/d9/clmsg_8c.html#a7">TESTANDSETKEYSTATE</a>(XBUTTON2)
00062     <a class="code" href="../../d0/d9/clmsg_8c.html#a7">TESTANDSETKEYSTATE</a>(<a class="code" href="../../d2/d9/uipriv_8c.html#a0">SHIFT</a>)
00063     <a class="code" href="../../d0/d9/clmsg_8c.html#a7">TESTANDSETKEYSTATE</a>(CONTROL)
00064 
00065     <span class="keywordflow">return</span> keystate;
00066 }
00067 
00068 <span class="comment">/***************************************************************************\</span>
00069 <span class="comment">* These are client side thunks for server side window procs. This is being</span>
00070 <span class="comment">* done so that when an app gets a wndproc via GetWindowLong, GetClassLong,</span>
00071 <span class="comment">* or GetClassInfo, it gets a real callable address - some apps don't call</span>
00072 <span class="comment">* CallWindowProc, but call the return ed address directly.</span>
00073 <span class="comment">*</span>
00074 <span class="comment">* 01-13-92 ScottLu Created.</span>
00075 <span class="comment">* 03-Dec-1993 mikeke  added client side handling of some messages</span>
00076 <span class="comment">\***************************************************************************/</span>
00077 
<a name="l00078"></a><a class="code" href="../../d0/d9/clmsg_8c.html#a10">00078</a> LRESULT WINAPI <a class="code" href="../../d0/d9/clmsg_8c.html#a10">DesktopWndProcWorker</a>(
00079     HWND hwnd,
00080     UINT message,
00081     WPARAM wParam,
00082     LPARAM lParam,
00083     BOOL fAnsi)
00084 {
00085     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00086 
00087     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a10">FWINDOWMSG</a>(message, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a196">FNID_DESKTOP</a>)) {
00088         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a11">CsSendMessage</a>(hwnd, message, wParam, lParam,
00089                 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a196">FNID_DESKTOP</a>, fAnsi);
00090     }
00091 
00092     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00093         <span class="keywordflow">return</span> 0;
00094 
00095     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(pwnd, message, wParam, lParam, fAnsi);
00096 
00097 }
00098 
<a name="l00099"></a><a class="code" href="../../d6/d0/usercli_8h.html#a578">00099</a> LRESULT WINAPI <a class="code" href="../../d6/d0/usercli_8h.html#a578">DesktopWndProcA</a>(
00100     HWND hwnd,
00101     UINT message,
00102     WPARAM wParam,
00103     LPARAM lParam)
00104 {
00105     <span class="keywordflow">return</span> <a class="code" href="../../d0/d9/clmsg_8c.html#a10">DesktopWndProcWorker</a>(hwnd, message, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00106 }
00107 
<a name="l00108"></a><a class="code" href="../../d6/d0/usercli_8h.html#a579">00108</a> LRESULT WINAPI <a class="code" href="../../d6/d0/usercli_8h.html#a579">DesktopWndProcW</a>(
00109     HWND hwnd,
00110     UINT message,
00111     WPARAM wParam,
00112     LPARAM lParam)
00113 {
00114     <span class="keywordflow">return</span> <a class="code" href="../../d0/d9/clmsg_8c.html#a10">DesktopWndProcWorker</a>(hwnd, message, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00115 }
00116 
00117 <span class="comment">/***************************************************************************\</span>
00118 <span class="comment">* These are client side thunks for server side window procs. This is being</span>
00119 <span class="comment">* done so that when an app gets a wndproc via GetWindowLong, GetClassLong,</span>
00120 <span class="comment">* or GetClassInfo, it gets a real callable address - some apps don't call</span>
00121 <span class="comment">* CallWindowProc, but call the return ed address directly.</span>
00122 <span class="comment">*</span>
00123 <span class="comment">* 01-13-92 ScottLu Created.</span>
00124 <span class="comment">* 03-Dec-1993 mikeke  added client side handling of some messages</span>
00125 <span class="comment">\***************************************************************************/</span>
00126 
<a name="l00127"></a><a class="code" href="../../d0/d9/clmsg_8c.html#a13">00127</a> LRESULT WINAPI <a class="code" href="../../d0/d9/clmsg_8c.html#a13">MenuWndProcWorker</a>(
00128     HWND hwnd,
00129     UINT message,
00130     WPARAM wParam,
00131     LPARAM lParam,
00132     BOOL fAnsi)
00133 {
00134     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00135 
00136     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a10">FWINDOWMSG</a>(message, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a195">FNID_MENU</a>)) {
00137         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a11">CsSendMessage</a>(hwnd, message, wParam, lParam,
00138                 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a195">FNID_MENU</a>, fAnsi);
00139     }
00140 
00141     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00142         <span class="keywordflow">return</span> 0;
00143 
00144     <span class="keywordflow">switch</span> (message) {
00145     <span class="keywordflow">case</span> WM_LBUTTONDBLCLK:
00146     <span class="keywordflow">case</span> WM_NCLBUTTONDBLCLK:
00147     <span class="keywordflow">case</span> WM_RBUTTONDBLCLK:
00148     <span class="keywordflow">case</span> WM_NCRBUTTONDBLCLK:
00149 
00150         <span class="comment">/*</span>
00151 <span class="comment">         * Ignore double clicks on these windows.</span>
00152 <span class="comment">         */</span>
00153         <span class="keywordflow">break</span>;
00154 
00155     <span class="keywordflow">case</span> WM_DESTROY:
00156         <span class="keywordflow">break</span>;
00157 
00158     <span class="keywordflow">default</span>:
00159         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(pwnd, message, wParam, lParam, fAnsi);
00160     }
00161 
00162     <span class="keywordflow">return</span> 0;
00163 }
00164 
<a name="l00165"></a><a class="code" href="../../d6/d0/usercli_8h.html#a576">00165</a> LRESULT WINAPI <a class="code" href="../../d6/d0/usercli_8h.html#a576">MenuWndProcA</a>(
00166     HWND hwnd,
00167     UINT message,
00168     WPARAM wParam,
00169     LPARAM lParam)
00170 {
00171     <span class="keywordflow">return</span> <a class="code" href="../../d0/d9/clmsg_8c.html#a13">MenuWndProcWorker</a>(hwnd, message, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00172 }
00173 
<a name="l00174"></a><a class="code" href="../../d6/d0/usercli_8h.html#a577">00174</a> LRESULT WINAPI <a class="code" href="../../d6/d0/usercli_8h.html#a577">MenuWndProcW</a>(
00175     HWND hwnd,
00176     UINT message,
00177     WPARAM wParam,
00178     LPARAM lParam)
00179 {
00180     <span class="keywordflow">return</span> <a class="code" href="../../d0/d9/clmsg_8c.html#a13">MenuWndProcWorker</a>(hwnd, message, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00181 }
00182 
00183 <span class="comment">/***************************************************************************\</span>
00184 <span class="comment">\***************************************************************************/</span>
00185 
00186 
<a name="l00187"></a><a class="code" href="../../d0/d9/clmsg_8c.html#a16">00187</a> LRESULT WINAPI <a class="code" href="../../d0/d9/clmsg_8c.html#a16">ScrollBarWndProcWorker</a>(
00188     HWND hwnd,
00189     UINT message,
00190     WPARAM wParam,
00191     LPARAM lParam,
00192     BOOL fAnsi)
00193 {
00194     <a class="code" href="../../d7/d5/structtagSBWND.html">PSBWND</a> psbwnd;
00195     LPSCROLLINFO lpsi;
00196     <a class="code" href="../../d4/d5/structtagSBDATA.html">PSBDATA</a> pw;
00197 
00198     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a10">FWINDOWMSG</a>(message, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a193">FNID_SCROLLBAR</a>)) {
00199         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a11">CsSendMessage</a>(hwnd, message, wParam, lParam,
00200                 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a193">FNID_SCROLLBAR</a>, fAnsi);
00201     }
00202 
00203     <span class="keywordflow">if</span> ((psbwnd = (<a class="code" href="../../d7/d5/structtagSBWND.html">PSBWND</a>)<a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00204         <span class="keywordflow">return</span> 0;
00205 
00206     <span class="keywordflow">switch</span> (message) {
00207     <span class="keywordflow">case</span> WM_GETDLGCODE:
00208         <span class="keywordflow">return</span> DLGC_WANTARROWS;
00209 
00210     <span class="keywordflow">case</span> SBM_GETPOS:
00211         <span class="keywordflow">return</span> (LONG)psbwnd-&gt;<a class="code" href="../../d7/d5/structtagSBWND.html#o3">SBCalc</a>.pos;
00212 
00213     <span class="keywordflow">case</span> SBM_GETRANGE:
00214         *((LPINT)wParam) = psbwnd-&gt;<a class="code" href="../../d7/d5/structtagSBWND.html#o3">SBCalc</a>.posMin;
00215         *((LPINT)lParam) = psbwnd-&gt;<a class="code" href="../../d7/d5/structtagSBWND.html#o3">SBCalc</a>.posMax;
00216         <span class="keywordflow">return</span> 0;
00217 
00218     <span class="keywordflow">case</span> SBM_GETSCROLLINFO:
00219         lpsi = (LPSCROLLINFO)lParam;
00220         <span class="keywordflow">if</span> ((lpsi-&gt;cbSize != <span class="keyword">sizeof</span>(SCROLLINFO)) &amp;&amp;
00221             (lpsi-&gt;cbSize != <span class="keyword">sizeof</span>(SCROLLINFO) - 4)) {
00222             RIPMSG0(RIP_ERROR, <span class="stringliteral">"SCROLLINFO: invalid cbSize"</span>);
00223             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00224         }
00225 
00226         <span class="keywordflow">if</span> (lpsi-&gt;fMask &amp; ~SIF_MASK)
00227         {
00228             RIPMSG0(RIP_ERROR, <span class="stringliteral">"SCROLLINFO: Invalid fMask"</span>);
00229             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00230         }
00231 
00232         pw = (<a class="code" href="../../d4/d5/structtagSBDATA.html">PSBDATA</a>)&amp;(psbwnd-&gt;<a class="code" href="../../d7/d5/structtagSBWND.html#o3">SBCalc</a>);
00233         <span class="keywordflow">return</span>(<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a329">NtUserSBGetParms</a>(hwnd, SB_CTL, pw, lpsi));
00234 
00235     <span class="keywordflow">default</span>:
00236         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>((<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)psbwnd, message,
00237                 wParam, lParam, fAnsi);
00238     }
00239 }
00240 
00241 
<a name="l00242"></a><a class="code" href="../../d6/d0/usercli_8h.html#a580">00242</a> LRESULT WINAPI <a class="code" href="../../d6/d0/usercli_8h.html#a580">ScrollBarWndProcA</a>(
00243     HWND hwnd,
00244     UINT message,
00245     WPARAM wParam,
00246     LPARAM lParam)
00247 {
00248     <span class="keywordflow">return</span> <a class="code" href="../../d0/d9/clmsg_8c.html#a16">ScrollBarWndProcWorker</a>(hwnd, message, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00249 }
00250 
<a name="l00251"></a><a class="code" href="../../d6/d0/usercli_8h.html#a581">00251</a> LRESULT WINAPI <a class="code" href="../../d6/d0/usercli_8h.html#a581">ScrollBarWndProcW</a>(
00252     HWND hwnd,
00253     UINT message,
00254     WPARAM wParam,
00255     LPARAM lParam)
00256 {
00257     <span class="keywordflow">return</span> <a class="code" href="../../d0/d9/clmsg_8c.html#a16">ScrollBarWndProcWorker</a>(hwnd, message, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00258 }
00259 
00260 
00261 <span class="comment">/***************************************************************************\</span>
00262 <span class="comment">* SendMessage</span>
00263 <span class="comment">*</span>
00264 <span class="comment">* Translates the message, calls SendMessage on server side.</span>
00265 <span class="comment">*</span>
00266 <span class="comment">* 04-11-91 ScottLu  Created.</span>
00267 <span class="comment">* 04-27-92 DarrinM  Added code to support client-to-client SendMessages.</span>
00268 <span class="comment">\***************************************************************************/</span>
00269 
<a name="l00270"></a><a class="code" href="../../d6/d0/usercli_8h.html#a600">00270</a> LRESULT <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(
00271     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00272     UINT message,
00273     WPARAM wParam,
00274     LPARAM lParam,
00275     BOOL fAnsi)
00276 {
00277     HWND hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd);
00278     <a class="code" href="../../d2/d2/struct__CLIENTINFO.html">PCLIENTINFO</a> pci;
00279     <a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a> pcls;
00280     BOOLEAN fAnsiRecv;
00281     BOOLEAN fNeedTranslation = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00282     BOOLEAN bDoDbcsMessaging = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00283     LRESULT lRet;
00284 
00285     UserAssert(pwnd);
00286 
00287     <span class="comment">/*</span>
00288 <span class="comment">     * Pass DDE messages to the server.</span>
00289 <span class="comment">     */</span>
00290     <span class="keywordflow">if</span> (message &gt;= WM_DDE_FIRST &amp;&amp; message &lt;= WM_DDE_LAST)
00291         <span class="keywordflow">goto</span> lbServerSendMessage;
00292 
00293     <span class="comment">/*</span>
00294 <span class="comment">     * Server must handle inter-thread SendMessages and SendMessages</span>
00295 <span class="comment">     * to server-side procs.</span>
00296 <span class="comment">     */</span>
00297     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>() != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)) || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a569">WFSERVERSIDEPROC</a>))
00298         <span class="keywordflow">goto</span> lbServerSendMessage;
00299 
00300     <span class="comment">/*</span>
00301 <span class="comment">     * Server must handle hooks (at least for now).</span>
00302 <span class="comment">     */</span>
00303     pci = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>();
00304     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(pci, (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a516">WHF_CALLWNDPROC</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a517">WHF_CALLWNDPROCRET</a>))) {
00305 lbServerSendMessage:
00306         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a11">CsSendMessage</a>(hwnd, message, wParam, lParam, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00307                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a216">FNID_SENDMESSAGE</a>, fAnsi);
00308     }
00309 
00310     <span class="comment">/*</span>
00311 <span class="comment">     * If the sender and the receiver are both ANSI or both UNICODE</span>
00312 <span class="comment">     * then no message translation is necessary.</span>
00313 <span class="comment">     *</span>
00314 <span class="comment">     * EditWndProc may need to go to the server for translation if we</span>
00315 <span class="comment">     * are calling vanilla EditWndProc from SendMessageA and the edit</span>
00316 <span class="comment">     * control is currently subclassed Ansi but the edit control is</span>
00317 <span class="comment">     * stored Unicode.</span>
00318 <span class="comment">     */</span>
00319     fAnsiRecv = !!(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a570">WFANSIPROC</a>));
00320     <span class="keywordflow">if</span> (!fAnsi != !fAnsiRecv) {
00321 
00322         <span class="comment">/*</span>
00323 <span class="comment">         * Translation might be necessary between sender and receiver,</span>
00324 <span class="comment">         * check to see if this is one of the messages we translate.</span>
00325 <span class="comment">         */</span>
00326         <span class="keywordflow">switch</span> (message) {
00327         <span class="keywordflow">case</span> WM_CHARTOITEM:
00328         <span class="keywordflow">case</span> EM_SETPASSWORDCHAR:
00329         <span class="keywordflow">case</span> WM_CHAR:
00330         <span class="keywordflow">case</span> WM_DEADCHAR:
00331         <span class="keywordflow">case</span> WM_SYSCHAR:
00332         <span class="keywordflow">case</span> WM_SYSDEADCHAR:
00333         <span class="keywordflow">case</span> WM_MENUCHAR:
00334         <span class="keywordflow">case</span> WM_IME_CHAR:
00335         <span class="keywordflow">case</span> WM_IME_COMPOSITION:
00336             <span class="keywordflow">if</span> (fAnsi) {
00337                 <span class="comment">/*</span>
00338 <span class="comment">                 * Setup DBCS Messaging for WM_CHAR...</span>
00339 <span class="comment">                 */</span>
00340                 <a class="code" href="../../d6/d0/usercli_8h.html#a295">BUILD_DBCS_MESSAGE_TO_CLIENTW_FROM_CLIENTA</a>(message,wParam,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00341 
00342                 <span class="comment">/*</span>
00343 <span class="comment">                 * Convert wParam to Unicode...</span>
00344 <span class="comment">                 */</span>
00345                 <a class="code" href="../../d5/d6/chartran_8c.html#a5">RtlMBMessageWParamCharToWCS</a>(message, &amp;wParam);
00346 
00347                 <span class="comment">/*</span>
00348 <span class="comment">                 * The message has been converted to Unicode.</span>
00349 <span class="comment">                 */</span>
00350                 fAnsi = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00351             } <span class="keywordflow">else</span> {
00352                 POINT ptZero = {0,0};
00353                 <span class="comment">/*</span>
00354 <span class="comment">                 * Convert wParam to ANSI...</span>
00355 <span class="comment">                 */</span>
00356                 <a class="code" href="../../d5/d6/chartran_8c.html#a4">RtlWCSMessageWParamCharToMB</a>(message, &amp;wParam);
00357 
00358                 <span class="comment">/*</span>
00359 <span class="comment">                 * Let's DBCS messaging for WM_CHAR....</span>
00360 <span class="comment">                 */</span>
00361                 <a class="code" href="../../d6/d0/usercli_8h.html#a298">BUILD_DBCS_MESSAGE_TO_CLIENTA_FROM_CLIENTW</a>(
00362                     hwnd,message,wParam,lParam,0,ptZero,bDoDbcsMessaging);
00363 
00364                 <span class="comment">/*</span>
00365 <span class="comment">                 * The message has been converted to ANSI.</span>
00366 <span class="comment">                 */</span>
00367                 fAnsi = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00368             }
00369             <span class="keywordflow">break</span>;
00370 
00371         <span class="keywordflow">case</span> EM_SETSEL:
00372         <span class="keywordflow">case</span> EM_GETSEL:
00373         <span class="keywordflow">case</span> CB_GETEDITSEL:
00374             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a125">IS_DBCS_ENABLED</a>()) {
00375                 RIPERR1(ERROR_INVALID_PARAMETER,
00376                         RIP_WARNING,
00377                         <span class="stringliteral">"Invalid DBCS message (%x) to SendMessageWorker"</span>,message);
00378             }
00379             <span class="comment">//</span>
00380             <span class="comment">// Fall down...</span>
00381 
00382         <span class="keywordflow">default</span>:
00383             <span class="keywordflow">if</span> ((message &lt; WM_USER) &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1144">MessageTable</a>[message].<a class="code" href="../../d6/d2/structtagMSG__TABLE__ENTRY.html#o1">bThunkMessage</a>) {
00384                 fNeedTranslation = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00385             }
00386         }
00387     }
00388 
00389 <span class="preprocessor">#ifndef LATER</span>
00390 <span class="preprocessor"></span>    <span class="comment">/*</span>
00391 <span class="comment">     * If the window has a client side worker proc and has</span>
00392 <span class="comment">     * not been subclassed, dispatch the message directly</span>
00393 <span class="comment">     * to the worker proc.  Otherwise, dispatch it normally.</span>
00394 <span class="comment">     */</span>
00395     pcls = <a class="code" href="../../d6/d0/usercli_8h.html#a24">REBASEALWAYS</a>(pwnd, pcls);
00396 
00397     <span class="keywordflow">if</span> ((pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o2">fnid</a> &gt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a199">FNID_CONTROLSTART</a> &amp;&amp; pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o2">fnid</a> &lt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a209">FNID_CONTROLEND</a>) &amp;&amp;
00398         ((KERNEL_ULONG_PTR)pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o8">lpfnWndProc</a> == <a class="code" href="../../d1/d0/inc_2user_8h.html#a239">FNID_TO_CLIENT_PFNW_KERNEL</a>(pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o2">fnid</a>) ||
00399          (KERNEL_ULONG_PTR)pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o8">lpfnWndProc</a> == <a class="code" href="../../d1/d0/inc_2user_8h.html#a238">FNID_TO_CLIENT_PFNA_KERNEL</a>(pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o2">fnid</a>))) {
00400         <a class="code" href="../../d1/d9/struct__WNDMSG.html">PWNDMSG</a> pwm = &amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o5">awmControl</a>[pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o2">fnid</a> - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a191">FNID_START</a>];
00401 
00402         <span class="comment">/*</span>
00403 <span class="comment">         * If this message is not processed by the control, call</span>
00404 <span class="comment">         * xxxDefWindowProc</span>
00405 <span class="comment">         */</span>
00406         <span class="keywordflow">if</span> (pwm-&gt;<a class="code" href="../../d1/d9/struct__WNDMSG.html#o1">abMsgs</a> &amp;&amp; ((message &gt; pwm-&gt;<a class="code" href="../../d1/d9/struct__WNDMSG.html#o0">maxMsgs</a>) ||
00407                 !((pwm-&gt;<a class="code" href="../../d1/d9/struct__WNDMSG.html#o1">abMsgs</a>)[message / 8] &amp; (1 &lt;&lt; (message &amp; 7))))) {
00408 
00409             <span class="comment">/*</span>
00410 <span class="comment">             * Special case dialogs so that we can ignore unimportant</span>
00411 <span class="comment">             * messages during dialog creation.</span>
00412 <span class="comment">             */</span>
00413             <span class="keywordflow">if</span> (pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o2">fnid</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a203">FNID_DIALOG</a> &amp;&amp;
00414                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd) &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;lpfnDlg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00415                 <span class="comment">/*</span>
00416 <span class="comment">                 * If A/W translation are needed for Dialog,</span>
00417 <span class="comment">                 * it should go to kernel side to perform proper message.</span>
00418 <span class="comment">                 * DefDlgProcWorker will call aplication's DlgProc directly</span>
00419 <span class="comment">                 * without A/W conversion.</span>
00420 <span class="comment">                 */</span>
00421                 <span class="keywordflow">if</span> (fNeedTranslation) {
00422                     <span class="keywordflow">goto</span> lbServerSendMessage;
00423                 }
00424                 <span class="comment">/*</span>
00425 <span class="comment">                 * Call woker procudure.</span>
00426 <span class="comment">                 */</span>
00427             SendMessageToWorker1Again:
00428                 lRet = ((PROC)(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a235">FNID_TO_CLIENT_PFNWORKER</a>(pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o2">fnid</a>)))(pwnd, message, wParam, lParam, fAnsi);
00429                 <span class="comment">/*</span>
00430 <span class="comment">                 * if we have DBCS TrailingByte that should be sent, send it here..</span>
00431 <span class="comment">                 */</span>
00432                 <a class="code" href="../../d6/d0/usercli_8h.html#a299">DISPATCH_DBCS_MESSAGE_IF_EXIST</a>(message,wParam,bDoDbcsMessaging,SendMessageToWorker1);
00433 
00434                 <span class="keywordflow">return</span> lRet;
00435             } <span class="keywordflow">else</span> {
00436                 <span class="comment">/*</span>
00437 <span class="comment">                 * Call worker procedure.</span>
00438 <span class="comment">                 */</span>
00439             SendMessageToDefWindowAgain:
00440                 lRet = <a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(pwnd, message, wParam, lParam, fAnsi);
00441                 <span class="comment">/*</span>
00442 <span class="comment">                 * if we have DBCS TrailingByte that should be sent, send it here..</span>
00443 <span class="comment">                 */</span>
00444                  <a class="code" href="../../d6/d0/usercli_8h.html#a299">DISPATCH_DBCS_MESSAGE_IF_EXIST</a>(message,wParam,bDoDbcsMessaging,SendMessageToDefWindow);
00445 
00446                 <span class="keywordflow">return</span> lRet;
00447             }
00448         } <span class="keywordflow">else</span> {
00449             <span class="comment">/*</span>
00450 <span class="comment">             * Call woker procudure.</span>
00451 <span class="comment">             */</span>
00452         SendMessageToWorker2Again:
00453             lRet = ((PROC)(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a235">FNID_TO_CLIENT_PFNWORKER</a>(pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o2">fnid</a>)))(pwnd, message, wParam, lParam, fAnsi);
00454 
00455             <span class="comment">/*</span>
00456 <span class="comment">             * if we have DBCS TrailingByte that should be sent, send it here..</span>
00457 <span class="comment">             */</span>
00458             <a class="code" href="../../d6/d0/usercli_8h.html#a299">DISPATCH_DBCS_MESSAGE_IF_EXIST</a>(message,wParam,bDoDbcsMessaging,SendMessageToWorker2);
00459 
00460             <span class="keywordflow">return</span> lRet;
00461         }
00462     }
00463 <span class="preprocessor">#endif</span>
00464 <span class="preprocessor"></span>
00465     <span class="comment">/*</span>
00466 <span class="comment">     * If this message needs to be translated, go through the kernel.</span>
00467 <span class="comment">     */</span>
00468     <span class="keywordflow">if</span> (fNeedTranslation) {
00469         <span class="keywordflow">goto</span> lbServerSendMessage;
00470     }
00471 
00472     <span class="comment">/*</span>
00473 <span class="comment">     * Call Client Windows procudure.</span>
00474 <span class="comment">     */</span>
00475 SendMessageToWndProcAgain:
00476 
00477     lRet = <a class="code" href="../../d6/d0/usercli_8h.html#a19">CALLPROC_WOWCHECKPWW</a>(<a class="code" href="../../d1/d0/inc_2user_8h.html#a237">MapKernelClientFnToClientFn</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o8">lpfnWndProc</a>), hwnd, message, wParam, lParam, &amp;(pwnd-&gt;state));
00478 
00479     <span class="comment">/*</span>
00480 <span class="comment">     * if we have DBCS TrailingByte that should be sent, send it here..</span>
00481 <span class="comment">     */</span>
00482     <a class="code" href="../../d6/d0/usercli_8h.html#a299">DISPATCH_DBCS_MESSAGE_IF_EXIST</a>(message,wParam,bDoDbcsMessaging,SendMessageToWndProc);
00483 
00484     <span class="keywordflow">return</span> lRet;
00485 }
00486 
00487 <span class="comment">// LATER!!! can this somehow be combined or subroutinized with SendMessageWork</span>
00488 <span class="comment">// so we don't have to copies of 95% identical code.</span>
00489 
00490 <span class="comment">/***************************************************************************\</span>
00491 <span class="comment">* SendMessageTimeoutWorker</span>
00492 <span class="comment">*</span>
00493 <span class="comment">* Translates the message, calls SendMessageTimeout on server side.</span>
00494 <span class="comment">*</span>
00495 <span class="comment">* 07-21-92 ChrisBB  Created/modified SendMessageWorkder</span>
00496 <span class="comment">\***************************************************************************/</span>
00497 
<a name="l00498"></a><a class="code" href="../../d6/d0/usercli_8h.html#a601">00498</a> LRESULT <a class="code" href="../../d6/d0/usercli_8h.html#a601">SendMessageTimeoutWorker</a>(
00499     HWND hwnd,
00500     UINT message,
00501     WPARAM wParam,
00502     LPARAM lParam,
00503     UINT fuFlags,
00504     UINT uTimeout,
00505     PULONG_PTR lpdwResult,
00506     BOOL fAnsi)
00507 {
00508     <a class="code" href="../../d9/d6/structtagSNDMSGTIMEOUT.html">SNDMSGTIMEOUT</a> smto;
00509 
00510     <span class="comment">/*</span>
00511 <span class="comment">     * Prevent apps from setting hi 16 bits so we can use them internally.</span>
00512 <span class="comment">     */</span>
00513     <span class="keywordflow">if</span> (message &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a8">RESERVED_MSG_BITS</a>) {
00514         RIPERR1(ERROR_INVALID_PARAMETER,
00515                 RIP_WARNING,
00516                 <span class="stringliteral">"Invalid parameter \"message\" (%ld) to SendMessageTimeoutWorker"</span>,
00517                 message);
00518 
00519         <span class="keywordflow">return</span>(0);
00520     }
00521 
00522     <span class="keywordflow">if</span> (fuFlags &amp; ~SMTO_VALID) {
00523         RIPERR1(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"invalid dwFlags (%x) for SendMessageTimeout\n"</span>, fuFlags);
00524         <span class="keywordflow">return</span>(0);
00525     }
00526 
00527     <span class="keywordflow">if</span> (lpdwResult != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00528         *lpdwResult = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00529 
00530     <span class="comment">/*</span>
00531 <span class="comment">     * Always send broadcast requests straight to the server.</span>
00532 <span class="comment">     * Note: the xParam is used to id if it's from timeout or</span>
00533 <span class="comment">     * from an normal sendmessage.</span>
00534 <span class="comment">     */</span>
00535     smto.<a class="code" href="../../d9/d6/structtagSNDMSGTIMEOUT.html#o0">fuFlags</a> = fuFlags;
00536     smto.<a class="code" href="../../d9/d6/structtagSNDMSGTIMEOUT.html#o1">uTimeout</a> = uTimeout;
00537     smto.<a class="code" href="../../d9/d6/structtagSNDMSGTIMEOUT.html#o2">lSMTOReturn</a> = 0;
00538     smto.<a class="code" href="../../d9/d6/structtagSNDMSGTIMEOUT.html#o3">lSMTOResult</a> = 0;
00539 
00540     <span class="comment">/*</span>
00541 <span class="comment">     * Thunk through a special sendmessage for -1 hwnd's so that the general</span>
00542 <span class="comment">     * purpose thunks don't allow -1 hwnd's.</span>
00543 <span class="comment">     */</span>
00544     <span class="keywordflow">if</span> (hwnd == (HWND)-1 || hwnd == (HWND)0x0000FFFF) {
00545         <span class="comment">/*</span>
00546 <span class="comment">         * Get a real hwnd so the thunks will validation ok. Note that since</span>
00547 <span class="comment">         * -1 hwnd is really rare, calling GetDesktopWindow() here is not a</span>
00548 <span class="comment">         * big deal.</span>
00549 <span class="comment">         */</span>
00550         hwnd = <a class="code" href="../../d3/d9/client_2wow_8c.html#a4">GetDesktopWindow</a>();
00551 
00552         <a class="code" href="../../d6/d0/usercli_8h.html#a11">CsSendMessage</a>(hwnd, message, wParam, lParam,
00553                 (ULONG_PTR)&amp;smto, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a217">FNID_SENDMESSAGEFF</a>, fAnsi);
00554     } <span class="keywordflow">else</span> {
00555         <a class="code" href="../../d6/d0/usercli_8h.html#a11">CsSendMessage</a>(hwnd, message, wParam, lParam,
00556                 (ULONG_PTR)&amp;smto, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a218">FNID_SENDMESSAGEEX</a>, fAnsi);
00557     }
00558 
00559     <span class="keywordflow">if</span> (lpdwResult != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00560          *lpdwResult = smto.<a class="code" href="../../d9/d6/structtagSNDMSGTIMEOUT.html#o3">lSMTOResult</a>;
00561 
00562     <span class="keywordflow">return</span> smto.<a class="code" href="../../d9/d6/structtagSNDMSGTIMEOUT.html#o2">lSMTOReturn</a>;
00563 }
00564 
00565 <span class="comment">/***************************************************************************\</span>
00566 <span class="comment">* DefWindowProcWorker</span>
00567 <span class="comment">*</span>
00568 <span class="comment">* Handles any messages that can be dealt with wholly on the client and</span>
00569 <span class="comment">* passes the rest to the server.</span>
00570 <span class="comment">*</span>
00571 <span class="comment">* 03-31-92 DarrinM      Created.</span>
00572 <span class="comment">\***************************************************************************/</span>
00573 
<a name="l00574"></a><a class="code" href="../../d6/d0/usercli_8h.html#a610">00574</a> LRESULT <a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(
00575     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00576     UINT message,
00577     WPARAM wParam,
00578     LPARAM lParam,
00579     DWORD fAnsi)
00580 {
00581     HWND hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd);
00582     <span class="keywordtype">int</span> icolBack;
00583     <span class="keywordtype">int</span> icolFore;
00584     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndParent;
00585     HWND hwndDefIme;
00586     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndDefIme;
00587     <a class="code" href="../../d4/d8/structtagIMEUI.html">PIMEUI</a> pimeui;
00588 
00589 <span class="preprocessor">#if DBG</span>
00590 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!gfTurboDWP) {
00591         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a11">CsSendMessage</a>(hwnd, message, wParam, lParam, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00592                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a197">FNID_DEFWINDOWPROC</a>, fAnsi);
00593     } <span class="keywordflow">else</span> {
00594 <span class="preprocessor">#endif</span>
00595 <span class="preprocessor"></span>
00596 
00597     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a9">FDEFWINDOWMSG</a>(message, DefWindowMsgs)) {
00598         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a11">CsSendMessage</a>(hwnd, message, wParam, lParam, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00599                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a197">FNID_DEFWINDOWPROC</a>, fAnsi);
00600     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a9">FDEFWINDOWMSG</a>(message, DefWindowSpecMsgs)) {
00601         <span class="keywordflow">return</span> 0;
00602     }
00603 
00604     <span class="comment">/*</span>
00605 <span class="comment">     * Important:  If you add cases to the switch statement below,</span>
00606 <span class="comment">     *             add the messages to server.c's gawDefWindowSpecMsgs.</span>
00607 <span class="comment">     *             Similarly if you add cases to dwp.c's DefWindowProc</span>
00608 <span class="comment">     *             which can come from the client, add the messages</span>
00609 <span class="comment">     *             to gawDefWindowMsgs.</span>
00610 <span class="comment">     */</span>
00611 
00612     <span class="keywordflow">switch</span> (message) {
00613 
00614     <span class="keywordflow">case</span> WM_HELP:
00615         {
00616         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwndDest;
00617 
00618         <span class="comment">/*</span>
00619 <span class="comment">         * If this window is a child window, Help message must be passed on</span>
00620 <span class="comment">         * to it's parent; Else, this must be passed on to the owner window.</span>
00621 <span class="comment">         */</span>
00622         pwndDest = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwnd) ? pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> : pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>);
00623         <span class="keywordflow">if</span> (pwndDest) {
00624             pwndDest = <a class="code" href="../../d6/d0/usercli_8h.html#a25">REBASEPTR</a>(pwnd, pwndDest);
00625             <span class="keywordflow">if</span> (pwndDest != <a class="code" href="../../d3/d9/client_2wow_8c.html#a3">_GetDesktopWindow</a>())
00626                 <span class="keywordflow">return</span> SendMessageW(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwndDest), WM_HELP, wParam, lParam);;
00627         }
00628         <span class="keywordflow">return</span>(0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00629         }
00630 
00631     <span class="keywordflow">case</span> WM_MOUSEWHEEL:
00632         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwnd)) {
00633             pwndParent = <a class="code" href="../../d6/d0/usercli_8h.html#a27">REBASEPWND</a>(pwnd, spwndParent);
00634             SendMessageW(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndParent), WM_MOUSEWHEEL, wParam, lParam);
00635         }
00636         <span class="keywordflow">break</span>;
00637 
00638     <span class="keywordflow">case</span> WM_CONTEXTMENU:
00639         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwnd)) {
00640             pwndParent = <a class="code" href="../../d6/d0/usercli_8h.html#a27">REBASEPWND</a>(pwnd, spwndParent);
00641             SendMessageW(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndParent), WM_CONTEXTMENU,
00642                     (WPARAM)hwnd, lParam);
00643         }
00644         <span class="keywordflow">break</span>;
00645 
00646     <span class="comment">/*</span>
00647 <span class="comment">     * Default handling for WM_CONTEXTMENU support</span>
00648 <span class="comment">     */</span>
00649     <span class="keywordflow">case</span> WM_RBUTTONUP:
00650 <span class="preprocessor">#ifdef USE_MIRRORING</span>
00651 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WEFLAYOUTRTL)) {
00652             lParam = MAKELONG(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.right - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a7">GET_X_LPARAM</a>(lParam), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a8">GET_Y_LPARAM</a>(lParam) + pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top);
00653         } <span class="keywordflow">else</span>
00654 <span class="preprocessor">#endif</span>
00655 <span class="preprocessor"></span>        {
00656             lParam = MAKELONG(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a7">GET_X_LPARAM</a>(lParam) + pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a8">GET_Y_LPARAM</a>(lParam) + pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top);
00657         }
00658         <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pwnd, WM_CONTEXTMENU, (WPARAM)hwnd, lParam, fAnsi);
00659         <span class="keywordflow">break</span>;
00660 
00661     <span class="keywordflow">case</span> WM_APPCOMMAND:
00662         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwnd)) {
00663             <span class="comment">/*</span>
00664 <span class="comment">             * Bubble the message to the parent</span>
00665 <span class="comment">             */</span>
00666             pwndParent = <a class="code" href="../../d6/d0/usercli_8h.html#a27">REBASEPWND</a>(pwnd, spwndParent);
00667             <span class="keywordflow">return</span> SendMessageW(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndParent), WM_APPCOMMAND, wParam, lParam);
00668         } <span class="keywordflow">else</span> {
00669             <span class="comment">/*</span>
00670 <span class="comment">             * Call the server side to send the shell hook HSHELL_APPCOMMAND</span>
00671 <span class="comment">             */</span>
00672             <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a11">CsSendMessage</a>(hwnd, WM_APPCOMMAND, wParam, lParam, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a197">FNID_DEFWINDOWPROC</a>, fAnsi);
00673         }
00674         <span class="keywordflow">break</span>;
00675 
00676     <span class="comment">/*</span>
00677 <span class="comment">     * Default handling for WM_APPCOMMAND support</span>
00678 <span class="comment">     */</span>
00679     <span class="keywordflow">case</span> WM_NCXBUTTONUP:
00680     <span class="keywordflow">case</span> WM_XBUTTONUP:
00681         {
00682             WORD cmd;
00683             WORD keystate;
00684             LPARAM lParamAppCommand;
00685 
00686             <span class="keywordflow">switch</span> (GET_XBUTTON_WPARAM(wParam)) {
00687             <span class="keywordflow">case</span> XBUTTON1:
00688                 cmd = APPCOMMAND_BROWSER_BACKWARD;
00689                 <span class="keywordflow">break</span>;
00690 
00691             <span class="keywordflow">case</span> XBUTTON2:
00692                 cmd = APPCOMMAND_BROWSER_FORWARD;
00693                 <span class="keywordflow">break</span>;
00694 
00695             <span class="keywordflow">default</span>:
00696                 cmd = 0;
00697                 <span class="keywordflow">break</span>;
00698             }
00699 
00700             <span class="keywordflow">if</span> (cmd == 0) {
00701                 <span class="keywordflow">break</span>;
00702             }
00703 
00704             cmd |= FAPPCOMMAND_MOUSE;
00705             <span class="keywordflow">if</span> (message == WM_XBUTTONUP) {
00706                 keystate = GET_KEYSTATE_WPARAM(wParam);
00707             } <span class="keywordflow">else</span> {
00708                 keystate = <a class="code" href="../../d0/d9/clmsg_8c.html#a9">GetMouseKeyState</a>();
00709             }
00710 
00711             lParamAppCommand = MAKELPARAM(keystate, cmd);
00712             <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pwnd, WM_APPCOMMAND, (WPARAM)hwnd, lParamAppCommand, fAnsi);
00713             <span class="keywordflow">break</span>;
00714         }
00715 
00716     <span class="keywordflow">case</span> WM_WINDOWPOSCHANGED: {
00717         PWINDOWPOS <a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a> = (PWINDOWPOS)lParam;
00718 
00719         <span class="keywordflow">if</span> (!(<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;flags &amp; SWP_NOCLIENTMOVE)) {
00720             POINT pt = {pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left, pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top};
00721             pwndParent = <a class="code" href="../../d6/d0/usercli_8h.html#a27">REBASEPWND</a>(pwnd, spwndParent);
00722 
00723             <span class="keywordflow">if</span> (pwndParent != <a class="code" href="../../d3/d9/client_2wow_8c.html#a3">_GetDesktopWindow</a>()) {
00724                 pt.x -= pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left;
00725                 pt.y -= pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top;
00726             }
00727 
00728             <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pwnd, WM_MOVE, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, MAKELPARAM(pt.x, pt.y), fAnsi);
00729         }
00730 
00731         <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;flags &amp; SWP_STATECHANGE) || !(<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;flags &amp; SWP_NOCLIENTSIZE)) {
00732             <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> cmd;
00733             RECT rc;
00734 
00735             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>))
00736                 cmd = SIZEICONIC;
00737             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a648">WFMAXIMIZED</a>))
00738                 cmd = SIZEFULLSCREEN;
00739             <span class="keywordflow">else</span>
00740                 cmd = SIZENORMAL;
00741 
00742         <span class="comment">/*</span>
00743 <span class="comment">         *  HACK ALERT:</span>
00744 <span class="comment">         *  If the window is minimized then the real client width and height are</span>
00745 <span class="comment">         *  zero. But, in win3.1 they were non-zero. Under Chicago, PrintShop</span>
00746 <span class="comment">         *  Deluxe ver 1.2 hits a divide by zero. To fix this we fake the width</span>
00747 <span class="comment">         *  and height for old apps to be non-zero values.</span>
00748 <span class="comment">         *  GetClientRect does that job for us.</span>
00749 <span class="comment">         */</span>
00750             <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a19">_GetClientRect</a>(pwnd, &amp;rc);
00751             <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pwnd, WM_SIZE, cmd,
00752                     MAKELONG(rc.right - rc.left,
00753                     rc.bottom - rc.top), fAnsi);
00754         }
00755         <span class="keywordflow">return</span> 0;
00756         }
00757 
00758     <span class="keywordflow">case</span> WM_MOUSEACTIVATE: {
00759         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT;
00760         LRESULT lt;
00761 
00762         <span class="comment">/*</span>
00763 <span class="comment">         * GetChildParent returns either a kernel pointer or NULL.</span>
00764 <span class="comment">         */</span>
00765         pwndT = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a741">GetChildParent</a>(pwnd);
00766         <span class="keywordflow">if</span> (pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00767             pwndT = <a class="code" href="../../d6/d0/usercli_8h.html#a25">REBASEPTR</a>(pwnd, pwndT);
00768             lt = <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pwndT, WM_MOUSEACTIVATE, wParam, lParam, fAnsi);
00769             <span class="keywordflow">if</span> (lt != 0)
00770                 <span class="keywordflow">return</span> lt;
00771         }
00772 
00773         <span class="comment">/*</span>
00774 <span class="comment">         * Moving, sizing or minimizing? Activate AFTER we take action.</span>
00775 <span class="comment">         */</span>
00776         <span class="keywordflow">return</span> ((LOWORD(lParam) == HTCAPTION) &amp;&amp; (HIWORD(lParam) == WM_LBUTTONDOWN )) ?
00777                 (LONG)MA_NOACTIVATE : (LONG)MA_ACTIVATE;
00778         }
00779 
00780     <span class="keywordflow">case</span> WM_CTLCOLORSCROLLBAR:
00781         <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;BitCount &lt; 8) ||
00782             (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(3DHILIGHT) != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(SCROLLBAR)) ||
00783             (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(3DHILIGHT) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(<a class="code" href="../../d6/d0/usercli_8h.html#a273">WINDOW</a>)))
00784         {
00785             <span class="comment">/*</span>
00786 <span class="comment">             * Remove call to UnrealizeObject().  GDI Handles this for</span>
00787 <span class="comment">             * brushes on NT.</span>
00788 <span class="comment">             *</span>
00789 <span class="comment">             * UnrealizeObject(ghbrGray);</span>
00790 <span class="comment">             */</span>
00791 
00792             SetBkColor((HDC)wParam, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(3DHILIGHT));
00793             SetTextColor((HDC)wParam, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(3DFACE));
00794             <span class="keywordflow">return</span>((LRESULT)<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;hbrGray);
00795         }
00796 
00797         icolBack = COLOR_3DHILIGHT;
00798         icolFore = COLOR_BTNTEXT;
00799         <span class="keywordflow">goto</span> SetColor;
00800 
00801     <span class="keywordflow">case</span> WM_CTLCOLORBTN:
00802         <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00803             <span class="keywordflow">goto</span> ColorDefault;
00804 
00805         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>)) {
00806             icolBack = COLOR_3DFACE;
00807             icolFore = COLOR_BTNTEXT;
00808         } <span class="keywordflow">else</span> {
00809             <span class="keywordflow">goto</span> ColorDefault;
00810         }
00811         <span class="keywordflow">goto</span> SetColor;
00812 
00813     <span class="keywordflow">case</span> WM_CTLCOLORSTATIC:
00814     <span class="keywordflow">case</span> WM_CTLCOLORDLG:
00815     <span class="keywordflow">case</span> WM_CTLCOLORMSGBOX:
00816         <span class="comment">// We want static controls in dialogs to have the 3D</span>
00817         <span class="comment">// background color, but statics in windows to inherit</span>
00818         <span class="comment">// their parents' background.</span>
00819 
00820         <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00821             <span class="keywordflow">goto</span> ColorDefault;
00822 
00823         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>)) {
00824             icolBack = COLOR_3DFACE;
00825             icolFore = COLOR_WINDOWTEXT;
00826             <span class="keywordflow">goto</span> SetColor;
00827         }
00828         <span class="comment">// ELSE FALL THRU...</span>
00829 
00830     <span class="keywordflow">case</span> WM_CTLCOLOR:              <span class="comment">// here for WOW only</span>
00831     <span class="keywordflow">case</span> WM_CTLCOLORLISTBOX:
00832     <span class="keywordflow">case</span> WM_CTLCOLOREDIT:
00833       ColorDefault:
00834         icolBack = COLOR_WINDOW;
00835         icolFore = COLOR_WINDOWTEXT;
00836 
00837       SetColor:
00838       {
00839         SetBkColor((HDC)wParam, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;argbSystem[icolBack]);
00840         SetTextColor((HDC)wParam, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;argbSystem[icolFore]);
00841         <span class="keywordflow">return</span> (LRESULT)(<a class="code" href="../../d1/d0/inc_2user_8h.html#a15">SYSHBRUSH</a>(icolBack));
00842       }
00843 
00844     <span class="keywordflow">case</span> WM_NCHITTEST:
00845         <span class="keywordflow">return</span> <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a0">FindNCHit</a>(pwnd, (LONG)lParam);
00846 
00847     <span class="keywordflow">case</span> WM_GETTEXT:
00848         <span class="keywordflow">if</span> (wParam != 0) {
00849 
00850             LPWSTR lpszText;
00851             <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>   cchSrc;
00852 
00853             <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o17">strName</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o0">Length</a>) {
00854 
00855                 lpszText = <a class="code" href="../../d6/d0/usercli_8h.html#a26">REBASE</a>(pwnd, strName.Buffer);
00856                 cchSrc = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o17">strName</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o0">Length</a> / <span class="keyword">sizeof</span>(WCHAR);
00857 
00858                 <span class="keywordflow">if</span> (fAnsi) {
00859 
00860                     LPSTR lpName = (LPSTR)lParam;
00861 
00862                     <span class="comment">/*</span>
00863 <span class="comment">                     * Non-zero retval means some text to copy out.  Do not</span>
00864 <span class="comment">                     * copy out more than the requested byte count</span>
00865 <span class="comment">                     * 'chMaxCount'.</span>
00866 <span class="comment">                     */</span>
00867                     cchSrc = WCSToMB(lpszText,
00868                                      cchSrc,
00869                                      (LPSTR *)&amp;lpName,
00870                                      (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(wParam - 1),
00871                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00872 
00873                     lpName[cchSrc] = <span class="charliteral">'\0'</span>;
00874 
00875                 } <span class="keywordflow">else</span> {
00876 
00877                     LPWSTR lpwName = (LPWSTR)lParam;
00878 
00879                     cchSrc = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(cchSrc, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(wParam - 1));
00880                     RtlCopyMemory(lpwName, lpszText, cchSrc * <span class="keyword">sizeof</span>(WCHAR));
00881                     lpwName[cchSrc] = 0;
00882                 }
00883 
00884                 <span class="keywordflow">return</span> cchSrc;
00885             }
00886 
00887             <span class="comment">/*</span>
00888 <span class="comment">             * else Null terminate the text buffer since there is no text.</span>
00889 <span class="comment">             */</span>
00890             <span class="keywordflow">if</span> (fAnsi) {
00891                 ((LPSTR)lParam)[0] = 0;
00892             } <span class="keywordflow">else</span> {
00893                 ((LPWSTR)lParam)[0] = 0;
00894             }
00895         }
00896 
00897         <span class="keywordflow">return</span> 0;
00898 
00899     <span class="keywordflow">case</span> WM_GETTEXTLENGTH:
00900         <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o17">strName</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o0">Length</a>) {
00901             <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> cch;
00902             <span class="keywordflow">if</span> (fAnsi) {
00903                 <a class="code" href="../../d9/d6/nlsxlat_8c.html#a36">RtlUnicodeToMultiByteSize</a>(&amp;cch,
00904                                           <a class="code" href="../../d6/d0/usercli_8h.html#a26">REBASE</a>(pwnd, strName.Buffer),
00905                                           pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o17">strName</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o0">Length</a>);
00906             } <span class="keywordflow">else</span> {
00907                 cch = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o17">strName</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o0">Length</a> / <span class="keyword">sizeof</span>(WCHAR);
00908             }
00909             <span class="keywordflow">return</span> cch;
00910         }
00911         <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00912 
00913     <span class="keywordflow">case</span> WM_QUERYDRAGICON:
00914         <span class="comment">/*</span>
00915 <span class="comment">         * If the window is WIN40COMPAT or has a kernel side procedure</span>
00916 <span class="comment">         * do not attempt to look into the instance module</span>
00917 <span class="comment">         */</span>
00918         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>) || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a569">WFSERVERSIDEPROC</a>)) {
00919             <span class="keywordflow">return</span> 0;
00920         }
00921         <span class="comment">/*</span>
00922 <span class="comment">         * For old apps, like the VB3 ones, try to load the icon from resources</span>
00923 <span class="comment">         * This is how Win95 does.</span>
00924 <span class="comment">         */</span>
00925         <span class="keywordflow">return</span> (LRESULT)<a class="code" href="../../d4/d9/clres_8c.html#a79">LoadIconW</a>(pwnd-&gt;hModule, MAKEINTRESOURCE(1));
00926 
00927     <span class="keywordflow">case</span> WM_QUERYOPEN:
00928     <span class="keywordflow">case</span> WM_QUERYENDSESSION:
00929     <span class="keywordflow">case</span> WM_DEVICECHANGE:
00930     <span class="keywordflow">case</span> WM_POWERBROADCAST:
00931         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00932 
00933     <span class="keywordflow">case</span> WM_KEYDOWN:
00934         <span class="keywordflow">if</span> (wParam == VK_F10) {
00935             <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a11">CsSendMessage</a>(hwnd, message, wParam, lParam, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00936                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a197">FNID_DEFWINDOWPROC</a>, fAnsi);
00937         }
00938         <span class="keywordflow">break</span>;
00939 
00940     <span class="keywordflow">case</span> WM_SYSKEYDOWN:
00941         <span class="keywordflow">if</span> ((HIWORD(lParam) &amp; <a class="code" href="../../d3/d5/editsl_8c.html#a0">SYS_ALTERNATE</a>) || (wParam == VK_F10) ||
00942                 (wParam == VK_ESCAPE))
00943             <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a11">CsSendMessage</a>(hwnd, message, wParam, lParam, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00944                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a197">FNID_DEFWINDOWPROC</a>, fAnsi);
00945         <span class="keywordflow">break</span>;
00946 
00947     <span class="keywordflow">case</span> WM_CHARTOITEM:
00948     <span class="keywordflow">case</span> WM_VKEYTOITEM:
00949         <span class="comment">/*</span>
00950 <span class="comment">         * Do default processing for keystrokes into owner draw listboxes.</span>
00951 <span class="comment">         */</span>
00952         <span class="keywordflow">return</span> -1;
00953 
00954     <span class="keywordflow">case</span> WM_ACTIVATE:
00955         <span class="keywordflow">if</span> (LOWORD(wParam))
00956             <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a11">CsSendMessage</a>(hwnd, message, wParam, lParam, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00957                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a197">FNID_DEFWINDOWPROC</a>, fAnsi);
00958         <span class="keywordflow">break</span>;
00959 
00960     <span class="keywordflow">case</span> WM_SHOWWINDOW:
00961         <span class="keywordflow">if</span> (lParam != 0)
00962             <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a11">CsSendMessage</a>(hwnd, message, wParam, lParam, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00963                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a197">FNID_DEFWINDOWPROC</a>, fAnsi);
00964         <span class="keywordflow">break</span>;
00965 
00966     <span class="keywordflow">case</span> WM_DROPOBJECT:
00967        <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a910">DO_DROPFILE</a>;
00968 
00969     <span class="keywordflow">case</span> WM_WINDOWPOSCHANGING:
00970         <span class="comment">/*</span>
00971 <span class="comment">         * If the window's size is changing, adjust the passed-in size</span>
00972 <span class="comment">         */</span>
00973 <span class="preprocessor">        #define ppos ((WINDOWPOS *)lParam)</span>
00974 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!(<a class="code" href="../../d0/d9/clmsg_8c.html#a8">ppos</a>-&gt;flags &amp; SWP_NOSIZE))
00975             <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a11">CsSendMessage</a>(hwnd, message, wParam, lParam, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00976                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a197">FNID_DEFWINDOWPROC</a>, fAnsi);
00977 <span class="preprocessor">        #undef ppos</span>
00978 <span class="preprocessor"></span>        <span class="keywordflow">break</span>;
00979 
00980     <span class="keywordflow">case</span> WM_KLUDGEMINRECT:
00981         {
00982         SHELLHOOKINFO shi;
00983         LPRECT lprc = (LPRECT)lParam;
00984 
00985         shi.hwnd = (HWND)wParam;
00986         shi.rc.left = MAKELONG(lprc-&gt;left, lprc-&gt;top);
00987         shi.rc.top = MAKELONG(lprc-&gt;right, lprc-&gt;bottom);
00988 
00989         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o15">uiShellMsg</a> == 0)
00990             <a class="code" href="../../d3/d8/client_8c.html#a117">SetTaskmanWindow</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00991         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pwnd, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o15">uiShellMsg</a>, HSHELL_GETMINRECT,
00992                 (LPARAM)&amp;shi, fAnsi)) {
00993             <span class="comment">//</span>
00994             <span class="comment">// Now convert the RECT back from two POINTS structures into two POINT</span>
00995             <span class="comment">// structures.</span>
00996             <span class="comment">//</span>
00997             lprc-&gt;left   = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)LOWORD(shi.rc.left);  <span class="comment">// Sign extend</span>
00998             lprc-&gt;top    = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)HIWORD(shi.rc.left);  <span class="comment">// Sign extend</span>
00999             lprc-&gt;right  = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)LOWORD(shi.rc.top);   <span class="comment">// Sign extend</span>
01000             lprc-&gt;bottom = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)HIWORD(shi.rc.top);   <span class="comment">// Sign extend</span>
01001         }
01002         <span class="keywordflow">break</span>;
01003         }
01004 
01005     <span class="keywordflow">case</span> WM_NOTIFYFORMAT:
01006         <span class="keywordflow">if</span> (lParam == NF_QUERY)
01007             <span class="keywordflow">return</span>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a581">WFANSICREATOR</a>) ? NFR_ANSI : NFR_UNICODE);
01008         <span class="keywordflow">break</span>;
01009 
01010     <span class="keywordflow">case</span> WM_IME_KEYDOWN:
01011         <span class="keywordflow">if</span> (fAnsi)
01012             PostMessageA(hwnd, WM_KEYDOWN, wParam, lParam);
01013         <span class="keywordflow">else</span>
01014             PostMessageW(hwnd, WM_KEYDOWN, wParam, lParam);
01015         <span class="keywordflow">break</span>;
01016 
01017     <span class="keywordflow">case</span> WM_IME_KEYUP:
01018         <span class="keywordflow">if</span> (fAnsi)
01019             PostMessageA(hwnd, WM_KEYUP, wParam, lParam);
01020         <span class="keywordflow">else</span>
01021             PostMessageW(hwnd, WM_KEYUP, wParam, lParam);
01022         <span class="keywordflow">break</span>;
01023 
01024     <span class="keywordflow">case</span> WM_IME_CHAR:
01025         <span class="comment">//if (TestCF(pwnd, CFIME))</span>
01026         <span class="comment">//    break;</span>
01027 
01028         <span class="keywordflow">if</span> ( fAnsi ) {
01029             <span class="keywordflow">if</span>( IsDBCSLeadByteEx(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a118">THREAD_CODEPAGE</a>(),(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)(wParam &gt;&gt; 8)) ) {
01030                 PostMessageA(hwnd,
01031                              WM_CHAR,
01032                              (WPARAM)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)(wParam &gt;&gt; 8)),   <span class="comment">// leading byte</span>
01033                              1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01034                 PostMessageA(hwnd,
01035                              WM_CHAR,
01036                              (WPARAM)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)wParam),         <span class="comment">// trailing byte</span>
01037                              1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01038             }
01039             <span class="keywordflow">else</span>
01040                 PostMessageA(hwnd,
01041                              WM_CHAR,
01042                              (WPARAM)(wParam),
01043                              1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01044         } <span class="keywordflow">else</span> {
01045             PostMessageW(hwnd, WM_CHAR, wParam, 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01046         }
01047         <span class="keywordflow">break</span>;
01048 
01049     <span class="keywordflow">case</span> WM_IME_COMPOSITION:
01050         <span class="comment">//if (TestCF(pwnd, CFIME))</span>
01051         <span class="comment">//    break;</span>
01052 
01053         <span class="keywordflow">if</span> (lParam &amp; GCS_RESULTSTR) {
01054             HIMC  hImc;
01055             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbLen;
01056 
01057             <span class="keywordflow">if</span> ((hImc = <a class="code" href="../../d6/d0/usercli_8h.html#a307">fpImmGetContext</a>(hwnd)) == <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>)
01058                 <span class="keywordflow">goto</span> dwpime_ToIMEWnd_withchk;
01059 
01060             <span class="keywordflow">if</span> (fAnsi) {
01061                 LPSTR pszBuffer, psz;
01062 
01063                 <span class="comment">/*</span>
01064 <span class="comment">                 * ImmGetComposition returns the size of buffer needed in byte.</span>
01065 <span class="comment">                 */</span>
01066                 <span class="keywordflow">if</span> (!(cbLen = <a class="code" href="../../d6/d0/usercli_8h.html#a308">fpImmGetCompositionStringA</a>(hImc, GCS_RESULTSTR, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0))) {
01067                     <a class="code" href="../../d6/d0/usercli_8h.html#a314">fpImmReleaseContext</a>(hwnd, hImc);
01068                     <span class="keywordflow">goto</span> dwpime_ToIMEWnd_withchk;
01069                 }
01070 
01071                 pszBuffer = psz = (LPSTR)<a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(HEAP_ZERO_MEMORY,
01072                                                         cbLen + <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
01073 
01074                 <span class="keywordflow">if</span> (pszBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01075                     <a class="code" href="../../d6/d0/usercli_8h.html#a314">fpImmReleaseContext</a>(hwnd, hImc);
01076                     <span class="keywordflow">goto</span> dwpime_ToIMEWnd_withchk;
01077                 }
01078 
01079                 <a class="code" href="../../d6/d0/usercli_8h.html#a308">fpImmGetCompositionStringA</a>(hImc, GCS_RESULTSTR, psz, cbLen);
01080 
01081                 <span class="keywordflow">while</span> (*psz) {
01082                     <span class="keywordflow">if</span> (IsDBCSLeadByteEx(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a118">THREAD_CODEPAGE</a>(),*psz)) {
01083                         <span class="keywordflow">if</span> (*(psz+1)) {
01084                             SendMessageA( hwnd,
01085                                           WM_IME_CHAR,
01086                                           MAKEWPARAM(MAKEWORD(*(psz+1), *psz), 0),
01087                                           1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a> );
01088                             psz++;
01089                         }
01090                         psz++;
01091                     }
01092                     <span class="keywordflow">else</span>
01093                         SendMessageA( hwnd,
01094                                       WM_IME_CHAR,
01095                                       MAKEWPARAM(MAKEWORD(*(psz++), 0), 0),
01096                                       1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a> );
01097                 }
01098 
01099                 <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(pszBuffer);
01100 
01101                 <a class="code" href="../../d6/d0/usercli_8h.html#a314">fpImmReleaseContext</a>(hwnd, hImc);
01102             }
01103             <span class="keywordflow">else</span> {
01104                 LPWSTR pwszBuffer, pwsz;
01105 
01106                 <span class="comment">/*</span>
01107 <span class="comment">                 * ImmGetComposition returns the size of buffer needed in byte</span>
01108 <span class="comment">                 */</span>
01109                 <span class="keywordflow">if</span> (!(cbLen = <a class="code" href="../../d6/d0/usercli_8h.html#a309">fpImmGetCompositionStringW</a>(hImc, GCS_RESULTSTR, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0))) {
01110                     <a class="code" href="../../d6/d0/usercli_8h.html#a314">fpImmReleaseContext</a>(hwnd, hImc);
01111                     <span class="keywordflow">goto</span> dwpime_ToIMEWnd_withchk;
01112                 }
01113 
01114                 pwszBuffer = pwsz = (LPWSTR)<a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(HEAP_ZERO_MEMORY,
01115                                                            cbLen + <span class="keyword">sizeof</span>(WCHAR));
01116 
01117                 <span class="keywordflow">if</span> (pwszBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01118                     <a class="code" href="../../d6/d0/usercli_8h.html#a314">fpImmReleaseContext</a>(hwnd, hImc);
01119                     <span class="keywordflow">goto</span> dwpime_ToIMEWnd_withchk;
01120                 }
01121 
01122                 <a class="code" href="../../d6/d0/usercli_8h.html#a309">fpImmGetCompositionStringW</a>(hImc, GCS_RESULTSTR, pwsz, cbLen);
01123 
01124                 <span class="keywordflow">while</span> (*pwsz)
01125                     SendMessageW(hwnd, WM_IME_CHAR, MAKEWPARAM(*pwsz++, 0), 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01126 
01127                 <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(pwszBuffer);
01128 
01129                 <a class="code" href="../../d6/d0/usercli_8h.html#a314">fpImmReleaseContext</a>(hwnd, hImc);
01130             }
01131         }
01132 
01133         <span class="comment">/*</span>
01134 <span class="comment">         * Fall through to send to Default IME Window with checking</span>
01135 <span class="comment">         * activated hIMC.</span>
01136 <span class="comment">         */</span>
01137 
01138     <span class="keywordflow">case</span> WM_IME_STARTCOMPOSITION:
01139     <span class="keywordflow">case</span> WM_IME_ENDCOMPOSITION:
01140 dwpime_ToIMEWnd_withchk:
01141         <span class="comment">//if (TestCF(pwnd, CFIME))</span>
01142         <span class="comment">//    break;</span>
01143 
01144         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>()-&gt;dwTIFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a817">TIF_DISABLEIME</a>) {
01145             <span class="keywordflow">break</span>;
01146         }
01147         <span class="comment">/*</span>
01148 <span class="comment">         * We assume this Wnd uses DefaultIMEWindow.</span>
01149 <span class="comment">         * If this window has its own IME window, it have to call</span>
01150 <span class="comment">         * ImmIsUIMessage()....</span>
01151 <span class="comment">         */</span>
01152         hwndDefIme = <a class="code" href="../../d6/d0/usercli_8h.html#a311">fpImmGetDefaultIMEWnd</a>(hwnd);
01153 
01154         <span class="keywordflow">if</span> (hwndDefIme == hwnd) {
01155             <span class="comment">/*</span>
01156 <span class="comment">             * VC++ 1.51 TLW0NCL.DLL subclass IME class window</span>
01157 <span class="comment">             * and pass IME messages to DefWindowProc().</span>
01158 <span class="comment">             */</span>
01159             RIPMSG1(RIP_WARNING,
01160                 <span class="stringliteral">"IME Class window is hooked and IME message [%X] are sent to DefWindowProc"</span>,
01161                 message);
01162             <a class="code" href="../../d6/d0/usercli_8h.html#a619">ImeWndProcWorker</a>(pwnd, message, wParam, lParam, fAnsi);
01163             <span class="keywordflow">break</span>;
01164         }
01165 
01166         <span class="keywordflow">if</span> ((pwndDefIme = <a class="code" href="../../d3/d9/client_2wow_8c.html#a1">ValidateHwndNoRip</a>(hwndDefIme)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01167             <span class="comment">/*</span>
01168 <span class="comment">             * If hImc of this window is not activated for IME window,</span>
01169 <span class="comment">             * we don't send WM_IME_NOTIFY.</span>
01170 <span class="comment">             */</span>
01171             pimeui = ((<a class="code" href="../../d5/d8/structtagIMEWND.html">PIMEWND</a>)pwndDefIme)-&gt;pimeui;
01172             <span class="keywordflow">if</span> (pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o1">hIMC</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a307">fpImmGetContext</a>(hwnd))
01173                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pwndDefIme, message, wParam, lParam, fAnsi);
01174             <span class="keywordflow">else</span>
01175                 RIPMSG1(RIP_WARNING,
01176                     <span class="stringliteral">"DefWindowProc can not send WM_IME_message [%X] now"</span>,
01177                     message);
01178         }
01179         <span class="keywordflow">break</span>;
01180 
01181 dwpime_ToTopLevel_withchk:
01182         <span class="comment">//if (TestCF(pwnd, CFIME))</span>
01183         <span class="comment">//    break;</span>
01184 
01185         <span class="comment">/*</span>
01186 <span class="comment">         * We assume this Wnd uses DefaultIMEWindow.</span>
01187 <span class="comment">         * If this window has its own IME window, it have to call</span>
01188 <span class="comment">         * ImmIsUIMessage()....</span>
01189 <span class="comment">         */</span>
01190         hwndDefIme = <a class="code" href="../../d6/d0/usercli_8h.html#a311">fpImmGetDefaultIMEWnd</a>(hwnd);
01191 
01192         <span class="keywordflow">if</span> (hwndDefIme == hwnd) {
01193             <span class="comment">/*</span>
01194 <span class="comment">             * VC++ 1.51 TLW0NCL.DLL subclass IME class window</span>
01195 <span class="comment">             * and pass IME messages to DefWindowProc().</span>
01196 <span class="comment">             */</span>
01197             RIPMSG1(RIP_WARNING,
01198                 <span class="stringliteral">"IME Class window is hooked and IME message [%X] are sent to DefWindowProc"</span>,
01199                 message);
01200             <a class="code" href="../../d6/d0/usercli_8h.html#a619">ImeWndProcWorker</a>(pwnd, message, wParam, lParam, fAnsi);
01201             <span class="keywordflow">break</span>;
01202         }
01203 
01204         pwndDefIme = <a class="code" href="../../d3/d9/client_2wow_8c.html#a1">ValidateHwndNoRip</a>(hwndDefIme);
01205 
01206         <span class="keywordflow">if</span> ((pwndDefIme = <a class="code" href="../../d3/d9/client_2wow_8c.html#a1">ValidateHwndNoRip</a>(hwndDefIme)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01207             <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT, pwndParent;
01208 
01209             pwndT = pwnd;
01210 
01211             <span class="keywordflow">while</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwndT)) {
01212                 pwndParent = <a class="code" href="../../d6/d0/usercli_8h.html#a27">REBASEPWND</a>(pwndT, spwndParent);
01213                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndParent) != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd))
01214                     <span class="keywordflow">break</span>;
01215                 pwndT = pwndParent;
01216             }
01217 
01218             <span class="comment">/*</span>
01219 <span class="comment">             * If hImc of this window is not activated for IME window,</span>
01220 <span class="comment">             * we don't send WM_IME_NOTIFY.</span>
01221 <span class="comment">             */</span>
01222             <span class="keywordflow">if</span> (pwndT != pwnd) {
01223                 pimeui = ((<a class="code" href="../../d5/d8/structtagIMEWND.html">PIMEWND</a>)pwndDefIme)-&gt;pimeui;
01224                 <span class="keywordflow">if</span> (pimeui-&gt;<a class="code" href="../../d4/d8/structtagIMEUI.html#o1">hIMC</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a307">fpImmGetContext</a>(hwnd))
01225                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pwndT, message, wParam, lParam, fAnsi);
01226                 <span class="keywordflow">else</span>
01227                     RIPMSG1(RIP_WARNING,
01228                         <span class="stringliteral">"DefWindowProc can not send WM_IME_message [%X] now"</span>,
01229                         message);
01230             }
01231             <span class="keywordflow">else</span> {
01232                 <span class="comment">/*</span>
01233 <span class="comment">                 * Review !!</span>
01234 <span class="comment">                 * If this is the toplevel window, we pass messages to</span>
01235 <span class="comment">                 * the default IME window...</span>
01236 <span class="comment">                 */</span>
01237                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pwndDefIme, message, wParam, lParam, fAnsi);
01238             }
01239         }
01240         <span class="keywordflow">break</span>;
01241 
01242     <span class="keywordflow">case</span> WM_IME_NOTIFY:
01243         <span class="keywordflow">switch</span> (wParam) {
01244         <span class="keywordflow">case</span> IMN_OPENSTATUSWINDOW:
01245         <span class="keywordflow">case</span> IMN_CLOSESTATUSWINDOW:
01246 <span class="preprocessor">#ifndef WKWOK_DEBUG</span>
01247 <span class="preprocessor"></span>            <span class="keywordflow">goto</span> dwpime_ToIMEWnd_withchk;
01248 <span class="preprocessor">#endif</span>
01249 <span class="preprocessor"></span>            <span class="keywordflow">goto</span> dwpime_ToTopLevel_withchk;
01250 
01251         <span class="keywordflow">default</span>:
01252             <span class="keywordflow">goto</span> dwpime_ToIMEWnd_withchk;
01253         }
01254         <span class="keywordflow">break</span>;
01255 
01256     <span class="keywordflow">case</span> WM_IME_REQUEST:
01257         <span class="keywordflow">switch</span> (wParam) {
01258         <span class="keywordflow">case</span> IMR_QUERYCHARPOSITION:
01259             <span class="keywordflow">goto</span> dwpime_ToIMEWnd_withchk;
01260         <span class="keywordflow">default</span>:
01261             <span class="keywordflow">break</span>;
01262         }
01263         <span class="keywordflow">break</span>;
01264 
01265     <span class="keywordflow">case</span> WM_IME_SYSTEM:
01266         <span class="keywordflow">if</span> (wParam == IMS_SETACTIVECONTEXT) {
01267             RIPMSG0(RIP_WARNING, <span class="stringliteral">"DefWindowProc received unexpected WM_IME_SYSTEM"</span>);
01268             <span class="keywordflow">break</span>;
01269         }
01270 
01271         <span class="comment">/*</span>
01272 <span class="comment">         * IMS_SETOPENSTATUS is depended on the activated input context.</span>
01273 <span class="comment">         * It needs to be sent to only the activated system window.</span>
01274 <span class="comment">         */</span>
01275         <span class="keywordflow">if</span> (wParam == IMS_SETOPENSTATUS)
01276             <span class="keywordflow">goto</span> dwpime_ToIMEWnd_withchk;
01277 
01278         <span class="comment">/*</span>
01279 <span class="comment">         * Fall through to send to Default IME Window.</span>
01280 <span class="comment">         */</span>
01281 
01282     <span class="keywordflow">case</span> WM_IME_SETCONTEXT:
01283         <span class="comment">//if (TestCF(pwnd, CFIME))</span>
01284         <span class="comment">//    break;</span>
01285 
01286         hwndDefIme = <a class="code" href="../../d6/d0/usercli_8h.html#a311">fpImmGetDefaultIMEWnd</a>(hwnd);
01287 
01288         <span class="keywordflow">if</span> (hwndDefIme == hwnd) {
01289             <span class="comment">/*</span>
01290 <span class="comment">             * VC++ 1.51 TLW0NCL.DLL subclass IME class window</span>
01291 <span class="comment">             * and pass IME messages to DefWindowProc().</span>
01292 <span class="comment">             */</span>
01293             RIPMSG1(RIP_WARNING,
01294                 <span class="stringliteral">"IME Class window is hooked and IME message [%X] are sent to DefWindowProc"</span>,
01295                 message);
01296             <a class="code" href="../../d6/d0/usercli_8h.html#a619">ImeWndProcWorker</a>(pwnd, message, wParam, lParam, fAnsi);
01297             <span class="keywordflow">break</span>;
01298         }
01299 
01300         <span class="keywordflow">if</span> ((pwndDefIme = <a class="code" href="../../d3/d9/client_2wow_8c.html#a1">ValidateHwndNoRip</a>(hwndDefIme)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01301             <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pwndDefIme, message, wParam, lParam, fAnsi);
01302 
01303         <span class="keywordflow">break</span>;
01304 
01305     <span class="keywordflow">case</span> WM_IME_SELECT:
01306         RIPMSG0(RIP_WARNING, <span class="stringliteral">"DefWindowProc should not receive WM_IME_SELECT"</span>);
01307         <span class="keywordflow">break</span>;
01308 
01309     <span class="keywordflow">case</span> WM_IME_COMPOSITIONFULL:
01310         <span class="comment">//if (TestCF(pwnd, CFIME))</span>
01311         <span class="comment">//    break;</span>
01312 
01313         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a150">GETAPPVER</a>() &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>) {
01314             <span class="comment">/*</span>
01315 <span class="comment">             * This is a temporary solution for win31app.</span>
01316 <span class="comment">             * FEREVIEW: For M5 this will call WINNLS message mapping logic</span>
01317 <span class="comment">             *           -yutakan</span>
01318 <span class="comment">             */</span>
01319             <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pwnd, WM_IME_REPORT,
01320                              IR_FULLCONVERT, (LPARAM)0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, fAnsi);
01321         }
01322         <span class="keywordflow">break</span>;
01323 
01324     <span class="keywordflow">case</span> WM_CHANGEUISTATE:
01325         {
01326             WORD wAction = LOWORD(wParam);
01327             WORD wFlags = HIWORD(wParam);
01328             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bRealChange = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01329 
01330             <span class="keywordflow">if</span> (wFlags &amp; ~UISF_VALID || wAction &gt; UIS_LASTVALID ||
01331                 lParam || !<a class="code" href="../../d1/d0/inc_2user_8h.html#a384">TEST_KbdCuesPUSIF</a>) {
01332                     <span class="keywordflow">return</span> 0;
01333             }
01334 
01335             <span class="keywordflow">if</span> (wAction == UIS_INITIALIZE) {
01336                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;bLastRITWasKeyboard) {
01337                     wAction = UIS_CLEAR;
01338                 } <span class="keywordflow">else</span> {
01339                     wAction = UIS_SET;
01340                 }
01341                 wFlags = UISF_HIDEFOCUS | UISF_HIDEACCEL;
01342                 wParam = MAKEWPARAM(wAction, wFlags);
01343             }
01344 
01345             UserAssert(wAction == UIS_SET || wAction == UIS_CLEAR);
01346             <span class="comment">/*</span>
01347 <span class="comment">             * If the state is not going to change, there's nothing to do here</span>
01348 <span class="comment">             */</span>
01349             <span class="keywordflow">if</span> (wFlags &amp; UISF_HIDEFOCUS) {
01350                 bRealChange = (!!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d1/d0/inc_2user_8h.html#a622">WEFPUIFOCUSHIDDEN</a>)) ^ (wAction == UIS_SET);
01351             }
01352             <span class="keywordflow">if</span> (wFlags &amp; UISF_HIDEACCEL) {
01353                 bRealChange |= (!!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d1/d0/inc_2user_8h.html#a623">WEFPUIACCELHIDDEN</a>)) ^ (wAction == UIS_SET);
01354             }
01355 
01356             <span class="keywordflow">if</span> (!bRealChange) {
01357                 <span class="keywordflow">break</span>;
01358             }
01359             <span class="comment">/*</span>
01360 <span class="comment">             * Children pass this message up</span>
01361 <span class="comment">             * Top level windows update send down to themselves WM_UPDATEUISTATE.</span>
01362 <span class="comment">             * WM_UPDATEUISTATE will change the state bits and broadcast down the message</span>
01363 <span class="comment">             */</span>
01364             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwnd)) {
01365 
01366                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(<a class="code" href="../../d6/d0/usercli_8h.html#a27">REBASEPWND</a>(pwnd, spwndParent), WM_CHANGEUISTATE,
01367                               wParam, lParam, fAnsi);
01368             } <span class="keywordflow">else</span> {
01369                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pwnd, WM_UPDATEUISTATE, wParam, lParam, fAnsi);
01370             }
01371 
01372         }
01373         <span class="keywordflow">break</span>;
01374 
01375     <span class="keywordflow">case</span> WM_QUERYUISTATE:
01376         <span class="keywordflow">return</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d1/d0/inc_2user_8h.html#a622">WEFPUIFOCUSHIDDEN</a>) ? UISF_HIDEFOCUS : 0) |
01377                (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d1/d0/inc_2user_8h.html#a623">WEFPUIACCELHIDDEN</a>) ? UISF_HIDEACCEL : 0);
01378         <span class="keywordflow">break</span>;
01379     }
01380 
01381     <span class="keywordflow">return</span> 0;
01382 
01383 <span class="preprocessor">#if DBG</span>
01384 <span class="preprocessor"></span>    } <span class="comment">// gfTurboDWP</span>
01385 <span class="preprocessor">#endif</span>
01386 <span class="preprocessor"></span>}
01387 
01388 
01389 <span class="comment">/***************************************************************************\</span>
01390 <span class="comment">* CallWindowProc</span>
01391 <span class="comment">*</span>
01392 <span class="comment">* Calls pfn with the passed message parameters. If pfn is a server-side</span>
01393 <span class="comment">* window proc the server is called to deliver the message to the window.</span>
01394 <span class="comment">* Currently we have the following restrictions:</span>
01395 <span class="comment">*</span>
01396 <span class="comment">* 04-17-91 DarrinM Created.</span>
01397 <span class="comment">\***************************************************************************/</span>
01398 
<a name="l01399"></a><a class="code" href="../../d0/d9/clmsg_8c.html#a22">01399</a> LRESULT WINAPI <a class="code" href="../../d0/d9/clmsg_8c.html#a22">CallWindowProcAorW</a>(
01400     WNDPROC pfn,
01401     HWND hwnd,
01402     UINT message,
01403     WPARAM wParam,
01404     LPARAM lParam,
01405     BOOL bAnsi)             <span class="comment">// Denotes if input is Ansi or Unicode</span>
01406 {
01407     <a class="code" href="../../d3/d7/struct__CALLPROCDATA.html">PCALLPROCDATA</a> pCPD;
01408 
01409     <span class="comment">/*</span>
01410 <span class="comment">     * Raid# 78954: SPY++</span>
01411 <span class="comment">     *</span>
01412 <span class="comment">     * Under FE NT4.0 or NT5.0, the sytem sends WM_GETTEXTLENGTH</span>
01413 <span class="comment">     * corresponding to WM_xxxGETTEXT to optimize buffer allocation.</span>
01414 <span class="comment">     * This is really needed to avoid the buffer size inflation.</span>
01415 <span class="comment">     * For some reasons, Spy++ passes NULL as pfn to CallWindowProc</span>
01416 <span class="comment">     *</span>
01417 <span class="comment">     */</span>
01418     <span class="keywordflow">if</span> (pfn == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01419         RIPMSG0(RIP_WARNING, <span class="stringliteral">"CallWidowProcAorW(): pfn == NULL!"</span>);
01420         <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
01421     }
01422 
01423 <span class="comment">// OPT!! check an ANSI\UNICODE table rather than fnDWORD</span>
01424 <span class="comment">// OPT!! convert WM_CHAR family messages in line</span>
01425 
01426     <span class="comment">/*</span>
01427 <span class="comment">     * Check if pfn is really a CallProcData Handle</span>
01428 <span class="comment">     * if it is and there is no ANSI data then convert the handle</span>
01429 <span class="comment">     * into an address; otherwise call the server for translation</span>
01430 <span class="comment">     */</span>
01431     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a468">ISCPDTAG</a>(pfn)) {
01432         <span class="keywordflow">if</span> (pCPD = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a8">HMValidateHandleNoRip</a>((HANDLE)pfn, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a243">TYPE_CALLPROC</a>)) {
01433             <span class="keywordflow">if</span> ((message &gt;= WM_USER) || !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1144">MessageTable</a>[message].<a class="code" href="../../d6/d2/structtagMSG__TABLE__ENTRY.html#o1">bThunkMessage</a>) {
01434                 pfn = (WNDPROC)pCPD-&gt;<a class="code" href="../../d3/d7/struct__CALLPROCDATA.html#o2">pfnClientPrevious</a>;
01435             } <span class="keywordflow">else</span> {
01436                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a11">CsSendMessage</a>(hwnd, message, wParam, lParam, (ULONG_PTR)pfn,
01437                         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a219">FNID_CALLWINDOWPROC</a>, bAnsi);
01438             }
01439         } <span class="keywordflow">else</span> {
01440             RIPMSG1(RIP_WARNING, <span class="stringliteral">"CallWindowProc tried using a deleted CPD %#p\n"</span>, pfn);
01441             <span class="keywordflow">return</span> 0;
01442         }
01443     }
01444 
01445     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a20">CALLPROC_WOWCHECK</a>(pfn, hwnd, message, wParam, lParam);
01446 }
01447 
<a name="l01448"></a><a class="code" href="../../d0/d9/clmsg_8c.html#a23">01448</a> LRESULT WINAPI <a class="code" href="../../d0/d9/clmsg_8c.html#a23">CallWindowProcA</a>(
01449     WNDPROC pfn,
01450     HWND hwnd,
01451     UINT message,
01452     WPARAM wParam,
01453     LPARAM lParam)
01454 {
01455     <span class="keywordflow">return</span> <a class="code" href="../../d0/d9/clmsg_8c.html#a22">CallWindowProcAorW</a>(pfn, hwnd, message, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01456 }
<a name="l01457"></a><a class="code" href="../../d0/d9/clmsg_8c.html#a24">01457</a> LRESULT WINAPI <a class="code" href="../../d0/d9/clmsg_8c.html#a24">CallWindowProcW</a>(
01458     WNDPROC pfn,
01459     HWND hwnd,
01460     UINT message,
01461     WPARAM wParam,
01462     LPARAM lParam)
01463 {
01464     <span class="keywordflow">return</span> <a class="code" href="../../d0/d9/clmsg_8c.html#a22">CallWindowProcAorW</a>(pfn, hwnd, message, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01465 }
01466 
01467 <span class="comment">/***************************************************************************\</span>
01468 <span class="comment">* MenuWindowProc</span>
01469 <span class="comment">*</span>
01470 <span class="comment">* Calls the sever-side function xxxMenuWindowProc</span>
01471 <span class="comment">*</span>
01472 <span class="comment">* 07-27-92 Mikehar Created.</span>
01473 <span class="comment">\***************************************************************************/</span>
01474 
<a name="l01475"></a><a class="code" href="../../d0/d9/clmsg_8c.html#a25">01475</a> LRESULT WINAPI <a class="code" href="../../d0/d9/clmsg_8c.html#a25">MenuWindowProcW</a>(
01476     HWND hwnd,
01477     HWND hwndMDIClient,
01478     UINT message,
01479     WPARAM wParam,
01480     LPARAM lParam)
01481 {
01482     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a11">CsSendMessage</a>(hwnd, message, wParam, lParam,
01483         (ULONG_PTR)hwndMDIClient, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a195">FNID_MENU</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01484 }
01485 
<a name="l01486"></a><a class="code" href="../../d0/d9/clmsg_8c.html#a26">01486</a> LRESULT WINAPI <a class="code" href="../../d0/d9/clmsg_8c.html#a26">MenuWindowProcA</a>(
01487     HWND hwnd,
01488     HWND hwndMDIClient,
01489     UINT message,
01490     WPARAM wParam,
01491     LPARAM lParam)
01492 {
01493     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a11">CsSendMessage</a>(hwnd, message, wParam, lParam,
01494         (ULONG_PTR)hwndMDIClient, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a195">FNID_MENU</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01495 }
01496 
01497 <span class="comment">/***************************************************************************\</span>
01498 <span class="comment">* _ClientGetListboxString</span>
01499 <span class="comment">*</span>
01500 <span class="comment">* This special function exists because LB_GETTEXT and CB_GETLBTEXT don't have</span>
01501 <span class="comment">* buffer counts in them anywhere. Because there is no buffer count we have</span>
01502 <span class="comment">* no idea how much room to reserved in the shared memory stack for this</span>
01503 <span class="comment">* string to be copied into. The solution is to get the string length ahead</span>
01504 <span class="comment">* of time, and send the message with this buffer length. Since this buffer</span>
01505 <span class="comment">* length isn't a part of the original message, this routine is used for</span>
01506 <span class="comment">* just this purpose.</span>
01507 <span class="comment">*</span>
01508 <span class="comment">* This routine gets called from the server.</span>
01509 <span class="comment">*</span>
01510 <span class="comment">* 04-13-91 ScottLu Created.</span>
01511 <span class="comment">\***************************************************************************/</span>
01512 
<a name="l01513"></a><a class="code" href="../../d6/d0/usercli_8h.html#a551">01513</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI <a class="code" href="../../d6/d0/usercli_8h.html#a551">_ClientGetListboxString</a>(
01514     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
01515     UINT msg,
01516     WPARAM wParam,
01517     LPSTR lParam, <span class="comment">// May be a unicode or ANSI string</span>
01518     ULONG_PTR xParam,
01519     PROC xpfn)
01520 {
01521     <span class="keywordflow">return</span> ((<a class="code" href="../../d6/d0/usercli_8h.html#a348">GENERICPROC</a>)xpfn)(pwnd, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, wParam, (LPARAM)lParam, xParam);
01522 }
01523 
01524 <span class="comment">/***************************************************************************\</span>
01525 <span class="comment">* DispatchMessageWorker</span>
01526 <span class="comment">*</span>
01527 <span class="comment">* Handles any messages that can be dealt with wholly on the client and</span>
01528 <span class="comment">* passes the rest to the server.</span>
01529 <span class="comment">*</span>
01530 <span class="comment">* 04-24-92 DarrinM      Created.</span>
01531 <span class="comment">\***************************************************************************/</span>
01532 
<a name="l01533"></a><a class="code" href="../../d0/d9/clmsg_8c.html#a28">01533</a> LRESULT <a class="code" href="../../d0/d9/clmsg_8c.html#a28">DispatchMessageWorker</a>(
01534     MSG *pmsg,
01535     BOOL fAnsi)
01536 {
01537     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
01538     WPARAM wParamSaved;
01539     LRESULT lRet;
01540     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bDoDbcsMessaging = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01541 
01542     <span class="comment">/*</span>
01543 <span class="comment">     * Prevent apps from setting hi 16 bits so we can use them internally.</span>
01544 <span class="comment">     */</span>
01545     <span class="keywordflow">if</span> (pmsg-&gt;message &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a8">RESERVED_MSG_BITS</a>) {
01546         RIPERR1(ERROR_INVALID_PARAMETER,
01547                 RIP_WARNING,
01548                 <span class="stringliteral">"Invalid parameter \"pmsg-&gt;message\" (%ld) to DispatchMessageWorker"</span>,
01549                 pmsg-&gt;message);
01550 
01551         <span class="keywordflow">return</span> 0;
01552     }
01553 
01554     <span class="keywordflow">if</span> (pmsg-&gt;hwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01555         pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(pmsg-&gt;hwnd);
01556         <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01557             <span class="keywordflow">return</span> 0;
01558         pmsg-&gt;hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd);     <span class="comment">// get full 32-bit HWND in case this came from WoW</span>
01559     } <span class="keywordflow">else</span> {
01560         pwnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01561     }
01562 
01563     <span class="comment">/*</span>
01564 <span class="comment">     * If this is a synchronous-only message (takes a pointer in wParam or</span>
01565 <span class="comment">     * lParam), then don't allow this message to go through since those</span>
01566 <span class="comment">     * parameters have not been thunked, and are pointing into outer-space</span>
01567 <span class="comment">     * (which would case exceptions to occur).</span>
01568 <span class="comment">     *</span>
01569 <span class="comment">     * (This api is only called in the context of a message loop, and you</span>
01570 <span class="comment">     * don't get synchronous-only messages in a message loop).</span>
01571 <span class="comment">     */</span>
01572     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a918">TESTSYNCONLYMESSAGE</a>(pmsg-&gt;message, pmsg-&gt;wParam)) {
01573         <span class="comment">/*</span>
01574 <span class="comment">         * Fail if 32 bit app is calling.</span>
01575 <span class="comment">         */</span>
01576         <span class="keywordflow">if</span> (!(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>()-&gt;dwTIFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>)) {
01577             RIPERR0(ERROR_MESSAGE_SYNC_ONLY, RIP_WARNING, <span class="stringliteral">"DispatchMessageWorker: must be sync only"</span>);
01578             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01579         }
01580 
01581         <span class="comment">/*</span>
01582 <span class="comment">         * For wow apps, allow it to go through (for compatibility). Change</span>
01583 <span class="comment">         * the message id so our code doesn't understand the message - wow</span>
01584 <span class="comment">         * will get the message and strip out this bit before dispatching</span>
01585 <span class="comment">         * the message to the application.</span>
01586 <span class="comment">         */</span>
01587         pmsg-&gt;message |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a544">MSGFLAG_WOW_RESERVED</a>;
01588     }
01589 
01590     <span class="comment">/*</span>
01591 <span class="comment">     * Timer callbacks that don't go through window procs are sent with</span>
01592 <span class="comment">     * the callback address in lParam.  Identify and dispatch those timers.</span>
01593 <span class="comment">     */</span>
01594     <span class="keywordflow">if</span> ((pmsg-&gt;message == WM_TIMER) || (pmsg-&gt;message == <a class="code" href="../../d1/d1/bench_8c.html#a4">WM_SYSTIMER</a>)) {
01595         <span class="keywordflow">if</span> (pmsg-&gt;lParam != 0) {
01596             <span class="comment">/*</span>
01597 <span class="comment">             * System timers must be executed on the server's context.</span>
01598 <span class="comment">             */</span>
01599             <span class="keywordflow">if</span> (pmsg-&gt;message == <a class="code" href="../../d1/d1/bench_8c.html#a4">WM_SYSTIMER</a>) {
01600                 <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a160">NtUserDispatchMessage</a>(pmsg);
01601             } <span class="keywordflow">else</span> {
01602                 <span class="comment">/*</span>
01603 <span class="comment">                 * We can't really trust what's in lParam, so make sure we</span>
01604 <span class="comment">                 * handle any exceptions that occur during this call.</span>
01605 <span class="comment">                 */</span>
01606                 <span class="keywordflow">try</span> {
01607                     <span class="comment">/* Bug 234292 - joejo</span>
01608 <span class="comment">                     * Since the called window/dialog proc may have a different calling</span>
01609 <span class="comment">                     * convention, we must wrap the call and, check esp and replace with</span>
01610 <span class="comment">                     * a good esp when the call returns. This is what UserCallWinProc* does.</span>
01611 <span class="comment">                    */</span>
01612                     lRet = <a class="code" href="../../d0/d5/callproc_8h.html#a0">UserCallWinProc</a>((WNDPROC)pmsg-&gt;lParam, pmsg-&gt;hwnd, pmsg-&gt;message,
01613                             pmsg-&gt;wParam, <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>());
01614                 } except ((<a class="code" href="../../d6/d3/queue_8c.html#a35">GetAppCompatFlags2</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>) &amp; GACF2_NO_TRYEXCEPT_CALLWNDPROC) ?
01615                           <a class="code" href="../../d6/d7/halmips_8h.html#a34">EXCEPTION_CONTINUE_SEARCH</a> : W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
01616                       <span class="comment">/* #359866</span>
01617 <span class="comment">                       * Some applications like Hagaki Studio 2000 need to handle the exception</span>
01618 <span class="comment">                       * in WndProc in their handler, even though it skips the API calls.</span>
01619 <span class="comment">                       * For those apps, we have to honor the behavior of NT4, with no protection.</span>
01620 <span class="comment">                       */</span>
01621                     lRet = 0;
01622                 }
01623                 <span class="keywordflow">return</span> lRet;
01624             }
01625         }
01626     }
01627 
01628     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01629         <span class="keywordflow">return</span> 0;
01630 
01631     <span class="comment">/*</span>
01632 <span class="comment">     * To be safe (in case some bizarre app wants to look at the message</span>
01633 <span class="comment">     * again after dispatching it) save wParam so it can be restored after</span>
01634 <span class="comment">     * RtlMBMessageWParamCharToWCS() or RtlWCSMessageToMB() mangle it.</span>
01635 <span class="comment">     */</span>
01636     wParamSaved = pmsg-&gt;wParam;
01637 
01638     <span class="comment">/*</span>
01639 <span class="comment">     * Pass messages intended for server-side windows over to the server.</span>
01640 <span class="comment">     * WM_PAINTs are passed over so the WFPAINTNOTPROCESSED code can be</span>
01641 <span class="comment">     * executed.</span>
01642 <span class="comment">     */</span>
01643     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a569">WFSERVERSIDEPROC</a>) || (pmsg-&gt;message == WM_PAINT)) {
01644         <span class="keywordflow">if</span> (fAnsi) {
01645             <span class="comment">/*</span>
01646 <span class="comment">             * Setup DBCS Messaging for WM_CHAR...</span>
01647 <span class="comment">             */</span>
01648             <a class="code" href="../../d6/d0/usercli_8h.html#a294">BUILD_DBCS_MESSAGE_TO_SERVER_FROM_CLIENTA</a>(pmsg-&gt;message,pmsg-&gt;wParam,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01649 
01650             <span class="comment">/*</span>
01651 <span class="comment">             * Convert wParam to Unicode, if nessesary.</span>
01652 <span class="comment">             */</span>
01653             <a class="code" href="../../d5/d6/chartran_8c.html#a5">RtlMBMessageWParamCharToWCS</a>(pmsg-&gt;message, &amp;pmsg-&gt;wParam);
01654         }
01655         lRet = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a160">NtUserDispatchMessage</a>(pmsg);
01656         pmsg-&gt;wParam = wParamSaved;
01657         <span class="keywordflow">return</span> lRet;
01658     }
01659 
01660     <span class="comment">/*</span>
01661 <span class="comment">     * If the dispatcher and the receiver are both ANSI or both UNICODE</span>
01662 <span class="comment">     * then no message translation is necessary.  NOTE: this test</span>
01663 <span class="comment">     * assumes that fAnsi is FALSE or TRUE, not just zero or non-zero.</span>
01664 <span class="comment">     */</span>
01665     <span class="keywordflow">if</span> (!fAnsi != !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a570">WFANSIPROC</a>)) {
01666         <span class="comment">// before: if (fAnsi != ((TestWF(pwnd, WFANSIPROC)) ? TRUE : FALSE)) {</span>
01667         UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>() == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)); <span class="comment">// use receiver's codepage</span>
01668         <span class="keywordflow">if</span> (fAnsi) {
01669             <span class="comment">/*</span>
01670 <span class="comment">             * Setup DBCS Messaging for WM_CHAR...</span>
01671 <span class="comment">             */</span>
01672             <a class="code" href="../../d6/d0/usercli_8h.html#a295">BUILD_DBCS_MESSAGE_TO_CLIENTW_FROM_CLIENTA</a>(pmsg-&gt;message,pmsg-&gt;wParam,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01673 
01674             <span class="comment">/*</span>
01675 <span class="comment">             * Convert wParam to Unicode, if nessesary.</span>
01676 <span class="comment">             */</span>
01677             <a class="code" href="../../d5/d6/chartran_8c.html#a5">RtlMBMessageWParamCharToWCS</a>(pmsg-&gt;message, &amp;pmsg-&gt;wParam);
01678         } <span class="keywordflow">else</span> {
01679             <span class="comment">/*</span>
01680 <span class="comment">             * Convert wParam to ANSI...</span>
01681 <span class="comment">             */</span>
01682             <a class="code" href="../../d5/d6/chartran_8c.html#a4">RtlWCSMessageWParamCharToMB</a>(pmsg-&gt;message, &amp;pmsg-&gt;wParam);
01683 
01684             <span class="comment">/*</span>
01685 <span class="comment">             * Let's DBCS messaging for WM_CHAR....</span>
01686 <span class="comment">             */</span>
01687             <a class="code" href="../../d6/d0/usercli_8h.html#a298">BUILD_DBCS_MESSAGE_TO_CLIENTA_FROM_CLIENTW</a>(
01688                 pmsg-&gt;hwnd,pmsg-&gt;message,pmsg-&gt;wParam,pmsg-&gt;lParam,
01689                 pmsg-&gt;time,pmsg-&gt;pt,bDoDbcsMessaging);
01690         }
01691     }
01692 
01693 DispatchMessageAgain:
01694     lRet = <a class="code" href="../../d6/d0/usercli_8h.html#a19">CALLPROC_WOWCHECKPWW</a>(<a class="code" href="../../d1/d0/inc_2user_8h.html#a237">MapKernelClientFnToClientFn</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o8">lpfnWndProc</a>), pmsg-&gt;hwnd, pmsg-&gt;message,
01695             pmsg-&gt;wParam, pmsg-&gt;lParam, &amp;(pwnd-&gt;state));
01696 
01697     <span class="comment">/*</span>
01698 <span class="comment">     * if we have DBCS TrailingByte that should be sent, send it here..</span>
01699 <span class="comment">     */</span>
01700     <a class="code" href="../../d6/d0/usercli_8h.html#a299">DISPATCH_DBCS_MESSAGE_IF_EXIST</a>(pmsg-&gt;message,pmsg-&gt;wParam,bDoDbcsMessaging,<a class="code" href="../../d5/d9/cltxt_8h.html#a24">DispatchMessage</a>);
01701 
01702     pmsg-&gt;wParam = wParamSaved;
01703     <span class="keywordflow">return</span> lRet;
01704 }
01705 
01706 <span class="comment">/***************************************************************************\</span>
01707 <span class="comment">* GetMessageTime (API)</span>
01708 <span class="comment">*</span>
01709 <span class="comment">* This API returns the time when the last message was read from</span>
01710 <span class="comment">* the current message queue.</span>
01711 <span class="comment">*</span>
01712 <span class="comment">* History:</span>
01713 <span class="comment">* 11-19-90 DavidPe      Created.</span>
01714 <span class="comment">\***************************************************************************/</span>
01715 
<a name="l01716"></a><a class="code" href="../../d0/d9/clmsg_8c.html#a29">01716</a> LONG <a class="code" href="../../d0/d9/clmsg_8c.html#a29">GetMessageTime</a>(VOID)
01717 {
01718     <span class="keywordflow">return</span> (LONG)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a287">NtUserGetThreadState</a>(UserThreadStateMessageTime);
01719 }
01720 
01721 <span class="comment">/***************************************************************************\</span>
01722 <span class="comment">* GetMessageExtraInfo (API)</span>
01723 <span class="comment">*</span>
01724 <span class="comment">* History:</span>
01725 <span class="comment">* 28-May-1991 mikeke</span>
01726 <span class="comment">\***************************************************************************/</span>
01727 
<a name="l01728"></a><a class="code" href="../../d0/d9/clmsg_8c.html#a30">01728</a> LPARAM <a class="code" href="../../d0/d9/clmsg_8c.html#a30">GetMessageExtraInfo</a>(VOID)
01729 {
01730     <span class="keywordflow">return</span> (LPARAM)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a287">NtUserGetThreadState</a>(UserThreadStateExtraInfo);
01731 }
01732 
<a name="l01733"></a><a class="code" href="../../d0/d9/clmsg_8c.html#a31">01733</a> LPARAM <a class="code" href="../../d0/d9/clmsg_8c.html#a31">SetMessageExtraInfo</a>(LPARAM lParam)
01734 {
01735     <span class="keywordflow">return</span> (LPARAM)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>(lParam, SFI__SETMESSAGEEXTRAINFO);
01736 }
01737 
01738 
01739 
01740 <span class="comment">/***********************************************************************\</span>
01741 <span class="comment">* InSendMessage (API)</span>
01742 <span class="comment">*</span>
01743 <span class="comment">* This function determines if the current thread is preocessing a message</span>
01744 <span class="comment">* from another application.</span>
01745 <span class="comment">*</span>
01746 <span class="comment">* History:</span>
01747 <span class="comment">* 01-13-91 DavidPe      Ported.</span>
01748 <span class="comment">\***********************************************************************/</span>
01749 
<a name="l01750"></a><a class="code" href="../../d0/d9/clmsg_8c.html#a32">01750</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d9/clmsg_8c.html#a32">InSendMessage</a>(VOID)
01751 {
01752     <a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html">PCLIENTTHREADINFO</a> pcti = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>()-&gt;pClientThreadInfo;
01753 
01754     <span class="keywordflow">if</span> (pcti) {
01755         <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a10">TEST_BOOL_FLAG</a>(pcti-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o0">CTIF_flags</a>, <a class="code" href="../../d1/d0/inc_2user_8h.html#a818">CTIF_INSENDMESSAGE</a>);
01756     }
01757     <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a287">NtUserGetThreadState</a>(UserThreadStateInSendMessage) != ISMEX_NOSEND;
01758 }
01759 <span class="comment">/***********************************************************************\</span>
01760 <span class="comment">* InSendMessageEx (API)</span>
01761 <span class="comment">*</span>
01762 <span class="comment">* This function tells you what type of send message is being processed</span>
01763 <span class="comment">*  by the application, if any</span>
01764 <span class="comment">*</span>
01765 <span class="comment">* History:</span>
01766 <span class="comment">* 01/22/97 GerardoB Created</span>
01767 <span class="comment">\***********************************************************************/</span>
01768 
<a name="l01769"></a><a class="code" href="../../d0/d9/clmsg_8c.html#a33">01769</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d0/d9/clmsg_8c.html#a33">InSendMessageEx</a>(LPVOID lpReserved)
01770 {
01771     <a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html">PCLIENTTHREADINFO</a> pcti = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>()-&gt;pClientThreadInfo;
01772     UNREFERENCED_PARAMETER(lpReserved);
01773 
01774     <span class="keywordflow">if</span> (pcti &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a9">TEST_FLAG</a>(pcti-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o0">CTIF_flags</a>, <a class="code" href="../../d1/d0/inc_2user_8h.html#a818">CTIF_INSENDMESSAGE</a>)) {
01775         <span class="keywordflow">return</span> ISMEX_NOSEND;
01776     }
01777     <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a287">NtUserGetThreadState</a>(UserThreadStateInSendMessage);
01778 }
01779 
01780 <span class="comment">/***********************************************************************\</span>
01781 <span class="comment">* GetCPD</span>
01782 <span class="comment">*</span>
01783 <span class="comment">* This function calls the server to allocate a CPD structure.</span>
01784 <span class="comment">*</span>
01785 <span class="comment">* History:</span>
01786 <span class="comment">* 11-15-94 JimA         Created.</span>
01787 <span class="comment">\***********************************************************************/</span>
01788 
<a name="l01789"></a><a class="code" href="../../d1/d0/inc_2user_8h.html#a1171">01789</a> ULONG_PTR <a class="code" href="../../d0/d5/ntuser_2kernel_2getset_8c.html#a7">GetCPD</a>(
01790     PVOID pWndOrCls,
01791     DWORD options,
01792     ULONG_PTR dwData)
01793 {
01794     <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a304">NtUserGetCPD</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pWndOrCls), options, dwData);
01795 }
01796 
01797 <span class="preprocessor">#ifdef BUILD_WOW6432</span>
01798 <span class="preprocessor"></span><span class="comment">/***********************************************************************\</span>
01799 <span class="comment">* MapKernelClientFnToClientFn</span>
01800 <span class="comment">*</span>
01801 <span class="comment">* Maps a function pointer from what the kernel expects to what the</span>
01802 <span class="comment">* client(user-mode) expects.</span>
01803 <span class="comment">*</span>
01804 <span class="comment">* History:</span>
01805 <span class="comment">* 11-15-98 PeterHal         Created.</span>
01806 <span class="comment">\***********************************************************************/</span>
01807 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a988">WNDPROC_PWND</a>
01808 <a class="code" href="../../d1/d0/inc_2user_8h.html#a237">MapKernelClientFnToClientFn</a>(
01809     WNDPROC_PWND lpfnWndProc
01810     )
01811 {
01812     KERNEL_ULONG_PTR *pp;
01813 
01814     <span class="keywordflow">for</span> (pp = (KERNEL_ULONG_PTR*)&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o8">apfnClientA</a>; pp &lt; (KERNEL_ULONG_PTR*) (&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o8">apfnClientA</a>+1); pp ++) {
01815         <span class="keywordflow">if</span> ((KERNEL_ULONG_PTR)lpfnWndProc == *pp) {
01816             <span class="keywordflow">return</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a988">WNDPROC_PWND</a>)((KERNEL_ULONG_PTR*) &amp;<a class="code" href="../../d6/d8/clinit_8c.html#a13">pfnClientA</a>) [ (pp - (KERNEL_ULONG_PTR*)&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o8">apfnClientA</a>) ];
01817         }
01818     }
01819 
01820     <span class="keywordflow">for</span> (pp = (KERNEL_ULONG_PTR*)&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o9">apfnClientW</a>; pp &lt; (KERNEL_ULONG_PTR*) (&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o9">apfnClientW</a>+1); pp ++) {
01821         <span class="keywordflow">if</span> ((KERNEL_ULONG_PTR)lpfnWndProc == *pp) {
01822             <span class="keywordflow">return</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a988">WNDPROC_PWND</a>)((KERNEL_ULONG_PTR*) &amp;<a class="code" href="../../d6/d8/clinit_8c.html#a14">pfnClientW</a>) [ (pp - (KERNEL_ULONG_PTR*)&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o9">apfnClientW</a>) ];
01823         }
01824     }
01825 
01826     <span class="keywordflow">return</span> lpfnWndProc;
01827 }
01828 <span class="preprocessor">#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:25 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
