<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: dirctrl.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>dirctrl.c File Reference</h1><code>#include "UdfProcs.h"</code><br>

<p>
<a href="../../d2/d7/dirctrl_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html">_COMPOUND_DIR_ENUM_CONTEXT</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/dirctrl_8c.html#a0">BugCheckFileId</a>&nbsp;&nbsp;&nbsp;(UDFS_BUG_CHECK_DIRCTRL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/dirctrl_8c.html#a1">Dbg</a>&nbsp;&nbsp;&nbsp;(UDFS_DEBUG_LEVEL_DIRCTRL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/dirctrl_8c.html#a2">UDF_FILE_INDEX_VIRTUAL_SELF</a>&nbsp;&nbsp;&nbsp;0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/dirctrl_8c.html#a3">UDF_FILE_INDEX_PHYSICAL</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html">_COMPOUND_DIR_ENUM_CONTEXT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/dirctrl_8c.html#a4">COMPOUND_DIR_ENUM_CONTEXT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html">_COMPOUND_DIR_ENUM_CONTEXT</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/dirctrl_8c.html#a5">PCOMPOUND_DIR_ENUM_CONTEXT</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/dirctrl_8c.html#a6">UdfInitializeCompoundDirContext</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html">PCOMPOUND_DIR_ENUM_CONTEXT</a> CompoundDirContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/dirctrl_8c.html#a7">UdfCleanupCompoundDirContext</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html">PCOMPOUND_DIR_ENUM_CONTEXT</a> CompoundDirContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE LONGLONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/dirctrl_8c.html#a8">UdfFileIndexToPhysicalOffset</a> (LONGLONG FileIndex)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE LONGLONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/dirctrl_8c.html#a9">UdfPhysicalOffsetToFileIndex</a> (LONGLONG PhysicalOffset)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/dirctrl_8c.html#a10">UdfIsFileIndexVirtual</a> (LONGLONG FileIndex)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/dirctrl_8c.html#a11">UdfQueryDirectory</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb, IN <a class="el" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/dirctrl_8c.html#a12">UdfNotifyChangeDirectory</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp, IN <a class="el" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/dirctrl_8c.html#a13">UdfInitializeEnumeration</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb, IN OUT <a class="el" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb, IN OUT <a class="el" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html">PCOMPOUND_DIR_ENUM_CONTEXT</a> CompoundDirContext, OUT PBOOLEAN ReturnNextEntry, OUT PBOOLEAN ReturnSingleEntry, OUT PBOOLEAN InitialQuery)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/dirctrl_8c.html#a14">UdfEnumerateIndex</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb, IN OUT <a class="el" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html">PCOMPOUND_DIR_ENUM_CONTEXT</a> CompoundDirContext, IN BOOLEAN ReturnNextEntry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/dirctrl_8c.html#a15">UdfLookupFileEntryInEnumeration</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb, IN <a class="el" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html">PCOMPOUND_DIR_ENUM_CONTEXT</a> CompoundDirContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/dirctrl_8c.html#a16">UdfLookupInitialFileIndex</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb, IN <a class="el" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html">PCOMPOUND_DIR_ENUM_CONTEXT</a> CompoundDirContext, IN PLONGLONG InitialIndex)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/dirctrl_8c.html#a17">UdfLookupNextFileIndex</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb, IN <a class="el" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html">PCOMPOUND_DIR_ENUM_CONTEXT</a> CompoundDirContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d8/dirctrl_8c.html#a18">UdfCommonDirControl</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="dirctrl.c::BugCheckFileId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BugCheckFileId&nbsp;&nbsp;&nbsp;(UDFS_BUG_CHECK_DIRCTRL)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00028">28</a> of file <a class="el" href="../../d2/d7/dirctrl_8c-source.html">dirctrl.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="dirctrl.c::Dbg" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define Dbg&nbsp;&nbsp;&nbsp;(UDFS_DEBUG_LEVEL_DIRCTRL)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00034">34</a> of file <a class="el" href="../../d2/d7/dirctrl_8c-source.html">dirctrl.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="dirctrl.c::UDF_FILE_INDEX_PHYSICAL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UDF_FILE_INDEX_PHYSICAL&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00088">88</a> of file <a class="el" href="../../d2/d7/dirctrl_8c-source.html">dirctrl.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00151">UdfFileIndexToPhysicalOffset()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01003">UdfInitializeEnumeration()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00171">UdfIsFileIndexVirtual()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01863">UdfLookupNextFileIndex()</a>, and <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00161">UdfPhysicalOffsetToFileIndex()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="dirctrl.c::UDF_FILE_INDEX_VIRTUAL_SELF" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UDF_FILE_INDEX_VIRTUAL_SELF&nbsp;&nbsp;&nbsp;0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00082">82</a> of file <a class="el" href="../../d2/d7/dirctrl_8c-source.html">dirctrl.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01003">UdfInitializeEnumeration()</a>, and <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01800">UdfLookupInitialFileIndex()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a4" doxytag="dirctrl.c::COMPOUND_DIR_ENUM_CONTEXT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html">_COMPOUND_DIR_ENUM_CONTEXT</a>  <a class="el" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html">COMPOUND_DIR_ENUM_CONTEXT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="dirctrl.c::PCOMPOUND_DIR_ENUM_CONTEXT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html">_COMPOUND_DIR_ENUM_CONTEXT</a> * <a class="el" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html">PCOMPOUND_DIR_ENUM_CONTEXT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a7" doxytag="dirctrl.c::UdfCleanupCompoundDirContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE VOID UdfCleanupCompoundDirContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html">PCOMPOUND_DIR_ENUM_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CompoundDirContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00112">112</a> of file <a class="el" href="../../d2/d7/dirctrl_8c-source.html">dirctrl.c</a>.
<p>
References <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00099">UdfCleanupDirContext()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03183">UdfCleanupIcbContext()</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00334">UdfQueryDirectory()</a>.
<p>
<pre class="fragment"><div>00116 {
00117 
00118     <a class="code" href="../../d3/d8/udfprocs_8h.html#a168">UdfCleanupDirContext</a>( IrpContext, &amp;CompoundDirContext-&gt;DirContext );
00119     <a class="code" href="../../d3/d8/udfprocs_8h.html#a224">UdfCleanupIcbContext</a>( IrpContext, &amp;CompoundDirContext-&gt;IcbContext );
00120 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="dirctrl.c::UdfCommonDirControl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfCommonDirControl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00255">255</a> of file <a class="el" href="../../d2/d7/dirctrl_8c-source.html">dirctrl.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00104">IRP_MN_NOTIFY_CHANGE_DIRECTORY</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00103">IRP_MN_QUERY_DIRECTORY</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00133">UdfDecodeFileObject()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00904">UdfNotifyChangeDirectory()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00334">UdfQueryDirectory()</a>, and <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00218">UdfFsdDispatch()</a>, and <a class="el" href="../../d1/d7/fspdisp_8c-source.html#l00038">UdfFspDispatch()</a>.
<p>
<pre class="fragment"><div>00262                    :
00263 
00264     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entry point <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> operations.  These
00265     are directory enumerations and directory notify calls.  We verify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00266     user's handle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> a directory and then call <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate routine.
00267 
00268 Arguments:
00269 
00270     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> <span class="keywordflow">for</span> <span class="keyword">this</span> request.
00271 
00272 Return Value:
00273 
00274     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> returned from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lower level <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a>.
00275 
00276 --*/
00277 
00278 {
00279     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00280     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00281 
00282     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
00283     <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb;
00284 
00285     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00286 
00287     <span class="comment">//</span>
00288     <span class="comment">//  Decode the user file object and fail this request if it is not</span>
00289     <span class="comment">//  a user directory.</span>
00290     <span class="comment">//</span>
00291 
00292     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a174">UdfDecodeFileObject</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>,
00293                              &amp;Fcb,
00294                              &amp;Ccb ) != <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>) {
00295 
00296         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_INVALID_PARAMETER );
00297         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00298     }
00299 
00300     <span class="comment">//</span>
00301     <span class="comment">//  We know this is a directory control so we'll case on the</span>
00302     <span class="comment">//  minor function, and call a internal worker routine to complete</span>
00303     <span class="comment">//  the irp.</span>
00304     <span class="comment">//</span>
00305 
00306     <span class="keywordflow">switch</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a>) {
00307 
00308     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a44">IRP_MN_QUERY_DIRECTORY</a>:
00309 
00310         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d8/dirctrl_8c.html#a11">UdfQueryDirectory</a>( IrpContext, Irp, IrpSp, Fcb, Ccb );
00311         <span class="keywordflow">break</span>;
00312 
00313     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a45">IRP_MN_NOTIFY_CHANGE_DIRECTORY</a>:
00314 
00315         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d8/dirctrl_8c.html#a12">UdfNotifyChangeDirectory</a>( IrpContext, Irp, IrpSp, Ccb );
00316         <span class="keywordflow">break</span>;
00317 
00318     <span class="keywordflow">default</span>:
00319 
00320         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_INVALID_DEVICE_REQUEST );
00321         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_DEVICE_REQUEST;
00322         <span class="keywordflow">break</span>;
00323     }
00324 
00325     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00326 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="dirctrl.c::UdfEnumerateIndex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfEnumerateIndex           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d9/struct__CCB.html">PCCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Ccb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html">PCOMPOUND_DIR_ENUM_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CompoundDirContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnNextEntry</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01500">1500</a> of file <a class="el" href="../../d2/d7/dirctrl_8c-source.html">dirctrl.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00346">ASSERT_CCB</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00501">BooleanFlagOn</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00205">BYTE_COUNT_8_DOT_3</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01666">_DIR_ENUM_CONTEXT::CaseObjectName</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01139">CCB_FLAG_ENUM_MATCH_ALL</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01138">CCB_FLAG_ENUM_NAME_EXP_HAS_WILD</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01142">CCB_FLAG_ENUM_NOMATCH_CONSTANT_ENTRY</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01132">CCB_FLAG_IGNORE_CASE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01699">DIR_CONTEXT_FLAG_SEEN_NONCONSTANT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01646">_DIR_ENUM_CONTEXT::Fid</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00783">NSR_FID::Flags</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01658">_DIR_ENUM_CONTEXT::Flags</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01101">FsRtlAllocatePoolWithTag</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00812">NSR_FID_F_DELETED</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01672">_DIR_ENUM_CONTEXT::PureObjectName</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01678">_DIR_ENUM_CONTEXT::ShortObjectName</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00173">TAG_SHORT_FILE_NAME</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d6/d4/namesup_8c-source.html#l00389">UdfGenerate8dot3Name()</a>, <a class="el" href="../../d6/d4/namesup_8c-source.html#l00176">UdfIs8dot3Name()</a>, <a class="el" href="../../d6/d4/namesup_8c-source.html#l01203">UdfIsNameInExpression()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01863">UdfLookupNextFileIndex()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00443">UdfPagedPool</a>, and <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00360">UdfUpdateDirNames()</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00334">UdfQueryDirectory()</a>.
<p>
<pre class="fragment"><div>01509                    :
01510 
01511     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> worker routine <span class="keywordflow">for</span> index enumeration.  We are positioned
01512     at some dirent in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory and will either <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first match
01513     at that point or look to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next entry.  The Ccb contains details about
01514     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a> to <span class="keywordflow">do</span>.
01515 
01516 Arguments:
01517 
01518     Ccb - Ccb <span class="keywordflow">for</span> <span class="keyword">this</span> directory handle.
01519 
01520     CompoundDirContext - context already positioned at some entry in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory.
01521 
01522     ReturnNextEntry - Indicates <span class="keywordflow">if</span> we are returning <span class="keyword">this</span> entry or should start
01523         with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next entry.
01524 
01525 Return Value:
01526 
01527     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> next entry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> found, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
01528 
01529 --*/
01530 
01531 {
01532     BOOLEAN Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01533     <a class="code" href="../../d1/d2/structNSR__FID.html">PNSR_FID</a> Fid;
01534     <a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">PDIR_ENUM_CONTEXT</a> DirContext;
01535 
01536     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01537 
01538     <span class="comment">//</span>
01539     <span class="comment">//  Check inputs.</span>
01540     <span class="comment">//</span>
01541 
01542     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
01543     <a class="code" href="../../d1/d8/udfdata_8h.html#a22">ASSERT_CCB</a>( Ccb );
01544 
01545     <span class="comment">//</span>
01546     <span class="comment">//  Directly reference the directory enumeration context for convenience.</span>
01547     <span class="comment">//</span>
01548 
01549     DirContext = &amp;CompoundDirContext-&gt;DirContext;
01550 
01551     <span class="comment">//</span>
01552     <span class="comment">//  Loop until we find a match or exaust the directory.</span>
01553     <span class="comment">//</span>
01554 
01555     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01556 
01557         <span class="comment">//</span>
01558         <span class="comment">//  Move to the next entry unless we want to consider the current</span>
01559         <span class="comment">//  entry.</span>
01560         <span class="comment">//</span>
01561 
01562         <span class="keywordflow">if</span> (ReturnNextEntry) {
01563 
01564             <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d8/dirctrl_8c.html#a17">UdfLookupNextFileIndex</a>( IrpContext, Ccb-&gt;Fcb, CompoundDirContext )) {
01565 
01566                 <span class="keywordflow">break</span>;
01567             }
01568 
01569             <a class="code" href="../../d3/d8/udfprocs_8h.html#a171">UdfUpdateDirNames</a>( IrpContext,
01570                                DirContext,
01571                                <a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>( Ccb-&gt;Flags, CCB_FLAG_IGNORE_CASE ));
01572         } <span class="keywordflow">else</span> {
01573 
01574             ReturnNextEntry = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01575         }
01576 
01577         <span class="comment">//</span>
01578         <span class="comment">//  Don't bother if we have a constant entry and are ignoring them.</span>
01579         <span class="comment">//</span>
01580         
01581         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DirContext-&gt;<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o7">Flags</a>, DIR_CONTEXT_FLAG_SEEN_NONCONSTANT ) &amp;&amp;
01582             <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Ccb-&gt;Flags, CCB_FLAG_ENUM_NOMATCH_CONSTANT_ENTRY )) {
01583 
01584             <span class="keywordflow">continue</span>;
01585         }
01586 
01587         <span class="comment">//</span>
01588         <span class="comment">//  Directly reference the Fid for convenience.</span>
01589         <span class="comment">//</span>
01590 
01591         Fid = DirContext-&gt;<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o5">Fid</a>;
01592 
01593         <span class="comment">//</span>
01594         <span class="comment">//  Look at the current entry if it is pointing at real space on the disk.  If the Fid is NULL, this</span>
01595         <span class="comment">//  means it is to be synthesized (and thus interesting to look at).</span>
01596         <span class="comment">//</span>
01597 
01598         <span class="keywordflow">if</span> (Fid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Fid-&gt;<a class="code" href="../../d1/d2/structNSR__FID.html#o2">Flags</a>, NSR_FID_F_DELETED )) {
01599 
01600             <span class="comment">//</span>
01601             <span class="comment">//  If we match all names then return to our caller.</span>
01602             <span class="comment">//</span>
01603 
01604             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Ccb-&gt;Flags, CCB_FLAG_ENUM_MATCH_ALL )) {
01605 
01606                 DirContext-&gt;<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o11">ShortObjectName</a>.Length = 0;
01607                 Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01608 
01609                 <span class="keywordflow">break</span>;
01610             }
01611 
01612             <span class="comment">//</span>
01613             <span class="comment">//  Check if the long name matches the search expression.</span>
01614             <span class="comment">//</span>
01615 
01616             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a184">UdfIsNameInExpression</a>( IrpContext,
01617                                        &amp;DirContext-&gt;<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o9">CaseObjectName</a>,
01618                                        &amp;Ccb-&gt;SearchExpression,
01619                                        <a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>( Ccb-&gt;Flags, CCB_FLAG_ENUM_NAME_EXP_HAS_WILD ))) {
01620 
01621                 <span class="comment">//</span>
01622                 <span class="comment">//  Let our caller know we found an entry.</span>
01623                 <span class="comment">//</span>
01624 
01625                 DirContext-&gt;<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o11">ShortObjectName</a>.Length = 0;
01626                 Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01627 
01628                 <span class="keywordflow">break</span>;
01629             }
01630 
01631             <span class="comment">//</span>
01632             <span class="comment">//  The long name didn't match so we need to check for a</span>
01633             <span class="comment">//  possible short name match.  There is no match if the</span>
01634             <span class="comment">//  long name is one of the constant entries or already</span>
01635             <span class="comment">//  is 8dot3.</span>
01636             <span class="comment">//</span>
01637 
01638             <span class="keywordflow">if</span> (!(!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DirContext-&gt;<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o7">Flags</a>, DIR_CONTEXT_FLAG_SEEN_NONCONSTANT ) ||
01639                   <a class="code" href="../../d3/d8/udfprocs_8h.html#a178">UdfIs8dot3Name</a>( IrpContext,
01640                                   DirContext-&gt;<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o9">CaseObjectName</a> ))) {
01641 
01642                 <span class="comment">//</span>
01643                 <span class="comment">//  Allocate the shortname if it isn't already done.</span>
01644                 <span class="comment">//</span>
01645                 
01646                 <span class="keywordflow">if</span> (DirContext-&gt;<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o11">ShortObjectName</a>.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01647 
01648                     DirContext-&gt;<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o11">ShortObjectName</a>.Buffer = <a class="code" href="../../d1/d8/fsrtl_8h.html#a37">FsRtlAllocatePoolWithTag</a>( UdfPagedPool,
01649                                                                                    BYTE_COUNT_8_DOT_3,
01650                                                                                    TAG_SHORT_FILE_NAME );
01651                     DirContext-&gt;<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o11">ShortObjectName</a>.MaximumLength = <a class="code" href="../../d9/d7/udf_8h.html#a11">BYTE_COUNT_8_DOT_3</a>;
01652                 }
01653 
01654                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a180">UdfGenerate8dot3Name</a>( IrpContext,
01655                                       &amp;DirContext-&gt;<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o10">PureObjectName</a>,
01656                                       &amp;DirContext-&gt;<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o11">ShortObjectName</a> );
01657 
01658                 <span class="comment">//</span>
01659                 <span class="comment">//  Check if this name matches.</span>
01660                 <span class="comment">//</span>
01661 
01662                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a184">UdfIsNameInExpression</a>( IrpContext,
01663                                            &amp;DirContext-&gt;<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o11">ShortObjectName</a>,
01664                                            &amp;Ccb-&gt;SearchExpression,
01665                                            <a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>( Ccb-&gt;Flags, CCB_FLAG_ENUM_NAME_EXP_HAS_WILD ))) {
01666                     
01667                     <span class="comment">//</span>
01668                     <span class="comment">//  Let our caller know we found an entry.</span>
01669                     <span class="comment">//</span>
01670 
01671                     Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01672     
01673                     <span class="keywordflow">break</span>;
01674                 }
01675             }
01676         }
01677     }
01678 
01679     <span class="keywordflow">return</span> Found;
01680 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="dirctrl.c::UdfFileIndexToPhysicalOffset" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE LONGLONG UdfFileIndexToPhysicalOffset           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">LONGLONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>FileIndex</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00151">151</a> of file <a class="el" href="../../d2/d7/dirctrl_8c-source.html">dirctrl.c</a>.
<p>
References <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00088">UDF_FILE_INDEX_PHYSICAL</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01800">UdfLookupInitialFileIndex()</a>.
<p>
<pre class="fragment"><div>00154 {
00155 
00156     <span class="keywordflow">return</span> FileIndex - <a class="code" href="../../d1/d8/dirctrl_8c.html#a3">UDF_FILE_INDEX_PHYSICAL</a>;
00157 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="dirctrl.c::UdfInitializeCompoundDirContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE VOID UdfInitializeCompoundDirContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html">PCOMPOUND_DIR_ENUM_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CompoundDirContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00096">96</a> of file <a class="el" href="../../d2/d7/dirctrl_8c-source.html">dirctrl.c</a>.
<p>
References <a class="el" href="../../d6/d8/udfstruc_8h.html#a56">TIMESTAMP_BUNDLE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01872">UdfFastInitializeIcbContext()</a>, and <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00060">UdfInitializeDirContext()</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00334">UdfQueryDirectory()</a>.
<p>
<pre class="fragment"><div>00100 {
00101 
00102     <a class="code" href="../../d3/d8/udfprocs_8h.html#a167">UdfInitializeDirContext</a>( IrpContext, &amp;CompoundDirContext-&gt;DirContext );
00103     <a class="code" href="../../d3/d8/udfprocs_8h.html#a222">UdfFastInitializeIcbContext</a>( IrpContext, &amp;CompoundDirContext-&gt;IcbContext );
00104 
00105     RtlZeroMemory( &amp;CompoundDirContext-&gt;Timestamps, <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d1/struct__TIMESTAMP__BUNDLE.html">TIMESTAMP_BUNDLE</a> ));
00106 
00107     CompoundDirContext-&gt;FileIndex.QuadPart = 0;
00108 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="dirctrl.c::UdfInitializeEnumeration" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfInitializeEnumeration           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpSp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d2/d9/struct__CCB.html">PCCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Ccb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html">PCOMPOUND_DIR_ENUM_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CompoundDirContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnNextEntry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnSingleEntry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>InitialQuery</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01003">1003</a> of file <a class="el" href="../../d2/d7/dirctrl_8c-source.html">dirctrl.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00346">ASSERT_CCB</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00342">ASSERT_FCB_INDEX</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00501">BooleanFlagOn</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01141">CCB_FLAG_ENUM_INITIALIZED</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01139">CCB_FLAG_ENUM_MATCH_ALL</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01138">CCB_FLAG_ENUM_NAME_EXP_HAS_WILD</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01142">CCB_FLAG_ENUM_NOMATCH_CONSTANT_ENTRY</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01140">CCB_FLAG_ENUM_RETURN_NEXT</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01132">CCB_FLAG_IGNORE_CASE</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a189a90">EqualTo</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00047">FileName</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01101">FsRtlAllocatePoolWithTag</a>, <a class="el" href="../../d5/d4/name_8c-source.html#l00229">FsRtlDoesNameContainWildCards()</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00806">ISONsrFidSize</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00062">Max</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01038">RtlUpcaseUnicodeString()</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00068">SELF_ENTRY</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01898">SL_INDEX_SPECIFIED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01896">SL_RESTART_SCAN</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01897">SL_RETURN_SINGLE_ENTRY</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00160">TAG_ENUM_EXPRESSION</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00088">UDF_FILE_INDEX_PHYSICAL</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00082">UDF_FILE_INDEX_VIRTUAL_SELF</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00099">UdfCleanupDirContext()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00453">UdfFreePool()</a>, <a class="el" href="../../d6/d4/namesup_8c-source.html#l01274">UdfFullCompareNames()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00060">UdfInitializeDirContext()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01567">UdfLockFcb</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01800">UdfLookupInitialFileIndex()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01863">UdfLookupNextFileIndex()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00443">UdfPagedPool</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00081">UdfUnicodeDirectoryNames</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01577">UdfUnlockFcb</a>, and <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00360">UdfUpdateDirNames()</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00334">UdfQueryDirectory()</a>.
<p>
<pre class="fragment"><div>01016                    :
01017 
01018     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration variables and structures.
01019     We look at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state of a previous enumeration from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Ccb as well as any
01020     input values from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user.  On <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a> we will position <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DirContext at
01021     a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory and let <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller know whether <span class="keyword">this</span> entry or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01022     next entry should be returned.
01023 
01024 Arguments:
01025 
01026     IrpSp - <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> stack location <span class="keywordflow">for</span> <span class="keyword">this</span> request.
01027 
01028     Fcb - Fcb <span class="keywordflow">for</span> <span class="keyword">this</span> directory.
01029 
01030     Ccb - Ccb <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory handle.
01031 
01032     CompoundDirContext - Context to use <span class="keywordflow">for</span> <span class="keyword">this</span> enumeration.
01033 
01034     ReturnNextEntry - Address to store whether we should <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entry at
01035         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context position or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next entry.
01036 
01037     ReturnSingleEntry - Address to store whether we should <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">return</span>
01038         a single entry.
01039 
01040     InitialQuery - Address to store whether <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first enumeration
01041         query on <span class="keyword">this</span> handle.
01042 
01043 Return Value:
01044 
01045     None.
01046 
01047 --*/
01048 
01049 {
01050     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01051 
01052     PUNICODE_STRING <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>;
01053     UNICODE_STRING SearchExpression;
01054 
01055     PUNICODE_STRING RestartName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01056     
01057     ULONG CcbFlags;
01058 
01059     LONGLONG FileIndex;
01060     ULONG HighFileIndex;
01061     BOOLEAN KnownIndex;
01062 
01063     BOOLEAN Found;
01064 
01065     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01066 
01067     <span class="comment">//</span>
01068     <span class="comment">//  Check inputs.</span>
01069     <span class="comment">//</span>
01070 
01071     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
01072     <a class="code" href="../../d1/d8/udfdata_8h.html#a18">ASSERT_FCB_INDEX</a>( Fcb );
01073     <a class="code" href="../../d1/d8/udfdata_8h.html#a22">ASSERT_CCB</a>( Ccb );
01074 
01075     <span class="comment">//</span>
01076     <span class="comment">//  If this is the initial query then build a search expression from the input</span>
01077     <span class="comment">//  file name.</span>
01078     <span class="comment">//</span>
01079 
01080     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Ccb-&gt;Flags, CCB_FLAG_ENUM_INITIALIZED )) {
01081 
01082         <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> = (PUNICODE_STRING) IrpSp-&gt;Parameters.QueryDirectory.FileName;
01083 
01084         CcbFlags = 0;
01085 
01086         <span class="comment">//</span>
01087         <span class="comment">//  If the filename is not specified or is a single '*' then we will</span>
01088         <span class="comment">//  match all names.</span>
01089         <span class="comment">//</span>
01090 
01091         <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01092             (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01093             (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length == 0) ||
01094             ((<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length == <span class="keyword">sizeof</span>( WCHAR )) &amp;&amp;
01095              (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer[0] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'*'</span>))) {
01096 
01097             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( CcbFlags, CCB_FLAG_ENUM_MATCH_ALL );
01098 
01099             SearchExpression.Length =
01100             SearchExpression.MaximumLength = 0;
01101             SearchExpression.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01102 
01103         <span class="comment">//</span>
01104         <span class="comment">//  Otherwise build the name from the name in the stack location.</span>
01105         <span class="comment">//  This involves checking for wild card characters and upcasing the</span>
01106         <span class="comment">//  string if this is a case-insensitive search.</span>
01107         <span class="comment">//</span>
01108 
01109         } <span class="keywordflow">else</span> {
01110 
01111             <span class="comment">//</span>
01112             <span class="comment">//  The name better have at least one character.</span>
01113             <span class="comment">//</span>
01114 
01115             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length == 0) {
01116 
01117                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_INVALID_PARAMETER );
01118             }
01119 
01120             <span class="comment">//</span>
01121             <span class="comment">//  Check for wildcards in the separate components.</span>
01122             <span class="comment">//</span>
01123 
01124             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a177">FsRtlDoesNameContainWildCards</a>( FileName)) {
01125 
01126                 <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( CcbFlags, CCB_FLAG_ENUM_NAME_EXP_HAS_WILD );
01127             }
01128             
01129             <span class="comment">//</span>
01130             <span class="comment">//  Now create the search expression to store in the Ccb.</span>
01131             <span class="comment">//</span>
01132 
01133             SearchExpression.Buffer = <a class="code" href="../../d1/d8/fsrtl_8h.html#a37">FsRtlAllocatePoolWithTag</a>( UdfPagedPool,
01134                                                                 <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length,
01135                                                                 TAG_ENUM_EXPRESSION );
01136 
01137             SearchExpression.MaximumLength = <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length;
01138 
01139             <span class="comment">//</span>
01140             <span class="comment">//  Either copy the name directly or perform the upcase.</span>
01141             <span class="comment">//</span>
01142 
01143             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Ccb-&gt;Flags, CCB_FLAG_IGNORE_CASE )) {
01144 
01145                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a31">RtlUpcaseUnicodeString</a>( &amp;SearchExpression,
01146                                                  FileName,
01147                                                  FALSE );
01148 
01149                 <span class="comment">//</span>
01150                 <span class="comment">//  This should never fail.</span>
01151                 <span class="comment">//</span>
01152 
01153                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Status == STATUS_SUCCESS );
01154 
01155             } <span class="keywordflow">else</span> {
01156 
01157                 RtlCopyMemory( SearchExpression.Buffer,
01158                                <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer,
01159                                <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length );
01160             }
01161 
01162             SearchExpression.Length = <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length;
01163         }
01164 
01165         <span class="comment">//</span>
01166         <span class="comment">//  But we do not want to return the constant "." and ".." entries for</span>
01167         <span class="comment">//  the root directory, for consistency with the rest of Microsoft's</span>
01168         <span class="comment">//  filesystems.</span>
01169         <span class="comment">//</span>
01170 
01171         <span class="keywordflow">if</span> (Fcb == Fcb-&gt;Vcb-&gt;RootIndexFcb) {
01172 
01173             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( CcbFlags, CCB_FLAG_ENUM_NOMATCH_CONSTANT_ENTRY );
01174         }
01175 
01176         <span class="comment">//</span>
01177         <span class="comment">//  Now lock the Fcb in order to update the Ccb with the inital</span>
01178         <span class="comment">//  enumeration values.</span>
01179         <span class="comment">//</span>
01180 
01181         <a class="code" href="../../d3/d8/udfprocs_8h.html#a90">UdfLockFcb</a>( IrpContext, Fcb );
01182 
01183         <span class="comment">//</span>
01184         <span class="comment">//  Check again that this is the initial search.</span>
01185         <span class="comment">//</span>
01186 
01187         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Ccb-&gt;Flags, CCB_FLAG_ENUM_INITIALIZED )) {
01188 
01189             <span class="comment">//</span>
01190             <span class="comment">//  Update the values in the Ccb.</span>
01191             <span class="comment">//</span>
01192 
01193             Ccb-&gt;CurrentFileIndex = 0;
01194             Ccb-&gt;SearchExpression = SearchExpression;
01195 
01196             <span class="comment">//</span>
01197             <span class="comment">//  Set the appropriate flags in the Ccb.</span>
01198             <span class="comment">//</span>
01199 
01200             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Ccb-&gt;Flags, CcbFlags | CCB_FLAG_ENUM_INITIALIZED );
01201 
01202         <span class="comment">//</span>
01203         <span class="comment">//  Otherwise cleanup any buffer allocated here.</span>
01204         <span class="comment">//</span>
01205 
01206         } <span class="keywordflow">else</span> {
01207 
01208             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( CcbFlags, CCB_FLAG_ENUM_MATCH_ALL )) {
01209 
01210                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a124">UdfFreePool</a>( &amp;SearchExpression.Buffer );
01211             }
01212         }
01213 
01214     <span class="comment">//</span>
01215     <span class="comment">//  Otherwise lock the Fcb so we can read the current enumeration values.</span>
01216     <span class="comment">//</span>
01217 
01218     } <span class="keywordflow">else</span> {
01219 
01220         <a class="code" href="../../d3/d8/udfprocs_8h.html#a90">UdfLockFcb</a>( IrpContext, Fcb );
01221     }
01222 
01223     <span class="comment">//</span>
01224     <span class="comment">//  Capture the current state of the enumeration.</span>
01225     <span class="comment">//</span>
01226     <span class="comment">//  If the user specified an index then use his offset.  We always</span>
01227     <span class="comment">//  return the next entry in this case.  If  no name is specified,</span>
01228     <span class="comment">//  then we can't perform the restart.</span>
01229     <span class="comment">//</span>
01230 
01231     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;Flags, SL_INDEX_SPECIFIED ) &amp;&amp;
01232         IrpSp-&gt;Parameters.QueryDirectory.FileName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01233 
01234         KnownIndex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01235         FileIndex = IrpSp-&gt;Parameters.QueryDirectory.FileIndex;
01236         RestartName = (PUNICODE_STRING) IrpSp-&gt;Parameters.QueryDirectory.FileName;
01237         *ReturnNextEntry = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01238 
01239         <span class="comment">//</span>
01240         <span class="comment">//  We will use the highest file index reportable to the caller as a</span>
01241         <span class="comment">//  starting point as required if we cannot directly land at the</span>
01242         <span class="comment">//  specified location.</span>
01243         <span class="comment">//</span>
01244         
01245         HighFileIndex = Ccb-&gt;HighestReturnableFileIndex;
01246 
01247     <span class="comment">//</span>
01248     <span class="comment">//  If we are restarting the scan then go from the self entry.</span>
01249     <span class="comment">//</span>
01250 
01251     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;Flags, SL_RESTART_SCAN )) {
01252 
01253         KnownIndex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01254         FileIndex = 0;
01255         *ReturnNextEntry = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01256 
01257     <span class="comment">//</span>
01258     <span class="comment">//  Otherwise use the values from the Ccb.</span>
01259     <span class="comment">//</span>
01260 
01261     } <span class="keywordflow">else</span> {
01262 
01263         KnownIndex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01264         FileIndex = Ccb-&gt;CurrentFileIndex;
01265         *ReturnNextEntry = <a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>( Ccb-&gt;Flags, CCB_FLAG_ENUM_RETURN_NEXT );
01266     }
01267 
01268     <span class="comment">//</span>
01269     <span class="comment">//  Unlock the Fcb.</span>
01270     <span class="comment">//</span>
01271 
01272     <a class="code" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>( IrpContext, Fcb );
01273 
01274     <span class="comment">//</span>
01275     <span class="comment">//  We have the starting offset in the directory and whether to return</span>
01276     <span class="comment">//  that entry or the next.  If we are at the beginning of the directory</span>
01277     <span class="comment">//  and are returning that entry, then tell our caller this is the</span>
01278     <span class="comment">//  initial query.</span>
01279     <span class="comment">//</span>
01280 
01281     *InitialQuery = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01282 
01283     <span class="keywordflow">if</span> ((FileIndex == 0) &amp;&amp;
01284         !(*ReturnNextEntry)) {
01285 
01286         *InitialQuery = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01287     }
01288 
01289     <span class="comment">//</span>
01290     <span class="comment">//  Determine the offset in the stream to position the context and</span>
01291     <span class="comment">//  whether this offset is known to be a file offset.</span>
01292     <span class="comment">//</span>
01293     <span class="comment">//  If this offset is known to be safe then go ahead and position the</span>
01294     <span class="comment">//  context.  This handles the cases where the offset is the beginning</span>
01295     <span class="comment">//  of the stream, the offset is from a previous search or this is the</span>
01296     <span class="comment">//  initial query.</span>
01297     <span class="comment">//</span>
01298 
01299     <span class="keywordflow">if</span> (KnownIndex) {
01300 
01301         Found = <a class="code" href="../../d1/d8/dirctrl_8c.html#a16">UdfLookupInitialFileIndex</a>( IrpContext, Fcb, CompoundDirContext, &amp;FileIndex );
01302 
01303         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Found );
01304         
01305     <span class="comment">//</span>
01306     <span class="comment">//  Try to directly jump to the specified file index.  Otherwise we walk through</span>
01307     <span class="comment">//  the directory from the beginning (or the saved highest known offset if that is</span>
01308     <span class="comment">//  useful) until we reach the entry which contains this offset.</span>
01309     <span class="comment">//</span>
01310 
01311     } <span class="keywordflow">else</span> {
01312         
01313         <span class="comment">//</span>
01314         <span class="comment">//  We need to handle the special case of a restart from a synthesized</span>
01315         <span class="comment">//  entry - this is the one time where the restart index can be zero</span>
01316         <span class="comment">//  without requiring us to search above the 2^32 byte mark.</span>
01317         <span class="comment">//</span>
01318         
01319         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a185">UdfFullCompareNames</a>( IrpContext,
01320                                  RestartName,
01321                                  &amp;UdfUnicodeDirectoryNames[SELF_ENTRY] ) == <a class="code" href="../../d1/d8/fsrtl_8h.html#a189a90">EqualTo</a>) {
01322 
01323             FileIndex = <a class="code" href="../../d1/d8/dirctrl_8c.html#a2">UDF_FILE_INDEX_VIRTUAL_SELF</a>;
01324 
01325             Found = <a class="code" href="../../d1/d8/dirctrl_8c.html#a16">UdfLookupInitialFileIndex</a>( IrpContext, Fcb, CompoundDirContext, &amp;FileIndex );
01326     
01327             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Found );
01328             
01329         <span class="comment">//</span>
01330         <span class="comment">//  We are restarting from a physical entry.  If the restart index is zero, we were</span>
01331         <span class="comment">//  unable to inform the caller as to the "real" file index due to the dispartity</span>
01332         <span class="comment">//  between the ULONG FileIndex in the return structures and the LONGLONG offsets</span>
01333         <span class="comment">//  possible in directory streams.  In this case, we will go as high as we were able</span>
01334         <span class="comment">//  to inform the caller of and search linearly from that point forward.</span>
01335         <span class="comment">//</span>
01336         <span class="comment">//  It is also possible (realistic? unknown) that the restart index is somewhere in the</span>
01337         <span class="comment">//  middle of an entry and we won't find anything useable.  In this case we try to find</span>
01338         <span class="comment">//  the entry which contains this index, using it as the real restart point.</span>
01339         <span class="comment">//</span>
01340         
01341         } <span class="keywordflow">else</span> {
01342 
01343             <span class="comment">//</span>
01344             <span class="comment">//  See if we need the high water mark.</span>
01345             <span class="comment">//</span>
01346             
01347             <span class="keywordflow">if</span> (FileIndex == 0) {
01348 
01349                 <span class="comment">//</span>
01350                 <span class="comment">//  We know that this is good.</span>
01351                 <span class="comment">//</span>
01352                 
01353                 FileIndex = <a class="code" href="../../d3/d8/udfprocs_8h.html#a4">Max</a>( Ccb-&gt;HighestReturnableFileIndex, UDF_FILE_INDEX_PHYSICAL );;
01354                 KnownIndex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01355             
01356             }
01357             
01358             <span class="comment">//</span>
01359             <span class="comment">//  The file index is now useful, falling into two cases</span>
01360             <span class="comment">//</span>
01361             <span class="comment">//      1) KnownIndex == FALSE - searching by index</span>
01362             <span class="comment">//      2) KnownIndex == TRUE  - searching by name</span>
01363             <span class="comment">//</span>
01364             <span class="comment">//  Go set up our inquiry.</span>
01365             <span class="comment">//</span>
01366 
01367             Found = <a class="code" href="../../d1/d8/dirctrl_8c.html#a16">UdfLookupInitialFileIndex</a>( IrpContext, Fcb, CompoundDirContext, &amp;FileIndex );
01368             
01369             <span class="keywordflow">if</span> (KnownIndex) {
01370                 
01371                 <span class="comment">//</span>
01372                 <span class="comment">//  Walk forward to discover an entry named per the caller's expectation.</span>
01373                 <span class="comment">//</span>
01374                 
01375                 <span class="keywordflow">do</span> {
01376     
01377                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a171">UdfUpdateDirNames</a>( IrpContext,
01378                                        &amp;CompoundDirContext-&gt;DirContext,
01379                                        <a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>( Ccb-&gt;Flags, CCB_FLAG_IGNORE_CASE ));
01380                     
01381                     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a185">UdfFullCompareNames</a>( IrpContext,
01382                                              &amp;CompoundDirContext-&gt;DirContext.CaseObjectName,
01383                                              RestartName ) == <a class="code" href="../../d1/d8/fsrtl_8h.html#a189a90">EqualTo</a>) {
01384 
01385                         <span class="keywordflow">break</span>;
01386                     }
01387 
01388                     Found = <a class="code" href="../../d1/d8/dirctrl_8c.html#a17">UdfLookupNextFileIndex</a>( IrpContext, Fcb, CompoundDirContext );
01389     
01390                 } <span class="keywordflow">while</span> (Found);
01391             
01392             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!Found) {
01393 
01394                 LONGLONG LastFileIndex;
01395 
01396                 <span class="comment">//</span>
01397                 <span class="comment">//  Perform the search for the entry by index from the beginning of the physical directory.</span>
01398                 <span class="comment">//</span>
01399 
01400                 LastFileIndex = <a class="code" href="../../d1/d8/dirctrl_8c.html#a3">UDF_FILE_INDEX_PHYSICAL</a>;
01401 
01402                 Found = <a class="code" href="../../d1/d8/dirctrl_8c.html#a16">UdfLookupInitialFileIndex</a>( IrpContext, Fcb, CompoundDirContext, &amp;LastFileIndex );
01403 
01404                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Found );
01405 
01406                 <span class="comment">//</span>
01407                 <span class="comment">//  Keep walking through the directory until we run out of</span>
01408                 <span class="comment">//  entries or we find an entry which ends beyond the input</span>
01409                 <span class="comment">//  index value (index search case) or corresponds to the</span>
01410                 <span class="comment">//  name we are looking for (name search case).</span>
01411                 <span class="comment">//</span>
01412     
01413                 <span class="keywordflow">do</span> {
01414     
01415                     <span class="comment">//</span>
01416                     <span class="comment">//  If we have passed the index value then exit.</span>
01417                     <span class="comment">//</span>
01418 
01419                     <span class="keywordflow">if</span> (CompoundDirContext-&gt;FileIndex.QuadPart &gt; FileIndex) {
01420 
01421                         Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01422                         <span class="keywordflow">break</span>;
01423                     }
01424 
01425                     <span class="comment">//</span>
01426                     <span class="comment">//  Remember the current position in case we need to go back.</span>
01427                     <span class="comment">//</span>
01428 
01429                     LastFileIndex = CompoundDirContext-&gt;FileIndex.QuadPart;
01430 
01431                     <span class="comment">//</span>
01432                     <span class="comment">//  Exit if the next entry is beyond the desired index value.</span>
01433                     <span class="comment">//</span>
01434 
01435                     <span class="keywordflow">if</span> (LastFileIndex + <a class="code" href="../../d0/d7/iso13346_8h.html#a87">ISONsrFidSize</a>( CompoundDirContext-&gt;DirContext.Fid ) &gt; FileIndex) {
01436 
01437                         <span class="keywordflow">break</span>;
01438                     }
01439     
01440                     Found = <a class="code" href="../../d1/d8/dirctrl_8c.html#a17">UdfLookupNextFileIndex</a>( IrpContext, Fcb, CompoundDirContext );
01441     
01442                 } <span class="keywordflow">while</span> (Found);
01443     
01444                 <span class="comment">//</span>
01445                 <span class="comment">//  If we didn't find the entry then go back to the last known entry.</span>
01446                 <span class="comment">//</span>
01447     
01448                 <span class="keywordflow">if</span> (!Found) {
01449     
01450                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a168">UdfCleanupDirContext</a>( IrpContext, &amp;CompoundDirContext-&gt;DirContext );
01451                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a167">UdfInitializeDirContext</a>( IrpContext, &amp;CompoundDirContext-&gt;DirContext );
01452     
01453                     Found = <a class="code" href="../../d1/d8/dirctrl_8c.html#a16">UdfLookupInitialFileIndex</a>( IrpContext, Fcb, CompoundDirContext, &amp;LastFileIndex );
01454 
01455                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Found );
01456                 }
01457             }
01458         }
01459     }
01460 
01461     <span class="comment">//</span>
01462     <span class="comment">//  Only update the dirent name if we will need it for some reason.</span>
01463     <span class="comment">//  Don't update this name if we are returning the next entry, and</span>
01464     <span class="comment">//  don't update it if it was already done.</span>
01465     <span class="comment">//</span>
01466 
01467     <span class="keywordflow">if</span> (!(*ReturnNextEntry) &amp;&amp;
01468         CompoundDirContext-&gt;DirContext.PureObjectName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01469 
01470         <span class="comment">//</span>
01471         <span class="comment">//  Update the names in the dirent.</span>
01472         <span class="comment">//</span>
01473 
01474         <a class="code" href="../../d3/d8/udfprocs_8h.html#a171">UdfUpdateDirNames</a>( IrpContext,
01475                            &amp;CompoundDirContext-&gt;DirContext,
01476                            <a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>( Ccb-&gt;Flags, CCB_FLAG_IGNORE_CASE ));
01477     }
01478 
01479     <span class="comment">//</span>
01480     <span class="comment">//  Look at the flag in the IrpSp indicating whether to return just</span>
01481     <span class="comment">//  one entry.</span>
01482     <span class="comment">//</span>
01483 
01484     *ReturnSingleEntry = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01485 
01486     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;Flags, SL_RETURN_SINGLE_ENTRY )) {
01487 
01488         *ReturnSingleEntry = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01489     }
01490 
01491     <span class="keywordflow">return</span>;
01492 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="dirctrl.c::UdfIsFileIndexVirtual" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE BOOLEAN UdfIsFileIndexVirtual           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">LONGLONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>FileIndex</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00171">171</a> of file <a class="el" href="../../d2/d7/dirctrl_8c-source.html">dirctrl.c</a>.
<p>
References <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00088">UDF_FILE_INDEX_PHYSICAL</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01688">UdfLookupFileEntryInEnumeration()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01800">UdfLookupInitialFileIndex()</a>, and <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01863">UdfLookupNextFileIndex()</a>.
<p>
<pre class="fragment"><div>00174 {
00175 
00176     <span class="keywordflow">return</span> FileIndex &lt; <a class="code" href="../../d1/d8/dirctrl_8c.html#a3">UDF_FILE_INDEX_PHYSICAL</a>;
00177 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="dirctrl.c::UdfLookupFileEntryInEnumeration" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfLookupFileEntryInEnumeration           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html">PCOMPOUND_DIR_ENUM_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CompoundDirContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01688">1688</a> of file <a class="el" href="../../d2/d7/dirctrl_8c-source.html">dirctrl.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00936">ICBFILE::Destag</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00339">DESTAG_ID_NSR_FILE</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00847">ICBTAG::FileType</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00783">NSR_FID::Flags</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00785">NSR_FID::Icb</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00937">ICBFILE::Icbtag</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00870">ICBTAG_FILE_T_BLOCK_DEV</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00874">ICBTAG_FILE_T_C_ISSOCK</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00871">ICBTAG_FILE_T_CHAR_DEV</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00868">ICBTAG_FILE_T_DIRECTORY</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00873">ICBTAG_FILE_T_FIFO</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00869">ICBTAG_FILE_T_FILE</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00876">ICBTAG_FILE_T_PATHLINK</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00304">DESTAG::Ident</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00130">NSRLBA::Lbn</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00141">NSRLENGTH::Length</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00170">LONGAD::Length</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00811">NSR_FID_F_DIRECTORY</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00131">NSRLBA::Partition</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00171">LONGAD::Start</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03183">UdfCleanupIcbContext()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03060">UdfInitializeIcbContext()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02951">UdfInitializeIcbContextFromFcb()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00171">UdfIsFileIndexVirtual()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03124">UdfLookupActiveIcb()</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00334">UdfQueryDirectory()</a>.
<p>
<pre class="fragment"><div>01696                    :
01697 
01698     This routine retrieves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> entry associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current location in
01699     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration of a compound directory context.
01700   
01701 Arguments:
01702 
01703     Fcb - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory being enumerated.
01704     
01705     CompoundDirContext - a corresponding context <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration.
01706     
01707 Return Value:
01708 
01709     None.  <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> may be raised on discovery of corruption.
01710 
01711 --*/
01712 
01713 {
01714     <a class="code" href="../../d1/d2/structNSR__FID.html">PNSR_FID</a> Fid;
01715     <a class="code" href="../../d8/d0/structICBFILE.html">PICBFILE</a> Fe;
01716 
01717     Fid = CompoundDirContext-&gt;DirContext.Fid;
01718 
01719     <span class="comment">//</span>
01720     <span class="comment">//  Figure out where the ICB we want is.</span>
01721     <span class="comment">//</span>
01722     
01723     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/dirctrl_8c.html#a10">UdfIsFileIndexVirtual</a>( CompoundDirContext-&gt;FileIndex.QuadPart )) {
01724 
01725         <span class="comment">//</span>
01726         <span class="comment">//  Synthesize!  We only have to synthesize the self entry.  The name is already done,</span>
01727         <span class="comment">//  so the remaining work is trivial.</span>
01728         <span class="comment">//</span>
01729 
01730         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Fid == NULL );
01731 
01732         <span class="comment">//</span>
01733         <span class="comment">//  Lift the FE corresponding to this directory</span>
01734         <span class="comment">//</span>
01735 
01736         <a class="code" href="../../d3/d8/udfprocs_8h.html#a224">UdfCleanupIcbContext</a>( IrpContext, &amp;CompoundDirContext-&gt;IcbContext );
01737         
01738         <a class="code" href="../../d3/d8/udfprocs_8h.html#a220">UdfInitializeIcbContextFromFcb</a>( IrpContext,
01739                                         &amp;CompoundDirContext-&gt;IcbContext,
01740                                         Fcb );
01741 
01742     } <span class="keywordflow">else</span> {
01743 
01744         <span class="comment">//</span>
01745         <span class="comment">//  Lift the FE corresponding to this FID.</span>
01746         <span class="comment">//</span>
01747 
01748         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Fid != NULL );
01749 
01750         <a class="code" href="../../d3/d8/udfprocs_8h.html#a224">UdfCleanupIcbContext</a>( IrpContext, &amp;CompoundDirContext-&gt;IcbContext );
01751 
01752         <a class="code" href="../../d3/d8/udfprocs_8h.html#a221">UdfInitializeIcbContext</a>( IrpContext,
01753                                  &amp;CompoundDirContext-&gt;IcbContext,
01754                                  Fcb-&gt;Vcb,
01755                                  DESTAG_ID_NSR_FILE,
01756                                  Fid-&gt;<a class="code" href="../../d1/d2/structNSR__FID.html#o4">Icb</a>.<a class="code" href="../../d4/d9/structLONGAD.html#o1">Start</a>.<a class="code" href="../../d6/d3/structNSRLBA.html#o1">Partition</a>,
01757                                  Fid-&gt;<a class="code" href="../../d1/d2/structNSR__FID.html#o4">Icb</a>.<a class="code" href="../../d4/d9/structLONGAD.html#o1">Start</a>.<a class="code" href="../../d6/d3/structNSRLBA.html#o0">Lbn</a>,
01758                                  Fid-&gt;<a class="code" href="../../d1/d2/structNSR__FID.html#o4">Icb</a>.<a class="code" href="../../d4/d9/structLONGAD.html#o0">Length</a>.<a class="code" href="../../d7/d3/structNSRLENGTH.html#o0">Length</a> );
01759     }
01760 
01761     <span class="comment">//</span>
01762     <span class="comment">//  Retrieve the ICB for inspection.</span>
01763     <span class="comment">//</span>
01764     
01765     <a class="code" href="../../d3/d8/udfprocs_8h.html#a223">UdfLookupActiveIcb</a>( IrpContext, &amp;CompoundDirContext-&gt;IcbContext );
01766 
01767     Fe = (<a class="code" href="../../d8/d0/structICBFILE.html">PICBFILE</a>) CompoundDirContext-&gt;IcbContext.Active.View;
01768 
01769     <span class="comment">//</span>
01770     <span class="comment">//  Perform some basic verification that the FE is of the proper type and that</span>
01771     <span class="comment">//  FID and FE agree as to the type of the object.  We explicitly check that</span>
01772     <span class="comment">//  a legal filesystem-level FE type is discovered, even though we don't support</span>
01773     <span class="comment">//  them in other paths.</span>
01774     <span class="comment">//</span>
01775 
01776     <span class="keywordflow">if</span> (Fe-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o0">Destag</a>.<a class="code" href="../../d7/d7/structDESTAG.html#o0">Ident</a> != <a class="code" href="../../d0/d7/iso13346_8h.html#a54">DESTAG_ID_NSR_FILE</a> ||
01777 
01778         (((Fid &amp;&amp; <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Fid-&gt;<a class="code" href="../../d1/d2/structNSR__FID.html#o2">Flags</a>, NSR_FID_F_DIRECTORY )) ||
01779           Fid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01780          Fe-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o1">Icbtag</a>.<a class="code" href="../../d1/d1/structICBTAG.html#o5">FileType</a> != <a class="code" href="../../d0/d7/iso13346_8h.html#a102">ICBTAG_FILE_T_DIRECTORY</a>) ||
01781 
01782         (Fe-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o1">Icbtag</a>.<a class="code" href="../../d1/d1/structICBTAG.html#o5">FileType</a> != <a class="code" href="../../d0/d7/iso13346_8h.html#a103">ICBTAG_FILE_T_FILE</a> &amp;&amp;
01783          Fe-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o1">Icbtag</a>.<a class="code" href="../../d1/d1/structICBTAG.html#o5">FileType</a> != <a class="code" href="../../d0/d7/iso13346_8h.html#a102">ICBTAG_FILE_T_DIRECTORY</a> &amp;&amp;
01784          Fe-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o1">Icbtag</a>.<a class="code" href="../../d1/d1/structICBTAG.html#o5">FileType</a> != <a class="code" href="../../d0/d7/iso13346_8h.html#a104">ICBTAG_FILE_T_BLOCK_DEV</a> &amp;&amp;
01785          Fe-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o1">Icbtag</a>.<a class="code" href="../../d1/d1/structICBTAG.html#o5">FileType</a> != <a class="code" href="../../d0/d7/iso13346_8h.html#a105">ICBTAG_FILE_T_CHAR_DEV</a> &amp;&amp;
01786          Fe-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o1">Icbtag</a>.<a class="code" href="../../d1/d1/structICBTAG.html#o5">FileType</a> != <a class="code" href="../../d0/d7/iso13346_8h.html#a107">ICBTAG_FILE_T_FIFO</a> &amp;&amp;
01787          Fe-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o1">Icbtag</a>.<a class="code" href="../../d1/d1/structICBTAG.html#o5">FileType</a> != <a class="code" href="../../d0/d7/iso13346_8h.html#a108">ICBTAG_FILE_T_C_ISSOCK</a> &amp;&amp;
01788          Fe-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o1">Icbtag</a>.<a class="code" href="../../d1/d1/structICBTAG.html#o5">FileType</a> != <a class="code" href="../../d0/d7/iso13346_8h.html#a110">ICBTAG_FILE_T_PATHLINK</a>)) {
01789 
01790         <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_FILE_CORRUPT_ERROR );
01791     }
01792 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="dirctrl.c::UdfLookupInitialFileIndex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfLookupInitialFileIndex           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html">PCOMPOUND_DIR_ENUM_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CompoundDirContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>InitialIndex</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01800">1800</a> of file <a class="el" href="../../d2/d7/dirctrl_8c-source.html">dirctrl.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00082">UDF_FILE_INDEX_VIRTUAL_SELF</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00151">UdfFileIndexToPhysicalOffset()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00171">UdfIsFileIndexVirtual()</a>, and <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00165">UdfLookupInitialDirEntry()</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01003">UdfInitializeEnumeration()</a>.
<p>
<pre class="fragment"><div>01809                    :
01810 
01811     This routine begins <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration of a directory by setting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context
01812     at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first avaliable <span class="keyword">virtual</span> directory entry.
01813   
01814 Arguments:
01815 
01816     Fcb - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory being enumerated.
01817     
01818     CompoundDirContext - a corresponding context <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration.
01819     
01820     InitialIndex - an optional starting <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> index to base <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration.
01821     
01822 Return Value:
01823 
01824    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> will be returned <span class="keywordflow">if</span> a valid entry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> found at <span class="keyword">this</span> offset, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
01825 
01826 --*/
01827 
01828 {
01829     LONGLONG DirOffset;
01830 
01831     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/dirctrl_8c.html#a10">UdfIsFileIndexVirtual</a>( *InitialIndex )) {
01832 
01833         <span class="comment">//</span>
01834         <span class="comment">//  We only synthesize a single virtual directory entry.  Position the context</span>
01835         <span class="comment">//  at the virtual self entry.</span>
01836         <span class="comment">//</span>
01837         
01838         CompoundDirContext-&gt;FileIndex.QuadPart = <a class="code" href="../../d1/d8/dirctrl_8c.html#a2">UDF_FILE_INDEX_VIRTUAL_SELF</a>;
01839         
01840         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01841     }
01842 
01843     CompoundDirContext-&gt;FileIndex.QuadPart = *InitialIndex;
01844 
01845     <span class="comment">//</span>
01846     <span class="comment">//  Find the base offset in the directory and look it up.</span>
01847     <span class="comment">//</span>
01848     
01849     DirOffset = <a class="code" href="../../d1/d8/dirctrl_8c.html#a8">UdfFileIndexToPhysicalOffset</a>( *InitialIndex );
01850         
01851     <span class="keywordflow">return</span> <a class="code" href="../../d3/d8/udfprocs_8h.html#a169">UdfLookupInitialDirEntry</a>( IrpContext,
01852                                      Fcb,
01853                                      &amp;CompoundDirContext-&gt;DirContext,
01854                                      &amp;DirOffset );
01855 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="dirctrl.c::UdfLookupNextFileIndex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfLookupNextFileIndex           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html">PCOMPOUND_DIR_ENUM_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CompoundDirContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01863">1863</a> of file <a class="el" href="../../d2/d7/dirctrl_8c-source.html">dirctrl.c</a>.
<p>
References <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00806">ISONsrFidSize</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00088">UDF_FILE_INDEX_PHYSICAL</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00171">UdfIsFileIndexVirtual()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00165">UdfLookupInitialDirEntry()</a>, and <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00287">UdfLookupNextDirEntry()</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01500">UdfEnumerateIndex()</a>, and <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01003">UdfInitializeEnumeration()</a>.
<p>
<pre class="fragment"><div>01871                    :
01872 
01873     This routine advances <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration of a <span class="keyword">virtual</span> directory by one entry.
01874 
01875 Arguments:
01876 
01877     Fcb - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory being enumerated.
01878     
01879     CompoundDirContext - a corresponding context <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration.
01880 
01881 Return Value:
01882 
01883     BOOLEAN True <span class="keywordflow">if</span> another Fid <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> avaliable, False <span class="keywordflow">if</span> we are at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end.
01884 
01885 --*/
01886 
01887 {
01888     ULONG Advance;
01889     BOOLEAN Result;
01890 
01891     <span class="comment">//</span>
01892     <span class="comment">//  Advance from the synthesized to the physical directory.</span>
01893     <span class="comment">//</span>
01894     
01895     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/dirctrl_8c.html#a10">UdfIsFileIndexVirtual</a>( CompoundDirContext-&gt;FileIndex.QuadPart )) {
01896 
01897         Result = <a class="code" href="../../d3/d8/udfprocs_8h.html#a169">UdfLookupInitialDirEntry</a>( IrpContext,
01898                                            Fcb,
01899                                            &amp;CompoundDirContext-&gt;DirContext,
01900                                            NULL );
01901         
01902         <span class="keywordflow">if</span> (Result) {
01903             
01904             CompoundDirContext-&gt;FileIndex.QuadPart = <a class="code" href="../../d1/d8/dirctrl_8c.html#a3">UDF_FILE_INDEX_PHYSICAL</a>;
01905         }
01906 
01907         <span class="keywordflow">return</span> Result;
01908     }
01909     
01910     Advance = <a class="code" href="../../d0/d7/iso13346_8h.html#a87">ISONsrFidSize</a>( CompoundDirContext-&gt;DirContext.Fid );
01911     
01912     <span class="comment">//</span>
01913     <span class="comment">//  Advance to the next entry in this directory.</span>
01914     <span class="comment">//</span>
01915     
01916     Result = <a class="code" href="../../d3/d8/udfprocs_8h.html#a170">UdfLookupNextDirEntry</a>( IrpContext, Fcb, &amp;CompoundDirContext-&gt;DirContext );
01917 
01918     <span class="keywordflow">if</span> (Result) {
01919 
01920         CompoundDirContext-&gt;FileIndex.QuadPart += Advance;
01921     }
01922     
01923     <span class="keywordflow">return</span> Result;
01924 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="dirctrl.c::UdfNotifyChangeDirectory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfNotifyChangeDirectory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpSp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d9/struct__CCB.html">PCCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Ccb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00904">904</a> of file <a class="el" href="../../d2/d7/dirctrl_8c-source.html">dirctrl.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00501">BooleanFlagOn</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00547">FsRtlNotifyFullChangeDirectory()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01235">IRP_CONTEXT_FLAG_WAIT</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01904">SL_WATCH_TREE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01518">UdfAcquireVcbShared</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01521">UdfReleaseVcb</a>, and <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00603">UdfVerifyVcb()</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00255">UdfCommonDirControl()</a>.
<p>
<pre class="fragment"><div>00913                    :
00914 
00915     This routine performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify change directory operation.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00916     responsible <span class="keywordflow">for</span> either completing of enqueuing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>.  Although there
00917     will never be a notify signalled on a readonly disk we still support <span class="keyword">this</span> call.
00918 
00919     We have already checked that <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not an OpenById handle.
00920 
00921 Arguments:
00922 
00923     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to process
00924 
00925     IrpSp - Io stack location <span class="keywordflow">for</span> <span class="keyword">this</span> request.
00926 
00927     Ccb - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory being watched.
00928 
00929 Return Value:
00930 
00931     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - STATUS_PENDING, any other error will raise.
00932 
00933 --*/
00934 
00935 {
00936     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00937 
00938     <span class="comment">//</span>
00939     <span class="comment">//  Always set the wait bit in the IrpContext so the initial wait can't fail.</span>
00940     <span class="comment">//</span>
00941 
00942     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_WAIT );
00943 
00944     <span class="comment">//</span>
00945     <span class="comment">//  Acquire the Vcb shared.</span>
00946     <span class="comment">//</span>
00947 
00948     <a class="code" href="../../d3/d8/udfprocs_8h.html#a75">UdfAcquireVcbShared</a>( IrpContext, IrpContext-&gt;Vcb, FALSE );
00949 
00950     <span class="comment">//</span>
00951     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00952     <span class="comment">//</span>
00953 
00954     <span class="keywordflow">try</span> {
00955 
00956         <span class="comment">//</span>
00957         <span class="comment">//  Verify the Vcb.</span>
00958         <span class="comment">//</span>
00959 
00960         <a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a5">UdfVerifyVcb</a>( IrpContext, IrpContext-&gt;Vcb );
00961 
00962         <span class="comment">//</span>
00963         <span class="comment">//  Call the Fsrtl package to process the request.  We cast the</span>
00964         <span class="comment">//  unicode strings to ansi strings as the dir notify package</span>
00965         <span class="comment">//  only deals with memory matching.</span>
00966         <span class="comment">//</span>
00967 
00968         <a class="code" href="../../d1/d8/fsrtl_8h.html#a172">FsRtlNotifyFullChangeDirectory</a>( IrpContext-&gt;Vcb-&gt;NotifySync,
00969                                         &amp;IrpContext-&gt;Vcb-&gt;DirNotifyList,
00970                                         Ccb,
00971                                         (PSTRING) &amp;IrpSp-&gt;FileObject-&gt;FileName,
00972                                         <a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>( IrpSp-&gt;Flags, SL_WATCH_TREE ),
00973                                         FALSE,
00974                                         IrpSp-&gt;Parameters.NotifyDirectory.CompletionFilter,
00975                                         Irp,
00976                                         NULL,
00977                                         NULL );
00978 
00979     } finally {
00980 
00981         <span class="comment">//</span>
00982         <span class="comment">//  Release the Vcb.</span>
00983         <span class="comment">//</span>
00984 
00985         <a class="code" href="../../d3/d8/udfprocs_8h.html#a76">UdfReleaseVcb</a>( IrpContext, IrpContext-&gt;Vcb );
00986     }
00987 
00988     <span class="comment">//</span>
00989     <span class="comment">//  Cleanup the IrpContext.</span>
00990     <span class="comment">//</span>
00991 
00992     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, NULL, STATUS_SUCCESS );
00993 
00994     <span class="keywordflow">return</span> STATUS_PENDING;
00995 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="dirctrl.c::UdfPhysicalOffsetToFileIndex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE LONGLONG UdfPhysicalOffsetToFileIndex           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">LONGLONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PhysicalOffset</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00161">161</a> of file <a class="el" href="../../d2/d7/dirctrl_8c-source.html">dirctrl.c</a>.
<p>
References <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00088">UDF_FILE_INDEX_PHYSICAL</a>.
<p>
<pre class="fragment"><div>00164 {
00165 
00166     <span class="keywordflow">return</span> PhysicalOffset + <a class="code" href="../../d1/d8/dirctrl_8c.html#a3">UDF_FILE_INDEX_PHYSICAL</a>;
00167 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="dirctrl.c::UdfQueryDirectory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfQueryDirectory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpSp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d9/struct__CCB.html">PCCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Ccb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00334">334</a> of file <a class="el" href="../../d2/d7/dirctrl_8c-source.html">dirctrl.c</a>.
<p>
References <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00184">_TIMESTAMP_BUNDLE::AccessTime</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01527">_ICB_SEARCH_CONTEXT::Active</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00205">BYTE_COUNT_8_DOT_3</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01666">_DIR_ENUM_CONTEXT::CaseObjectName</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01140">CCB_FLAG_ENUM_RETURN_NEXT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00183">_TIMESTAMP_BUNDLE::CreationTime</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01699">DIR_CONTEXT_FLAG_SEEN_NONCONSTANT</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00053">_COMPOUND_DIR_ENUM_CONTEXT::DirContext</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00056">EXCEPTION_CONTINUE_SEARCH</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01646">_DIR_ENUM_CONTEXT::Fid</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00066">_COMPOUND_DIR_ENUM_CONTEXT::FileIndex</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00047">FileName</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00847">ICBTAG::FileType</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01658">_DIR_ENUM_CONTEXT::Flags</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00783">NSR_FID::Flags</a>, <a class="el" href="../../d8/d2/fsrtl_2filter_8c-source.html#l00082">FsRtlIsNtstatusExpected()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00054">_COMPOUND_DIR_ENUM_CONTEXT::IcbContext</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00937">ICBFILE::Icbtag</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00868">ICBTAG_FILE_T_DIRECTORY</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00945">ICBFILE::InfoLength</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00248">LlBlockAlign</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00185">_TIMESTAMP_BUNDLE::ModificationTime</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00810">NSR_FID_F_HIDDEN</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00048">NT_ERROR</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01665">_DIR_ENUM_CONTEXT::ObjectName</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d7/iso13346_8h.html#a246">PICBFILE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01672">_DIR_ENUM_CONTEXT::PureObjectName</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00513">QuadAlign</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01678">_DIR_ENUM_CONTEXT::ShortObjectName</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00060">_COMPOUND_DIR_ENUM_CONTEXT::Timestamps</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00436">try_leave</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01533">UdfAcquireFileShared</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00112">UdfCleanupCompoundDirContext()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01500">UdfEnumerateIndex()</a>, <a class="el" href="../../d6/d4/namesup_8c-source.html#l00389">UdfGenerate8dot3Name()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00096">UdfInitializeCompoundDirContext()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01003">UdfInitializeEnumeration()</a>, <a class="el" href="../../d6/d4/namesup_8c-source.html#l00176">UdfIs8dot3Name()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01567">UdfLockFcb</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01688">UdfLookupFileEntryInEnumeration()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00902">UdfMapUserBuffer</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01539">UdfReleaseFile</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01577">UdfUnlockFcb</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03595">UdfUpdateTimestampsFromIcbContext()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00760">UdfVerifyFcbOperation()</a>, and <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01486">_MAPPED_PVIEW::View</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00255">UdfCommonDirControl()</a>.
<p>
<pre class="fragment"><div>00344                    :
00345 
00346     This routine performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query directory operation.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> responsible
00347     <span class="keywordflow">for</span> either completing of enqueuing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>.  We store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00348     search in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Ccb.
00349 
00350 Arguments:
00351 
00352     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to process
00353 
00354     IrpSp - Stack location <span class="keywordflow">for</span> <span class="keyword">this</span> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>.
00355 
00356     Fcb - Fcb <span class="keywordflow">for</span> <span class="keyword">this</span> directory.
00357 
00358     Ccb - Ccb <span class="keywordflow">for</span> <span class="keyword">this</span> directory open.
00359 
00360 Return Value:
00361 
00362     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The <span class="keywordflow">return</span> status <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation
00363 
00364 --*/
00365 
00366 {
00367     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00368     ULONG Information = 0;
00369 
00370     ULONG LastEntry = 0;
00371     ULONG NextEntry = 0;
00372 
00373     ULONG FileNameBytes;
00374     ULONG BytesConverted;
00375 
00376     <a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html">COMPOUND_DIR_ENUM_CONTEXT</a> CompoundDirContext;
00377 
00378     <a class="code" href="../../d1/d2/structNSR__FID.html">PNSR_FID</a> ThisFid;
00379     <a class="code" href="../../d8/d0/structICBFILE.html">PICBFILE</a> ThisFe;
00380     
00381     BOOLEAN InitialQuery;
00382     BOOLEAN ReturnNextEntry;
00383     BOOLEAN ReturnSingleEntry;
00384     BOOLEAN Found;
00385 
00386     PCHAR UserBuffer;
00387     ULONG BytesRemainingInBuffer;
00388 
00389     ULONG BaseLength;
00390 
00391     PFILE_BOTH_DIR_INFORMATION DirInfo;
00392     PFILE_NAMES_INFORMATION NamesInfo;
00393 
00394     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00395 
00396     <span class="comment">//</span>
00397     <span class="comment">//  Check if we support this search mode.  Also remember the size of the base part of</span>
00398     <span class="comment">//  each of these structures.</span>
00399     <span class="comment">//</span>
00400 
00401     <span class="keywordflow">switch</span> (IrpSp-&gt;Parameters.QueryDirectory.FileInformationClass) {
00402 
00403     <span class="keywordflow">case</span> FileDirectoryInformation:
00404 
00405         BaseLength = FIELD_OFFSET( FILE_DIRECTORY_INFORMATION,
00406                                    FileName[0] );
00407         <span class="keywordflow">break</span>;
00408 
00409     <span class="keywordflow">case</span> FileFullDirectoryInformation:
00410 
00411         BaseLength = FIELD_OFFSET( FILE_FULL_DIR_INFORMATION,
00412                                    FileName[0] );
00413         <span class="keywordflow">break</span>;
00414 
00415     <span class="keywordflow">case</span> FileNamesInformation:
00416 
00417         BaseLength = FIELD_OFFSET( FILE_NAMES_INFORMATION,
00418                                    FileName[0] );
00419         <span class="keywordflow">break</span>;
00420 
00421     <span class="keywordflow">case</span> FileBothDirectoryInformation:
00422 
00423         BaseLength = FIELD_OFFSET( FILE_BOTH_DIR_INFORMATION,
00424                                    FileName[0] );
00425         <span class="keywordflow">break</span>;
00426 
00427     <span class="keywordflow">default</span>:
00428 
00429         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_INVALID_INFO_CLASS );
00430         <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
00431     }
00432 
00433     <span class="comment">//</span>
00434     <span class="comment">//  Get the user buffer.</span>
00435     <span class="comment">//</span>
00436 
00437     <a class="code" href="../../d3/d8/udfprocs_8h.html#a70">UdfMapUserBuffer</a>( IrpContext, &amp;UserBuffer);
00438 
00439     <span class="comment">//</span>
00440     <span class="comment">//  Initialize our search context.</span>
00441     <span class="comment">//</span>
00442 
00443     <a class="code" href="../../d1/d8/dirctrl_8c.html#a6">UdfInitializeCompoundDirContext</a>( IrpContext, &amp;CompoundDirContext );
00444     
00445     <span class="comment">//</span>
00446     <span class="comment">//  Acquire the directory.</span>
00447     <span class="comment">//</span>
00448 
00449     <a class="code" href="../../d3/d8/udfprocs_8h.html#a80">UdfAcquireFileShared</a>( IrpContext, Fcb );
00450 
00451     <span class="comment">//</span>
00452     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00453     <span class="comment">//</span>
00454 
00455     <span class="keywordflow">try</span> {
00456 
00457         <span class="comment">//</span>
00458         <span class="comment">//  Verify the Fcb is still good.</span>
00459         <span class="comment">//</span>
00460 
00461         <a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a6">UdfVerifyFcbOperation</a>( IrpContext, Fcb );
00462 
00463         <span class="comment">//</span>
00464         <span class="comment">//  Start by getting the initial state for the enumeration.  This will set up the Ccb with</span>
00465         <span class="comment">//  the initial search parameters and let us know the starting offset in the directory</span>
00466         <span class="comment">//  to search.</span>
00467         <span class="comment">//</span>
00468 
00469         <a class="code" href="../../d1/d8/dirctrl_8c.html#a13">UdfInitializeEnumeration</a>( IrpContext,
00470                                   IrpSp,
00471                                   Fcb,
00472                                   Ccb,
00473                                   &amp;CompoundDirContext,
00474                                   &amp;ReturnNextEntry,
00475                                   &amp;ReturnSingleEntry,
00476                                   &amp;InitialQuery );
00477 
00478         <span class="comment">//</span>
00479         <span class="comment">//  At this point we are about to enter our query loop.  We have</span>
00480         <span class="comment">//  determined the index into the directory file to begin the</span>
00481         <span class="comment">//  search.  LastEntry and NextEntry are used to index into the user</span>
00482         <span class="comment">//  buffer.  LastEntry is the last entry we've added, NextEntry is</span>
00483         <span class="comment">//  current one we're working on.  If NextEntry is non-zero, then</span>
00484         <span class="comment">//  at least one entry was added.</span>
00485         <span class="comment">//</span>
00486 
00487         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00488 
00489             <span class="comment">//</span>
00490             <span class="comment">//  If the user had requested only a single match and we have</span>
00491             <span class="comment">//  returned that, then we stop at this point.  We update the Ccb with</span>
00492             <span class="comment">//  the status based on the last entry returned.</span>
00493             <span class="comment">//</span>
00494 
00495             <span class="keywordflow">if</span> ((NextEntry != 0) &amp;&amp; ReturnSingleEntry) {
00496 
00497                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status );
00498             }
00499 
00500             <span class="comment">//</span>
00501             <span class="comment">//  We try to locate the next matching dirent.  Our search if based on a starting</span>
00502             <span class="comment">//  dirent offset, whether we should return the current or next entry, whether</span>
00503             <span class="comment">//  we should be doing a short name search and finally whether we should be</span>
00504             <span class="comment">//  checking for a version match.</span>
00505             <span class="comment">//</span>
00506 
00507             Found = <a class="code" href="../../d1/d8/dirctrl_8c.html#a14">UdfEnumerateIndex</a>( IrpContext, Ccb, &amp;CompoundDirContext, ReturnNextEntry );
00508 
00509             <span class="comment">//</span>
00510             <span class="comment">//  Initialize the value for the next search.</span>
00511             <span class="comment">//</span>
00512 
00513             ReturnNextEntry = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00514 
00515             <span class="comment">//</span>
00516             <span class="comment">//  If we didn't receive a dirent, then we are at the end of the</span>
00517             <span class="comment">//  directory.  If we have returned any files, we exit with</span>
00518             <span class="comment">//  success, otherwise we return STATUS_NO_MORE_FILES.</span>
00519             <span class="comment">//</span>
00520 
00521             <span class="keywordflow">if</span> (!Found) {
00522 
00523                 <span class="keywordflow">if</span> (NextEntry == 0) {
00524 
00525                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MORE_FILES;
00526 
00527                     <span class="keywordflow">if</span> (InitialQuery) {
00528 
00529                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_SUCH_FILE;
00530                     }
00531                 }
00532 
00533                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status );
00534             }
00535 
00536             <span class="comment">//</span>
00537             <span class="comment">//  Remember the dirent/file entry for the file we just found.</span>
00538             <span class="comment">//</span>
00539 
00540             ThisFid = CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o0">DirContext</a>.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o5">Fid</a>;
00541 
00542             <span class="comment">//</span>
00543             <span class="comment">//  Here are the rules concerning filling up the buffer:</span>
00544             <span class="comment">//</span>
00545             <span class="comment">//  1.  The Io system garentees that there will always be</span>
00546             <span class="comment">//      enough room for at least one base record.</span>
00547             <span class="comment">//</span>
00548             <span class="comment">//  2.  If the full first record (including file name) cannot</span>
00549             <span class="comment">//      fit, as much of the name as possible is copied and</span>
00550             <span class="comment">//      STATUS_BUFFER_OVERFLOW is returned.</span>
00551             <span class="comment">//</span>
00552             <span class="comment">//  3.  If a subsequent record cannot completely fit into the</span>
00553             <span class="comment">//      buffer, none of it (as in 0 bytes) is copied, and</span>
00554             <span class="comment">//      STATUS_SUCCESS is returned.  A subsequent query will</span>
00555             <span class="comment">//      pick up with this record.</span>
00556             <span class="comment">//</span>
00557 
00558             <span class="comment">//</span>
00559             <span class="comment">//  We can look directly at the dirent that we found.</span>
00560             <span class="comment">//</span>
00561 
00562             FileNameBytes = CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o0">DirContext</a>.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o9">CaseObjectName</a>.Length;
00563 
00564             <span class="comment">//</span>
00565             <span class="comment">//  If the slot for the next entry would be beyond the length of the</span>
00566             <span class="comment">//  user's buffer just exit (we know we've returned at least one entry</span>
00567             <span class="comment">//  already). This will happen when we align the pointer past the end.</span>
00568             <span class="comment">//</span>
00569 
00570             <span class="keywordflow">if</span> (NextEntry &gt; IrpSp-&gt;Parameters.QueryDirectory.Length) {
00571 
00572                 ReturnNextEntry = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00573                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_SUCCESS );
00574             }
00575 
00576             <span class="comment">//</span>
00577             <span class="comment">//  Compute the number of bytes remaining in the buffer.  Round this</span>
00578             <span class="comment">//  down to a WCHAR boundary so we can copy full characters.</span>
00579             <span class="comment">//</span>
00580 
00581             BytesRemainingInBuffer = IrpSp-&gt;Parameters.QueryDirectory.Length - NextEntry;
00582             <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( BytesRemainingInBuffer, 1 );
00583 
00584             <span class="comment">//</span>
00585             <span class="comment">//  If this won't fit and we have returned a previous entry then just</span>
00586             <span class="comment">//  return STATUS_SUCCESS.</span>
00587             <span class="comment">//</span>
00588 
00589             <span class="keywordflow">if</span> ((BaseLength + FileNameBytes) &gt; BytesRemainingInBuffer) {
00590 
00591                 <span class="comment">//</span>
00592                 <span class="comment">//  If we already found an entry then just exit.</span>
00593                 <span class="comment">//</span>
00594 
00595                 <span class="keywordflow">if</span> (NextEntry != 0) {
00596 
00597                     ReturnNextEntry = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00598                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_SUCCESS );
00599                 }
00600 
00601                 <span class="comment">//</span>
00602                 <span class="comment">//  Reduce the FileNameBytes to just fit in the buffer.</span>
00603                 <span class="comment">//</span>
00604 
00605                 FileNameBytes = BytesRemainingInBuffer - BaseLength;
00606 
00607                 <span class="comment">//</span>
00608                 <span class="comment">//  Use a status code of STATUS_BUFFER_OVERFLOW.  Also set</span>
00609                 <span class="comment">//  ReturnSingleEntry so that we will exit the loop at the top.</span>
00610                 <span class="comment">//</span>
00611 
00612                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_OVERFLOW;
00613                 ReturnSingleEntry = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00614             }
00615 
00616             <span class="comment">//</span>
00617             <span class="comment">//  Protect access to the user buffer with an exception handler.</span>
00618             <span class="comment">//  Since (at our request) IO doesn't buffer these requests, we have</span>
00619             <span class="comment">//  to guard against a user messing with the page protection and other</span>
00620             <span class="comment">//  such trickery.</span>
00621             <span class="comment">//</span>
00622 
00623             <span class="keywordflow">try</span> {
00624                 
00625                 <span class="comment">//</span>
00626                 <span class="comment">//  Zero and initialize the base part of the current entry.</span>
00627                 <span class="comment">//</span>
00628 
00629                 RtlZeroMemory( <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( UserBuffer, NextEntry, PVOID ),
00630                                BaseLength );
00631     
00632                 <span class="comment">//</span>
00633                 <span class="comment">//  Now we have an entry to return to our caller.</span>
00634                 <span class="comment">//  We'll case on the type of information requested and fill up</span>
00635                 <span class="comment">//  the user buffer if everything fits.</span>
00636                 <span class="comment">//</span>
00637     
00638                 <span class="keywordflow">switch</span> (IrpSp-&gt;Parameters.QueryDirectory.FileInformationClass) {
00639     
00640                 <span class="keywordflow">case</span> FileBothDirectoryInformation:
00641                 <span class="keywordflow">case</span> FileFullDirectoryInformation:
00642                 <span class="keywordflow">case</span> FileDirectoryInformation:
00643     
00644                     DirInfo = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( UserBuffer, NextEntry, PFILE_BOTH_DIR_INFORMATION );
00645     
00646                     <span class="comment">//</span>
00647                     <span class="comment">//  These information types require we look up the file entry.</span>
00648                     <span class="comment">//</span>
00649                     
00650                     <a class="code" href="../../d1/d8/dirctrl_8c.html#a15">UdfLookupFileEntryInEnumeration</a>( IrpContext,
00651                                                      Fcb,
00652                                                      &amp;CompoundDirContext );
00653                     <span class="comment">//</span>
00654                     <span class="comment">//  Directly reference the file entry we just looked up.</span>
00655                     <span class="comment">//</span>
00656                     
00657                     ThisFe = (<a class="code" href="../../d8/d0/structICBFILE.html">PICBFILE</a>) CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o1">IcbContext</a>.<a class="code" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html#o2">Active</a>.<a class="code" href="../../d6/d6/struct__MAPPED__PVIEW.html#o0">View</a>;
00658                     
00659                     <span class="comment">//</span>
00660                     <span class="comment">//  Now go gather all of the timestamps for this guy.</span>
00661                     <span class="comment">//</span>
00662             
00663                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a226">UdfUpdateTimestampsFromIcbContext</a> ( IrpContext,
00664                                                         &amp;CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o1">IcbContext</a>,
00665                                                         &amp;CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o2">Timestamps</a> );
00666                     
00667                     DirInfo-&gt;CreationTime = CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o2">Timestamps</a>.<a class="code" href="../../d4/d1/struct__TIMESTAMP__BUNDLE.html#o0">CreationTime</a>;
00668     
00669                     DirInfo-&gt;LastWriteTime =
00670                     DirInfo-&gt;ChangeTime = CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o2">Timestamps</a>.<a class="code" href="../../d4/d1/struct__TIMESTAMP__BUNDLE.html#o2">ModificationTime</a>;
00671     
00672                     DirInfo-&gt;LastAccessTime = CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o2">Timestamps</a>.<a class="code" href="../../d4/d1/struct__TIMESTAMP__BUNDLE.html#o1">AccessTime</a>;
00673     
00674                     <span class="comment">//</span>
00675                     <span class="comment">//  Set the attributes and sizes separately for directories and</span>
00676                     <span class="comment">//  files.</span>
00677                     <span class="comment">//</span>
00678     
00679                     <span class="keywordflow">if</span> (ThisFe-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o1">Icbtag</a>.<a class="code" href="../../d1/d1/structICBTAG.html#o5">FileType</a> == <a class="code" href="../../d0/d7/iso13346_8h.html#a102">ICBTAG_FILE_T_DIRECTORY</a>) {
00680     
00681                         DirInfo-&gt;EndOfFile.QuadPart = DirInfo-&gt;AllocationSize.QuadPart = 0;
00682     
00683                         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( DirInfo-&gt;FileAttributes, FILE_ATTRIBUTE_DIRECTORY );
00684     
00685                     } <span class="keywordflow">else</span> {
00686     
00687                         DirInfo-&gt;EndOfFile.QuadPart = ThisFe-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o9">InfoLength</a>;
00688                         DirInfo-&gt;AllocationSize.QuadPart = <a class="code" href="../../d3/d8/udfprocs_8h.html#a46">LlBlockAlign</a>( Fcb-&gt;Vcb, ThisFe-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o9">InfoLength</a> );
00689                     }
00690 
00691                     <span class="comment">//</span>
00692                     <span class="comment">//  All Cdrom files are readonly.  We also copy the existence</span>
00693                     <span class="comment">//  bit to the hidden attribute, assuming that synthesized FIDs</span>
00694                     <span class="comment">//  are never hidden.</span>
00695                     <span class="comment">//</span>
00696 
00697                     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( DirInfo-&gt;FileAttributes, FILE_ATTRIBUTE_READONLY );
00698     
00699                     <span class="keywordflow">if</span> (ThisFid &amp;&amp; <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ThisFid-&gt;<a class="code" href="../../d1/d2/structNSR__FID.html#o2">Flags</a>, NSR_FID_F_HIDDEN )) {
00700     
00701                         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( DirInfo-&gt;FileAttributes, FILE_ATTRIBUTE_HIDDEN );
00702                     }
00703     
00704                     <span class="comment">//</span>
00705                     <span class="comment">//  The file index for real file indices &gt; 2^32 is zero.  When asked to</span>
00706                     <span class="comment">//  restart at an index of zero, we will know to use a stashed starting</span>
00707                     <span class="comment">//  point to beging to search, by name, for the correct restart point.</span>
00708                     <span class="comment">//</span>
00709                     
00710                     <span class="keywordflow">if</span> (CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o3">FileIndex</a>.HighPart == 0) {
00711                         
00712                         DirInfo-&gt;FileIndex = CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o3">FileIndex</a>.LowPart;
00713                     
00714                     } <span class="keywordflow">else</span> {
00715     
00716                         DirInfo-&gt;FileIndex = 0;
00717                     }
00718     
00719                     DirInfo-&gt;FileNameLength = FileNameBytes;
00720     
00721                     <span class="keywordflow">break</span>;
00722     
00723                 <span class="keywordflow">case</span> FileNamesInformation:
00724     
00725                     NamesInfo = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( UserBuffer, NextEntry, PFILE_NAMES_INFORMATION );
00726     
00727                     <span class="keywordflow">if</span> (CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o3">FileIndex</a>.HighPart == 0) {
00728                         
00729                         NamesInfo-&gt;FileIndex = CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o3">FileIndex</a>.LowPart;
00730                     
00731                     } <span class="keywordflow">else</span> {
00732     
00733                         NamesInfo-&gt;FileIndex = 0;
00734                     }
00735     
00736                     NamesInfo-&gt;FileNameLength = FileNameBytes;
00737     
00738                     <span class="keywordflow">break</span>;
00739                 }
00740 
00741                 <span class="comment">//</span>
00742                 <span class="comment">//  Now copy as much of the name as possible.</span>
00743                 <span class="comment">//</span>
00744     
00745                 <span class="keywordflow">if</span> (FileNameBytes != 0) {
00746     
00747                     <span class="comment">//</span>
00748                     <span class="comment">//  This is a Unicode name, we can copy the bytes directly.</span>
00749                     <span class="comment">//</span>
00750     
00751                     RtlCopyMemory( <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( UserBuffer, NextEntry + BaseLength, PVOID ),
00752                                    CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o0">DirContext</a>.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o8">ObjectName</a>.Buffer,
00753                                    FileNameBytes );
00754                 }
00755 
00756                 <span class="comment">//</span>
00757                 <span class="comment">//  Fill in the short name if we got STATUS_SUCCESS.  The short name</span>
00758                 <span class="comment">//  may already be in the file context, otherwise we will check</span>
00759                 <span class="comment">//  whether the long name is 8.3.  Special case the self and parent</span>
00760                 <span class="comment">//  directory names.</span>
00761                 <span class="comment">//</span>
00762     
00763                 <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) &amp;&amp;
00764                     (IrpSp-&gt;Parameters.QueryDirectory.FileInformationClass == FileBothDirectoryInformation) &amp;&amp;
00765                     <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o0">DirContext</a>.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o7">Flags</a>, DIR_CONTEXT_FLAG_SEEN_NONCONSTANT )) {
00766     
00767                     <span class="comment">//</span>
00768                     <span class="comment">//  If we already have the short name then copy into the user's buffer.</span>
00769                     <span class="comment">//</span>
00770     
00771                     <span class="keywordflow">if</span> (CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o0">DirContext</a>.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o11">ShortObjectName</a>.Length != 0) {
00772     
00773                         RtlCopyMemory( DirInfo-&gt;ShortName,
00774                                        CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o0">DirContext</a>.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o11">ShortObjectName</a>.Buffer,
00775                                        CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o0">DirContext</a>.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o11">ShortObjectName</a>.Length );
00776     
00777                         DirInfo-&gt;ShortNameLength = (CCHAR) CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o0">DirContext</a>.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o11">ShortObjectName</a>.Length;
00778     
00779                     <span class="comment">//</span>
00780                     <span class="comment">//  If the short name length is currently zero then check if</span>
00781                     <span class="comment">//  the long name is not 8.3.  We can copy the short name in</span>
00782                     <span class="comment">//  unicode form directly into the caller's buffer.</span>
00783                     <span class="comment">//</span>
00784     
00785                     } <span class="keywordflow">else</span> {
00786     
00787                         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d8/udfprocs_8h.html#a178">UdfIs8dot3Name</a>( IrpContext,
00788                                              CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o0">DirContext</a>.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o8">ObjectName</a> )) {
00789     
00790                             UNICODE_STRING ShortName;
00791     
00792                             ShortName.Buffer = DirInfo-&gt;ShortName;
00793                             ShortName.MaximumLength = <a class="code" href="../../d9/d7/udf_8h.html#a11">BYTE_COUNT_8_DOT_3</a>;
00794                             
00795                             <a class="code" href="../../d3/d8/udfprocs_8h.html#a180">UdfGenerate8dot3Name</a>( IrpContext,
00796                                                   &amp;CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o0">DirContext</a>.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o10">PureObjectName</a>,
00797                                                   &amp;ShortName );
00798     
00799                             DirInfo-&gt;ShortNameLength = (CCHAR) ShortName.Length;
00800                         }
00801                     }
00802                 }
00803 
00804                 <span class="comment">//</span>
00805                 <span class="comment">//  Update the information with the number of bytes stored in the</span>
00806                 <span class="comment">//  buffer.  We quad-align the existing buffer to add any necessary</span>
00807                 <span class="comment">//  pad bytes.</span>
00808                 <span class="comment">//</span>
00809 
00810                 Information = NextEntry + BaseLength + FileNameBytes;
00811 
00812                 <span class="comment">//</span>
00813                 <span class="comment">//  Go back to the previous entry and fill in the update to this entry.</span>
00814                 <span class="comment">//</span>
00815 
00816                 *(<a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( UserBuffer, LastEntry, PULONG )) = NextEntry - LastEntry;
00817 
00818                 <span class="comment">//</span>
00819                 <span class="comment">//  Set up our variables for the next dirent.</span>
00820                 <span class="comment">//</span>
00821 
00822                 InitialQuery = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00823 
00824                 LastEntry = NextEntry;
00825                 NextEntry = <a class="code" href="../../d5/d5/cc_8h.html#a62">QuadAlign</a>( Information );
00826             
00827             } except (!<a class="code" href="../../d1/d8/fsrtl_8h.html#a137">FsRtlIsNtstatusExpected</a>(GetExceptionCode()) ?
00828                       EXCEPTION_EXECUTE_HANDLER : EXCEPTION_CONTINUE_SEARCH) {
00829 
00830                   <span class="comment">//</span>
00831                   <span class="comment">//  We must have had a problem filling in the user's buffer, so stop</span>
00832                   <span class="comment">//  and fail this request.</span>
00833                   <span class="comment">//</span>
00834                   
00835                   Information = 0;
00836                   <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = GetExceptionCode());
00837             }
00838         }
00839 
00840     } finally {
00841 
00842         <span class="keywordflow">if</span> (!AbnormalTermination() &amp;&amp; !<a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>( Status )) {
00843         
00844             <span class="comment">//</span>
00845             <span class="comment">//  Update the Ccb to show the current state of the enumeration.</span>
00846             <span class="comment">//</span>
00847     
00848             <a class="code" href="../../d3/d8/udfprocs_8h.html#a90">UdfLockFcb</a>( IrpContext, Fcb );
00849     
00850             Ccb-&gt;CurrentFileIndex = CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o3">FileIndex</a>.QuadPart;
00851 
00852             <span class="comment">//</span>
00853             <span class="comment">//  Update our notion of a high 32bit file index.  We only do this once to avoid the hit</span>
00854             <span class="comment">//  of thrashing the Fcb mutex to do this for every entry.  If it is ever neccesary to use</span>
00855             <span class="comment">//  this information, the difference of a few dozen entries from the optimal pick-up point</span>
00856             <span class="comment">//  will be trivial.</span>
00857             <span class="comment">//</span>
00858             
00859             <span class="keywordflow">if</span> (CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o3">FileIndex</a>.HighPart == 0 &amp;&amp;
00860                 CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o3">FileIndex</a>.LowPart &gt; Ccb-&gt;HighestReturnableFileIndex) {
00861 
00862                     Ccb-&gt;HighestReturnableFileIndex = CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o3">FileIndex</a>.LowPart;
00863             }
00864             
00865             <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Ccb-&gt;Flags, CCB_FLAG_ENUM_RETURN_NEXT );
00866     
00867             <span class="keywordflow">if</span> (ReturnNextEntry) {
00868     
00869                 <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Ccb-&gt;Flags, CCB_FLAG_ENUM_RETURN_NEXT );
00870             }
00871     
00872             <a class="code" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>( IrpContext, Fcb );
00873         }
00874 
00875         <span class="comment">//</span>
00876         <span class="comment">//  Cleanup our search context.</span>
00877         <span class="comment">//</span>
00878 
00879         <a class="code" href="../../d1/d8/dirctrl_8c.html#a7">UdfCleanupCompoundDirContext</a>( IrpContext, &amp;CompoundDirContext );
00880 
00881         <span class="comment">//</span>
00882         <span class="comment">//  Release the Fcb.</span>
00883         <span class="comment">//</span>
00884 
00885         <a class="code" href="../../d3/d8/udfprocs_8h.html#a82">UdfReleaseFile</a>( IrpContext, Fcb );
00886     }
00887 
00888     <span class="comment">//</span>
00889     <span class="comment">//  Complete the request here.</span>
00890     <span class="comment">//</span>
00891 
00892     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = Information;
00893 
00894     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, Status );
00895     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00896 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:27 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
