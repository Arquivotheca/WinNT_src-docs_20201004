<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: wmicon.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>wmicon.c</h1><a href="../../d0/d9/wmicon_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/***************************************************************************\</span>
00002 <span class="comment">* Module Name: wmicon.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Icon Drawing Routines</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* 22-Jan-1991 MikeKe  from win30</span>
00009 <span class="comment">* 13-Jan-1994 JohnL   rewrote from Chicago (m5)</span>
00010 <span class="comment">\***************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
<a name="l00015"></a><a class="code" href="../../d0/d9/wmicon_8c.html#a0">00015</a> <span class="preprocessor">#define SetBestStretchMode(hdc, bpp, fHT)                                \</span>
00016 <span class="preprocessor">    GreSetStretchBltMode(hdc,                                            \</span>
00017 <span class="preprocessor">                         (fHT ? HALFTONE :                               \</span>
00018 <span class="preprocessor">                             ((bpp) == 1 ? BLACKONWHITE : COLORONCOLOR)))</span>
00019 <span class="preprocessor"></span>
<a name="l00020"></a><a class="code" href="../../d0/d9/wmicon_8c.html#a1">00020</a> <span class="preprocessor">#define GetCWidth(cxOrg, lrF, cxDes) \</span>
00021 <span class="preprocessor">    (cxOrg ? cxOrg : ((lrF &amp; DI_DEFAULTSIZE) ? SYSMET(CXICON) : cxDes))</span>
00022 <span class="preprocessor"></span>
<a name="l00023"></a><a class="code" href="../../d0/d9/wmicon_8c.html#a2">00023</a> <span class="preprocessor">#define GetCHeight(cyOrg, lrF, cyDes) \</span>
00024 <span class="preprocessor">    (cyOrg ? cyOrg : ((lrF &amp; DI_DEFAULTSIZE) ? SYSMET(CYICON) : cyDes))</span>
00025 <span class="preprocessor"></span>
00026 <span class="comment">/***************************************************************************\</span>
00027 <span class="comment">* BltIcon</span>
00028 <span class="comment">*</span>
00029 <span class="comment">*</span>
00030 <span class="comment">\***************************************************************************/</span>
00031 
<a name="l00032"></a><a class="code" href="../../d0/d9/wmicon_8c.html#a3">00032</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d9/wmicon_8c.html#a3">BltIcon</a>(
00033     HDC     hdc,
00034     <span class="keywordtype">int</span>     x,
00035     <span class="keywordtype">int</span>     y,
00036     <span class="keywordtype">int</span>     cx,
00037     <span class="keywordtype">int</span>     cy,
00038     HDC     hdcSrc,
00039     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcur,
00040     BOOL    fMask,
00041     LONG    rop)
00042 {
00043     HBITMAP hbmpSave;
00044     HBITMAP hbmpUse;
00045     LONG    rgbText;
00046     LONG    rgbBk;
00047     <span class="keywordtype">int</span>     nMode;
00048 
00049     <span class="comment">/*</span>
00050 <span class="comment">     * Setup the DC for drawing</span>
00051 <span class="comment">     */</span>
00052     hbmpUse = (fMask || !pcur-&gt;hbmColor ? pcur-&gt;hbmMask : pcur-&gt;hbmColor);
00053 
00054     rgbBk   = GreSetBkColor(hdc, 0x00FFFFFFL);
00055     rgbText = GreSetTextColor(hdc, 0x00000000L);
00056     nMode   = <a class="code" href="../../d6/d0/usercli_8h.html#a31">SetBestStretchMode</a>(hdc, pcur-&gt;bpp, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00057 
00058     hbmpSave = GreSelectBitmap(hdcSrc, hbmpUse);
00059 
00060     <span class="comment">/*</span>
00061 <span class="comment">     * Do the output to the surface.  By passing in (-1) as the background</span>
00062 <span class="comment">     * color, we are telling GDI to use the background-color already set</span>
00063 <span class="comment">     * in the DC.</span>
00064 <span class="comment">     */</span>
00065     GreStretchBlt(hdc,
00066                   x,
00067                   y,
00068                   cx,
00069                   <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
00070                   hdcSrc,
00071                   0,
00072                   (fMask || pcur-&gt;hbmColor ? 0 : pcur-&gt;cy / 2),
00073                   pcur-&gt;cx,
00074                   pcur-&gt;cy / 2,
00075                   rop,
00076                   (COLORREF)-1);
00077 
00078     GreSetStretchBltMode(hdc, nMode);
00079     GreSetTextColor(hdc, rgbText);
00080     GreSetBkColor(hdc, rgbBk);
00081 
00082     GreSelectBitmap(hdcSrc, hbmpSave);
00083 
00084     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00085 }
00086 
00087 <span class="comment">/***************************************************************************\</span>
00088 <span class="comment">* DrawIconEx</span>
00089 <span class="comment">*</span>
00090 <span class="comment">* Draws icon in desired size.</span>
00091 <span class="comment">*</span>
00092 <span class="comment">\***************************************************************************/</span>
<a name="l00093"></a><a class="code" href="../../d0/d9/wmicon_8c.html#a4">00093</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d9/wmicon_8c.html#a4">_DrawIconEx</a>(
00094     HDC     hdc,
00095     <span class="keywordtype">int</span>     x,
00096     <span class="keywordtype">int</span>     y,
00097     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcur,
00098     <span class="keywordtype">int</span>     cx,
00099     <span class="keywordtype">int</span>     cy,
00100     UINT    istepIfAniCur,
00101     HBRUSH  hbr,
00102     UINT    diFlags)
00103 {
00104     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00105 
00106     <span class="comment">/*</span>
00107 <span class="comment">     * If this is an animated cursor, just grab the ith frame and use it</span>
00108 <span class="comment">     * for drawing.</span>
00109 <span class="comment">     */</span>
00110     <span class="keywordflow">if</span> (pcur-&gt;CURSORF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a537">CURSORF_ACON</a>) {
00111 
00112         <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)istepIfAniCur &gt;= ((<a class="code" href="../../d1/d8/structtagACON.html">PACON</a>)pcur)-&gt;cicur) {
00113             RIPERR0(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"DrawIconEx, icon step out of range."</span>);
00114             <span class="keywordflow">goto</span> Done;
00115         }
00116 
00117         pcur = ((<a class="code" href="../../d1/d8/structtagACON.html">PACON</a>)pcur)-&gt;aspcur[((<a class="code" href="../../d1/d8/structtagACON.html">PACON</a>)pcur)-&gt;aicur[istepIfAniCur]];
00118     }
00119 
00120     <span class="comment">/*</span>
00121 <span class="comment">     * Setup defaults.</span>
00122 <span class="comment">     */</span>
00123     cx = <a class="code" href="../../d0/d9/wmicon_8c.html#a1">GetCWidth</a>(cx, diFlags, pcur-&gt;cx);
00124     <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = <a class="code" href="../../d0/d9/wmicon_8c.html#a2">GetCHeight</a>(<a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>, diFlags, (pcur-&gt;cy / 2));
00125 
00126     <span class="keywordflow">if</span> (hbr) {
00127 
00128         HBITMAP    hbmpT = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00129         HDC        hdcT;
00130         HBITMAP    hbmpOld;
00131         POLYPATBLT PolyData;
00132 
00133         <span class="keywordflow">if</span> (hdcT = GreCreateCompatibleDC(hdc)) {
00134 
00135             <span class="keywordflow">if</span> (hbmpT = GreCreateCompatibleBitmap(hdc, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>)) {
00136                 POINT pt;
00137                 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bRet;
00138 
00139                 hbmpOld = GreSelectBitmap(hdcT, hbmpT);
00140 
00141                 <span class="comment">/*</span>
00142 <span class="comment">                 * Set new dc's brush origin in same relative</span>
00143 <span class="comment">                 * location as passed-in dc's.</span>
00144 <span class="comment">                 */</span>
00145                 bRet = GreGetBrushOrg(hdc, &amp;pt);
00146                 <span class="comment">/*</span>
00147 <span class="comment">                 * Bug 292396 - joejo</span>
00148 <span class="comment">                 * Stop overactive asserts by replacing with RIPMSG.</span>
00149 <span class="comment">                 */</span>
00150                 <span class="keywordflow">if</span> (bRet != <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00151                     RIPMSG0(RIP_WARNING, <span class="stringliteral">"DrawIconEx, GreGetBrushOrg failed."</span>);
00152                 }
00153 
00154                 bRet = GreSetBrushOrg(hdcT, pt.x, pt.y, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00155                 <span class="keywordflow">if</span> (bRet != <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00156                     RIPMSG0(RIP_WARNING, <span class="stringliteral">"DrawIconEx, GreSetBrushOrg failed."</span>);
00157                 }
00158 
00159                 PolyData.x         = 0;
00160                 PolyData.y         = 0;
00161                 PolyData.cx        = cx;
00162                 PolyData.cy        = <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
00163                 PolyData.BrClr.hbr = hbr;
00164 
00165                 bRet = GrePolyPatBlt(hdcT, PATCOPY, &amp;PolyData, 1, PPB_BRUSH);
00166                 <span class="keywordflow">if</span> (bRet != <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00167                     RIPMSG0(RIP_WARNING, <span class="stringliteral">"DrawIconEx, GrePolyPatBlt failed."</span>);
00168                 }
00169                 
00170                 <span class="comment">/*</span>
00171 <span class="comment">                 * Output the image to the temporary memoryDC.</span>
00172 <span class="comment">                 */</span>
00173                 <a class="code" href="../../d0/d9/wmicon_8c.html#a3">BltIcon</a>(hdcT, 0, 0, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>, pcur, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, SRCAND);
00174                 <a class="code" href="../../d0/d9/wmicon_8c.html#a3">BltIcon</a>(hdcT, 0, 0, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>, pcur, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, SRCINVERT);
00175 
00176                 <span class="comment">/*</span>
00177 <span class="comment">                 * Blt the bitmap to the original DC.</span>
00178 <span class="comment">                 */</span>
00179                 GreBitBlt(hdc, x, y, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>, hdcT, 0, 0, SRCCOPY, (COLORREF)-1);
00180 
00181                 GreSelectBitmap(hdcT, hbmpOld);
00182 
00183                 bRet = GreDeleteObject(hbmpT);
00184                 <span class="keywordflow">if</span> (bRet != <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00185                     RIPMSG0(RIP_WARNING, <span class="stringliteral">"DrawIconEx, GreDeleteObject failed. Possible Leak"</span>);
00186                 }
00187                 
00188                 fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00189             }
00190 
00191             GreDeleteDC(hdcT);
00192         }
00193 
00194     } <span class="keywordflow">else</span> {
00195 
00196         <span class="keywordflow">if</span> (diFlags &amp; DI_MASK) {
00197 
00198             <a class="code" href="../../d0/d9/wmicon_8c.html#a3">BltIcon</a>(hdc,
00199                     x,
00200                     y,
00201                     cx,
00202                     <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
00203                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>,
00204                     pcur,
00205                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00206                     ((diFlags &amp; DI_IMAGE) ? SRCAND : SRCCOPY));
00207         }
00208 
00209         <span class="keywordflow">if</span> (diFlags &amp; DI_IMAGE) {
00210 
00211             <a class="code" href="../../d0/d9/wmicon_8c.html#a3">BltIcon</a>(hdc,
00212                     x,
00213                     y,
00214                     cx,
00215                     <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
00216                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>,
00217                     pcur,
00218                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00219                     ((diFlags &amp; DI_MASK) ? SRCINVERT : SRCCOPY));
00220         }
00221 
00222         fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00223     }
00224 
00225 Done:
00226 
00227     <span class="keywordflow">return</span> fSuccess;
00228 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:26 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
