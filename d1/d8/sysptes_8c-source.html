<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: sysptes.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>sysptes.c</h1><a href="../../d0/d9/sysptes_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">   sysptes.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the routines which reserve and release</span>
00012 <span class="comment">    system wide PTEs reserved within the non paged portion of the</span>
00013 <span class="comment">    system space.  These PTEs are used for mapping I/O devices</span>
00014 <span class="comment">    and mapping kernel stacks for threads.</span>
00015 <span class="comment"></span>
00016 <span class="comment">Author:</span>
00017 <span class="comment"></span>
00018 <span class="comment">    Lou Perazzoli (loup) 6-Apr-1989</span>
00019 <span class="comment"></span>
00020 <span class="comment">Revision History:</span>
00021 <span class="comment"></span>
00022 <span class="comment">--*/</span>
00023 
00024 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00025 
00026 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00027 <a class="code" href="../../d0/d9/sysptes_8c.html#a19">MiFeedSysPtePool</a> (
00028     IN ULONG Index
00029     );
00030 
00031 <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>
00032 <a class="code" href="../../d0/d9/sysptes_8c.html#a20">MiReserveSystemPtes2</a> (
00033     IN ULONG NumberOfPtes,
00034     IN MMSYSTEM_PTE_POOL_TYPE SystemPtePoolType,
00035     IN ULONG Alignment,
00036     IN ULONG Offset,
00037     IN ULONG BugCheckOnFailure
00038     );
00039 
00040 ULONG
00041 <a class="code" href="../../d0/d9/sysptes_8c.html#a21">MiGetSystemPteListCount</a> (
00042     IN ULONG ListSize
00043     );
00044 
00045 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00046 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,MiInitializeSystemPtes)</span>
00047 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,MiAddSystemPtes)</span>
00048 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(MISYSPTE,MiReserveSystemPtes)</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(MISYSPTE,MiReserveSystemPtes2)</span>
00050 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(MISYSPTE,MiFeedSysPtePool)</span>
00051 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(MISYSPTE,MiReleaseSystemPtes)</span>
00052 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(MISYSPTE,MiGetSystemPteListCount)</span>
00053 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00054 <span class="preprocessor"></span>
00055 <span class="preprocessor">#ifdef _MI_GUARD_PTE_</span>
00056 <span class="preprocessor"></span><span class="preprocessor">#define _MI_SYSPTE_DEBUG_ 1</span>
00057 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00058 <span class="preprocessor"></span>
00059 <span class="preprocessor">#ifdef _MI_SYSPTE_DEBUG_</span>
00060 <span class="preprocessor"></span><span class="keyword">typedef</span> <span class="keyword">struct </span>_MMPTE_TRACKER {
00061     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>   NumberOfPtes;
00062     BOOLEAN  InUse;
00063     BOOLEAN  Reserved;
00064 } MMPTE_TRACKER, *PMMPTE_TRACKER;
00065 
00066 PMMPTE_TRACKER MiPteTracker;
00067 <span class="preprocessor">#endif</span>
00068 <span class="preprocessor"></span>
<a name="l00069"></a><a class="code" href="../../d0/d9/sysptes_8c.html#a8">00069</a> ULONG <a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[<a class="code" href="../../d4/d8/mi_8h.html#a1003a771">MaximumPtePoolTypes</a>];
<a name="l00070"></a><a class="code" href="../../d0/d9/sysptes_8c.html#a9">00070</a> <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> <a class="code" href="../../d8/d5/kddata_8c.html#a14">MmSystemPtesStart</a>[<a class="code" href="../../d4/d8/mi_8h.html#a1003a771">MaximumPtePoolTypes</a>];
<a name="l00071"></a><a class="code" href="../../d0/d9/sysptes_8c.html#a10">00071</a> <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> <a class="code" href="../../d8/d5/kddata_8c.html#a15">MmSystemPtesEnd</a>[<a class="code" href="../../d4/d8/mi_8h.html#a1003a771">MaximumPtePoolTypes</a>];
00072 
<a name="l00073"></a><a class="code" href="../../d0/d9/sysptes_8c.html#a0">00073</a> <span class="preprocessor">#define MM_MIN_SYSPTE_FREE 500</span>
<a name="l00074"></a><a class="code" href="../../d0/d9/sysptes_8c.html#a1">00074</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_MAX_SYSPTE_FREE 3000</span>
00075 <span class="preprocessor"></span>
<a name="l00076"></a><a class="code" href="../../d0/d9/sysptes_8c.html#a11">00076</a> <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> <a class="code" href="../../d0/d9/sysptes_8c.html#a11">MmFlushPte1</a>;
00077 
<a name="l00078"></a><a class="code" href="../../d0/d9/sysptes_8c.html#a12">00078</a> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a644">MmFlushCounter</a>;
00079 
00080 <span class="comment">//</span>
00081 <span class="comment">// PTEs are binned at sizes 1, 2, 4, 8, and 16.</span>
00082 <span class="comment">//</span>
00083 
00084 <span class="preprocessor">#ifdef _ALPHA_</span>
00085 <span class="preprocessor"></span>
00086 <span class="comment">//</span>
00087 <span class="comment">// Alpha has an 8k page size and stacks consume 9 pages (including guard page).</span>
00088 <span class="comment">//</span>
00089 
00090 ULONG <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a>[<a class="code" href="../../d4/d8/mi_8h.html#a237">MM_SYS_PTE_TABLES_MAX</a>] = {1,2,4,9,16};
00091 
00092 UCHAR <a class="code" href="../../d0/d9/sysptes_8c.html#a14">MmSysPteTables</a>[17] = {0,0,1,2,2,3,3,3,3,3,4,4,4,4,4,4,4};
00093 
00094 <span class="preprocessor">#else</span>
00095 <span class="preprocessor"></span>
<a name="l00096"></a><a class="code" href="../../d0/d9/sysptes_8c.html#a13">00096</a> ULONG <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a>[<a class="code" href="../../d4/d8/mi_8h.html#a237">MM_SYS_PTE_TABLES_MAX</a>] = {1,2,4,8,16};
00097 
<a name="l00098"></a><a class="code" href="../../d0/d9/sysptes_8c.html#a14">00098</a> UCHAR <a class="code" href="../../d0/d9/sysptes_8c.html#a14">MmSysPteTables</a>[17] = {0,0,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4};
00099 <span class="preprocessor">#endif</span>
00100 <span class="preprocessor"></span>
<a name="l00101"></a><a class="code" href="../../d0/d9/sysptes_8c.html#a15">00101</a> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> <a class="code" href="../../d0/d9/sysptes_8c.html#a15">MmFreeSysPteListBySize</a> [<a class="code" href="../../d4/d8/mi_8h.html#a237">MM_SYS_PTE_TABLES_MAX</a>];
<a name="l00102"></a><a class="code" href="../../d0/d9/sysptes_8c.html#a16">00102</a> <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> <a class="code" href="../../d0/d9/sysptes_8c.html#a16">MmLastSysPteListBySize</a> [<a class="code" href="../../d4/d8/mi_8h.html#a237">MM_SYS_PTE_TABLES_MAX</a>];
<a name="l00103"></a><a class="code" href="../../d0/d9/sysptes_8c.html#a17">00103</a> ULONG <a class="code" href="../../d0/d9/sysptes_8c.html#a17">MmSysPteListBySizeCount</a> [<a class="code" href="../../d4/d8/mi_8h.html#a237">MM_SYS_PTE_TABLES_MAX</a>];
<a name="l00104"></a><a class="code" href="../../d0/d9/sysptes_8c.html#a18">00104</a> ULONG <a class="code" href="../../d0/d9/sysptes_8c.html#a18">MmSysPteMinimumFree</a> [<a class="code" href="../../d4/d8/mi_8h.html#a237">MM_SYS_PTE_TABLES_MAX</a>] = {100,50,30,20,20};
00105 
00106 <span class="comment">//</span>
00107 <span class="comment">// Initial sizes for PTE lists.</span>
00108 <span class="comment">//</span>
00109 
<a name="l00110"></a><a class="code" href="../../d0/d9/sysptes_8c.html#a2">00110</a> <span class="preprocessor">#define MM_PTE_LIST_1  400</span>
<a name="l00111"></a><a class="code" href="../../d0/d9/sysptes_8c.html#a3">00111</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_LIST_2  100</span>
<a name="l00112"></a><a class="code" href="../../d0/d9/sysptes_8c.html#a4">00112</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_LIST_4   60</span>
<a name="l00113"></a><a class="code" href="../../d0/d9/sysptes_8c.html#a5">00113</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_LIST_8   50</span>
<a name="l00114"></a><a class="code" href="../../d0/d9/sysptes_8c.html#a6">00114</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_LIST_16  40</span>
00115 <span class="preprocessor"></span>
<a name="l00116"></a><a class="code" href="../../d0/d9/sysptes_8c.html#a7">00116</a> <span class="preprocessor">#define MM_PTE_TABLE_LIMIT 16</span>
00117 <span class="preprocessor"></span>
00118 <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>
00119 <a class="code" href="../../d0/d9/sysptes_8c.html#a20">MiReserveSystemPtes2</a> (
00120     IN ULONG NumberOfPtes,
00121     IN MMSYSTEM_PTE_POOL_TYPE SystemPtePoolType,
00122     IN ULONG Alignment,
00123     IN ULONG Offset,
00124     IN ULONG BugCheckOnFailure
00125     );
00126 
00127 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00128 <a class="code" href="../../d0/d9/sysptes_8c.html#a19">MiFeedSysPtePool</a> (
00129     IN ULONG Index
00130     );
00131 
00132 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00133 <a class="code" href="../../d0/d9/sysptes_8c.html#a22">MiDumpSystemPtes</a> (
00134     IN MMSYSTEM_PTE_POOL_TYPE SystemPtePoolType
00135     );
00136 
00137 ULONG
00138 <a class="code" href="../../d0/d9/sysptes_8c.html#a23">MiCountFreeSystemPtes</a> (
00139     IN MMSYSTEM_PTE_POOL_TYPE SystemPtePoolType
00140     );
00141 
00142 PVOID
00143 <a class="code" href="../../d0/d9/sysptes_8c.html#a24">MiGetHighestPteConsumer</a> (
00144     OUT PULONG_PTR NumberOfPtes
00145     );
00146 
00147 <span class="preprocessor">#ifdef _MI_SYSPTE_DEBUG_</span>
00148 <span class="preprocessor"></span>ULONG MiPtesChecked[0x10];
00149 
00150 
00151 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00152 MiValidateSystemPtes (
00153     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartingPte,
00154     IN ULONG NumberOfPtes
00155     )
00156 
00157 <span class="comment">/*++</span>
00158 <span class="comment"></span>
00159 <span class="comment">Routine Description:</span>
00160 <span class="comment"></span>
00161 <span class="comment">    This function validates the PTE range passed in, guaranteeing that it</span>
00162 <span class="comment">    doesn't overlap with any free system PTEs.  This enables us to catch</span>
00163 <span class="comment">    callers that are freeing one too many PTEs.</span>
00164 <span class="comment"></span>
00165 <span class="comment">Arguments:</span>
00166 <span class="comment"></span>
00167 <span class="comment">    StartingPte - Supplies the first PTE being freed.</span>
00168 <span class="comment"></span>
00169 <span class="comment">    NumberOfPtes - Supplies the number of PTEs being freed.</span>
00170 <span class="comment"></span>
00171 <span class="comment">Return Value:</span>
00172 <span class="comment"></span>
00173 <span class="comment">    None.</span>
00174 <span class="comment"></span>
00175 <span class="comment">Environment:</span>
00176 <span class="comment"></span>
00177 <span class="comment">    Kernel mode, DISPATCH_LEVEL or below.</span>
00178 <span class="comment"></span>
00179 <span class="comment">--*/</span>
00180 
00181 {
00182     KIRQL OldIrql;
00183     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00184     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndingPte;
00185     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte1;
00186     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerFreedPte;
00187     ULONG PtesInThisBucket;
00188     ULONG j;
00189 
00190     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfPtes != 0);
00191 
00192     EndingPte = StartingPte + NumberOfPtes - 1;
00193 
00194     <a class="code" href="../../d4/d8/mi_8h.html#a117">MiLockSystemSpace</a>(OldIrql);
00195 
00196     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a237">MM_SYS_PTE_TABLES_MAX</a>; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00197 
00198         PointerPte1 = &amp;<a class="code" href="../../d0/d9/sysptes_8c.html#a15">MmFreeSysPteListBySize</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00199 
00200         <span class="keywordflow">while</span> (PointerPte1-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>) {
00201 
00202             MiPtesChecked[0] += 1;
00203 
00204             PointerPte1 = <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a> + PointerPte1-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry;
00205 
00206             PtesInThisBucket = <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00207 
00208             <span class="keywordflow">if</span> (StartingPte &gt;= PointerPte1 &amp;&amp; StartingPte &lt; PointerPte1 + PtesInThisBucket) {
00209                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiValidateSystemPtes1: %x %x %x %x %x %x\n"</span>,
00210                     StartingPte,
00211                     EndingPte,
00212                     NumberOfPtes,
00213                     PointerPte1,
00214                     PtesInThisBucket,
00215                     Index);
00216                 DbgBreakPoint ();
00217             }
00218 
00219             <span class="keywordflow">if</span> (EndingPte &gt;= PointerPte1 &amp;&amp; EndingPte &lt; PointerPte1 + PtesInThisBucket) {
00220                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiValidateSystemPtes2: %x %x %x %x %x %x\n"</span>,
00221                     StartingPte,
00222                     EndingPte,
00223                     NumberOfPtes,
00224                     PointerPte1,
00225                     PtesInThisBucket,
00226                     Index);
00227                 DbgBreakPoint ();
00228             }
00229 
00230             <span class="keywordflow">if</span> (StartingPte &lt; PointerPte1 &amp;&amp; EndingPte &gt;= PointerPte1 + PtesInThisBucket) {
00231                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiValidateSystemPtes3: %x %x %x %x %x %x\n"</span>,
00232                     StartingPte,
00233                     EndingPte,
00234                     NumberOfPtes,
00235                     PointerPte1,
00236                     PtesInThisBucket,
00237                     Index);
00238                 DbgBreakPoint ();
00239             }
00240 
00241             PointerFreedPte = PointerPte1;
00242             <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]; j++) {
00243                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerFreedPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
00244                 PointerFreedPte += 1;
00245                 MiPtesChecked[1] += 1;
00246             }
00247         }
00248     }
00249 
00250     <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
00251 }
00252 
00253 
00254 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00255 MiCheckPteAllocation (
00256     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartingPte,
00257     IN ULONG NumberOfPtes,
00258     IN ULONG CallerId,
00259     IN ULONG Context1
00260     )
00261 
00262 <span class="comment">/*++</span>
00263 <span class="comment"></span>
00264 <span class="comment">Routine Description:</span>
00265 <span class="comment"></span>
00266 <span class="comment">    This function validates the PTE range passed in, guaranteeing that it</span>
00267 <span class="comment">    is not already allocated.</span>
00268 <span class="comment"></span>
00269 <span class="comment">Arguments:</span>
00270 <span class="comment"></span>
00271 <span class="comment">    StartingPte - Supplies the first PTE being allocated.</span>
00272 <span class="comment"></span>
00273 <span class="comment">    NumberOfPtes - Supplies the number of PTEs being allocated.</span>
00274 <span class="comment"></span>
00275 <span class="comment">    CallerId - Supplies the caller's ID.</span>
00276 <span class="comment"></span>
00277 <span class="comment">    Context1 - Opaque.</span>
00278 <span class="comment"></span>
00279 <span class="comment">Return Value:</span>
00280 <span class="comment"></span>
00281 <span class="comment">    None.</span>
00282 <span class="comment"></span>
00283 <span class="comment">Environment:</span>
00284 <span class="comment"></span>
00285 <span class="comment">    Kernel mode, MmSystemSpaceLock held.</span>
00286 <span class="comment"></span>
00287 <span class="comment">--*/</span>
00288 
00289 {
00290     ULONG i;
00291     ULONG_PTR <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00292     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> BasePte;
00293     PMMPTE_TRACKER Tracker;
00294 
00295     <span class="comment">//</span>
00296     <span class="comment">// Don't track nonpaged pool expansion.</span>
00297     <span class="comment">//</span>
00298 
00299     <span class="keywordflow">if</span> (StartingPte &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a14">MmSystemPtesStart</a>[<a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>] ||
00300         StartingPte + NumberOfPtes &gt; <a class="code" href="../../d8/d5/kddata_8c.html#a15">MmSystemPtesEnd</a>[<a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>] + 1) {
00301             <span class="keywordflow">return</span>;
00302     }
00303 
00304     <span class="keywordflow">if</span> (MiPteTracker == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00305             <span class="keywordflow">return</span>;
00306     }
00307 
00308     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = StartingPte - <a class="code" href="../../d8/d5/kddata_8c.html#a14">MmSystemPtesStart</a>[<a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>];
00309 
00310     Tracker = &amp;MiPteTracker[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00311 
00312     <span class="keywordflow">for</span> (i = 0; i &lt; NumberOfPtes; i += 1) {
00313 
00314         <span class="keywordflow">if</span> (Tracker-&gt;InUse == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00315             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SYSTEM_PTE_MISUSE,
00316                           7,
00317                           (ULONG_PTR)StartingPte,
00318                           NumberOfPtes,
00319                           CallerId);
00320         }
00321 
00322         Tracker += 1;
00323     }
00324 
00325     Tracker = &amp;MiPteTracker[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00326 
00327     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfPtes &lt; 0x10000);
00328 
00329     Tracker-&gt;NumberOfPtes = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)NumberOfPtes;
00330 
00331     <span class="keywordflow">for</span> (i = 0; i &lt; NumberOfPtes; i += 1) {
00332         Tracker-&gt;InUse = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00333         Tracker += 1;
00334     }
00335 
00336     MiPtesChecked[0xE] += 1;
00337 }
00338 
00339 
00340 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00341 MiCheckPteRelease (
00342     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartingPte,
00343     IN ULONG NumberOfPtes
00344     )
00345 
00346 <span class="comment">/*++</span>
00347 <span class="comment"></span>
00348 <span class="comment">Routine Description:</span>
00349 <span class="comment"></span>
00350 <span class="comment">    This function validates the PTE range passed in, guaranteeing that it</span>
00351 <span class="comment">    is not already free.</span>
00352 <span class="comment"></span>
00353 <span class="comment">Arguments:</span>
00354 <span class="comment"></span>
00355 <span class="comment">    StartingPte - Supplies the first PTE being allocated.</span>
00356 <span class="comment"></span>
00357 <span class="comment">    NumberOfPtes - Supplies the number of PTEs being allocated.</span>
00358 <span class="comment"></span>
00359 <span class="comment">Return Value:</span>
00360 <span class="comment"></span>
00361 <span class="comment">    None.</span>
00362 <span class="comment"></span>
00363 <span class="comment">Environment:</span>
00364 <span class="comment"></span>
00365 <span class="comment">    Kernel mode, MmSystemSpaceLock held.</span>
00366 <span class="comment"></span>
00367 <span class="comment">--*/</span>
00368 
00369 {
00370     ULONG i;
00371     ULONG_PTR <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00372     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> BasePte;
00373     PMMPTE_TRACKER Tracker;
00374 
00375     <span class="comment">//</span>
00376     <span class="comment">// Don't track nonpaged pool expansion.</span>
00377     <span class="comment">//</span>
00378 
00379     <span class="keywordflow">if</span> (StartingPte &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a14">MmSystemPtesStart</a>[<a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>] ||
00380         StartingPte + NumberOfPtes &gt; <a class="code" href="../../d8/d5/kddata_8c.html#a15">MmSystemPtesEnd</a>[<a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>] + 1) {
00381             <span class="keywordflow">return</span>;
00382     }
00383 
00384     <span class="keywordflow">if</span> (MiPteTracker == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00385             <span class="keywordflow">return</span>;
00386     }
00387 
00388     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfPtes &lt; 0x10000);
00389 
00390     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = StartingPte - <a class="code" href="../../d8/d5/kddata_8c.html#a14">MmSystemPtesStart</a>[<a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>];
00391 
00392     Tracker = &amp;MiPteTracker[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00393 
00394     <span class="keywordflow">if</span> ((NumberOfPtes == 0) ||
00395         (Tracker-&gt;NumberOfPtes != NumberOfPtes)) {
00396         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SYSTEM_PTE_MISUSE,
00397                       8,
00398                       (ULONG_PTR)StartingPte,
00399                       NumberOfPtes,
00400                       Tracker-&gt;NumberOfPtes);
00401     }
00402 
00403     Tracker-&gt;NumberOfPtes = 0;
00404 
00405     <span class="keywordflow">for</span> (i = 0; i &lt; NumberOfPtes; i += 1) {
00406 
00407         <span class="keywordflow">if</span> (Tracker-&gt;InUse == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00408             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SYSTEM_PTE_MISUSE,
00409                           9,
00410                           (ULONG_PTR)StartingPte,
00411                           NumberOfPtes,
00412                           i);
00413         }
00414 
00415         Tracker += 1;
00416     }
00417 
00418     Tracker = &amp;MiPteTracker[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00419 
00420     <span class="keywordflow">for</span> (i = 0; i &lt; NumberOfPtes; i += 1) {
00421         Tracker-&gt;InUse = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00422         Tracker += 1;
00423     }
00424 
00425     MiPtesChecked[0xF] += 1;
00426 }
00427 
00428 
00429 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00430 MiRebuildPteTracker (
00431     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartingPte,
00432     IN ULONG NumberOfPtes
00433     )
00434 
00435 <span class="comment">/*++</span>
00436 <span class="comment"></span>
00437 <span class="comment">Routine Description:</span>
00438 <span class="comment"></span>
00439 <span class="comment">    This function resizes the PTE tracking data structures to account for</span>
00440 <span class="comment">    system PTE table growth.</span>
00441 <span class="comment"></span>
00442 <span class="comment">    Note that the original PTE tracker structure cannot be freed unless</span>
00443 <span class="comment">    MiFreePoolPages is modified to deal with the boundary allocations being</span>
00444 <span class="comment">    freed - since this never happens in a normal system, there are no bounds</span>
00445 <span class="comment">    checks in place and it will coalesce past the ends of pool.</span>
00446 <span class="comment"></span>
00447 <span class="comment">Arguments:</span>
00448 <span class="comment"></span>
00449 <span class="comment">    StartingPte - Supplies the first PTE for the system PTE pool.</span>
00450 <span class="comment"></span>
00451 <span class="comment">    NumberOfPtes - Supplies the number of PTEs in the system PTE pool.</span>
00452 <span class="comment"></span>
00453 <span class="comment">Return Value:</span>
00454 <span class="comment"></span>
00455 <span class="comment">    None.</span>
00456 <span class="comment"></span>
00457 <span class="comment">Environment:</span>
00458 <span class="comment"></span>
00459 <span class="comment">    Kernel mode, MmSystemSpaceLock held.</span>
00460 <span class="comment"></span>
00461 <span class="comment">--*/</span>
00462 
00463 {
00464     KIRQL OldIrql;
00465     ULONG_PTR OldPtes;
00466     ULONG_PTR NewPtes;
00467     PMMPTE_TRACKER OldTracker;
00468     PMMPTE_TRACKER NewTracker;
00469 
00470     <span class="comment">//</span>
00471     <span class="comment">// If we've already discovered a discontiguity don't coalesce now.</span>
00472     <span class="comment">//</span>
00473 
00474     <span class="keywordflow">if</span> (MiPteTracker == (PMMPTE_TRACKER) 0) {
00475         <span class="keywordflow">return</span>;
00476     }
00477 
00478     <span class="keywordflow">if</span> (StartingPte + NumberOfPtes != <a class="code" href="../../d8/d5/kddata_8c.html#a14">MmSystemPtesStart</a>[<a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>]) {
00479 <span class="preprocessor">#if 0</span>
00480 <span class="preprocessor"></span>        <a class="code" href="../../d1/d6/allocpag_8c.html#a55">MiFreePoolPages</a> ((PVOID)MiPteTracker);
00481 <span class="preprocessor">#endif</span>
00482 <span class="preprocessor"></span>        MiPteTracker = (PMMPTE_TRACKER) 0;
00483         <span class="keywordflow">return</span>;
00484     }
00485 
00486     <span class="keywordflow">if</span> (MiPteTracker) {
00487         OldPtes = <a class="code" href="../../d8/d5/kddata_8c.html#a15">MmSystemPtesEnd</a>[<a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>] - <a class="code" href="../../d8/d5/kddata_8c.html#a14">MmSystemPtesStart</a>[<a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>] + 1;
00488 
00489         NewPtes = OldPtes + NumberOfPtes;
00490 
00491         NewTracker = (PMMPTE_TRACKER) <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (
00492                                           NonPagedPool,
00493                                           (ULONG_PTR)(NewPtes * <span class="keyword">sizeof</span> (MMPTE_TRACKER)),
00494                                           '  mM');
00495 
00496         <span class="keywordflow">if</span> (NewTracker == (PMMPTE_TRACKER) 0) {
00497             MiPteTracker = (PMMPTE_TRACKER) 0;
00498             <span class="keywordflow">return</span>;
00499         }
00500 
00501         RtlZeroMemory (NewTracker, NewPtes * <span class="keyword">sizeof</span> (MMPTE_TRACKER));
00502 
00503         OldTracker = MiPteTracker;
00504 
00505         <a class="code" href="../../d4/d8/mi_8h.html#a117">MiLockSystemSpace</a>(OldIrql);
00506 
00507         RtlCopyMemory (NewTracker + NumberOfPtes, OldTracker, OldPtes * <span class="keyword">sizeof</span> (MMPTE_TRACKER));
00508 
00509         MiPteTracker = NewTracker;
00510 
00511         <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
00512 
00513 <span class="preprocessor">#if 0</span>
00514 <span class="preprocessor"></span>        <a class="code" href="../../d1/d6/allocpag_8c.html#a55">MiFreePoolPages</a> ((PVOID)OldTracker);
00515 <span class="preprocessor">#endif</span>
00516 <span class="preprocessor"></span>
00517         MiPtesChecked[0xD] += 1;
00518     }
00519 }
00520 <span class="preprocessor">#endif</span>
00521 <span class="preprocessor"></span>
00522 
00523 <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>
<a name="l00524"></a><a class="code" href="../../d0/d9/sysptes_8c.html#a25">00524</a> <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a> (
00525     IN ULONG NumberOfPtes,
00526     IN MMSYSTEM_PTE_POOL_TYPE SystemPtePoolType,
00527     IN ULONG Alignment,
00528     IN ULONG Offset,
00529     IN ULONG BugCheckOnFailure
00530     )
00531 
00532 <span class="comment">/*++</span>
00533 <span class="comment"></span>
00534 <span class="comment">Routine Description:</span>
00535 <span class="comment"></span>
00536 <span class="comment">    This function locates the specified number of unused PTEs to locate</span>
00537 <span class="comment">    within the non paged portion of system space.</span>
00538 <span class="comment"></span>
00539 <span class="comment">Arguments:</span>
00540 <span class="comment"></span>
00541 <span class="comment">    NumberOfPtes - Supplies the number of PTEs to locate.</span>
00542 <span class="comment"></span>
00543 <span class="comment">    SystemPtePoolType - Supplies the PTE type of the pool to expand, one of</span>
00544 <span class="comment">                        SystemPteSpace or NonPagedPoolExpansion.</span>
00545 <span class="comment"></span>
00546 <span class="comment">    Alignment - Supplies the virtual address alignment for the address</span>
00547 <span class="comment">                the returned PTE maps. For example, if the value is 64K,</span>
00548 <span class="comment">                the returned PTE will map an address on a 64K boundary.</span>
00549 <span class="comment">                An alignment of zero means to align on a page boundary.</span>
00550 <span class="comment"></span>
00551 <span class="comment">    Offset - Supplies the offset into the alignment for the virtual address.</span>
00552 <span class="comment">             For example, if the Alignment is 64k and the Offset is 4k,</span>
00553 <span class="comment">             the returned address will be 4k above a 64k boundary.</span>
00554 <span class="comment"></span>
00555 <span class="comment">    BugCheckOnFailure - Supplies FALSE if NULL should be returned if</span>
00556 <span class="comment">                        the request cannot be satisfied, TRUE if</span>
00557 <span class="comment">                        a bugcheck should be issued.</span>
00558 <span class="comment"></span>
00559 <span class="comment">Return Value:</span>
00560 <span class="comment"></span>
00561 <span class="comment">    Returns the address of the first PTE located.</span>
00562 <span class="comment">    NULL if no system PTEs can be located and BugCheckOnFailure is FALSE.</span>
00563 <span class="comment"></span>
00564 <span class="comment">Environment:</span>
00565 <span class="comment"></span>
00566 <span class="comment">    Kernel mode, DISPATCH_LEVEL or below.</span>
00567 <span class="comment"></span>
00568 <span class="comment">--*/</span>
00569 
00570 {
00571     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00572     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> Previous;
00573     KIRQL OldIrql;
00574     ULONG PteMask;
00575     ULONG MaskSize;
00576     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00577 
00578 <span class="preprocessor">#ifdef _MI_GUARD_PTE_</span>
00579 <span class="preprocessor"></span>    ULONG ExactPtes;
00580 
00581     <span class="keywordflow">if</span> (NumberOfPtes == 0) {
00582         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SYSTEM_PTE_MISUSE,
00583                       0xA,
00584                       BugCheckOnFailure,
00585                       NumberOfPtes,
00586                       SystemPtePoolType);
00587     }
00588 
00589     <span class="keywordflow">if</span> (SystemPtePoolType == <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>) {
00590         NumberOfPtes += 1;
00591     }
00592 
00593     ExactPtes = NumberOfPtes;
00594 <span class="preprocessor">#endif</span>
00595 <span class="preprocessor"></span>
00596     <span class="keywordflow">if</span> (SystemPtePoolType == <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>) {
00597 
00598         MaskSize = (Alignment - 1) &gt;&gt; (<a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> - <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>);
00599         PteMask = MaskSize &amp; (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &gt;&gt; (<a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> - <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>));
00600 
00601         <span class="comment">//</span>
00602         <span class="comment">// Acquire the system space lock to synchronize access to this</span>
00603         <span class="comment">// routine.</span>
00604         <span class="comment">//</span>
00605 
00606         <a class="code" href="../../d4/d8/mi_8h.html#a117">MiLockSystemSpace</a>(OldIrql);
00607 
00608         <span class="keywordflow">if</span> (NumberOfPtes &lt;= <a class="code" href="../../d0/d9/sysptes_8c.html#a7">MM_PTE_TABLE_LIMIT</a>) {
00609             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d0/d9/sysptes_8c.html#a14">MmSysPteTables</a> [NumberOfPtes];
00610             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfPtes &lt;= <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]);
00611             PointerPte = &amp;<a class="code" href="../../d0/d9/sysptes_8c.html#a15">MmFreeSysPteListBySize</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00612 <span class="preprocessor">#if DBG</span>
00613 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a65">MM_DBG_SYS_PTES</a>) {
00614                 <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte1;
00615                 PointerPte1 = &amp;<a class="code" href="../../d0/d9/sysptes_8c.html#a15">MmFreeSysPteListBySize</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00616                 <span class="keywordflow">while</span> (PointerPte1-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>) {
00617                     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerFreedPte;
00618                     ULONG j;
00619 
00620                     PointerPte1 = <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a> + PointerPte1-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry;
00621                     PointerFreedPte = PointerPte1;
00622                     <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]; j++) {
00623                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerFreedPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
00624                         PointerFreedPte++;
00625                     }
00626                 }
00627             }
00628 <span class="preprocessor">#endif //DBG</span>
00629 <span class="preprocessor"></span>
00630             Previous = PointerPte;
00631 
00632             <span class="keywordflow">while</span> (PointerPte-&gt;u.List.NextEntry != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>) {
00633 
00634                 <span class="comment">//</span>
00635                 <span class="comment">//  Try to find suitable PTEs with the proper alignment.</span>
00636                 <span class="comment">//</span>
00637 
00638                 Previous = PointerPte;
00639                 PointerPte = <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a> + PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry;
00640 <span class="preprocessor">#if !defined(_IA64_)</span>
00641 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (PointerPte == <a class="code" href="../../d0/d9/sysptes_8c.html#a11">MmFlushPte1</a>) {
00642                     <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00643                     <a class="code" href="../../d4/d8/mi_8h.html#a644">MmFlushCounter</a> = (<a class="code" href="../../d4/d8/mi_8h.html#a644">MmFlushCounter</a> + 1) &amp; <a class="code" href="../../d4/d8/mi_8h.html#a8">MM_FLUSH_COUNTER_MASK</a>;
00644                     <a class="code" href="../../d0/d9/sysptes_8c.html#a11">MmFlushPte1</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00645                 }
00646 <span class="preprocessor">#endif</span>
00647 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ((Alignment == 0) ||
00648                     (((ULONG_PTR)PointerPte &amp; MaskSize) == PteMask)) {
00649 
00650 <span class="preprocessor">#ifdef _MI_SYSPTE_DEBUG_</span>
00651 <span class="preprocessor"></span>                    MiCheckPteAllocation (PointerPte,
00652                                           NumberOfPtes,
00653                                           0,
00654                                           <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]);
00655 <span class="preprocessor">#endif</span>
00656 <span class="preprocessor"></span>                    <span class="comment">//</span>
00657                     <span class="comment">// Proper alignment and offset, update list index.</span>
00658                     <span class="comment">//</span>
00659 
00660                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((PointerPte-&gt;u.List.NextEntry + <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a>) &gt;=
00661                              <a class="code" href="../../d8/d5/kddata_8c.html#a14">MmSystemPtesStart</a>[SystemPtePoolType] ||
00662                              PointerPte-&gt;u.List.NextEntry == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>);
00663                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((PointerPte-&gt;u.List.NextEntry + <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a>) &lt;=
00664                              <a class="code" href="../../d8/d5/kddata_8c.html#a15">MmSystemPtesEnd</a>[SystemPtePoolType] ||
00665                              PointerPte-&gt;u.List.NextEntry == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>);
00666 
00667                     Previous-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry = PointerPte-&gt;u.List.NextEntry;
00668                     <a class="code" href="../../d0/d9/sysptes_8c.html#a17">MmSysPteListBySizeCount</a> [<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] -= 1;
00669 
00670 <span class="preprocessor">#if !defined(_IA64_)</span>
00671 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (NumberOfPtes != 1) {
00672 
00673                         <span class="comment">//</span>
00674                         <span class="comment">// Check to see if the TB should be flushed.</span>
00675                         <span class="comment">//</span>
00676 
00677                         <span class="keywordflow">if</span> ((PointerPte + 1)-&gt;u.List.NextEntry == <a class="code" href="../../d4/d8/mi_8h.html#a644">MmFlushCounter</a>) {
00678                             <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00679                             <a class="code" href="../../d4/d8/mi_8h.html#a644">MmFlushCounter</a> = (<a class="code" href="../../d4/d8/mi_8h.html#a644">MmFlushCounter</a> + 1) &amp;
00680                                                     <a class="code" href="../../d4/d8/mi_8h.html#a8">MM_FLUSH_COUNTER_MASK</a>;
00681                             <a class="code" href="../../d0/d9/sysptes_8c.html#a11">MmFlushPte1</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00682                         }
00683                     }
00684 <span class="preprocessor">#endif</span>
00685 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (PointerPte-&gt;u.List.NextEntry == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>) {
00686                         <a class="code" href="../../d0/d9/sysptes_8c.html#a16">MmLastSysPteListBySize</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = Previous;
00687                     }
00688 <span class="preprocessor">#if DBG</span>
00689 <span class="preprocessor"></span>
00690                     <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a65">MM_DBG_SYS_PTES</a>) {
00691                         <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte1;
00692                         PointerPte1 = &amp;<a class="code" href="../../d0/d9/sysptes_8c.html#a15">MmFreeSysPteListBySize</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00693                         <span class="keywordflow">while</span> (PointerPte1-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>) {
00694                             <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerFreedPte;
00695                             ULONG j;
00696 
00697                             PointerPte1 = <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a> + PointerPte1-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry;
00698                             PointerFreedPte = PointerPte1;
00699                             <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]; j++) {
00700                                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerFreedPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
00701                                 PointerFreedPte++;
00702                             }
00703                         }
00704                     }
00705 <span class="preprocessor">#endif //DBG</span>
00706 <span class="preprocessor"></span>                    <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
00707 
00708 <span class="preprocessor">#if DBG</span>
00709 <span class="preprocessor"></span>                    PointerPte-&gt;u.List.NextEntry = 0xABCDE;
00710                     <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a65">MM_DBG_SYS_PTES</a>) {
00711 
00712                         <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerFreedPte;
00713                         ULONG j;
00714 
00715                         PointerFreedPte = PointerPte;
00716                         <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]; j++) {
00717                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerFreedPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
00718                             PointerFreedPte++;
00719                         }
00720                     }
00721                     <span class="keywordflow">if</span> (PointerPte &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a14">MmSystemPtesStart</a>[SystemPtePoolType]) {
00722                         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SYSTEM_PTE_MISUSE,
00723                                       0xB,
00724                                       (ULONG_PTR)PointerPte,
00725                                       NumberOfPtes,
00726                                       SystemPtePoolType);
00727                     }
00728                     <span class="keywordflow">if</span> (PointerPte &gt; <a class="code" href="../../d8/d5/kddata_8c.html#a15">MmSystemPtesEnd</a>[SystemPtePoolType]) {
00729                         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SYSTEM_PTE_MISUSE,
00730                                       0xC,
00731                                       (ULONG_PTR)PointerPte,
00732                                       NumberOfPtes,
00733                                       SystemPtePoolType);
00734                     }
00735 <span class="preprocessor">#endif //DBG</span>
00736 <span class="preprocessor"></span>
00737                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d9/sysptes_8c.html#a17">MmSysPteListBySizeCount</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] &lt;
00738                                             <a class="code" href="../../d0/d9/sysptes_8c.html#a18">MmSysPteMinimumFree</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]) {
00739                         <a class="code" href="../../d0/d9/sysptes_8c.html#a19">MiFeedSysPtePool</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>);
00740                     }
00741 <span class="preprocessor">#ifdef _MI_GUARD_PTE_</span>
00742 <span class="preprocessor"></span>                    (PointerPte + ExactPtes - 1)-&gt;u.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a97">MM_KERNEL_NOACCESS_PTE</a>;
00743 <span class="preprocessor">#endif</span>
00744 <span class="preprocessor"></span>                    <span class="keywordflow">return</span> PointerPte;
00745                 }
00746             }
00747             NumberOfPtes = <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a> [<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00748         }
00749         <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
00750     }
00751 
00752 <span class="preprocessor">#ifdef _MI_GUARD_PTE_</span>
00753 <span class="preprocessor"></span>    NumberOfPtes = ExactPtes;
00754 <span class="preprocessor">#endif</span>
00755 <span class="preprocessor"></span>
00756     PointerPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a20">MiReserveSystemPtes2</a> (NumberOfPtes,
00757                                        SystemPtePoolType,
00758                                        Alignment,
00759                                        <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>,
00760                                        BugCheckOnFailure);
00761 
00762 <span class="preprocessor">#if DBG</span>
00763 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a65">MM_DBG_SYS_PTES</a>) {
00764 
00765         <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerFreedPte;
00766         ULONG j;
00767 
00768         <span class="keywordflow">if</span> (PointerPte) {
00769             PointerFreedPte = PointerPte;
00770             <span class="keywordflow">for</span> (j = 0; j &lt; NumberOfPtes; j++) {
00771                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerFreedPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
00772                 PointerFreedPte++;
00773             }
00774         }
00775     }
00776 <span class="preprocessor">#endif //DBG</span>
00777 <span class="preprocessor"></span>
00778 <span class="preprocessor">#ifdef _MI_GUARD_PTE_</span>
00779 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (PointerPte) {
00780         (PointerPte + ExactPtes - 1)-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a97">MM_KERNEL_NOACCESS_PTE</a>;
00781     }
00782 <span class="preprocessor">#endif</span>
00783 <span class="preprocessor"></span>
00784     <span class="keywordflow">return</span> PointerPte;
00785 }
00786 
00787 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00788"></a><a class="code" href="../../d0/d9/sysptes_8c.html#a19">00788</a> <a class="code" href="../../d0/d9/sysptes_8c.html#a19">MiFeedSysPtePool</a> (
00789     IN ULONG Index
00790     )
00791 
00792 <span class="comment">/*++</span>
00793 <span class="comment"></span>
00794 <span class="comment">Routine Description:</span>
00795 <span class="comment"></span>
00796 <span class="comment">    This routine adds PTEs to the look aside lists.</span>
00797 <span class="comment"></span>
00798 <span class="comment">Arguments:</span>
00799 <span class="comment"></span>
00800 <span class="comment">    Index - Supplies the index for the look aside list to fill.</span>
00801 <span class="comment"></span>
00802 <span class="comment">Return Value:</span>
00803 <span class="comment"></span>
00804 <span class="comment">    None.</span>
00805 <span class="comment"></span>
00806 <span class="comment"></span>
00807 <span class="comment">Environment:</span>
00808 <span class="comment"></span>
00809 <span class="comment">    Kernel mode, internal to SysPtes.</span>
00810 <span class="comment"></span>
00811 <span class="comment">--*/</span>
00812 
00813 {
00814 <span class="preprocessor">#ifdef _MI_GUARD_PTE_</span>
00815 <span class="preprocessor"></span>    UNREFERENCED_PARAMETER (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>);
00816 <span class="preprocessor">#else</span>
00817 <span class="preprocessor"></span>    ULONG i;
00818     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00819 
00820     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[<a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>] &lt; <a class="code" href="../../d0/d9/sysptes_8c.html#a0">MM_MIN_SYSPTE_FREE</a>) {
00821         <span class="keywordflow">return</span>;
00822     }
00823 
00824     <span class="keywordflow">for</span> (i = 0; i &lt; 10 ; i++ ) {
00825         PointerPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a20">MiReserveSystemPtes2</a> (<a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a> [<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>],
00826                                            <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>,
00827                                            0,
00828                                            0,
00829                                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00830         <span class="keywordflow">if</span> (PointerPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00831             <span class="keywordflow">return</span>;
00832         }
00833         <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (PointerPte,
00834                              <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a> [<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>],
00835                              <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>);
00836     }
00837 <span class="preprocessor">#endif</span>
00838 <span class="preprocessor"></span>    <span class="keywordflow">return</span>;
00839 }
00840 
00841 
00842 <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>
<a name="l00843"></a><a class="code" href="../../d0/d9/sysptes_8c.html#a20">00843</a> <a class="code" href="../../d0/d9/sysptes_8c.html#a20">MiReserveSystemPtes2</a> (
00844     IN ULONG NumberOfPtes,
00845     IN MMSYSTEM_PTE_POOL_TYPE SystemPtePoolType,
00846     IN ULONG Alignment,
00847     IN ULONG Offset,
00848     IN ULONG BugCheckOnFailure
00849     )
00850 
00851 <span class="comment">/*++</span>
00852 <span class="comment"></span>
00853 <span class="comment">Routine Description:</span>
00854 <span class="comment"></span>
00855 <span class="comment">    This function locates the specified number of unused PTEs to locate</span>
00856 <span class="comment">    within the non paged portion of system space.</span>
00857 <span class="comment"></span>
00858 <span class="comment">Arguments:</span>
00859 <span class="comment"></span>
00860 <span class="comment">    NumberOfPtes - Supplies the number of PTEs to locate.</span>
00861 <span class="comment"></span>
00862 <span class="comment">    SystemPtePoolType - Supplies the PTE type of the pool to expand, one of</span>
00863 <span class="comment">                        SystemPteSpace or NonPagedPoolExpansion.</span>
00864 <span class="comment"></span>
00865 <span class="comment">    Alignment - Supplies the virtual address alignment for the address</span>
00866 <span class="comment">                the returned PTE maps. For example, if the value is 64K,</span>
00867 <span class="comment">                the returned PTE will map an address on a 64K boundary.</span>
00868 <span class="comment">                An alignment of zero means to align on a page boundary.</span>
00869 <span class="comment"></span>
00870 <span class="comment">    Offset - Supplies the offset into the alignment for the virtual address.</span>
00871 <span class="comment">             For example, if the Alignment is 64k and the Offset is 4k,</span>
00872 <span class="comment">             the returned address will be 4k above a 64k boundary.</span>
00873 <span class="comment"></span>
00874 <span class="comment">    BugCheckOnFailure - Supplies FALSE if NULL should be returned if</span>
00875 <span class="comment">                        the request cannot be satisfied, TRUE if</span>
00876 <span class="comment">                        a bugcheck should be issued.</span>
00877 <span class="comment"></span>
00878 <span class="comment">Return Value:</span>
00879 <span class="comment"></span>
00880 <span class="comment">    Returns the address of the first PTE located.</span>
00881 <span class="comment">    NULL if no system PTEs can be located and BugCheckOnFailure is FALSE.</span>
00882 <span class="comment"></span>
00883 <span class="comment">Environment:</span>
00884 <span class="comment"></span>
00885 <span class="comment">    Kernel mode, DISPATCH_LEVEL or below.</span>
00886 <span class="comment"></span>
00887 <span class="comment">--*/</span>
00888 
00889 {
00890     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00891     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerFollowingPte;
00892     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> Previous;
00893     ULONG_PTR SizeInSet;
00894     KIRQL OldIrql;
00895     ULONG MaskSize;
00896     ULONG NumberOfRequiredPtes;
00897     ULONG OffsetSum;
00898     ULONG PtesToObtainAlignment;
00899     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> NextSetPointer;
00900     ULONG_PTR LeftInSet;
00901     ULONG_PTR PteOffset;
00902     <a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html">MMPTE_FLUSH_LIST</a> PteFlushList;
00903     PVOID HighConsumer;
00904     ULONG_PTR HighPteUse;
00905 
00906     MaskSize = (Alignment - 1) &gt;&gt; (<a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> - <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>);
00907 
00908     OffsetSum = (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &gt;&gt; (<a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> - <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>)) |
00909                             (Alignment &gt;&gt; (<a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> - <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>));
00910 
00911     <a class="code" href="../../d4/d8/mi_8h.html#a117">MiLockSystemSpace</a>(OldIrql);
00912 
00913     <span class="comment">//</span>
00914     <span class="comment">// The nonpaged PTE pool uses the invalid PTEs to define the pool</span>
00915     <span class="comment">// structure.   A global pointer points to the first free set</span>
00916     <span class="comment">// in the list, each free set contains the number free and a pointer</span>
00917     <span class="comment">// to the next free set.  The free sets are kept in an ordered list</span>
00918     <span class="comment">// such that the pointer to the next free set is always greater</span>
00919     <span class="comment">// than the address of the current free set.</span>
00920     <span class="comment">//</span>
00921     <span class="comment">// As to not limit the size of this pool, two PTEs are used</span>
00922     <span class="comment">// to define a free region.  If the region is a single PTE, the</span>
00923     <span class="comment">// prototype field within the PTE is set indicating the set</span>
00924     <span class="comment">// consists of a single PTE.</span>
00925     <span class="comment">//</span>
00926     <span class="comment">// The page frame number field is used to define the next set</span>
00927     <span class="comment">// and the number free.  The two flavors are:</span>
00928     <span class="comment">//</span>
00929     <span class="comment">//                           o          V</span>
00930     <span class="comment">//                           n          l</span>
00931     <span class="comment">//                           e          d</span>
00932     <span class="comment">//  +-----------------------+-+----------+</span>
00933     <span class="comment">//  |  next set             |0|0        0|</span>
00934     <span class="comment">//  +-----------------------+-+----------+</span>
00935     <span class="comment">//  |  number in this set   |0|0        0|</span>
00936     <span class="comment">//  +-----------------------+-+----------+</span>
00937     <span class="comment">//</span>
00938     <span class="comment">//</span>
00939     <span class="comment">//  +-----------------------+-+----------+</span>
00940     <span class="comment">//  |  next set             |1|0        0|</span>
00941     <span class="comment">//  +-----------------------+-+----------+</span>
00942     <span class="comment">//  ...</span>
00943     <span class="comment">//</span>
00944 
00945     <span class="comment">//</span>
00946     <span class="comment">// Acquire the system space lock to synchronize access to this routine.</span>
00947     <span class="comment">//</span>
00948 
00949     PointerPte = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a655">MmFirstFreeSystemPte</a>[SystemPtePoolType];
00950     Previous = PointerPte;
00951 
00952     <span class="keywordflow">if</span> (PointerPte-&gt;u.List.NextEntry == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>) {
00953 
00954         <span class="comment">//</span>
00955         <span class="comment">// End of list and none found, return NULL or bugcheck.</span>
00956         <span class="comment">//</span>
00957 
00958         <span class="keywordflow">if</span> (BugCheckOnFailure) {
00959             <span class="keywordflow">goto</span> IssueBugcheck;
00960         }
00961 
00962         <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
00963         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00964     }
00965 
00966     PointerPte = <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a> + PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry;
00967 
00968     <span class="keywordflow">if</span> (Alignment &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) {
00969 
00970         <span class="comment">//</span>
00971         <span class="comment">// Don't deal with alignment issues.</span>
00972         <span class="comment">//</span>
00973 
00974         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00975 
00976             <span class="keywordflow">if</span> (PointerPte-&gt;u.List.OneEntry) {
00977                 SizeInSet = 1;
00978 
00979             } <span class="keywordflow">else</span> {
00980 
00981                 PointerFollowingPte = PointerPte + 1;
00982                 SizeInSet = (ULONG_PTR) PointerFollowingPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry;
00983             }
00984 
00985             <span class="keywordflow">if</span> (NumberOfPtes &lt; SizeInSet) {
00986 
00987                 <span class="comment">//</span>
00988                 <span class="comment">// Get the PTEs from this set and reduce the size of the</span>
00989                 <span class="comment">// set.  Note that the size of the current set cannot be 1.</span>
00990                 <span class="comment">//</span>
00991 
00992                 <span class="keywordflow">if</span> ((SizeInSet - NumberOfPtes) == 1) {
00993 
00994                     <span class="comment">//</span>
00995                     <span class="comment">// Collapse to the single PTE format.</span>
00996                     <span class="comment">//</span>
00997 
00998                     PointerPte-&gt;u.List.OneEntry = 1;
00999 
01000                 } <span class="keywordflow">else</span> {
01001 
01002                     PointerFollowingPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry = SizeInSet - NumberOfPtes;
01003 
01004                     <span class="comment">//</span>
01005                     <span class="comment">// Get the required PTEs from the end of the set.</span>
01006                     <span class="comment">//</span>
01007 
01008 <span class="preprocessor">#if 0</span>
01009 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a65">MM_DBG_SYS_PTES</a>) {
01010                         <a class="code" href="../../d0/d9/sysptes_8c.html#a22">MiDumpSystemPtes</a>(SystemPtePoolType);
01011                         PointerFollowingPte = PointerPte + (SizeInSet - NumberOfPtes);
01012                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"allocated 0x%lx Ptes at %lx\n"</span>,NumberOfPtes,PointerFollowingPte);
01013                     }
01014 <span class="preprocessor">#endif //0</span>
01015 <span class="preprocessor"></span>                }
01016 
01017                 <a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[SystemPtePoolType] -= NumberOfPtes;
01018 <span class="preprocessor">#if DBG</span>
01019 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a65">MM_DBG_SYS_PTES</a>) {
01020                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[SystemPtePoolType] ==
01021                              <a class="code" href="../../d0/d9/sysptes_8c.html#a23">MiCountFreeSystemPtes</a> (SystemPtePoolType));
01022                 }
01023 <span class="preprocessor">#endif //DBG</span>
01024 <span class="preprocessor"></span>
01025 <span class="preprocessor">#ifdef _MI_SYSPTE_DEBUG_</span>
01026 <span class="preprocessor"></span>                MiCheckPteAllocation (PointerPte + (SizeInSet - NumberOfPtes),
01027                                       NumberOfPtes,
01028                                       1,
01029                                       0);
01030 <span class="preprocessor">#endif</span>
01031 <span class="preprocessor"></span>
01032                 <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
01033 
01034                 PointerPte =  PointerPte + (SizeInSet - NumberOfPtes);
01035                 <span class="keywordflow">goto</span> Flush;
01036             }
01037 
01038             <span class="keywordflow">if</span> (NumberOfPtes == SizeInSet) {
01039 
01040                 <span class="comment">//</span>
01041                 <span class="comment">// Satisfy the request with this complete set and change</span>
01042                 <span class="comment">// the list to reflect the fact that this set is gone.</span>
01043                 <span class="comment">//</span>
01044 
01045                 Previous-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry = PointerPte-&gt;u.List.NextEntry;
01046 
01047                 <span class="comment">//</span>
01048                 <span class="comment">// Release the system PTE lock.</span>
01049                 <span class="comment">//</span>
01050 
01051 <span class="preprocessor">#if 0</span>
01052 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a65">MM_DBG_SYS_PTES</a>) {
01053                         <a class="code" href="../../d0/d9/sysptes_8c.html#a22">MiDumpSystemPtes</a>(SystemPtePoolType);
01054                         PointerFollowingPte = PointerPte + (SizeInSet - NumberOfPtes);
01055                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"allocated 0x%lx Ptes at %lx\n"</span>,NumberOfPtes,PointerFollowingPte);
01056                 }
01057 <span class="preprocessor">#endif //0</span>
01058 <span class="preprocessor"></span>
01059                 <a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[SystemPtePoolType] -= NumberOfPtes;
01060 <span class="preprocessor">#if DBG</span>
01061 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a65">MM_DBG_SYS_PTES</a>) {
01062                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[SystemPtePoolType] ==
01063                              <a class="code" href="../../d0/d9/sysptes_8c.html#a23">MiCountFreeSystemPtes</a> (SystemPtePoolType));
01064                 }
01065 <span class="preprocessor">#endif //DBG</span>
01066 <span class="preprocessor"></span>
01067 <span class="preprocessor">#ifdef _MI_SYSPTE_DEBUG_</span>
01068 <span class="preprocessor"></span>                MiCheckPteAllocation (PointerPte,
01069                                       NumberOfPtes,
01070                                       2,
01071                                       0);
01072 <span class="preprocessor">#endif</span>
01073 <span class="preprocessor"></span>
01074                 <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
01075                 <span class="keywordflow">goto</span> Flush;
01076             }
01077 
01078             <span class="comment">//</span>
01079             <span class="comment">// Point to the next set and try again</span>
01080             <span class="comment">//</span>
01081 
01082             <span class="keywordflow">if</span> (PointerPte-&gt;u.List.NextEntry == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>) {
01083 
01084                 <span class="comment">//</span>
01085                 <span class="comment">// End of list and none found, return NULL or bugcheck.</span>
01086                 <span class="comment">//</span>
01087 
01088                 <span class="keywordflow">if</span> (BugCheckOnFailure) {
01089                     <span class="keywordflow">goto</span> IssueBugcheck;
01090                 }
01091 
01092                 <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
01093                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01094             }
01095             Previous = PointerPte;
01096             PointerPte = <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a> + PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry;
01097             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte &gt; Previous);
01098         }
01099 
01100     } <span class="keywordflow">else</span> {
01101 
01102         <span class="comment">//</span>
01103         <span class="comment">// Deal with the alignment issues.</span>
01104         <span class="comment">//</span>
01105 
01106         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01107 
01108             <span class="keywordflow">if</span> (PointerPte-&gt;u.List.OneEntry) {
01109                 SizeInSet = 1;
01110 
01111             } <span class="keywordflow">else</span> {
01112 
01113                 PointerFollowingPte = PointerPte + 1;
01114                 SizeInSet = (ULONG_PTR) PointerFollowingPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry;
01115             }
01116 
01117             PtesToObtainAlignment = (ULONG)
01118                 (((OffsetSum - ((ULONG_PTR)PointerPte &amp; MaskSize)) &amp; MaskSize) &gt;&gt;
01119                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>);
01120 
01121             NumberOfRequiredPtes = NumberOfPtes + PtesToObtainAlignment;
01122 
01123             <span class="keywordflow">if</span> (NumberOfRequiredPtes &lt; SizeInSet) {
01124 
01125                 <span class="comment">//</span>
01126                 <span class="comment">// Get the PTEs from this set and reduce the size of the</span>
01127                 <span class="comment">// set.  Note that the size of the current set cannot be 1.</span>
01128                 <span class="comment">//</span>
01129                 <span class="comment">// This current block will be slit into 2 blocks if</span>
01130                 <span class="comment">// the PointerPte does not match the alignment.</span>
01131                 <span class="comment">//</span>
01132 
01133                 <span class="comment">//</span>
01134                 <span class="comment">// Check to see if the first PTE is on the proper</span>
01135                 <span class="comment">// alignment, if so, eliminate this block.</span>
01136                 <span class="comment">//</span>
01137 
01138                 LeftInSet = SizeInSet - NumberOfRequiredPtes;
01139 
01140                 <span class="comment">//</span>
01141                 <span class="comment">// Set up the new set at the end of this block.</span>
01142                 <span class="comment">//</span>
01143 
01144                 NextSetPointer = PointerPte + NumberOfRequiredPtes;
01145                 NextSetPointer-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry =
01146                                        PointerPte-&gt;u.List.NextEntry;
01147 
01148                 PteOffset = (ULONG_PTR)(NextSetPointer - <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a>);
01149 
01150                 <span class="keywordflow">if</span> (PtesToObtainAlignment == 0) {
01151 
01152                     Previous-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry += NumberOfRequiredPtes;
01153 
01154                 } <span class="keywordflow">else</span> {
01155 
01156                     <span class="comment">//</span>
01157                     <span class="comment">// Point to the new set at the end of the block</span>
01158                     <span class="comment">// we are giving away.</span>
01159                     <span class="comment">//</span>
01160 
01161                     PointerPte-&gt;u.List.NextEntry = PteOffset;
01162 
01163                     <span class="comment">//</span>
01164                     <span class="comment">// Update the size of the current set.</span>
01165                     <span class="comment">//</span>
01166 
01167                     <span class="keywordflow">if</span> (PtesToObtainAlignment == 1) {
01168 
01169                         <span class="comment">//</span>
01170                         <span class="comment">// Collapse to the single PTE format.</span>
01171                         <span class="comment">//</span>
01172 
01173                         PointerPte-&gt;u.List.OneEntry = 1;
01174 
01175                     } <span class="keywordflow">else</span> {
01176 
01177                         <span class="comment">//</span>
01178                         <span class="comment">// Set the set size in the next PTE.</span>
01179                         <span class="comment">//</span>
01180 
01181                         PointerFollowingPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry =
01182                                                         PtesToObtainAlignment;
01183                     }
01184                 }
01185 
01186                 <span class="comment">//</span>
01187                 <span class="comment">// Set up the new set at the end of the block.</span>
01188                 <span class="comment">//</span>
01189 
01190                 <span class="keywordflow">if</span> (LeftInSet == 1) {
01191                     NextSetPointer-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.OneEntry = 1;
01192                 } <span class="keywordflow">else</span> {
01193                     NextSetPointer-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.OneEntry = 0;
01194                     NextSetPointer += 1;
01195                     NextSetPointer-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry = LeftInSet;
01196                 }
01197                 <a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[SystemPtePoolType] -= NumberOfPtes;
01198 <span class="preprocessor">#if DBG</span>
01199 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a65">MM_DBG_SYS_PTES</a>) {
01200                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[SystemPtePoolType] ==
01201                              <a class="code" href="../../d0/d9/sysptes_8c.html#a23">MiCountFreeSystemPtes</a> (SystemPtePoolType));
01202                 }
01203 <span class="preprocessor">#endif //DBG</span>
01204 <span class="preprocessor"></span>
01205 <span class="preprocessor">#ifdef _MI_SYSPTE_DEBUG_</span>
01206 <span class="preprocessor"></span>                MiCheckPteAllocation (PointerPte + PtesToObtainAlignment,
01207                                       NumberOfPtes,
01208                                       3,
01209                                       0);
01210 <span class="preprocessor">#endif</span>
01211 <span class="preprocessor"></span>
01212                 <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
01213 
01214                 PointerPte = PointerPte + PtesToObtainAlignment;
01215                 <span class="keywordflow">goto</span> Flush;
01216             }
01217 
01218             <span class="keywordflow">if</span> (NumberOfRequiredPtes == SizeInSet) {
01219 
01220                 <span class="comment">//</span>
01221                 <span class="comment">// Satisfy the request with this complete set and change</span>
01222                 <span class="comment">// the list to reflect the fact that this set is gone.</span>
01223                 <span class="comment">//</span>
01224 
01225                 <span class="keywordflow">if</span> (PtesToObtainAlignment == 0) {
01226 
01227                     <span class="comment">//</span>
01228                     <span class="comment">// This block exactly satisfies the request.</span>
01229                     <span class="comment">//</span>
01230 
01231                     Previous-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry =
01232                                             PointerPte-&gt;u.List.NextEntry;
01233 
01234                 } <span class="keywordflow">else</span> {
01235 
01236                     <span class="comment">//</span>
01237                     <span class="comment">// A portion at the start of this block remains.</span>
01238                     <span class="comment">//</span>
01239 
01240                     <span class="keywordflow">if</span> (PtesToObtainAlignment == 1) {
01241 
01242                         <span class="comment">//</span>
01243                         <span class="comment">// Collapse to the single PTE format.</span>
01244                         <span class="comment">//</span>
01245 
01246                         PointerPte-&gt;u.List.OneEntry = 1;
01247 
01248                     } <span class="keywordflow">else</span> {
01249                       PointerFollowingPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry =
01250                                                         PtesToObtainAlignment;
01251 
01252                     }
01253                 }
01254 
01255                 <a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[SystemPtePoolType] -= NumberOfPtes;
01256 <span class="preprocessor">#if DBG</span>
01257 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a65">MM_DBG_SYS_PTES</a>) {
01258                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[SystemPtePoolType] ==
01259                              <a class="code" href="../../d0/d9/sysptes_8c.html#a23">MiCountFreeSystemPtes</a> (SystemPtePoolType));
01260                 }
01261 <span class="preprocessor">#endif //DBG</span>
01262 <span class="preprocessor"></span>
01263 <span class="preprocessor">#ifdef _MI_SYSPTE_DEBUG_</span>
01264 <span class="preprocessor"></span>                MiCheckPteAllocation (PointerPte + PtesToObtainAlignment,
01265                                       NumberOfPtes,
01266                                       4,
01267                                       0);
01268 <span class="preprocessor">#endif</span>
01269 <span class="preprocessor"></span>
01270                 <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
01271 
01272                 PointerPte = PointerPte + PtesToObtainAlignment;
01273                 <span class="keywordflow">goto</span> Flush;
01274             }
01275 
01276             <span class="comment">//</span>
01277             <span class="comment">// Point to the next set and try again</span>
01278             <span class="comment">//</span>
01279 
01280             <span class="keywordflow">if</span> (PointerPte-&gt;u.List.NextEntry == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>) {
01281 
01282                 <span class="comment">//</span>
01283                 <span class="comment">// End of list and none found, return NULL or bugcheck.</span>
01284                 <span class="comment">//</span>
01285 
01286                 <span class="keywordflow">if</span> (BugCheckOnFailure) {
01287                     <span class="keywordflow">goto</span> IssueBugcheck;
01288                 }
01289 
01290                 <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
01291                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01292             }
01293             Previous = PointerPte;
01294             PointerPte = <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a> + PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry;
01295             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte &gt; Previous);
01296         }
01297     }
01298 Flush:
01299 
01300     <span class="keywordflow">if</span> (SystemPtePoolType == <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>) {
01301         PVOID BaseAddress;
01302         ULONG j;
01303 
01304         PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a> = 0;
01305         Previous = PointerPte;
01306         BaseAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (Previous);
01307 
01308         <span class="keywordflow">for</span> (j = 0; j &lt; NumberOfPtes ; j++) {
01309             <span class="keywordflow">if</span> (PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a> != <a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>) {
01310                 PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o1">FlushPte</a>[PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a>] = Previous;
01311                 PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o2">FlushVa</a>[PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a>] = BaseAddress;
01312                 PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a> += 1;
01313             }
01314 
01315             <span class="comment">//</span>
01316             <span class="comment">// PTEs being freed better be invalid.</span>
01317             <span class="comment">//</span>
01318             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Previous-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
01319 
01320             *Previous = <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>;
01321             BaseAddress = (PVOID)((PCHAR)BaseAddress + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01322             Previous++;
01323         }
01324 
01325         <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>, &amp;OldIrql);
01326         <a class="code" href="../../d4/d8/mi_8h.html#a888">MiFlushPteList</a> (&amp;PteFlushList, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>);
01327         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
01328     }
01329     <span class="keywordflow">return</span> PointerPte;
01330 
01331 IssueBugcheck:
01332 
01333     <span class="keywordflow">if</span> (SystemPtePoolType == <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>) {
01334 
01335         HighConsumer = <a class="code" href="../../d0/d9/sysptes_8c.html#a24">MiGetHighestPteConsumer</a> (&amp;HighPteUse);
01336 
01337         <span class="keywordflow">if</span> (HighConsumer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01338             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_USED_EXCESSIVE_PTES,
01339                           (ULONG_PTR)HighConsumer,
01340                           HighPteUse,
01341                           <a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[SystemPtePoolType],
01342                           <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a>);
01343         }
01344     }
01345 
01346     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (NO_MORE_SYSTEM_PTES,
01347                   (ULONG_PTR)SystemPtePoolType,
01348                   NumberOfPtes,
01349                   <a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[SystemPtePoolType],
01350                   <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a>);
01351 }
01352 
01353 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01354"></a><a class="code" href="../../d0/d9/sysptes_8c.html#a26">01354</a> <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (
01355     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartingPte,
01356     IN ULONG NumberOfPtes,
01357     IN MMSYSTEM_PTE_POOL_TYPE SystemPtePoolType
01358     )
01359 
01360 <span class="comment">/*++</span>
01361 <span class="comment"></span>
01362 <span class="comment">Routine Description:</span>
01363 <span class="comment"></span>
01364 <span class="comment">    This function releases the specified number of PTEs</span>
01365 <span class="comment">    within the non paged portion of system space.</span>
01366 <span class="comment"></span>
01367 <span class="comment">    Note that the PTEs must be invalid and the page frame number</span>
01368 <span class="comment">    must have been set to zero.</span>
01369 <span class="comment"></span>
01370 <span class="comment">Arguments:</span>
01371 <span class="comment"></span>
01372 <span class="comment">    StartingPte - Supplies the address of the first PTE to release.</span>
01373 <span class="comment"></span>
01374 <span class="comment">    NumberOfPtes - Supplies the number of PTEs to release.</span>
01375 <span class="comment"></span>
01376 <span class="comment">    SystemPtePoolType - Supplies the PTE type of the pool to release PTEs to,</span>
01377 <span class="comment">                        one of SystemPteSpace or NonPagedPoolExpansion.</span>
01378 <span class="comment"></span>
01379 <span class="comment">Return Value:</span>
01380 <span class="comment"></span>
01381 <span class="comment">    none.</span>
01382 <span class="comment"></span>
01383 <span class="comment">Environment:</span>
01384 <span class="comment"></span>
01385 <span class="comment">    Kernel mode.</span>
01386 <span class="comment"></span>
01387 <span class="comment">--*/</span>
01388 
01389 {
01390     ULONG_PTR <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
01391     ULONG i;
01392     ULONG_PTR PteOffset;
01393     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01394     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerFollowingPte;
01395     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> NextPte;
01396     KIRQL OldIrql;
01397     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01398 <span class="preprocessor">#if defined(_IA64_)</span>
01399 <span class="preprocessor"></span>    <a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html">MMPTE_FLUSH_LIST</a> PteFlushList;
01400     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> Previous;
01401     PVOID BaseAddress;
01402 <span class="preprocessor">#endif</span>
01403 <span class="preprocessor"></span>
01404     <span class="comment">//</span>
01405     <span class="comment">// Check to make sure the PTEs don't map anything.</span>
01406     <span class="comment">//</span>
01407 
01408     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfPtes != 0);
01409 
01410 <span class="preprocessor">#ifdef _MI_GUARD_PTE_</span>
01411 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (NumberOfPtes == 0) {
01412         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SYSTEM_PTE_MISUSE,
01413                       0xD,
01414                       (ULONG_PTR)StartingPte,
01415                       NumberOfPtes,
01416                       SystemPtePoolType);
01417     }
01418 
01419     <span class="keywordflow">if</span> (SystemPtePoolType == <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>) {
01420         <span class="keywordflow">if</span> ((StartingPte + NumberOfPtes)-&gt;u.Long != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a97">MM_KERNEL_NOACCESS_PTE</a>) {
01421             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SYSTEM_PTE_MISUSE,
01422                           0xE,
01423                           (ULONG_PTR)StartingPte,
01424                           NumberOfPtes,
01425                           SystemPtePoolType);
01426         }
01427         NumberOfPtes += 1;
01428     }
01429 <span class="preprocessor">#endif</span>
01430 <span class="preprocessor"></span>
01431 <span class="preprocessor">#if DBG</span>
01432 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (StartingPte &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a14">MmSystemPtesStart</a>[SystemPtePoolType]) {
01433         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SYSTEM_PTE_MISUSE,
01434                       0xF,
01435                       (ULONG_PTR)StartingPte,
01436                       NumberOfPtes,
01437                       SystemPtePoolType);
01438     }
01439 
01440     <span class="keywordflow">if</span> (StartingPte &gt; <a class="code" href="../../d8/d5/kddata_8c.html#a15">MmSystemPtesEnd</a>[SystemPtePoolType]) {
01441         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SYSTEM_PTE_MISUSE,
01442                       0x10,
01443                       (ULONG_PTR)StartingPte,
01444                       NumberOfPtes,
01445                       SystemPtePoolType);
01446     }
01447 <span class="preprocessor">#endif //DBG</span>
01448 <span class="preprocessor"></span>
01449 <span class="preprocessor">#if 0</span>
01450 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a65">MM_DBG_SYS_PTES</a>) {
01451         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"releasing 0x%lx system PTEs at location %lx\n"</span>,NumberOfPtes,StartingPte);
01452     }
01453 <span class="preprocessor">#endif //0</span>
01454 <span class="preprocessor"></span>
01455 <span class="preprocessor">#if defined(_IA64_)</span>
01456 <span class="preprocessor"></span>
01457     PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a> = 0;
01458     Previous = StartingPte;
01459     BaseAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (Previous);
01460     <span class="keywordflow">for</span> (i = 0; i &lt; NumberOfPtes ; i++) {
01461         <span class="keywordflow">if</span> (PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a> != <a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>) {
01462             PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o1">FlushPte</a>[PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a>] = Previous;
01463             PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o2">FlushVa</a>[PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a>] = BaseAddress;
01464             PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a> += 1;
01465         }
01466         *Previous = <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>;
01467         BaseAddress = (PVOID)((PCHAR)BaseAddress + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01468         Previous++;
01469     }
01470 
01471     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>, &amp;OldIrql);
01472     <a class="code" href="../../d4/d8/mi_8h.html#a888">MiFlushPteList</a> (&amp;PteFlushList, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>);
01473     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
01474 
01475 <span class="preprocessor">#else</span>
01476 <span class="preprocessor"></span>
01477     <span class="comment">//</span>
01478     <span class="comment">// Zero PTEs.</span>
01479     <span class="comment">//</span>
01480 
01481 <span class="preprocessor">#ifdef _MI_SYSPTE_DEBUG_</span>
01482 <span class="preprocessor"></span>    MiValidateSystemPtes (StartingPte, NumberOfPtes);
01483 <span class="preprocessor">#endif</span>
01484 <span class="preprocessor"></span>
01485     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a189">MiFillMemoryPte</a> (StartingPte,
01486                      NumberOfPtes * <span class="keyword">sizeof</span> (<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>),
01487                      <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
01488 
01489 <span class="preprocessor">#ifdef _MI_SYSPTE_DEBUG_</span>
01490 <span class="preprocessor"></span>
01491     <span class="comment">//</span>
01492     <span class="comment">// Invalidate any TB entries that might have been mapped to</span>
01493     <span class="comment">// immediately prevent bad callers from corrupting the system.</span>
01494     <span class="comment">//</span>
01495 
01496     <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01497 <span class="preprocessor">#endif</span>
01498 <span class="preprocessor"></span>
01499 <span class="preprocessor">#endif</span>
01500 <span class="preprocessor"></span>
01501     <span class="comment">//</span>
01502     <span class="comment">// Acquire system space spin lock to synchronize access.</span>
01503     <span class="comment">//</span>
01504 
01505     PteOffset = (ULONG_PTR)(StartingPte - <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a>);
01506 
01507 <span class="preprocessor">#ifdef _MI_SYSPTE_DEBUG_</span>
01508 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (PteOffset == 0) {
01509         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SYSTEM_PTE_MISUSE,
01510                       0x11,
01511                       (ULONG_PTR)StartingPte,
01512                       NumberOfPtes,
01513                       SystemPtePoolType);
01514     }
01515 <span class="preprocessor">#endif</span>
01516 <span class="preprocessor"></span>
01517     <a class="code" href="../../d4/d8/mi_8h.html#a117">MiLockSystemSpace</a>(OldIrql);
01518 
01519 <span class="preprocessor">#ifdef _MI_SYSPTE_DEBUG_</span>
01520 <span class="preprocessor"></span>    MiCheckPteRelease (StartingPte, NumberOfPtes);
01521 <span class="preprocessor">#endif</span>
01522 <span class="preprocessor"></span>
01523 <span class="preprocessor">#ifndef _MI_GUARD_PTE_</span>
01524 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((SystemPtePoolType == <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>) &amp;&amp;
01525         (NumberOfPtes &lt;= <a class="code" href="../../d0/d9/sysptes_8c.html#a7">MM_PTE_TABLE_LIMIT</a>)) {
01526 
01527         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d0/d9/sysptes_8c.html#a14">MmSysPteTables</a> [NumberOfPtes];
01528         NumberOfPtes = <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a> [<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01529 
01530         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[<a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>] &gt;= <a class="code" href="../../d0/d9/sysptes_8c.html#a0">MM_MIN_SYSPTE_FREE</a>) {
01531 
01532             <span class="comment">//</span>
01533             <span class="comment">// Don't add to the pool if the size is greater than 15 + the minimum.</span>
01534             <span class="comment">//</span>
01535 
01536             i = <a class="code" href="../../d0/d9/sysptes_8c.html#a18">MmSysPteMinimumFree</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01537             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[<a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>] &gt;= <a class="code" href="../../d0/d9/sysptes_8c.html#a1">MM_MAX_SYSPTE_FREE</a>) {
01538 
01539                 <span class="comment">//</span>
01540                 <span class="comment">// Lots of free PTEs, quadruple the limit.</span>
01541                 <span class="comment">//</span>
01542 
01543                 i = i * 4;
01544             }
01545             i += 15;
01546             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d9/sysptes_8c.html#a17">MmSysPteListBySizeCount</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] &lt;= i) {
01547 
01548 <span class="preprocessor">#if DBG</span>
01549 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a65">MM_DBG_SYS_PTES</a>) {
01550                     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte1;
01551 
01552                     PointerPte1 = &amp;<a class="code" href="../../d0/d9/sysptes_8c.html#a15">MmFreeSysPteListBySize</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01553                     <span class="keywordflow">while</span> (PointerPte1-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>) {
01554                         <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerFreedPte;
01555                         ULONG j;
01556 
01557                         PointerPte1 = <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a> + PointerPte1-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry;
01558                         PointerFreedPte = PointerPte1;
01559                         <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]; j++) {
01560                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerFreedPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
01561                             PointerFreedPte++;
01562                         }
01563                     }
01564                 }
01565 <span class="preprocessor">#endif //DBG</span>
01566 <span class="preprocessor"></span>                <a class="code" href="../../d0/d9/sysptes_8c.html#a17">MmSysPteListBySizeCount</a> [<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] += 1;
01567                 PointerPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a16">MmLastSysPteListBySize</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01568                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>);
01569                 PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry = PteOffset;
01570                 <a class="code" href="../../d0/d9/sysptes_8c.html#a16">MmLastSysPteListBySize</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = StartingPte;
01571                 StartingPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>;
01572 
01573 <span class="preprocessor">#if DBG</span>
01574 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a65">MM_DBG_SYS_PTES</a>) {
01575                     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte1;
01576                     PointerPte1 = &amp;<a class="code" href="../../d0/d9/sysptes_8c.html#a15">MmFreeSysPteListBySize</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01577                     <span class="keywordflow">while</span> (PointerPte1-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>) {
01578                         <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerFreedPte;
01579                         ULONG j;
01580 
01581                         PointerPte1 = <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a> + PointerPte1-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry;
01582                         PointerFreedPte = PointerPte1;
01583                         <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]; j++) {
01584                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerFreedPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
01585                             PointerFreedPte++;
01586                         }
01587                     }
01588                 }
01589 <span class="preprocessor">#endif //DBG</span>
01590 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (NumberOfPtes == 1) {
01591                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d9/sysptes_8c.html#a11">MmFlushPte1</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01592                         <a class="code" href="../../d0/d9/sysptes_8c.html#a11">MmFlushPte1</a> = StartingPte;
01593                     }
01594                 } <span class="keywordflow">else</span> {
01595                     (StartingPte + 1)-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry = <a class="code" href="../../d4/d8/mi_8h.html#a644">MmFlushCounter</a>;
01596                 }
01597 
01598                 <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
01599                 <span class="keywordflow">return</span>;
01600             }
01601         }
01602     }
01603 <span class="preprocessor">#endif</span>
01604 <span class="preprocessor"></span>
01605     <a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[SystemPtePoolType] += NumberOfPtes;
01606 
01607     PteOffset = (ULONG_PTR)(StartingPte - <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a>);
01608     PointerPte = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a655">MmFirstFreeSystemPte</a>[SystemPtePoolType];
01609 
01610     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01611         NextPte = <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a> + PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry;
01612         <span class="keywordflow">if</span> (PteOffset &lt; PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry) {
01613 
01614             <span class="comment">//</span>
01615             <span class="comment">// Insert in the list at this point.  The</span>
01616             <span class="comment">// previous one should point to the new freed set and</span>
01617             <span class="comment">// the new freed set should point to the place</span>
01618             <span class="comment">// the previous set points to.</span>
01619             <span class="comment">//</span>
01620             <span class="comment">// Attempt to combine the clusters before we</span>
01621             <span class="comment">// insert.</span>
01622             <span class="comment">//</span>
01623             <span class="comment">// Locate the end of the current structure.</span>
01624             <span class="comment">//</span>
01625 
01626             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((StartingPte + NumberOfPtes) &lt;= NextPte) ||
01627                     (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>));
01628 
01629             PointerFollowingPte = PointerPte + 1;
01630             <span class="keywordflow">if</span> (PointerPte-&gt;u.List.OneEntry) {
01631                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 1;
01632             } <span class="keywordflow">else</span> {
01633                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = (ULONG_PTR) PointerFollowingPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry;
01634             }
01635             <span class="keywordflow">if</span> ((PointerPte + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>) == StartingPte) {
01636 
01637                 <span class="comment">//</span>
01638                 <span class="comment">// We can combine the clusters.</span>
01639                 <span class="comment">//</span>
01640 
01641                 NumberOfPtes += (ULONG)<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
01642                 PointerFollowingPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry = NumberOfPtes;
01643                 PointerPte-&gt;u.List.OneEntry = 0;
01644 
01645                 <span class="comment">//</span>
01646                 <span class="comment">// Point the starting PTE to the beginning of</span>
01647                 <span class="comment">// the new free set and try to combine with the</span>
01648                 <span class="comment">// following free cluster.</span>
01649                 <span class="comment">//</span>
01650 
01651                 StartingPte = PointerPte;
01652 
01653             } <span class="keywordflow">else</span> {
01654 
01655                 <span class="comment">//</span>
01656                 <span class="comment">// Can't combine with previous. Make this Pte the</span>
01657                 <span class="comment">// start of a cluster.</span>
01658                 <span class="comment">//</span>
01659 
01660                 <span class="comment">//</span>
01661                 <span class="comment">// Point this cluster to the next cluster.</span>
01662                 <span class="comment">//</span>
01663 
01664                 StartingPte-&gt;u.List.NextEntry = PointerPte-&gt;u.List.NextEntry;
01665 
01666                 <span class="comment">//</span>
01667                 <span class="comment">// Point the current cluster to this cluster.</span>
01668                 <span class="comment">//</span>
01669 
01670                 PointerPte-&gt;u.List.NextEntry = PteOffset;
01671 
01672                 <span class="comment">//</span>
01673                 <span class="comment">// Set the size of this cluster.</span>
01674                 <span class="comment">//</span>
01675 
01676                 <span class="keywordflow">if</span> (NumberOfPtes == 1) {
01677                     StartingPte-&gt;u.List.OneEntry = 1;
01678 
01679                 } <span class="keywordflow">else</span> {
01680                     StartingPte-&gt;u.List.OneEntry = 0;
01681                     PointerFollowingPte = StartingPte + 1;
01682                     PointerFollowingPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry = NumberOfPtes;
01683                 }
01684             }
01685 
01686             <span class="comment">//</span>
01687             <span class="comment">// Attempt to combine the newly created cluster with</span>
01688             <span class="comment">// the following cluster.</span>
01689             <span class="comment">//</span>
01690 
01691             <span class="keywordflow">if</span> ((StartingPte + NumberOfPtes) == NextPte) {
01692 
01693                 <span class="comment">//</span>
01694                 <span class="comment">// Combine with following cluster.</span>
01695                 <span class="comment">//</span>
01696 
01697                 <span class="comment">//</span>
01698                 <span class="comment">// Set the next cluster to the value contained in the</span>
01699                 <span class="comment">// cluster we are merging into this one.</span>
01700                 <span class="comment">//</span>
01701 
01702                 StartingPte-&gt;u.List.NextEntry = NextPte-&gt;u.List.NextEntry;
01703                 StartingPte-&gt;u.List.OneEntry = 0;
01704                 PointerFollowingPte = StartingPte + 1;
01705 
01706                 <span class="keywordflow">if</span> (NextPte-&gt;u.List.OneEntry) {
01707                     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 1;
01708 
01709                 } <span class="keywordflow">else</span> {
01710                     NextPte++;
01711                     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = (ULONG_PTR) NextPte-&gt;u.List.NextEntry;
01712                 }
01713                 PointerFollowingPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry = NumberOfPtes + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
01714             }
01715 <span class="preprocessor">#if 0</span>
01716 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a65">MM_DBG_SYS_PTES</a>) {
01717                 <a class="code" href="../../d0/d9/sysptes_8c.html#a22">MiDumpSystemPtes</a>(SystemPtePoolType);
01718             }
01719 <span class="preprocessor">#endif //0</span>
01720 <span class="preprocessor"></span>
01721 <span class="preprocessor">#if DBG</span>
01722 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a65">MM_DBG_SYS_PTES</a>) {
01723                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[SystemPtePoolType] ==
01724                          <a class="code" href="../../d0/d9/sysptes_8c.html#a23">MiCountFreeSystemPtes</a> (SystemPtePoolType));
01725             }
01726 <span class="preprocessor">#endif //DBG</span>
01727 <span class="preprocessor"></span>            <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
01728             <span class="keywordflow">return</span>;
01729         }
01730 
01731         <span class="comment">//</span>
01732         <span class="comment">// Point to next freed cluster.</span>
01733         <span class="comment">//</span>
01734 
01735         PointerPte = NextPte;
01736     }
01737 }
01738 
01739 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01740"></a><a class="code" href="../../d0/d9/sysptes_8c.html#a27">01740</a> <a class="code" href="../../d0/d9/sysptes_8c.html#a27">MiInitializeSystemPtes</a> (
01741     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartingPte,
01742     IN ULONG NumberOfPtes,
01743     IN MMSYSTEM_PTE_POOL_TYPE SystemPtePoolType
01744     )
01745 
01746 <span class="comment">/*++</span>
01747 <span class="comment"></span>
01748 <span class="comment">Routine Description:</span>
01749 <span class="comment"></span>
01750 <span class="comment">    This routine initializes the system PTE pool.</span>
01751 <span class="comment"></span>
01752 <span class="comment">Arguments:</span>
01753 <span class="comment"></span>
01754 <span class="comment">    StartingPte - Supplies the address of the first PTE to put in the pool.</span>
01755 <span class="comment"></span>
01756 <span class="comment">    NumberOfPtes - Supplies the number of PTEs to put in the pool.</span>
01757 <span class="comment"></span>
01758 <span class="comment">    SystemPtePoolType - Supplies the PTE type of the pool to initialize, one of</span>
01759 <span class="comment">                        SystemPteSpace or NonPagedPoolExpansion.</span>
01760 <span class="comment"></span>
01761 <span class="comment">Return Value:</span>
01762 <span class="comment"></span>
01763 <span class="comment">    none.</span>
01764 <span class="comment"></span>
01765 <span class="comment">Environment:</span>
01766 <span class="comment"></span>
01767 <span class="comment">    Kernel mode.</span>
01768 <span class="comment"></span>
01769 <span class="comment">--*/</span>
01770 
01771 {
01772     LONG i;
01773     LONG j;
01774 <span class="preprocessor">#ifdef _MI_SYSPTE_DEBUG_</span>
01775 <span class="preprocessor"></span>    PMMPTE_TRACKER Tracker;
01776 <span class="preprocessor">#endif</span>
01777 <span class="preprocessor"></span>
01778     <span class="comment">//</span>
01779     <span class="comment">// Set the base of the system PTE pool to this PTE.  This takes into</span>
01780     <span class="comment">// account that systems may have additional PTE pools below the PTE_BASE.</span>
01781     <span class="comment">//</span>
01782 
01783     <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a2">MI_PTE_BASE_FOR_LOWEST_KERNEL_ADDRESS</a>;
01784 
01785     <a class="code" href="../../d8/d5/kddata_8c.html#a14">MmSystemPtesStart</a>[SystemPtePoolType] = StartingPte;
01786     <a class="code" href="../../d8/d5/kddata_8c.html#a15">MmSystemPtesEnd</a>[SystemPtePoolType] = StartingPte + NumberOfPtes - 1;
01787 
01788     <span class="comment">//</span>
01789     <span class="comment">// If there are no PTEs specified, then make a valid chain by indicating</span>
01790     <span class="comment">// that the list is empty.</span>
01791     <span class="comment">//</span>
01792 
01793     <span class="keywordflow">if</span> (NumberOfPtes == 0) {
01794         <a class="code" href="../../d4/d8/mi_8h.html#a655">MmFirstFreeSystemPte</a>[SystemPtePoolType] = <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>;
01795         <a class="code" href="../../d4/d8/mi_8h.html#a655">MmFirstFreeSystemPte</a>[SystemPtePoolType].<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry =
01796                                                                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
01797         <span class="keywordflow">return</span>;
01798     }
01799 
01800     <span class="comment">//</span>
01801     <span class="comment">// Initialize the specified system pte pool.</span>
01802     <span class="comment">//</span>
01803 
01804     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a189">MiFillMemoryPte</a> (StartingPte,
01805                      NumberOfPtes * <span class="keyword">sizeof</span> (<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>),
01806                      <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
01807 
01808     <span class="comment">//</span>
01809     <span class="comment">// The page frame field points to the next cluster.  As we only</span>
01810     <span class="comment">// have one cluster at initialization time, mark it as the last</span>
01811     <span class="comment">// cluster.</span>
01812     <span class="comment">//</span>
01813 
01814     StartingPte-&gt;u.List.NextEntry = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
01815 
01816     <a class="code" href="../../d4/d8/mi_8h.html#a655">MmFirstFreeSystemPte</a>[SystemPtePoolType] = <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>;
01817     <a class="code" href="../../d4/d8/mi_8h.html#a655">MmFirstFreeSystemPte</a>[SystemPtePoolType].<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry =
01818                                                 StartingPte - <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a>;
01819 
01820     <span class="comment">//</span>
01821     <span class="comment">// If there is only one PTE in the pool, then mark it as a one entry</span>
01822     <span class="comment">// PTE. Otherwise, store the cluster size in the following PTE.</span>
01823     <span class="comment">//</span>
01824 
01825     <span class="keywordflow">if</span> (NumberOfPtes == 1) {
01826         StartingPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.OneEntry = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01827 
01828     } <span class="keywordflow">else</span> {
01829         StartingPte += 1;
01830         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (StartingPte, <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>);
01831         StartingPte-&gt;u.List.NextEntry = NumberOfPtes;
01832     }
01833 
01834     <span class="comment">//</span>
01835     <span class="comment">// Set the total number of free PTEs for the specified type.</span>
01836     <span class="comment">//</span>
01837 
01838     <a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[SystemPtePoolType] = NumberOfPtes;
01839 
01840     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[SystemPtePoolType] ==
01841                          <a class="code" href="../../d0/d9/sysptes_8c.html#a23">MiCountFreeSystemPtes</a> (SystemPtePoolType));
01842 
01843     <span class="keywordflow">if</span> (SystemPtePoolType == <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>) {
01844 
01845         ULONG Lists[<a class="code" href="../../d4/d8/mi_8h.html#a237">MM_SYS_PTE_TABLES_MAX</a>] = {<a class="code" href="../../d0/d9/sysptes_8c.html#a2">MM_PTE_LIST_1</a>, <a class="code" href="../../d0/d9/sysptes_8c.html#a3">MM_PTE_LIST_2</a>, <a class="code" href="../../d0/d9/sysptes_8c.html#a4">MM_PTE_LIST_4</a>, <a class="code" href="../../d0/d9/sysptes_8c.html#a5">MM_PTE_LIST_8</a>, <a class="code" href="../../d0/d9/sysptes_8c.html#a6">MM_PTE_LIST_16</a>};
01846         <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01847         ULONG total;
01848 
01849 <span class="preprocessor">#ifdef _MI_SYSPTE_DEBUG_</span>
01850 <span class="preprocessor"></span>        Tracker = (PMMPTE_TRACKER) <a class="code" href="../../d1/d6/allocpag_8c.html#a54">MiAllocatePoolPages</a> (
01851                                           <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
01852                                           NumberOfPtes * <span class="keyword">sizeof</span> (MMPTE_TRACKER),
01853                                           0);
01854 
01855         <span class="keywordflow">if</span> (Tracker) {
01856             RtlZeroMemory (Tracker, NumberOfPtes * <span class="keyword">sizeof</span> (MMPTE_TRACKER));
01857         }
01858 <span class="preprocessor">#endif</span>
01859 <span class="preprocessor"></span>
01860         <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="../../d4/d8/mi_8h.html#a237">MM_SYS_PTE_TABLES_MAX</a> ; j++) {
01861             <a class="code" href="../../d0/d9/sysptes_8c.html#a15">MmFreeSysPteListBySize</a> [j].<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>;
01862             <a class="code" href="../../d0/d9/sysptes_8c.html#a16">MmLastSysPteListBySize</a> [j] = &amp;<a class="code" href="../../d0/d9/sysptes_8c.html#a15">MmFreeSysPteListBySize</a> [j];
01863         }
01864         <a class="code" href="../../d4/d8/mi_8h.html#a644">MmFlushCounter</a> += 1;
01865 
01866 <span class="preprocessor">#ifndef _MI_GUARD_PTE_</span>
01867 <span class="preprocessor"></span>
01868         <span class="comment">//</span>
01869         <span class="comment">// Initialize the by size lists.</span>
01870         <span class="comment">//</span>
01871 
01872         total = <a class="code" href="../../d0/d9/sysptes_8c.html#a2">MM_PTE_LIST_1</a> * <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a>[0] +
01873                 <a class="code" href="../../d0/d9/sysptes_8c.html#a3">MM_PTE_LIST_2</a> * <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a>[1] +
01874                 <a class="code" href="../../d0/d9/sysptes_8c.html#a4">MM_PTE_LIST_4</a> * <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a>[2] +
01875                 <a class="code" href="../../d0/d9/sysptes_8c.html#a5">MM_PTE_LIST_8</a> * <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a>[3] +
01876                 <a class="code" href="../../d0/d9/sysptes_8c.html#a6">MM_PTE_LIST_16</a> * <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a>[4];
01877 
01878         PointerPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a> (total,
01879                                           <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>,
01880                                           64*1024,
01881                                           0,
01882                                           <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01883 
01884         <span class="keywordflow">for</span> (i = (<a class="code" href="../../d4/d8/mi_8h.html#a237">MM_SYS_PTE_TABLES_MAX</a> - 1); i &gt;= 0; i--) {
01885             <span class="keywordflow">do</span> {
01886                 Lists[i] -= 1;
01887                 <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (PointerPte,
01888                                      <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a>[i],
01889                                      <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>);
01890                 PointerPte += <a class="code" href="../../d0/d9/sysptes_8c.html#a13">MmSysPteIndex</a>[i];
01891             } <span class="keywordflow">while</span> (Lists[i] != 0  );
01892         }
01893 <span class="preprocessor">#endif</span>
01894 <span class="preprocessor"></span>
01895         <a class="code" href="../../d4/d8/mi_8h.html#a644">MmFlushCounter</a> += 1;
01896         <a class="code" href="../../d0/d9/sysptes_8c.html#a11">MmFlushPte1</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01897 
01898 <span class="preprocessor">#ifdef _MI_SYSPTE_DEBUG_</span>
01899 <span class="preprocessor"></span>        MiPteTracker = Tracker;
01900 <span class="preprocessor">#endif</span>
01901 <span class="preprocessor"></span>    }
01902 
01903     <span class="keywordflow">return</span>;
01904 }
01905 
01906 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01907"></a><a class="code" href="../../d0/d9/sysptes_8c.html#a28">01907</a> <a class="code" href="../../d0/d9/sysptes_8c.html#a28">MiAddSystemPtes</a>(
01908     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartingPte,
01909     IN ULONG  NumberOfPtes,
01910     IN MMSYSTEM_PTE_POOL_TYPE SystemPtePoolType
01911     )
01912 
01913 <span class="comment">/*++</span>
01914 <span class="comment"></span>
01915 <span class="comment">Routine Description:</span>
01916 <span class="comment"></span>
01917 <span class="comment">    This routine adds newly created PTEs to the specified pool.</span>
01918 <span class="comment"></span>
01919 <span class="comment">Arguments:</span>
01920 <span class="comment"></span>
01921 <span class="comment">    StartingPte - Supplies the address of the first PTE to put in the pool.</span>
01922 <span class="comment"></span>
01923 <span class="comment">    NumberOfPtes - Supplies the number of PTEs to put in the pool.</span>
01924 <span class="comment"></span>
01925 <span class="comment">    SystemPtePoolType - Supplies the PTE type of the pool to expand, one of</span>
01926 <span class="comment">                        SystemPteSpace or NonPagedPoolExpansion.</span>
01927 <span class="comment"></span>
01928 <span class="comment">Return Value:</span>
01929 <span class="comment"></span>
01930 <span class="comment">    None.</span>
01931 <span class="comment"></span>
01932 <span class="comment">Environment:</span>
01933 <span class="comment"></span>
01934 <span class="comment">    Kernel mode.</span>
01935 <span class="comment"></span>
01936 <span class="comment">--*/</span>
01937 
01938 {
01939     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndingPte;
01940 
01941     EndingPte = StartingPte + NumberOfPtes - 1;
01942 
01943 <span class="preprocessor">#ifdef _MI_SYSPTE_DEBUG_</span>
01944 <span class="preprocessor"></span>    MiRebuildPteTracker (StartingPte, NumberOfPtes);
01945 <span class="preprocessor">#endif</span>
01946 <span class="preprocessor"></span>
01947     <span class="keywordflow">if</span> (StartingPte &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a14">MmSystemPtesStart</a>[SystemPtePoolType]) {
01948         <a class="code" href="../../d8/d5/kddata_8c.html#a14">MmSystemPtesStart</a>[SystemPtePoolType] = StartingPte;
01949     }
01950 
01951     <span class="keywordflow">if</span> (EndingPte &gt; <a class="code" href="../../d8/d5/kddata_8c.html#a15">MmSystemPtesEnd</a>[SystemPtePoolType]) {
01952         <a class="code" href="../../d8/d5/kddata_8c.html#a15">MmSystemPtesEnd</a>[SystemPtePoolType] = EndingPte;
01953     }
01954 
01955 <span class="preprocessor">#ifdef _MI_SYSPTE_DEBUG_</span>
01956 <span class="preprocessor"></span>
01957     <span class="keywordflow">if</span> (SystemPtePoolType == <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a> &amp;&amp; MiPteTracker != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01958 
01959         ULONG i;
01960         ULONG_PTR <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01961         PMMPTE_TRACKER Tracker;
01962 
01963         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = StartingPte - <a class="code" href="../../d8/d5/kddata_8c.html#a14">MmSystemPtesStart</a>[<a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>];
01964         Tracker = &amp;MiPteTracker[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01965 
01966         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfPtes &lt; 0x10000);
01967         Tracker-&gt;NumberOfPtes = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)NumberOfPtes;
01968 
01969         <span class="keywordflow">for</span> (i = 0; i &lt; NumberOfPtes; i += 1) {
01970             Tracker-&gt;InUse = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01971             Tracker += 1;
01972         }
01973     }
01974 
01975     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a189">MiFillMemoryPte</a> (StartingPte, NumberOfPtes * <span class="keyword">sizeof</span> (<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>), <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a97">MM_KERNEL_NOACCESS_PTE</a>);
01976 <span class="preprocessor">#endif</span>
01977 <span class="preprocessor"></span>
01978 <span class="preprocessor">#ifdef _MI_GUARD_PTE_</span>
01979 <span class="preprocessor"></span>    <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (StartingPte, NumberOfPtes - 1, SystemPtePoolType);
01980 <span class="preprocessor">#else</span>
01981 <span class="preprocessor"></span>    <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (StartingPte, NumberOfPtes, SystemPtePoolType);
01982 <span class="preprocessor">#endif</span>
01983 <span class="preprocessor"></span>}
01984 
01985 
01986 ULONG
<a name="l01987"></a><a class="code" href="../../d4/d5/procsup_8c.html#a18">01987</a> <a class="code" href="../../d0/d9/sysptes_8c.html#a21">MiGetSystemPteListCount</a> (
01988     IN ULONG ListSize
01989     )
01990 
01991 <span class="comment">/*++</span>
01992 <span class="comment"></span>
01993 <span class="comment">Routine Description:</span>
01994 <span class="comment"></span>
01995 <span class="comment">    This routine returns the number of free entries of the list which</span>
01996 <span class="comment">    covers the specified size.  The size must be less than or equal to the</span>
01997 <span class="comment">    largest list index.</span>
01998 <span class="comment"></span>
01999 <span class="comment">Arguments:</span>
02000 <span class="comment"></span>
02001 <span class="comment">    ListSize - Supplies the number of PTEs needed.</span>
02002 <span class="comment"></span>
02003 <span class="comment">Return Value:</span>
02004 <span class="comment"></span>
02005 <span class="comment">    Number of free entries on the list which contains ListSize PTEs.</span>
02006 <span class="comment"></span>
02007 <span class="comment">Environment:</span>
02008 <span class="comment"></span>
02009 <span class="comment">    Kernel mode.</span>
02010 <span class="comment"></span>
02011 <span class="comment">--*/</span>
02012 
02013 {
02014 <span class="preprocessor">#ifdef _MI_GUARD_PTE_</span>
02015 <span class="preprocessor"></span>    UNREFERENCED_PARAMETER (ListSize);
02016 
02017     <span class="keywordflow">return</span> 8;
02018 <span class="preprocessor">#else</span>
02019 <span class="preprocessor"></span>    ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02020 
02021     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ListSize &lt;= <a class="code" href="../../d0/d9/sysptes_8c.html#a7">MM_PTE_TABLE_LIMIT</a>);
02022 
02023     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d0/d9/sysptes_8c.html#a14">MmSysPteTables</a> [ListSize];
02024     <span class="keywordflow">return</span> <a class="code" href="../../d0/d9/sysptes_8c.html#a17">MmSysPteListBySizeCount</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
02025 <span class="preprocessor">#endif</span>
02026 <span class="preprocessor"></span>}
02027 
02028 
02029 LOGICAL
<a name="l02030"></a><a class="code" href="../../d0/d9/sysptes_8c.html#a29">02030</a> <a class="code" href="../../d0/d9/sysptes_8c.html#a29">MiGetSystemPteAvailability</a> (
02031     IN ULONG NumberOfPtes,
02032     IN MM_PAGE_PRIORITY Priority
02033     )
02034 
02035 <span class="comment">/*++</span>
02036 <span class="comment"></span>
02037 <span class="comment">Routine Description:</span>
02038 <span class="comment"></span>
02039 <span class="comment">    This routine checks how many SystemPteSpace PTEs are available for the</span>
02040 <span class="comment">    requested size.  If plenty are available then TRUE is returned.</span>
02041 <span class="comment">    If we are reaching a low resource situation, then the request is evaluated</span>
02042 <span class="comment">    based on the argument priority.</span>
02043 <span class="comment"></span>
02044 <span class="comment">Arguments:</span>
02045 <span class="comment"></span>
02046 <span class="comment">    NumberOfPtes - Supplies the number of PTEs needed.</span>
02047 <span class="comment"></span>
02048 <span class="comment">    Priority - Supplies the priority of the request.</span>
02049 <span class="comment"></span>
02050 <span class="comment">Return Value:</span>
02051 <span class="comment"></span>
02052 <span class="comment">    TRUE if the caller should allocate the PTEs, FALSE if not.</span>
02053 <span class="comment"></span>
02054 <span class="comment">Environment:</span>
02055 <span class="comment"></span>
02056 <span class="comment">    Kernel mode.</span>
02057 <span class="comment"></span>
02058 <span class="comment">--*/</span>
02059 
02060 {
02061     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02062     ULONG FreePtes;
02063     ULONG FreeBinnedPtes;
02064 
02065     <span class="keywordflow">if</span> (Priority == <a class="code" href="../../d2/d1/mm_8h.html#a347a183">HighPagePriority</a>) {
02066         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02067     }
02068 
02069 <span class="preprocessor">#ifdef _MI_GUARD_PTE_</span>
02070 <span class="preprocessor"></span>    NumberOfPtes += 1;
02071 <span class="preprocessor">#endif</span>
02072 <span class="preprocessor"></span>
02073     FreePtes = <a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[<a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>];
02074 
02075     <span class="keywordflow">if</span> (NumberOfPtes &lt;= <a class="code" href="../../d0/d9/sysptes_8c.html#a7">MM_PTE_TABLE_LIMIT</a>) {
02076         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d0/d9/sysptes_8c.html#a14">MmSysPteTables</a> [NumberOfPtes];
02077         FreeBinnedPtes = <a class="code" href="../../d0/d9/sysptes_8c.html#a17">MmSysPteListBySizeCount</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
02078 
02079         <span class="keywordflow">if</span> (FreeBinnedPtes &gt; <a class="code" href="../../d0/d9/sysptes_8c.html#a18">MmSysPteMinimumFree</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]) {
02080             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02081         }
02082         <span class="keywordflow">if</span> (FreeBinnedPtes != 0) {
02083             <span class="keywordflow">if</span> (Priority == <a class="code" href="../../d2/d1/mm_8h.html#a347a182">NormalPagePriority</a>) {
02084                 <span class="keywordflow">if</span> (FreeBinnedPtes &gt; 1 || FreePtes &gt; 512) {
02085                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02086                 }
02087                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02088             }
02089             <span class="keywordflow">if</span> (FreePtes &gt; 2048) {
02090                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02091             }
02092             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02093         }
02094     }
02095 
02096     <span class="keywordflow">if</span> (Priority == <a class="code" href="../../d2/d1/mm_8h.html#a347a182">NormalPagePriority</a>) {
02097         <span class="keywordflow">if</span> ((LONG)NumberOfPtes &lt; (LONG)FreePtes - 512) {
02098             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02099         }
02100         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02101     }
02102 
02103     <span class="keywordflow">if</span> ((LONG)NumberOfPtes &lt; (LONG)FreePtes - 2048) {
02104         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02105     }
02106     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02107 }
02108 
02109 <span class="preprocessor">#if DBG</span>
02110 <span class="preprocessor"></span>
02111 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02112 <a class="code" href="../../d0/d9/sysptes_8c.html#a22">MiDumpSystemPtes</a> (
02113     IN MMSYSTEM_PTE_POOL_TYPE SystemPtePoolType
02114     )
02115 
02116 
02117 {
02118     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02119     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerNextPte;
02120     ULONG_PTR ClusterSize;
02121     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndOfCluster;
02122 
02123     PointerPte = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a655">MmFirstFreeSystemPte</a>[SystemPtePoolType];
02124     <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>) {
02125         <span class="keywordflow">return</span>;
02126     }
02127 
02128     PointerPte = <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a> + PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry;
02129 
02130     <span class="keywordflow">for</span> (;;) {
02131         <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.OneEntry) {
02132             ClusterSize = 1;
02133         } <span class="keywordflow">else</span> {
02134             PointerNextPte = PointerPte + 1;
02135             ClusterSize = (ULONG_PTR) PointerNextPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry;
02136         }
02137 
02138         EndOfCluster = PointerPte + (ClusterSize - 1);
02139 
02140         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"System Pte at %p for %p entries (%p)\n"</span>,
02141                 PointerPte, ClusterSize, EndOfCluster);
02142 
02143         <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>) {
02144             <span class="keywordflow">break</span>;
02145         }
02146 
02147         PointerPte = <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a> + PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry;
02148     }
02149     <span class="keywordflow">return</span>;
02150 }
02151 
02152 ULONG
02153 <a class="code" href="../../d0/d9/sysptes_8c.html#a23">MiCountFreeSystemPtes</a> (
02154     IN MMSYSTEM_PTE_POOL_TYPE SystemPtePoolType
02155     )
02156 
02157 {
02158     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02159     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerNextPte;
02160     ULONG_PTR ClusterSize;
02161     ULONG_PTR FreeCount;
02162 
02163     PointerPte = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a655">MmFirstFreeSystemPte</a>[SystemPtePoolType];
02164     <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>) {
02165         <span class="keywordflow">return</span> 0;
02166     }
02167 
02168     FreeCount = 0;
02169 
02170     PointerPte = <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a> + PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry;
02171 
02172     <span class="keywordflow">for</span> (;;) {
02173         <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.OneEntry) {
02174             ClusterSize = 1;
02175 
02176         } <span class="keywordflow">else</span> {
02177             PointerNextPte = PointerPte + 1;
02178             ClusterSize = (ULONG_PTR) PointerNextPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry;
02179         }
02180 
02181         FreeCount += ClusterSize;
02182         <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>) {
02183             <span class="keywordflow">break</span>;
02184         }
02185 
02186         PointerPte = <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a> + PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry;
02187     }
02188 
02189     <span class="keywordflow">return</span> (ULONG)FreeCount;
02190 }
02191 
02192 <span class="preprocessor">#endif //DBG</span>
02193 <span class="preprocessor"></span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:57 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
