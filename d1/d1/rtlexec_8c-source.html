<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: rtlexec.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>rtlexec.c</h1><a href="../../d0/d2/rtlexec_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    rtlexec.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    User Mode routines for creating user mode processes and threads.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Steve Wood (stevewo) 18-Aug-1989</span>
00016 <span class="comment"></span>
00017 <span class="comment">Environment:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    User Mode or Kernel Mode</span>
00020 <span class="comment"></span>
00021 <span class="comment">Revision History:</span>
00022 <span class="comment"></span>
00023 <span class="comment">--*/</span>
00024 
00025 <span class="preprocessor">#include "<a class="code" href="../../d5/d9/ntrtlp_8h.html">ntrtlp.h</a>"</span>
00026 <span class="preprocessor">#include &lt;nturtl.h&gt;</span>
00027 <span class="preprocessor">#include &lt;string.h&gt;</span>
00028 <span class="preprocessor">#include "<a class="code" href="../../d8/d1/init_8h.html">init.h</a>"</span>
00029 <span class="preprocessor">#include "<a class="code" href="../../d9/d8/ntos_8h.html">ntos.h</a>"</span>
<a name="l00030"></a><a class="code" href="../../d0/d2/rtlexec_8c.html#a0">00030</a> <span class="preprocessor">#define ROUND_UP( x, y )  ((ULONG)(x) + ((y)-1) &amp; ~((y)-1))</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#ifdef KERNEL</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#define ISTERMINALSERVER() (SharedUserData-&gt;SuiteMask &amp; (1 &lt;&lt; TerminalServer))</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00034"></a><a class="code" href="../../d0/d2/rtlexec_8c.html#a1">00034</a> <span class="preprocessor"></span><span class="preprocessor">#define ISTERMINALSERVER() (USER_SHARED_DATA-&gt;SuiteMask &amp; (1 &lt;&lt; TerminalServer))</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00036 <span class="preprocessor"></span>
00037 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00038 <a class="code" href="../../d0/d2/rtlexec_8c.html#a4">RtlpCopyProcString</a>(
00039     IN OUT PWSTR *pDst,
00040     OUT PUNICODE_STRING DestString,
00041     IN PUNICODE_STRING SourceString,
00042     IN ULONG DstAlloc OPTIONAL
00043     );
00044 
00045 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00046 <a class="code" href="../../d0/d2/rtlexec_8c.html#a5">RtlpOpenImageFile</a>(
00047     IN PUNICODE_STRING ImagePathName,
00048     IN ULONG Attributes,
00049     OUT PHANDLE FileHandle,
00050     IN BOOLEAN ReportErrors
00051     );
00052 
00053 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00054 <a class="code" href="../../d0/d2/rtlexec_8c.html#a6">RtlpFreeStack</a>(
00055     IN HANDLE Process,
00056     IN PINITIAL_TEB InitialTeb
00057     );
00058 
00059 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00060 <a class="code" href="../../d0/d2/rtlexec_8c.html#a7">RtlpCreateStack</a>(
00061     IN HANDLE Process,
00062     IN SIZE_T MaximumStackSize OPTIONAL,
00063     IN SIZE_T CommittedStackSize OPTIONAL,
00064     IN ULONG ZeroBits OPTIONAL,
00065     OUT PINITIAL_TEB InitialTeb
00066     );
00067 
00068 <span class="preprocessor">#if defined(ALLOC_PRAGMA) &amp;&amp; defined(NTOS_KERNEL_RUNTIME)</span>
00069 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,RtlpCopyProcString          )</span>
00070 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,RtlCreateProcessParameters  )</span>
00071 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,RtlDestroyProcessParameters )</span>
00072 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,RtlNormalizeProcessParams   )</span>
00073 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,RtlDeNormalizeProcessParams )</span>
00074 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,RtlpOpenImageFile           )</span>
00075 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,RtlpCreateStack             )</span>
00076 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,RtlpFreeStack               )</span>
00077 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,RtlCreateUserProcess        )</span>
00078 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,RtlCreateUserThread         )</span>
00079 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00080 <span class="preprocessor"></span>
00081 
00082 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00083"></a><a class="code" href="../../d0/d2/rtlexec_8c.html#a4">00083</a> <a class="code" href="../../d0/d2/rtlexec_8c.html#a4">RtlpCopyProcString</a>(
00084     IN OUT PWSTR *pDst,
00085     OUT PUNICODE_STRING DestString,
00086     IN PUNICODE_STRING SourceString,
00087     IN ULONG DstAlloc OPTIONAL
00088     )
00089 {
00090     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( (ULONG_PTR)DstAlloc )) {
00091         DstAlloc = <a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>-&gt;MaximumLength;
00092         }
00093 
00094     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>-&gt;Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>-&gt;Length != 0) {
00095         RtlMoveMemory( *pDst,
00096                        <a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>-&gt;Buffer,
00097                        <a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>-&gt;Length
00098                      );
00099         }
00100 
00101     <a class="code" href="../../d0/d2/usrbench_8h.html#a35">DestString</a>-&gt;Buffer = *pDst;
00102     <a class="code" href="../../d0/d2/usrbench_8h.html#a35">DestString</a>-&gt;Length = <a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>-&gt;Length;
00103     <a class="code" href="../../d0/d2/usrbench_8h.html#a35">DestString</a>-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)DstAlloc;
00104 
00105     *pDst = (PWSTR)((PCHAR)(*pDst) + <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>( DstAlloc, <span class="keyword">sizeof</span>( ULONG ) ) );
00106     <span class="keywordflow">return</span>;
00107 }
00108 
00109 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00110"></a><a class="code" href="../../d0/d2/rtlexec_8c.html#a8">00110</a> <a class="code" href="../../d0/d2/rtlexec_8c.html#a8">RtlCreateProcessParameters</a>(
00111     OUT PRTL_USER_PROCESS_PARAMETERS *ProcessParameters,
00112     IN PUNICODE_STRING ImagePathName,
00113     IN PUNICODE_STRING DllPath OPTIONAL,
00114     IN PUNICODE_STRING CurrentDirectory OPTIONAL,
00115     IN PUNICODE_STRING CommandLine OPTIONAL,
00116     IN PVOID Environment OPTIONAL,
00117     IN PUNICODE_STRING WindowTitle OPTIONAL,
00118     IN PUNICODE_STRING DesktopInfo OPTIONAL,
00119     IN PUNICODE_STRING ShellInfo OPTIONAL,
00120     IN PUNICODE_STRING RuntimeData OPTIONAL
00121     )
00122 
00123 <span class="comment">/*++</span>
00124 <span class="comment"></span>
00125 <span class="comment">Routine Description:</span>
00126 <span class="comment"></span>
00127 <span class="comment">    This function formats NT style RTL_USER_PROCESS_PARAMETERS</span>
00128 <span class="comment">    record.  The record is self-contained in a single block of memory</span>
00129 <span class="comment">    allocated by this function.  The allocation method is opaque and</span>
00130 <span class="comment">    thus the record must be freed by calling the</span>
00131 <span class="comment">    RtlDestroyProcessParameters function.</span>
00132 <span class="comment"></span>
00133 <span class="comment">    The process parameters record is created in a de-normalized form,</span>
00134 <span class="comment">    thus making it suitable for passing to the RtlCreateUserProcess</span>
00135 <span class="comment">    function.  It is expected that the caller will fill in additional</span>
00136 <span class="comment">    fields in the process parameters record after this function returns,</span>
00137 <span class="comment">    but prior to calling RtlCreateUserProcess.</span>
00138 <span class="comment"></span>
00139 <span class="comment">Arguments:</span>
00140 <span class="comment"></span>
00141 <span class="comment">    ProcessParameters - Pointer to a variable that will receive the address</span>
00142 <span class="comment">        of the process parameter structure created by this routinue.  The</span>
00143 <span class="comment">        memory for the structure is allocated in an opaque manner and must</span>
00144 <span class="comment">        be freed by calling RtlDestroyProcessParameters.</span>
00145 <span class="comment"></span>
00146 <span class="comment">    ImagePathName - Required parameter that is the fully qualified NT</span>
00147 <span class="comment">        path name of the image file that will be used to create the process</span>
00148 <span class="comment">        that will received these parameters.</span>
00149 <span class="comment"></span>
00150 <span class="comment">    DllPath - An optional parameter that is an NT String variable pointing</span>
00151 <span class="comment">        to the search path the NT Loader is to use in the target process</span>
00152 <span class="comment">        when searching for Dll modules.  If not specified, then the Dll</span>
00153 <span class="comment">        search path is filled in from the current process's Dll search</span>
00154 <span class="comment">        path.</span>
00155 <span class="comment"></span>
00156 <span class="comment">    CurrentDirectory - An optional parameter that is an NT String variable</span>
00157 <span class="comment">        pointing to the default directory string for the target process.</span>
00158 <span class="comment">        If not specified, then the current directory string is filled in</span>
00159 <span class="comment">        from the current process's current directory string.</span>
00160 <span class="comment"></span>
00161 <span class="comment">    CommandLine - An optional parameter that is an NT String variable that</span>
00162 <span class="comment">        will be passed to the target process as its command line.  If not</span>
00163 <span class="comment">        specified, then the command line passed to the target process will</span>
00164 <span class="comment">        be a null string.</span>
00165 <span class="comment"></span>
00166 <span class="comment">    Environment - An optional parameter that is an opaque pointer to an</span>
00167 <span class="comment">        environment variable block of the type created by</span>
00168 <span class="comment">        RtlCreateEnvironment routine.  If not specified, then the target</span>
00169 <span class="comment">        process will receive a copy of the calling process's environment</span>
00170 <span class="comment">        variable block.</span>
00171 <span class="comment"></span>
00172 <span class="comment">    WindowTitle - An optional parameter that is an NT String variable that</span>
00173 <span class="comment">        points to the title string the target process is to use for its</span>
00174 <span class="comment">        main window.  If not specified, then a null string will be passed</span>
00175 <span class="comment">        to the target process as its default window title.</span>
00176 <span class="comment"></span>
00177 <span class="comment">    DesktopInfo - An optional parameter that is an NT String variable that</span>
00178 <span class="comment">        contains uninterpreted data that is passed as is to the target</span>
00179 <span class="comment">        process.  If not specified, the target process will receive a</span>
00180 <span class="comment">        pointer to an empty string.</span>
00181 <span class="comment"></span>
00182 <span class="comment">    ShellInfo - An optional parameter that is an NT String variable that</span>
00183 <span class="comment">        contains uninterpreted data that is passed as is to the target</span>
00184 <span class="comment">        process.  If not specified, the target process will receive a</span>
00185 <span class="comment">        pointer to an empty string.</span>
00186 <span class="comment"></span>
00187 <span class="comment">    RuntimeData - An optional parameter that is an NT String variable that</span>
00188 <span class="comment">        contains uninterpreted data that is passed as is to the target</span>
00189 <span class="comment">        process.  If not specified, the target process will receive a</span>
00190 <span class="comment">        pointer to an empty string.</span>
00191 <span class="comment"></span>
00192 <span class="comment">Return Value:</span>
00193 <span class="comment"></span>
00194 <span class="comment">    STATUS_SUCCESS - The process parameters is De-Normalized and</span>
00195 <span class="comment">        contains entries for each of the specified argument and variable</span>
00196 <span class="comment">        strings.</span>
00197 <span class="comment"></span>
00198 <span class="comment">    STATUS_BUFFER_TOO_SMALL - The specified process parameters buffer is</span>
00199 <span class="comment">        too small to contain the argument and environment strings. The value</span>
00200 <span class="comment">        of ProcessParameters-&gt;Length is modified to contain the buffer</span>
00201 <span class="comment">        size needed to contain the argument and variable strings.</span>
00202 <span class="comment"></span>
00203 <span class="comment">--*/</span>
00204 
00205 {
00206     PRTL_USER_PROCESS_PARAMETERS p;
00207     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00208     UNICODE_STRING NullString = {0, 1, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>};
00209     ULONG ByteCount;
00210     SIZE_T MaxByteCount;
00211     PWSTR pDst;
00212     PPEB Peb = NtCurrentPeb();
00213     HANDLE CurDirHandle;
00214 
00215     <span class="comment">//</span>
00216     <span class="comment">// Acquire the Peb Lock for the duration while we copy information out</span>
00217     <span class="comment">// of it.</span>
00218     <span class="comment">//</span>
00219 
00220     <a class="code" href="../../d2/d4/eballoc_8c.html#a1">RtlAcquirePebLock</a>();
00221     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00222     p = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00223     CurDirHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00224     <span class="keywordflow">try</span> {
00225         <span class="comment">//</span>
00226         <span class="comment">// For optional pointer parameters, default them to point to their</span>
00227         <span class="comment">// corresponding field in the current process's process parameter</span>
00228         <span class="comment">// structure or to a null string.</span>
00229         <span class="comment">//</span>
00230 
00231         <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( DllPath )) {
00232             DllPath = &amp;Peb-&gt;ProcessParameters-&gt;DllPath;
00233             }
00234 
00235         <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( <a class="code" href="../../d2/d5/editreg_8c.html#a47">CurrentDirectory</a> )) {
00236 
00237             <span class="keywordflow">if</span> ( Peb-&gt;ProcessParameters-&gt;CurrentDirectory.Handle ) {
00238                 CurDirHandle = (HANDLE)((ULONG_PTR)Peb-&gt;ProcessParameters-&gt;CurrentDirectory.Handle &amp; ~OBJ_HANDLE_TAGBITS);
00239                 CurDirHandle = (HANDLE)((ULONG_PTR)CurDirHandle | RTL_USER_PROC_CURDIR_INHERIT);
00240                 }
00241             <a class="code" href="../../d2/d5/editreg_8c.html#a47">CurrentDirectory</a> = &amp;Peb-&gt;ProcessParameters-&gt;CurrentDirectory.DosPath;
00242             }
00243         <span class="keywordflow">else</span> {
00244             <span class="keywordflow">if</span> ( Peb-&gt;ProcessParameters-&gt;CurrentDirectory.Handle ) {
00245                 CurDirHandle = (HANDLE)((ULONG_PTR)Peb-&gt;ProcessParameters-&gt;CurrentDirectory.Handle &amp; ~OBJ_HANDLE_TAGBITS);
00246                 CurDirHandle = (HANDLE)((ULONG_PTR)CurDirHandle | RTL_USER_PROC_CURDIR_CLOSE);
00247                 }
00248             }
00249 
00250         <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( <a class="code" href="../../d2/d5/editreg_8c.html#a48">CommandLine</a> )) {
00251             <a class="code" href="../../d2/d5/editreg_8c.html#a48">CommandLine</a> = ImagePathName;
00252             }
00253 
00254         <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( Environment )) {
00255             Environment = Peb-&gt;ProcessParameters-&gt;Environment;
00256             }
00257 
00258         <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( WindowTitle )) {
00259             WindowTitle = &amp;NullString;
00260             }
00261 
00262         <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( DesktopInfo )) {
00263             DesktopInfo = &amp;NullString;
00264             }
00265 
00266         <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( ShellInfo )) {
00267             ShellInfo = &amp;NullString;
00268             }
00269 
00270         <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( RuntimeData )) {
00271             RuntimeData = &amp;NullString;
00272             }
00273 
00274         <span class="comment">//</span>
00275         <span class="comment">// Determine size need to contain the process parameter record</span>
00276         <span class="comment">// structure and all of the strings it will point to.  Each string</span>
00277         <span class="comment">// will be aligned on a ULONG byte boundary.</span>
00278         <span class="comment">//</span>
00279 
00280         ByteCount = <span class="keyword">sizeof</span>( **ProcessParameters );
00281         ByteCount += <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>( ImagePathName-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL),    <span class="keyword">sizeof</span>( ULONG ) );
00282         ByteCount += <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>( DllPath-&gt;MaximumLength,       <span class="keyword">sizeof</span>( ULONG ) );
00283         ByteCount += <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>( DOS_MAX_PATH_LENGTH*2,        <span class="keyword">sizeof</span>( ULONG ) );
00284         ByteCount += <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>( <a class="code" href="../../d2/d5/editreg_8c.html#a48">CommandLine</a>-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL),      <span class="keyword">sizeof</span>( ULONG ) );
00285         ByteCount += <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>( WindowTitle-&gt;MaximumLength,   <span class="keyword">sizeof</span>( ULONG ) );
00286         ByteCount += <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>( DesktopInfo-&gt;MaximumLength,   <span class="keyword">sizeof</span>( ULONG ) );
00287         ByteCount += <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>( ShellInfo-&gt;MaximumLength,     <span class="keyword">sizeof</span>( ULONG ) );
00288         ByteCount += <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>( RuntimeData-&gt;MaximumLength,   <span class="keyword">sizeof</span>( ULONG ) );
00289 
00290         <span class="comment">//</span>
00291         <span class="comment">// Allocate memory for the process parameter record.</span>
00292         <span class="comment">//</span>
00293 
00294         MaxByteCount = ByteCount;
00295         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory( NtCurrentProcess(),
00296                                           (PVOID *)&amp;p,
00297                                           0,
00298                                           &amp;MaxByteCount,
00299                                           MEM_COMMIT,
00300                                           PAGE_READWRITE
00301                                         );
00302         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00303             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00304             }
00305 
00306         p-&gt;MaximumLength = (ULONG) MaxByteCount;
00307         p-&gt;Length = ByteCount;
00308         p-&gt;Flags = RTL_USER_PROC_PARAMS_NORMALIZED;
00309         p-&gt;Environment = Environment;
00310         p-&gt;CurrentDirectory.Handle = CurDirHandle;
00311 
00312         <span class="comment">//</span>
00313         <span class="comment">// Inherits ^C inhibit information</span>
00314         <span class="comment">//</span>
00315 
00316         p-&gt;ConsoleFlags = Peb-&gt;ProcessParameters-&gt;ConsoleFlags;
00317 
00318         pDst = (PWSTR)(p + 1);
00319         <a class="code" href="../../d0/d2/rtlexec_8c.html#a4">RtlpCopyProcString</a>( &amp;pDst,
00320                             &amp;p-&gt;CurrentDirectory.DosPath,
00321                             <a class="code" href="../../d2/d5/editreg_8c.html#a47">CurrentDirectory</a>,
00322                             DOS_MAX_PATH_LENGTH*2
00323                           );
00324 
00325         <a class="code" href="../../d0/d2/rtlexec_8c.html#a4">RtlpCopyProcString</a>( &amp;pDst, &amp;p-&gt;DllPath, DllPath, 0 );
00326         <a class="code" href="../../d0/d2/rtlexec_8c.html#a4">RtlpCopyProcString</a>( &amp;pDst, &amp;p-&gt;ImagePathName, ImagePathName, ImagePathName-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL) );
00327         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d5/editreg_8c.html#a48">CommandLine</a>-&gt;Length == <a class="code" href="../../d2/d5/editreg_8c.html#a48">CommandLine</a>-&gt;MaximumLength) {
00328             <a class="code" href="../../d0/d2/rtlexec_8c.html#a4">RtlpCopyProcString</a>( &amp;pDst, &amp;p-&gt;CommandLine, <a class="code" href="../../d2/d5/editreg_8c.html#a48">CommandLine</a>, 0 );
00329             }
00330         <span class="keywordflow">else</span> {
00331             <a class="code" href="../../d0/d2/rtlexec_8c.html#a4">RtlpCopyProcString</a>( &amp;pDst, &amp;p-&gt;CommandLine, <a class="code" href="../../d2/d5/editreg_8c.html#a48">CommandLine</a>, <a class="code" href="../../d2/d5/editreg_8c.html#a48">CommandLine</a>-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL) );
00332             }
00333         <a class="code" href="../../d0/d2/rtlexec_8c.html#a4">RtlpCopyProcString</a>( &amp;pDst, &amp;p-&gt;WindowTitle, WindowTitle, 0 );
00334         <a class="code" href="../../d0/d2/rtlexec_8c.html#a4">RtlpCopyProcString</a>( &amp;pDst, &amp;p-&gt;DesktopInfo, DesktopInfo, 0 );
00335         <a class="code" href="../../d0/d2/rtlexec_8c.html#a4">RtlpCopyProcString</a>( &amp;pDst, &amp;p-&gt;ShellInfo,   ShellInfo, 0 );
00336         <span class="keywordflow">if</span> (RuntimeData-&gt;Length != 0) {
00337             <a class="code" href="../../d0/d2/rtlexec_8c.html#a4">RtlpCopyProcString</a>( &amp;pDst, &amp;p-&gt;RuntimeData, RuntimeData, 0 );
00338             }
00339         <span class="keywordflow">else</span> {
00340             p-&gt;RuntimeData.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00341             p-&gt;RuntimeData.Length = 0;
00342             p-&gt;RuntimeData.MaximumLength = 0;
00343             }
00344         *ProcessParameters = <a class="code" href="../../d0/d2/rtlexec_8c.html#a11">RtlDeNormalizeProcessParams</a>( p );
00345         p = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00346         }
00347     finally {
00348         <span class="keywordflow">if</span> (AbnormalTermination()) {
00349             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_VIOLATION;
00350             }
00351 
00352         <span class="keywordflow">if</span> (p != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00353             <a class="code" href="../../d0/d2/rtlexec_8c.html#a9">RtlDestroyProcessParameters</a>( p );
00354             }
00355 
00356         <a class="code" href="../../d2/d4/eballoc_8c.html#a2">RtlReleasePebLock</a>();
00357         }
00358 
00359     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00360 }
00361 
00362 
00363 
00364 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00365"></a><a class="code" href="../../d0/d2/rtlexec_8c.html#a9">00365</a> <a class="code" href="../../d0/d2/rtlexec_8c.html#a9">RtlDestroyProcessParameters</a>(
00366     IN PRTL_USER_PROCESS_PARAMETERS ProcessParameters
00367     )
00368 {
00369     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00370     SIZE_T RegionSize;
00371 
00372     RegionSize = 0;
00373     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwFreeVirtualMemory( NtCurrentProcess(),
00374                                   (PVOID *)&amp;ProcessParameters,
00375                                   &amp;RegionSize,
00376                                   MEM_RELEASE
00377                                 );
00378 
00379     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00380 }
00381 
00382 
<a name="l00383"></a><a class="code" href="../../d0/d2/rtlexec_8c.html#a2">00383</a> <span class="preprocessor">#define RtlpNormalizeProcessParam( Base, p )        \</span>
00384 <span class="preprocessor">    if ((p) != NULL) {                              \</span>
00385 <span class="preprocessor">        (p) = (PWSTR)((PCHAR)(p) + (ULONG_PTR)(Base));  \</span>
00386 <span class="preprocessor">        }                                           \</span>
00387 <span class="preprocessor"></span>
<a name="l00388"></a><a class="code" href="../../d0/d2/rtlexec_8c.html#a3">00388</a> <span class="preprocessor"></span><span class="preprocessor">#define RtlpDeNormalizeProcessParam( Base, p )      \</span>
00389 <span class="preprocessor">    if ((p) != NULL) {                              \</span>
00390 <span class="preprocessor">        (p) = (PWSTR)((PCHAR)(p) - (ULONG_PTR)(Base));  \</span>
00391 <span class="preprocessor">        }                                           \</span>
00392 <span class="preprocessor"></span>
00393 <span class="preprocessor"></span>
00394 PRTL_USER_PROCESS_PARAMETERS
<a name="l00395"></a><a class="code" href="../../d0/d2/rtlexec_8c.html#a10">00395</a> <a class="code" href="../../d0/d2/rtlexec_8c.html#a10">RtlNormalizeProcessParams</a>(
00396     IN OUT PRTL_USER_PROCESS_PARAMETERS ProcessParameters
00397     )
00398 {
00399     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( ProcessParameters )) {
00400         <span class="keywordflow">return</span>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00401         }
00402 
00403     <span class="keywordflow">if</span> (ProcessParameters-&gt;Flags &amp; RTL_USER_PROC_PARAMS_NORMALIZED) {
00404         <span class="keywordflow">return</span>( ProcessParameters );
00405         }
00406 
00407     <a class="code" href="../../d0/d2/rtlexec_8c.html#a2">RtlpNormalizeProcessParam</a>( ProcessParameters,
00408                                ProcessParameters-&gt;CurrentDirectory.DosPath.Buffer
00409                              );
00410 
00411     <a class="code" href="../../d0/d2/rtlexec_8c.html#a2">RtlpNormalizeProcessParam</a>( ProcessParameters,
00412                                ProcessParameters-&gt;DllPath.Buffer
00413                              );
00414 
00415     <a class="code" href="../../d0/d2/rtlexec_8c.html#a2">RtlpNormalizeProcessParam</a>( ProcessParameters,
00416                                ProcessParameters-&gt;ImagePathName.Buffer
00417                              );
00418 
00419     <a class="code" href="../../d0/d2/rtlexec_8c.html#a2">RtlpNormalizeProcessParam</a>( ProcessParameters,
00420                                ProcessParameters-&gt;CommandLine.Buffer
00421                              );
00422 
00423     <a class="code" href="../../d0/d2/rtlexec_8c.html#a2">RtlpNormalizeProcessParam</a>( ProcessParameters,
00424                                ProcessParameters-&gt;WindowTitle.Buffer
00425                              );
00426 
00427     <a class="code" href="../../d0/d2/rtlexec_8c.html#a2">RtlpNormalizeProcessParam</a>( ProcessParameters,
00428                                ProcessParameters-&gt;DesktopInfo.Buffer
00429                              );
00430 
00431     <a class="code" href="../../d0/d2/rtlexec_8c.html#a2">RtlpNormalizeProcessParam</a>( ProcessParameters,
00432                                ProcessParameters-&gt;ShellInfo.Buffer
00433                              );
00434 
00435     <a class="code" href="../../d0/d2/rtlexec_8c.html#a2">RtlpNormalizeProcessParam</a>( ProcessParameters,
00436                                ProcessParameters-&gt;RuntimeData.Buffer
00437                              );
00438     ProcessParameters-&gt;Flags |= RTL_USER_PROC_PARAMS_NORMALIZED;
00439 
00440     <span class="keywordflow">return</span>( ProcessParameters );
00441 }
00442 
00443 PRTL_USER_PROCESS_PARAMETERS
<a name="l00444"></a><a class="code" href="../../d0/d2/rtlexec_8c.html#a11">00444</a> <a class="code" href="../../d0/d2/rtlexec_8c.html#a11">RtlDeNormalizeProcessParams</a>(
00445     IN OUT PRTL_USER_PROCESS_PARAMETERS ProcessParameters
00446     )
00447 {
00448     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( ProcessParameters )) {
00449         <span class="keywordflow">return</span>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00450         }
00451 
00452     <span class="keywordflow">if</span> (!(ProcessParameters-&gt;Flags &amp; RTL_USER_PROC_PARAMS_NORMALIZED)) {
00453         <span class="keywordflow">return</span>( ProcessParameters );
00454         }
00455 
00456     <a class="code" href="../../d0/d2/rtlexec_8c.html#a3">RtlpDeNormalizeProcessParam</a>( ProcessParameters,
00457                                  ProcessParameters-&gt;CurrentDirectory.DosPath.Buffer
00458                                );
00459 
00460     <a class="code" href="../../d0/d2/rtlexec_8c.html#a3">RtlpDeNormalizeProcessParam</a>( ProcessParameters,
00461                                  ProcessParameters-&gt;DllPath.Buffer
00462                                );
00463 
00464     <a class="code" href="../../d0/d2/rtlexec_8c.html#a3">RtlpDeNormalizeProcessParam</a>( ProcessParameters,
00465                                  ProcessParameters-&gt;ImagePathName.Buffer
00466                                );
00467 
00468     <a class="code" href="../../d0/d2/rtlexec_8c.html#a3">RtlpDeNormalizeProcessParam</a>( ProcessParameters,
00469                                  ProcessParameters-&gt;CommandLine.Buffer
00470                                );
00471 
00472     <a class="code" href="../../d0/d2/rtlexec_8c.html#a3">RtlpDeNormalizeProcessParam</a>( ProcessParameters,
00473                                  ProcessParameters-&gt;WindowTitle.Buffer
00474                                );
00475 
00476     <a class="code" href="../../d0/d2/rtlexec_8c.html#a3">RtlpDeNormalizeProcessParam</a>( ProcessParameters,
00477                                  ProcessParameters-&gt;DesktopInfo.Buffer
00478                                );
00479 
00480     <a class="code" href="../../d0/d2/rtlexec_8c.html#a3">RtlpDeNormalizeProcessParam</a>( ProcessParameters,
00481                                  ProcessParameters-&gt;ShellInfo.Buffer
00482                                );
00483 
00484     <a class="code" href="../../d0/d2/rtlexec_8c.html#a3">RtlpDeNormalizeProcessParam</a>( ProcessParameters,
00485                                  ProcessParameters-&gt;RuntimeData.Buffer
00486                                );
00487 
00488     ProcessParameters-&gt;Flags &amp;= ~RTL_USER_PROC_PARAMS_NORMALIZED;
00489     <span class="keywordflow">return</span>( ProcessParameters );
00490 }
00491 
00492 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00493"></a><a class="code" href="../../d0/d2/rtlexec_8c.html#a5">00493</a> <a class="code" href="../../d0/d2/rtlexec_8c.html#a5">RtlpOpenImageFile</a>(
00494     IN PUNICODE_STRING ImagePathName,
00495     IN ULONG Attributes,
00496     OUT PHANDLE FileHandle,
00497     IN BOOLEAN ReportErrors
00498     )
00499 {
00500     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00501     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00502     HANDLE <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>;
00503     IO_STATUS_BLOCK IoStatus;
00504 
00505     *FileHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00506 
00507     InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00508                                 ImagePathName,
00509                                 Attributes,
00510                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00511                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00512                               );
00513     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a33">ZwOpenFile</a>( &amp;<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>,
00514                          SYNCHRONIZE | FILE_EXECUTE,
00515                          &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00516                          &amp;IoStatus,
00517                          FILE_SHARE_READ | FILE_SHARE_DELETE,
00518                          FILE_NON_DIRECTORY_FILE
00519                          );
00520 
00521     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00522 <span class="preprocessor">#if DBG</span>
00523 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (ReportErrors) {
00524             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"NTRTL: RtlpOpenImageFile - NtCreateFile( %wZ ) failed.  Status == %X\n"</span>,
00525                       ImagePathName,
00526                       <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>
00527                     );
00528             }
00529 <span class="preprocessor">#endif // DBG</span>
00530 <span class="preprocessor"></span>        <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00531         }
00532 
00533     *FileHandle = <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>;
00534     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00535 }
00536 
00537 
00538 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00539"></a><a class="code" href="../../d0/d2/rtlexec_8c.html#a7">00539</a> <a class="code" href="../../d0/d2/rtlexec_8c.html#a7">RtlpCreateStack</a>(
00540     IN HANDLE Process,
00541     IN SIZE_T MaximumStackSize OPTIONAL,
00542     IN SIZE_T CommittedStackSize OPTIONAL,
00543     IN ULONG ZeroBits OPTIONAL,
00544     OUT PINITIAL_TEB InitialTeb
00545     )
00546 {
00547     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00548     PCH Stack;
00549     SYSTEM_BASIC_INFORMATION SysInfo;
00550     BOOLEAN GuardPage;
00551     SIZE_T RegionSize;
00552     ULONG OldProtect;
00553 <span class="preprocessor">#if defined(_IA64_)</span>
00554 <span class="preprocessor"></span>    PCH Bstore;
00555     SIZE_T CommittedBstoreSize;
00556     SIZE_T MaximumBstoreSize;
00557     SIZE_T MstackPlusBstoreSize;
00558 <span class="preprocessor">#endif</span>
00559 <span class="preprocessor"></span>
00560     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQuerySystemInformation( SystemBasicInformation,
00561                                        (PVOID)&amp;SysInfo,
00562                                        <span class="keyword">sizeof</span>( SysInfo ),
00563                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00564                                      );
00565     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) ) {
00566         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00567         }
00568 
00569     <span class="comment">//</span>
00570     <span class="comment">// if stack is in the current process, then default to</span>
00571     <span class="comment">// the parameters from the image</span>
00572     <span class="comment">//</span>
00573 
00574     <span class="keywordflow">if</span> ( Process == NtCurrentProcess() ) {
00575         PPEB Peb;
00576         PIMAGE_NT_HEADERS NtHeaders;
00577 
00578 
00579         Peb = NtCurrentPeb();
00580         NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(Peb-&gt;ImageBaseAddress);
00581 
00582 
00583         <span class="keywordflow">if</span> (!MaximumStackSize) {
00584             MaximumStackSize = NtHeaders-&gt;OptionalHeader.SizeOfStackReserve;
00585             }
00586 
00587         <span class="keywordflow">if</span> (!CommittedStackSize) {
00588             CommittedStackSize = NtHeaders-&gt;OptionalHeader.SizeOfStackCommit;
00589             }
00590 
00591         }
00592     <span class="keywordflow">else</span> {
00593 
00594         <span class="keywordflow">if</span> (!CommittedStackSize) {
00595             CommittedStackSize = SysInfo.PageSize;
00596             }
00597 
00598         <span class="keywordflow">if</span> (!MaximumStackSize) {
00599             MaximumStackSize = SysInfo.AllocationGranularity;
00600             }
00601 
00602         }
00603 
00604 
00605     <span class="keywordflow">if</span> ( CommittedStackSize &gt;= MaximumStackSize ) {
00606         MaximumStackSize = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(CommittedStackSize, (1024*1024));
00607         }
00608 
00609 
00610     CommittedStackSize = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>( CommittedStackSize, SysInfo.PageSize );
00611     MaximumStackSize = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>( MaximumStackSize,
00612                                  SysInfo.AllocationGranularity
00613                                );
00614 
00615     Stack = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00616 
00617 <span class="preprocessor">#if defined(_IA64_)</span>
00618 <span class="preprocessor"></span>
00619     <span class="comment">//</span>
00620     <span class="comment">// Piggyback the backing store with the memory stack</span>
00621     <span class="comment">//</span>
00622 
00623     CommittedBstoreSize = CommittedStackSize;
00624     MaximumBstoreSize = MaximumStackSize;
00625     MstackPlusBstoreSize = MaximumBstoreSize + MaximumStackSize;
00626 
00627     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory( Process,
00628                                       (PVOID *)&amp;Stack,
00629                                       ZeroBits,
00630                                       &amp;MstackPlusBstoreSize,
00631                                       MEM_RESERVE,
00632                                       PAGE_READWRITE
00633                                     );
00634 <span class="preprocessor">#else</span>
00635 <span class="preprocessor"></span>
00636     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory( Process,
00637                                       (PVOID *)&amp;Stack,
00638                                       ZeroBits,
00639                                       &amp;MaximumStackSize,
00640                                       MEM_RESERVE,
00641                                       PAGE_READWRITE
00642                                     );
00643 <span class="preprocessor">#endif // defined(_IA64_)</span>
00644 <span class="preprocessor"></span>
00645     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) ) {
00646 <span class="preprocessor">#if DBG</span>
00647 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"NTRTL: RtlpCreateStack( %lx ) failed.  Stack Reservation Status == %X\n"</span>,
00648                   Process,
00649                   <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>
00650                 );
00651 <span class="preprocessor">#endif // DBG</span>
00652 <span class="preprocessor"></span>        <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00653         }
00654 
00655 <span class="preprocessor">#if defined(_IA64_)</span>
00656 <span class="preprocessor"></span>    <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;OldInitialTeb.OldBStoreLimit = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00657 <span class="preprocessor">#endif // defined(_IA64_)</span>
00658 <span class="preprocessor"></span>
00659     <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;OldInitialTeb.OldStackBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00660     <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;OldInitialTeb.OldStackLimit = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00661     <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;StackAllocationBase = Stack;
00662     <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;StackBase = Stack + MaximumStackSize;
00663 
00664     Stack += MaximumStackSize - CommittedStackSize;
00665     <span class="keywordflow">if</span> (MaximumStackSize &gt; CommittedStackSize) {
00666         Stack -= SysInfo.PageSize;
00667         CommittedStackSize += SysInfo.PageSize;
00668         GuardPage = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00669         }
00670     <span class="keywordflow">else</span> {
00671         GuardPage = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00672         }
00673     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory( Process,
00674                                       (PVOID *)&amp;Stack,
00675                                       0,
00676                                       &amp;CommittedStackSize,
00677                                       MEM_COMMIT,
00678                                       PAGE_READWRITE
00679                                     );
00680     <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;StackLimit = Stack;
00681 
00682     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) ) {
00683 <span class="preprocessor">#if DBG</span>
00684 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"NTRTL: RtlpCreateStack( %lx ) failed.  Stack Commit Status == %X\n"</span>,
00685                   Process,
00686                   <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>
00687                 );
00688 <span class="preprocessor">#endif // DBG</span>
00689 <span class="preprocessor"></span>        <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00690         }
00691 
00692     <span class="comment">//</span>
00693     <span class="comment">// if we have space, create a guard page.</span>
00694     <span class="comment">//</span>
00695 
00696     <span class="keywordflow">if</span> (GuardPage) {
00697         RegionSize =  SysInfo.PageSize;
00698         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwProtectVirtualMemory( Process,
00699                                          (PVOID *)&amp;Stack,
00700                                          &amp;RegionSize,
00701                                          PAGE_GUARD | PAGE_READWRITE,
00702                                          &amp;OldProtect);
00703 
00704 
00705         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) ) {
00706 <span class="preprocessor">#if DBG</span>
00707 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"NTRTL: RtlpCreateStack( %lx ) failed.  Guard Page Creation Status == %X\n"</span>,
00708                       Process,
00709                       <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>
00710                     );
00711 <span class="preprocessor">#endif // DBG</span>
00712 <span class="preprocessor"></span>            <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00713             }
00714 <span class="preprocessor">#if defined(_IA64_)</span>
00715 <span class="preprocessor"></span>        <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;StackLimit = (PVOID)((PUCHAR)<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;StackLimit + RegionSize);
00716 <span class="preprocessor">#else</span>
00717 <span class="preprocessor"></span>        <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;StackLimit = (PVOID)((PUCHAR)<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;StackLimit - RegionSize);
00718 <span class="preprocessor">#endif // defined(_IA64_)</span>
00719 <span class="preprocessor"></span>        }
00720 
00721 <span class="preprocessor">#if defined(_IA64_)</span>
00722 <span class="preprocessor"></span>
00723     <span class="comment">//</span>
00724     <span class="comment">// Commit backing store pages and create guard pages if there is space</span>
00725     <span class="comment">//</span>
00726 
00727     Bstore = <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;StackBase;
00728     <span class="keywordflow">if</span> (MaximumBstoreSize &gt; CommittedBstoreSize) {
00729         CommittedBstoreSize += SysInfo.PageSize;
00730         GuardPage = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00731     } <span class="keywordflow">else</span> {
00732         GuardPage = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00733     }
00734 
00735     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory( Process,
00736                                       (PVOID *)&amp;Bstore,
00737                                       0,
00738                                       &amp;CommittedBstoreSize,
00739                                       MEM_COMMIT,
00740                                       PAGE_READWRITE
00741                                     );
00742 
00743     <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;BStoreLimit = Bstore + CommittedBstoreSize;
00744 
00745     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00746 <span class="preprocessor">#if DBG</span>
00747 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"NTRTL: RtlpCreateStack( %lx ) failed. Backing Store Commit Status == %X\n"</span>,
00748                  Process,
00749                  <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>
00750                 );
00751 <span class="preprocessor">#endif // DBG</span>
00752 <span class="preprocessor"></span>        <span class="keywordflow">return</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00753     }
00754 
00755     <span class="keywordflow">if</span> (GuardPage) {
00756         Bstore = (PCH)<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;BStoreLimit - SysInfo.PageSize;
00757         RegionSize = SysInfo.PageSize;
00758         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwProtectVirtualMemory(Process,
00759                                         (PVOID *)&amp;Bstore,
00760                                         &amp;RegionSize,
00761                                         PAGE_GUARD | PAGE_READWRITE,
00762                                         &amp;OldProtect
00763                                        );
00764         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00765 <span class="preprocessor">#if DBG</span>
00766 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"NTRTL: RtlpCreateStack( %lx ) failed.  Backing Store Guard Page Creation Status == %X\n"</span>,
00767                      Process,
00768                      <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>
00769                     );
00770 <span class="preprocessor">#endif // DBG</span>
00771 <span class="preprocessor"></span>            <span class="keywordflow">return</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00772         }
00773         <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;BStoreLimit = (PVOID)((PUCHAR)<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;BStoreLimit - RegionSize);
00774     }
00775 
00776 <span class="preprocessor">#endif // defined(_IA64_)</span>
00777 <span class="preprocessor"></span>
00778     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00779 }
00780 
00781 
00782 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00783"></a><a class="code" href="../../d0/d2/rtlexec_8c.html#a6">00783</a> <a class="code" href="../../d0/d2/rtlexec_8c.html#a6">RtlpFreeStack</a>(
00784     IN HANDLE Process,
00785     IN PINITIAL_TEB InitialTeb
00786     )
00787 {
00788     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00789     SIZE_T <a class="code" href="../../d6/d6/ttime_8c.html#a0">Zero</a>;
00790 
00791     <a class="code" href="../../d6/d6/ttime_8c.html#a0">Zero</a> = 0;
00792     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwFreeVirtualMemory( Process,
00793                                   &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;StackAllocationBase,
00794                                   &amp;<a class="code" href="../../d6/d6/ttime_8c.html#a0">Zero</a>,
00795                                   MEM_RELEASE
00796                                 );
00797     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) ) {
00798 <span class="preprocessor">#if DBG</span>
00799 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"NTRTL: RtlpFreeStack( %lx ) failed.  Stack DeCommit Status == %X\n"</span>,
00800                   Process,
00801                   <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>
00802                 );
00803 <span class="preprocessor">#endif // DBG</span>
00804 <span class="preprocessor"></span>        <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00805         }
00806 
00807     RtlZeroMemory( <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>, <span class="keyword">sizeof</span>( *<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a> ) );
00808     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00809 }
00810 
00811 
00812 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00813"></a><a class="code" href="../../d0/d2/rtlexec_8c.html#a12">00813</a> <a class="code" href="../../d0/d2/rtlexec_8c.html#a12">RtlCreateUserProcess</a>(
00814     IN PUNICODE_STRING NtImagePathName,
00815     IN ULONG Attributes,
00816     IN PRTL_USER_PROCESS_PARAMETERS ProcessParameters,
00817     IN PSECURITY_DESCRIPTOR ProcessSecurityDescriptor OPTIONAL,
00818     IN PSECURITY_DESCRIPTOR ThreadSecurityDescriptor OPTIONAL,
00819     IN HANDLE ParentProcess OPTIONAL,
00820     IN BOOLEAN InheritHandles,
00821     IN HANDLE DebugPort OPTIONAL,
00822     IN HANDLE ExceptionPort OPTIONAL,
00823     OUT PRTL_USER_PROCESS_INFORMATION ProcessInformation
00824     )
00825 
00826 <span class="comment">/*++</span>
00827 <span class="comment"></span>
00828 <span class="comment">Routine Description:</span>
00829 <span class="comment"></span>
00830 <span class="comment">    This function creates a user mode process with a single thread with</span>
00831 <span class="comment">    a suspend count of one.  The address space of the new process is</span>
00832 <span class="comment">    initialized with the contents of specified image file.  The caller</span>
00833 <span class="comment">    can specify the Access Control List for the new process and thread.</span>
00834 <span class="comment">    The caller can also specify the parent process to inherit process</span>
00835 <span class="comment">    priority and processor affinity from.  The default is to inherit</span>
00836 <span class="comment">    these from the current process.  Finally the caller can specify</span>
00837 <span class="comment">    whether the new process is to inherit any of the object handles</span>
00838 <span class="comment">    from the specified parent process or not.</span>
00839 <span class="comment"></span>
00840 <span class="comment">    Information about the new process and thread is returned via</span>
00841 <span class="comment">    the ProcessInformation parameter.</span>
00842 <span class="comment"></span>
00843 <span class="comment">Arguments:</span>
00844 <span class="comment"></span>
00845 <span class="comment">    NtImagePathName - A required pointer that points to the NT Path string</span>
00846 <span class="comment">        that identifies the image file that is to be loaded into the</span>
00847 <span class="comment">        child process.</span>
00848 <span class="comment"></span>
00849 <span class="comment">    ProcessParameters - A required pointer that points to parameters that</span>
00850 <span class="comment">        are to passed to the child process.</span>
00851 <span class="comment"></span>
00852 <span class="comment">    ProcessSecurityDescriptor - An optional pointer to the Security Descriptor</span>
00853 <span class="comment">        give to the new process.</span>
00854 <span class="comment"></span>
00855 <span class="comment">    ThreadSecurityDescriptor - An optional pointer to the Security Descriptor</span>
00856 <span class="comment">        give to the new thread.</span>
00857 <span class="comment"></span>
00858 <span class="comment">    ParentProcess - An optional process handle that will used to inherit</span>
00859 <span class="comment">        certain properties from.</span>
00860 <span class="comment"></span>
00861 <span class="comment">    InheritHandles - A boolean value.  TRUE specifies that object handles</span>
00862 <span class="comment">        associated with the specified parent process are to be inherited</span>
00863 <span class="comment">        by the new process, provided they have the OBJ_INHERIT attribute.</span>
00864 <span class="comment">        FALSE specifies that the new process is to inherit no handles.</span>
00865 <span class="comment"></span>
00866 <span class="comment">    DebugPort - An optional handle to the debug port associated with this</span>
00867 <span class="comment">        process.</span>
00868 <span class="comment"></span>
00869 <span class="comment">    ExceptionPort - An optional handle to the exception port associated with this</span>
00870 <span class="comment">        process.</span>
00871 <span class="comment"></span>
00872 <span class="comment">    ProcessInformation - A pointer to a variable that receives information</span>
00873 <span class="comment">        about the new process and thread.</span>
00874 <span class="comment"></span>
00875 <span class="comment">Return Value:</span>
00876 <span class="comment"></span>
00877 <span class="comment">    TBS.</span>
00878 <span class="comment"></span>
00879 <span class="comment">--*/</span>
00880 
00881 {
00882     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00883     HANDLE Section, <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>;
00884     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00885     PRTL_USER_PROCESS_PARAMETERS Parameters;
00886     SIZE_T ParameterLength;
00887     PVOID Environment;
00888     PWCHAR s;
00889     ULONG EnvironmentLength;
00890     SIZE_T RegionSize;
00891     PROCESS_BASIC_INFORMATION ProcessInfo;
00892     PPEB Peb;
00893     UNICODE_STRING <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>;
00894 
00895     <span class="comment">//</span>
00896     <span class="comment">// Zero output parameter and probe the addresses at the same time</span>
00897     <span class="comment">//</span>
00898 
00899     RtlZeroMemory( ProcessInformation, <span class="keyword">sizeof</span>( *ProcessInformation ) );
00900     ProcessInformation-&gt;Length = <span class="keyword">sizeof</span>( *ProcessInformation );
00901 
00902     <span class="comment">//</span>
00903     <span class="comment">// Open the specified image file.</span>
00904     <span class="comment">//</span>
00905 
00906     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/rtlexec_8c.html#a5">RtlpOpenImageFile</a>( NtImagePathName,
00907                                 Attributes &amp; (OBJ_INHERIT | OBJ_CASE_INSENSITIVE),
00908                                 &amp;<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>,
00909                                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00910                               );
00911     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00912         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00913         }
00914 
00915 
00916     <span class="comment">//</span>
00917     <span class="comment">// Create a memory section backed by the opened image file</span>
00918     <span class="comment">//</span>
00919 
00920     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwCreateSection( &amp;Section,
00921                               SECTION_ALL_ACCESS,
00922                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00923                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00924                               PAGE_EXECUTE,
00925                               SEC_IMAGE,
00926                               <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>
00927                             );
00928     ZwClose( <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> );
00929     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) ) {
00930         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00931         }
00932 
00933 
00934     <span class="comment">//</span>
00935     <span class="comment">// Create the user mode process, defaulting the parent process to the</span>
00936     <span class="comment">// current process if one is not specified.  The new process will not</span>
00937     <span class="comment">// have a name nor will the handle be inherited by other processes.</span>
00938     <span class="comment">//</span>
00939 
00940     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( ParentProcess )) {
00941         ParentProcess = NtCurrentProcess();
00942         }
00943 
00944     InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00945                                 ProcessSecurityDescriptor );
00946     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a25">RtlGetNtGlobalFlags</a>() &amp; FLG_ENABLE_CSRDEBUG ) {
00947         <span class="keywordflow">if</span> ( wcsstr(NtImagePathName-&gt;Buffer,<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"csrss"</span>) ||
00948              wcsstr(NtImagePathName-&gt;Buffer,<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"CSRSS"</span>)
00949            ) {
00950 
00951             <span class="comment">//</span>
00952             <span class="comment">// For Hydra we don't name the CSRSS process to avoid name</span>
00953             <span class="comment">// collissions when multiple CSRSS's are started</span>
00954             <span class="comment">//</span>
00955             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/rtlexec_8c.html#a1">ISTERMINALSERVER</a>()) {
00956 
00957                 InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00958                                             ProcessSecurityDescriptor );
00959             } <span class="keywordflow">else</span> {
00960 
00961                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>,<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\WindowsSS"</span>);
00962                 InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>, &amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00963                                             ProcessSecurityDescriptor );
00964             }
00965 
00966             }
00967         }
00968 
00969     <span class="keywordflow">if</span> ( !InheritHandles ) {
00970         ProcessParameters-&gt;CurrentDirectory.Handle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00971         }
00972     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwCreateProcess( &amp;ProcessInformation-&gt;Process,
00973                               PROCESS_ALL_ACCESS,
00974                               &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00975                               ParentProcess,
00976                               InheritHandles,
00977                               Section,
00978                               <a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>,
00979                               ExceptionPort
00980                             );
00981     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) ) {
00982         ZwClose( Section );
00983         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00984         }
00985 
00986 
00987     <span class="comment">//</span>
00988     <span class="comment">// Retreive the interesting information from the image header</span>
00989     <span class="comment">//</span>
00990 
00991     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQuerySection( Section,
00992                              SectionImageInformation,
00993                              &amp;ProcessInformation-&gt;ImageInformation,
00994                              <span class="keyword">sizeof</span>( ProcessInformation-&gt;ImageInformation ),
00995                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00996                            );
00997     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) ) {
00998         ZwClose( ProcessInformation-&gt;Process );
00999         ZwClose( Section );
01000         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01001         }
01002 
01003     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQueryInformationProcess( ProcessInformation-&gt;Process,
01004                                         ProcessBasicInformation,
01005                                         &amp;ProcessInfo,
01006                                         <span class="keyword">sizeof</span>( ProcessInfo ),
01007                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01008                                       );
01009     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) ) {
01010         ZwClose( ProcessInformation-&gt;Process );
01011         ZwClose( Section );
01012         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01013         }
01014 
01015     Peb = ProcessInfo.PebBaseAddress;
01016 
01017     <span class="comment">//</span>
01018     <span class="comment">// Duplicate Native handles into new process if any specified.</span>
01019     <span class="comment">// Note that the duplicated handles will overlay the input values.</span>
01020     <span class="comment">//</span>
01021 
01022     <span class="keywordflow">try</span> {
01023         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01024 
01025         <span class="keywordflow">if</span> ( ProcessParameters-&gt;StandardInput ) {
01026 
01027             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwDuplicateObject(
01028                         ParentProcess,
01029                         ProcessParameters-&gt;StandardInput,
01030                         ProcessInformation-&gt;Process,
01031                         &amp;ProcessParameters-&gt;StandardInput,
01032                         0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01033                         0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01034                         DUPLICATE_SAME_ACCESS | DUPLICATE_SAME_ATTRIBUTES
01035                         );
01036             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
01037                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01038             }
01039         }
01040 
01041         <span class="keywordflow">if</span> ( ProcessParameters-&gt;StandardOutput ) {
01042 
01043             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwDuplicateObject(
01044                         ParentProcess,
01045                         ProcessParameters-&gt;StandardOutput,
01046                         ProcessInformation-&gt;Process,
01047                         &amp;ProcessParameters-&gt;StandardOutput,
01048                         0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01049                         0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01050                         DUPLICATE_SAME_ACCESS | DUPLICATE_SAME_ATTRIBUTES
01051                         );
01052             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
01053                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01054             }
01055         }
01056 
01057         <span class="keywordflow">if</span> ( ProcessParameters-&gt;StandardError ) {
01058 
01059             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwDuplicateObject(
01060                         ParentProcess,
01061                         ProcessParameters-&gt;StandardError,
01062                         ProcessInformation-&gt;Process,
01063                         &amp;ProcessParameters-&gt;StandardError,
01064                         0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01065                         0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01066                         DUPLICATE_SAME_ACCESS | DUPLICATE_SAME_ATTRIBUTES
01067                         );
01068             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
01069                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01070             }
01071         }
01072 
01073     } finally {
01074         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
01075             ZwClose( ProcessInformation-&gt;Process );
01076             ZwClose( Section );
01077             }
01078         }
01079 
01080     <span class="comment">//</span>
01081     <span class="comment">// Possibly reserve some address space in the new process</span>
01082     <span class="comment">//</span>
01083 
01084     <span class="keywordflow">if</span> (ProcessInformation-&gt;ImageInformation.SubSystemType == IMAGE_SUBSYSTEM_NATIVE ) {
01085         <span class="keywordflow">if</span> ( ProcessParameters-&gt;Flags &amp; RTL_USER_PROC_RESERVE_1MB ) {
01086 
01087 <span class="preprocessor">#if defined(_IA64_)</span>
01088 <span class="preprocessor"></span>            Environment = (PVOID)(UADDRESS_BASE+4);
01089 <span class="preprocessor">#else</span>
01090 <span class="preprocessor"></span>            Environment = (PVOID)(4);
01091 <span class="preprocessor">#endif</span>
01092 <span class="preprocessor"></span>            RegionSize = (1024*1024)-(256);
01093 
01094             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory( ProcessInformation-&gt;Process,
01095                                               (PVOID *)&amp;Environment,
01096                                               0,
01097                                               &amp;RegionSize,
01098                                               MEM_RESERVE,
01099                                               PAGE_READWRITE
01100                                             );
01101             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) ) {
01102                 ZwClose( ProcessInformation-&gt;Process );
01103                 ZwClose( Section );
01104                 <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01105                 }
01106             }
01107         }
01108 
01109     <span class="comment">//</span>
01110     <span class="comment">// Allocate virtual memory in the new process and use NtWriteVirtualMemory</span>
01111     <span class="comment">// to write a copy of the process environment block into the address</span>
01112     <span class="comment">// space of the new process.  Save the address of the allocated block in</span>
01113     <span class="comment">// the process parameter block so the new process can access it.</span>
01114     <span class="comment">//</span>
01115 
01116     <span class="keywordflow">if</span> (s = (PWCHAR)ProcessParameters-&gt;Environment) {
01117         <span class="keywordflow">while</span> (*s++) {
01118             <span class="keywordflow">while</span> (*s++) {
01119                 }
01120             }
01121         EnvironmentLength = (ULONG)(s - (PWCHAR)ProcessParameters-&gt;Environment) * <span class="keyword">sizeof</span>(WCHAR);
01122 
01123         Environment = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01124         RegionSize = EnvironmentLength;
01125         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory( ProcessInformation-&gt;Process,
01126                                           (PVOID *)&amp;Environment,
01127                                           0,
01128                                           &amp;RegionSize,
01129                                           MEM_COMMIT,
01130                                           PAGE_READWRITE
01131                                         );
01132         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) ) {
01133             ZwClose( ProcessInformation-&gt;Process );
01134             ZwClose( Section );
01135             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01136             }
01137 
01138         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwWriteVirtualMemory( ProcessInformation-&gt;Process,
01139                                        Environment,
01140                                        ProcessParameters-&gt;Environment,
01141                                        EnvironmentLength,
01142                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01143                                      );
01144         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) ) {
01145             ZwClose( ProcessInformation-&gt;Process );
01146             ZwClose( Section );
01147             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01148             }
01149 
01150         ProcessParameters-&gt;Environment = Environment;
01151         }
01152 
01153     <span class="comment">//</span>
01154     <span class="comment">// Allocate virtual memory in the new process and use NtWriteVirtualMemory</span>
01155     <span class="comment">// to write a copy of the process parameters block into the address</span>
01156     <span class="comment">// space of the new process.  Set the initial parameter to the new thread</span>
01157     <span class="comment">// to be the address of the block in the new process's address space.</span>
01158     <span class="comment">//</span>
01159 
01160     Parameters = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01161     ParameterLength = ProcessParameters-&gt;MaximumLength;
01162     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory( ProcessInformation-&gt;Process,
01163                                       (PVOID *)&amp;Parameters,
01164                                       0,
01165                                       &amp;ParameterLength,
01166                                       MEM_COMMIT,
01167                                       PAGE_READWRITE
01168                                     );
01169     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) ) {
01170         ZwClose( ProcessInformation-&gt;Process );
01171         ZwClose( Section );
01172         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01173         }
01174 
01175     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwWriteVirtualMemory( ProcessInformation-&gt;Process,
01176                                    Parameters,
01177                                    ProcessParameters,
01178                                    ProcessParameters-&gt;Length,
01179                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01180                                  );
01181     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) ) {
01182             ZwClose( ProcessInformation-&gt;Process );
01183             ZwClose( Section );
01184             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01185             }
01186 
01187     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwWriteVirtualMemory( ProcessInformation-&gt;Process,
01188                                    &amp;Peb-&gt;ProcessParameters,
01189                                    &amp;Parameters,
01190                                    <span class="keyword">sizeof</span>( Parameters ),
01191                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01192                                  );
01193     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) ) {
01194         ZwClose( ProcessInformation-&gt;Process );
01195         ZwClose( Section );
01196         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01197         }
01198 
01199     <span class="comment">//</span>
01200     <span class="comment">// Create a suspended thread in the new process.  Specify the size and</span>
01201     <span class="comment">// position of the stack, along with the start address, initial parameter</span>
01202     <span class="comment">// and an SECURITY_DESCRIPTOR.  The new thread will not have a name and its handle will</span>
01203     <span class="comment">// not be inherited by other processes.</span>
01204     <span class="comment">//</span>
01205 
01206     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/rtlexec_8c.html#a13">RtlCreateUserThread</a>(
01207                  ProcessInformation-&gt;Process,
01208                  ThreadSecurityDescriptor,
01209                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01210                  ProcessInformation-&gt;ImageInformation.ZeroBits,
01211                  ProcessInformation-&gt;ImageInformation.MaximumStackSize,
01212                  ProcessInformation-&gt;ImageInformation.CommittedStackSize,
01213                  (PUSER_THREAD_START_ROUTINE)
01214                      ProcessInformation-&gt;ImageInformation.TransferAddress,
01215                  (PVOID)Peb,
01216                  &amp;ProcessInformation-&gt;Thread,
01217                  &amp;ProcessInformation-&gt;ClientId
01218                  );
01219     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) ) {
01220         ZwClose( ProcessInformation-&gt;Process );
01221         ZwClose( Section );
01222         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01223         }
01224 
01225     <span class="comment">//</span>
01226     <span class="comment">// Now close the section and file handles.  The objects they represent</span>
01227     <span class="comment">// will not actually go away until the process is destroyed.</span>
01228     <span class="comment">//</span>
01229 
01230     ZwClose( Section );
01231 
01232     <span class="comment">//</span>
01233     <span class="comment">// Return success status</span>
01234     <span class="comment">//</span>
01235 
01236     <span class="keywordflow">return</span>( STATUS_SUCCESS );
01237 }
01238 
01239 
01240 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01241"></a><a class="code" href="../../d0/d2/rtlexec_8c.html#a13">01241</a> <a class="code" href="../../d0/d2/rtlexec_8c.html#a13">RtlCreateUserThread</a>(
01242     IN HANDLE Process,
01243     IN PSECURITY_DESCRIPTOR ThreadSecurityDescriptor OPTIONAL,
01244     IN BOOLEAN CreateSuspended,
01245     IN ULONG ZeroBits OPTIONAL,
01246     IN SIZE_T MaximumStackSize OPTIONAL,
01247     IN SIZE_T CommittedStackSize OPTIONAL,
01248     IN PUSER_THREAD_START_ROUTINE StartAddress,
01249     IN PVOID Parameter OPTIONAL,
01250     OUT PHANDLE Thread OPTIONAL,
01251     OUT PCLIENT_ID ClientId OPTIONAL
01252     )
01253 
01254 <span class="comment">/*++</span>
01255 <span class="comment"></span>
01256 <span class="comment">Routine Description:</span>
01257 <span class="comment"></span>
01258 <span class="comment">    This function creates a user mode thread in a user process.  The caller</span>
01259 <span class="comment">    specifies the attributes of the new thread.  A handle to the thread, along</span>
01260 <span class="comment">    with its Client Id are returned to the caller.</span>
01261 <span class="comment"></span>
01262 <span class="comment">Arguments:</span>
01263 <span class="comment"></span>
01264 <span class="comment">    Process - Handle to the target process in which to create the new thread.</span>
01265 <span class="comment"></span>
01266 <span class="comment">    ThreadSecurityDescriptor - An optional pointer to the Security Descriptor</span>
01267 <span class="comment">        give to the new thread.</span>
01268 <span class="comment"></span>
01269 <span class="comment">    CreateSuspended - A boolean parameter that specifies whether or not the new</span>
01270 <span class="comment">        thread is to be created suspended or not.  If TRUE, the new thread</span>
01271 <span class="comment">        will be created with an initial suspend count of 1.  If FALSE then</span>
01272 <span class="comment">        the new thread will be ready to run when this call returns.</span>
01273 <span class="comment"></span>
01274 <span class="comment">    ZeroBits - This parameter is passed to the virtual memory manager</span>
01275 <span class="comment">        when the stack is allocated.  Stacks are always allocated with the</span>
01276 <span class="comment">        MEM_TOP_DOWN allocation attribute.</span>
01277 <span class="comment"></span>
01278 <span class="comment">    MaximumStackSize - This is the maximum size of the stack.  This size</span>
01279 <span class="comment">        will be rounded up to the next highest page boundary.  If zero is</span>
01280 <span class="comment">        specified, then the default size will be 64K bytes.</span>
01281 <span class="comment"></span>
01282 <span class="comment">    CommittedStackSize - This is the initial committed size of the stack.  This</span>
01283 <span class="comment">        size is rounded up to the next highest page boundary and then an</span>
01284 <span class="comment">        additional page is added for the guard page.  The resulting size</span>
01285 <span class="comment">        will then be commited and the guard page protection initialized</span>
01286 <span class="comment">        for the last committed page in the stack.</span>
01287 <span class="comment"></span>
01288 <span class="comment">    StartAddress - The initial starting address of the thread.</span>
01289 <span class="comment"></span>
01290 <span class="comment">    Parameter - An optional pointer to a 32-bit pointer parameter that is</span>
01291 <span class="comment">        passed as a single argument to the procedure at the start address</span>
01292 <span class="comment">        location.</span>
01293 <span class="comment"></span>
01294 <span class="comment">    Thread - An optional pointer that, if specified, points to a variable that</span>
01295 <span class="comment">        will receive the handle of the new thread.</span>
01296 <span class="comment"></span>
01297 <span class="comment">    ClientId - An optional pointer that, if specified, points to a variable</span>
01298 <span class="comment">        that will receive the Client Id of the new thread.</span>
01299 <span class="comment"></span>
01300 <span class="comment">Return Value:</span>
01301 <span class="comment"></span>
01302 <span class="comment">    TBS</span>
01303 <span class="comment"></span>
01304 <span class="comment">--*/</span>
01305 
01306 {
01307     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01308     CONTEXT <a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>;
01309     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
01310     INITIAL_TEB <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>;
01311     HANDLE <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>;
01312     CLIENT_ID <a class="code" href="../../d2/d1/cttoken_8c.html#a61">ThreadClientId</a>;
01313 
01314     <span class="comment">//</span>
01315     <span class="comment">// Allocate a stack for this thread in the address space of the target</span>
01316     <span class="comment">// process.</span>
01317     <span class="comment">//</span>
01318 
01319     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/rtlexec_8c.html#a7">RtlpCreateStack</a>( Process,
01320                               MaximumStackSize,
01321                               CommittedStackSize,
01322                               ZeroBits,
01323                               &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>
01324                             );
01325     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) ) {
01326         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01327         }
01328 
01329     <span class="comment">//</span>
01330     <span class="comment">// Create an initial context for the new thread.</span>
01331     <span class="comment">//</span>
01332 
01333 
01334     <a class="code" href="../../d6/d6/rtl_2ppc_2context_8c.html#a1">RtlInitializeContext</a>( Process,
01335                           &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>,
01336                           Parameter,
01337                           (PVOID)StartAddress,
01338                           <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>.StackBase
01339                         );
01340 
01341     <span class="comment">//</span>
01342     <span class="comment">// Now create a thread in the target process.  The new thread will</span>
01343     <span class="comment">// not have a name and its handle will not be inherited by other</span>
01344     <span class="comment">// processes.</span>
01345     <span class="comment">//</span>
01346 
01347     InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01348                                 ThreadSecurityDescriptor );
01349     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwCreateThread( &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
01350                              THREAD_ALL_ACCESS,
01351                              &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01352                              Process,
01353                              &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a61">ThreadClientId</a>,
01354                              &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>,
01355                              &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>,
01356                              CreateSuspended
01357                            );
01358     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01359 <span class="preprocessor">#if DBG</span>
01360 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"NTRTL: RtlCreateUserThread Failed. NtCreateThread Status == %X\n"</span>,
01361                   <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01362 <span class="preprocessor">#endif // DBG</span>
01363 <span class="preprocessor"></span>        <a class="code" href="../../d0/d2/rtlexec_8c.html#a6">RtlpFreeStack</a>( Process, &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a> );
01364         }
01365     <span class="keywordflow">else</span> {
01366         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Thread )) {
01367             *Thread = <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>;
01368             }
01369 
01370         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ClientId )) {
01371             *ClientId = <a class="code" href="../../d2/d1/cttoken_8c.html#a61">ThreadClientId</a>;
01372             }
01373 
01374         }
01375 
01376     <span class="comment">//</span>
01377     <span class="comment">// Return status</span>
01378     <span class="comment">//</span>
01379 
01380     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01381 }
01382 
01383 
01384 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01385"></a><a class="code" href="../../d0/d2/rtlexec_8c.html#a14">01385</a> <a class="code" href="../../d0/d2/rtlexec_8c.html#a14">RtlFreeUserThreadStack</a>(
01386     HANDLE hProcess,
01387     HANDLE hThread
01388     )
01389 {
01390     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01391     PTEB Teb;
01392     THREAD_BASIC_INFORMATION ThreadInfo;
01393     PVOID StackDeallocationBase;
01394     ULONG Length;
01395     SIZE_T <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
01396 
01397     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a20">NtQueryInformationThread</a>( hThread,
01398                                        ThreadBasicInformation,
01399                                        &amp;ThreadInfo,
01400                                        <span class="keyword">sizeof</span>( ThreadInfo ),
01401                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01402                                      );
01403     Teb = ThreadInfo.TebBaseAddress;
01404     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) || !Teb) {
01405         <span class="keywordflow">return</span>;
01406         }
01407 
01408     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a9">NtReadVirtualMemory</a>( hProcess,
01409                                   &amp;Teb-&gt;DeallocationStack,
01410                                   &amp;StackDeallocationBase,
01411                                   <span class="keyword">sizeof</span>( StackDeallocationBase ),
01412                                   &amp;Length
01413                                 );
01414     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) || !StackDeallocationBase) {
01415         <span class="keywordflow">return</span>;
01416         }
01417 
01418     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 0;
01419     <a class="code" href="../../d3/d7/freevm_8c.html#a6">NtFreeVirtualMemory</a>( hProcess, &amp;StackDeallocationBase, &amp;<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>, MEM_RELEASE );
01420     <span class="keywordflow">return</span>;
01421 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:41 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
