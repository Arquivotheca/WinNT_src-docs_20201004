<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: obinsert.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>obinsert.c File Reference</h1><code>#include "<a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>"</code><br>

<p>
<a href="../../d2/d0/obinsert_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a> (IN PVOID Object, IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState OPTIONAL, IN ACCESS_MASK DesiredAccess OPTIONAL, IN ULONG ObjectPointerBias, OUT PVOID *NewObject OPTIONAL, OUT PHANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a0" doxytag="obinsert.c::ObInsertObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObInsertObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK DesiredAccess&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectPointerBias</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *NewObject&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">29</a> of file <a class="el" href="../../d2/d0/obinsert_8c-source.html">obinsert.c</a>.
<p>
References <a class="el" href="../../d5/d9/ob_8h-source.html#l00284">_OBJECT_CREATE_INFORMATION::Attributes</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00331">_OBJECT_HEADER_NAME_INFO::Directory</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00306">_OBJECT_HEADER::Flags</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00168">_OBJECT_TYPE_INITIALIZER::GenericMapping</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00332">_OBJECT_HEADER_NAME_INFO::Name</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00348">OB_FLAG_KERNEL_OBJECT</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00347">OB_FLAG_NEW_OBJECT</a>, <a class="el" href="../../d4/d0/ob_8h.html#a21">OB_OPEN_REASON</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01574">ObAssignSecurity()</a>, <a class="el" href="../../d4/d0/ob_8h.html#a100a58">ObCreateHandle</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01258">ObGetObjectSecurity()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00368">OBJECT_HEADER_TO_NAME_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00308">_OBJECT_HEADER::ObjectCreateInfo</a>, <a class="el" href="../../d4/d0/ob_8h.html#a100a59">ObOpenHandle</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02160">ObpCreateHandle()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l01015">ObpCreateSymbolicLinkName()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02507">ObpCreateUnnamedHandle()</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l01009">ObpDeleteDirectoryEntry()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l01497">ObpDeleteNameCheck()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00431">ObpFreeObjectCreateInformation</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00202">ObpLeaveRootDirectoryMutex</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l01081">ObpLookupObjectName()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00368">ObpSymbolicLinkObjectType</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01886">ObpValidateAccessMask()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00071">ObpValidateIrql</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01418">ObReleaseObjectSecurity()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00286">_OBJECT_CREATE_INFORMATION::ParseContext</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00287">_OBJECT_CREATE_INFORMATION::ProbeMode</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00285">_OBJECT_CREATE_INFORMATION::RootDirectory</a>, <a class="el" href="../../d3/d4/seastate_8c-source.html#l00180">SeCreateAccessState()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00291">_OBJECT_CREATE_INFORMATION::SecurityDescriptor</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00292">_OBJECT_CREATE_INFORMATION::SecurityQos</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00170">_OBJECT_TYPE_INITIALIZER::SecurityRequired</a>, <a class="el" href="../../d3/d4/seastate_8c-source.html#l00348">SeDeleteAccessState()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l00631">SeReleaseSecurityDescriptor()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01165">CmpCreateRegistryRoot()</a>, <a class="el" href="../../d3/d3/ex_2callback_8c-source.html#l00222">ExCreateCallback()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l03917">IoCreateController()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l04073">IoCreateDevice()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01071">IoCreateDriver()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05378">IoCreateStreamFileObject()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02812">IopInitializeBuiltinDriver()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>, <a class="el" href="../../d7/d5/lpccreat_8c-source.html#l00136">LpcpCreatePort()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l00768">MiSectionInitialization()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01392">MmGetCrashDumpInformation()</a>, <a class="el" href="../../d5/d5/lpccompl_8c-source.html#l00040">NtAcceptConnectPort()</a>, <a class="el" href="../../d5/d5/channel_8c-source.html#l00101">NtCreateChannel()</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l00032">NtCreateDirectoryObject()</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00180">NtCreateEvent()</a>, <a class="el" href="../../d4/d7/eventpr_8c-source.html#l00131">NtCreateEventPair()</a>, <a class="el" href="../../d6/d3/complete_8c-source.html#l00051">NtCreateIoCompletion()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l00048">NtCreateJobObject()</a>, <a class="el" href="../../d3/d4/mutant_8c-source.html#l00156">NtCreateMutant()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00199">NtCreateProfile()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l00134">NtCreateSection()</a>, <a class="el" href="../../d3/d5/semphore_8c-source.html#l00123">NtCreateSemaphore()</a>, <a class="el" href="../../d2/d7/super_8c-source.html#l00056">NtCreateSuperSection()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l00052">NtCreateSymbolicLinkObject()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00444">NtCreateTimer()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00046">NtDuplicateToken()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01306">NtFilterToken()</a>, <a class="el" href="../../d5/d5/channel_8c-source.html#l00348">NtOpenChannel()</a>, <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00458">NtOpenThreadToken()</a>, <a class="el" href="../../d6/d5/lpcconn_8c-source.html#l00084">NtSecureConnectPort()</a>, <a class="el" href="../../d4/d2/tob_8c-source.html#l00187">obtest()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00262">PspCreateThread()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01634">SeFilterToken()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l02213">SepCreateToken()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l01327">SeSubProcessToken()</a>, and <a class="el" href="../../d9/d7/winsta_8c-source.html#l00243">xxxCreateWindowStation()</a>.
<p>
<pre class="fragment"><div>00040                    :
00041 
00042     This routine inserts an object into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current processes handle table.
00043 
00044     The Object header includes a pointer to a SecurityDescriptor passed in
00045     an object creation call.  This SecurityDescriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not assumed to have
00046     been captured.  This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> responsible <span class="keywordflow">for</span> making an appropriate
00047     SecurityDescriptor and removing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object header.
00048 
00049 Arguments:
00050 
00051     Object - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> object body
00052 
00053     AccessState - Optionally supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access state <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span>
00054         handle
00055 
00056     DesiredAccess - Optionally supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access we want <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00057         <span class="keyword">new</span> handle
00058 
00059     ObjectPointerBias - Supplies a bias to apply <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer count <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00060         object
00061 
00062     NewObject - Optionally receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> object that we've
00063         created a handle <span class="keywordflow">for</span>
00064 
00065     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> handle
00066 
00067 Return Value:
00068 
00069     An appropriate <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> value.
00070 
00071 --*/
00072 
00073 {
00074     <a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html">POBJECT_CREATE_INFORMATION</a> ObjectCreateInfo;
00075     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00076     PUNICODE_STRING ObjectName;
00077     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
00078     <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a> NameInfo;
00079     PSECURITY_DESCRIPTOR ParentDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00080     PVOID InsertObject;
00081     HANDLE NewHandle;
00082     BOOLEAN DirectoryLocked;
00083     <a class="code" href="../../d4/d0/ob_8h.html#a21">OB_OPEN_REASON</a> OpenReason;
00084     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00085     <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">ACCESS_STATE</a> LocalAccessState;
00086     <a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html">AUX_ACCESS_DATA</a> AuxData;
00087     BOOLEAN SecurityDescriptorAllocated;
00088     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00089     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> ReturnStatus;
00090     PVOID DirObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00091 
00092 
00093     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00094 
00095     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>(<span class="stringliteral">"ObInsertObject"</span>);
00096 
00097     <span class="comment">//</span>
00098     <span class="comment">//  Get the address of the object header, the object create information,</span>
00099     <span class="comment">//  the object type, and the address of the object name descriptor, if</span>
00100     <span class="comment">//  specified.</span>
00101     <span class="comment">//</span>
00102 
00103     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(Object);
00104 
00105 <span class="preprocessor">#if DBG</span>
00106 <span class="preprocessor"></span>
00107     <span class="keywordflow">if</span> ((ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a1">OB_FLAG_NEW_OBJECT</a>) == 0) {
00108 
00109         KdPrint((<span class="stringliteral">"OB: Attempting to insert existing object %08x\n"</span>, Object));
00110         KdBreakPoint();
00111 
00112         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Object);
00113 
00114         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00115     }
00116 
00117 <span class="preprocessor">#endif</span>
00118 <span class="preprocessor"></span>
00119     ObjectCreateInfo = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o8">ObjectCreateInfo</a>;
00120 
00121     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
00122 
00123     NameInfo = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>(ObjectHeader);
00124 
00125     ObjectName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00126 
00127     <span class="keywordflow">if</span> ((NameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00128 
00129         ObjectName = &amp;NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>;
00130     }
00131 
00132     <span class="comment">//</span>
00133     <span class="comment">//  If security checks are not required and an object name is not</span>
00134     <span class="comment">//  specified, insert an unnamed object, biasing the count</span>
00135     <span class="comment">//  by one, dereference the bias, and return to our caller</span>
00136     <span class="comment">//</span>
00137 
00138     PreviousMode = KeGetPreviousMode();
00139 
00140     <span class="keywordflow">if</span> (!ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o6">SecurityRequired</a> &amp;&amp; (ObjectName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00141 
00142         ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o8">ObjectCreateInfo</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00143 
00144         *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00145 
00146         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a81">ObpCreateUnnamedHandle</a>( Object,
00147                                          DesiredAccess,
00148                                          1 + ObjectPointerBias,
00149                                          ObjectCreateInfo-&gt;<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html#o0">Attributes</a>,
00150                                          PreviousMode,
00151                                          NewObject,
00152                                          Handle );
00153 
00154         <span class="comment">//</span>
00155         <span class="comment">//  Free the object creation information and dereference the object.</span>
00156         <span class="comment">//</span>
00157 
00158         <a class="code" href="../../d5/d1/obp_8h.html#a29">ObpFreeObjectCreateInformation</a>(ObjectCreateInfo);
00159 
00160         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Object);
00161 
00162         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00163     }
00164 
00165     <span class="comment">//</span>
00166     <span class="comment">//  The object is either named or requires full security checks.  If the</span>
00167     <span class="comment">//  caller hasn't specified an access state then dummy up a local one</span>
00168     <span class="comment">//  using the requested desired access</span>
00169     <span class="comment">//</span>
00170 
00171     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(AccessState)) {
00172 
00173         AccessState = &amp;LocalAccessState;
00174 
00175         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/seastate_8c.html#a2">SeCreateAccessState</a>( &amp;LocalAccessState,
00176                                       &amp;AuxData,
00177                                       DesiredAccess,
00178                                       &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> );
00179 
00180         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00181 
00182             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Object);
00183 
00184             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00185         }
00186     }
00187 
00188     AccessState-&gt;SecurityDescriptor = ObjectCreateInfo-&gt;<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html#o7">SecurityDescriptor</a>;
00189 
00190     <span class="comment">//</span>
00191     <span class="comment">//  Check the desired access mask against the security descriptor</span>
00192     <span class="comment">//</span>
00193 
00194     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a14">ObpValidateAccessMask</a>( AccessState );
00195 
00196     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00197 
00198         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Object);
00199 
00200         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00201     }
00202 
00203     <span class="comment">//</span>
00204     <span class="comment">//  Set some local state variables</span>
00205     <span class="comment">//</span>
00206 
00207     DirectoryLocked = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00208     InsertObject = Object;
00209     OpenReason = <a class="code" href="../../d4/d0/ob_8h.html#a100a58">ObCreateHandle</a>;
00210 
00211     <span class="comment">//</span>
00212     <span class="comment">//  Check if we have an object name.  If so then</span>
00213     <span class="comment">//  lookup the name</span>
00214     <span class="comment">//</span>
00215 
00216     <span class="keywordflow">if</span> (ObjectName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00217 
00218         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a71">ObpLookupObjectName</a>( ObjectCreateInfo-&gt;<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html#o1">RootDirectory</a>,
00219                                       ObjectName,
00220                                       ObjectCreateInfo-&gt;<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html#o0">Attributes</a>,
00221                                       ObjectType,
00222                                       (KPROCESSOR_MODE)(ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; OB_FLAG_KERNEL_OBJECT
00223                                                             ? KernelMode : UserMode),
00224                                       ObjectCreateInfo-&gt;<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html#o2">ParseContext</a>,
00225                                       ObjectCreateInfo-&gt;<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html#o8">SecurityQos</a>,
00226                                       Object,
00227                                       AccessState,
00228                                       &amp;DirectoryLocked,
00229                                       &amp;InsertObject );
00230 
00231         <span class="comment">//</span>
00232         <span class="comment">//  We found the name and it is not the object we have as our input.</span>
00233         <span class="comment">//  So we cannot insert the object again so we'll return an</span>
00234         <span class="comment">//  appropriate status</span>
00235         <span class="comment">//</span>
00236 
00237         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) &amp;&amp;
00238             (InsertObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00239             (InsertObject != Object)) {
00240 
00241             OpenReason = <a class="code" href="../../d4/d0/ob_8h.html#a100a59">ObOpenHandle</a>;
00242 
00243             <span class="keywordflow">if</span> (ObjectCreateInfo-&gt;<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html#o0">Attributes</a> &amp; OBJ_OPENIF) {
00244 
00245                 <span class="keywordflow">if</span> (ObjectType != <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(InsertObject)-&gt;Type) {
00246 
00247                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_TYPE_MISMATCH;
00248 
00249                 } <span class="keywordflow">else</span> {
00250 
00251                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_EXISTS;     <span class="comment">// Warning only</span>
00252                 }
00253 
00254             } <span class="keywordflow">else</span> {
00255 
00256                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_COLLISION;
00257             }
00258         }
00259 
00260         <span class="comment">//</span>
00261         <span class="comment">//  We did not find the name so we'll cleanup after ourselves</span>
00262         <span class="comment">//  and return to our caller</span>
00263         <span class="comment">//</span>
00264 
00265         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00266 
00267             <span class="keywordflow">if</span> (DirectoryLocked) {
00268 
00269                 <a class="code" href="../../d5/d1/obp_8h.html#a11">ObpLeaveRootDirectoryMutex</a>();
00270             }
00271 
00272             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Object );
00273 
00274             <span class="comment">//</span>
00275             <span class="comment">//  Free security information if we allocated it</span>
00276             <span class="comment">//</span>
00277 
00278             <span class="keywordflow">if</span> (AccessState == &amp;LocalAccessState) {
00279 
00280                 <a class="code" href="../../d2/d5/seastate_8c.html#a3">SeDeleteAccessState</a>( AccessState );
00281             }
00282 
00283             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00284 
00285         } <span class="keywordflow">else</span> {
00286 
00287             <span class="comment">//</span>
00288             <span class="comment">//  Otherwise we did locate the object name</span>
00289             <span class="comment">//</span>
00290             <span class="comment">//  If we just created a named symbolic link then call out to</span>
00291             <span class="comment">//  handle any Dos Device name semanatics.</span>
00292             <span class="comment">//</span>
00293 
00294             <span class="keywordflow">if</span> (ObjectType == <a class="code" href="../../d5/d1/obp_8h.html#a43">ObpSymbolicLinkObjectType</a>) {
00295 
00296                 <a class="code" href="../../d5/d1/obp_8h.html#a66">ObpCreateSymbolicLinkName</a>( (<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html">POBJECT_SYMBOLIC_LINK</a>)InsertObject );
00297             }
00298         }
00299     }
00300 
00301     <span class="comment">//</span>
00302     <span class="comment">//  If we are creating a new object, then we need assign security</span>
00303     <span class="comment">//  to it.  A pointer to the captured caller-proposed security</span>
00304     <span class="comment">//  descriptor is contained in the AccessState structure.  The</span>
00305     <span class="comment">//  SecurityDescriptor field in the object header must point to</span>
00306     <span class="comment">//  the final security descriptor, or to NULL if no security is</span>
00307     <span class="comment">//  to be assigned to the object.</span>
00308     <span class="comment">//</span>
00309 
00310     <span class="keywordflow">if</span> (InsertObject == Object) {
00311 
00312         <span class="comment">//</span>
00313         <span class="comment">//  Only the following objects have security descriptors:</span>
00314         <span class="comment">//</span>
00315         <span class="comment">//       - Named Objects</span>
00316         <span class="comment">//       - Unnamed objects whose object-type information explicitly</span>
00317         <span class="comment">//         indicates a security descriptor is required.</span>
00318         <span class="comment">//</span>
00319 
00320         <span class="keywordflow">if</span> ((ObjectName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o6">SecurityRequired</a>) {
00321 
00322             <span class="comment">//</span>
00323             <span class="comment">//  Get the parent's descriptor, if there is one...</span>
00324             <span class="comment">//</span>
00325 
00326             <span class="keywordflow">if</span> ((NameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00327 
00328                 <span class="comment">//</span>
00329                 <span class="comment">//  This will allocate a block of memory and copy</span>
00330                 <span class="comment">//  the parent's security descriptor into it, and</span>
00331                 <span class="comment">//  return the pointer to the block.</span>
00332                 <span class="comment">//</span>
00333                 <span class="comment">//  Call ObReleaseObjectSecurity to free up this</span>
00334                 <span class="comment">//  memory.</span>
00335                 <span class="comment">//</span>
00336 
00337                 <a class="code" href="../../d9/d1/obse_8c.html#a8">ObGetObjectSecurity</a>( NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a>,
00338                                      &amp;ParentDescriptor,
00339                                      &amp;SecurityDescriptorAllocated );
00340             }
00341 
00342             <span class="comment">//</span>
00343             <span class="comment">//  Take the captured security descriptor in the AccessState,</span>
00344             <span class="comment">//  put it into the proper format, and call the object's</span>
00345             <span class="comment">//  security method to assign the new security descriptor to</span>
00346             <span class="comment">//  the new object.</span>
00347             <span class="comment">//</span>
00348 
00349             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a11">ObAssignSecurity</a>( AccessState,
00350                                        ParentDescriptor,
00351                                        Object,
00352                                        ObjectType );
00353 
00354             <span class="keywordflow">if</span> (ParentDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00355 
00356                 <a class="code" href="../../d9/d1/obse_8c.html#a9">ObReleaseObjectSecurity</a>( ParentDescriptor,
00357                                          SecurityDescriptorAllocated );
00358 
00359             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00360 
00361                 <a class="code" href="../../d2/d5/se_2capture_8c.html#a2">SeReleaseSecurityDescriptor</a>( ObjectCreateInfo-&gt;<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html#o7">SecurityDescriptor</a>,
00362                                              ObjectCreateInfo-&gt;<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html#o3">ProbeMode</a>,
00363                                              TRUE );
00364 
00365                 ObjectCreateInfo-&gt;<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html#o7">SecurityDescriptor</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00366                 AccessState-&gt;SecurityDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00367             }
00368         }
00369 
00370         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00371 
00372             <span class="comment">//</span>
00373             <span class="comment">//  The attempt to assign the security descriptor to</span>
00374             <span class="comment">//  the object failed.</span>
00375             <span class="comment">//</span>
00376 
00377             <span class="keywordflow">if</span> (DirectoryLocked) {
00378 
00379                 <span class="comment">//</span>
00380                 <span class="comment">//  If ObpLookupObjectName already inserted the </span>
00381                 <span class="comment">//  object into the directory we have to backup this</span>
00382                 <span class="comment">//</span>
00383 
00384                 <span class="comment">//</span>
00385                 <span class="comment">//  Capture the object Directory </span>
00386                 <span class="comment">//</span>
00387 
00388                 DirObject = NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a>;
00389                 
00390                 <a class="code" href="../../d5/d1/obp_8h.html#a70">ObpDeleteDirectoryEntry</a>( NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a> ); 
00391 
00392                 NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00393 
00394                 <a class="code" href="../../d5/d1/obp_8h.html#a11">ObpLeaveRootDirectoryMutex</a>();
00395 
00396                 <span class="comment">//</span>
00397                 <span class="comment">//  If ObpLookupObjectName inserted the object into the directory</span>
00398                 <span class="comment">//  it added a reference to the object and to its directory</span>
00399                 <span class="comment">//  object. We should remove the extra-references</span>
00400                 <span class="comment">//</span>
00401 
00402                 <span class="keywordflow">if</span> (DirObject) {
00403                     
00404                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Object );
00405                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( DirObject );
00406                 }
00407             }
00408 
00409             <span class="comment">//</span>
00410             <span class="comment">//  *** The first backout logic used ObpDeleteNameCheck</span>
00411             <span class="comment">//  which is wrong because the security descriptor for</span>
00412             <span class="comment">//  the object is not initialized. Actually  ObpDeleteNameCheck</span>
00413             <span class="comment">//  had no effect because the object was removed before from </span>
00414             <span class="comment">//  the directory</span>
00415             <span class="comment">//</span>
00416 
00417             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Object );
00418 
00419             <span class="comment">//</span>
00420             <span class="comment">//  Free security information if we allocated it</span>
00421             <span class="comment">//</span>
00422 
00423             <span class="keywordflow">if</span> (AccessState == &amp;LocalAccessState) {
00424 
00425                 <a class="code" href="../../d2/d5/seastate_8c.html#a3">SeDeleteAccessState</a>( AccessState );
00426             }
00427 
00428             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00429         }
00430     }
00431 
00432     ReturnStatus = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00433 
00434     ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o8">ObjectCreateInfo</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00435 
00436     <span class="comment">//</span>
00437     <span class="comment">//  Create a named handle for the object with a pointer bias</span>
00438     <span class="comment">//  This call also will unlock the directory lock is necessary</span>
00439     <span class="comment">//  on return</span>
00440     <span class="comment">//</span>
00441 
00442     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a79">ObpCreateHandle</a>( OpenReason,
00443                               InsertObject,
00444                               NULL,
00445                               AccessState,
00446                               1 + ObjectPointerBias,
00447                               ObjectCreateInfo-&gt;<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html#o0">Attributes</a>,
00448                               DirectoryLocked,
00449                               PreviousMode,
00450                               NewObject,
00451                               &amp;NewHandle );
00452 
00453     <a class="code" href="../../d5/d1/obp_8h.html#a29">ObpFreeObjectCreateInformation</a>( ObjectCreateInfo );
00454 
00455     <span class="comment">//</span>
00456     <span class="comment">//  If the insertion failed, the following dereference will cause</span>
00457     <span class="comment">//  the newly created object to be deallocated.</span>
00458     <span class="comment">//</span>
00459 
00460     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00461 
00462         <span class="comment">//</span>
00463         <span class="comment">//  Make the name reference go away if an error.</span>
00464         <span class="comment">//</span>
00465 
00466         <span class="keywordflow">if</span> (ObjectName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00467 
00468             <a class="code" href="../../d7/d1/obref_8c.html#a11">ObpDeleteNameCheck</a>( Object, FALSE );
00469         }
00470     }
00471 
00472     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Object );
00473 
00474     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00475 
00476         *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = NewHandle;
00477 
00478     } <span class="keywordflow">else</span> {
00479 
00480         *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00481 
00482         ReturnStatus = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00483     }
00484 
00485     <span class="comment">//</span>
00486     <span class="comment">//  Free security information if we allocated it</span>
00487     <span class="comment">//</span>
00488 
00489     <span class="keywordflow">if</span> (AccessState == &amp;LocalAccessState) {
00490 
00491         <a class="code" href="../../d2/d5/seastate_8c.html#a3">SeDeleteAccessState</a>( AccessState );
00492     }
00493 
00494     <span class="keywordflow">return</span>( ReturnStatus );
00495 }
}
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:58 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
