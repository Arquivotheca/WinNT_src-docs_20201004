<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: hivesync.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>hivesync.c</h1><a href="../../d0/d2/hivesync_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    hivesync.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements procedures to write dirty parts of a hive's</span>
00012 <span class="comment">    stable store to backing media.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Bryan M. Willman (bryanwi) 28-Mar-92</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment"></span>
00021 <span class="comment">Revision History:</span>
00022 <span class="comment"></span>
00023 <span class="comment">--*/</span>
00024 
00025 <span class="preprocessor">#include    "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00026 
<a name="l00027"></a><a class="code" href="../../d0/d2/hivesync_8c.html#a1">00027</a> <span class="keyword">extern</span>  BOOLEAN <a class="code" href="../../d7/d0/cmdat2_8c.html#a13">HvShutdownComplete</a>;     <span class="comment">// Set to true after shutdown</span>
00028                                         <span class="comment">// to disable any further I/O</span>
00029 
00030 <span class="preprocessor">#if DBG</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#define DumpDirtyVector(Hive)    \</span>
00032 <span class="preprocessor">        {                                                               \</span>
00033 <span class="preprocessor">            PRTL_BITMAP BitMap;                                         \</span>
00034 <span class="preprocessor">            ULONG BitMapSize;                                           \</span>
00035 <span class="preprocessor">            PUCHAR BitBuffer;                                           \</span>
00036 <span class="preprocessor">            ULONG i;                                                    \</span>
00037 <span class="preprocessor">            UCHAR Byte;                                                 \</span>
00038 <span class="preprocessor">                                                                        \</span>
00039 <span class="preprocessor">            BitMap = &amp;(Hive-&gt;DirtyVector);                              \</span>
00040 <span class="preprocessor">            BitMapSize = (BitMap-&gt;SizeOfBitMap) / 8;                    \</span>
00041 <span class="preprocessor">            BitBuffer = (PUCHAR)(BitMap-&gt;Buffer);                       \</span>
00042 <span class="preprocessor">            for (i = 0; i &lt; BitMapSize; i++) {                          \</span>
00043 <span class="preprocessor">                if ((i % 8) == 0) {                                     \</span>
00044 <span class="preprocessor">                    KdPrint(("\n\t"));                                     \</span>
00045 <span class="preprocessor">                }                                                       \</span>
00046 <span class="preprocessor">                Byte = BitBuffer[i];                                    \</span>
00047 <span class="preprocessor">                KdPrint(("%02x ", Byte));                                 \</span>
00048 <span class="preprocessor">            }                                                           \</span>
00049 <span class="preprocessor">            KdPrint(("\n"));                                               \</span>
00050 <span class="preprocessor">        }</span>
00051 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00052"></a><a class="code" href="../../d0/d2/hivesync_8c.html#a0">00052</a> <span class="preprocessor"></span><span class="preprocessor">#define DumpDirtyVector(Hive)</span>
00053 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00054 <span class="preprocessor"></span>
00055 <span class="comment">//</span>
00056 <span class="comment">// Private prototypes</span>
00057 <span class="comment">//</span>
00058 BOOLEAN
00059 <a class="code" href="../../d0/d2/hivesync_8c.html#a2">HvpWriteLog</a>(
00060     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive
00061     );
00062 
00063 BOOLEAN
00064 <a class="code" href="../../d0/d2/hivesync_8c.html#a3">HvpFindNextDirtyBlock</a>(
00065     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
00066     PRTL_BITMAP     <a class="code" href="../../d2/d1/structBitMap.html">BitMap</a>,
00067     PULONG          Current,
00068     PUCHAR          *Address,
00069     PULONG          Length,
00070     PULONG          Offset
00071     );
00072 
00073 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00074 <a class="code" href="../../d0/d2/hivesync_8c.html#a16">HvpDiscardBins</a>(
00075     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>  Hive
00076     );
00077 
00078 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00079 <a class="code" href="../../d0/d2/hivesync_8c.html#a17">HvpTruncateBins</a>(
00080     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>  Hive
00081     );
00082 
00083 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00084 <a class="code" href="../../d0/d2/hivesync_8c.html#a6">HvRefreshHive</a>(
00085     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>  Hive
00086     );
00087 
00088 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00089 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvMarkCellDirty)</span>
00090 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvIsBinDirty)</span>
00091 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvMarkDirty)</span>
00092 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvMarkClean)</span>
00093 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvpGrowLog1)</span>
00094 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvpGrowLog2)</span>
00095 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvSyncHive)</span>
00096 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvpDoWriteHive)</span>
00097 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvpWriteLog)</span>
00098 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvpFindNextDirtyBlock)</span>
00099 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvWriteHive)</span>
00100 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvRefreshHive)</span>
00101 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvpDiscardBins)</span>
00102 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvpTruncateBins)</span>
00103 <span class="preprocessor"></span>
00104 <span class="preprocessor">#ifdef _WRITE_PROTECTED_REGISTRY_POOL</span>
00105 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvpChangeBinAllocation)</span>
00106 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvpMarkBinReadWrite)</span>
00107 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00108 <span class="preprocessor"></span>
00109 <span class="preprocessor">#endif</span>
00110 <span class="preprocessor"></span>
00111 
00112 
00113 <span class="comment">//</span>
00114 <span class="comment">// Code for tracking modifications and ensuring adequate log space</span>
00115 <span class="comment">//</span>
00116 BOOLEAN
<a name="l00117"></a><a class="code" href="../../d0/d2/hivesync_8c.html#a7">00117</a> <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(
00118     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>      Hive,
00119     HCELL_INDEX Cell
00120     )
00121 <span class="comment">/*++</span>
00122 <span class="comment"></span>
00123 <span class="comment">Routine Description:</span>
00124 <span class="comment"></span>
00125 <span class="comment">    Marks the data for the specified cell dirty.</span>
00126 <span class="comment"></span>
00127 <span class="comment">Arguments:</span>
00128 <span class="comment"></span>
00129 <span class="comment">    Hive - supplies a pointer to the hive control structure for the</span>
00130 <span class="comment">            hive of interest</span>
00131 <span class="comment"></span>
00132 <span class="comment">    Cell - hcell_index of cell that is being edited</span>
00133 <span class="comment"></span>
00134 <span class="comment">Return Value:</span>
00135 <span class="comment"></span>
00136 <span class="comment">    TRUE - it worked</span>
00137 <span class="comment"></span>
00138 <span class="comment">    FALSE - could not allocate log space, failure!</span>
00139 <span class="comment"></span>
00140 <span class="comment">--*/</span>
00141 {
00142     ULONG       Type;
00143     ULONG       <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00144     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>      pCell;
00145     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> Me;
00146     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Base;
00147     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>       <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00148 
00149     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a23">CML_MINOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a30">CMS_IO</a>) {
00150         KdPrint((<span class="stringliteral">"HvMarkCellDirty:\n\t"</span>));
00151         KdPrint((<span class="stringliteral">"Hive:%08lx Cell:%08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>));
00152     }
00153 
00154     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == <a class="code" href="../../d0/d1/hivedata_8h.html#a37">HHIVE_SIGNATURE</a>);
00155     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00156     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00157 
00158     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00159 
00160     <span class="keywordflow">if</span> ( (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>) ||
00161          (Type == <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>) )
00162     {
00163         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00164     }
00165 
00166     pCell = <a class="code" href="../../d6/d0/hive_8h.html#a13">HvpGetHCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00167 <span class="preprocessor">#if DBG</span>
00168 <span class="preprocessor"></span>    Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00169     <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00170     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
00171     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o0">Signature</a> == <a class="code" href="../../d0/d1/hivedata_8h.html#a24">HBIN_SIGNATURE</a>);
00172 <span class="preprocessor">#endif</span>
00173 <span class="preprocessor"></span>    <span class="comment">//</span>
00174     <span class="comment">// If it's an old format hive, mark the entire</span>
00175     <span class="comment">// bin dirty, because the Last backpointers are</span>
00176     <span class="comment">// such a pain to deal with in the partial</span>
00177     <span class="comment">// alloc and free-coalescing cases.</span>
00178     <span class="comment">//</span>
00179 
00180     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>)) {
00181         Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00182         <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00183         <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
00184         Base = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>;
00185         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>;
00186         <span class="keywordflow">return</span> <a class="code" href="../../d0/d2/hivesync_8c.html#a9">HvMarkDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Base, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
00187     } <span class="keywordflow">else</span> {
00188         <span class="keywordflow">if</span> (pCell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> &lt; 0) {
00189             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = -pCell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>;
00190         } <span class="keywordflow">else</span> {
00191             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = pCell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>;
00192         }
00193         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Size &lt; Bin-&gt;<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
00194         <span class="keywordflow">return</span> <a class="code" href="../../d0/d2/hivesync_8c.html#a9">HvMarkDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-FIELD_OFFSET(<a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>,u.NewCell), <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
00195     }
00196 }
00197 
00198 
00199 BOOLEAN
<a name="l00200"></a><a class="code" href="../../d0/d2/hivesync_8c.html#a8">00200</a> <a class="code" href="../../d0/d2/hivesync_8c.html#a8">HvIsBinDirty</a>(
00201     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00202     IN HCELL_INDEX Cell
00203     )
00204 
00205 <span class="comment">/*++</span>
00206 <span class="comment"></span>
00207 <span class="comment">Routine Description:</span>
00208 <span class="comment"></span>
00209 <span class="comment">    Given a hive and a cell, checks whether the bin containing</span>
00210 <span class="comment">    that cell has any dirty clusters or not.</span>
00211 <span class="comment"></span>
00212 <span class="comment">Arguments:</span>
00213 <span class="comment"></span>
00214 <span class="comment">    Hive - Supplies a pointer to the hive control structure</span>
00215 <span class="comment"></span>
00216 <span class="comment">    Cell - Supplies the HCELL_INDEX of the Cell.</span>
00217 <span class="comment"></span>
00218 <span class="comment">Return Value:</span>
00219 <span class="comment"></span>
00220 <span class="comment">    TRUE - Bin contains dirty data.</span>
00221 <span class="comment"></span>
00222 <span class="comment">    FALSE - Bin does not contain dirty data.</span>
00223 <span class="comment"></span>
00224 <span class="comment">--*/</span>
00225 
00226 {
00227     ULONG       Type;
00228     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>      pcell;
00229     PRTL_BITMAP Bitmap;
00230     ULONG       First;
00231     ULONG       Last;
00232     ULONG       i;
00233     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> Map;
00234     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>       <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00235 
00236     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a23">CML_MINOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a30">CMS_IO</a>) {
00237         KdPrint((<span class="stringliteral">"HvIsBinDirty:\n\t"</span>));
00238         KdPrint((<span class="stringliteral">"Hive:%08lx Cell:%08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>));
00239     }
00240 
00241     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == <a class="code" href="../../d0/d1/hivedata_8h.html#a37">HHIVE_SIGNATURE</a>);
00242     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00243 
00244     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00245 
00246     <span class="keywordflow">if</span> ( (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>) ||
00247          (Type == <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>) )
00248     {
00249         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00250     }
00251 
00252     Bitmap = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>);
00253 
00254     Map = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00255     <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Map,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00256     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
00257     First = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00258     Last = (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> - 1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00259 
00260     <span class="keywordflow">for</span> (i=First; i&lt;=Last; i++) {
00261         <span class="keywordflow">if</span> (RtlCheckBit(Bitmap, i)==1) {
00262             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00263         }
00264     }
00265     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00266 }
00267 
00268 
00269 BOOLEAN
<a name="l00270"></a><a class="code" href="../../d0/d2/hivesync_8c.html#a9">00270</a> <a class="code" href="../../d0/d2/hivesync_8c.html#a9">HvMarkDirty</a>(
00271     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>      Hive,
00272     HCELL_INDEX Start,
00273     ULONG       Length
00274     )
00275 <span class="comment">/*++</span>
00276 <span class="comment"></span>
00277 <span class="comment">Routine Description:</span>
00278 <span class="comment"></span>
00279 <span class="comment">    Marks the relevent parts of a hive dirty, so that they will</span>
00280 <span class="comment">    be flushed to backing store.</span>
00281 <span class="comment"></span>
00282 <span class="comment">    If Hive-&gt;Cluster is not 1, then adjacent all logical sectors</span>
00283 <span class="comment">    in the given cluster will be forced dirty (and log space</span>
00284 <span class="comment">    allocated for them.)  This must be done here rather than in</span>
00285 <span class="comment">    HvSyncHive so that we can know how much to grow the log.</span>
00286 <span class="comment"></span>
00287 <span class="comment">    This is a noop for Volatile address range.</span>
00288 <span class="comment"></span>
00289 <span class="comment">    NOTE:   Range will not be marked dirty if operation fails.</span>
00290 <span class="comment"></span>
00291 <span class="comment">Arguments:</span>
00292 <span class="comment"></span>
00293 <span class="comment">    Hive - supplies a pointer to the hive control structure for the</span>
00294 <span class="comment">            hive of interest</span>
00295 <span class="comment"></span>
00296 <span class="comment">    Start - supplies a hive virtual address (i.e., an HCELL_INDEX or</span>
00297 <span class="comment">             like form address) of the start of the area to mark dirty.</span>
00298 <span class="comment"></span>
00299 <span class="comment">    Length - inclusive length in bytes of area to mark dirty.</span>
00300 <span class="comment"></span>
00301 <span class="comment">Return Value:</span>
00302 <span class="comment"></span>
00303 <span class="comment">    TRUE - it worked</span>
00304 <span class="comment"></span>
00305 <span class="comment">    FALSE - could not allocate log space, failure!</span>
00306 <span class="comment"></span>
00307 <span class="comment">--*/</span>
00308 {
00309     ULONG       Type;
00310     PRTL_BITMAP <a class="code" href="../../d2/d1/structBitMap.html">BitMap</a>;
00311     ULONG       First;
00312     ULONG       Last;
00313     ULONG       i;
00314     ULONG       Cluster;
00315     ULONG       OriginalDirtyCount;
00316     ULONG       DirtySectors;
00317     BOOLEAN     Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00318 
00319     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a23">CML_MINOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a30">CMS_IO</a>) {
00320         KdPrint((<span class="stringliteral">"HvMarkDirty:\n\t"</span>));
00321         KdPrint((<span class="stringliteral">"Hive:%08lx Start:%08lx Length:%08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>, Length));
00322     }
00323 
00324 
00325     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == <a class="code" href="../../d0/d1/hivedata_8h.html#a37">HHIVE_SIGNATURE</a>);
00326     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00327     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00328 
00329     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>);
00330 
00331     <span class="keywordflow">if</span> ( (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>) ||
00332          (Type == <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>) )
00333     {
00334         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00335     }
00336 
00337 
00338     <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a> = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>);
00339     OriginalDirtyCount = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a>;
00340 
00341     First = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00342     Last = (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> + Length - 1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00343 
00344     Cluster = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>;
00345     <span class="keywordflow">if</span> (Cluster &gt; 1) {
00346 
00347         <span class="comment">//</span>
00348         <span class="comment">// Force Start down to base of cluster</span>
00349         <span class="comment">// Force End up to top of cluster</span>
00350         <span class="comment">//</span>
00351         First = First &amp; ~(Cluster - 1);
00352         Last = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(Last+1, Cluster) - 1;
00353     }
00354 
00355     <span class="keywordflow">if</span> (Last &gt;= <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a>-&gt;SizeOfBitMap) {
00356         Last = <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a>-&gt;SizeOfBitMap-1;
00357     }
00358 
00359     <span class="comment">//</span>
00360     <span class="comment">// Try and grow the log enough to accomodate all the dirty sectors.</span>
00361     <span class="comment">//</span>
00362     DirtySectors = 0;
00363     <span class="keywordflow">for</span> (i = First; i &lt;= Last; i++) {
00364         <span class="keywordflow">if</span> (RtlCheckBit(<a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a>, i)==0) {
00365             ++DirtySectors;
00366         }
00367     }
00368     <span class="keywordflow">if</span> (DirtySectors != 0) {
00369         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/hivesync_8c.html#a11">HvpGrowLog1</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, DirtySectors) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00370             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00371         }
00372     
00373         <span class="keywordflow">if</span> ((OriginalDirtyCount == 0) &amp;&amp; (First != 0)) {
00374             Result = <a class="code" href="../../d0/d2/hivesync_8c.html#a9">HvMarkDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>));  <span class="comment">// force header of 1st bin dirty</span>
00375             <span class="keywordflow">if</span> (Result==<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00376                 <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00377             }
00378         }
00379     
00380         <span class="comment">//</span>
00381         <span class="comment">// Log has been successfully grown, go ahead</span>
00382         <span class="comment">// and set the dirty bits.</span>
00383         <span class="comment">//</span>
00384         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00385         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> += DirtySectors;
00386         <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a34">RtlSetBits</a>(<a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a>, First, Last-First+1);
00387     }
00388 
00389     <span class="comment">// mark this bin as writable</span>
00390     <a class="code" href="../../d1/d2/cmp_8h.html#a12">HvpMarkBinReadWrite</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>);
00391         
00392     <span class="keywordflow">if</span> (!(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a10">HIVE_NOLAZYFLUSH</a>)) {
00393         <a class="code" href="../../d6/d3/cmwraper_8c.html#a11">CmpLazyFlush</a>();
00394     }
00395     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00396     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00397 }
00398 
00399 
00400 BOOLEAN
<a name="l00401"></a><a class="code" href="../../d0/d2/hivesync_8c.html#a10">00401</a> <a class="code" href="../../d0/d2/hivesync_8c.html#a10">HvMarkClean</a>(
00402     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>      Hive,
00403     HCELL_INDEX Start,
00404     ULONG       Length
00405     )
00406 <span class="comment">/*++</span>
00407 <span class="comment"></span>
00408 <span class="comment">Routine Description:</span>
00409 <span class="comment"></span>
00410 <span class="comment">    Clears the dirty bits for a given portion of a hive.  This is</span>
00411 <span class="comment">    the inverse of HvMarkDirty, although it does not give up any</span>
00412 <span class="comment">    file space in the primary or log that HvMarkDirty may have reserved.</span>
00413 <span class="comment"></span>
00414 <span class="comment">    This is a noop for Volatile address range.</span>
00415 <span class="comment"></span>
00416 <span class="comment">Arguments:</span>
00417 <span class="comment"></span>
00418 <span class="comment">    Hive - supplies a pointer to the hive control structure for the</span>
00419 <span class="comment">            hive of interest</span>
00420 <span class="comment"></span>
00421 <span class="comment">    Start - supplies a hive virtual address (i.e., an HCELL_INDEX or</span>
00422 <span class="comment">             like form address) of the start of the area to mark dirty.</span>
00423 <span class="comment"></span>
00424 <span class="comment">    Length - inclusive length in bytes of area to mark dirty.</span>
00425 <span class="comment"></span>
00426 <span class="comment">Return Value:</span>
00427 <span class="comment"></span>
00428 <span class="comment">    TRUE - it worked</span>
00429 <span class="comment"></span>
00430 <span class="comment">--*/</span>
00431 {
00432     ULONG       Type;
00433     PRTL_BITMAP <a class="code" href="../../d2/d1/structBitMap.html">BitMap</a>;
00434     ULONG       First;
00435     ULONG       Last;
00436     ULONG       i;
00437     ULONG       Cluster;
00438 
00439     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a23">CML_MINOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a30">CMS_IO</a>) {
00440         KdPrint((<span class="stringliteral">"HvMarkClean:\n\t"</span>));
00441         KdPrint((<span class="stringliteral">"Hive:%08lx Start:%08lx Length:%08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>, Length));
00442     }
00443 
00444 
00445     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == <a class="code" href="../../d0/d1/hivedata_8h.html#a37">HHIVE_SIGNATURE</a>);
00446     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00447     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00448 
00449     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>);
00450 
00451     <span class="keywordflow">if</span> ( (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>) ||
00452          (Type == <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>) )
00453     {
00454         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00455     }
00456 
00457     <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a> = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>);
00458 
00459     First = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00460     Last = (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> + Length - 1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00461 
00462     Cluster = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>;
00463     <span class="keywordflow">if</span> (Cluster &gt; 1) {
00464 
00465         <span class="comment">//</span>
00466         <span class="comment">// Force Start down to base of cluster</span>
00467         <span class="comment">// Force End up to top of cluster</span>
00468         <span class="comment">//</span>
00469         First = First &amp; ~(Cluster - 1);
00470         Last = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(Last+1, Cluster) - 1;
00471     }
00472 
00473     <span class="keywordflow">if</span> (Last &gt;= <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a>-&gt;SizeOfBitMap) {
00474         Last = <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a>-&gt;SizeOfBitMap-1;
00475     }
00476 
00477     <span class="comment">//</span>
00478     <span class="comment">// Subtract out the dirty count and</span>
00479     <span class="comment">// and clear the dirty bits.</span>
00480     <span class="comment">//</span>
00481     <span class="keywordflow">for</span> (i=First; i&lt;=Last; i++) {
00482         <span class="keywordflow">if</span> (RtlCheckBit(<a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a>,i)==1) {
00483             --<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a>;
00484             <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a>(<a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a>, i, 1);
00485         }
00486     }
00487     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00488 
00489     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00490 }
00491 
00492 
00493 
00494 BOOLEAN
<a name="l00495"></a><a class="code" href="../../d0/d2/hivesync_8c.html#a11">00495</a> <a class="code" href="../../d0/d2/hivesync_8c.html#a11">HvpGrowLog1</a>(
00496     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>  Hive,
00497     ULONG   Count
00498     )
00499 <span class="comment">/*++</span>
00500 <span class="comment"></span>
00501 <span class="comment">Routine Description:</span>
00502 <span class="comment"></span>
00503 <span class="comment">    Adjust the log for growth in the number of sectors of dirty</span>
00504 <span class="comment">    data that are desired.</span>
00505 <span class="comment"></span>
00506 <span class="comment">Arguments:</span>
00507 <span class="comment"></span>
00508 <span class="comment">    Hive - supplies a pointer to the hive control structure for the</span>
00509 <span class="comment">            hive of interest</span>
00510 <span class="comment"></span>
00511 <span class="comment">    Count - number of additional logical sectors of log space needed</span>
00512 <span class="comment"></span>
00513 <span class="comment">Return Value:</span>
00514 <span class="comment"></span>
00515 <span class="comment">    TRUE - it worked</span>
00516 <span class="comment"></span>
00517 <span class="comment">    FALSE - could not allocate log space, failure!</span>
00518 <span class="comment"></span>
00519 <span class="comment">--*/</span>
00520 {
00521     ULONG   ClusterSize;
00522     ULONG   RequiredSize;
00523     ULONG   tmp;
00524 
00525     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a23">CML_MINOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a30">CMS_IO</a>) {
00526         KdPrint((<span class="stringliteral">"HvpGrowLog1:\n\t"</span>));
00527         KdPrint((<span class="stringliteral">"Hive:%08lx Count:%08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>));
00528     }
00529 
00530     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00531     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00532 
00533     <span class="comment">//</span>
00534     <span class="comment">// If logging is off, tell caller world is OK.</span>
00535     <span class="comment">//</span>
00536     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o15">Log</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00537         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00538     }
00539 
00540     ClusterSize = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00541 
00542     tmp = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.SizeOfBitMap / 8;   <span class="comment">// bytes</span>
00543     tmp += <span class="keyword">sizeof</span>(ULONG);                       <span class="comment">// signature</span>
00544 
00545     RequiredSize =
00546         ClusterSize  +                                  <span class="comment">// 1 cluster for header</span>
00547         <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(tmp, ClusterSize) +
00548         ((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> + <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>) * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>);
00549 
00550     RequiredSize = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(RequiredSize, <a class="code" href="../../d0/d1/hivedata_8h.html#a2">HLOG_GROW</a>);
00551 
00552     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00553 
00554     <span class="keywordflow">if</span> ( ! (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o4">FileSetSize</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>, RequiredSize)) {
00555         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00556     }
00557 
00558     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o18">LogSize</a> = RequiredSize;
00559     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00560     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00561 }
00562 
00563 
00564 BOOLEAN
<a name="l00565"></a><a class="code" href="../../d0/d2/hivesync_8c.html#a12">00565</a> <a class="code" href="../../d0/d2/hivesync_8c.html#a12">HvpGrowLog2</a>(
00566     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>  Hive,
00567     ULONG   Size
00568     )
00569 <span class="comment">/*++</span>
00570 <span class="comment"></span>
00571 <span class="comment">Routine Description:</span>
00572 <span class="comment"></span>
00573 <span class="comment">    Adjust the log for growth in the size of the hive, in particular,</span>
00574 <span class="comment">    account for the increased space needed for a bigger dirty vector.</span>
00575 <span class="comment"></span>
00576 <span class="comment">Arguments:</span>
00577 <span class="comment"></span>
00578 <span class="comment">    Hive - supplies a pointer to the hive control structure for the</span>
00579 <span class="comment">            hive of interest</span>
00580 <span class="comment"></span>
00581 <span class="comment">    Size - proposed growth in size in bytes.</span>
00582 <span class="comment"></span>
00583 <span class="comment">Return Value:</span>
00584 <span class="comment"></span>
00585 <span class="comment">    TRUE - it worked</span>
00586 <span class="comment"></span>
00587 <span class="comment">    FALSE - could not allocate log space, failure!</span>
00588 <span class="comment"></span>
00589 <span class="comment">--*/</span>
00590 {
00591     ULONG   ClusterSize;
00592     ULONG   RequiredSize;
00593     ULONG   DirtyBytes;
00594 
00595     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a23">CML_MINOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a30">CMS_IO</a>) {
00596         KdPrint((<span class="stringliteral">"HvpGrowLog2:\n\t"</span>));
00597         KdPrint((<span class="stringliteral">"Hive:%08lx Size:%08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>));
00598     }
00599 
00600     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00601     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00602 
00603 
00604     <span class="comment">//</span>
00605     <span class="comment">// If logging is off, tell caller world is OK.</span>
00606     <span class="comment">//</span>
00607     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o15">Log</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00608         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00609     }
00610 
00611     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> % <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>) == 0 );
00612 
00613     ClusterSize = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00614 
00615     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>) / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>) % 8) == 0);
00616 
00617     DirtyBytes = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.SizeOfBitMap / 8) +
00618                     ((<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>) / 8) +
00619                     <span class="keyword">sizeof</span>(ULONG);                      <span class="comment">// signature</span>
00620     DirtyBytes = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(DirtyBytes, ClusterSize);
00621 
00622     RequiredSize =
00623         ClusterSize  +                                  <span class="comment">// 1 cluster for header</span>
00624         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>) +
00625         DirtyBytes;
00626 
00627     RequiredSize = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(RequiredSize, <a class="code" href="../../d0/d1/hivedata_8h.html#a2">HLOG_GROW</a>);
00628 
00629     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00630 
00631     <span class="keywordflow">if</span> ( ! (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o4">FileSetSize</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>, RequiredSize)) {
00632         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00633     }
00634 
00635     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o18">LogSize</a> = RequiredSize;
00636     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00637     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00638 }
00639 
00640 
00641 
00642 <span class="comment">//</span>
00643 <span class="comment">// Code for syncing a hive to backing store</span>
00644 <span class="comment">//</span>
00645 
00646 BOOLEAN
<a name="l00647"></a><a class="code" href="../../d0/d2/hivesync_8c.html#a13">00647</a> <a class="code" href="../../d0/d2/hivesync_8c.html#a13">HvSyncHive</a>(
00648     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>  Hive
00649     )
00650 <span class="comment">/*++</span>
00651 <span class="comment"></span>
00652 <span class="comment">Routine Description:</span>
00653 <span class="comment"></span>
00654 <span class="comment">    Force backing store to match the memory image of the Stable</span>
00655 <span class="comment">    part of the hive's space.</span>
00656 <span class="comment"></span>
00657 <span class="comment">    Logs, primary, and alternate data can be written.  Primary is</span>
00658 <span class="comment">    always written.  Normally either a log or an alternate, but</span>
00659 <span class="comment">    not both, will also be written.</span>
00660 <span class="comment"></span>
00661 <span class="comment">    It is possible to write only the primary.</span>
00662 <span class="comment"></span>
00663 <span class="comment">    All dirty bits will be set clear.</span>
00664 <span class="comment"></span>
00665 <span class="comment">Arguments:</span>
00666 <span class="comment"></span>
00667 <span class="comment">    Hive - supplies a pointer to the hive control structure for the</span>
00668 <span class="comment">            hive of interest</span>
00669 <span class="comment"></span>
00670 <span class="comment">Return Value:</span>
00671 <span class="comment"></span>
00672 <span class="comment">    TRUE - it worked</span>
00673 <span class="comment"></span>
00674 <span class="comment">    FALSE - some failure.</span>
00675 <span class="comment"></span>
00676 <span class="comment">--*/</span>
00677 {
00678     BOOLEAN oldFlag;
00679 
00680     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a21">CML_WORKER</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a30">CMS_IO</a>) {
00681         KdPrint((<span class="stringliteral">"HvSyncHive:\n\t"</span>));
00682         KdPrint((<span class="stringliteral">"Hive:%08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>));
00683     }
00684 
00685     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == <a class="code" href="../../d0/d1/hivedata_8h.html#a37">HHIVE_SIGNATURE</a>);
00686     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00687 
00688     <span class="comment">//</span>
00689     <span class="comment">// Punt if post shutdown</span>
00690     <span class="comment">//</span>
00691     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a13">HvShutdownComplete</a>) {
00692         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a30">CMS_IO</a>) {
00693             KdPrint((<span class="stringliteral">"HvSyncHive:  Attempt to sync AFTER SHUTDOWN\n"</span>));
00694         }
00695         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00696     }
00697 
00698     <span class="comment">//</span>
00699     <span class="comment">// If nothing dirty, do nothing</span>
00700     <span class="comment">//</span>
00701     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == 0) {
00702         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00703     }
00704 
00705     <a class="code" href="../../d0/d2/hivesync_8c.html#a17">HvpTruncateBins</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
00706 
00707     <span class="comment">//</span>
00708     <span class="comment">// If hive is volatile, do nothing</span>
00709     <span class="comment">//</span>
00710     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>) {
00711         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00712     }
00713 
00714     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a30">CMS_IO</a>) {
00715         KdPrint((<span class="stringliteral">"\tDirtyCount:%08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a>));
00716         KdPrint((<span class="stringliteral">"\tDirtyVector:"</span>));
00717         <a class="code" href="../../d0/d2/hivesync_8c.html#a0">DumpDirtyVector</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
00718     }
00719 
00720     <span class="comment">//</span>
00721     <span class="comment">// disable hard error popups, to avoid self deadlock on bogus devices</span>
00722     <span class="comment">//</span>
00723     oldFlag = <a class="code" href="../../d4/d6/iosubs_8c.html#a108">IoSetThreadHardErrorMode</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00724 
00725     <span class="comment">//</span>
00726     <span class="comment">// Write a log.</span>
00727     <span class="comment">//</span>
00728     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o15">Log</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00729         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/hivesync_8c.html#a2">HvpWriteLog</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00730             <a class="code" href="../../d4/d6/iosubs_8c.html#a108">IoSetThreadHardErrorMode</a>(oldFlag);
00731             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00732         }
00733     }
00734 
00735     <span class="comment">//</span>
00736     <span class="comment">// Write the primary</span>
00737     <span class="comment">//</span>
00738     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/hivesync_8c.html#a14">HvpDoWriteHive</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00739         <a class="code" href="../../d4/d6/iosubs_8c.html#a108">IoSetThreadHardErrorMode</a>(oldFlag);
00740         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00741     }
00742 
00743     <span class="comment">//</span>
00744     <span class="comment">// Write an alternate</span>
00745     <span class="comment">//</span>
00746     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o16">Alternate</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00747         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/hivesync_8c.html#a14">HvpDoWriteHive</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00748             <a class="code" href="../../d4/d6/iosubs_8c.html#a108">IoSetThreadHardErrorMode</a>(oldFlag);
00749             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00750         }
00751     }
00752 
00753     <span class="comment">//</span>
00754     <span class="comment">// restore hard error popups mode</span>
00755     <span class="comment">//</span>
00756     <a class="code" href="../../d4/d6/iosubs_8c.html#a108">IoSetThreadHardErrorMode</a>(oldFlag);
00757     
00758     <span class="comment">//</span>
00759     <span class="comment">// Hive was successfully written out, discard any bins marked as</span>
00760     <span class="comment">// discardable.</span>
00761     <span class="comment">//</span>
00762     <a class="code" href="../../d0/d2/hivesync_8c.html#a16">HvpDiscardBins</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
00763 
00764     <span class="comment">//</span>
00765     <span class="comment">// Clear the dirty map</span>
00766     <span class="comment">//</span>
00767     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a27">RtlClearAllBits</a>(&amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00768     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> = 0;
00769 
00770     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00771 }
00772 
00773 
00774 BOOLEAN
<a name="l00775"></a><a class="code" href="../../d0/d2/hivesync_8c.html#a14">00775</a> <a class="code" href="../../d0/d2/hivesync_8c.html#a14">HvpDoWriteHive</a>(
00776     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
00777     ULONG           FileType
00778     )
00779 <span class="comment">/*++</span>
00780 <span class="comment"></span>
00781 <span class="comment">Routine Description:</span>
00782 <span class="comment"></span>
00783 <span class="comment">    Write dirty parts of the hive out to either its primary or alternate</span>
00784 <span class="comment">    file.  Write the header, flush, write all data, flush, update header,</span>
00785 <span class="comment">    flush.  Assume either logging or primary/alternate pairs used.</span>
00786 <span class="comment"></span>
00787 <span class="comment">    NOTE:   TimeStamp is not set, assumption is that HvpWriteLog set</span>
00788 <span class="comment">            that.  It is only used for checking if Logs correspond anyway.</span>
00789 <span class="comment"></span>
00790 <span class="comment">Arguments:</span>
00791 <span class="comment"></span>
00792 <span class="comment">    Hive - pointer to Hive for which dirty data is to be written.</span>
00793 <span class="comment"></span>
00794 <span class="comment">    FileType - indicated whether primary or alternate file should be written.</span>
00795 <span class="comment"></span>
00796 <span class="comment">Return Value:</span>
00797 <span class="comment"></span>
00798 <span class="comment">    TRUE - it worked</span>
00799 <span class="comment"></span>
00800 <span class="comment">    FALSE - it failed</span>
00801 <span class="comment"></span>
00802 <span class="comment">--*/</span>
00803 {
00804     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    BaseBlock;
00805     ULONG           <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00806     PUCHAR          Address;
00807     ULONG           Length;
00808     BOOLEAN         rc;
00809     ULONG           Current;
00810     PRTL_BITMAP     <a class="code" href="../../d2/d1/structBitMap.html">BitMap</a>;
00811     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a>     Me;
00812     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00813     BOOLEAN         ShrinkHive;
00814     <a class="code" href="../../d0/d1/hivedata_8h.html#a66">PCMP_OFFSET_ARRAY</a> offsetArray;
00815     <a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html">CMP_OFFSET_ARRAY</a> offsetElement;
00816     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00817     ULONG SetBitCount;
00818 
00819     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a23">CML_MINOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a30">CMS_IO</a>) {
00820         KdPrint((<span class="stringliteral">"HvpDoWriteHive:\n\t"</span>));
00821         KdPrint((<span class="stringliteral">"Hive:%08lx FileType:%08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, FileType));
00822     }
00823 
00824     <span class="comment">//</span>
00825     <span class="comment">// flush first, so that the filesystem structures get written to</span>
00826     <span class="comment">// disk if we have grown the file.</span>
00827     <span class="comment">//</span>
00828     <span class="keywordflow">if</span> (!(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o7">FileFlush</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, FileType)) {
00829         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00830     }
00831 
00832     BaseBlock = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>;
00833 
00834     <span class="keywordflow">if</span> (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a> &gt; <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length) {
00835         ShrinkHive = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00836     } <span class="keywordflow">else</span> {
00837         ShrinkHive = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00838     }
00839 
00840     <span class="comment">//</span>
00841     <span class="comment">// --- Write out header first time, flush ---</span>
00842     <span class="comment">//</span>
00843     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o0">Signature</a> == <a class="code" href="../../d0/d1/hivedata_8h.html#a26">HBASE_BLOCK_SIGNATURE</a>);
00844     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o4">Major</a> == <a class="code" href="../../d0/d1/hivedata_8h.html#a27">HSYS_MAJOR</a>);
00845     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o7">Format</a> == <a class="code" href="../../d0/d1/hivedata_8h.html#a29">HBASE_FORMAT_MEMORY</a>);
00846     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00847 
00848 
00849     <span class="keywordflow">if</span> (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o1">Sequence1</a> != BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o2">Sequence2</a>) {
00850 
00851         <span class="comment">//</span>
00852         <span class="comment">// Some previous log attempt failed, or this hive needs to</span>
00853         <span class="comment">// be recovered, so punt.</span>
00854         <span class="comment">//</span>
00855         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00856     }
00857 
00858     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length;
00859 
00860     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o1">Sequence1</a>++;
00861     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o6">Type</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>;
00862     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o10">Cluster</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>;
00863     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o13">CheckSum</a> = <a class="code" href="../../d9/d1/hivesum_8c.html#a0">HvpHeaderCheckSum</a>(BaseBlock);
00864 
00865     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = 0;
00866     offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o0">FileOffset</a> = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00867     offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o1">DataBuffer</a> = (PVOID) BaseBlock;
00868     offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o2">DataLength</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a> * <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>;
00869     rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o5">FileWrite</a>)(
00870             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00871             FileType,
00872             &amp;offsetElement,
00873             1,
00874             &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>
00875             );
00876 
00877     <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00878         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00879     }
00880     <span class="keywordflow">if</span> ( ! (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o7">FileFlush</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, FileType)) {
00881         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00882     }
00883     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>, <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>);
00884 
00885     <span class="comment">//</span>
00886     <span class="comment">// --- Write out dirty data (only if there is any) ---</span>
00887     <span class="comment">//</span>
00888 
00889     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00890         <span class="comment">//</span>
00891         <span class="comment">// First sector of first bin will always be dirty, write it out</span>
00892         <span class="comment">// with the TimeStamp value overlaid on its Link field.</span>
00893         <span class="comment">//</span>
00894         <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a> = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>);
00895 
00896         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(RtlCheckBit(<a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a>, 0) == 1);
00897         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(RtlCheckBit(<a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a>, (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> - 1)) == 1);
00898         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<span class="keyword">sizeof</span>(LIST_ENTRY) &gt;= <span class="keyword">sizeof</span>(LARGE_INTEGER));
00899 
00900         Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, 0);
00901         <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,0);
00902         Address = (PUCHAR)Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a>;
00903         Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00904         <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)Address;
00905         <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o4">TimeStamp</a> = BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o3">TimeStamp</a>;
00906 
00907         offsetElement.FileOffset = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00908         offsetElement.DataBuffer = (PVOID) Address;
00909         offsetElement.DataLength = Length;
00910         rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o5">FileWrite</a>)(
00911                 <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00912                 FileType,
00913                 &amp;offsetElement,
00914                 1,
00915                 &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>
00916                 );
00917         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> % (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>)) == 0);
00918         <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00919             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00920         }
00921 
00922 
00923         <span class="comment">//</span>
00924         <span class="comment">// Write out the rest of the dirty data</span>
00925         <span class="comment">//</span>
00926         Current = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>;        <span class="comment">// don't rewrite 1st bin or header</span>
00927 
00928         SetBitCount = <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(<a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a>);
00929         offsetArray =
00930             (<a class="code" href="../../d0/d1/hivedata_8h.html#a66">PCMP_OFFSET_ARRAY</a>)
00931             <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00932                            <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html">CMP_OFFSET_ARRAY</a>) * SetBitCount);
00933         <span class="keywordflow">if</span> (offsetArray == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00934             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00935         }
00936         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
00937 
00938         <span class="keywordflow">while</span> (<a class="code" href="../../d0/d2/hivesync_8c.html#a3">HvpFindNextDirtyBlock</a>(
00939                     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00940                     <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a>,
00941                     &amp;Current,
00942                     &amp;Address,
00943                     &amp;Length,
00944                     &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>
00945                     ) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)
00946         {
00947             <span class="comment">// Gather data into array.</span>
00948             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> &lt; SetBitCount);
00949             offsetArray[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].FileOffset = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00950             offsetArray[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].DataBuffer = Address;
00951             offsetArray[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].DataLength = Length;
00952             <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> += Length;
00953             <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++;
00954             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> % (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>)) == 0);
00955         }
00956 
00957             rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o5">FileWrite</a>)(
00958                     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00959                     FileType,
00960             offsetArray,
00961             <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>,
00962             &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>             <span class="comment">// Just an OUT parameter which returns the point</span>
00963                                 <span class="comment">// in the file after the last write.</span>
00964                     );
00965         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(offsetArray);
00966             <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00967                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00968         }
00969     }
00970 
00971     <span class="keywordflow">if</span> ( ! (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o7">FileFlush</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, FileType)) {
00972         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00973     }
00974 
00975     <span class="comment">//</span>
00976     <span class="comment">// --- Write header again to report completion ---</span>
00977     <span class="comment">//</span>
00978     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o2">Sequence2</a>++;
00979     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o13">CheckSum</a> = <a class="code" href="../../d9/d1/hivesum_8c.html#a0">HvpHeaderCheckSum</a>(BaseBlock);
00980     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = 0;
00981 
00982     offsetElement.FileOffset = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00983     offsetElement.DataBuffer = (PVOID) BaseBlock;
00984     offsetElement.DataLength = <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a> * <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>;
00985     rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o5">FileWrite</a>)(
00986             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00987             FileType,
00988             &amp;offsetElement,
00989             1,
00990             &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>
00991             );
00992     <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00993         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00994     }
00995 
00996     <span class="keywordflow">if</span> (ShrinkHive) {
00997         <span class="comment">//</span>
00998         <span class="comment">// Hive has shrunk, give up the excess space.</span>
00999         <span class="comment">//</span>
01000         <a class="code" href="../../d7/d3/cmwrapr_8c.html#a13">CmpDoFileSetSize</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, FileType, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length + <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>);
01001     }
01002 
01003     <span class="keywordflow">if</span> ( ! (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o7">FileFlush</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, FileType)) {
01004         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01005     }
01006 
01007     <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o15">Log</a>) &amp;&amp;
01008         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o18">LogSize</a> &gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a4">HLOG_MINSIZE</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>))) {
01009         <span class="comment">//</span>
01010         <span class="comment">// Shrink log back down, reserve at least two clusters</span>
01011         <span class="comment">// worth of space so that if all the disk space is</span>
01012         <span class="comment">// consumed, there will still be enough space prereserved</span>
01013         <span class="comment">// to allow a minimum of registry operations so the user</span>
01014         <span class="comment">// can log on.</span>
01015         <span class="comment">//</span>
01016         <a class="code" href="../../d7/d3/cmwrapr_8c.html#a13">CmpDoFileSetSize</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>, <a class="code" href="../../d0/d1/hivedata_8h.html#a4">HLOG_MINSIZE</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>));
01017         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o18">LogSize</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a4">HLOG_MINSIZE</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
01018     }
01019 
01020     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01021 }
01022 
01023 
01024 BOOLEAN
<a name="l01025"></a><a class="code" href="../../d0/d2/hivesync_8c.html#a2">01025</a> <a class="code" href="../../d0/d2/hivesync_8c.html#a2">HvpWriteLog</a>(
01026     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive
01027     )
01028 <span class="comment">/*++</span>
01029 <span class="comment"></span>
01030 <span class="comment">Routine Description:</span>
01031 <span class="comment"></span>
01032 <span class="comment">    Write a header, the DirtyVector, and all the dirty data into</span>
01033 <span class="comment">    the log file.  Do flushes at the right places.  Update the header.</span>
01034 <span class="comment"></span>
01035 <span class="comment">Arguments:</span>
01036 <span class="comment"></span>
01037 <span class="comment">    Hive - pointer to Hive for which dirty data is to be logged.</span>
01038 <span class="comment"></span>
01039 <span class="comment">Return Value:</span>
01040 <span class="comment"></span>
01041 <span class="comment">    TRUE - it worked</span>
01042 <span class="comment"></span>
01043 <span class="comment">    FALSE - it failed</span>
01044 <span class="comment"></span>
01045 <span class="comment">--*/</span>
01046 {
01047     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    BaseBlock;
01048     ULONG           <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01049     PUCHAR          Address;
01050     ULONG           Length;
01051     BOOLEAN         rc;
01052     ULONG           Current;
01053     ULONG           junk;
01054     ULONG           ClusterSize;
01055     ULONG           HeaderLength;
01056     PRTL_BITMAP     <a class="code" href="../../d2/d1/structBitMap.html">BitMap</a>;
01057     ULONG           DirtyVectorSignature = <a class="code" href="../../d0/d1/hivedata_8h.html#a32">HLOG_DV_SIGNATURE</a>;
01058     LARGE_INTEGER   systemtime;
01059     <a class="code" href="../../d0/d1/hivedata_8h.html#a66">PCMP_OFFSET_ARRAY</a> offsetArray;
01060     <a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html">CMP_OFFSET_ARRAY</a> offsetElement;
01061     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
01062     ULONG SetBitCount;
01063 
01064     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a23">CML_MINOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a30">CMS_IO</a>) {
01065         KdPrint((<span class="stringliteral">"HvpWriteLog:\n\t"</span>));
01066         KdPrint((<span class="stringliteral">"Hive:%08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>));
01067     }
01068 
01069     <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a> = &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>;
01070     <span class="comment">//</span>
01071     <span class="comment">// --- Write out header first time, flush ---</span>
01072     <span class="comment">//</span>
01073     BaseBlock = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>;
01074     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o0">Signature</a> == <a class="code" href="../../d0/d1/hivedata_8h.html#a26">HBASE_BLOCK_SIGNATURE</a>);
01075     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o4">Major</a> == <a class="code" href="../../d0/d1/hivedata_8h.html#a27">HSYS_MAJOR</a>);
01076     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o7">Format</a> == <a class="code" href="../../d0/d1/hivedata_8h.html#a29">HBASE_FORMAT_MEMORY</a>);
01077     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01078 
01079 
01080     <span class="keywordflow">if</span> (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o1">Sequence1</a> != BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o2">Sequence2</a>) {
01081 
01082         <span class="comment">//</span>
01083         <span class="comment">// Some previous log attempt failed, or this hive needs to</span>
01084         <span class="comment">// be recovered, so punt.</span>
01085         <span class="comment">//</span>
01086         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01087     }
01088 
01089     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o1">Sequence1</a>++;
01090     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;systemtime);
01091     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o3">TimeStamp</a> = systemtime;
01092 
01093     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o6">Type</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>;
01094 
01095     ClusterSize = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
01096     HeaderLength = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(<a class="code" href="../../d0/d1/hivedata_8h.html#a31">HLOG_HEADER_SIZE</a>, ClusterSize);
01097     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o10">Cluster</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>;
01098 
01099     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o13">CheckSum</a> = <a class="code" href="../../d9/d1/hivesum_8c.html#a0">HvpHeaderCheckSum</a>(BaseBlock);
01100 
01101     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = 0;
01102     offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o0">FileOffset</a> = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01103     offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o1">DataBuffer</a> = (PVOID) BaseBlock;
01104     offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o2">DataLength</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a> * <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>;
01105     rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o5">FileWrite</a>)(
01106             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01107             <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>,
01108             &amp;offsetElement,
01109             1,
01110             &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>
01111             );
01112     <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01113         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01114     }
01115     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>, HeaderLength);
01116     <span class="keywordflow">if</span> ( ! (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o7">FileFlush</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>)) {
01117         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01118     }
01119 
01120     <span class="comment">//</span>
01121     <span class="comment">// --- Write out dirty vector ---</span>
01122     <span class="comment">//</span>
01123     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<span class="keyword">sizeof</span>(ULONG) == <span class="keyword">sizeof</span>(DirtyVectorSignature));  <span class="comment">// See GrowLog1 above</span>
01124     offsetElement.FileOffset = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01125     offsetElement.DataBuffer = (PVOID) &amp;DirtyVectorSignature;
01126     offsetElement.DataLength = <span class="keyword">sizeof</span>(DirtyVectorSignature);
01127     rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o5">FileWrite</a>)(
01128             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01129             <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>,
01130             &amp;offsetElement,
01131             1,
01132             &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>
01133             );
01134     <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01135         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01136     }
01137 
01138     Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.SizeOfBitMap / 8;
01139     Address = (PUCHAR)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.Buffer);
01140     offsetElement.FileOffset = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01141     offsetElement.DataBuffer = (PVOID) Address;
01142     offsetElement.DataLength = Length;
01143     rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o5">FileWrite</a>)(
01144             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01145             <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>,
01146             &amp;offsetElement,
01147             1,
01148             &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>
01149             );
01150     <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01151         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01152     }
01153     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>, ClusterSize);
01154 
01155     <span class="comment">//</span>
01156     <span class="comment">// --- Write out body of log ---</span>
01157     <span class="comment">//</span>
01158     SetBitCount = <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(<a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a>);
01159     offsetArray =
01160         (<a class="code" href="../../d0/d1/hivedata_8h.html#a66">PCMP_OFFSET_ARRAY</a>)
01161         <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01162                        <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html">CMP_OFFSET_ARRAY</a>) * SetBitCount);
01163     <span class="keywordflow">if</span> (offsetArray == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01164         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01165     }
01166     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
01167 
01168     Current = 0;
01169     <span class="keywordflow">while</span> (<a class="code" href="../../d0/d2/hivesync_8c.html#a3">HvpFindNextDirtyBlock</a>(
01170                 <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01171                 <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a>,
01172                 &amp;Current,
01173                 &amp;Address,
01174                 &amp;Length,
01175                 &amp;junk
01176                 ) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)
01177     {
01178         <span class="comment">// Gather data into array.</span>
01179         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> &lt; SetBitCount);
01180         offsetArray[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].FileOffset = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01181         offsetArray[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].DataBuffer = Address;
01182         offsetArray[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].DataLength = Length;
01183         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> += Length;
01184         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++;
01185         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> % ClusterSize) == 0);
01186     }
01187 
01188         rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o5">FileWrite</a>)(
01189                 <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01190                 <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>,
01191         offsetArray,
01192         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>,
01193         &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>             <span class="comment">// Just an OUT parameter which returns the point</span>
01194                             <span class="comment">// in the file after the last write.</span>
01195                 );
01196     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(offsetArray);
01197         <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01198             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01199         }
01200 
01201     <span class="keywordflow">if</span> ( ! (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o7">FileFlush</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>)) {
01202         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01203     }
01204 
01205     <span class="comment">//</span>
01206     <span class="comment">// --- Write header again to report completion ---</span>
01207     <span class="comment">//</span>
01208     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o2">Sequence2</a>++;
01209     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o13">CheckSum</a> = <a class="code" href="../../d9/d1/hivesum_8c.html#a0">HvpHeaderCheckSum</a>(BaseBlock);
01210     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = 0;
01211     offsetElement.FileOffset = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01212     offsetElement.DataBuffer = (PVOID) BaseBlock;
01213     offsetElement.DataLength = <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a> * <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>;
01214     rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o5">FileWrite</a>)(
01215             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01216             <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>,
01217             &amp;offsetElement,
01218             1,
01219             &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>
01220             );
01221     <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01222         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01223     }
01224     <span class="keywordflow">if</span> ( ! (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o7">FileFlush</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>)) {
01225         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01226     }
01227 
01228     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01229 }
01230 
01231 
01232 BOOLEAN
<a name="l01233"></a><a class="code" href="../../d0/d2/hivesync_8c.html#a3">01233</a> <a class="code" href="../../d0/d2/hivesync_8c.html#a3">HvpFindNextDirtyBlock</a>(
01234     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
01235     PRTL_BITMAP     <a class="code" href="../../d2/d1/structBitMap.html">BitMap</a>,
01236     PULONG          Current,
01237     PUCHAR          *Address,
01238     PULONG          Length,
01239     PULONG          Offset
01240     )
01241 <span class="comment">/*++</span>
01242 <span class="comment"></span>
01243 <span class="comment">Routine Description:</span>
01244 <span class="comment"></span>
01245 <span class="comment">    This routine finds and reports the largest run of dirty logical</span>
01246 <span class="comment">    sectors in the hive, which are contiguous in memory and on disk.</span>
01247 <span class="comment"></span>
01248 <span class="comment">Arguments:</span>
01249 <span class="comment"></span>
01250 <span class="comment">    Hive - pointer to Hive of interest.</span>
01251 <span class="comment"></span>
01252 <span class="comment">    BitMap - supplies a pointer to a bitmap structure, which</span>
01253 <span class="comment">                describes what is dirty.</span>
01254 <span class="comment"></span>
01255 <span class="comment">    Current - supplies a pointer to a varible that tracks position</span>
01256 <span class="comment">                in the bitmap.  It is a bitnumber.  It is updated by</span>
01257 <span class="comment">                this call.</span>
01258 <span class="comment"></span>
01259 <span class="comment">    Address - supplies a pointer to a variable to receive a pointer</span>
01260 <span class="comment">                to the area in memory to be written out.</span>
01261 <span class="comment"></span>
01262 <span class="comment">    Length - supplies a pointer to a variable to receive the length</span>
01263 <span class="comment">                of the region to read/write</span>
01264 <span class="comment"></span>
01265 <span class="comment">    Offset - supplies a pointer to a variable to receive the offset</span>
01266 <span class="comment">                in the backing file to which the data should be written.</span>
01267 <span class="comment">                (not valid for log files)</span>
01268 <span class="comment"></span>
01269 <span class="comment">Return Value:</span>
01270 <span class="comment"></span>
01271 <span class="comment">    TRUE - more to write, ret values good</span>
01272 <span class="comment"></span>
01273 <span class="comment">    FALSE - all data has been written</span>
01274 <span class="comment"></span>
01275 <span class="comment">--*/</span>
01276 {
01277     ULONG       i;
01278     ULONG       EndOfBitMap;
01279     ULONG       <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
01280     ULONG       <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
01281     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> FileBaseAddress;
01282     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> FileEndAddress;
01283     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> Me;
01284     PUCHAR      Block;
01285     PUCHAR      StartBlock;
01286     PUCHAR      NextBlock;
01287     ULONG       RunSpan;
01288     ULONG       RunLength;
01289     ULONG       FileLength;
01290     <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>  FreeBin;
01291 
01292     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a30">CMS_IO</a>) {
01293         KdPrint((<span class="stringliteral">"HvpFindNextDirtyBlock:\n\t"</span>));
01294         KdPrint((<span class="stringliteral">"Hive:%08lx Current:%08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, *Current));
01295     }
01296 
01297 
01298     EndOfBitMap = <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a>-&gt;SizeOfBitMap;
01299 
01300     <span class="keywordflow">if</span> (*Current &gt;= EndOfBitMap) {
01301         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01302     }
01303 
01304     <span class="comment">//</span>
01305     <span class="comment">// Find next run of set bits</span>
01306     <span class="comment">//</span>
01307     <span class="keywordflow">for</span> (i = *Current; i &lt; EndOfBitMap; i++) {
01308         <span class="keywordflow">if</span> (RtlCheckBit(<a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a>, i) == 1) {
01309             <span class="keywordflow">break</span>;
01310         }
01311     }
01312     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> = i;
01313 
01314     <span class="keywordflow">for</span> ( ; i &lt; EndOfBitMap; i++) {
01315         <span class="keywordflow">if</span> (RtlCheckBit(<a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a>, i) == 0) {
01316             <span class="keywordflow">break</span>;
01317         }
01318     }
01319     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = i;
01320 
01321 
01322     <span class="comment">//</span>
01323     <span class="comment">// Compute hive virtual addresses, beginning file address, memory address</span>
01324     <span class="comment">//</span>
01325     FileBaseAddress = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
01326     FileEndAddress = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
01327     FileLength = FileEndAddress - FileBaseAddress;
01328     <span class="keywordflow">if</span> (FileLength == 0) {
01329         *Address = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01330         *Current = 0xffffffff;
01331         *Length = 0;
01332         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01333     }
01334     Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, FileBaseAddress);
01335     <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,FileBaseAddress);
01336 
01337     <span class="keywordflow">if</span> (Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a36">HMAP_DISCARDABLE</a>) {
01338         FreeBin = (<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>)Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a>;
01339         StartBlock = (PUCHAR)((Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>) + FileBaseAddress - FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a> );
01340     } <span class="keywordflow">else</span> {
01341         StartBlock = (PUCHAR)Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a>;
01342     }
01343 
01344     Block = StartBlock;
01345     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(((<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>))-&gt;Signature == <a class="code" href="../../d0/d1/hivedata_8h.html#a24">HBIN_SIGNATURE</a>);
01346     *Address = Block + (FileBaseAddress &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a13">HCELL_OFFSET_MASK</a>);
01347 
01348     *<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = FileBaseAddress + <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
01349 
01350     <span class="comment">//</span>
01351     <span class="comment">// Build up length.  First, account for sectors in first block.</span>
01352     <span class="comment">//</span>
01353     RunSpan = <a class="code" href="../../d0/d1/hivedata_8h.html#a16">HSECTOR_COUNT</a> - (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> % <a class="code" href="../../d0/d1/hivedata_8h.html#a16">HSECTOR_COUNT</a>);
01354 
01355     <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> - <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>) &lt;= RunSpan) {
01356 
01357         <span class="comment">//</span>
01358         <span class="comment">// Entire length is in first block, return it</span>
01359         <span class="comment">//</span>
01360         *Length = FileLength;
01361         *Current = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
01362         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01363 
01364     } <span class="keywordflow">else</span> {
01365 
01366         RunLength = RunSpan * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
01367         FileBaseAddress = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(FileBaseAddress+1, <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>);
01368 
01369     }
01370 
01371     <span class="comment">//</span>
01372     <span class="comment">// Scan forward through blocks, filling up length as we go.</span>
01373     <span class="comment">//</span>
01374     <span class="comment">// NOTE:    This loop grows forward 1 block at time.  If we were</span>
01375     <span class="comment">//          really clever we'd fill forward a bin at time, since</span>
01376     <span class="comment">//          bins are always contiguous.  But most bins will be</span>
01377     <span class="comment">//          one block long anyway, so we won't bother for now.</span>
01378     <span class="comment">//</span>
01379     <span class="keywordflow">while</span> (RunLength &lt; FileLength) {
01380 
01381         Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, FileBaseAddress);
01382         <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,FileBaseAddress);
01383         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(((<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>))-&gt;Signature == <a class="code" href="../../d0/d1/hivedata_8h.html#a24">HBIN_SIGNATURE</a>);
01384 
01385         <span class="keywordflow">if</span> (Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a36">HMAP_DISCARDABLE</a>) {
01386             FreeBin = (<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>)Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a>;
01387             NextBlock = (PUCHAR)((Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>) + FileBaseAddress - FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a> );
01388         } <span class="keywordflow">else</span> {
01389             NextBlock = (PUCHAR)Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a>;
01390         }
01391 
01392         <span class="keywordflow">if</span> ( (NextBlock - Block) != <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) {
01393 
01394             <span class="comment">//</span>
01395             <span class="comment">// We've hit a discontinuity in memory.  RunLength is</span>
01396             <span class="comment">// as long as it's going to get.</span>
01397             <span class="comment">//</span>
01398             <span class="keywordflow">break</span>;
01399         }
01400 
01401 
01402         <span class="keywordflow">if</span> ((FileEndAddress - FileBaseAddress) &lt;= <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) {
01403 
01404             <span class="comment">//</span>
01405             <span class="comment">// We've reached the tail block, all is contiguous,</span>
01406             <span class="comment">// fill up to end and return.</span>
01407             <span class="comment">//</span>
01408             *Length = FileLength;
01409             *Current = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
01410             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01411         }
01412 
01413         <span class="comment">//</span>
01414         <span class="comment">// Just another contiguous block, fill forward</span>
01415         <span class="comment">//</span>
01416         RunLength += <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
01417         RunSpan += <a class="code" href="../../d0/d1/hivedata_8h.html#a16">HSECTOR_COUNT</a>;
01418         FileBaseAddress += <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
01419         Block = NextBlock;
01420     }
01421 
01422     <span class="comment">//</span>
01423     <span class="comment">// We either hit a discontinuity, OR, we're at the end of the range</span>
01424     <span class="comment">// we're trying to fill.  In either case, return.</span>
01425     <span class="comment">//</span>
01426     *Length = RunLength;
01427     *Current = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> + RunSpan;
01428     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01429 }
01430 
01431 
01432 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01433"></a><a class="code" href="../../d0/d2/hivesync_8c.html#a15">01433</a> <a class="code" href="../../d0/d2/hivesync_8c.html#a15">HvWriteHive</a>(
01434     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>  Hive
01435     )
01436 <span class="comment">/*++</span>
01437 <span class="comment"></span>
01438 <span class="comment">Routine Description:</span>
01439 <span class="comment"></span>
01440 <span class="comment">    Write the hive out.  Write only to the Primary file, neither</span>
01441 <span class="comment">    logs nor alternates will be updated.  The hive will be written</span>
01442 <span class="comment">    to the HFILE_TYPE_EXTERNAL handle.</span>
01443 <span class="comment"></span>
01444 <span class="comment">    Intended for use in applications like SaveKey.</span>
01445 <span class="comment"></span>
01446 <span class="comment">    Only Stable storage will be written (as for any hive.)</span>
01447 <span class="comment"></span>
01448 <span class="comment">    Presumption is that layer above has set HFILE_TYPE_EXTERNAL</span>
01449 <span class="comment">    handle to point to correct place.</span>
01450 <span class="comment"></span>
01451 <span class="comment">    Applying this call to an active hive will generally hose integrity</span>
01452 <span class="comment">    measures.</span>
01453 <span class="comment"></span>
01454 <span class="comment">    HOW IT WORKS:</span>
01455 <span class="comment"></span>
01456 <span class="comment">        Make a new DirtyVector.  Fill it with 1s (all dirty).</span>
01457 <span class="comment">        Make hive point at it.  We now have what looks like</span>
01458 <span class="comment">        a completely dirty hive.</span>
01459 <span class="comment"></span>
01460 <span class="comment">        Call HvpWriteHive, which will write the whole thing to disk.</span>
01461 <span class="comment"></span>
01462 <span class="comment">        Put back DirtyVector, and free the extra one we used.</span>
01463 <span class="comment"></span>
01464 <span class="comment">        In failure case, force Sequence numbers in Hive and BaseBlock</span>
01465 <span class="comment">        to match.</span>
01466 <span class="comment"></span>
01467 <span class="comment">Arguments:</span>
01468 <span class="comment"></span>
01469 <span class="comment">    Hive - supplies a pointer to the hive control structure for the</span>
01470 <span class="comment">            hive of interest.</span>
01471 <span class="comment"></span>
01472 <span class="comment">Return Value:</span>
01473 <span class="comment"></span>
01474 <span class="comment">    Status.</span>
01475 <span class="comment"></span>
01476 <span class="comment">--*/</span>
01477 {
01478     PULONG          SaveDirtyVector;
01479     ULONG           SaveDirtyVectorSize;
01480     PULONG          AltDirtyVector;
01481     ULONG           AltDirtyVectorSize;
01482     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    SaveBaseBlock;
01483     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    AltBaseBlock;
01484     ULONG           Alignment;
01485 
01486     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        status;
01487 
01488 
01489     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a30">CMS_IO</a>) {
01490         KdPrint((<span class="stringliteral">"HvWriteHive: \n"</span>));
01491         KdPrint((<span class="stringliteral">"\tHive = %08lx\n"</span>));
01492     }
01493     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == <a class="code" href="../../d0/d1/hivedata_8h.html#a37">HHIVE_SIGNATURE</a>);
01494     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01495 
01496 
01497     <span class="comment">//</span>
01498     <span class="comment">// Punt if post shutdown</span>
01499     <span class="comment">//</span>
01500     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a13">HvShutdownComplete</a>) {
01501         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a30">CMS_IO</a>) {
01502             KdPrint((<span class="stringliteral">"HvWriteHive: Attempt to write hive AFTER SHUTDOWN\n"</span>));
01503         }
01504         <span class="keywordflow">return</span> STATUS_REGISTRY_IO_FAILED;
01505     }
01506 
01507     <span class="comment">//</span>
01508     <span class="comment">// Splice in a duplicate DirtyVector with all bits set.</span>
01509     <span class="comment">//</span>
01510     SaveDirtyVector = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.Buffer;
01511     SaveDirtyVectorSize = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.SizeOfBitMap;
01512     SaveBaseBlock = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>;
01513 
01514     AltDirtyVectorSize = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>) / 8;
01515     AltDirtyVector = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(AltDirtyVectorSize,<span class="keyword">sizeof</span>(ULONG)), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01516     <span class="keywordflow">if</span> (AltDirtyVector == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01517         status = STATUS_INSUFFICIENT_RESOURCES;
01518         <span class="keywordflow">goto</span> Exit1;
01519     }
01520     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.Buffer = AltDirtyVector;
01521     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.SizeOfBitMap = AltDirtyVectorSize * 8;
01522     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a28">RtlSetAllBits</a>(&amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
01523 
01524     <span class="comment">//</span>
01525     <span class="comment">// Splice in a duplicate BaseBlock</span>
01526     <span class="comment">//</span>
01527     AltBaseBlock = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01528     <span class="keywordflow">if</span> (AltBaseBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01529         status = STATUS_INSUFFICIENT_RESOURCES;
01530         <span class="keywordflow">goto</span> Exit2;
01531     }
01532     <span class="comment">//</span>
01533     <span class="comment">// Make sure the buffer we got back is cluster-aligned. If not, try</span>
01534     <span class="comment">// harder to get an aligned buffer.</span>
01535     <span class="comment">//</span>
01536     Alignment = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a> - 1;
01537     <span class="keywordflow">if</span> (((ULONG_PTR)AltBaseBlock &amp; Alignment) != 0) {
01538         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(AltBaseBlock, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>));
01539         AltBaseBlock = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
01540         <span class="keywordflow">if</span> (AltBaseBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01541             status = STATUS_INSUFFICIENT_RESOURCES;
01542             <span class="keywordflow">goto</span> Exit2;
01543         }
01544         <span class="comment">//</span>
01545         <span class="comment">// Return the quota for the extra allocation, as we are not really using</span>
01546         <span class="comment">// it and it will not be accounted for later when we free it.</span>
01547         <span class="comment">//</span>
01548         <a class="code" href="../../d1/d2/cmp_8h.html#a248">CmpReleaseGlobalQuota</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>));
01549     }
01550 
01551     RtlMoveMemory(AltBaseBlock, SaveBaseBlock, <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>);
01552     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = AltBaseBlock;
01553 
01554     <span class="comment">//</span>
01555     <span class="comment">// Ensure the file can be made big enough, then do the deed</span>
01556     <span class="comment">//</span>
01557     status = <a class="code" href="../../d7/d3/cmwrapr_8c.html#a13">CmpDoFileSetSize</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01558                               <a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a>,
01559                               <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length);
01560 
01561     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01562         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/hivesync_8c.html#a14">HvpDoWriteHive</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a>)) {
01563             status = STATUS_REGISTRY_IO_FAILED;
01564         }
01565     }
01566 
01567     <span class="comment">//</span>
01568     <span class="comment">// Clean up, success or failure</span>
01569     <span class="comment">//</span>
01570     <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(AltBaseBlock, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>));
01571 
01572 Exit2:
01573     <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(AltDirtyVector, <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(AltDirtyVectorSize,<span class="keyword">sizeof</span>(ULONG)));
01574 
01575 Exit1:
01576     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.Buffer = SaveDirtyVector;
01577     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.SizeOfBitMap = SaveDirtyVectorSize;
01578     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = SaveBaseBlock;
01579     <span class="keywordflow">return</span> status;
01580 }
01581 
01582 
01583 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01584"></a><a class="code" href="../../d6/d0/hive_8h.html#a37">01584</a> <a class="code" href="../../d0/d2/hivesync_8c.html#a6">HvRefreshHive</a>(
01585     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>  Hive
01586     )
01587 <span class="comment">/*++</span>
01588 <span class="comment"></span>
01589 <span class="comment">Routine Description:</span>
01590 <span class="comment"></span>
01591 <span class="comment">    Undo the last sync.  We do this by reading back all data which</span>
01592 <span class="comment">    has been marked dirty from the file into memory.  Update the</span>
01593 <span class="comment">    free list.  We will then clear the dirty vector.</span>
01594 <span class="comment"></span>
01595 <span class="comment">    Any growth since the last sync will be discarded, and in fact,</span>
01596 <span class="comment">    the size of the file will be set down.</span>
01597 <span class="comment"></span>
01598 <span class="comment">    WARNNOTE:   Failure will cause a bugcheck, as we cannot</span>
01599 <span class="comment">                keep the hive consistent if we fail part way through.</span>
01600 <span class="comment"></span>
01601 <span class="comment">    All I/O is done via HFILE_TYPE_PRIMARY.</span>
01602 <span class="comment"></span>
01603 <span class="comment">Arguments:</span>
01604 <span class="comment"></span>
01605 <span class="comment">    Hive - supplies a pointer to the hive control structure for the</span>
01606 <span class="comment">            hive of interest.</span>
01607 <span class="comment"></span>
01608 <span class="comment">Return Value:</span>
01609 <span class="comment"></span>
01610 <span class="comment">    NONE. Either works or BugChecks.</span>
01611 <span class="comment"></span>
01612 <span class="comment">--*/</span>
01613 {
01614     ULONG       <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01615     ULONG       ReadLength;
01616     ULONG       checkstatus;
01617     PUCHAR      Address;
01618     ULONG       Current;
01619     PRTL_BITMAP <a class="code" href="../../d2/d1/structBitMap.html">BitMap</a>;
01620     BOOLEAN     rc;
01621     ULONG       <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
01622     ULONG       <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
01623     ULONG       BitLength;
01624     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> TailStart;
01625     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> p;
01626     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>;
01627     ULONG       i;
01628     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>       <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
01629     PLIST_ENTRY <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>;
01630     <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>  FreeBin;
01631     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> Map;
01632     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> RootCell;
01633     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> RootNode;
01634     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> LinkCell;
01635 
01636     <span class="comment">//</span>
01637     <span class="comment">// this array stores the last elements in each free cell list for the stable storage</span>
01638     <span class="comment">//</span>
01639     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     TailDisplay[<a class="code" href="../../d0/d1/hivedata_8h.html#a45">HHIVE_FREE_DISPLAY_SIZE</a>];
01640 
01641     <span class="comment">//</span>
01642     <span class="comment">// noop or assert on various uninteresting or bogus conditions</span>
01643     <span class="comment">//</span>
01644     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == 0) {
01645         <span class="keywordflow">return</span>;
01646     }
01647     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a10">HIVE_NOLAZYFLUSH</a>);
01648     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>].Length == 0);
01649 
01650     <span class="comment">//</span>
01651     <span class="comment">// be sure the hive is not already trash</span>
01652     <span class="comment">//</span>
01653     checkstatus = <a class="code" href="../../d9/d0/hivechek_8c.html#a9">HvCheckHive</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01654     <span class="keywordflow">if</span> (checkstatus != 0) {
01655         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR,7,0,(ULONG_PTR)<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,checkstatus);
01656     }
01657 
01658     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o19">RefreshCount</a>++;
01659 
01660     <span class="comment">//</span>
01661     <span class="comment">// Capture the LinkCell backpointer in the hive's root cell. We need this in case</span>
01662     <span class="comment">// the first bin is overwritten with what was on disk.</span>
01663     <span class="comment">//</span>
01664     RootCell = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a>;
01665     RootNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, RootCell);
01666     LinkCell = RootNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a>;
01667 
01668     <span class="comment">//</span>
01669     <span class="comment">// Any bins that have been marked as discardable, but not yet flushed to</span>
01670     <span class="comment">// disk, are going to be overwritten with old data.  Bring them back into</span>
01671     <span class="comment">// memory and remove their FREE_HBIN marker from the list.</span>
01672     <span class="comment">//</span>
01673     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].FreeBins.Flink;
01674     <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> != &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].FreeBins) {
01675 
01676         FreeBin = CONTAINING_RECORD(<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>, <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">FREE_HBIN</a>, ListEntry);
01677         <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Flink;
01678 
01679         <span class="keywordflow">if</span> (FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a48">FREE_HBIN_DISCARDABLE</a>) {
01680             <span class="keywordflow">for</span> (i=0; i&lt;FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>; i+=<a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) {
01681                 Map = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a>+i);
01682                 <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Map,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a>+i);
01683                 Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a> = (Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>)+i;
01684                 Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp;= ~<a class="code" href="../../d0/d1/hivedata_8h.html#a36">HMAP_DISCARDABLE</a>;
01685             }
01686             RemoveEntryList(&amp;FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o0">ListEntry</a>);
01687             (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(FreeBin, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">FREE_HBIN</a>));
01688         }
01689     }
01690 
01691     <span class="comment">//</span>
01692     <span class="comment">// OverRead base block.</span>
01693     <span class="comment">//</span>
01694     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = 0;
01695     <span class="keywordflow">if</span> ( (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o6">FileRead</a>)(
01696             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01697             <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>,
01698             &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>,
01699             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>,
01700             <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>
01701             ) != <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)
01702     {
01703         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR,7,1,0,0);
01704     }
01705     TailStart = (<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a>);
01706 
01707     <span class="comment">//</span>
01708     <span class="comment">// Free "tail" memory and maps for it, update hive size pointers</span>
01709     <span class="comment">//</span>
01710     <a class="code" href="../../d2/d1/hivefree_8c.html#a1">HvFreeHivePartial</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, TailStart, <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>);
01711 
01712     <span class="comment">//</span>
01713     <span class="comment">// Clear dirty vector for data past Hive-&gt;BaseBlock-&gt;Length</span>
01714     <span class="comment">//</span>
01715     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a> / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
01716     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.SizeOfBitMap;
01717     BitLength = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> - <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
01718 
01719     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a>(&amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>), <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>, BitLength);
01720 
01721     <span class="comment">//</span>
01722     <span class="comment">// Scan dirty blocks.  Read contiguous blocks off disk into hive.</span>
01723     <span class="comment">// Stop when we get to reduced length.</span>
01724     <span class="comment">//</span>
01725     <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a> = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>);
01726     Current = 0;
01727     <span class="keywordflow">while</span> (<a class="code" href="../../d0/d2/hivesync_8c.html#a3">HvpFindNextDirtyBlock</a>(
01728                 <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01729                 &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>,
01730                 &amp;Current, &amp;Address,
01731                 &amp;ReadLength,
01732                 &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>
01733                 ))
01734     {
01735         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Offset &lt; (Hive-&gt;BaseBlock-&gt;Length + <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>)));
01736         rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o6">FileRead</a>)(
01737                 <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01738                 <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>,
01739                 &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>,
01740                 (PVOID)Address,
01741                 ReadLength
01742                 );
01743         <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01744             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR,7,2,(ULONG_PTR)&amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>,rc);
01745         }
01746     }
01747 
01748     <span class="comment">//</span>
01749     <span class="comment">// If we read the start of any HBINs into memory, it is likely</span>
01750     <span class="comment">// their MemAlloc fields are invalid.  Walk through the HBINs</span>
01751     <span class="comment">// and write valid MemAlloc values for any HBINs whose first</span>
01752     <span class="comment">// sector was reread.</span>
01753     <span class="comment">//</span>
01754     p=0;
01755     <span class="keywordflow">while</span> (p &lt; <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length) {
01756         <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, p);
01757         <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,p);
01758         <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BlockAddress &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
01759 
01760         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BinAddress &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a36">HMAP_DISCARDABLE</a>)==0) {
01761             <span class="keywordflow">if</span> (RtlCheckBit(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>, p / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>)==1) {
01762                 <span class="comment">//</span>
01763                 <span class="comment">// The first sector in the HBIN is dirty.</span>
01764                 <span class="comment">//</span>
01765                 <span class="comment">// Reset the BinAddress to the Block address to cover</span>
01766                 <span class="comment">// the case where a few smaller bins have been coalesced</span>
01767                 <span class="comment">// into a larger bin. We want the smaller bins back now.</span>
01768                 <span class="comment">//</span>
01769                 <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BinAddress = (<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BinAddress &amp; ~<a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>) | <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BlockAddress;
01770 
01771                 <span class="comment">// Check the map to see if this is the start</span>
01772                 <span class="comment">// of a memory allocation or not.</span>
01773                 <span class="comment">//</span>
01774 
01775                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BinAddress &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a35">HMAP_NEWALLOC</a>) {
01776                     <span class="comment">//</span>
01777                     <span class="comment">// Walk through the map to determine the length</span>
01778                     <span class="comment">// of the allocation.</span>
01779                     <span class="comment">//</span>
01780                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a> = 0;
01781                     <span class="keywordflow">do</span> {
01782                         <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, p+<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a>+<a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>);
01783                         <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a> += <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
01784                         <span class="keywordflow">if</span> (p+<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a> == <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length) {
01785                             <span class="comment">//</span>
01786                             <span class="comment">// Reached the end of the hive.</span>
01787                             <span class="comment">//</span>
01788                             <span class="keywordflow">break</span>;
01789                         }
01790                         <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,p+<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a>);
01791                     } <span class="keywordflow">while</span> ( (<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BinAddress &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a35">HMAP_NEWALLOC</a>) == 0);
01792 
01793                 } <span class="keywordflow">else</span> {
01794                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a> = 0;
01795                 }
01796             }
01797 
01798             p += <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>;
01799 
01800         } <span class="keywordflow">else</span> {
01801             FreeBin = (<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>)<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BlockAddress;
01802             p += FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>;
01803         }
01804     }
01805 
01806     <span class="comment">//</span>
01807     <span class="comment">// be sure we haven't filled memory with trash</span>
01808     <span class="comment">//</span>
01809     checkstatus = <a class="code" href="../../d9/d0/hivechek_8c.html#a9">HvCheckHive</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01810     <span class="keywordflow">if</span> (checkstatus != 0) {
01811         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR,7,3,(ULONG_PTR)<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,checkstatus);
01812     }
01813 
01814     <span class="comment">//</span>
01815     <span class="comment">// reinit the free list</span>
01816     <span class="comment">//</span>
01817     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d0/d1/hivedata_8h.html#a45">HHIVE_FREE_DISPLAY_SIZE</a>; i++) {
01818         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].FreeDisplay[i] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01819         TailDisplay[i] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01820     }
01821     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].FreeSummary = 0;
01822 
01823     <span class="comment">//</span>
01824     <span class="comment">// rebuild the free list</span>
01825     <span class="comment">//</span>
01826     p = 0;
01827     <span class="keywordflow">while</span> (p &lt; <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length) {
01828         <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, p);
01829         <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,p);
01830 
01831         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BinAddress &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a36">HMAP_DISCARDABLE</a>) == 0) {
01832             <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)((<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BinAddress) &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
01833 
01834             <span class="keywordflow">if</span> ( ! <a class="code" href="../../d7/d1/hivemap_8c.html#a10">HvpEnlistFreeCells</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>,TailDisplay)) {
01835                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR,7,5,(ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>,<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>);
01836             }
01837 
01838             p = (ULONG)p + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>;
01839         } <span class="keywordflow">else</span> {
01840             FreeBin = (<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>)<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BlockAddress;
01841             p = (ULONG)p + FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>;
01842         }
01843     }
01844 
01845     <span class="comment">//</span>
01846     <span class="comment">// Finally we need to rewrite the parent field in the root hcell. This is</span>
01847     <span class="comment">// patched in at hive load time so the correct value could have just been</span>
01848     <span class="comment">// overwritten with whatever happened to be on disk.</span>
01849     <span class="comment">//</span>
01850     RootNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, RootCell);
01851     RootNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a> = LinkCell;
01852     RootNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/cmdata_8h.html#a29">KEY_HIVE_ENTRY</a> | <a class="code" href="../../d9/d0/cmdata_8h.html#a30">KEY_NO_DELETE</a>;
01853 
01854 
01855     <span class="comment">//</span>
01856     <span class="comment">// be sure the structure of the thing is OK after all this</span>
01857     <span class="comment">//</span>
01858     checkstatus = <a class="code" href="../../d1/d2/cmp_8h.html#a294">CmCheckRegistry</a>((<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01859     <span class="keywordflow">if</span> (checkstatus != 0) {
01860         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR,7,6,(ULONG_PTR)<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,checkstatus);
01861     }
01862 
01863     <span class="comment">//</span>
01864     <span class="comment">// Clear dirty vector.</span>
01865     <span class="comment">//</span>
01866     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a27">RtlClearAllBits</a>(&amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
01867     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> = 0;
01868 
01869 
01870     <span class="comment">//</span>
01871     <span class="comment">// Adjust the file size, if this fails, ignore it, since it just</span>
01872     <span class="comment">// means the file is too big.</span>
01873     <span class="comment">//</span>
01874     (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o4">FileSetSize</a>)(
01875         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01876         <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>,
01877         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a> + <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>)
01878         );
01879 
01880     <span class="keywordflow">return</span>;
01881 }
01882 
01883 
01884 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01885"></a><a class="code" href="../../d0/d2/hivesync_8c.html#a16">01885</a> <a class="code" href="../../d0/d2/hivesync_8c.html#a16">HvpDiscardBins</a>(
01886     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive
01887     )
01888 
01889 <span class="comment">/*++</span>
01890 <span class="comment"></span>
01891 <span class="comment">Routine Description:</span>
01892 <span class="comment"></span>
01893 <span class="comment">    Walks through the dirty bins in a hive to see if any are marked</span>
01894 <span class="comment">    discardable.  If so, they are discarded and the map is updated to</span>
01895 <span class="comment">    reflect this.</span>
01896 <span class="comment"></span>
01897 <span class="comment">Arguments:</span>
01898 <span class="comment"></span>
01899 <span class="comment">    Hive - Supplies the hive control structure.</span>
01900 <span class="comment"></span>
01901 <span class="comment">Return Value:</span>
01902 <span class="comment"></span>
01903 <span class="comment">    None.</span>
01904 <span class="comment"></span>
01905 <span class="comment">--*/</span>
01906 
01907 {
01908     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a> <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
01909     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> Map;
01910     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> PreviousMap;
01911     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> NextMap;
01912     <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a> FreeBin;
01913     <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a> PreviousFreeBin;
01914     <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a> NextFreeBin;
01915     PLIST_ENTRY <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>;
01916 
01917     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].FreeBins.Flink;
01918 
01919     <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> != &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].FreeBins) {
01920         <a class="code" href="../../d6/d0/hive_8h.html#a3">ASSERT_LISTENTRY</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>);
01921         FreeBin = CONTAINING_RECORD(<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>, <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">FREE_HBIN</a>, ListEntry);
01922 
01923         <span class="keywordflow">if</span> (FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a48">FREE_HBIN_DISCARDABLE</a>) {
01924             Map = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a>);
01925             <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Map,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a>);
01926             <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
01927             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a36">HMAP_DISCARDABLE</a>);
01928             <span class="comment">//</span>
01929             <span class="comment">// Note we use ExFreePool directly here to avoid</span>
01930             <span class="comment">// giving back the quota for this bin. By charging</span>
01931             <span class="comment">// registry quota for discarded bins, we prevent</span>
01932             <span class="comment">// sparse hives from requiring more quota after</span>
01933             <span class="comment">// a reboot than on a running system.</span>
01934             <span class="comment">//</span>
01935             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>);
01936             FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o3">Flags</a> &amp;= ~<a class="code" href="../../d0/d1/hivedata_8h.html#a48">FREE_HBIN_DISCARDABLE</a>;
01937         }
01938         <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>=<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Flink;
01939     }
01940 
01941 }
01942 
01943 
01944 
01945 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01946"></a><a class="code" href="../../d0/d2/hivesync_8c.html#a17">01946</a> <a class="code" href="../../d0/d2/hivesync_8c.html#a17">HvpTruncateBins</a>(
01947     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive
01948     )
01949 
01950 <span class="comment">/*++</span>
01951 <span class="comment"></span>
01952 <span class="comment">Routine Description:</span>
01953 <span class="comment"></span>
01954 <span class="comment">    Attempts to shrink the hive by truncating any bins that are discardable at</span>
01955 <span class="comment">    the end of the hive.  Applies to both stable and volatile storage.</span>
01956 <span class="comment"></span>
01957 <span class="comment">Arguments:</span>
01958 <span class="comment"></span>
01959 <span class="comment">    Hive - Supplies the hive to be truncated.</span>
01960 <span class="comment"></span>
01961 <span class="comment">Return Value:</span>
01962 <span class="comment"></span>
01963 <span class="comment">    None.</span>
01964 <span class="comment"></span>
01965 <span class="comment">--*/</span>
01966 
01967 {
01968     <a class="code" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a> i;
01969     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> Map;
01970     ULONG NewLength;
01971     <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a> FreeBin;
01972 
01973     <span class="comment">//</span>
01974     <span class="comment">// stable and volatile</span>
01975     <span class="comment">//</span>
01976     <span class="keywordflow">for</span> (i=0;i&lt;<a class="code" href="../../d0/d1/hivedata_8h.html#a5">HTYPE_COUNT</a>;i++) {
01977 
01978         <span class="comment">//</span>
01979         <span class="comment">// find the last in-use bin in the hive</span>
01980         <span class="comment">//</span>
01981         NewLength = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[i].Length;
01982 
01983         <span class="keywordflow">while</span> (NewLength &gt; 0) {
01984             Map = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, (NewLength - <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) + (i*<a class="code" href="../../d0/d1/hivedata_8h.html#a7">HCELL_TYPE_MASK</a>));
01985             <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Map,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,(NewLength - <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) + (i*<a class="code" href="../../d0/d1/hivedata_8h.html#a7">HCELL_TYPE_MASK</a>));
01986             <span class="keywordflow">if</span> (Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a36">HMAP_DISCARDABLE</a>) {
01987                 FreeBin = (<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>)Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a>;
01988                 NewLength = FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a>;
01989             } <span class="keywordflow">else</span> {
01990                 <span class="keywordflow">break</span>;
01991             }
01992         }
01993 
01994         <span class="keywordflow">if</span> (NewLength &lt; <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[i].Length) {
01995             <span class="comment">//</span>
01996             <span class="comment">// There are some free bins to truncate.</span>
01997             <span class="comment">//</span>
01998             <a class="code" href="../../d2/d1/hivefree_8c.html#a1">HvFreeHivePartial</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, NewLength, i);
01999         }
02000     }
02001 }
02002 
02003 <span class="preprocessor">#ifdef _WRITE_PROTECTED_REGISTRY_POOL</span>
02004 <span class="preprocessor"></span>
02005 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02006 <a class="code" href="../../d1/d2/cmp_8h.html#a11">HvpChangeBinAllocation</a>(
02007     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>       Bin,
02008     BOOLEAN     ReadOnly
02009     )
02010 {
02011     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o0">Signature</a> == HBIN_SIGNATURE);
02012     <span class="comment">//</span>
02013     <span class="comment">// Here to call the code to mark the memory pointed by Bin as Read/Write or ReadOnly, depending on the ReadOnly argument</span>
02014     <span class="comment">//</span>
02015 }
02016 
02017 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02018 <a class="code" href="../../d1/d2/cmp_8h.html#a12">HvpMarkBinReadWrite</a>(
02019     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>      Hive,
02020     HCELL_INDEX Cell
02021     )
02022 <span class="comment">/*++</span>
02023 <span class="comment"></span>
02024 <span class="comment">Routine Description:</span>
02025 <span class="comment"></span>
02026 <span class="comment">    Marks the memory allocated for the bin containing the specified cell as read/write.</span>
02027 <span class="comment"></span>
02028 <span class="comment">Arguments:</span>
02029 <span class="comment"></span>
02030 <span class="comment">    Hive - supplies a pointer to the hive control structure for the</span>
02031 <span class="comment">            hive of interest</span>
02032 <span class="comment"></span>
02033 <span class="comment">    Cell - hcell_index of cell </span>
02034 <span class="comment"></span>
02035 <span class="comment">Return Value:</span>
02036 <span class="comment"></span>
02037 <span class="comment">    NONE (It should work!)</span>
02038 <span class="comment"></span>
02039 <span class="comment">--*/</span>
02040 {
02041     ULONG       Type;
02042     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> Me;
02043     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>       <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
02044 
02045     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == HHIVE_SIGNATURE);
02046     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
02047 
02048     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Cell);
02049 
02050     <span class="keywordflow">if</span> ( (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>) ||
02051          (Type == <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>) )
02052     {
02053         <span class="comment">// nothing to do on a volatile hive</span>
02054         <span class="keywordflow">return</span>;
02055     }
02056 
02057     Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, Cell);
02058     <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,Hive,Cell);
02059     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
02060     
02061     <a class="code" href="../../d1/d2/cmp_8h.html#a11">HvpChangeBinAllocation</a>(Bin,FALSE);
02062 
02063 }
02064 
02065 <span class="preprocessor">#endif</span>
02066 <span class="preprocessor"></span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:18 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
