<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cmnotify.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cmnotify.c</h1><a href="../../d0/d2/cmnotify_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    cmnotify.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains support for NtNotifyChangeKey.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Bryan M. Willman (bryanwi) 03-Feb-1992</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Dragos C. Sambotin (dragoss) 16-Mar-1999</span>
00020 <span class="comment">        - fixing race conditions that when more than one thread simultaneously operates over the post list</span>
00021 <span class="comment">--*/</span>
00022 
00023 
00025 <span class="comment">//                                                                                                                      //</span>
00026 <span class="comment">//   "The" POST BLOCK RULE :                                                                                            //</span>
00027 <span class="comment">//                                                                                                                      //</span>
00028 <span class="comment">//      To operate on a post block (i.e. add or remove it from a list - notify,thread,slave),                           //</span>
00029 <span class="comment">//      you should at least:                                                                                            //</span>
00030 <span class="comment">//          1. Hold the registry lock exclusively                                                                       //</span>
00031 <span class="comment">//                     OR                                                                                               //</span>
00032 <span class="comment">//          2. Hold the registry lock shared and aquire the postblock mutex.                                            //</span>
00033 <span class="comment">//                                                                                                                      //</span>
00034 <span class="comment">//                                                                                                                      //</span>
00035 <span class="comment">//      WARNING!!!                                                                                                      //</span>
00036 <span class="comment">//          Failing to do that could arise in obscure registry deadlocks or usage of already freed memory (bugcheck)    //</span>
00037 <span class="comment">//                                                                                                                      //</span>
00039 <span class="comment"></span>
00041 <span class="comment">//                                                                                                                      //</span>
00042 <span class="comment">//  Other important rules to follow:                                                                                    //</span>
00043 <span class="comment">//                                                                                                                      //</span>
00044 <span class="comment">//      1. We DO NOT dereference objects in CmpPostApc !                                                                //</span>
00045 <span class="comment">//      2. We DO NOT dereference objects while walking the notify list!                                                 //</span>
00046 <span class="comment">//      3. All operations with Thread PostList are done in CmpPostApc or at APC level. This should avoid two threads    //</span>
00047 <span class="comment">//          operating on the same list at the same time                                                                 //</span>
00048 <span class="comment">//                                                                                                                      //</span>
00050 <span class="comment"></span>
00051 <span class="preprocessor">#include    "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00052 
00053 <span class="preprocessor">#if DBG</span>
00054 <span class="preprocessor"></span><span class="comment">/*++</span>
00055 <span class="comment">Routine Description:</span>
00056 <span class="comment">    Check if the post block or it's slave (if any) has no reference </span>
00057 <span class="comment">    to any key body object</span>
00058 <span class="comment">++*/</span>
00059 
00060 <span class="preprocessor">#define CmpCheckPostBlock(PostBlock )                                               \</span>
00061 <span class="preprocessor">    {                                                                               \</span>
00062 <span class="preprocessor">        PCM_POST_BLOCK  SlavePostBlock;                                             \</span>
00063 <span class="preprocessor">                                                                                    \</span>
00064 <span class="preprocessor">        </span><span class="comment">/* this post block should have the link with key body already broken*/</span>      \
00065         ASSERT( PostBlock-&gt;PostKeyBody == NULL );                                   \
00066                                                                                     \
00067         <span class="comment">/* only masters get to CmpPostApc */</span>                                        \
00068         ASSERT( IsMasterPostBlock(PostBlock) );                             \
00069                                                                                     \
00070         if (IsListEmpty(&amp;(PostBlock-&gt;CancelPostList)) == FALSE) {                   \
00071                                                                                     \
00072             <span class="comment">/* get the slave and verify him too */</span>                                  \
00073             SlavePostBlock = (PCM_POST_BLOCK)PostBlock-&gt;CancelPostList.Flink;       \
00074             SlavePostBlock = CONTAINING_RECORD(SlavePostBlock,                      \
00075                                                CM_POST_BLOCK,                       \
00076                                                CancelPostList);                     \
00077             <span class="comment">/* This should be true !*/</span>                                              \
00078             ASSERT( !IsMasterPostBlock(SlavePostBlock) );                           \
00079                                                                                     \
00080             <span class="comment">/* this post block shoul have the link with key body already broken */</span>  \
00081             ASSERT( SlavePostBlock-&gt;PostKeyBody == NULL );                          \
00082         }                                                                           \
00083     }
00084 <span class="preprocessor">#else</span>
<a name="l00085"></a><a class="code" href="../../d0/d2/cmnotify_8c.html#a0">00085</a> <span class="preprocessor"></span><span class="preprocessor">#define CmpCheckPostBlock(a) //nothing</span>
00086 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00087 <span class="preprocessor"></span>
00088 
00089 <span class="comment">//</span>
00090 <span class="comment">// "Back Side" of notify</span>
00091 <span class="comment">//</span>
00092 
<a name="l00093"></a><a class="code" href="../../d0/d2/cmnotify_8c.html#a1">00093</a> <span class="keyword">extern</span>  <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>  <a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>;
00094 
00095 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00096 <a class="code" href="../../d0/d2/cmnotify_8c.html#a2">CmpReportNotifyHelper</a>(
00097     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock,
00098     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> SearchHive,
00099     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00100     IN <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node,
00101     IN ULONG Filter
00102     );
00103 
00104 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00105 <a class="code" href="../../d0/d2/cmnotify_8c.html#a3">CmpCancelSlavePost</a>(
00106     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>  PostBlock,
00107     PLIST_ENTRY     DelayedDeref
00108     );
00109 
00110 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00111 <a class="code" href="../../d0/d2/cmnotify_8c.html#a4">CmpFreeSlavePost</a>(
00112     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>  MasterPostBlock
00113     );
00114 
00115 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00116 <a class="code" href="../../d0/d2/cmnotify_8c.html#a5">CmpAddToDelayedDeref</a>(
00117     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>  PostBlock,
00118     PLIST_ENTRY     DelayedDeref
00119     );
00120 
00121 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00122 <a class="code" href="../../d0/d2/cmnotify_8c.html#a6">CmpDelayedDerefKeys</a>(
00123                     PLIST_ENTRY DelayedDeref
00124                     );
00125 
00126 BOOLEAN
00127 <a class="code" href="../../d0/d2/cmnotify_8c.html#a7">CmpNotifyTriggerCheck</a>(
00128     IN <a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a> NotifyBlock,
00129     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00130     IN <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node
00131     );
00132 
00133 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00134 <a class="code" href="../../d7/d7/ntapi_8c.html#a13">CmpDummyApc</a>(
00135     <span class="keyword">struct</span> <a class="code" href="../../d1/d5/struct__KAPC.html">_KAPC</a> *Apc,
00136     PVOID *SystemArgument1,
00137     PVOID *SystemArgument2
00138     );
00139 
00140 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00141 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpReportNotify)</span>
00142 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpReportNotifyHelper)</span>
00143 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpPostNotify)</span>
00144 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpPostApc)</span>
00145 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpPostApcRunDown)</span>
00146 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmNotifyRunDown)</span>
00147 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpFlushNotify)</span>
00148 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpNotifyChangeKey)</span>
00149 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpCancelSlavePost)</span>
00150 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpFreeSlavePost)</span>
00151 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpAddToDelayedDeref)</span>
00152 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpDelayedDerefKeys)</span>
00153 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpNotifyTriggerCheck)</span>
00154 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpDummyApc)</span>
00155 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00156 <span class="preprocessor"></span>
00157 
00158 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00159"></a><a class="code" href="../../d0/d2/cmnotify_8c.html#a8">00159</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a13">CmpDummyApc</a>(
00160     <span class="keyword">struct</span> <a class="code" href="../../d1/d5/struct__KAPC.html">_KAPC</a> *Apc,
00161     PVOID *SystemArgument1,
00162     PVOID *SystemArgument2
00163     )
00164 <span class="comment">/*++</span>
00165 <span class="comment"></span>
00166 <span class="comment">Routine Description:</span>
00167 <span class="comment"></span>
00168 <span class="comment">    Dummy routine to prevent user-mode callers to set special kernel apcs</span>
00169 <span class="comment"></span>
00170 <span class="comment">Arguments:</span>
00171 <span class="comment"></span>
00172 <span class="comment">    Apc - pointer to apc object</span>
00173 <span class="comment"></span>
00174 <span class="comment">    SystemArgument1 -  IN: Status value for IoStatusBlock</span>
00175 <span class="comment">                      OUT: Ptr to IoStatusBlock (2nd arg to user apc routine)</span>
00176 <span class="comment"></span>
00177 <span class="comment">    SystemArgument2 - Pointer to the PostBlock</span>
00178 <span class="comment"></span>
00179 <span class="comment">Return Value:</span>
00180 <span class="comment"></span>
00181 <span class="comment">    NONE.</span>
00182 <span class="comment"></span>
00183 <span class="comment">--*/</span>
00184 {
00185     UNREFERENCED_PARAMETER(Apc);
00186     UNREFERENCED_PARAMETER(SystemArgument1);
00187     UNREFERENCED_PARAMETER(SystemArgument2);
00188 }
00189 
00190 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00191"></a><a class="code" href="../../d1/d2/cmp_8h.html#a283">00191</a> <a class="code" href="../../d6/d3/cmwraper_8c.html#a13">CmpReportNotify</a>(
00192     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   KeyControlBlock,
00193     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>                  Hive,
00194     HCELL_INDEX             Cell,
00195     ULONG                   Filter
00196     )
00197 <span class="comment">/*++</span>
00198 <span class="comment"></span>
00199 <span class="comment">Routine Description:</span>
00200 <span class="comment"></span>
00201 <span class="comment">    This routine is called when a notifiable event occurs. It will</span>
00202 <span class="comment">    apply CmpReportNotifyHelper to the hive the event occured in,</span>
00203 <span class="comment">    and the master hive if different.</span>
00204 <span class="comment"></span>
00205 <span class="comment">Arguments:</span>
00206 <span class="comment"></span>
00207 <span class="comment">    KeyControlBlock - KCB of the key at which the event occured.</span>
00208 <span class="comment">            For create or delete this is the created or deleted key.</span>
00209 <span class="comment"></span>
00210 <span class="comment">    Hive - pointer to hive containing cell of Key at which event occured.</span>
00211 <span class="comment"></span>
00212 <span class="comment">    Cell - cell of Key at which event occured</span>
00213 <span class="comment"></span>
00214 <span class="comment">            (hive and cell correspond with name.)</span>
00215 <span class="comment"></span>
00216 <span class="comment">    Filter - event to be reported</span>
00217 <span class="comment"></span>
00218 <span class="comment">Return Value:</span>
00219 <span class="comment"></span>
00220 <span class="comment">    NONE.</span>
00221 <span class="comment"></span>
00222 <span class="comment">--*/</span>
00223 {
00224     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> pcell;
00225     ULONG       flags;
00226     ULONG       i;
00227 
00228     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00229     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a21">CML_WORKER</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a37">CMS_NOTIFY</a>) {
00230         KdPrint((<span class="stringliteral">"CmpReportNotify:\n"</span>));
00231         KdPrint((<span class="stringliteral">"\tHive:%08lx Cell:%08lx Filter:%08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>, <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>));
00232     }
00233 
00234     pcell = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00235     <span class="comment">//</span>
00236     <span class="comment">// If the operation was create or delete, treat it as a change</span>
00237     <span class="comment">// to the parent.</span>
00238     <span class="comment">//</span>
00239     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a> == REG_NOTIFY_CHANGE_NAME) {
00240         flags = pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a>;
00241         <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a>;
00242         <span class="keywordflow">if</span> (flags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a29">KEY_HIVE_ENTRY</a>) {
00243             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>);
00244             pcell = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00245         }
00246 
00247 
00248         KeyControlBlock = KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o9">ParentKcb</a>;
00249 
00250         <span class="comment">//</span>
00251         <span class="comment">// if we're at an exit/link node, back up the real node</span>
00252         <span class="comment">// that MUST be it's parent.</span>
00253         <span class="comment">//</span>
00254         <span class="keywordflow">if</span> (pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a28">KEY_HIVE_EXIT</a>) {
00255             <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a>;
00256         }
00257         pcell = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00258     }
00259 
00260     <span class="comment">//</span>
00261     <span class="comment">// Report to notifies waiting on the event's hive</span>
00262     <span class="comment">//</span>
00263     <a class="code" href="../../d0/d2/cmnotify_8c.html#a2">CmpReportNotifyHelper</a>(KeyControlBlock, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, pcell, <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>);
00264 
00265 
00266     <span class="comment">//</span>
00267     <span class="comment">// If containing hive is not the master hive, apply to master hive</span>
00268     <span class="comment">//</span>
00269     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> != &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>)) {
00270         <a class="code" href="../../d0/d2/cmnotify_8c.html#a2">CmpReportNotifyHelper</a>(KeyControlBlock,
00271                               &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>),
00272                               <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00273                               pcell,
00274                               <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>);
00275     }
00276 
00277     <span class="keywordflow">return</span>;
00278 }
00279 
00280 BOOLEAN
<a name="l00281"></a><a class="code" href="../../d0/d2/cmnotify_8c.html#a7">00281</a> <a class="code" href="../../d0/d2/cmnotify_8c.html#a7">CmpNotifyTriggerCheck</a>(
00282     IN <a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a> NotifyBlock,
00283     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00284     IN <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node
00285     )
00286 <span class="comment">/*++</span>
00287 <span class="comment"></span>
00288 <span class="comment">Routine Description:</span>
00289 <span class="comment"></span>
00290 <span class="comment">    Checks if a notify can be triggered</span>
00291 <span class="comment"></span>
00292 <span class="comment">Arguments:</span>
00293 <span class="comment"></span>
00294 <span class="comment">    NotifyBlock - the notify block</span>
00295 <span class="comment"></span>
00296 <span class="comment">    Hive - Supplies hive containing node to match with.</span>
00297 <span class="comment"></span>
00298 <span class="comment">    Node - pointer to key to match with (and check access to)</span>
00299 <span class="comment"></span>
00300 <span class="comment"></span>
00301 <span class="comment">Return Value:</span>
00302 <span class="comment"></span>
00303 <span class="comment">    TRUE - yes.</span>
00304 <span class="comment">    FALSE - no</span>
00305 <span class="comment"></span>
00306 <span class="comment">--*/</span>
00307 {
00308     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a> PostBlock;
00309     <a class="code" href="../../d1/d2/cmp_8h.html#a166">POST_BLOCK_TYPE</a> NotifyType;
00310 
00311     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00312 
00313     <span class="keywordflow">if</span>(IsListEmpty(&amp;(NotifyBlock-&gt;PostList)) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00314 
00315         <span class="comment">//</span>
00316         <span class="comment">// check if it is a kernel notify. Look at the first post block</span>
00317         <span class="comment">// to see that. If is a kernel post-block, then all posts in </span>
00318         <span class="comment">// the list should be kernel notifies</span>
00319         <span class="comment">//</span>
00320         PostBlock = (<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>)NotifyBlock-&gt;PostList.Flink;
00321         PostBlock = CONTAINING_RECORD(PostBlock,
00322                                       <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">CM_POST_BLOCK</a>,
00323                                       NotifyList);
00324 
00325         NotifyType = <a class="code" href="../../d1/d2/cmp_8h.html#a88">PostBlockType</a>(PostBlock);
00326 
00327         <span class="keywordflow">if</span>( NotifyType == <a class="code" href="../../d1/d2/cmp_8h.html#a335a206">PostAsyncKernel</a> ) {
00328             <span class="comment">// this is a kernel notify; always trigger it</span>
00329 <span class="preprocessor">#if DBG</span>
00330 <span class="preprocessor"></span>            <span class="comment">//</span>
00331             <span class="comment">// DEBUG only code: All post blocks should be of the same type</span>
00332             <span class="comment">// (kernel/user)</span>
00333             <span class="comment">//</span>
00334             <span class="keywordflow">while</span>( PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>.Flink != &amp;(NotifyBlock-&gt;PostList) ) {
00335                 PostBlock = (<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>)PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>.Flink;
00336                 PostBlock = CONTAINING_RECORD(PostBlock,
00337                                             <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">CM_POST_BLOCK</a>,
00338                                             NotifyList);
00339                 
00340                 <span class="comment">//KdPrint(("CmpNotifyTriggerCheck : NotifyBlock = %lx\n",NotifyBlock));</span>
00341                 
00342                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d1/d2/cmp_8h.html#a88">PostBlockType</a>(PostBlock) == NotifyType );
00343             }
00344 <span class="preprocessor">#endif</span>
00345 <span class="preprocessor"></span>        
00346             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00347         }
00348     }
00349 
00350     <span class="comment">//</span>
00351     <span class="comment">// else, check if the caller has the right access</span>
00352     <span class="comment">//</span>
00353     <span class="keywordflow">return</span> <a class="code" href="../../d7/d2/cmse_8c.html#a12">CmpCheckNotifyAccess</a>(NotifyBlock,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,Node);
00354 }
00355 
00356 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00357"></a><a class="code" href="../../d0/d2/cmnotify_8c.html#a2">00357</a> <a class="code" href="../../d0/d2/cmnotify_8c.html#a2">CmpReportNotifyHelper</a>(
00358     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock,
00359     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> SearchHive,
00360     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00361     IN <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node,
00362     IN ULONG Filter
00363     )
00364 <span class="comment">/*++</span>
00365 <span class="comment"></span>
00366 <span class="comment">Routine Description:</span>
00367 <span class="comment"></span>
00368 <span class="comment">    Scan the list of active notifies for the specified hive.  For</span>
00369 <span class="comment">    any with scope including KeyControlBlock and filter matching</span>
00370 <span class="comment">    Filter, and with proper security access, post the notify.</span>
00371 <span class="comment"></span>
00372 <span class="comment">Arguments:</span>
00373 <span class="comment"></span>
00374 <span class="comment">    Name - canonical path name (as in a key control block) of the key</span>
00375 <span class="comment">            at which the event occured.  (This is the name for</span>
00376 <span class="comment">            reporting purposes.)</span>
00377 <span class="comment"></span>
00378 <span class="comment">    SearchHive - hive to search for matches (which notify list to check)</span>
00379 <span class="comment"></span>
00380 <span class="comment">    Hive - Supplies hive containing node to match with.</span>
00381 <span class="comment"></span>
00382 <span class="comment">    Node - pointer to key to match with (and check access to)</span>
00383 <span class="comment"></span>
00384 <span class="comment">    Filter - type of event</span>
00385 <span class="comment"></span>
00386 <span class="comment">Return Value:</span>
00387 <span class="comment"></span>
00388 <span class="comment">    NONE.</span>
00389 <span class="comment"></span>
00390 <span class="comment">--*/</span>
00391 {
00392     PLIST_ENTRY         NotifyPtr;
00393     <a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a>    NotifyBlock;
00394     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>             CmSearchHive;
00395     PUNICODE_STRING     NotifyName;
00396     KIRQL               OldIrql;
00397     LIST_ENTRY          DelayedDeref;
00398 
00399     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00400 
00401     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, &amp;OldIrql);
00402 
00403     CmSearchHive = CONTAINING_RECORD(SearchHive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
00404 
00405     NotifyPtr = &amp;(CmSearchHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o2">NotifyList</a>);
00406 
00407     InitializeListHead(&amp;(DelayedDeref));
00408 
00409     <span class="keywordflow">while</span> (NotifyPtr-&gt;Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00410 
00411         NotifyPtr = NotifyPtr-&gt;Flink;
00412 
00413         NotifyBlock = CONTAINING_RECORD(NotifyPtr, <a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">CM_NOTIFY_BLOCK</a>, <a class="code" href="../../d4/d6/regext_8c.html#a0">HiveList</a>);
00414         <span class="keywordflow">if</span> (NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o16">TotalLevels</a> &gt; KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o16">TotalLevels</a>) {
00415             <span class="comment">//</span>
00416             <span class="comment">// list is level sorted, we're past all shorter entries</span>
00417             <span class="comment">//</span>
00418             <span class="keywordflow">break</span>;
00419         } <span class="keywordflow">else</span> {
00420             <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00421             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> LevelDiff, l;
00422 
00423             LevelDiff = KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o16">TotalLevels</a> - NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o16">TotalLevels</a>;
00424 
00425             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = KeyControlBlock;
00426             <span class="keywordflow">for</span> (l=0; l&lt;LevelDiff; l++) {
00427                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ParentKcb;
00428             }
00429 
00430             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> == NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o1">KeyControlBlock</a>) {
00431                 <span class="comment">//</span>
00432                 <span class="comment">// This Notify path is the prefix of this kcb.</span>
00433                 <span class="comment">//</span>
00434                 <span class="keywordflow">if</span> ((NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o3">Filter</a> &amp; <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>)
00435                             &amp;&amp;
00436                     ((NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o6">WatchTree</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) ||
00437                      (Node == NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o17">KeyNode</a>))
00438                    )
00439                 {
00440                     <span class="comment">// Filter matches, this event is relevent to this notify</span>
00441                     <span class="comment">//                  AND</span>
00442                     <span class="comment">// Either the notify spans the whole subtree, or the cell</span>
00443                     <span class="comment">// (key) of interest is the one it applies to</span>
00444                     <span class="comment">//</span>
00445                     <span class="comment">// THEREFORE:   The notify is relevent.</span>
00446                     <span class="comment">//</span>
00447 
00448                     <span class="comment">//</span>
00449                     <span class="comment">// Correct scope, does caller have access?</span>
00450                     <span class="comment">//</span>
00451                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/cmnotify_8c.html#a7">CmpNotifyTriggerCheck</a>(NotifyBlock,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,Node)) {
00452                         <span class="comment">//</span>
00453                         <span class="comment">// Notify block has KEY_NOTIFY access to the node</span>
00454                         <span class="comment">// the event occured at.  It is relevent.  Therefore,</span>
00455                         <span class="comment">// it gets to see this event.  Post and be done.</span>
00456                         <span class="comment">//</span>
00457                         <span class="comment">// we specify that we want no key body dereferenciation </span>
00458                         <span class="comment">// during the CmpPostNotify call. This is to prevent the </span>
00459                         <span class="comment">// deletion of the current notify block</span>
00460                         <span class="comment">//</span>
00461                         <a class="code" href="../../d1/d2/cmp_8h.html#a284">CmpPostNotify</a>(
00462                             NotifyBlock,
00463                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00464                             <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>,
00465                             STATUS_NOTIFY_ENUM_DIR,
00466                             &amp;DelayedDeref
00467                             );
00468 
00469                     }  <span class="comment">// else no KEY_NOTIFY access to node event occured at</span>
00470                 } <span class="comment">// else not relevent (wrong scope, filter, etc)</span>
00471             }
00472         }
00473     }
00474     
00475     <span class="comment">//</span>
00476     <span class="comment">// finish the job started in CmpPostNotify (i.e. dereference the keybodies</span>
00477     <span class="comment">// we prevented. this may cause some notifyblocks to be freed</span>
00478     <span class="comment">//</span>
00479     <a class="code" href="../../d0/d2/cmnotify_8c.html#a6">CmpDelayedDerefKeys</a>(&amp;DelayedDeref);
00480     
00481     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00482     <span class="keywordflow">return</span>;
00483 }
00484 
00485 
00486 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00487"></a><a class="code" href="../../d1/d2/cmp_8h.html#a284">00487</a> <a class="code" href="../../d1/d2/cmp_8h.html#a284">CmpPostNotify</a>(
00488     <a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a>    NotifyBlock,
00489     PUNICODE_STRING     Name OPTIONAL,
00490     ULONG               Filter,
00491     NTSTATUS            Status,
00492     PLIST_ENTRY         ExternalKeyDeref OPTIONAL
00493     )
00494 <span class="comment">/*++</span>
00495 <span class="comment"></span>
00496 <span class="comment">Routine Description:</span>
00497 <span class="comment"></span>
00498 <span class="comment">    Actually report the notify event by signalling events, enqueing</span>
00499 <span class="comment">    APCs, and so forth.</span>
00500 <span class="comment"></span>
00501 <span class="comment">    When Status is STATUS_NOTIFY_CLEANUP:</span>
00502 <span class="comment"></span>
00503 <span class="comment">      - if the post block is a slave one, just cancel it.</span>
00504 <span class="comment">      - if the post block is a master one, cancel all slave post blocks</span>
00505 <span class="comment">        and trigger event on the master block.</span>
00506 <span class="comment"></span>
00507 <span class="comment">Comments:</span>
00508 <span class="comment">    </span>
00509 <span class="comment">    This routine is using a "delayed dereferencing" technique to prevent</span>
00510 <span class="comment">    deadlocks that may appear when a keybody is dereferenced while holding</span>
00511 <span class="comment">    the post block lock. As for this, a list with keybodies that have to be </span>
00512 <span class="comment">    dereferenced is constructed while walking the list of postblocks attached</span>
00513 <span class="comment">    to the current notify block and the related (slave or master) post blocks.</span>
00514 <span class="comment">    The list is built by tricking postblocks. For all postblock about to be </span>
00515 <span class="comment">    freed the PostKeyBody member is added to the local list and then set to NULL</span>
00516 <span class="comment">    on the postblock. This will avoid the key body dereferencing in CmpFreePostBlock.</span>
00517 <span class="comment">    Instead, after the postblock lock is released, the local list is iterated and </span>
00518 <span class="comment">    the keybodies are dereferenced and the storage for associated CM_POST_KEY_BODY </span>
00519 <span class="comment">    objects is freed.</span>
00520 <span class="comment"></span>
00521 <span class="comment">  </span>
00522 <span class="comment">Arguments:</span>
00523 <span class="comment"></span>
00524 <span class="comment">    NotifyBlock - pointer to structure that describes the notify</span>
00525 <span class="comment">                  operation.  (Where to post to)</span>
00526 <span class="comment"></span>
00527 <span class="comment">    Name - name of key at which event occurred.</span>
00528 <span class="comment"></span>
00529 <span class="comment">    Filter - nature of event</span>
00530 <span class="comment"></span>
00531 <span class="comment">    Status - completion status to report</span>
00532 <span class="comment"></span>
00533 <span class="comment">    ExternalKeyDeref - this parameter (when not NULL) specifies that the caller doesn't </span>
00534 <span class="comment">                    want any keybody to be dereferenced while in this routine</span>
00535 <span class="comment"></span>
00536 <span class="comment">Return Value:</span>
00537 <span class="comment"></span>
00538 <span class="comment">    NONE.</span>
00539 <span class="comment"></span>
00540 <span class="comment">--*/</span>
00541 {
00542     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>      PostBlock;
00543     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>      SlavePostBlock;
00544     LIST_ENTRY          LocalDelayedDeref;
00545     KIRQL               OldIrql;
00546     PLIST_ENTRY         DelayedDeref;
00547 
00548     <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>;
00549     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
00550 
00551     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00552     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a37">CMS_NOTIFY</a>) {
00553         KdPrint((<span class="stringliteral">"CmpPostNotify:\n"</span>));
00554         KdPrint((<span class="stringliteral">"\tNotifyBlock:%08lx  "</span>, NotifyBlock));
00555         KdPrint((<span class="stringliteral">"\tName = %wZ\n"</span>, <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>));
00556         KdPrint((<span class="stringliteral">"\tFilter:%08lx  Status=%08lx\n"</span>, <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00557     }
00558     <a class="code" href="../../d1/d2/cmp_8h.html#a61">ASSERT_CM_LOCK_OWNED</a>();
00559 
00560     <span class="keywordflow">if</span>( ARGUMENT_PRESENT(ExternalKeyDeref) ) {
00561         <span class="comment">//</span>
00562         <span class="comment">// The caller want to do all keybody dereferencing by himself</span>
00563         <span class="comment">//</span>
00564         DelayedDeref = ExternalKeyDeref;
00565     } <span class="keywordflow">else</span> {
00566         <span class="comment">// local delayed dereferencing (the caller doesn't care!)</span>
00567         DelayedDeref = &amp;LocalDelayedDeref;
00568         InitializeListHead(DelayedDeref);
00569     }
00570 
00571     <span class="comment">//</span>
00572     <span class="comment">// Aquire exclusive access over the postlist(s)</span>
00573     <span class="comment">//</span>
00574     <a class="code" href="../../d1/d2/cmp_8h.html#a92">LOCK_POST_LIST</a>();
00575 
00576     <span class="keywordflow">if</span> (IsListEmpty(&amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o4">PostList</a>)) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00577         <span class="comment">//</span>
00578         <span class="comment">// Nothing to post, set a mark and return</span>
00579         <span class="comment">//</span>
00580         NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o7">NotifyPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00581         <a class="code" href="../../d1/d2/cmp_8h.html#a93">UNLOCK_POST_LIST</a>();
00582         <span class="keywordflow">return</span>;
00583     }
00584     NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o7">NotifyPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00585 
00586     <span class="comment">//</span>
00587     <span class="comment">// IMPLEMENTATION NOTE:</span>
00588     <span class="comment">//      If we ever want to actually implement the code that returns</span>
00589     <span class="comment">//      names of things that changed, this is the place to add the</span>
00590     <span class="comment">//      name and operation type to the buffer.</span>
00591     <span class="comment">//</span>
00592 
00593     <span class="comment">//</span>
00594     <span class="comment">// Pull and post all the entries in the post list</span>
00595     <span class="comment">//</span>
00596     <span class="keywordflow">while</span> (IsListEmpty(&amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o4">PostList</a>)) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00597 
00598         <span class="comment">//</span>
00599         <span class="comment">// Remove from the notify block list, and enqueue the apc.</span>
00600         <span class="comment">// The apc will remove itself from the thread list</span>
00601         <span class="comment">//</span>
00602         PostBlock = (<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>)RemoveHeadList(&amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o4">PostList</a>));
00603         PostBlock = CONTAINING_RECORD(PostBlock,
00604                                       <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">CM_POST_BLOCK</a>,
00605                                       NotifyList);
00606 
00607         <span class="comment">// Protect for multiple deletion of the same object</span>
00608         <a class="code" href="../../d1/d2/cmp_8h.html#a2">CmpClearListEntry</a>(&amp;(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>));
00609         
00610         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a37">CMS_NOTIFY</a>) {
00611 <span class="preprocessor">#if DBG</span>
00612 <span class="preprocessor"></span>            <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
00613                 WCHAR                   *NameBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00614                 UNICODE_STRING          <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
00615 
00616                 NameBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="code" href="../../d9/d0/cmdata_8h.html#a1">MAX_KEY_NAME_LENGTH</a>);
00617                 <span class="keywordflow">if</span>(NameBuffer) {
00618                    <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a14">CmpInitializeKeyNameString</a>(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o17">KeyNode</a>,&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,NameBuffer);
00619                    KdPrint((<span class="stringliteral">"[CM]CmpPostNotify: NotifyBlock:%08lx\tKey = %.*S\n"</span>,NotifyBlock,<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length / <span class="keyword">sizeof</span>(WCHAR),<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer));
00620                    <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NameBuffer);
00621                 }
00622                 KdPrint((<span class="stringliteral">"[CM]\tCmpPostNotify: PostBlock:%08lx\n"</span>, PostBlock));
00623             }
00624 <span class="preprocessor">#endif</span>
00625 <span class="preprocessor"></span>        }
00626 
00627         <span class="keywordflow">if</span>( (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NOTIFY_CLEANUP) &amp;&amp; !<a class="code" href="../../d1/d2/cmp_8h.html#a89">IsMasterPostBlock</a>(PostBlock) ) {
00628             <span class="comment">//</span>
00629             <span class="comment">// Cleanup notification (i.e. the key handle was closed or the key was deleted)</span>
00630             <span class="comment">// When the post is a slave one, just cancel it. Canceling means:</span>
00631             <span class="comment">//      1. Removing from the notify PostList (aldready done at this point - see above)</span>
00632             <span class="comment">//      2. Unchaining from the Master Block CancelPostList</span>
00633             <span class="comment">//      3. Delisting from the thread PostBlockList</span>
00634             <span class="comment">//      4. Actually freeing the memory</span>
00635             <span class="comment">//</span>
00636 
00637             <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
00638             <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o2">CancelPostList</a>));
00639             <span class="comment">//</span>
00640             <span class="comment">// FIX 289351</span>
00641             <span class="comment">//</span>
00642             <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
00643             <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, &amp;OldIrql);
00644             <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o1">ThreadList</a>));
00645             <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00646 
00647             <span class="keywordflow">if</span>( PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o4">NotifyType</a> != <a class="code" href="../../d1/d2/cmp_8h.html#a335a204">PostSynchronous</a> ) {
00648 
00649                 <span class="comment">// add to the deref list and clean the post block</span>
00650                 <a class="code" href="../../d0/d2/cmnotify_8c.html#a5">CmpAddToDelayedDeref</a>(PostBlock,DelayedDeref);
00651 
00652                 <span class="comment">//</span>
00653                 <span class="comment">// Front-end routine will do self cleanup for syncrounous notifications</span>
00654                 <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(PostBlock);
00655             }
00656 
00657             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a37">CMS_NOTIFY</a>) {
00658 <span class="preprocessor">#if DBG</span>
00659 <span class="preprocessor"></span>                <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
00660                     KdPrint((<span class="stringliteral">"[CM]\tCmpPostNotify: PostBlock:%08lx is a slave block,and notify is CLEANUP==&gt; just cleanning\n"</span>, PostBlock));
00661                 }
00662 <span class="preprocessor">#endif</span>
00663 <span class="preprocessor"></span>            }
00664 
00665             <span class="keywordflow">continue</span>; <span class="comment">//try the next one</span>
00666         }
00667 
00668         <span class="comment">//</span>
00669         <span class="comment">// Simulate that this block is the master one, so we can free the others</span>
00670         <span class="comment">// Doing that will ensure the right memory dealocation when the master</span>
00671         <span class="comment">// (from now on this block) will be freed.</span>
00672         <span class="comment">//</span>
00673         <span class="keywordflow">if</span>(!<a class="code" href="../../d1/d2/cmp_8h.html#a89">IsMasterPostBlock</a>(PostBlock)) {
00674             <span class="comment">//</span>
00675             <span class="comment">// oops.,this is not the master block, we have some more work to do</span>
00676             <span class="comment">//</span>
00677             SlavePostBlock = PostBlock;
00678             <span class="keywordflow">do</span> {
00679                 SlavePostBlock = (<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>)SlavePostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o2">CancelPostList</a>.Flink;
00680                 SlavePostBlock = CONTAINING_RECORD(SlavePostBlock,
00681                                                    <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">CM_POST_BLOCK</a>,
00682                                                    CancelPostList);
00683                 <span class="comment">//</span>
00684                 <span class="comment">// reset the "master flag" if set</span>
00685                 <span class="comment">//</span>
00686                 <a class="code" href="../../d1/d2/cmp_8h.html#a91">ClearMasterPostBlockFlag</a>(SlavePostBlock);
00687             } <span class="keywordflow">while</span> (SlavePostBlock != PostBlock);
00688 
00689             <span class="comment">//</span>
00690             <span class="comment">// Make this post block the master one</span>
00691             <span class="comment">//</span>
00692             <a class="code" href="../../d1/d2/cmp_8h.html#a90">SetMasterPostBlockFlag</a>(PostBlock);
00693         }
00694 
00695         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a37">CMS_NOTIFY</a>) {
00696 <span class="preprocessor">#if DBG</span>
00697 <span class="preprocessor"></span>            <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
00698                 KdPrint((<span class="stringliteral">"[CM]\tCmpPostNotify: Master block switched to :%08lx\n"</span>, PostBlock));
00699             }
00700 <span class="preprocessor">#endif</span>
00701 <span class="preprocessor"></span>        }
00702 
00703         <span class="comment">//</span>
00704         <span class="comment">// Cancel all slave Post requests that may be linked to self</span>
00705         <span class="comment">//</span>
00706 
00707         <span class="keywordflow">if</span>( <a class="code" href="../../d1/d2/cmp_8h.html#a88">PostBlockType</a>(PostBlock) != <a class="code" href="../../d1/d2/cmp_8h.html#a335a204">PostSynchronous</a> ) {
00708             <span class="comment">//</span>
00709             <span class="comment">// Front-end routine will do self cleanup for syncrounous notifications</span>
00710             <a class="code" href="../../d0/d2/cmnotify_8c.html#a3">CmpCancelSlavePost</a>(PostBlock,DelayedDeref);
00711             <span class="comment">//</span>
00712             <span class="comment">// Do the same for the master (in case master and slave got switched)</span>
00713             <span class="comment">// This will avoid dereferencing the keybody from CmpPostApc</span>
00714             <a class="code" href="../../d0/d2/cmnotify_8c.html#a5">CmpAddToDelayedDeref</a>(PostBlock,DelayedDeref);
00715         }
00716 
00717         <span class="keywordflow">switch</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a88">PostBlockType</a>(PostBlock)) {
00718             <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a335a204">PostSynchronous</a>:
00719                 <span class="comment">//</span>
00720                 <span class="comment">// This is a SYNC notify call.  There will be no user event,</span>
00721                 <span class="comment">// and no user apc routine.  Quick exit here, just fill in</span>
00722                 <span class="comment">// the Status and poke the event.</span>
00723                 <span class="comment">//</span>
00724                 <span class="comment">// Holder of the systemevent will wake up and free the</span>
00725                 <span class="comment">// postblock.  If we free it here, we get a race &amp; bugcheck.</span>
00726                 <span class="comment">//</span>
00727                 <span class="comment">// Set the flink to NULL so that the front side can tell this</span>
00728                 <span class="comment">// has been removed if its wait aborts.</span>
00729                 <span class="comment">//</span>
00730                 PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00731                 PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o0">Sync</a>.<a class="code" href="../../d7/d6/struct__CM__SYNC__POST__BLOCK.html#o1">Status</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00732                 <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o0">Sync</a>.<a class="code" href="../../d7/d6/struct__CM__SYNC__POST__BLOCK.html#o0">SystemEvent</a>,
00733                            0,
00734                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00735                 <span class="keywordflow">break</span>;
00736 
00737             <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a335a205">PostAsyncUser</a>:
00738                 <span class="comment">//</span>
00739                 <span class="comment">// Insert the APC into the queue</span>
00740                 <span class="comment">//</span>
00741                 <a class="code" href="../../d5/d7/apcobj_8c.html#a3">KeInsertQueueApc</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o1">Apc</a>,
00742                                  (PVOID)ULongToPtr(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>),
00743                                  (PVOID)PostBlock,
00744                                  0);
00745                 <span class="keywordflow">break</span>;
00746 
00747             <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a335a206">PostAsyncKernel</a>:
00748                 <span class="comment">//</span>
00749                 <span class="comment">// Queue the work item, then free the post block.</span>
00750                 <span class="comment">//</span>
00751                 <span class="keywordflow">if</span> (PostBlock-&gt;u-&gt;AsyncKernel.WorkItem != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00752                     <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>(PostBlock-&gt;u-&gt;AsyncKernel.WorkItem,
00753                                     PostBlock-&gt;u-&gt;AsyncKernel.QueueType);
00754                 }
00755                 <span class="comment">//</span>
00756                 <span class="comment">// Signal Event if present, and deref it.</span>
00757                 <span class="comment">//</span>
00758                 <span class="keywordflow">if</span> (PostBlock-&gt;u-&gt;AsyncKernel.Event != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00759                     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(PostBlock-&gt;u-&gt;AsyncKernel.Event,
00760                                0,
00761                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00762                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(PostBlock-&gt;u-&gt;AsyncKernel.Event);
00763                 }
00764 
00765                                 <span class="comment">//</span>
00766                                 <span class="comment">// Multiple async kernel notification are not allowed</span>
00767                                 <span class="comment">//</span>
00768                                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IsListEmpty(&amp;(PostBlock-&gt;CancelPostList)) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00769                                 <span class="comment">//</span>
00770                 <span class="comment">// remove the post block from the thread list, and free it</span>
00771                 <span class="comment">//</span>
00772                 <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
00773                 <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, &amp;OldIrql);
00774                 <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(PostBlock-&gt;ThreadList));
00775                 <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00776                 
00777                 <span class="comment">// it was already added to delayed deref.</span>
00778                 <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(PostBlock);
00779                 <span class="keywordflow">break</span>;
00780         }
00781     }
00782 
00783     <a class="code" href="../../d1/d2/cmp_8h.html#a93">UNLOCK_POST_LIST</a>();
00784 
00785     <span class="comment">//</span>
00786     <span class="comment">// At this point we have a list of keybody elements that have to be dereferenciated</span>
00787     <span class="comment">// and the associated storage for the covering objects freed. The keybodies in this </span>
00788     <span class="comment">// list have only one reference count on them (they were referenced only in </span>
00789     <span class="comment">// NtNotifyChangeMultipleKeys), dereferencing them here should free the object</span>
00790     <span class="comment">//</span>
00791 
00792     <span class="keywordflow">if</span>( ARGUMENT_PRESENT(ExternalKeyDeref) ) {
00793         <span class="comment">// do nothing; the caller wants to handle the dereferenciation by himself!</span>
00794     } <span class="keywordflow">else</span> {
00795         <span class="comment">// dereferenciate all keybodies in the delayed list</span>
00796         <a class="code" href="../../d0/d2/cmnotify_8c.html#a6">CmpDelayedDerefKeys</a>(DelayedDeref);
00797     }
00798    
00799     <span class="keywordflow">return</span>;
00800 }
00801 
00802 
00803 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00804"></a><a class="code" href="../../d1/d2/cmp_8h.html#a287">00804</a> <a class="code" href="../../d1/d2/cmp_8h.html#a287">CmpPostApc</a>(
00805     <span class="keyword">struct</span> <a class="code" href="../../d1/d5/struct__KAPC.html">_KAPC</a> *Apc,
00806     PKNORMAL_ROUTINE *NormalRoutine,
00807     PVOID *NormalContext,
00808     PVOID *SystemArgument1,
00809     PVOID *SystemArgument2
00810     )
00811 <span class="comment">/*++</span>
00812 <span class="comment"></span>
00813 <span class="comment">Routine Description:</span>
00814 <span class="comment"></span>
00815 <span class="comment">    This is the kernel apc routine.  It is called for all notifies,</span>
00816 <span class="comment">    regardless of what form of notification the caller requested.</span>
00817 <span class="comment"></span>
00818 <span class="comment">    We compute the postblock address from the apc object address.</span>
00819 <span class="comment">    IoStatus is set.  SystemEvent and UserEvent will be signalled</span>
00820 <span class="comment">    as appropriate.  If the user requested an APC, then NormalRoutine</span>
00821 <span class="comment">    will be set at entry and executed when we exit.  The PostBlock</span>
00822 <span class="comment">    is freed here.</span>
00823 <span class="comment"></span>
00824 <span class="comment">Arguments:</span>
00825 <span class="comment"></span>
00826 <span class="comment">    Apc - pointer to apc object</span>
00827 <span class="comment"></span>
00828 <span class="comment">    NormalRoutine - Will be called when we return</span>
00829 <span class="comment"></span>
00830 <span class="comment">    NormalContext - will be 1st argument to normal routine, ApcContext</span>
00831 <span class="comment">                    passed in when NtNotifyChangeKey was called</span>
00832 <span class="comment"></span>
00833 <span class="comment">    SystemArgument1 -  IN: Status value for IoStatusBlock</span>
00834 <span class="comment">                      OUT: Ptr to IoStatusBlock (2nd arg to user apc routine)</span>
00835 <span class="comment"></span>
00836 <span class="comment">    SystemArgument2 - Pointer to the PostBlock</span>
00837 <span class="comment"></span>
00838 <span class="comment">Return Value:</span>
00839 <span class="comment"></span>
00840 <span class="comment">    NONE.</span>
00841 <span class="comment"></span>
00842 <span class="comment">--*/</span>
00843 {
00844     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>  PostBlock;
00845 
00846     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00847     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a37">CMS_NOTIFY</a>) {
00848         KdPrint((<span class="stringliteral">"CmpPostApc:\n"</span>));
00849         KdPrint((<span class="stringliteral">"\tApc:%08lx "</span>, Apc));
00850         KdPrint((<span class="stringliteral">"NormalRoutine:%08lx\n"</span>, NormalRoutine));
00851         KdPrint((<span class="stringliteral">"\tNormalContext:%08lx"</span>, NormalContext));
00852         KdPrint((<span class="stringliteral">"\tSystemArgument1=IoStatusBlock:%08lx\n"</span>, SystemArgument1));
00853     }
00854 
00855 
00856     PostBlock = *(<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a> *)SystemArgument2;
00857 
00858     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a37">CMS_NOTIFY</a>) {
00859 <span class="preprocessor">#if DBG</span>
00860 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
00861             KdPrint((<span class="stringliteral">"[CM]CmpPostApc: PostBlock:%08lx\n"</span>, PostBlock));
00862         }
00863 <span class="preprocessor">#endif</span>
00864 <span class="preprocessor"></span>    }
00865     <span class="comment">//</span>
00866     <span class="comment">// Fill in IO Status Block</span>
00867     <span class="comment">//</span>
00868     <span class="comment">// IMPLEMENTATION NOTE:</span>
00869     <span class="comment">//      If we ever want to actually implement the code that returns</span>
00870     <span class="comment">//      names of things that changed, this is the place to copy the</span>
00871     <span class="comment">//      buffer into the caller's buffer.</span>
00872     <span class="comment">//</span>
00873     <span class="comment">//  Sundown only: Use a 32bit IO_STATUS_BLOCK if the caller is 32bit.</span>
00874 
00875     <span class="keywordflow">try</span> {
00876         <a class="code" href="../../d1/d2/cmp_8h.html#a151">CmpSetIoStatus</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o2">IoStatusBlock</a>, 
00877                        *((ULONG *)SystemArgument1), 
00878                        0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00879                        <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Wow64Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00880     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00881         NOTHING;
00882     }
00883     *SystemArgument1 = PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o2">IoStatusBlock</a>;
00884 
00885     <span class="comment">//</span>
00886     <span class="comment">// This is an Async notify, do all work here, including</span>
00887     <span class="comment">// cleaning up the post block</span>
00888     <span class="comment">//</span>
00889 
00890     <span class="comment">//</span>
00891     <span class="comment">// Signal UserEvent if present, and deref it.</span>
00892     <span class="comment">//</span>
00893     <span class="keywordflow">if</span> (PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o0">UserEvent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00894         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o0">UserEvent</a>,
00895                    0,
00896                    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00897         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o0">UserEvent</a>);
00898     }
00899 
00900     <span class="comment">//</span>
00901     <span class="comment">// remove the post block from the thread list, and free it</span>
00902     <span class="comment">//</span>
00903     <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
00904     <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o1">ThreadList</a>));
00905 
00906     <span class="comment">// debug only checks</span>
00907     <a class="code" href="../../d0/d2/cmnotify_8c.html#a0">CmpCheckPostBlock</a>(PostBlock);
00908     <span class="comment">//</span>
00909         <span class="comment">// Free the slave post block to avoid "dangling" postblocks</span>
00910         <span class="comment">//</span>
00911         <a class="code" href="../../d0/d2/cmnotify_8c.html#a4">CmpFreeSlavePost</a>(PostBlock);
00912     <span class="comment">//</span>
00913         <span class="comment">// free this post block</span>
00914         <span class="comment">// </span>
00915         <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(PostBlock);
00916 
00917     <span class="keywordflow">return</span>;
00918 }
00919 
00920 
00921 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00922"></a><a class="code" href="../../d1/d2/cmp_8h.html#a289">00922</a> <a class="code" href="../../d1/d2/cmp_8h.html#a289">CmpPostApcRunDown</a>(
00923     <span class="keyword">struct</span> <a class="code" href="../../d1/d5/struct__KAPC.html">_KAPC</a> *Apc
00924     )
00925 <span class="comment">/*++</span>
00926 <span class="comment"></span>
00927 <span class="comment">Routine Description:</span>
00928 <span class="comment"></span>
00929 <span class="comment">    This routine is called to clear away apcs in the apc queue</span>
00930 <span class="comment">    of a thread that has been terminated.</span>
00931 <span class="comment"></span>
00932 <span class="comment">    Since the apc is in the apc queue, we know that it is NOT in</span>
00933 <span class="comment">    any NotifyBlock's post list.  It is, however, in the threads's</span>
00934 <span class="comment">    PostBlockList.</span>
00935 <span class="comment"></span>
00936 <span class="comment">    Therefore, poke any user events so that waiters are not stuck,</span>
00937 <span class="comment">    drop the references so the event can be cleaned up, delist the</span>
00938 <span class="comment">    PostBlock and free it.</span>
00939 <span class="comment"></span>
00940 <span class="comment">    Since we are cleaning up the thread, SystemEvents are not interesting.</span>
00941 <span class="comment"></span>
00942 <span class="comment">    Since the apc is in the apc queue, we know that if there were any other</span>
00943 <span class="comment">    notifications related to this one, they are cleaned up by the</span>
00944 <span class="comment">    CmPostNotify routine</span>
00945 <span class="comment"></span>
00946 <span class="comment">Arguments:</span>
00947 <span class="comment"></span>
00948 <span class="comment">    Apc - pointer to apc object</span>
00949 <span class="comment"></span>
00950 <span class="comment">Return Value:</span>
00951 <span class="comment"></span>
00952 <span class="comment">    NONE.</span>
00953 <span class="comment"></span>
00954 <span class="comment">--*/</span>
00955 {
00956     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>  PostBlock;
00957     KIRQL           OldIrql;
00958 
00959     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00960     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a37">CMS_NOTIFY</a>) {
00961         KdPrint((<span class="stringliteral">"CmpApcRunDown:"</span>));
00962         KdPrint((<span class="stringliteral">"\tApc:%08lx \n"</span>, Apc));
00963     }
00964 
00965     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, &amp;OldIrql);
00966 
00967     PostBlock = (<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>)Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o10">SystemArgument2</a>;
00968 
00969     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a37">CMS_NOTIFY</a>) {
00970 <span class="preprocessor">#if DBG</span>
00971 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
00972             KdPrint((<span class="stringliteral">"[CM]CmpPostApcRunDown: PostBlock:%08lx\n"</span>, PostBlock));
00973         }
00974 <span class="preprocessor">#endif</span>
00975 <span class="preprocessor"></span>    }
00976 
00977     <span class="comment">//</span>
00978     <span class="comment">// report status and wake up any threads that might otherwise</span>
00979     <span class="comment">// be stuck.  also drop any event references we hold</span>
00980     <span class="comment">//</span>
00981     <span class="comment">//  Sundown only: Use a 32bit IO_STATUS_BLOCK if the caller is 32bit. </span>
00982 
00983     <span class="keywordflow">try</span> {
00984         <a class="code" href="../../d1/d2/cmp_8h.html#a151">CmpSetIoStatus</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o2">IoStatusBlock</a>, 
00985                        STATUS_NOTIFY_CLEANUP, 
00986                        0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, 
00987                        <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Wow64Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00988     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00989         NOTHING;
00990     }
00991 
00992     <span class="keywordflow">if</span> (PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o0">UserEvent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00993         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(
00994             PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o0">UserEvent</a>,
00995             0,
00996             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00997             );
00998         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o0">UserEvent</a>);
00999     }
01000 
01001     <span class="comment">//</span>
01002     <span class="comment">// delist the post block</span>
01003     <span class="comment">//</span>
01004     <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01005     <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o1">ThreadList</a>));
01006 
01007         <span class="comment">//</span>
01008         <span class="comment">// Free the slave post block to avoid "dangling" postblocks</span>
01009         <span class="comment">//</span>
01010         <a class="code" href="../../d0/d2/cmnotify_8c.html#a4">CmpFreeSlavePost</a>(PostBlock);
01011     <span class="comment">//</span>
01012     <span class="comment">// Free the post block.  Use Ex call because PostBlocks are NOT</span>
01013     <span class="comment">// part of the global registry pool computation, but are instead</span>
01014     <span class="comment">// part of NonPagedPool with Quota.</span>
01015     <span class="comment">//</span>
01016     <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(PostBlock);
01017 
01018     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
01019 
01020     <span class="keywordflow">return</span>;
01021 }
01022 
01023 
01024 <span class="comment">//</span>
01025 <span class="comment">// Cleanup procedure</span>
01026 <span class="comment">//</span>
01027 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01028"></a><a class="code" href="../../d7/d9/cm_8h.html#a32">01028</a> <a class="code" href="../../d7/d9/cm_8h.html#a32">CmNotifyRunDown</a>(
01029     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>    Thread
01030     )
01031 <span class="comment">/*++</span>
01032 <span class="comment"></span>
01033 <span class="comment">Routine Description:</span>
01034 <span class="comment"></span>
01035 <span class="comment">    This routine is called from PspExitThread to clean up any pending</span>
01036 <span class="comment">    notify requests.</span>
01037 <span class="comment"></span>
01038 <span class="comment">    It will traverse the thread's PostBlockList, for each PostBlock it</span>
01039 <span class="comment">    finds, it will:</span>
01040 <span class="comment"></span>
01041 <span class="comment">        1.  Remove it from the relevent NotifyBlock.  This requires</span>
01042 <span class="comment">            that we hold the Registry mutex.</span>
01043 <span class="comment"></span>
01044 <span class="comment">        2.  Remove it from the thread's PostBlockList.  This requires</span>
01045 <span class="comment">            that we run at APC level.</span>
01046 <span class="comment"></span>
01047 <span class="comment">        3.  By the time this procedure runs, user apcs are not interesting</span>
01048 <span class="comment">            and neither are SystemEvents, so do not bother processing</span>
01049 <span class="comment">            them.</span>
01050 <span class="comment"></span>
01051 <span class="comment">            UserEvents and IoStatusBlocks could be refered to by other</span>
01052 <span class="comment">            threads in the same process, or even a different process,</span>
01053 <span class="comment">            so process them so those threads know what happened, use</span>
01054 <span class="comment">            status code of STATUS_NOTIFY_CLEANUP.</span>
01055 <span class="comment"></span>
01056 <span class="comment">            If the notify is a master one, cancel all slave notifications.</span>
01057 <span class="comment">            Else only remove this notification from the master CancelPortList</span>
01058 <span class="comment"></span>
01059 <span class="comment">        4.  Free the post block.</span>
01060 <span class="comment"></span>
01061 <span class="comment">Arguments:</span>
01062 <span class="comment"></span>
01063 <span class="comment">    Thread - pointer to the executive thread object for the thread</span>
01064 <span class="comment">             we wish to do rundown on.</span>
01065 <span class="comment"></span>
01066 <span class="comment">Return Value:</span>
01067 <span class="comment"></span>
01068 <span class="comment">    NONE.</span>
01069 <span class="comment"></span>
01070 <span class="comment">--*/</span>
01071 {
01072     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>      PostBlock;
01073     <a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a>    NotifyBlock;
01074     KIRQL               OldIrql;
01075 
01076     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01077 
01078     <span class="keywordflow">if</span> ( IsListEmpty(&amp;(Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o8">PostBlockList</a>)) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ) {
01079         <span class="keywordflow">return</span>;
01080     }
01081 
01082     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) {
01083         KdPrint((<span class="stringliteral">"CmNotifyRunDown: ethread:%08lx\n"</span>, Thread));
01084     }
01085 
01086     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
01087 
01088         <span class="comment">//</span>
01089     <span class="comment">// Aquire exclusive access over the postlist(s)</span>
01090     <span class="comment">//</span>
01091     <span class="comment">// This is not needed (see the rule above)</span>
01092     <span class="comment">//LOCK_POST_LIST(); </span>
01093 
01094     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, &amp;OldIrql);
01095     <span class="keywordflow">while</span> (IsListEmpty(&amp;(Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o8">PostBlockList</a>)) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01096 
01097         <span class="comment">//</span>
01098         <span class="comment">// remove from thread list</span>
01099         <span class="comment">//</span>
01100         PostBlock = (<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>)RemoveHeadList(&amp;(Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o8">PostBlockList</a>));
01101         PostBlock = CONTAINING_RECORD(
01102                         PostBlock,
01103                         <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">CM_POST_BLOCK</a>,
01104                         ThreadList
01105                         );
01106 
01107         <span class="comment">// Protect for multiple deletion of the same object</span>
01108         <a class="code" href="../../d1/d2/cmp_8h.html#a2">CmpClearListEntry</a>(&amp;(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o1">ThreadList</a>));
01109 
01110         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) {
01111 <span class="preprocessor">#if DBG</span>
01112 <span class="preprocessor"></span>            <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
01113                 KdPrint((<span class="stringliteral">"[CM]CmpNotifyRunDown: ethread:%08lx, PostBlock:%08lx\n"</span>, Thread,PostBlock));
01114             }
01115 <span class="preprocessor">#endif</span>
01116 <span class="preprocessor"></span>        }
01117 
01118         <span class="comment">//</span>
01119         <span class="comment">// Canceling a master notification implies canceling all the slave notifications</span>
01120         <span class="comment">// from the CancelPostList</span>
01121         <span class="comment">//</span>
01122         <span class="keywordflow">if</span>(<a class="code" href="../../d1/d2/cmp_8h.html#a89">IsMasterPostBlock</a>(PostBlock)) {
01123             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) {
01124 <span class="preprocessor">#if DBG</span>
01125 <span class="preprocessor"></span>                <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
01126                         KdPrint((<span class="stringliteral">"[CM]\tCmpNotifyRunDown: PostBlock:%08lx is a master block\n"</span>, PostBlock));
01127                 }
01128 <span class="preprocessor">#endif</span>
01129 <span class="preprocessor"></span>            }
01130             <span class="comment">//</span>
01131             <span class="comment">// at this point, CmpReportNotify and friends will no longer</span>
01132             <span class="comment">// attempt to post this post block.</span>
01133             <span class="comment">//</span>
01134             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a88">PostBlockType</a>(PostBlock) == <a class="code" href="../../d1/d2/cmp_8h.html#a335a205">PostAsyncUser</a>) {
01135                 <span class="comment">//</span>
01136                 <span class="comment">// report status and wake up any threads that might otherwise</span>
01137                 <span class="comment">// be stuck.  also drop any event references we hold</span>
01138                 <span class="comment">//</span>
01139                 <span class="comment">//  Sundown only: Use a 32bit IO_STATUS_BLOCK if the caller is 32bit. </span>
01140 
01141                 <span class="keywordflow">try</span> {
01142                     <a class="code" href="../../d1/d2/cmp_8h.html#a151">CmpSetIoStatus</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o2">IoStatusBlock</a>, 
01143                                    STATUS_NOTIFY_CLEANUP, 
01144                                    0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, 
01145                                    <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Wow64Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01146                 } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01147                     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a38">CMS_EXCEPTION</a>) {
01148                         KdPrint((<span class="stringliteral">"!!CmNotifyRundown: code:%08lx\n"</span>, GetExceptionCode()));
01149                     }
01150                     NOTHING;
01151                 }
01152 
01153                 <span class="keywordflow">if</span> (PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o0">UserEvent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01154                     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(
01155                         PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o0">UserEvent</a>,
01156                         0,
01157                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01158                         );
01159                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o0">UserEvent</a>);
01160                 }
01161 
01162                 <span class="comment">//</span>
01163                 <span class="comment">// Cancel the APC. Otherwise the rundown routine will also</span>
01164                 <span class="comment">// free the post block if the APC happens to be queued at</span>
01165                 <span class="comment">// this point. If the APC is queued, then the post block has</span>
01166                 <span class="comment">// already been removed from the notify list, so don't remove</span>
01167                 <span class="comment">// it again.</span>
01168                 <span class="comment">//</span>
01169                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d7/apcobj_8c.html#a4">KeRemoveQueueApc</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o1">Apc</a>)) {
01170 
01171                     <span class="comment">//</span>
01172                     <span class="comment">// remove from notify block's list</span>
01173                     <span class="comment">//</span>
01174                     <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01175                     <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>));
01176                 }
01177             } <span class="keywordflow">else</span> {
01178                 <span class="comment">//</span>
01179                 <span class="comment">// remove from notify block's list</span>
01180                 <span class="comment">//</span>
01181                 <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01182                 <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>));
01183             }
01184 
01185             <span class="comment">//</span>
01186             <span class="comment">// Cancel all slave Post requests that may be linked to self</span>
01187             <span class="comment">//</span>
01188             <a class="code" href="../../d0/d2/cmnotify_8c.html#a3">CmpCancelSlavePost</a>(PostBlock,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>); <span class="comment">// we do not want delayed deref</span>
01189                         <span class="comment">//</span>
01190                         <span class="comment">// Free the slave Post blocks too</span>
01191                         <span class="comment">//</span>
01192                         <a class="code" href="../../d0/d2/cmnotify_8c.html#a4">CmpFreeSlavePost</a>(PostBlock);
01193         } <span class="keywordflow">else</span> {
01194 
01195             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) {
01196 <span class="preprocessor">#if DBG</span>
01197 <span class="preprocessor"></span>                <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
01198                     KdPrint((<span class="stringliteral">"[CM]\tCmpNotifyRunDown: PostBlock:%08lx is a slave block\n"</span>, PostBlock));
01199                 }
01200 <span class="preprocessor">#endif</span>
01201 <span class="preprocessor"></span>            }
01202             <span class="comment">//</span>
01203             <span class="comment">// Is a slave PostBlock, just remove self from the Notify PostList</span>
01204             <span class="comment">//</span>
01205             <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01206             <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>));
01207 
01208             <span class="comment">//</span>
01209             <span class="comment">// and unchain from the Master CancelPostList</span>
01210             <span class="comment">//</span>
01211             <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01212             <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o2">CancelPostList</a>));
01213 
01214         }
01215 
01216         <span class="comment">//</span>
01217         <span class="comment">// Free the post block.  Use Ex call because PostBlocks are NOT</span>
01218         <span class="comment">// part of the global registry pool computation, but are instead</span>
01219         <span class="comment">// part of NonPagedPool with Quota.</span>
01220         <span class="comment">//</span>
01221         <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(PostBlock);
01222     }
01223 
01224     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
01225 
01226     <span class="comment">// This is not needed (see the rule above)</span>
01227     <span class="comment">//UNLOCK_POST_LIST();</span>
01228 
01229     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01230     <span class="keywordflow">return</span>;
01231 }
01232 
01233 
01234 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01235"></a><a class="code" href="../../d1/d2/cmp_8h.html#a288">01235</a> <a class="code" href="../../d1/d2/cmp_8h.html#a288">CmpFlushNotify</a>(
01236     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>        KeyBody
01237     )
01238 <span class="comment">/*++</span>
01239 <span class="comment"></span>
01240 <span class="comment">Routine Description:</span>
01241 <span class="comment"></span>
01242 <span class="comment">    Clean up notifyblock when a handle is closed or the key it refers</span>
01243 <span class="comment">    to is deleted.</span>
01244 <span class="comment"></span>
01245 <span class="comment">Arguments:</span>
01246 <span class="comment"></span>
01247 <span class="comment">    KeyBody - supplies pointer to key object body for handle we</span>
01248 <span class="comment">                are cleaning up.</span>
01249 <span class="comment"></span>
01250 <span class="comment">Return Value:</span>
01251 <span class="comment"></span>
01252 <span class="comment">    NONE</span>
01253 <span class="comment"></span>
01254 <span class="comment">--*/</span>
01255 {
01256     <a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a>    NotifyBlock;
01257     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
01258 
01259     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01260     <a class="code" href="../../d1/d2/cmp_8h.html#a61">ASSERT_CM_LOCK_OWNED</a>();
01261 
01262     <span class="keywordflow">if</span> (KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o2">NotifyBlock</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01263         <span class="keywordflow">return</span>;
01264     }
01265 
01266 <span class="preprocessor">#ifdef KCB_TO_KEYBODY_LINK</span>
01267 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o0">Delete</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01268 <span class="preprocessor">#endif</span>
01269 <span class="preprocessor"></span>
01270     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a37">CMS_NOTIFY</a>) {
01271 <span class="preprocessor">#if DBG</span>
01272 <span class="preprocessor"></span>        WCHAR                   *NameBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01273         UNICODE_STRING          <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
01274 
01275         KdPrint((<span class="stringliteral">"[CM]CmpFlushNotify: NotifyBlock = %08lx\n"</span>,KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o2">NotifyBlock</a>));
01276         NameBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="code" href="../../d9/d0/cmdata_8h.html#a1">MAX_KEY_NAME_LENGTH</a>);
01277         <span class="keywordflow">if</span>(NameBuffer &amp;&amp; KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o17">KeyNode</a>) {
01278            <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a14">CmpInitializeKeyNameString</a>(KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o17">KeyNode</a>,&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,NameBuffer);
01279            KdPrint((<span class="stringliteral">"\t[CM]CmpFlushNotify: Key = %.*S\n"</span>,<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length / <span class="keyword">sizeof</span>(WCHAR),<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer));
01280            <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NameBuffer);
01281         }
01282 <span class="preprocessor">#endif</span>
01283 <span class="preprocessor"></span>    }
01284 
01285     <span class="comment">//</span>
01286     <span class="comment">// Lock the hive exclusively to prevent multiple threads from whacking</span>
01287     <span class="comment">// on the list.</span>
01288     <span class="comment">//</span>
01289     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = CONTAINING_RECORD(KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a>,
01290                              <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>,
01291                              <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
01292     <a class="code" href="../../d1/d2/cmp_8h.html#a94">CmLockHive</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
01293     <span class="comment">//</span>
01294     <span class="comment">// Reread the notify block in case it has already been freed.</span>
01295     <span class="comment">//</span>
01296     NotifyBlock = KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o2">NotifyBlock</a>;
01297     <span class="keywordflow">if</span> (NotifyBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01298         <a class="code" href="../../d1/d2/cmp_8h.html#a95">CmUnlockHive</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
01299         <span class="keywordflow">return</span>;
01300     }
01301 
01302     <span class="comment">//</span>
01303     <span class="comment">// Clean up all PostBlocks waiting on the NotifyBlock</span>
01304     <span class="comment">//</span>
01305     <span class="keywordflow">if</span> (IsListEmpty(&amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o4">PostList</a>)) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01306         <a class="code" href="../../d1/d2/cmp_8h.html#a284">CmpPostNotify</a>(
01307             NotifyBlock,
01308             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01309             0,
01310             STATUS_NOTIFY_CLEANUP,
01311             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01312             );
01313     }
01314 
01315     <span class="comment">//</span>
01316     <span class="comment">// Release the subject context</span>
01317     <span class="comment">//</span>
01318     <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a>(&amp;NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o5">SubjectContext</a>);
01319 
01320     <span class="comment">//</span>
01321     <span class="comment">// IMPLEMENTATION NOTE:</span>
01322     <span class="comment">//      If we ever do code to report names and types of events,</span>
01323     <span class="comment">//      this is the place to free the buffer.</span>
01324     <span class="comment">//</span>
01325 
01326     <span class="comment">//</span>
01327     <span class="comment">// Remove the NotifyBlock from the hive chain</span>
01328     <span class="comment">//</span>
01329     NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>.Blink-&gt;Flink = NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>.Flink;
01330     <span class="keywordflow">if</span> (NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>.Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01331         NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>.Flink-&gt;Blink = NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>.Blink;
01332     }
01333 
01334     <span class="comment">// Protect for multiple deletion of the same object</span>
01335     <a class="code" href="../../d1/d2/cmp_8h.html#a2">CmpClearListEntry</a>(&amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>));
01336 
01337     KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o2">NotifyBlock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01338 
01339 <span class="preprocessor">#ifdef _CM_ENTRYLIST_MANIPULATION</span>
01340 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (IsListEmpty(&amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o4">PostList</a>)) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01341         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CmpFlushNotify: NotifyBlock %08lx\n"</span>,NotifyBlock);
01342         DbgBreakPoint();
01343     }
01344     <span class="comment">//check is the notify has been deleted from the hive notify list</span>
01345     {
01346         <a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a> ValidNotifyBlock;
01347         PLIST_ENTRY NotifyPtr;
01348 
01349         NotifyPtr = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;NotifyList);
01350 
01351         <span class="keywordflow">while</span> (NotifyPtr-&gt;Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01352             NotifyPtr = NotifyPtr-&gt;Flink;
01353 
01354             ValidNotifyBlock = CONTAINING_RECORD(NotifyPtr, <a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">CM_NOTIFY_BLOCK</a>, <a class="code" href="../../d4/d6/regext_8c.html#a0">HiveList</a>);
01355             <span class="keywordflow">if</span>( ValidNotifyBlock == NotifyBlock ) {
01356                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CmpFlushNotify: NotifyBlock %08lx is about to be deleted but is still in the hive notify list\n"</span>,NotifyBlock);
01357                 DbgBreakPoint();
01358             }
01359         }
01360     }
01361     RtlZeroMemory((PVOID)NotifyBlock, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">CM_NOTIFY_BLOCK</a>));
01362 <span class="preprocessor">#endif</span>
01363 <span class="preprocessor"></span>    
01364     <a class="code" href="../../d1/d2/cmp_8h.html#a95">CmUnlockHive</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
01365 
01366     <span class="comment">//</span>
01367     <span class="comment">// Free the block, clean up the KeyBody</span>
01368     <span class="comment">//</span>
01369     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NotifyBlock);
01370     <span class="keywordflow">return</span>;
01371 }
01372 
01373 
01374 <span class="comment">//</span>
01375 <span class="comment">// "Front Side" of notify.  See also Ntapi.c: ntnotifychangekey</span>
01376 <span class="comment">//</span>
01377 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01378"></a><a class="code" href="../../d1/d2/cmp_8h.html#a239">01378</a> <a class="code" href="../../d1/d2/cmp_8h.html#a239">CmpNotifyChangeKey</a>(
01379     IN <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>     KeyBody,
01380     IN <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>   PostBlock,
01381     IN ULONG            CompletionFilter,
01382     IN BOOLEAN          WatchTree,
01383     IN PVOID            Buffer,
01384     IN ULONG            BufferSize,
01385     IN <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>   MasterPostBlock
01386     )
01387 <span class="comment">/*++</span>
01388 <span class="comment"></span>
01389 <span class="comment">Routine Description:</span>
01390 <span class="comment"></span>
01391 <span class="comment">    This routine sets up the NotifyBlock, and attaches the PostBlock</span>
01392 <span class="comment">    to it.  When it returns, the Notify is visible to the system,</span>
01393 <span class="comment">    and will receive event reports.</span>
01394 <span class="comment"></span>
01395 <span class="comment">    If there is already an event report pending, then the notify</span>
01396 <span class="comment">    call will be satisified at once.</span>
01397 <span class="comment"></span>
01398 <span class="comment">Arguments:</span>
01399 <span class="comment"></span>
01400 <span class="comment">    KeyBody - pointer to key object that handle refers to, allows access</span>
01401 <span class="comment">              to key control block, notify block, etc.</span>
01402 <span class="comment"></span>
01403 <span class="comment">    PostBlock - pointer to structure that describes how/where the caller</span>
01404 <span class="comment">                is to be notified.</span>
01405 <span class="comment"></span>
01406 <span class="comment">                WARNING:    PostBlock must come from Pool, THIS routine</span>
01407 <span class="comment">                            will keep it, back side will free it.  This</span>
01408 <span class="comment">                            routine WILL free it in case of error.</span>
01409 <span class="comment"></span>
01410 <span class="comment">    CompletionFilter - what types of events the caller wants to see</span>
01411 <span class="comment"></span>
01412 <span class="comment">    WatchTree - TRUE to watch whole subtree, FALSE to watch only immediate</span>
01413 <span class="comment">                key the notify is applied to</span>
01414 <span class="comment"></span>
01415 <span class="comment">    Buffer - pointer to area to recieve notify data</span>
01416 <span class="comment"></span>
01417 <span class="comment">    BufferSize - size of buffer, also size user would like to allocate</span>
01418 <span class="comment">                 for internal buffer</span>
01419 <span class="comment"></span>
01420 <span class="comment">    MasterPostBlock - the post block of the master notification. Used to</span>
01421 <span class="comment">                      insert the PostBlock into the CancelPostList list.</span>
01422 <span class="comment"></span>
01423 <span class="comment">Return Value:</span>
01424 <span class="comment"></span>
01425 <span class="comment">    Status.</span>
01426 <span class="comment"></span>
01427 <span class="comment">--*/</span>
01428 {
01429     <a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a>    NotifyBlock;
01430     <a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a>    node;
01431     PLIST_ENTRY         ptr;
01432     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
01433     KIRQL               OldIrql;
01434 
01435     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01436     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a21">CML_WORKER</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a37">CMS_NOTIFY</a>) {
01437         KdPrint((<span class="stringliteral">"CmpNotifyChangeKey:\n"</span>));
01438         KdPrint((<span class="stringliteral">"\tKeyBody:%08lx PostBlock:%08lx "</span>, KeyBody, PostBlock));
01439         KdPrint((<span class="stringliteral">"Filter:%08lx WatchTree:%08lx\n"</span>, CompletionFilter, <a class="code" href="../../d5/d2/rtnotify_8c.html#a4">WatchTree</a>));
01440 <span class="preprocessor">#if DBG</span>
01441 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
01442             WCHAR                   *NameBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01443             UNICODE_STRING          <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
01444 
01445             KdPrint((<span class="stringliteral">"[CM]CmpNotifyChangeKey: PostBlock:%08lx\tMasterBlock: %08lx\n"</span>, PostBlock,MasterPostBlock));
01446             NameBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="code" href="../../d9/d0/cmdata_8h.html#a1">MAX_KEY_NAME_LENGTH</a>);
01447             <span class="keywordflow">if</span>(NameBuffer&amp;&amp;KeyBody-&gt;KeyControlBlock-&gt;KeyNode) {
01448                <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a14">CmpInitializeKeyNameString</a>(KeyBody-&gt;KeyControlBlock-&gt;KeyNode,&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,NameBuffer);
01449                KdPrint((<span class="stringliteral">"\t[CM]CmpNotifyChangeKey: Key = %.*S\n"</span>,<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length / <span class="keyword">sizeof</span>(WCHAR),<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer));
01450                <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NameBuffer);
01451             }
01452         }
01453 <span class="preprocessor">#endif</span>
01454 <span class="preprocessor"></span>    }
01455 
01456     <span class="comment">//</span>
01457     <span class="comment">// The registry lock should be aquired exclusively by the caller !!!</span>
01458     <span class="comment">//</span>
01459     <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
01460 
01461     <span class="keywordflow">if</span> (KeyBody-&gt;KeyControlBlock-&gt;Delete) {
01462 <span class="preprocessor">#ifdef KCB_TO_KEYBODY_LINK</span>
01463 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( KeyBody-&gt;NotifyBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01464 <span class="preprocessor">#endif</span>
01465 <span class="preprocessor"></span>        <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(PostBlock);
01466         <span class="keywordflow">return</span> STATUS_KEY_DELETED;
01467     }
01468 
01469     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = (<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)KeyBody-&gt;KeyControlBlock-&gt;KeyHive;
01470     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = CONTAINING_RECORD(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
01471     NotifyBlock = KeyBody-&gt;NotifyBlock;
01472 
01473     <span class="keywordflow">if</span> (NotifyBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01474         <span class="comment">//</span>
01475         <span class="comment">// Set up new notify session</span>
01476         <span class="comment">//</span>
01477         NotifyBlock = <a class="code" href="../../d5/d8/ex_8h.html#a5">ExAllocatePoolWithQuotaTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>|<a class="code" href="../../d5/d8/ex_8h.html#a2">POOL_QUOTA_FAIL_INSTEAD_OF_RAISE</a>,<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">CM_NOTIFY_BLOCK</a>),CM_NOTIFYBLOCK_TAG);
01478         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a23">CML_MINOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a35">CMS_POOL</a>) {
01479             KdPrint((<span class="stringliteral">"**CmpNotifyChangeKey: allocate:%08lx, "</span>, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d2/cmp_8h.html#a164">CM_NOTIFY_BLOCK</a>)));
01480             KdPrint((<span class="stringliteral">"type:%d, at:%08lx\n"</span>, <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, NotifyBlock));
01481         }
01482 
01483         <span class="keywordflow">if</span> (NotifyBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01484             <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(PostBlock);
01485             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01486         }
01487         NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o1">KeyControlBlock</a> = KeyBody-&gt;KeyControlBlock;
01488         NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o3">Filter</a> = CompletionFilter;
01489         NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o6">WatchTree</a> = <a class="code" href="../../d5/d2/rtnotify_8c.html#a4">WatchTree</a>;
01490         NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o7">NotifyPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01491         InitializeListHead(&amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o4">PostList</a>));
01492         KeyBody-&gt;NotifyBlock = NotifyBlock;
01493         NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o2">KeyBody</a> = KeyBody;
01494         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( KeyBody-&gt;KeyControlBlock-&gt;Delete == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01495 
01496         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a21">CML_WORKER</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a37">CMS_NOTIFY</a>) {
01497 <span class="preprocessor">#if DBG</span>
01498 <span class="preprocessor"></span>            <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
01499                 WCHAR                   *NameBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01500                 UNICODE_STRING          <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
01501 
01502                 NameBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="code" href="../../d9/d0/cmdata_8h.html#a1">MAX_KEY_NAME_LENGTH</a>);
01503                 <span class="keywordflow">if</span>(NameBuffer) {
01504                    <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a14">CmpInitializeKeyNameString</a>(KeyBody-&gt;KeyControlBlock-&gt;KeyNode,&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,NameBuffer);
01505                    KdPrint((<span class="stringliteral">"[CM]\tCmpNotifyChangeKey: New NotifyBlock at:%08lx was allocated for Key = %.*S\n"</span>,NotifyBlock,<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length / <span class="keyword">sizeof</span>(WCHAR),<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer));
01506                    <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NameBuffer);
01507                 }
01508             }
01509 <span class="preprocessor">#endif</span>
01510 <span class="preprocessor"></span>        }
01511 
01512         <span class="comment">//</span>
01513         <span class="comment">// IMPLEMENTATION NOTE:</span>
01514         <span class="comment">//      If we ever want to actually return the buffers full of</span>
01515         <span class="comment">//      data, the buffer should be allocated and its address</span>
01516         <span class="comment">//      stored in the notify block here.</span>
01517         <span class="comment">//</span>
01518 
01519         <span class="comment">//</span>
01520         <span class="comment">// Capture the subject context so we can do checking once the</span>
01521         <span class="comment">// notify goes off.</span>
01522         <span class="comment">//</span>
01523         <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a>(&amp;NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o5">SubjectContext</a>);
01524 
01525         <span class="comment">//</span>
01526         <span class="comment">// Attach notify block to hive in properly sorted order</span>
01527         <span class="comment">//</span>
01528         ptr = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;NotifyList);
01529         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01530             <span class="keywordflow">if</span> (ptr-&gt;Flink == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01531                 <span class="comment">//</span>
01532                 <span class="comment">// End of list, add self after ptr.</span>
01533                 <span class="comment">//</span>
01534                 ptr-&gt;Flink = &amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>);
01535                 NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01536                 NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>.Blink = ptr;
01537                 <span class="keywordflow">break</span>;
01538             }
01539 
01540             ptr = ptr-&gt;Flink;
01541 
01542             node = CONTAINING_RECORD(ptr, <a class="code" href="../../d1/d2/cmp_8h.html#a164">CM_NOTIFY_BLOCK</a>, <a class="code" href="../../d4/d6/regext_8c.html#a0">HiveList</a>);
01543 
01544             <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o16">TotalLevels</a> &gt;
01545                 KeyBody-&gt;KeyControlBlock-&gt;TotalLevels)
01546             {
01547                 <span class="comment">//</span>
01548                 <span class="comment">// ptr -&gt; notify with longer name than us, insert in FRONT</span>
01549                 <span class="comment">//</span>
01550                 NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>.Flink = ptr;
01551                 ptr-&gt;Blink-&gt;Flink = &amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>);
01552                 NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>.Blink = ptr-&gt;Blink;
01553                 ptr-&gt;Blink = &amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o0">HiveList</a>);
01554                 <span class="keywordflow">break</span>;
01555             }
01556         }
01557     }
01558 
01559 
01560     <span class="comment">//</span>
01561     <span class="comment">// Add post block to front of notify block's list, and add it to thread list.</span>
01562     <span class="comment">//</span>
01563     InsertHeadList(
01564         &amp;(NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o4">PostList</a>),
01565         &amp;(PostBlock-&gt;NotifyList)
01566         );
01567 
01568 
01569 
01570     <span class="keywordflow">if</span>( <a class="code" href="../../d1/d2/cmp_8h.html#a89">IsMasterPostBlock</a>(PostBlock) ) {
01571         <span class="comment">//</span>
01572         <span class="comment">// Protect against outrageous calls</span>
01573         <span class="comment">//</span>
01574         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PostBlock == MasterPostBlock);
01575 
01576         <span class="comment">//</span>
01577         <span class="comment">// When the notification is a master one, initialize the CancelPostList list</span>
01578         <span class="comment">//</span>
01579         InitializeListHead(&amp;(PostBlock-&gt;CancelPostList));
01580     } <span class="keywordflow">else</span> {
01581         <span class="comment">//</span>
01582         <span class="comment">// Add PostBlock at the end of the CancelPostList list from the master post</span>
01583         <span class="comment">//</span>
01584         InsertTailList(
01585             &amp;(MasterPostBlock-&gt;CancelPostList),
01586             &amp;(PostBlock-&gt;CancelPostList)
01587             );
01588     }
01589 
01590 
01591     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, &amp;OldIrql);
01592     InsertHeadList(
01593         &amp;(<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;PostBlockList),
01594         &amp;(PostBlock-&gt;ThreadList)
01595         );
01596 
01597     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a21">CML_WORKER</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a37">CMS_NOTIFY</a>) {
01598 <span class="preprocessor">#if DBG</span>
01599 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
01600             KdPrint((<span class="stringliteral">"[CM]\tCmpNotifyChangeKey: Attaching the post:%08lx\t to thread:%08lx\n"</span>,PostBlock,<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()));
01601         }
01602 <span class="preprocessor">#endif</span>
01603 <span class="preprocessor"></span>    }
01604 
01605     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
01606 
01607     <span class="comment">//</span>
01608     <span class="comment">// If there is a notify pending (will not be if we just created</span>
01609     <span class="comment">// the notify block) then post it at once.  Note that this call</span>
01610     <span class="comment">// ALWAYS returns STATUS_PENDING unless it fails.  Caller must</span>
01611     <span class="comment">// ALWAYS look in IoStatusBlock to see what happened.</span>
01612     <span class="comment">//</span>
01613     <span class="keywordflow">if</span> (NotifyBlock-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o7">NotifyPending</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01614         <a class="code" href="../../d1/d2/cmp_8h.html#a284">CmpPostNotify</a>(
01615             NotifyBlock,
01616             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01617             0,
01618             STATUS_NOTIFY_ENUM_DIR,
01619             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01620             );
01621         <span class="comment">//</span>
01622         <span class="comment">// return STATUS_SUCCESS to signal to the caller the the notify already been triggered</span>
01623         <span class="comment">//</span>
01624         <span class="keywordflow">return</span> STATUS_SUCCESS;
01625     }
01626 
01627     <span class="comment">//</span>
01628     <span class="comment">// return STATUS_PENDING to signal to the caller the the notify has not been triggered yet</span>
01629     <span class="comment">//</span>
01630     <span class="keywordflow">return</span> STATUS_PENDING;
01631 }
01632 
01633 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01634"></a><a class="code" href="../../d0/d2/cmnotify_8c.html#a4">01634</a> <a class="code" href="../../d0/d2/cmnotify_8c.html#a4">CmpFreeSlavePost</a>(
01635     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>  MasterPostBlock
01636     )
01637 <span class="comment">/*++</span>
01638 <span class="comment"></span>
01639 <span class="comment">Routine Description:</span>
01640 <span class="comment"></span>
01641 <span class="comment">        Free the slave post block related to this master post block</span>
01642 <span class="comment"></span>
01643 <span class="comment">Arguments:</span>
01644 <span class="comment"></span>
01645 <span class="comment">    MasterPostBlock - pointer to structure that describes the post requests.</span>
01646 <span class="comment">                It should be a master post!!</span>
01647 <span class="comment">Return Value:</span>
01648 <span class="comment"></span>
01649 <span class="comment">    NONE.</span>
01650 <span class="comment"></span>
01651 <span class="comment">--*/</span>
01652 {
01653     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>  SlavePostBlock;
01654 
01655     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01656     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a37">CMS_NOTIFY</a>) {
01657         KdPrint((<span class="stringliteral">"CmpCancelSlavePost:\t"</span>));
01658         KdPrint((<span class="stringliteral">"MasterPostBlock:%08lx\n"</span>, MasterPostBlock));
01659     }
01660 
01661     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a89">IsMasterPostBlock</a>(MasterPostBlock));
01662 
01663     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a37">CMS_NOTIFY</a>) {
01664 <span class="preprocessor">#if DBG</span>
01665 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(MasterPostBlock-&gt;TraceIntoDebugger) {
01666             KdPrint((<span class="stringliteral">"[CM]CmCancelSlavePost: MasterPostBlock:%08lx\n"</span>, MasterPostBlock));
01667         }
01668 <span class="preprocessor">#endif</span>
01669 <span class="preprocessor"></span>    }
01670 
01671     <span class="keywordflow">if</span> (IsListEmpty(&amp;(MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o2">CancelPostList</a>)) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01672         <span class="comment">//</span>
01673         <span class="comment">// Nothing to cancel, just return</span>
01674         <span class="comment">//</span>
01675         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a37">CMS_NOTIFY</a>) {
01676 <span class="preprocessor">#if DBG</span>
01677 <span class="preprocessor"></span>            <span class="keywordflow">if</span>(MasterPostBlock-&gt;TraceIntoDebugger) {
01678                 KdPrint((<span class="stringliteral">"[CM]CmCancelSlavePost: MasterPostBlock:%08lx has no slaves\n"</span>, MasterPostBlock));
01679             }
01680 <span class="preprocessor">#endif</span>
01681 <span class="preprocessor"></span>        }
01682 
01683         <span class="keywordflow">return</span>;
01684     }
01685 
01686 
01687     <span class="comment">//</span>
01688     <span class="comment">// Pull all the entries in the cancel post list and unlink them (when they are slave requests)</span>
01689     <span class="comment">// We base here on the assumption that there is only one slave.</span>
01690     <span class="comment">//</span>
01691     <span class="comment">//     NOTE!!!</span>
01692     <span class="comment">//       When more than slave allowed, here to modify</span>
01693     <span class="comment">//</span>
01694 
01695 
01696     SlavePostBlock = (<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>)MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o2">CancelPostList</a>.Flink;
01697     SlavePostBlock = CONTAINING_RECORD(SlavePostBlock,
01698                                        <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">CM_POST_BLOCK</a>,
01699                                        CancelPostList);
01700 
01701     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a37">CMS_NOTIFY</a>) {
01702 <span class="preprocessor">#if DBG</span>
01703 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(MasterPostBlock-&gt;TraceIntoDebugger) {
01704             KdPrint((<span class="stringliteral">"[CM]CmCancelSlavePost: Cleaning SlavePostBlock:%08lx\n"</span>, SlavePostBlock));
01705         }
01706 <span class="preprocessor">#endif</span>
01707 <span class="preprocessor"></span>    }
01708 
01709     <span class="comment">//</span>
01710     <span class="comment">// This should be true !</span>
01711     <span class="comment">//</span>
01712     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !<a class="code" href="../../d1/d2/cmp_8h.html#a89">IsMasterPostBlock</a>(SlavePostBlock) );
01713 
01714     <span class="comment">//</span>
01715     <span class="comment">// Unchain from the Master CancelPostList</span>
01716     <span class="comment">//</span>
01717     <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01718     <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(SlavePostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o2">CancelPostList</a>));
01719 
01720     <span class="comment">//</span>
01721     <span class="comment">// delist the post block from the thread postblocklist</span>
01722     <span class="comment">//</span>
01723     <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01724     <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(SlavePostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o1">ThreadList</a>));
01725 
01726     <span class="comment">//</span>
01727     <span class="comment">// Free the post block.</span>
01728     <span class="comment">//</span>
01729     <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(SlavePostBlock);
01730 
01731     <span class="comment">//</span>
01732     <span class="comment">// Result validation. was it the only slave?</span>
01733     <span class="comment">//</span>
01734     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IsListEmpty(&amp;(MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o2">CancelPostList</a>)));
01735 }
01736 
01737 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01738"></a><a class="code" href="../../d0/d2/cmnotify_8c.html#a3">01738</a> <a class="code" href="../../d0/d2/cmnotify_8c.html#a3">CmpCancelSlavePost</a>(
01739     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>  MasterPostBlock,
01740     PLIST_ENTRY     DelayedDeref
01741     )
01742 <span class="comment">/*++</span>
01743 <span class="comment"></span>
01744 <span class="comment">Routine Description:</span>
01745 <span class="comment"></span>
01746 <span class="comment">        Unlink the slave postblock from its notify list and dereferences (or adds to the delayed deref list)</span>
01747 <span class="comment">        the keybody related to this thread. This should disable the slave post block. </span>
01748 <span class="comment">        It will be cleared later in CmpPostApc.</span>
01749 <span class="comment"></span>
01750 <span class="comment">Arguments:</span>
01751 <span class="comment"></span>
01752 <span class="comment">    MasterPostBlock - pointer to structure that describes the post requests.</span>
01753 <span class="comment">                It should be a master post!!</span>
01754 <span class="comment">    DelayedDeref - pointer to list of delayed deref keybodies. If this parameter is not NULL,</span>
01755 <span class="comment">                the keybody for the slave is not cleared before calling CmpFreePostBlock, </span>
01756 <span class="comment">                and instead is added to the list</span>
01757 <span class="comment"></span>
01758 <span class="comment"></span>
01759 <span class="comment">Return Value:</span>
01760 <span class="comment"></span>
01761 <span class="comment">    NONE.</span>
01762 <span class="comment"></span>
01763 <span class="comment">--*/</span>
01764 {
01765     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>  SlavePostBlock;
01766 
01767     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01768     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a37">CMS_NOTIFY</a>) {
01769         KdPrint((<span class="stringliteral">"CmpCancelSlavePost:\t"</span>));
01770         KdPrint((<span class="stringliteral">"MasterPostBlock:%08lx\n"</span>, MasterPostBlock));
01771     }
01772 
01773     <a class="code" href="../../d1/d2/cmp_8h.html#a61">ASSERT_CM_LOCK_OWNED</a>();
01774 
01775     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a89">IsMasterPostBlock</a>(MasterPostBlock));
01776 
01777     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a37">CMS_NOTIFY</a>) {
01778 <span class="preprocessor">#if DBG</span>
01779 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(MasterPostBlock-&gt;TraceIntoDebugger) {
01780             KdPrint((<span class="stringliteral">"[CM]CmCancelSlavePost: MasterPostBlock:%08lx\n"</span>, MasterPostBlock));
01781         }
01782 <span class="preprocessor">#endif</span>
01783 <span class="preprocessor"></span>    }
01784 
01785     <span class="keywordflow">if</span> (IsListEmpty(&amp;(MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o2">CancelPostList</a>)) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01786         <span class="comment">//</span>
01787         <span class="comment">// Nothing to cancel, just return</span>
01788         <span class="comment">//</span>
01789         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a37">CMS_NOTIFY</a>) {
01790 <span class="preprocessor">#if DBG</span>
01791 <span class="preprocessor"></span>            <span class="keywordflow">if</span>(MasterPostBlock-&gt;TraceIntoDebugger) {
01792                 KdPrint((<span class="stringliteral">"[CM]CmCancelSlavePost: MasterPostBlock:%08lx has no slaves\n"</span>, MasterPostBlock));
01793             }
01794 <span class="preprocessor">#endif</span>
01795 <span class="preprocessor"></span>        }
01796 
01797         <span class="keywordflow">return</span>;
01798     }
01799 
01800 
01801     <span class="comment">//</span>
01802     <span class="comment">// Pull all the entries in the cancel post list and unlink them (when they are slave requests)</span>
01803     <span class="comment">// We base here on the assumption that there is only one slave.</span>
01804     <span class="comment">//</span>
01805     <span class="comment">//     NOTE!!!</span>
01806     <span class="comment">//       When more than slave allowed, here to modify</span>
01807     <span class="comment">//</span>
01808 
01809 
01810     SlavePostBlock = (<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>)MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o2">CancelPostList</a>.Flink;
01811     SlavePostBlock = CONTAINING_RECORD(SlavePostBlock,
01812                                        <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">CM_POST_BLOCK</a>,
01813                                        CancelPostList);
01814 
01815     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a37">CMS_NOTIFY</a>) {
01816 <span class="preprocessor">#if DBG</span>
01817 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(MasterPostBlock-&gt;TraceIntoDebugger) {
01818             KdPrint((<span class="stringliteral">"[CM]CmCancelSlavePost: Cleaning SlavePostBlock:%08lx\n"</span>, SlavePostBlock));
01819         }
01820 <span class="preprocessor">#endif</span>
01821 <span class="preprocessor"></span>    }
01822 
01823     <span class="comment">//</span>
01824     <span class="comment">// This should be true !</span>
01825     <span class="comment">//</span>
01826     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !<a class="code" href="../../d1/d2/cmp_8h.html#a89">IsMasterPostBlock</a>(SlavePostBlock) );
01827 
01828     <span class="comment">//</span>
01829     <span class="comment">// Remove it from notify block's list</span>
01830     <span class="comment">//</span>
01831     <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01832         <span class="comment">// This will disable the notifications that might come on the slave key</span>
01833         <span class="comment">//</span>
01834     <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(SlavePostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>));
01835 
01836     <span class="keywordflow">if</span>( DelayedDeref ) {
01837         <span class="comment">// </span>
01838         <span class="comment">// the caller wants to handle key body dereferenciation by himself</span>
01839         <span class="comment">//</span>
01840         <a class="code" href="../../d0/d2/cmnotify_8c.html#a5">CmpAddToDelayedDeref</a>(SlavePostBlock,DelayedDeref);
01841     }
01842 }
01843 
01844 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01845"></a><a class="code" href="../../d0/d2/cmnotify_8c.html#a5">01845</a> <a class="code" href="../../d0/d2/cmnotify_8c.html#a5">CmpAddToDelayedDeref</a>(
01846     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>  PostBlock,
01847     PLIST_ENTRY     DelayedDeref
01848     )
01849 <span class="comment">/*++</span>
01850 <span class="comment"></span>
01851 <span class="comment">Routine Description:</span>
01852 <span class="comment"></span>
01853 <span class="comment">    Add the key body attached to the post block to the delayed deref list.</span>
01854 <span class="comment">    Cleans the post block KeyBody member, so it will not be dereferenced </span>
01855 <span class="comment">    when the post block is freed.</span>
01856 <span class="comment"></span>
01857 <span class="comment">Arguments:</span>
01858 <span class="comment"></span>
01859 <span class="comment">    PostBlock - pointer to structure that describes the post requests.</span>
01860 <span class="comment"></span>
01861 <span class="comment">    DelayedDeref - the delayed deref list</span>
01862 <span class="comment"></span>
01863 <span class="comment">Return Value:</span>
01864 <span class="comment"></span>
01865 <span class="comment">    NONE.</span>
01866 <span class="comment"></span>
01867 <span class="comment">--*/</span>
01868 
01869 {
01870     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01871 
01872     <span class="comment">// common sense</span>
01873     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PostBlock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01874 
01875     <span class="keywordflow">if</span>( PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o3">PostKeyBody</a> ) {
01876         <span class="comment">//</span>
01877         <span class="comment">// If the post block has a keybody attached, add it to delayed deref list and </span>
01878         <span class="comment">// clear the post block member. The key body will be deref'd prior after </span>
01879         <span class="comment">// postblock lock is released.</span>
01880         <span class="comment">//</span>
01881     
01882         <span class="comment">// extra validation</span>
01883         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o3">PostKeyBody</a>-&gt;<a class="code" href="../../d6/d6/struct__CM__POST__KEY__BODY.html#o1">KeyBody</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01884         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DelayedDeref);
01885 
01886         <span class="comment">// add it to the end of the list</span>
01887         InsertTailList(
01888             DelayedDeref,
01889             &amp;(PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o3">PostKeyBody</a>-&gt;<a class="code" href="../../d6/d6/struct__CM__POST__KEY__BODY.html#o0">KeyBodyList</a>)
01890             );
01891     
01892         <span class="comment">// make sure we don't deref it in CmpFreePostBlock</span>
01893         PostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o3">PostKeyBody</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01894     }
01895 
01896     <span class="keywordflow">return</span>;
01897 }
01898 
01899 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01900"></a><a class="code" href="../../d0/d2/cmnotify_8c.html#a6">01900</a> <a class="code" href="../../d0/d2/cmnotify_8c.html#a6">CmpDelayedDerefKeys</a>(
01901                     PLIST_ENTRY DelayedDeref
01902                     )
01903 <span class="comment">/*++</span>
01904 <span class="comment"></span>
01905 <span class="comment">Routine Description:</span>
01906 <span class="comment"></span>
01907 <span class="comment">    Walk through the entire list, dereference each keybody and free storage for the </span>
01908 <span class="comment">    CM_POST_KEY_BODY allocated for this purpose.</span>
01909 <span class="comment"></span>
01910 <span class="comment">Arguments:</span>
01911 <span class="comment"></span>
01912 <span class="comment">    DelayedDeref - the delayed deref list</span>
01913 <span class="comment"></span>
01914 <span class="comment">Return Value:</span>
01915 <span class="comment"></span>
01916 <span class="comment">    NONE.</span>
01917 <span class="comment"></span>
01918 <span class="comment">--*/</span>
01919 {
01920     <a class="code" href="../../d6/d6/struct__CM__POST__KEY__BODY.html">PCM_POST_KEY_BODY</a>   PostKeyBody;
01921 
01922     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01923 
01924     <span class="comment">// common sense</span>
01925     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( DelayedDeref != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01926 
01927     <span class="keywordflow">while</span>(IsListEmpty(DelayedDeref) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01928         <span class="comment">//</span>
01929         <span class="comment">// Remove from the delayed deref list and deref the coresponding keybody</span>
01930         <span class="comment">// free the storage associated with CM_POST_KEY_BODY</span>
01931         <span class="comment">//</span>
01932         PostKeyBody = (<a class="code" href="../../d6/d6/struct__CM__POST__KEY__BODY.html">PCM_POST_KEY_BODY</a>)RemoveHeadList(DelayedDeref);
01933         PostKeyBody = CONTAINING_RECORD(PostKeyBody,
01934                                       <a class="code" href="../../d6/d6/struct__CM__POST__KEY__BODY.html">CM_POST_KEY_BODY</a>,
01935                                       KeyBodyList);
01936 
01937         <span class="comment">// extra validation</span>
01938         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PostKeyBody-&gt;<a class="code" href="../../d6/d6/struct__CM__POST__KEY__BODY.html#o1">KeyBody</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01939         <span class="comment">// this should be a valid key body</span>
01940         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PostKeyBody-&gt;<a class="code" href="../../d6/d6/struct__CM__POST__KEY__BODY.html#o1">KeyBody</a>-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o0">Type</a> == <a class="code" href="../../d1/d2/cmp_8h.html#a78">KEY_BODY_TYPE</a>);
01941         
01942         <span class="comment">// at last ..... dereference the key object</span>
01943         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(PostKeyBody-&gt;<a class="code" href="../../d6/d6/struct__CM__POST__KEY__BODY.html#o1">KeyBody</a>);
01944 
01945         <span class="comment">// Free the storage for the CM_POST_KEY_BODY object (allocated by CmpAllocatePostBlock)</span>
01946         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostKeyBody);
01947     }
01948 }
01949 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:28 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
