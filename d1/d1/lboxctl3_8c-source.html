<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: lboxctl3.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>lboxctl3.c</h1><a href="../../d0/d2/lboxctl3_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************************************************************\</span>
00002 <span class="comment">*</span>
00003 <span class="comment">*  LBOXCTL3.C -</span>
00004 <span class="comment">*</span>
00005 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00006 <span class="comment">*</span>
00007 <span class="comment">*      Directory List Box Routines</span>
00008 <span class="comment">*</span>
00009 <span class="comment">* ??-???-???? ianja    Ported from Win 3.0 sources</span>
00010 <span class="comment">* 14-Feb-1991 mikeke   Added Revalidation code</span>
00011 <span class="comment">\****************************************************************************/</span>
00012 
<a name="l00013"></a><a class="code" href="../../d0/d2/lboxctl3_8c.html#a0">00013</a> <span class="preprocessor">#define CTLMGR</span>
<a name="l00014"></a><a class="code" href="../../d0/d2/lboxctl3_8c.html#a1">00014</a> <span class="preprocessor"></span><span class="preprocessor">#define LSTRING</span>
00015 <span class="preprocessor"></span>
00016 <span class="preprocessor">#include "<a class="code" href="../../d7/d3/w32_2ntuser_2client_2precomp_8h.html">precomp.h</a>"</span>
00017 <span class="preprocessor">#pragma hdrstop</span>
00018 <span class="preprocessor"></span>
<a name="l00019"></a><a class="code" href="../../d0/d2/lboxctl3_8c.html#a2">00019</a> <span class="preprocessor">#define DATESEPARATOR TEXT('-')</span>
<a name="l00020"></a><a class="code" href="../../d0/d2/lboxctl3_8c.html#a3">00020</a> <span class="preprocessor"></span><span class="preprocessor">#define TIMESEPARATOR  TEXT(':')</span>
<a name="l00021"></a><a class="code" href="../../d0/d2/lboxctl3_8c.html#a4">00021</a> <span class="preprocessor"></span><span class="preprocessor">#define TABCHAR        TEXT('\t')</span>
00022 <span class="preprocessor"></span>
<a name="l00023"></a><a class="code" href="../../d0/d2/lboxctl3_8c.html#a5">00023</a> <span class="preprocessor">#define MAXDIGITSINSIZE 9</span>
00024 <span class="preprocessor"></span>
00025 <span class="keywordtype">void</span> <a class="code" href="../../d0/d2/lboxctl3_8c.html#a22">LB_CreateLBLine</a>(LPWIN32_FIND_DATA, LPWSTR);
00026 
<a name="l00027"></a><a class="code" href="../../d0/d2/lboxctl3_8c.html#a6">00027</a> <span class="preprocessor">#define DDL_PRIVILEGES  (DDL_READONLY | DDL_HIDDEN | DDL_SYSTEM | DDL_ARCHIVE)</span>
<a name="l00028"></a><a class="code" href="../../d0/d2/lboxctl3_8c.html#a7">00028</a> <span class="preprocessor"></span><span class="preprocessor">#define DDL_TYPE        (DDL_DRIVES | DDL_DIRECTORY | DDL_POSTMSGS)</span>
00029 <span class="preprocessor"></span>
00030 <span class="comment">/***************************************************************************\</span>
00031 <span class="comment">* ChopText</span>
00032 <span class="comment">*</span>
00033 <span class="comment">* Chops the given path at 'lpchBuffer' + CCH_CHOPTEXT_EXTRA to fit in the</span>
00034 <span class="comment">* field of the static control with id 'idStatic' in the dialog box 'hwndDlg'.</span>
00035 <span class="comment">* If the path is too long, an ellipsis prefix is added to the beginning of the</span>
00036 <span class="comment">* chopped text ("x:\...\")</span>
00037 <span class="comment">*</span>
00038 <span class="comment">* If the supplied path does not fit and the last directory appended to</span>
00039 <span class="comment">* ellipsis (i.e. "c:\...\eee" in the case of "c:\aaa\bbb\ccc\ddd\eee")</span>
00040 <span class="comment">* does not fit, then "x:\..." is returned.</span>
00041 <span class="comment">*</span>
00042 <span class="comment">* Pathological case:</span>
00043 <span class="comment">* "c:\SW\MW\R2\LIB\SERVICES\NT" almost fits into static control, while</span>
00044 <span class="comment">* "c:\...\MW\R2\LIB\SERVICES\NT" does fit - although it is more characters.</span>
00045 <span class="comment">* In this case, ChopText substitutes the first 'n' characters of the path with</span>
00046 <span class="comment">* a prefix containing MORE than 'n' characters!  The extra characters will</span>
00047 <span class="comment">* be put in front of lpch, so there must be space reserved for them or they</span>
00048 <span class="comment">* will trash the stack.  lpch contains CCH_CHOPTEXT_EXTRA chars followed by</span>
00049 <span class="comment">* the path.</span>
00050 <span class="comment">*</span>
00051 <span class="comment">* History:</span>
00052 <span class="comment">\***************************************************************************/</span>
00053 
00054 <span class="comment">/*</span>
00055 <span class="comment"> * In practice CCH_CHOPTEXT_EXTRA probably never has to be more than 1 or 2,</span>
00056 <span class="comment"> * but in case the font is weird, set it to the number of chars in the prefix.</span>
00057 <span class="comment"> * This guarantees enough space to prepend the prefix.</span>
00058 <span class="comment"> */</span>
<a name="l00059"></a><a class="code" href="../../d0/d2/lboxctl3_8c.html#a8">00059</a> <span class="preprocessor">#define CCH_CHOPTEXT_EXTRA 7</span>
00060 <span class="preprocessor"></span>
<a name="l00061"></a><a class="code" href="../../d0/d2/lboxctl3_8c.html#a13">00061</a> LPWSTR <a class="code" href="../../d0/d2/lboxctl3_8c.html#a13">ChopText</a>(
00062     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndDlg,
00063     <span class="keywordtype">int</span> idStatic,
00064     LPWSTR lpchBuffer)
00065 {
00066 <span class="preprocessor">#define AWCHLEN(a) ((sizeof(a)/sizeof(a[0])) - 1)</span>
00067 <span class="preprocessor"></span>
00068     <span class="comment">/*</span>
00069 <span class="comment">     * Declaring szPrefix this way ensures CCH_CHOPTEXT_EXTRA is big enough</span>
00070 <span class="comment">     */</span>
00071     WCHAR szPrefix[<a class="code" href="../../d0/d2/lboxctl3_8c.html#a8">CCH_CHOPTEXT_EXTRA</a> + 1] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"x:\\...\\"</span>;
00072     <span class="keywordtype">int</span> cxField;
00073     RECT rc;
00074     SIZE size;
00075     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndStatic;
00076     <a class="code" href="../../d1/d7/structtagSTAT.html">PSTAT</a> pstat;
00077     HDC hdc;
00078     HFONT hOldFont;
00079     <span class="keywordtype">int</span> cchPath;
00080     PWCHAR lpch;
00081     PWCHAR lpchPath;
00082 
00083     <span class="comment">/*</span>
00084 <span class="comment">     * Get length of static field.</span>
00085 <span class="comment">     */</span>
00086     pwndStatic = <a class="code" href="../../d3/d9/client_2wow_8c.html#a5">_GetDlgItem</a>(pwndDlg, idStatic);
00087     <span class="keywordflow">if</span> (pwndStatic == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00088         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00089 
00090     <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a19">_GetClientRect</a>(pwndStatic, &amp;rc);
00091     cxField = rc.right - rc.left;
00092 
00093     <span class="comment">/*</span>
00094 <span class="comment">     * Set up DC appropriately for the static control.</span>
00095 <span class="comment">     */</span>
00096     hdc = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a250">NtUserGetDC</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwndStatic));
00097 
00098     <span class="comment">/*</span>
00099 <span class="comment">     * Only assume this is a static window if this window uses the static</span>
00100 <span class="comment">     * window wndproc.</span>
00101 <span class="comment">     */</span>
00102     hOldFont = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00103     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwndStatic) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a207">FNID_STATIC</a>) {
00104         pstat = ((<a class="code" href="../../d3/d7/structtagSTATWND.html">PSTATWND</a>)pwndStatic)-&gt;pstat;
00105         <span class="keywordflow">if</span> (pstat != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pstat != (<a class="code" href="../../d1/d7/structtagSTAT.html">PSTAT</a>)-1 &amp;&amp; pstat-&gt;<a class="code" href="../../d1/d7/structtagSTAT.html#o1">hFont</a>)
00106             hOldFont = SelectObject(hdc, pstat-&gt;<a class="code" href="../../d1/d7/structtagSTAT.html#o1">hFont</a>);
00107     }
00108 
00109     <span class="comment">/*</span>
00110 <span class="comment">     * Check horizontal extent of string.</span>
00111 <span class="comment">     */</span>
00112     lpch = lpchPath = lpchBuffer + <a class="code" href="../../d0/d2/lboxctl3_8c.html#a8">CCH_CHOPTEXT_EXTRA</a>;
00113     cchPath = wcslen(lpchPath);
00114     GetTextExtentPoint(hdc, lpchPath, cchPath, &amp;size);
00115     <span class="keywordflow">if</span> (size.cx &gt; cxField) {
00116 
00117         <span class="comment">/*</span>
00118 <span class="comment">         * String is too long to fit in the static control; chop it.</span>
00119 <span class="comment">         * Set up new prefix and determine remaining space in control.</span>
00120 <span class="comment">         */</span>
00121         szPrefix[0] = *lpchPath;
00122         GetTextExtentPoint(hdc, szPrefix, <a class="code" href="../../d0/d2/lboxctl3_8c.html#a9">AWCHLEN</a>(szPrefix), &amp;size);
00123 
00124         <span class="comment">/*</span>
00125 <span class="comment">         * If the field is too small to display all of the prefix,</span>
00126 <span class="comment">         * copy only the prefix.</span>
00127 <span class="comment">         */</span>
00128         <span class="keywordflow">if</span> (cxField &lt; size.cx) {
00129             RtlCopyMemory(lpch, szPrefix, <span class="keyword">sizeof</span>(szPrefix));
00130             <span class="keywordflow">goto</span> DoneChop;
00131         } <span class="keywordflow">else</span>
00132             cxField -= size.cx;
00133 
00134         <span class="comment">/*</span>
00135 <span class="comment">         * Advance a directory at a time until the remainder of the</span>
00136 <span class="comment">         * string fits into the static control after the "x:\...\" prefix.</span>
00137 <span class="comment">         */</span>
00138         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00139             <span class="keywordtype">int</span> cchT;
00140             <span class="keywordflow">while</span> (*lpch &amp;&amp; (*lpch++ != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>)) {
00141                 ;
00142             }
00143             cchT = cchPath - (<span class="keywordtype">int</span>)(lpch - lpchPath);
00144             GetTextExtentPoint(hdc, lpch, cchT, &amp;size);
00145             <span class="keywordflow">if</span> (*lpch == 0 || size.cx &lt;= cxField) {
00146 
00147                 <span class="keywordflow">if</span> (*lpch == 0) {
00148 
00149                     <span class="comment">/*</span>
00150 <span class="comment">                     * Nothing could fit after the prefix; remove the</span>
00151 <span class="comment">                     * final "\" from the prefix</span>
00152 <span class="comment">                     */</span>
00153                     szPrefix[<a class="code" href="../../d0/d2/lboxctl3_8c.html#a9">AWCHLEN</a>(szPrefix) - 1] = 0;
00154                 }
00155 
00156                 <span class="comment">/*</span>
00157 <span class="comment">                 * rest of string fits -- back up and stick prefix on front</span>
00158 <span class="comment">                 * We are guaranteed to have at least CCH_CHOPTEXT_EXTRA chars</span>
00159 <span class="comment">                 * backing up space, so we won't trash any stack. #26453</span>
00160 <span class="comment">                 */</span>
00161                 lpch -= <a class="code" href="../../d0/d2/lboxctl3_8c.html#a9">AWCHLEN</a>(szPrefix);
00162 
00163                 UserAssert(lpch &gt;= lpchBuffer);
00164 
00165                 RtlCopyMemory(lpch, szPrefix, <span class="keyword">sizeof</span>(szPrefix) - <span class="keyword">sizeof</span>(WCHAR));
00166                 <span class="keywordflow">goto</span> DoneChop;
00167             }
00168         }
00169     }
00170 
00171 DoneChop:
00172     <span class="keywordflow">if</span> (hOldFont)
00173         SelectObject(hdc, hOldFont);
00174 
00175     <a class="code" href="../../d3/d8/client_8c.html#a45">ReleaseDC</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwndStatic), hdc);
00176 
00177     <span class="keywordflow">return</span> lpch;
00178 }
00179 
00180 
00181 <span class="comment">/***************************************************************************\</span>
00182 <span class="comment">* xxxDlgDirListHelper</span>
00183 <span class="comment">*</span>
00184 <span class="comment">*  NOTE:  If idStaticPath is &lt; 0, then that parameter contains the details</span>
00185 <span class="comment">*         about what should be in each line of the list box</span>
00186 <span class="comment">*</span>
00187 <span class="comment">* History:</span>
00188 <span class="comment">\***************************************************************************/</span>
00189 
<a name="l00190"></a><a class="code" href="../../d6/d0/usercli_8h.html#a735">00190</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d0/usercli_8h.html#a735">xxxDlgDirListHelper</a>(
00191     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndDlg,
00192     LPWSTR lpszPathSpec,
00193     LPBYTE lpszPathSpecClient,
00194     <span class="keywordtype">int</span> idListBox,
00195     <span class="keywordtype">int</span> idStaticPath,
00196     UINT attrib,
00197     BOOL fListBox)  <span class="comment">/* Listbox or ComboBox? */</span>
00198 {
00199     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndLB;
00200     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndLB;
00201     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fDir = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00202     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRoot, bRet;
00203     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fPostIt;
00204     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>   cch;
00205     WCHAR ch;
00206     WCHAR szStaticPath[<a class="code" href="../../d0/d2/lboxctl3_8c.html#a8">CCH_CHOPTEXT_EXTRA</a> + <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00207     PWCHAR pszCurrentDir;
00208     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> wDirMsg;
00209     LPWSTR lpchFile;
00210     LPWSTR lpchDirectory;
00211     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb;
00212     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fWasVisible = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00213     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fWin40Compat;
00214     <a class="code" href="../../d7/d9/structtagCBox.html">PCBOX</a> pcbox;
00215 
00216     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndDlg);
00217 
00218     <span class="comment">/*</span>
00219 <span class="comment">     * Strip the private bit DDL_NOFILES out - KidPix passes it in my mistake!</span>
00220 <span class="comment">     */</span>
00221     <span class="keywordflow">if</span> (attrib &amp; ~DDL_VALID) {
00222         RIPERR2(ERROR_INVALID_FLAGS, RIP_WARNING, <span class="stringliteral">"Invalid flags, %x &amp; ~%x != 0"</span>,
00223               attrib, DDL_VALID);
00224         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00225     }
00226 
00227     <span class="keywordflow">if</span> (attrib &amp; DDL_NOFILES) {
00228         RIPMSG0(RIP_WARNING, <span class="stringliteral">"DlgDirListHelper: stripping DDL_NOFILES"</span>);
00229         attrib &amp;= ~DDL_NOFILES;
00230     }
00231 
00232     <span class="comment">/*</span>
00233 <span class="comment">     * Case:Works is an app that calls DlgDirList with a NULL has hwndDlg;</span>
00234 <span class="comment">     * This is allowed because he uses NULL for idStaticPath and idListBox.</span>
00235 <span class="comment">     * So, the validation layer has been modified to allow a NULL for hwndDlg.</span>
00236 <span class="comment">     * But, we catch the bad apps with the following check.</span>
00237 <span class="comment">     * Fix for Bug #11864 --SANKAR-- 08/22/91 --</span>
00238 <span class="comment">     */</span>
00239     <span class="keywordflow">if</span> (!pwndDlg &amp;&amp; (idStaticPath || idListBox)) {
00240         RIPERR0(ERROR_INVALID_PARAMETER, RIP_VERBOSE, <span class="stringliteral">""</span>);
00241         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00242     }
00243 
00244     plb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00245 
00246     <span class="comment">/*</span>
00247 <span class="comment">     * Do we need to add date, time, size or attribute info?</span>
00248 <span class="comment">     * Windows checks the Atom but misses if the class has been sub-classed</span>
00249 <span class="comment">     * as in VB.</span>
00250 <span class="comment">     */</span>
00251     <span class="keywordflow">if</span> (pwndLB = (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)<a class="code" href="../../d3/d9/client_2wow_8c.html#a5">_GetDlgItem</a>(pwndDlg, idListBox)) {
00252         WORD fnid = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwndLB);
00253 
00254         <span class="keywordflow">if</span> ((fnid == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a205">FNID_LISTBOX</a> &amp;&amp; fListBox) ||
00255                 (fnid == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a201">FNID_COMBOBOX</a> &amp;&amp; !fListBox) ||
00256                 (fnid == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a202">FNID_COMBOLISTBOX</a> &amp;&amp; fListBox)) {
00257             <span class="keywordflow">if</span> (fListBox) {
00258                 plb = ((<a class="code" href="../../d9/d9/structtagLBWND.html">PLBWND</a>)pwndLB)-&gt;pLBIV;
00259             } <span class="keywordflow">else</span> {
00260 
00261                 pcbox = ((<a class="code" href="../../d0/d1/structtagCOMBOWND.html">PCOMBOWND</a>)pwndLB)-&gt;pcbox;
00262                 plb = ((<a class="code" href="../../d9/d9/structtagLBWND.html">PLBWND</a>)(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>))-&gt;pLBIV;
00263             }
00264         } <span class="keywordflow">else</span> {
00265             RIPERR0(ERROR_LISTBOX_ID_NOT_FOUND, RIP_VERBOSE, <span class="stringliteral">""</span>);
00266         }
00267     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (idListBox != 0) {
00268 
00269         <span class="comment">/*</span>
00270 <span class="comment">         * Yell if the app passed an invalid list box id and keep from using a</span>
00271 <span class="comment">         * bogus plb.  PLB is NULLed above.</span>
00272 <span class="comment">         */</span>
00273         RIPERR0(ERROR_LISTBOX_ID_NOT_FOUND, RIP_VERBOSE, <span class="stringliteral">""</span>);
00274     }
00275 
00276     <span class="keywordflow">if</span> (idStaticPath &lt; 0 &amp;&amp; plb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00277 
00278         <span class="comment">/*</span>
00279 <span class="comment">         * Clear idStaticPath because its purpose is over.</span>
00280 <span class="comment">         */</span>
00281         idStaticPath = 0;
00282 
00283     }
00284 
00285     fPostIt = (attrib &amp; DDL_POSTMSGS);
00286 
00287     <span class="keywordflow">if</span> (lpszPathSpec) {
00288         cch = lstrlenW(lpszPathSpec);
00289         <span class="keywordflow">if</span> (!cch) {
00290             <span class="keywordflow">if</span> (lpszPathSpecClient != (LPBYTE)lpszPathSpec) {
00291                 lpszPathSpecClient = <a class="code" href="../../d1/d8/clglobal_8c.html#a3">achSlashStar</a>;
00292             }
00293             lpszPathSpec = <a class="code" href="../../d1/d8/clglobal_8c.html#a2">awchSlashStar</a>;
00294         } <span class="keywordflow">else</span> {
00295             <span class="comment">/*</span>
00296 <span class="comment">             * Make sure we won't overflow our buffers...</span>
00297 <span class="comment">             */</span>
00298             <span class="keywordflow">if</span> (cch &gt; <a class="code" href="../../d6/d0/usercli_8h.html#a135">CCHFILEMAX</a>)
00299                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00300 
00301             <span class="comment">/*</span>
00302 <span class="comment">             * Convert lpszPathSpec into an upper case, OEM string.</span>
00303 <span class="comment">             */</span>
00304             CharUpper(lpszPathSpec);
00305             lpchDirectory = lpszPathSpec;
00306 
00307             lpchFile = <a class="code" href="../../d1/d8/clglobal_8c.html#a15">szSLASHSTARDOTSTAR</a> + 1;
00308 
00309             <span class="keywordflow">if</span> (*lpchDirectory) {
00310 
00311                 cch = wcslen(lpchDirectory);
00312 
00313                 <span class="comment">/*</span>
00314 <span class="comment">                 * If the directory name has a * or ? in it, don't bother trying</span>
00315 <span class="comment">                 * the (slow) SetCurrentDirectory.</span>
00316 <span class="comment">                 */</span>
00317                 <span class="keywordflow">if</span> (((<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)<a class="code" href="../../d1/d5/w32_2ntuser_2rtl_2random_8c.html#a1">FindCharPosition</a>(lpchDirectory, TEXT(<span class="charliteral">'*'</span>)) != cch) ||
00318                     ((<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)<a class="code" href="../../d1/d5/w32_2ntuser_2rtl_2random_8c.html#a1">FindCharPosition</a>(lpchDirectory, TEXT(<span class="charliteral">'?'</span>)) != cch) ||
00319                     !SetCurrentDirectory(lpchDirectory)) {
00320 
00321                     <span class="comment">/*</span>
00322 <span class="comment">                     * Set 'fDir' and 'fRoot' accordingly.</span>
00323 <span class="comment">                     */</span>
00324                     lpchFile = lpchDirectory + cch;
00325                     fDir = *(lpchFile - 1) == TEXT(<span class="charliteral">'\\'</span>);
00326                     fRoot = 0;
00327                     <span class="keywordflow">while</span> (cch--) {
00328                         ch = *(lpchFile - 1);
00329                         <span class="keywordflow">if</span> (ch == TEXT(<span class="charliteral">'*'</span>) || ch == TEXT(<span class="charliteral">'?'</span>))
00330                             fDir = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00331 
00332                         <span class="keywordflow">if</span> (ch == TEXT(<span class="charliteral">'\\'</span>) || ch == TEXT(<span class="charliteral">'/'</span>) || ch == TEXT(<span class="charliteral">':'</span>)) {
00333                             fRoot = (cch == 0 || *(lpchFile - 2) == TEXT(<span class="charliteral">':'</span>) ||
00334                                     (ch == TEXT(<span class="charliteral">':'</span>)));
00335                             <span class="keywordflow">break</span>;
00336                         }
00337                         lpchFile--;
00338                     }
00339 
00340                     <span class="comment">/*</span>
00341 <span class="comment">                     * To remove Bug #16, the following error return is to be removed.</span>
00342 <span class="comment">                     * In order to prevent the existing apps from breaking up, it is</span>
00343 <span class="comment">                     * decided that the bug will not be fixed and will be mentioned</span>
00344 <span class="comment">                     * in the documentation.</span>
00345 <span class="comment">                     * --SANKAR-- Sep 21</span>
00346 <span class="comment">                     */</span>
00347 
00348                     <span class="comment">/*</span>
00349 <span class="comment">                     * If no wildcard characters, return error.</span>
00350 <span class="comment">                     */</span>
00351                     <span class="keywordflow">if</span> (!fDir) {
00352                         RIPERR0(ERROR_NO_WILDCARD_CHARACTERS, RIP_VERBOSE, <span class="stringliteral">""</span>);
00353                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00354                     }
00355 
00356                     <span class="comment">/*</span>
00357 <span class="comment">                     * Special case for lpchDirectory == "\"</span>
00358 <span class="comment">                     */</span>
00359                     <span class="keywordflow">if</span> (fRoot)
00360                         lpchFile++;
00361 
00362                     <span class="comment">/*</span>
00363 <span class="comment">                     * Do we need to change directories?</span>
00364 <span class="comment">                     */</span>
00365                     <span class="keywordflow">if</span> (fRoot || cch &gt;= 0) {
00366 
00367                         <span class="comment">/*</span>
00368 <span class="comment">                         * Replace the Filename's first char with a nul.</span>
00369 <span class="comment">                         */</span>
00370                         ch = *--lpchFile;
00371                         *lpchFile = TEXT(<span class="charliteral">'\0'</span>);
00372 
00373                         <span class="comment">/*</span>
00374 <span class="comment">                         * Change the current directory.</span>
00375 <span class="comment">                         */</span>
00376                         <span class="keywordflow">if</span> (*lpchDirectory) {
00377                             bRet = SetCurrentDirectory(lpchDirectory);
00378                             <span class="keywordflow">if</span> (!bRet) {
00379 
00380                                 <span class="comment">/*</span>
00381 <span class="comment">                                 * Restore the filename before we return...</span>
00382 <span class="comment">                                 */</span>
00383                                 *((LPWSTR)lpchFile)++ = ch;
00384                                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00385                             }
00386                         }
00387 
00388                         <span class="comment">/*</span>
00389 <span class="comment">                         * Restore the filename's first character.</span>
00390 <span class="comment">                         */</span>
00391                         *lpchFile++ = ch;
00392                     }
00393 
00394                     <span class="comment">/*</span>
00395 <span class="comment">                     * Undo damage caused by special case above.</span>
00396 <span class="comment">                     */</span>
00397                     <span class="keywordflow">if</span> (fRoot) {
00398                         lpchFile--;
00399                     }
00400                 }
00401             }
00402 
00403             <span class="comment">/*</span>
00404 <span class="comment">             * This is copying on top of the data the client passed us! Since</span>
00405 <span class="comment">             * the LB_DIR or CB_DIR could be posted, and since we need to</span>
00406 <span class="comment">             * pass a client side string pointer when we do that, we need</span>
00407 <span class="comment">             * to copy this new data back to the client!</span>
00408 <span class="comment">             */</span>
00409             <span class="keywordflow">if</span> (fPostIt &amp;&amp; lpszPathSpecClient != (LPBYTE)lpszPathSpec) {
00410                 WCSToMB(lpchFile, -1, &amp;lpszPathSpecClient, MAXLONG, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00411             }
00412             wcscpy(lpszPathSpec, lpchFile);
00413         }
00414     }
00415     <span class="comment">/*</span>
00416 <span class="comment">     * In some cases, the ChopText requires extra space ahead of the path:</span>
00417 <span class="comment">     * Give it CCH_CHOPTEXT_EXTRA extra spaces. (See ChopText() above).</span>
00418 <span class="comment">     */</span>
00419     pszCurrentDir = szStaticPath + <a class="code" href="../../d0/d2/lboxctl3_8c.html#a8">CCH_CHOPTEXT_EXTRA</a>;
00420     GetCurrentDirectory(
00421             <span class="keyword">sizeof</span>(szStaticPath)/<span class="keyword">sizeof</span>(WCHAR) - <a class="code" href="../../d0/d2/lboxctl3_8c.html#a8">CCH_CHOPTEXT_EXTRA</a>,
00422             pszCurrentDir);
00423 
00424     <span class="comment">/*</span>
00425 <span class="comment">     * If we have a listbox, lock it down</span>
00426 <span class="comment">     */</span>
00427     <span class="keywordflow">if</span> (pwndLB != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00428         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwndLB, &amp;tlpwndLB);
00429     }
00430 
00431     <span class="comment">/*</span>
00432 <span class="comment">     * Fill in the static path item.</span>
00433 <span class="comment">     */</span>
00434     <span class="keywordflow">if</span> (idStaticPath) {
00435 
00436         <span class="comment">/*</span>
00437 <span class="comment">         * To fix a bug OemToAnsi() call is inserted; SANKAR--Sep 16th</span>
00438 <span class="comment">         */</span>
00439 <span class="comment">// OemToChar(szCurrentDir, szCurrentDir);</span>
00440         CharLower(pszCurrentDir);
00441         <a class="code" href="../../d5/d9/cltxt_8h.html#a20">SetDlgItemText</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwndDlg), idStaticPath, <a class="code" href="../../d0/d2/lboxctl3_8c.html#a13">ChopText</a>(pwndDlg, idStaticPath, szStaticPath));
00442     }
00443 
00444     <span class="comment">/*</span>
00445 <span class="comment">     * Fill in the directory List/ComboBox if it exists.</span>
00446 <span class="comment">     */</span>
00447     <span class="keywordflow">if</span> (idListBox &amp;&amp; pwndLB != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00448 
00449         HWND hwndLB = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwndLB);
00450 
00451         wDirMsg = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(fListBox ? LB_RESETCONTENT : CB_RESETCONTENT);
00452 
00453         <span class="keywordflow">if</span> (fPostIt) {
00454             <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(hwndLB, wDirMsg, 0, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00455         } <span class="keywordflow">else</span> {
00456             <span class="keywordflow">if</span> (plb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; (fWasVisible = <a class="code" href="../../d6/d0/usercli_8h.html#a108">IsLBoxVisible</a>(plb))) {
00457                 <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hwndLB, WM_SETREDRAW, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00458             }
00459             <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hwndLB, wDirMsg, 0, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00460         }
00461 
00462         wDirMsg = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(fListBox ? LB_DIR : CB_DIR);
00463 
00464         <span class="keywordflow">if</span> (attrib == DDL_DRIVES)
00465             attrib |= DDL_EXCLUSIVE;
00466 
00467         <span class="comment">//</span>
00468         <span class="comment">// Hack for DDL_EXCLUSIVE to REALLY work.</span>
00469         <span class="comment">//</span>
00470         fWin40Compat = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndLB, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>);
00471 
00472         <span class="comment">//</span>
00473         <span class="comment">// BACKWARDS COMPATIBILITY HACK</span>
00474         <span class="comment">//</span>
00475         <span class="comment">// We want DDL_EXCLUSIVE to _really_ work for new apps.  I.E., we</span>
00476         <span class="comment">// want apps to be able to specify DDL_DRIVES/DDL_VOLUMES with</span>
00477         <span class="comment">// DDL_EXCLUSIVE and privilege bits -- and have only those items</span>
00478         <span class="comment">// matching show up, w/out files.</span>
00479         <span class="comment">//</span>
00480         <span class="keywordflow">if</span> (attrib &amp; DDL_EXCLUSIVE)
00481         {
00482             <span class="keywordflow">if</span> (fWin40Compat)
00483             {
00484                 <span class="keywordflow">if</span> (attrib &amp; (DDL_DRIVES | DDL_DIRECTORY))
00485                     attrib |= DDL_NOFILES;
00486             }
00487             <span class="keywordflow">else</span>
00488             {
00489                 <span class="keywordflow">if</span> (attrib == (DDL_DRIVES | DDL_EXCLUSIVE))
00490                     attrib |= DDL_NOFILES;
00491             }
00492         }
00493 
00494         <span class="keywordflow">if</span> (!(attrib &amp; DDL_NOFILES)) {
00495 
00496             <span class="comment">/*</span>
00497 <span class="comment">             * Add everything except the subdirectories and disk drives.</span>
00498 <span class="comment">             */</span>
00499             <span class="keywordflow">if</span> (fPostIt) {
00500                 <span class="comment">/*</span>
00501 <span class="comment">                 * Post lpszPathSpecClient, the client side pointer.</span>
00502 <span class="comment">                 */</span>
00503 <span class="preprocessor">#ifdef WASWIN31</span>
00504 <span class="preprocessor"></span>                <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(hwndLB, wDirMsg, attrib &amp;
00505                         ~(DDL_DIRECTORY | DDL_DRIVES | DDL_POSTMSGS),
00506                         (LPARAM)lpszPathSpecClient);
00507 <span class="preprocessor">#else</span>
00508 <span class="preprocessor"></span>                <span class="comment">/*</span>
00509 <span class="comment">                 * On NT, keep DDL_POSTMSGS in wParam because we need to know</span>
00510 <span class="comment">                 * in the wndproc whether the pointer is clientside or server</span>
00511 <span class="comment">                 * side.</span>
00512 <span class="comment">                 */</span>
00513                 <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(hwndLB, wDirMsg,
00514                         attrib &amp; ~(DDL_DIRECTORY | DDL_DRIVES),
00515                         (LPARAM)lpszPathSpecClient);
00516 <span class="preprocessor">#endif</span>
00517 <span class="preprocessor"></span>
00518             } <span class="keywordflow">else</span> {
00519 
00520                 <span class="comment">/*</span>
00521 <span class="comment">                 * IanJa: #ifndef WIN16 (32-bit Windows), attrib gets extended</span>
00522 <span class="comment">                 * to LONG wParam automatically by the compiler</span>
00523 <span class="comment">                 */</span>
00524                 <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hwndLB, wDirMsg,
00525                         attrib &amp; ~(DDL_DIRECTORY | DDL_DRIVES),
00526                         (LPARAM)lpszPathSpec);
00527             }
00528 
00529 <span class="preprocessor">#ifdef WASWIN31</span>
00530 <span class="preprocessor"></span>            <span class="comment">/*</span>
00531 <span class="comment">             * Strip out just the subdirectory and drive bits.</span>
00532 <span class="comment">             */</span>
00533             attrib &amp;= (DDL_DIRECTORY | DDL_DRIVES);
00534 <span class="preprocessor">#else</span>
00535 <span class="preprocessor"></span>            <span class="comment">//</span>
00536             <span class="comment">// B#1433</span>
00537             <span class="comment">// The old code stripped out read-only, hidden, system, and archive</span>
00538             <span class="comment">// information for subdirectories, making it impossible to have</span>
00539             <span class="comment">// a listbox w/ hidden directories!</span>
00540             <span class="comment">//</span>
00541 
00542             <span class="comment">/*</span>
00543 <span class="comment">             * Strip out just the subdirectory and drive bits. ON NT, keep</span>
00544 <span class="comment">             * the DDL_POSTMSG bit so we know how to thunk this message.</span>
00545 <span class="comment">             */</span>
00546             <span class="keywordflow">if</span> (!fWin40Compat)
00547                 attrib &amp;= <a class="code" href="../../d0/d2/lboxctl3_8c.html#a7">DDL_TYPE</a>;
00548             <span class="keywordflow">else</span>
00549             {
00550                 attrib &amp;= (<a class="code" href="../../d0/d2/lboxctl3_8c.html#a7">DDL_TYPE</a> | (attrib &amp; <a class="code" href="../../d0/d2/lboxctl3_8c.html#a6">DDL_PRIVILEGES</a>));
00551                 attrib |= DDL_NOFILES;
00552             }
00553 <span class="comment">//            attrib &amp;= (DDL_DIRECTORY | DDL_DRIVES | DDL_POSTMSGS);</span>
00554 <span class="preprocessor">#endif</span>
00555 <span class="preprocessor"></span>        }
00556 
00557         <span class="comment">//</span>
00558         <span class="comment">// Add directories and volumes to the listbox.</span>
00559         <span class="comment">//</span>
00560         <span class="keywordflow">if</span> (attrib &amp; <a class="code" href="../../d0/d2/lboxctl3_8c.html#a7">DDL_TYPE</a>) {
00561 
00562             <span class="comment">/*</span>
00563 <span class="comment">             * Add the subdirectories and disk drives.</span>
00564 <span class="comment">             */</span>
00565             lpszPathSpec = <a class="code" href="../../d1/d8/clglobal_8c.html#a15">szSLASHSTARDOTSTAR</a> + 1;
00566 
00567             attrib |= DDL_EXCLUSIVE;
00568 
00569             <span class="keywordflow">if</span> (fPostIt) {
00570                 <span class="comment">/*</span>
00571 <span class="comment">                 * Post lpszPathSpecClient, the client side pointer (see text</span>
00572 <span class="comment">                 * above).</span>
00573 <span class="comment">                 */</span>
00574                 <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(hwndLB, wDirMsg, attrib, (LPARAM)lpszPathSpecClient);
00575             } <span class="keywordflow">else</span> {
00576                 <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hwndLB, wDirMsg, attrib, (LPARAM)lpszPathSpec);
00577             }
00578         }
00579 
00580         <span class="keywordflow">if</span> (!fPostIt &amp;&amp; fWasVisible) {
00581             <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hwndLB, WM_SETREDRAW, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00582             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a206">NtUserInvalidateRect</a>(hwndLB, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00583         }
00584     }
00585 
00586     <span class="keywordflow">if</span> (pwndLB != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00587         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndLB);
00588     }
00589 
00590     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00591 }
00592 
00593 
00594 <span class="comment">/***************************************************************************\</span>
00595 <span class="comment">* xxxDlgDirList</span>
00596 <span class="comment">*</span>
00597 <span class="comment">* History:</span>
00598 <span class="comment">\***************************************************************************/</span>
00599 
<a name="l00600"></a><a class="code" href="../../d0/d2/lboxctl3_8c.html#a15">00600</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d2/lboxctl3_8c.html#a15">DlgDirListA</a>(
00601     HWND hwndDlg,
00602     LPSTR lpszPathSpecClient,
00603     <span class="keywordtype">int</span> idListBox,
00604     <span class="keywordtype">int</span> idStaticPath,
00605     UINT attrib)
00606 {
00607     LPWSTR lpszPathSpec;
00608     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndDlg;
00609     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndDlg;
00610     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRet;
00611 
00612     pwndDlg = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwndDlg);
00613 
00614     <span class="keywordflow">if</span> (pwndDlg == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00615         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00616 
00617     lpszPathSpec = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00618     <span class="keywordflow">if</span> (lpszPathSpecClient) {
00619         <span class="keywordflow">if</span> (!MBToWCS(lpszPathSpecClient, -1, &amp;lpszPathSpec, -1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))
00620             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00621     }
00622 
00623     <span class="comment">/*</span>
00624 <span class="comment">     * The last parameter is TRUE to indicate ListBox (not ComboBox)</span>
00625 <span class="comment">     */</span>
00626     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndDlg, &amp;tlpwndDlg);
00627     fRet = <a class="code" href="../../d6/d0/usercli_8h.html#a735">xxxDlgDirListHelper</a>(pwndDlg, lpszPathSpec, lpszPathSpecClient,
00628             idListBox, idStaticPath, attrib, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00629     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndDlg);
00630 
00631     <span class="keywordflow">if</span> (lpszPathSpec) {
00632         <span class="keywordflow">if</span> (fRet) {
00633             <span class="comment">/*</span>
00634 <span class="comment">             * Non-zero retval means some text to copy out.  Copy out up to</span>
00635 <span class="comment">             * the nul terminator (buffer will be big enough).</span>
00636 <span class="comment">             */</span>
00637             WCSToMB(lpszPathSpec, -1, &amp;lpszPathSpecClient, MAXLONG, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00638         }
00639         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(lpszPathSpec);
00640     }
00641 
00642     <span class="keywordflow">return</span> fRet;
00643 }
00644 
<a name="l00645"></a><a class="code" href="../../d0/d2/lboxctl3_8c.html#a16">00645</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d2/lboxctl3_8c.html#a16">DlgDirListW</a>(
00646     HWND hwndDlg,
00647     LPWSTR lpszPathSpecClient,
00648     <span class="keywordtype">int</span> idListBox,
00649     <span class="keywordtype">int</span> idStaticPath,
00650     UINT attrib)
00651 {
00652     LPWSTR lpszPathSpec;
00653     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndDlg;
00654     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndDlg;
00655     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRet;
00656 
00657     pwndDlg = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwndDlg);
00658 
00659     <span class="keywordflow">if</span> (pwndDlg == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00660         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00661 
00662     lpszPathSpec = lpszPathSpecClient;
00663 
00664     <span class="comment">/*</span>
00665 <span class="comment">     * The last parameter is TRUE to indicate ListBox (not ComboBox)</span>
00666 <span class="comment">     */</span>
00667     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndDlg, &amp;tlpwndDlg);
00668     fRet = <a class="code" href="../../d6/d0/usercli_8h.html#a735">xxxDlgDirListHelper</a>(pwndDlg, lpszPathSpec, (LPBYTE)lpszPathSpecClient,
00669             idListBox, idStaticPath, attrib, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00670     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndDlg);
00671 
00672     <span class="keywordflow">return</span> fRet;
00673 }
00674 
00675 
00676 <span class="comment">/***************************************************************************\</span>
00677 <span class="comment">* DlgDirSelectHelper</span>
00678 <span class="comment">*</span>
00679 <span class="comment">* History:</span>
00680 <span class="comment">\***************************************************************************/</span>
00681 
<a name="l00682"></a><a class="code" href="../../d6/d0/usercli_8h.html#a736">00682</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d0/usercli_8h.html#a736">DlgDirSelectHelper</a>(
00683     LPWSTR lpszPathSpec,
00684     <span class="keywordtype">int</span> chCount,
00685     HWND hwndListBox)
00686 {
00687     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>   cch;
00688     LPWSTR lpchFile;
00689     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fDir;
00690     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> sItem;
00691     LPWSTR lpchT;
00692     WCHAR rgch[<a class="code" href="../../d6/d0/usercli_8h.html#a135">CCHFILEMAX</a> + 2];
00693     <span class="keywordtype">int</span> cchT;
00694     <a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html">LARGE_UNICODE_STRING</a> str;
00695 
00696     <span class="comment">/*</span>
00697 <span class="comment">     * Callers such as DlgDirSelectEx do not validate the existance</span>
00698 <span class="comment">     * of hwndListBox</span>
00699 <span class="comment">     */</span>
00700     <span class="keywordflow">if</span> (hwndListBox == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00701         RIPERR0(ERROR_CONTROL_ID_NOT_FOUND, RIP_VERBOSE, <span class="stringliteral">""</span>);
00702         <span class="keywordflow">return</span> 0;
00703     }
00704 
00705     sItem = (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)<a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hwndListBox, LB_GETCURSEL, 0, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00706     <span class="keywordflow">if</span> (sItem &lt; 0)
00707         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00708 
00709     cchT = (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)<a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hwndListBox, LB_GETTEXT, sItem, (LPARAM)rgch);
00710     UserAssert(cchT &lt; (<span class="keyword">sizeof</span>(rgch)/<span class="keyword">sizeof</span>(rgch[0])));
00711 
00712     lpchFile = rgch;
00713     fDir = (*rgch == TEXT(<span class="charliteral">'['</span>));
00714 
00715     <span class="comment">/*</span>
00716 <span class="comment">     * Check if all details along with file name are to be returned.  Make sure</span>
00717 <span class="comment">     * we can find the listbox because with drop down combo boxes, the</span>
00718 <span class="comment">     * GetDlgItem will fail.</span>
00719 <span class="comment">     *</span>
00720 <span class="comment">     * Make sure this window has been using the listbox window proc because</span>
00721 <span class="comment">     * we store some data as a window long.</span>
00722 <span class="comment">     */</span>
00723 
00724     <span class="comment">/*</span>
00725 <span class="comment">     * Only the file name is to be returned.  Find the end of the filename.</span>
00726 <span class="comment">     */</span>
00727     lpchT = lpchFile;
00728     <span class="keywordflow">while</span> ((*lpchT) &amp;&amp; (*lpchT != <a class="code" href="../../d0/d2/lboxctl3_8c.html#a4">TABCHAR</a>))
00729         lpchT++;
00730     *lpchT = TEXT(<span class="charliteral">'\0'</span>);
00731 
00732     cch = wcslen(lpchFile);
00733 
00734     <span class="comment">/*</span>
00735 <span class="comment">     * Selection is drive or directory.</span>
00736 <span class="comment">     */</span>
00737     <span class="keywordflow">if</span> (fDir) {
00738         lpchFile++;
00739         cch--;
00740         *(lpchFile + cch - 1) = TEXT(<span class="charliteral">'\\'</span>);
00741 
00742         <span class="comment">/*</span>
00743 <span class="comment">         * Selection is drive</span>
00744 <span class="comment">         */</span>
00745         <span class="keywordflow">if</span> (rgch[1] == TEXT(<span class="charliteral">'-'</span>)) {
00746             lpchFile++;
00747             cch--;
00748             *(lpchFile + 1) = TEXT(<span class="charliteral">':'</span>);
00749             *(lpchFile + 2) = 0;
00750         }
00751     } <span class="keywordflow">else</span> {
00752 
00753         <span class="comment">/*</span>
00754 <span class="comment">         * Selection is file.  If filename has no extension, append '.'</span>
00755 <span class="comment">         */</span>
00756         lpchT = lpchFile;
00757         <span class="keywordflow">for</span> (; (cch &gt; 0) &amp;&amp; (*lpchT != <a class="code" href="../../d0/d2/lboxctl3_8c.html#a4">TABCHAR</a>);
00758                 cch--, lpchT++) {
00759             <span class="keywordflow">if</span> (*lpchT == TEXT(<span class="charliteral">'.'</span>))
00760                 <span class="keywordflow">goto</span> Exit;
00761         }
00762         <span class="keywordflow">if</span> (*lpchT == <a class="code" href="../../d0/d2/lboxctl3_8c.html#a4">TABCHAR</a>) {
00763             memmove(lpchT + 1, lpchT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a38">CHARSTOBYTES</a>(cch + 1));
00764             *lpchT = TEXT(<span class="charliteral">'.'</span>);
00765         } <span class="keywordflow">else</span> {
00766             *lpchT++ = TEXT(<span class="charliteral">'.'</span>);
00767             *lpchT = 0;
00768         }
00769     }
00770 
00771 Exit:
00772     <a class="code" href="../../d5/d6/chartran_8c.html#a7">RtlInitLargeUnicodeString</a>(&amp;str, lpchFile, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1);
00773     <a class="code" href="../../d1/d5/w32_2ntuser_2rtl_2random_8c.html#a2">TextCopy</a>(&amp;str, lpszPathSpec, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)chCount);
00774     <span class="keywordflow">return</span> fDir;
00775 }
00776 
00777 
00778 <span class="comment">/***************************************************************************\</span>
00779 <span class="comment">* DlgDirSelectEx</span>
00780 <span class="comment">*</span>
00781 <span class="comment">* History:</span>
00782 <span class="comment">\***************************************************************************/</span>
00783 
<a name="l00784"></a><a class="code" href="../../d0/d2/lboxctl3_8c.html#a18">00784</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d2/lboxctl3_8c.html#a18">DlgDirSelectExA</a>(
00785     HWND hwndDlg,
00786     LPSTR lpszPathSpec,
00787     <span class="keywordtype">int</span> chCount,
00788     <span class="keywordtype">int</span> idListBox)
00789 {
00790     LPWSTR lpwsz;
00791     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRet;
00792 
00793     lpwsz = (LPWSTR)<a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(HEAP_ZERO_MEMORY, chCount * <span class="keyword">sizeof</span>(WCHAR));
00794     <span class="keywordflow">if</span> (!lpwsz) {
00795         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00796     }
00797 
00798     fRet = <a class="code" href="../../d6/d0/usercli_8h.html#a736">DlgDirSelectHelper</a>(lpwsz, chCount, <a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(hwndDlg, idListBox));
00799 
00800     WCSToMB(lpwsz, -1, &amp;lpszPathSpec, chCount, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00801 
00802     <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(lpwsz);
00803 
00804     <span class="keywordflow">return</span> fRet;
00805 }
00806 
<a name="l00807"></a><a class="code" href="../../d0/d2/lboxctl3_8c.html#a19">00807</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d2/lboxctl3_8c.html#a19">DlgDirSelectExW</a>(
00808     HWND hwndDlg,
00809     LPWSTR lpszPathSpec,
00810     <span class="keywordtype">int</span> chCount,
00811     <span class="keywordtype">int</span> idListBox)
00812 {
00813     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a736">DlgDirSelectHelper</a>(lpszPathSpec, chCount, <a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(hwndDlg, idListBox));
00814 }
00815 
00816 
00817 <span class="comment">/***************************************************************************\</span>
00818 <span class="comment">* xxxLbDir</span>
00819 <span class="comment">*</span>
00820 <span class="comment">* History:</span>
00821 <span class="comment">\***************************************************************************/</span>
00822 
00823 <span class="comment">/*</span>
00824 <span class="comment"> * Note that these FILE_ATTRIBUTE_* values map directly with</span>
00825 <span class="comment"> * their DDL_* counterparts, with the exception of FILE_ATTRIBUTE_NORMAL.</span>
00826 <span class="comment"> */</span>
<a name="l00827"></a><a class="code" href="../../d0/d2/lboxctl3_8c.html#a10">00827</a> <span class="preprocessor">#define FIND_ATTR ( \</span>
00828 <span class="preprocessor">        FILE_ATTRIBUTE_NORMAL | \</span>
00829 <span class="preprocessor">        FILE_ATTRIBUTE_DIRECTORY | \</span>
00830 <span class="preprocessor">        FILE_ATTRIBUTE_HIDDEN | \</span>
00831 <span class="preprocessor">        FILE_ATTRIBUTE_SYSTEM | \</span>
00832 <span class="preprocessor">        FILE_ATTRIBUTE_ARCHIVE | \</span>
00833 <span class="preprocessor">        FILE_ATTRIBUTE_READONLY )</span>
<a name="l00834"></a><a class="code" href="../../d0/d2/lboxctl3_8c.html#a11">00834</a> <span class="preprocessor"></span><span class="preprocessor">#define EXCLUDE_ATTR ( \</span>
00835 <span class="preprocessor">        FILE_ATTRIBUTE_DIRECTORY | \</span>
00836 <span class="preprocessor">        FILE_ATTRIBUTE_HIDDEN | \</span>
00837 <span class="preprocessor">        FILE_ATTRIBUTE_SYSTEM )</span>
00838 <span class="preprocessor"></span>
<a name="l00839"></a><a class="code" href="../../d6/d0/usercli_8h.html#a728">00839</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> <a class="code" href="../../d6/d0/usercli_8h.html#a728">xxxLbDir</a>(
00840     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
00841     UINT attrib,
00842     LPWSTR lhszFileSpec)
00843 {
00844     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> result;
00845     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fWasVisible, bRet;
00846     WCHAR <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[<a class="code" href="../../d6/d0/usercli_8h.html#a135">CCHFILEMAX</a> + 1];
00847     WCHAR <a class="code" href="../../d9/d0/tfilmem_8c.html#a2">Buffer2</a>[<a class="code" href="../../d6/d0/usercli_8h.html#a135">CCHFILEMAX</a> + 1];
00848     HANDLE hFind;
00849     WIN32_FIND_DATA ffd;
00850     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> attribFile;
00851     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> mDrives;
00852     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> cDrive;
00853     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> attribInclMask, attribExclMask;
00854 
00855     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
00856 
00857     <span class="comment">/*</span>
00858 <span class="comment">     * Make sure the buffer is valid and copy it onto the stack. Why? Because</span>
00859 <span class="comment">     * there is a chance that lhszFileSpec is pointing to an invalid string</span>
00860 <span class="comment">     * because some app posted a CB_DIR or LB_DIR without the DDL_POSTMSGS</span>
00861 <span class="comment">     * bit set.</span>
00862 <span class="comment">     */</span>
00863     <span class="keywordflow">try</span> {
00864         wcscpy(<a class="code" href="../../d9/d0/tfilmem_8c.html#a2">Buffer2</a>, lhszFileSpec);
00865         lhszFileSpec = <a class="code" href="../../d9/d0/tfilmem_8c.html#a2">Buffer2</a>;
00866     } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
00867         <span class="keywordflow">return</span> -1;
00868     }
00869 
00870     result = -1;
00871 
00872 <span class="preprocessor">#ifndef UNICODE</span>
00873 <span class="preprocessor"></span>    CharToOem(lhszFileSpec, lhszFileSpec);
00874 <span class="preprocessor">#endif</span>
00875 <span class="preprocessor"></span>
00876     <span class="keywordflow">if</span> (fWasVisible = <a class="code" href="../../d6/d0/usercli_8h.html#a108">IsLBoxVisible</a>(plb)) {
00877         <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>), WM_SETREDRAW, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, 0);
00878     }
00879 
00880     <span class="comment">/*</span>
00881 <span class="comment">     * First we add the files then the directories and drives.</span>
00882 <span class="comment">     * If they only wanted drives then skip the file query</span>
00883 <span class="comment">     * Also under Windows specifing only 0x8000 (DDL_EXCLUSIVE) adds no files).</span>
00884 <span class="comment">     */</span>
00885 
00886 
00887 <span class="comment">//    if ((attrib != (DDL_EXCLUSIVE | DDL_DRIVES)) &amp;&amp; (attrib != DDL_EXCLUSIVE) &amp;&amp;</span>
00888     <span class="keywordflow">if</span> (attrib != (DDL_EXCLUSIVE | DDL_DRIVES | DDL_NOFILES)) {
00889         hFind = FindFirstFile(lhszFileSpec, &amp;ffd);
00890 
00891         <span class="keywordflow">if</span> (hFind != <a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>) {
00892 
00893             <span class="comment">/*</span>
00894 <span class="comment">             * If this is not an exclusive search, include normal files.</span>
00895 <span class="comment">             */</span>
00896             attribInclMask = attrib &amp; <a class="code" href="../../d0/d2/lboxctl3_8c.html#a10">FIND_ATTR</a>;
00897             <span class="keywordflow">if</span> (!(attrib &amp; DDL_EXCLUSIVE))
00898                 attribInclMask |= FILE_ATTRIBUTE_NORMAL | FILE_ATTRIBUTE_READONLY |
00899                         FILE_ATTRIBUTE_ARCHIVE;
00900 
00901             <span class="comment">/*</span>
00902 <span class="comment">             * Make a mask of the attributes to be excluded from</span>
00903 <span class="comment">             * the search.</span>
00904 <span class="comment">             */</span>
00905             attribExclMask = ~attrib &amp; <a class="code" href="../../d0/d2/lboxctl3_8c.html#a11">EXCLUDE_ATTR</a>;
00906 
00907 <span class="comment">// LATER BUG - scottlu</span>
00908 <span class="comment">// Win3 assumes doing a LoadCursor here will return the same wait cursor that</span>
00909 <span class="comment">// has already been created, whereas calling ServerLoadCursor creates a new</span>
00910 <span class="comment">// one every time!</span>
00911 <span class="comment">// hCursorT = NtUserSetCursor(ServerLoadCursor(NULL, IDC_WAIT));</span>
00912 
00913 
00914 <span class="comment">// FindFirst/Next works different in NT then DOS.  Under DOS you passed in</span>
00915 <span class="comment">// a set of attributes under NT you get back a set of attributes and have</span>
00916 <span class="comment">// to test for those attributes (Dos input attributes were Hidden, System</span>
00917 <span class="comment">// and Directoy) the dos find first always returned ReadOnly and archive files</span>
00918 
00919 <span class="comment">// we are going to select a file in one of two cases.</span>
00920 <span class="comment">// 1) if any of the attrib bits are set on the file.</span>
00921 <span class="comment">// 2) if we want normal files and the file is a notmal file (the file attrib</span>
00922 <span class="comment">//    bits don't contain any NOEXCLBITS</span>
00923 
00924             <span class="keywordflow">do</span> {
00925                 attribFile = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)ffd.dwFileAttributes;
00926                 <span class="keywordflow">if</span> (attribFile == FILE_ATTRIBUTE_COMPRESSED) {
00927                     attribFile = FILE_ATTRIBUTE_NORMAL;
00928                 }
00929                 attribFile &amp;= ~FILE_ATTRIBUTE_COMPRESSED;
00930 
00931                 <span class="comment">/*</span>
00932 <span class="comment">                 * Accept those files that have only the</span>
00933 <span class="comment">                 * attributes that we are looking for.</span>
00934 <span class="comment">                 */</span>
00935                 <span class="keywordflow">if</span> ((attribFile &amp; attribInclMask) != 0 &amp;&amp;
00936                         (attribFile &amp; attribExclMask) == 0) {
00937                     <span class="keywordflow">if</span> (attribFile &amp; DDL_DIRECTORY) {
00938 
00939                         <span class="comment">/*</span>
00940 <span class="comment">                         * Don't include '.' (current directory) in list.</span>
00941 <span class="comment">                         */</span>
00942                         <span class="keywordflow">if</span> (*((LPDWORD)&amp;ffd.cFileName[0]) == 0x0000002E)
00943                             <span class="keywordflow">goto</span> cfnf;
00944 
00945                         <span class="comment">/*</span>
00946 <span class="comment">                         * If we're not looking for dirs, ignore it</span>
00947 <span class="comment">                         */</span>
00948                         <span class="keywordflow">if</span> (!(attrib &amp; DDL_DIRECTORY))
00949                             <span class="keywordflow">goto</span> cfnf;
00950 
00951                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (attrib &amp; DDL_NOFILES) {
00952                         <span class="comment">/*</span>
00953 <span class="comment">                         * Don't include files if DDL_NOFILES is set.</span>
00954 <span class="comment">                         */</span>
00955                         <span class="keywordflow">goto</span> cfnf;
00956                     }
00957 
00958                     <a class="code" href="../../d0/d2/lboxctl3_8c.html#a22">LB_CreateLBLine</a>(&amp;ffd,
00959                             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00960                     result = <a class="code" href="../../d6/d0/usercli_8h.html#a685">xxxLBInsertItem</a>(plb, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, 0, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a547">MSGFLAG_SPECIAL_THUNK</a> | <a class="code" href="../../d6/d0/usercli_8h.html#a117">LBI_ADD</a>);
00961                 }
00962 cfnf:
00963                 bRet = FindNextFile(hFind, &amp;ffd);
00964 
00965             } <span class="keywordflow">while</span> (result &gt;= -1 &amp;&amp; bRet);
00966             FindClose(hFind);
00967 
00968 <span class="comment">// LATER see above comment</span>
00969 <span class="comment">// NtUserSetCursor(hCursorT);</span>
00970         }
00971     }
00972 
00973     <span class="comment">/*</span>
00974 <span class="comment">     * If drive bit set, include drives in the list.</span>
00975 <span class="comment">     */</span>
00976     <span class="keywordflow">if</span> (result != LB_ERRSPACE &amp;&amp; (attrib &amp; DDL_DRIVES)) {
00977         ffd.cFileName[0] = TEXT(<span class="charliteral">'['</span>);
00978         ffd.cFileName[1] = ffd.cFileName[3] = TEXT(<span class="charliteral">'-'</span>);
00979         ffd.cFileName[4] = TEXT(<span class="charliteral">']'</span>);
00980         ffd.cFileName[5] = 0;
00981         mDrives = GetLogicalDrives();
00982         <span class="keywordflow">for</span> (cDrive = 0; mDrives; mDrives &gt;&gt;= 1, cDrive++) {
00983             <span class="keywordflow">if</span> (mDrives &amp; 1) {
00984                 ffd.cFileName[2] = (WCHAR)(TEXT(<span class="charliteral">'A'</span>) + cDrive);
00985 
00986                 <span class="comment">/*</span>
00987 <span class="comment">                 * We have to set the SPECIAL_THUNK bit because we are</span>
00988 <span class="comment">                 * adding a server side string to a list box that may not</span>
00989 <span class="comment">                 * be HASSTRINGS so we have to force the server-client</span>
00990 <span class="comment">                 * string thunk.</span>
00991 <span class="comment">                 */</span>
00992                 <span class="keywordflow">if</span> ((result = <a class="code" href="../../d6/d0/usercli_8h.html#a685">xxxLBInsertItem</a>(plb, CharLower(ffd.cFileName), -1,
00993                         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a547">MSGFLAG_SPECIAL_THUNK</a>)) &lt; 0) {
00994                     <span class="keywordflow">break</span>;
00995                 }
00996             }
00997         }
00998     }
00999 
01000     <span class="keywordflow">if</span> (result == LB_ERRSPACE) {
01001         <a class="code" href="../../d6/d0/usercli_8h.html#a732">xxxNotifyOwner</a>(plb, LB_ERRSPACE);
01002     }
01003 
01004     <span class="keywordflow">if</span> (fWasVisible) {
01005         <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>), WM_SETREDRAW, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, 0);
01006     }
01007 
01008     <a class="code" href="../../d6/d0/usercli_8h.html#a706">xxxLBShowHideScrollBars</a>(plb);
01009 
01010     <a class="code" href="../../d6/d0/usercli_8h.html#a714">xxxCheckRedraw</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, 0);
01011 
01012     <span class="keywordflow">if</span> (result != LB_ERRSPACE) {
01013 
01014         <span class="comment">/*</span>
01015 <span class="comment">         * Return index of last item in the listbox.  We can't just return</span>
01016 <span class="comment">         * result because that is the index of the last item added which may</span>
01017 <span class="comment">         * be in the middle somewhere if the LBS_SORT style is on.</span>
01018 <span class="comment">         */</span>
01019         <span class="keywordflow">return</span> plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o6">cMac</a> - 1;
01020     } <span class="keywordflow">else</span> {
01021         <span class="keywordflow">return</span> result;
01022     }
01023 }
01024 
01025 <span class="comment">/***************************************************************************\</span>
01026 <span class="comment">* xxxLbInsertFile</span>
01027 <span class="comment">*</span>
01028 <span class="comment">* Yet another CraigC shell hack... This responds to LB_ADDFILE messages</span>
01029 <span class="comment">* sent to directory windows in the file system as a response to the</span>
01030 <span class="comment">* WM_FILESYSCHANGE message.  That way, we don't reread the whole</span>
01031 <span class="comment">* directory when we copy files.</span>
01032 <span class="comment">*</span>
01033 <span class="comment">* History:</span>
01034 <span class="comment">\***************************************************************************/</span>
01035 
<a name="l01036"></a><a class="code" href="../../d6/d0/usercli_8h.html#a729">01036</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> <a class="code" href="../../d6/d0/usercli_8h.html#a729">xxxLbInsertFile</a>(
01037     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb,
01038     LPWSTR lpFile)
01039 {
01040     WCHAR chBuffer[<a class="code" href="../../d6/d0/usercli_8h.html#a135">CCHFILEMAX</a> + 1];
01041     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> result = -1;
01042     HANDLE hFind;
01043     WIN32_FIND_DATA ffd;
01044 
01045     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o1">spwnd</a>);
01046 
01047     hFind = FindFirstFile(lpFile, &amp;ffd);
01048     <span class="keywordflow">if</span> (hFind != <a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>) {
01049         FindClose(hFind);
01050         <a class="code" href="../../d0/d2/lboxctl3_8c.html#a22">LB_CreateLBLine</a>(&amp;ffd, chBuffer);
01051         result = <a class="code" href="../../d6/d0/usercli_8h.html#a685">xxxLBInsertItem</a>(plb, chBuffer, 0, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a547">MSGFLAG_SPECIAL_THUNK</a> | <a class="code" href="../../d6/d0/usercli_8h.html#a117">LBI_ADD</a>);
01052     }
01053 
01054     <span class="keywordflow">if</span> (result == LB_ERRSPACE) {
01055         <a class="code" href="../../d6/d0/usercli_8h.html#a732">xxxNotifyOwner</a>(plb, result);
01056     }
01057 
01058     <a class="code" href="../../d6/d0/usercli_8h.html#a714">xxxCheckRedraw</a>(plb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, 0);
01059     <span class="keywordflow">return</span> result;
01060 }
01061 
01062 <span class="comment">/***************************************************************************\</span>
01063 <span class="comment">* LB_CreateLBLine</span>
01064 <span class="comment">*</span>
01065 <span class="comment">* This creates a character string that contains all the required</span>
01066 <span class="comment">* details of a file;( Name)</span>
01067 <span class="comment">*</span>
01068 <span class="comment">* History:</span>
01069 <span class="comment">\***************************************************************************/</span>
01070 
<a name="l01071"></a><a class="code" href="../../d0/d2/lboxctl3_8c.html#a22">01071</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d2/lboxctl3_8c.html#a22">LB_CreateLBLine</a>(
01072     PWIN32_FIND_DATA pffd,
01073     LPWSTR lpBuffer)
01074 {
01075     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> bAttribute;
01076     LPWSTR lpch;
01077 
01078     lpch = lpBuffer;
01079 
01080     bAttribute = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)pffd-&gt;dwFileAttributes;
01081     <span class="keywordflow">if</span> (bAttribute &amp; DDL_DIRECTORY)  <span class="comment">/* Is it a directory */</span>
01082         *lpch++ = TEXT(<span class="charliteral">'['</span>);
01083 
01084     <span class="comment">/*</span>
01085 <span class="comment">     * Copy the file name</span>
01086 <span class="comment">     *</span>
01087 <span class="comment">     * If we are running from wow, check if the shortname exists</span>
01088 <span class="comment">     */</span>
01089     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>()-&gt;dwTIFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) {
01090         UNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
01091         BOOLEAN fSpace = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01092 
01093         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, pffd-&gt;cFileName);
01094         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9/gen8dot3_8c.html#a13">RtlIsNameLegalDOS8Dot3</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;fSpace) &amp;&amp; !fSpace) {
01095             <span class="comment">/*</span>
01096 <span class="comment">             * Legal 8.3 name and no spaces, so use the principal</span>
01097 <span class="comment">             * file name.</span>
01098 <span class="comment">             */</span>
01099             wcscpy(lpch, pffd-&gt;cFileName);
01100         } <span class="keywordflow">else</span> {
01101             <span class="keywordflow">if</span> (pffd-&gt;cAlternateFileName[0] == 0)
01102                 wcscpy(lpch, pffd-&gt;cFileName);
01103             <span class="keywordflow">else</span>
01104                 <span class="comment">/*</span>
01105 <span class="comment">                 * Use the alternate file name.</span>
01106 <span class="comment">                 */</span>
01107                 wcscpy(lpch, pffd-&gt;cAlternateFileName);
01108         }
01109         <span class="comment">/*</span>
01110 <span class="comment">         * Make filename lower-case for 16-bit apps.  Some Corel apps</span>
01111 <span class="comment">         * require this.</span>
01112 <span class="comment">         */</span>
01113         CharLower(lpch);
01114 
01115     }
01116     <span class="keywordflow">else</span>
01117        wcscpy(lpch, pffd-&gt;cFileName);
01118 
01119     lpch = (LPWSTR)(lpch + wcslen(lpch));
01120 
01121     <span class="keywordflow">if</span> (bAttribute &amp; DDL_DIRECTORY)  <span class="comment">/* Is it a directory */</span>
01122         *lpch++ = TEXT(<span class="charliteral">']'</span>);
01123 
01124     *lpch = TEXT(<span class="charliteral">'\0'</span>);
01125 
01126 <span class="preprocessor">#ifndef UNICODE</span>
01127 <span class="preprocessor"></span>    OemToChar(lpBuffer, lpBuffer);
01128 <span class="preprocessor">#endif</span>
01129 <span class="preprocessor"></span>
01130     *lpch = TEXT(<span class="charliteral">'\0'</span>);  <span class="comment">/* Null terminate */</span>
01131 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:37 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
