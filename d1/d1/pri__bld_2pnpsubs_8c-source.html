<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: pnpsubs.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pnpsubs.c</h1><a href="../../d0/d2/pri__bld_2pnpsubs_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1995  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    pnpsubs.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the plug-and-play subroutines for the</span>
00012 <span class="comment">    I/O system.</span>
00013 <span class="comment"></span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    Shie-Lin Tzong (shielint) 3-Jan-1995</span>
00018 <span class="comment"></span>
00019 <span class="comment">Environment:</span>
00020 <span class="comment"></span>
00021 <span class="comment">    Kernel mode</span>
00022 <span class="comment"></span>
00023 <span class="comment">Revision History:</span>
00024 <span class="comment"></span>
00025 <span class="comment"></span>
00026 <span class="comment">--*/</span>
00027 
00028 <span class="preprocessor">#include "<a class="code" href="../../d0/d6/iop_8h.html">iop.h</a>"</span>
00029 <span class="preprocessor">#pragma hdrstop</span>
00030 <span class="preprocessor"></span>
00031 <span class="preprocessor">#ifdef POOL_TAGGING</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#undef ExAllocatePool</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePool(a,b) ExAllocatePoolWithTag(a,b,'uspP')</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00035 <span class="preprocessor"></span>
00036 <span class="comment">//</span>
00037 <span class="comment">// Prototype of internal functions</span>
00038 <span class="comment">//</span>
00039 
00040 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00041 <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a0">IopDisableDevice</a>(
00042     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
00043     IN HANDLE Handle
00044     );
00045 
00046 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00047 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopCreateMadeupNode)</span>
00048 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopRemoveStringFromValueKey)</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopAppendStringToValueKey)</span>
00050 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopConcatenateUnicodeStrings)</span>
00051 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopPrepareDriverLoading)</span>
00052 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopServiceInstanceToDeviceInstance)</span>
00053 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopOpenRegistryKeyPersist)</span>
00054 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopOpenServiceEnumKeys)</span>
00055 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopOpenCurrentHwProfileDeviceInstanceKey)</span>
00056 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopGetDeviceInstanceCsConfigFlags)</span>
00057 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopSetDeviceInstanceCsConfigFlags)</span>
00058 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopApplyFunctionToSubKeys)</span>
00059 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopRegMultiSzToUnicodeStrings)</span>
00060 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopApplyFunctionToServiceInstances)</span>
00061 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopIsDuplicatedDevices)</span>
00062 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopMarkDuplicateDevice)</span>
00063 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopFreeUnicodeStringList)</span>
00064 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopDriverLoadingFailed)</span>
00065 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopIsAnyDeviceInstanceEnabled)</span>
00066 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopIsDeviceInstanceEnabled)</span>
00067 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopDetermineResourceListSize)</span>
00068 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopReferenceDriverObjectByName)</span>
00069 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopDeviceObjectFromDeviceInstance)</span>
00070 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopDeviceObjectToDeviceInstance)</span>
00071 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopCleanupDeviceRegistryValues)</span>
00072 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopGetDeviceResourcesFromRegistry)</span>
00073 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopCmResourcesToIoResources)</span>
00074 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopReadDeviceConfiguration)</span>
00075 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopGetGroupOrderIndex)</span>
00076 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopDeleteLegacyKey)</span>
00077 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopIsLegacyDriver)</span>
00078 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopFilterResourceRequirementsList)</span>
00079 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopMergeFilteredResourceRequirementsList)</span>
00080 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopDisableDevice)</span>
00081 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopMergeCmResourceLists)</span>
00082 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopDeviceCapabilitiesToRegistry)</span>
00083 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopRestartDeviceNode)</span>
00084 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00085 <span class="preprocessor"></span>
00086 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00087"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a1">00087</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a1">IopCreateMadeupNode</a>(
00088     IN PUNICODE_STRING ServiceKeyName,
00089     OUT PHANDLE ReturnedHandle,
00090     OUT PUNICODE_STRING KeyName,
00091     OUT PULONG InstanceNumber,
00092     IN BOOLEAN ResourceOwned
00093     )
00094 
00095 <span class="comment">/*++</span>
00096 <span class="comment"></span>
00097 <span class="comment">Routine Description:</span>
00098 <span class="comment"></span>
00099 <span class="comment">    This routine creates a new instance node under System\Enum\Root\*Madeup&lt;Name&gt;</span>
00100 <span class="comment">    key and all the required default value entries.  Also a value entry under</span>
00101 <span class="comment">    Service\ServiceKeyName\Enum is created to point to the newly created madeup</span>
00102 <span class="comment">    entry.  A handle and the keyname of the new key are returned to caller.</span>
00103 <span class="comment">    Caller must free the unicode string when he is done with it.</span>
00104 <span class="comment"></span>
00105 <span class="comment">Parameters:</span>
00106 <span class="comment"></span>
00107 <span class="comment">    ServiceKeyName - Supplies a pointer to the name of the subkey in the</span>
00108 <span class="comment">        system service list (HKEY_LOCAL_MACHINE\CurrentControlSet\Services)</span>
00109 <span class="comment">        that caused the driver to load. This is the RegistryPath parameter</span>
00110 <span class="comment">        to the DriverEntry routine.</span>
00111 <span class="comment"></span>
00112 <span class="comment">    ReturnedHandle - Supplies a variable to receive the handle of the</span>
00113 <span class="comment">        newly created key.</span>
00114 <span class="comment"></span>
00115 <span class="comment">    KeyName - Supplies a variable to receive the name of the newly created</span>
00116 <span class="comment">        key.</span>
00117 <span class="comment"></span>
00118 <span class="comment">    InstanceNumber - supplies a variable to receive the InstanceNumber value</span>
00119 <span class="comment">        entry created under service\name\enum subkey.</span>
00120 <span class="comment"></span>
00121 <span class="comment">    ResourceOwned - supplies a BOOLEAN variable to indicate if caller owns</span>
00122 <span class="comment">        the registry resource exclusively.</span>
00123 <span class="comment"></span>
00124 <span class="comment">Return Value:</span>
00125 <span class="comment"></span>
00126 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
00127 <span class="comment"></span>
00128 <span class="comment">--*/</span>
00129 
00130 {
00131     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
00132     UNICODE_STRING tmpKeyName, unicodeInstanceName, unicodeString;
00133     UNICODE_STRING rootKeyName, unicodeValueName, unicodeKeyName;
00134     HANDLE handle, enumRootHandle, hTreeHandle;
00135     ULONG instance;
00136     UCHAR unicodeBuffer[20];
00137     ULONG tmpValue, disposition = 0;
00138     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00139     PWSTR p;
00140     BOOLEAN releaseResource = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00141 
00142     <span class="keywordflow">if</span> (!ResourceOwned) {
00143         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00144         <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00145         releaseResource = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00146     }
00147 
00148     <span class="comment">//</span>
00149     <span class="comment">// Open LocalMachine\System\CurrentControlSet\Enum\Root</span>
00150     <span class="comment">//</span>
00151 
00152     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;enumRootHandle,
00153                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00154                                 &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a24">CmRegistryMachineSystemCurrentControlSetEnumRootName</a>,
00155                                 KEY_ALL_ACCESS,
00156                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00157                                 );
00158     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00159         <span class="keywordflow">goto</span> local_exit0;
00160     }
00161 
00162     <span class="comment">//</span>
00163     <span class="comment">// Open, and create if not already exist, System\Enum\Root\LEGACY_&lt;ServiceName&gt;</span>
00164     <span class="comment">// First, try to find the ServiceName by extracting it from user supplied</span>
00165     <span class="comment">// ServiceKeyName.</span>
00166     <span class="comment">//</span>
00167 
00168     PiWstrToUnicodeString(&amp;tmpKeyName, REGSTR_KEY_MADEUP);
00169     <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a>(&amp;unicodeKeyName, &amp;tmpKeyName, ServiceKeyName);
00170     <a class="code" href="../../d6/d6/nls_8c.html#a31">RtlUpcaseUnicodeString</a>(&amp;unicodeKeyName, &amp;unicodeKeyName, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00171     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a7">IopOpenRegistryKeyPersist</a>(&amp;handle,
00172                                        enumRootHandle,
00173                                        &amp;unicodeKeyName,
00174                                        KEY_ALL_ACCESS,
00175                                        <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00176                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00177                                        );
00178     ZwClose(enumRootHandle);
00179     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00180         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeKeyName);
00181         <span class="keywordflow">goto</span> local_exit0;
00182     }
00183 
00184     instance = 1;
00185 
00186     PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_NEXT_INSTANCE);
00187     status = ZwSetValueKey(
00188                 handle,
00189                 &amp;unicodeValueName,
00190                 <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00191                 REG_DWORD,
00192                 &amp;instance,
00193                 <span class="keyword">sizeof</span>(instance)
00194                 );
00195 
00196     instance--;
00197     *InstanceNumber = instance;
00198     PiUlongToInstanceKeyUnicodeString(&amp;unicodeInstanceName,
00199                                       unicodeBuffer + <span class="keyword">sizeof</span>(WCHAR), <span class="comment">// reserve first WCHAR space</span>
00200                                       20 - <span class="keyword">sizeof</span>(WCHAR),
00201                                       instance
00202                                       );
00203     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a7">IopOpenRegistryKeyPersist</a>(<a class="code" href="../../d5/d9/unc_8c.html#a7">ReturnedHandle</a>,
00204                                        handle,
00205                                        &amp;unicodeInstanceName,
00206                                        KEY_ALL_ACCESS,
00207                                        <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00208                                        &amp;disposition
00209                                        );
00210     ZwClose(handle);
00211     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00212         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeKeyName);
00213         <span class="keywordflow">goto</span> local_exit0;
00214     }
00215 
00216     <span class="comment">//</span>
00217     <span class="comment">// Prepare newly created registry key name for returning to caller</span>
00218     <span class="comment">//</span>
00219 
00220     *(PWSTR)unicodeBuffer = OBJ_NAME_PATH_SEPARATOR;
00221     unicodeInstanceName.Buffer = (PWSTR)unicodeBuffer;
00222     unicodeInstanceName.Length += <span class="keyword">sizeof</span>(WCHAR);
00223     unicodeInstanceName.MaximumLength += <span class="keyword">sizeof</span>(WCHAR);
00224     PiWstrToUnicodeString(&amp;rootKeyName, REGSTR_KEY_ROOTENUM);
00225     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;tmpKeyName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\"</span>);
00226     <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a>(&amp;unicodeString, &amp;tmpKeyName, &amp;unicodeKeyName);
00227     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeKeyName);
00228     <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a>(&amp;tmpKeyName, &amp;rootKeyName, &amp;unicodeString);
00229     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeString);
00230     <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a>(<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>, &amp;tmpKeyName, &amp;unicodeInstanceName);
00231 
00232     <span class="keywordflow">if</span> (disposition == REG_CREATED_NEW_KEY) {
00233 
00234         <span class="comment">//</span>
00235         <span class="comment">// Create all the default value entry for the newly created key.</span>
00236         <span class="comment">// Service = ServiceKeyName</span>
00237         <span class="comment">// FoundAtEnum = 1</span>
00238         <span class="comment">// Class = "LegacyDriver"</span>
00239         <span class="comment">// ClassGUID = GUID for legacy driver class</span>
00240         <span class="comment">// ConfigFlags = 0</span>
00241         <span class="comment">//</span>
00242         <span class="comment">// Create "Control" subkey with "NewlyCreated" value key</span>
00243         <span class="comment">//</span>
00244 
00245         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_KEY_CONTROL);
00246         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
00247                                     *<a class="code" href="../../d5/d9/unc_8c.html#a7">ReturnedHandle</a>,
00248                                     &amp;unicodeValueName,
00249                                     KEY_ALL_ACCESS,
00250                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00251                                     );
00252         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00253             PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_NEWLY_CREATED);
00254             tmpValue = 0;
00255             ZwSetValueKey(handle,
00256                           &amp;unicodeValueName,
00257                           <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00258                           REG_DWORD,
00259                           &amp;tmpValue,
00260                           <span class="keyword">sizeof</span>(tmpValue)
00261                           );
00262             ZwClose(handle);
00263         }
00264 
00265         handle = *<a class="code" href="../../d5/d9/unc_8c.html#a7">ReturnedHandle</a>;
00266 
00267         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_SERVICE);
00268         p = (PWSTR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00269                                   ServiceKeyName-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL));
00270         <span class="keywordflow">if</span>(p) {
00271             RtlMoveMemory(p, ServiceKeyName-&gt;Buffer, ServiceKeyName-&gt;Length);
00272             p[ServiceKeyName-&gt;Length / <span class="keyword">sizeof</span> (WCHAR)] = UNICODE_NULL;
00273             ZwSetValueKey(
00274                         handle,
00275                         &amp;unicodeValueName,
00276                         <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00277                         REG_SZ,
00278                         p,
00279                         ServiceKeyName-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL)
00280                         );
00281             <span class="comment">//</span>
00282             <span class="comment">// We'll keep the null-terminated service name buffer around for a while,</span>
00283             <span class="comment">// because we may need it later on for the DeviceDesc in case the service</span>
00284             <span class="comment">// has no DisplayName.</span>
00285             <span class="comment">//</span>
00286             <span class="comment">// ExFreePool(p);</span>
00287         }
00288 
00289         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_LEGACY);
00290         tmpValue = 1;
00291         ZwSetValueKey(
00292                     handle,
00293                     &amp;unicodeValueName,
00294                     <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00295                     REG_DWORD,
00296                     &amp;tmpValue,
00297                     <span class="keyword">sizeof</span>(tmpValue)
00298                     );
00299 
00300         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_CONFIG_FLAGS);
00301         tmpValue = 0;
00302         ZwSetValueKey(
00303                     handle,
00304                     &amp;unicodeValueName,
00305                     <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00306                     REG_DWORD,
00307                     &amp;tmpValue,
00308                     <span class="keyword">sizeof</span>(tmpValue)
00309                     );
00310 
00311         <span class="comment">//</span>
00312         <span class="comment">// BUGBUG (lonnym)--verify that removal of the following code fragment is OK.</span>
00313         <span class="comment">//</span>
00314 <span class="preprocessor">#if 0</span>
00315 <span class="preprocessor"></span>        PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_FOUNDATENUM);
00316         tmpValue = 1;
00317         ZwSetValueKey(
00318                     handle,
00319                     &amp;unicodeValueName,
00320                     <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00321                     REG_DWORD,
00322                     &amp;tmpValue,
00323                     <span class="keyword">sizeof</span>(tmpValue)
00324                     );
00325 <span class="preprocessor">#endif // (lonnym, verify removal to here)</span>
00326 <span class="preprocessor"></span>
00327         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_CLASS);
00328         ZwSetValueKey(
00329                     handle,
00330                     &amp;unicodeValueName,
00331                     <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00332                     REG_SZ,
00333                     REGSTR_VALUE_LEGACY_DRIVER,
00334                     <span class="keyword">sizeof</span>(REGSTR_VALUE_LEGACY_DRIVER)
00335                     );
00336 
00337         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_CLASSGUID);
00338         ZwSetValueKey(
00339                     handle,
00340                     &amp;unicodeValueName,
00341                     <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00342                     REG_SZ,
00343                     REGSTR_VALUE_LEGACY_DRIVER_CLASS_GUID,
00344                     <span class="keyword">sizeof</span>(REGSTR_VALUE_LEGACY_DRIVER_CLASS_GUID)
00345                     );
00346 
00347 
00348         <span class="comment">//</span>
00349         <span class="comment">// Initialize DeviceDesc= value entry.  If the service key has a "DisplayName"</span>
00350         <span class="comment">// value entry, it is used as the DeviceDesc value.  Otherwise, the service key</span>
00351         <span class="comment">// name is used.</span>
00352         <span class="comment">//</span>
00353 
00354         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">IopOpenServiceEnumKeys</a>(ServiceKeyName,
00355                                         KEY_READ,
00356                                         &amp;handle,
00357                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00358                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00359                                         );
00360         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00361 
00362             keyValueInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00363             unicodeString.Length = 0;
00364             status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(handle,
00365                                          REGSTR_VALUE_DISPLAY_NAME,
00366                                          &amp;keyValueInformation
00367                                         );
00368             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00369                 <span class="keywordflow">if</span> (keyValueInformation-&gt;Type == REG_SZ) {
00370                     <span class="keywordflow">if</span> (keyValueInformation-&gt;DataLength &gt; <span class="keyword">sizeof</span>(UNICODE_NULL)) {
00371                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a82">IopRegistryDataToUnicodeString</a>(&amp;unicodeString,
00372                                                        (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
00373                                                        keyValueInformation-&gt;DataLength
00374                                                        );
00375                     }
00376                 }
00377             }
00378             <span class="keywordflow">if</span> ((unicodeString.Length == 0) &amp;&amp; p) {
00379 
00380                 <span class="comment">//</span>
00381                 <span class="comment">// No DisplayName--use the service key name.</span>
00382                 <span class="comment">//</span>
00383 
00384                 unicodeString.Length = ServiceKeyName-&gt;Length;
00385                 unicodeString.MaximumLength = ServiceKeyName-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL);
00386                 unicodeString.Buffer = p;
00387             }
00388 
00389             <span class="keywordflow">if</span>(unicodeString.Length) {
00390                 PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_DEVICE_DESC);
00391                 ZwSetValueKey(*<a class="code" href="../../d5/d9/unc_8c.html#a7">ReturnedHandle</a>,
00392                               &amp;unicodeValueName,
00393                               <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00394                               REG_SZ,
00395                               unicodeString.Buffer,
00396                               unicodeString.Length + <span class="keyword">sizeof</span>(UNICODE_NULL)
00397                               );
00398             }
00399             <span class="keywordflow">if</span> (keyValueInformation) {
00400                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00401             }
00402             ZwClose(handle);
00403         }
00404 
00405         <span class="keywordflow">if</span>(p) {
00406             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(p);
00407         }
00408     }
00409 
00410     <span class="comment">//</span>
00411     <span class="comment">// Create new value entry under ServiceKeyName\Enum to reflect the newly</span>
00412     <span class="comment">// added made-up device instance node.</span>
00413     <span class="comment">//</span>
00414 
00415     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
00416     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00417     releaseResource = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00418 
00419     status = <a class="code" href="../../d6/d9/pnp_8h.html#a138">PpDeviceRegistration</a>(
00420                  <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,
00421                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00422                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00423                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00424                  );
00425 
00426     <span class="keywordflow">if</span> (ResourceOwned) {
00427         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00428         <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00429     }
00430     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;tmpKeyName);
00431     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00432 
00433         <span class="comment">//</span>
00434         <span class="comment">// There is no registry key for the ServiceKeyName information.</span>
00435         <span class="comment">//</span>
00436 
00437         ZwClose(*<a class="code" href="../../d5/d9/unc_8c.html#a7">ReturnedHandle</a>);
00438         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>);
00439     }
00440 local_exit0:
00441     <span class="keywordflow">if</span> (releaseResource) {
00442         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
00443         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00444     }
00445     <span class="keywordflow">return</span> status;
00446 }
00447 
00448 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00449"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a2">00449</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a2">IopRemoveStringFromValueKey</a> (
00450     IN HANDLE Handle,
00451     IN PWSTR ValueName,
00452     IN PUNICODE_STRING String
00453     )
00454 
00455 <span class="comment">/*++</span>
00456 <span class="comment"></span>
00457 <span class="comment">Routine Description:</span>
00458 <span class="comment"></span>
00459 <span class="comment">    This routine remove a string from a value entry specified by ValueName</span>
00460 <span class="comment">    under an already opened registry handle.  Note, this routine will not</span>
00461 <span class="comment">    delete the ValueName entry even it becomes empty after the removal.</span>
00462 <span class="comment"></span>
00463 <span class="comment">Parameters:</span>
00464 <span class="comment"></span>
00465 <span class="comment">    Handle - Supplies the handle to a registry key whose value entry will</span>
00466 <span class="comment">        be modified.</span>
00467 <span class="comment"></span>
00468 <span class="comment">    ValueName - Supplies a unicode string to specify the value entry.</span>
00469 <span class="comment"></span>
00470 <span class="comment">    String - Supplies a unicode string to remove from value entry.</span>
00471 <span class="comment"></span>
00472 <span class="comment">Return Value:</span>
00473 <span class="comment"></span>
00474 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
00475 <span class="comment"></span>
00476 <span class="comment">--*/</span>
00477 
00478 {
00479     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
00480     UNICODE_STRING unicodeString;
00481     PWSTR nextString, currentString;
00482     ULONG length, leftLength;
00483     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00484     BOOLEAN found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00485 
00486     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length / <span class="keyword">sizeof</span>(WCHAR) == 0) {
00487         <span class="keywordflow">return</span> STATUS_SUCCESS;
00488     }
00489 
00490     <span class="comment">//</span>
00491     <span class="comment">// Read registry value entry data</span>
00492     <span class="comment">//</span>
00493 
00494     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>, <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>, &amp;keyValueInformation);
00495 
00496     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00497         <span class="keywordflow">return</span> status;
00498     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type != REG_MULTI_SZ) ||
00499                (keyValueInformation-&gt;DataLength == 0)) {
00500 
00501         status = (keyValueInformation-&gt;Type == REG_MULTI_SZ) ? STATUS_SUCCESS
00502                                                              : STATUS_INVALID_PARAMETER;
00503         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00504         <span class="keywordflow">return</span> status;
00505     }
00506 
00507     <span class="comment">//</span>
00508     <span class="comment">// Scan through the multi_sz string to find the matching string</span>
00509     <span class="comment">// and remove it.</span>
00510     <span class="comment">//</span>
00511 
00512     status = STATUS_SUCCESS;
00513     currentString = (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
00514     leftLength = keyValueInformation-&gt;DataLength;
00515     <span class="keywordflow">while</span> (!found &amp;&amp; leftLength &gt;= <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length + <span class="keyword">sizeof</span>(WCHAR)) {
00516         unicodeString.Buffer = currentString;
00517         length = wcslen( currentString ) * <span class="keyword">sizeof</span>( WCHAR );
00518         unicodeString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)length;
00519         length += <span class="keyword">sizeof</span>(UNICODE_NULL);
00520         unicodeString.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)length;
00521         nextString = currentString + length / <span class="keyword">sizeof</span>(WCHAR);
00522         leftLength -= length;
00523 
00524         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(&amp;unicodeString, <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00525             found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00526             RtlMoveMemory(currentString, nextString, leftLength);
00527             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeString, <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>);
00528             status = ZwSetValueKey(
00529                         <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
00530                         &amp;unicodeString,
00531                         <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00532                         REG_MULTI_SZ,
00533                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
00534                         keyValueInformation-&gt;DataLength - length
00535                         );
00536             <span class="keywordflow">break</span>;
00537         } <span class="keywordflow">else</span> {
00538             currentString = nextString;
00539         }
00540     }
00541     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00542     <span class="keywordflow">return</span> status;
00543 }
00544 
00545 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00546"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a3">00546</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a3">IopAppendStringToValueKey</a> (
00547     IN HANDLE Handle,
00548     IN PWSTR ValueName,
00549     IN PUNICODE_STRING String,
00550     IN BOOLEAN Create
00551     )
00552 
00553 <span class="comment">/*++</span>
00554 <span class="comment"></span>
00555 <span class="comment">Routine Description:</span>
00556 <span class="comment"></span>
00557 <span class="comment">    This routine appends a string to a value entry specified by ValueName</span>
00558 <span class="comment">    under an already opened registry handle.  If the ValueName is not present</span>
00559 <span class="comment">    and Create is TRUE, a new value entry will be created using the name</span>
00560 <span class="comment">    ValueName.</span>
00561 <span class="comment"></span>
00562 <span class="comment">Parameters:</span>
00563 <span class="comment"></span>
00564 <span class="comment">    Handle - Supplies the handle to a registry key whose value entry will</span>
00565 <span class="comment">        be modified.</span>
00566 <span class="comment"></span>
00567 <span class="comment">    ValueName - Supplies a pointer to a string to specify the value entry.</span>
00568 <span class="comment"></span>
00569 <span class="comment">    String - Supplies a unicode string to append to the value entry.</span>
00570 <span class="comment"></span>
00571 <span class="comment">    Create - Supplies a BOOLEAN variable to indicate if the ValueName</span>
00572 <span class="comment">        value entry should be created if it is not present.</span>
00573 <span class="comment"></span>
00574 <span class="comment">Return Value:</span>
00575 <span class="comment"></span>
00576 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
00577 <span class="comment"></span>
00578 <span class="comment">--*/</span>
00579 
00580 {
00581     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
00582     PWSTR destinationString, p;
00583     UNICODE_STRING unicodeValueName;
00584     ULONG size;
00585     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00586 
00587     <span class="keywordflow">if</span> ( !<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> || (<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length &lt; <span class="keyword">sizeof</span>(WCHAR)) ) {
00588         <span class="keywordflow">return</span> STATUS_SUCCESS;
00589     }
00590 
00591     <span class="comment">//</span>
00592     <span class="comment">// Read registry value entry data</span>
00593     <span class="comment">//</span>
00594 
00595     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>, <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>, &amp;keyValueInformation);
00596 
00597     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00598         <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND &amp;&amp; <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a>) {
00599 
00600             <span class="comment">//</span>
00601             <span class="comment">// if no valid entry exists and user said ok to create one</span>
00602             <span class="comment">//</span>
00603 
00604             keyValueInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00605         } <span class="keywordflow">else</span> {
00606             <span class="keywordflow">return</span> status;
00607         }
00608     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(keyValueInformation-&gt;Type != REG_MULTI_SZ) {
00609 
00610         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00611 
00612         <span class="keywordflow">if</span>(<a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a>) {
00613             keyValueInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00614         } <span class="keywordflow">else</span> {
00615             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
00616         }
00617 
00618     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(keyValueInformation-&gt;DataLength &lt; <span class="keyword">sizeof</span>(WCHAR) ||
00619               *(PWCHAR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation) == UNICODE_NULL) {  <span class="comment">// empty or one NULL WCHAR</span>
00620 
00621         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00622         keyValueInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00623     }
00624 
00625     <span class="comment">//</span>
00626     <span class="comment">// Allocate a buffer to hold new data for the specified key value entry</span>
00627     <span class="comment">// Make sure the buffer is at least an empty MULTI_SZ big.</span>
00628     <span class="comment">//</span>
00629 
00630     <span class="keywordflow">if</span> (keyValueInformation) {
00631         size = keyValueInformation-&gt;DataLength + <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length + <span class="keyword">sizeof</span> (UNICODE_NULL);
00632     } <span class="keywordflow">else</span> {
00633         size =  <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length + 2 * <span class="keyword">sizeof</span>(UNICODE_NULL);
00634     }
00635 
00636     destinationString = p = (PWSTR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, size);
00637     <span class="keywordflow">if</span> (destinationString == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00638         <span class="keywordflow">if</span> (keyValueInformation) {
00639             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00640         }
00641         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00642     }
00643 
00644     <span class="comment">//</span>
00645     <span class="comment">// Copy the existing data to our newly allocated buffer, if any</span>
00646     <span class="comment">//</span>
00647 
00648     <span class="keywordflow">if</span> (keyValueInformation) {
00649 
00650         <span class="comment">//</span>
00651         <span class="comment">// Note we  need to remove a UNICODE_NULL because the</span>
00652         <span class="comment">// MULTI_SZ has two terminating UNICODE_NULL.</span>
00653         <span class="comment">//</span>
00654 
00655         RtlMoveMemory(p,
00656                       <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
00657                       keyValueInformation-&gt;DataLength - <span class="keyword">sizeof</span>(WCHAR)
00658                       );
00659         p += keyValueInformation-&gt;DataLength / <span class="keyword">sizeof</span>(WCHAR) - 1;
00660 
00661         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00662     }
00663 
00664     <span class="comment">//</span>
00665     <span class="comment">// Append the user specified unicode string to our buffer</span>
00666     <span class="comment">//</span>
00667     RtlMoveMemory(p,
00668                   <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Buffer,
00669                   <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length
00670                   );
00671     p += <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length / <span class="keyword">sizeof</span>(WCHAR);
00672     *p = UNICODE_NULL;
00673     p++;
00674     *p = UNICODE_NULL;
00675 
00676     <span class="comment">//</span>
00677     <span class="comment">// Finally write the data to the specified registy value entry</span>
00678     <span class="comment">//</span>
00679 
00680     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeValueName, <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>);
00681     status = ZwSetValueKey(
00682                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
00683                 &amp;unicodeValueName,
00684                 <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00685                 REG_MULTI_SZ,
00686                 destinationString,
00687                 size
00688                 );
00689 
00690     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(destinationString);
00691     <span class="keywordflow">return</span> status;
00692 }
00693 
00694 BOOLEAN
<a name="l00695"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">00695</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a> (
00696     OUT PUNICODE_STRING Destination,
00697     IN  PUNICODE_STRING String1,
00698     IN  PUNICODE_STRING String2  OPTIONAL
00699     )
00700 
00701 <span class="comment">/*++</span>
00702 <span class="comment"></span>
00703 <span class="comment">Routine Description:</span>
00704 <span class="comment"></span>
00705 <span class="comment">    This routine returns a buffer containing the concatenation of the</span>
00706 <span class="comment">    two specified strings.  Since String2 is optional, this function may</span>
00707 <span class="comment">    also be used to make a copy of a unicode string.  Paged pool space</span>
00708 <span class="comment">    is allocated for the destination string.  Caller must release the</span>
00709 <span class="comment">    space once done with it.</span>
00710 <span class="comment"></span>
00711 <span class="comment">Parameters:</span>
00712 <span class="comment"></span>
00713 <span class="comment">    Destination - Supplies a variable to receive the handle of the</span>
00714 <span class="comment">        newly created key.</span>
00715 <span class="comment"></span>
00716 <span class="comment">    String1 - Supplies a pointer to the frist UNICODE_STRING.</span>
00717 <span class="comment"></span>
00718 <span class="comment">    String2 - Supplies an optional pointer to the second UNICODE_STRING.</span>
00719 <span class="comment"></span>
00720 <span class="comment">Return Value:</span>
00721 <span class="comment"></span>
00722 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
00723 <span class="comment"></span>
00724 <span class="comment">--*/</span>
00725 
00726 {
00727     ULONG length;
00728     PWSTR buffer;
00729 
00730     length = <a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL);
00731     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(<a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a>)) {
00732         length += <a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a>-&gt;Length;
00733     }
00734     buffer = (PWSTR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, length);
00735     <span class="keywordflow">if</span> (!buffer) {
00736         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00737     }
00738     Destination-&gt;Buffer = buffer;
00739     Destination-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)length - <span class="keyword">sizeof</span>(UNICODE_NULL);
00740     Destination-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)length;
00741     RtlMoveMemory (Destination-&gt;Buffer, <a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>-&gt;Buffer, <a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>-&gt;Length);
00742     <span class="keywordflow">if</span>(ARGUMENT_PRESENT(<a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a>)) {
00743         RtlMoveMemory((PUCHAR)Destination-&gt;Buffer + <a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>-&gt;Length,
00744                       <a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a>-&gt;Buffer,
00745                       <a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a>-&gt;Length
00746                      );
00747     }
00748     buffer[length / <span class="keyword">sizeof</span>(WCHAR) - 1] = UNICODE_NULL;
00749     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00750 }
00751 
00752 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00753"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a5">00753</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a5">IopPrepareDriverLoading</a> (
00754     IN PUNICODE_STRING KeyName,
00755     IN HANDLE KeyHandle,
00756     IN PIMAGE_NT_HEADERS Header
00757     )
00758 
00759 <span class="comment">/*++</span>
00760 <span class="comment"></span>
00761 <span class="comment">Routine Description:</span>
00762 <span class="comment"></span>
00763 <span class="comment">    This routine first checks if the driver is loadable.  If its a</span>
00764 <span class="comment">    PnP driver, it will always be loaded (we trust it to do the right</span>
00765 <span class="comment">    things.)  If it is a legacy driver, we need to check if its device</span>
00766 <span class="comment">    has been disabled.  Once we decide to load the driver, the Enum</span>
00767 <span class="comment">    subkey of the service node will be checked for duplicates, if any.</span>
00768 <span class="comment"></span>
00769 <span class="comment">Parameters:</span>
00770 <span class="comment"></span>
00771 <span class="comment">    KeyName - Supplies a pointer to the driver's service key unicode string</span>
00772 <span class="comment"></span>
00773 <span class="comment">    KeyHandle - Supplies a handle to the driver service node in the registry</span>
00774 <span class="comment">        that describes the driver to be loaded.</span>
00775 <span class="comment"></span>
00776 <span class="comment">Return Value:</span>
00777 <span class="comment"></span>
00778 <span class="comment">    The function value is the final status of the load operation.</span>
00779 <span class="comment"></span>
00780 <span class="comment">--*/</span>
00781 
00782 {
00783     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00784     PKEY_VALUE_FULL_INFORMATION keyValueInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00785     ULONG tmp, count = 0;
00786     HANDLE serviceEnumHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, sysEnumXxxHandle, controlHandle;
00787     UNICODE_STRING unicodeKeyName, unicodeValueName;
00788     BOOLEAN IsPlugPlayDriver = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00789 
00790     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00791     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00792 
00793     <span class="comment">//</span>
00794     <span class="comment">// Check should this driver be loaded.  If it is a PnP driver and has at least</span>
00795     <span class="comment">// one device instance enabled, it will be loaded. If it is a legacy driver,</span>
00796     <span class="comment">// we need to check if its device has been disabled.</span>
00797     <span class="comment">//</span>
00798 
00799     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>) &amp;&amp;
00800         (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;OptionalHeader.DllCharacteristics &amp; IMAGE_DLLCHARACTERISTICS_WDM_DRIVER)) {
00801         IsPlugPlayDriver = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00802     }
00803     <span class="keywordflow">if</span> (IsPlugPlayDriver) {
00804 
00805         <span class="comment">//</span>
00806         <span class="comment">// BUGBUG - For SUR, we load the driver only if device instance list is not</span>
00807         <span class="comment">// empty and at least one device instance is enabled.</span>
00808         <span class="comment">//</span>
00809 
00810         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a19">IopIsAnyDeviceInstanceEnabled</a>(<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>, KeyHandle, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00811             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a15">PnPDetectionEnabled</a>) {
00812 
00813                 <span class="comment">//</span>
00814                 <span class="comment">// We need to load WDM driver on TextMode Setup phase.</span>
00815                 <span class="comment">//</span>
00816 
00817                 status = STATUS_SUCCESS;
00818             } <span class="keywordflow">else</span> {
00819                 status = STATUS_PLUGPLAY_NO_DEVICE;
00820            }
00821            <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
00822 
00823         }
00824     } <span class="keywordflow">else</span> {
00825 
00826         <span class="comment">//</span>
00827         <span class="comment">// If this is a legacy driver, then we need to check if its</span>
00828         <span class="comment">// device has been disabled. (There should be NO more than one device</span>
00829         <span class="comment">// instance for legacy driver.)</span>
00830         <span class="comment">//</span>
00831 
00832         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a19">IopIsAnyDeviceInstanceEnabled</a>(<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>, KeyHandle, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00833 
00834             <span class="comment">//</span>
00835             <span class="comment">// If the device is not enabled, it may be because there is no device</span>
00836             <span class="comment">// instance.  If this is the case, we need to create a madeup key as</span>
00837             <span class="comment">// the device instance for the legacy driver.</span>
00838             <span class="comment">//</span>
00839 
00840             <span class="comment">//</span>
00841             <span class="comment">// First open registry ServiceKeyName\Enum branch</span>
00842             <span class="comment">//</span>
00843 
00844             PiWstrToUnicodeString(&amp;unicodeKeyName, REGSTR_KEY_ENUM);
00845             status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;serviceEnumHandle,
00846                                         KeyHandle,
00847                                         &amp;unicodeKeyName,
00848                                         KEY_ALL_ACCESS,
00849                                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00850                                         );
00851 
00852             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00853                 <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
00854             }
00855 
00856             <span class="comment">//</span>
00857             <span class="comment">// Find out how many device instances listed in the ServiceName's</span>
00858             <span class="comment">// Enum key.</span>
00859             <span class="comment">//</span>
00860 
00861             status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> ( serviceEnumHandle,
00862                                            REGSTR_VALUE_COUNT,
00863                                            &amp;keyValueInformation
00864                                            );
00865             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00866                 <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
00867                     (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
00868 
00869                     count = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
00870                 }
00871                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00872             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status != STATUS_OBJECT_PATH_NOT_FOUND &amp;&amp;
00873                        status != STATUS_OBJECT_NAME_NOT_FOUND) {
00874 
00875                 ZwClose(serviceEnumHandle);
00876                 <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
00877             }
00878 
00879             <span class="keywordflow">if</span> (count == 0) {
00880 
00881                 <span class="comment">//</span>
00882                 <span class="comment">// If there is no Enum key or instance under Enum for the</span>
00883                 <span class="comment">// legacy driver we will create a madeup node for it.</span>
00884                 <span class="comment">//</span>
00885 
00886                 status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a1">IopCreateMadeupNode</a>(<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,
00887                                              &amp;sysEnumXxxHandle,
00888                                              &amp;unicodeKeyName,
00889                                              &amp;tmp,
00890                                              <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00891 
00892                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00893                     ZwClose(serviceEnumHandle);
00894                     <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
00895                 }
00896                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeKeyName);
00897 
00898                 <span class="comment">//</span>
00899                 <span class="comment">// Create and set Control\ActiveService value</span>
00900                 <span class="comment">//</span>
00901 
00902                 PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_KEY_CONTROL);
00903                 status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;controlHandle,
00904                                             sysEnumXxxHandle,
00905                                             &amp;unicodeValueName,
00906                                             KEY_ALL_ACCESS,
00907                                             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00908                                             );
00909                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00910                     PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VAL_ACTIVESERVICE);
00911                     ZwSetValueKey(
00912                                 controlHandle,
00913                                 &amp;unicodeValueName,
00914                                 <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00915                                 REG_SZ,
00916                                 <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>-&gt;Buffer,
00917                                 <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL)
00918                                 );
00919 
00920                     ZwClose(controlHandle);
00921                 }
00922                 count++;
00923 
00924                 <span class="comment">//</span>
00925                 <span class="comment">// Don't forget to update the "Count=" and "NextInstance=" value entries</span>
00926                 <span class="comment">//</span>
00927 
00928                 PiWstrToUnicodeString( &amp;unicodeValueName, REGSTR_VALUE_COUNT);
00929 
00930                 ZwSetValueKey(serviceEnumHandle,
00931                               &amp;unicodeValueName,
00932                               <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00933                               REG_DWORD,
00934                               &amp;count,
00935                               <span class="keyword">sizeof</span> (count)
00936                               );
00937                 PiWstrToUnicodeString( &amp;unicodeValueName, REGSTR_VALUE_NEXT_INSTANCE);
00938 
00939                 ZwSetValueKey(serviceEnumHandle,
00940                               &amp;unicodeValueName,
00941                               <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00942                               REG_DWORD,
00943                               &amp;count,
00944                               <span class="keyword">sizeof</span> (count)
00945                               );
00946                 ZwClose(sysEnumXxxHandle);
00947                 ZwClose(serviceEnumHandle);
00948             } <span class="keywordflow">else</span> {
00949                 ZwClose(serviceEnumHandle);
00950                 status = STATUS_PLUGPLAY_NO_DEVICE;
00951                 <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
00952             }
00953         }
00954     }
00955 
00956     status = STATUS_SUCCESS;
00957 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
00958     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
00959     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00960     <span class="keywordflow">return</span> status;
00961 }
00962 
00963 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00964"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a6">00964</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a6">IopServiceInstanceToDeviceInstance</a> (
00965     IN  HANDLE ServiceKeyHandle OPTIONAL,
00966     IN  PUNICODE_STRING ServiceKeyName OPTIONAL,
00967     IN  ULONG ServiceInstanceOrdinal,
00968     OUT PUNICODE_STRING DeviceInstanceRegistryPath OPTIONAL,
00969     OUT PHANDLE DeviceInstanceHandle OPTIONAL,
00970     IN  ACCESS_MASK DesiredAccess
00971     )
00972 
00973 <span class="comment">/*++</span>
00974 <span class="comment"></span>
00975 <span class="comment">Routine Description:</span>
00976 <span class="comment"></span>
00977 <span class="comment">    This routine reads the service node enum entry to find the desired device instance</span>
00978 <span class="comment">    under the System\Enum tree.  It then optionally returns the registry path of the</span>
00979 <span class="comment">    specified device instance (relative to HKLM\System\Enum) and an open handle</span>
00980 <span class="comment">    to that registry key.</span>
00981 <span class="comment"></span>
00982 <span class="comment">    It is the caller's responsibility to close the handle returned if</span>
00983 <span class="comment">    DeviceInstanceHandle is supplied, and also to free the (PagedPool) memory</span>
00984 <span class="comment">    allocated for the unicode string buffer of DeviceInstanceRegistryPath, if</span>
00985 <span class="comment">    supplied.</span>
00986 <span class="comment"></span>
00987 <span class="comment">Parameters:</span>
00988 <span class="comment"></span>
00989 <span class="comment">    ServiceKeyHandle - Optionally, supplies a handle to the driver service node in the</span>
00990 <span class="comment">        registry that controls this device instance.  If this argument is not specified,</span>
00991 <span class="comment">        then ServiceKeyName is used to specify the service entry.</span>
00992 <span class="comment"></span>
00993 <span class="comment">    ServiceKeyName - Optionally supplies the name of the service entry that controls</span>
00994 <span class="comment">        the device instance. This must be specified if ServiceKeyHandle isn't given.</span>
00995 <span class="comment"></span>
00996 <span class="comment">    ServiceInstanceOrdinal - Supplies the instance value under the service entry's</span>
00997 <span class="comment">        volatile Enum subkey that references the desired device instance.</span>
00998 <span class="comment"></span>
00999 <span class="comment">    DeviceInstanceRegistryPath - Optionally, supplies a pointer to a unicode string</span>
01000 <span class="comment">        that will be initialized with the registry path (relative to HKLM\System\Enum)</span>
01001 <span class="comment">        to the device instance key.</span>
01002 <span class="comment"></span>
01003 <span class="comment">    DeviceInstanceHandle - Optionally, supplies a pointer to a variable that will</span>
01004 <span class="comment">        receive a handle to the opened device instance registry key.</span>
01005 <span class="comment"></span>
01006 <span class="comment">    DesiredAccess - If DeviceInstanceHandle is specified (i.e., the device instance</span>
01007 <span class="comment">        key is to be opened), then this variable specifies the access that is needed</span>
01008 <span class="comment">        to this key.</span>
01009 <span class="comment"></span>
01010 <span class="comment">Return Value:</span>
01011 <span class="comment"></span>
01012 <span class="comment">    NT status code indicating whether the function was successful.</span>
01013 <span class="comment"></span>
01014 <span class="comment">--*/</span>
01015 
01016 {
01017     WCHAR unicodeBuffer[20];
01018     UNICODE_STRING unicodeKeyName;
01019     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01020     HANDLE handle;
01021     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
01022 
01023     <span class="comment">//</span>
01024     <span class="comment">// Open registry ServiceKeyName\Enum branch</span>
01025     <span class="comment">//</span>
01026     <span class="keywordflow">if</span>(ARGUMENT_PRESENT(ServiceKeyHandle)) {
01027 
01028         PiWstrToUnicodeString(&amp;unicodeKeyName, REGSTR_KEY_ENUM);
01029         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
01030                                     ServiceKeyHandle,
01031                                     &amp;unicodeKeyName,
01032                                     KEY_READ,
01033                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01034                                     );
01035     } <span class="keywordflow">else</span> {
01036 
01037         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">IopOpenServiceEnumKeys</a>(ServiceKeyName,
01038                                         KEY_READ,
01039                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01040                                         &amp;handle,
01041                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01042                                        );
01043     }
01044 
01045     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01046 
01047         <span class="comment">//</span>
01048         <span class="comment">// There is no registry key for the ServiceKeyName\Enum information.</span>
01049         <span class="comment">//</span>
01050 
01051         <span class="keywordflow">return</span> status;
01052     }
01053 
01054     <span class="comment">//</span>
01055     <span class="comment">// Read a path to System\Enum hardware tree branch specified by the service</span>
01056     <span class="comment">// instance ordinal</span>
01057     <span class="comment">//</span>
01058 
01059     swprintf(unicodeBuffer, REGSTR_VALUE_STANDARD_ULONG_FORMAT, ServiceInstanceOrdinal);
01060     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> ( handle,
01061                                    unicodeBuffer,
01062                                    &amp;keyValueInformation
01063                                    );
01064 
01065     ZwClose(handle);
01066     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01067         <span class="keywordflow">return</span> status;
01068     } <span class="keywordflow">else</span> {
01069         <span class="keywordflow">if</span>(keyValueInformation-&gt;Type == REG_SZ) {
01070             <a class="code" href="../../d9/d0/pnpiop_8h.html#a82">IopRegistryDataToUnicodeString</a>(&amp;unicodeKeyName,
01071                                            (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
01072                                            keyValueInformation-&gt;DataLength
01073                                           );
01074             <span class="keywordflow">if</span>(!unicodeKeyName.Length) {
01075                 status = STATUS_OBJECT_PATH_NOT_FOUND;
01076             }
01077         } <span class="keywordflow">else</span> {
01078             status = STATUS_INVALID_PLUGPLAY_DEVICE_PATH;
01079         }
01080 
01081         <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01082             <span class="keywordflow">goto</span> PrepareForReturn;
01083         }
01084     }
01085 
01086     <span class="comment">//</span>
01087     <span class="comment">// If the DeviceInstanceHandle argument was specified, open the device instance</span>
01088     <span class="comment">// key under HKLM\System\CurrentControlSet\Enum</span>
01089     <span class="comment">//</span>
01090 
01091     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(DeviceInstanceHandle)) {
01092 
01093         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
01094                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01095                                     &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a23">CmRegistryMachineSystemCurrentControlSetEnumName</a>,
01096                                     KEY_READ,
01097                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01098                                     );
01099 
01100         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01101 
01102             status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a> (DeviceInstanceHandle,
01103                                          handle,
01104                                          &amp;unicodeKeyName,
01105                                          DesiredAccess,
01106                                          <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01107                                          );
01108             ZwClose(handle);
01109         }
01110 
01111         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01112             <span class="keywordflow">goto</span> PrepareForReturn;
01113         }
01114     }
01115 
01116     <span class="comment">//</span>
01117     <span class="comment">// If the DeviceInstanceRegistryPath argument was specified, then store a</span>
01118     <span class="comment">// copy of the device instance path in the supplied unicode string variable.</span>
01119     <span class="comment">//</span>
01120     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(DeviceInstanceRegistryPath)) {
01121 
01122         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a>(DeviceInstanceRegistryPath,
01123                                           &amp;unicodeKeyName,
01124                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01125 
01126             <span class="keywordflow">if</span>(ARGUMENT_PRESENT(DeviceInstanceHandle)) {
01127                 ZwClose(*DeviceInstanceHandle);
01128             }
01129             status = STATUS_INSUFFICIENT_RESOURCES;
01130         }
01131     }
01132 
01133 PrepareForReturn:
01134 
01135     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
01136     <span class="keywordflow">return</span> status;
01137 }
01138 
01139 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01140"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a7">01140</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a7">IopOpenRegistryKeyPersist</a>(
01141     OUT PHANDLE Handle,
01142     IN HANDLE BaseHandle OPTIONAL,
01143     IN PUNICODE_STRING KeyName,
01144     IN ACCESS_MASK DesiredAccess,
01145     IN BOOLEAN Create,
01146     OUT PULONG Disposition OPTIONAL
01147     )
01148 
01149 <span class="comment">/*++</span>
01150 <span class="comment"></span>
01151 <span class="comment">Routine Description:</span>
01152 <span class="comment"></span>
01153 <span class="comment">    Opens or creates a PERSIST (non-volatile) registry key using the name</span>
01154 <span class="comment">    passed in based at the BaseHandle node. This name may specify a key</span>
01155 <span class="comment">    that is actually a registry path, in which case each intermediate subkey</span>
01156 <span class="comment">    will be created (if Create is TRUE).</span>
01157 <span class="comment"></span>
01158 <span class="comment">    NOTE: Creating a registry path (i.e., more than one of the keys in the path</span>
01159 <span class="comment">    do not presently exist) requires that a BaseHandle be specified.</span>
01160 <span class="comment"></span>
01161 <span class="comment">Arguments:</span>
01162 <span class="comment"></span>
01163 <span class="comment">    Handle - Pointer to the handle which will contain the registry key that</span>
01164 <span class="comment">        was opened.</span>
01165 <span class="comment"></span>
01166 <span class="comment">    BaseHandle - Optional handle to the base path from which the key must be opened.</span>
01167 <span class="comment">        If KeyName specifies a registry path that must be created, then this parameter</span>
01168 <span class="comment">        must be specified, and KeyName must be a relative path.</span>
01169 <span class="comment"></span>
01170 <span class="comment">    KeyName - Name of the Key that must be opened/created (possibly a registry path)</span>
01171 <span class="comment"></span>
01172 <span class="comment">    DesiredAccess - Specifies the desired access that the caller needs to</span>
01173 <span class="comment">        the key.</span>
01174 <span class="comment"></span>
01175 <span class="comment">    Create - Determines if the key is to be created if it does not exist.</span>
01176 <span class="comment"></span>
01177 <span class="comment">    Disposition - If Create is TRUE, this optional pointer receives a ULONG indicating</span>
01178 <span class="comment">        whether the key was newly created:</span>
01179 <span class="comment"></span>
01180 <span class="comment">            REG_CREATED_NEW_KEY - A new Registry Key was created</span>
01181 <span class="comment">            REG_OPENED_EXISTING_KEY - An existing Registry Key was opened</span>
01182 <span class="comment"></span>
01183 <span class="comment">Return Value:</span>
01184 <span class="comment"></span>
01185 <span class="comment">   The function value is the final status of the operation.</span>
01186 <span class="comment"></span>
01187 <span class="comment">--*/</span>
01188 
01189 {
01190     OBJECT_ATTRIBUTES objectAttributes;
01191     ULONG disposition, baseHandleIndex = 0, keyHandleIndex = 1, closeBaseHandle;
01192     HANDLE handles[2];
01193     BOOLEAN continueParsing;
01194     PWCHAR pathEndPtr, pathCurPtr, pathBeginPtr;
01195     ULONG pathComponentLength;
01196     UNICODE_STRING unicodeString;
01197     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01198 
01199     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01200 
01201     InitializeObjectAttributes(&amp;objectAttributes,
01202                                <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,
01203                                OBJ_CASE_INSENSITIVE,
01204                                BaseHandle,
01205                                (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01206                               );
01207     <span class="keywordflow">if</span>(<a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a>) {
01208         <span class="comment">//</span>
01209         <span class="comment">// Attempt to create the path as specified. We have to try it this</span>
01210         <span class="comment">// way first, because it allows us to create a key without a BaseHandle</span>
01211         <span class="comment">// (if only the last component of the registry path is not present).</span>
01212         <span class="comment">//</span>
01213         status = ZwCreateKey(&amp;(handles[keyHandleIndex]),
01214                              DesiredAccess,
01215                              &amp;objectAttributes,
01216                              0,
01217                              (PUNICODE_STRING) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01218                              REG_OPTION_NON_VOLATILE,
01219                              &amp;disposition
01220                             );
01221 
01222         <span class="keywordflow">if</span>(!((status == STATUS_OBJECT_NAME_NOT_FOUND) &amp;&amp; ARGUMENT_PRESENT(BaseHandle))) {
01223             <span class="comment">//</span>
01224             <span class="comment">// Then either we succeeded, or failed, but there's nothing we can do</span>
01225             <span class="comment">// about it. In either case, prepare to return.</span>
01226             <span class="comment">//</span>
01227             <span class="keywordflow">goto</span> PrepareForReturn;
01228         }
01229 
01230     } <span class="keywordflow">else</span> {
01231         <span class="comment">//</span>
01232         <span class="comment">// Simply attempt to open the path, as specified.</span>
01233         <span class="comment">//</span>
01234         <span class="keywordflow">return</span> ZwOpenKey(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
01235                          DesiredAccess,
01236                          &amp;objectAttributes
01237                         );
01238     }
01239 
01240     <span class="comment">//</span>
01241     <span class="comment">// If we get to here, then there must be more than one element of the</span>
01242     <span class="comment">// registry path that does not currently exist.  We will now parse the</span>
01243     <span class="comment">// specified path, extracting each component and doing a ZwCreateKey on it.</span>
01244     <span class="comment">//</span>
01245     handles[baseHandleIndex] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01246     handles[keyHandleIndex] = BaseHandle;
01247     closeBaseHandle = 0;
01248     continueParsing = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01249     pathBeginPtr = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>-&gt;Buffer;
01250     pathEndPtr = (PWCHAR)((PCHAR)pathBeginPtr + <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>-&gt;Length);
01251     status = STATUS_SUCCESS;
01252 
01253     <span class="keywordflow">while</span>(continueParsing) {
01254         <span class="comment">//</span>
01255         <span class="comment">// There's more to do, so close the previous base handle (if necessary),</span>
01256         <span class="comment">// and replace it with the current key handle.</span>
01257         <span class="comment">//</span>
01258         <span class="keywordflow">if</span>(closeBaseHandle &gt; 1) {
01259             ZwClose(handles[baseHandleIndex]);
01260         }
01261         baseHandleIndex = keyHandleIndex;
01262         keyHandleIndex = (keyHandleIndex + 1) &amp; 1;  <span class="comment">// toggle between 0 and 1.</span>
01263         handles[keyHandleIndex] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01264 
01265         <span class="comment">//</span>
01266         <span class="comment">// Extract next component out of the specified registry path.</span>
01267         <span class="comment">//</span>
01268         <span class="keywordflow">for</span>(pathCurPtr = pathBeginPtr;
01269             ((pathCurPtr &lt; pathEndPtr) &amp;&amp; (*pathCurPtr != OBJ_NAME_PATH_SEPARATOR));
01270             pathCurPtr++);
01271 
01272         <span class="keywordflow">if</span>((pathComponentLength = (ULONG)((PCHAR)pathCurPtr - (PCHAR)pathBeginPtr))) {
01273             <span class="comment">//</span>
01274             <span class="comment">// Then we have a non-empty path component (key name).  Attempt</span>
01275             <span class="comment">// to create this key.</span>
01276             <span class="comment">//</span>
01277             unicodeString.Buffer = pathBeginPtr;
01278             unicodeString.Length = unicodeString.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)pathComponentLength;
01279 
01280             InitializeObjectAttributes(&amp;objectAttributes,
01281                                        &amp;unicodeString,
01282                                        OBJ_CASE_INSENSITIVE,
01283                                        handles[baseHandleIndex],
01284                                        (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01285                                       );
01286             status = ZwCreateKey(&amp;(handles[keyHandleIndex]),
01287                                  DesiredAccess,
01288                                  &amp;objectAttributes,
01289                                  0,
01290                                  (PUNICODE_STRING) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01291                                  REG_OPTION_NON_VOLATILE,
01292                                  &amp;disposition
01293                                 );
01294             <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01295                 <span class="comment">//</span>
01296                 <span class="comment">// Increment the closeBaseHandle value, which basically tells us whether</span>
01297                 <span class="comment">// the BaseHandle passed in has been 'shifted out' of our way, so that</span>
01298                 <span class="comment">// we should start closing our base handles when we're finished with them.</span>
01299                 <span class="comment">//</span>
01300                 closeBaseHandle++;
01301             } <span class="keywordflow">else</span> {
01302                 continueParsing = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01303                 <span class="keywordflow">continue</span>;
01304             }
01305         } <span class="keywordflow">else</span> {
01306             <span class="comment">//</span>
01307             <span class="comment">// Either a path separator ('\') was included at the beginning of</span>
01308             <span class="comment">// the path, or we hit 2 consecutive separators.</span>
01309             <span class="comment">//</span>
01310             status = STATUS_INVALID_PARAMETER;
01311             continueParsing = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01312             <span class="keywordflow">continue</span>;
01313         }
01314 
01315         <span class="keywordflow">if</span>((pathCurPtr == pathEndPtr) ||
01316            ((pathBeginPtr = pathCurPtr + 1) == pathEndPtr)) {
01317             <span class="comment">//</span>
01318             <span class="comment">// Then we've reached the end of the path</span>
01319             <span class="comment">//</span>
01320             continueParsing = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01321         }
01322     }
01323 
01324     <span class="keywordflow">if</span>(closeBaseHandle &gt; 1) {
01325         ZwClose(handles[baseHandleIndex]);
01326     }
01327 
01328 PrepareForReturn:
01329 
01330     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01331         *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = handles[keyHandleIndex];
01332 
01333         <span class="keywordflow">if</span>(ARGUMENT_PRESENT(Disposition)) {
01334             *Disposition = disposition;
01335         }
01336     }
01337 
01338     <span class="keywordflow">return</span> status;
01339 }
01340 
01341 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01342"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">01342</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">IopOpenServiceEnumKeys</a> (
01343     IN PUNICODE_STRING ServiceKeyName,
01344     IN ACCESS_MASK DesiredAccess,
01345     OUT PHANDLE ServiceHandle OPTIONAL,
01346     OUT PHANDLE ServiceEnumHandle OPTIONAL,
01347     IN BOOLEAN CreateEnum
01348     )
01349 
01350 <span class="comment">/*++</span>
01351 <span class="comment"></span>
01352 <span class="comment">Routine Description:</span>
01353 <span class="comment"></span>
01354 <span class="comment">    This routine opens the HKEY_LOCAL_MACHINE\CurrentControlSet\Services\</span>
01355 <span class="comment">    ServiceKeyName and its Enum subkey and returns handles for both key.</span>
01356 <span class="comment">    It is caller's responsibility to close the returned handles.</span>
01357 <span class="comment"></span>
01358 <span class="comment">Arguments:</span>
01359 <span class="comment"></span>
01360 <span class="comment">    ServiceKeyName - Supplies a pointer to the name of the subkey in the</span>
01361 <span class="comment">        system service list (HKEY_LOCAL_MACHINE\CurrentControlSet\Services)</span>
01362 <span class="comment">        that caused the driver to load. This is the RegistryPath parameter</span>
01363 <span class="comment">        to the DriverEntry routine.</span>
01364 <span class="comment"></span>
01365 <span class="comment">    DesiredAccess - Specifies the desired access to the keys.</span>
01366 <span class="comment"></span>
01367 <span class="comment">    ServiceHandle - Supplies a variable to receive a handle to ServiceKeyName.</span>
01368 <span class="comment">        A NULL ServiceHandle indicates caller does not want need the handle to</span>
01369 <span class="comment">        the ServiceKeyName.</span>
01370 <span class="comment"></span>
01371 <span class="comment">    ServiceEnumHandle - Supplies a variable to receive a handle to ServiceKeyName\Enum.</span>
01372 <span class="comment">        A NULL ServiceEnumHandle indicates caller does not need the handle to</span>
01373 <span class="comment">        the ServiceKeyName\Enum.</span>
01374 <span class="comment"></span>
01375 <span class="comment">    CreateEnum - Supplies a BOOLEAN variable to indicate should the Enum subkey be</span>
01376 <span class="comment">        created if not present.</span>
01377 <span class="comment"></span>
01378 <span class="comment">Return Value:</span>
01379 <span class="comment"></span>
01380 <span class="comment">    status</span>
01381 <span class="comment"></span>
01382 <span class="comment">--*/</span>
01383 
01384 {
01385     HANDLE handle, serviceHandle, enumHandle;
01386     UNICODE_STRING enumName;
01387     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01388 
01389     <span class="comment">//</span>
01390     <span class="comment">// Open System\CurrentControlSet\Services</span>
01391     <span class="comment">//</span>
01392 
01393     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
01394                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01395                                 &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a25">CmRegistryMachineSystemCurrentControlSetServices</a>,
01396                                 DesiredAccess,
01397                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01398                                 );
01399 
01400     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01401         <span class="keywordflow">return</span> status;
01402     }
01403 
01404     <span class="comment">//</span>
01405     <span class="comment">// Open the registry ServiceKeyName key.</span>
01406     <span class="comment">//</span>
01407 
01408     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;serviceHandle,
01409                                 handle,
01410                                 ServiceKeyName,
01411                                 DesiredAccess,
01412                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01413                                 );
01414 
01415     ZwClose(handle);
01416     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01417 
01418         <span class="comment">//</span>
01419         <span class="comment">// There is no registry key for the ServiceKeyName information.</span>
01420         <span class="comment">//</span>
01421 
01422         <span class="keywordflow">return</span> status;
01423     }
01424 
01425     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ServiceEnumHandle) || CreateEnum) {
01426 
01427         <span class="comment">//</span>
01428         <span class="comment">// Open registry ServiceKeyName\Enum branch if caller wants</span>
01429         <span class="comment">// the handle or wants to create it.</span>
01430         <span class="comment">//</span>
01431 
01432         PiWstrToUnicodeString(&amp;enumName, REGSTR_KEY_ENUM);
01433         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;enumHandle,
01434                                     serviceHandle,
01435                                     &amp;enumName,
01436                                     DesiredAccess,
01437                                     CreateEnum
01438                                     );
01439 
01440         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01441 
01442             <span class="comment">//</span>
01443             <span class="comment">// There is no registry key for the ServiceKeyName\Enum information.</span>
01444             <span class="comment">//</span>
01445 
01446             ZwClose(serviceHandle);
01447             <span class="keywordflow">return</span> status;
01448         }
01449         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ServiceEnumHandle)) {
01450             *ServiceEnumHandle = enumHandle;
01451         } <span class="keywordflow">else</span> {
01452             ZwClose(enumHandle);
01453         }
01454     }
01455 
01456     <span class="comment">//</span>
01457     <span class="comment">// if caller wants to have the ServiceKey handle, we return it.  Otherwise</span>
01458     <span class="comment">// we close it.</span>
01459     <span class="comment">//</span>
01460 
01461     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ServiceHandle)) {
01462         *ServiceHandle = serviceHandle;
01463     } <span class="keywordflow">else</span> {
01464         ZwClose(serviceHandle);
01465     }
01466 
01467     <span class="keywordflow">return</span> STATUS_SUCCESS;
01468 }
01469 
01470 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01471"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a9">01471</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a9">IopGetDeviceInstanceCsConfigFlags</a>(
01472     IN PUNICODE_STRING ServiceKeyName,
01473     IN ULONG Instance,
01474     OUT PULONG CsConfigFlags
01475     )
01476 
01477 <span class="comment">/*++</span>
01478 <span class="comment"></span>
01479 <span class="comment">Routine Description:</span>
01480 <span class="comment"></span>
01481 <span class="comment">    This routine retrieves the csconfig flags for the specified device</span>
01482 <span class="comment">    which is specified by the instance number under ServiceKeyName\Enum.</span>
01483 <span class="comment"></span>
01484 <span class="comment">Arguments:</span>
01485 <span class="comment"></span>
01486 <span class="comment">    ServiceKeyName - Supplies a pointer to the name of the subkey in the</span>
01487 <span class="comment">        system service list (HKEY_LOCAL_MACHINE\CurrentControlSet\Services)</span>
01488 <span class="comment">        that caused the driver to load.</span>
01489 <span class="comment"></span>
01490 <span class="comment">    Instance - Supplies the instance value under ServiceKeyName\Enum key</span>
01491 <span class="comment"></span>
01492 <span class="comment">    CsConfigFlags - Supplies a variable to receive the device's CsConfigFlags</span>
01493 <span class="comment"></span>
01494 <span class="comment">Return Value:</span>
01495 <span class="comment"></span>
01496 <span class="comment">    status</span>
01497 <span class="comment"></span>
01498 <span class="comment">--*/</span>
01499 
01500 {
01501     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01502     HANDLE handle;
01503     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
01504 
01505     *CsConfigFlags = 0;
01506 
01507     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a11">IopOpenCurrentHwProfileDeviceInstanceKey</a>(&amp;handle,
01508                                                       ServiceKeyName,
01509                                                       Instance,
01510                                                       KEY_READ,
01511                                                       <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01512                                                      );
01513     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01514         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(handle,
01515                                      REGSTR_VALUE_CSCONFIG_FLAGS,
01516                                      &amp;keyValueInformation
01517                                     );
01518         <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01519             <span class="keywordflow">if</span>((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
01520                (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
01521                 *CsConfigFlags = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
01522             }
01523             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
01524         }
01525         ZwClose(handle);
01526     }
01527     <span class="keywordflow">return</span> status;
01528 }
01529 
01530 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01531"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a10">01531</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a10">IopSetDeviceInstanceCsConfigFlags</a>(
01532     IN PUNICODE_STRING ServiceKeyName,
01533     IN ULONG Instance,
01534     IN ULONG CsConfigFlags
01535     )
01536 
01537 <span class="comment">/*++</span>
01538 <span class="comment"></span>
01539 <span class="comment">Routine Description:</span>
01540 <span class="comment"></span>
01541 <span class="comment">    This routine sets the csconfig flags for the specified device</span>
01542 <span class="comment">    which is specified by the instance number under ServiceKeyName\Enum.</span>
01543 <span class="comment"></span>
01544 <span class="comment">Arguments:</span>
01545 <span class="comment"></span>
01546 <span class="comment">    ServiceKeyName - Supplies a pointer to the name of the subkey in the</span>
01547 <span class="comment">        system service list (HKEY_LOCAL_MACHINE\CurrentControlSet\Services)</span>
01548 <span class="comment">        that caused the driver to load. This is the RegistryPath parameter</span>
01549 <span class="comment">        to the DriverEntry routine.</span>
01550 <span class="comment"></span>
01551 <span class="comment">    Instance - Supplies the instance value under ServiceKeyName\Enum key</span>
01552 <span class="comment"></span>
01553 <span class="comment">    CsConfigFlags - Supplies the device instance's new CsConfigFlags</span>
01554 <span class="comment"></span>
01555 <span class="comment">Return Value:</span>
01556 <span class="comment"></span>
01557 <span class="comment">    status</span>
01558 <span class="comment"></span>
01559 <span class="comment">--*/</span>
01560 
01561 {
01562     HANDLE handle;
01563     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01564     UNICODE_STRING tempUnicodeString;
01565 
01566     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a11">IopOpenCurrentHwProfileDeviceInstanceKey</a>(&amp;handle,
01567                                                       ServiceKeyName,
01568                                                       Instance,
01569                                                       KEY_READ | KEY_WRITE,
01570                                                       <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
01571                                                      );
01572     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01573 
01574         PiWstrToUnicodeString(&amp;tempUnicodeString, REGSTR_VALUE_CSCONFIG_FLAGS);
01575         status = ZwSetValueKey(handle,
01576                                &amp;tempUnicodeString,
01577                                <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
01578                                REG_DWORD,
01579                                &amp;CsConfigFlags,
01580                                <span class="keyword">sizeof</span>(CsConfigFlags)
01581                               );
01582         ZwClose(handle);
01583     }
01584     <span class="keywordflow">return</span> status;
01585 }
01586 
01587 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01588"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a11">01588</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a11">IopOpenCurrentHwProfileDeviceInstanceKey</a>(
01589     OUT PHANDLE Handle,
01590     IN  PUNICODE_STRING ServiceKeyName,
01591     IN  ULONG Instance,
01592     IN  ACCESS_MASK DesiredAccess,
01593     IN  BOOLEAN Create
01594     )
01595 
01596 <span class="comment">/*++</span>
01597 <span class="comment"></span>
01598 <span class="comment">Routine Description:</span>
01599 <span class="comment"></span>
01600 <span class="comment">    This routine sets the csconfig flags for the specified device</span>
01601 <span class="comment">    which is specified by the instance number under ServiceKeyName\Enum.</span>
01602 <span class="comment"></span>
01603 <span class="comment">Arguments:</span>
01604 <span class="comment"></span>
01605 <span class="comment">    ServiceKeyName - Supplies a pointer to the name of the subkey in the</span>
01606 <span class="comment">        system service list (HKEY_LOCAL_MACHINE\CurrentControlSet\Services)</span>
01607 <span class="comment">        that caused the driver to load. This is the RegistryPath parameter</span>
01608 <span class="comment">        to the DriverEntry routine.</span>
01609 <span class="comment"></span>
01610 <span class="comment">    Instance - Supplies the instance value under ServiceKeyName\Enum key</span>
01611 <span class="comment"></span>
01612 <span class="comment">    DesiredAccess - Specifies the desired access that the caller needs to</span>
01613 <span class="comment">        the key.</span>
01614 <span class="comment"></span>
01615 <span class="comment">    Create - Determines if the key is to be created if it does not exist.</span>
01616 <span class="comment"></span>
01617 <span class="comment">Return Value:</span>
01618 <span class="comment"></span>
01619 <span class="comment">    status</span>
01620 <span class="comment"></span>
01621 <span class="comment">--*/</span>
01622 
01623 {
01624     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01625     UNICODE_STRING tempUnicodeString;
01626     HANDLE profileHandle, profileEnumHandle, tmpHandle;
01627 
01628     <span class="comment">//</span>
01629     <span class="comment">// See if we can open current hardware profile</span>
01630     <span class="comment">//</span>
01631     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;profileHandle,
01632                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01633                                 &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a26">CmRegistryMachineSystemCurrentControlSetHardwareProfilesCurrent</a>,
01634                                 KEY_READ,
01635                                 <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a>
01636                                 );
01637     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01638         <span class="comment">//</span>
01639         <span class="comment">// Now, we must open the System\CCS\Enum key under this.</span>
01640         <span class="comment">//</span>
01641         <span class="comment">//</span>
01642         <span class="comment">// Open system\CurrentControlSet under current hardware profile key</span>
01643         <span class="comment">//</span>
01644 
01645         PiWstrToUnicodeString(&amp;tempUnicodeString, REGSTR_PATH_CURRENTCONTROLSET);
01646         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;tmpHandle,
01647                                     profileHandle,
01648                                     &amp;tempUnicodeString,
01649                                     DesiredAccess,
01650                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01651                                     );
01652         ZwClose(profileHandle);
01653         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01654             <span class="keywordflow">return</span> status;
01655         }
01656 
01657         PiWstrToUnicodeString(&amp;tempUnicodeString, REGSTR_KEY_ENUM);
01658         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;profileEnumHandle,
01659                                     tmpHandle,
01660                                     &amp;tempUnicodeString,
01661                                     KEY_READ,
01662                                     <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a>
01663                                     );
01664         ZwClose(tmpHandle);
01665         <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01666 
01667             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a6">IopServiceInstanceToDeviceInstance</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01668                                                         ServiceKeyName,
01669                                                         Instance,
01670                                                         &amp;tempUnicodeString,
01671                                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01672                                                         0
01673                                                        );
01674             <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01675                 status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
01676                                             profileEnumHandle,
01677                                             &amp;tempUnicodeString,
01678                                             DesiredAccess,
01679                                             <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a>
01680                                             );
01681                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;tempUnicodeString);
01682             }
01683             ZwClose(profileEnumHandle);
01684         }
01685     }
01686     <span class="keywordflow">return</span> status;
01687 }
01688 
01689 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01690"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a12">01690</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a12">IopApplyFunctionToSubKeys</a>(
01691     IN     HANDLE BaseHandle OPTIONAL,
01692     IN     PUNICODE_STRING KeyName OPTIONAL,
01693     IN     ACCESS_MASK DesiredAccess,
01694     IN     BOOLEAN IgnoreNonCriticalErrors,
01695     IN     PIOP_SUBKEY_CALLBACK_ROUTINE SubKeyCallbackRoutine,
01696     IN OUT PVOID Context
01697     )
01698 
01699 <span class="comment">/*++</span>
01700 <span class="comment"></span>
01701 <span class="comment">Routine Description:</span>
01702 <span class="comment"></span>
01703 <span class="comment">    This routine enumerates all subkeys under the specified key, and calls</span>
01704 <span class="comment">    the specified callback routine for each subkey.</span>
01705 <span class="comment"></span>
01706 <span class="comment">Arguments:</span>
01707 <span class="comment"></span>
01708 <span class="comment">    BaseHandle - Optional handle to the base registry path. If KeyName is also</span>
01709 <span class="comment">        specified, then KeyName represents a subkey under this path.  If KeyName</span>
01710 <span class="comment">        is not specified, the subkeys are enumerated under this handle.  If this</span>
01711 <span class="comment">        parameter is not specified, then the full path to the base key must be</span>
01712 <span class="comment">        given in KeyName.</span>
01713 <span class="comment"></span>
01714 <span class="comment">    KeyName - Optional name of the key whose subkeys are to be enumerated.</span>
01715 <span class="comment"></span>
01716 <span class="comment">    DesiredAccess - Specifies the desired access that the callback routine</span>
01717 <span class="comment">        needs to the subkeys.  If no desired access is specified (i.e.,</span>
01718 <span class="comment">        DesiredAccess is zero), then no handle will be opened for the</span>
01719 <span class="comment">        subkeys, and the callback will be passed a NULL for its SubKeyHandle</span>
01720 <span class="comment">        parameter.</span>
01721 <span class="comment"></span>
01722 <span class="comment">    IgnoreNonCriticalErrors - Specifies whether this function should</span>
01723 <span class="comment">        immediately terminate on all errors, or only on critical ones.</span>
01724 <span class="comment">        An example of a non-critical error is when an enumerated subkey</span>
01725 <span class="comment">        cannot be opened for the desired access.</span>
01726 <span class="comment"></span>
01727 <span class="comment">    SubKeyCallbackRoutine - Supplies a pointer to a function that will</span>
01728 <span class="comment">        be called for each subkey found under the</span>
01729 <span class="comment">        specified key.  The prototype of the function</span>
01730 <span class="comment">        is as follows:</span>
01731 <span class="comment"></span>
01732 <span class="comment">            typedef BOOLEAN (*PIOP_SUBKEY_CALLBACK_ROUTINE) (</span>
01733 <span class="comment">                IN     HANDLE SubKeyHandle,</span>
01734 <span class="comment">                IN     PUNICODE_STRING SubKeyName,</span>
01735 <span class="comment">                IN OUT PVOID Context</span>
01736 <span class="comment">                );</span>
01737 <span class="comment"></span>
01738 <span class="comment">        where SubKeyHandle is the handle to an enumerated subkey under the</span>
01739 <span class="comment">        specified key, SubKeyName is its name, and Context is a pointer to</span>
01740 <span class="comment">        user-defined data.</span>
01741 <span class="comment"></span>
01742 <span class="comment">        This function should return TRUE to continue enumeration, or</span>
01743 <span class="comment">        FALSE to terminate it.</span>
01744 <span class="comment"></span>
01745 <span class="comment">    Context - Supplies a pointer to user-defined data that will be passed</span>
01746 <span class="comment">        in to the callback routine at each subkey invocation.</span>
01747 <span class="comment"></span>
01748 <span class="comment">Return Value:</span>
01749 <span class="comment"></span>
01750 <span class="comment">    NT status code indicating whether the subkeys were successfully</span>
01751 <span class="comment">    enumerated.  Note that this does not provide information on the</span>
01752 <span class="comment">    success or failure of the callback routine--if desired, this</span>
01753 <span class="comment">    information should be stored in the Context structure.</span>
01754 <span class="comment"></span>
01755 <span class="comment">--*/</span>
01756 
01757 {
01758     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01759     BOOLEAN CloseHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, ContinueEnumeration;
01760     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>, SubKeyHandle;
01761     ULONG i, RequiredBufferLength;
01762     PKEY_BASIC_INFORMATION KeyInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01763     <span class="comment">// Use an initial key name buffer size large enough for a 20-character key</span>
01764     <span class="comment">// (+ terminating NULL)</span>
01765     ULONG KeyInformationLength = <span class="keyword">sizeof</span>(KEY_BASIC_INFORMATION) + (20 * <span class="keyword">sizeof</span>(WCHAR));
01766     UNICODE_STRING SubKeyName;
01767 
01768     <span class="keywordflow">if</span>(ARGUMENT_PRESENT(<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>)) {
01769 
01770         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
01771                                     BaseHandle,
01772                                     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,
01773                                     KEY_READ,
01774                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01775                                    );
01776         <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01777             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01778         } <span class="keywordflow">else</span> {
01779             CloseHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01780         }
01781 
01782     } <span class="keywordflow">else</span> {
01783 
01784         <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = BaseHandle;
01785     }
01786 
01787     <span class="comment">//</span>
01788     <span class="comment">// Enumerate the subkeys until we run out of them.</span>
01789     <span class="comment">//</span>
01790     i = 0;
01791     SubKeyHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01792 
01793     <span class="keywordflow">while</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01794 
01795         <span class="keywordflow">if</span>(!KeyInformation) {
01796 
01797             KeyInformation = (PKEY_BASIC_INFORMATION)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01798                                                                     KeyInformationLength
01799                                                                    );
01800             <span class="keywordflow">if</span>(!KeyInformation) {
01801                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
01802                 <span class="keywordflow">break</span>;
01803             }
01804         }
01805 
01806         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwEnumerateKey(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
01807                                 i,
01808                                 KeyBasicInformation,
01809                                 KeyInformation,
01810                                 KeyInformationLength,
01811                                 &amp;RequiredBufferLength
01812                                );
01813 
01814         <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01815             <span class="keywordflow">if</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_OVERFLOW) {
01816                 <span class="comment">//</span>
01817                 <span class="comment">// Try again with larger buffer.</span>
01818                 <span class="comment">//</span>
01819                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyInformation);
01820                 KeyInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01821                 KeyInformationLength = RequiredBufferLength;
01822                 <span class="keywordflow">continue</span>;
01823 
01824             } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NO_MORE_ENTRIES) {
01825                 <span class="comment">//</span>
01826                 <span class="comment">// break out of loop</span>
01827                 <span class="comment">//</span>
01828                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01829                 <span class="keywordflow">break</span>;
01830 
01831             } <span class="keywordflow">else</span> {
01832                 <span class="comment">//</span>
01833                 <span class="comment">// This is a non-critical error.</span>
01834                 <span class="comment">//</span>
01835                 <span class="keywordflow">if</span>(IgnoreNonCriticalErrors) {
01836                     <span class="keywordflow">goto</span> ContinueWithNextSubKey;
01837                 } <span class="keywordflow">else</span> {
01838                     <span class="keywordflow">break</span>;
01839                 }
01840             }
01841         }
01842 
01843         <span class="comment">//</span>
01844         <span class="comment">// Initialize a unicode string with this key name.  Note that this string</span>
01845         <span class="comment">// WILL NOT be NULL-terminated.</span>
01846         <span class="comment">//</span>
01847         SubKeyName.Length = SubKeyName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)KeyInformation-&gt;NameLength;
01848         SubKeyName.Buffer = KeyInformation-&gt;Name;
01849 
01850         <span class="comment">//</span>
01851         <span class="comment">// If DesiredAccess is non-zero, open a handle to this subkey.</span>
01852         <span class="comment">//</span>
01853         <span class="keywordflow">if</span>(DesiredAccess) {
01854             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;SubKeyHandle,
01855                                         <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
01856                                         &amp;SubKeyName,
01857                                         DesiredAccess,
01858                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01859                                        );
01860             <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01861                 <span class="comment">//</span>
01862                 <span class="comment">// This is a non-critical error.</span>
01863                 <span class="comment">//</span>
01864                 <span class="keywordflow">if</span>(IgnoreNonCriticalErrors) {
01865                     <span class="keywordflow">goto</span> ContinueWithNextSubKey;
01866                 } <span class="keywordflow">else</span> {
01867                     <span class="keywordflow">break</span>;
01868                 }
01869             }
01870         }
01871 
01872         <span class="comment">//</span>
01873         <span class="comment">// Invoke the supplied callback function for this subkey.</span>
01874         <span class="comment">//</span>
01875         ContinueEnumeration = SubKeyCallbackRoutine(SubKeyHandle, &amp;SubKeyName, Context);
01876 
01877         <span class="keywordflow">if</span>(DesiredAccess) {
01878             ZwClose(SubKeyHandle);
01879         }
01880 
01881         <span class="keywordflow">if</span>(!ContinueEnumeration) {
01882             <span class="comment">//</span>
01883             <span class="comment">// Enumeration has been aborted.</span>
01884             <span class="comment">//</span>
01885             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01886             <span class="keywordflow">break</span>;
01887 
01888         }
01889 
01890 ContinueWithNextSubKey:
01891 
01892         i++;
01893     }
01894 
01895     <span class="keywordflow">if</span>(KeyInformation) {
01896         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyInformation);
01897     }
01898 
01899     <span class="keywordflow">if</span>(CloseHandle) {
01900         ZwClose(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
01901     }
01902 
01903     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01904 }
01905 
01906 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01907"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a13">01907</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a13">IopRegMultiSzToUnicodeStrings</a>(
01908     IN  PKEY_VALUE_FULL_INFORMATION KeyValueInformation,
01909     OUT PUNICODE_STRING *UnicodeStringList,
01910     OUT PULONG UnicodeStringCount
01911     )
01912 
01913 <span class="comment">/*++</span>
01914 <span class="comment"></span>
01915 <span class="comment">Routine Description:</span>
01916 <span class="comment"></span>
01917 <span class="comment">    This routine takes a KEY_VALUE_FULL_INFORMATION structure containing</span>
01918 <span class="comment">    a REG_MULTI_SZ value, and allocates an array of UNICODE_STRINGs,</span>
01919 <span class="comment">    initializing each one to a copy of one of the strings in the value entry.</span>
01920 <span class="comment">    All the resulting UNICODE_STRINGs will be NULL terminated</span>
01921 <span class="comment">    (MaximumLength = Length + sizeof(UNICODE_NULL)).</span>
01922 <span class="comment"></span>
01923 <span class="comment">    It is the responsibility of the caller to free the buffers for each</span>
01924 <span class="comment">    unicode string, as well as the buffer containing the UNICODE_STRING</span>
01925 <span class="comment">    array. This may be done by calling IopFreeUnicodeStringList.</span>
01926 <span class="comment"></span>
01927 <span class="comment">Arguments:</span>
01928 <span class="comment"></span>
01929 <span class="comment">    KeyValueInformation - Supplies the buffer containing the REG_MULTI_SZ</span>
01930 <span class="comment">        value entry data.</span>
01931 <span class="comment"></span>
01932 <span class="comment">    UnicodeStringList - Receives a pointer to an array of UNICODE_STRINGs, each</span>
01933 <span class="comment">        initialized with a copy of one of the strings in the REG_MULTI_SZ.</span>
01934 <span class="comment"></span>
01935 <span class="comment">    UnicodeStringCount - Receives the number of strings in the</span>
01936 <span class="comment">        UnicodeStringList.</span>
01937 <span class="comment"></span>
01938 <span class="comment">Returns:</span>
01939 <span class="comment"></span>
01940 <span class="comment">    NT status code indicating whether the function was successful.</span>
01941 <span class="comment"></span>
01942 <span class="comment">--*/</span>
01943 
01944 {
01945     PWCHAR p, BufferEnd, StringStart;
01946     ULONG StringCount, i, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>;
01947 
01948     <span class="comment">//</span>
01949     <span class="comment">// First, make sure this is really a REG_MULTI_SZ value.</span>
01950     <span class="comment">//</span>
01951     <span class="keywordflow">if</span>(KeyValueInformation-&gt;Type != REG_MULTI_SZ) {
01952         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01953     }
01954 
01955     <span class="comment">//</span>
01956     <span class="comment">// Make a preliminary pass through the buffer to count the number of strings</span>
01957     <span class="comment">// There will always be at least one string returned (possibly empty).</span>
01958     <span class="comment">//</span>
01959     StringCount = 0;
01960     p = (PWCHAR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(KeyValueInformation);
01961     BufferEnd = (PWCHAR)((PUCHAR)p + KeyValueInformation-&gt;DataLength);
01962     <span class="keywordflow">while</span>(p != BufferEnd) {
01963         <span class="keywordflow">if</span>(!*p) {
01964             StringCount++;
01965             <span class="keywordflow">if</span>(((p + 1) == BufferEnd) || !*(p + 1)) {
01966                 <span class="keywordflow">break</span>;
01967             }
01968         }
01969         p++;
01970     }
01971     <span class="keywordflow">if</span>(p == BufferEnd) {
01972         StringCount++;
01973     }
01974 
01975     *UnicodeStringList = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>(UNICODE_STRING) * StringCount);
01976     <span class="keywordflow">if</span>(!(*UnicodeStringList)) {
01977         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01978     }
01979 
01980     <span class="comment">//</span>
01981     <span class="comment">// Now, make a second pass through the buffer making copies of each string.</span>
01982     <span class="comment">//</span>
01983     i = 0;
01984     StringStart = p = (PWCHAR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(KeyValueInformation);
01985     <span class="keywordflow">while</span>(p != BufferEnd) {
01986         <span class="keywordflow">if</span>(!*p) {
01987             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a> = (ULONG)((PUCHAR)p - (PUCHAR)StringStart) + <span class="keyword">sizeof</span>(UNICODE_NULL);
01988             (*UnicodeStringList)[i].Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>);
01989 
01990             <span class="keywordflow">if</span>(!((*UnicodeStringList)[i].Buffer)) {
01991                 <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a17">IopFreeUnicodeStringList</a>(*UnicodeStringList, i);
01992                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01993             }
01994 
01995             RtlMoveMemory((*UnicodeStringList)[i].<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, StringStart, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>);
01996 
01997             (*UnicodeStringList)[i].Length =
01998                 ((*UnicodeStringList)[i].MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>)
01999                 - <span class="keyword">sizeof</span>(UNICODE_NULL);
02000 
02001             i++;
02002 
02003             <span class="keywordflow">if</span>(((p + 1) == BufferEnd) || !*(p + 1)) {
02004                 <span class="keywordflow">break</span>;
02005             } <span class="keywordflow">else</span> {
02006                 StringStart = p + 1;
02007             }
02008         }
02009         p++;
02010     }
02011     <span class="keywordflow">if</span>(p == BufferEnd) {
02012         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a> = (ULONG)((PUCHAR)p - (PUCHAR)StringStart);
02013         (*UnicodeStringList)[i].Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
02014                                                         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a> + <span class="keyword">sizeof</span>(UNICODE_NULL)
02015                                                        );
02016         <span class="keywordflow">if</span>(!((*UnicodeStringList)[i].Buffer)) {
02017             <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a17">IopFreeUnicodeStringList</a>(*UnicodeStringList, i);
02018             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02019         }
02020         <span class="keywordflow">if</span>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>) {
02021             RtlMoveMemory((*UnicodeStringList)[i].<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, StringStart, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>);
02022         }
02023         (*UnicodeStringList)[i].Buffer[CB_TO_CWC(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>)] = UNICODE_NULL;
02024 
02025         (*UnicodeStringList)[i].MaximumLength =
02026                 ((*UnicodeStringList)[i].Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>)
02027                 + <span class="keyword">sizeof</span>(UNICODE_NULL);
02028     }
02029 
02030     *UnicodeStringCount = StringCount;
02031 
02032     <span class="keywordflow">return</span> STATUS_SUCCESS;
02033 }
02034 
02035 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02036"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a14">02036</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a14">IopApplyFunctionToServiceInstances</a>(
02037     IN     HANDLE ServiceKeyHandle OPTIONAL,
02038     IN     PUNICODE_STRING ServiceKeyName OPTIONAL,
02039     IN     ACCESS_MASK DesiredAccess,
02040     IN     BOOLEAN IgnoreNonCriticalErrors,
02041     IN     PIOP_SUBKEY_CALLBACK_ROUTINE DevInstCallbackRoutine,
02042     IN OUT PVOID Context,
02043     OUT    PULONG ServiceInstanceOrdinal OPTIONAL
02044     )
02045 
02046 <span class="comment">/*++</span>
02047 <span class="comment"></span>
02048 <span class="comment">Routine Description:</span>
02049 <span class="comment"></span>
02050 <span class="comment">    This routine enumerates all device instances referenced by the instance</span>
02051 <span class="comment">    ordinal entries under a service's volatile Enum key, and calls</span>
02052 <span class="comment">    the specified callback routine for each instance's corresponding subkey</span>
02053 <span class="comment">    under HKLM\System\Enum.</span>
02054 <span class="comment"></span>
02055 <span class="comment">Arguments:</span>
02056 <span class="comment"></span>
02057 <span class="comment">    ServiceKeyHandle - Optional handle to the service entry. If this parameter</span>
02058 <span class="comment">        is not specified, then the service key name must be given in</span>
02059 <span class="comment">        ServiceKeyName (if both parameters are specified, then ServiceKeyHandle</span>
02060 <span class="comment">        is used, and ServiceKeyName is ignored).</span>
02061 <span class="comment"></span>
02062 <span class="comment">    ServiceKeyName - Optional name of the service entry key (under</span>
02063 <span class="comment">        HKLM\CurrentControlSet\Services). If this parameter is not specified,</span>
02064 <span class="comment">        then ServiceKeyHandle must contain a handle to the desired service key.</span>
02065 <span class="comment"></span>
02066 <span class="comment">    DesiredAccess - Specifies the desired access that the callback routine</span>
02067 <span class="comment">        needs to the enumerated device instance keys.  If no desired access is</span>
02068 <span class="comment">        specified (i.e., DesiredAccess is zero), then no handle will be opened</span>
02069 <span class="comment">        for the device instance keys, and the callback will be passed a NULL for</span>
02070 <span class="comment">        its DeviceInstanceHandle parameter.</span>
02071 <span class="comment"></span>
02072 <span class="comment">    IgnoreNonCriticalErrors - Specifies whether this function should</span>
02073 <span class="comment">        immediately terminate on all errors, or only on critical ones.</span>
02074 <span class="comment">        An example of a non-critical error is when an enumerated device instance</span>
02075 <span class="comment">        key cannot be opened for the desired access.</span>
02076 <span class="comment"></span>
02077 <span class="comment">    DevInstCallbackRoutine - Supplies a pointer to a function that will</span>
02078 <span class="comment">        be called for each device instance key referenced by a service instance</span>
02079 <span class="comment">        entry under the service's volatile Enum subkey. The prototype of the</span>
02080 <span class="comment">        function is as follows:</span>
02081 <span class="comment"></span>
02082 <span class="comment">            typedef BOOLEAN (*PIOP_SUBKEY_CALLBACK_ROUTINE) (</span>
02083 <span class="comment">                IN     HANDLE DeviceInstanceHandle,</span>
02084 <span class="comment">                IN     PUNICODE_STRING DeviceInstancePath,</span>
02085 <span class="comment">                IN OUT PVOID Context</span>
02086 <span class="comment">                );</span>
02087 <span class="comment"></span>
02088 <span class="comment">        where DeviceInstanceHandle is the handle to an enumerated device instance</span>
02089 <span class="comment">        key, DeviceInstancePath is the registry path (relative to</span>
02090 <span class="comment">        HKLM\System\Enum) to this device instance, and Context is a pointer to</span>
02091 <span class="comment">        user-defined data.</span>
02092 <span class="comment"></span>
02093 <span class="comment">        This function should return TRUE to continue enumeration, or</span>
02094 <span class="comment">        FALSE to terminate it.</span>
02095 <span class="comment"></span>
02096 <span class="comment">    Context - Supplies a pointer to user-defined data that will be passed</span>
02097 <span class="comment">        in to the callback routine at each device instance key invocation.</span>
02098 <span class="comment"></span>
02099 <span class="comment">    ServiceInstanceOrdinal - Optionally, receives the service instance ordinal (1 based)</span>
02100 <span class="comment">        that terminated the enumeration, or the total number of instances enumerated</span>
02101 <span class="comment">        if the enumeration completed without being aborted.</span>
02102 <span class="comment"></span>
02103 <span class="comment">Return Value:</span>
02104 <span class="comment"></span>
02105 <span class="comment">    NT status code indicating whether the device instance keys were successfully</span>
02106 <span class="comment">    enumerated.  Note that this does not provide information on the success or</span>
02107 <span class="comment">    failure of the callback routine--if desired, this information should be</span>
02108 <span class="comment">    stored in the Context structure.</span>
02109 <span class="comment"></span>
02110 <span class="comment">--*/</span>
02111 
02112 {
02113     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02114     HANDLE ServiceEnumHandle, SystemEnumHandle, DeviceInstanceHandle;
02115     UNICODE_STRING TempUnicodeString;
02116     ULONG ServiceInstanceCount, i, junk;
02117     PKEY_VALUE_FULL_INFORMATION KeyValueInformation;
02118     WCHAR ValueNameString[20];
02119     BOOLEAN ContinueEnumeration;
02120 
02121     <span class="comment">//</span>
02122     <span class="comment">// First, open up the volatile Enum subkey under the specified service entry.</span>
02123     <span class="comment">//</span>
02124 
02125     <span class="keywordflow">if</span>(ARGUMENT_PRESENT(ServiceKeyHandle)) {
02126         PiWstrToUnicodeString(&amp;TempUnicodeString, REGSTR_KEY_ENUM);
02127         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;ServiceEnumHandle,
02128                                     ServiceKeyHandle,
02129                                     &amp;TempUnicodeString,
02130                                     KEY_READ,
02131                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
02132                                    );
02133     } <span class="keywordflow">else</span> {
02134         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">IopOpenServiceEnumKeys</a>(ServiceKeyName,
02135                                         KEY_READ,
02136                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02137                                         &amp;ServiceEnumHandle,
02138                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
02139                                        );
02140     }
02141     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02142         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02143     }
02144 
02145     <span class="comment">//</span>
02146     <span class="comment">// Find out how many instances are referenced in the service's Enum key.</span>
02147     <span class="comment">//</span>
02148 
02149     ServiceInstanceCount = 0;   <span class="comment">// assume none.</span>
02150 
02151     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(ServiceEnumHandle,
02152                                  REGSTR_VALUE_COUNT,
02153                                  &amp;KeyValueInformation
02154                                 );
02155     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02156 
02157         <span class="keywordflow">if</span>((KeyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
02158            (KeyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
02159 
02160             ServiceInstanceCount = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(KeyValueInformation);
02161 
02162         }
02163         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyValueInformation);
02164 
02165     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_OBJECT_NAME_NOT_FOUND) {
02166         <span class="keywordflow">goto</span> PrepareForReturn;
02167     } <span class="keywordflow">else</span> {
02168         <span class="comment">//</span>
02169         <span class="comment">// If 'Count' value entry not found, consider this to mean there are simply</span>
02170         <span class="comment">// no device instance controlled by this service.</span>
02171         <span class="comment">//</span>
02172         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02173     }
02174 
02175     <span class="comment">//</span>
02176     <span class="comment">// Now, enumerate each service instance, and call the specified callback function</span>
02177     <span class="comment">// for the corresponding device instance.</span>
02178     <span class="comment">//</span>
02179 
02180     <span class="keywordflow">if</span> (ServiceInstanceCount) {
02181 
02182         <span class="keywordflow">if</span> (DesiredAccess) {
02183             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;SystemEnumHandle,
02184                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02185                                         &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a23">CmRegistryMachineSystemCurrentControlSetEnumName</a>,
02186                                         KEY_READ,
02187                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
02188                                        );
02189             <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02190                 <span class="keywordflow">goto</span> PrepareForReturn;
02191             }
02192         } <span class="keywordflow">else</span> {
02193             <span class="comment">//</span>
02194             <span class="comment">// Set DeviceInstanceHandle to NULL, since we won't be opening up the</span>
02195             <span class="comment">// device instance keys.</span>
02196             <span class="comment">//</span>
02197             DeviceInstanceHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02198         }
02199         KeyValueInformation = (PKEY_VALUE_FULL_INFORMATION)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
02200                                                               <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
02201                                                               <a class="code" href="../../d9/d0/pnpiop_8h.html#a86">PNP_SCRATCH_BUFFER_SIZE</a>);
02202         <span class="keywordflow">if</span> (!KeyValueInformation) {
02203             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
02204             <span class="keywordflow">goto</span> PrepareForReturn;
02205         }
02206         i = 0;
02207         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02208             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwEnumerateValueKey (           <span class="comment">// i was initialized to zero above.</span>
02209                             ServiceEnumHandle,
02210                             i++,
02211                             KeyValueFullInformation,
02212                             KeyValueInformation,
02213                             <a class="code" href="../../d9/d0/pnpiop_8h.html#a86">PNP_SCRATCH_BUFFER_SIZE</a>,
02214                             &amp;junk
02215                             );
02216 
02217             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02218                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NO_MORE_ENTRIES) {
02219                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02220                     <span class="keywordflow">break</span>;
02221                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(IgnoreNonCriticalErrors) {
02222                     <span class="keywordflow">continue</span>;
02223                 } <span class="keywordflow">else</span> {
02224                     <span class="keywordflow">break</span>;
02225                 }
02226             }
02227 
02228             <span class="keywordflow">if</span> (KeyValueInformation-&gt;Type != REG_SZ) {
02229                 <span class="keywordflow">continue</span>;
02230             }
02231 
02232             ContinueEnumeration = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02233             TempUnicodeString.Length = 0;
02234             <a class="code" href="../../d9/d0/pnpiop_8h.html#a82">IopRegistryDataToUnicodeString</a>(&amp;TempUnicodeString,
02235                                            (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(KeyValueInformation),
02236                                            KeyValueInformation-&gt;DataLength
02237                                            );
02238             <span class="keywordflow">if</span> (TempUnicodeString.Length) {
02239 
02240                 <span class="comment">//</span>
02241                 <span class="comment">// We have retrieved a (non-empty) string for this service instance.</span>
02242                 <span class="comment">// If the user specified a non-zero value for the DesiredAccess</span>
02243                 <span class="comment">// parameter, we will attempt to open up the corresponding device</span>
02244                 <span class="comment">// instance key under HKLM\System\Enum.</span>
02245                 <span class="comment">//</span>
02246                 <span class="keywordflow">if</span> (DesiredAccess) {
02247                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;DeviceInstanceHandle,
02248                                                 SystemEnumHandle,
02249                                                 &amp;TempUnicodeString,
02250                                                 DesiredAccess,
02251                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
02252                                                 );
02253                 }
02254 
02255                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02256                     <span class="comment">//</span>
02257                     <span class="comment">// Invoke the specified callback routine for this device instance.</span>
02258                     <span class="comment">//</span>
02259                     ContinueEnumeration = DevInstCallbackRoutine(DeviceInstanceHandle,
02260                                                                  &amp;TempUnicodeString,
02261                                                                  Context
02262                                                                 );
02263                     <span class="keywordflow">if</span> (DesiredAccess) {
02264                         ZwClose(DeviceInstanceHandle);
02265                     }
02266                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IgnoreNonCriticalErrors) {
02267                     <span class="keywordflow">continue</span>;
02268                 } <span class="keywordflow">else</span> {
02269                     <span class="keywordflow">break</span>;
02270                 }
02271             } <span class="keywordflow">else</span> {
02272                 <span class="keywordflow">continue</span>;
02273             }
02274             <span class="keywordflow">if</span> (!ContinueEnumeration) {
02275                 <span class="keywordflow">break</span>;
02276             }
02277         }
02278 
02279         <span class="keywordflow">if</span>(DesiredAccess) {
02280             ZwClose(SystemEnumHandle);
02281         }
02282         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyValueInformation);
02283     }
02284 
02285     <span class="keywordflow">if</span>(ARGUMENT_PRESENT(ServiceInstanceOrdinal)) {
02286         *ServiceInstanceOrdinal = i;
02287     }
02288 
02289 PrepareForReturn:
02290 
02291     ZwClose(ServiceEnumHandle);
02292 
02293     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02294 }
02295 
02296 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02297"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a15">02297</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a15">IopMarkDuplicateDevice</a> (
02298     IN PUNICODE_STRING TargetKeyName,
02299     IN ULONG TargetInstance,
02300     IN PUNICODE_STRING SourceKeyName,
02301     IN ULONG SourceInstance
02302     )
02303 
02304 <span class="comment">/*++</span>
02305 <span class="comment"></span>
02306 <span class="comment">Routine Description:</span>
02307 <span class="comment"></span>
02308 <span class="comment">    This routine marks the device instance specified by TargetKeyName and TargetInstance</span>
02309 <span class="comment">    as DuplicateOf the device specified by SourceKeyName and SourceInstance.</span>
02310 <span class="comment"></span>
02311 <span class="comment">Arguments:</span>
02312 <span class="comment"></span>
02313 <span class="comment">    TargetKeyName - supplies a pointer to the name of service key which will be marked</span>
02314 <span class="comment">        as duplicate.</span>
02315 <span class="comment"></span>
02316 <span class="comment">    TargetInstance - the instance number of the target device.</span>
02317 <span class="comment"></span>
02318 <span class="comment">    SourceKeyName - supplies a pointer to the name of service key.</span>
02319 <span class="comment"></span>
02320 <span class="comment">    SourceInstance - the instance number of the source device.</span>
02321 <span class="comment"></span>
02322 <span class="comment"></span>
02323 <span class="comment">Returns:</span>
02324 <span class="comment"></span>
02325 <span class="comment">    NTSTATUS code.</span>
02326 <span class="comment"></span>
02327 <span class="comment">--*/</span>
02328 
02329 {
02330     HANDLE handle;
02331     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02332     UNICODE_STRING sourceDeviceString, unicodeValueName;
02333 
02334     <span class="comment">//</span>
02335     <span class="comment">// Open the handle of the target device instance.</span>
02336     <span class="comment">//</span>
02337 
02338     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a6">IopServiceInstanceToDeviceInstance</a>(
02339                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02340                        TargetKeyName,
02341                        TargetInstance,
02342                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02343                        &amp;handle,
02344                        0
02345                        );
02346     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02347         <span class="keywordflow">return</span> status;
02348     }
02349 
02350     <span class="comment">//</span>
02351     <span class="comment">// Get the name of the source device instance</span>
02352     <span class="comment">//</span>
02353 
02354     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a6">IopServiceInstanceToDeviceInstance</a>(
02355                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02356                        SourceKeyName,
02357                        SourceInstance,
02358                        &amp;sourceDeviceString,
02359                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02360                        0
02361                        );
02362     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02363         <span class="keywordflow">return</span> status;
02364     }
02365 
02366     <span class="comment">//</span>
02367     <span class="comment">// Write the name of the source device to the DuplicateOf value entry of</span>
02368     <span class="comment">// target device key.</span>
02369     <span class="comment">//</span>
02370 
02371     PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_DUPLICATEOF);
02372     status = ZwSetValueKey(
02373                 handle,
02374                 &amp;unicodeValueName,
02375                 <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
02376                 REG_SZ,
02377                 &amp;sourceDeviceString,
02378                 sourceDeviceString.Length + <span class="keyword">sizeof</span>(WCHAR)
02379                 );
02380     <span class="keywordflow">return</span> status;
02381 }
02382 
02383 BOOLEAN
<a name="l02384"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a16">02384</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a16">IopIsDuplicatedDevices</a>(
02385     IN PCM_RESOURCE_LIST Configuration1,
02386     IN PCM_RESOURCE_LIST Configuration2,
02387     IN <a class="code" href="../../d6/d2/struct__HAL__BUS__INFORMATION.html">PHAL_BUS_INFORMATION</a> BusInfo1 OPTIONAL,
02388     IN <a class="code" href="../../d6/d2/struct__HAL__BUS__INFORMATION.html">PHAL_BUS_INFORMATION</a> BusInfo2 OPTIONAL
02389     )
02390 
02391 <span class="comment">/*++</span>
02392 <span class="comment"></span>
02393 <span class="comment">Routine Description:</span>
02394 <span class="comment"></span>
02395 <span class="comment">    This routine compares two set of configurations and bus information to</span>
02396 <span class="comment">    determine if the resources indicate the same device.  If BusInfo1 and</span>
02397 <span class="comment">    BusInfo2 both are absent, it means caller wants to compare the raw</span>
02398 <span class="comment">    resources.</span>
02399 <span class="comment"></span>
02400 <span class="comment">Arguments:</span>
02401 <span class="comment"></span>
02402 <span class="comment">    Configuration1 - Supplies a pointer to the first set of resource.</span>
02403 <span class="comment"></span>
02404 <span class="comment">    Configuration2 - Supplies a pointer to the second set of resource.</span>
02405 <span class="comment"></span>
02406 <span class="comment">    BusInfo1 - Supplies a pointer to the first set of bus information.</span>
02407 <span class="comment"></span>
02408 <span class="comment">    BusInfo2 - Supplies a pointer to the second set of bus information.</span>
02409 <span class="comment"></span>
02410 <span class="comment">Return Value:</span>
02411 <span class="comment"></span>
02412 <span class="comment">    returns TRUE if the two set of resources indicate the same device;</span>
02413 <span class="comment">    otherwise a value of FALSE is returned.</span>
02414 <span class="comment"></span>
02415 <span class="comment">--*/</span>
02416 
02417 {
02418     PCM_PARTIAL_RESOURCE_LIST list1, list2;
02419     PCM_PARTIAL_RESOURCE_DESCRIPTOR descriptor1, descriptor2;
02420 
02421     ULONG i, j;
02422     ULONG pass = 0;
02423 
02424     <span class="comment">//</span>
02425     <span class="comment">// The BusInfo for both resources must be both present or not present.</span>
02426     <span class="comment">//</span>
02427 
02428     <span class="keywordflow">if</span> ((ARGUMENT_PRESENT(BusInfo1) &amp;&amp; !ARGUMENT_PRESENT(BusInfo2)) ||
02429         (!ARGUMENT_PRESENT(BusInfo1) &amp;&amp; ARGUMENT_PRESENT(BusInfo2))) {
02430 
02431         <span class="comment">//</span>
02432         <span class="comment">// Unable to determine.</span>
02433         <span class="comment">//</span>
02434 
02435         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02436     }
02437 
02438     <span class="comment">//</span>
02439     <span class="comment">// Next check resources used by the two devices.</span>
02440     <span class="comment">// Currently, we *only* check the Io ports.</span>
02441     <span class="comment">//</span>
02442 
02443     <span class="keywordflow">if</span> (Configuration1-&gt;Count == 0 || Configuration2-&gt;Count == 0) {
02444 
02445         <span class="comment">//</span>
02446         <span class="comment">// If any one of the configuration data is empty, we assume</span>
02447         <span class="comment">// the devices are not duplicates.</span>
02448         <span class="comment">//</span>
02449 
02450         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02451     }
02452 
02453 RedoScan:
02454 
02455     list1 = &amp;(Configuration1-&gt;List[0].PartialResourceList);
02456     list2 = &amp;(Configuration2-&gt;List[0].PartialResourceList);
02457 
02458     <span class="keywordflow">for</span>(i = 0, descriptor1 = list1-&gt;PartialDescriptors;
02459         i &lt; list1-&gt;Count;
02460         i++, descriptor1++) {
02461 
02462         <span class="comment">//</span>
02463         <span class="comment">// If this is an i/o port or a memory range then look for a match</span>
02464         <span class="comment">// in the other list.</span>
02465         <span class="comment">//</span>
02466 
02467         <span class="keywordflow">if</span>((descriptor1-&gt;Type == CmResourceTypePort) ||
02468            (descriptor1-&gt;Type == CmResourceTypeMemory)) {
02469 
02470             <span class="keywordflow">for</span>(j = 0, descriptor2 = list2-&gt;PartialDescriptors;
02471                 j &lt; list2-&gt;Count;
02472                 j++, descriptor2++) {
02473 
02474                 <span class="comment">//</span>
02475                 <span class="comment">// If the types match then check to see if both addresses</span>
02476                 <span class="comment">// match as well.  If bus info was provided then go ahead</span>
02477                 <span class="comment">// and translate the ranges first.</span>
02478                 <span class="comment">//</span>
02479 
02480                 <span class="keywordflow">if</span>(descriptor1-&gt;Type == descriptor2-&gt;Type) {
02481 
02482                     PHYSICAL_ADDRESS range1, range1Translated;
02483                     PHYSICAL_ADDRESS range2, range2Translated;
02484                     ULONG range1IoSpace, range2IoSpace;
02485 
02486                     range1 = descriptor1-&gt;u.Generic.Start;
02487                     range2 = descriptor2-&gt;u.Generic.Start;
02488 
02489                     <span class="keywordflow">if</span>((range1.QuadPart == 0) ||
02490                        (BusInfo1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
02491                        (<a class="code" href="../../d2/d7/hal_8h.html#a184">HalTranslateBusAddress</a>(
02492                             BusInfo1-&gt;BusType,
02493                             BusInfo1-&gt;BusNumber,
02494                             range1,
02495                             &amp;range1IoSpace,
02496                             &amp;range1Translated) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
02497 
02498                         range1Translated = range1;
02499                         range1IoSpace =
02500                             (descriptor1-&gt;Type == CmResourceTypePort) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> :
02501                                                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02502                     }
02503 
02504                     <span class="keywordflow">if</span>((range2.QuadPart == 0) ||
02505                        (BusInfo2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
02506                        (<a class="code" href="../../d2/d7/hal_8h.html#a184">HalTranslateBusAddress</a>(
02507                             BusInfo2-&gt;BusType,
02508                             BusInfo2-&gt;BusNumber,
02509                             range2,
02510                             &amp;range2IoSpace,
02511                             &amp;range2Translated) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
02512 
02513                         range2Translated = range2;
02514                         range2IoSpace =
02515                             (descriptor2-&gt;Type == CmResourceTypePort) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> :
02516                                                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02517                     }
02518 
02519                     <span class="comment">//</span>
02520                     <span class="comment">// If the ranges are in the same space and start at the</span>
02521                     <span class="comment">// same location then break out and go on to the next</span>
02522                     <span class="comment">// range</span>
02523                     <span class="comment">//</span>
02524 
02525                     <span class="keywordflow">if</span>((range1Translated.QuadPart == range2Translated.QuadPart) &amp;&amp;
02526                        (range1IoSpace == range2IoSpace)) {
02527 
02528                         <span class="keywordflow">break</span>;
02529                     }
02530                 }
02531             }
02532 
02533             <span class="comment">//</span>
02534             <span class="comment">// If we made it all the way through the resource list without</span>
02535             <span class="comment">// finding a match then these are not duplicates.</span>
02536             <span class="comment">//</span>
02537 
02538             <span class="keywordflow">if</span>(j == list2-&gt;Count) {
02539                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02540             }
02541         }
02542     }
02543 
02544     <span class="comment">//</span>
02545     <span class="comment">// If every resource in list 1 exists in list 2 then we also need to make</span>
02546     <span class="comment">// sure that every resource in list 2 exists in list 1.</span>
02547     <span class="comment">//</span>
02548 
02549     <span class="keywordflow">if</span>(pass == 0) {
02550 
02551         PVOID tmp ;
02552 
02553         tmp = Configuration2;
02554         Configuration2 = Configuration1;
02555         Configuration1 = tmp;
02556 
02557         tmp = BusInfo2;
02558         BusInfo2 = BusInfo1;
02559         BusInfo1 = tmp;
02560 
02561         pass = 1;
02562 
02563         <span class="keywordflow">goto</span> RedoScan;
02564     }
02565 
02566     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02567 }
02568 
02569 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02570"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a17">02570</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a17">IopFreeUnicodeStringList</a>(
02571     IN PUNICODE_STRING UnicodeStringList,
02572     IN ULONG StringCount
02573     )
02574 
02575 <span class="comment">/*++</span>
02576 <span class="comment"></span>
02577 <span class="comment">Routine Description:</span>
02578 <span class="comment"></span>
02579 <span class="comment">    This routine frees the buffer for each UNICODE_STRING in the specified list</span>
02580 <span class="comment">    (there are StringCount of them), and then frees the memory used for the</span>
02581 <span class="comment">    string list itself.</span>
02582 <span class="comment"></span>
02583 <span class="comment">Arguments:</span>
02584 <span class="comment"></span>
02585 <span class="comment">    UnicodeStringList - Supplies a pointer to an array of UNICODE_STRINGs.</span>
02586 <span class="comment"></span>
02587 <span class="comment">    StringCount - Supplies the number of strings in the UnicodeStringList array.</span>
02588 <span class="comment"></span>
02589 <span class="comment">Returns:</span>
02590 <span class="comment"></span>
02591 <span class="comment">    None.</span>
02592 <span class="comment"></span>
02593 <span class="comment">--*/</span>
02594 
02595 {
02596     ULONG i;
02597 
02598     <span class="keywordflow">if</span>(UnicodeStringList) {
02599         <span class="keywordflow">for</span>(i = 0; i &lt; StringCount; i++) {
02600             <span class="keywordflow">if</span>(UnicodeStringList[i].Buffer) {
02601                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(UnicodeStringList[i].<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
02602             }
02603         }
02604         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(UnicodeStringList);
02605     }
02606 }
02607 
02608 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02609"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a18">02609</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a18">IopDriverLoadingFailed</a>(
02610     IN HANDLE ServiceHandle OPTIONAL,
02611     IN PUNICODE_STRING ServiceName OPTIONAL
02612     )
02613 
02614 <span class="comment">/*++</span>
02615 <span class="comment"></span>
02616 <span class="comment">Routine Description:</span>
02617 <span class="comment"></span>
02618 <span class="comment">    This routine is invoked when driver failed to start.  All the device</span>
02619 <span class="comment">    instances controlled by this driver/service are marked as failing to</span>
02620 <span class="comment">    start.</span>
02621 <span class="comment"></span>
02622 <span class="comment">Arguments:</span>
02623 <span class="comment"></span>
02624 <span class="comment">    ServiceKeyHandle - Optionally, supplies a handle to the driver service node in the</span>
02625 <span class="comment">        registry that controls this device instance.  If this argument is not specified,</span>
02626 <span class="comment">        then ServiceKeyName is used to specify the service entry.</span>
02627 <span class="comment"></span>
02628 <span class="comment">    ServiceKeyName - Optionally supplies the name of the service entry that controls</span>
02629 <span class="comment">        the device instance. This must be specified if ServiceKeyHandle isn't given.</span>
02630 <span class="comment"></span>
02631 <span class="comment">Returns:</span>
02632 <span class="comment"></span>
02633 <span class="comment">    None.</span>
02634 <span class="comment"></span>
02635 <span class="comment">--*/</span>
02636 
02637 {
02638     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02639     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
02640     BOOLEAN closeHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, deletePdo;
02641     HANDLE handle, serviceEnumHandle, controlHandle;
02642     HANDLE sysEnumHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02643     ULONG deviceFlags, count, newCount, i, j;
02644     UNICODE_STRING unicodeValueName, deviceInstanceName;
02645     WCHAR unicodeBuffer[20];
02646 
02647     <span class="comment">//</span>
02648     <span class="comment">// Open registry ServiceKeyName\Enum branch</span>
02649     <span class="comment">//</span>
02650 
02651     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(ServiceHandle)) {
02652         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">IopOpenServiceEnumKeys</a>(ServiceName,
02653                                         KEY_READ,
02654                                         &amp;ServiceHandle,
02655                                         &amp;serviceEnumHandle,
02656                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
02657                                         );
02658         closeHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02659     } <span class="keywordflow">else</span> {
02660         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_KEY_ENUM);
02661         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;serviceEnumHandle,
02662                                     ServiceHandle,
02663                                     &amp;unicodeValueName,
02664                                     KEY_READ,
02665                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
02666                                     );
02667     }
02668     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02669 
02670         <span class="comment">//</span>
02671         <span class="comment">// No Service Enum key? no device instance.  Return FALSE.</span>
02672         <span class="comment">//</span>
02673 
02674         <span class="keywordflow">return</span> status;
02675     }
02676 
02677     <span class="comment">//</span>
02678     <span class="comment">// Set "STARTFAILED" flags.  So, we won't load it again.</span>
02679     <span class="comment">//</span>
02680 
02681     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeValueName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"INITSTARTFAILED"</span>);
02682     deviceFlags = 1;
02683     ZwSetValueKey(
02684                 serviceEnumHandle,
02685                 &amp;unicodeValueName,
02686                 <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
02687                 REG_DWORD,
02688                 &amp;deviceFlags,
02689                 <span class="keyword">sizeof</span>(deviceFlags)
02690                 );
02691 
02692     <span class="comment">//</span>
02693     <span class="comment">// Find out how many device instances listed in the ServiceName's</span>
02694     <span class="comment">// Enum key.</span>
02695     <span class="comment">//</span>
02696 
02697     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> ( serviceEnumHandle,
02698                                    REGSTR_VALUE_COUNT,
02699                                    &amp;keyValueInformation
02700                                    );
02701     count = 0;
02702     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02703         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
02704             (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
02705 
02706             count = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
02707         }
02708         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
02709     }
02710     <span class="keywordflow">if</span> (count == 0) {
02711         ZwClose(serviceEnumHandle);
02712         <span class="keywordflow">if</span> (closeHandle) {
02713             ZwClose(ServiceHandle);
02714         }
02715         <span class="keywordflow">return</span> status;
02716     }
02717 
02718     <span class="comment">//</span>
02719     <span class="comment">// Open HTREE\ROOT\0 key so later we can remove device instance key</span>
02720     <span class="comment">// from its AttachedComponents value name.</span>
02721     <span class="comment">//</span>
02722 
02723     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;sysEnumHandle,
02724                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02725                                 &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a23">CmRegistryMachineSystemCurrentControlSetEnumName</a>,
02726                                 KEY_ALL_ACCESS,
02727                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
02728                                 );
02729 
02730     <span class="comment">//</span>
02731     <span class="comment">// Walk through each registered device instance to mark its Problem and</span>
02732     <span class="comment">// StatusFlags as fail to start and reset its ActiveService</span>
02733     <span class="comment">//</span>
02734 
02735     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
02736     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02737 
02738     newCount = count;
02739     <span class="keywordflow">for</span> (i = 0; i &lt; count; i++) {
02740         deletePdo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02741         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a6">IopServiceInstanceToDeviceInstance</a> (
02742                      ServiceHandle,
02743                      ServiceName,
02744                      i,
02745                      &amp;deviceInstanceName,
02746                      &amp;handle,
02747                      KEY_ALL_ACCESS
02748                      );
02749 
02750         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02751 
02752             <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
02753             <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
02754 
02755             <span class="comment">//</span>
02756             <span class="comment">// If the device instance is a detected device reported during driver's</span>
02757             <span class="comment">// DriverEntry we need to clean it up.</span>
02758             <span class="comment">//</span>
02759 
02760             deviceObject = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">IopDeviceObjectFromDeviceInstance</a>(handle, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02761             <span class="keywordflow">if</span> (deviceObject) {
02762                 deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
02763                 <span class="keywordflow">if</span> (deviceNode) {
02764 
02765                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a279">IopReleaseDeviceResources</a>(deviceNode);
02766 
02767                     <span class="keywordflow">if</span> ((deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>) &amp;&amp; (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>)) {
02768 
02769                         <span class="comment">//</span>
02770                         <span class="comment">// Now mark this one deleted.</span>
02771                         <span class="comment">//</span>
02772                         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>;
02773 
02774                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_DEVICE_NOT_THERE);
02775                         deletePdo = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02776                     }
02777                 }
02778                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceObject);  <span class="comment">// added via IopDeviceObjectFromDeviceInstance</span>
02779             }
02780 
02781             PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_KEY_CONTROL);
02782             controlHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02783             status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;controlHandle,
02784                                         handle,
02785                                         &amp;unicodeValueName,
02786                                         KEY_ALL_ACCESS,
02787                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
02788                                         );
02789             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02790 
02791                 status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(controlHandle,
02792                                              REGSTR_VALUE_NEWLY_CREATED,
02793                                              &amp;keyValueInformation);
02794                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02795                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
02796                 }
02797                 <span class="keywordflow">if</span> ((status != STATUS_OBJECT_NAME_NOT_FOUND) &amp;&amp;
02798                     (status != STATUS_OBJECT_PATH_NOT_FOUND)) {
02799 
02800                     <span class="comment">//</span>
02801                     <span class="comment">// Remove the instance value name from service enum key</span>
02802                     <span class="comment">//</span>
02803 
02804                     PiUlongToUnicodeString(&amp;unicodeValueName, unicodeBuffer, 20, i);
02805                     status = ZwDeleteValueKey (serviceEnumHandle, &amp;unicodeValueName);
02806                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02807 
02808                         <span class="comment">//</span>
02809                         <span class="comment">// If we can successfaully remove the instance value entry</span>
02810                         <span class="comment">// from service enum key, we then remove the device instance key</span>
02811                         <span class="comment">// Otherwise, we go thru normal path to mark driver loading failed</span>
02812                         <span class="comment">// in the device instance key.</span>
02813                         <span class="comment">//</span>
02814 
02815                         newCount--;
02816 
02817                         ZwDeleteKey(controlHandle);
02818                         ZwDeleteKey(handle);
02819 
02820 
02821                         <span class="comment">//</span>
02822                         <span class="comment">// We also want to delete the ROOT\LEGACY_&lt;driver&gt; key</span>
02823                         <span class="comment">//</span>
02824 
02825                         <span class="keywordflow">if</span> (sysEnumHandle) {
02826                             deviceInstanceName.Length -= 5 * <span class="keyword">sizeof</span>(WCHAR);
02827                             deviceInstanceName.Buffer[deviceInstanceName.Length / <span class="keyword">sizeof</span>(WCHAR)] =
02828                                                  UNICODE_NULL;
02829                             status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
02830                                                         sysEnumHandle,
02831                                                         &amp;deviceInstanceName,
02832                                                         KEY_ALL_ACCESS,
02833                                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
02834                                                         );
02835                             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02836                                 ZwDeleteKey(handle);
02837                             }
02838                         }
02839 
02840                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceInstanceName.Buffer);
02841 
02842                         <span class="comment">//</span>
02843                         <span class="comment">// If there is a PDO for this device, remove it</span>
02844                         <span class="comment">//</span>
02845 
02846                         <span class="keywordflow">if</span> (deletePdo) {
02847                             <a class="code" href="../../d4/d6/iosubs_8c.html#a55">IoDeleteDevice</a>(deviceObject);
02848                         }
02849 
02850                         <span class="keywordflow">continue</span>;
02851                     }
02852                 }
02853             }
02854 
02855             <span class="comment">//</span>
02856             <span class="comment">// Reset Control\ActiveService value name.</span>
02857             <span class="comment">//</span>
02858 
02859             <span class="keywordflow">if</span> (controlHandle) {
02860                 PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VAL_ACTIVESERVICE);
02861                 ZwDeleteValueKey(controlHandle, &amp;unicodeValueName);
02862                 ZwClose(controlHandle);
02863             }
02864 
02865             ZwClose(handle);
02866             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceInstanceName.Buffer);
02867         }
02868     }
02869 
02870     <span class="comment">//</span>
02871     <span class="comment">// If some instance value entry is deleted, we need to update the count of instance</span>
02872     <span class="comment">// value entries and rearrange the instance value entries under service enum key.</span>
02873     <span class="comment">//</span>
02874 
02875     <span class="keywordflow">if</span> (newCount != count) {
02876         <span class="keywordflow">if</span> (newCount != 0) {
02877             j = 0;
02878             i = 0;
02879             <span class="keywordflow">while</span> (i &lt; count) {
02880                 PiUlongToUnicodeString(&amp;unicodeValueName, unicodeBuffer, 20, i);
02881                 status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(serviceEnumHandle,
02882                                              unicodeValueName.Buffer,
02883                                              &amp;keyValueInformation
02884                                              );
02885                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02886                     <span class="keywordflow">if</span> (i != j) {
02887 
02888                         <span class="comment">//</span>
02889                         <span class="comment">// Need to change the instance i to instance j</span>
02890                         <span class="comment">//</span>
02891 
02892                         ZwDeleteValueKey(serviceEnumHandle, &amp;unicodeValueName);
02893 
02894                         PiUlongToUnicodeString(&amp;unicodeValueName, unicodeBuffer, 20, j);
02895                         ZwSetValueKey (serviceEnumHandle,
02896                                        &amp;unicodeValueName,
02897                                        <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
02898                                        REG_SZ,
02899                                        (PVOID)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
02900                                        keyValueInformation-&gt;DataLength
02901                                        );
02902                     }
02903                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
02904                     j++;
02905                 }
02906                 i++;
02907             }
02908         }
02909 
02910         <span class="comment">//</span>
02911         <span class="comment">// Don't forget to update the "Count=" and "NextInstance=" value entries</span>
02912         <span class="comment">//</span>
02913 
02914         PiWstrToUnicodeString( &amp;unicodeValueName, REGSTR_VALUE_COUNT);
02915 
02916         ZwSetValueKey(serviceEnumHandle,
02917                       &amp;unicodeValueName,
02918                       <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
02919                       REG_DWORD,
02920                       &amp;newCount,
02921                       <span class="keyword">sizeof</span> (newCount)
02922                       );
02923         PiWstrToUnicodeString( &amp;unicodeValueName, REGSTR_VALUE_NEXT_INSTANCE);
02924 
02925         ZwSetValueKey(serviceEnumHandle,
02926                       &amp;unicodeValueName,
02927                       <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
02928                       REG_DWORD,
02929                       &amp;newCount,
02930                       <span class="keyword">sizeof</span> (newCount)
02931                       );
02932     }
02933     ZwClose(serviceEnumHandle);
02934     <span class="keywordflow">if</span> (closeHandle) {
02935         ZwClose(ServiceHandle);
02936     }
02937     <span class="keywordflow">if</span> (sysEnumHandle) {
02938         ZwClose(sysEnumHandle);
02939     }
02940 
02941     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
02942     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02943 
02944     <span class="keywordflow">return</span> STATUS_SUCCESS;
02945 }
02946 
02947 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02948 <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a0">IopDisableDevice</a>(
02949     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
02950     IN HANDLE Handle
02951     )
02952 
02953 <span class="comment">/*++</span>
02954 <span class="comment"></span>
02955 <span class="comment">Routine Description:</span>
02956 <span class="comment"></span>
02957 <span class="comment">    This routine tries to ask a bus driver stopping decoding resources</span>
02958 <span class="comment"></span>
02959 <span class="comment">Arguments:</span>
02960 <span class="comment"></span>
02961 <span class="comment">    DeviceNode - Specifies the device to be disabled.</span>
02962 <span class="comment"></span>
02963 <span class="comment">    Handle - specifies the device instance handle.</span>
02964 <span class="comment"></span>
02965 <span class="comment">Returns:</span>
02966 <span class="comment"></span>
02967 <span class="comment">    None.</span>
02968 <span class="comment"></span>
02969 <span class="comment">--*/</span>
02970 
02971 {
02972     UNICODE_STRING unicodeName;
02973     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02974     PCM_RESOURCE_LIST cmResource;
02975     ULONG cmLength, tmpValue;
02976     HANDLE logConfHandle;
02977 
02978     <span class="comment">//</span>
02979     <span class="comment">// If the device has boot config, we will query-remove and remove the device to free</span>
02980     <span class="comment">// the boot config if possible.</span>
02981     <span class="comment">//</span>
02982 
02983     <span class="keywordflow">if</span> (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a>) {
02984         status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a21">IopRemoveDevice</a> (DeviceNode-&gt;PhysicalDeviceObject, IRP_MN_QUERY_REMOVE_DEVICE);
02985         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02986             status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a21">IopRemoveDevice</a> (DeviceNode-&gt;PhysicalDeviceObject, IRP_MN_REMOVE_DEVICE);
02987             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
02988             <a class="code" href="../../d9/d0/pnpiop_8h.html#a279">IopReleaseDeviceResources</a>(DeviceNode);
02989 
02990             <span class="comment">//</span>
02991             <span class="comment">// If device node still has boot config, the IopReleaseDeviceResource has</span>
02992             <span class="comment">// reserved the boot config for the device again and the boot resources are not</span>
02993             <span class="comment">// changed.</span>
02994             <span class="comment">// Else send query-resource again to make sure the bus driver did disable the</span>
02995             <span class="comment">// device and free the resources.</span>
02996             <span class="comment">//</span>
02997 
02998             <span class="keywordflow">if</span> (DeviceNode-&gt;BootResources == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02999                 PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_LOG_CONF);
03000                 status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a7">IopOpenRegistryKeyPersist</a>(&amp;logConfHandle,
03001                                                    Handle,
03002                                                    &amp;unicodeName,
03003                                                    KEY_ALL_ACCESS,
03004                                                    TRUE,
03005                                                    &amp;tmpValue
03006                                                    );
03007                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03008                     logConfHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03009                 }
03010                 status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a27">IopQueryDeviceResources</a> (
03011                               DeviceNode-&gt;PhysicalDeviceObject,
03012                               QUERY_RESOURCE_LIST,
03013                               &amp;cmResource,
03014                               &amp;cmLength
03015                               );
03016 
03017                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03018                     cmResource = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03019                     cmLength = 0;
03020                 }
03021 
03022                 <span class="keywordflow">if</span> (logConfHandle) {
03023                     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
03024                     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
03025                     <span class="keywordflow">if</span> (cmResource) {
03026                         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_BOOTCONFIG);
03027                         ZwSetValueKey(
03028                                   logConfHandle,
03029                                   &amp;unicodeName,
03030                                   TITLE_INDEX_VALUE,
03031                                   REG_RESOURCE_LIST,
03032                                   cmResource,
03033                                   cmLength
03034                                   );
03035                     } <span class="keywordflow">else</span> {
03036                         ZwDeleteValueKey(logConfHandle, &amp;unicodeName);
03037                     }
03038                     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
03039                     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03040                     ZwClose(logConfHandle);
03041                 }
03042                 <span class="keywordflow">if</span> (cmResource) {
03043                     DeviceNode-&gt;Flags |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a>;
03044                     DeviceNode-&gt;BootResources = cmResource;
03045 
03046                     <span class="comment">//</span>
03047                     <span class="comment">// This device consumes BOOT resources.  Reserve its boot resources</span>
03048                     <span class="comment">//</span>
03049 
03050                     (*IopReserveResourcesRoutine)(<a class="code" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>,
03051                                                   DeviceNode-&gt;PhysicalDeviceObject,
03052                                                   cmResource);
03053                 }
03054             }
03055         } <span class="keywordflow">else</span> {
03056             <a class="code" href="../../d0/d1/pnpirp_8c.html#a21">IopRemoveDevice</a> (DeviceNode-&gt;PhysicalDeviceObject, IRP_MN_CANCEL_REMOVE_DEVICE);
03057         }
03058     }
03059 
03060     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(DeviceNode)) {
03061         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_NOT_CONFIGURED) ||
03062                <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_REINSTALL));
03063 
03064         <a class="code" href="../../d9/d0/pnpiop_8h.html#a79">IopClearDevNodeProblem</a>(DeviceNode);
03065     }
03066 
03067     <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(DeviceNode, CM_PROB_DISABLED);
03068 }
03069 
03070 BOOLEAN
<a name="l03071"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a19">03071</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a19">IopIsAnyDeviceInstanceEnabled</a>(
03072     IN PUNICODE_STRING ServiceKeyName,
03073     IN HANDLE ServiceHandle OPTIONAL,
03074     IN BOOLEAN LegacyIncluded
03075     )
03076 
03077 <span class="comment">/*++</span>
03078 <span class="comment"></span>
03079 <span class="comment">Routine Description:</span>
03080 <span class="comment"></span>
03081 <span class="comment">    This routine checks if any of the devices instances is turned on for the specified</span>
03082 <span class="comment">    service. This routine is used for Pnp Driver only and is temporary function to support</span>
03083 <span class="comment">    SUR.</span>
03084 <span class="comment"></span>
03085 <span class="comment">Arguments:</span>
03086 <span class="comment"></span>
03087 <span class="comment">    ServiceKeyName - Specifies the service key unicode name</span>
03088 <span class="comment"></span>
03089 <span class="comment">    ServiceHandle - Optionally supplies a handle to the service key to be checked.</span>
03090 <span class="comment"></span>
03091 <span class="comment">    LegacyIncluded - TRUE, a legacy device instance key is counted as a device instance.</span>
03092 <span class="comment">                     FALSE, a legacy device instance key is not counted.</span>
03093 <span class="comment"></span>
03094 <span class="comment">Returns:</span>
03095 <span class="comment"></span>
03096 <span class="comment">    A BOOLEAN value.</span>
03097 <span class="comment"></span>
03098 <span class="comment">--*/</span>
03099 
03100 {
03101     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03102     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
03103     HANDLE serviceEnumHandle, handle, controlHandle;
03104     ULONG i, count, deviceFlags;
03105     UNICODE_STRING unicodeName;
03106     BOOLEAN enabled, setProblem, closeHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03107     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> physicalDeviceObject;
03108     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
03109 
03110     <span class="comment">//</span>
03111     <span class="comment">// Open registry ServiceKeyName\Enum branch</span>
03112     <span class="comment">//</span>
03113 
03114     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(ServiceHandle)) {
03115         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">IopOpenServiceEnumKeys</a>(ServiceKeyName,
03116                                         KEY_READ,
03117                                         &amp;ServiceHandle,
03118                                         &amp;serviceEnumHandle,
03119                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
03120                                         );
03121         closeHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03122     } <span class="keywordflow">else</span> {
03123         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_ENUM);
03124         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;serviceEnumHandle,
03125                                     ServiceHandle,
03126                                     &amp;unicodeName,
03127                                     KEY_READ,
03128                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
03129                                     );
03130     }
03131     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03132 
03133         <span class="comment">//</span>
03134         <span class="comment">// No Service Enum key? no device instance.  Return FALSE.</span>
03135         <span class="comment">//</span>
03136 
03137         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03138     }
03139 
03140     <span class="comment">//</span>
03141     <span class="comment">// Find out how many device instances listed in the ServiceName's</span>
03142     <span class="comment">// Enum key.</span>
03143     <span class="comment">//</span>
03144 
03145     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> ( serviceEnumHandle,
03146                                    REGSTR_VALUE_COUNT,
03147                                    &amp;keyValueInformation
03148                                    );
03149     ZwClose(serviceEnumHandle);
03150     count = 0;
03151     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03152         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
03153             (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
03154 
03155             count = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03156         }
03157         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03158     }
03159     <span class="keywordflow">if</span> (count == 0) {
03160         <span class="keywordflow">if</span> (closeHandle) {
03161             ZwClose(ServiceHandle);
03162         }
03163         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03164     }
03165 
03166     <span class="comment">//</span>
03167     <span class="comment">// Walk through each registered device instance to check it is enabled.</span>
03168     <span class="comment">//</span>
03169 
03170     enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03171     <span class="keywordflow">for</span> (i = 0; i &lt; count; i++) {
03172 
03173         <span class="comment">//</span>
03174         <span class="comment">// Get device instance handle.  If it fails, we will skip this device</span>
03175         <span class="comment">// instance.</span>
03176         <span class="comment">//</span>
03177 
03178         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a6">IopServiceInstanceToDeviceInstance</a> (
03179                      ServiceHandle,
03180                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03181                      i,
03182                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03183                      &amp;handle,
03184                      KEY_ALL_ACCESS
03185                      );
03186         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03187             <span class="keywordflow">continue</span>;
03188         }
03189 
03190         physicalDeviceObject = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">IopDeviceObjectFromDeviceInstance</a>(handle, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03191         <span class="keywordflow">if</span> (physicalDeviceObject) {
03192             deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)physicalDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
03193             <span class="keywordflow">if</span> (deviceNode &amp;&amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(deviceNode, CM_PROB_DISABLED)) {
03194                 ZwClose(handle);
03195                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(physicalDeviceObject);
03196                 <span class="keywordflow">continue</span>;
03197             }
03198         }
03199 
03200         <span class="comment">//</span>
03201         <span class="comment">// Check if the device instance has been disabled.</span>
03202         <span class="comment">// First check global flag: CONFIGFLAG and then CSCONFIGFLAG.</span>
03203         <span class="comment">//</span>
03204 
03205         deviceFlags = 0;
03206         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(handle,
03207                                      REGSTR_VALUE_CONFIG_FLAGS,
03208                                      &amp;keyValueInformation);
03209         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03210             <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
03211                 (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
03212 
03213                 deviceFlags = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03214             }
03215             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03216         }
03217 
03218         <span class="keywordflow">if</span> (deviceFlags &amp; CONFIGFLAG_DISABLED) {
03219 
03220             <span class="comment">//</span>
03221             <span class="comment">// Convert this flag into the hardware profile-specific version, so it'll</span>
03222             <span class="comment">// look the same as the CsConfigFlags we retrieve below.</span>
03223             <span class="comment">//</span>
03224 
03225             deviceFlags = CSCONFIGFLAG_DISABLED;
03226 
03227         } <span class="keywordflow">else</span> {
03228 
03229             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a9">IopGetDeviceInstanceCsConfigFlags</a>(
03230                          ServiceKeyName,
03231                          i,
03232                          &amp;deviceFlags
03233                          );
03234 
03235             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03236                 deviceFlags = 0;
03237             }
03238         }
03239 
03240         <span class="comment">//</span>
03241         <span class="comment">// If the device is disabled (either globally, or specifically for this</span>
03242         <span class="comment">// hardware profile), then mark the devnode as DNF_DISABLED.</span>
03243         <span class="comment">//</span>
03244 
03245         <span class="keywordflow">if</span> ((deviceFlags &amp; CSCONFIGFLAG_DISABLED) || (deviceFlags &amp; CSCONFIGFLAG_DO_NOT_START)) {
03246 
03247             <span class="keywordflow">if</span> (deviceNode) {
03248                 <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a0">IopDisableDevice</a>(deviceNode, handle);
03249             }
03250         }
03251 
03252         <span class="keywordflow">if</span> (physicalDeviceObject) {
03253             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(physicalDeviceObject);
03254         }
03255 
03256         <span class="comment">//</span>
03257         <span class="comment">// Finally, we need to set the STATUSFLAGS of the device instance to</span>
03258         <span class="comment">// indicate if the driver is successfully started.</span>
03259         <span class="comment">//</span>
03260 
03261         <span class="keywordflow">if</span> (!(deviceFlags &amp; (CSCONFIGFLAG_DISABLED | CSCONFIGFLAG_DO_NOT_CREATE | CSCONFIGFLAG_DO_NOT_START))) {
03262 
03263             ULONG legacy;
03264 
03265             <span class="comment">//</span>
03266             <span class="comment">// Check should legacy instance key be counted as an enabled device</span>
03267             <span class="comment">//</span>
03268 
03269             <span class="keywordflow">if</span> (LegacyIncluded == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03270 
03271                 <span class="comment">//</span>
03272                 <span class="comment">// The legacy variable must be initialized to zero.  Because the device</span>
03273                 <span class="comment">// instance key may be an enumerated device.  In this case, there is no</span>
03274                 <span class="comment">// legacy value name.</span>
03275                 <span class="comment">//</span>
03276 
03277                 legacy = 0;
03278                 status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(handle,
03279                                              REGSTR_VALUE_LEGACY,
03280                                              &amp;keyValueInformation
03281                                              );
03282                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03283                     <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
03284                         (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
03285                         legacy = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03286                     }
03287                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03288                 }
03289             } <span class="keywordflow">else</span> {
03290                 legacy = 0;
03291             }
03292 
03293             <span class="keywordflow">if</span> (legacy == 0) {
03294 
03295                 <span class="comment">//</span>
03296                 <span class="comment">// Mark that the driver has at least a device instance to work with.</span>
03297                 <span class="comment">//</span>
03298 
03299                 PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_CONTROL);
03300                 status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;controlHandle,
03301                                             handle,
03302                                             &amp;unicodeName,
03303                                             KEY_ALL_ACCESS,
03304                                             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
03305                                             );
03306                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03307                     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_ACTIVESERVICE);
03308                     ZwSetValueKey(
03309                                 controlHandle,
03310                                 &amp;unicodeName,
03311                                 <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
03312                                 REG_SZ,
03313                                 ServiceKeyName-&gt;Buffer,
03314                                 ServiceKeyName-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL)
03315                                 );
03316 
03317                     ZwClose(controlHandle);
03318                 }
03319                 enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03320             }
03321         }
03322         ZwClose(handle);
03323     }
03324 
03325     <span class="keywordflow">if</span> (closeHandle) {
03326         ZwClose(ServiceHandle);
03327     }
03328     <span class="keywordflow">return</span> enabled;
03329 }
03330 
03331 BOOLEAN
<a name="l03332"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a20">03332</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a20">IopIsDeviceInstanceEnabled</a>(
03333     IN HANDLE DeviceInstanceHandle,
03334     IN PUNICODE_STRING DeviceInstance,
03335     IN BOOLEAN DisableIfEnabled
03336     )
03337 
03338 <span class="comment">/*++</span>
03339 <span class="comment"></span>
03340 <span class="comment">Routine Description:</span>
03341 <span class="comment"></span>
03342 <span class="comment">    This routine checks if the specified devices instances is enabled.</span>
03343 <span class="comment"></span>
03344 <span class="comment">Arguments:</span>
03345 <span class="comment"></span>
03346 <span class="comment">    DeviceInstanceHandle - Optionally supplies a handle to the device instance</span>
03347 <span class="comment">        key to be checked.</span>
03348 <span class="comment"></span>
03349 <span class="comment">    DeviceInstance - Specifies the device instance key unicode name.  Caller</span>
03350 <span class="comment">        must at least specified DeviceInstanceHandle or DeviceInstance.</span>
03351 <span class="comment"></span>
03352 <span class="comment">Returns:</span>
03353 <span class="comment"></span>
03354 <span class="comment">    A BOOLEAN value.</span>
03355 <span class="comment"></span>
03356 <span class="comment">--*/</span>
03357 
03358 {
03359     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03360     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
03361     HANDLE handle, handle1;
03362     ULONG deviceFlags;
03363     BOOLEAN enabled, closeHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03364     UNICODE_STRING unicodeString;
03365     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03366     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;;
03367 
03368     <span class="comment">//</span>
03369     <span class="comment">// Open registry ServiceKeyName\Enum branch</span>
03370     <span class="comment">//</span>
03371 
03372     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(DeviceInstanceHandle)) {
03373         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
03374                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03375                                     &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a23">CmRegistryMachineSystemCurrentControlSetEnumName</a>,
03376                                     KEY_READ,
03377                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
03378                                     );
03379 
03380         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03381 
03382             status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a> (
03383                                     DeviceInstanceHandle,
03384                                     handle,
03385                                     DeviceInstance,
03386                                     KEY_READ,
03387                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
03388                                     );
03389             ZwClose(handle);
03390         }
03391 
03392         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03393             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03394         }
03395         closeHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03396     }
03397 
03398     enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03399 
03400     <span class="comment">//</span>
03401     <span class="comment">// First check the device node</span>
03402     <span class="comment">//</span>
03403 
03404     deviceObject = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">IopDeviceObjectFromDeviceInstance</a>(DeviceInstanceHandle, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03405     <span class="keywordflow">if</span> (deviceObject) {
03406         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
03407         <span class="keywordflow">if</span> (deviceNode &amp;&amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(deviceNode, CM_PROB_DISABLED)) {
03408             enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03409             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
03410         }
03411     }
03412 
03413     <span class="comment">//</span>
03414     <span class="comment">// Check if the device instance has been disabled.</span>
03415     <span class="comment">// First check global flag: CONFIGFLAG and then CSCONFIGFLAG.</span>
03416     <span class="comment">//</span>
03417 
03418     deviceFlags = 0;
03419     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(DeviceInstanceHandle,
03420                                  REGSTR_VALUE_CONFIG_FLAGS,
03421                                  &amp;keyValueInformation);
03422     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03423         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
03424             (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
03425             deviceFlags = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03426         }
03427         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03428     }
03429     <span class="keywordflow">if</span> (!(deviceFlags &amp; CONFIGFLAG_DISABLED)) {
03430         enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03431 
03432         <span class="comment">//</span>
03433         <span class="comment">// See if we can open current hardware profile</span>
03434         <span class="comment">//</span>
03435         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle1,
03436                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03437                                     &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a26">CmRegistryMachineSystemCurrentControlSetHardwareProfilesCurrent</a>,
03438                                     KEY_READ,
03439                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
03440                                     );
03441         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; DeviceInstance != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03442 
03443             <span class="comment">//</span>
03444             <span class="comment">// Now, we must open the System\CCS\Enum key under this.</span>
03445             <span class="comment">//</span>
03446             <span class="comment">//</span>
03447             <span class="comment">// Open system\CurrentControlSet under current hardware profile key</span>
03448             <span class="comment">//</span>
03449 
03450             PiWstrToUnicodeString(&amp;unicodeString, REGSTR_PATH_CURRENTCONTROLSET);
03451             status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
03452                                         handle1,
03453                                         &amp;unicodeString,
03454                                         KEY_READ,
03455                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
03456                                         );
03457             ZwClose(handle1);
03458             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03459                 PiWstrToUnicodeString(&amp;unicodeString, REGSTR_KEY_ENUM);
03460                 status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle1,
03461                                             handle,
03462                                             &amp;unicodeString,
03463                                             KEY_READ,
03464                                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
03465                                             );
03466                 ZwClose(handle);
03467                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03468                     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
03469                                                 handle1,
03470                                                 DeviceInstance,
03471                                                 KEY_READ,
03472                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
03473                                                 );
03474                     ZwClose(handle1);
03475                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03476                         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(
03477                                         handle,
03478                                         REGSTR_VALUE_CSCONFIG_FLAGS,
03479                                         &amp;keyValueInformation
03480                                         );
03481                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03482                             <span class="keywordflow">if</span>((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
03483                                (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
03484                                deviceFlags = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03485                             }
03486                             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03487                         }
03488                         ZwClose(handle);
03489                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03490                             <span class="keywordflow">if</span> ((deviceFlags &amp; CSCONFIGFLAG_DISABLED) ||
03491                                 (deviceFlags &amp; CSCONFIGFLAG_DO_NOT_CREATE) ||
03492                                 (deviceFlags &amp; CSCONFIGFLAG_DO_NOT_START)) {
03493                                 enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03494                             }
03495                         }
03496                     }
03497                 }
03498             }
03499         }
03500     } <span class="keywordflow">else</span> {
03501         enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03502     }
03503 
03504     <span class="comment">//</span>
03505     <span class="comment">// If the device is disabled and has device node associated with it.</span>
03506     <span class="comment">// disable the device.</span>
03507     <span class="comment">//</span>
03508 
03509     <span class="keywordflow">if</span> (enabled == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> &amp;&amp; deviceNode &amp;&amp; DisableIfEnabled) {
03510         <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a0">IopDisableDevice</a>(deviceNode, DeviceInstanceHandle);
03511     }
03512 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
03513     <span class="keywordflow">if</span> (deviceObject) {
03514         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceObject);
03515     }
03516     <span class="keywordflow">if</span> (closeHandle) {
03517         ZwClose(DeviceInstanceHandle);
03518     }
03519     <span class="keywordflow">return</span> enabled;
03520 }
03521 
03522 ULONG
<a name="l03523"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">03523</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(
03524     IN PCM_RESOURCE_LIST ResourceList
03525     )
03526 
03527 <span class="comment">/*++</span>
03528 <span class="comment"></span>
03529 <span class="comment">Routine Description:</span>
03530 <span class="comment"></span>
03531 <span class="comment">    This routine determines size of the passed in ResourceList</span>
03532 <span class="comment">    structure.</span>
03533 <span class="comment"></span>
03534 <span class="comment">Arguments:</span>
03535 <span class="comment"></span>
03536 <span class="comment">    Configuration1 - Supplies a pointer to the resource list.</span>
03537 <span class="comment"></span>
03538 <span class="comment">Return Value:</span>
03539 <span class="comment"></span>
03540 <span class="comment">    size of the resource list structure.</span>
03541 <span class="comment"></span>
03542 <span class="comment">--*/</span>
03543 
03544 {
03545     ULONG totalSize, listSize, descriptorSize, i, j;
03546     PCM_FULL_RESOURCE_DESCRIPTOR fullResourceDesc;
03547     PCM_PARTIAL_RESOURCE_DESCRIPTOR partialDescriptor;
03548 
03549     <span class="keywordflow">if</span> (!ResourceList) {
03550         totalSize = 0;
03551     } <span class="keywordflow">else</span> {
03552         totalSize = FIELD_OFFSET(CM_RESOURCE_LIST, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>);
03553         fullResourceDesc = &amp;ResourceList-&gt;List[0];
03554         <span class="keywordflow">for</span> (i = 0; i &lt; ResourceList-&gt;Count; i++) {
03555             listSize = FIELD_OFFSET(CM_FULL_RESOURCE_DESCRIPTOR,
03556                                     PartialResourceList) +
03557                        FIELD_OFFSET(CM_PARTIAL_RESOURCE_LIST,
03558                                     PartialDescriptors);
03559             partialDescriptor = &amp;fullResourceDesc-&gt;PartialResourceList.PartialDescriptors[0];
03560             <span class="keywordflow">for</span> (j = 0; j &lt; fullResourceDesc-&gt;PartialResourceList.Count; j++) {
03561                 descriptorSize = <span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_DESCRIPTOR);
03562                 <span class="keywordflow">if</span> (partialDescriptor-&gt;Type == CmResourceTypeDeviceSpecific) {
03563                     descriptorSize += partialDescriptor-&gt;u.DeviceSpecificData.DataSize;
03564                 }
03565                 listSize += descriptorSize;
03566                 partialDescriptor = (PCM_PARTIAL_RESOURCE_DESCRIPTOR)
03567                                         ((PUCHAR)partialDescriptor + descriptorSize);
03568             }
03569             totalSize += listSize;
03570             fullResourceDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)
03571                                       ((PUCHAR)fullResourceDesc + listSize);
03572         }
03573     }
03574     <span class="keywordflow">return</span> totalSize;
03575 }
03576 
03577 <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>
<a name="l03578"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a22">03578</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a22">IopReferenceDriverObjectByName</a> (
03579     IN PUNICODE_STRING DriverName
03580     )
03581 
03582 <span class="comment">/*++</span>
03583 <span class="comment"></span>
03584 <span class="comment">Routine Description:</span>
03585 <span class="comment"></span>
03586 <span class="comment">    This routine references a driver object by a given driver name.</span>
03587 <span class="comment"></span>
03588 <span class="comment">Arguments:</span>
03589 <span class="comment"></span>
03590 <span class="comment">    DriverName - supplies a pointer to the name of the driver whose driver object is</span>
03591 <span class="comment">        to be referenced.</span>
03592 <span class="comment"></span>
03593 <span class="comment">Returns:</span>
03594 <span class="comment"></span>
03595 <span class="comment">    A pointer to a DRIVER_OBJECT if succeeds.  Otherwise, a NULL value.</span>
03596 <span class="comment"></span>
03597 <span class="comment">--*/</span>
03598 
03599 {
03600     OBJECT_ATTRIBUTES objectAttributes;
03601     HANDLE driverHandle;
03602     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03603     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject;
03604 
03605     <span class="comment">//</span>
03606     <span class="comment">// Make sure the driver name is valid.</span>
03607     <span class="comment">//</span>
03608 
03609     <span class="keywordflow">if</span> (DriverName-&gt;Length == 0) {
03610         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03611     }
03612 
03613     InitializeObjectAttributes(&amp;objectAttributes,
03614                                DriverName,
03615                                OBJ_CASE_INSENSITIVE,
03616                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03617                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
03618                                );
03619     status = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>(&amp;objectAttributes,
03620                                 <a class="code" href="../../d3/d5/iodata_8c.html#a36">IoDriverObjectType</a>,
03621                                 <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
03622                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03623                                 FILE_READ_ATTRIBUTES,
03624                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03625                                 &amp;driverHandle
03626                                 );
03627     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03628 
03629         <span class="comment">//</span>
03630         <span class="comment">// Now reference the driver object.</span>
03631         <span class="comment">//</span>
03632 
03633         status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(driverHandle,
03634                                            0,
03635                                            <a class="code" href="../../d3/d5/iodata_8c.html#a36">IoDriverObjectType</a>,
03636                                            <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
03637                                            &amp;driverObject,
03638                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
03639                                            );
03640         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(driverHandle);
03641     }
03642 
03643     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03644         <span class="keywordflow">return</span> driverObject;
03645     } <span class="keywordflow">else</span> {
03646         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03647     }
03648 }
03649 
03650 <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>
<a name="l03651"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">03651</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">IopDeviceObjectFromDeviceInstance</a> (
03652     IN HANDLE DeviceInstanceHandle      OPTIONAL,
03653     IN PUNICODE_STRING DeviceInstance   OPTIONAL
03654     )
03655 
03656 <span class="comment">/*++</span>
03657 <span class="comment"></span>
03658 <span class="comment">Routine Description:</span>
03659 <span class="comment"></span>
03660 <span class="comment">    This routine receives a DeviceInstance path (or DeviceInstance handle) and</span>
03661 <span class="comment">    returns a reference to a bus device object for the DeviceInstance.</span>
03662 <span class="comment"></span>
03663 <span class="comment">Arguments:</span>
03664 <span class="comment"></span>
03665 <span class="comment">    DeviceInstanceHandle - Supplies a handle to the registry Device Instance key.</span>
03666 <span class="comment">        If this parameter is NULL, DeviceInstance must specify the registry path.</span>
03667 <span class="comment"></span>
03668 <span class="comment">    DeviceInstance - supplies a UNICODE_STRING to specify the device instance path.</span>
03669 <span class="comment">        if this parameter is NULL, DeviceInstanceHandle must specify the handle</span>
03670 <span class="comment">        to its registry key.</span>
03671 <span class="comment"></span>
03672 <span class="comment">Returns:</span>
03673 <span class="comment"></span>
03674 <span class="comment">    A reference to the desired bus device object.</span>
03675 <span class="comment"></span>
03676 <span class="comment">--*/</span>
03677 
03678 {
03679     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03680     HANDLE handle, deviceHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03681     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceReference = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03682     UNICODE_STRING unicodeName;
03683     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
03684     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
03685 
03686     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03687 
03688     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(DeviceInstanceHandle)) {
03689 
03690         <span class="comment">//</span>
03691         <span class="comment">// first open System\CCS\Enum key and then the device instance key.</span>
03692         <span class="comment">//</span>
03693 
03694         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
03695                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03696                                     &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a23">CmRegistryMachineSystemCurrentControlSetEnumName</a>,
03697                                     KEY_READ,
03698                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
03699                                     );
03700 
03701         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03702             <span class="keywordflow">return</span> deviceReference;
03703         }
03704 
03705         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceInstance);
03706         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a> (&amp;deviceHandle,
03707                                      handle,
03708                                      DeviceInstance,
03709                                      KEY_READ,
03710                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
03711                                      );
03712         ZwClose(handle);
03713         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03714             <span class="keywordflow">return</span> deviceReference;
03715         }
03716         DeviceInstanceHandle = deviceHandle;
03717     }
03718 
03719     <span class="comment">//</span>
03720     <span class="comment">// Read the address of device object</span>
03721     <span class="comment">//</span>
03722 
03723     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_CONTROL);
03724     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
03725                                 DeviceInstanceHandle,
03726                                 &amp;unicodeName,
03727                                 KEY_READ,
03728                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
03729                                 );
03730     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03731         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
03732     }
03733 
03734     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (handle,
03735                                   REGSTR_VALUE_DEVICE_REFERENCE,
03736                                   &amp;keyValueInformation);
03737     ZwClose(handle);
03738     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03739         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
03740             (keyValueInformation-&gt;DataLength == <span class="keyword">sizeof</span>(ULONG_PTR))) {
03741 
03742             deviceReference = *(<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03743         }
03744         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03745     }
03746     <span class="keywordflow">if</span> (!deviceReference) {
03747         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
03748     }
03749 
03750     <span class="comment">//</span>
03751     <span class="comment">// Make sure the address of the device object is not clobbered,</span>
03752     <span class="comment">// unfortunately if the address is truly bogus we will bugcheck since</span>
03753     <span class="comment">// try/except doesn't work for kernel addresses.</span>
03754     <span class="comment">//</span>
03755 
03756     <span class="keywordflow">if</span> (deviceReference-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o0">Type</a> != <a class="code" href="../../d0/d5/io_8h.html#a2">IO_TYPE_DEVICE</a>) {
03757         deviceReference = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03758     } <span class="keywordflow">else</span> {
03759         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceReference-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
03760         <span class="keywordflow">if</span> (deviceNode &amp;&amp; (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a> == deviceReference)) {
03761             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(deviceReference);
03762         } <span class="keywordflow">else</span> {
03763             deviceReference = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03764         }
03765     }
03766 
03767 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
03768     <span class="keywordflow">if</span> (deviceHandle) {
03769         ZwClose(deviceHandle);
03770     }
03771     <span class="keywordflow">return</span> deviceReference;
03772 
03773 }
03774 
03775 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03776"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a24">03776</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a24">IopDeviceObjectToDeviceInstance</a> (
03777     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
03778     IN PHANDLE DeviceInstanceHandle,
03779     IN  ACCESS_MASK DesiredAccess
03780     )
03781 
03782 <span class="comment">/*++</span>
03783 <span class="comment"></span>
03784 <span class="comment">Routine Description:</span>
03785 <span class="comment"></span>
03786 <span class="comment">    This routine receives a DeviceObject pointer and returns a handle to the device</span>
03787 <span class="comment">    instance path under registry System\ENUM key.</span>
03788 <span class="comment"></span>
03789 <span class="comment">    Note, caller must owner the PpRegistryDeviceResource before calling the function,</span>
03790 <span class="comment"></span>
03791 <span class="comment">Arguments:</span>
03792 <span class="comment"></span>
03793 <span class="comment">    DeviceObject - supplies a pointer to a physical device object.</span>
03794 <span class="comment"></span>
03795 <span class="comment">    DeviceInstanceHandle - Supplies a variable to receive the handle to the registry</span>
03796 <span class="comment">             device instance key.</span>
03797 <span class="comment"></span>
03798 <span class="comment">    DesiredAccess - specifies the access that is needed to this key.</span>
03799 <span class="comment"></span>
03800 <span class="comment">Returns:</span>
03801 <span class="comment"></span>
03802 <span class="comment">    NTSTATUS code to indicate success or failure.</span>
03803 <span class="comment"></span>
03804 <span class="comment">--*/</span>
03805 
03806 {
03807     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03808     HANDLE handle;
03809     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
03810 
03811     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03812 
03813     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
03814                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03815                                 &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a23">CmRegistryMachineSystemCurrentControlSetEnumName</a>,
03816                                 KEY_READ,
03817                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
03818                                 );
03819 
03820     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03821         <span class="keywordflow">return</span> status;
03822     }
03823 
03824     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>) DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
03825     <span class="keywordflow">if</span> (deviceNode &amp;&amp; (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Length != 0)) {
03826         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a> (DeviceInstanceHandle,
03827                                      handle,
03828                                      &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>,
03829                                      DesiredAccess,
03830                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
03831                                      );
03832     } <span class="keywordflow">else</span> {
03833         status = STATUS_INVALID_DEVICE_REQUEST;
03834     }
03835     ZwClose(handle);
03836 
03837     <span class="keywordflow">return</span> status;
03838 }
03839 
03840 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03841"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a25">03841</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a25">IopCleanupDeviceRegistryValues</a> (
03842     IN PUNICODE_STRING InstancePath,
03843     IN BOOLEAN KeepReference
03844     )
03845 
03846 <span class="comment">/*++</span>
03847 <span class="comment"></span>
03848 <span class="comment">Routine Description:</span>
03849 <span class="comment"></span>
03850 <span class="comment">    This routine cleans up a device instance key when the device is no</span>
03851 <span class="comment">    longer present/enumerated.  If the device is registered to a Service</span>
03852 <span class="comment">    the Service's enum key will also been cleaned up.</span>
03853 <span class="comment"></span>
03854 <span class="comment">    Note the caller must lock the RegistryDeciceResource</span>
03855 <span class="comment"></span>
03856 <span class="comment">Arguments:</span>
03857 <span class="comment"></span>
03858 <span class="comment">    InstancePath - supplies a pointer to the name of the device instance key.</span>
03859 <span class="comment"></span>
03860 <span class="comment">    KeepReference - supplies a boolean value to indicate if we should remove the</span>
03861 <span class="comment">        device instance path to device object mapping.</span>
03862 <span class="comment"></span>
03863 <span class="comment">Return Value:</span>
03864 <span class="comment"></span>
03865 <span class="comment">    status</span>
03866 <span class="comment"></span>
03867 <span class="comment">--*/</span>
03868 
03869 {
03870     HANDLE handle, instanceHandle;
03871     UNICODE_STRING unicodeValueName;
03872     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03873     ULONG count = 0;
03874     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
03875 
03876     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03877 
03878     <span class="comment">//</span>
03879     <span class="comment">// Open System\CurrentControlSet\Enum</span>
03880     <span class="comment">//</span>
03881 
03882     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
03883                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03884                                 &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a23">CmRegistryMachineSystemCurrentControlSetEnumName</a>,
03885                                 KEY_ALL_ACCESS,
03886                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
03887                                 );
03888 
03889     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03890         <span class="keywordflow">return</span> status;
03891     }
03892 
03893     <span class="comment">//</span>
03894     <span class="comment">// Open the device instance key</span>
03895     <span class="comment">//</span>
03896 
03897     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;instanceHandle,
03898                                 handle,
03899                                 InstancePath,
03900                                 KEY_ALL_ACCESS,
03901                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
03902                                 );
03903 
03904     ZwClose(handle);
03905     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03906 
03907         <span class="comment">//</span>
03908         <span class="comment">// There is no registry key for the ServiceKeyName information.</span>
03909         <span class="comment">//</span>
03910 
03911         <span class="keywordflow">return</span> status;
03912     }
03913 
03914     <span class="comment">//</span>
03915     <span class="comment">// Delete the DeviceReference value name under Control key</span>
03916     <span class="comment">//</span>
03917 
03918     <span class="keywordflow">if</span> (!KeepReference) {
03919 
03920         <span class="comment">//</span>
03921         <span class="comment">// BUGBUG (lonnym)--verify that removal of the following code fragment is valid.</span>
03922         <span class="comment">//</span>
03923 <span class="preprocessor">#if 0</span>
03924 <span class="preprocessor"></span>        <span class="comment">//</span>
03925         <span class="comment">// Set the 'FoundAtEnum' value to false.</span>
03926         <span class="comment">//</span>
03927 
03928         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_FOUNDATENUM);
03929         tmpValue = 0;
03930         ZwSetValueKey(instanceHandle,
03931                       &amp;unicodeValueName,
03932                       <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
03933                       REG_DWORD,
03934                       &amp;tmpValue,
03935                       <span class="keyword">sizeof</span>(tmpValue)
03936                       );
03937 <span class="preprocessor">#endif // (lonnym, verify removal to here)</span>
03938 <span class="preprocessor"></span>
03939         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_KEY_CONTROL);
03940         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
03941                                     instanceHandle,
03942                                     &amp;unicodeValueName,
03943                                     KEY_ALL_ACCESS,
03944                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
03945                                     );
03946         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03947             PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_DEVICE_REFERENCE);
03948             ZwDeleteValueKey(handle, &amp;unicodeValueName);
03949             ZwClose(handle);
03950         }
03951 
03952         <span class="comment">//</span>
03953         <span class="comment">// Deregister the device from its controlling service's service enum key</span>
03954         <span class="comment">//</span>
03955 
03956         status = PiDeviceRegistration(InstancePath,
03957                                       <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
03958                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
03959                                       );
03960     }
03961     ZwClose(instanceHandle);
03962 
03963     <span class="keywordflow">return</span> status;
03964 }
03965 
03966 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03967"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a26">03967</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a26">IopGetDeviceResourcesFromRegistry</a> (
03968     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
03969     IN ULONG ResourceType,
03970     IN ULONG Preference,
03971     OUT PVOID *Resource,
03972     OUT PULONG Length
03973     )
03974 
03975 <span class="comment">/*++</span>
03976 <span class="comment"></span>
03977 <span class="comment">Routine Description:</span>
03978 <span class="comment"></span>
03979 <span class="comment">    This routine determines the resources decoded by the device specified.</span>
03980 <span class="comment">    If the device object is a madeup device, we will try to read the resources</span>
03981 <span class="comment">    from registry.  Otherwise, we need to traverse the internal assigned resource</span>
03982 <span class="comment">    list to compose the resource list.</span>
03983 <span class="comment"></span>
03984 <span class="comment">Arguments:</span>
03985 <span class="comment"></span>
03986 <span class="comment">    DeviceObject - supplies a pointer to a device object whose registry</span>
03987 <span class="comment">        values are to be cleaned up.</span>
03988 <span class="comment"></span>
03989 <span class="comment">    ResourceType - 0 for CM_RESOURCE_LIST and 1 for IO_RESOURCE_REQUIREMENTS_LIS</span>
03990 <span class="comment"></span>
03991 <span class="comment">    Flags - specify the preference.</span>
03992 <span class="comment"></span>
03993 <span class="comment">    Resource - Specified a variable to receive the required resources.</span>
03994 <span class="comment"></span>
03995 <span class="comment">    Length - Specified a variable to receive the length of the resource structure.</span>
03996 <span class="comment"></span>
03997 <span class="comment">Return Value:</span>
03998 <span class="comment"></span>
03999 <span class="comment">    status</span>
04000 <span class="comment"></span>
04001 <span class="comment">--*/</span>
04002 
04003 {
04004     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
04005     HANDLE handle, handlex;
04006     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04007     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
04008     PCM_RESOURCE_LIST cmResource;
04009     PIO_RESOURCE_REQUIREMENTS_LIST ioResource;
04010     ULONG length;
04011     UNICODE_STRING unicodeName;
04012     PWCHAR valueName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04013 
04014     *<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04015     *Length = 0;
04016 
04017     <span class="comment">//</span>
04018     <span class="comment">// Open the LogConfig key of the device instance.</span>
04019     <span class="comment">//</span>
04020 
04021     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a24">IopDeviceObjectToDeviceInstance</a>(DeviceObject, &amp;handlex, KEY_READ);
04022     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04023         <span class="keywordflow">return</span> status;
04024     }
04025 
04026     <span class="keywordflow">if</span> (ResourceType == <a class="code" href="../../d9/d0/pnpiop_8h.html#a60">QUERY_RESOURCE_LIST</a>) {
04027 
04028         <span class="comment">//</span>
04029         <span class="comment">// Caller is asking for CM_RESOURCE_LIST</span>
04030         <span class="comment">//</span>
04031 
04032         <span class="keywordflow">if</span> (Preference &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a62">REGISTRY_ALLOC_CONFIG</a>) {
04033 
04034             <span class="comment">//</span>
04035             <span class="comment">// Try alloc config first</span>
04036             <span class="comment">//</span>
04037 
04038             PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_CONTROL);
04039             status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
04040                                         handlex,
04041                                         &amp;unicodeName,
04042                                         KEY_READ,
04043                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
04044                                         );
04045             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04046                 status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a27">IopReadDeviceConfiguration</a> (handle, <a class="code" href="../../d9/d0/pnpiop_8h.html#a62">REGISTRY_ALLOC_CONFIG</a>, (PCM_RESOURCE_LIST *)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>, Length);
04047                 ZwClose(handle);
04048                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04049                     ZwClose(handlex);
04050                     <span class="keywordflow">return</span> status;
04051                 }
04052             }
04053         }
04054 
04055         handle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04056         <span class="keywordflow">if</span> (Preference &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a63">REGISTRY_FORCED_CONFIG</a>) {
04057 
04058             PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_LOG_CONF);
04059             status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
04060                                         handlex,
04061                                         &amp;unicodeName,
04062                                         KEY_READ,
04063                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
04064                                         );
04065             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04066                 status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a27">IopReadDeviceConfiguration</a> (handle, <a class="code" href="../../d9/d0/pnpiop_8h.html#a63">REGISTRY_FORCED_CONFIG</a>, (PCM_RESOURCE_LIST *)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>, Length);
04067                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04068                     ZwClose(handle);
04069                     ZwClose(handlex);
04070                     <span class="keywordflow">return</span> status;
04071                 }
04072             } <span class="keywordflow">else</span> {
04073                 ZwClose(handlex);
04074                 <span class="keywordflow">return</span> status;
04075             }
04076         }
04077         <span class="keywordflow">if</span> (Preference &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a64">REGISTRY_BOOT_CONFIG</a>) {
04078 
04079             <span class="comment">//</span>
04080             <span class="comment">// Try alloc config first</span>
04081             <span class="comment">//</span>
04082 
04083             <span class="keywordflow">if</span> (handle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04084                 PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_LOG_CONF);
04085                 status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
04086                                             handlex,
04087                                             &amp;unicodeName,
04088                                             KEY_READ,
04089                                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
04090                                             );
04091                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04092                     ZwClose(handlex);
04093                     <span class="keywordflow">return</span> status;
04094                 }
04095             }
04096             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a27">IopReadDeviceConfiguration</a> (handle, <a class="code" href="../../d9/d0/pnpiop_8h.html#a64">REGISTRY_BOOT_CONFIG</a>, (PCM_RESOURCE_LIST *)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>, Length);
04097         }
04098         <span class="keywordflow">if</span> (handle) {
04099             ZwClose(handle);
04100         }
04101     } <span class="keywordflow">else</span> {
04102 
04103         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_LOG_CONF);
04104         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
04105                                     handlex,
04106                                     &amp;unicodeName,
04107                                     KEY_READ,
04108                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
04109                                     );
04110         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04111 
04112             <span class="keywordflow">if</span> (Preference &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a65">REGISTRY_OVERRIDE_CONFIGVECTOR</a>) {
04113                 valueName = REGSTR_VALUE_OVERRIDE_CONFIG_VECTOR;
04114             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Preference &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a66">REGISTRY_BASIC_CONFIGVECTOR</a>) {
04115                 valueName = REGSTR_VALUE_BASIC_CONFIG_VECTOR;
04116             }
04117             <span class="keywordflow">if</span> (valueName) {
04118 
04119                 <span class="comment">//</span>
04120                 <span class="comment">// Try to read device's configuration vector</span>
04121                 <span class="comment">//</span>
04122 
04123                 status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (handle,
04124                                               valueName,
04125                                               &amp;keyValueInformation);
04126                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04127 
04128                     <span class="comment">//</span>
04129                     <span class="comment">// Try to read what caller wants.</span>
04130                     <span class="comment">//</span>
04131 
04132                     <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_RESOURCE_REQUIREMENTS_LIST) &amp;&amp;
04133                         (keyValueInformation-&gt;DataLength != 0)) {
04134 
04135                         *<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
04136                                                    keyValueInformation-&gt;DataLength);
04137                         <span class="keywordflow">if</span> (*Resource) {
04138                             PIO_RESOURCE_REQUIREMENTS_LIST ioResource;
04139 
04140                             *Length = keyValueInformation-&gt;DataLength;
04141                             RtlMoveMemory(*<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>,
04142                                           <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
04143                                           keyValueInformation-&gt;DataLength);
04144 
04145                             <span class="comment">//</span>
04146                             <span class="comment">// Process the io resource requirements list to change undefined</span>
04147                             <span class="comment">// interface type to our default type.</span>
04148                             <span class="comment">//</span>
04149 
04150                             ioResource = *<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>;
04151                             <span class="keywordflow">if</span> (ioResource-&gt;InterfaceType == InterfaceTypeUndefined) {
04152                                 ioResource-&gt;BusNumber = 0;
04153                                 ioResource-&gt;InterfaceType = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
04154                             }
04155                         } <span class="keywordflow">else</span> {
04156                             status = STATUS_INVALID_PARAMETER_2;
04157                         }
04158                     }
04159                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
04160                 }
04161             }
04162             ZwClose(handle);
04163         }
04164     }
04165     ZwClose(handlex);
04166     <span class="keywordflow">return</span> status;
04167 }
04168 
04169 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04170"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a27">04170</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a27">IopReadDeviceConfiguration</a> (
04171     IN HANDLE Handle,
04172     IN ULONG Flags,
04173     OUT PCM_RESOURCE_LIST *CmResource,
04174     OUT PULONG Length
04175     )
04176 
04177 <span class="comment">/*++</span>
04178 <span class="comment"></span>
04179 <span class="comment">Routine Description:</span>
04180 <span class="comment"></span>
04181 <span class="comment">    This routine read the specified ALLOC config or ForcedConfig or Boot config.</span>
04182 <span class="comment"></span>
04183 <span class="comment">Arguments:</span>
04184 <span class="comment"></span>
04185 <span class="comment">    Hanle - supplies a handle to the registry key to read resources.</span>
04186 <span class="comment"></span>
04187 <span class="comment">Return Value:</span>
04188 <span class="comment"></span>
04189 <span class="comment">    status</span>
04190 <span class="comment"></span>
04191 <span class="comment">--*/</span>
04192 
04193 {
04194     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04195     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
04196     PWCHAR valueName;
04197 
04198     *CmResource = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04199     *Length = 0;
04200 
04201     <span class="keywordflow">if</span> (Flags == <a class="code" href="../../d9/d0/pnpiop_8h.html#a62">REGISTRY_ALLOC_CONFIG</a>) {
04202         valueName = REGSTR_VALUE_ALLOC_CONFIG;
04203     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Flags == <a class="code" href="../../d9/d0/pnpiop_8h.html#a63">REGISTRY_FORCED_CONFIG</a>) {
04204         valueName = REGSTR_VALUE_FORCED_CONFIG;
04205     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Flags == <a class="code" href="../../d9/d0/pnpiop_8h.html#a64">REGISTRY_BOOT_CONFIG</a>) {
04206         valueName = REGSTR_VALUE_BOOT_CONFIG;
04207     } <span class="keywordflow">else</span> {
04208         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
04209     }
04210 
04211     <span class="comment">//</span>
04212     <span class="comment">// Read the registry value of the desired value name</span>
04213     <span class="comment">//</span>
04214 
04215     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
04216                                   valueName,
04217                                   &amp;keyValueInformation);
04218     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04219 
04220         <span class="comment">//</span>
04221         <span class="comment">// Try to read what caller wants.</span>
04222         <span class="comment">//</span>
04223 
04224         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_RESOURCE_LIST) &amp;&amp;
04225             (keyValueInformation-&gt;DataLength != 0)) {
04226             *CmResource = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
04227                                          keyValueInformation-&gt;DataLength);
04228             <span class="keywordflow">if</span> (*CmResource) {
04229                 <span class="keywordflow">if</span> (*CmResource) {
04230                     *Length = keyValueInformation-&gt;DataLength;
04231                     RtlMoveMemory(*CmResource,
04232                                   <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
04233                                   keyValueInformation-&gt;DataLength);
04234                 } <span class="keywordflow">else</span> {
04235                     status = STATUS_INSUFFICIENT_RESOURCES;
04236                 }
04237             }
04238             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
04239             <span class="keywordflow">if</span> (*CmResource) {
04240                 PCM_RESOURCE_LIST resourceList;
04241                 PCM_FULL_RESOURCE_DESCRIPTOR cmFullDesc;
04242                 PCM_PARTIAL_RESOURCE_DESCRIPTOR cmPartDesc;
04243                 ULONG j, k, size, count;
04244 
04245                 <span class="comment">//</span>
04246                 <span class="comment">// Process the resource list read from Registry to change undefined</span>
04247                 <span class="comment">// interface type to our default interface type.</span>
04248                 <span class="comment">//</span>
04249 
04250                 resourceList = *CmResource;
04251                 cmFullDesc = &amp;resourceList-&gt;List[0];
04252                 <span class="keywordflow">for</span> (j = 0; j &lt; resourceList-&gt;Count; j++) {
04253                     <span class="keywordflow">if</span> (cmFullDesc-&gt;InterfaceType == InterfaceTypeUndefined) {
04254                         cmFullDesc-&gt;BusNumber = 0;
04255                         cmFullDesc-&gt;InterfaceType = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
04256                     }
04257                     cmPartDesc = &amp;cmFullDesc-&gt;PartialResourceList.PartialDescriptors[0];
04258                     <span class="keywordflow">for</span> (k = 0; k &lt; cmFullDesc-&gt;PartialResourceList.Count; k++) {
04259                         size = 0;
04260                         <span class="keywordflow">switch</span> (cmPartDesc-&gt;Type) {
04261                         <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
04262                              size = cmPartDesc-&gt;u.DeviceSpecificData.DataSize;
04263                              <span class="keywordflow">break</span>;
04264                         }
04265                         cmPartDesc++;
04266                         cmPartDesc = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmPartDesc + size);
04267                     }
04268                     cmFullDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)cmPartDesc;
04269                 }
04270             }
04271         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (keyValueInformation-&gt;Type != REG_RESOURCE_LIST) {
04272             status = STATUS_UNSUCCESSFUL;
04273         }
04274     }
04275     <span class="keywordflow">return</span> status;
04276 }
04277 
04278 PIO_RESOURCE_REQUIREMENTS_LIST
<a name="l04279"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a28">04279</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a28">IopCmResourcesToIoResources</a> (
04280     IN ULONG SlotNumber,
04281     IN PCM_RESOURCE_LIST CmResourceList,
04282     IN ULONG Priority
04283     )
04284 
04285 <span class="comment">/*++</span>
04286 <span class="comment"></span>
04287 <span class="comment">Routine Description:</span>
04288 <span class="comment"></span>
04289 <span class="comment">    This routines converts the input CmResourceList to IO_RESOURCE_REQUIREMENTS_LIST.</span>
04290 <span class="comment"></span>
04291 <span class="comment">Arguments:</span>
04292 <span class="comment"></span>
04293 <span class="comment">    SlotNumber - supplies the SlotNumber the resources refer to.</span>
04294 <span class="comment"></span>
04295 <span class="comment">    CmResourceList - the cm resource list to convert.</span>
04296 <span class="comment"></span>
04297 <span class="comment">    Priority - specifies the priority of the logconfig</span>
04298 <span class="comment"></span>
04299 <span class="comment">Return Value:</span>
04300 <span class="comment"></span>
04301 <span class="comment">    returns a IO_RESOURCE_REQUIREMENTS_LISTST if succeeds.  Otherwise a NULL value is</span>
04302 <span class="comment">    returned.</span>
04303 <span class="comment"></span>
04304 <span class="comment">--*/</span>
04305 {
04306     PIO_RESOURCE_REQUIREMENTS_LIST ioResReqList;
04307     ULONG count = 0, size, i, j;
04308     PCM_FULL_RESOURCE_DESCRIPTOR cmFullDesc;
04309     PCM_PARTIAL_RESOURCE_DESCRIPTOR cmPartDesc;
04310     PIO_RESOURCE_DESCRIPTOR ioDesc;
04311 
04312     <span class="comment">//</span>
04313     <span class="comment">// First determine number of descriptors required.</span>
04314     <span class="comment">//</span>
04315 
04316     cmFullDesc = &amp;CmResourceList-&gt;List[0];
04317     <span class="keywordflow">for</span> (i = 0; i &lt; CmResourceList-&gt;Count; i++) {
04318         count += cmFullDesc-&gt;PartialResourceList.Count;
04319         cmPartDesc = &amp;cmFullDesc-&gt;PartialResourceList.PartialDescriptors[0];
04320         <span class="keywordflow">for</span> (j = 0; j &lt; cmFullDesc-&gt;PartialResourceList.Count; j++) {
04321             size = 0;
04322             <span class="keywordflow">switch</span> (cmPartDesc-&gt;Type) {
04323             <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
04324                  size = cmPartDesc-&gt;u.DeviceSpecificData.DataSize;
04325                  count--;
04326                  <span class="keywordflow">break</span>;
04327             }
04328             cmPartDesc++;
04329             cmPartDesc = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmPartDesc + size);
04330         }
04331         cmFullDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)cmPartDesc;
04332     }
04333 
04334     <span class="keywordflow">if</span> (count == 0) {
04335         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04336     }
04337 
04338     <span class="comment">//</span>
04339     <span class="comment">// Count the extra descriptors for InterfaceType and BusNumber information.</span>
04340     <span class="comment">//</span>
04341 
04342     count += CmResourceList-&gt;Count - 1;
04343 
04344     <span class="comment">//</span>
04345     <span class="comment">// Allocate heap space for IO RESOURCE REQUIREMENTS LIST</span>
04346     <span class="comment">//</span>
04347 
04348     count++;           <span class="comment">// add one for CmResourceTypeConfigData</span>
04349     ioResReqList = (PIO_RESOURCE_REQUIREMENTS_LIST)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
04350                        <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
04351                        <span class="keyword">sizeof</span>(IO_RESOURCE_REQUIREMENTS_LIST) +
04352                            count * <span class="keyword">sizeof</span>(IO_RESOURCE_DESCRIPTOR)
04353                        );
04354     <span class="keywordflow">if</span> (!ioResReqList) {
04355         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04356     }
04357 
04358     <span class="comment">//</span>
04359     <span class="comment">// Parse the cm resource descriptor and build its corresponding IO resource descriptor</span>
04360     <span class="comment">//</span>
04361 
04362     ioResReqList-&gt;InterfaceType = CmResourceList-&gt;List[0].InterfaceType;
04363     ioResReqList-&gt;BusNumber = CmResourceList-&gt;List[0].BusNumber;
04364     ioResReqList-&gt;SlotNumber = SlotNumber;
04365     ioResReqList-&gt;Reserved[0] = 0;
04366     ioResReqList-&gt;Reserved[1] = 0;
04367     ioResReqList-&gt;Reserved[2] = 0;
04368     ioResReqList-&gt;AlternativeLists = 1;
04369     ioResReqList-&gt;List[0].Version = 1;
04370     ioResReqList-&gt;List[0].Revision = 1;
04371     ioResReqList-&gt;List[0].Count = count;
04372 
04373     <span class="comment">//</span>
04374     <span class="comment">// Generate a CmResourceTypeConfigData descriptor</span>
04375     <span class="comment">//</span>
04376 
04377     ioDesc = &amp;ioResReqList-&gt;List[0].Descriptors[0];
04378     ioDesc-&gt;Option = IO_RESOURCE_PREFERRED;
04379     ioDesc-&gt;Type = CmResourceTypeConfigData;
04380     ioDesc-&gt;ShareDisposition = CmResourceShareShared;
04381     ioDesc-&gt;Flags = 0;
04382     ioDesc-&gt;Spare1 = 0;
04383     ioDesc-&gt;Spare2 = 0;
04384     ioDesc-&gt;u.ConfigData.Priority = Priority;
04385     ioDesc++;
04386 
04387     cmFullDesc = &amp;CmResourceList-&gt;List[0];
04388     <span class="keywordflow">for</span> (i = 0; i &lt; CmResourceList-&gt;Count; i++) {
04389         <span class="keywordflow">if</span> (i != 0) {
04390 
04391             <span class="comment">//</span>
04392             <span class="comment">// Set up descriptor to remember the InterfaceType and BusNumber.</span>
04393             <span class="comment">//</span>
04394 
04395             ioDesc-&gt;Option = IO_RESOURCE_PREFERRED;
04396             ioDesc-&gt;Type = <a class="code" href="../../d9/d0/pnpiop_8h.html#a74">CmResourceTypeReserved</a>;
04397             ioDesc-&gt;ShareDisposition = CmResourceShareUndetermined;
04398             ioDesc-&gt;Flags = 0;
04399             ioDesc-&gt;Spare1 = 0;
04400             ioDesc-&gt;Spare2 = 0;
04401             <span class="keywordflow">if</span> (cmFullDesc-&gt;InterfaceType == InterfaceTypeUndefined) {
04402                 ioDesc-&gt;u.DevicePrivate.Data[0] = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
04403             } <span class="keywordflow">else</span> {
04404                 ioDesc-&gt;u.DevicePrivate.Data[0] = cmFullDesc-&gt;InterfaceType;
04405             }
04406             ioDesc-&gt;u.DevicePrivate.Data[1] = cmFullDesc-&gt;BusNumber;
04407             ioDesc-&gt;u.DevicePrivate.Data[2] = 0;
04408             ioDesc++;
04409         }
04410         cmPartDesc = &amp;cmFullDesc-&gt;PartialResourceList.PartialDescriptors[0];
04411         <span class="keywordflow">for</span> (j = 0; j &lt; cmFullDesc-&gt;PartialResourceList.Count; j++) {
04412             ioDesc-&gt;Option = IO_RESOURCE_PREFERRED;
04413             ioDesc-&gt;Type = cmPartDesc-&gt;Type;
04414             ioDesc-&gt;ShareDisposition = cmPartDesc-&gt;ShareDisposition;
04415             ioDesc-&gt;Flags = cmPartDesc-&gt;Flags;
04416             ioDesc-&gt;Spare1 = 0;
04417             ioDesc-&gt;Spare2 = 0;
04418 
04419             size = 0;
04420             <span class="keywordflow">switch</span> (cmPartDesc-&gt;Type) {
04421             <span class="keywordflow">case</span> CmResourceTypePort:
04422                  ioDesc-&gt;u.Port.MinimumAddress = cmPartDesc-&gt;u.Port.Start;
04423                  ioDesc-&gt;u.Port.MaximumAddress.QuadPart = cmPartDesc-&gt;u.Port.Start.QuadPart +
04424                                                              cmPartDesc-&gt;u.Port.Length - 1;
04425                  ioDesc-&gt;u.Port.Alignment = 1;
04426                  ioDesc-&gt;u.Port.Length = cmPartDesc-&gt;u.Port.Length;
04427                  ioDesc++;
04428                  <span class="keywordflow">break</span>;
04429             <span class="keywordflow">case</span> CmResourceTypeInterrupt:
04430 <span class="preprocessor">#if defined(_X86_)</span>
04431 <span class="preprocessor"></span>                ioDesc-&gt;u.Interrupt.MinimumVector = ioDesc-&gt;u.Interrupt.MaximumVector =
04432                    cmPartDesc-&gt;u.Interrupt.Level;
04433 <span class="preprocessor">#else</span>
04434 <span class="preprocessor"></span>                 ioDesc-&gt;u.Interrupt.MinimumVector = ioDesc-&gt;u.Interrupt.MaximumVector =
04435                     cmPartDesc-&gt;u.Interrupt.Vector;
04436 <span class="preprocessor">#endif</span>
04437 <span class="preprocessor"></span>                 ioDesc++;
04438                  <span class="keywordflow">break</span>;
04439             <span class="keywordflow">case</span> CmResourceTypeMemory:
04440                  ioDesc-&gt;u.Memory.MinimumAddress = cmPartDesc-&gt;u.Memory.Start;
04441                  ioDesc-&gt;u.Memory.MaximumAddress.QuadPart = cmPartDesc-&gt;u.Memory.Start.QuadPart +
04442                                                                cmPartDesc-&gt;u.Memory.Length - 1;
04443                  ioDesc-&gt;u.Memory.Alignment = 1;
04444                  ioDesc-&gt;u.Memory.Length = cmPartDesc-&gt;u.Memory.Length;
04445                  ioDesc++;
04446                  <span class="keywordflow">break</span>;
04447             <span class="keywordflow">case</span> CmResourceTypeDma:
04448                  ioDesc-&gt;u.Dma.MinimumChannel = cmPartDesc-&gt;u.Dma.Channel;
04449                  ioDesc-&gt;u.Dma.MaximumChannel = cmPartDesc-&gt;u.Dma.Channel;
04450                  ioDesc++;
04451                  <span class="keywordflow">break</span>;
04452             <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
04453                  size = cmPartDesc-&gt;u.DeviceSpecificData.DataSize;
04454                  <span class="keywordflow">break</span>;
04455             <span class="keywordflow">case</span> CmResourceTypeBusNumber:
04456                  ioDesc-&gt;u.BusNumber.MinBusNumber = cmPartDesc-&gt;u.BusNumber.Start;
04457                  ioDesc-&gt;u.BusNumber.MaxBusNumber = cmPartDesc-&gt;u.BusNumber.Start +
04458                                                     cmPartDesc-&gt;u.BusNumber.Length - 1;
04459                  ioDesc-&gt;u.BusNumber.Length = cmPartDesc-&gt;u.BusNumber.Length;
04460                  ioDesc++;
04461                  <span class="keywordflow">break</span>;
04462             <span class="keywordflow">default</span>:
04463                  ioDesc-&gt;u.DevicePrivate.Data[0] = cmPartDesc-&gt;u.DevicePrivate.Data[0];
04464                  ioDesc-&gt;u.DevicePrivate.Data[1] = cmPartDesc-&gt;u.DevicePrivate.Data[1];
04465                  ioDesc-&gt;u.DevicePrivate.Data[2] = cmPartDesc-&gt;u.DevicePrivate.Data[2];
04466                  ioDesc++;
04467                  <span class="keywordflow">break</span>;
04468             }
04469             cmPartDesc++;
04470             cmPartDesc = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmPartDesc + size);
04471         }
04472         cmFullDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)cmPartDesc;
04473     }
04474     ioResReqList-&gt;ListSize = (ULONG)((ULONG_PTR)ioDesc - (ULONG_PTR)ioResReqList);
04475     <span class="keywordflow">return</span> ioResReqList;
04476 }
04477 
04478 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04479"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a29">04479</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a29">IopFilterResourceRequirementsList</a> (
04480     IN PIO_RESOURCE_REQUIREMENTS_LIST IoList,
04481     IN PCM_RESOURCE_LIST CmList,
04482     IN OUT PIO_RESOURCE_REQUIREMENTS_LIST *FilteredList,
04483     OUT PBOOLEAN ExactMatch
04484     )
04485 
04486 <span class="comment">/*++</span>
04487 <span class="comment"></span>
04488 <span class="comment">Routine Description:</span>
04489 <span class="comment"></span>
04490 <span class="comment">    This routines adjusts the input IoList based on input BootConfig.</span>
04491 <span class="comment"></span>
04492 <span class="comment"></span>
04493 <span class="comment">Arguments:</span>
04494 <span class="comment"></span>
04495 <span class="comment">    IoList - supplies the pointer to an IoResourceRequirementsList</span>
04496 <span class="comment"></span>
04497 <span class="comment">    CmList - supplies the pointer to a BootConfig.</span>
04498 <span class="comment"></span>
04499 <span class="comment">    FilteredList - Supplies a variable to receive the filtered resource</span>
04500 <span class="comment">             requirements list.</span>
04501 <span class="comment"></span>
04502 <span class="comment">Return Value:</span>
04503 <span class="comment"></span>
04504 <span class="comment">    A NTSTATUS code to indicate the result of the function.</span>
04505 <span class="comment"></span>
04506 <span class="comment">--*/</span>
04507 {
04508     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04509     PIO_RESOURCE_REQUIREMENTS_LIST ioList, newList;
04510     PIO_RESOURCE_LIST ioResourceList, newIoResourceList, selectedResourceList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04511     PIO_RESOURCE_DESCRIPTOR ioResourceDescriptor, ioResourceDescriptorEnd;
04512     PIO_RESOURCE_DESCRIPTOR newIoResourceDescriptor, configDataDescriptor;
04513     LONG ioResourceDescriptorCount = 0;
04514     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> version;
04515     PCM_FULL_RESOURCE_DESCRIPTOR cmFullDesc;
04516     PCM_PARTIAL_RESOURCE_DESCRIPTOR cmDescriptor;
04517     ULONG cmDescriptorCount = 0;
04518     ULONG size, i, j, oldCount, phase;
04519     LONG k, alternativeLists;
04520     BOOLEAN exactMatch;
04521 
04522     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04523 
04524     *FilteredList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04525     *ExactMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04526 
04527     <span class="comment">//</span>
04528     <span class="comment">// Make sure there is some resource requirements to be filtered.</span>
04529     <span class="comment">// If no, we will convert CmList/BootConfig to an IoResourceRequirementsList</span>
04530     <span class="comment">//</span>
04531 
04532     <span class="keywordflow">if</span> (IoList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || IoList-&gt;AlternativeLists == 0) {
04533         <span class="keywordflow">if</span> (CmList &amp;&amp; CmList-&gt;Count != 0) {
04534             *FilteredList = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a28">IopCmResourcesToIoResources</a> (0, CmList, LCPRI_BOOTCONFIG);
04535         }
04536         <span class="keywordflow">return</span> STATUS_SUCCESS;
04537     }
04538 
04539     <span class="comment">//</span>
04540     <span class="comment">// Make a copy of the Io Resource Requirements List</span>
04541     <span class="comment">//</span>
04542 
04543     ioList = (PIO_RESOURCE_REQUIREMENTS_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, IoList-&gt;ListSize);
04544     <span class="keywordflow">if</span> (ioList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04545         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
04546     }
04547 
04548     RtlMoveMemory(ioList, IoList, IoList-&gt;ListSize);
04549 
04550     <span class="comment">//</span>
04551     <span class="comment">// If there is no BootConfig, simply return the copy of the input Io list.</span>
04552     <span class="comment">//</span>
04553 
04554     <span class="keywordflow">if</span> (CmList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || CmList-&gt;Count == 0) {
04555         *FilteredList = ioList;
04556         <span class="keywordflow">return</span> STATUS_SUCCESS;
04557     }
04558 
04559     <span class="comment">//</span>
04560     <span class="comment">// First determine minimum number of descriptors required.</span>
04561     <span class="comment">//</span>
04562 
04563     cmFullDesc = &amp;CmList-&gt;List[0];
04564     <span class="keywordflow">for</span> (i = 0; i &lt; CmList-&gt;Count; i++) {
04565         cmDescriptorCount += cmFullDesc-&gt;PartialResourceList.Count;
04566         cmDescriptor = &amp;cmFullDesc-&gt;PartialResourceList.PartialDescriptors[0];
04567         <span class="keywordflow">for</span> (j = 0; j &lt; cmFullDesc-&gt;PartialResourceList.Count; j++) {
04568             size = 0;
04569             <span class="keywordflow">switch</span> (cmDescriptor-&gt;Type) {
04570             <span class="keywordflow">case</span> CmResourceTypeConfigData:
04571             <span class="keywordflow">case</span> CmResourceTypeDevicePrivate:
04572                  cmDescriptorCount--;
04573                  <span class="keywordflow">break</span>;
04574             <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
04575                  size = cmDescriptor-&gt;u.DeviceSpecificData.DataSize;
04576                  cmDescriptorCount--;
04577                  <span class="keywordflow">break</span>;
04578             <span class="keywordflow">default</span>:
04579 
04580                  <span class="comment">//</span>
04581                  <span class="comment">// Invalid cmresource list.  Ignore it and use io resources</span>
04582                  <span class="comment">//</span>
04583 
04584                  <span class="keywordflow">if</span> (cmDescriptor-&gt;Type == CmResourceTypeNull ||
04585                      cmDescriptor-&gt;Type &gt;= CmResourceTypeMaximum) {
04586                      cmDescriptorCount--;
04587                  }
04588             }
04589             cmDescriptor++;
04590             cmDescriptor = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmDescriptor + size);
04591         }
04592         cmFullDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)cmDescriptor;
04593     }
04594 
04595     <span class="keywordflow">if</span> (cmDescriptorCount == 0) {
04596         *FilteredList = ioList;
04597         <span class="keywordflow">return</span> STATUS_SUCCESS;
04598     }
04599 
04600     <span class="comment">//</span>
04601     <span class="comment">// cmDescriptorCount is the number of BootConfig Descriptors needs.</span>
04602     <span class="comment">//</span>
04603     <span class="comment">// For each IO list Alternative ...</span>
04604     <span class="comment">//</span>
04605 
04606     ioResourceList = ioList-&gt;List;
04607     k = ioList-&gt;AlternativeLists;
04608     <span class="keywordflow">while</span> (--k &gt;= 0) {
04609         ioResourceDescriptor = ioResourceList-&gt;Descriptors;
04610         ioResourceDescriptorEnd = ioResourceDescriptor + ioResourceList-&gt;Count;
04611         <span class="keywordflow">while</span> (ioResourceDescriptor &lt; ioResourceDescriptorEnd) {
04612             ioResourceDescriptor-&gt;Spare1 = 0;
04613             ioResourceDescriptor++;
04614         }
04615         ioResourceList = (PIO_RESOURCE_LIST) ioResourceDescriptorEnd;
04616     }
04617 
04618     ioResourceList = ioList-&gt;List;
04619     k = alternativeLists = ioList-&gt;AlternativeLists;
04620     <span class="keywordflow">while</span> (--k &gt;= 0) {
04621         version = ioResourceList-&gt;Version;
04622         <span class="keywordflow">if</span> (version == 0xffff) {  <span class="comment">// Convert bogus version to valid number</span>
04623             version = 1;
04624         }
04625 
04626         <span class="comment">//</span>
04627         <span class="comment">// We use Version field to store number of BootConfig found.</span>
04628         <span class="comment">// Count field to store new number of descriptor in the alternative list.</span>
04629         <span class="comment">//</span>
04630 
04631         ioResourceList-&gt;Version = 0;
04632         oldCount = ioResourceList-&gt;Count;
04633 
04634         ioResourceDescriptor = ioResourceList-&gt;Descriptors;
04635         ioResourceDescriptorEnd = ioResourceDescriptor + ioResourceList-&gt;Count;
04636 
04637         <span class="keywordflow">if</span> (ioResourceDescriptor == ioResourceDescriptorEnd) {
04638 
04639             <span class="comment">//</span>
04640             <span class="comment">// An alternative list with zero descriptor count</span>
04641             <span class="comment">//</span>
04642 
04643             ioResourceList-&gt;Version = 0xffff;  <span class="comment">// Mark it as invalid</span>
04644             ioList-&gt;AlternativeLists--;
04645             <span class="keywordflow">continue</span>;
04646         }
04647 
04648         exactMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04649 
04650         <span class="comment">//</span>
04651         <span class="comment">// For each Cm Resource descriptor ... except DevicePrivate and</span>
04652         <span class="comment">// DeviceSpecific...</span>
04653         <span class="comment">//</span>
04654 
04655         cmFullDesc = &amp;CmList-&gt;List[0];
04656         <span class="keywordflow">for</span> (i = 0; i &lt; CmList-&gt;Count; i++) {
04657             cmDescriptor = &amp;cmFullDesc-&gt;PartialResourceList.PartialDescriptors[0];
04658             <span class="keywordflow">for</span> (j = 0; j &lt; cmFullDesc-&gt;PartialResourceList.Count; j++) {
04659                 size = 0;
04660                 <span class="keywordflow">switch</span> (cmDescriptor-&gt;Type) {
04661                 <span class="keywordflow">case</span> CmResourceTypeDevicePrivate:
04662                      <span class="keywordflow">break</span>;
04663                 <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
04664                      size = cmDescriptor-&gt;u.DeviceSpecificData.DataSize;
04665                      <span class="keywordflow">break</span>;
04666                 <span class="keywordflow">default</span>:
04667                     <span class="keywordflow">if</span> (cmDescriptor-&gt;Type == CmResourceTypeNull ||
04668                         cmDescriptor-&gt;Type &gt;= CmResourceTypeMaximum) {
04669                         <span class="keywordflow">break</span>;
04670                     }
04671 
04672                     <span class="comment">//</span>
04673                     <span class="comment">// Check CmDescriptor against current Io Alternative list</span>
04674                     <span class="comment">//</span>
04675 
04676                     <span class="keywordflow">for</span> (phase = 0; phase &lt; 2; phase++) {
04677                         ioResourceDescriptor = ioResourceList-&gt;Descriptors;
04678                         <span class="keywordflow">while</span> (ioResourceDescriptor &lt; ioResourceDescriptorEnd) {
04679                             <span class="keywordflow">if</span> ((ioResourceDescriptor-&gt;Type == cmDescriptor-&gt;Type) &amp;&amp;
04680                                 (ioResourceDescriptor-&gt;Spare1 == 0)) {
04681                                 ULONGLONG min1, max1, min2, max2;
04682                                 ULONG len1 = 1, len2 = 1, align1, align2;
04683                                 UCHAR share1, share2;
04684 
04685                                 share2 = ioResourceDescriptor-&gt;ShareDisposition;
04686                                 share1 = cmDescriptor-&gt;ShareDisposition;
04687                                 <span class="keywordflow">if</span> ((share1 == CmResourceShareUndetermined) ||
04688                                     (share1 &gt; CmResourceShareShared)) {
04689                                     share1 = share2;
04690                                 }
04691                                 <span class="keywordflow">if</span> ((share2 == CmResourceShareUndetermined) ||
04692                                     (share2 &gt; CmResourceShareShared)) {
04693                                     share2 = share1;
04694                                 }
04695                                 align1 = align2 = 1;
04696 
04697                                 <span class="keywordflow">switch</span> (cmDescriptor-&gt;Type) {
04698                                 <span class="keywordflow">case</span> CmResourceTypePort:
04699                                 <span class="keywordflow">case</span> CmResourceTypeMemory:
04700                                     min1 = cmDescriptor-&gt;u.Port.Start.QuadPart;
04701                                     max1 = cmDescriptor-&gt;u.Port.Start.QuadPart + cmDescriptor-&gt;u.Port.Length - 1;
04702                                     len1 = cmDescriptor-&gt;u.Port.Length;
04703                                     min2 = ioResourceDescriptor-&gt;u.Port.MinimumAddress.QuadPart;
04704                                     max2 = ioResourceDescriptor-&gt;u.Port.MaximumAddress.QuadPart;
04705                                     len2 = ioResourceDescriptor-&gt;u.Port.Length;
04706                                     align2 = ioResourceDescriptor-&gt;u.Port.Alignment;
04707                                     <span class="keywordflow">break</span>;
04708                                 <span class="keywordflow">case</span> CmResourceTypeInterrupt:
04709                                     max1 = min1 = cmDescriptor-&gt;u.Interrupt.Vector;
04710                                     min2 = ioResourceDescriptor-&gt;u.Interrupt.MinimumVector;
04711                                     max2 = ioResourceDescriptor-&gt;u.Interrupt.MaximumVector;
04712                                     <span class="keywordflow">break</span>;
04713                                 <span class="keywordflow">case</span> CmResourceTypeDma:
04714                                     min1 = max1 =cmDescriptor-&gt;u.Dma.Channel;
04715                                     min2 = ioResourceDescriptor-&gt;u.Dma.MinimumChannel;
04716                                     max2 = ioResourceDescriptor-&gt;u.Dma.MaximumChannel;
04717                                     <span class="keywordflow">break</span>;
04718                                 <span class="keywordflow">case</span> CmResourceTypeBusNumber:
04719                                     min1 = cmDescriptor-&gt;u.BusNumber.Start;
04720                                     max1 = cmDescriptor-&gt;u.BusNumber.Start + cmDescriptor-&gt;u.BusNumber.Length - 1;
04721                                     len1 = cmDescriptor-&gt;u.BusNumber.Length;
04722                                     min2 = ioResourceDescriptor-&gt;u.BusNumber.MinBusNumber;
04723                                     max2 = ioResourceDescriptor-&gt;u.BusNumber.MaxBusNumber;
04724                                     len2 = ioResourceDescriptor-&gt;u.BusNumber.Length;
04725                                     <span class="keywordflow">break</span>;
04726                                 <span class="keywordflow">default</span>:
04727                                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
04728                                     <span class="keywordflow">break</span>;
04729                                 }
04730                                 <span class="keywordflow">if</span> (phase == 0) {
04731                                     <span class="keywordflow">if</span> (share1 == share2 &amp;&amp; min2 == min1 &amp;&amp; max2 &gt;= max1 &amp;&amp; len2 &gt;= len1) {
04732 
04733                                         <span class="comment">//</span>
04734                                         <span class="comment">// For phase 0 match, we want near exact match...</span>
04735                                         <span class="comment">//</span>
04736 
04737                                         <span class="keywordflow">if</span> (max2 != max1) {
04738                                             exactMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04739                                         }
04740                                         ioResourceList-&gt;Version++;
04741                                         ioResourceDescriptor-&gt;Spare1 = 0x80;
04742                                         <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE) {
04743                                             PIO_RESOURCE_DESCRIPTOR ioDesc;
04744 
04745                                             ioDesc = ioResourceDescriptor;
04746                                             ioDesc--;
04747                                             <span class="keywordflow">while</span> (ioDesc &gt;= ioResourceList-&gt;Descriptors) {
04748                                                 ioDesc-&gt;Type = CmResourceTypeNull;
04749                                                 ioResourceList-&gt;Count--;
04750                                                 <span class="keywordflow">if</span> (ioDesc-&gt;Option == IO_RESOURCE_ALTERNATIVE) {
04751                                                     ioDesc--;
04752                                                 } <span class="keywordflow">else</span> {
04753                                                     <span class="keywordflow">break</span>;
04754                                                 }
04755                                             }
04756                                         }
04757                                         ioResourceDescriptor-&gt;Option = IO_RESOURCE_PREFERRED;
04758                                         ioResourceDescriptor-&gt;Flags = cmDescriptor-&gt;Flags;
04759                                         <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Type == CmResourceTypePort ||
04760                                             ioResourceDescriptor-&gt;Type == CmResourceTypeMemory) {
04761                                             ioResourceDescriptor-&gt;u.Port.MinimumAddress.QuadPart = min1;
04762                                             ioResourceDescriptor-&gt;u.Port.MaximumAddress.QuadPart = min1 + len2 - 1;
04763                                             ioResourceDescriptor-&gt;u.Port.Alignment = 1;
04764                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Type == CmResourceTypeBusNumber) {
04765                                             ioResourceDescriptor-&gt;u.BusNumber.MinBusNumber = (ULONG)min1;
04766                                             ioResourceDescriptor-&gt;u.BusNumber.MaxBusNumber = (ULONG)(min1 + len2 - 1);
04767                                         }
04768                                         ioResourceDescriptor++;
04769                                         <span class="keywordflow">while</span> (ioResourceDescriptor &lt; ioResourceDescriptorEnd) {
04770                                             <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE) {
04771                                                 ioResourceDescriptor-&gt;Type = CmResourceTypeNull;
04772                                                 ioResourceDescriptor++;
04773                                                 ioResourceList-&gt;Count--;
04774                                             } <span class="keywordflow">else</span> {
04775                                                 <span class="keywordflow">break</span>;
04776                                             }
04777                                         }
04778                                         phase = 1;   <span class="comment">// skip phase 1</span>
04779                                         <span class="keywordflow">break</span>;
04780                                     } <span class="keywordflow">else</span> {
04781                                         ioResourceDescriptor++;
04782                                     }
04783                                 } <span class="keywordflow">else</span> {
04784                                     exactMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04785                                     <span class="keywordflow">if</span> (share1 == share2 &amp;&amp; min2 &lt;= min1 &amp;&amp; max2 &gt;= max1 &amp;&amp; len2 &gt;= len1 &amp;&amp;
04786                                         (min1 &amp; (align2 - 1)) == 0) {
04787 
04788                                         <span class="comment">//</span>
04789                                         <span class="comment">// Io range covers Cm range ... Change the Io range to what is specified</span>
04790                                         <span class="comment">// in BootConfig.</span>
04791                                         <span class="comment">//</span>
04792                                         <span class="comment">//</span>
04793 
04794                                         <span class="keywordflow">switch</span> (cmDescriptor-&gt;Type) {
04795                                         <span class="keywordflow">case</span> CmResourceTypePort:
04796                                         <span class="keywordflow">case</span> CmResourceTypeMemory:
04797                                             ioResourceDescriptor-&gt;u.Port.MinimumAddress.QuadPart = min1;
04798                                             ioResourceDescriptor-&gt;u.Port.MaximumAddress.QuadPart = min1 + len2 - 1;
04799                                             <span class="keywordflow">break</span>;
04800                                         <span class="keywordflow">case</span> CmResourceTypeInterrupt:
04801                                         <span class="keywordflow">case</span> CmResourceTypeDma:
04802                                             ioResourceDescriptor-&gt;u.Interrupt.MinimumVector = (ULONG)min1;
04803                                             ioResourceDescriptor-&gt;u.Interrupt.MaximumVector = (ULONG)max1;
04804                                             <span class="keywordflow">break</span>;
04805                                         <span class="keywordflow">case</span> CmResourceTypeBusNumber:
04806                                             ioResourceDescriptor-&gt;u.BusNumber.MinBusNumber = (ULONG)min1;
04807                                             ioResourceDescriptor-&gt;u.BusNumber.MaxBusNumber = (ULONG)(min1 + len2 - 1);
04808                                             <span class="keywordflow">break</span>;
04809                                         }
04810                                         ioResourceList-&gt;Version++;
04811                                         ioResourceDescriptor-&gt;Spare1 = 0x80;
04812                                         ioResourceDescriptor-&gt;Flags = cmDescriptor-&gt;Flags;
04813                                         <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE) {
04814                                             PIO_RESOURCE_DESCRIPTOR ioDesc;
04815 
04816                                             ioDesc = ioResourceDescriptor;
04817                                             ioDesc--;
04818                                             <span class="keywordflow">while</span> (ioDesc &gt;= ioResourceList-&gt;Descriptors) {
04819                                                 ioDesc-&gt;Type = CmResourceTypeNull;
04820                                                 ioResourceList-&gt;Count--;
04821                                                 <span class="keywordflow">if</span> (ioDesc-&gt;Option == IO_RESOURCE_ALTERNATIVE) {
04822                                                     ioDesc--;
04823                                                 } <span class="keywordflow">else</span> {
04824                                                     <span class="keywordflow">break</span>;
04825                                                 }
04826                                             }
04827                                         }
04828                                         ioResourceDescriptor-&gt;Option = IO_RESOURCE_PREFERRED;
04829                                         ioResourceDescriptor++;
04830                                         <span class="keywordflow">while</span> (ioResourceDescriptor &lt; ioResourceDescriptorEnd) {
04831                                             <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE) {
04832                                                 ioResourceDescriptor-&gt;Type = CmResourceTypeNull;
04833                                                 ioResourceList-&gt;Count--;
04834                                                 ioResourceDescriptor++;
04835                                             } <span class="keywordflow">else</span> {
04836                                                 <span class="keywordflow">break</span>;
04837                                             }
04838                                         }
04839                                         <span class="keywordflow">break</span>;
04840                                     } <span class="keywordflow">else</span> {
04841                                         ioResourceDescriptor++;
04842                                     }
04843                                 }
04844                             } <span class="keywordflow">else</span> {
04845                                 ioResourceDescriptor++;
04846                             }
04847                         } <span class="comment">// Don't add any instruction after this ...</span>
04848                     } <span class="comment">// phase</span>
04849                 } <span class="comment">// switch</span>
04850 
04851                 <span class="comment">//</span>
04852                 <span class="comment">// Move to next Cm Descriptor</span>
04853                 <span class="comment">//</span>
04854 
04855                 cmDescriptor++;
04856                 cmDescriptor = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmDescriptor + size);
04857             }
04858 
04859             <span class="comment">//</span>
04860             <span class="comment">// Move to next Cm List</span>
04861             <span class="comment">//</span>
04862 
04863             cmFullDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)cmDescriptor;
04864         }
04865 
04866         <span class="keywordflow">if</span> (ioResourceList-&gt;Version != (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)cmDescriptorCount) {
04867 
04868             <span class="comment">//</span>
04869             <span class="comment">// If the current alternative list does not cover all the boot config</span>
04870             <span class="comment">// descriptors, make it as invalid.</span>
04871             <span class="comment">//</span>
04872 
04873             ioResourceList-&gt;Version = 0xffff;
04874             ioList-&gt;AlternativeLists--;
04875         } <span class="keywordflow">else</span> {
04876             <span class="keywordflow">if</span> ((ioResourceList-&gt;Count == cmDescriptorCount) ||
04877                 (ioResourceList-&gt;Count == (cmDescriptorCount + 1) &amp;&amp;
04878                  ioResourceList-&gt;Descriptors[0].Type == CmResourceTypeConfigData)) {
04879                 <span class="keywordflow">if</span> (selectedResourceList) {
04880                     ioResourceList-&gt;Version = 0xffff;
04881                     ioList-&gt;AlternativeLists--;
04882                 } <span class="keywordflow">else</span> {
04883                     selectedResourceList = ioResourceList;
04884                     ioResourceDescriptorCount += ioResourceList-&gt;Count;
04885                     ioResourceList-&gt;Version = version;
04886                     <span class="keywordflow">if</span> (exactMatch) {
04887                         *ExactMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04888                     }
04889                 }
04890             } <span class="keywordflow">else</span> {
04891                 ioResourceDescriptorCount += ioResourceList-&gt;Count;
04892                 ioResourceList-&gt;Version = version;
04893             }
04894         }
04895         ioResourceList-&gt;Count = oldCount;
04896 
04897         <span class="comment">//</span>
04898         <span class="comment">// Move to next Io alternative list.</span>
04899         <span class="comment">//</span>
04900 
04901         ioResourceList = (PIO_RESOURCE_LIST) ioResourceDescriptorEnd;
04902     }
04903 
04904     <span class="comment">//</span>
04905     <span class="comment">// If there is not any valid alternative, convert CmList to Io list.</span>
04906     <span class="comment">//</span>
04907 
04908     <span class="keywordflow">if</span> (ioList-&gt;AlternativeLists == 0) {
04909          *FilteredList = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a28">IopCmResourcesToIoResources</a> (0, CmList, LCPRI_BOOTCONFIG);
04910         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ioList);
04911         <span class="keywordflow">return</span> STATUS_SUCCESS;
04912     }
04913 
04914     <span class="comment">//</span>
04915     <span class="comment">// we have finished filtering the resource requirements list.  Now allocate memory</span>
04916     <span class="comment">// and rebuild a new list.</span>
04917     <span class="comment">//</span>
04918 
04919     size = <span class="keyword">sizeof</span>(IO_RESOURCE_REQUIREMENTS_LIST) +
04920                <span class="keyword">sizeof</span>(IO_RESOURCE_LIST) * (ioList-&gt;AlternativeLists - 1) +
04921                <span class="keyword">sizeof</span>(IO_RESOURCE_DESCRIPTOR) * (ioResourceDescriptorCount);
04922     newList = (PIO_RESOURCE_REQUIREMENTS_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, size);
04923     <span class="keywordflow">if</span> (newList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04924         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ioList);
04925         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
04926     }
04927 
04928     <span class="comment">//</span>
04929     <span class="comment">// Walk through the io resource requirements list and pick up any valid descriptor.</span>
04930     <span class="comment">//</span>
04931 
04932     newList-&gt;ListSize = size;
04933     newList-&gt;InterfaceType = CmList-&gt;List-&gt;InterfaceType;
04934     newList-&gt;BusNumber = CmList-&gt;List-&gt;BusNumber;
04935     newList-&gt;SlotNumber = ioList-&gt;SlotNumber;
04936     <span class="keywordflow">if</span> (ioList-&gt;AlternativeLists &gt; 1) {
04937         *ExactMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04938     }
04939     newList-&gt;AlternativeLists = ioList-&gt;AlternativeLists;
04940     ioResourceList = ioList-&gt;List;
04941     newIoResourceList = newList-&gt;List;
04942     <span class="keywordflow">while</span> (--alternativeLists &gt;= 0) {
04943         ioResourceDescriptor = ioResourceList-&gt;Descriptors;
04944         ioResourceDescriptorEnd = ioResourceDescriptor + ioResourceList-&gt;Count;
04945         <span class="keywordflow">if</span> (ioResourceList-&gt;Version == 0xffff) {
04946             ioResourceList = (PIO_RESOURCE_LIST)ioResourceDescriptorEnd;
04947             <span class="keywordflow">continue</span>;
04948         }
04949         newIoResourceList-&gt;Version = ioResourceList-&gt;Version;
04950         newIoResourceList-&gt;Revision = ioResourceList-&gt;Revision;
04951 
04952         newIoResourceDescriptor = newIoResourceList-&gt;Descriptors;
04953         <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Type != CmResourceTypeConfigData) {
04954             newIoResourceDescriptor-&gt;Option = IO_RESOURCE_PREFERRED;
04955             newIoResourceDescriptor-&gt;Type = CmResourceTypeConfigData;
04956             newIoResourceDescriptor-&gt;ShareDisposition = CmResourceShareShared;
04957             newIoResourceDescriptor-&gt;Flags = 0;
04958             newIoResourceDescriptor-&gt;Spare1 = 0;
04959             newIoResourceDescriptor-&gt;Spare2 = 0;
04960             newIoResourceDescriptor-&gt;u.ConfigData.Priority = LCPRI_BOOTCONFIG;
04961             configDataDescriptor = newIoResourceDescriptor;
04962             newIoResourceDescriptor++;
04963         } <span class="keywordflow">else</span> {
04964             newList-&gt;ListSize -= <span class="keyword">sizeof</span>(IO_RESOURCE_DESCRIPTOR);
04965             configDataDescriptor = newIoResourceDescriptor;
04966         }
04967 
04968         <span class="keywordflow">while</span> (ioResourceDescriptor &lt; ioResourceDescriptorEnd) {
04969             <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Type != CmResourceTypeNull) {
04970                 *newIoResourceDescriptor = *ioResourceDescriptor;
04971                 newIoResourceDescriptor++;
04972             }
04973             ioResourceDescriptor++;
04974         }
04975         newIoResourceList-&gt;Count = (ULONG)(newIoResourceDescriptor - newIoResourceList-&gt;Descriptors);
04976 
04977         <span class="comment">//if (newIoResourceList-&gt;Count == (cmDescriptorCount + 1)) {</span>
04978         configDataDescriptor-&gt;u.ConfigData.Priority =  LCPRI_BOOTCONFIG;
04979         <span class="comment">//}</span>
04980 
04981         <span class="comment">//</span>
04982         <span class="comment">// Move to next Io alternative list.</span>
04983         <span class="comment">//</span>
04984 
04985         newIoResourceList = (PIO_RESOURCE_LIST) newIoResourceDescriptor;
04986         ioResourceList = (PIO_RESOURCE_LIST) ioResourceDescriptorEnd;
04987     }
04988     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((PUCHAR)newIoResourceList == ((PUCHAR)newList + newList-&gt;ListSize));
04989 
04990     *FilteredList = newList;
04991     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ioList);
04992     <span class="keywordflow">return</span> STATUS_SUCCESS;
04993 }
04994 
04995 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04996"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a30">04996</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a30">IopMergeFilteredResourceRequirementsList</a> (
04997     IN PIO_RESOURCE_REQUIREMENTS_LIST IoList1,
04998     IN PIO_RESOURCE_REQUIREMENTS_LIST IoList2,
04999     IN OUT PIO_RESOURCE_REQUIREMENTS_LIST *MergedList
05000     )
05001 
05002 <span class="comment">/*++</span>
05003 <span class="comment"></span>
05004 <span class="comment">Routine Description:</span>
05005 <span class="comment"></span>
05006 <span class="comment">    This routines merges two IoLists into one.</span>
05007 <span class="comment"></span>
05008 <span class="comment"></span>
05009 <span class="comment">Arguments:</span>
05010 <span class="comment"></span>
05011 <span class="comment">    IoList1 - supplies the pointer to the first IoResourceRequirementsList</span>
05012 <span class="comment"></span>
05013 <span class="comment">    IoList2 - supplies the pointer to the second IoResourceRequirementsList</span>
05014 <span class="comment"></span>
05015 <span class="comment">    MergedList - Supplies a variable to receive the merged resource</span>
05016 <span class="comment">             requirements list.</span>
05017 <span class="comment"></span>
05018 <span class="comment">Return Value:</span>
05019 <span class="comment"></span>
05020 <span class="comment">    A NTSTATUS code to indicate the result of the function.</span>
05021 <span class="comment"></span>
05022 <span class="comment">--*/</span>
05023 {
05024     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
05025     PIO_RESOURCE_REQUIREMENTS_LIST ioList, newList;
05026     ULONG size;
05027     PUCHAR p;
05028 
05029     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05030 
05031     *MergedList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05032 
05033     <span class="comment">//</span>
05034     <span class="comment">// First handle the easy cases that both IO Lists are empty or any one of</span>
05035     <span class="comment">// them is empty.</span>
05036     <span class="comment">//</span>
05037 
05038     <span class="keywordflow">if</span> ((IoList1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || IoList1-&gt;AlternativeLists == 0) &amp;&amp;
05039         (IoList2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || IoList2-&gt;AlternativeLists == 0)) {
05040         <span class="keywordflow">return</span> status;
05041     }
05042     ioList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05043     <span class="keywordflow">if</span> (IoList1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || IoList1-&gt;AlternativeLists == 0) {
05044         ioList = IoList2;
05045     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IoList2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || IoList2-&gt;AlternativeLists == 0) {
05046         ioList = IoList1;
05047     }
05048     <span class="keywordflow">if</span> (ioList) {
05049         newList = (PIO_RESOURCE_REQUIREMENTS_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, ioList-&gt;ListSize);
05050         <span class="keywordflow">if</span> (newList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05051             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05052         }
05053         RtlMoveMemory(newList, ioList, ioList-&gt;ListSize);
05054         *MergedList = newList;
05055         <span class="keywordflow">return</span> status;
05056     }
05057 
05058     <span class="comment">//</span>
05059     <span class="comment">// Do real work...</span>
05060     <span class="comment">//</span>
05061 
05062     size = IoList1-&gt;ListSize + IoList2-&gt;ListSize - FIELD_OFFSET(IO_RESOURCE_REQUIREMENTS_LIST, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>);
05063     newList = (PIO_RESOURCE_REQUIREMENTS_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
05064                           <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
05065                           size
05066                           );
05067     <span class="keywordflow">if</span> (newList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05068         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05069     }
05070     p = (PUCHAR)newList;
05071     RtlMoveMemory(p, IoList1, IoList1-&gt;ListSize);
05072     p += IoList1-&gt;ListSize;
05073     RtlMoveMemory(p,
05074                   &amp;IoList2-&gt;List[0],
05075                   size - IoList1-&gt;ListSize
05076                   );
05077     newList-&gt;ListSize = size;
05078     newList-&gt;AlternativeLists += IoList2-&gt;AlternativeLists;
05079     *MergedList = newList;
05080     <span class="keywordflow">return</span> status;
05081 
05082 }
05083 
05084 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l05085"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a31">05085</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a31">IopMergeCmResourceLists</a> (
05086     IN PCM_RESOURCE_LIST List1,
05087     IN PCM_RESOURCE_LIST List2,
05088     IN OUT PCM_RESOURCE_LIST *MergedList
05089     )
05090 
05091 <span class="comment">/*++</span>
05092 <span class="comment"></span>
05093 <span class="comment">Routine Description:</span>
05094 <span class="comment"></span>
05095 <span class="comment">    This routines merges two IoLists into one.</span>
05096 <span class="comment"></span>
05097 <span class="comment"></span>
05098 <span class="comment">Arguments:</span>
05099 <span class="comment"></span>
05100 <span class="comment">    IoList1 - supplies the pointer to the first CmResourceList</span>
05101 <span class="comment"></span>
05102 <span class="comment">    IoList2 - supplies the pointer to the second CmResourceList</span>
05103 <span class="comment"></span>
05104 <span class="comment">    MergedList - Supplies a variable to receive the merged resource</span>
05105 <span class="comment">             list.</span>
05106 <span class="comment"></span>
05107 <span class="comment">Return Value:</span>
05108 <span class="comment"></span>
05109 <span class="comment">    A NTSTATUS code to indicate the result of the function.</span>
05110 <span class="comment"></span>
05111 <span class="comment">--*/</span>
05112 {
05113     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
05114     PCM_RESOURCE_LIST cmList, newList;
05115     ULONG size, size1, size2;
05116     PUCHAR p;
05117 
05118     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05119 
05120     *MergedList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05121 
05122     <span class="comment">//</span>
05123     <span class="comment">// First handle the easy cases that both IO Lists are empty or any one of</span>
05124     <span class="comment">// them is empty.</span>
05125     <span class="comment">//</span>
05126 
05127     <span class="keywordflow">if</span> ((List1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || List1-&gt;Count == 0) &amp;&amp;
05128         (List2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || List2-&gt;Count == 0)) {
05129         <span class="keywordflow">return</span> status;
05130     }
05131 
05132     cmList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05133     <span class="keywordflow">if</span> (List1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || List1-&gt;Count == 0) {
05134         cmList = List2;
05135     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (List2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || List2-&gt;Count == 0) {
05136         cmList = List1;
05137     }
05138     <span class="keywordflow">if</span> (cmList) {
05139         size =  <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(cmList);
05140         newList = (PCM_RESOURCE_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, size);
05141         <span class="keywordflow">if</span> (newList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05142             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05143         }
05144         RtlMoveMemory(newList, cmList, size);
05145         *MergedList = newList;
05146         <span class="keywordflow">return</span> status;
05147     }
05148 
05149     <span class="comment">//</span>
05150     <span class="comment">// Do real work...</span>
05151     <span class="comment">//</span>
05152 
05153     size1 =  <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(List1);
05154     size2 =  <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(List2);
05155     size = size1 + size2;
05156     newList = (PCM_RESOURCE_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
05157                           <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
05158                           size
05159                           );
05160     <span class="keywordflow">if</span> (newList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05161         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05162     }
05163     p = (PUCHAR)newList;
05164     RtlMoveMemory(p, List1, size1);
05165     p += size1;
05166     RtlMoveMemory(p,
05167                   &amp;List2-&gt;List[0],
05168                   size2 - FIELD_OFFSET(CM_RESOURCE_LIST, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>)
05169                   );
05170     newList-&gt;Count = List1-&gt;Count + List2-&gt;Count;
05171     *MergedList = newList;
05172     <span class="keywordflow">return</span> status;
05173 
05174 }
05175 
05176 BOOLEAN
<a name="l05177"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a32">05177</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a32">IopIsLegacyDriver</a> (
05178     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject
05179     )
05180 
05181 <span class="comment">/*++</span>
05182 <span class="comment"></span>
05183 <span class="comment">Routine Description:</span>
05184 <span class="comment"></span>
05185 <span class="comment">    This routine checks if the driver object specifies a legacy driver.</span>
05186 <span class="comment"></span>
05187 <span class="comment">Arguments:</span>
05188 <span class="comment"></span>
05189 <span class="comment">    DriverObject - supplies a pointer to the driver object to be checked.</span>
05190 <span class="comment"></span>
05191 <span class="comment">Return Value:</span>
05192 <span class="comment"></span>
05193 <span class="comment">    BOOLEAN</span>
05194 <span class="comment"></span>
05195 <span class="comment">--*/</span>
05196 
05197 {
05198 
05199     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05200 
05201     <span class="comment">//</span>
05202     <span class="comment">// If AddDevice entry is not empty it is a wdm driver</span>
05203     <span class="comment">//</span>
05204 
05205     <span class="keywordflow">if</span> (DriverObject-&gt;DriverExtension-&gt;AddDevice) {
05206         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05207     }
05208 
05209     <span class="comment">//</span>
05210     <span class="comment">// Else if LEGACY flag is set in the driver object, it's a legacy driver.</span>
05211     <span class="comment">//</span>
05212 
05213     <span class="keywordflow">if</span> (DriverObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a144">DRVO_LEGACY_DRIVER</a>) {
05214         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05215     } <span class="keywordflow">else</span> {
05216         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05217     }
05218 }
05219 
05220 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>
<a name="l05221"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a33">05221</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a33">IopGetGroupOrderIndex</a> (
05222     IN HANDLE ServiceHandle
05223     )
05224 
05225 <span class="comment">/*++</span>
05226 <span class="comment"></span>
05227 <span class="comment">Routine Description:</span>
05228 <span class="comment"></span>
05229 <span class="comment">    This routine reads the Group value of the service key, finds its position in the</span>
05230 <span class="comment">    ServiceOrderList.  If ServiceHandle is NULL or unrecognized group value, it returns</span>
05231 <span class="comment">    a value with max group order + 1.</span>
05232 <span class="comment">    if any.</span>
05233 <span class="comment"></span>
05234 <span class="comment">Parameters:</span>
05235 <span class="comment"></span>
05236 <span class="comment">    ServiceHandle - supplies a handle to the service key.</span>
05237 <span class="comment"></span>
05238 <span class="comment">Return Value:</span>
05239 <span class="comment"></span>
05240 <span class="comment">    group order index.</span>
05241 <span class="comment"></span>
05242 <span class="comment">--*/</span>
05243 
05244 {
05245     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05246     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
05247     UNICODE_STRING *groupTable, group;
05248     HANDLE handle;
05249     ULONG count, index;
05250 
05251     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05252 
05253     <span class="comment">//</span>
05254     <span class="comment">// Open System\CurrentControlSet\Control\ServiceOrderList</span>
05255     <span class="comment">//</span>
05256 
05257     PiWstrToUnicodeString(&amp;group, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\ServiceGroupOrder"</span>);
05258     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle,
05259                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
05260                                 &amp;group,
05261                                 KEY_READ,
05262                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
05263                                 );
05264 
05265     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
05266         <span class="keywordflow">return</span> <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>;
05267     }
05268 
05269     <span class="comment">//</span>
05270     <span class="comment">// Read and build a unicode string array containing all the group names.</span>
05271     <span class="comment">//</span>
05272 
05273     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (handle,
05274                                   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"List"</span>,
05275                                   &amp;keyValueInformation);
05276     ZwClose(handle);
05277     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05278 
05279         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_MULTI_SZ) &amp;&amp;
05280             (keyValueInformation-&gt;DataLength != 0)) {
05281              status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a13">IopRegMultiSzToUnicodeStrings</a>(keyValueInformation, &amp;groupTable, &amp;count);
05282              <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05283                  <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
05284                  <span class="keywordflow">return</span> <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>;
05285              }
05286         }
05287         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
05288     }
05289 
05290     <span class="keywordflow">if</span> (ServiceHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05291         <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a17">IopFreeUnicodeStringList</a>(groupTable, count);
05292         <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(count + 1);
05293     }
05294 
05295 
05296     <span class="comment">//</span>
05297     <span class="comment">// Read service key's Group value</span>
05298     <span class="comment">//</span>
05299 
05300     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (ServiceHandle,
05301                                   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Group"</span>,
05302                                   &amp;keyValueInformation);
05303     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05304 
05305         <span class="comment">//</span>
05306         <span class="comment">// Try to read what caller wants.</span>
05307         <span class="comment">//</span>
05308 
05309         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_SZ) &amp;&amp;
05310             (keyValueInformation-&gt;DataLength != 0)) {
05311             <a class="code" href="../../d9/d0/pnpiop_8h.html#a82">IopRegistryDataToUnicodeString</a>(&amp;group,
05312                                            (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
05313                                            keyValueInformation-&gt;DataLength
05314                                            );
05315         }
05316     } <span class="keywordflow">else</span> {
05317 
05318         <span class="comment">//</span>
05319         <span class="comment">// If we failed to read the Group value, or no Group value...</span>
05320         <span class="comment">//</span>
05321 
05322         <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a17">IopFreeUnicodeStringList</a>(groupTable, count);
05323         <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)count;
05324     }
05325 
05326     index = 0;
05327     <span class="keywordflow">for</span> (index = 0; index &lt; count; index++) {
05328         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(&amp;group, &amp;groupTable[index], <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
05329             <span class="keywordflow">break</span>;
05330         }
05331     }
05332     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
05333     <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a17">IopFreeUnicodeStringList</a>(groupTable, count);
05334     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)index;
05335 }
05336 
05337 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l05338"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a34">05338</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a34">IopDeleteLegacyKey</a>(
05339     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject
05340     )
05341 
05342 <span class="comment">/*++</span>
05343 <span class="comment"></span>
05344 <span class="comment">Routine Description:</span>
05345 <span class="comment"></span>
05346 <span class="comment">    This routine checks if the Legacy= value of the driver's legacy_xxx key</span>
05347 <span class="comment">    is one.  If yes, it deletes the Legacy key.</span>
05348 <span class="comment"></span>
05349 <span class="comment">Parameters:</span>
05350 <span class="comment"></span>
05351 <span class="comment">    DriverObject - supplies a pointer to the driver object.</span>
05352 <span class="comment"></span>
05353 <span class="comment">Return Value:</span>
05354 <span class="comment"></span>
05355 <span class="comment">    None.  If anything fails in this routine, the legacy key stays.</span>
05356 <span class="comment"></span>
05357 <span class="comment">--*/</span>
05358 
05359 {
05360     WCHAR buffer[100];
05361     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05362     UNICODE_STRING deviceName, instanceName, unicodeName, *serviceName;
05363     ULONG length;
05364     HANDLE handle, handle1, handlex, enumHandle;
05365     ULONG legacy;
05366     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
05367     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
05368     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
05369 
05370     serviceName = &amp;DriverObject-&gt;DriverExtension-&gt;ServiceKeyName;
05371 
05372     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
05373     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
05374 
05375     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;enumHandle,
05376                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
05377                                 &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a23">CmRegistryMachineSystemCurrentControlSetEnumName</a>,
05378                                 KEY_ALL_ACCESS,
05379                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
05380                                 );
05381 
05382     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05383         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
05384     }
05385 
05386     length = _snwprintf(buffer, <span class="keyword">sizeof</span>(buffer) / <span class="keyword">sizeof</span>(WCHAR), <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ROOT\\LEGACY_%s"</span>, serviceName-&gt;Buffer);
05387     deviceName.MaximumLength = <span class="keyword">sizeof</span>(buffer);
05388     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(length &lt;= <span class="keyword">sizeof</span>(buffer) - 10);
05389     deviceName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(length * <span class="keyword">sizeof</span>(WCHAR));
05390     deviceName.Buffer = buffer;
05391 
05392     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handle1,
05393                                 enumHandle,
05394                                 &amp;deviceName,
05395                                 KEY_ALL_ACCESS,
05396                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
05397                                 );
05398 
05399     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05400 
05401         deviceName.Buffer[deviceName.Length / <span class="keyword">sizeof</span>(WCHAR)] =
05402                    OBJ_NAME_PATH_SEPARATOR;
05403         deviceName.Length += <span class="keyword">sizeof</span>(WCHAR);
05404         PiUlongToInstanceKeyUnicodeString(
05405                                 &amp;instanceName,
05406                                 buffer + deviceName.Length / <span class="keyword">sizeof</span>(WCHAR),
05407                                 <span class="keyword">sizeof</span>(buffer) - deviceName.Length,
05408                                 0
05409                                 );
05410         deviceName.Length += instanceName.Length;
05411 
05412 
05413         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(
05414                                 &amp;handle,
05415                                 handle1,
05416                                 &amp;instanceName,
05417                                 KEY_ALL_ACCESS,
05418                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
05419                                 );
05420         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05421             legacy = 1;
05422             status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (handle,
05423                                           REGSTR_VALUE_LEGACY,
05424                                           &amp;keyValueInformation);
05425             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05426                 <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
05427                     (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
05428                     legacy = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
05429                 }
05430                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
05431             }
05432             <span class="keywordflow">if</span> (legacy != 0) {
05433 
05434                 <span class="comment">//</span>
05435                 <span class="comment">// We also want to delete the madeup device node</span>
05436                 <span class="comment">//</span>
05437 
05438                 deviceObject = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">IopDeviceObjectFromDeviceInstance</a>(handle, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05439                 <span class="keywordflow">if</span> (deviceObject) {
05440 
05441                     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> devNodex, devNodey;
05442 
05443                     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
05444                     <span class="keywordflow">if</span> (deviceNode) {
05445                         <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>) {
05446 
05447                             <span class="comment">//</span>
05448                             <span class="comment">// Now mark this one deleted.</span>
05449                             <span class="comment">//</span>
05450                             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>;
05451                             <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_DEVICE_NOT_THERE);
05452 
05453                             <span class="comment">//</span>
05454                             <span class="comment">// This is actually doing nothing because DeviceNode-&gt;ResourceList is NULL.</span>
05455                             <span class="comment">//</span>
05456 
05457                             <a class="code" href="../../d9/d0/pnpiop_8h.html#a279">IopReleaseDeviceResources</a>(deviceNode);
05458                             devNodex = deviceNode;
05459                             <span class="keywordflow">while</span> (devNodex) {
05460                                 devNodey = devNodex;
05461                                 devNodex = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)devNodey-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o34">OverUsed2</a>.NextResourceDeviceNode;
05462                                 devNodey-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o34">OverUsed2</a>.NextResourceDeviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05463                                 devNodey-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o32">OverUsed1</a>.LegacyDeviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05464                             }
05465 
05466                             deviceNode-&gt;Flags &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>;  <span class="comment">// remove its boot config if any</span>
05467                             <a class="code" href="../../d4/d6/iosubs_8c.html#a55">IoDeleteDevice</a>(deviceObject);
05468                         }
05469                     }
05470                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceObject);  <span class="comment">// added via IopDeviceObjectFromDeviceInstance</span>
05471                 }
05472 
05473                 PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_CONTROL);
05474                 status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handlex,
05475                                             handle,
05476                                             &amp;unicodeName,
05477                                             KEY_ALL_ACCESS,
05478                                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
05479                                             );
05480                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05481                     ZwDeleteKey(handlex);
05482                 }
05483                 PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_LOG_CONF);
05484                 status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>(&amp;handlex,
05485                                             handle,
05486                                             &amp;unicodeName,
05487                                             KEY_ALL_ACCESS,
05488                                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
05489                                             );
05490                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05491                     ZwDeleteKey(handlex);
05492                 }
05493 
05494                 ZwClose(enumHandle);
05495 
05496                 <span class="comment">//</span>
05497                 <span class="comment">// We need to call IopCleanupDeviceRegistryValue even we are going to</span>
05498                 <span class="comment">// delete it.  Because, it also cleans up related value names in other</span>
05499                 <span class="comment">// keys.</span>
05500                 <span class="comment">//</span>
05501 
05502                 <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a25">IopCleanupDeviceRegistryValues</a>(&amp;deviceName, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05503                 ZwDeleteKey(handle);
05504                 ZwDeleteKey(handle1);
05505             } <span class="keywordflow">else</span> {
05506                 ZwClose(handle);
05507                 ZwClose(handle1);
05508                 ZwClose(enumHandle);
05509             }
05510         } <span class="keywordflow">else</span> {
05511             ZwClose(handle1);
05512             ZwClose(enumHandle);
05513         }
05514     } <span class="keywordflow">else</span> {
05515         ZwClose(enumHandle);
05516     }
05517 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
05518     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
05519     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
05520     <span class="keywordflow">return</span>;
05521 }
05522 
05523 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l05524"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a35">05524</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a35">IopDeviceCapabilitiesToRegistry</a> (
05525     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject
05526     )
05527 
05528 <span class="comment">/*++</span>
05529 <span class="comment"></span>
05530 <span class="comment">Routine Description:</span>
05531 <span class="comment"></span>
05532 <span class="comment">    This routine queries and updates device capabilities after device received a start irp.</span>
05533 <span class="comment"></span>
05534 <span class="comment">Arguments:</span>
05535 <span class="comment"></span>
05536 <span class="comment">    DeviceObject - supplies a pointer to a device object whose registry</span>
05537 <span class="comment">        values are to be updated.</span>
05538 <span class="comment"></span>
05539 <span class="comment">Return Value:</span>
05540 <span class="comment"></span>
05541 <span class="comment">    status</span>
05542 <span class="comment"></span>
05543 <span class="comment">--*/</span>
05544 
05545 {
05546     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
05547     HANDLE handle;
05548     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05549     UNICODE_STRING unicodeName;
05550     ULONG tmpValue;
05551     <a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">DEVICE_CAPABILITIES</a> capabilities;
05552 
05553     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05554 
05555     <span class="comment">//</span>
05556     <span class="comment">// Open the device instance key</span>
05557     <span class="comment">//</span>
05558 
05559     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a24">IopDeviceObjectToDeviceInstance</a>(DeviceObject, &amp;handle, KEY_ALL_ACCESS);
05560     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05561         <span class="keywordflow">return</span> status;
05562     }
05563 
05564     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a330">IopQueryDeviceCapabilities</a>(deviceNode, &amp;capabilities);
05565     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05566         <span class="keywordflow">return</span> status;
05567     }
05568 
05569     <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a>) {
05570         capabilities.<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o11">SurpriseRemovalOK</a> = 0;
05571     }
05572 
05573     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_CAPABILITIES);
05574     tmpValue = (capabilities.<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o4">LockSupported</a>)          |
05575                (capabilities.<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o5">EjectSupported</a>    &lt;&lt; 1) |
05576                (capabilities.<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o6">Removable</a>         &lt;&lt; 2) |
05577                (capabilities.<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o7">DockDevice</a>        &lt;&lt; 3) |
05578                (capabilities.<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o8">UniqueID</a>          &lt;&lt; 4) |
05579                (capabilities.<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o9">SilentInstall</a>     &lt;&lt; 5) |
05580                (capabilities.<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o10">RawDeviceOK</a>       &lt;&lt; 6) |
05581                (capabilities.<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o11">SurpriseRemovalOK</a> &lt;&lt; 7);
05582 
05583     status = ZwSetValueKey(
05584                   handle,
05585                   &amp;unicodeName,
05586                   <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
05587                   REG_DWORD,
05588                   &amp;tmpValue,
05589                   <span class="keyword">sizeof</span>(tmpValue)
05590                   );
05591 
05592     ZwClose(handle);
05593     <span class="keywordflow">return</span> status;
05594 }
05595 
05596 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l05597"></a><a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a36">05597</a> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a36">IopRestartDeviceNode</a>(
05598     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode
05599     )
05600 {
05601     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05602 
05603     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(<a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(DeviceNode) ||
05604             (DeviceNode-&gt;Flags &amp; (<a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a> |
05605                                  <a class="code" href="../../d9/d0/pnpiop_8h.html#a11">DNF_ADDED</a> |
05606                                  <a class="code" href="../../d9/d0/pnpiop_8h.html#a18">DNF_RESOURCE_ASSIGNED</a> |
05607                                  <a class="code" href="../../d9/d0/pnpiop_8h.html#a19">DNF_RESOURCE_REPORTED</a>)) ||
05608             (DeviceNode-&gt;UserFlags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a37">DNUF_WILL_BE_REMOVED</a>)));
05609 
05610     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a9">DNF_ENUMERATED</a>);
05611 
05612     <span class="keywordflow">if</span> (!(DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a9">DNF_ENUMERATED</a>)) {
05613         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
05614     }
05615 
05616     DeviceNode-&gt;UserFlags &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a39">DNUF_NEED_RESTART</a>;
05617 
05618 <span class="preprocessor">#if DBG_SCOPE</span>
05619 <span class="preprocessor"></span>    DeviceNode-&gt;FailureStatus = 0;
05620     <span class="keywordflow">if</span> (DeviceNode-&gt;PreviousResourceList) {
05621         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;PreviousResourceList);
05622         DeviceNode-&gt;PreviousResourceList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05623     }
05624     <span class="keywordflow">if</span> (DeviceNode-&gt;PreviousResourceRequirements) {
05625         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;PreviousResourceRequirements);
05626         DeviceNode-&gt;PreviousResourceRequirements = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05627     }
05628 <span class="preprocessor">#endif</span>
05629 <span class="preprocessor"></span>
05630     <span class="comment">//</span>
05631     <span class="comment">// Free any existing devnode strings so we can recreate them</span>
05632     <span class="comment">// during enumeration.</span>
05633     <span class="comment">//</span>
05634 
05635     <span class="keywordflow">if</span> (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a8">DNF_PROCESSED</a>) {
05636 
05637         DeviceNode-&gt;Flags &amp;= ~(<a class="code" href="../../d9/d0/pnpiop_8h.html#a8">DNF_PROCESSED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a28">DNF_ENUMERATION_REQUEST_QUEUED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a20">DNF_RESOURCE_REQUIREMENTS_CHANGED</a>);
05638 
05639         <span class="keywordflow">if</span> (DeviceNode-&gt;ServiceName.Length != 0) {
05640             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;ServiceName.Buffer);
05641             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;DeviceNode-&gt;ServiceName, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05642         }
05643 
05644         <span class="keywordflow">if</span> (DeviceNode-&gt;InstanceOrdinal.Length != 0) {
05645             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;InstanceOrdinal.Buffer);
05646             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;DeviceNode-&gt;InstanceOrdinal, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05647         }
05648 
05649         <span class="keywordflow">if</span> (DeviceNode-&gt;ResourceRequirements != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05650             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;ResourceRequirements);
05651             DeviceNode-&gt;ResourceRequirements = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05652             DeviceNode-&gt;Flags &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a16">DNF_RESOURCE_REQUIREMENTS_NEED_FILTERED</a>;
05653         }
05654     }
05655 
05656     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode-&gt;ServiceName.Length == 0 &amp;&amp;
05657            DeviceNode-&gt;ServiceName.MaximumLength == 0 &amp;&amp;
05658            DeviceNode-&gt;ServiceName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05659 
05660     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode-&gt;InstanceOrdinal.Length == 0 &amp;&amp;
05661            DeviceNode-&gt;InstanceOrdinal.MaximumLength == 0 &amp;&amp;
05662            DeviceNode-&gt;InstanceOrdinal.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05663 
05664     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(DeviceNode-&gt;Flags &amp;
05665            ~(<a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a9">DNF_ENUMERATED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a> |
05666              <a class="code" href="../../d9/d0/pnpiop_8h.html#a13">DNF_BOOT_CONFIG_RESERVED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a15">DNF_NO_RESOURCE_REQUIRED</a>)));
05667 
05668     <span class="keywordflow">return</span> STATUS_SUCCESS;
05669 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:24 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
