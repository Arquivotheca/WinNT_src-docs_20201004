<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: mmsup.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>mmsup.c</h1><a href="../../d0/d2/mmsup_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">   mmsup.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the various routines for miscellaneous support</span>
00012 <span class="comment">    operations for memory management.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Lou Perazzoli (loup) 31-Aug-1989</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Landy Wang (landyw) 08-April-1998 : Modifications for 3-level 64-bit NT.</span>
00021 <span class="comment"></span>
00022 <span class="comment">--*/</span>
00023 
00024 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00025 
00026 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, MmHibernateInformation)</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00029 <span class="preprocessor"></span>
00030 <span class="preprocessor">#if _WIN64</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#if DBGXX</span>
00032 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00033 MiCheckPageTableTrim(
00034     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte
00035 );
00036 <span class="preprocessor">#endif</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00038 <span class="preprocessor"></span>
00039 
00040 ULONG
00041 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00042"></a><a class="code" href="../../d0/d2/mmsup_8c.html#a3">00042</a> <a class="code" href="../../d0/d2/mmsup_8c.html#a3">MiIsPteDecommittedPage</a> (
00043     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte
00044     )
00045 
00046 <span class="comment">/*++</span>
00047 <span class="comment"></span>
00048 <span class="comment">Routine Description:</span>
00049 <span class="comment"></span>
00050 <span class="comment">    This function checks the contents of a PTE to determine if the</span>
00051 <span class="comment">    PTE is explicitly decommitted.</span>
00052 <span class="comment"></span>
00053 <span class="comment">    If the PTE is a prototype PTE and the protection is not in the</span>
00054 <span class="comment">    prototype PTE, the value FALSE is returned.</span>
00055 <span class="comment"></span>
00056 <span class="comment">Arguments:</span>
00057 <span class="comment"></span>
00058 <span class="comment">    PointerPte - Supplies a pointer to the PTE to examine.</span>
00059 <span class="comment"></span>
00060 <span class="comment">Return Value:</span>
00061 <span class="comment"></span>
00062 <span class="comment">    TRUE if the PTE is in the explicit decommitted state.</span>
00063 <span class="comment">    FALSE if the PTE is not in the explicit decommitted state.</span>
00064 <span class="comment"></span>
00065 <span class="comment">Environment:</span>
00066 <span class="comment"></span>
00067 <span class="comment">    Kernel mode, APCs disabled, WorkingSetLock held.</span>
00068 <span class="comment"></span>
00069 <span class="comment">--*/</span>
00070 
00071 {
00072     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
00073 
00074     PteContents = *PointerPte;
00075 
00076     <span class="comment">//</span>
00077     <span class="comment">// If the protection in the PTE is not decommitted, return false.</span>
00078     <span class="comment">//</span>
00079 
00080     <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection != <a class="code" href="../../d4/d8/mi_8h.html#a45">MM_DECOMMIT</a>) {
00081         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00082     }
00083 
00084     <span class="comment">//</span>
00085     <span class="comment">// Check to make sure the protection field is really being interpreted</span>
00086     <span class="comment">// correctly.</span>
00087     <span class="comment">//</span>
00088 
00089     <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
00090 
00091         <span class="comment">//</span>
00092         <span class="comment">// The PTE is valid and therefore cannot be decommitted.</span>
00093         <span class="comment">//</span>
00094 
00095         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00096     }
00097 
00098     <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1) &amp;&amp;
00099          (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a181">MI_PTE_LOOKUP_NEEDED</a>)) {
00100 
00101         <span class="comment">//</span>
00102         <span class="comment">// The PTE's protection is not known as it is in</span>
00103         <span class="comment">// prototype PTE format.  Return FALSE.</span>
00104         <span class="comment">//</span>
00105 
00106         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00107     }
00108 
00109     <span class="comment">//</span>
00110     <span class="comment">// It is a decommitted PTE.</span>
00111     <span class="comment">//</span>
00112 
00113     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00114 }
00115 
00116 <span class="comment">//</span>
00117 <span class="comment">// Data for is protection compatible.</span>
00118 <span class="comment">//</span>
00119 
<a name="l00120"></a><a class="code" href="../../d0/d2/mmsup_8c.html#a0">00120</a> ULONG <a class="code" href="../../d0/d2/mmsup_8c.html#a0">MmCompatibleProtectionMask</a>[8] = {
00121             PAGE_NOACCESS,
00122             PAGE_NOACCESS | PAGE_READONLY | PAGE_WRITECOPY,
00123             PAGE_NOACCESS | PAGE_EXECUTE,
00124             PAGE_NOACCESS | PAGE_READONLY | PAGE_WRITECOPY | PAGE_EXECUTE |
00125                 PAGE_EXECUTE_READ,
00126             PAGE_NOACCESS | PAGE_READONLY | PAGE_WRITECOPY | PAGE_READWRITE,
00127             PAGE_NOACCESS | PAGE_READONLY | PAGE_WRITECOPY,
00128             PAGE_NOACCESS | PAGE_READONLY | PAGE_WRITECOPY | PAGE_READWRITE |
00129                 PAGE_EXECUTE | PAGE_EXECUTE_READ | PAGE_EXECUTE_READWRITE |
00130                 PAGE_EXECUTE_WRITECOPY,
00131             PAGE_NOACCESS | PAGE_READONLY | PAGE_WRITECOPY | PAGE_EXECUTE |
00132                 PAGE_EXECUTE_READ | PAGE_EXECUTE_WRITECOPY
00133             };
00134 
00135 
00136 
00137 ULONG
00138 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00139"></a><a class="code" href="../../d0/d2/mmsup_8c.html#a4">00139</a> <a class="code" href="../../d0/d2/mmsup_8c.html#a4">MiIsProtectionCompatible</a> (
00140     IN ULONG OldProtect,
00141     IN ULONG NewProtect
00142     )
00143 
00144 <span class="comment">/*++</span>
00145 <span class="comment"></span>
00146 <span class="comment">Routine Description:</span>
00147 <span class="comment"></span>
00148 <span class="comment">    This function takes two user supplied page protections and checks</span>
00149 <span class="comment">    to see if the new protection is compatible with the old protection.</span>
00150 <span class="comment"></span>
00151 <span class="comment">   protection        compatible protections</span>
00152 <span class="comment">    NoAccess          NoAccess</span>
00153 <span class="comment">    ReadOnly          NoAccess, ReadOnly, ReadWriteCopy</span>
00154 <span class="comment">    ReadWriteCopy     NoAccess, ReadOnly, ReadWriteCopy</span>
00155 <span class="comment">    ReadWrite         NoAccess, ReadOnly, ReadWriteCopy, ReadWrite</span>
00156 <span class="comment">    Execute           NoAccess, Execute</span>
00157 <span class="comment">    ExecuteRead       NoAccess, ReadOnly, ReadWriteCopy, Execute, ExecuteRead,</span>
00158 <span class="comment">                        ExecuteWriteCopy</span>
00159 <span class="comment">    ExecuteWrite      NoAccess, ReadOnly, ReadWriteCopy, Execute, ExecuteRead,</span>
00160 <span class="comment">                        ExecuteWriteCopy, ReadWrite, ExecuteWrite</span>
00161 <span class="comment">    ExecuteWriteCopy  NoAccess, ReadOnly, ReadWriteCopy, Execute, ExecuteRead,</span>
00162 <span class="comment">                        ExecuteWriteCopy</span>
00163 <span class="comment"></span>
00164 <span class="comment">Arguments:</span>
00165 <span class="comment"></span>
00166 <span class="comment">    OldProtect - Supplies the protection to be compatible with.</span>
00167 <span class="comment"></span>
00168 <span class="comment">    NewProtect - Supplies the protection to check out.</span>
00169 <span class="comment"></span>
00170 <span class="comment"></span>
00171 <span class="comment">Return Value:</span>
00172 <span class="comment"></span>
00173 <span class="comment">    Returns TRUE if the protection is compatible, FALSE if not.</span>
00174 <span class="comment"></span>
00175 <span class="comment">Environment:</span>
00176 <span class="comment"></span>
00177 <span class="comment">    Kernel Mode.</span>
00178 <span class="comment"></span>
00179 <span class="comment">--*/</span>
00180 
00181 {
00182     ULONG Mask;
00183     ULONG ProtectMask;
00184 
00185     <span class="keywordflow">try</span> {
00186         Mask = <a class="code" href="../../d0/d2/mmsup_8c.html#a5">MiMakeProtectionMask</a> (OldProtect) &amp; 0x7;
00187     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00188         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00189     }
00190 
00191     ProtectMask = <a class="code" href="../../d0/d2/mmsup_8c.html#a0">MmCompatibleProtectionMask</a>[Mask] | PAGE_GUARD | PAGE_NOCACHE;
00192 
00193     <span class="keywordflow">if</span> ((ProtectMask | NewProtect) != ProtectMask) {
00194         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00195     }
00196     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00197 }
00198 
00199 
00200 <span class="comment">//</span>
00201 <span class="comment">// Protection data for MiMakeProtectionMask</span>
00202 <span class="comment">//</span>
00203 
<a name="l00204"></a><a class="code" href="../../d0/d2/mmsup_8c.html#a1">00204</a> CCHAR <a class="code" href="../../d0/d2/mmsup_8c.html#a1">MmUserProtectionToMask1</a>[16] = {
00205                                  0,
00206                                  <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>,
00207                                  <a class="code" href="../../d4/d8/mi_8h.html#a36">MM_READONLY</a>,
00208                                  -1,
00209                                  <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a>,
00210                                  -1,
00211                                  -1,
00212                                  -1,
00213                                  <a class="code" href="../../d4/d8/mi_8h.html#a40">MM_WRITECOPY</a>,
00214                                  -1,
00215                                  -1,
00216                                  -1,
00217                                  -1,
00218                                  -1,
00219                                  -1,
00220                                  -1 };
00221 
<a name="l00222"></a><a class="code" href="../../d0/d2/mmsup_8c.html#a2">00222</a> CCHAR <a class="code" href="../../d0/d2/mmsup_8c.html#a2">MmUserProtectionToMask2</a>[16] = {
00223                                  0,
00224                                  <a class="code" href="../../d4/d8/mi_8h.html#a37">MM_EXECUTE</a>,
00225                                  <a class="code" href="../../d4/d8/mi_8h.html#a38">MM_EXECUTE_READ</a>,
00226                                  -1,
00227                                  <a class="code" href="../../d4/d8/mi_8h.html#a41">MM_EXECUTE_READWRITE</a>,
00228                                  -1,
00229                                  -1,
00230                                  -1,
00231                                  <a class="code" href="../../d4/d8/mi_8h.html#a42">MM_EXECUTE_WRITECOPY</a>,
00232                                  -1,
00233                                  -1,
00234                                  -1,
00235                                  -1,
00236                                  -1,
00237                                  -1,
00238                                  -1 };
00239 
00240 
00241 ULONG
00242 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00243"></a><a class="code" href="../../d0/d2/mmsup_8c.html#a5">00243</a> <a class="code" href="../../d0/d2/mmsup_8c.html#a5">MiMakeProtectionMask</a> (
00244     IN ULONG Protect
00245     )
00246 
00247 <span class="comment">/*++</span>
00248 <span class="comment"></span>
00249 <span class="comment">Routine Description:</span>
00250 <span class="comment"></span>
00251 <span class="comment">    This function takes a user supplied protection and converts it</span>
00252 <span class="comment">    into a 5-bit protection code for the PTE.</span>
00253 <span class="comment"></span>
00254 <span class="comment">Arguments:</span>
00255 <span class="comment"></span>
00256 <span class="comment">    Protect - Supplies the protection.</span>
00257 <span class="comment"></span>
00258 <span class="comment"></span>
00259 <span class="comment">Return Value:</span>
00260 <span class="comment"></span>
00261 <span class="comment">    Returns the protection code for use in the PTE.</span>
00262 <span class="comment">    An exception is raised if the user supplied protection is invalid.</span>
00263 <span class="comment"></span>
00264 <span class="comment">Environment:</span>
00265 <span class="comment"></span>
00266 <span class="comment">    Kernel Mode.</span>
00267 <span class="comment"></span>
00268 <span class="comment">--*/</span>
00269 
00270 {
00271     ULONG Field1;
00272     ULONG Field2;
00273     ULONG ProtectCode;
00274 
00275     <span class="keywordflow">if</span> (Protect &gt;= (PAGE_NOCACHE * 2)) {
00276         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INVALID_PAGE_PROTECTION);
00277     }
00278 
00279     Field1 = Protect &amp; 0xF;
00280     Field2 = (Protect &gt;&gt; 4) &amp; 0xF;
00281 
00282     <span class="comment">//</span>
00283     <span class="comment">// Make sure at least one field is set.</span>
00284     <span class="comment">//</span>
00285 
00286     <span class="keywordflow">if</span> (Field1 == 0) {
00287         <span class="keywordflow">if</span> (Field2 == 0) {
00288 
00289             <span class="comment">//</span>
00290             <span class="comment">// Both fields are zero, raise exception.</span>
00291             <span class="comment">//</span>
00292 
00293             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INVALID_PAGE_PROTECTION);
00294             <span class="keywordflow">return</span> 0;
00295         }
00296         ProtectCode = <a class="code" href="../../d0/d2/mmsup_8c.html#a2">MmUserProtectionToMask2</a>[Field2];
00297     } <span class="keywordflow">else</span> {
00298         <span class="keywordflow">if</span> (Field2 != 0) {
00299             <span class="comment">//</span>
00300             <span class="comment">//  Both fields are non-zero, raise exception.</span>
00301             <span class="comment">//</span>
00302 
00303             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INVALID_PAGE_PROTECTION);
00304             <span class="keywordflow">return</span> 0;
00305         }
00306         ProtectCode = <a class="code" href="../../d0/d2/mmsup_8c.html#a1">MmUserProtectionToMask1</a>[Field1];
00307     }
00308 
00309     <span class="keywordflow">if</span> (ProtectCode == -1) {
00310         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INVALID_PAGE_PROTECTION);
00311     }
00312 
00313     <span class="keywordflow">if</span> (Protect &amp; PAGE_GUARD) {
00314         <span class="keywordflow">if</span> (ProtectCode == <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>) {
00315 
00316             <span class="comment">//</span>
00317             <span class="comment">// Invalid protection, no access and no_cache.</span>
00318             <span class="comment">//</span>
00319 
00320             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INVALID_PAGE_PROTECTION);
00321         }
00322 
00323         ProtectCode |= <a class="code" href="../../d4/d8/mi_8h.html#a44">MM_GUARD_PAGE</a>;
00324     }
00325 
00326     <span class="keywordflow">if</span> (Protect &amp; PAGE_NOCACHE) {
00327 
00328         <span class="keywordflow">if</span> (ProtectCode == <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>) {
00329 
00330             <span class="comment">//</span>
00331             <span class="comment">// Invalid protection, no access and no cache.</span>
00332             <span class="comment">//</span>
00333 
00334             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INVALID_PAGE_PROTECTION);
00335         }
00336 
00337         ProtectCode |= <a class="code" href="../../d4/d8/mi_8h.html#a43">MM_NOCACHE</a>;
00338     }
00339 
00340     <span class="keywordflow">return</span> ProtectCode;
00341 }
00342 
00343 <span class="preprocessor">#if defined (_WIN64)</span>
00344 <span class="preprocessor"></span>
00345 LOGICAL
00346 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (
00347     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe,
00348     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess,
00349     IN ULONG PfnMutexHeld,
00350     OUT PULONG Waited
00351     )
00352 
00353 <span class="comment">/*++</span>
00354 <span class="comment"></span>
00355 <span class="comment">Routine Description:</span>
00356 <span class="comment"></span>
00357 <span class="comment">    This routine examines the specified Page Directory Parent Entry to determine</span>
00358 <span class="comment">    if the page directory page mapped by the PPE exists.</span>
00359 <span class="comment"></span>
00360 <span class="comment">    If the page directory page exists and is not currently in memory, the</span>
00361 <span class="comment">    working set mutex and, if held, the PFN mutex are released and the</span>
00362 <span class="comment">    page directory page is faulted into the working set.  The mutexes are</span>
00363 <span class="comment">    reacquired.</span>
00364 <span class="comment"></span>
00365 <span class="comment">    If the PPE exists, the function returns true.</span>
00366 <span class="comment"></span>
00367 <span class="comment">Arguments:</span>
00368 <span class="comment"></span>
00369 <span class="comment">    PointerPpe - Supplies a pointer to the PPE to examine and potentially</span>
00370 <span class="comment">                 bring into the working set.</span>
00371 <span class="comment"></span>
00372 <span class="comment">    TargetProcess - Supplies a pointer to the current process.</span>
00373 <span class="comment"></span>
00374 <span class="comment">    PfnMutexHeld - Supplies the value TRUE if the PFN mutex is held, FALSE</span>
00375 <span class="comment">                   otherwise.</span>
00376 <span class="comment"></span>
00377 <span class="comment">    Waited - Supplies a pointer to a ULONG to increment if the mutex is released</span>
00378 <span class="comment">             and reacquired.  Note this value may be incremented more than once.</span>
00379 <span class="comment"></span>
00380 <span class="comment">Return Value:</span>
00381 <span class="comment"></span>
00382 <span class="comment">    TRUE if the PPE exists, FALSE if the PPE is zero.</span>
00383 <span class="comment"></span>
00384 <span class="comment">Environment:</span>
00385 <span class="comment"></span>
00386 <span class="comment">    Kernel mode, APCs disabled, WorkingSetLock held.</span>
00387 <span class="comment"></span>
00388 <span class="comment">--*/</span>
00389 
00390 {
00391     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00392     KIRQL OldIrql;
00393 
00394     OldIrql = <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>;
00395 
00396     <span class="keywordflow">if</span> (PointerPpe-&gt;u.Long == 0) {
00397 
00398         <span class="comment">//</span>
00399         <span class="comment">// This page directory parent entry doesn't exist, return FALSE.</span>
00400         <span class="comment">//</span>
00401 
00402         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00403     }
00404 
00405     <span class="keywordflow">if</span> (PointerPpe-&gt;u.Hard.Valid == 1) {
00406 
00407         <span class="comment">//</span>
00408         <span class="comment">// Already valid.</span>
00409         <span class="comment">//</span>
00410 
00411         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00412     }
00413 
00414     <span class="comment">//</span>
00415     <span class="comment">// Page directory parent entry exists, it is either valid, in transition</span>
00416     <span class="comment">// or in the paging file.  Fault it in.</span>
00417     <span class="comment">//</span>
00418 
00419     <span class="keywordflow">if</span> (PfnMutexHeld) {
00420         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00421         *Waited += 1;
00422     }
00423 
00424     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPpe);
00425 
00426     *Waited += <a class="code" href="../../d0/d2/mmsup_8c.html#a8">MiMakeSystemAddressValid</a> (PointerPde, TargetProcess);
00427 
00428     <span class="keywordflow">if</span> (PfnMutexHeld) {
00429         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00430     }
00431     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00432 }
00433 <span class="preprocessor">#endif</span>
00434 <span class="preprocessor"></span>
00435 
00436 ULONG
<a name="l00437"></a><a class="code" href="../../d0/d2/mmsup_8c.html#a6">00437</a> <a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (
00438     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde,
00439     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess,
00440     IN ULONG PfnMutexHeld,
00441     OUT PULONG Waited
00442     )
00443 
00444 <span class="comment">/*++</span>
00445 <span class="comment"></span>
00446 <span class="comment">Routine Description:</span>
00447 <span class="comment"></span>
00448 <span class="comment">    This routine examines the specified Page Directory Entry to determine</span>
00449 <span class="comment">    if the page table page mapped by the PDE exists.</span>
00450 <span class="comment"></span>
00451 <span class="comment">    If the page table page exists and is not currently in memory, the</span>
00452 <span class="comment">    working set mutex and, if held, the PFN mutex are released and the</span>
00453 <span class="comment">    page table page is faulted into the working set.  The mutexes are</span>
00454 <span class="comment">    reacquired.</span>
00455 <span class="comment"></span>
00456 <span class="comment">    If the PDE exists, the function returns true.</span>
00457 <span class="comment"></span>
00458 <span class="comment">Arguments:</span>
00459 <span class="comment"></span>
00460 <span class="comment">    PointerPde - Supplies a pointer to the PDE to examine and potentially</span>
00461 <span class="comment">                 bring into the working set.</span>
00462 <span class="comment"></span>
00463 <span class="comment">    TargetProcess - Supplies a pointer to the current process.</span>
00464 <span class="comment"></span>
00465 <span class="comment">    PfnMutexHeld - Supplies the value TRUE if the PFN mutex is held, FALSE</span>
00466 <span class="comment">                   otherwise.</span>
00467 <span class="comment"></span>
00468 <span class="comment">    Waited - Supplies a pointer to a ULONG to increment if the mutex is released</span>
00469 <span class="comment">             and reacquired.  Note this value may be incremented more than once.</span>
00470 <span class="comment"></span>
00471 <span class="comment">Return Value:</span>
00472 <span class="comment"></span>
00473 <span class="comment">    TRUE if the PDE exists, FALSE if the PDE is zero.</span>
00474 <span class="comment"></span>
00475 <span class="comment">Environment:</span>
00476 <span class="comment"></span>
00477 <span class="comment">    Kernel mode, APCs disabled, WorkingSetLock held.</span>
00478 <span class="comment"></span>
00479 <span class="comment">--*/</span>
00480 
00481 {
00482     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00483     KIRQL OldIrql;
00484 
00485     OldIrql = <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>;
00486 
00487     <span class="keywordflow">if</span> (PointerPde-&gt;u.Long == 0) {
00488 
00489         <span class="comment">//</span>
00490         <span class="comment">// This page directory entry doesn't exist, return FALSE.</span>
00491         <span class="comment">//</span>
00492 
00493         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00494     }
00495 
00496     <span class="keywordflow">if</span> (PointerPde-&gt;u.Hard.Valid == 1) {
00497 
00498         <span class="comment">//</span>
00499         <span class="comment">// Already valid.</span>
00500         <span class="comment">//</span>
00501 
00502         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00503     }
00504 
00505     <span class="comment">//</span>
00506     <span class="comment">// Page directory entry exists, it is either valid, in transition</span>
00507     <span class="comment">// or in the paging file.  Fault it in.</span>
00508     <span class="comment">//</span>
00509 
00510     <span class="keywordflow">if</span> (PfnMutexHeld) {
00511         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00512         *Waited += 1;
00513     }
00514 
00515     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00516 
00517     *Waited += <a class="code" href="../../d0/d2/mmsup_8c.html#a8">MiMakeSystemAddressValid</a> (PointerPte, TargetProcess);
00518 
00519     <span class="keywordflow">if</span> (PfnMutexHeld) {
00520         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00521     }
00522     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00523 }
00524 
00525 <span class="preprocessor">#if defined (_WIN64)</span>
00526 <span class="preprocessor"></span>
00527 ULONG
00528 <a class="code" href="../../d4/d8/mi_8h.html#a245">MiMakePpeExistAndMakeValid</a> (
00529     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe,
00530     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess,
00531     IN ULONG PfnMutexHeld
00532     )
00533 
00534 <span class="comment">/*++</span>
00535 <span class="comment"></span>
00536 <span class="comment">Routine Description:</span>
00537 <span class="comment"></span>
00538 <span class="comment">    This routine examines the specified Page Directory Parent Entry to</span>
00539 <span class="comment">    determine if the page directory page mapped by the PPE exists.</span>
00540 <span class="comment"></span>
00541 <span class="comment">    If the page directory page exists and is not currently in memory, the</span>
00542 <span class="comment">    working set mutex and, if held, the PFN mutex are released and the</span>
00543 <span class="comment">    page directory page is faulted into the working set.  The mutexes are</span>
00544 <span class="comment">    reacquired.</span>
00545 <span class="comment"></span>
00546 <span class="comment">    If the PPE exists, the function returns true.</span>
00547 <span class="comment"></span>
00548 <span class="comment">    If the PPE does not exist, a zero filled page directory is created</span>
00549 <span class="comment">    and it is brought into the working set.  In this case the return</span>
00550 <span class="comment">    value is FALSE.</span>
00551 <span class="comment"></span>
00552 <span class="comment">Arguments:</span>
00553 <span class="comment"></span>
00554 <span class="comment">    PointerPpe - Supplies a pointer to the PPE to examine and bring</span>
00555 <span class="comment">                 into the working set.</span>
00556 <span class="comment"></span>
00557 <span class="comment">    TargetProcess - Supplies a pointer to the current process.</span>
00558 <span class="comment"></span>
00559 <span class="comment">    PfnMutexHeld - Supplies the value TRUE if the PFN mutex is held, FALSE</span>
00560 <span class="comment">                   otherwise.</span>
00561 <span class="comment"></span>
00562 <span class="comment">Return Value:</span>
00563 <span class="comment"></span>
00564 <span class="comment">    TRUE if the PDE exists, FALSE if the PPE was created.</span>
00565 <span class="comment"></span>
00566 <span class="comment">Environment:</span>
00567 <span class="comment"></span>
00568 <span class="comment">    Kernel mode, APCs disabled, WorkingSetLock held.</span>
00569 <span class="comment"></span>
00570 <span class="comment">--*/</span>
00571 
00572 {
00573     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00574     KIRQL OldIrql;
00575     ULONG ReturnValue;
00576 
00577     <span class="keywordflow">if</span> (PointerPpe-&gt;u.Hard.Valid == 1) {
00578 
00579         <span class="comment">//</span>
00580         <span class="comment">// Already valid.</span>
00581         <span class="comment">//</span>
00582 
00583         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00584     }
00585 
00586     <span class="comment">//</span>
00587     <span class="comment">// Deal with the page directory page first.</span>
00588     <span class="comment">//</span>
00589 
00590     <span class="keywordflow">if</span> (PointerPpe-&gt;u.Long == 0) {
00591         ReturnValue = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00592     } <span class="keywordflow">else</span> {
00593         ReturnValue = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00594     }
00595 
00596     <span class="comment">//</span>
00597     <span class="comment">// Page directory parent entry not valid, make it valid.</span>
00598     <span class="comment">//</span>
00599 
00600     OldIrql = <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>;
00601 
00602     <span class="keywordflow">if</span> (PfnMutexHeld) {
00603         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00604     }
00605 
00606     <span class="comment">//</span>
00607     <span class="comment">// Fault it in.</span>
00608     <span class="comment">//</span>
00609 
00610     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPpe);
00611     <a class="code" href="../../d0/d2/mmsup_8c.html#a8">MiMakeSystemAddressValid</a> (PointerPde, TargetProcess);
00612 
00613     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPpe-&gt;u.Hard.Valid == 1);
00614 
00615     <span class="keywordflow">if</span> (PfnMutexHeld) {
00616         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00617     }
00618 
00619     <span class="keywordflow">return</span> ReturnValue;
00620 }
00621 <span class="preprocessor">#endif</span>
00622 <span class="preprocessor"></span>
00623 ULONG
<a name="l00624"></a><a class="code" href="../../d0/d2/mmsup_8c.html#a7">00624</a> <a class="code" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a> (
00625     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde,
00626     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess,
00627     IN ULONG PfnMutexHeld
00628     )
00629 
00630 <span class="comment">/*++</span>
00631 <span class="comment"></span>
00632 <span class="comment">Routine Description:</span>
00633 <span class="comment"></span>
00634 <span class="comment">    This routine examines the specified Page Directory Parent Entry to</span>
00635 <span class="comment">    determine if the page directory page mapped by the PPE exists.  If it does,</span>
00636 <span class="comment">    then it examines the specified Page Directory Entry to determine if</span>
00637 <span class="comment">    the page table page mapped by the PDE exists.</span>
00638 <span class="comment"></span>
00639 <span class="comment">    If the page table page exists and is not currently in memory, the</span>
00640 <span class="comment">    working set mutex and, if held, the PFN mutex are released and the</span>
00641 <span class="comment">    page table page is faulted into the working set.  The mutexes are</span>
00642 <span class="comment">    reacquired.</span>
00643 <span class="comment"></span>
00644 <span class="comment">    If the PDE exists, the function returns true.</span>
00645 <span class="comment"></span>
00646 <span class="comment">    If the PDE does not exist, a zero filled PTE is created and it</span>
00647 <span class="comment">    too is brought into the working set.  In this case the return</span>
00648 <span class="comment">    value is FALSE.</span>
00649 <span class="comment"></span>
00650 <span class="comment">Arguments:</span>
00651 <span class="comment"></span>
00652 <span class="comment">    PointerPde - Supplies a pointer to the PDE to examine and bring</span>
00653 <span class="comment">                 into the working set.</span>
00654 <span class="comment"></span>
00655 <span class="comment">    TargetProcess - Supplies a pointer to the current process.</span>
00656 <span class="comment"></span>
00657 <span class="comment">    PfnMutexHeld - Supplies the value TRUE if the PFN mutex is held, FALSE</span>
00658 <span class="comment">                   otherwise.</span>
00659 <span class="comment"></span>
00660 <span class="comment">Return Value:</span>
00661 <span class="comment"></span>
00662 <span class="comment">    TRUE if the PDE exists, FALSE if the PDE was created.</span>
00663 <span class="comment"></span>
00664 <span class="comment">Environment:</span>
00665 <span class="comment"></span>
00666 <span class="comment">    Kernel mode, APCs disabled, WorkingSetLock held.</span>
00667 <span class="comment"></span>
00668 <span class="comment">--*/</span>
00669 
00670 {
00671     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00672     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00673     KIRQL OldIrql;
00674     ULONG ReturnValue;
00675 
00676     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
00677 
00678     <span class="keywordflow">if</span> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1 &amp;&amp; PointerPde-&gt;u.Hard.Valid == 1) {
00679 
00680         <span class="comment">//</span>
00681         <span class="comment">// Already valid.</span>
00682         <span class="comment">//</span>
00683 
00684         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00685     }
00686 
00687     <span class="comment">//</span>
00688     <span class="comment">// Deal with the page directory page first.</span>
00689     <span class="comment">//</span>
00690 
00691     <span class="keywordflow">if</span> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
00692         ReturnValue = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00693     } <span class="keywordflow">else</span> {
00694         ReturnValue = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00695     }
00696 
00697     <span class="comment">//</span>
00698     <span class="comment">// Page directory parent entry not valid, make it valid.</span>
00699     <span class="comment">//</span>
00700 
00701     OldIrql = <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>;
00702 
00703     <span class="keywordflow">do</span> {
00704 
00705         <span class="keywordflow">if</span> (PfnMutexHeld) {
00706             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00707         }
00708     
00709         <span class="comment">//</span>
00710         <span class="comment">// Fault it in.</span>
00711         <span class="comment">//</span>
00712     
00713         <a class="code" href="../../d0/d2/mmsup_8c.html#a8">MiMakeSystemAddressValid</a> (PointerPde, TargetProcess);
00714     
00715         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
00716     
00717         <span class="keywordflow">if</span> (PfnMutexHeld) {
00718             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00719         }
00720     
00721         <span class="comment">//</span>
00722         <span class="comment">// Now deal with the page table page.</span>
00723         <span class="comment">//</span>
00724     
00725         <span class="keywordflow">if</span> (ReturnValue == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00726             <span class="keywordflow">if</span> (PointerPde-&gt;u.Long == 0) {
00727                 ReturnValue = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00728             } <span class="keywordflow">else</span> {
00729                 ReturnValue = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00730             }
00731         }
00732         
00733         <span class="comment">//</span>
00734         <span class="comment">// Page directory entry not valid, make it valid.</span>
00735         <span class="comment">//</span>
00736     
00737         OldIrql = <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>;
00738     
00739         <span class="keywordflow">if</span> (PfnMutexHeld) {
00740             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00741         }
00742     
00743         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00744     
00745         <span class="comment">//</span>
00746         <span class="comment">// Fault it in.</span>
00747         <span class="comment">//</span>
00748     
00749         <a class="code" href="../../d0/d2/mmsup_8c.html#a8">MiMakeSystemAddressValid</a> (PointerPte, TargetProcess);
00750     
00751         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPde-&gt;u.Hard.Valid == 1);
00752     
00753         <span class="keywordflow">if</span> (PfnMutexHeld) {
00754             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00755         }
00756 
00757     } <span class="keywordflow">while</span> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0 || PointerPde-&gt;u.Hard.Valid == 0);
00758 
00759     <span class="keywordflow">return</span> ReturnValue;
00760 }
00761 
00762 ULONG
00763 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00764"></a><a class="code" href="../../d0/d2/mmsup_8c.html#a8">00764</a> <a class="code" href="../../d0/d2/mmsup_8c.html#a8">MiMakeSystemAddressValid</a> (
00765     IN PVOID VirtualAddress,
00766     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess
00767     )
00768 
00769 <span class="comment">/*++</span>
00770 <span class="comment"></span>
00771 <span class="comment">Routine Description:</span>
00772 <span class="comment"></span>
00773 <span class="comment">    This routine checks to see if the virtual address is valid, and if</span>
00774 <span class="comment">    not makes it valid.</span>
00775 <span class="comment"></span>
00776 <span class="comment">Arguments:</span>
00777 <span class="comment"></span>
00778 <span class="comment">    VirtualAddress - Supplies the virtual address to make valid.</span>
00779 <span class="comment"></span>
00780 <span class="comment">    CurrentProcess - Supplies a pointer to the current process.</span>
00781 <span class="comment"></span>
00782 <span class="comment">Return Value:</span>
00783 <span class="comment"></span>
00784 <span class="comment">    Returns TRUE if lock released and wait performed, FALSE otherwise.</span>
00785 <span class="comment"></span>
00786 <span class="comment">Environment:</span>
00787 <span class="comment"></span>
00788 <span class="comment">    Kernel mode, APCs disabled, WorkingSetLock held.</span>
00789 <span class="comment"></span>
00790 <span class="comment">--*/</span>
00791 
00792 {
00793     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00794     LOGICAL WsHeldSafe;
00795     ULONG Waited;
00796 
00797     Waited = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00798 
00799     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VirtualAddress &gt; MM_HIGHEST_USER_ADDRESS);
00800 
00801     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((VirtualAddress &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a21">MM_PAGED_POOL_START</a>) ||
00802         (VirtualAddress &gt; <a class="code" href="../../d8/d5/kddata_8c.html#a26">MmPagedPoolEnd</a>));
00803 
00804     <span class="keywordflow">while</span> (!<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(VirtualAddress)) {
00805 
00806         <span class="comment">//</span>
00807         <span class="comment">// The virtual address is not present.  Release</span>
00808         <span class="comment">// the working set mutex and fault it in.</span>
00809         <span class="comment">//</span>
00810         <span class="comment">// The working set lock may have been acquired safely or unsafely</span>
00811         <span class="comment">// by our caller.  Handle both cases here and below.</span>
00812         <span class="comment">//</span>
00813 
00814         <a class="code" href="../../d4/d8/mi_8h.html#a164">UNLOCK_WS_REGARDLESS</a>(CurrentProcess, WsHeldSafe);
00815 
00816         status = <a class="code" href="../../d4/d1/mmfault_8c.html#a2">MmAccessFault</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, VirtualAddress, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, (PVOID)0);
00817         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00818             KdPrint ((<span class="stringliteral">"MM:page fault status %lx\n"</span>,status));
00819             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (KERNEL_DATA_INPAGE_ERROR,
00820                           1,
00821                           (ULONG)status,
00822                           (ULONG_PTR)CurrentProcess,
00823                           (ULONG_PTR)VirtualAddress);
00824         }
00825 
00826         <a class="code" href="../../d4/d8/mi_8h.html#a165">LOCK_WS_REGARDLESS</a>(CurrentProcess, WsHeldSafe);
00827 
00828         Waited = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00829     }
00830 
00831     <span class="keywordflow">return</span> Waited;
00832 }
00833 
00834 
00835 ULONG
00836 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00837"></a><a class="code" href="../../d0/d2/mmsup_8c.html#a9">00837</a> <a class="code" href="../../d0/d2/mmsup_8c.html#a9">MiMakeSystemAddressValidPfnWs</a> (
00838     IN PVOID VirtualAddress,
00839     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess OPTIONAL
00840     )
00841 
00842 <span class="comment">/*++</span>
00843 <span class="comment"></span>
00844 <span class="comment">Routine Description:</span>
00845 <span class="comment"></span>
00846 <span class="comment">    This routine checks to see if the virtual address is valid, and if</span>
00847 <span class="comment">    not makes it valid.</span>
00848 <span class="comment"></span>
00849 <span class="comment">Arguments:</span>
00850 <span class="comment"></span>
00851 <span class="comment">    VirtualAddress - Supplies the virtual address to make valid.</span>
00852 <span class="comment"></span>
00853 <span class="comment">    CurrentProcess - Supplies a pointer to the current process, if the</span>
00854 <span class="comment">                     working set lock is not held, this value is NULL.</span>
00855 <span class="comment"></span>
00856 <span class="comment">Return Value:</span>
00857 <span class="comment"></span>
00858 <span class="comment">    Returns TRUE if lock released and wait performed, FALSE otherwise.</span>
00859 <span class="comment"></span>
00860 <span class="comment">Environment:</span>
00861 <span class="comment"></span>
00862 <span class="comment">    Kernel mode, APCs disabled, PFN lock held, working set lock held</span>
00863 <span class="comment">       if CurrentProcess != NULL.</span>
00864 <span class="comment"></span>
00865 <span class="comment">--*/</span>
00866 
00867 {
00868     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00869     ULONG Waited;
00870     KIRQL OldIrql;
00871     LOGICAL WsHeldSafe;
00872 
00873     Waited = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00874     OldIrql = <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>;
00875 
00876     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VirtualAddress &gt; MM_HIGHEST_USER_ADDRESS);
00877 
00878     <span class="keywordflow">while</span> (!<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(VirtualAddress)) {
00879 
00880         <span class="comment">//</span>
00881         <span class="comment">// The virtual address is not present.  Release</span>
00882         <span class="comment">// the working set mutex and fault it in.</span>
00883         <span class="comment">//</span>
00884 
00885         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00886         <span class="keywordflow">if</span> (CurrentProcess != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00887 
00888             <span class="comment">//</span>
00889             <span class="comment">// The working set lock may have been acquired safely or unsafely</span>
00890             <span class="comment">// by our caller.  Handle both cases here and below.</span>
00891             <span class="comment">//</span>
00892 
00893             <a class="code" href="../../d4/d8/mi_8h.html#a164">UNLOCK_WS_REGARDLESS</a>(CurrentProcess, WsHeldSafe);
00894         }
00895         status = <a class="code" href="../../d4/d1/mmfault_8c.html#a2">MmAccessFault</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, VirtualAddress, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, (PVOID)0);
00896         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00897             KdPrint ((<span class="stringliteral">"MM:page fault status %lx\n"</span>,status));
00898             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (KERNEL_DATA_INPAGE_ERROR,
00899                           2,
00900                           (ULONG)status,
00901                           (ULONG_PTR)CurrentProcess,
00902                           (ULONG_PTR)VirtualAddress);
00903         }
00904         <span class="keywordflow">if</span> (CurrentProcess != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00905             <a class="code" href="../../d4/d8/mi_8h.html#a165">LOCK_WS_REGARDLESS</a>(CurrentProcess, WsHeldSafe);
00906         }
00907         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00908 
00909         Waited = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00910     }
00911     <span class="keywordflow">return</span> Waited;
00912 }
00913 
00914 ULONG
00915 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00916"></a><a class="code" href="../../d0/d2/mmsup_8c.html#a10">00916</a> <a class="code" href="../../d0/d2/mmsup_8c.html#a10">MiMakeSystemAddressValidPfnSystemWs</a> (
00917     IN PVOID VirtualAddress
00918     )
00919 
00920 <span class="comment">/*++</span>
00921 <span class="comment"></span>
00922 <span class="comment">Routine Description:</span>
00923 <span class="comment"></span>
00924 <span class="comment">    This routine checks to see if the virtual address is valid, and if</span>
00925 <span class="comment">    not makes it valid.</span>
00926 <span class="comment"></span>
00927 <span class="comment">Arguments:</span>
00928 <span class="comment"></span>
00929 <span class="comment">    VirtualAddress - Supplies the virtual address to make valid.</span>
00930 <span class="comment"></span>
00931 <span class="comment">Return Value:</span>
00932 <span class="comment"></span>
00933 <span class="comment">    Returns TRUE if lock released and wait performed, FALSE otherwise.</span>
00934 <span class="comment"></span>
00935 <span class="comment">Environment:</span>
00936 <span class="comment"></span>
00937 <span class="comment">    Kernel mode, APCs disabled, PFN lock held, system working set lock held.</span>
00938 <span class="comment"></span>
00939 <span class="comment">--*/</span>
00940 
00941 {
00942     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00943     ULONG Waited;
00944     KIRQL OldIrql;
00945     KIRQL OldIrqlWs;
00946     LOGICAL SessionSpace;
00947 
00948     Waited = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00949     OldIrql = <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>;
00950     OldIrqlWs = <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>;
00951 
00952     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VirtualAddress &gt; MM_HIGHEST_USER_ADDRESS);
00953 
00954     SessionSpace = <a class="code" href="../../d4/d8/mi_8h.html#a352">MI_IS_SESSION_IMAGE_ADDRESS</a> (VirtualAddress);
00955 
00956     <span class="keywordflow">while</span> (!<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(VirtualAddress)) {
00957 
00958         <span class="comment">//</span>
00959         <span class="comment">// The virtual address is not present.  Release</span>
00960         <span class="comment">// the working set mutex and fault it in.</span>
00961         <span class="comment">//</span>
00962 
00963         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00964 
00965         <span class="keywordflow">if</span> (SessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00966             <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrqlWs);
00967         }
00968         <span class="keywordflow">else</span> {
00969             <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (OldIrqlWs);
00970         }
00971 
00972         status = <a class="code" href="../../d4/d1/mmfault_8c.html#a2">MmAccessFault</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, VirtualAddress, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, (PVOID)0);
00973         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00974             KdPrint ((<span class="stringliteral">"MM:page fault status %lx\n"</span>,status));
00975             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (KERNEL_DATA_INPAGE_ERROR,
00976                           2,
00977                           (ULONG)status,
00978                           (ULONG_PTR)0,
00979                           (ULONG_PTR)VirtualAddress);
00980         }
00981         <span class="keywordflow">if</span> (SessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00982             <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (OldIrqlWs);
00983         }
00984         <span class="keywordflow">else</span> {
00985             <a class="code" href="../../d4/d8/mi_8h.html#a144">LOCK_SYSTEM_WS</a> (OldIrqlWs);
00986         }
00987         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00988 
00989         Waited = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00990     }
00991     <span class="keywordflow">return</span> Waited;
00992 }
00993 
00994 ULONG
00995 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00996"></a><a class="code" href="../../d0/d2/mmsup_8c.html#a11">00996</a> <a class="code" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (
00997     IN PVOID VirtualAddress
00998     )
00999 
01000 <span class="comment">/*++</span>
01001 <span class="comment"></span>
01002 <span class="comment">Routine Description:</span>
01003 <span class="comment"></span>
01004 <span class="comment">    This routine checks to see if the virtual address is valid, and if</span>
01005 <span class="comment">    not makes it valid.</span>
01006 <span class="comment"></span>
01007 <span class="comment">Arguments:</span>
01008 <span class="comment"></span>
01009 <span class="comment">    VirtualAddress - Supplies the virtual address to make valid.</span>
01010 <span class="comment"></span>
01011 <span class="comment">Return Value:</span>
01012 <span class="comment"></span>
01013 <span class="comment">    Returns TRUE if lock released and wait performed, FALSE otherwise.</span>
01014 <span class="comment"></span>
01015 <span class="comment">Environment:</span>
01016 <span class="comment"></span>
01017 <span class="comment">    Kernel mode, APCs disabled, only the PFN Lock held.</span>
01018 <span class="comment"></span>
01019 <span class="comment">--*/</span>
01020 
01021 {
01022     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01023     KIRQL OldIrql = <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>;
01024 
01025     ULONG Waited = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01026 
01027     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VirtualAddress &gt; MM_HIGHEST_USER_ADDRESS);
01028 
01029     <span class="keywordflow">while</span> (!<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(VirtualAddress)) {
01030 
01031         <span class="comment">//</span>
01032         <span class="comment">// The virtual address is not present.  Release</span>
01033         <span class="comment">// the working set mutex and fault it in.</span>
01034         <span class="comment">//</span>
01035 
01036         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01037 
01038         status = <a class="code" href="../../d4/d1/mmfault_8c.html#a2">MmAccessFault</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, VirtualAddress, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, (PVOID)0);
01039         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01040             KdPrint ((<span class="stringliteral">"MM:page fault status %lx\n"</span>,status));
01041             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (KERNEL_DATA_INPAGE_ERROR,
01042                           3,
01043                           (ULONG)status,
01044                           (ULONG_PTR)VirtualAddress,
01045                           0);
01046         }
01047 
01048         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01049 
01050         Waited = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01051     }
01052 
01053     <span class="keywordflow">return</span> Waited;
01054 }
01055 
01056 ULONG
01057 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l01058"></a><a class="code" href="../../d0/d2/mmsup_8c.html#a12">01058</a> <a class="code" href="../../d0/d2/mmsup_8c.html#a12">MiLockPagedAddress</a> (
01059     IN PVOID VirtualAddress,
01060     IN ULONG PfnLockHeld
01061     )
01062 
01063 <span class="comment">/*++</span>
01064 <span class="comment"></span>
01065 <span class="comment">Routine Description:</span>
01066 <span class="comment"></span>
01067 <span class="comment">    This routine checks to see if the virtual address is valid, and if</span>
01068 <span class="comment">    not makes it valid.</span>
01069 <span class="comment"></span>
01070 <span class="comment">Arguments:</span>
01071 <span class="comment"></span>
01072 <span class="comment">    VirtualAddress - Supplies the virtual address to make valid.</span>
01073 <span class="comment"></span>
01074 <span class="comment">    CurrentProcess - Supplies a pointer to the current process.</span>
01075 <span class="comment"></span>
01076 <span class="comment">Return Value:</span>
01077 <span class="comment"></span>
01078 <span class="comment">    Returns TRUE if lock released and wait performed, FALSE otherwise.</span>
01079 <span class="comment"></span>
01080 <span class="comment">Environment:</span>
01081 <span class="comment"></span>
01082 <span class="comment">    Kernel mode.</span>
01083 <span class="comment"></span>
01084 <span class="comment">--*/</span>
01085 
01086 {
01087 
01088     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01089     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01090     KIRQL OldIrql;
01091     ULONG Waited = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01092 
01093     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(VirtualAddress);
01094 
01095     <span class="comment">//</span>
01096     <span class="comment">// The address must be within paged pool.</span>
01097     <span class="comment">//</span>
01098 
01099     <span class="keywordflow">if</span> (PfnLockHeld == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01100         <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
01101     }
01102 
01103     <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
01104 
01105         Waited = <a class="code" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (
01106                                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte));
01107 
01108     }
01109 
01110     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01111     <a class="code" href="../../d4/d8/mi_8h.html#a186">MI_ADD_LOCKED_PAGE_CHARGE</a>(Pfn1, 6);
01112     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
01113 
01114     <span class="keywordflow">if</span> (PfnLockHeld == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01115         <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
01116     }
01117     <span class="keywordflow">return</span> Waited;
01118 }
01119 
01120 
01121 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01122 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l01123"></a><a class="code" href="../../d0/d2/mmsup_8c.html#a13">01123</a> <a class="code" href="../../d0/d2/mmsup_8c.html#a13">MiUnlockPagedAddress</a> (
01124     IN PVOID VirtualAddress,
01125     IN ULONG PfnLockHeld
01126     )
01127 
01128 <span class="comment">/*++</span>
01129 <span class="comment"></span>
01130 <span class="comment">Routine Description:</span>
01131 <span class="comment"></span>
01132 <span class="comment">    This routine checks to see if the virtual address is valid, and if</span>
01133 <span class="comment">    not makes it valid.</span>
01134 <span class="comment"></span>
01135 <span class="comment">Arguments:</span>
01136 <span class="comment"></span>
01137 <span class="comment">    VirtualAddress - Supplies the virtual address to make valid.</span>
01138 <span class="comment"></span>
01139 <span class="comment"></span>
01140 <span class="comment">Return Value:</span>
01141 <span class="comment"></span>
01142 <span class="comment">    None.</span>
01143 <span class="comment"></span>
01144 <span class="comment">Environment:</span>
01145 <span class="comment"></span>
01146 <span class="comment">    Kernel mode.  PFN LOCK MUST NOT BE HELD.</span>
01147 <span class="comment"></span>
01148 <span class="comment">--*/</span>
01149 
01150 {
01151     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01152     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01153     KIRQL OldIrql;
01154     PFN_NUMBER PageFrameIndex;
01155 
01156     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(VirtualAddress);
01157 
01158     <span class="comment">//</span>
01159     <span class="comment">// Address must be within paged pool.</span>
01160     <span class="comment">//</span>
01161 
01162     <span class="keywordflow">if</span> (PfnLockHeld == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01163         <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
01164     }
01165 
01166     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
01167     PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
01168     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01169 
01170     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt; 1);
01171 
01172     <a class="code" href="../../d4/d8/mi_8h.html#a189">MI_REMOVE_LOCKED_PAGE_CHARGE</a>(Pfn1, 7);
01173 
01174     <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (PageFrameIndex);
01175 
01176     <span class="keywordflow">if</span> (PfnLockHeld == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01177         <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
01178     }
01179     <span class="keywordflow">return</span>;
01180 }
01181 
01182 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01183 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l01184"></a><a class="code" href="../../d0/d2/mmsup_8c.html#a14">01184</a> <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (
01185     IN PFN_NUMBER PageFrameIndex,
01186     IN ULONG PageColor
01187     )
01188 
01189 <span class="comment">/*++</span>
01190 <span class="comment"></span>
01191 <span class="comment">Routine Description:</span>
01192 <span class="comment"></span>
01193 <span class="comment">    This procedure maps the specified physical page into hyper space</span>
01194 <span class="comment">    and fills the page with zeros.</span>
01195 <span class="comment"></span>
01196 <span class="comment">Arguments:</span>
01197 <span class="comment"></span>
01198 <span class="comment">    PageFrameIndex - Supplies the physical page number to fill with</span>
01199 <span class="comment">                    zeroes.</span>
01200 <span class="comment"></span>
01201 <span class="comment">Return Value:</span>
01202 <span class="comment"></span>
01203 <span class="comment">    none.</span>
01204 <span class="comment"></span>
01205 <span class="comment">Environment:</span>
01206 <span class="comment"></span>
01207 <span class="comment">    Kernel mode.</span>
01208 <span class="comment"></span>
01209 <span class="comment">--*/</span>
01210 
01211 {
01212     PULONG va;
01213     KIRQL OldIrql;
01214 
01215 <span class="preprocessor">#if defined(_ALPHA_)</span>
01216 <span class="preprocessor"></span>
01217     HalZeroPage((PVOID)ULongToPtr((PageColor &amp; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a57">MM_COLOR_MASK</a>) &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>),
01218                 (PVOID)ULongToPtr((PageColor &amp; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a57">MM_COLOR_MASK</a>) &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>),
01219                 PageFrameIndex);
01220 <span class="preprocessor">#else</span>
01221 <span class="preprocessor"></span>
01222     UNREFERENCED_PARAMETER (PageColor);
01223 
01224     va = (PULONG)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PageFrameIndex, &amp;OldIrql);
01225 
01226 <span class="preprocessor">#if defined(_X86_)</span>
01227 <span class="preprocessor"></span>
01228     <a class="code" href="../../d6/d9/kernlini_8c.html#a24">KeZeroPage</a>(va);
01229 
01230 <span class="preprocessor">#else</span>
01231 <span class="preprocessor"></span>
01232     RtlZeroMemory (va, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01233 
01234 <span class="preprocessor">#endif // X86</span>
01235 <span class="preprocessor"></span>
01236     <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql);
01237 
01238 <span class="preprocessor">#endif // ALPHA</span>
01239 <span class="preprocessor"></span>
01240     <span class="keywordflow">return</span>;
01241 }
01242 
01243 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01244 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l01245"></a><a class="code" href="../../d0/d2/mmsup_8c.html#a15">01245</a> <a class="code" href="../../d0/d2/mmsup_8c.html#a15">MiRestoreTransitionPte</a> (
01246     IN PFN_NUMBER PageFrameIndex
01247     )
01248 
01249 <span class="comment">/*++</span>
01250 <span class="comment"></span>
01251 <span class="comment">Routine Description:</span>
01252 <span class="comment"></span>
01253 <span class="comment">    This procedure restores the original contents into the PTE (which could</span>
01254 <span class="comment">    be a prototype PTE) referred to by the PFN database for the specified</span>
01255 <span class="comment">    physical page.  It also updates all necessary data structures to</span>
01256 <span class="comment">    reflect the fact that the referenced PTE is no longer in transition.</span>
01257 <span class="comment"></span>
01258 <span class="comment">    The physical address of the referenced PTE is mapped into hyper space</span>
01259 <span class="comment">    of the current process and the PTE is then updated.</span>
01260 <span class="comment"></span>
01261 <span class="comment">Arguments:</span>
01262 <span class="comment"></span>
01263 <span class="comment">    PageFrameIndex - Supplies the physical page number which refers to a</span>
01264 <span class="comment">                    transition PTE.</span>
01265 <span class="comment"></span>
01266 <span class="comment">Return Value:</span>
01267 <span class="comment"></span>
01268 <span class="comment">    none.</span>
01269 <span class="comment"></span>
01270 <span class="comment">Environment:</span>
01271 <span class="comment"></span>
01272 <span class="comment">    Must be holding the PFN database mutex with APCs disabled.</span>
01273 <span class="comment"></span>
01274 <span class="comment">--*/</span>
01275 
01276 {
01277     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01278     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01279     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
01280     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
01281     KIRQL OldIrql = 99;
01282 
01283     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01284 
01285     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>);
01286 
01287     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte) {
01288 
01289         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>)) {
01290             PointerPte = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>;
01291         } <span class="keywordflow">else</span> {
01292 
01293             <span class="comment">//</span>
01294             <span class="comment">// The page containing the prototype PTE is not valid,</span>
01295             <span class="comment">// map the page into hyperspace and reference it that way.</span>
01296             <span class="comment">//</span>
01297 
01298             PointerPte = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>, &amp;OldIrql);
01299             PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)((PCHAR)PointerPte +
01300                                     <a class="code" href="../../d4/d8/mi_8h.html#a110">MiGetByteOffset</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>));
01301         }
01302 
01303         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a> (PointerPte) == PageFrameIndex) &amp;&amp;
01304                  (PointerPte-&gt;u.Hard.Valid == 0));
01305 
01306         <span class="comment">//</span>
01307         <span class="comment">// This page is referenced by a prototype PTE.  The</span>
01308         <span class="comment">// segment structures need to be updated when the page</span>
01309         <span class="comment">// is removed from the transition state.</span>
01310         <span class="comment">//</span>
01311 
01312         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype) {
01313 
01314             <span class="comment">//</span>
01315             <span class="comment">// The prototype PTE is in subsection format, calculate the</span>
01316             <span class="comment">// address of the control area for the subsection and decrement</span>
01317             <span class="comment">// the number of PFN references to the control area.</span>
01318             <span class="comment">//</span>
01319             <span class="comment">// Calculate address of subsection for this prototype PTE.</span>
01320             <span class="comment">//</span>
01321 
01322             Subsection = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a148">MiGetSubsectionAddress</a> (&amp;Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
01323             ControlArea = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a>;
01324             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">NumberOfPfnReferences</a> -= 1;
01325             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">NumberOfPfnReferences</a> &gt;= 0);
01326 
01327             <a class="code" href="../../d5/d5/sectsup_8c.html#a25">MiCheckForControlAreaDeletion</a> (ControlArea);
01328         }
01329 
01330     } <span class="keywordflow">else</span> {
01331 
01332         <span class="comment">//</span>
01333         <span class="comment">// The page points to a page or page table page which may not be</span>
01334         <span class="comment">// for the current process.  Map the page into hyperspace and</span>
01335         <span class="comment">// reference it through hyperspace.  If the page resides in</span>
01336         <span class="comment">// system space (but not session space), it does not need to be</span>
01337         <span class="comment">// mapped as all PTEs for system space must be resident.  Session</span>
01338         <span class="comment">// space PTEs are only mapped per session so access to them must</span>
01339         <span class="comment">// also go through hyperspace.</span>
01340         <span class="comment">//</span>
01341 
01342         PointerPte = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>;
01343 
01344         <span class="keywordflow">if</span> (PointerPte &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a11">MM_SYSTEM_SPACE_START</a>) ||
01345                <a class="code" href="../../d4/d8/mi_8h.html#a355">MI_IS_SESSION_PTE</a> (PointerPte)) {
01346 
01347             PointerPte = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>, &amp;OldIrql);
01348             PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)((PCHAR)PointerPte +
01349                                        <a class="code" href="../../d4/d8/mi_8h.html#a110">MiGetByteOffset</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>));
01350         }
01351         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a> (PointerPte) == PageFrameIndex) &amp;&amp;
01352                  (PointerPte-&gt;u.Hard.Valid == 0));
01353 
01354         <a class="code" href="../../d4/d8/mi_8h.html#a175">MI_CAPTURE_USED_PAGETABLE_ENTRIES</a> (Pfn1);
01355 
01356 <span class="preprocessor">#if _WIN64</span>
01357 <span class="preprocessor"></span><span class="preprocessor">#if DBGXX</span>
01358 <span class="preprocessor"></span>        MiCheckPageTableTrim(PointerPte);
01359 <span class="preprocessor">#endif</span>
01360 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01361 <span class="preprocessor"></span>    }
01362 
01363     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
01364     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (!((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
01365              (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1)));
01366 
01367     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
01368 
01369     <span class="keywordflow">if</span> (OldIrql != 99) {
01370         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql);
01371     }
01372 
01373     <span class="comment">//</span>
01374     <span class="comment">// The PTE has been restored to its original contents and is</span>
01375     <span class="comment">// no longer in transition.  Decrement the share count on</span>
01376     <span class="comment">// the page table page which contains the PTE.</span>
01377     <span class="comment">//</span>
01378 
01379     <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01380 
01381     <span class="keywordflow">return</span>;
01382 }
01383 
01384 <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>
<a name="l01385"></a><a class="code" href="../../d0/d2/mmsup_8c.html#a16">01385</a> <a class="code" href="../../d0/d2/mmsup_8c.html#a16">MiGetSubsectionAndProtoFromPte</a> (
01386     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
01387     OUT <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> *ProtoPte,
01388     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
01389     )
01390 
01391 <span class="comment">/*++</span>
01392 <span class="comment"></span>
01393 <span class="comment">Routine Description:</span>
01394 <span class="comment"></span>
01395 <span class="comment">    This routine examines the contents of the supplied PTE (which must</span>
01396 <span class="comment">    map a page within a section) and determines the address of the</span>
01397 <span class="comment">    subsection in which the PTE is contained.</span>
01398 <span class="comment"></span>
01399 <span class="comment">Arguments:</span>
01400 <span class="comment"></span>
01401 <span class="comment">    PointerPte - Supplies a pointer to the PTE.</span>
01402 <span class="comment"></span>
01403 <span class="comment">    ProtoPte - Supplies a pointer to a PMMPTE which receives the</span>
01404 <span class="comment">               address of the prototype PTE which is mapped by the supplied</span>
01405 <span class="comment">               PointerPte.</span>
01406 <span class="comment"></span>
01407 <span class="comment">    Process - Supplies a pointer to the current process.</span>
01408 <span class="comment"></span>
01409 <span class="comment">Return Value:</span>
01410 <span class="comment"></span>
01411 <span class="comment">    Returns the pointer to the subsection for this PTE.</span>
01412 <span class="comment"></span>
01413 <span class="comment">Environment:</span>
01414 <span class="comment"></span>
01415 <span class="comment">    Kernel mode - Must be holding the PFN database lock and</span>
01416 <span class="comment">                  working set mutex (acquired safely) with APCs disabled.</span>
01417 <span class="comment"></span>
01418 <span class="comment">--*/</span>
01419 
01420 {
01421     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerProto;
01422     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01423 
01424     <span class="keywordflow">if</span> (PointerPte-&gt;u.Hard.Valid == 1) {
01425         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;u.Hard.PageFrameNumber);
01426         *ProtoPte = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>;
01427         <span class="keywordflow">return</span> <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a148">MiGetSubsectionAddress</a> (&amp;Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
01428     }
01429 
01430     PointerProto = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a144">MiPteToProto</a> (PointerPte);
01431     *ProtoPte = PointerProto;
01432 
01433     <a class="code" href="../../d0/d2/mmsup_8c.html#a9">MiMakeSystemAddressValidPfnWs</a> (PointerProto, Process);
01434 
01435     <span class="keywordflow">if</span> (PointerProto-&gt;u.Hard.Valid == 1) {
01436         <span class="comment">//</span>
01437         <span class="comment">// Prototype Pte is valid.</span>
01438         <span class="comment">//</span>
01439 
01440         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerProto-&gt;u.Hard.PageFrameNumber);
01441         <span class="keywordflow">return</span> <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a148">MiGetSubsectionAddress</a> (&amp;Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
01442     }
01443 
01444     <span class="keywordflow">if</span> ((PointerProto-&gt;u.Soft.Transition == 1) &amp;&amp;
01445          (PointerProto-&gt;u.Soft.Prototype == 0)) {
01446 
01447         <span class="comment">//</span>
01448         <span class="comment">// Prototype Pte is in transition.</span>
01449         <span class="comment">//</span>
01450 
01451         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerProto-&gt;u.Trans.PageFrameNumber);
01452         <span class="keywordflow">return</span> <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a148">MiGetSubsectionAddress</a> (&amp;Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
01453     }
01454 
01455     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerProto-&gt;u.Soft.Prototype == 1);
01456     <span class="keywordflow">return</span> <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a148">MiGetSubsectionAddress</a> (PointerProto);
01457 }
01458 
01459 BOOLEAN
<a name="l01460"></a><a class="code" href="../../d0/d2/mmsup_8c.html#a17">01460</a> <a class="code" href="../../d0/d2/mmsup_8c.html#a17">MmIsNonPagedSystemAddressValid</a> (
01461     IN PVOID VirtualAddress
01462     )
01463 
01464 <span class="comment">/*++</span>
01465 <span class="comment"></span>
01466 <span class="comment">Routine Description:</span>
01467 <span class="comment"></span>
01468 <span class="comment">    For a given virtual address this function returns TRUE if the address</span>
01469 <span class="comment">    is within the nonpagable portion of the system's address space,</span>
01470 <span class="comment">    FALSE otherwise.</span>
01471 <span class="comment"></span>
01472 <span class="comment">Arguments:</span>
01473 <span class="comment"></span>
01474 <span class="comment">    VirtualAddress - Supplies the virtual address to check.</span>
01475 <span class="comment"></span>
01476 <span class="comment">Return Value:</span>
01477 <span class="comment"></span>
01478 <span class="comment">    TRUE if the address is within the nonpagable portion of the system</span>
01479 <span class="comment">    address space, FALSE otherwise.</span>
01480 <span class="comment"></span>
01481 <span class="comment">Environment:</span>
01482 <span class="comment"></span>
01483 <span class="comment">    Kernel mode.</span>
01484 <span class="comment"></span>
01485 <span class="comment">--*/</span>
01486 
01487 {
01488     <span class="comment">//</span>
01489     <span class="comment">// Return TRUE if address is within the nonpagable portion</span>
01490     <span class="comment">// of the system.  Check limits for paged pool and if not within</span>
01491     <span class="comment">// those limits, return TRUE.</span>
01492     <span class="comment">//</span>
01493 
01494     <span class="keywordflow">if</span> ((VirtualAddress &gt;= <a class="code" href="../../d8/d5/kddata_8c.html#a25">MmPagedPoolStart</a>) &amp;&amp;
01495         (VirtualAddress &lt;= <a class="code" href="../../d8/d5/kddata_8c.html#a26">MmPagedPoolEnd</a>)) {
01496         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01497     }
01498 
01499     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01500 }
01501 
01502 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01503"></a><a class="code" href="../../d0/d2/mmsup_8c.html#a18">01503</a> <a class="code" href="../../d0/d2/mmsup_8c.html#a18">MmHibernateInformation</a> (
01504     IN PVOID    MemoryMap,
01505     OUT PULONG_PTR  HiberVa,
01506     OUT PPHYSICAL_ADDRESS HiberPte
01507     )
01508 {
01509     <span class="comment">//</span>
01510     <span class="comment">// Mark PTE page where the 16 dump PTEs reside as needing cloned</span>
01511     <span class="comment">//</span>
01512 
01513     <a class="code" href="../../d1/d2/po_8h.html#a67">PoSetHiberRange</a> (
01514         MemoryMap,
01515         <a class="code" href="../../d1/d2/po_8h.html#a9">PO_MEM_CLONE</a>,
01516         <a class="code" href="../../d4/d2/datalpha_8c.html#a19">MmCrashDumpPte</a>,
01517         1,
01518         ' etP'
01519         );
01520 
01521     <span class="comment">//</span>
01522     <span class="comment">// Return the dump PTEs to the loader (as it needs to use them</span>
01523     <span class="comment">// to map it's relocation code into the kernel space on the</span>
01524     <span class="comment">// final bit of restoring memory)</span>
01525     <span class="comment">//</span>
01526 
01527     *HiberVa = (ULONG_PTR) <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(<a class="code" href="../../d4/d2/datalpha_8c.html#a19">MmCrashDumpPte</a>);
01528     *HiberPte = <a class="code" href="../../d5/d6/iosup_8c.html#a68">MmGetPhysicalAddress</a>(<a class="code" href="../../d4/d2/datalpha_8c.html#a19">MmCrashDumpPte</a>);
01529 }
01530 
01531 <span class="preprocessor">#if _WIN64</span>
01532 <span class="preprocessor"></span><span class="preprocessor">#if DBGXX</span>
01533 <span class="preprocessor"></span>
01534 ULONG zok[16];
01535 
01536 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01537 MiCheckPageTableTrim(
01538     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte
01539 )
01540 {
01541     ULONG i;
01542     PFN_NUMBER Frame;
01543     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn;
01544     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FrameData;
01545     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> p;
01546     ULONG count;
01547 
01548     Frame = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(PointerPte);
01549     Pfn = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (Frame);
01550 
01551     <span class="keywordflow">if</span> (Pfn-&gt;UsedPageTableEntries) {
01552 
01553         count = 0;
01554 
01555         p = FrameData = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)KSEG_ADDRESS (Frame);
01556 
01557         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a103">PTE_PER_PAGE</a>; i += 1, p += 1) {
01558             <span class="keywordflow">if</span> (p-&gt;u.Long != 0) {
01559                 count += 1;
01560             }
01561         }
01562 
01563         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MiCheckPageTableTrim: %I64X %I64X %I64X\n"</span>,
01564             PointerPte, Pfn, Pfn-&gt;UsedPageTableEntries);
01565 
01566         <span class="keywordflow">if</span> (count != Pfn-&gt;UsedPageTableEntries) {
01567             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MiCheckPageTableTrim1: %I64X %I64X %I64X %I64X\n"</span>,
01568                 PointerPte, Pfn, Pfn-&gt;UsedPageTableEntries, count);
01569             DbgBreakPoint();
01570         }
01571         zok[0] += 1;
01572     }
01573     <span class="keywordflow">else</span> {
01574         zok[1] += 1;
01575     }
01576 }
01577 
01578 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01579 MiCheckPageTableInPage(
01580     IN <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn,
01581     IN <a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html">PMMINPAGE_SUPPORT</a> Support
01582 )
01583 {
01584     ULONG i;
01585     PFN_NUMBER Frame;
01586     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FrameData;
01587     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> p;
01588     ULONG count;
01589 
01590     <span class="keywordflow">if</span> (Support-&gt;UsedPageTableEntries) {
01591 
01592         Frame = (PFN_NUMBER)((<a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a>)Pfn - (<a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a>)<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>);
01593 
01594         count = 0;
01595 
01596         p = FrameData = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)KSEG_ADDRESS (Frame);
01597 
01598         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a103">PTE_PER_PAGE</a>; i += 1, p += 1) {
01599             <span class="keywordflow">if</span> (p-&gt;u.Long != 0) {
01600                 count += 1;
01601             }
01602         }
01603 
01604         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MiCheckPageTableIn: %I64X %I64X %I64X\n"</span>,
01605             FrameData, Pfn, Support-&gt;UsedPageTableEntries);
01606 
01607         <span class="keywordflow">if</span> (count != Support-&gt;UsedPageTableEntries) {
01608             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MiCheckPageTableIn1: %I64X %I64X %I64X %I64X\n"</span>,
01609                 FrameData, Pfn, Support-&gt;UsedPageTableEntries, count);
01610             DbgBreakPoint();
01611         }
01612         zok[2] += 1;
01613     }
01614     <span class="keywordflow">else</span> {
01615         zok[3] += 1;
01616     }
01617 }
01618 <span class="preprocessor">#endif</span>
01619 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:50 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
