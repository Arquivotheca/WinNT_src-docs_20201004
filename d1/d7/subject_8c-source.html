<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: subject.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>subject.c</h1><a href="../../d0/d8/subject_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    Subject.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This Module implements services related to subject security context.</span>
00012 <span class="comment">    These services are part of the services provided by the Reference Monitor</span>
00013 <span class="comment">    component.</span>
00014 <span class="comment"></span>
00015 <span class="comment">    FOR PERFORMANCE SAKE, THIS MODULE IS AWARE OF INTERNAL TOKEN OBJECT</span>
00016 <span class="comment">    FORMATS.</span>
00017 <span class="comment"></span>
00018 <span class="comment">Author:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Jim Kelly       (JimK)      2-Aug-1990</span>
00021 <span class="comment"></span>
00022 <span class="comment">Environment:</span>
00023 <span class="comment"></span>
00024 <span class="comment">    Kernel Mode</span>
00025 <span class="comment"></span>
00026 <span class="comment">Revision History:</span>
00027 <span class="comment"></span>
00028 <span class="comment">--*/</span>
00029 
00030 <span class="preprocessor">#include "<a class="code" href="../../d6/d6/sep_8h.html">sep.h</a>"</span>
00031 <span class="preprocessor">#include "seopaque.h"</span>
00032 <span class="preprocessor">#include "<a class="code" href="../../d8/d3/tokenp_8h.html">tokenp.h</a>"</span>
00033 
00034 
00035 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeCaptureSubjectContext)</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeLockSubjectContext)</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeUnlockSubjectContext)</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeReleaseSubjectContext)</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepGetDefaultsSubjectContext)</span>
00041 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepValidOwnerSubjectContext)</span>
00042 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00043 <span class="preprocessor"></span>
00044 
00045 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00046"></a><a class="code" href="../../d0/d8/subject_8c.html#a0">00046</a> <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a> (
00047     OUT <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectContext
00048     )
00049 
00050 <span class="comment">/*++</span>
00051 <span class="comment"></span>
00052 <span class="comment">Routine Description:</span>
00053 <span class="comment"></span>
00054 <span class="comment">    This routine takes a snapshot of the calling thread's security</span>
00055 <span class="comment">    context (locking tokens as necessary to do so).  This function</span>
00056 <span class="comment">    is intended to support the object manager and other components</span>
00057 <span class="comment">    that utilize the reference monitor's access validation,</span>
00058 <span class="comment">    privilege test, and audit generation services.</span>
00059 <span class="comment"></span>
00060 <span class="comment">    A subject's security context should be captured before initiating</span>
00061 <span class="comment">    access validation and should be released after audit messages</span>
00062 <span class="comment">    are generated.  This is necessary to provide a consistent security</span>
00063 <span class="comment">    context to all those services.</span>
00064 <span class="comment"></span>
00065 <span class="comment">    After calling access validation, privilege test, and audit generation</span>
00066 <span class="comment">    services, the captured context should be released as soon as possible</span>
00067 <span class="comment">    using the SeReleaseSubjectContext() service.</span>
00068 <span class="comment"></span>
00069 <span class="comment">Arguments:</span>
00070 <span class="comment"></span>
00071 <span class="comment">    SubjectContext - Points to a SECURITY_SUBJECT_CONTEXT data structure</span>
00072 <span class="comment">        to be filled in with a snapshot of the calling thread's security</span>
00073 <span class="comment">        profile.</span>
00074 <span class="comment"></span>
00075 <span class="comment">Return Value:</span>
00076 <span class="comment"></span>
00077 <span class="comment">    none.</span>
00078 <span class="comment"></span>
00079 <span class="comment">--*/</span>
00080 
00081 {
00082 
00083     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00084 
00085     <span class="comment">//PVOID Objects[2];</span>
00086 
00087     BOOLEAN IgnoreCopyOnOpen;
00088     BOOLEAN IgnoreEffectiveOnly;
00089 
00090     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00091 
00092     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00093     SubjectContext-&gt;ProcessAuditId = <a class="code" href="../../d1/d9/ps_8h.html#a25">PsProcessAuditId</a>( CurrentProcess );
00094 
00095     <span class="comment">//</span>
00096     <span class="comment">// Get pointers to primary and impersonation tokens</span>
00097     <span class="comment">//</span>
00098 
00099     SubjectContext-&gt;ClientToken = <a class="code" href="../../d6/d5/ps_2security_8c.html#a1">PsReferenceImpersonationToken</a>(
00100                                       <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>(),
00101                                       &amp;IgnoreCopyOnOpen,
00102                                       &amp;IgnoreEffectiveOnly,
00103                                       &amp;(SubjectContext-&gt;ImpersonationLevel)
00104                                       );
00105 
00106     SubjectContext-&gt;PrimaryToken = <a class="code" href="../../d6/d5/ps_2security_8c.html#a0">PsReferencePrimaryToken</a>(CurrentProcess);
00107 
00108     <span class="keywordflow">return</span>;
00109 
00110 }
00111 
00112 
00113 
00114 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00115"></a><a class="code" href="../../d0/d8/subject_8c.html#a1">00115</a> <a class="code" href="../../d0/d8/subject_8c.html#a1">SeLockSubjectContext</a>(
00116     IN <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectContext
00117     )
00118 
00119 <span class="comment">/*++</span>
00120 <span class="comment"></span>
00121 <span class="comment">Routine Description:</span>
00122 <span class="comment"></span>
00123 <span class="comment">    Acquires READ LOCKS on the primary and impersonation tokens</span>
00124 <span class="comment">    in the passed SubjectContext.</span>
00125 <span class="comment"></span>
00126 <span class="comment">    This call must be undone by a call to SeUnlockSubjectContext().</span>
00127 <span class="comment"></span>
00128 <span class="comment">    No one outside of the SE component should need to acquire a</span>
00129 <span class="comment">    write lock to a token.  Therefore there is no public interface</span>
00130 <span class="comment">    to do this.</span>
00131 <span class="comment"></span>
00132 <span class="comment">Arguments:</span>
00133 <span class="comment"></span>
00134 <span class="comment">    SubjectContext - Points to a SECURITY_SUBJECT_CONTEXT data structure</span>
00135 <span class="comment">        which points to a primary token and an optional impersonation token.</span>
00136 <span class="comment"></span>
00137 <span class="comment">Return Value:</span>
00138 <span class="comment"></span>
00139 <span class="comment">    None</span>
00140 <span class="comment"></span>
00141 <span class="comment">--*/</span>
00142 
00143 {
00144     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00145 
00146     <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>((<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)(SubjectContext-&gt;PrimaryToken));
00147 
00148     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(SubjectContext-&gt;ClientToken)) {
00149 
00150         <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>((<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)(SubjectContext-&gt;ClientToken));
00151     }
00152 
00153     <span class="keywordflow">return</span>;
00154 }
00155 
00156 
00157 
00158 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00159"></a><a class="code" href="../../d0/d8/subject_8c.html#a2">00159</a> <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>(
00160     IN <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectContext
00161     )
00162 
00163 <span class="comment">/*++</span>
00164 <span class="comment"></span>
00165 <span class="comment">Routine Description:</span>
00166 <span class="comment"></span>
00167 <span class="comment">    Releases the read locks on the token(s) in the passed SubjectContext.</span>
00168 <span class="comment"></span>
00169 <span class="comment">Arguments:</span>
00170 <span class="comment"></span>
00171 <span class="comment">    SubjectContext - Points to a SECURITY_SUBJECT_CONTEXT data structure</span>
00172 <span class="comment">        which points to a primary token and an optional impersonation token.</span>
00173 <span class="comment"></span>
00174 <span class="comment">Return Value:</span>
00175 <span class="comment"></span>
00176 <span class="comment">    None</span>
00177 <span class="comment"></span>
00178 <span class="comment">--*/</span>
00179 
00180 {
00181     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00182 
00183     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>((<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)(SubjectContext-&gt;PrimaryToken));
00184 
00185     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(SubjectContext-&gt;ClientToken)) {
00186 
00187         <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>((<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)(SubjectContext-&gt;ClientToken));
00188     }
00189 
00190 
00191 }
00192 
00193 
00194 
00195 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00196"></a><a class="code" href="../../d0/d8/subject_8c.html#a3">00196</a> <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> (
00197     IN <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectContext
00198     )
00199 
00200 <span class="comment">/*++</span>
00201 <span class="comment"></span>
00202 <span class="comment"></span>
00203 <span class="comment">Routine Description:</span>
00204 <span class="comment"></span>
00205 <span class="comment">    This routine releases a subject security context previously captured by</span>
00206 <span class="comment">    SeCaptureSubjectContext().</span>
00207 <span class="comment"></span>
00208 <span class="comment">Arguments:</span>
00209 <span class="comment"></span>
00210 <span class="comment">    SubjectContext - Points to a SECURITY_SUBJECT_CONTEXT data structure</span>
00211 <span class="comment">        containing a subject's previously captured security context.</span>
00212 <span class="comment"></span>
00213 <span class="comment">Return Value:</span>
00214 <span class="comment"></span>
00215 <span class="comment">    none.</span>
00216 <span class="comment"></span>
00217 <span class="comment">--*/</span>
00218 
00219 {
00220     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00221 
00222     <a class="code" href="../../d1/d9/ps_8h.html#a24">PsDereferencePrimaryToken</a>( SubjectContext-&gt;PrimaryToken );
00223     SubjectContext-&gt;PrimaryToken = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00224 
00225 
00226     <a class="code" href="../../d1/d9/ps_8h.html#a26">PsDereferenceImpersonationToken</a>( SubjectContext-&gt;ClientToken );
00227     SubjectContext-&gt;ClientToken = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00228 
00229     <span class="keywordflow">return</span>;
00230 
00231 }
00232 
00233 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00234"></a><a class="code" href="../../d0/d8/subject_8c.html#a4">00234</a> <a class="code" href="../../d0/d8/subject_8c.html#a4">SepGetDefaultsSubjectContext</a>(
00235     IN <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectContext,
00236     OUT PSID *Owner,
00237     OUT PSID *Group,
00238     OUT PSID *ServerOwner,
00239     OUT PSID *ServerGroup,
00240     OUT PACL *Dacl
00241     )
00242 <span class="comment">/*++</span>
00243 <span class="comment"></span>
00244 <span class="comment">Routine Description:</span>
00245 <span class="comment"></span>
00246 <span class="comment">    This routine retrieves pointers to the default owner, primary group,</span>
00247 <span class="comment">    and, if present, discretionary ACL of the provided subject security</span>
00248 <span class="comment">    context.</span>
00249 <span class="comment"></span>
00250 <span class="comment">Arguments:</span>
00251 <span class="comment"></span>
00252 <span class="comment">    SubjectContext - Points to the subject security context whose default</span>
00253 <span class="comment">        values are to be retrieved.</span>
00254 <span class="comment"></span>
00255 <span class="comment">    Owner - Receives a pointer to the subject's default owner SID.  This</span>
00256 <span class="comment">        value will always be returned as a non-zero pointer.  That is,</span>
00257 <span class="comment">        a subject's security context must contain a owner SID.</span>
00258 <span class="comment"></span>
00259 <span class="comment">    Group - Receives a pointer to the subject's default primary group SID.</span>
00260 <span class="comment">        This value will always be returned as a non-zero pointer.  That is,</span>
00261 <span class="comment">        a subject's security context must contain a primary group.</span>
00262 <span class="comment"></span>
00263 <span class="comment">    Dacl - Receives a pointer to the subject's default discretionary ACL,</span>
00264 <span class="comment">        if one is define for the subject.  Note that a subject security context</span>
00265 <span class="comment">        does not have to include a default discretionary ACL.  In this case,</span>
00266 <span class="comment">        this value will be returned as NULL.</span>
00267 <span class="comment"></span>
00268 <span class="comment"></span>
00269 <span class="comment"></span>
00270 <span class="comment"></span>
00271 <span class="comment">Return Value:</span>
00272 <span class="comment"></span>
00273 <span class="comment">    none.</span>
00274 <span class="comment"></span>
00275 <span class="comment">--*/</span>
00276 
00277 {
00278     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>;
00279     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>;
00280 
00281     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00282 
00283     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(SubjectContext-&gt;ClientToken)) {
00284         <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a> = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)SubjectContext-&gt;ClientToken;
00285     } <span class="keywordflow">else</span> {
00286         <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a> = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)SubjectContext-&gt;PrimaryToken;
00287     }
00288 
00289     (*Owner) = <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>-&gt;UserAndGroups[<a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>-&gt;DefaultOwnerIndex].Sid;
00290 
00291     (*Group) = <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>-&gt;PrimaryGroup;
00292 
00293     (*Dacl)  = <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>-&gt;DefaultDacl;
00294 
00295     <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a> = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)SubjectContext-&gt;PrimaryToken;
00296 
00297     *ServerOwner = <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>-&gt;UserAndGroups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>-&gt;DefaultOwnerIndex].Sid;
00298 
00299     *ServerGroup = <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>-&gt;PrimaryGroup;
00300 
00301     <span class="keywordflow">return</span>;
00302 }
00303 
00304 
00305 BOOLEAN
<a name="l00306"></a><a class="code" href="../../d0/d8/subject_8c.html#a5">00306</a> <a class="code" href="../../d0/d8/subject_8c.html#a5">SepIdAssignableAsGroup</a>(
00307     IN PACCESS_TOKEN AToken,
00308     IN PSID Group
00309     )
00310 <span class="comment">/*++</span>
00311 <span class="comment"></span>
00312 <span class="comment">Routine Description:</span>
00313 <span class="comment"></span>
00314 <span class="comment">    This routine checks to see whether the provided SID is one that</span>
00315 <span class="comment">    may be assigned to be the default primary group in a token.</span>
00316 <span class="comment"></span>
00317 <span class="comment">    The current criteria is that the passed SID be a group in the</span>
00318 <span class="comment">    token, with no other restrictions.</span>
00319 <span class="comment"></span>
00320 <span class="comment">Arguments:</span>
00321 <span class="comment"></span>
00322 <span class="comment">    Token - Points to the token to be examined.</span>
00323 <span class="comment"></span>
00324 <span class="comment">    Group - Points to the SID to be checked.</span>
00325 <span class="comment"></span>
00326 <span class="comment">Return Value:</span>
00327 <span class="comment"></span>
00328 <span class="comment">    TRUE - SID passed by be assigned as the default primary group in a token.</span>
00329 <span class="comment"></span>
00330 <span class="comment">    FALSE - Passed SID may not be so assigned.</span>
00331 <span class="comment"></span>
00332 <span class="comment">--*/</span>
00333 
00334 {
00335     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00336     BOOLEAN Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00337     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00338 
00339     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00340 
00341     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)AToken;
00342 
00343     <span class="comment">//</span>
00344     <span class="comment">// Let's make it invalid to assign a NULL primary group,</span>
00345     <span class="comment">// but we may need to revisit this.</span>
00346     <span class="comment">//</span>
00347 
00348     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00349         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00350     }
00351 
00352     <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00353 
00354     <span class="comment">//</span>
00355     <span class="comment">//  Walk through the list of user and group IDs looking</span>
00356     <span class="comment">//  for a match to the specified SID.</span>
00357     <span class="comment">//</span>
00358 
00359     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
00360     <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount) {
00361 
00362         Found = <a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(
00363                     <a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a>,
00364                     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Sid
00365                     );
00366 
00367         <span class="keywordflow">if</span> ( Found ) {
00368             <span class="keywordflow">break</span>;
00369         }
00370 
00371         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
00372     }
00373 
00374     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00375 
00376     <span class="keywordflow">return</span> Found;
00377 }
00378 
00379 
00380 BOOLEAN
<a name="l00381"></a><a class="code" href="../../d0/d8/subject_8c.html#a6">00381</a> <a class="code" href="../../d0/d8/subject_8c.html#a6">SepValidOwnerSubjectContext</a>(
00382     IN <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectContext,
00383     IN PSID Owner,
00384     IN BOOLEAN ServerObject
00385     )
00386 <span class="comment">/*++</span>
00387 <span class="comment"></span>
00388 <span class="comment">Routine Description:</span>
00389 <span class="comment"></span>
00390 <span class="comment">    This routine checks to see whether the provided SID is one the subject</span>
00391 <span class="comment">    is authorized to assign as the owner of objects.  It will also check to</span>
00392 <span class="comment">    see if the caller has SeRestorePrivilege, if so, the request is granted.</span>
00393 <span class="comment"></span>
00394 <span class="comment">Arguments:</span>
00395 <span class="comment"></span>
00396 <span class="comment">    SubjectContext - Points to the subject's security context.</span>
00397 <span class="comment"></span>
00398 <span class="comment">    Owner - Points to the SID to be checked.</span>
00399 <span class="comment"></span>
00400 <span class="comment"></span>
00401 <span class="comment"></span>
00402 <span class="comment">Return Value:</span>
00403 <span class="comment"></span>
00404 <span class="comment">    none.</span>
00405 <span class="comment"></span>
00406 <span class="comment">--*/</span>
00407 
00408 {
00409 
00410     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00411     BOOLEAN Found;
00412     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>;
00413     BOOLEAN Rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00414 
00415     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00416 
00417     <span class="comment">//</span>
00418     <span class="comment">// It is invalid to assign a NULL owner, regardless of</span>
00419     <span class="comment">// whether you have SeRestorePrivilege or not.</span>
00420     <span class="comment">//</span>
00421 
00422     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00423         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00424     }
00425 
00426     <span class="comment">//</span>
00427     <span class="comment">// Allowable owners come from the primary if it's a server object.</span>
00428     <span class="comment">//</span>
00429 
00430     <span class="keywordflow">if</span> (!ServerObject &amp;&amp; ARGUMENT_PRESENT(SubjectContext-&gt;ClientToken)) {
00431         <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a> = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)SubjectContext-&gt;ClientToken;
00432     } <span class="keywordflow">else</span> {
00433         <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a> = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)SubjectContext-&gt;PrimaryToken;
00434     }
00435 
00436 
00437     <span class="comment">//</span>
00438     <span class="comment">// If we're impersonating, make sure we're at TokenImpersonation</span>
00439     <span class="comment">// or above.  This prevents someone from setting the owner of an</span>
00440     <span class="comment">// object when impersonating at less Identify or Anonymous.</span>
00441     <span class="comment">//</span>
00442 
00443     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>-&gt;TokenType == TokenImpersonation) {
00444 
00445         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>-&gt;ImpersonationLevel &lt; SecurityImpersonation) {
00446 
00447             <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00448 
00449         }
00450     }
00451 
00452     <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a> );
00453 
00454     <span class="comment">//</span>
00455     <span class="comment">//  Walk through the list of user and group IDs looking</span>
00456     <span class="comment">//  for a match to the specified SID.  If one is found,</span>
00457     <span class="comment">//  make sure it may be assigned as an owner.</span>
00458     <span class="comment">//</span>
00459     <span class="comment">//  This code is similar to that performed to set the default</span>
00460     <span class="comment">//  owner of a token (NtSetInformationToken).</span>
00461     <span class="comment">//</span>
00462 
00463     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
00464     <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>-&gt;UserAndGroupCount) {
00465 
00466 
00467         Found = <a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(
00468                     <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>,
00469                     <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>-&gt;UserAndGroups[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Sid
00470                     );
00471 
00472         <span class="keywordflow">if</span> ( Found ) {
00473 
00474             <span class="comment">//</span>
00475             <span class="comment">// We may return success if the Sid is one that may be assigned</span>
00476             <span class="comment">// as an owner, or if the caller has SeRestorePrivilege</span>
00477             <span class="comment">//</span>
00478 
00479             <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d3/tokenp_8h.html#a33">SepIdAssignableAsOwner</a>(<a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>,<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>) ) {
00480 
00481                 <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a> );
00482                 Rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00483                 <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
00484 
00485             } <span class="keywordflow">else</span> {
00486 
00487                 <span class="comment">//</span>
00488                 <span class="comment">// Rc is already set to FALSE, just exit.</span>
00489                 <span class="comment">//</span>
00490 
00491                 <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a> );
00492                 <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
00493 
00494             } <span class="comment">//endif assignable</span>
00495 
00496 
00497         }  <span class="comment">//endif Found</span>
00498 
00499 
00500         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
00501 
00502     } <span class="comment">//endwhile</span>
00503 
00504 
00505     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a> );
00506 
00507 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
00508 
00509     <span class="comment">//</span>
00510     <span class="comment">// If we are going to fail this call, check for Restore privilege,</span>
00511     <span class="comment">// and succeed if he has it.</span>
00512     <span class="comment">//</span>
00513 
00514     <span class="comment">//</span>
00515     <span class="comment">// We should really have gotten PreviousMode from the caller, but we</span>
00516     <span class="comment">// didn't, so hard wire it to be user-mode here.</span>
00517     <span class="comment">//</span>
00518 
00519     <span class="keywordflow">if</span> ( Rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
00520         Rc = <a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>( <a class="code" href="../../d0/d5/se_8h.html#a95">SeRestorePrivilege</a>, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a> );
00521     }
00522 
00523     <span class="keywordflow">return</span> Rc;
00524 }
00525 
00526 
00527 
00528 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00529"></a><a class="code" href="../../d0/d8/subject_8c.html#a7">00529</a> <a class="code" href="../../d0/d8/subject_8c.html#a7">SeQueryAuthenticationIdSubjectContext</a>(
00530     IN <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectContext,
00531     OUT PLUID AuthenticationId
00532     )
00533 <span class="comment">/*++</span>
00534 <span class="comment"></span>
00535 <span class="comment">    Routine Description:</span>
00536 <span class="comment"></span>
00537 <span class="comment">        This routine returns the authentication ID for the effective token</span>
00538 <span class="comment">        in a subject context</span>
00539 <span class="comment"></span>
00540 <span class="comment">    Parameters:</span>
00541 <span class="comment"></span>
00542 <span class="comment">        SubjectContext - The subject context to get the ID from</span>
00543 <span class="comment"></span>
00544 <span class="comment">        AuthenticationId - Receives the authentication ID from the token</span>
00545 <span class="comment"></span>
00546 <span class="comment">    Return Value:</span>
00547 <span class="comment"></span>
00548 <span class="comment">        Errors from SeQueryAuthenticationidToken.</span>
00549 <span class="comment"></span>
00550 <span class="comment">--*/</span>
00551 {
00552     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00553 
00554     <a class="code" href="../../d0/d8/subject_8c.html#a1">SeLockSubjectContext</a>( SubjectContext );
00555 
00556 
00557     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a1">SeQueryAuthenticationIdToken</a>(
00558                 <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>(SubjectContext),
00559                 AuthenticationId
00560                 );
00561 
00562     <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( SubjectContext );
00563 
00564     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00565 
00566 
00567 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:54 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
