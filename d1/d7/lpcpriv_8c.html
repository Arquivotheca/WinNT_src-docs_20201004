<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: lpcpriv.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>lpcpriv.c File Reference</h1><code>#include "<a class="el" href="../../d1/d6/lpcp_8h-source.html">lpcp.h</a>"</code><br>

<p>
<a href="../../d2/d6/lpcpriv_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d7/lpcpriv_8c.html#a0">NtImpersonateClientOfPort</a> (IN HANDLE <a class="el" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a>, IN PPORT_MESSAGE Message)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d7/lpcpriv_8c.html#a1">LpcpFreePortClientSecurity</a> (IN <a class="el" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> Port)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a1" doxytag="lpcpriv.c::LpcpFreePortClientSecurity" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LpcpFreePortClientSecurity           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Port</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d6/lpcpriv_8c-source.html#l00296">296</a> of file <a class="el" href="../../d2/d6/lpcpriv_8c-source.html">lpcpriv.c</a>.
<p>
References <a class="el" href="../../d3/d5/lpc_8h-source.html#l00134">CLIENT_COMMUNICATION_PORT</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00137">PORT_DYNAMIC_SECURITY</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00130">PORT_TYPE</a>, and <a class="el" href="../../d1/d4/se_8h-source.html#l00612">SeDeleteClientSecurity</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/lpcclose_8c-source.html#l00110">LpcpDeletePort()</a>.
<p>
<pre class="fragment"><div>00302                    :
00303 
00304     This routine cleans up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> captured security context <span class="keywordflow">for</span> a client port.
00305     The cleanup <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> typically done when we are deleting a port
00306 
00307 Arguments:
00308 
00309     Port - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client port being deleted
00310 
00311 Return Value:
00312 
00313     None.
00314 
00315 --*/
00316 
00317 {
00318     <span class="comment">//</span>
00319     <span class="comment">//  We only do this action if supplied with a client communication port</span>
00320     <span class="comment">//</span>
00321 
00322     <span class="keywordflow">if</span> ((Port-&gt;Flags &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) == <a class="code" href="../../d2/d6/lpc_8h.html#a7">CLIENT_COMMUNICATION_PORT</a>) {
00323 
00324         <span class="comment">//</span>
00325         <span class="comment">//  We only do this action if the port has static security tracking,</span>
00326         <span class="comment">//  and we have a captured client token.  The action is to simply</span>
00327         <span class="comment">//  delete the client token.</span>
00328         <span class="comment">//</span>
00329 
00330         <span class="keywordflow">if</span> (!(Port-&gt;Flags &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a10">PORT_DYNAMIC_SECURITY</a>)) {
00331 
00332             <span class="keywordflow">if</span> ( Port-&gt;StaticSecurity.ClientToken ) {
00333 
00334                 <a class="code" href="../../d0/d5/se_8h.html#a12">SeDeleteClientSecurity</a>( &amp;(Port)-&gt;StaticSecurity );
00335             }
00336         }
00337     }
00338 
00339     <span class="comment">//</span>
00340     <span class="comment">//  And return to our caller</span>
00341     <span class="comment">//</span>
00342 
00343     <span class="keywordflow">return</span>;
00344 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="lpcpriv.c::NtImpersonateClientOfPort" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtImpersonateClientOfPort           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>PortHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PPORT_MESSAGE&nbsp;</td>
          <td class="mdname" nowrap> <em>Message</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d6/lpcpriv_8c-source.html#l00032">32</a> of file <a class="el" href="../../d2/d6/lpcpriv_8c-source.html">lpcpriv.c</a>.
<p>
References <a class="el" href="../../d8/d6/uclient_8c-source.html#l00033">ClientThread()</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00108">_LPCP_PORT_OBJECT::ConnectedPort</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00106">_LPCP_PORT_OBJECT::Flags</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00093">LpcpAcquireLpcpLock</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00275">LpcpFreeDynamicClientSecurity</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00272">LpcpGetDynamicClientSecurity</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00278">LpcpReferencePortObject</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00108">LpcpReleaseLpcpLock</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00119">_LPCP_PORT_OBJECT::LpcReplyChainHead</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00138">PORT_DELETED</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00137">PORT_DYNAMIC_SECURITY</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00130">PORT_TYPE</a>, <a class="el" href="../../d8/d6/uclient_8c-source.html#l00027">PortHandle</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d2/d9/pscid_8c-source.html#l00027">PsLookupProcessThreadByCid()</a>, <a class="el" href="../../d5/d4/seclient_8c-source.html#l00636">SeImpersonateClientEx()</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00133">SERVER_COMMUNICATION_PORT</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00118">_LPCP_PORT_OBJECT::StaticSecurity</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/lpcsvr_8c-source.html#l00696">RtlImpersonateLpcClient()</a>, and <a class="el" href="../../d9/d9/ctlpcqos_8c-source.html#l00645">SepServerImpersonateClient()</a>.
<p>
<pre class="fragment"><div>00039                    :
00040 
00041     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server thread to temporarily acquire <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00042     identifier set of a client thread.
00043 
00044     This service establishes an impersonation token <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling thread.
00045     The impersonation token corresponds to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context provided by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> port
00046     client.  The client must currently be waiting <span class="keywordflow">for</span> a reply to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00047     specified message.
00048 
00049     This service returns an error status code <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
00050     waiting <span class="keywordflow">for</span> a reply to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message.  The security quality of service
00051     parameters specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client upon connection dictate what use <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00052     server will have of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's security context.
00053 
00054     For complicated or extended impersonation needs, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server may open a
00055     copy of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's token (<span class="keyword">using</span> <a class="code" href="../../d7/d3/tokenopn_8c.html#a3">NtOpenThreadToken</a>()).  This must be
00056     done <span class="keywordflow">while</span> impersonating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client.
00057 
00058 Arguments:
00059 
00060     <a class="code" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a> - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> communication port that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00061         message was received from.
00062 
00063     Message - Specifies an address of a message that was received from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00064         client that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be impersonated.  The ClientId field of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message
00065         identifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client thread that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be impersonated.  The client
00066         thread must be waiting <span class="keywordflow">for</span> a reply to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message in order to
00067         impersonate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client.
00068 
00069 Return Value:
00070 
00071     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation was
00072     successful.
00073 
00074 --*/
00075 
00076 {
00077     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> PortObject;
00078     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> ConnectedPort;
00079     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00080     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00081     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>;
00082     CLIENT_ID CapturedClientId;
00083     ULONG CapturedMessageId;
00084     <a class="code" href="../../d8/d0/struct__SECURITY__CLIENT__CONTEXT.html">SECURITY_CLIENT_CONTEXT</a> DynamicSecurity;
00085     PLIST_ENTRY Next, Head;
00086     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> ThreadWaitingForReply;
00087 
00088     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00089 
00090     <span class="comment">//</span>
00091     <span class="comment">//  Get previous processor mode and probe output arguments if necessary.</span>
00092     <span class="comment">//</span>
00093 
00094     PreviousMode = KeGetPreviousMode();
00095 
00096     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00097 
00098         <span class="keywordflow">try</span> {
00099 
00100             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( Message, <span class="keyword">sizeof</span>( PORT_MESSAGE ), <span class="keyword">sizeof</span>( ULONG ));
00101 
00102             CapturedClientId = Message-&gt;ClientId;
00103             CapturedMessageId = Message-&gt;MessageId;
00104 
00105         } except( EXCEPTION_EXECUTE_HANDLER ) {
00106 
00107             <span class="keywordflow">return</span>( GetExceptionCode() );
00108         }
00109 
00110     } <span class="keywordflow">else</span> {
00111 
00112         CapturedClientId = Message-&gt;ClientId;
00113         CapturedMessageId = Message-&gt;MessageId;
00114     }
00115 
00116     <span class="comment">//</span>
00117     <span class="comment">//  Reference the communication port object by handle.  Return status if</span>
00118     <span class="comment">//  unsuccessful.</span>
00119     <span class="comment">//</span>
00120 
00121     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/lpcp_8h.html#a10">LpcpReferencePortObject</a>( PortHandle, 0,
00122                                       PreviousMode, &amp;PortObject );
00123     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00124 
00125         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00126     }
00127 
00128     <span class="comment">//</span>
00129     <span class="comment">//  It is an error to try this on any port other than a server</span>
00130     <span class="comment">//  communication port</span>
00131     <span class="comment">//</span>
00132 
00133     <span class="keywordflow">if</span> ((PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) != <a class="code" href="../../d2/d6/lpc_8h.html#a6">SERVER_COMMUNICATION_PORT</a>) {
00134 
00135         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00136 
00137         <span class="keywordflow">return</span>( STATUS_INVALID_PORT_HANDLE );
00138     }
00139 
00140     <span class="comment">//</span>
00141     <span class="comment">//  Translate the ClientId from the connection request into a</span>
00142     <span class="comment">//  thread pointer.  This is a referenced pointer to keep the thread</span>
00143     <span class="comment">//  from evaporating out from under us.</span>
00144     <span class="comment">//</span>
00145 
00146     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d0/pscid_8c.html#a0">PsLookupProcessThreadByCid</a>( &amp;CapturedClientId,
00147                                          NULL,
00148                                          &amp;ClientThread );
00149 
00150     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00151 
00152         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00153 
00154         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00155     }
00156 
00157     <span class="comment">//</span>
00158     <span class="comment">//  Acquire the mutex that guards the LpcReplyMessage field of</span>
00159     <span class="comment">//  the thread and get the pointer to the message that the thread</span>
00160     <span class="comment">//  is waiting for a reply to.</span>
00161     <span class="comment">//</span>
00162 
00163     <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
00164 
00165     <span class="keywordflow">if</span> ( ( PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o3">ConnectedPort</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) ||
00166          ( PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o3">ConnectedPort</a>-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a11">PORT_DELETED</a> )) {
00167 
00168         <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00169 
00170         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00171         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientThread );
00172 
00173         <span class="keywordflow">return</span>( STATUS_PORT_DISCONNECTED );
00174     }
00175 
00176     ConnectedPort = PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o3">ConnectedPort</a>;
00177     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( ConnectedPort );
00178 
00179     <span class="comment">//</span>
00180     <span class="comment">//  See if the thread is waiting for a reply to the message</span>
00181     <span class="comment">//  specified on this call, if the user gave us a bad</span>
00182     <span class="comment">//  message id.  If not then a bogus message</span>
00183     <span class="comment">//  has been specified, so return failure.</span>
00184     <span class="comment">//</span>
00185 
00186     <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;LpcReplyMessageId != CapturedMessageId) ||
00187         (CapturedMessageId == 0)) {
00188 
00189         <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00190 
00191         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00192         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientThread );
00193         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ConnectedPort );
00194 
00195         <span class="keywordflow">return</span> (STATUS_REPLY_MESSAGE_MISMATCH);
00196     }
00197 
00198     <span class="comment">//</span>
00199     <span class="comment">//  Search in the LpcReplyChain if the ClientThread exists</span>
00200     <span class="comment">//  Perform this search only if the client thread is queued to the port object</span>
00201     <span class="comment">//</span>
00202     
00203     <span class="keywordflow">if</span> ( !IsListEmpty( &amp;<a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>-&gt;LpcReplyChain ) ) {
00204         
00205         ThreadWaitingForReply = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00206         Head = &amp;PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o14">LpcReplyChainHead</a>;
00207         Next = Head-&gt;Flink;
00208 
00209         <span class="keywordflow">while</span> ((Next != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (Next != Head)) {
00210 
00211             ThreadWaitingForReply = CONTAINING_RECORD( Next, <a class="code" href="../../d5/d6/struct__ETHREAD.html">ETHREAD</a>, LpcReplyChain );
00212 
00213             <span class="comment">//</span>
00214             <span class="comment">//  If found the Client thread, quit from the loop</span>
00215             <span class="comment">//</span>
00216 
00217             <span class="keywordflow">if</span> ( ThreadWaitingForReply ==  <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>) {
00218 
00219                 <span class="keywordflow">break</span>;
00220             }
00221 
00222             Next = Next-&gt;Flink;
00223         }
00224 
00225         <span class="comment">//</span>
00226         <span class="comment">//  If not found, return an error</span>
00227         <span class="comment">//</span>
00228 
00229         <span class="keywordflow">if</span> (ThreadWaitingForReply !=  <a class="code" href="../../d7/d7/uclient_8c.html#a6">ClientThread</a>) {
00230             
00231             <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00232 
00233             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00234             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientThread );
00235             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ConnectedPort );
00236 
00237             <span class="keywordflow">return</span> (STATUS_REPLY_MESSAGE_MISMATCH);
00238         }
00239     }
00240     
00241 
00242     <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00243 
00244     <span class="comment">//</span>
00245     <span class="comment">//  If the client requested dynamic security tracking, then the client</span>
00246     <span class="comment">//  security needs to be referenced.  Otherwise, (static case)</span>
00247     <span class="comment">//  it is already in the client's port.</span>
00248     <span class="comment">//</span>
00249 
00250     <span class="keywordflow">if</span> (ConnectedPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a10">PORT_DYNAMIC_SECURITY</a>) {
00251 
00252         <span class="comment">//</span>
00253         <span class="comment">//  Impersonate the client with information from the queued message</span>
00254         <span class="comment">//</span>
00255 
00256         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/lpcp_8h.html#a8">LpcpGetDynamicClientSecurity</a>( ClientThread,
00257                                                PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o3">ConnectedPort</a>,
00258                                                &amp;DynamicSecurity );
00259 
00260         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00261 
00262             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00263             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientThread );
00264             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ConnectedPort );
00265 
00266             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00267         }
00268 
00269         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d5/seclient_8c.html#a3">SeImpersonateClientEx</a>( &amp;DynamicSecurity, NULL );
00270 
00271         <a class="code" href="../../d0/d7/lpcp_8h.html#a9">LpcpFreeDynamicClientSecurity</a>( &amp;DynamicSecurity );
00272 
00273     } <span class="keywordflow">else</span> {
00274 
00275         <span class="comment">//</span>
00276         <span class="comment">//  Impersonate the client with information from the client's port</span>
00277         <span class="comment">//</span>
00278 
00279         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d5/seclient_8c.html#a3">SeImpersonateClientEx</a>( &amp;ConnectedPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o13">StaticSecurity</a>, NULL );
00280 
00281     }
00282 
00283     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00284     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientThread );
00285     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ConnectedPort );
00286 
00287     <span class="comment">//</span>
00288     <span class="comment">//  And return to our caller</span>
00289     <span class="comment">//</span>
00290 
00291     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00292 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:34 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
