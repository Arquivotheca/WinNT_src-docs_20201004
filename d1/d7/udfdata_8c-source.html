<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: udfdata.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>udfdata.c</h1><a href="../../d0/d8/udfdata_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    UdfData.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module declares the global data used by the Udfs file system.</span>
00012 <span class="comment"></span>
00013 <span class="comment">    This module also handles the dispath routines in the Fsd threads as well as</span>
00014 <span class="comment">    handling the IrpContext and Irp through the exception path.</span>
00015 <span class="comment"></span>
00016 <span class="comment">Author:</span>
00017 <span class="comment"></span>
00018 <span class="comment">    Dan Lovinger    [DanLo]   24-May-1996</span>
00019 <span class="comment"></span>
00020 <span class="comment">Revision History:</span>
00021 <span class="comment"></span>
00022 <span class="comment">--*/</span>
00023 
00024 <span class="preprocessor">#include "UdfProcs.h"</span>
00025 
00026 <span class="comment">//</span>
00027 <span class="comment">//  The Bug check file id for this module</span>
00028 <span class="comment">//</span>
00029 
<a name="l00030"></a><a class="code" href="../../d0/d8/udfdata_8c.html#a0">00030</a> <span class="preprocessor">#define BugCheckFileId                   (UDFS_BUG_CHECK_UDFDATA)</span>
00031 <span class="preprocessor"></span>
00032 <span class="comment">//</span>
00033 <span class="comment">//  The local debug trace level</span>
00034 <span class="comment">//</span>
00035 
<a name="l00036"></a><a class="code" href="../../d0/d8/udfdata_8c.html#a1">00036</a> <span class="preprocessor">#define Dbg                              (UDFS_DEBUG_LEVEL_UDFDATA)</span>
00037 <span class="preprocessor"></span>
00038 <span class="comment">//</span>
00039 <span class="comment">//  Global data structures</span>
00040 <span class="comment">//</span>
00041 
<a name="l00042"></a><a class="code" href="../../d0/d8/udfdata_8c.html#a2">00042</a> <a class="code" href="../../d2/d3/struct__UDF__DATA.html">UDF_DATA</a> <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>;
<a name="l00043"></a><a class="code" href="../../d0/d8/udfdata_8c.html#a3">00043</a> <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a> <a class="code" href="../../d0/d8/udfdata_8c.html#a3">UdfFastIoDispatch</a>;
00044 
00045 <span class="comment">//</span>
00046 <span class="comment">//  Debug trace levels</span>
00047 <span class="comment">//</span>
00048 
00049 <span class="preprocessor">#ifdef UDF_SANITY</span>
00050 <span class="preprocessor"></span>
00051 <span class="comment">//</span>
00052 <span class="comment">//  For UdfDebugTrace (only live in checked builds) to be able to swing</span>
00053 <span class="comment">//  variable argument lists and varargs printfs.</span>
00054 <span class="comment">//</span>
00055 
00056 <span class="preprocessor">#include &lt;stdarg.h&gt;</span>
00057 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00058 
00059 BOOLEAN UdfTestTopLevel = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00060 BOOLEAN UdfTestRaisedStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00061 
00062 LONG UdfDebugTraceLevel = 0;
00063 LONG UdfDebugTraceIndent = 0;
00064 
00065 <span class="comment">//</span>
00066 <span class="comment">//  Control whether UdfVerifyDescriptor will only emit info on failure (FALSE) or</span>
00067 <span class="comment">//  all of the time (TRUE).</span>
00068 <span class="comment">//</span>
00069 
00070 BOOLEAN UdfNoisyVerifyDescriptor = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00071 
00072 <span class="preprocessor">#endif</span>
00073 <span class="preprocessor"></span>
00074 <span class="comment">//</span>
00075 <span class="comment">//  Reserved directory strings.</span>
00076 <span class="comment">//</span>
00077 
<a name="l00078"></a><a class="code" href="../../d0/d8/udfdata_8c.html#a4">00078</a> WCHAR <a class="code" href="../../d0/d8/udfdata_8c.html#a4">UdfUnicodeSelfArray</a>[] = { <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'.'</span> };
<a name="l00079"></a><a class="code" href="../../d0/d8/udfdata_8c.html#a5">00079</a> WCHAR <a class="code" href="../../d0/d8/udfdata_8c.html#a5">UdfUnicodeParentArray</a>[] = { <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'.'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'.'</span> };
00080 
<a name="l00081"></a><a class="code" href="../../d0/d8/udfdata_8c.html#a6">00081</a> UNICODE_STRING <a class="code" href="../../d0/d8/udfdata_8c.html#a6">UdfUnicodeDirectoryNames</a>[] = {
00082     { <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/udfdata_8c.html#a4">UdfUnicodeSelfArray</a>), <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/udfdata_8c.html#a4">UdfUnicodeSelfArray</a>), <a class="code" href="../../d0/d8/udfdata_8c.html#a4">UdfUnicodeSelfArray</a>},
00083     { <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/udfdata_8c.html#a5">UdfUnicodeParentArray</a>), <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/udfdata_8c.html#a5">UdfUnicodeParentArray</a>), <a class="code" href="../../d0/d8/udfdata_8c.html#a5">UdfUnicodeParentArray</a>}
00084     };
00085 
00086 <span class="comment">//</span>
00087 <span class="comment">//  Identifier strings defined by UDF.</span>
00088 <span class="comment">//</span>
00089 
<a name="l00090"></a><a class="code" href="../../d0/d8/udfdata_8c.html#a7">00090</a> <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> <a class="code" href="../../d0/d8/udfdata_8c.html#a7">UdfCS0IdentifierArray</a>[] = { <span class="charliteral">'O'</span>, <span class="charliteral">'S'</span>, <span class="charliteral">'T'</span>, <span class="charliteral">'A'</span>, <span class="charliteral">' '</span>,
00091                                  <span class="charliteral">'C'</span>, <span class="charliteral">'o'</span>, <span class="charliteral">'m'</span>, <span class="charliteral">'p'</span>, <span class="charliteral">'r'</span>, <span class="charliteral">'e'</span>, <span class="charliteral">'s'</span>, <span class="charliteral">'s'</span>, <span class="charliteral">'e'</span>, <span class="charliteral">'d'</span>, <span class="charliteral">' '</span>,
00092                                  <span class="charliteral">'U'</span>, <span class="charliteral">'n'</span>, <span class="charliteral">'i'</span>, <span class="charliteral">'c'</span>, <span class="charliteral">'o'</span>, <span class="charliteral">'d'</span>, <span class="charliteral">'e'</span> };
00093 
<a name="l00094"></a><a class="code" href="../../d0/d8/udfdata_8c.html#a8">00094</a> STRING <a class="code" href="../../d0/d8/udfdata_8c.html#a8">UdfCS0Identifier</a> = {
00095     <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/udfdata_8c.html#a7">UdfCS0IdentifierArray</a>),
00096     <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/udfdata_8c.html#a7">UdfCS0IdentifierArray</a>),
00097     <a class="code" href="../../d0/d8/udfdata_8c.html#a7">UdfCS0IdentifierArray</a>
00098     };
00099 
<a name="l00100"></a><a class="code" href="../../d0/d8/udfdata_8c.html#a9">00100</a> <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> <a class="code" href="../../d0/d8/udfdata_8c.html#a9">UdfDomainIdentifierArray</a>[] = { <span class="charliteral">'*'</span>, <span class="charliteral">'O'</span>, <span class="charliteral">'S'</span>, <span class="charliteral">'T'</span>, <span class="charliteral">'A'</span>, <span class="charliteral">' '</span>,
00101                                     <span class="charliteral">'U'</span>, <span class="charliteral">'D'</span>, <span class="charliteral">'F'</span>, <span class="charliteral">' '</span>,
00102                                     <span class="charliteral">'C'</span>, <span class="charliteral">'o'</span>, <span class="charliteral">'m'</span>, <span class="charliteral">'p'</span>, <span class="charliteral">'l'</span>, <span class="charliteral">'i'</span>, <span class="charliteral">'a'</span>, <span class="charliteral">'n'</span>, <span class="charliteral">'t'</span> };
00103 
<a name="l00104"></a><a class="code" href="../../d0/d8/udfdata_8c.html#a10">00104</a> STRING <a class="code" href="../../d0/d8/udfdata_8c.html#a10">UdfDomainIdentifier</a> = {
00105     <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/udfdata_8c.html#a9">UdfDomainIdentifierArray</a>),
00106     <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/udfdata_8c.html#a9">UdfDomainIdentifierArray</a>),
00107     <a class="code" href="../../d0/d8/udfdata_8c.html#a9">UdfDomainIdentifierArray</a>
00108     };
00109 
<a name="l00110"></a><a class="code" href="../../d0/d8/udfdata_8c.html#a11">00110</a> <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> <a class="code" href="../../d0/d8/udfdata_8c.html#a11">UdfVirtualPartitionDomainIdentifierArray</a>[] = { <span class="charliteral">'*'</span>, <span class="charliteral">'U'</span>, <span class="charliteral">'D'</span>, <span class="charliteral">'F'</span>, <span class="charliteral">' '</span>,
00111                                                     <span class="charliteral">'V'</span>, <span class="charliteral">'i'</span>, <span class="charliteral">'r'</span>, <span class="charliteral">'t'</span>, <span class="charliteral">'u'</span>, <span class="charliteral">'a'</span>, <span class="charliteral">'l'</span>, <span class="charliteral">' '</span>,
00112                                                     <span class="charliteral">'P'</span>, <span class="charliteral">'a'</span>, <span class="charliteral">'r'</span>, <span class="charliteral">'t'</span>, <span class="charliteral">'i'</span>, <span class="charliteral">'t'</span>, <span class="charliteral">'i'</span>, <span class="charliteral">'o'</span>, <span class="charliteral">'n'</span> };
00113 
<a name="l00114"></a><a class="code" href="../../d0/d8/udfdata_8c.html#a12">00114</a> STRING <a class="code" href="../../d0/d8/udfdata_8c.html#a12">UdfVirtualPartitionDomainIdentifier</a> = {
00115     <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/udfdata_8c.html#a11">UdfVirtualPartitionDomainIdentifierArray</a>),
00116     <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/udfdata_8c.html#a11">UdfVirtualPartitionDomainIdentifierArray</a>),
00117     <a class="code" href="../../d0/d8/udfdata_8c.html#a11">UdfVirtualPartitionDomainIdentifierArray</a> 
00118     };
00119 
<a name="l00120"></a><a class="code" href="../../d0/d8/udfdata_8c.html#a13">00120</a> <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> <a class="code" href="../../d0/d8/udfdata_8c.html#a13">UdfVatTableIdentifierArray</a>[] = { <span class="charliteral">'*'</span>, <span class="charliteral">'U'</span>, <span class="charliteral">'D'</span>, <span class="charliteral">'F'</span>, <span class="charliteral">' '</span>,
00121                                       <span class="charliteral">'V'</span>, <span class="charliteral">'i'</span>, <span class="charliteral">'r'</span>, <span class="charliteral">'t'</span>, <span class="charliteral">'u'</span>, <span class="charliteral">'a'</span>, <span class="charliteral">'l'</span>, <span class="charliteral">' '</span>,
00122                                       <span class="charliteral">'A'</span>, <span class="charliteral">'l'</span>, <span class="charliteral">'l'</span>, <span class="charliteral">'o'</span>, <span class="charliteral">'c'</span>, <span class="charliteral">' '</span>,
00123                                       <span class="charliteral">'T'</span>, <span class="charliteral">'b'</span>, <span class="charliteral">'l'</span> };
00124 
<a name="l00125"></a><a class="code" href="../../d0/d8/udfdata_8c.html#a14">00125</a> STRING <a class="code" href="../../d0/d8/udfdata_8c.html#a14">UdfVatTableIdentifier</a> = {
00126     <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/udfdata_8c.html#a13">UdfVatTableIdentifierArray</a>),
00127     <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/udfdata_8c.html#a13">UdfVatTableIdentifierArray</a>),
00128     <a class="code" href="../../d0/d8/udfdata_8c.html#a13">UdfVatTableIdentifierArray</a>
00129     };
00130                                     
<a name="l00131"></a><a class="code" href="../../d0/d8/udfdata_8c.html#a15">00131</a> <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> <a class="code" href="../../d0/d8/udfdata_8c.html#a15">UdfSparablePartitionDomainIdentifierArray</a>[] = { <span class="charliteral">'*'</span>, <span class="charliteral">'U'</span>, <span class="charliteral">'D'</span>, <span class="charliteral">'F'</span>, <span class="charliteral">' '</span>,
00132                                                      <span class="charliteral">'S'</span>, <span class="charliteral">'p'</span>, <span class="charliteral">'a'</span>, <span class="charliteral">'r'</span>, <span class="charliteral">'a'</span>, <span class="charliteral">'b'</span>, <span class="charliteral">'l'</span>, <span class="charliteral">'e'</span>, <span class="charliteral">' '</span>,
00133                                                      <span class="charliteral">'P'</span>, <span class="charliteral">'a'</span>, <span class="charliteral">'r'</span>, <span class="charliteral">'t'</span>, <span class="charliteral">'i'</span>, <span class="charliteral">'t'</span>, <span class="charliteral">'i'</span>, <span class="charliteral">'o'</span>, <span class="charliteral">'n'</span> };
00134 
<a name="l00135"></a><a class="code" href="../../d0/d8/udfdata_8c.html#a16">00135</a> STRING <a class="code" href="../../d0/d8/udfdata_8c.html#a16">UdfSparablePartitionDomainIdentifier</a> = {
00136     <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/udfdata_8c.html#a15">UdfSparablePartitionDomainIdentifierArray</a>),
00137     <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/udfdata_8c.html#a15">UdfSparablePartitionDomainIdentifierArray</a>),
00138     <a class="code" href="../../d0/d8/udfdata_8c.html#a15">UdfSparablePartitionDomainIdentifierArray</a>
00139     };
00140 
<a name="l00141"></a><a class="code" href="../../d0/d8/udfdata_8c.html#a17">00141</a> <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> <a class="code" href="../../d0/d8/udfdata_8c.html#a17">UdfSparingTableIdentifierArray</a>[] = { <span class="charliteral">'*'</span>, <span class="charliteral">'U'</span>, <span class="charliteral">'D'</span>, <span class="charliteral">'F'</span>, <span class="charliteral">' '</span>,
00142                                           <span class="charliteral">'S'</span>, <span class="charliteral">'p'</span>, <span class="charliteral">'a'</span>, <span class="charliteral">'r'</span>, <span class="charliteral">'i'</span>, <span class="charliteral">'n'</span>, <span class="charliteral">'g'</span>, <span class="charliteral">' '</span>,
00143                                           <span class="charliteral">'T'</span>, <span class="charliteral">'a'</span>, <span class="charliteral">'b'</span>, <span class="charliteral">'l'</span>, <span class="charliteral">'e'</span> };
00144 
<a name="l00145"></a><a class="code" href="../../d0/d8/udfdata_8c.html#a18">00145</a> STRING <a class="code" href="../../d0/d8/udfdata_8c.html#a18">UdfSparingTableIdentifier</a> = {
00146     <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/udfdata_8c.html#a17">UdfSparingTableIdentifierArray</a>),
00147     <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/udfdata_8c.html#a17">UdfSparingTableIdentifierArray</a>),
00148     <a class="code" href="../../d0/d8/udfdata_8c.html#a17">UdfSparingTableIdentifierArray</a>
00149     };
00150 
<a name="l00151"></a><a class="code" href="../../d0/d8/udfdata_8c.html#a19">00151</a> <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> <a class="code" href="../../d0/d8/udfdata_8c.html#a19">UdfNSR02IdentifierArray</a>[] = <a class="code" href="../../d0/d7/iso13346_8h.html#a73">NSR_PART_CONTID_NSR02</a>;
00152 
<a name="l00153"></a><a class="code" href="../../d0/d8/udfdata_8c.html#a20">00153</a> STRING <a class="code" href="../../d0/d8/udfdata_8c.html#a20">UdfNSR02Identifier</a> = {
00154     <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/udfdata_8c.html#a19">UdfNSR02IdentifierArray</a>),
00155     <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/udfdata_8c.html#a19">UdfNSR02IdentifierArray</a>),
00156     <a class="code" href="../../d0/d8/udfdata_8c.html#a19">UdfNSR02IdentifierArray</a>
00157     };
00158 
00159 <span class="comment">//</span>
00160 <span class="comment">//  Tables of tokens we have to parse up from mount-time on-disk structures</span>
00161 <span class="comment">//</span>
00162 
<a name="l00163"></a><a class="code" href="../../d0/d8/udfdata_8c.html#a21">00163</a> <a class="code" href="../../d2/d8/struct__PARSE__KEYVALUE.html">PARSE_KEYVALUE</a> <a class="code" href="../../d4/d8/udfs__rec_8c.html#a1">VsdIdentParseTable</a>[] = {
00164     { <a class="code" href="../../d5/d8/udfs__rec_8h.html#a2">VSD_IDENT_BEA01</a>, <a class="code" href="../../d5/d8/udfs__rec_8h.html#a30a19">VsdIdentBEA01</a> },
00165     { <a class="code" href="../../d5/d8/udfs__rec_8h.html#a3">VSD_IDENT_TEA01</a>, <a class="code" href="../../d5/d8/udfs__rec_8h.html#a30a20">VsdIdentTEA01</a> },
00166     { <a class="code" href="../../d5/d8/udfs__rec_8h.html#a4">VSD_IDENT_CDROM</a>, <a class="code" href="../../d5/d8/udfs__rec_8h.html#a30a21">VsdIdentCDROM</a> },
00167     { <a class="code" href="../../d5/d8/udfs__rec_8h.html#a5">VSD_IDENT_CD001</a>, <a class="code" href="../../d5/d8/udfs__rec_8h.html#a30a22">VsdIdentCD001</a> },
00168     { <a class="code" href="../../d5/d8/udfs__rec_8h.html#a6">VSD_IDENT_CDW01</a>, <a class="code" href="../../d5/d8/udfs__rec_8h.html#a30a23">VsdIdentCDW01</a> },
00169     { <a class="code" href="../../d5/d8/udfs__rec_8h.html#a7">VSD_IDENT_CDW02</a>, <a class="code" href="../../d5/d8/udfs__rec_8h.html#a30a24">VsdIdentCDW02</a> },
00170     { <a class="code" href="../../d5/d8/udfs__rec_8h.html#a8">VSD_IDENT_NSR01</a>, <a class="code" href="../../d5/d8/udfs__rec_8h.html#a30a25">VsdIdentNSR01</a> },
00171     { <a class="code" href="../../d5/d8/udfs__rec_8h.html#a9">VSD_IDENT_NSR02</a>, <a class="code" href="../../d5/d8/udfs__rec_8h.html#a30a26">VsdIdentNSR02</a> },
00172     { <a class="code" href="../../d5/d8/udfs__rec_8h.html#a10">VSD_IDENT_BOOT2</a>, <a class="code" href="../../d5/d8/udfs__rec_8h.html#a30a27">VsdIdentBOOT2</a> },
00173     { <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,            <a class="code" href="../../d5/d8/udfs__rec_8h.html#a30a18">VsdIdentBad</a> }
00174     };
00175 
<a name="l00176"></a><a class="code" href="../../d0/d8/udfdata_8c.html#a22">00176</a> <a class="code" href="../../d2/d8/struct__PARSE__KEYVALUE.html">PARSE_KEYVALUE</a> <a class="code" href="../../d0/d8/udfdata_8c.html#a22">NsrPartContIdParseTable</a>[] = {
00177     { <a class="code" href="../../d0/d7/iso13346_8h.html#a68">NSR_PART_CONTID_FDC01</a>, <a class="code" href="../../d0/d7/iso13346_8h.html#a279a272">NsrPartContIdFDC01</a> },
00178     { <a class="code" href="../../d0/d7/iso13346_8h.html#a69">NSR_PART_CONTID_CD001</a>, <a class="code" href="../../d0/d7/iso13346_8h.html#a279a273">NsrPartContIdCD001</a> },
00179     { <a class="code" href="../../d0/d7/iso13346_8h.html#a70">NSR_PART_CONTID_CDW01</a>, <a class="code" href="../../d0/d7/iso13346_8h.html#a279a274">NsrPartContIdCDW01</a> },
00180     { <a class="code" href="../../d0/d7/iso13346_8h.html#a71">NSR_PART_CONTID_CDW02</a>, <a class="code" href="../../d0/d7/iso13346_8h.html#a279a275">NsrPartContIdCDW02</a> },
00181     { <a class="code" href="../../d0/d7/iso13346_8h.html#a72">NSR_PART_CONTID_NSR01</a>, <a class="code" href="../../d0/d7/iso13346_8h.html#a279a276">NsrPartContIdNSR01</a> },
00182     { <a class="code" href="../../d0/d7/iso13346_8h.html#a73">NSR_PART_CONTID_NSR02</a>, <a class="code" href="../../d0/d7/iso13346_8h.html#a279a277">NsrPartContIdNSR02</a> },
00183     { <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                  <a class="code" href="../../d0/d7/iso13346_8h.html#a279a271">NsrPartContIdBad</a> }
00184     };
00185 
00186 <span class="comment">//</span>
00187 <span class="comment">//  Lookaside allocation lists for various volatile structures</span>
00188 <span class="comment">//</span>
00189 
<a name="l00190"></a><a class="code" href="../../d0/d8/udfdata_8c.html#a23">00190</a> <a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a> <a class="code" href="../../d0/d8/udfdata_8c.html#a23">UdfFcbNonPagedLookasideList</a>;
<a name="l00191"></a><a class="code" href="../../d0/d8/udfdata_8c.html#a24">00191</a> <a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a> <a class="code" href="../../d0/d8/udfdata_8c.html#a24">UdfIrpContextLookasideList</a>;
00192 
<a name="l00193"></a><a class="code" href="../../d0/d8/udfdata_8c.html#a25">00193</a> <a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html">PAGED_LOOKASIDE_LIST</a> <a class="code" href="../../d0/d8/udfdata_8c.html#a25">UdfCcbLookasideList</a>;
<a name="l00194"></a><a class="code" href="../../d0/d8/udfdata_8c.html#a26">00194</a> <a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html">PAGED_LOOKASIDE_LIST</a> <a class="code" href="../../d0/d8/udfdata_8c.html#a26">UdfFcbIndexLookasideList</a>;
<a name="l00195"></a><a class="code" href="../../d0/d8/udfdata_8c.html#a27">00195</a> <a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html">PAGED_LOOKASIDE_LIST</a> <a class="code" href="../../d0/d8/udfdata_8c.html#a27">UdfFcbDataLookasideList</a>;
<a name="l00196"></a><a class="code" href="../../d0/d8/udfdata_8c.html#a28">00196</a> <a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html">PAGED_LOOKASIDE_LIST</a> <a class="code" href="../../d0/d8/udfdata_8c.html#a28">UdfLcbLookasideList</a>;
00197 
00198 <span class="comment">//</span>
00199 <span class="comment">//  16bit CRC table</span>
00200 <span class="comment">//</span>
00201 
<a name="l00202"></a><a class="code" href="../../d0/d8/udfdata_8c.html#a29">00202</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a> <a class="code" href="../../d0/d8/udfdata_8c.html#a29">UdfCrcTable</a>;
00203 
00204 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00205 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfComputeCrc16)</span>
00206 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfComputeCrc16Uni)</span>
00207 <span class="preprocessor"></span><span class="preprocessor">#ifdef UDF_SANITY</span>
00208 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfDebugTrace)</span>
00209 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00210 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfFastIoCheckIfPossible)</span>
00211 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfHighBit)</span>
00212 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfInitializeCrc16)</span>
00213 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfSerial32)</span>
00214 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00215 <span class="preprocessor"></span>
00216 
00217 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00218"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a126">00218</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a126">UdfFsdDispatch</a> (
00219     IN <a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html">PVOLUME_DEVICE_OBJECT</a> VolumeDeviceObject,
00220     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
00221     )
00222 
00223 <span class="comment">/*++</span>
00224 <span class="comment"></span>
00225 <span class="comment">Routine Description:</span>
00226 <span class="comment"></span>
00227 <span class="comment">    This is the driver entry to all of the Fsd dispatch points.</span>
00228 <span class="comment"></span>
00229 <span class="comment">    Conceptually the Io routine will call this routine on all requests</span>
00230 <span class="comment">    to the file system.  We case on the type of request and invoke the</span>
00231 <span class="comment">    correct handler for this type of request.  There is an exception filter</span>
00232 <span class="comment">    to catch any exceptions in the UDFS code as well as the UDFS process</span>
00233 <span class="comment">    exception routine.</span>
00234 <span class="comment"></span>
00235 <span class="comment">    This routine allocates and initializes the IrpContext for this request as</span>
00236 <span class="comment">    well as updating the top-level thread context as necessary.  We may loop</span>
00237 <span class="comment">    in this routine if we need to retry the request for any reason.  The</span>
00238 <span class="comment">    status code STATUS_CANT_WAIT is used to indicate this.  Suppose the disk</span>
00239 <span class="comment">    in the drive has changed.  An Fsd request will proceed normally until it</span>
00240 <span class="comment">    recognizes this condition.  STATUS_VERIFY_REQUIRED is raised at that point</span>
00241 <span class="comment">    and the exception code will handle the verify and either return</span>
00242 <span class="comment">    STATUS_CANT_WAIT or STATUS_PENDING depending on whether the request was</span>
00243 <span class="comment">    posted.</span>
00244 <span class="comment"></span>
00245 <span class="comment">Arguments:</span>
00246 <span class="comment"></span>
00247 <span class="comment">    VolumeDeviceObject - Supplies the volume device object for this request</span>
00248 <span class="comment"></span>
00249 <span class="comment">    Irp - Supplies the Irp being processed</span>
00250 <span class="comment"></span>
00251 <span class="comment">Return Value:</span>
00252 <span class="comment"></span>
00253 <span class="comment">    NTSTATUS - The FSD status for the IRP</span>
00254 <span class="comment"></span>
00255 <span class="comment">--*/</span>
00256 
00257 {
00258     <a class="code" href="../../d0/d1/struct__THREAD__CONTEXT.html">THREAD_CONTEXT</a> <a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>;
00259     <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00260     BOOLEAN Wait;
00261 
00262 <span class="preprocessor">#ifdef UDF_SANITY</span>
00263 <span class="preprocessor"></span>    PVOID PreviousTopLevel;
00264 <span class="preprocessor">#endif</span>
00265 <span class="preprocessor"></span>
00266     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00267 
00268     KIRQL SaveIrql = KeGetCurrentIrql();
00269 
00270     <a class="code" href="../../d1/d8/udfdata_8h.html#a33">ASSERT_OPTIONAL_IRP</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00271 
00272     <a class="code" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>();
00273 
00274 <span class="preprocessor">#ifdef UDF_SANITY</span>
00275 <span class="preprocessor"></span>    PreviousTopLevel = <a class="code" href="../../d4/d6/iosubs_8c.html#a79">IoGetTopLevelIrp</a>();
00276 <span class="preprocessor">#endif</span>
00277 <span class="preprocessor"></span>
00278     <span class="comment">//</span>
00279     <span class="comment">//  Loop until this request has been completed or posted.</span>
00280     <span class="comment">//</span>
00281 
00282     <span class="keywordflow">do</span> {
00283 
00284         <span class="comment">//</span>
00285         <span class="comment">//  Use a try-except to handle the exception cases.</span>
00286         <span class="comment">//</span>
00287 
00288         <span class="keywordflow">try</span> {
00289 
00290             <span class="comment">//</span>
00291             <span class="comment">//  If the IrpContext is NULL then this is the first pass through</span>
00292             <span class="comment">//  this loop.</span>
00293             <span class="comment">//</span>
00294 
00295             <span class="keywordflow">if</span> (IrpContext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00296 
00297                 <span class="comment">//</span>
00298                 <span class="comment">//  Decide if this request is waitable an allocate the IrpContext.</span>
00299                 <span class="comment">//  If the file object in the stack location is NULL then this</span>
00300                 <span class="comment">//  is a mount which is always waitable.  Otherwise we look at</span>
00301                 <span class="comment">//  the file object flags.</span>
00302                 <span class="comment">//</span>
00303 
00304                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> )-&gt;FileObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00305 
00306                     Wait = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00307 
00308                 } <span class="keywordflow">else</span> {
00309 
00310                     Wait = <a class="code" href="../../d3/d8/udfprocs_8h.html#a62">CanFsdWait</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00311                 }
00312 
00313                 IrpContext = <a class="code" href="../../d3/d8/udfprocs_8h.html#a207">UdfCreateIrpContext</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, Wait );
00314 
00315                 <span class="comment">//</span>
00316                 <span class="comment">//  Update the thread context information.</span>
00317                 <span class="comment">//</span>
00318 
00319                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a130">UdfSetThreadContext</a>( IrpContext, &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a> );
00320 
00321 <span class="preprocessor">#ifdef UDF_SANITY</span>
00322 <span class="preprocessor"></span>                <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !UdfTestTopLevel ||
00323                         <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a12">SafeNodeType</a>( IrpContext-&gt;<a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html#o9">TopLevel</a> ) == <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a7">UDFS_NTC_IRP_CONTEXT</a> );
00324 <span class="preprocessor">#endif</span>
00325 <span class="preprocessor"></span>
00326             <span class="comment">//</span>
00327             <span class="comment">//  Otherwise cleanup the IrpContext for the retry.</span>
00328             <span class="comment">//</span>
00329 
00330             } <span class="keywordflow">else</span> {
00331 
00332                 <span class="comment">//</span>
00333                 <span class="comment">//  Set the MORE_PROCESSING flag to make sure the IrpContext</span>
00334                 <span class="comment">//  isn't inadvertently deleted here.  Then cleanup the</span>
00335                 <span class="comment">//  IrpContext to perform the retry.</span>
00336                 <span class="comment">//</span>
00337 
00338                 <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpContext-&gt;<a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html#o5">Flags</a>, <a class="code" href="../../d6/d8/udfstruc_8h.html#a29">IRP_CONTEXT_FLAG_MORE_PROCESSING</a> );
00339                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a208">UdfCleanupIrpContext</a>( IrpContext, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00340             }
00341 
00342             <span class="comment">//</span>
00343             <span class="comment">//  Case on the major irp code.</span>
00344             <span class="comment">//</span>
00345 
00346             <span class="keywordflow">switch</span> (IrpContext-&gt;<a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html#o10">MajorFunction</a>) {
00347 
00348                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a31">IRP_MJ_CLEANUP</a> :
00349                     
00350                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a251">UdfCommonCleanup</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00351                     <span class="keywordflow">break</span>;
00352     
00353                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a15">IRP_MJ_CLOSE</a> :
00354 
00355                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a252">UdfCommonClose</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00356                     <span class="keywordflow">break</span>;
00357 
00358                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a13">IRP_MJ_CREATE</a> :
00359                     
00360                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a253">UdfCommonCreate</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00361                     <span class="keywordflow">break</span>;
00362     
00363                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a27">IRP_MJ_DEVICE_CONTROL</a> :
00364     
00365                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a254">UdfCommonDevControl</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00366                     <span class="keywordflow">break</span>;
00367     
00368                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a25">IRP_MJ_DIRECTORY_CONTROL</a> :
00369 
00370                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a255">UdfCommonDirControl</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00371                     <span class="keywordflow">break</span>;
00372 
00373                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a26">IRP_MJ_FILE_SYSTEM_CONTROL</a> :
00374     
00375                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a256">UdfCommonFsControl</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00376                     <span class="keywordflow">break</span>;
00377 
00378                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a30">IRP_MJ_LOCK_CONTROL</a> :
00379 
00380                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a257">UdfCommonLockControl</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00381                     <span class="keywordflow">break</span>;
00382 
00383                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a> :
00384 
00385                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a258">UdfCommonPnp</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00386                     <span class="keywordflow">break</span>;
00387 
00388                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a18">IRP_MJ_QUERY_INFORMATION</a> :
00389 
00390                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a259">UdfCommonQueryInfo</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00391                     <span class="keywordflow">break</span>;
00392                 
00393                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a23">IRP_MJ_QUERY_VOLUME_INFORMATION</a> :
00394 
00395                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d6/volinfo_8c.html#a6">UdfCommonQueryVolInfo</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00396                     <span class="keywordflow">break</span>;
00397                 
00398                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a16">IRP_MJ_READ</a> :
00399     
00400                     <span class="comment">//</span>
00401                     <span class="comment">//  If this is an Mdl complete request, don't go through</span>
00402                     <span class="comment">//  common read.</span>
00403                     <span class="comment">//</span>
00404     
00405                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;<a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html#o11">MinorFunction</a>, <a class="code" href="../../d0/d5/io_8h.html#a59">IRP_MN_COMPLETE</a> )) {
00406     
00407                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a156">UdfCompleteMdl</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00408     
00409                     } <span class="keywordflow">else</span> {
00410     
00411                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a261">UdfCommonRead</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00412                     }
00413     
00414                     <span class="keywordflow">break</span>;
00415 
00416                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a19">IRP_MJ_SET_INFORMATION</a> :
00417 
00418                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a262">UdfCommonSetInfo</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00419                     <span class="keywordflow">break</span>;
00420                 
00421                 <span class="keywordflow">default</span> :
00422                             
00423                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_DEVICE_REQUEST;
00424                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00425             }
00426 
00427         } except( <a class="code" href="../../d3/d8/udfprocs_8h.html#a127">UdfExceptionFilter</a>( IrpContext, GetExceptionInformation() )) {
00428 
00429             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a128">UdfProcessException</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, GetExceptionCode() );
00430         }
00431 
00432     } <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_CANT_WAIT);
00433 
00434 <span class="preprocessor">#ifdef UDF_SANITY</span>
00435 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !UdfTestTopLevel ||
00436             (PreviousTopLevel == <a class="code" href="../../d4/d6/iosubs_8c.html#a79">IoGetTopLevelIrp</a>()) );
00437 <span class="preprocessor">#endif</span>
00438 <span class="preprocessor"></span>
00439     <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00440 
00441     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SaveIrql == KeGetCurrentIrql( ));
00442 
00443     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00444 }
00445 
00446 
00447 LONG
<a name="l00448"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a127">00448</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a127">UdfExceptionFilter</a> (
00449     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00450     IN PEXCEPTION_POINTERS ExceptionPointer
00451     )
00452 
00453 <span class="comment">/*++</span>
00454 <span class="comment"></span>
00455 <span class="comment">Routine Description:</span>
00456 <span class="comment"></span>
00457 <span class="comment">    This routine is used to decide whether we will handle a raised exception</span>
00458 <span class="comment">    status.  If UDFS explicitly raised an error then this status is already</span>
00459 <span class="comment">    in the IrpContext.  We choose which is the correct status code and</span>
00460 <span class="comment">    either indicate that we will handle the exception or bug-check the system.</span>
00461 <span class="comment"></span>
00462 <span class="comment">Arguments:</span>
00463 <span class="comment"></span>
00464 <span class="comment">    ExceptionCode - Supplies the exception code to being checked.</span>
00465 <span class="comment"></span>
00466 <span class="comment">Return Value:</span>
00467 <span class="comment"></span>
00468 <span class="comment">    ULONG - returns EXCEPTION_EXECUTE_HANDLER or bugchecks</span>
00469 <span class="comment"></span>
00470 <span class="comment">--*/</span>
00471 
00472 {
00473     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> ExceptionCode;
00474     BOOLEAN TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00475 
00476     <a class="code" href="../../d1/d8/udfdata_8h.html#a29">ASSERT_OPTIONAL_IRP_CONTEXT</a>( IrpContext );
00477 
00478     ExceptionCode = ExceptionPointer-&gt;ExceptionRecord-&gt;ExceptionCode;
00479 
00480     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
00481                  <span class="stringliteral">"UdfExceptionFilter: %08x (exr %08x cxr %08x)\n"</span>,
00482                  ExceptionCode,
00483                  ExceptionPointer-&gt;ExceptionRecord,
00484                  ExceptionPointer-&gt;ContextRecord ));
00485 
00486 
00487     <span class="comment">//</span>
00488     <span class="comment">// If the exception is STATUS_IN_PAGE_ERROR, get the I/O error code</span>
00489     <span class="comment">// from the exception record.</span>
00490     <span class="comment">//</span>
00491 
00492     <span class="keywordflow">if</span> ((ExceptionCode == STATUS_IN_PAGE_ERROR) &amp;&amp;
00493         (ExceptionPointer-&gt;ExceptionRecord-&gt;NumberParameters &gt;= 3)) {
00494 
00495         ExceptionCode = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>) ExceptionPointer-&gt;ExceptionRecord-&gt;ExceptionInformation[2];
00496     }
00497 
00498     <span class="comment">//</span>
00499     <span class="comment">//  If there is an Irp context then check which status code to use.</span>
00500     <span class="comment">//</span>
00501 
00502     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( IrpContext )) {
00503 
00504         <span class="keywordflow">if</span> (IrpContext-&gt;ExceptionStatus == STATUS_SUCCESS) {
00505 
00506             <span class="comment">//</span>
00507             <span class="comment">//  Store the real status into the IrpContext.</span>
00508             <span class="comment">//</span>
00509 
00510             IrpContext-&gt;ExceptionStatus = ExceptionCode;
00511 
00512         } <span class="keywordflow">else</span> {
00513 
00514             <span class="comment">//</span>
00515             <span class="comment">//  No need to test the status code if we raised it ourselves.</span>
00516             <span class="comment">//</span>
00517 
00518             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00519         }
00520     }
00521 
00522     <span class="comment">//</span>
00523     <span class="comment">//  Bug check if this status is not supported.</span>
00524     <span class="comment">//</span>
00525 
00526     <span class="keywordflow">if</span> (TestStatus &amp;&amp; !<a class="code" href="../../d1/d8/fsrtl_8h.html#a137">FsRtlIsNtstatusExpected</a>( ExceptionCode )) {
00527 
00528         <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a66">UdfBugCheck</a>( (ULONG_PTR) ExceptionPointer-&gt;ExceptionRecord,
00529                      (ULONG_PTR) ExceptionPointer-&gt;ContextRecord,
00530                      (ULONG_PTR) ExceptionPointer-&gt;ExceptionRecord-&gt;ExceptionAddress );
00531 
00532     }
00533 
00534     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>;
00535 }
00536 
00537 
00538 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00539"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a128">00539</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a128">UdfProcessException</a> (
00540     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext OPTIONAL,
00541     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp,
00542     IN NTSTATUS ExceptionCode
00543     )
00544 
00545 <span class="comment">/*++</span>
00546 <span class="comment"></span>
00547 <span class="comment">Routine Description:</span>
00548 <span class="comment"></span>
00549 <span class="comment">    This routine processes an exception.  It either completes the request</span>
00550 <span class="comment">    with the exception status in the IrpContext, sends this off to the Fsp</span>
00551 <span class="comment">    workque or causes it to be retried in the current thread if a verification</span>
00552 <span class="comment">    is needed.</span>
00553 <span class="comment"></span>
00554 <span class="comment">    If the volume needs to be verified (STATUS_VERIFY_REQUIRED) and we can</span>
00555 <span class="comment">    do the work in the current thread we will translate the status code</span>
00556 <span class="comment">    to STATUS_CANT_WAIT to indicate that we need to retry the request.</span>
00557 <span class="comment"></span>
00558 <span class="comment">Arguments:</span>
00559 <span class="comment"></span>
00560 <span class="comment">    Irp - Supplies the Irp being processed</span>
00561 <span class="comment"></span>
00562 <span class="comment">    ExceptionCode - Supplies the normalized exception status being handled</span>
00563 <span class="comment"></span>
00564 <span class="comment">Return Value:</span>
00565 <span class="comment"></span>
00566 <span class="comment">    NTSTATUS - Returns the results of either posting the Irp or the</span>
00567 <span class="comment">        saved completion status.</span>
00568 <span class="comment"></span>
00569 <span class="comment">--*/</span>
00570 
00571 {
00572     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> Device;
00573     <a class="code" href="../../d7/d7/struct__VPB.html">PVPB</a> Vpb;
00574     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00575 
00576     <a class="code" href="../../d1/d8/udfdata_8h.html#a29">ASSERT_OPTIONAL_IRP_CONTEXT</a>( IrpContext );
00577     <a class="code" href="../../d1/d8/udfdata_8h.html#a32">ASSERT_IRP</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00578 
00579     <span class="comment">//</span>
00580     <span class="comment">//  If there is not an irp context, then complete the request with the</span>
00581     <span class="comment">//  current status code.</span>
00582     <span class="comment">//</span>
00583 
00584     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( IrpContext )) {
00585 
00586         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, ExceptionCode );
00587         <span class="keywordflow">return</span> ExceptionCode;
00588     }
00589 
00590     <span class="comment">//</span>
00591     <span class="comment">//  Get the real exception status from the IrpContext.</span>
00592     <span class="comment">//</span>
00593 
00594     ExceptionCode = IrpContext-&gt;ExceptionStatus;
00595 
00596     <span class="comment">//</span>
00597     <span class="comment">//  If we are not a top level request then we just complete the request</span>
00598     <span class="comment">//  with the current status code.</span>
00599     <span class="comment">//</span>
00600 
00601     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a32">IRP_CONTEXT_FLAG_TOP_LEVEL</a> )) {
00602 
00603         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, ExceptionCode );
00604 
00605         <span class="keywordflow">return</span> ExceptionCode;
00606     }
00607 
00608     <span class="comment">//</span>
00609     <span class="comment">//  Check if we are posting this request.  One of the following must be true</span>
00610     <span class="comment">//  if we are to post a request.</span>
00611     <span class="comment">//</span>
00612     <span class="comment">//      - Status code is STATUS_CANT_WAIT and the request is asynchronous</span>
00613     <span class="comment">//          or we are forcing this to be posted.</span>
00614     <span class="comment">//</span>
00615     <span class="comment">//      - Status code is STATUS_VERIFY_REQUIRED and we are at APC level</span>
00616     <span class="comment">//          or higher.  Can't wait for IO in the verify path in this case.</span>
00617     <span class="comment">//</span>
00618     <span class="comment">//  Set the MORE_PROCESSING flag in the IrpContext to keep if from being</span>
00619     <span class="comment">//  deleted if this is a retryable condition.</span>
00620     <span class="comment">//</span>
00621     <span class="comment">//  Note:  Children of UdfFsdPostRequest() can raise.</span>
00622     <span class="comment">//</span>
00623 
00624     <span class="keywordflow">try</span> {
00625     
00626         <span class="keywordflow">if</span> (ExceptionCode == STATUS_CANT_WAIT) {
00627 
00628             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a31">IRP_CONTEXT_FLAG_FORCE_POST</a> )) {
00629 
00630                 ExceptionCode = <a class="code" href="../../d2/d9/workque_8c.html#a4">UdfFsdPostRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00631             }
00632 
00633         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ExceptionCode == STATUS_VERIFY_REQUIRED) {
00634 
00635             <span class="keywordflow">if</span> (KeGetCurrentIrql() &gt;= <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) {
00636 
00637                 ExceptionCode = <a class="code" href="../../d2/d9/workque_8c.html#a4">UdfFsdPostRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00638             }
00639         }
00640     }
00641     except (<a class="code" href="../../d3/d8/udfprocs_8h.html#a127">UdfExceptionFilter</a>( IrpContext, GetExceptionInformation()))  {
00642     
00643         ExceptionCode = GetExceptionCode(); 
00644     }
00645 
00646     <span class="comment">//</span>
00647     <span class="comment">//  If we posted the request or our caller will retry then just return here.</span>
00648     <span class="comment">//</span>
00649 
00650     <span class="keywordflow">if</span> ((ExceptionCode == STATUS_PENDING) ||
00651         (ExceptionCode == STATUS_CANT_WAIT)) {
00652 
00653         <span class="keywordflow">return</span> ExceptionCode;
00654     }
00655 
00656     <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( IrpContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a29">IRP_CONTEXT_FLAG_MORE_PROCESSING</a> );
00657 
00658     <span class="comment">//</span>
00659     <span class="comment">//  Store this error into the Irp for posting back to the Io system.</span>
00660     <span class="comment">//</span>
00661 
00662     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = ExceptionCode;
00663 
00664     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/io_8h.html#a232">IoIsErrorUserInduced</a>( ExceptionCode )) {
00665 
00666         <span class="comment">//</span>
00667         <span class="comment">//  Check for the various error conditions that can be caused by,</span>
00668         <span class="comment">//  and possibly resolved my the user.</span>
00669         <span class="comment">//</span>
00670 
00671         <span class="keywordflow">if</span> (ExceptionCode == STATUS_VERIFY_REQUIRED) {
00672 
00673             <span class="comment">//</span>
00674             <span class="comment">//  Now we are at the top level file system entry point.</span>
00675             <span class="comment">//</span>
00676             <span class="comment">//  If we have already posted this request then the device to</span>
00677             <span class="comment">//  verify is in the original thread.  Find this via the Irp.</span>
00678             <span class="comment">//</span>
00679 
00680             Device = <a class="code" href="../../d4/d6/iosubs_8c.html#a72">IoGetDeviceToVerify</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread );
00681             <a class="code" href="../../d4/d6/iosubs_8c.html#a104">IoSetDeviceToVerify</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00682 
00683             <span class="comment">//</span>
00684             <span class="comment">//  If there is no device in that location then check in the</span>
00685             <span class="comment">//  current thread.</span>
00686             <span class="comment">//</span>
00687 
00688             <span class="keywordflow">if</span> (Device == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00689 
00690                 Device = <a class="code" href="../../d4/d6/iosubs_8c.html#a72">IoGetDeviceToVerify</a>( <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>() );
00691                 <a class="code" href="../../d4/d6/iosubs_8c.html#a104">IoSetDeviceToVerify</a>( <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>(), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00692 
00693                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Device != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00694 
00695                 <span class="comment">//</span>
00696                 <span class="comment">//  Let's not BugCheck just because the driver screwed up.</span>
00697                 <span class="comment">//</span>
00698 
00699                 <span class="keywordflow">if</span> (Device == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00700 
00701                     ExceptionCode = STATUS_DRIVER_INTERNAL_ERROR;
00702 
00703                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, ExceptionCode );
00704 
00705                     <span class="keywordflow">return</span> ExceptionCode;
00706                 }
00707             }
00708 
00709             <span class="comment">//</span>
00710             <span class="comment">//  CdPerformVerify() will do the right thing with the Irp.</span>
00711             <span class="comment">//  If we return STATUS_CANT_WAIT then the current thread</span>
00712             <span class="comment">//  can retry the request.</span>
00713             <span class="comment">//</span>
00714 
00715             <span class="keywordflow">return</span> <a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a2">UdfPerformVerify</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, Device );
00716         }
00717 
00718         <span class="comment">//</span>
00719         <span class="comment">//  The other user induced conditions generate an error unless</span>
00720         <span class="comment">//  they have been disabled for this request.</span>
00721         <span class="comment">//</span>
00722 
00723         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a37">IRP_CONTEXT_FLAG_DISABLE_POPUPS</a> )) {
00724 
00725             <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, ExceptionCode );
00726 
00727             <span class="keywordflow">return</span> ExceptionCode;
00728 
00729         } <span class="keywordflow">else</span> {
00730 
00731             <span class="comment">//</span>
00732             <span class="comment">//  Generate a pop-up</span>
00733             <span class="comment">//</span>
00734 
00735             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> )-&gt;FileObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00736 
00737                 Vpb = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> )-&gt;FileObject-&gt;Vpb;
00738 
00739             } <span class="keywordflow">else</span> {
00740 
00741                 Vpb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00742             }
00743 
00744             <span class="comment">//</span>
00745             <span class="comment">//  The device to verify is either in my thread local storage</span>
00746             <span class="comment">//  or that of the thread that owns the Irp.</span>
00747             <span class="comment">//</span>
00748 
00749             Thread = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread;
00750             Device = <a class="code" href="../../d4/d6/iosubs_8c.html#a72">IoGetDeviceToVerify</a>( Thread );
00751 
00752             <span class="keywordflow">if</span> (Device == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00753 
00754                 Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00755                 Device = <a class="code" href="../../d4/d6/iosubs_8c.html#a72">IoGetDeviceToVerify</a>( Thread );
00756 
00757                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Device != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00758 
00759                 <span class="comment">//</span>
00760                 <span class="comment">//  Let's not BugCheck just because the driver screwed up.</span>
00761                 <span class="comment">//</span>
00762 
00763                 <span class="keywordflow">if</span> (Device == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00764 
00765                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, ExceptionCode );
00766 
00767                     <span class="keywordflow">return</span> ExceptionCode;
00768                 }
00769             }
00770 
00771             <span class="comment">//</span>
00772             <span class="comment">//  This routine actually causes the pop-up.  It usually</span>
00773             <span class="comment">//  does this by queuing an APC to the callers thread,</span>
00774             <span class="comment">//  but in some cases it will complete the request immediately,</span>
00775             <span class="comment">//  so it is very important to IoMarkIrpPending() first.</span>
00776             <span class="comment">//</span>
00777 
00778             <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00779             <a class="code" href="../../d4/d6/iosubs_8c.html#a93">IoRaiseHardError</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, Vpb, Device );
00780 
00781             <span class="comment">//</span>
00782             <span class="comment">//  We will be handing control back to the caller here, so</span>
00783             <span class="comment">//  reset the saved device object.</span>
00784             <span class="comment">//</span>
00785 
00786             <a class="code" href="../../d4/d6/iosubs_8c.html#a104">IoSetDeviceToVerify</a>( Thread, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00787 
00788             <span class="comment">//</span>
00789             <span class="comment">//  The Irp will be completed by Io or resubmitted.  In either</span>
00790             <span class="comment">//  case we must clean up the IrpContext here.</span>
00791             <span class="comment">//</span>
00792 
00793             <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, STATUS_SUCCESS );
00794             <span class="keywordflow">return</span> STATUS_PENDING;
00795         }
00796     }
00797 
00798     <span class="comment">//</span>
00799     <span class="comment">//  This is just a run of the mill error.</span>
00800     <span class="comment">//</span>
00801 
00802     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, ExceptionCode );
00803 
00804     <span class="keywordflow">return</span> ExceptionCode;
00805 }
00806 
00807 
00808 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00809"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a129">00809</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a> (
00810     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext OPTIONAL,
00811     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp OPTIONAL,
00812     IN NTSTATUS Status
00813     )
00814 
00815 <span class="comment">/*++</span>
00816 <span class="comment"></span>
00817 <span class="comment">Routine Description:</span>
00818 <span class="comment"></span>
00819 <span class="comment">    This routine completes a Irp and cleans up the IrpContext.  Either or</span>
00820 <span class="comment">    both of these may not be specified.</span>
00821 <span class="comment"></span>
00822 <span class="comment">Arguments:</span>
00823 <span class="comment"></span>
00824 <span class="comment">    Irp - Supplies the Irp being processed.</span>
00825 <span class="comment"></span>
00826 <span class="comment">    Status - Supplies the status to complete the Irp with</span>
00827 <span class="comment"></span>
00828 <span class="comment">Return Value:</span>
00829 <span class="comment"></span>
00830 <span class="comment">    None.</span>
00831 <span class="comment"></span>
00832 <span class="comment">--*/</span>
00833 
00834 {
00835     <a class="code" href="../../d1/d8/udfdata_8h.html#a29">ASSERT_OPTIONAL_IRP_CONTEXT</a>( IrpContext );
00836     <a class="code" href="../../d1/d8/udfdata_8h.html#a33">ASSERT_OPTIONAL_IRP</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00837 
00838     <span class="comment">//</span>
00839     <span class="comment">//  Cleanup the IrpContext if passed in here.</span>
00840     <span class="comment">//</span>
00841 
00842     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( IrpContext )) {
00843 
00844         <a class="code" href="../../d3/d8/udfprocs_8h.html#a208">UdfCleanupIrpContext</a>( IrpContext, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00845     }
00846 
00847     <span class="comment">//</span>
00848     <span class="comment">//  If we have an Irp then complete the irp.</span>
00849     <span class="comment">//</span>
00850 
00851     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> )) {
00852 
00853         <span class="comment">//</span>
00854         <span class="comment">//  Clear the information field in case we have used this Irp</span>
00855         <span class="comment">//  internally.</span>
00856         <span class="comment">//</span>
00857 
00858         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) &amp;&amp;
00859             <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a>, <a class="code" href="../../d0/d5/io_8h.html#a180">IRP_INPUT_OPERATION</a> )) {
00860 
00861             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = 0;
00862         }
00863 
00864         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00865         <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d7/d8/exboosts_8h.html#a4">IO_CD_ROM_INCREMENT</a> );
00866     }
00867 
00868     <span class="keywordflow">return</span>;
00869 }
00870 
00871 
00872 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00873"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a130">00873</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a130">UdfSetThreadContext</a> (
00874     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00875     IN <a class="code" href="../../d0/d1/struct__THREAD__CONTEXT.html">PTHREAD_CONTEXT</a> ThreadContext
00876     )
00877 
00878 <span class="comment">/*++</span>
00879 <span class="comment"></span>
00880 <span class="comment">Routine Description:</span>
00881 <span class="comment"></span>
00882 <span class="comment">    This routine is called at each Fsd/Fsp entry point set up the IrpContext</span>
00883 <span class="comment">    and thread local storage to track top level requests.  If there is</span>
00884 <span class="comment">    not a Udfs context in the thread local storage then we use the input one.</span>
00885 <span class="comment">    Otherwise we use the one already there.  This routine also updates the</span>
00886 <span class="comment">    IrpContext based on the state of the top-level context.</span>
00887 <span class="comment"></span>
00888 <span class="comment">    If the TOP_LEVEL flag in the IrpContext is already set when we are called</span>
00889 <span class="comment">    then we force this request to appear top level.</span>
00890 <span class="comment"></span>
00891 <span class="comment">Arguments:</span>
00892 <span class="comment"></span>
00893 <span class="comment">    ThreadContext - Address on stack for local storage if not already present.</span>
00894 <span class="comment"></span>
00895 <span class="comment">    ForceTopLevel - We force this request to appear top level regardless of</span>
00896 <span class="comment">        any previous stack value.</span>
00897 <span class="comment"></span>
00898 <span class="comment">Return Value:</span>
00899 <span class="comment"></span>
00900 <span class="comment">    None</span>
00901 <span class="comment"></span>
00902 <span class="comment">--*/</span>
00903 
00904 {
00905     <a class="code" href="../../d0/d1/struct__THREAD__CONTEXT.html">PTHREAD_CONTEXT</a> CurrentThreadContext;
00906     ULONG_PTR StackTop;
00907     ULONG_PTR StackBottom;
00908 
00909     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00910 
00911     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00912 
00913     <span class="comment">//</span>
00914     <span class="comment">//  Get the current top-level irp out of the thread storage.</span>
00915     <span class="comment">//  If NULL then this is the top-level request.</span>
00916     <span class="comment">//</span>
00917 
00918     CurrentThreadContext = (<a class="code" href="../../d0/d1/struct__THREAD__CONTEXT.html">PTHREAD_CONTEXT</a>) <a class="code" href="../../d4/d6/iosubs_8c.html#a79">IoGetTopLevelIrp</a>();
00919 
00920     <span class="keywordflow">if</span> (CurrentThreadContext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00921 
00922         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a32">IRP_CONTEXT_FLAG_TOP_LEVEL</a> );
00923     }
00924 
00925     <span class="comment">//</span>
00926     <span class="comment">//  Initialize the input context unless we are using the current</span>
00927     <span class="comment">//  thread context block.  We use the new block if our caller</span>
00928     <span class="comment">//  specified this or the existing block is invalid.</span>
00929     <span class="comment">//</span>
00930     <span class="comment">//  The following must be true for the current to be a valid Udfs context.</span>
00931     <span class="comment">//</span>
00932     <span class="comment">//      Structure must lie within current stack.</span>
00933     <span class="comment">//      Address must be ULONG aligned.</span>
00934     <span class="comment">//      Udfs signature must be present.</span>
00935     <span class="comment">//</span>
00936     <span class="comment">//  If this is not a valid Udfs context then use the input thread</span>
00937     <span class="comment">//  context and store it in the top level context.</span>
00938     <span class="comment">//</span>
00939 
00940     <a class="code" href="../../d0/d5/io_8h.html#a508">IoGetStackLimits</a>( &amp;StackTop, &amp;StackBottom);
00941 
00942     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a32">IRP_CONTEXT_FLAG_TOP_LEVEL</a> ) ||
00943         (((ULONG_PTR) CurrentThreadContext &gt; StackBottom - <span class="keyword">sizeof</span>( <a class="code" href="../../d0/d1/struct__THREAD__CONTEXT.html">THREAD_CONTEXT</a> )) ||
00944          ((ULONG_PTR) CurrentThreadContext &lt;= StackTop) ||
00945          <a class="code" href="../../d3/d8/udfprocs_8h.html#a30">LongOffsetPtr</a>( CurrentThreadContext ) ||
00946          (CurrentThreadContext-&gt;<a class="code" href="../../d0/d1/struct__THREAD__CONTEXT.html#o0">Udfs</a> != <a class="code" href="../../d1/d8/udfdata_8h.html#a4">UDFS_SIGNATURE</a>))) {
00947 
00948         <a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>-&gt;Udfs = <a class="code" href="../../d1/d8/udfdata_8h.html#a4">UDFS_SIGNATURE</a>;
00949         <a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>-&gt;SavedTopLevelIrp = (<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>) CurrentThreadContext;
00950         <a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>-&gt;TopLevelIrpContext = IrpContext;
00951         <a class="code" href="../../d4/d6/iosubs_8c.html#a109">IoSetTopLevelIrp</a>( (<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>) <a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a> );
00952 
00953         IrpContext-&gt;TopLevel = IrpContext;
00954         IrpContext-&gt;ThreadContext = <a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>;
00955 
00956         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a33">IRP_CONTEXT_FLAG_TOP_LEVEL_UDFS</a> );
00957 
00958     <span class="comment">//</span>
00959     <span class="comment">//  Otherwise use the IrpContext in the thread context.</span>
00960     <span class="comment">//</span>
00961 
00962     } <span class="keywordflow">else</span> {
00963 
00964         IrpContext-&gt;TopLevel = CurrentThreadContext-&gt;<a class="code" href="../../d0/d1/struct__THREAD__CONTEXT.html#o2">TopLevelIrpContext</a>;
00965     }
00966 
00967     <span class="keywordflow">return</span>;
00968 }
00969 
00970 
00971 BOOLEAN
<a name="l00972"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a138">00972</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a138">UdfFastIoCheckIfPossible</a> (
00973     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject,
00974     IN PLARGE_INTEGER FileOffset,
00975     IN ULONG Length,
00976     IN BOOLEAN Wait,
00977     IN ULONG LockKey,
00978     IN BOOLEAN CheckForReadOperation,
00979     OUT PIO_STATUS_BLOCK IoStatus,
00980     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject
00981     )
00982 
00983 <span class="comment">/*++</span>
00984 <span class="comment"></span>
00985 <span class="comment">Routine Description:</span>
00986 <span class="comment"></span>
00987 <span class="comment">    This routine checks if fast i/o is possible for a read/write operation</span>
00988 <span class="comment"></span>
00989 <span class="comment">Arguments:</span>
00990 <span class="comment"></span>
00991 <span class="comment">    FileObject - Supplies the file object used in the query</span>
00992 <span class="comment"></span>
00993 <span class="comment">    FileOffset - Supplies the starting byte offset for the read/write operation</span>
00994 <span class="comment"></span>
00995 <span class="comment">    Length - Supplies the length, in bytes, of the read/write operation</span>
00996 <span class="comment"></span>
00997 <span class="comment">    Wait - Indicates if we can wait</span>
00998 <span class="comment"></span>
00999 <span class="comment">    LockKey - Supplies the lock key</span>
01000 <span class="comment"></span>
01001 <span class="comment">    CheckForReadOperation - Indicates if this is a check for a read or write</span>
01002 <span class="comment">        operation</span>
01003 <span class="comment"></span>
01004 <span class="comment">    IoStatus - Receives the status of the operation if our return value is</span>
01005 <span class="comment">        FastIoReturnError</span>
01006 <span class="comment"></span>
01007 <span class="comment">Return Value:</span>
01008 <span class="comment"></span>
01009 <span class="comment">    BOOLEAN - TRUE if fast I/O is possible and FALSE if the caller needs</span>
01010 <span class="comment">        to take the long route.</span>
01011 <span class="comment"></span>
01012 <span class="comment">--*/</span>
01013 
01014 {
01015     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01016 
01017     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01018 }
01019 
01020 
01021 ULONG
<a name="l01022"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a132">01022</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a132">UdfSerial32</a> (
01023     IN PCHAR Buffer,
01024     IN ULONG ByteCount
01025     )
01026 
01027 <span class="comment">/*++</span>
01028 <span class="comment"></span>
01029 <span class="comment">Routine Description:</span>
01030 <span class="comment"></span>
01031 <span class="comment">    This routine is called to generate a 32 bit serial number.  This is</span>
01032 <span class="comment">    done by doing four separate checksums into an array of bytes and</span>
01033 <span class="comment">    then treating the bytes as a ULONG.</span>
01034 <span class="comment"></span>
01035 <span class="comment">Arguments:</span>
01036 <span class="comment"></span>
01037 <span class="comment">    Buffer - Pointer to the buffer to generate the ID for.</span>
01038 <span class="comment"></span>
01039 <span class="comment">    ByteCount - Number of bytes in the buffer.</span>
01040 <span class="comment"></span>
01041 <span class="comment">Return Value:</span>
01042 <span class="comment"></span>
01043 <span class="comment">    ULONG - The 32 bit serial number.</span>
01044 <span class="comment"></span>
01045 <span class="comment">--*/</span>
01046 
01047 {
01048     <span class="keyword">union </span>{
01049         UCHAR   Bytes[4];
01050         ULONG   <a class="code" href="../../d2/d5/mapper_8c.html#a30">SerialId</a>;
01051     } Checksum;
01052 
01053     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01054 
01055     <span class="comment">//</span>
01056     <span class="comment">//  Initialize the serial number.</span>
01057     <span class="comment">//</span>
01058 
01059     Checksum.SerialId = 0;
01060 
01061     <span class="comment">//</span>
01062     <span class="comment">//  Continue while there are more bytes to use.</span>
01063     <span class="comment">//</span>
01064 
01065     <span class="keywordflow">while</span> (ByteCount--) {
01066 
01067         <span class="comment">//</span>
01068         <span class="comment">//  Increment this sub-checksum.</span>
01069         <span class="comment">//</span>
01070 
01071         Checksum.Bytes[ByteCount &amp; 0x3] += *(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>++);
01072     }
01073 
01074     <span class="comment">//</span>
01075     <span class="comment">//  Return the checksums as a ULONG.</span>
01076     <span class="comment">//</span>
01077 
01078     <span class="keywordflow">return</span> Checksum.SerialId;
01079 }
01080 
01081 
01082 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01083"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a133">01083</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a133">UdfInitializeCrc16</a> (
01084     ULONG Polynomial
01085     )
01086 
01087 <span class="comment">/*++</span>
01088 <span class="comment"></span>
01089 <span class="comment">Routine Description:</span>
01090 <span class="comment"></span>
01091 <span class="comment">    This routine generates the 16bit CRC Table to be used in CRC calculation.</span>
01092 <span class="comment"></span>
01093 <span class="comment">Arguments:</span>
01094 <span class="comment"></span>
01095 <span class="comment">    Polynomial - Starting seed for the generation</span>
01096 <span class="comment"></span>
01097 <span class="comment">Return Value:</span>
01098 <span class="comment"></span>
01099 <span class="comment">    None</span>
01100 <span class="comment"></span>
01101 <span class="comment">--*/</span>
01102 
01103 {
01104     ULONG <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>, i, Crc;
01105 
01106     <span class="comment">//</span>
01107     <span class="comment">//  All CRC code was devised by Don P. Mitchell of AT&amp;T Bell Laboratories</span>
01108     <span class="comment">//  and Ned W. Rhodes of Software Systems Group.  It has been published in</span>
01109     <span class="comment">//  "Design and Validation of Computer Protocols", Prentice Hall, Englewood</span>
01110     <span class="comment">//  Cliffs, NJ, 1991, Chapter 3, ISBN 0-13-539925-4.</span>
01111     <span class="comment">//</span>
01112     <span class="comment">//  Copyright is held by AT&amp;T.</span>
01113     <span class="comment">//</span>
01114     <span class="comment">//  AT&amp;T gives permission for the free use of the source code.</span>
01115     <span class="comment">//</span>
01116 
01117     <a class="code" href="../../d0/d8/udfdata_8c.html#a29">UdfCrcTable</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>) <a class="code" href="../../d1/d8/fsrtl_8h.html#a37">FsRtlAllocatePoolWithTag</a>( <a class="code" href="../../d3/d8/udfprocs_8h.html#a65">UdfPagedPool</a>,
01118                                                       256 * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>),
01119                                                       <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a69">TAG_CRC_TABLE</a> );
01120 
01121     <span class="keywordflow">for</span> (<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = 0; <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> &lt; 256; <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>++) {
01122 
01123         Crc = <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> &lt;&lt; 8;
01124 
01125         <span class="keywordflow">for</span> (i = 0; i &lt; 8; i++) {
01126 
01127             <span class="keywordflow">if</span>(Crc &amp; 0x8000) {
01128 
01129                 Crc = (Crc &lt;&lt; 1) ^ Polynomial;
01130 
01131             } <span class="keywordflow">else</span> {
01132 
01133                 Crc &lt;&lt;= 1;
01134             }
01135 
01136             Crc &amp;= 0xffff;
01137         }
01138 
01139         <a class="code" href="../../d0/d8/udfdata_8c.html#a29">UdfCrcTable</a>[<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>] = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) Crc;
01140     }
01141 }
01142 
01143 
01144 
01145 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>
<a name="l01146"></a><a class="code" href="../../d0/d8/udfdata_8c.html#a38">01146</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a134">UdfComputeCrc16</a> (
01147         PUCHAR Buffer,
01148         ULONG ByteCount
01149     )
01150 
01151 <span class="comment">/*++</span>
01152 <span class="comment"></span>
01153 <span class="comment">Routine Description:</span>
01154 <span class="comment"></span>
01155 <span class="comment">    This routine generates a 16 bit CRC of the input buffer in accordance</span>
01156 <span class="comment">    with the precomputed CRC table.</span>
01157 <span class="comment"></span>
01158 <span class="comment">Arguments:</span>
01159 <span class="comment"></span>
01160 <span class="comment">    Buffer - Pointer to the buffer to generate the CRC for.</span>
01161 <span class="comment"></span>
01162 <span class="comment">    ByteCount - Number of bytes in the buffer.</span>
01163 <span class="comment"></span>
01164 <span class="comment">Return Value:</span>
01165 <span class="comment"></span>
01166 <span class="comment">    USHORT - The 16bit CRC</span>
01167 <span class="comment"></span>
01168 <span class="comment">--*/</span>
01169 
01170 {
01171         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Crc = 0;
01172 
01173     <span class="comment">//</span>
01174     <span class="comment">//  All CRC code was devised by Don P. Mitchell of AT&amp;T Bell Laboratories</span>
01175     <span class="comment">//  and Ned W. Rhodes of Software Systems Group.  It has been published in</span>
01176     <span class="comment">//  "Design and Validation of Computer Protocols", Prentice Hall, Englewood</span>
01177     <span class="comment">//  Cliffs, NJ, 1991, Chapter 3, ISBN 0-13-539925-4.</span>
01178     <span class="comment">//</span>
01179     <span class="comment">//  Copyright is held by AT&amp;T.</span>
01180     <span class="comment">//</span>
01181     <span class="comment">//  AT&amp;T gives permission for the free use of the source code.</span>
01182     <span class="comment">//</span>
01183 
01184     <span class="keywordflow">while</span> (ByteCount-- &gt; 0) {
01185 
01186         Crc = <a class="code" href="../../d0/d8/udfdata_8c.html#a29">UdfCrcTable</a>[((Crc &gt;&gt; 8) ^ *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>++) &amp; 0xff] ^ (Crc &lt;&lt; 8);
01187     }
01188 
01189         <span class="keywordflow">return</span> Crc;
01190 }
01191 
01192 
01193 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>
<a name="l01194"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a135">01194</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a135">UdfComputeCrc16Uni</a> (
01195     PWCHAR Buffer,
01196     ULONG CharCount
01197     )
01198 
01199 <span class="comment">/*++</span>
01200 <span class="comment"></span>
01201 <span class="comment">Routine Description:</span>
01202 <span class="comment"></span>
01203 <span class="comment">    This routine generates a 16 bit CRC of the input buffer in accordance</span>
01204 <span class="comment">    with the precomputed CRC table.</span>
01205 <span class="comment">    </span>
01206 <span class="comment">    It performs a byte-order independent crc (hi then lo). This is a bit</span>
01207 <span class="comment">    suspect, but is called for in the specification. </span>
01208 <span class="comment"></span>
01209 <span class="comment">Arguments:</span>
01210 <span class="comment"></span>
01211 <span class="comment">    Buffer - Pointer to the buffer to generate the CRC for.</span>
01212 <span class="comment"></span>
01213 <span class="comment">    ShortCount - Number of wide characters in the buffer.</span>
01214 <span class="comment"></span>
01215 <span class="comment">Return Value:</span>
01216 <span class="comment"></span>
01217 <span class="comment">    USHORT - The 16bit CRC</span>
01218 <span class="comment"></span>
01219 <span class="comment">--*/</span>
01220 
01221 {
01222     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Crc = 0;
01223 
01224     <span class="comment">//</span>
01225     <span class="comment">//  Byte order independent CRC, hi byte to low byte per character.</span>
01226     <span class="comment">//</span>
01227 
01228     <span class="keywordflow">while</span> (CharCount-- &gt; 0) {
01229 
01230         Crc = <a class="code" href="../../d0/d8/udfdata_8c.html#a29">UdfCrcTable</a>[((Crc &gt;&gt; 8) ^ (*<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> &gt;&gt; 8)) &amp; 0xff] ^ (Crc &lt;&lt; 8);
01231         Crc = <a class="code" href="../../d0/d8/udfdata_8c.html#a29">UdfCrcTable</a>[((Crc &gt;&gt; 8) ^ (*<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>++ &amp; 0xff)) &amp; 0xff] ^ (Crc &lt;&lt; 8);
01232     }
01233 
01234     <span class="keywordflow">return</span> Crc;
01235 }
01236 
01237 
01238 ULONG
<a name="l01239"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a136">01239</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a136">UdfHighBit</a> (
01240     ULONG Word
01241     )
01242 
01243 <span class="comment">/*++</span>
01244 <span class="comment"></span>
01245 <span class="comment">Routine Description:</span>
01246 <span class="comment"></span>
01247 <span class="comment">    This routine discovers the highest set bit of the input word.  It is</span>
01248 <span class="comment">    equivalent to the integer logarithim base 2.</span>
01249 <span class="comment"></span>
01250 <span class="comment">Arguments:</span>
01251 <span class="comment"></span>
01252 <span class="comment">    Word - word to check</span>
01253 <span class="comment"></span>
01254 <span class="comment">Return Value:</span>
01255 <span class="comment"></span>
01256 <span class="comment">    Bit offset of highest set bit. If no bit is set, return is zero.</span>
01257 <span class="comment"></span>
01258 <span class="comment">--*/</span>
01259 
01260 {
01261     ULONG <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = 31;
01262     ULONG Mask = (ULONG)(1 &lt;&lt; 31);
01263 
01264     <span class="keywordflow">if</span> (Word == 0) {
01265 
01266         <span class="keywordflow">return</span> 0;
01267     }
01268 
01269     <span class="keywordflow">while</span> ((Word &amp; Mask) == 0) {
01270 
01271         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>--;
01272         Mask &gt;&gt;= 1;
01273     }
01274 
01275     <span class="keywordflow">return</span> <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01276 }
01277 
01278 
01279 <span class="preprocessor">#ifdef UDF_SANITY</span>
01280 <span class="preprocessor"></span>BOOLEAN
01281 UdfDebugTrace (
01282     LONG IndentIncrement,
01283     ULONG TraceMask,
01284     PCHAR Format,
01285     ...
01286     )
01287 
01288 <span class="comment">/*++</span>
01289 <span class="comment"></span>
01290 <span class="comment">Routine Description:</span>
01291 <span class="comment"></span>
01292 <span class="comment">    This routine is a simple debug info printer that returns a constant boolean value.  This</span>
01293 <span class="comment">    makes it possible to splice it into the middle of boolean expressions to discover which</span>
01294 <span class="comment">    elements are firing.</span>
01295 <span class="comment">    </span>
01296 <span class="comment">    We will use this as our general debug printer.  See udfdata.h for how we use the DebugTrace</span>
01297 <span class="comment">    macro to accomplish the effect.</span>
01298 <span class="comment">    </span>
01299 <span class="comment">Arguments:</span>
01300 <span class="comment"></span>
01301 <span class="comment">    IndentIncrement - amount to change the indentation by.</span>
01302 <span class="comment">    </span>
01303 <span class="comment">    TraceMask - specification of what debug trace level this call should be noisy at.</span>
01304 <span class="comment"></span>
01305 <span class="comment">Return Value:</span>
01306 <span class="comment"></span>
01307 <span class="comment">    USHORT - The 16bit CRC</span>
01308 <span class="comment"></span>
01309 <span class="comment">--*/</span>
01310 
01311 {
01312     va_list Arglist;
01313     LONG i;
01314     UCHAR <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[128];
01315     <span class="keywordtype">int</span> Bytes;
01316 
01317     <span class="keywordflow">if</span> (TraceMask == 0 || (UdfDebugTraceLevel &amp; TraceMask) != 0) {
01318 
01319         <span class="keywordflow">if</span> (IndentIncrement &lt; 0) {
01320             
01321             UdfDebugTraceIndent += IndentIncrement;
01322         }
01323 
01324         <span class="keywordflow">if</span> (UdfDebugTraceIndent &lt; 0) {
01325             
01326             UdfDebugTraceIndent = 0;
01327         }
01328 
01329         <span class="comment">//</span>
01330         <span class="comment">//  Build the indent in big chunks since calling DbgPrint repeatedly is expensive.</span>
01331         <span class="comment">//</span>
01332         
01333         <span class="keywordflow">for</span> (i = UdfDebugTraceIndent; i &gt; 0; i -= (<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>) - 1)) {
01334 
01335             RtlFillMemory( Buffer, <a class="code" href="../../d3/d8/udfprocs_8h.html#a3">Min</a>( i, (<span class="keyword">sizeof</span>(Buffer) - 1 )), <span class="charliteral">' '</span>);
01336             *(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> + <a class="code" href="../../d3/d8/udfprocs_8h.html#a3">Min</a>( i, (<span class="keyword">sizeof</span>(Buffer) - 1 ))) = <span class="charliteral">'\0'</span>;
01337             
01338             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( Buffer );
01339         }
01340 
01341         <span class="comment">//</span>
01342         <span class="comment">// Format the output into a buffer and then print it.</span>
01343         <span class="comment">//</span>
01344 
01345         va_start( Arglist, Format );
01346         Bytes = _vsnprintf( Buffer, <span class="keyword">sizeof</span>(Buffer), Format, Arglist );
01347         va_end( Arglist );
01348 
01349         <span class="comment">//</span>
01350         <span class="comment">// detect buffer overflow</span>
01351         <span class="comment">//</span>
01352 
01353         <span class="keywordflow">if</span> (Bytes == -1) {
01354 
01355             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>) - 1] = <span class="charliteral">'\n'</span>;
01356         }
01357 
01358         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( Buffer );
01359 
01360         <span class="keywordflow">if</span> (IndentIncrement &gt; 0) {
01361 
01362             UdfDebugTraceIndent += IndentIncrement;
01363         }
01364     }
01365 
01366     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01367 }
01368 <span class="preprocessor">#endif</span>
01369 <span class="preprocessor"></span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:10 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
