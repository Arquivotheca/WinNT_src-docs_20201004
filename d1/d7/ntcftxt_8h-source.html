<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ntcftxt.h Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ntcftxt.h</h1><a href="../../d0/d8/ntcftxt_8h.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/***************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: ntcftxt.h</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Kernel call forward stubs with text arguments</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* Each function will be created with two flavors Ansi and Unicode</span>
00009 <span class="comment">*</span>
00010 <span class="comment">* 06-Jan-1992 IanJa      Moved from cf.h</span>
00011 <span class="comment">* 18-Mar-1995 JimA       Ported from cftxt.h</span>
00012 <span class="comment">\**************************************************************************/</span>
00013 
00014 <span class="preprocessor">#ifdef UNICODE</span>
00015 <span class="preprocessor"></span><span class="preprocessor">#define IS_ANSI FALSE</span>
00016 <span class="preprocessor"></span><span class="preprocessor">#ifndef _UNICODE</span>
00017 <span class="preprocessor"></span><span class="preprocessor">#define _UNICODE</span>
00018 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00019 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00020"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a0">00020</a> <span class="preprocessor"></span><span class="preprocessor">#define IS_ANSI TRUE</span>
00021 <span class="preprocessor"></span><span class="preprocessor">#undef _UNICODE</span>
00022 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00023 <span class="preprocessor"></span><span class="preprocessor">#include &lt;tchar.h&gt;</span>
00024 <span class="preprocessor">#include "<a class="code" href="../../d7/d9/ntsend_8h.html">ntsend.h</a>"</span>
00025 
<a name="l00026"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a3">00026</a> HWND <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a36">TEXT_FN</a>(InternalFindWindowEx)(
00027     HWND    hwndParent,
00028     HWND    hwndChild,
00029     LPCTSTR pClassName,
00030     LPCTSTR pWindowName,
00031     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwFlag)
00032 {
00033     <a class="code" href="../../d8/d1/struct__IN__STRING.html">IN_STRING</a> strClass;
00034     <a class="code" href="../../d8/d1/struct__IN__STRING.html">IN_STRING</a> strWindow;
00035 
00036     <span class="comment">/*</span>
00037 <span class="comment">     * Make sure cleanup will work successfully</span>
00038 <span class="comment">     */</span>
00039     strClass.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o2">fAllocated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00040     strWindow.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o2">fAllocated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00041 
00042     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00043 
00044         <a class="code" href="../../d7/d9/ntsend_8h.html#a51">FIRSTCOPYLPTSTRIDOPT</a>(&amp;strClass, pClassName);
00045         <a class="code" href="../../d7/d9/ntsend_8h.html#a48">COPYLPTSTROPT</a>(&amp;strWindow, pWindowName);
00046 
00047         retval = (ULONG_PTR)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a306">NtUserFindWindowEx</a>(
00048                 hwndParent,
00049                 hwndChild,
00050                 strClass.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a>,
00051                 strWindow.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a>,
00052                 dwFlag);
00053 
00054     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00055     <a class="code" href="../../d7/d9/ntsend_8h.html#a55">CLEANUPLPTSTR</a>(strClass);
00056     <a class="code" href="../../d7/d9/ntsend_8h.html#a55">CLEANUPLPTSTR</a>(strWindow);
00057     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(HWND);
00058 
00059 }
00060 
<a name="l00061"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a10">00061</a> HWND <a class="code" href="../../d0/d8/ntcftxt_8h.html#a10">FindWindowEx</a>(
00062     HWND    hwndParent,
00063     HWND    hwndChild,
00064     LPCTSTR pClassName,
00065     LPCTSTR pWindowName)
00066 {
00067     <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a36">TEXT_FN</a>(<a class="code" href="../../d0/d8/ntcftxt_8h.html#a3">InternalFindWindowEx</a>)(hwndParent, hwndChild, pClassName, pWindowName, <a class="code" href="../../d1/d0/inc_2user_8h.html#a187">FW_BOTH</a>);
00068 }
00069 
<a name="l00070"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a11">00070</a> HWND <a class="code" href="../../d0/d8/ntcftxt_8h.html#a11">FindWindow</a>(
00071     LPCTSTR pClassName,
00072     LPCTSTR pWindowName)
00073 {
00074     <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a36">TEXT_FN</a>(<a class="code" href="../../d0/d8/ntcftxt_8h.html#a3">InternalFindWindowEx</a>)(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pClassName, pWindowName, <a class="code" href="../../d1/d0/inc_2user_8h.html#a187">FW_BOTH</a>);
00075 }
00076 
<a name="l00077"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a4">00077</a> <span class="keyword">extern</span> WNDPROC <a class="code" href="../../d0/d8/ntcftxt_8h.html#a4">mpPfnAddress</a>[];
00078 
<a name="l00079"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a12">00079</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d8/ntcftxt_8h.html#a12">GetClassInfo</a>(
00080     HINSTANCE hmod OPTIONAL,
00081     LPCTSTR pszClassName,
00082     LPWNDCLASS pwc)
00083 {
00084     <a class="code" href="../../d8/d1/struct__IN__STRING.html">IN_STRING</a> strClassName;
00085     LPWSTR pszMenuName;
00086     WNDCLASSEXW WndClass;
00087 
00088     <span class="comment">/*</span>
00089 <span class="comment">     * Make sure cleanup will work successfully</span>
00090 <span class="comment">     */</span>
00091     strClassName.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o2">fAllocated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00092 
00093     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00094 
00095         <a class="code" href="../../d7/d9/ntsend_8h.html#a50">FIRSTCOPYLPTSTRID</a>(&amp;strClassName, pszClassName);
00096 
00097         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a307">NtUserGetClassInfo</a>(
00098                 hmod,
00099                 strClassName.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a>,
00100                 &amp;WndClass,
00101                 &amp;pszMenuName,
00102                 <a class="code" href="../../d5/d9/cltxt_8h.html#a0">IS_ANSI</a>);
00103 
00104         <span class="keywordflow">if</span> (retval) {
00105 
00106             <span class="comment">/*</span>
00107 <span class="comment">             * Move the info from the WNDCLASSEX to the WNDCLASS structure</span>
00108 <span class="comment">             * On 64-bit plaforms we'll have 32 bits of padding between style and</span>
00109 <span class="comment">             * lpfnWndProc in WNDCLASS, so start the copy from the first 64-bit</span>
00110 <span class="comment">             * aligned field and hand copy the rest.</span>
00111 <span class="comment">             */</span>
00112             RtlCopyMemory(&amp;(pwc-&gt;lpfnWndProc), &amp;(WndClass.lpfnWndProc), <span class="keyword">sizeof</span>(WNDCLASS) - FIELD_OFFSET(WNDCLASS, lpfnWndProc));
00113             pwc-&gt;style = WndClass.style;
00114 
00115             <span class="comment">/*</span>
00116 <span class="comment">             * Update these pointers so they point to something real.</span>
00117 <span class="comment">             * pszMenuName is actually just the pointer the app originally</span>
00118 <span class="comment">             * passed to us.</span>
00119 <span class="comment">             */</span>
00120             pwc-&gt;lpszMenuName = (LPTSTR)pszMenuName;
00121             pwc-&gt;lpszClassName = pszClassName;
00122         }
00123 
00124     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00125     <a class="code" href="../../d7/d9/ntsend_8h.html#a55">CLEANUPLPTSTR</a>(strClassName);
00126     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>);
00127 }
00128 
<a name="l00129"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a13">00129</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d8/ntcftxt_8h.html#a13">GetClassInfoEx</a>(
00130     HINSTANCE hmod OPTIONAL,
00131     LPCTSTR pszClassName,
00132     LPWNDCLASSEX pwc)
00133 {
00134     <a class="code" href="../../d8/d1/struct__IN__STRING.html">IN_STRING</a> strClassName;
00135     LPWSTR pszMenuName;
00136 
00137     <span class="comment">/*</span>
00138 <span class="comment">     * Make sure cleanup will work successfully</span>
00139 <span class="comment">     */</span>
00140     strClassName.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o2">fAllocated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00141 
00142     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00143 
00144         <a class="code" href="../../d7/d9/ntsend_8h.html#a50">FIRSTCOPYLPTSTRID</a>(&amp;strClassName, pszClassName);
00145 
00146         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a307">NtUserGetClassInfo</a>(
00147                 hmod,
00148                 strClassName.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a>,
00149                 (LPWNDCLASSEXW)pwc,
00150                 &amp;pszMenuName,
00151                 <a class="code" href="../../d5/d9/cltxt_8h.html#a0">IS_ANSI</a>);
00152 
00153         <span class="keywordflow">if</span> (retval) {
00154 
00155             <span class="comment">/*</span>
00156 <span class="comment">             * Update these pointers so they point to something real.</span>
00157 <span class="comment">             * pszMenuName is actually just the pointer the app originally</span>
00158 <span class="comment">             * passed to us.</span>
00159 <span class="comment">             */</span>
00160             pwc-&gt;lpszMenuName = (LPTSTR)pszMenuName;
00161             pwc-&gt;lpszClassName = pszClassName;
00162         }
00163 
00164     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00165     <a class="code" href="../../d7/d9/ntsend_8h.html#a55">CLEANUPLPTSTR</a>(strClassName);
00166     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>);
00167 }
00168 
<a name="l00169"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a14">00169</a> <span class="keywordtype">int</span> <a class="code" href="../../d0/d8/ntcftxt_8h.html#a14">GetClipboardFormatName</a>(
00170     UINT wFormat,
00171     LPTSTR pFormatName,
00172     <span class="keywordtype">int</span> chMaxCount)
00173 {
00174     LPWSTR lpszReserve;
00175 
00176     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00177 
00178 #ifdef UNICODE
00179         lpszReserve = pFormatName;
00180 <span class="preprocessor">#else</span>
00181 <span class="preprocessor"></span>        lpszReserve = LocalAlloc(LMEM_FIXED, chMaxCount * <span class="keyword">sizeof</span>(WCHAR));
00182         <span class="keywordflow">if</span> (!lpszReserve) {
00183             <span class="keywordflow">return</span> 0;
00184         }
00185 <span class="preprocessor">#endif</span>
00186 <span class="preprocessor"></span>
00187         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a309">NtUserGetClipboardFormatName</a>(
00188                 wFormat,
00189                 lpszReserve,
00190                 chMaxCount);
00191 
00192 <span class="preprocessor">#ifndef UNICODE</span>
00193 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (retval) {
00194             <span class="comment">/*</span>
00195 <span class="comment">             * Do not copy out more than the requested byte count 'chMaxCount'.</span>
00196 <span class="comment">             * Set retval to reflect the number of ANSI bytes.</span>
00197 <span class="comment">             */</span>
00198             retval = WCSToMB(lpszReserve, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)retval,
00199                     &amp;pFormatName, chMaxCount-1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00200             pFormatName[retval] = <span class="charliteral">'\0'</span>;
00201         }
00202         LocalFree(lpszReserve);
00203 <span class="preprocessor">#endif</span>
00204 <span class="preprocessor"></span>
00205     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00206     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<span class="keywordtype">int</span>);
00207 }
00208 
<a name="l00209"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a15">00209</a> <span class="keywordtype">int</span> <a class="code" href="../../d0/d8/ntcftxt_8h.html#a15">GetKeyNameText</a>(
00210     LONG lParam,
00211     LPTSTR pString,
00212     <span class="keywordtype">int</span> cchSize)
00213 {
00214     LPWSTR lpszReserve;
00215 
00216     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00217 
00218 #ifdef UNICODE
00219         lpszReserve = pString;
00220 <span class="preprocessor">#else</span>
00221 <span class="preprocessor"></span>        lpszReserve = LocalAlloc(LMEM_FIXED, cchSize * <span class="keyword">sizeof</span>(WCHAR));
00222         <span class="keywordflow">if</span> (!lpszReserve) {
00223             <span class="keywordflow">return</span> 0;
00224         }
00225 <span class="preprocessor">#endif</span>
00226 <span class="preprocessor"></span>
00227         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a310">NtUserGetKeyNameText</a>(
00228                 lParam,
00229                 lpszReserve,
00230                 cchSize);
00231 
00232 <span class="preprocessor">#ifndef UNICODE</span>
00233 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (retval) {
00234             <span class="comment">/*</span>
00235 <span class="comment">             * Do not copy out more than the requested byte count 'nSize'.</span>
00236 <span class="comment">             * Set retval to reflect the number of ANSI bytes.</span>
00237 <span class="comment">             */</span>
00238             retval = WCSToMB(lpszReserve, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)retval,
00239                     &amp;pString, cchSize-1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00240         }
00241         LocalFree(lpszReserve);
00242         ((LPSTR)pString)[retval] = <span class="charliteral">'\0'</span>;
00243 <span class="preprocessor">#endif</span>
00244 <span class="preprocessor"></span>
00245     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00246     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<span class="keywordtype">int</span>);
00247 }
00248 
<a name="l00249"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a16">00249</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a> <a class="code" href="../../d0/d8/ntcftxt_8h.html#a16">GetMessage</a>(
00250     LPMSG pmsg,
00251     HWND hwnd,
00252     UINT wMsgFilterMin,
00253     UINT wMsgFilterMax)
00254 {
00255     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00256 
00257         <span class="comment">/*</span>
00258 <span class="comment">         * Prevent apps from setting hi 16 bits so we can use them internally.</span>
00259 <span class="comment">         */</span>
00260         <span class="keywordflow">if</span> ((wMsgFilterMin | wMsgFilterMax) &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a8">RESERVED_MSG_BITS</a>) {
00261             <a class="code" href="../../d5/d8/crecv_8c.html#a8">MSGERRORCODE</a>(ERROR_INVALID_PARAMETER);
00262         }
00263 
00264 <span class="preprocessor">#ifndef UNICODE</span>
00265 <span class="preprocessor"></span>        <span class="comment">/*</span>
00266 <span class="comment">         * If we have pushed message for DBCS messaging, we should pass this one</span>
00267 <span class="comment">         * to Apps at first...</span>
00268 <span class="comment">         */</span>
00269         <a class="code" href="../../d6/d0/usercli_8h.html#a293">GET_DBCS_MESSAGE_IF_EXIST</a>(<a class="code" href="../../d0/d8/ntcftxt_8h.html#a16">GetMessage</a>, pmsg, wMsgFilterMin, wMsgFilterMax, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00270 <span class="preprocessor">#endif</span>
00271 <span class="preprocessor"></span>
00272         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a110">NtUserGetMessage</a>(
00273                 pmsg,
00274                 hwnd,
00275                 wMsgFilterMin,
00276                 wMsgFilterMax);
00277 
00278 <span class="preprocessor">#ifndef UNICODE</span>
00279 <span class="preprocessor"></span>        <span class="comment">// May have a bit more work to do if this MSG is for an ANSI app</span>
00280 
00281         <span class="comment">// !!! LATER if the unichar translates into multiple ANSI chars</span>
00282         <span class="comment">// !!! then what??? Divide into two messages??  WM_SYSDEADCHAR??</span>
00283 
00284         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/chartran_8c.html#a4">RtlWCSMessageWParamCharToMB</a>(pmsg-&gt;message, &amp;(pmsg-&gt;wParam))) {
00285             WPARAM dwAnsi = pmsg-&gt;wParam;
00286             <span class="comment">/*</span>
00287 <span class="comment">             * Build DBCS-ware wParam. (for EM_SETPASSWORDCHAR...)</span>
00288 <span class="comment">             */</span>
00289             <a class="code" href="../../d6/d0/usercli_8h.html#a296">BUILD_DBCS_MESSAGE_TO_CLIENTA_FROM_SERVER</a>(pmsg, dwAnsi, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00290         } <span class="keywordflow">else</span> {
00291             retval = 0;
00292         }
00293 ExitGetMessage:
00294 <span class="preprocessor">#else</span>
00295 <span class="preprocessor"></span>        <span class="comment">/*</span>
00296 <span class="comment">         * Only LOWORD of WPARAM is valid for WM_CHAR (Unicode)....</span>
00297 <span class="comment">         * (Mask off DBCS messaging information.)</span>
00298 <span class="comment">         */</span>
00299         <a class="code" href="../../d6/d0/usercli_8h.html#a297">BUILD_DBCS_MESSAGE_TO_CLIENTW_FROM_SERVER</a>(pmsg-&gt;message,pmsg-&gt;wParam);
00300 <span class="preprocessor">#endif // UNICODE</span>
00301 <span class="preprocessor"></span>
00302     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00303     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>);
00304 }
00305 
<a name="l00306"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a17">00306</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d8/ntcftxt_8h.html#a17">GetKeyboardLayoutName</a>(
00307     LPTSTR pwszKL)
00308 {
00309 <span class="preprocessor">#ifdef UNICODE</span>
00310 <span class="preprocessor"></span>    UNICODE_STRING str;
00311     PUNICODE_STRING pstr = &amp;str;
00312 <span class="preprocessor">#else</span>
00313 <span class="preprocessor"></span>    PUNICODE_STRING pstr = &amp;NtCurrentTeb()-&gt;StaticUnicodeString;
00314 <span class="preprocessor">#endif</span>
00315 <span class="preprocessor"></span>
00316     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00317 
00318 #ifdef UNICODE
00319         str.MaximumLength = KL_NAMELENGTH * <span class="keyword">sizeof</span>(WCHAR);
00320         str.Buffer = pwszKL;
00321 <span class="preprocessor">#endif</span>
00322 <span class="preprocessor"></span>
00323         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a311">NtUserGetKeyboardLayoutName</a>(pstr);
00324 
00325 <span class="preprocessor">#ifndef UNICODE</span>
00326 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (retval) {
00327             <span class="comment">/*</span>
00328 <span class="comment">             * Non-zero retval means some text to copy out.  Do not copy out</span>
00329 <span class="comment">             * more than the requested byte count 'chMaxCount'.</span>
00330 <span class="comment">             */</span>
00331             WCSToMB(pstr-&gt;Buffer, -1, &amp;pwszKL, KL_NAMELENGTH, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00332         }
00333 <span class="preprocessor">#endif</span>
00334 <span class="preprocessor"></span>
00335     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00336     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>);
00337 }
00338 
<a name="l00339"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a18">00339</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d0/d8/ntcftxt_8h.html#a18">MapVirtualKey</a>(
00340     UINT wCode,
00341     UINT wMapType)
00342 {
00343     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00344 
00345         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a313">NtUserMapVirtualKeyEx</a>(
00346                 wCode,
00347                 wMapType,
00348                 0,
00349                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00350 
00351 <span class="preprocessor">#ifndef UNICODE</span>
00352 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((wMapType == 2) &amp;&amp; (retval != 0)) {
00353             WCHAR wch = LOWORD(retval);
00354             retval &amp;= ~0xFFFF;
00355             <a class="code" href="../../d9/d6/nlsxlat_8c.html#a37">RtlUnicodeToMultiByteN</a>((LPSTR)&amp;(retval), <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>),
00356                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;wch, <span class="keyword">sizeof</span>(WCHAR));
00357         }
00358 <span class="preprocessor">#endif</span>
00359 <span class="preprocessor"></span>
00360     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00361     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>);
00362 }
00363 
00364 <span class="comment">/**************************************************************************\</span>
00365 <span class="comment">* MapVirtualKeyEx</span>
00366 <span class="comment">*</span>
00367 <span class="comment">* 21-Feb-1995 GregoryW    Created</span>
00368 <span class="comment">\**************************************************************************/</span>
00369 
00370 <span class="preprocessor">#ifndef UNICODE</span>
<a name="l00371"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a5">00371</a> <span class="preprocessor"></span><span class="keyword">static</span> HKL  <a class="code" href="../../d0/d8/ntcftxt_8h.html#a5">hMVKCachedHKL</a> = 0;
<a name="l00372"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a6">00372</a> <span class="keyword">static</span> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d0/d8/ntcftxt_8h.html#a6">uMVKCachedCP</a>  = 0;
00373 <span class="preprocessor">#endif</span>
<a name="l00374"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a19">00374</a> <span class="preprocessor"></span><a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d0/d8/ntcftxt_8h.html#a19">MapVirtualKeyEx</a>(
00375     UINT wCode,
00376     UINT wMapType,
00377     HKL hkl)
00378 {
00379     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00380 
00381         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a313">NtUserMapVirtualKeyEx</a>(
00382                 wCode,
00383                 wMapType,
00384                 (ULONG_PTR)hkl,
00385                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00386 
00387 <span class="preprocessor">#ifndef UNICODE</span>
00388 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((wMapType == 2) &amp;&amp; (retval != 0)) {
00389             WCHAR wch = LOWORD(retval);
00390 
00391             <span class="keywordflow">if</span> (hkl != <a class="code" href="../../d0/d8/ntcftxt_8h.html#a5">hMVKCachedHKL</a>) {
00392                 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwCodePage;
00393                 <span class="keywordflow">if</span> (!GetLocaleInfoW(
00394                          HandleToUlong(hkl) &amp; 0xffff,
00395                          LOCALE_IDEFAULTANSICODEPAGE | LOCALE_RETURN_NUMBER,
00396                          (LPWSTR)&amp;dwCodePage,
00397                          <span class="keyword">sizeof</span>(dwCodePage) / <span class="keyword">sizeof</span>(WCHAR)
00398                          )) {
00399                     <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
00400                 }
00401                 <a class="code" href="../../d0/d8/ntcftxt_8h.html#a6">uMVKCachedCP</a> = dwCodePage;
00402                 <a class="code" href="../../d0/d8/ntcftxt_8h.html#a5">hMVKCachedHKL</a> = hkl;
00403             }
00404             <span class="comment">/*</span>
00405 <span class="comment">             * Clear low word which contains Unicode character returned from server.</span>
00406 <span class="comment">             * This preserves the high word which is used to indicate dead key status.</span>
00407 <span class="comment">             */</span>
00408             retval = retval &amp; 0xffff0000;
00409             <span class="keywordflow">if</span> (!WideCharToMultiByte(
00410                      <a class="code" href="../../d0/d8/ntcftxt_8h.html#a6">uMVKCachedCP</a>,
00411                      0,
00412                      &amp;wch,
00413                      1,
00414                      (LPSTR)&amp;(retval),
00415                      1,
00416                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00417                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00418                 <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
00419             }
00420         }
00421 <span class="preprocessor">#endif</span>
00422 <span class="preprocessor"></span>
00423     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00424     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>);
00425 }
00426 
<a name="l00427"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">00427</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a> <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(
00428     HWND hwnd,
00429     UINT wMsg,
00430     WPARAM wParam,
00431     LPARAM lParam)
00432 {
00433     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00434 
00435         <span class="keywordflow">switch</span> (wMsg) {
00436         <span class="keywordflow">case</span> WM_DROPFILES:
00437             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a12">GetWindowProcess</a>(hwnd) != <a class="code" href="../../d6/d0/usercli_8h.html#a13">GETPROCESSID</a>()) {
00438                 <span class="comment">/*</span>
00439 <span class="comment">                 * We first send a WM_COPYGLOBALDATA message to get the data into the proper</span>
00440 <span class="comment">                 * context.</span>
00441 <span class="comment">                 */</span>
00442                 HGLOBAL hg;
00443 
00444                 hg = (HGLOBAL)<a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hwnd, WM_COPYGLOBALDATA,
00445                         GlobalSize((HGLOBAL)wParam), wParam);
00446                 <span class="keywordflow">if</span> (!hg) {
00447                     <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
00448                 }
00449                 wParam = (WPARAM)hg;
00450             }
00451             <span class="keywordflow">break</span>;
00452 
00453         <span class="keywordflow">case</span> LB_DIR:
00454         <span class="keywordflow">case</span> CB_DIR:
00455             <span class="comment">/*</span>
00456 <span class="comment">             * Make sure this bit is set so the client side string gets</span>
00457 <span class="comment">             * successfully copied over.</span>
00458 <span class="comment">             */</span>
00459             wParam |= DDL_POSTMSGS;
00460             <span class="keywordflow">break</span>;
00461         }
00462 
00463 <span class="preprocessor">#ifndef UNICODE</span>
00464 <span class="preprocessor"></span>        <span class="comment">/*</span>
00465 <span class="comment">         * Setup DBCS Messaging for WM_CHAR...</span>
00466 <span class="comment">         */</span>
00467         <a class="code" href="../../d6/d0/usercli_8h.html#a294">BUILD_DBCS_MESSAGE_TO_SERVER_FROM_CLIENTA</a>(wMsg,wParam,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00468 
00469         <a class="code" href="../../d5/d6/chartran_8c.html#a5">RtlMBMessageWParamCharToWCS</a>(wMsg, &amp;wParam);
00470 <span class="preprocessor">#endif</span>
00471 <span class="preprocessor"></span>        retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a214">NtUserPostMessage</a>(
00472                 hwnd,
00473                 wMsg,
00474                 wParam,
00475                 lParam);
00476 
00477     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00478     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>);
00479 }
00480 
<a name="l00481"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a21">00481</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a> <a class="code" href="../../d0/d8/ntcftxt_8h.html#a21">PostThreadMessage</a>(
00482     DWORD idThread,
00483     UINT msg,
00484     WPARAM wParam,
00485     LPARAM lParam)
00486 {
00487     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00488 
00489 #ifndef UNICODE
00490 <span class="preprocessor">#ifdef FE_SB // PostThreadMessage()</span>
00491 <span class="preprocessor"></span>        <span class="comment">/*</span>
00492 <span class="comment">         * The server always expects the characters to be unicode so</span>
00493 <span class="comment">         * if this was generated from an ANSI routine convert it to Unicode</span>
00494 <span class="comment">         */</span>
00495         <a class="code" href="../../d6/d0/usercli_8h.html#a294">BUILD_DBCS_MESSAGE_TO_SERVER_FROM_CLIENTA</a>(<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,wParam,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00496 <span class="preprocessor">#endif // FE_SB</span>
00497 <span class="preprocessor"></span>
00498         <a class="code" href="../../d5/d6/chartran_8c.html#a5">RtlMBMessageWParamCharToWCS</a>(<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, &amp;wParam);
00499 <span class="preprocessor">#endif</span>
00500 <span class="preprocessor"></span>
00501         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a127">NtUserPostThreadMessage</a>(
00502                 idThread,
00503                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
00504                 wParam,
00505                 lParam);
00506 
00507     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00508     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>);
00509 }
00510 
00511 
00512 <span class="comment">/**************************************************************************\</span>
00513 <span class="comment">* StringDuplicate</span>
00514 <span class="comment">*</span>
00515 <span class="comment">* 03-25-96 GerardoB         Added Header.</span>
00516 <span class="comment">\**************************************************************************/</span>
<a name="l00517"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a1">00517</a> <span class="preprocessor">#define StringDuplicate TEXT_FN(StringDuplicate)</span>
<a name="l00518"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a22">00518</a> <span class="preprocessor"></span>LPTSTR <a class="code" href="../../d0/d8/ntcftxt_8h.html#a1">StringDuplicate</a>(LPCTSTR ptszDup) {
00519     LPTSTR ptsz;
00520     ULONG cb;
00521 
00522     cb = (_tcslen(ptszDup) + 1) * <span class="keyword">sizeof</span>(TCHAR);
00523     ptsz = (LPTSTR)LocalAlloc(NONZEROLPTR, cb);
00524     <span class="keywordflow">if</span> (ptsz != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00525         RtlCopyMemory(ptsz, ptszDup, cb);
00526     }
00527     <span class="keywordflow">return</span> ptsz;
00528 }
00529 <span class="comment">/**************************************************************************\</span>
00530 <span class="comment">* InitClsMenuName</span>
00531 <span class="comment">*</span>
00532 <span class="comment">* 03-22-96 GerardoB         Created.</span>
00533 <span class="comment">\**************************************************************************/</span>
<a name="l00534"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a2">00534</a> <span class="preprocessor">#define InitClsMenuName TEXT_FN(InitClsMenuName)</span>
<a name="l00535"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a23">00535</a> <span class="preprocessor"></span><a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d8/ntcftxt_8h.html#a2">InitClsMenuName</a> (<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html">PCLSMENUNAME</a> pcmn, LPCTSTR lpszMenuName, <a class="code" href="../../d8/d1/struct__IN__STRING.html">PIN_STRING</a> pstrMenuName)
00536 {
00537     <span class="comment">/*</span>
00538 <span class="comment">     * We check the high-word because this may be a resource-ID.</span>
00539 <span class="comment">     */</span>
00540     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(lpszMenuName)) {
00541 <span class="preprocessor">#ifdef UNICODE</span>
00542 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((pcmn-&gt;<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o1">pwszClientUnicodeMenuName</a> = <a class="code" href="../../d0/d8/ntcftxt_8h.html#a1">StringDuplicate</a>(lpszMenuName)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00543             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00544         }
00545 
00546         <span class="keywordflow">if</span> (!WCSToMB(lpszMenuName, -1, &amp;(pcmn-&gt;<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o0">pszClientAnsiMenuName</a>), -1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00547             pcmn-&gt;<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o0">pszClientAnsiMenuName</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00548         }
00549 <span class="preprocessor">#else</span>
00550 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((pcmn-&gt;<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o0">pszClientAnsiMenuName</a> = <a class="code" href="../../d0/d8/ntcftxt_8h.html#a1">StringDuplicate</a>(lpszMenuName)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00551             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00552         }
00553 
00554         <span class="keywordflow">if</span> (!MBToWCS(lpszMenuName, -1, &amp;(pcmn-&gt;<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o1">pwszClientUnicodeMenuName</a>), -1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00555             pcmn-&gt;<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o1">pwszClientUnicodeMenuName</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00556         }
00557 <span class="preprocessor">#endif // UNICODE</span>
00558 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
00559         <span class="comment">/* Copy the ID */</span>
00560         pcmn-&gt;<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o0">pszClientAnsiMenuName</a> = (LPSTR)lpszMenuName;
00561         pcmn-&gt;<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o1">pwszClientUnicodeMenuName</a> = (LPWSTR)lpszMenuName;
00562     }
00563 
00564     <a class="code" href="../../d7/d9/ntsend_8h.html#a46">COPYLPTSTRID</a>(pstrMenuName, lpszMenuName);
00565     pcmn-&gt;<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o2">pusMenuName</a> = pstrMenuName-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a>;
00566 
00567     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00568 
00569     <span class="keywordflow">goto</span> errorexit; <span class="comment">/* Keep the compiler happy */</span>
00570 errorexit: <span class="comment">/* Used by COPYLPTSTRID */</span>
00571    <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00572 }
00573 
00574 <span class="comment">/**************************************************************************\</span>
00575 <span class="comment">* SetClassLong</span>
00576 <span class="comment">*</span>
00577 <span class="comment">* 03-22-96 GerardoB      Moved from client\cltxt.h &amp; client\ntstubs.c</span>
00578 <span class="comment">\**************************************************************************/</span>
<a name="l00579"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a24">00579</a> ULONG_PTR <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a> <a class="code" href="../../d0/d8/ntcftxt_8h.html#a24">SetClassLongPtr</a>(HWND hwnd, <span class="keywordtype">int</span> nIndex, LONG_PTR dwNewLong)
00580 {
00581     <a class="code" href="../../d8/d0/structtagCLSMENUNAME.html">CLSMENUNAME</a> cmn;
00582     <a class="code" href="../../d8/d1/struct__IN__STRING.html">IN_STRING</a> strMenuName;
00583 
00584     <span class="keywordflow">switch</span> (nIndex) {
00585         <span class="keywordflow">case</span> GCLP_MENUNAME:
00586             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d8/ntcftxt_8h.html#a2">InitClsMenuName</a>(&amp;cmn, (LPCTSTR) dwNewLong, &amp;strMenuName)) {
00587                 RIPERR0(ERROR_INVALID_HANDLE, RIP_WARNING, <span class="stringliteral">"SetClassLong: InitClsMenuName failed"</span>);
00588                 <span class="keywordflow">return</span> 0;
00589             }
00590             dwNewLong = (ULONG_PTR) &amp;cmn;
00591             <span class="keywordflow">break</span>;
00592 
00593         <span class="keywordflow">case</span> GCLP_HBRBACKGROUND:
00594             <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)dwNewLong &gt; COLOR_ENDCOLORS) {
00595                 <span class="comment">/*</span>
00596 <span class="comment">                 * Let gdi validate the brush.  If it's invalid, then</span>
00597 <span class="comment">                 * gdi will log a warning.  No need to rip twice so we'll</span>
00598 <span class="comment">                 * just set the last-error.</span>
00599 <span class="comment">                 */</span>
00600                 <span class="keywordflow">if</span> (GdiValidateHandle((HBRUSH)dwNewLong) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00601                     RIPERR0(ERROR_INVALID_HANDLE, RIP_VERBOSE, <span class="stringliteral">""</span>);
00602                     <span class="keywordflow">return</span> 0;
00603                 }
00604             }
00605             <span class="keywordflow">break</span>;
00606     }
00607 
00608     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00609 
00610     retval = (ULONG_PTR)<a class="code" href="../../d0/d0/ntuser_8h.html#a2">NtUserSetClassLongPtr</a>(hwnd, nIndex, dwNewLong, <a class="code" href="../../d5/d9/cltxt_8h.html#a0">IS_ANSI</a>);
00611 
00612     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00613 
00614     <span class="comment">/* Clean up */</span>
00615     <span class="keywordflow">switch</span> (nIndex) {
00616         <span class="keywordflow">case</span> GCLP_MENUNAME:
00617             <a class="code" href="../../d7/d9/ntsend_8h.html#a55">CLEANUPLPTSTR</a>(strMenuName); <span class="comment">/* Initialized by InitClsMenuName */</span>
00618             <span class="comment">/*</span>
00619 <span class="comment">             * We free either the old strings (returned by the kernel),</span>
00620 <span class="comment">             *  or the new ones if the kernel call failed</span>
00621 <span class="comment">             */</span>
00622             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(cmn.<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o0">pszClientAnsiMenuName</a>)) {
00623                 LocalFree(cmn.<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o0">pszClientAnsiMenuName</a>);
00624             }
00625             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(cmn.<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o1">pwszClientUnicodeMenuName</a>)) {
00626                 LocalFree(cmn.<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o1">pwszClientUnicodeMenuName</a>);
00627             }
00628 
00629             <span class="keywordflow">break</span>;
00630     }
00631 
00632     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(ULONG_PTR);
00633 
00634 }
00635 
00636 <span class="preprocessor">#ifdef _WIN64</span>
00637 <span class="preprocessor"></span><a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a> SetClassLong(HWND hwnd, <span class="keywordtype">int</span> nIndex, LONG dwNewLong)
00638 {
00639     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00640 
00641     retval = (DWORD)NtUserSetClassLong(hwnd, nIndex, dwNewLong, IS_ANSI);
00642 
00643     ERRORTRAP(0);
00644     ENDCALL(DWORD);
00645 }
00646 #endif
00647 <span class="comment">/**************************************************************************\</span>
00648 <span class="comment">* RegisterClassExWOW</span>
00649 <span class="comment">*</span>
00650 <span class="comment">* 03-22-96 GerardoB      Added Header</span>
00651 <span class="comment">\**************************************************************************/</span>
<a name="l00652"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a7">00652</a> ATOM TEXT_FN(RegisterClassExWOW)(
00653     WNDCLASSEX *lpWndClass,
00654     LPDWORD pdwWOWstuff,
00655     WORD fnid)
00656 {
00657     WNDCLASSEX WndClass;
00658     <a class="code" href="../../d8/d1/struct__IN__STRING.html">IN_STRING</a> strClassName;
00659     <a class="code" href="../../d8/d1/struct__IN__STRING.html">IN_STRING</a> strMenuName;
00660     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>, dwExpWinVer;
00661     <a class="code" href="../../d8/d0/structtagCLSMENUNAME.html">CLSMENUNAME</a> cmn;
00662 
00663     strClassName.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o2">fAllocated</a> = 0;
00664     strMenuName.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o2">fAllocated</a>  = 0;
00665 
00666     <span class="comment">/*</span>
00667 <span class="comment">     * Skip validation for our classes</span>
00668 <span class="comment">     */</span>
00669     <span class="keywordflow">if</span> (fnid !=0) {
00670         <span class="comment">/*</span>
00671 <span class="comment">         * This is a hack to bypass validation for DDE classes</span>
00672 <span class="comment">         * specifically, allow them to use hmodUser.</span>
00673 <span class="comment">         */</span>
00674          <span class="keywordflow">if</span> (fnid == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a225">FNID_DDE_BIT</a>) {
00675              fnid = 0;
00676          }
00677          dwExpWinVer = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>;
00678     } <span class="keywordflow">else</span> {
00679         <span class="keywordflow">if</span> (lpWndClass-&gt;cbSize != <span class="keyword">sizeof</span>(WNDCLASSEX)) {
00680             RIPMSG0(RIP_WARNING, <span class="stringliteral">"RegisterClass: Invalid cbSize"</span>);
00681         }
00682 
00683         <span class="keywordflow">if</span> (lpWndClass-&gt;cbClsExtra &lt; 0 ||
00684                 lpWndClass-&gt;cbWndExtra &lt; 0) {
00685             RIPMSG0(RIP_WARNING, <span class="stringliteral">"RegisterClass: invalid cb*Extra"</span>);
00686             <span class="keywordflow">goto</span> BadParameter;
00687         }
00688 
00689         <span class="comment">/*</span>
00690 <span class="comment">         * Validate hInstance</span>
00691 <span class="comment">         * Don't allow 4.0 apps to use hmodUser</span>
00692 <span class="comment">         */</span>
00693          <span class="keywordflow">if</span> ((lpWndClass-&gt;hInstance == <a class="code" href="../../d1/d8/clglobal_8c.html#a6">hmodUser</a>)
00694                 &amp;&amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>()-&gt;dwExpWinVer &gt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>)) {
00695              RIPMSG0(RIP_WARNING, <span class="stringliteral">"RegisterClass: Cannot use USER's hInstance"</span>);
00696              <span class="keywordflow">goto</span> BadParameter;
00697          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lpWndClass-&gt;hInstance == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00698             <span class="comment">/*</span>
00699 <span class="comment">             * For 32 bit apps we need to fix up the hInstance because Win 95 does</span>
00700 <span class="comment">             * this in their thunk MapHInstLS</span>
00701 <span class="comment">             */</span>
00702 
00703             lpWndClass-&gt;hInstance = GetModuleHandle(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00704             RIPMSG1(RIP_VERBOSE, <span class="stringliteral">"RegisterClass: fixing up NULL hmodule to %#p"</span>,
00705                     lpWndClass-&gt;hInstance);
00706         }
00707 
00708         dwExpWinVer = <a class="code" href="../../d6/d0/usercli_8h.html#a134">GETEXPWINVER</a>(lpWndClass-&gt;hInstance);
00709 
00710 
00711         <span class="comment">/*</span>
00712 <span class="comment">         * Check for valid style bits and strip if appropriate</span>
00713 <span class="comment">         */</span>
00714         <span class="keywordflow">if</span> (lpWndClass-&gt;style &amp; ~CS_VALID40) {
00715 
00716             <span class="keywordflow">if</span> (dwExpWinVer &gt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a102">VER31</a>) {
00717                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"RegisterClass: Invalid class style"</span>);
00718                 <span class="keywordflow">goto</span> BadParameter;
00719             }
00720 
00721             <span class="comment">/*</span>
00722 <span class="comment">             * Old application - strip bogus bits and pass through</span>
00723 <span class="comment">             */</span>
00724             RIPMSG0(RIP_WARNING, <span class="stringliteral">"RegisterClass: Invalid class style, stripping bad styles"</span>);
00725             lpWndClass-&gt;style &amp;= CS_VALID40;
00726         }
00727 
00728         <span class="comment">/*</span>
00729 <span class="comment">         * Validate hbrBackground</span>
00730 <span class="comment">         */</span>
00731         <span class="keywordflow">if</span> (lpWndClass-&gt;hbrBackground &gt; (HBRUSH)COLOR_MAX
00732                 &amp;&amp; !GdiValidateHandle(lpWndClass-&gt;hbrBackground)) {
00733 
00734             RIPMSG1(RIP_WARNING, <span class="stringliteral">"RegisterClass: Invalid class brush:%#p"</span>, lpWndClass-&gt;hbrBackground);
00735             <span class="keywordflow">if</span> (dwExpWinVer &gt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a103">VER30</a>) {
00736                 <span class="keywordflow">goto</span> BadParameter;
00737             }
00738 
00739             lpWndClass-&gt;hbrBackground = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00740         }
00741 
00742     } <span class="comment">/* if (fnid !=0) */</span>
00743 
00744 
00745     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d8/ntcftxt_8h.html#a2">InitClsMenuName</a>(&amp;cmn, lpWndClass-&gt;lpszMenuName, &amp;strMenuName)) {
00746         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00747     }
00748 
00749     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00750 
00751         WndClass = *lpWndClass;
00752 
00753 <span class="preprocessor">#ifdef UNICODE</span>
00754 <span class="preprocessor"></span>        <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> = 0;
00755 <span class="preprocessor">#else</span>
00756 <span class="preprocessor"></span>        <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a493">CSF_ANSIPROC</a>;
00757 <span class="preprocessor">#endif // UNICODE</span>
00758 <span class="preprocessor"></span>
00759         <span class="keywordflow">if</span> (dwExpWinVer &gt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a102">VER31</a>) {
00760             <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> |= <a class="code" href="../../d1/d0/inc_2user_8h.html#a491">CSF_WIN40COMPAT</a>;
00761         }
00762 
00763         <a class="code" href="../../d7/d9/ntsend_8h.html#a46">COPYLPTSTRID</a>(&amp;strClassName, (LPTSTR)lpWndClass-&gt;lpszClassName);
00764 
00765         retval = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a314">NtUserRegisterClassExWOW</a>(
00766                 &amp;WndClass,
00767                 strClassName.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a>,
00768                 &amp;cmn,
00769                 fnid,
00770                 <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>,
00771                 pdwWOWstuff);
00772 
00773         <span class="comment">/*</span>
00774 <span class="comment">         * Return the atom associated with this class or if earlier</span>
00775 <span class="comment">         * than Win 3.1 convert it to a strict BOOL (some apps check)</span>
00776 <span class="comment">         */</span>
00777         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a134">GETEXPWINVER</a>(lpWndClass-&gt;hInstance) &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a102">VER31</a>)
00778             retval = !!retval;
00779 
00780     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00781     <a class="code" href="../../d7/d9/ntsend_8h.html#a55">CLEANUPLPTSTR</a>(strMenuName);     <span class="comment">/* Initialized by InitClsMenuName */</span>
00782     <a class="code" href="../../d7/d9/ntsend_8h.html#a55">CLEANUPLPTSTR</a>(strClassName);
00783 
00784     <span class="keywordflow">if</span> (!retval) {
00785         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(cmn.<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o0">pszClientAnsiMenuName</a>)) {
00786             LocalFree(cmn.<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o0">pszClientAnsiMenuName</a>);
00787         }
00788         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(cmn.<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o1">pwszClientUnicodeMenuName</a>)) {
00789             LocalFree(cmn.<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o1">pwszClientUnicodeMenuName</a>);
00790         }
00791     }
00792     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>);
00793 
00794 BadParameter:
00795     RIPERR0(ERROR_INVALID_PARAMETER, RIP_VERBOSE, <span class="stringliteral">"RegisterClass: Invalid Parameter"</span>);
00796     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00797 
00798 }
00799 
<a name="l00800"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a25">00800</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d0/d8/ntcftxt_8h.html#a25">RegisterWindowMessage</a>(
00801     LPCTSTR pString)
00802 {
00803     <a class="code" href="../../d8/d1/struct__IN__STRING.html">IN_STRING</a> str;
00804 
00805     <span class="comment">/*</span>
00806 <span class="comment">     * Make sure cleanup will work successfully</span>
00807 <span class="comment">     */</span>
00808     str.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o2">fAllocated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00809 
00810     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00811 
00812         <a class="code" href="../../d7/d9/ntsend_8h.html#a49">FIRSTCOPYLPTSTR</a>(&amp;str, (LPTSTR)pString);
00813 
00814         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a315">NtUserRegisterWindowMessage</a>(
00815                 str.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a>);
00816 
00817     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00818     <a class="code" href="../../d7/d9/ntsend_8h.html#a55">CLEANUPLPTSTR</a>(str);
00819     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>);
00820 }
00821 
<a name="l00822"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a26">00822</a> HANDLE <a class="code" href="../../d0/d8/ntcftxt_8h.html#a26">RemoveProp</a>(
00823     HWND hwnd,
00824     LPCTSTR pString)
00825 {
00826     ATOM atomProp;
00827     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwProp;
00828 
00829     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00830 
00831         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(pString)) {
00832             atomProp = GlobalFindAtom(pString);
00833             <span class="keywordflow">if</span> (atomProp == 0)
00834                 <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
00835             dwProp = MAKELONG(atomProp, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00836         } <span class="keywordflow">else</span>
00837             dwProp = MAKELONG(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(pString), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00838 
00839         retval = (ULONG_PTR)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a316">NtUserRemoveProp</a>(
00840                 hwnd,
00841                 dwProp);
00842 
00843         <span class="keywordflow">if</span> (retval != 0 &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(pString))
00844             GlobalDeleteAtom(atomProp);
00845 
00846     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00847     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(HANDLE);
00848 }
00849 
<a name="l00850"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a27">00850</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a> <a class="code" href="../../d0/d8/ntcftxt_8h.html#a27">SendMessageCallback</a>(
00851     HWND hwnd,
00852     UINT wMsg,
00853     WPARAM wParam,
00854     LPARAM lParam,
00855     SENDASYNCPROC lpResultCallBack,
00856     ULONG_PTR dwData)
00857 {
00858     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00859 
00860 #ifndef UNICODE
00861 <span class="preprocessor">#ifdef FE_SB // SendMessageCallBack()</span>
00862 <span class="preprocessor"></span>        <span class="comment">/*</span>
00863 <span class="comment">         * Setup DBCS Messaging for WM_CHAR...</span>
00864 <span class="comment">         */</span>
00865         <a class="code" href="../../d6/d0/usercli_8h.html#a294">BUILD_DBCS_MESSAGE_TO_SERVER_FROM_CLIENTA</a>(wMsg,wParam,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00866 <span class="preprocessor">#endif // FE_SB</span>
00867 <span class="preprocessor"></span>
00868         <a class="code" href="../../d5/d6/chartran_8c.html#a5">RtlMBMessageWParamCharToWCS</a>(wMsg, &amp;wParam);
00869 <span class="preprocessor">#endif</span>
00870 <span class="preprocessor"></span>
00871         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a216">NtUserSendMessageCallback</a>(
00872                 hwnd,
00873                 wMsg,
00874                 wParam,
00875                 lParam,
00876                 lpResultCallBack,
00877                 dwData);
00878 
00879     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00880     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>);
00881 }
00882 
<a name="l00883"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a28">00883</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a> <a class="code" href="../../d0/d8/ntcftxt_8h.html#a28">SendNotifyMessage</a>(
00884     HWND hwnd,
00885     UINT wMsg,
00886     WPARAM wParam,
00887     LPARAM lParam)
00888 {
00889     <a class="code" href="../../d1/d9/struct__LARGE__STRING.html">LARGE_STRING</a> str;
00890     LPWSTR  lpUniName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00891 
00892 
00893     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00894 
00895 #ifndef UNICODE
00896 <span class="preprocessor">#ifdef FE_SB // SendNotifyMessage()</span>
00897 <span class="preprocessor"></span>        <span class="comment">/*</span>
00898 <span class="comment">         * Setup DBCS Messaging for WM_CHAR...</span>
00899 <span class="comment">         */</span>
00900         <a class="code" href="../../d6/d0/usercli_8h.html#a294">BUILD_DBCS_MESSAGE_TO_SERVER_FROM_CLIENTA</a>(wMsg,wParam,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00901 <span class="preprocessor">#endif // FE_SB</span>
00902 <span class="preprocessor"></span>
00903         <a class="code" href="../../d5/d6/chartran_8c.html#a5">RtlMBMessageWParamCharToWCS</a>(wMsg, &amp;wParam);
00904 <span class="preprocessor">#endif</span>
00905 <span class="preprocessor"></span>
00906         <span class="comment">/*</span>
00907 <span class="comment">         * Allow system notification messages containing</span>
00908 <span class="comment">         * strings to go through.</span>
00909 <span class="comment">         */</span>
00910         <span class="keywordflow">if</span> ((wMsg == WM_WININICHANGE || wMsg == WM_DEVMODECHANGE) &amp;&amp; lParam) {
00911 <span class="preprocessor">#ifdef UNICODE</span>
00912 <span class="preprocessor"></span>            <a class="code" href="../../d5/d6/chartran_8c.html#a7">RtlInitLargeUnicodeString</a>((<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html">PLARGE_UNICODE_STRING</a>)&amp;str,
00913                     (LPWSTR)lParam, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1);
00914 <span class="preprocessor">#else</span>
00915 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (!MBToWCS((LPSTR)lParam, -1, &amp;lpUniName, -1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))
00916                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00917 
00918             <a class="code" href="../../d5/d6/chartran_8c.html#a7">RtlInitLargeUnicodeString</a>((<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html">PLARGE_UNICODE_STRING</a>)&amp;str,
00919                         lpUniName, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1);
00920 <span class="preprocessor">#endif</span>
00921 <span class="preprocessor"></span>            lParam = (LPARAM)(&amp;str);
00922         }
00923 
00924         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a215">NtUserSendNotifyMessage</a>(
00925                 hwnd,
00926                 wMsg,
00927                 wParam,
00928                 lParam);
00929 
00930     <span class="keywordflow">if</span> (lpUniName)
00931         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(lpUniName);
00932 
00933     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00934     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>);
00935 }
00936 
<a name="l00937"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a29">00937</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d8/ntcftxt_8h.html#a29">SetProp</a>(
00938     HWND hwnd,
00939     LPCTSTR pString,
00940     HANDLE hData)
00941 {
00942     ATOM atomProp;
00943     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwProp;
00944 
00945     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00946 
00947         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(pString)) {
00948             atomProp = GlobalAddAtom(pString);
00949             <span class="keywordflow">if</span> (atomProp == 0)
00950                 <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
00951             dwProp = MAKELONG(atomProp, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00952         } <span class="keywordflow">else</span>
00953             dwProp = MAKELONG(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(pString), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00954 
00955         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a317">NtUserSetProp</a>(
00956                 hwnd,
00957                 dwProp,
00958                 hData);
00959 
00960         <span class="comment">/*</span>
00961 <span class="comment">         * If it failed, get rid of the atom</span>
00962 <span class="comment">         */</span>
00963         <span class="keywordflow">if</span> (retval == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(pString))
00964             GlobalDeleteAtom(atomProp);
00965 
00966     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00967     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>);
00968 }
00969 
<a name="l00970"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a30">00970</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d8/ntcftxt_8h.html#a30">UnregisterClass</a>(
00971     LPCTSTR pszClassName,
00972     HINSTANCE hModule)
00973 {
00974     <a class="code" href="../../d8/d1/struct__IN__STRING.html">IN_STRING</a> strClassName;
00975     <a class="code" href="../../d8/d0/structtagCLSMENUNAME.html">CLSMENUNAME</a> cmn;
00976 
00977     <span class="comment">/*</span>
00978 <span class="comment">     * Make sure cleanup will work successfully</span>
00979 <span class="comment">     */</span>
00980     strClassName.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o2">fAllocated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00981 
00982     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00983 
00984         <a class="code" href="../../d7/d9/ntsend_8h.html#a50">FIRSTCOPYLPTSTRID</a>(&amp;strClassName, pszClassName);
00985 
00986         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a318">NtUserUnregisterClass</a>(
00987                 strClassName.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a>,
00988                 hModule,
00989                 &amp;cmn);
00990 
00991 
00992         <span class="comment">/*</span>
00993 <span class="comment">         * Check explicity for TRUE so we don't get a !FALSE when</span>
00994 <span class="comment">         * converttogui fails and the NtUser returns a status code intead of bool.</span>
00995 <span class="comment">         */</span>
00996         <span class="keywordflow">if</span> (retval == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00997             <span class="comment">/*</span>
00998 <span class="comment">             * Free the menu strings if they are not resource IDs</span>
00999 <span class="comment">             */</span>
01000             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(cmn.<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o0">pszClientAnsiMenuName</a>)) {
01001                 LocalFree(cmn.<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o0">pszClientAnsiMenuName</a>);
01002             }
01003             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(cmn.<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o1">pwszClientUnicodeMenuName</a>)) {
01004                 LocalFree(cmn.<a class="code" href="../../d8/d0/structtagCLSMENUNAME.html#o1">pwszClientUnicodeMenuName</a>);
01005             }
01006         }
01007 
01008     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
01009     <a class="code" href="../../d7/d9/ntsend_8h.html#a55">CLEANUPLPTSTR</a>(strClassName);
01010     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>);
01011 }
01012 
<a name="l01013"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a31">01013</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> <a class="code" href="../../d0/d8/ntcftxt_8h.html#a31">VkKeyScan</a>(
01014     TCHAR cChar)
01015 {
01016     WCHAR wChar;
01017 
01018     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
01019 
01020 #ifdef UNICODE
01021         wChar = cChar;
01022 <span class="preprocessor">#else</span>
01023 <span class="preprocessor"></span><span class="preprocessor">#ifdef FE_SB // VkKeyScan()</span>
01024 <span class="preprocessor"></span>        <span class="comment">/*</span>
01025 <span class="comment">         * Return 0xFFFFFFFF for DBCS LeadByte character.</span>
01026 <span class="comment">         */</span>
01027         <span class="keywordflow">if</span> (IsDBCSLeadByte(cChar)) {
01028             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01029         }
01030 <span class="preprocessor">#endif // FE_SB</span>
01031 <span class="preprocessor"></span>
01032         <a class="code" href="../../d9/d6/nlsxlat_8c.html#a33">RtlMultiByteToUnicodeN</a>((LPWSTR)&amp;(wChar), <span class="keyword">sizeof</span>(WCHAR), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;cChar, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
01033 <span class="preprocessor">#endif // UNICODE</span>
01034 <span class="preprocessor"></span>
01035         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a319">NtUserVkKeyScanEx</a>(
01036                 wChar,
01037                 0,
01038                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01039 
01040     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(-1);
01041     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>);
01042 }
01043 
01044 <span class="preprocessor">#ifndef UNICODE</span>
<a name="l01045"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a8">01045</a> <span class="preprocessor"></span><span class="keyword">static</span> HKL  <a class="code" href="../../d0/d8/ntcftxt_8h.html#a8">hVKSCachedHKL</a> = 0;
<a name="l01046"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a9">01046</a> <span class="keyword">static</span> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d0/d8/ntcftxt_8h.html#a9">uVKSCachedCP</a>  = 0;
01047 <span class="preprocessor">#endif</span>
<a name="l01048"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a32">01048</a> <span class="preprocessor"></span><a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> <a class="code" href="../../d0/d8/ntcftxt_8h.html#a32">VkKeyScanEx</a>(
01049     TCHAR cChar,
01050     HKL hkl)
01051 {
01052     WCHAR wChar;
01053     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
01054 
01055 #ifdef UNICODE
01056         wChar = cChar;
01057 <span class="preprocessor">#else</span>
01058 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (hkl != <a class="code" href="../../d0/d8/ntcftxt_8h.html#a8">hVKSCachedHKL</a>) {
01059             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwCodePage;
01060             <span class="keywordflow">if</span> (!GetLocaleInfoW(
01061                      HandleToUlong(hkl) &amp; 0xffff,
01062                      LOCALE_IDEFAULTANSICODEPAGE | LOCALE_RETURN_NUMBER,
01063                      (LPWSTR)&amp;dwCodePage,
01064                      <span class="keyword">sizeof</span>(dwCodePage) / <span class="keyword">sizeof</span>(WCHAR)
01065                      )) {
01066                 <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01067             }
01068             <a class="code" href="../../d0/d8/ntcftxt_8h.html#a9">uVKSCachedCP</a> = dwCodePage;
01069             <a class="code" href="../../d0/d8/ntcftxt_8h.html#a8">hVKSCachedHKL</a> = hkl;
01070         }
01071 
01072 <span class="preprocessor">#ifdef FE_SB // VkKeyScanEx()</span>
01073 <span class="preprocessor"></span>        <span class="comment">/*</span>
01074 <span class="comment">         * Return 0xFFFFFFFF for DBCS LeadByte character.</span>
01075 <span class="comment">         */</span>
01076         <span class="keywordflow">if</span> (IsDBCSLeadByteEx(<a class="code" href="../../d0/d8/ntcftxt_8h.html#a9">uVKSCachedCP</a>,cChar)) {
01077             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01078         }
01079 <span class="preprocessor">#endif // FE_SB</span>
01080 <span class="preprocessor"></span>
01081         <span class="keywordflow">if</span> (!MultiByteToWideChar(
01082                  <a class="code" href="../../d0/d8/ntcftxt_8h.html#a9">uVKSCachedCP</a>,
01083                  0,
01084                  &amp;cChar,
01085                  <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>),
01086                  &amp;wChar,
01087                  <span class="keyword">sizeof</span>(WCHAR))) {
01088             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01089         }
01090 <span class="preprocessor">#endif // UNICODE</span>
01091 <span class="preprocessor"></span>
01092         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a319">NtUserVkKeyScanEx</a>(
01093                 wChar,
01094                 (ULONG_PTR)hkl,
01095                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01096 
01097     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(-1);
01098     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>);
01099 }
01100 
01101 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l01102"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a33">01102</a> <a class="code" href="../../d0/d8/ntcftxt_8h.html#a33">EnumDisplayDevices</a>(
01103     LPCTSTR lpszDevice,
01104     DWORD iDevNum,
01105     PDISPLAY_DEVICE lpDisplayDevice,
01106     DWORD dwFlags)
01107 {
01108     UNICODE_STRING  UnicodeString;
01109     PUNICODE_STRING pUnicodeString = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01110     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01111     DISPLAY_DEVICEW tmpDisplayDevice;
01112 
01113     <span class="comment">//</span>
01114     <span class="comment">// Clear out things to make sure the caller passes in appropriate</span>
01115     <span class="comment">// parameters</span>
01116     <span class="comment">//</span>
01117 
01118     ZeroMemory(((PUCHAR)lpDisplayDevice) + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>),
01119                lpDisplayDevice-&gt;cb - <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
01120 
01121     tmpDisplayDevice.cb = <span class="keyword">sizeof</span>(DISPLAY_DEVICEW);
01122 
01123     <span class="keywordflow">if</span> (lpszDevice) {
01124 
01125 <span class="preprocessor">#ifdef UNICODE</span>
01126 <span class="preprocessor"></span>
01127         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, lpszDevice);
01128 
01129 <span class="preprocessor">#else</span>
01130 <span class="preprocessor"></span>
01131         ANSI_STRING     AnsiString;
01132 
01133         UnicodeString = NtCurrentTeb()-&gt;StaticUnicodeString;
01134         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;AnsiString, (LPSTR)lpszDevice);
01135 
01136         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;UnicodeString,
01137                                                      &amp;AnsiString,
01138                                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>))) {
01139             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01140         }
01141 
01142 <span class="preprocessor">#endif</span>
01143 <span class="preprocessor"></span>
01144         pUnicodeString = &amp;UnicodeString;
01145     }
01146 
01147     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a320">NtUserEnumDisplayDevices</a>(
01148                 pUnicodeString,
01149                 iDevNum,
01150                 &amp;tmpDisplayDevice,
01151                 <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
01152 
01153     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01154     {
01155 <span class="preprocessor">#ifndef UNICODE</span>
01156 <span class="preprocessor"></span>        LPSTR psz;
01157 
01158         <span class="keywordflow">if</span> (lpDisplayDevice-&gt;cb &gt;= FIELD_OFFSET(DISPLAY_DEVICE, DeviceString)) {
01159             psz = (LPSTR)&amp;(lpDisplayDevice-&gt;DeviceName[0]);
01160             WCSToMB(&amp;(tmpDisplayDevice.DeviceName[0]), -1, &amp;psz, 32, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01161         }
01162 
01163         <span class="keywordflow">if</span> (lpDisplayDevice-&gt;cb &gt;= FIELD_OFFSET(DISPLAY_DEVICE, StateFlags)) {
01164             psz = (LPSTR)&amp;(lpDisplayDevice-&gt;DeviceString[0]);
01165             WCSToMB(&amp;(tmpDisplayDevice.DeviceString[0]), -1, &amp;psz, 128, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01166         }
01167 
01168         <span class="keywordflow">if</span> (lpDisplayDevice-&gt;cb &gt;= FIELD_OFFSET(DISPLAY_DEVICE, DeviceID)) {
01169             lpDisplayDevice-&gt;StateFlags = tmpDisplayDevice.StateFlags;
01170         }
01171 
01172         <span class="keywordflow">if</span> (lpDisplayDevice-&gt;cb &gt;= FIELD_OFFSET(DISPLAY_DEVICE, DeviceKey)) {
01173             psz = (LPSTR)&amp;(lpDisplayDevice-&gt;DeviceID[0]);
01174             WCSToMB(&amp;(tmpDisplayDevice.DeviceID[0]), -1, &amp;psz, 128, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01175         }
01176         <span class="keywordflow">if</span> (lpDisplayDevice-&gt;cb &gt;= <span class="keyword">sizeof</span>(DISPLAY_DEVICE)) {
01177             psz = (LPSTR)&amp;(lpDisplayDevice-&gt;DeviceKey[0]);
01178             WCSToMB(&amp;(tmpDisplayDevice.DeviceKey[0]), -1, &amp;psz, 128, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01179         }
01180 <span class="preprocessor">#else</span>
01181 <span class="preprocessor"></span>
01182         RtlMoveMemory(lpDisplayDevice,
01183                       &amp;tmpDisplayDevice,
01184                       lpDisplayDevice-&gt;cb);
01185 
01186 <span class="preprocessor">#endif</span>
01187 <span class="preprocessor"></span>
01188         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01189     }
01190 
01191     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01192 }
01193 
<a name="l01194"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a34">01194</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d8/ntcftxt_8h.html#a34">EnumDisplaySettings</a>(
01195     LPCTSTR   lpszDeviceName,
01196     DWORD     iModeNum,
01197     LPDEVMODE lpDevMode)
01198 {
01199 
01200     <span class="comment">//</span>
01201     <span class="comment">// Work-around Win95 problem which does not require the caller</span>
01202     <span class="comment">// to initialize these two fields.</span>
01203     <span class="comment">//</span>
01204 
01205     lpDevMode-&gt;dmDriverExtra = 0;
01206     lpDevMode-&gt;dmSize = FIELD_OFFSET(DEVMODE, dmICMMethod);
01207 
01208     <span class="keywordflow">return</span> <a class="code" href="../../d0/d8/ntcftxt_8h.html#a35">EnumDisplaySettingsEx</a>(lpszDeviceName, iModeNum, lpDevMode, 0);
01209 }
01210 
<a name="l01211"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a35">01211</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d8/ntcftxt_8h.html#a35">EnumDisplaySettingsEx</a>(
01212     LPCTSTR   lpszDeviceName,
01213     DWORD     iModeNum,
01214     LPDEVMODE lpDevMode,
01215     DWORD     dwFlags)
01216 {
01217     UNICODE_STRING  UnicodeString;
01218     PUNICODE_STRING pUnicodeString = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01219     LPDEVMODEW      lpDevModeReserve;
01220     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>            retval = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01221     WORD            size = lpDevMode-&gt;dmSize;
01222 
01223     <span class="keywordflow">if</span> (lpszDeviceName) {
01224 
01225 <span class="preprocessor">#ifdef UNICODE</span>
01226 <span class="preprocessor"></span>
01227         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, lpszDeviceName);
01228 
01229 <span class="preprocessor">#else</span>
01230 <span class="preprocessor"></span>
01231         ANSI_STRING     AnsiString;
01232 
01233         UnicodeString = NtCurrentTeb()-&gt;StaticUnicodeString;
01234         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;AnsiString, (LPSTR)lpszDeviceName);
01235 
01236         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;UnicodeString,
01237                                                      &amp;AnsiString,
01238                                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>))) {
01239             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01240         }
01241 
01242 <span class="preprocessor">#endif</span>
01243 <span class="preprocessor"></span>
01244         pUnicodeString = &amp;UnicodeString;
01245     }
01246 
01247     <span class="comment">/*</span>
01248 <span class="comment">     * Currently -2 is reserved (undocumented function of the NT api.</span>
01249 <span class="comment">     * remove the check is win95 implements this.</span>
01250 <span class="comment">     * -&gt; -1 returns the content of the registry at the time of the call</span>
01251 <span class="comment">     *</span>
01252 <span class="comment">     *</span>
01253 <span class="comment">     * if (iModeNum == (DWORD) -2)</span>
01254 <span class="comment">     * {</span>
01255 <span class="comment">     *     return FALSE;</span>
01256 <span class="comment">     * }</span>
01257 <span class="comment">     *</span>
01258 <span class="comment">     *</span>
01259 <span class="comment">     * -1 should return the current DEVMODE for the device.</span>
01260 <span class="comment">     * This is handled in the kernel part of the function, so we pass it on.</span>
01261 <span class="comment">     *</span>
01262 <span class="comment">     *</span>
01263 <span class="comment">     *</span>
01264 <span class="comment">     * We will always request a full DEVMODE from the kernel.</span>
01265 <span class="comment">     * So allocate the space needed</span>
01266 <span class="comment">     *</span>
01267 <span class="comment">     */</span>
01268     lpDevModeReserve = <a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(HEAP_ZERO_MEMORY,
01269                                       <span class="keyword">sizeof</span>(DEVMODEW) + lpDevMode-&gt;dmDriverExtra);
01270 
01271     <span class="keywordflow">if</span> (lpDevModeReserve) {
01272 
01273         lpDevModeReserve-&gt;dmSize = <span class="keyword">sizeof</span>(DEVMODEW);
01274         lpDevModeReserve-&gt;dmDriverExtra = lpDevMode-&gt;dmDriverExtra;
01275 
01276         <span class="comment">/*</span>
01277 <span class="comment">         * Get the information</span>
01278 <span class="comment">         */</span>
01279         retval = (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a321">NtUserEnumDisplaySettings</a>(pUnicodeString,
01280                                                        iModeNum,
01281                                                        lpDevModeReserve,
01282                                                        <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>)));
01283         <span class="keywordflow">if</span> (retval) {
01284 
01285 <span class="preprocessor">#ifndef UNICODE</span>
01286 <span class="preprocessor"></span>            LPSTR psz;
01287 <span class="preprocessor">#endif</span>
01288 <span class="preprocessor"></span>
01289             <span class="comment">/*</span>
01290 <span class="comment">             * return only the amount of information requested.</span>
01291 <span class="comment">             * For ANSI, this requires a conversion.</span>
01292 <span class="comment">             */</span>
01293 
01294             <span class="comment">/*</span>
01295 <span class="comment">             * First, copy the driver extra information</span>
01296 <span class="comment">             */</span>
01297 
01298             <span class="keywordflow">if</span> (lpDevMode-&gt;dmDriverExtra &amp;&amp;
01299                 lpDevModeReserve-&gt;dmDriverExtra) {
01300 
01301                 RtlMoveMemory(((PUCHAR)lpDevMode) + size,
01302                               lpDevModeReserve + 1,
01303                               <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(lpDevMode-&gt;dmDriverExtra,
01304                                   lpDevModeReserve-&gt;dmDriverExtra));
01305             }
01306 
01307 <span class="preprocessor">#ifndef UNICODE</span>
01308 <span class="preprocessor"></span>            psz = (LPSTR)&amp;(lpDevMode-&gt;dmDeviceName[0]);
01309 
01310             retval = WCSToMB(lpDevModeReserve-&gt;dmDeviceName,
01311                              -1,
01312                              &amp;psz,
01313                              32,
01314                              <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01315 
01316             RtlMoveMemory(&amp;lpDevMode-&gt;dmSpecVersion,
01317                           &amp;lpDevModeReserve-&gt;dmSpecVersion,
01318                           <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(size, FIELD_OFFSET(DEVMODE,dmFormName)) -
01319                               FIELD_OFFSET(DEVMODE,dmSpecVersion));
01320 
01321             lpDevMode-&gt;dmSize = size;
01322 
01323             <span class="keywordflow">if</span> (size &gt;= FIELD_OFFSET(DEVMODE,dmFormName)) {
01324 
01325                 psz = (LPSTR)&amp;(lpDevMode-&gt;dmFormName[0]);
01326 
01327                 retval = WCSToMB(lpDevModeReserve-&gt;dmFormName, -1, &amp;psz, 32, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01328             }
01329 
01330             <span class="keywordflow">if</span> (size &gt; FIELD_OFFSET(DEVMODE,dmBitsPerPel)) {
01331 
01332                 RtlMoveMemory(&amp;lpDevMode-&gt;dmBitsPerPel,
01333                               &amp;lpDevModeReserve-&gt;dmBitsPerPel,
01334                               lpDevMode-&gt;dmSize +
01335                                   lpDevMode-&gt;dmDriverExtra -
01336                                   FIELD_OFFSET(DEVMODE,dmBitsPerPel));
01337             }
01338 
01339 <span class="preprocessor">#else</span>
01340 <span class="preprocessor"></span>            RtlMoveMemory(lpDevMode, lpDevModeReserve, size);
01341 
01342             lpDevMode-&gt;dmSize = size;
01343 
01344 <span class="preprocessor">#endif</span>
01345 <span class="preprocessor"></span>
01346             <span class="keywordflow">if</span> (size != lpDevMode-&gt;dmSize) {
01347                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"EnumDisplaySettings : Error in dmSize"</span>);
01348             }
01349 
01350             <span class="comment">/*</span>
01351 <span class="comment">             * Don't return invalid field flags to the application</span>
01352 <span class="comment">             * Add any other new ones here.</span>
01353 <span class="comment">             *</span>
01354 <span class="comment">             * We assume apps at least have up to dmDisplayFrenquency for</span>
01355 <span class="comment">             * now ...</span>
01356 <span class="comment">             */</span>
01357 
01358             <span class="keywordflow">if</span> (size &lt; FIELD_OFFSET(DEVMODE,dmPanningWidth))
01359                 lpDevMode-&gt;dmFields &amp;= ~DM_PANNINGWIDTH;
01360 
01361             <span class="keywordflow">if</span> (size &lt; FIELD_OFFSET(DEVMODE,dmPanningHeight))
01362                 lpDevMode-&gt;dmFields &amp;= ~DM_PANNINGHEIGHT;
01363         }
01364 
01365         LocalFree(lpDevModeReserve);
01366     }
01367 
01368     <span class="keywordflow">return</span> retval;
01369 }
01370 
01371 
<a name="l01372"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a36">01372</a> LONG <a class="code" href="../../d0/d8/ntcftxt_8h.html#a36">ChangeDisplaySettings</a>(
01373     LPDEVMODE lpDevMode,
01374     DWORD     dwFlags)
01375 {
01376 
01377     <span class="comment">/*</span>
01378 <span class="comment">     * Compatibility</span>
01379 <span class="comment">     */</span>
01380     <span class="keywordflow">if</span> (lpDevMode)
01381         lpDevMode-&gt;dmDriverExtra = 0;
01382 
01383     <span class="keywordflow">return</span> <a class="code" href="../../d0/d8/ntcftxt_8h.html#a37">ChangeDisplaySettingsEx</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, lpDevMode, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01384 }
01385 
<a name="l01386"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a37">01386</a> LONG <a class="code" href="../../d0/d8/ntcftxt_8h.html#a37">ChangeDisplaySettingsEx</a>(
01387     LPCTSTR   lpszDeviceName,
01388     LPDEVMODE lpDevMode,
01389     HWND      hwnd,
01390     DWORD     dwFlags,
01391     LPVOID    lParam)
01392 {
01393 <span class="preprocessor">#ifndef UNICODE</span>
01394 <span class="preprocessor"></span>    ANSI_STRING     AnsiString;
01395 <span class="preprocessor">#endif</span>
01396 <span class="preprocessor"></span>
01397     UNICODE_STRING  UnicodeString;
01398     PUNICODE_STRING pUnicodeString = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01399     LONG            status = DISP_CHANGE_FAILED;
01400     LPDEVMODEW      lpDevModeW;
01401 
01402     <span class="keywordflow">if</span> (lpszDeviceName) {
01403 
01404 <span class="preprocessor">#ifdef UNICODE</span>
01405 <span class="preprocessor"></span>
01406         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, lpszDeviceName);
01407 
01408 <span class="preprocessor">#else</span>
01409 <span class="preprocessor"></span>
01410         UnicodeString = NtCurrentTeb()-&gt;StaticUnicodeString;
01411         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;AnsiString, (LPSTR)lpszDeviceName);
01412 
01413         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;UnicodeString,
01414                                                      &amp;AnsiString,
01415                                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>))) {
01416             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01417         }
01418 
01419 <span class="preprocessor">#endif</span>
01420 <span class="preprocessor"></span>
01421         pUnicodeString = &amp;UnicodeString;
01422     }
01423 
01424 <span class="preprocessor">#ifdef UNICODE</span>
01425 <span class="preprocessor"></span>
01426     lpDevModeW = lpDevMode;
01427 
01428 <span class="preprocessor">#else</span>
01429 <span class="preprocessor"></span>
01430     lpDevModeW = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01431 
01432     <span class="keywordflow">if</span> (lpDevMode) {
01433 
01434         lpDevModeW = GdiConvertToDevmodeW(lpDevMode);
01435 
01436         <span class="keywordflow">if</span> (lpDevModeW == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01437 
01438             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01439         }
01440     }
01441 
01442 <span class="preprocessor">#endif</span>
01443 <span class="preprocessor"></span>
01444     status = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a322">NtUserChangeDisplaySettings</a>(pUnicodeString,
01445                                          lpDevModeW,
01446                                          hwnd,
01447                                          <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>,
01448                                          lParam);
01449 
01450 <span class="preprocessor">#ifndef UNICODE</span>
01451 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (lpDevMode) {
01452         LocalFree(lpDevModeW);
01453     }
01454 <span class="preprocessor">#endif</span>
01455 <span class="preprocessor"></span>
01456     <span class="keywordflow">return</span> status;
01457 }
01458 
01459 
<a name="l01460"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a38">01460</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d8/ntcftxt_8h.html#a38">CallMsgFilter</a>(
01461     LPMSG pmsg,
01462     <span class="keywordtype">int</span>   nCode)
01463 {
01464     <a class="code" href="../../d2/d2/struct__CLIENTINFO.html">PCLIENTINFO</a> pci;
01465     MSG         <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
01466 
01467     <a class="code" href="../../d7/d9/ntsend_8h.html#a0">BEGINCALLCONNECT</a>()
01468 
01469         <span class="comment">/*</span>
01470 <span class="comment">         * If we're not hooked, don't bother going to the server</span>
01471 <span class="comment">         */</span>
01472         pci = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>();
01473         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(pci, (WH_MSGFILTER | WH_SYSMSGFILTER))) {
01474             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01475         }
01476 
01477         <span class="comment">/*</span>
01478 <span class="comment">         * Don't allow apps to use the hiword of the message parameter.</span>
01479 <span class="comment">         */</span>
01480         <span class="keywordflow">if</span> (pmsg-&gt;message &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a8">RESERVED_MSG_BITS</a>) {
01481             <a class="code" href="../../d5/d8/crecv_8c.html#a8">MSGERRORCODE</a>(ERROR_INVALID_PARAMETER);
01482         }
01483         <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> = *pmsg;
01484 
01485 <span class="preprocessor">#ifndef UNICODE</span>
01486 <span class="preprocessor"></span>        <span class="keywordflow">switch</span> (pmsg-&gt;message) {
01487 <span class="preprocessor">#ifdef FE_SB // CallMsgFilter()</span>
01488 <span class="preprocessor"></span>        <span class="keywordflow">case</span> WM_CHAR:
01489         <span class="keywordflow">case</span> EM_SETPASSWORDCHAR:
01490 <span class="preprocessor">#ifndef LATER</span>
01491 <span class="preprocessor"></span>             <span class="comment">/*</span>
01492 <span class="comment">              * we should not return "TRUE" everytime for DBCS leadbyte character...</span>
01493 <span class="comment">              * but should convert DBCS character to Unicode correctly.. How I can do ??</span>
01494 <span class="comment">              * then ,finally, we just take what we did in NT 3.51, it means do nothing..</span>
01495 <span class="comment">              */</span>
01496 <span class="preprocessor">#else</span>
01497 <span class="preprocessor"></span>             <span class="comment">/*</span>
01498 <span class="comment">              * Build DBCS-aware message.</span>
01499 <span class="comment">              */</span>
01500              <a class="code" href="../../d6/d0/usercli_8h.html#a294">BUILD_DBCS_MESSAGE_TO_SERVER_FROM_CLIENTA</a>(pmsg-&gt;message,pmsg-&gt;wParam,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01501              <span class="comment">/*</span>
01502 <span class="comment">              * Fall through.....</span>
01503 <span class="comment">              */</span>
01504 <span class="preprocessor">#endif // LATER</span>
01505 <span class="preprocessor"></span><span class="preprocessor">#else</span>
01506 <span class="preprocessor"></span>        <span class="keywordflow">case</span> WM_CHAR:
01507         <span class="keywordflow">case</span> EM_SETPASSWORDCHAR:
01508 <span class="preprocessor">#endif // FE_SB</span>
01509 <span class="preprocessor"></span>        <span class="keywordflow">case</span> WM_CHARTOITEM:
01510         <span class="keywordflow">case</span> WM_DEADCHAR:
01511         <span class="keywordflow">case</span> WM_SYSCHAR:
01512         <span class="keywordflow">case</span> WM_SYSDEADCHAR:
01513         <span class="keywordflow">case</span> WM_MENUCHAR:
01514 <span class="preprocessor">#ifdef FE_IME // CallMsgFilter()</span>
01515 <span class="preprocessor"></span>        <span class="keywordflow">case</span> WM_IME_CHAR:
01516         <span class="keywordflow">case</span> WM_IME_COMPOSITION:
01517 <span class="preprocessor">#endif // FE_IME</span>
01518 <span class="preprocessor"></span>
01519             <a class="code" href="../../d5/d6/chartran_8c.html#a5">RtlMBMessageWParamCharToWCS</a>( <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message, &amp;(<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.wParam));
01520             <span class="keywordflow">break</span>;
01521         }
01522 <span class="preprocessor">#endif </span>
01523 <span class="preprocessor"></span>
01524 <span class="preprocessor"></span>        retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a323">NtUserCallMsgFilter</a>(
01525                 &amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
01526                 nCode);
01527 
01528     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
01529     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>);
01530 }
01531 
<a name="l01532"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a39">01532</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d8/ntcftxt_8h.html#a39">DrawCaptionTemp</a>(
01533     HWND hwnd,
01534     HDC hdc,
01535     LPCRECT lprc,
01536     HFONT hFont,
01537     HICON hicon,
01538     LPCTSTR lpText,
01539     UINT flags)
01540 {
01541     HDC hdcr;
01542     <a class="code" href="../../d8/d1/struct__IN__STRING.html">IN_STRING</a> strText;
01543 
01544     <span class="comment">/*</span>
01545 <span class="comment">     * Make sure cleanup will work successfully</span>
01546 <span class="comment">     */</span>
01547     strText.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o2">fAllocated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01548 
01549     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
01550 
01551         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a547">IsMetaFile</a>(hdc)) <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01552 
01553         hdcr = GdiConvertAndCheckDC(hdc);
01554         <span class="keywordflow">if</span> (hdcr == (HDC)0)
01555             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01556 
01557         <a class="code" href="../../d7/d9/ntsend_8h.html#a51">FIRSTCOPYLPTSTRIDOPT</a>(&amp;strText, lpText);
01558 
01559         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a325">NtUserDrawCaptionTemp</a>(
01560                 hwnd,
01561                 hdc,
01562                 lprc,
01563                 hFont,
01564                 hicon,
01565                 strText.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a>,
01566                 flags);
01567 
01568     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
01569     <a class="code" href="../../d7/d9/ntsend_8h.html#a55">CLEANUPLPTSTR</a>(strText);
01570     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>);
01571 }
01572 
01573 WINUSERAPI <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> WINAPI
<a name="l01574"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a40">01574</a> <a class="code" href="../../d0/d8/ntcftxt_8h.html#a40">RealGetWindowClass</a>(
01575     HWND hwnd,
01576     LPTSTR ptszClassName,
01577     UINT cchClassNameMax)
01578 {
01579     UNICODE_STRING strClassName;
01580     <span class="keywordtype">int</span> retval;
01581 
01582     strClassName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(cchClassNameMax * <span class="keyword">sizeof</span>(WCHAR));
01583 
01584 <span class="preprocessor">#ifndef UNICODE</span>
01585 <span class="preprocessor"></span>    strClassName.Buffer = LocalAlloc(LMEM_FIXED, strClassName.MaximumLength);
01586     <span class="keywordflow">if</span> (!strClassName.Buffer) {
01587         <span class="keywordflow">return</span> 0;
01588     }
01589 <span class="preprocessor">#else</span>
01590 <span class="preprocessor"></span>    strClassName.Buffer = ptszClassName;
01591 <span class="preprocessor">#endif</span>
01592 <span class="preprocessor"></span>
01593     retval = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a308">NtUserGetClassName</a>(hwnd, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, &amp;strClassName);
01594 
01595 <span class="preprocessor">#ifndef UNICODE</span>
01596 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (retval || (cchClassNameMax == 1)) {
01597         <span class="comment">/*</span>
01598 <span class="comment">         * Copy the result</span>
01599 <span class="comment">         */</span>
01600         retval = WCSToMB(strClassName.Buffer, retval,
01601                 &amp;ptszClassName, cchClassNameMax-1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01602         ptszClassName[retval] = <span class="charliteral">'\0'</span>;
01603     }
01604     LocalFree(strClassName.Buffer);
01605 <span class="preprocessor">#endif</span>
01606 <span class="preprocessor"></span>
01607   <span class="keywordflow">return</span> retval;
01608 }
01609 
<a name="l01610"></a><a class="code" href="../../d0/d8/ntcftxt_8h.html#a41">01610</a> WINUSERAPI <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d0/d8/ntcftxt_8h.html#a41">GetAltTabInfo</a>(
01611     HWND hwnd,
01612     <span class="keywordtype">int</span> iItem,
01613     PALTTABINFO pati,
01614     LPTSTR pszItemText,
01615     UINT cchItemText OPTIONAL)
01616 {
01617     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
01618 
01619     retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a146">NtUserGetAltTabInfo</a>(hwnd,  iItem, pati,
01620             (LPWSTR)pszItemText, cchItemText, <a class="code" href="../../d5/d9/cltxt_8h.html#a0">IS_ANSI</a>);
01621 
01622     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
01623     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>);
01624 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:59 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
