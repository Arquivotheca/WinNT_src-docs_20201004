<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: event.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>event.c</h1><a href="../../d0/d8/ex_2event_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    event.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">   This module implements the executive event object. Functions are provided</span>
00012 <span class="comment">   to create, open, set, reset, pulse, and query event objects.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    David N. Cutler (davec) 8-May-1989</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Kernel mode only.</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="../../d4/d0/exp_8h.html">exp.h</a>"</span>
00027 
00028 <span class="comment">//</span>
00029 <span class="comment">// Temporary so boost is patchable</span>
00030 <span class="comment">//</span>
00031 
<a name="l00032"></a><a class="code" href="../../d0/d8/ex_2event_8c.html#a0">00032</a> ULONG <a class="code" href="../../d0/d8/ex_2event_8c.html#a0">ExpEventBoost</a> = <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>;
00033 
00034 <span class="comment">//</span>
00035 <span class="comment">// Address of event object type descriptor.</span>
00036 <span class="comment">//</span>
00037 
<a name="l00038"></a><a class="code" href="../../d0/d8/ex_2event_8c.html#a1">00038</a> <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a3">ExEventObjectType</a>;
00039 
00040 <span class="comment">//</span>
00041 <span class="comment">// Structure that describes the mapping of generic access rights to object</span>
00042 <span class="comment">// specific access rights for event objects.</span>
00043 <span class="comment">//</span>
00044 
<a name="l00045"></a><a class="code" href="../../d0/d8/ex_2event_8c.html#a2">00045</a> GENERIC_MAPPING <a class="code" href="../../d0/d8/ex_2event_8c.html#a2">ExpEventMapping</a> = {
00046     STANDARD_RIGHTS_READ |
00047         EVENT_QUERY_STATE,
00048     STANDARD_RIGHTS_WRITE |
00049         EVENT_MODIFY_STATE,
00050     STANDARD_RIGHTS_EXECUTE |
00051         SYNCHRONIZE,
00052     EVENT_ALL_ACCESS
00053 };
00054 
00055 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00056 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, ExpEventInitialization)</span>
00057 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtClearEvent)</span>
00058 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtCreateEvent)</span>
00059 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtOpenEvent)</span>
00060 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtPulseEvent)</span>
00061 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtQueryEvent)</span>
00062 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtResetEvent)</span>
00063 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtSetEvent)</span>
00064 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00065 <span class="preprocessor"></span>
00066 BOOLEAN
<a name="l00067"></a><a class="code" href="../../d0/d8/ex_2event_8c.html#a3">00067</a> <a class="code" href="../../d0/d8/ex_2event_8c.html#a3">ExpEventInitialization</a> (
00068     )
00069 
00070 <span class="comment">/*++</span>
00071 <span class="comment"></span>
00072 <span class="comment">Routine Description:</span>
00073 <span class="comment"></span>
00074 <span class="comment">    This function creates the event object type descriptor at system</span>
00075 <span class="comment">    initialization and stores the address of the object type descriptor</span>
00076 <span class="comment">    in global storage.</span>
00077 <span class="comment"></span>
00078 <span class="comment">Arguments:</span>
00079 <span class="comment"></span>
00080 <span class="comment">    None.</span>
00081 <span class="comment"></span>
00082 <span class="comment">Return Value:</span>
00083 <span class="comment"></span>
00084 <span class="comment">    A value of TRUE is returned if the event object type descriptor is</span>
00085 <span class="comment">    successfully initialized. Otherwise a value of FALSE is returned.</span>
00086 <span class="comment"></span>
00087 <span class="comment">--*/</span>
00088 
00089 {
00090 
00091     <a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html">OBJECT_TYPE_INITIALIZER</a> ObjectTypeInitializer;
00092     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00093     UNICODE_STRING TypeName;
00094 
00095     <span class="comment">//</span>
00096     <span class="comment">// Initialize string descriptor.</span>
00097     <span class="comment">//</span>
00098 
00099     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;TypeName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Event"</span>);
00100 
00101     <span class="comment">//</span>
00102     <span class="comment">// Create event object type descriptor.</span>
00103     <span class="comment">//</span>
00104 
00105     RtlZeroMemory(&amp;ObjectTypeInitializer, <span class="keyword">sizeof</span>(ObjectTypeInitializer));
00106     ObjectTypeInitializer.Length = <span class="keyword">sizeof</span>(ObjectTypeInitializer);
00107     ObjectTypeInitializer.InvalidAttributes = OBJ_OPENLINK;
00108     ObjectTypeInitializer.GenericMapping = <a class="code" href="../../d0/d8/ex_2event_8c.html#a2">ExpEventMapping</a>;
00109     ObjectTypeInitializer.PoolType = <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>;
00110     ObjectTypeInitializer.DefaultNonPagedPoolCharge = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>);
00111     ObjectTypeInitializer.ValidAccessMask = EVENT_ALL_ACCESS;
00112     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>(&amp;TypeName,
00113                                 &amp;ObjectTypeInitializer,
00114                                 (PSECURITY_DESCRIPTOR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00115                                 &amp;<a class="code" href="../../d7/d7/ntapi_8c.html#a3">ExEventObjectType</a>);
00116 
00117     <span class="comment">//</span>
00118     <span class="comment">// If the event object type descriptor was successfully created, then</span>
00119     <span class="comment">// return a value of TRUE. Otherwise return a value of FALSE.</span>
00120     <span class="comment">//</span>
00121 
00122     <span class="keywordflow">return</span> (BOOLEAN)(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00123 }
00124 
00125 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00126"></a><a class="code" href="../../d0/d8/ex_2event_8c.html#a4">00126</a> <a class="code" href="../../d0/d8/ex_2event_8c.html#a4">NtClearEvent</a> (
00127     IN HANDLE EventHandle
00128     )
00129 
00130 <span class="comment">/*++</span>
00131 <span class="comment"></span>
00132 <span class="comment">Routine Description:</span>
00133 <span class="comment"></span>
00134 <span class="comment">    This function sets an event object to a Not-Signaled state.</span>
00135 <span class="comment"></span>
00136 <span class="comment">Arguments:</span>
00137 <span class="comment"></span>
00138 <span class="comment">    EventHandle - Supplies a handle to an event object.</span>
00139 <span class="comment"></span>
00140 <span class="comment">Return Value:</span>
00141 <span class="comment"></span>
00142 <span class="comment">    TBS</span>
00143 <span class="comment"></span>
00144 <span class="comment">--*/</span>
00145 
00146 {
00147 
00148     PVOID <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00149     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00150 
00151     <span class="comment">//</span>
00152     <span class="comment">// Reference event object by handle.</span>
00153     <span class="comment">//</span>
00154 
00155     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a7">EventHandle</a>,
00156                                        EVENT_MODIFY_STATE,
00157                                        <a class="code" href="../../d7/d7/ntapi_8c.html#a3">ExEventObjectType</a>,
00158                                        KeGetPreviousMode(),
00159                                        &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>,
00160                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00161 
00162     <span class="comment">//</span>
00163     <span class="comment">// If the reference was successful, then set the state of the event</span>
00164     <span class="comment">// object to Not-Signaled and dereference event object.</span>
00165     <span class="comment">//</span>
00166 
00167     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00168         <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>((<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>)<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>);
00169         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>);
00170     }
00171 
00172     <span class="comment">//</span>
00173     <span class="comment">// Return service status.</span>
00174     <span class="comment">//</span>
00175 
00176     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00177 }
00178 
00179 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00180"></a><a class="code" href="../../d0/d8/ex_2event_8c.html#a5">00180</a> <a class="code" href="../../d0/d8/ex_2event_8c.html#a5">NtCreateEvent</a> (
00181     OUT PHANDLE EventHandle,
00182     IN ACCESS_MASK DesiredAccess,
00183     IN POBJECT_ATTRIBUTES ObjectAttributes OPTIONAL,
00184     IN EVENT_TYPE EventType,
00185     IN BOOLEAN InitialState
00186     )
00187 
00188 <span class="comment">/*++</span>
00189 <span class="comment"></span>
00190 <span class="comment">Routine Description:</span>
00191 <span class="comment"></span>
00192 <span class="comment">    This function creates an event object, sets it initial state to the</span>
00193 <span class="comment">    specified value, and opens a handle to the object with the specified</span>
00194 <span class="comment">    desired access.</span>
00195 <span class="comment"></span>
00196 <span class="comment">Arguments:</span>
00197 <span class="comment"></span>
00198 <span class="comment">    EventHandle - Supplies a pointer to a variable that will receive the</span>
00199 <span class="comment">        event object handle.</span>
00200 <span class="comment"></span>
00201 <span class="comment">    DesiredAccess - Supplies the desired types of access for the event object.</span>
00202 <span class="comment"></span>
00203 <span class="comment">    ObjectAttributes - Supplies a pointer to an object attributes structure.</span>
00204 <span class="comment"></span>
00205 <span class="comment">    EventType - Supplies the type of the event (autoclearing or notification).</span>
00206 <span class="comment"></span>
00207 <span class="comment">    InitialState - Supplies the initial state of the event object.</span>
00208 <span class="comment"></span>
00209 <span class="comment">Return Value:</span>
00210 <span class="comment"></span>
00211 <span class="comment">    TBS</span>
00212 <span class="comment"></span>
00213 <span class="comment">--*/</span>
00214 
00215 {
00216 
00217     PVOID <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00218     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00219     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00220     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00221 
00222     <span class="comment">//</span>
00223     <span class="comment">// Establish an exception handler, probe the output handle address, and</span>
00224     <span class="comment">// attempt to create an event object. If the probe fails, then return the</span>
00225     <span class="comment">// exception code as the service status. Otherwise return the status value</span>
00226     <span class="comment">// returned by the object insertion routine.</span>
00227     <span class="comment">//</span>
00228 
00229     <span class="keywordflow">try</span> {
00230 
00231         <span class="comment">//</span>
00232         <span class="comment">// Get previous processor mode and probe output handle address if</span>
00233         <span class="comment">// necessary.</span>
00234         <span class="comment">//</span>
00235 
00236         PreviousMode = KeGetPreviousMode();
00237         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00238             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>(<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a7">EventHandle</a>);
00239         }
00240 
00241         <span class="comment">//</span>
00242         <span class="comment">// Check argument validity.</span>
00243         <span class="comment">//</span>
00244 
00245         <span class="keywordflow">if</span> ((EventType != NotificationEvent) &amp;&amp; (EventType != SynchronizationEvent)) {
00246             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00247         }
00248 
00249         <span class="comment">//</span>
00250         <span class="comment">// Allocate event object.</span>
00251         <span class="comment">//</span>
00252 
00253         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>(PreviousMode,
00254                                 <a class="code" href="../../d7/d7/ntapi_8c.html#a3">ExEventObjectType</a>,
00255                                 <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00256                                 PreviousMode,
00257                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00258                                 <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>),
00259                                 0,
00260                                 0,
00261                                 (PVOID *)&amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>);
00262 
00263         <span class="comment">//</span>
00264         <span class="comment">// If the event object was successfully allocated, then initialize the</span>
00265         <span class="comment">// event object and attempt to insert the event object in the current</span>
00266         <span class="comment">// process' handle table.</span>
00267         <span class="comment">//</span>
00268 
00269         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00270             <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>((<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>)<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>, EventType, InitialState);
00271             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>(<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>,
00272                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00273                                     DesiredAccess,
00274                                     0,
00275                                     (PVOID *)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00276                                     &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
00277 
00278             <span class="comment">//</span>
00279             <span class="comment">// If the event object was successfully inserted in the current</span>
00280             <span class="comment">// process' handle table, then attempt to write the event object</span>
00281             <span class="comment">// handle value. If the write attempt fails, then do not report</span>
00282             <span class="comment">// an error. When the caller attempts to access the handle value,</span>
00283             <span class="comment">// an access violation will occur.</span>
00284             <span class="comment">//</span>
00285 
00286             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00287                 <span class="keywordflow">try</span> {
00288                     *<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a7">EventHandle</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00289 
00290                 } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00291                 }
00292             }
00293         }
00294 
00295     <span class="comment">//</span>
00296     <span class="comment">// If an exception occurs during the probe of the output handle address,</span>
00297     <span class="comment">// then always handle the exception and return the exception code as the</span>
00298     <span class="comment">// status value.</span>
00299     <span class="comment">//</span>
00300 
00301     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00302         <span class="keywordflow">return</span> GetExceptionCode();
00303     }
00304 
00305     <span class="comment">//</span>
00306     <span class="comment">// Return service status.</span>
00307     <span class="comment">//</span>
00308 
00309     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00310 }
00311 
00312 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00313"></a><a class="code" href="../../d0/d8/ex_2event_8c.html#a6">00313</a> <a class="code" href="../../d0/d8/ex_2event_8c.html#a6">NtOpenEvent</a> (
00314     OUT PHANDLE EventHandle,
00315     IN ACCESS_MASK DesiredAccess,
00316     IN POBJECT_ATTRIBUTES ObjectAttributes
00317     )
00318 
00319 <span class="comment">/*++</span>
00320 <span class="comment"></span>
00321 <span class="comment">Routine Description:</span>
00322 <span class="comment"></span>
00323 <span class="comment">    This function opens a handle to an event object with the specified</span>
00324 <span class="comment">    desired access.</span>
00325 <span class="comment"></span>
00326 <span class="comment">Arguments:</span>
00327 <span class="comment"></span>
00328 <span class="comment">    EventHandle - Supplies a pointer to a variable that will receive the</span>
00329 <span class="comment">        event object handle.</span>
00330 <span class="comment"></span>
00331 <span class="comment">    DesiredAccess - Supplies the desired types of access for the event object.</span>
00332 <span class="comment"></span>
00333 <span class="comment">    ObjectAttributes - Supplies a pointer to an object attributes structure.</span>
00334 <span class="comment"></span>
00335 <span class="comment">Return Value:</span>
00336 <span class="comment"></span>
00337 <span class="comment">    TBS</span>
00338 <span class="comment"></span>
00339 <span class="comment">--*/</span>
00340 
00341 {
00342 
00343     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00344     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00345     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00346 
00347 
00348     <span class="comment">//</span>
00349     <span class="comment">// Establish an exception handler, probe the output handle address, and</span>
00350     <span class="comment">// attempt to open the event object. If the probe fails, then return the</span>
00351     <span class="comment">// exception code as the service status. Otherwise return the status value</span>
00352     <span class="comment">// returned by the object open routine.</span>
00353     <span class="comment">//</span>
00354 
00355     <span class="keywordflow">try</span> {
00356 
00357         <span class="comment">//</span>
00358         <span class="comment">// Get previous processor mode and probe output handle address</span>
00359         <span class="comment">// if necessary.</span>
00360         <span class="comment">//</span>
00361 
00362         PreviousMode = KeGetPreviousMode();
00363         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00364             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>(<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a7">EventHandle</a>);
00365         }
00366 
00367         <span class="comment">//</span>
00368         <span class="comment">// Open handle to the event object with the specified desired access.</span>
00369         <span class="comment">//</span>
00370 
00371         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>(<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00372                                     <a class="code" href="../../d7/d7/ntapi_8c.html#a3">ExEventObjectType</a>,
00373                                     PreviousMode,
00374                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00375                                     DesiredAccess,
00376                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00377                                     &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
00378 
00379         <span class="comment">//</span>
00380         <span class="comment">// If the open was successful, then attempt to write the event object</span>
00381         <span class="comment">// handle value. If the write attempt fails, then do not report an</span>
00382         <span class="comment">// error. When the caller attempts to access the handle value, an</span>
00383         <span class="comment">// access violation will occur.</span>
00384         <span class="comment">//</span>
00385 
00386         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00387             <span class="keywordflow">try</span> {
00388                 *<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a7">EventHandle</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00389 
00390             } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00391             }
00392         }
00393 
00394     <span class="comment">//</span>
00395     <span class="comment">// If an exception occurs during the probe of the output event handle,</span>
00396     <span class="comment">// then always handle the exception and return the exception code as the</span>
00397     <span class="comment">// status value.</span>
00398     <span class="comment">//</span>
00399 
00400     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00401         <span class="keywordflow">return</span> GetExceptionCode();
00402     }
00403 
00404     <span class="comment">//</span>
00405     <span class="comment">// Return service status.</span>
00406     <span class="comment">//</span>
00407 
00408     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00409 }
00410 
00411 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00412"></a><a class="code" href="../../d0/d8/ex_2event_8c.html#a7">00412</a> <a class="code" href="../../d0/d8/ex_2event_8c.html#a7">NtPulseEvent</a> (
00413     IN HANDLE EventHandle,
00414     OUT PLONG PreviousState OPTIONAL
00415     )
00416 
00417 <span class="comment">/*++</span>
00418 <span class="comment"></span>
00419 <span class="comment">Routine Description:</span>
00420 <span class="comment"></span>
00421 <span class="comment">    This function sets an event object to a Signaled state, attempts to</span>
00422 <span class="comment">    satisfy as many waits as possible, and then resets the state of the</span>
00423 <span class="comment">    event object to Not-Signaled.</span>
00424 <span class="comment"></span>
00425 <span class="comment">Arguments:</span>
00426 <span class="comment"></span>
00427 <span class="comment">    EventHandle - Supplies a handle to an event object.</span>
00428 <span class="comment"></span>
00429 <span class="comment">    PreviousState - Supplies an optional pointer to a variable that will</span>
00430 <span class="comment">        receive the previous state of the event object.</span>
00431 <span class="comment"></span>
00432 <span class="comment">Return Value:</span>
00433 <span class="comment"></span>
00434 <span class="comment">    TBS</span>
00435 <span class="comment"></span>
00436 <span class="comment">--*/</span>
00437 
00438 {
00439 
00440     PVOID <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00441     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00442     LONG State;
00443     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00444 
00445     <span class="comment">//</span>
00446     <span class="comment">// Establish an exception handler, probe the previous state address if</span>
00447     <span class="comment">// specified, reference the event object, and pulse the event object. If</span>
00448     <span class="comment">// the probe fails, then return the exception code as the service status.</span>
00449     <span class="comment">// Otherwise return the status value returned by the reference object by</span>
00450     <span class="comment">// handle routine.</span>
00451     <span class="comment">//</span>
00452 
00453     <span class="keywordflow">try</span> {
00454 
00455         <span class="comment">//</span>
00456         <span class="comment">// Get previous processor mode and probe previous state address</span>
00457         <span class="comment">// if necessary.</span>
00458         <span class="comment">//</span>
00459 
00460         PreviousMode = KeGetPreviousMode();
00461         <span class="keywordflow">if</span> ((PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp; (ARGUMENT_PRESENT(PreviousState))) {
00462             <a class="code" href="../../d5/d8/ex_8h.html#a39">ProbeForWriteLong</a>(PreviousState);
00463         }
00464 
00465         <span class="comment">//</span>
00466         <span class="comment">// Reference event object by handle.</span>
00467         <span class="comment">//</span>
00468 
00469         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a7">EventHandle</a>,
00470                                            EVENT_MODIFY_STATE,
00471                                            <a class="code" href="../../d7/d7/ntapi_8c.html#a3">ExEventObjectType</a>,
00472                                            PreviousMode,
00473                                            &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>,
00474                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00475 
00476         <span class="comment">//</span>
00477         <span class="comment">// If the reference was successful, then pulse the event object,</span>
00478         <span class="comment">// dereference event object, and write the previous state value if</span>
00479         <span class="comment">// specified. If the write of the previous state fails, then do not</span>
00480         <span class="comment">// report an error. When the caller attempts to access the previous</span>
00481         <span class="comment">// state value, an access violation will occur.</span>
00482         <span class="comment">//</span>
00483 
00484         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00485             State = <a class="code" href="../../d2/d8/eventobj_8c.html#a5">KePulseEvent</a>((<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>)<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>, <a class="code" href="../../d0/d8/ex_2event_8c.html#a0">ExpEventBoost</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00486             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>);
00487             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
00488                 <span class="keywordflow">try</span> {
00489                     *PreviousState = State;
00490 
00491                 } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00492                 }
00493             }
00494         }
00495 
00496     <span class="comment">//</span>
00497     <span class="comment">// If an exception occurs during the probe of the previous state, then</span>
00498     <span class="comment">// always handle the exception and return the exception code as the status</span>
00499     <span class="comment">// value.</span>
00500     <span class="comment">//</span>
00501 
00502     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00503         <span class="keywordflow">return</span> GetExceptionCode();
00504     }
00505 
00506     <span class="comment">//</span>
00507     <span class="comment">// Return service status.</span>
00508     <span class="comment">//</span>
00509 
00510     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00511 }
00512 
00513 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00514"></a><a class="code" href="../../d0/d8/ex_2event_8c.html#a8">00514</a> <a class="code" href="../../d0/d8/ex_2event_8c.html#a8">NtQueryEvent</a> (
00515     IN HANDLE EventHandle,
00516     IN EVENT_INFORMATION_CLASS EventInformationClass,
00517     OUT PVOID EventInformation,
00518     IN ULONG EventInformationLength,
00519     OUT PULONG ReturnLength OPTIONAL
00520     )
00521 
00522 <span class="comment">/*++</span>
00523 <span class="comment"></span>
00524 <span class="comment">Routine Description:</span>
00525 <span class="comment"></span>
00526 <span class="comment">    This function queries the state of an event object and returns the</span>
00527 <span class="comment">    requested information in the specified record structure.</span>
00528 <span class="comment"></span>
00529 <span class="comment">Arguments:</span>
00530 <span class="comment"></span>
00531 <span class="comment">    EventHandle - Supplies a handle to an event object.</span>
00532 <span class="comment"></span>
00533 <span class="comment">    EventInformationClass - Supplies the class of information being requested.</span>
00534 <span class="comment"></span>
00535 <span class="comment">    EventInformation - Supplies a pointer to a record that is to receive the</span>
00536 <span class="comment">        requested information.</span>
00537 <span class="comment"></span>
00538 <span class="comment">    EventInformationLength - Supplies the length of the record that is to</span>
00539 <span class="comment">        receive the requested information.</span>
00540 <span class="comment"></span>
00541 <span class="comment">    ReturnLength - Supplies an optional pointer to a variable that is to</span>
00542 <span class="comment">        receive the actual length of information that is returned.</span>
00543 <span class="comment"></span>
00544 <span class="comment">Return Value:</span>
00545 <span class="comment"></span>
00546 <span class="comment">    TBS</span>
00547 <span class="comment"></span>
00548 <span class="comment">--*/</span>
00549 
00550 {
00551 
00552     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00553     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00554     LONG State;
00555     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00556     EVENT_TYPE EventType;
00557 
00558     <span class="comment">//</span>
00559     <span class="comment">// Check argument validity.</span>
00560     <span class="comment">//</span>
00561 
00562     <span class="keywordflow">if</span> (EventInformationClass != EventBasicInformation) {
00563         <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
00564     }
00565 
00566     <span class="keywordflow">if</span> (EventInformationLength != <span class="keyword">sizeof</span>(EVENT_BASIC_INFORMATION)) {
00567         <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00568     }
00569 
00570     <span class="comment">//</span>
00571     <span class="comment">// Establish an exception handler, probe the output arguments, reference</span>
00572     <span class="comment">// the event object, and return the specified information. If the probe</span>
00573     <span class="comment">// fails, then return the exception code as the service status. Otherwise</span>
00574     <span class="comment">// return the status value returned by the reference object by handle</span>
00575     <span class="comment">// routine.</span>
00576     <span class="comment">//</span>
00577 
00578     <span class="keywordflow">try</span> {
00579 
00580         <span class="comment">//</span>
00581         <span class="comment">// Get previous processor mode and probe output arguments if necessary.</span>
00582         <span class="comment">//</span>
00583 
00584         PreviousMode = KeGetPreviousMode();
00585         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00586             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(EventInformation,
00587                           <span class="keyword">sizeof</span>(EVENT_BASIC_INFORMATION),
00588                           <span class="keyword">sizeof</span>(ULONG));
00589 
00590             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength)) {
00591                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(ReturnLength);
00592             }
00593         }
00594 
00595         <span class="comment">//</span>
00596         <span class="comment">// Reference event object by handle.</span>
00597         <span class="comment">//</span>
00598 
00599         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a7">EventHandle</a>,
00600                                            EVENT_QUERY_STATE,
00601                                            <a class="code" href="../../d7/d7/ntapi_8c.html#a3">ExEventObjectType</a>,
00602                                            PreviousMode,
00603                                            (PVOID *)&amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>,
00604                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00605 
00606         <span class="comment">//</span>
00607         <span class="comment">// If the reference was successful, then read the current state of</span>
00608         <span class="comment">// the event object, deference event object, fill in the information</span>
00609         <span class="comment">// structure, and return the length of the information structure if</span>
00610         <span class="comment">// specified. If the write of the event information or the return</span>
00611         <span class="comment">// length fails, then do not report an error. When the caller accesses</span>
00612         <span class="comment">// the information structure or length an access violation will occur.</span>
00613         <span class="comment">//</span>
00614 
00615         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00616             State = <a class="code" href="../../d2/d8/eventobj_8c.html#a6">KeReadStateEvent</a>(<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>);
00617             EventType = <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>-&gt;Header.Type;
00618             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>);
00619             <span class="keywordflow">try</span> {
00620                 ((PEVENT_BASIC_INFORMATION)EventInformation)-&gt;EventType = EventType;
00621                 ((PEVENT_BASIC_INFORMATION)EventInformation)-&gt;EventState = State;
00622                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength)) {
00623                     *ReturnLength = <span class="keyword">sizeof</span>(EVENT_BASIC_INFORMATION);
00624                 }
00625 
00626             } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00627             }
00628         }
00629 
00630     <span class="comment">//</span>
00631     <span class="comment">// If an exception occurs during the probe of the output arguments, then</span>
00632     <span class="comment">// always handle the exception and return the exception code as the status</span>
00633     <span class="comment">// value.</span>
00634     <span class="comment">//</span>
00635 
00636     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00637         <span class="keywordflow">return</span> GetExceptionCode();
00638     }
00639 
00640     <span class="comment">//</span>
00641     <span class="comment">// Return service status.</span>
00642     <span class="comment">//</span>
00643 
00644     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00645 }
00646 
00647 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00648"></a><a class="code" href="../../d0/d8/ex_2event_8c.html#a9">00648</a> <a class="code" href="../../d0/d8/ex_2event_8c.html#a9">NtResetEvent</a> (
00649     IN HANDLE EventHandle,
00650     OUT PLONG PreviousState OPTIONAL
00651     )
00652 
00653 <span class="comment">/*++</span>
00654 <span class="comment"></span>
00655 <span class="comment">Routine Description:</span>
00656 <span class="comment"></span>
00657 <span class="comment">    This function sets an event object to a Not-Signaled state.</span>
00658 <span class="comment"></span>
00659 <span class="comment">Arguments:</span>
00660 <span class="comment"></span>
00661 <span class="comment">    EventHandle - Supplies a handle to an event object.</span>
00662 <span class="comment"></span>
00663 <span class="comment">    PreviousState - Supplies an optional pointer to a variable that will</span>
00664 <span class="comment">        receive the previous state of the event object.</span>
00665 <span class="comment"></span>
00666 <span class="comment">Return Value:</span>
00667 <span class="comment"></span>
00668 <span class="comment">    TBS</span>
00669 <span class="comment"></span>
00670 <span class="comment">--*/</span>
00671 
00672 {
00673 
00674     PVOID <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00675     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00676     LONG State;
00677     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00678 
00679     <span class="comment">//</span>
00680     <span class="comment">// Establish an exception handler, probe the previous state address if</span>
00681     <span class="comment">// specified, reference the event object, and reset the event object. If</span>
00682     <span class="comment">// the probe fails, then return the exception code as the service status.</span>
00683     <span class="comment">// Otherwise return the status value returned by the reference object by</span>
00684     <span class="comment">// handle routine.</span>
00685     <span class="comment">//</span>
00686 
00687     <span class="keywordflow">try</span> {
00688 
00689         <span class="comment">//</span>
00690         <span class="comment">// Get previous processor mode and probe previous state address</span>
00691         <span class="comment">// if necessary.</span>
00692         <span class="comment">//</span>
00693 
00694         PreviousMode = KeGetPreviousMode();
00695         <span class="keywordflow">if</span> ((PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp; (ARGUMENT_PRESENT(PreviousState))) {
00696             <a class="code" href="../../d5/d8/ex_8h.html#a39">ProbeForWriteLong</a>(PreviousState);
00697         }
00698 
00699         <span class="comment">//</span>
00700         <span class="comment">// Reference event object by handle.</span>
00701         <span class="comment">//</span>
00702 
00703         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a7">EventHandle</a>,
00704                                            EVENT_MODIFY_STATE,
00705                                            <a class="code" href="../../d7/d7/ntapi_8c.html#a3">ExEventObjectType</a>,
00706                                            PreviousMode,
00707                                            &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>,
00708                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00709 
00710         <span class="comment">//</span>
00711         <span class="comment">// If the reference was successful, then set the state of the event</span>
00712         <span class="comment">// object to Not-Signaled, dereference event object, and write the</span>
00713         <span class="comment">// previous state value if specified. If the write of the previous</span>
00714         <span class="comment">// state fails, then do not report an error. When the caller attempts</span>
00715         <span class="comment">// to access the previous state value, an access violation will occur.</span>
00716         <span class="comment">//</span>
00717 
00718         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00719             State = <a class="code" href="../../d2/d8/eventobj_8c.html#a7">KeResetEvent</a>((<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>)<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>);
00720             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>);
00721             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
00722                 <span class="keywordflow">try</span> {
00723                     *PreviousState = State;
00724 
00725                 } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00726                 }
00727             }
00728         }
00729 
00730     <span class="comment">//</span>
00731     <span class="comment">// If an exception occurs during the probe of the previous state, then</span>
00732     <span class="comment">// always handle the exception and return the exception code as the status</span>
00733     <span class="comment">// value.</span>
00734     <span class="comment">//</span>
00735 
00736     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00737         <span class="keywordflow">return</span> GetExceptionCode();
00738     }
00739 
00740     <span class="comment">//</span>
00741     <span class="comment">// Return service status.</span>
00742     <span class="comment">//</span>
00743 
00744     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00745 }
00746 
00747 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00748"></a><a class="code" href="../../d0/d8/ex_2event_8c.html#a10">00748</a> <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a> (
00749     IN HANDLE EventHandle,
00750     OUT PLONG PreviousState OPTIONAL
00751     )
00752 
00753 <span class="comment">/*++</span>
00754 <span class="comment"></span>
00755 <span class="comment">Routine Description:</span>
00756 <span class="comment"></span>
00757 <span class="comment">    This function sets an event object to a Signaled state and attempts to</span>
00758 <span class="comment">    satisfy as many waits as possible.</span>
00759 <span class="comment"></span>
00760 <span class="comment">Arguments:</span>
00761 <span class="comment"></span>
00762 <span class="comment">    EventHandle - Supplies a handle to an event object.</span>
00763 <span class="comment"></span>
00764 <span class="comment">    PreviousState - Supplies an optional pointer to a variable that will</span>
00765 <span class="comment">        receive the previous state of the event object.</span>
00766 <span class="comment"></span>
00767 <span class="comment">Return Value:</span>
00768 <span class="comment"></span>
00769 <span class="comment">    TBS</span>
00770 <span class="comment"></span>
00771 <span class="comment">--*/</span>
00772 
00773 {
00774 
00775     PVOID <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00776     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00777     LONG State;
00778     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00779 <span class="preprocessor">#if DBG</span>
00780 <span class="preprocessor"></span>
00781     <span class="comment">//</span>
00782     <span class="comment">// Sneaky trick here to catch sleazy apps (csrss) that erroneously call</span>
00783     <span class="comment">// NtSetEvent on an event that happens to be somebody else's </span>
00784     <span class="comment">// critical section. Only allow setting a protected handle if the low</span>
00785     <span class="comment">// bit of PreviousState is set.</span>
00786     <span class="comment">//</span>
00787     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a> HandleInfo;
00788 
00789 <span class="preprocessor">#endif</span>
00790 <span class="preprocessor"></span>
00791     <span class="comment">//</span>
00792     <span class="comment">// Establish an exception handler, probe the previous state address if</span>
00793     <span class="comment">// specified, reference the event object, and set the event object. If</span>
00794     <span class="comment">// the probe fails, then return the exception code as the service status.</span>
00795     <span class="comment">// Otherwise return the status value returned by the reference object by</span>
00796     <span class="comment">// handle routine.</span>
00797     <span class="comment">//</span>
00798 
00799     <span class="keywordflow">try</span> {
00800 
00801         <span class="comment">//</span>
00802         <span class="comment">// Get previous processor mode and probe previous state address</span>
00803         <span class="comment">// if necessary.</span>
00804         <span class="comment">//</span>
00805 
00806         PreviousMode = KeGetPreviousMode();
00807 <span class="preprocessor">#if DBG</span>
00808 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp; 
00809             (ARGUMENT_PRESENT(PreviousState)) &amp;&amp;
00810             (PreviousState != (PLONG)1)) {
00811             <a class="code" href="../../d5/d8/ex_8h.html#a39">ProbeForWriteLong</a>(PreviousState);
00812         }
00813 <span class="preprocessor">#else</span>
00814 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp; (ARGUMENT_PRESENT(PreviousState))) {
00815             <a class="code" href="../../d5/d8/ex_8h.html#a39">ProbeForWriteLong</a>(PreviousState);
00816         }
00817 <span class="preprocessor">#endif</span>
00818 <span class="preprocessor"></span>
00819         <span class="comment">//</span>
00820         <span class="comment">// Reference event object by handle.</span>
00821         <span class="comment">//</span>
00822 
00823 <span class="preprocessor">#if DBG</span>
00824 <span class="preprocessor"></span>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a7">EventHandle</a>,
00825                                            EVENT_MODIFY_STATE,
00826                                            <a class="code" href="../../d7/d7/ntapi_8c.html#a3">ExEventObjectType</a>,
00827                                            PreviousMode,
00828                                            &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>,
00829                                            &amp;HandleInfo);
00830         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00831 
00832             <span class="keywordflow">if</span> ((HandleInfo.<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o0">HandleAttributes</a> &amp; 1) &amp;&amp;
00833                 (PreviousState != (PLONG)1)) {
00834 <span class="preprocessor">#if 0</span>
00835 <span class="preprocessor"></span>                <span class="comment">//</span>
00836                 <span class="comment">// This is a protected handle. If the low bit of PreviousState is NOT set,</span>
00837                 <span class="comment">// break into the debugger</span>
00838                 <span class="comment">//</span>
00839 
00840                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"NtSetEvent: Illegal call to NtSetEvent on a protected handle\n"</span>);
00841                 DbgBreakPoint();
00842                 PreviousState = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00843 <span class="preprocessor">#endif</span>
00844 <span class="preprocessor"></span>            }
00845         } <span class="keywordflow">else</span> {
00846             <span class="keywordflow">if</span> ((KeGetPreviousMode() != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp;
00847                 (<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a7">EventHandle</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00848                 ((<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_ENABLE_CLOSE_EXCEPTIONS) ||
00849                  (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;DebugPort != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))) {
00850 
00851                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a13">KeRaiseUserException</a>(STATUS_INVALID_HANDLE);
00852 
00853             }
00854         }
00855 <span class="preprocessor">#else</span>
00856 <span class="preprocessor"></span>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a7">EventHandle</a>,
00857                                            EVENT_MODIFY_STATE,
00858                                            <a class="code" href="../../d7/d7/ntapi_8c.html#a3">ExEventObjectType</a>,
00859                                            PreviousMode,
00860                                            &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>,
00861                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00862 <span class="preprocessor">#endif</span>
00863 <span class="preprocessor"></span>
00864         <span class="comment">//</span>
00865         <span class="comment">// If the reference was successful, then set the event object to the</span>
00866         <span class="comment">// Signaled state, dereference event object, and write the previous</span>
00867         <span class="comment">// state value if specified. If the write of the previous state fails,</span>
00868         <span class="comment">// then do not report an error. When the caller attempts to access the</span>
00869         <span class="comment">// previous state value, an access violation will occur.</span>
00870         <span class="comment">//</span>
00871 
00872         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00873             State = <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>((<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>)<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>, <a class="code" href="../../d0/d8/ex_2event_8c.html#a0">ExpEventBoost</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00874             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>);
00875             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
00876                 <span class="keywordflow">try</span> {
00877                     *PreviousState = State;
00878 
00879                 } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00880                 }
00881             }
00882         }
00883 
00884     <span class="comment">//</span>
00885     <span class="comment">// If an exception occurs during the probe of the previous state, then</span>
00886     <span class="comment">// always handle the exception and return the exception code as the status</span>
00887     <span class="comment">// value.</span>
00888     <span class="comment">//</span>
00889 
00890     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00891         <span class="keywordflow">return</span> GetExceptionCode();
00892     }
00893 
00894     <span class="comment">//</span>
00895     <span class="comment">// Return service status.</span>
00896     <span class="comment">//</span>
00897 
00898     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00899 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:56 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
