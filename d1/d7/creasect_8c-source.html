<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: creasect.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>creasect.c</h1><a href="../../d0/d8/creasect_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">   creasect.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the routines which implement the</span>
00012 <span class="comment">    NtCreateSection and NtOpenSection.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Lou Perazzoli (loup) 22-May-1989</span>
00017 <span class="comment">    Landy Wang (landyw) 02-Jun-1997</span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
00023 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00024 
<a name="l00025"></a><a class="code" href="../../d0/d8/creasect_8c.html#a6">00025</a> ULONG <a class="code" href="../../d0/d8/creasect_8c.html#a6">MMCONTROL</a> = 'aCmM';
<a name="l00026"></a><a class="code" href="../../d0/d8/creasect_8c.html#a7">00026</a> ULONG <a class="code" href="../../d0/d8/creasect_8c.html#a7">MMTEMPORARY</a> = 'xxmM';
<a name="l00027"></a><a class="code" href="../../d0/d8/creasect_8c.html#a8">00027</a> ULONG <a class="code" href="../../d0/d8/creasect_8c.html#a8">MMSECT</a> = 'tSmM';              <span class="comment">// This is exported to special pool.</span>
00028 
<a name="l00029"></a><a class="code" href="../../d0/d8/creasect_8c.html#a0">00029</a> <span class="preprocessor">#define MM_SIZE_OF_LARGEST_IMAGE ((ULONG)0x77000000)</span>
00030 <span class="preprocessor"></span>
<a name="l00031"></a><a class="code" href="../../d0/d8/creasect_8c.html#a1">00031</a> <span class="preprocessor">#define MM_MAXIMUM_IMAGE_HEADER (2 * PAGE_SIZE)</span>
00032 <span class="preprocessor"></span>
<a name="l00033"></a><a class="code" href="../../d0/d8/creasect_8c.html#a2">00033</a> <span class="preprocessor">#define MM_ALLOCATION_FRAGMENT (64 * 1024)</span>
00034 <span class="preprocessor"></span>
00035 <span class="comment">//</span>
00036 <span class="comment">// The maximum number of image object (object table entries) is</span>
00037 <span class="comment">// the number which will fit into the MM_MAXIMUM_IMAGE_HEADER with</span>
00038 <span class="comment">// the start of the PE image header in the last word of the first</span>
00039 <span class="comment">//</span>
00040 
<a name="l00041"></a><a class="code" href="../../d0/d8/creasect_8c.html#a3">00041</a> <span class="preprocessor">#define MM_MAXIMUM_IMAGE_SECTIONS                       \</span>
00042 <span class="preprocessor">     ((MM_MAXIMUM_IMAGE_HEADER - (PAGE_SIZE + sizeof(IMAGE_NT_HEADERS))) /  \</span>
00043 <span class="preprocessor">            sizeof(IMAGE_SECTION_HEADER))</span>
00044 <span class="preprocessor"></span>
00045 <span class="preprocessor">#if DBG</span>
00046 <span class="preprocessor"></span><span class="keyword">extern</span> <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> MmWatchProcess;
00047 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> MmFooBar(VOID);
00048 <span class="preprocessor">#endif // DBG</span>
00049 <span class="preprocessor"></span>
<a name="l00050"></a><a class="code" href="../../d0/d8/creasect_8c.html#a9">00050</a> <span class="keyword">extern</span> <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="code" href="../../d5/d8/fssup_8c.html#a3">IoFileObjectType</a>;
00051 
<a name="l00052"></a><a class="code" href="../../d0/d8/creasect_8c.html#a10">00052</a> CCHAR <a class="code" href="../../d0/d8/creasect_8c.html#a10">MmImageProtectionArray</a>[16] = {
00053                                     <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>,
00054                                     <a class="code" href="../../d4/d8/mi_8h.html#a37">MM_EXECUTE</a>,
00055                                     <a class="code" href="../../d4/d8/mi_8h.html#a36">MM_READONLY</a>,
00056                                     <a class="code" href="../../d4/d8/mi_8h.html#a38">MM_EXECUTE_READ</a>,
00057                                     <a class="code" href="../../d4/d8/mi_8h.html#a40">MM_WRITECOPY</a>,
00058                                     <a class="code" href="../../d4/d8/mi_8h.html#a42">MM_EXECUTE_WRITECOPY</a>,
00059                                     <a class="code" href="../../d4/d8/mi_8h.html#a40">MM_WRITECOPY</a>,
00060                                     <a class="code" href="../../d4/d8/mi_8h.html#a42">MM_EXECUTE_WRITECOPY</a>,
00061                                     <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>,
00062                                     <a class="code" href="../../d4/d8/mi_8h.html#a37">MM_EXECUTE</a>,
00063                                     <a class="code" href="../../d4/d8/mi_8h.html#a36">MM_READONLY</a>,
00064                                     <a class="code" href="../../d4/d8/mi_8h.html#a38">MM_EXECUTE_READ</a>,
00065                                     <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a>,
00066                                     <a class="code" href="../../d4/d8/mi_8h.html#a41">MM_EXECUTE_READWRITE</a>,
00067                                     <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a>,
00068                                     <a class="code" href="../../d4/d8/mi_8h.html#a41">MM_EXECUTE_READWRITE</a> };
00069 
00070 
00071 CCHAR
00072 <a class="code" href="../../d0/d8/creasect_8c.html#a13">MiGetImageProtection</a> (
00073     IN ULONG SectionCharacteristics
00074     );
00075 
00076 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00077 <a class="code" href="../../d0/d8/creasect_8c.html#a14">MiVerifyImageHeader</a> (
00078     IN PIMAGE_NT_HEADERS NtHeader,
00079     IN PIMAGE_DOS_HEADER DosHeader,
00080     IN ULONG NtHeaderSize
00081     );
00082 
00083 BOOLEAN
00084 <a class="code" href="../../d0/d8/creasect_8c.html#a15">MiCheckDosCalls</a> (
00085     IN PIMAGE_OS2_HEADER Os2Header,
00086     IN ULONG HeaderSize
00087     );
00088 
00089 <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>
00090 <a class="code" href="../../d0/d8/creasect_8c.html#a28">MiFindImageSectionObject</a>(
00091     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> File,
00092     IN PBOOLEAN GlobalNeeded
00093     );
00094 
00095 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00096 <a class="code" href="../../d0/d8/creasect_8c.html#a17">MiInsertImageSectionObject</a>(
00097     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> File,
00098     IN <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea
00099     );
00100 
00101 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00102 <a class="code" href="../../d0/d8/creasect_8c.html#a18">MiFlushDataSection</a>(
00103     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> File
00104     );
00105 
00106 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00107 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiCreateImageFileMap)</span>
00108 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtCreateSection)</span>
00109 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtOpenSection)</span>
00110 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiGetImageProtection)</span>
00111 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiVerifyImageHeader)</span>
00112 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiCheckDosCalls)</span>
00113 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiCreatePagingFileMap)</span>
00114 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiCreateDataFileMap)</span>
00115 <span class="preprocessor"></span>
00116 <span class="preprocessor">#pragma alloc_text(PAGEHYDRA,MiFindImageSectionObject)</span>
00117 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEHYDRA,MiInsertImageSectionObject)</span>
00118 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEHYDRA,MiRemoveImageSectionObject)</span>
00119 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEHYDRA,MiGetWritablePagesInSection)</span>
00120 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00121 <span class="preprocessor"></span>
00122 <span class="preprocessor">#pragma pack (1)</span>
<a name="l00123"></a><a class="code" href="../../d2/d5/struct__PHARLAP__CONFIG.html">00123</a> <span class="preprocessor"></span><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d2/d5/struct__PHARLAP__CONFIG.html">_PHARLAP_CONFIG</a> {
<a name="l00124"></a><a class="code" href="../../d2/d5/struct__PHARLAP__CONFIG.html#o0">00124</a>     UCHAR  <a class="code" href="../../d2/d5/struct__PHARLAP__CONFIG.html#o0">uchCopyRight</a>[0x32];
<a name="l00125"></a><a class="code" href="../../d2/d5/struct__PHARLAP__CONFIG.html#o1">00125</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d2/d5/struct__PHARLAP__CONFIG.html#o1">usType</a>;
<a name="l00126"></a><a class="code" href="../../d2/d5/struct__PHARLAP__CONFIG.html#o2">00126</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d2/d5/struct__PHARLAP__CONFIG.html#o2">usRsv1</a>;
<a name="l00127"></a><a class="code" href="../../d2/d5/struct__PHARLAP__CONFIG.html#o3">00127</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d2/d5/struct__PHARLAP__CONFIG.html#o3">usRsv2</a>;
<a name="l00128"></a><a class="code" href="../../d2/d5/struct__PHARLAP__CONFIG.html#o4">00128</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d2/d5/struct__PHARLAP__CONFIG.html#o4">usSign</a>;
00129 } <a class="code" href="../../d2/d5/struct__PHARLAP__CONFIG.html">CONFIGPHARLAP</a>, *<a class="code" href="../../d2/d5/struct__PHARLAP__CONFIG.html">PCONFIGPHARLAP</a>;
00130 <span class="preprocessor">#pragma pack ()</span>
00131 <span class="preprocessor"></span>
00132 
00133 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00134"></a><a class="code" href="../../d0/d8/creasect_8c.html#a19">00134</a> <a class="code" href="../../d0/d8/creasect_8c.html#a19">NtCreateSection</a> (
00135     OUT PHANDLE SectionHandle,
00136     IN ACCESS_MASK DesiredAccess,
00137     IN POBJECT_ATTRIBUTES ObjectAttributes OPTIONAL,
00138     IN PLARGE_INTEGER MaximumSize OPTIONAL,
00139     IN ULONG SectionPageProtection,
00140     IN ULONG AllocationAttributes,
00141     IN HANDLE FileHandle OPTIONAL
00142      )
00143 
00144 <span class="comment">/*++</span>
00145 <span class="comment"></span>
00146 <span class="comment">Routine Description:</span>
00147 <span class="comment"></span>
00148 <span class="comment">    This function creates a section object and opens a handle to the object</span>
00149 <span class="comment">    with the specified desired access.</span>
00150 <span class="comment"></span>
00151 <span class="comment">Arguments:</span>
00152 <span class="comment"></span>
00153 <span class="comment">    SectionHandle - A pointer to a variable that will</span>
00154 <span class="comment">        receive the section object handle value.</span>
00155 <span class="comment"></span>
00156 <span class="comment">    DesiredAccess - The desired types of access for the section.</span>
00157 <span class="comment"></span>
00158 <span class="comment">    DesiredAccess Flags</span>
00159 <span class="comment"></span>
00160 <span class="comment">         EXECUTE - Execute access to the section is</span>
00161 <span class="comment">              desired.</span>
00162 <span class="comment"></span>
00163 <span class="comment">         READ - Read access to the section is desired.</span>
00164 <span class="comment"></span>
00165 <span class="comment">         WRITE - Write access to the section is desired.</span>
00166 <span class="comment"></span>
00167 <span class="comment"></span>
00168 <span class="comment">    ObjectAttributes - Supplies a pointer to an object attributes structure.</span>
00169 <span class="comment"></span>
00170 <span class="comment">    MaximumSize - Supplies the maximum size of the section in bytes.</span>
00171 <span class="comment">         This value is rounded up to the host page size and</span>
00172 <span class="comment">         specifies the size of the section (page file</span>
00173 <span class="comment">         backed section) or the maximum size to which a</span>
00174 <span class="comment">         file can be extended or mapped (file backed</span>
00175 <span class="comment">         section).</span>
00176 <span class="comment"></span>
00177 <span class="comment">    SectionPageProtection - Supplies the protection to place on each page</span>
00178 <span class="comment">         in the section.  One of PAGE_READ, PAGE_READWRITE, PAGE_EXECUTE,</span>
00179 <span class="comment">         or PAGE_WRITECOPY and, optionally, PAGE_NOCACHE may be specified.</span>
00180 <span class="comment"></span>
00181 <span class="comment">    AllocationAttributes - Supplies a set of flags that describe the</span>
00182 <span class="comment">         allocation attributes of the section.</span>
00183 <span class="comment"></span>
00184 <span class="comment">        AllocationAttributes Flags</span>
00185 <span class="comment"></span>
00186 <span class="comment">        SEC_BASED - The section is a based section and will be</span>
00187 <span class="comment">            allocated at the same virtual address in each process</span>
00188 <span class="comment">            address space that receives the section.  This does not</span>
00189 <span class="comment">            imply that addresses are reserved for based sections.</span>
00190 <span class="comment">            Rather if the section cannot be mapped at the based address</span>
00191 <span class="comment">            an error is returned.</span>
00192 <span class="comment"></span>
00193 <span class="comment"></span>
00194 <span class="comment">        SEC_RESERVE - All pages of the section are set to the</span>
00195 <span class="comment">            reserved state.</span>
00196 <span class="comment"></span>
00197 <span class="comment">        SEC_COMMIT - All pages of the section are set to the commit</span>
00198 <span class="comment">            state.</span>
00199 <span class="comment"></span>
00200 <span class="comment">        SEC_IMAGE - The file specified by the file handle is an</span>
00201 <span class="comment">                    executable image file.</span>
00202 <span class="comment"></span>
00203 <span class="comment">        SEC_FILE - The file specified by the file handle is a mapped</span>
00204 <span class="comment">                   file.  If a file handle is supplied and neither</span>
00205 <span class="comment">                   SEC_IMAGE or SEC_FILE is supplied, SEC_FILE is</span>
00206 <span class="comment">                   assumed.</span>
00207 <span class="comment"></span>
00208 <span class="comment">        SEC_NO_CHANGE - Once the file is mapped, the protection cannot</span>
00209 <span class="comment">                        be changed nor can the view be unmapped.  The</span>
00210 <span class="comment">                        view is unmapped when the process is deleted.</span>
00211 <span class="comment">                        Cannot be used with SEC_IMAGE.</span>
00212 <span class="comment"></span>
00213 <span class="comment">    FileHandle - Supplies an optional handle of an open file object.</span>
00214 <span class="comment">         If the value of this handle is null, then the</span>
00215 <span class="comment">         section will be backed by a paging file. Otherwise</span>
00216 <span class="comment">         the section is backed by the specified data file.</span>
00217 <span class="comment"></span>
00218 <span class="comment">Return Value:</span>
00219 <span class="comment"></span>
00220 <span class="comment">    Returns the status of the operation.</span>
00221 <span class="comment"></span>
00222 <span class="comment">    TBS</span>
00223 <span class="comment"></span>
00224 <span class="comment">--*/</span>
00225 
00226 {
00227     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00228     PVOID Section;
00229     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00230     LARGE_INTEGER LargeSize;
00231     LARGE_INTEGER CapturedSize;
00232     ULONG RetryCount;
00233 
00234     <span class="keywordflow">if</span> ((AllocationAttributes &amp; ~(SEC_COMMIT | SEC_RESERVE | SEC_BASED |
00235             SEC_IMAGE | SEC_NOCACHE | SEC_NO_CHANGE)) != 0) {
00236         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_6;
00237     }
00238 
00239     <span class="keywordflow">if</span> ((AllocationAttributes &amp; (SEC_COMMIT | SEC_RESERVE | SEC_IMAGE)) == 0) {
00240         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_6;
00241     }
00242 
00243     <span class="keywordflow">if</span> ((AllocationAttributes &amp; SEC_IMAGE) &amp;&amp;
00244             (AllocationAttributes &amp; (SEC_COMMIT | SEC_RESERVE |
00245                             SEC_NOCACHE | SEC_NO_CHANGE))) {
00246 
00247         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_6;
00248     }
00249 
00250     <span class="keywordflow">if</span> ((AllocationAttributes &amp; SEC_COMMIT) &amp;&amp;
00251             (AllocationAttributes &amp; SEC_RESERVE)) {
00252         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_6;
00253     }
00254 
00255     <span class="comment">//</span>
00256     <span class="comment">// Check the SectionProtection Flag.</span>
00257     <span class="comment">//</span>
00258 
00259     <span class="keywordflow">if</span> ((SectionPageProtection &amp; PAGE_NOCACHE) ||
00260         (SectionPageProtection &amp; PAGE_GUARD) ||
00261         (SectionPageProtection &amp; PAGE_NOACCESS)) {
00262 
00263         <span class="comment">//</span>
00264         <span class="comment">// No cache is only specified through SEC_NOCACHE option in the</span>
00265         <span class="comment">// allocation attributes.</span>
00266         <span class="comment">//</span>
00267 
00268         <span class="keywordflow">return</span> STATUS_INVALID_PAGE_PROTECTION;
00269     }
00270 
00271 
00272     <span class="keywordflow">if</span> (KeGetPreviousMode() != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00273         <span class="keywordflow">try</span> {
00274             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>(SectionHandle);
00275 
00276             <span class="keywordflow">if</span> (ARGUMENT_PRESENT (MaximumSize)) {
00277 
00278                 <span class="comment">//</span>
00279                 <span class="comment">// Note we only probe for byte alignment because prior to NT 5,</span>
00280                 <span class="comment">// we never probed at all.  We don't want to break user apps</span>
00281                 <span class="comment">// that had bad alignment if they worked before.</span>
00282                 <span class="comment">//</span>
00283 
00284                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(MaximumSize, <span class="keyword">sizeof</span>(LARGE_INTEGER), <span class="keyword">sizeof</span>(UCHAR));
00285                 LargeSize = *MaximumSize;
00286             } <span class="keywordflow">else</span> {
00287                 <a class="code" href="../../d4/d8/mi_8h.html#a166">ZERO_LARGE</a> (LargeSize);
00288             }
00289 
00290         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00291             <span class="keywordflow">return</span> GetExceptionCode();
00292         }
00293     } <span class="keywordflow">else</span> {
00294         <span class="keywordflow">if</span> (ARGUMENT_PRESENT (MaximumSize)) {
00295             LargeSize = *MaximumSize;
00296         } <span class="keywordflow">else</span> {
00297             <a class="code" href="../../d4/d8/mi_8h.html#a166">ZERO_LARGE</a> (LargeSize);
00298         }
00299     }
00300 
00301     RetryCount = 0;
00302 
00303 retry:
00304 
00305     CapturedSize = LargeSize;
00306 
00307     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00308     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/creasect_8c.html#a20">MmCreateSection</a> ( &amp;Section,
00309                                DesiredAccess,
00310                                <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00311                                &amp;CapturedSize,
00312                                SectionPageProtection,
00313                                AllocationAttributes,
00314                                FileHandle,
00315                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00316 
00317 
00318     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00319     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00320         <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_FILE_LOCK_CONFLICT) &amp;&amp;
00321             (RetryCount &lt; 3)) {
00322 
00323             <span class="comment">//</span>
00324             <span class="comment">// The file system may have prevented this from working</span>
00325             <span class="comment">// due to log file flushing.  Delay and try again.</span>
00326             <span class="comment">//</span>
00327 
00328             RetryCount += 1;
00329 
00330             <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00331                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00332                                     &amp;<a class="code" href="../../d4/d8/mi_8h.html#a421">MmHalfSecond</a>);
00333 
00334             <span class="keywordflow">goto</span> retry;
00335 
00336         }
00337         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00338     }
00339 
00340 <span class="preprocessor">#if DBG</span>
00341 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a64">MM_DBG_SECTIONS</a>) {
00342         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"inserting section %lx control %lx\n"</span>,Section,
00343                     ((<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)Section)-&gt;Segment-&gt;ControlArea);
00344     }
00345 <span class="preprocessor">#endif</span>
00346 <span class="preprocessor"></span>
00347     {
00348         <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
00349         ControlArea = ((<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)Section)-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o0">ControlArea</a>;
00350         <span class="keywordflow">if</span> ((ControlArea != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00351             <a class="code" href="../../d4/d2/cache_8h.html#a65">CcZeroEndOfLastPage</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>);
00352         }
00353     }
00354 
00355     <span class="comment">//</span>
00356     <span class="comment">// Note if the insertion fails, Ob will dereference the object for us.</span>
00357     <span class="comment">//</span>
00358 
00359     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a> (Section,
00360                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00361                              DesiredAccess,
00362                              0,
00363                              (PVOID *)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00364                              &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
00365 
00366     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00367         <span class="keywordflow">try</span> {
00368             *SectionHandle = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00369         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00370 
00371             <span class="comment">//</span>
00372             <span class="comment">// If the write attempt fails, then do not report an error.</span>
00373             <span class="comment">// When the caller attempts to access the handle value,</span>
00374             <span class="comment">// an access violation will occur.</span>
00375             <span class="comment">//</span>
00376         }
00377     }
00378 
00379 <span class="preprocessor">#if DBG</span>
00380 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a81">MM_DBG_SHOW_NT_CALLS</a>) {
00381         <span class="keywordflow">if</span> ( !MmWatchProcess )
00382             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"return creasect handle %lx status %lx\n"</span>,<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00383     }
00384 <span class="preprocessor">#endif</span>
00385 <span class="preprocessor"></span>
00386     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00387 }
00388 
00389 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00390"></a><a class="code" href="../../d0/d8/creasect_8c.html#a20">00390</a> <a class="code" href="../../d0/d8/creasect_8c.html#a20">MmCreateSection</a> (
00391     OUT PVOID *SectionObject,
00392     IN ACCESS_MASK DesiredAccess,
00393     IN POBJECT_ATTRIBUTES ObjectAttributes OPTIONAL,
00394     IN PLARGE_INTEGER InputMaximumSize,
00395     IN ULONG SectionPageProtection,
00396     IN ULONG AllocationAttributes,
00397     IN HANDLE FileHandle OPTIONAL,
00398     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject OPTIONAL
00399     )
00400 
00401 <span class="comment">/*++</span>
00402 <span class="comment"></span>
00403 <span class="comment">Routine Description:</span>
00404 <span class="comment"></span>
00405 <span class="comment">    This function creates a section object and opens a handle to the object</span>
00406 <span class="comment">    with the specified desired access.</span>
00407 <span class="comment"></span>
00408 <span class="comment">Arguments:</span>
00409 <span class="comment"></span>
00410 <span class="comment">    Section - A pointer to a variable that will</span>
00411 <span class="comment">              receive the section object address.</span>
00412 <span class="comment"></span>
00413 <span class="comment">    DesiredAccess - The desired types of access for the section.</span>
00414 <span class="comment"></span>
00415 <span class="comment">    DesiredAccess Flags</span>
00416 <span class="comment"></span>
00417 <span class="comment">         EXECUTE - Execute access to the section is desired.</span>
00418 <span class="comment"></span>
00419 <span class="comment">         READ - Read access to the section is desired.</span>
00420 <span class="comment"></span>
00421 <span class="comment">         WRITE - Write access to the section is desired.</span>
00422 <span class="comment"></span>
00423 <span class="comment">    ObjectAttributes - Supplies a pointer to an object attributes structure.</span>
00424 <span class="comment"></span>
00425 <span class="comment">    InputMaximumSize - Supplies the maximum size of the section in bytes.</span>
00426 <span class="comment">                       This value is rounded up to the host page size and</span>
00427 <span class="comment">                       specifies the size of the section (page file</span>
00428 <span class="comment">                       backed section) or the maximum size to which a</span>
00429 <span class="comment">                       file can be extended or mapped (file backed</span>
00430 <span class="comment">                       section).</span>
00431 <span class="comment"></span>
00432 <span class="comment">    SectionPageProtection - Supplies the protection to place on each page</span>
00433 <span class="comment">                            in the section.  One of PAGE_READ, PAGE_READWRITE,</span>
00434 <span class="comment">                            PAGE_EXECUTE, or PAGE_WRITECOPY and, optionally,</span>
00435 <span class="comment">                            PAGE_NOCACHE may be specified.</span>
00436 <span class="comment"></span>
00437 <span class="comment">    AllocationAttributes - Supplies a set of flags that describe the</span>
00438 <span class="comment">                           allocation attributes of the section.</span>
00439 <span class="comment"></span>
00440 <span class="comment">        AllocationAttributes Flags</span>
00441 <span class="comment"></span>
00442 <span class="comment">        SEC_BASED - The section is a based section and will be</span>
00443 <span class="comment">                    allocated at the same virtual address in each process</span>
00444 <span class="comment">                    address space that receives the section.  This does not</span>
00445 <span class="comment">                    imply that addresses are reserved for based sections.</span>
00446 <span class="comment">                    Rather if the section cannot be mapped at the based address</span>
00447 <span class="comment">                    an error is returned.</span>
00448 <span class="comment"></span>
00449 <span class="comment">        SEC_RESERVE - All pages of the section are set to the</span>
00450 <span class="comment">                      reserved state.</span>
00451 <span class="comment"></span>
00452 <span class="comment">        SEC_COMMIT - All pages of the section are set to the commit state.</span>
00453 <span class="comment"></span>
00454 <span class="comment">        SEC_IMAGE - The file specified by the file handle is an</span>
00455 <span class="comment">                    executable image file.</span>
00456 <span class="comment"></span>
00457 <span class="comment">        SEC_FILE - The file specified by the file handle is a mapped</span>
00458 <span class="comment">                   file.  If a file handle is supplied and neither</span>
00459 <span class="comment">                   SEC_IMAGE or SEC_FILE is supplied, SEC_FILE is</span>
00460 <span class="comment">                   assumed.</span>
00461 <span class="comment"></span>
00462 <span class="comment">    FileHandle - Supplies an optional handle of an open file object.</span>
00463 <span class="comment">                 If the value of this handle is null, then the</span>
00464 <span class="comment">                 section will be backed by a paging file. Otherwise</span>
00465 <span class="comment">                 the section is backed by the specified data file.</span>
00466 <span class="comment"></span>
00467 <span class="comment">    FileObject - Supplies an optional pointer to the file object.  If this</span>
00468 <span class="comment">                 value is NULL and the FileHandle is NULL, then there is</span>
00469 <span class="comment">                 no file to map (image or mapped file).  If this value</span>
00470 <span class="comment">                 is specified, then the File is to be mapped as a MAPPED FILE</span>
00471 <span class="comment">                 and NO file size checking will be performed.</span>
00472 <span class="comment"></span>
00473 <span class="comment">                 ONLY THE SYSTEM CACHE SHOULD PROVIDE A FILE OBJECT WITH THE</span>
00474 <span class="comment">                 CALL!! as this is optimized to not check the size, only do</span>
00475 <span class="comment">                 data mapping, no protection check, etc.</span>
00476 <span class="comment"></span>
00477 <span class="comment">    Note - Only one of FileHandle or File should be specified!</span>
00478 <span class="comment"></span>
00479 <span class="comment">Return Value:</span>
00480 <span class="comment"></span>
00481 <span class="comment">    Returns the relevant NTSTATUS code.</span>
00482 <span class="comment"></span>
00483 <span class="comment">--*/</span>
00484 
00485 {
00486     <a class="code" href="../../d5/d0/struct__SECTION.html">SECTION</a> Section;
00487     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a> NewSection;
00488     <a class="code" href="../../d1/d1/struct__SEGMENT.html">PSEGMENT</a> Segment;
00489     <a class="code" href="../../d1/d1/struct__SEGMENT.html">PSEGMENT</a> NewSegment;
00490     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00491     KIRQL OldIrql;
00492     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00493     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
00494     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> NewControlArea;
00495     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> SegmentControlArea;
00496     ACCESS_MASK FileDesiredAccess;
00497     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>;
00498     <a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html">PEVENT_COUNTER</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00499     ULONG IgnoreFileSizing;
00500     ULONG ProtectionMask;
00501     ULONG ProtectMaskForAccess;
00502     ULONG FileAcquired;
00503     <a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html">PEVENT_COUNTER</a> SegmentEvent;
00504     BOOLEAN FileSizeChecked;
00505     LARGE_INTEGER TempSectionSize;
00506     UINT64 EndOfFile;
00507     ULONG IncrementedRefCount;
00508     ULONG ControlAreaSize;
00509     PUINT64 MaximumSize;
00510     <a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a> *SectionBasedRoot;
00511     BOOLEAN GlobalNeeded;
00512     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> ChangeFileReference;
00513 <span class="preprocessor">#if DBG</span>
00514 <span class="preprocessor"></span>    PVOID PreviousSectionPointer;
00515 <span class="preprocessor">#endif //DBG</span>
00516 <span class="preprocessor"></span>
00517     DesiredAccess;
00518 
00519     IgnoreFileSizing = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00520     FileAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00521     FileSizeChecked = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00522     IncrementedRefCount = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00523     ChangeFileReference = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00524 
00525     MaximumSize = (PUINT64) InputMaximumSize;
00526 
00527 <span class="preprocessor">#if DBG</span>
00528 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a81">MM_DBG_SHOW_NT_CALLS</a>) {
00529         <span class="keywordflow">if</span> ( !MmWatchProcess ) {
00530             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"crea sect access mask %lx maxsize %I64X page prot %lx\n"</span>,
00531                 DesiredAccess, *MaximumSize, SectionPageProtection);
00532             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"     allocation attributes %lx file handle %lx\n"</span>,
00533                 AllocationAttributes, FileHandle);
00534         }
00535     }
00536 <span class="preprocessor">#endif</span>
00537 <span class="preprocessor"></span>
00538     <span class="comment">//</span>
00539     <span class="comment">// Check allocation attributes flags.</span>
00540     <span class="comment">//</span>
00541 
00542     <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> = (<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00543 
00544     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((AllocationAttributes &amp; ~(SEC_COMMIT | SEC_RESERVE | SEC_BASED |
00545             SEC_IMAGE | SEC_NOCACHE | SEC_NO_CHANGE)) == 0);
00546 
00547     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((AllocationAttributes &amp; (SEC_COMMIT | SEC_RESERVE | SEC_IMAGE)) != 0);
00548 
00549     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (!((AllocationAttributes &amp; SEC_IMAGE) &amp;&amp;
00550             (AllocationAttributes &amp; (SEC_COMMIT | SEC_RESERVE |
00551                             SEC_NOCACHE | SEC_NO_CHANGE))));
00552 
00553     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (!((AllocationAttributes &amp; SEC_COMMIT) &amp;&amp;
00554             (AllocationAttributes &amp; SEC_RESERVE)));
00555 
00556     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (!((SectionPageProtection &amp; PAGE_NOCACHE) ||
00557         (SectionPageProtection &amp; PAGE_GUARD) ||
00558         (SectionPageProtection &amp; PAGE_NOACCESS)));
00559 
00560     <span class="keywordflow">if</span> (AllocationAttributes &amp; SEC_NOCACHE) {
00561         SectionPageProtection |= PAGE_NOCACHE;
00562     }
00563 
00564     <span class="comment">//</span>
00565     <span class="comment">// Check the protection field.  This could raise an exception.</span>
00566     <span class="comment">//</span>
00567 
00568     <span class="keywordflow">try</span> {
00569         ProtectionMask = <a class="code" href="../../d0/d2/mmsup_8c.html#a5">MiMakeProtectionMask</a> (SectionPageProtection);
00570     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00571         <span class="keywordflow">return</span> GetExceptionCode();
00572     }
00573 
00574     ProtectMaskForAccess = ProtectionMask &amp; 0x7;
00575 
00576     FileDesiredAccess = <a class="code" href="../../d4/d8/mi_8h.html#a415">MmMakeFileAccess</a>[ProtectMaskForAccess];
00577 
00578     <span class="comment">//</span>
00579     <span class="comment">// Get previous processor mode and probe output arguments if necessary.</span>
00580     <span class="comment">//</span>
00581 
00582     PreviousMode = KeGetPreviousMode();
00583 
00584     Section.<a class="code" href="../../d5/d0/struct__SECTION.html#o6">InitialPageProtection</a> = SectionPageProtection;
00585     Section.<a class="code" href="../../d5/d0/struct__SECTION.html#o1">Segment</a> = (<a class="code" href="../../d1/d1/struct__SEGMENT.html">PSEGMENT</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00586 
00587     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(FileHandle) || ARGUMENT_PRESENT(FileObject)) {
00588 
00589         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(FileObject)) {
00590             IgnoreFileSizing = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00591             <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> = FileObject;
00592 
00593             <span class="comment">//</span>
00594             <span class="comment">// Quick check to see if a control area already exists.</span>
00595             <span class="comment">//</span>
00596 
00597             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer-&gt;DataSectionObject) {
00598 
00599                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00600                 ControlArea =
00601                     (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)(<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer-&gt;DataSectionObject);
00602 
00603                 <span class="keywordflow">if</span> ((ControlArea != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00604                     (!ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingDeleted) &amp;&amp;
00605                     (!ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingCreated)) {
00606 
00607                     <span class="comment">//</span>
00608                     <span class="comment">// Control area exists and is not being deleted,</span>
00609                     <span class="comment">// reference it.</span>
00610                     <span class="comment">//</span>
00611 
00612                     NewSegment = ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>;
00613                     <span class="keywordflow">if</span> ((ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o2">NumberOfSectionReferences</a> == 0) &amp;&amp;
00614                         (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> == 0) &amp;&amp;
00615                         (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o13">ModifiedWriteCount</a> == 0)) {
00616 
00617                         <span class="comment">//</span>
00618                         <span class="comment">// Dereference the current file object and</span>
00619                         <span class="comment">// reference this one.</span>
00620                         <span class="comment">//</span>
00621 
00622                         ChangeFileReference = ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>;
00623                         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a> = FileObject;
00624 
00625                         <span class="comment">//</span>
00626                         <span class="comment">// This dereference is purposely at DPC_LEVEL</span>
00627                         <span class="comment">// so the object manager queues it to another</span>
00628                         <span class="comment">// thread thereby eliminating deadlocks with</span>
00629                         <span class="comment">// the redirector.</span>
00630                         <span class="comment">//</span>
00631 
00632                         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (ChangeFileReference);
00633                     }
00634                     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Accessed = 1;
00635                     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o2">NumberOfSectionReferences</a> += 1;
00636                     <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o1">DereferenceList</a>.Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00637 
00638                         <span class="comment">//</span>
00639                         <span class="comment">// Remove this from the list of unused segments.</span>
00640                         <span class="comment">//</span>
00641 
00642                         RemoveEntryList (&amp;ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o1">DereferenceList</a>);
00643 
00644                         <a class="code" href="../../d4/d8/mi_8h.html#a330">MI_UNUSED_SEGMENTS_REMOVE_CHARGE</a> (ControlArea);
00645 
00646                         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o1">DereferenceList</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00647                         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o1">DereferenceList</a>.Blink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00648                     }
00649                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00650                     IncrementedRefCount = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00651                     Section.<a class="code" href="../../d5/d0/struct__SECTION.html#o2">SizeOfSection</a>.QuadPart = (LONGLONG)*MaximumSize;
00652 
00653                     <span class="keywordflow">goto</span> ReferenceObject;
00654                 }
00655                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00656             }
00657 
00658             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a> (FileObject);
00659 
00660         } <span class="keywordflow">else</span> {
00661 
00662             <span class="comment">//</span>
00663             <span class="comment">// Only one of FileHandle or FileObject should be supplied</span>
00664             <span class="comment">// if a FileObject is supplied, this must be from the</span>
00665             <span class="comment">// file system and therefore the file's size should not</span>
00666             <span class="comment">// be checked.</span>
00667             <span class="comment">//</span>
00668 
00669             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> ( FileHandle,
00670                                                  FileDesiredAccess,
00671                                                  <a class="code" href="../../d5/d8/fssup_8c.html#a3">IoFileObjectType</a>,
00672                                                  PreviousMode,
00673                                                  (PVOID *)&amp;<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>,
00674                                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00675             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00676                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00677             }
00678 
00679             <span class="comment">//</span>
00680             <span class="comment">// If this file doesn't have a section object pointer,</span>
00681             <span class="comment">// return an error.</span>
00682             <span class="comment">//</span>
00683 
00684             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00685                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>);
00686                 <span class="keywordflow">return</span> STATUS_INVALID_FILE_FOR_SECTION;
00687             }
00688         }
00689 
00690         <span class="comment">//</span>
00691         <span class="comment">// Check to see if the specified file already has a section.</span>
00692         <span class="comment">// If not, indicate in the file object's pointer to an FCB that</span>
00693         <span class="comment">// a section is being built.  This synchronizes segment creation</span>
00694         <span class="comment">// for the file.</span>
00695         <span class="comment">//</span>
00696 
00697         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; (AllocationAttributes &amp; SEC_IMAGE)) {
00698 
00699             <span class="comment">//</span>
00700             <span class="comment">// This control area is always just a place holder - the real one</span>
00701             <span class="comment">// is allocated in MiCreateImageFileMap and will be allocated</span>
00702             <span class="comment">// with the correct size and this one freed in a short while.</span>
00703             <span class="comment">//</span>
00704             <span class="comment">// This place holder must always be allocated as a large control</span>
00705             <span class="comment">// area so that it can be chained for the per-session case.</span>
00706             <span class="comment">//</span>
00707             <span class="comment">// This may need revisiting for wx86.</span>
00708             <span class="comment">//</span>
00709 
00710             ControlAreaSize = (ULONG)<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">LARGE_CONTROL_AREA</a>) +
00711                                                 (ULONG)<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d7/struct__SUBSECTION.html">SUBSECTION</a>);
00712         }
00713         <span class="keywordflow">else</span> {
00714             ControlAreaSize = (ULONG)<span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">CONTROL_AREA</a>) +
00715                                                 (ULONG)<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d7/struct__SUBSECTION.html">SUBSECTION</a>);
00716         }
00717 
00718         NewControlArea = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00719                                                 ControlAreaSize,
00720                                                 <a class="code" href="../../d0/d8/creasect_8c.html#a6">MMCONTROL</a>);
00721 
00722         <span class="keywordflow">if</span> (NewControlArea == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00723             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>);
00724             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00725         }
00726 
00727         RtlZeroMemory (NewControlArea, ControlAreaSize);
00728 
00729         NewControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o16">NonPagedPoolUsage</a> = <a class="code" href="../../d4/d2/pool_8h.html#a23">EX_REAL_POOL_USAGE</a>(ControlAreaSize);
00730 
00731         NewSegment = (<a class="code" href="../../d1/d1/struct__SEGMENT.html">PSEGMENT</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00732 
00733         <span class="comment">//</span>
00734         <span class="comment">// We only need the file resource if the was a user request, i.e. not</span>
00735         <span class="comment">// a call from the cache manager or file system.</span>
00736         <span class="comment">//</span>
00737 
00738         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(FileHandle)) {
00739 
00740             <a class="code" href="../../d1/d8/fsrtl_8h.html#a107">FsRtlAcquireFileExclusive</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>);
00741             <a class="code" href="../../d4/d6/iosubs_8c.html#a109">IoSetTopLevelIrp</a>((<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>)<a class="code" href="../../d1/d8/fsrtl_8h.html#a11">FSRTL_FSP_TOP_LEVEL_IRP</a>);
00742             FileAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00743         }
00744 
00745         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00746 
00747         <span class="comment">//</span>
00748         <span class="comment">// Allocate an event to wait on in case the segment is in the</span>
00749         <span class="comment">// process of being deleted.  This event cannot be allocated</span>
00750         <span class="comment">// with the PFN database locked as pool expansion would deadlock.</span>
00751         <span class="comment">//</span>
00752 
00753 ReallocateandcheckSegment:
00754 
00755         SegmentEvent = <a class="code" href="../../d4/d8/mi_8h.html#a931">MiGetEventCounter</a>();
00756 
00757         <span class="keywordflow">if</span> (SegmentEvent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00758             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00759             <span class="keywordflow">if</span> (FileAcquired) {
00760                 <a class="code" href="../../d4/d6/iosubs_8c.html#a109">IoSetTopLevelIrp</a>((<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00761                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a108">FsRtlReleaseFile</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>);
00762             }
00763             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (NewControlArea);
00764             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>);
00765             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00766         }
00767 
00768 RecheckSegment:
00769 
00770         <span class="keywordflow">if</span> (AllocationAttributes &amp; SEC_IMAGE) {
00771 
00772             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00773                 ControlArea = <a class="code" href="../../d0/d8/creasect_8c.html#a28">MiFindImageSectionObject</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>, &amp;GlobalNeeded);
00774             }
00775             <span class="keywordflow">else</span> {
00776                 ControlArea =
00777                    (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)(<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer-&gt;ImageSectionObject);
00778             }
00779         } <span class="keywordflow">else</span> {
00780             ControlArea =
00781                (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)(<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer-&gt;DataSectionObject);
00782         }
00783 
00784         <span class="keywordflow">if</span> (ControlArea != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00785 
00786             <span class="comment">//</span>
00787             <span class="comment">// A segment already exists for this file.  Make sure that it</span>
00788             <span class="comment">// is not in the process of being deleted, or being created.</span>
00789             <span class="comment">//</span>
00790 
00791 
00792             <span class="keywordflow">if</span> ((ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingDeleted) ||
00793                 (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingCreated)) {
00794 
00795                 <span class="comment">//</span>
00796                 <span class="comment">// The segment object is in the process of being deleted or</span>
00797                 <span class="comment">// created.</span>
00798                 <span class="comment">// Check to see if another thread is waiting for the deletion,</span>
00799                 <span class="comment">// otherwise create an event object to wait upon.</span>
00800                 <span class="comment">//</span>
00801 
00802                 <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o12">WaitingForDeletion</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00803 
00804                     <span class="comment">//</span>
00805                     <span class="comment">// Initialize an event and put its address in the control area.</span>
00806                     <span class="comment">//</span>
00807 
00808                     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o12">WaitingForDeletion</a> = SegmentEvent;
00809                     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> = SegmentEvent;
00810                     SegmentEvent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00811                 } <span class="keywordflow">else</span> {
00812                     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> = ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o12">WaitingForDeletion</a>;
00813                     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>-&gt;RefCount += 1;
00814                 }
00815 
00816                 <span class="comment">//</span>
00817                 <span class="comment">// Release the pfn lock, the file lock, and wait for the event.</span>
00818                 <span class="comment">//</span>
00819 
00820                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00821                 <span class="keywordflow">if</span> (FileAcquired) {
00822                     <a class="code" href="../../d4/d6/iosubs_8c.html#a109">IoSetTopLevelIrp</a>((<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00823                     <a class="code" href="../../d1/d8/fsrtl_8h.html#a108">FsRtlReleaseFile</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>);
00824                 }
00825 
00826                 <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>-&gt;Event,
00827                                       <a class="code" href="../../d4/d9/ke_8h.html#a407a216">WrVirtualMemory</a>,
00828                                       <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00829                                       <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00830                                       (PLARGE_INTEGER)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00831 
00832                 <span class="keywordflow">if</span> (FileAcquired) {
00833                     <a class="code" href="../../d1/d8/fsrtl_8h.html#a107">FsRtlAcquireFileExclusive</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>);
00834                     <a class="code" href="../../d4/d6/iosubs_8c.html#a109">IoSetTopLevelIrp</a>((<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>)<a class="code" href="../../d1/d8/fsrtl_8h.html#a11">FSRTL_FSP_TOP_LEVEL_IRP</a>);
00835                 }
00836 
00837                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00838                 <a class="code" href="../../d5/d5/sectsup_8c.html#a28">MiFreeEventCounter</a> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00839 
00840                 <span class="keywordflow">if</span> (SegmentEvent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00841 
00842                     <span class="comment">//</span>
00843                     <span class="comment">// The event was freed from pool, allocate another</span>
00844                     <span class="comment">// event in case we have to synchronize one more time.</span>
00845                     <span class="comment">//</span>
00846 
00847                     <span class="keywordflow">goto</span> ReallocateandcheckSegment;
00848                 }
00849                 <span class="keywordflow">goto</span> RecheckSegment;
00850 
00851             } <span class="keywordflow">else</span> {
00852 
00853                 <span class="comment">//</span>
00854                 <span class="comment">// There is already a segment for this file, have</span>
00855                 <span class="comment">// this section refer to that segment.</span>
00856                 <span class="comment">// No need to reference the file object any more.</span>
00857                 <span class="comment">//</span>
00858 
00859                 NewSegment = ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>;
00860                 ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Accessed = 1;
00861                 ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o2">NumberOfSectionReferences</a> += 1;
00862                 <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o1">DereferenceList</a>.Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00863 
00864                     <span class="comment">//</span>
00865                     <span class="comment">// Remove this from the list of unused segments.</span>
00866                     <span class="comment">//</span>
00867 
00868                     RemoveEntryList (&amp;ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o1">DereferenceList</a>);
00869 
00870                     <a class="code" href="../../d4/d8/mi_8h.html#a330">MI_UNUSED_SEGMENTS_REMOVE_CHARGE</a> (ControlArea);
00871 
00872                     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o1">DereferenceList</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00873                     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o1">DereferenceList</a>.Blink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00874                 }
00875                 IncrementedRefCount = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00876 
00877                 <span class="comment">//</span>
00878                 <span class="comment">// If this reference was not from the cache manager</span>
00879                 <span class="comment">// up the count of user references.</span>
00880                 <span class="comment">//</span>
00881 
00882                 <span class="keywordflow">if</span> (IgnoreFileSizing == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00883                     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o7">NumberOfUserReferences</a> += 1;
00884                 }
00885             }
00886         } <span class="keywordflow">else</span> {
00887 
00888             <span class="comment">//</span>
00889             <span class="comment">// There is no segment associated with this file object.</span>
00890             <span class="comment">// Set the file object to refer to the new control area.</span>
00891             <span class="comment">//</span>
00892 
00893             ControlArea = NewControlArea;
00894             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingCreated = 1;
00895 
00896             <span class="keywordflow">if</span> (AllocationAttributes &amp; SEC_IMAGE) {
00897                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00898                     <span class="keywordflow">if</span> (GlobalNeeded == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00899                         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession = 1;
00900                     }
00901 
00902                     <a class="code" href="../../d0/d8/creasect_8c.html#a17">MiInsertImageSectionObject</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>, ControlArea);
00903                 }
00904                 <span class="keywordflow">else</span> {
00905                     ((<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)((<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer-&gt;ImageSectionObject))) =
00906                                                                 ControlArea;
00907                 }
00908             } <span class="keywordflow">else</span> {
00909 <span class="preprocessor">#if DBG</span>
00910 <span class="preprocessor"></span>                PreviousSectionPointer = <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer;
00911 <span class="preprocessor">#endif //DBG</span>
00912 <span class="preprocessor"></span>                ((<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)((<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer-&gt;DataSectionObject))) =
00913                                                                 ControlArea;
00914             }
00915         }
00916 
00917         <span class="keywordflow">if</span> (SegmentEvent != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00918             <a class="code" href="../../d5/d5/sectsup_8c.html#a28">MiFreeEventCounter</a> (SegmentEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00919         }
00920 
00921         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00922         
00923         <span class="keywordflow">if</span> (NewSegment != (<a class="code" href="../../d1/d1/struct__SEGMENT.html">PSEGMENT</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00924 
00925             <span class="comment">//</span>
00926             <span class="comment">// Whether we created a segment or not, flush the data section</span>
00927             <span class="comment">// if there is one.</span>
00928             <span class="comment">//</span>
00929 
00930             <span class="keywordflow">if</span> (AllocationAttributes &amp; SEC_IMAGE) {
00931                 <a class="code" href="../../d0/d8/creasect_8c.html#a18">MiFlushDataSection</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>);
00932             }
00933 
00934             <span class="comment">//</span>
00935             <span class="comment">// A segment already exists for this file object.</span>
00936             <span class="comment">// Deallocate the new control area as it is no longer required.</span>
00937             <span class="comment">// Dereference the file object later when we're done with it.</span>
00938             <span class="comment">//</span>
00939 
00940             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (NewControlArea);
00941 
00942             <span class="comment">//</span>
00943             <span class="comment">// The section is in paged pool, this can't be set until</span>
00944             <span class="comment">// the PFN mutex has been released.</span>
00945             <span class="comment">//</span>
00946 
00947             <span class="keywordflow">if</span> ((!IgnoreFileSizing) &amp;&amp; (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Image == 0)) {
00948 
00949                 <span class="comment">//</span>
00950                 <span class="comment">// The file size in the segment may not match the current</span>
00951                 <span class="comment">// file size, query the file system and get the file</span>
00952                 <span class="comment">// size.</span>
00953                 <span class="comment">//</span>
00954 
00955                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d8/fsrtl_8h.html#a109">FsRtlGetFileSize</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>, (PLARGE_INTEGER)&amp;EndOfFile );
00956 
00957                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00958 
00959                     <span class="keywordflow">if</span> (FileAcquired) {
00960                         <a class="code" href="../../d4/d6/iosubs_8c.html#a109">IoSetTopLevelIrp</a>((<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00961                         <a class="code" href="../../d1/d8/fsrtl_8h.html#a108">FsRtlReleaseFile</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>);
00962                         FileAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00963                     }
00964 
00965                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>);
00966                     <span class="keywordflow">goto</span> UnrefAndReturn;
00967                 }
00968 
00969                 <span class="keywordflow">if</span> (EndOfFile == 0 &amp;&amp; *MaximumSize == 0) {
00970 
00971                     <span class="comment">//</span>
00972                     <span class="comment">// Can't map a zero length without specifying the maximum</span>
00973                     <span class="comment">// size as non-zero.</span>
00974                     <span class="comment">//</span>
00975 
00976                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_MAPPED_FILE_SIZE_ZERO;
00977 
00978                     <span class="keywordflow">if</span> (FileAcquired) {
00979                         <a class="code" href="../../d4/d6/iosubs_8c.html#a109">IoSetTopLevelIrp</a>((<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00980                         <a class="code" href="../../d1/d8/fsrtl_8h.html#a108">FsRtlReleaseFile</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>);
00981                         FileAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00982                     }
00983 
00984                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>);
00985                     <span class="keywordflow">goto</span> UnrefAndReturn;
00986                 }
00987             } <span class="keywordflow">else</span> {
00988 
00989                 <span class="comment">//</span>
00990                 <span class="comment">// The size is okay in the segment.</span>
00991                 <span class="comment">//</span>
00992 
00993                 EndOfFile = (UINT64) NewSegment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o4">SizeOfSegment</a>;
00994             }
00995 
00996             <span class="keywordflow">if</span> (FileAcquired) {
00997                 <a class="code" href="../../d4/d6/iosubs_8c.html#a109">IoSetTopLevelIrp</a>((<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00998                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a108">FsRtlReleaseFile</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>);
00999                 FileAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01000             }
01001 
01002             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>);
01003 
01004             <span class="keywordflow">if</span> (*MaximumSize == 0) {
01005 
01006                 Section.<a class="code" href="../../d5/d0/struct__SECTION.html#o2">SizeOfSection</a>.QuadPart = (LONGLONG)EndOfFile;
01007                 FileSizeChecked = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01008 
01009             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (EndOfFile &gt;= *MaximumSize) {
01010 
01011                 <span class="comment">//</span>
01012                 <span class="comment">// EndOfFile is greater than the MaximumSize,</span>
01013                 <span class="comment">// use the specified maximum size.</span>
01014                 <span class="comment">//</span>
01015 
01016                 Section.<a class="code" href="../../d5/d0/struct__SECTION.html#o2">SizeOfSection</a>.QuadPart = (LONGLONG)*MaximumSize;
01017                 FileSizeChecked = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01018 
01019             } <span class="keywordflow">else</span> {
01020 
01021                 <span class="comment">//</span>
01022                 <span class="comment">// Need to extend the section, make sure the file was</span>
01023                 <span class="comment">// opened for write access.</span>
01024                 <span class="comment">//</span>
01025 
01026                 <span class="keywordflow">if</span> (((SectionPageProtection &amp; PAGE_READWRITE) |
01027                     (SectionPageProtection &amp; PAGE_EXECUTE_READWRITE)) == 0) {
01028 
01029                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SECTION_TOO_BIG;
01030                     <span class="keywordflow">goto</span> UnrefAndReturn;
01031                 }
01032                 Section.<a class="code" href="../../d5/d0/struct__SECTION.html#o2">SizeOfSection</a>.QuadPart = (LONGLONG)*MaximumSize;
01033             }
01034 
01035         } <span class="keywordflow">else</span> {
01036 
01037             <span class="comment">//</span>
01038             <span class="comment">// The file does not have an associated segment, create a segment</span>
01039             <span class="comment">// object.</span>
01040             <span class="comment">//</span>
01041 
01042             <span class="keywordflow">if</span> (AllocationAttributes &amp; SEC_IMAGE) {
01043 
01044                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d8/mi_8h.html#a921">MiCreateImageFileMap</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>, &amp;Segment);
01045 
01046             } <span class="keywordflow">else</span> {
01047 
01048                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d8/mi_8h.html#a922">MiCreateDataFileMap</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>,
01049                                               &amp;Segment,
01050                                               MaximumSize,
01051                                               SectionPageProtection,
01052                                               AllocationAttributes,
01053                                               IgnoreFileSizing );
01054                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PreviousSectionPointer == <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer);
01055             }
01056 
01057             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01058 
01059                 <span class="comment">//</span>
01060                 <span class="comment">// Lock the PFN database and check to see if another thread has</span>
01061                 <span class="comment">// tried to create a segment to the file object at the same</span>
01062                 <span class="comment">// time.</span>
01063                 <span class="comment">//</span>
01064 
01065                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01066 
01067                 <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> = ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o12">WaitingForDeletion</a>;
01068                 ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o12">WaitingForDeletion</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01069                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.FilePointerNull == 0);
01070                 ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.FilePointerNull = 1;
01071 
01072                 <span class="keywordflow">if</span> (AllocationAttributes &amp; SEC_IMAGE) {
01073                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01074                         <a class="code" href="../../d4/d8/mi_8h.html#a914">MiRemoveImageSectionObject</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>, ControlArea);
01075                     }
01076                     <span class="keywordflow">else</span> {
01077                         (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)((<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer-&gt;ImageSectionObject)) =
01078                                                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01079                     }
01080                 } <span class="keywordflow">else</span> {
01081                     (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)((<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer-&gt;DataSectionObject)) =
01082                                                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01083                 }
01084                 ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingCreated = 0;
01085 
01086                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01087 
01088                 <span class="keywordflow">if</span> (FileAcquired) {
01089                     <a class="code" href="../../d4/d6/iosubs_8c.html#a109">IoSetTopLevelIrp</a>((<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01090                     <a class="code" href="../../d1/d8/fsrtl_8h.html#a108">FsRtlReleaseFile</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>);
01091                 }
01092 
01093                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (NewControlArea);
01094 
01095                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>);
01096 
01097                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01098 
01099                     <span class="comment">//</span>
01100                     <span class="comment">// Signal any waiters that the segment structure exists.</span>
01101                     <span class="comment">//</span>
01102 
01103                     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>-&gt;Event, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01104                 }
01105 
01106                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01107             }
01108 
01109             <span class="comment">//</span>
01110             <span class="comment">// If the size was specified as zero, set the section size</span>
01111             <span class="comment">// from the created segment size.  This solves problems with</span>
01112             <span class="comment">// race conditions when multiple sections</span>
01113             <span class="comment">// are created for the same mapped file with varying sizes.</span>
01114             <span class="comment">//</span>
01115 
01116             <span class="keywordflow">if</span> (*MaximumSize == 0) {
01117                 Section.<a class="code" href="../../d5/d0/struct__SECTION.html#o2">SizeOfSection</a>.QuadPart = (LONGLONG)Segment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o4">SizeOfSegment</a>;
01118             } <span class="keywordflow">else</span> {
01119                 Section.<a class="code" href="../../d5/d0/struct__SECTION.html#o2">SizeOfSection</a>.QuadPart = (LONGLONG)*MaximumSize;
01120             }
01121         }
01122 
01123     } <span class="keywordflow">else</span> {
01124 
01125         <span class="comment">//</span>
01126         <span class="comment">// No file handle exists, this is a page file backed section.</span>
01127         <span class="comment">//</span>
01128 
01129         <span class="keywordflow">if</span> (AllocationAttributes &amp; SEC_IMAGE) {
01130             <span class="keywordflow">return</span> STATUS_INVALID_FILE_FOR_SECTION;
01131         }
01132 
01133         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d8/mi_8h.html#a923">MiCreatePagingFileMap</a> ( &amp;NewSegment,
01134                                          MaximumSize,
01135                                          ProtectionMask,
01136                                          AllocationAttributes);
01137 
01138         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01139             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01140         }
01141 
01142         <span class="comment">//</span>
01143         <span class="comment">// Set the section size from the created segment size.  This</span>
01144         <span class="comment">// solves problems with race conditions when multiple sections</span>
01145         <span class="comment">// are created for the same mapped file with varying sizes.</span>
01146         <span class="comment">//</span>
01147 
01148         Section.<a class="code" href="../../d5/d0/struct__SECTION.html#o2">SizeOfSection</a>.QuadPart = (LONGLONG)NewSegment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o4">SizeOfSegment</a>;
01149         ControlArea = NewSegment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o0">ControlArea</a>;
01150     }
01151 
01152 <span class="preprocessor">#if DBG</span>
01153 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a64">MM_DBG_SECTIONS</a>) {
01154         <span class="keywordflow">if</span> (NewSegment == (<a class="code" href="../../d1/d1/struct__SEGMENT.html">PSEGMENT</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01155             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"inserting segment %lx control %lx\n"</span>,Segment,
01156                         Segment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o0">ControlArea</a>);
01157         } <span class="keywordflow">else</span> {
01158             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"inserting segment %lx control %lx\n"</span>,NewSegment,
01159                         NewSegment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o0">ControlArea</a>);
01160         }
01161     }
01162 <span class="preprocessor">#endif</span>
01163 <span class="preprocessor"></span>
01164 
01165     <span class="keywordflow">if</span> (NewSegment == (<a class="code" href="../../d1/d1/struct__SEGMENT.html">PSEGMENT</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01166         NewSegment = Segment;
01167 
01168         <span class="comment">//</span>
01169         <span class="comment">// Lock the PFN database and check to see if another thread has</span>
01170         <span class="comment">// tried to create a segment to the file object at the same time.</span>
01171         <span class="comment">//</span>
01172 
01173         SegmentControlArea = Segment-&gt;ControlArea;
01174 
01175         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01176 
01177         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01178 
01179         <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> = ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o12">WaitingForDeletion</a>;
01180         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o12">WaitingForDeletion</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01181 
01182         <span class="keywordflow">if</span> (AllocationAttributes &amp; SEC_IMAGE) {
01183 
01184             <span class="comment">//</span>
01185             <span class="comment">// Change the control area in the file object pointer.</span>
01186             <span class="comment">//</span>
01187 
01188             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01189                 <a class="code" href="../../d4/d8/mi_8h.html#a914">MiRemoveImageSectionObject</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>, NewControlArea);
01190                 <a class="code" href="../../d0/d8/creasect_8c.html#a17">MiInsertImageSectionObject</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>, SegmentControlArea);
01191             }
01192             <span class="keywordflow">else</span> {
01193                 ((<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)(<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer-&gt;ImageSectionObject)) =
01194                                                          SegmentControlArea;
01195             }
01196 
01197             ControlArea = SegmentControlArea;
01198         }
01199 
01200         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingCreated = 0;
01201 
01202         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01203 
01204         <span class="keywordflow">if</span> (AllocationAttributes &amp; SEC_IMAGE) {
01205 
01206             <span class="comment">//</span>
01207             <span class="comment">// Deallocate the pool used for the original control area.</span>
01208             <span class="comment">//</span>
01209 
01210             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (NewControlArea);
01211         }
01212 
01213         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01214 
01215             <span class="comment">//</span>
01216             <span class="comment">// Signal any waiters that the segment structure exists.</span>
01217             <span class="comment">//</span>
01218 
01219             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>-&gt;Event, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01220         }
01221 
01222         <a class="code" href="../../d2/d1/mm_8h.html#a91">PERFINFO_SECTION_CREATE</a>(ControlArea);
01223     }
01224 
01225     <span class="comment">//</span>
01226     <span class="comment">// Being created has now been cleared allowing other threads</span>
01227     <span class="comment">// to reference the segment.  Release the resource on the file.</span>
01228     <span class="comment">//</span>
01229 
01230     <span class="keywordflow">if</span> (FileAcquired) {
01231         <a class="code" href="../../d4/d6/iosubs_8c.html#a109">IoSetTopLevelIrp</a>((<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01232         <a class="code" href="../../d1/d8/fsrtl_8h.html#a108">FsRtlReleaseFile</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>);
01233         FileAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01234     }
01235 
01236 ReferenceObject:
01237 
01238     <span class="keywordflow">if</span> (ChangeFileReference) {
01239         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a> (FileObject);
01240     }
01241 
01242     <span class="comment">//</span>
01243     <span class="comment">// Now that the segment object is created, make the section object</span>
01244     <span class="comment">// refer to the segment object.</span>
01245     <span class="comment">//</span>
01246 
01247     Section.<a class="code" href="../../d5/d0/struct__SECTION.html#o1">Segment</a> = NewSegment;
01248     Section.<a class="code" href="../../d5/d0/struct__SECTION.html#o5">u</a>.LongFlags = ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.LongFlags;
01249 
01250     <span class="comment">//</span>
01251     <span class="comment">// Create the section object now.  The section object is created</span>
01252     <span class="comment">// now so that the error handling when the section object cannot</span>
01253     <span class="comment">// be created is simplified.</span>
01254     <span class="comment">//</span>
01255 
01256     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a> (PreviousMode,
01257                              <a class="code" href="../../d2/d1/mm_8h.html#a133">MmSectionObjectType</a>,
01258                              <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01259                              PreviousMode,
01260                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01261                              <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d0/struct__SECTION.html">SECTION</a>),
01262                              <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a479">SECTION</a>) +
01263                                  NewSegment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o2">TotalNumberOfPtes</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>),
01264                              <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">CONTROL_AREA</a>) +
01265                                  NewSegment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o0">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o5">NumberOfSubsections</a> *
01266                                    <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d7/struct__SUBSECTION.html">SUBSECTION</a>),
01267                              (PVOID *)&amp;NewSection);
01268 
01269     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01270         <span class="keywordflow">goto</span> UnrefAndReturn;
01271     }
01272 
01273     RtlMoveMemory (NewSection, &amp;Section, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a479">SECTION</a>));
01274     NewSection-&gt;Address.StartingVpn = 0;
01275 
01276     <span class="keywordflow">if</span> (!IgnoreFileSizing) {
01277 
01278         <span class="comment">//</span>
01279         <span class="comment">// Indicate that the cache manager is not the owner of this</span>
01280         <span class="comment">// section.</span>
01281         <span class="comment">//</span>
01282 
01283         NewSection-&gt;u.Flags.UserReference = 1;
01284 
01285         <span class="keywordflow">if</span> (AllocationAttributes &amp; SEC_NO_CHANGE) {
01286 
01287             <span class="comment">//</span>
01288             <span class="comment">// Indicate that once the section is mapped, no protection</span>
01289             <span class="comment">// changes or freeing the mapping is allowed.</span>
01290             <span class="comment">//</span>
01291 
01292             NewSection-&gt;u.Flags.NoChange = 1;
01293         }
01294 
01295         <span class="keywordflow">if</span> (((SectionPageProtection &amp; PAGE_READWRITE) |
01296             (SectionPageProtection &amp; PAGE_EXECUTE_READWRITE)) == 0) {
01297 
01298             <span class="comment">//</span>
01299             <span class="comment">// This section does not support WRITE access, indicate</span>
01300             <span class="comment">// that changing the protection to WRITE results in COPY_ON_WRITE.</span>
01301             <span class="comment">//</span>
01302 
01303             NewSection-&gt;u.Flags.CopyOnWrite = 1;
01304         }
01305 
01306         <span class="keywordflow">if</span> (AllocationAttributes &amp; SEC_BASED) {
01307 
01308             NewSection-&gt;u.Flags.Based = 1;
01309 
01310             SectionBasedRoot = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a675">MmSectionBasedRoot</a>;
01311 
01312             <span class="comment">//</span>
01313             <span class="comment">// Get the allocation base mutex.</span>
01314             <span class="comment">//</span>
01315 
01316             ExAcquireFastMutex (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a678">MmSectionBasedMutex</a>);
01317 
01318             <span class="comment">//</span>
01319             <span class="comment">// This section is based at a unique address system wide.</span>
01320             <span class="comment">//</span>
01321 
01322             <span class="keywordflow">try</span> {
01323                 NewSection-&gt;Address.StartingVpn = (ULONG_PTR)<a class="code" href="../../d5/d5/sectsup_8c.html#a16">MiFindEmptySectionBaseDown</a> (
01324                                                  NewSection-&gt;SizeOfSection.LowPart,
01325                                                  <a class="code" href="../../d4/d8/mi_8h.html#a676">MmHighSectionBase</a>);
01326 
01327             } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01328                 ExReleaseFastMutex (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a678">MmSectionBasedMutex</a>);
01329                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (NewSection);
01330                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01331             }
01332 
01333             NewSection-&gt;Address.EndingVpn = NewSection-&gt;Address.StartingVpn +
01334                                   NewSection-&gt;SizeOfSection.LowPart - 1;
01335 
01336             <a class="code" href="../../d5/d5/sectsup_8c.html#a14">MiInsertBasedSection</a> (NewSection);
01337             ExReleaseFastMutex (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a678">MmSectionBasedMutex</a>);
01338         }
01339     }
01340 
01341     <span class="comment">//</span>
01342     <span class="comment">// If the cache manager is creating the section, set the was</span>
01343     <span class="comment">// purged flag as the file size can change.</span>
01344     <span class="comment">//</span>
01345 
01346     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.WasPurged |= IgnoreFileSizing;
01347 
01348     <span class="comment">//</span>
01349     <span class="comment">// Check to see if the section is for a data file and the size</span>
01350     <span class="comment">// of the section is greater than the current size of the</span>
01351     <span class="comment">// segment.</span>
01352     <span class="comment">//</span>
01353 
01354     <span class="keywordflow">if</span> (((ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.WasPurged == 1) &amp;&amp; (!IgnoreFileSizing)) &amp;&amp;
01355                       (!FileSizeChecked)
01356                             ||
01357         ((UINT64)NewSection-&gt;SizeOfSection.QuadPart &gt;
01358                                 NewSection-&gt;Segment-&gt;SizeOfSegment)) {
01359 
01360         TempSectionSize = NewSection-&gt;SizeOfSection;
01361 
01362         NewSection-&gt;SizeOfSection.QuadPart = (LONGLONG)NewSection-&gt;Segment-&gt;SizeOfSegment;
01363 
01364         <span class="comment">//</span>
01365         <span class="comment">// Even if the caller didn't specify extension rights, we enable it here</span>
01366         <span class="comment">// temporarily to make the section correct.  Use a temporary section</span>
01367         <span class="comment">// instead of temporarily editing the real section to avoid opening</span>
01368         <span class="comment">// a security window that other concurrent threads could exploit.</span>
01369         <span class="comment">//</span>
01370 
01371         <span class="keywordflow">if</span> (((NewSection-&gt;InitialPageProtection &amp; PAGE_READWRITE) |
01372             (NewSection-&gt;InitialPageProtection &amp; PAGE_EXECUTE_READWRITE)) == 0) {
01373                 <a class="code" href="../../d4/d8/mi_8h.html#a479">SECTION</a>     WritableSection;
01374 
01375                 *(<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)&amp;WritableSection = *NewSection;
01376 
01377                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d0/extsect_8c.html#a1">MmExtendSection</a> (&amp;WritableSection,
01378                                           &amp;TempSectionSize,
01379                                           IgnoreFileSizing);
01380 
01381                 NewSection-&gt;SizeOfSection = WritableSection.<a class="code" href="../../d5/d0/struct__SECTION.html#o2">SizeOfSection</a>;
01382         }
01383         <span class="keywordflow">else</span> {
01384             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d0/extsect_8c.html#a1">MmExtendSection</a> (NewSection,
01385                                       &amp;TempSectionSize,
01386                                       IgnoreFileSizing);
01387         }
01388 
01389         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01390             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (NewSection);
01391             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01392         }
01393     }
01394 
01395     *SectionObject = (PVOID)NewSection;
01396 
01397     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01398 
01399 UnrefAndReturn:
01400 
01401     <span class="comment">//</span>
01402     <span class="comment">// Unreference the control area, if it was referenced and return</span>
01403     <span class="comment">// the error status.</span>
01404     <span class="comment">//</span>
01405 
01406     <span class="keywordflow">if</span> (FileAcquired) {
01407         <a class="code" href="../../d4/d6/iosubs_8c.html#a109">IoSetTopLevelIrp</a>((<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01408         <a class="code" href="../../d1/d8/fsrtl_8h.html#a108">FsRtlReleaseFile</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>);
01409     }
01410 
01411     <span class="keywordflow">if</span> (IncrementedRefCount) {
01412         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01413         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o2">NumberOfSectionReferences</a> -= 1;
01414         <span class="keywordflow">if</span> (!IgnoreFileSizing) {
01415             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o7">NumberOfUserReferences</a> &gt; 0);
01416             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o7">NumberOfUserReferences</a> -= 1;
01417         }
01418         <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, OldIrql);
01419     }
01420     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01421 }
01422 
01423 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01424"></a><a class="code" href="../../d4/d8/mi_8h.html#a921">01424</a> <a class="code" href="../../d4/d8/mi_8h.html#a921">MiCreateImageFileMap</a> (
01425     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> File,
01426     OUT <a class="code" href="../../d1/d1/struct__SEGMENT.html">PSEGMENT</a> *Segment
01427     )
01428 
01429 <span class="comment">/*++</span>
01430 <span class="comment"></span>
01431 <span class="comment">Routine Description:</span>
01432 <span class="comment"></span>
01433 <span class="comment">    This function creates the necessary structures to allow the mapping</span>
01434 <span class="comment">    of an image file.</span>
01435 <span class="comment"></span>
01436 <span class="comment">    The image file is opened and verified for correctness, a segment</span>
01437 <span class="comment">    object is created and initialized based on data in the image</span>
01438 <span class="comment">    header.</span>
01439 <span class="comment"></span>
01440 <span class="comment">Arguments:</span>
01441 <span class="comment"></span>
01442 <span class="comment">    File - Supplies the file object for the image file.</span>
01443 <span class="comment"></span>
01444 <span class="comment">    Segment - Returns the segment object.</span>
01445 <span class="comment"></span>
01446 <span class="comment">Return Value:</span>
01447 <span class="comment"></span>
01448 <span class="comment">    Returns the status value.</span>
01449 <span class="comment"></span>
01450 <span class="comment">    TBS</span>
01451 <span class="comment"></span>
01452 <span class="comment"></span>
01453 <span class="comment">--*/</span>
01454 
01455 {
01456     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01457     ULONG_PTR EndingAddress;
01458     ULONG NumberOfPtes;
01459     ULONG SizeOfSegment;
01460     ULONG SectionVirtualSize;
01461     ULONG i;
01462     ULONG j;
01463     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
01464     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
01465     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01466     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
01467     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPteDemandZero;
01468     PVOID Base;
01469     PIMAGE_DOS_HEADER DosHeader;
01470     PIMAGE_NT_HEADERS NtHeader;
01471     PIMAGE_FILE_HEADER FileHeader;
01472     ULONG SizeOfImage;
01473     ULONG SizeOfHeaders;
01474 <span class="preprocessor">#if defined(_WIN64)</span>
01475 <span class="preprocessor"></span>    PIMAGE_NT_HEADERS32 NtHeader32;
01476 <span class="preprocessor">#endif</span>
01477 <span class="preprocessor"></span>    PIMAGE_SECTION_HEADER SectionTableEntry;
01478     <a class="code" href="../../d1/d1/struct__SEGMENT.html">PSEGMENT</a> NewSegment;
01479     ULONG <a class="code" href="../../d3/d8/udfprocs_8h.html#a43">SectorOffset</a>;
01480     ULONG NumberOfSubsections;
01481     PFN_NUMBER PageFrameNumber;
01482     LARGE_INTEGER StartingOffset;
01483     PCHAR ExtendedHeader;
01484     PPFN_NUMBER Page;
01485     ULONG_PTR PreferredImageBase;
01486     ULONG_PTR NextVa;
01487     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> InPageEvent;
01488     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl;
01489     ULONG ImageFileSize;
01490     ULONG OffsetToSectionTable;
01491     ULONG ImageAlignment;
01492     ULONG RoundingAlignment;
01493     ULONG FileAlignment;
01494     BOOLEAN ImageCommit;
01495     BOOLEAN SectionCommit;
01496     IO_STATUS_BLOCK IoStatus;
01497     LARGE_INTEGER EndOfFile;
01498     ULONG NtHeaderSize;
01499     ULONG SubsectionsAllocated;
01500     <a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">PLARGE_CONTROL_AREA</a> LargeControlArea;
01501     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> NewSubsection;
01502     ULONG OriginalProtection;
01503     ULONG LoaderFlags;
01504 
01505 <span class="preprocessor">#if defined (_ALPHA_) || defined(_IA64_)</span>
01506 <span class="preprocessor"></span>    <span class="comment">//[barrybo] bugbug:  The image alignment code should be switched back</span>
01507     <span class="comment">//                   out on IA64 when EMNT supports 4k pages for WOW64.</span>
01508     BOOLEAN InvalidAlignmentAllowed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01509 
01510     ULONG TempNumberOfSubsections;
01511     PIMAGE_SECTION_HEADER TempSectionTableEntry;
01512     ULONG AdditionalSubsections;
01513     ULONG AdditionalPtes;
01514     ULONG AdditionalBasePtes;
01515     ULONG NewSubsectionsAllocated; 
01516     <a class="code" href="../../d1/d1/struct__SEGMENT.html">PSEGMENT</a> OldSegment;
01517     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> NewPointerPte;
01518     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> OldPointerPte;
01519     ULONG OrigNumberOfPtes;
01520     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> NewControlArea;
01521 
01522 <span class="preprocessor">#endif</span>
01523 <span class="preprocessor"></span>
01524     ExtendedHeader = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01525 
01526     <span class="comment">// *************************************************************</span>
01527     <span class="comment">// Create image file section.</span>
01528     <span class="comment">// *************************************************************</span>
01529 
01530     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01531 
01532 
01533     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d8/fsrtl_8h.html#a109">FsRtlGetFileSize</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>, &amp;EndOfFile);
01534 
01535     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_FILE_IS_A_DIRECTORY) {
01536 
01537         <span class="comment">//</span>
01538         <span class="comment">// Can't map a directory as a section. Return error.</span>
01539         <span class="comment">//</span>
01540 
01541         <span class="keywordflow">return</span> STATUS_INVALID_FILE_FOR_SECTION;
01542     }
01543 
01544     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01545         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01546     }
01547 
01548     <span class="keywordflow">if</span> (EndOfFile.HighPart != 0) {
01549 
01550         <span class="comment">//</span>
01551         <span class="comment">// File too big. Return error.</span>
01552         <span class="comment">//</span>
01553 
01554         <span class="keywordflow">return</span> STATUS_INVALID_FILE_FOR_SECTION;
01555     }
01556 
01557     <span class="comment">//</span>
01558     <span class="comment">// Create a segment which maps an image file.</span>
01559     <span class="comment">// For now map a COFF image file with the subsections</span>
01560     <span class="comment">// containing the based address of the file.</span>
01561     <span class="comment">//</span>
01562 
01563     <span class="comment">//</span>
01564     <span class="comment">// Read in the file header.</span>
01565     <span class="comment">//</span>
01566 
01567     InPageEvent = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
01568                                   <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>) + <a class="code" href="../../d2/d1/mm_8h.html#a304">MmSizeOfMdl</a> (
01569                                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01570                                                       <a class="code" href="../../d0/d8/creasect_8c.html#a1">MM_MAXIMUM_IMAGE_HEADER</a>),
01571                                                       <a class="code" href="../../d0/d8/creasect_8c.html#a7">MMTEMPORARY</a>);
01572     <span class="keywordflow">if</span> (InPageEvent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01573         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01574     }
01575 
01576     Mdl = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)(InPageEvent + 1);
01577 
01578     <span class="comment">//</span>
01579     <span class="comment">// Create an event for the read operation.</span>
01580     <span class="comment">//</span>
01581 
01582     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (InPageEvent, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01583 
01584     <span class="comment">//</span>
01585     <span class="comment">// Build an MDL for the operation.</span>
01586     <span class="comment">//</span>
01587 
01588     <a class="code" href="../../d5/d6/iosup_8c.html#a73">MmCreateMdl</a>( Mdl, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01589     Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a13">MDL_PAGES_LOCKED</a>;
01590 
01591     PageFrameNumber = <a class="code" href="../../d4/d8/mi_8h.html#a809">MiGetPageForHeader</a>();
01592 
01593     Page = (PPFN_NUMBER)(Mdl + 1);
01594     *Page = PageFrameNumber;
01595 
01596     <a class="code" href="../../d4/d8/mi_8h.html#a166">ZERO_LARGE</a> (StartingOffset);
01597 
01598     <a class="code" href="../../d4/d2/cache_8h.html#a65">CcZeroEndOfLastPage</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>);
01599 
01600     <span class="comment">//</span>
01601     <span class="comment">// Flush the data section if there is one.</span>
01602     <span class="comment">//</span>
01603 
01604     <a class="code" href="../../d0/d8/creasect_8c.html#a18">MiFlushDataSection</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>);
01605 
01606     Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a13">MDL_PAGES_LOCKED</a>;
01607     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a89">IoPageRead</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>,
01608                          Mdl,
01609                          &amp;StartingOffset,
01610                          InPageEvent,
01611                          &amp;IoStatus
01612                         );
01613 
01614     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
01615         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( InPageEvent,
01616                                <a class="code" href="../../d4/d9/ke_8h.html#a407a207">WrPageIn</a>,
01617                                <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01618                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01619                                (PLARGE_INTEGER)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01620     }
01621 
01622     <span class="keywordflow">if</span> (Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a12">MDL_MAPPED_TO_SYSTEM_VA</a>) {
01623         <a class="code" href="../../d5/d6/iosup_8c.html#a56">MmUnmapLockedPages</a> (Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o4">MappedSystemVa</a>, Mdl);
01624     }
01625 
01626     <span class="keywordflow">if</span> ((!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) || (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IoStatus.Status))) {
01627         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_FILE_LOCK_CONFLICT) {
01628             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_FILE_FOR_SECTION;
01629         }
01630         <span class="keywordflow">goto</span> BadSection;
01631     }
01632 
01633     Base = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a1">MiMapImageHeaderInHyperSpace</a> (PageFrameNumber);
01634     DosHeader = (PIMAGE_DOS_HEADER)Base;
01635 
01636     <span class="keywordflow">if</span> (IoStatus.Information != <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) {
01637 
01638         <span class="comment">//</span>
01639         <span class="comment">// A full page was not read from the file, zero any remaining</span>
01640         <span class="comment">// bytes.</span>
01641         <span class="comment">//</span>
01642 
01643         RtlZeroMemory ((PVOID)((PCHAR)Base + IoStatus.Information),
01644                        <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - IoStatus.Information);
01645     }
01646 
01647     <span class="comment">//</span>
01648     <span class="comment">// Check to determine if this is an NT image (PE format) or</span>
01649     <span class="comment">// a DOS image, Win-16 image, or OS/2 image.  If the image is</span>
01650     <span class="comment">// not NT format, return an error indicating which image it</span>
01651     <span class="comment">// appears to be.</span>
01652     <span class="comment">//</span>
01653 
01654     <span class="keywordflow">if</span> (DosHeader-&gt;e_magic != IMAGE_DOS_SIGNATURE) {
01655 
01656         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_IMAGE_NOT_MZ;
01657         <span class="keywordflow">goto</span> NeImage;
01658     }
01659 
01660 <span class="preprocessor">#ifndef i386</span>
01661 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (((ULONG)DosHeader-&gt;e_lfanew &amp; 3) != 0) {
01662 
01663         <span class="comment">//</span>
01664         <span class="comment">// The image header is not aligned on a longword boundary.</span>
01665         <span class="comment">// Report this as an invalid protect mode image.</span>
01666         <span class="comment">//</span>
01667 
01668         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_IMAGE_PROTECT;
01669         <span class="keywordflow">goto</span> NeImage;
01670     }
01671 <span class="preprocessor">#endif</span>
01672 <span class="preprocessor"></span>
01673     <span class="keywordflow">if</span> ((ULONG)DosHeader-&gt;e_lfanew &gt; EndOfFile.LowPart) {
01674         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_IMAGE_PROTECT;
01675         <span class="keywordflow">goto</span> NeImage;
01676     }
01677 
01678     <span class="keywordflow">if</span> (((ULONG)DosHeader-&gt;e_lfanew +
01679             <span class="keyword">sizeof</span>(IMAGE_NT_HEADERS) +
01680             (16 * <span class="keyword">sizeof</span>(IMAGE_SECTION_HEADER))) &lt;= (ULONG)DosHeader-&gt;e_lfanew) {
01681         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_IMAGE_PROTECT;
01682         <span class="keywordflow">goto</span> NeImage;
01683     }
01684 
01685     <span class="keywordflow">if</span> (((ULONG)DosHeader-&gt;e_lfanew +
01686             <span class="keyword">sizeof</span>(IMAGE_NT_HEADERS) +
01687             (16 * <span class="keyword">sizeof</span>(IMAGE_SECTION_HEADER))) &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) {
01688 
01689         <span class="comment">//</span>
01690         <span class="comment">// The PE header is not within the page already read or the</span>
01691         <span class="comment">// objects are in another page.</span>
01692         <span class="comment">// Build another MDL and read an additional 8k.</span>
01693         <span class="comment">//</span>
01694 
01695         ExtendedHeader = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
01696                                          <a class="code" href="../../d0/d8/creasect_8c.html#a1">MM_MAXIMUM_IMAGE_HEADER</a>,
01697                                          <a class="code" href="../../d0/d8/creasect_8c.html#a7">MMTEMPORARY</a>);
01698         <span class="keywordflow">if</span> (ExtendedHeader == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01699             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
01700             <span class="keywordflow">goto</span> NeImage;
01701         }
01702 
01703         <span class="comment">//</span>
01704         <span class="comment">// Build an MDL for the operation.</span>
01705         <span class="comment">//</span>
01706 
01707         <a class="code" href="../../d5/d6/iosup_8c.html#a73">MmCreateMdl</a>( Mdl, ExtendedHeader, <a class="code" href="../../d0/d8/creasect_8c.html#a1">MM_MAXIMUM_IMAGE_HEADER</a>);
01708 
01709         <a class="code" href="../../d5/d6/iosup_8c.html#a46">MmBuildMdlForNonPagedPool</a> (Mdl);
01710 
01711         StartingOffset.LowPart = PtrToUlong(<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> ((ULONG)DosHeader-&gt;e_lfanew));
01712 
01713         <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (InPageEvent);
01714         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a89">IoPageRead</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>,
01715                              Mdl,
01716                              &amp;StartingOffset,
01717                              InPageEvent,
01718                              &amp;IoStatus
01719                             );
01720 
01721         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
01722             <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( InPageEvent,
01723                                    <a class="code" href="../../d4/d9/ke_8h.html#a407a207">WrPageIn</a>,
01724                                    <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01725                                    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01726                                    (PLARGE_INTEGER)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01727         }
01728 
01729         <span class="keywordflow">if</span> (Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a12">MDL_MAPPED_TO_SYSTEM_VA</a>) {
01730             <a class="code" href="../../d5/d6/iosup_8c.html#a56">MmUnmapLockedPages</a> (Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o4">MappedSystemVa</a>, Mdl);
01731         }
01732 
01733         <span class="keywordflow">if</span> ((!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) || (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IoStatus.Status))) {
01734             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_FILE_LOCK_CONFLICT) {
01735                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_FILE_FOR_SECTION;
01736             }
01737             <span class="keywordflow">goto</span> NeImage;
01738         }
01739         NtHeader = (PIMAGE_NT_HEADERS)((PCHAR)ExtendedHeader +
01740                           <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>((ULONG)DosHeader-&gt;e_lfanew));
01741         NtHeaderSize = <a class="code" href="../../d0/d8/creasect_8c.html#a1">MM_MAXIMUM_IMAGE_HEADER</a> -
01742                             (ULONG)(<a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>((ULONG)DosHeader-&gt;e_lfanew));
01743 
01744     } <span class="keywordflow">else</span> {
01745         NtHeader = (PIMAGE_NT_HEADERS)((PCHAR)DosHeader +
01746                                           (ULONG)DosHeader-&gt;e_lfanew);
01747         NtHeaderSize = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - (ULONG)DosHeader-&gt;e_lfanew;
01748     }
01749     FileHeader = &amp;NtHeader-&gt;FileHeader;
01750 
01751     <span class="comment">//</span>
01752     <span class="comment">// Check to see if this is an NT image or a DOS or OS/2 image.</span>
01753     <span class="comment">//</span>
01754 
01755     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/creasect_8c.html#a14">MiVerifyImageHeader</a> (NtHeader, DosHeader, NtHeaderSize);
01756     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
01757         <span class="keywordflow">goto</span> NeImage;
01758     }
01759 
01760 <span class="preprocessor">#if defined(_WIN64)</span>
01761 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (NtHeader-&gt;OptionalHeader.Magic == IMAGE_NT_OPTIONAL_HDR32_MAGIC) {
01762         <span class="comment">//</span>
01763         <span class="comment">// The image is 32-bit.  All code below this point must check</span>
01764         <span class="comment">// if NtHeader is NULL.  If it is, then the image is PE32 and</span>
01765         <span class="comment">// NtHeader32 must be used.</span>
01766         <span class="comment">//</span>
01767         NtHeader32 = (PIMAGE_NT_HEADERS32)NtHeader;
01768         NtHeader = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01769     } <span class="keywordflow">else</span> {
01770         NtHeader32 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01771     }
01772 
01773     <span class="keywordflow">if</span> (NtHeader) {
01774 <span class="preprocessor">#endif</span>
01775 <span class="preprocessor"></span>        ImageAlignment = NtHeader-&gt;OptionalHeader.SectionAlignment;
01776         FileAlignment = NtHeader-&gt;OptionalHeader.FileAlignment - 1;
01777         SizeOfImage = NtHeader-&gt;OptionalHeader.SizeOfImage;
01778         LoaderFlags = NtHeader-&gt;OptionalHeader.LoaderFlags;
01779 <span class="preprocessor">#if defined (_WIN64)</span>
01780 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
01781         ImageAlignment = NtHeader32-&gt;OptionalHeader.SectionAlignment;
01782         FileAlignment = NtHeader32-&gt;OptionalHeader.FileAlignment - 1;
01783         SizeOfImage = NtHeader32-&gt;OptionalHeader.SizeOfImage;
01784         LoaderFlags = NtHeader32-&gt;OptionalHeader.LoaderFlags;
01785     }
01786 <span class="preprocessor">#endif</span>
01787 <span class="preprocessor"></span>
01788     RoundingAlignment = ImageAlignment;
01789     NumberOfSubsections = FileHeader-&gt;NumberOfSections;
01790 
01791     <span class="keywordflow">if</span> (ImageAlignment &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) {
01792 
01793         <span class="comment">//</span>
01794         <span class="comment">// The image alignment is less than the page size,</span>
01795         <span class="comment">// map the image with a single subsection.</span>
01796         <span class="comment">//</span>
01797 
01798         ControlArea = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
01799                       (ULONG)(<span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">CONTROL_AREA</a>) + (<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d7/struct__SUBSECTION.html">SUBSECTION</a>))),
01800                       <a class="code" href="../../d0/d8/creasect_8c.html#a6">MMCONTROL</a>);
01801         SubsectionsAllocated = 1;
01802     } <span class="keywordflow">else</span> {
01803 
01804         <span class="comment">//</span>
01805         <span class="comment">// Allocate a control area and a subsection for each section</span>
01806         <span class="comment">// header plus one for the image header which has no section.</span>
01807         <span class="comment">//</span>
01808 
01809         ControlArea = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
01810                                             (ULONG)(<span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">CONTROL_AREA</a>) +
01811                                                     (<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d7/struct__SUBSECTION.html">SUBSECTION</a>) *
01812                                                 (NumberOfSubsections + 1))),
01813                                             'iCmM');
01814         SubsectionsAllocated = NumberOfSubsections + 1;
01815     }
01816 
01817     <span class="keywordflow">if</span> (ControlArea == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01818 
01819         <span class="comment">//</span>
01820         <span class="comment">// The requested pool could not be allocated.</span>
01821         <span class="comment">//</span>
01822 
01823         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
01824         <span class="keywordflow">goto</span> NeImage;
01825     }
01826 
01827     <span class="comment">//</span>
01828     <span class="comment">// Zero the control area and the FIRST subsection.</span>
01829     <span class="comment">//</span>
01830 
01831     RtlZeroMemory (ControlArea,
01832                    <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">CONTROL_AREA</a>) + <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d7/struct__SUBSECTION.html">SUBSECTION</a>));
01833 
01834     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o16">NonPagedPoolUsage</a> = <a class="code" href="../../d4/d2/pool_8h.html#a23">EX_REAL_POOL_USAGE</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a460">CONTROL_AREA</a>) +
01835                                                         <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a465">SUBSECTION</a>) *
01836                                                         SubsectionsAllocated);
01837 
01838     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 0);
01839 
01840     Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(ControlArea + 1);
01841 
01842     NumberOfPtes = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (SizeOfImage);
01843 
01844     <span class="keywordflow">if</span> (NumberOfPtes == 0) {
01845         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ControlArea);
01846         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_IMAGE_FORMAT;
01847         <span class="keywordflow">goto</span> NeImage;
01848     }
01849 
01850 <span class="preprocessor">#if defined (_ALPHA_) || defined(_IA64_)</span>
01851 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (ImageAlignment &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> &amp;&amp; KeGetPreviousMode() != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> &amp;&amp;
01852        (FileHeader-&gt;Machine &lt; USER_SHARED_DATA-&gt;ImageNumberLow ||
01853         FileHeader-&gt;Machine &gt; USER_SHARED_DATA-&gt;ImageNumberHigh)) {
01854 
01855         InvalidAlignmentAllowed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;  
01856     }
01857     OrigNumberOfPtes = NumberOfPtes;
01858 <span class="preprocessor">#endif</span>
01859 <span class="preprocessor"></span>
01860     SizeOfSegment = <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/struct__SEGMENT.html">SEGMENT</a>) + (<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>) * (NumberOfPtes - 1)) +
01861                     <span class="keyword">sizeof</span>(SECTION_IMAGE_INFORMATION);
01862 
01863     NewSegment = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01864                                         SizeOfSegment,
01865                                         <a class="code" href="../../d0/d8/creasect_8c.html#a8">MMSECT</a>);
01866 
01867     <span class="keywordflow">if</span> (NewSegment == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01868 
01869         <span class="comment">//</span>
01870         <span class="comment">// The requested pool could not be allocated.</span>
01871         <span class="comment">//</span>
01872 
01873         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ControlArea);
01874         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
01875         <span class="keywordflow">goto</span> NeImage;
01876     }
01877     *Segment = NewSegment;
01878     RtlZeroMemory (NewSegment, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/struct__SEGMENT.html">SEGMENT</a>));
01879 
01880     <span class="comment">//</span>
01881     <span class="comment">// Align the prototype PTEs on the proper boundary.</span>
01882     <span class="comment">//</span>
01883 
01884     PointerPte = &amp;NewSegment-&gt;ThePtes[0];
01885     i = (ULONG) (((ULONG_PTR)PointerPte &gt;&gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>) &amp;
01886                     ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a47">MM_PROTO_PTE_ALIGNMENT</a> / <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) - 1));
01887 
01888     <span class="keywordflow">if</span> (i != 0) {
01889         i = (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a47">MM_PROTO_PTE_ALIGNMENT</a> / <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) - i;
01890     }
01891 
01892     NewSegment-&gt;PrototypePte = &amp;NewSegment-&gt;ThePtes[i];
01893 
01894     NewSegment-&gt;ControlArea = ControlArea;
01895     NewSegment-&gt;ImageInformation =
01896         (PSECTION_IMAGE_INFORMATION)((PCHAR)NewSegment + <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a455">SEGMENT</a>) +
01897                                        (<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>) * (NumberOfPtes - 1)));
01898     NewSegment-&gt;TotalNumberOfPtes = NumberOfPtes;
01899     NewSegment-&gt;NonExtendedPtes = NumberOfPtes;
01900     NewSegment-&gt;SizeOfSegment = (ULONG_PTR)NumberOfPtes * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01901 
01902     RtlZeroMemory (NewSegment-&gt;ImageInformation,
01903                    sizeof (SECTION_IMAGE_INFORMATION));
01904 
01905 
01906 <span class="comment">//</span>
01907 <span class="comment">// This code is built twice on the Win64 build - once for PE32+ and once for</span>
01908 <span class="comment">// PE32 images.</span>
01909 <span class="comment">//</span>
01910 <span class="preprocessor">#define INIT_IMAGE_INFORMATION(OptHdr) {                        \</span>
01911 <span class="preprocessor">    NewSegment-&gt;ImageInformation-&gt;TransferAddress =             \</span>
01912 <span class="preprocessor">                    (PVOID)((ULONG_PTR)((OptHdr).ImageBase) +   \</span>
01913 <span class="preprocessor">                            (OptHdr).AddressOfEntryPoint);      \</span>
01914 <span class="preprocessor">    NewSegment-&gt;ImageInformation-&gt;MaximumStackSize =            \</span>
01915 <span class="preprocessor">                            (OptHdr).SizeOfStackReserve;        \</span>
01916 <span class="preprocessor">    NewSegment-&gt;ImageInformation-&gt;CommittedStackSize =          \</span>
01917 <span class="preprocessor">                            (OptHdr).SizeOfStackCommit;         \</span>
01918 <span class="preprocessor">    NewSegment-&gt;ImageInformation-&gt;SubSystemType =               \</span>
01919 <span class="preprocessor">                            (OptHdr).Subsystem;                 \</span>
01920 <span class="preprocessor">    NewSegment-&gt;ImageInformation-&gt;SubSystemMajorVersion = (USHORT)((OptHdr).MajorSubsystemVersion); \</span>
01921 <span class="preprocessor">    NewSegment-&gt;ImageInformation-&gt;SubSystemMinorVersion = (USHORT)((OptHdr).MinorSubsystemVersion); \</span>
01922 <span class="preprocessor">    NewSegment-&gt;ImageInformation-&gt;DllCharacteristics =          \</span>
01923 <span class="preprocessor">                            (OptHdr).DllCharacteristics;        \</span>
01924 <span class="preprocessor">    NewSegment-&gt;ImageInformation-&gt;ImageContainsCode =           \</span>
01925 <span class="preprocessor">                            (BOOLEAN)(((OptHdr).SizeOfCode != 0) || \</span>
01926 <span class="preprocessor">                                      ((OptHdr).AddressOfEntryPoint != 0)); \</span>
01927 <span class="preprocessor">    }</span>
01928 <span class="preprocessor"></span>
01929 <span class="preprocessor">#if defined (_WIN64)</span>
01930 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (NtHeader) {
01931 <span class="preprocessor">#endif</span>
01932 <span class="preprocessor"></span>        <a class="code" href="../../d0/d8/creasect_8c.html#a4">INIT_IMAGE_INFORMATION</a>(NtHeader-&gt;OptionalHeader);
01933 <span class="preprocessor">#if defined (_WIN64)</span>
01934 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
01935         <span class="comment">// The image is 32-bit so use the 32-bit header</span>
01936         <a class="code" href="../../d0/d8/creasect_8c.html#a4">INIT_IMAGE_INFORMATION</a>(NtHeader32-&gt;OptionalHeader);
01937     }
01938 <span class="preprocessor">#endif</span>
01939 <span class="preprocessor"></span><span class="preprocessor">    #undef INIT_IMAGE_INFORMATION</span>
01940 <span class="preprocessor"></span>
01941     NewSegment-&gt;ImageInformation-&gt;ImageCharacteristics =
01942                             FileHeader-&gt;Characteristics;
01943     NewSegment-&gt;ImageInformation-&gt;Machine =
01944                             FileHeader-&gt;Machine;
01945 
01946     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a> = NewSegment;
01947     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o2">NumberOfSectionReferences</a> = 1;
01948     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o7">NumberOfUserReferences</a> = 1;
01949     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingCreated = 1;
01950     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o15">PagedPoolUsage</a> = <a class="code" href="../../d4/d2/pool_8h.html#a23">EX_REAL_POOL_USAGE</a>((<span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a455">SEGMENT</a>) + (NumberOfPtes * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>))));
01951 
01952     <span class="keywordflow">if</span> (ImageAlignment &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) {
01953 
01954         <span class="comment">//</span>
01955         <span class="comment">// Image alignment is less than a page, the number</span>
01956         <span class="comment">// of subsections is 1.</span>
01957         <span class="comment">//</span>
01958 
01959         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o5">NumberOfSubsections</a> = 1;
01960     } <span class="keywordflow">else</span> {
01961         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o5">NumberOfSubsections</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)NumberOfSubsections;
01962     }
01963 
01964     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Image = 1;
01965     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.File = 1;
01966 
01967     <span class="keywordflow">if</span> ((FILE_FLOPPY_DISKETTE &amp; <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;DeviceObject-&gt;Characteristics) ||
01968         ((FileHeader-&gt;Characteristics &amp;
01969                 IMAGE_FILE_REMOVABLE_RUN_FROM_SWAP) &amp;&amp;
01970          (FILE_REMOVABLE_MEDIA &amp; <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;DeviceObject-&gt;Characteristics)) ||
01971         ((FileHeader-&gt;Characteristics &amp;
01972                 IMAGE_FILE_NET_RUN_FROM_SWAP) &amp;&amp;
01973          (FILE_REMOTE_DEVICE &amp; <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;DeviceObject-&gt;Characteristics))) {
01974 
01975         <span class="comment">//</span>
01976         <span class="comment">// This file resides on a floppy disk or a removable media or</span>
01977         <span class="comment">// network with flags set indicating it should be copied</span>
01978         <span class="comment">// to the paging file.</span>
01979         <span class="comment">//</span>
01980 
01981         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.FloppyMedia = 1;
01982     }
01983 
01984     <span class="keywordflow">if</span> (FILE_REMOTE_DEVICE &amp; <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;DeviceObject-&gt;Characteristics) {
01985 
01986         <span class="comment">//</span>
01987         <span class="comment">// This file resides on a redirected drive.</span>
01988         <span class="comment">//</span>
01989 
01990         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Networked = 1;
01991     }
01992 
01993     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a> = <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>;
01994 
01995     <span class="comment">//</span>
01996     <span class="comment">// Build the subsection and prototype PTEs for the image header.</span>
01997     <span class="comment">//</span>
01998 
01999     Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a> = ControlArea;
02000 <span class="preprocessor">#if defined(_WIN64)</span>
02001 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (NtHeader) {
02002 <span class="preprocessor">#endif</span>
02003 <span class="preprocessor"></span>        NextVa = NtHeader-&gt;OptionalHeader.ImageBase;
02004 <span class="preprocessor">#if defined(_WIN64)</span>
02005 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
02006         NextVa = NtHeader32-&gt;OptionalHeader.ImageBase;
02007     }
02008 <span class="preprocessor">#endif</span>
02009 <span class="preprocessor"></span>
02010 
02011     <span class="keywordflow">if</span> ((NextVa &amp; (<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a> - 1)) != 0) {
02012 
02013         <span class="comment">//</span>
02014         <span class="comment">// Image header is not aligned on a 64k boundary.</span>
02015         <span class="comment">//</span>
02016 
02017         <span class="keywordflow">goto</span> BadPeImageSegment;
02018     }
02019 
02020     NewSegment-&gt;BasedAddress = (PVOID)NextVa;
02021 <span class="preprocessor">#if defined(_WIN64)</span>
02022 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (NtHeader) {
02023 <span class="preprocessor">#endif</span>
02024 <span class="preprocessor"></span>        SizeOfHeaders = NtHeader-&gt;OptionalHeader.SizeOfHeaders;
02025 <span class="preprocessor">#if defined(_WIN64)</span>
02026 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
02027         SizeOfHeaders = NtHeader32-&gt;OptionalHeader.SizeOfHeaders;
02028     }
02029 <span class="preprocessor">#endif</span>
02030 <span class="preprocessor"></span>
02031     <span class="keywordflow">if</span> (SizeOfHeaders &gt;= SizeOfImage) {
02032         <span class="keywordflow">goto</span> BadPeImageSegment;
02033     }
02034 
02035     Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> = <a class="code" href="../../d4/d8/mi_8h.html#a90">MI_ROUND_TO_SIZE</a> (
02036                                        SizeOfHeaders,
02037                                        ImageAlignment
02038                                    ) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
02039 
02040     PointerPte = NewSegment-&gt;PrototypePte;
02041     Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a> = PointerPte;
02042 
02043     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a149">MiGetSubsectionAddressForPte</a> (Subsection);
02044     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype = 1;
02045 
02046     NewSegment-&gt;SegmentPteTemplate = TempPte;
02047     <a class="code" href="../../d3/d8/udfprocs_8h.html#a43">SectorOffset</a> = 0;
02048 
02049     <span class="keywordflow">if</span> (ImageAlignment &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) {
02050 
02051         <span class="comment">//</span>
02052         <span class="comment">// Aligned on less than a page size boundary.</span>
02053         <span class="comment">// Build a single subsection to refer to the image.</span>
02054         <span class="comment">//</span>
02055 
02056         PointerPte = NewSegment-&gt;PrototypePte;
02057 
02058         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> = NumberOfPtes;
02059 
02060         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o5">NumberOfFullSectors</a> =
02061                             (ULONG)(EndOfFile.QuadPart &gt;&gt; <a class="code" href="../../d4/d8/mi_8h.html#a27">MMSECTOR_SHIFT</a>);
02062 
02063         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((ULONG)(EndOfFile.HighPart &amp; 0xFFFFF000) == 0);
02064 
02065         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.SectorEndOffset =
02066                               EndOfFile.LowPart &amp; <a class="code" href="../../d4/d8/mi_8h.html#a28">MMSECTOR_MASK</a>;
02067 
02068         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a42">MM_EXECUTE_WRITECOPY</a>;
02069 
02070         <span class="comment">//</span>
02071         <span class="comment">// Set all the PTEs to the execute-read-write protection.</span>
02072         <span class="comment">// The section will control access to these and the segment</span>
02073         <span class="comment">// must provide a method to allow other users to map the file</span>
02074         <span class="comment">// for various protections.</span>
02075         <span class="comment">//</span>
02076 
02077         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a42">MM_EXECUTE_WRITECOPY</a>;
02078 
02079         NewSegment-&gt;SegmentPteTemplate = TempPte;
02080 
02081 
02082 <span class="preprocessor">#if defined (_ALPHA_) || defined(_IA64_)</span>
02083 <span class="preprocessor"></span>        <span class="comment">//</span>
02084         <span class="comment">// Invalid image alignments are supported for cross platform</span>
02085         <span class="comment">// emulation. Only alpha and IA64 require extra handling because page</span>
02086         <span class="comment">// size is larger than x86.</span>
02087         <span class="comment">//</span>
02088 
02089 
02090         <span class="keywordflow">if</span> (InvalidAlignmentAllowed) {
02091 
02092             TempPteDemandZero.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = 0;
02093             TempPteDemandZero.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a42">MM_EXECUTE_WRITECOPY</a>;
02094             <a class="code" href="../../d3/d8/udfprocs_8h.html#a43">SectorOffset</a> = 0;
02095 
02096             <span class="keywordflow">for</span> (i = 0; i &lt; NumberOfPtes; i += 1) {
02097 
02098                 <span class="comment">//</span>
02099                 <span class="comment">// Set prototype PTEs.</span>
02100                 <span class="comment">//</span>
02101 
02102                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a43">SectorOffset</a> &lt; EndOfFile.LowPart) {
02103 
02104                     <span class="comment">//</span>
02105                     <span class="comment">// Data resides on the disk, refer to the control section.</span>
02106                     <span class="comment">//</span>
02107 
02108                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, TempPte);
02109 
02110                 } <span class="keywordflow">else</span> {
02111 
02112                     <span class="comment">//</span>
02113                     <span class="comment">// Data does not reside on the disk, use Demand zero pages.</span>
02114                     <span class="comment">//</span>
02115 
02116                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, TempPteDemandZero);
02117                 }
02118 
02119                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a43">SectorOffset</a> += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02120                 PointerPte += 1;
02121             }
02122 
02123         } <span class="keywordflow">else</span>
02124 <span class="preprocessor">#endif</span>
02125 <span class="preprocessor"></span>           {
02126 
02127             <span class="keywordflow">for</span> (i = 0; i &lt; NumberOfPtes; i += 1) {
02128 
02129                 <span class="comment">//</span>
02130                 <span class="comment">// Set all the prototype PTEs to refer to the control section.</span>
02131                 <span class="comment">//</span>
02132 
02133                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, TempPte);
02134                 PointerPte += 1;
02135             }
02136         }
02137 
02138         NewSegment-&gt;ImageCommitment = NumberOfPtes;
02139 
02140 
02141         <span class="comment">//</span>
02142         <span class="comment">// Indicate alignment is less than a page.</span>
02143         <span class="comment">//</span>
02144 
02145         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = 0;
02146 
02147     } <span class="keywordflow">else</span> {
02148 
02149         <span class="comment">//</span>
02150         <span class="comment">// Alignment is PAGE_SIZE or greater.</span>
02151         <span class="comment">//</span>
02152 
02153         <span class="keywordflow">if</span> (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> &gt; NumberOfPtes) {
02154 
02155             <span class="comment">//</span>
02156             <span class="comment">// Inconsistent image, size does not agree with header.</span>
02157             <span class="comment">//</span>
02158 
02159             <span class="keywordflow">goto</span> BadPeImageSegment;
02160         }
02161         NumberOfPtes -= Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>;
02162 
02163         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o5">NumberOfFullSectors</a> =
02164             SizeOfHeaders &gt;&gt; <a class="code" href="../../d4/d8/mi_8h.html#a27">MMSECTOR_SHIFT</a>;
02165 
02166         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.SectorEndOffset =
02167             SizeOfHeaders &amp; <a class="code" href="../../d4/d8/mi_8h.html#a28">MMSECTOR_MASK</a>;
02168 
02169         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.ReadOnly = 1;
02170         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.CopyOnWrite = 1;
02171         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a36">MM_READONLY</a>;
02172 
02173         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a36">MM_READONLY</a>;
02174         NewSegment-&gt;SegmentPteTemplate = TempPte;
02175 
02176         <span class="keywordflow">for</span> (i = 0; i &lt; Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>; i += 1) {
02177 
02178             <span class="comment">//</span>
02179             <span class="comment">// Set all the prototype PTEs to refer to the control section.</span>
02180             <span class="comment">//</span>
02181 
02182             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a43">SectorOffset</a> &lt; SizeOfHeaders) {
02183                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, TempPte);
02184             } <span class="keywordflow">else</span> {
02185                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>);
02186             }
02187             <a class="code" href="../../d3/d8/udfprocs_8h.html#a43">SectorOffset</a> += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02188             PointerPte += 1;
02189             NextVa += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02190         }
02191     }
02192 
02193     <span class="comment">//</span>
02194     <span class="comment">// Build the next subsections.</span>
02195     <span class="comment">//</span>
02196 
02197 <span class="preprocessor">#if defined(_WIN64)</span>
02198 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (NtHeader) {
02199 <span class="preprocessor">#endif</span>
02200 <span class="preprocessor"></span>        PreferredImageBase = NtHeader-&gt;OptionalHeader.ImageBase;
02201 <span class="preprocessor">#if defined(_WIN64)</span>
02202 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
02203         PreferredImageBase = NtHeader32-&gt;OptionalHeader.ImageBase;
02204     }
02205 <span class="preprocessor">#endif</span>
02206 <span class="preprocessor"></span>
02207     <span class="comment">//</span>
02208     <span class="comment">// At this point the object table is read in (if it was not</span>
02209     <span class="comment">// already read in) and may displace the image header.</span>
02210     <span class="comment">//</span>
02211 
02212     SectionTableEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02213     OffsetToSectionTable = <span class="keyword">sizeof</span>(ULONG) +
02214                               <span class="keyword">sizeof</span>(IMAGE_FILE_HEADER) +
02215                               FileHeader-&gt;SizeOfOptionalHeader;
02216 
02217     <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(NtHeader) + OffsetToSectionTable +
02218 <span class="preprocessor">#if defined (_WIN64)</span>
02219 <span class="preprocessor"></span>                <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(NtHeader32) +
02220 <span class="preprocessor">#endif</span>
02221 <span class="preprocessor"></span>                ((NumberOfSubsections + 1) *
02222                 <span class="keyword">sizeof</span> (IMAGE_SECTION_HEADER))) &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) {
02223 
02224         <span class="comment">//</span>
02225         <span class="comment">// Section tables are within the header which was read.</span>
02226         <span class="comment">//</span>
02227 
02228 <span class="preprocessor">#if defined(_WIN64)</span>
02229 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (NtHeader32) {
02230             SectionTableEntry = (PIMAGE_SECTION_HEADER)((PCHAR)NtHeader32 +
02231                                     OffsetToSectionTable);
02232         } <span class="keywordflow">else</span>
02233 <span class="preprocessor">#endif</span>
02234 <span class="preprocessor"></span>        {
02235             SectionTableEntry = (PIMAGE_SECTION_HEADER)((PCHAR)NtHeader +
02236                                     OffsetToSectionTable);
02237         }
02238 
02239     } <span class="keywordflow">else</span> {
02240 
02241         <span class="comment">//</span>
02242         <span class="comment">// Has an extended header been read in and are the object</span>
02243         <span class="comment">// tables resident?</span>
02244         <span class="comment">//</span>
02245 
02246         <span class="keywordflow">if</span> (ExtendedHeader != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02247 
02248 <span class="preprocessor">#if defined(_WIN64)</span>
02249 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (NtHeader32) {
02250                 SectionTableEntry = (PIMAGE_SECTION_HEADER)((PCHAR)NtHeader32 +
02251                                         OffsetToSectionTable);
02252             } <span class="keywordflow">else</span>
02253 <span class="preprocessor">#endif</span>
02254 <span class="preprocessor"></span>            {
02255                 SectionTableEntry = (PIMAGE_SECTION_HEADER)((PCHAR)NtHeader +
02256                                         OffsetToSectionTable);
02257             }
02258 
02259             <span class="comment">//</span>
02260             <span class="comment">// Is the whole range of object tables mapped by the</span>
02261             <span class="comment">// extended header?</span>
02262             <span class="comment">//</span>
02263 
02264             <span class="keywordflow">if</span> ((((PCHAR)SectionTableEntry +
02265                  ((NumberOfSubsections + 1) *
02266                     <span class="keyword">sizeof</span> (IMAGE_SECTION_HEADER))) -
02267                          (PCHAR)ExtendedHeader) &gt;
02268                                             <a class="code" href="../../d0/d8/creasect_8c.html#a1">MM_MAXIMUM_IMAGE_HEADER</a>) {
02269                 SectionTableEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02270 
02271             }
02272         }
02273     }
02274 
02275     <span class="keywordflow">if</span> (SectionTableEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02276 
02277         <span class="comment">//</span>
02278         <span class="comment">// The section table entries are not in the same</span>
02279         <span class="comment">// pages as the other data already read in.  Read in</span>
02280         <span class="comment">// the object table entries.</span>
02281         <span class="comment">//</span>
02282 
02283         <span class="keywordflow">if</span> (ExtendedHeader == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02284             ExtendedHeader = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
02285                                                     <a class="code" href="../../d0/d8/creasect_8c.html#a1">MM_MAXIMUM_IMAGE_HEADER</a>,
02286                                                     <a class="code" href="../../d0/d8/creasect_8c.html#a7">MMTEMPORARY</a>);
02287             <span class="keywordflow">if</span> (ExtendedHeader == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02288                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (NewSegment);
02289                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ControlArea);
02290                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
02291                 <span class="keywordflow">goto</span> NeImage;
02292             }
02293 
02294             <span class="comment">//</span>
02295             <span class="comment">// Build an MDL for the operation.</span>
02296             <span class="comment">//</span>
02297 
02298             <a class="code" href="../../d5/d6/iosup_8c.html#a73">MmCreateMdl</a>( Mdl, ExtendedHeader, <a class="code" href="../../d0/d8/creasect_8c.html#a1">MM_MAXIMUM_IMAGE_HEADER</a>);
02299 
02300             <a class="code" href="../../d5/d6/iosup_8c.html#a46">MmBuildMdlForNonPagedPool</a> (Mdl);
02301         }
02302 
02303         StartingOffset.LowPart = PtrToUlong(<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (
02304                                     (ULONG)DosHeader-&gt;e_lfanew +
02305                                     OffsetToSectionTable));
02306 
02307         SectionTableEntry = (PIMAGE_SECTION_HEADER)((PCHAR)ExtendedHeader +
02308                                 <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>((ULONG)DosHeader-&gt;e_lfanew +
02309                                 OffsetToSectionTable));
02310 
02311         <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (InPageEvent);
02312         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a89">IoPageRead</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>,
02313                              Mdl,
02314                              &amp;StartingOffset,
02315                              InPageEvent,
02316                              &amp;IoStatus
02317                             );
02318 
02319         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
02320             <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( InPageEvent,
02321                                    <a class="code" href="../../d4/d9/ke_8h.html#a407a207">WrPageIn</a>,
02322                                    <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
02323                                    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
02324                                    (PLARGE_INTEGER)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02325         }
02326 
02327         <span class="keywordflow">if</span> (Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a12">MDL_MAPPED_TO_SYSTEM_VA</a>) {
02328             <a class="code" href="../../d5/d6/iosup_8c.html#a56">MmUnmapLockedPages</a> (Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o4">MappedSystemVa</a>, Mdl);
02329         }
02330 
02331         <span class="keywordflow">if</span> ((!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) || (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IoStatus.Status))) {
02332             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_FILE_LOCK_CONFLICT) {
02333                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_FILE_FOR_SECTION;
02334             }
02335             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (NewSegment);
02336             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ControlArea);
02337             <span class="keywordflow">goto</span> NeImage;
02338         }
02339 
02340         <span class="comment">//</span>
02341         <span class="comment">// From this point on NtHeader is only valid if it</span>
02342         <span class="comment">// was in the first 4k of the image, otherwise reading in</span>
02343         <span class="comment">// the object tables wiped it out.</span>
02344         <span class="comment">//</span>
02345 
02346     }
02347 
02348     <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0
02349 <span class="preprocessor">#if defined (_ALPHA_) || defined(_IA64_)</span>
02350 <span class="preprocessor"></span>        &amp;&amp; (!InvalidAlignmentAllowed)
02351 <span class="preprocessor">#endif</span>
02352 <span class="preprocessor"></span>       ) {
02353 
02354         <span class="comment">// The image header is no longer valid, TempPte is</span>
02355         <span class="comment">// used to indicate that this image alignment is</span>
02356         <span class="comment">// less than a PAGE_SIZE.</span>
02357 
02358         <span class="comment">//</span>
02359         <span class="comment">// Loop through all sections and make sure there is no</span>
02360         <span class="comment">// uninitialized data.</span>
02361         <span class="comment">//</span>
02362 
02363         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02364 
02365         <span class="keywordflow">while</span> (NumberOfSubsections &gt; 0) {
02366             <span class="keywordflow">if</span> (SectionTableEntry-&gt;Misc.VirtualSize == 0) {
02367                 SectionVirtualSize = SectionTableEntry-&gt;SizeOfRawData;
02368             } <span class="keywordflow">else</span> {
02369                 SectionVirtualSize = SectionTableEntry-&gt;Misc.VirtualSize;
02370             }
02371 
02372             <span class="comment">//</span>
02373             <span class="comment">// If the raw pointer + raw size overflows a long word, return an error.</span>
02374             <span class="comment">//</span>
02375 
02376             <span class="keywordflow">if</span> (SectionTableEntry-&gt;PointerToRawData +
02377                         SectionTableEntry-&gt;SizeOfRawData &lt;
02378                 SectionTableEntry-&gt;PointerToRawData) {
02379 
02380                 KdPrint((<span class="stringliteral">"MMCREASECT: invalid section/file size %Z\n"</span>,
02381                     &amp;<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;FileName));
02382 
02383                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_IMAGE_FORMAT;
02384                 <span class="keywordflow">break</span>;
02385             }
02386 
02387             <span class="comment">//</span>
02388             <span class="comment">// If the virtual size and address does not match the rawdata</span>
02389             <span class="comment">// and invalid alignments not allowed return an error.</span>
02390             <span class="comment">//</span>
02391 
02392             <span class="keywordflow">if</span> (((SectionTableEntry-&gt;PointerToRawData !=
02393                   SectionTableEntry-&gt;VirtualAddress))
02394                             ||
02395                    (SectionVirtualSize &gt; SectionTableEntry-&gt;SizeOfRawData)) {
02396 
02397                 KdPrint((<span class="stringliteral">"MMCREASECT: invalid BSS/Trailingzero %Z\n"</span>,
02398                         &amp;<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;FileName));
02399 
02400                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_IMAGE_FORMAT;
02401                 <span class="keywordflow">break</span>;
02402             }
02403 
02404 
02405             SectionTableEntry += 1;
02406             NumberOfSubsections -= 1;
02407         }
02408 
02409 
02410         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02411             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (NewSegment);
02412             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ControlArea);
02413             <span class="keywordflow">goto</span> NeImage;
02414         }
02415 
02416         <span class="keywordflow">goto</span> PeReturnSuccess;
02417 
02418     }
02419 <span class="preprocessor">#if defined (_ALPHA_) || defined(_IA64_)</span>
02420 <span class="preprocessor"></span>
02421     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0 &amp;&amp; InvalidAlignmentAllowed) {
02422 
02423         TempNumberOfSubsections = NumberOfSubsections;
02424         TempSectionTableEntry = SectionTableEntry;
02425         
02426         <span class="comment">//</span>
02427         <span class="comment">// The image header is no longer valid, TempPte is</span>
02428         <span class="comment">// used to indicate that this image alignment is</span>
02429         <span class="comment">// less than a PAGE_SIZE.</span>
02430         <span class="comment">//</span>
02431 
02432         <span class="comment">//</span>
02433         <span class="comment">// Loop through all sections and make sure there is no</span>
02434         <span class="comment">// uninitialized data.</span>
02435         <span class="comment">//</span>
02436         <span class="comment">// Also determine if there are shared data sections and</span>
02437         <span class="comment">// the number of extra ptes they require.</span>
02438         <span class="comment">//</span>
02439 
02440         AdditionalSubsections = 0;
02441         AdditionalPtes = 0;
02442         AdditionalBasePtes = 0;
02443         RoundingAlignment = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02444 
02445         <span class="keywordflow">while</span> (TempNumberOfSubsections &gt; 0) {
02446             ULONG EndOfSection;
02447             ULONG ExtraPages;
02448 
02449             <span class="keywordflow">if</span> (TempSectionTableEntry-&gt;Misc.VirtualSize == 0) {
02450                 SectionVirtualSize = TempSectionTableEntry-&gt;SizeOfRawData;
02451             } <span class="keywordflow">else</span> {
02452                 SectionVirtualSize = TempSectionTableEntry-&gt;Misc.VirtualSize;
02453             }
02454 
02455             EndOfSection = TempSectionTableEntry-&gt;PointerToRawData +
02456                            TempSectionTableEntry-&gt;SizeOfRawData;
02457             
02458             <span class="comment">//</span>
02459             <span class="comment">// If the raw pointer + raw size overflows a long word, return an error.</span>
02460             <span class="comment">//</span>
02461 
02462             <span class="keywordflow">if</span> (EndOfSection &lt; TempSectionTableEntry-&gt;PointerToRawData) {
02463 
02464                  KdPrint((<span class="stringliteral">"MMCREASECT: invalid section/file size %Z\n"</span>,
02465                       &amp;<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;FileName));
02466 
02467                  <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_IMAGE_FORMAT;
02468 
02469                  <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (NewSegment);
02470                  <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ControlArea);
02471                  <span class="keywordflow">goto</span> NeImage;
02472             }
02473 
02474             <span class="comment">//</span>
02475             <span class="comment">// If the section goes past SizeOfImage then allocate additional PTEs.</span>
02476             <span class="comment">// On x86 this is handled by the subsection mapping. On alpha this is handled</span>
02477             <span class="comment">// by the Wx86 loader extension after the image has been mapped in. But the</span>
02478             <span class="comment">// additional data must be in memory so it can be shuffled around later.</span>
02479             <span class="comment">//</span>
02480 
02481             <span class="keywordflow">if</span> ((EndOfSection &lt;= EndOfFile.LowPart) &amp;&amp;
02482                 (EndOfSection &gt; SizeOfImage)) {
02483 
02484                 <span class="comment">//</span>
02485                 <span class="comment">// Allocate enough PTEs to cover the end of this section.</span>
02486                 <span class="comment">// Maximize with any other sections that extend beyond SizeOfImage</span>
02487                 <span class="comment">//</span>
02488 
02489                 ExtraPages = <a class="code" href="../../d4/d8/mi_8h.html#a90">MI_ROUND_TO_SIZE</a> (EndOfSection - SizeOfImage, RoundingAlignment) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
02490                 <span class="keywordflow">if</span> (ExtraPages &gt; AdditionalBasePtes) {
02491                     AdditionalBasePtes = ExtraPages;
02492                 }
02493             }
02494 
02495             <span class="comment">// Count number of shared data sections and additional ptes needed</span>
02496 
02497             <span class="keywordflow">if</span> ((TempSectionTableEntry-&gt;Characteristics &amp; IMAGE_SCN_MEM_SHARED) &amp;&amp;
02498                 (!(TempSectionTableEntry-&gt;Characteristics &amp; IMAGE_SCN_MEM_EXECUTE) ||
02499                  (TempSectionTableEntry-&gt;Characteristics &amp; IMAGE_SCN_MEM_WRITE))) {
02500                 AdditionalPtes += 
02501                     <a class="code" href="../../d4/d8/mi_8h.html#a90">MI_ROUND_TO_SIZE</a> (SectionVirtualSize, RoundingAlignment) &gt;&gt;
02502                                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
02503                 AdditionalSubsections += 1;
02504             }
02505 
02506             TempSectionTableEntry += 1;
02507             TempNumberOfSubsections -= 1;
02508         }
02509 
02510         <span class="keywordflow">if</span> (AdditionalBasePtes == 0 &amp;&amp; (AdditionalSubsections == 0 || AdditionalPtes == 0)) {
02511             <span class="comment">// no shared data sections</span>
02512             <span class="keywordflow">goto</span> PeReturnSuccess;
02513         }
02514 
02515         <span class="comment">//</span>
02516         <span class="comment">// There are additional Base PTEs or shared data sections.</span>
02517         <span class="comment">// For shared sections, allocate new PTEs for these sections</span>
02518         <span class="comment">// at the end of the image. The WX86 loader will change</span>
02519         <span class="comment">// fixups to point to the new pages.</span>
02520         <span class="comment">//</span>
02521         <span class="comment">// First reallocate the control area.</span>
02522         <span class="comment">//</span>
02523 
02524         NewSubsectionsAllocated = SubsectionsAllocated +
02525                                                 AdditionalSubsections;
02526 
02527         NewControlArea = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
02528                                     (ULONG) (<span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a460">CONTROL_AREA</a>) +
02529                                             (<span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a465">SUBSECTION</a>) *
02530                                                 NewSubsectionsAllocated)),
02531                                                 'iCmM');
02532         <span class="keywordflow">if</span> (NewControlArea == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02533             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (NewSegment);
02534             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ControlArea);
02535             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
02536             <span class="keywordflow">goto</span> NeImage;
02537         }
02538 
02539         <span class="comment">//</span>
02540         <span class="comment">// Copy the old control area to the new one, modify some fields.</span>
02541         <span class="comment">//</span>
02542 
02543         RtlMoveMemory (NewControlArea, ControlArea,
02544                         <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a460">CONTROL_AREA</a>) +
02545                             <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a465">SUBSECTION</a>) * SubsectionsAllocated);
02546 
02547         NewControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o16">NonPagedPoolUsage</a> = 
02548                         <a class="code" href="../../d4/d2/pool_8h.html#a23">EX_REAL_POOL_USAGE</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a460">CONTROL_AREA</a>) +
02549                                             (<span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a465">SUBSECTION</a>) *
02550                                                 NewSubsectionsAllocated));
02551 
02552         NewControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o5">NumberOfSubsections</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) NewSubsectionsAllocated;
02553 
02554         <span class="comment">//</span>
02555         <span class="comment">// Now allocate a new segment that has the newly calculated number</span>
02556         <span class="comment">// of PTEs, initialize it from the previously allocated new segment,</span>
02557         <span class="comment">// and overwrite the fields that should be changed.</span>
02558         <span class="comment">//</span>
02559 
02560         OldSegment = NewSegment;
02561 
02562         
02563         OrigNumberOfPtes += AdditionalBasePtes;
02564 
02565         SizeOfSegment = <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a455">SEGMENT</a>) + 
02566                      (<span class="keyword">sizeof</span>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a213">MMPTE</a>) * (OrigNumberOfPtes + AdditionalPtes - 1)) +
02567                         <span class="keyword">sizeof</span>(SECTION_IMAGE_INFORMATION);
02568 
02569         NewSegment = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
02570                                             SizeOfSegment,
02571                                             <a class="code" href="../../d0/d8/creasect_8c.html#a8">MMSECT</a>);
02572 
02573         <span class="keywordflow">if</span> (NewSegment == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02574 
02575             <span class="comment">//</span>
02576             <span class="comment">// The requested pool could not be allocated.</span>
02577             <span class="comment">//</span>
02578 
02579             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ControlArea);
02580             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (NewControlArea);
02581             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (OldSegment);
02582             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
02583             <span class="keywordflow">goto</span> NeImage;
02584         }
02585 
02586         *Segment = NewSegment;
02587         RtlMoveMemory (NewSegment, OldSegment, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a455">SEGMENT</a>));
02588 
02589         <span class="comment">//</span>
02590         <span class="comment">// Align the prototype PTEs on the proper boundary.</span>
02591         <span class="comment">//</span>
02592 
02593         NewPointerPte = &amp;NewSegment-&gt;ThePtes[0];
02594         i = (ULONG) (((ULONG_PTR)NewPointerPte &gt;&gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>) &amp;
02595                         ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a47">MM_PROTO_PTE_ALIGNMENT</a> / <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) - 1));
02596 
02597         <span class="keywordflow">if</span> (i != 0) {
02598             i = (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a47">MM_PROTO_PTE_ALIGNMENT</a> / <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) - i;
02599         }
02600 
02601         NewSegment-&gt;PrototypePte = &amp;NewSegment-&gt;ThePtes[i];
02602         <span class="keywordflow">if</span> (i != 0) {
02603             RtlZeroMemory (&amp;NewSegment-&gt;ThePtes[0], <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a213">MMPTE</a>) * i);
02604         }
02605         PointerPte = NewSegment-&gt;PrototypePte + 
02606                                        (PointerPte - OldSegment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o12">PrototypePte</a>);
02607 
02608         NewSegment-&gt;ControlArea = NewControlArea;
02609         NewSegment-&gt;ImageInformation =
02610             (PSECTION_IMAGE_INFORMATION)((PCHAR)NewSegment + <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a455">SEGMENT</a>) +
02611                      (<span class="keyword">sizeof</span>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a213">MMPTE</a>) * (OrigNumberOfPtes + AdditionalPtes - 1)));
02612         NewSegment-&gt;TotalNumberOfPtes = OrigNumberOfPtes + AdditionalPtes;
02613         NewSegment-&gt;NonExtendedPtes = OrigNumberOfPtes + AdditionalPtes;
02614         NewSegment-&gt;SizeOfSegment = (ULONG_PTR)(OrigNumberOfPtes + AdditionalPtes) * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02615 
02616         RtlMoveMemory (NewSegment-&gt;ImageInformation,
02617                        OldSegment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o6">ImageInformation</a>,
02618                        sizeof (SECTION_IMAGE_INFORMATION));
02619 
02620         <span class="comment">//</span>
02621         <span class="comment">// Now change the fields in the subsections to account for the new</span>
02622         <span class="comment">// control area and the new segment. Also change the PTEs in the </span>
02623         <span class="comment">// newly allocated segment to point to the new subsections.</span>
02624         <span class="comment">//</span>
02625 
02626         NewControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a> = NewSegment;
02627         NewControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o15">PagedPoolUsage</a> = <a class="code" href="../../d4/d2/pool_8h.html#a23">EX_REAL_POOL_USAGE</a>((<span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a455">SEGMENT</a>) +
02628                         ((OrigNumberOfPtes + AdditionalPtes) * <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a213">MMPTE</a>))));
02629 
02630         Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(ControlArea + 1);
02631         NewSubsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(NewControlArea + 1);
02632         NewSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> += AdditionalBasePtes;
02633         
02634         <span class="keywordflow">for</span> (i = 0; i &lt; SubsectionsAllocated; i += 1) {
02635 
02636             <span class="comment">//</span>
02637             <span class="comment">// Note: SubsectionsAllocated is always 1 (for wx86), so this loop </span>
02638             <span class="comment">// is executed only once.</span>
02639             <span class="comment">//</span>
02640 
02641             NewSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a> = (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>) NewControlArea;
02642             
02643             NewSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a> = NewSegment-&gt;PrototypePte + 
02644                     (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a> - OldSegment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o12">PrototypePte</a>);
02645 
02646             NewPointerPte = NewSegment-&gt;PrototypePte;
02647             OldPointerPte = OldSegment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o12">PrototypePte</a>;
02648 
02649             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a149">MiGetSubsectionAddressForPte</a> (NewSubsection);
02650             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype = 1;
02651 
02652             <span class="keywordflow">for</span> (j = 0; j &lt; OldSegment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o2">TotalNumberOfPtes</a>+AdditionalBasePtes; j += 1) {
02653                 
02654                 <span class="keywordflow">if</span> ((OldPointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1) &amp;&amp;
02655                     (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a148">MiGetSubsectionAddress</a> (OldPointerPte) == Subsection)) {
02656                     OriginalProtection = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a184">MI_GET_PROTECTION_FROM_SOFT_PTE</a> (OldPointerPte);
02657                     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = OriginalProtection;
02658                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (NewPointerPte, TempPte);
02659                 }
02660                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i == 0) {
02661 
02662                     <span class="comment">//</span>
02663                     <span class="comment">// Since the outer for loop is executed only once, there </span>
02664                     <span class="comment">// is no need for the i == 0 above, but it is safer to</span>
02665                     <span class="comment">// have it. If the code changes later and other sections</span>
02666                     <span class="comment">// are added, their PTEs will get initialized here as</span>
02667                     <span class="comment">// DemandZero and if they are not DemandZero, they will be</span>
02668                     <span class="comment">// overwritten in a later iteration of the outer loop. </span>
02669                     <span class="comment">// For now, this else if clause will be executed only </span>
02670                     <span class="comment">// for DemandZero PTEs.</span>
02671                     <span class="comment">//</span>
02672 
02673                     OriginalProtection = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a184">MI_GET_PROTECTION_FROM_SOFT_PTE</a> (OldPointerPte);
02674                     TempPteDemandZero.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = 0;
02675                     TempPteDemandZero.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = OriginalProtection;
02676                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (NewPointerPte, TempPteDemandZero);
02677                 }
02678 
02679                 NewPointerPte += 1;
02680                 <span class="comment">// Stop incrementing the OldPointerPte at the last entry and use it</span>
02681                 <span class="comment">// for the additional Base PTEs</span>
02682                 <span class="keywordflow">if</span> (j &lt; OldSegment-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o2">TotalNumberOfPtes</a>-1) {
02683                     OldPointerPte += 1;
02684                 }
02685             }
02686 
02687             Subsection += 1;
02688             NewSubsection += 1;
02689         }
02690 
02691 
02692         RtlZeroMemory (NewSubsection,
02693                             <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a465">SUBSECTION</a>) * AdditionalSubsections);
02694 
02695         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (OldSegment);
02696         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ControlArea);
02697         ControlArea = (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>) NewControlArea;
02698 
02699         <span class="comment">//</span>
02700         <span class="comment">// Adjust some variables that are used below.</span>
02701         <span class="comment">// PointerPte has already been set above before OldSegment was freed.</span>
02702         <span class="comment">//</span>
02703 
02704         SubsectionsAllocated = NewSubsectionsAllocated;
02705         Subsection = NewSubsection - 1; <span class="comment">// Points to last used subsection.</span>
02706         NumberOfPtes = AdditionalPtes;  <span class="comment">// # PTEs that haven't yet been used in </span>
02707                                         <span class="comment">// previous subsections.</span>
02708         
02709         <span class="comment">// Additional Base PTEs have been added. Only continue if there are</span>
02710         <span class="comment">// additional subsections to process</span>
02711         <span class="keywordflow">if</span> (AdditionalSubsections == 0 || AdditionalPtes == 0) {
02712             <span class="comment">// no shared data sections</span>
02713             <span class="keywordflow">goto</span> PeReturnSuccess;
02714         }
02715     }
02716 <span class="preprocessor">#endif</span>
02717 <span class="preprocessor"></span>
02718     <span class="keywordflow">while</span> (NumberOfSubsections &gt; 0) {
02719 
02720 <span class="preprocessor">#if defined (_ALPHA_) || defined(_IA64_)</span>
02721 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!InvalidAlignmentAllowed || 
02722             ((SectionTableEntry-&gt;Characteristics &amp; IMAGE_SCN_MEM_SHARED) &amp;&amp;
02723              (!(SectionTableEntry-&gt;Characteristics &amp; IMAGE_SCN_MEM_EXECUTE) ||
02724               (SectionTableEntry-&gt;Characteristics &amp; IMAGE_SCN_MEM_WRITE)))) {
02725 <span class="preprocessor">#endif</span>
02726 <span class="preprocessor"></span>
02727         <span class="comment">//</span>
02728         <span class="comment">// Handle case where virtual size is 0.</span>
02729         <span class="comment">//</span>
02730 
02731         <span class="keywordflow">if</span> (SectionTableEntry-&gt;Misc.VirtualSize == 0) {
02732             SectionVirtualSize = SectionTableEntry-&gt;SizeOfRawData;
02733         } <span class="keywordflow">else</span> {
02734             SectionVirtualSize = SectionTableEntry-&gt;Misc.VirtualSize;
02735         }
02736 
02737         <span class="comment">//</span>
02738         <span class="comment">// Fix for Borland linker problem.  The SizeOfRawData can</span>
02739         <span class="comment">// be a zero, but the PointerToRawData is not zero.</span>
02740         <span class="comment">// Set it to zero.</span>
02741         <span class="comment">//</span>
02742 
02743         <span class="keywordflow">if</span> (SectionTableEntry-&gt;SizeOfRawData == 0) {
02744             SectionTableEntry-&gt;PointerToRawData = 0;
02745         }
02746 
02747         <span class="comment">//</span>
02748         <span class="comment">// If the section information wraps return an error.</span>
02749         <span class="comment">//</span>
02750 
02751         <span class="keywordflow">if</span> (SectionTableEntry-&gt;PointerToRawData +
02752                     SectionTableEntry-&gt;SizeOfRawData &lt;
02753             SectionTableEntry-&gt;PointerToRawData) {
02754 
02755             <span class="keywordflow">goto</span> BadPeImageSegment;
02756         }
02757 
02758 
02759         Subsection += 1;
02760         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a> = ControlArea;
02761         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a> = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02762         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o7">UnusedPtes</a> = 0;
02763         
02764         <span class="keywordflow">if</span> (((NextVa !=
02765                 (PreferredImageBase + SectionTableEntry-&gt;VirtualAddress)) 
02766 
02767 <span class="preprocessor">#if defined (_ALPHA_) || defined(_IA64_)</span>
02768 <span class="preprocessor"></span>             &amp;&amp; !InvalidAlignmentAllowed
02769 <span class="preprocessor">#endif</span>
02770 <span class="preprocessor"></span>
02771             )  ||
02772             (SectionVirtualSize == 0)) {
02773 
02774             <span class="comment">//</span>
02775             <span class="comment">// The specified virtual address does not align</span>
02776             <span class="comment">// with the next prototype PTE.</span>
02777             <span class="comment">//</span>
02778 
02779             <span class="keywordflow">goto</span> BadPeImageSegment;
02780         }
02781 
02782         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> =
02783             <a class="code" href="../../d4/d8/mi_8h.html#a90">MI_ROUND_TO_SIZE</a> (SectionVirtualSize, RoundingAlignment) 
02784                                                                 &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
02785 
02786         <span class="keywordflow">if</span> (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> &gt; NumberOfPtes) {
02787 
02788             <span class="comment">//</span>
02789             <span class="comment">// Inconsistent image, size does not agree with object tables.</span>
02790             <span class="comment">//</span>
02791             
02792             <span class="keywordflow">goto</span> BadPeImageSegment;
02793         }
02794         NumberOfPtes -= Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>;
02795 
02796         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.LongFlags = 0;
02797         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o4">StartingSector</a> =
02798                         SectionTableEntry-&gt;PointerToRawData &gt;&gt; <a class="code" href="../../d4/d8/mi_8h.html#a27">MMSECTOR_SHIFT</a>;
02799 
02800         <span class="comment">//</span>
02801         <span class="comment">// Align ending sector on file align boundary.</span>
02802         <span class="comment">//</span>
02803 
02804         EndingAddress = (SectionTableEntry-&gt;PointerToRawData +
02805                                      SectionTableEntry-&gt;SizeOfRawData +
02806                                      FileAlignment) &amp; ~FileAlignment;
02807         
02808         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o5">NumberOfFullSectors</a> = (ULONG)
02809                          ((EndingAddress &gt;&gt; <a class="code" href="../../d4/d8/mi_8h.html#a27">MMSECTOR_SHIFT</a>) -
02810                          Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o4">StartingSector</a>);
02811 
02812         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.SectorEndOffset =
02813                                     (ULONG) EndingAddress &amp; <a class="code" href="../../d4/d8/mi_8h.html#a28">MMSECTOR_MASK</a>;
02814 
02815         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a> = PointerPte;
02816 
02817         <span class="comment">//</span>
02818         <span class="comment">// Build both a demand zero PTE and a PTE pointing to the</span>
02819         <span class="comment">// subsection.</span>
02820         <span class="comment">//</span>
02821         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = 0;
02822         TempPteDemandZero.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = 0;
02823 
02824         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a149">MiGetSubsectionAddressForPte</a> (Subsection);
02825         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype = 1;
02826         ImageFileSize = SectionTableEntry-&gt;PointerToRawData +
02827                                     SectionTableEntry-&gt;SizeOfRawData;
02828         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection =
02829                  <a class="code" href="../../d0/d8/creasect_8c.html#a13">MiGetImageProtection</a> (SectionTableEntry-&gt;Characteristics);
02830         TempPteDemandZero.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection;
02831 
02832         <span class="keywordflow">if</span> (SectionTableEntry-&gt;PointerToRawData == 0) {
02833             TempPte = TempPteDemandZero;
02834         }
02835 
02836         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.ReadOnly = 1;
02837         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.CopyOnWrite = 1;
02838         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.Protection = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a184">MI_GET_PROTECTION_FROM_SOFT_PTE</a> (&amp;TempPte);
02839 
02840         <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection &amp; <a class="code" href="../../d4/d8/mi_8h.html#a51">MM_PROTECTION_WRITE_MASK</a>) {
02841             <span class="keywordflow">if</span> ((TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection &amp; <a class="code" href="../../d4/d8/mi_8h.html#a84">MM_COPY_ON_WRITE_MASK</a>)
02842                                             == <a class="code" href="../../d4/d8/mi_8h.html#a84">MM_COPY_ON_WRITE_MASK</a>) {
02843 
02844                 <span class="comment">//</span>
02845                 <span class="comment">// This page is copy on write, charge ImageCommitment</span>
02846                 <span class="comment">// for all pages in this subsection.</span>
02847                 <span class="comment">//</span>
02848 
02849                 ImageCommit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02850             } <span class="keywordflow">else</span> {
02851 
02852                 <span class="comment">//</span>
02853                 <span class="comment">// This page is write shared, charge commitment when</span>
02854                 <span class="comment">// the mapping completes.</span>
02855                 <span class="comment">//</span>
02856 
02857                 SectionCommit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02858                 Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.GlobalMemory = 1;
02859                 ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.GlobalMemory = 1;
02860             }
02861         } <span class="keywordflow">else</span> {
02862 
02863             <span class="comment">//</span>
02864             <span class="comment">// Not writable, don't charge commitment at all.</span>
02865             <span class="comment">//</span>
02866 
02867             ImageCommit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02868             SectionCommit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02869         }
02870 
02871         NewSegment-&gt;SegmentPteTemplate = TempPte;
02872         <a class="code" href="../../d3/d8/udfprocs_8h.html#a43">SectorOffset</a> = 0;
02873 
02874         <span class="keywordflow">for</span> (i = 0; i &lt; Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>; i += 1) {
02875 
02876             <span class="comment">//</span>
02877             <span class="comment">// Set all the prototype PTEs to refer to the control section.</span>
02878             <span class="comment">//</span>
02879 
02880             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a43">SectorOffset</a> &lt; SectionVirtualSize) {
02881 
02882                 <span class="comment">//</span>
02883                 <span class="comment">// Make PTE accessible.</span>
02884                 <span class="comment">//</span>
02885 
02886                 <span class="keywordflow">if</span> (SectionCommit) {
02887                     NewSegment-&gt;NumberOfCommittedPages += 1;
02888                 }
02889                 <span class="keywordflow">if</span> (ImageCommit) {
02890                     NewSegment-&gt;ImageCommitment += 1;
02891                 }
02892 
02893                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a43">SectorOffset</a> &lt; SectionTableEntry-&gt;SizeOfRawData) {
02894 
02895                     <span class="comment">//</span>
02896                     <span class="comment">// Data resides on the disk, use the subsection format PTE.</span>
02897                     <span class="comment">//</span>
02898                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, TempPte);
02899                 } <span class="keywordflow">else</span> {
02900 
02901                     <span class="comment">//</span>
02902                     <span class="comment">// Demand zero pages.</span>
02903                     <span class="comment">//</span>
02904                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, TempPteDemandZero);
02905                 }
02906             } <span class="keywordflow">else</span> {
02907 
02908                 <span class="comment">//</span>
02909                 <span class="comment">// No access pages.</span>
02910                 <span class="comment">//</span>
02911 
02912                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>);
02913             }
02914             <a class="code" href="../../d3/d8/udfprocs_8h.html#a43">SectorOffset</a> += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02915             PointerPte += 1;
02916             NextVa += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02917         }
02918 
02919 <span class="preprocessor">#if defined (_ALPHA_) || defined(_IA64_)</span>
02920 <span class="preprocessor"></span>        }
02921 <span class="preprocessor">#endif</span>
02922 <span class="preprocessor"></span>
02923         SectionTableEntry += 1;
02924         NumberOfSubsections -= 1;
02925     }
02926 
02927 <span class="preprocessor">#if defined (_ALPHA_) || defined(_IA64_)</span>
02928 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!InvalidAlignmentAllowed) {
02929 <span class="preprocessor">#endif</span>
02930 <span class="preprocessor"></span>
02931     <span class="comment">//</span>
02932     <span class="comment">// Account for the number of subsections that really are mapped.</span>
02933     <span class="comment">//</span>
02934 
02935     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ImageAlignment &gt;= <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
02936     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o5">NumberOfSubsections</a> += 1;
02937 
02938     <span class="comment">//</span>
02939     <span class="comment">// If the file size is not as big as the image claimed to be,</span>
02940     <span class="comment">// return an error.</span>
02941     <span class="comment">//</span>
02942 
02943     <span class="keywordflow">if</span> (ImageFileSize &gt; EndOfFile.LowPart) {
02944 
02945         <span class="comment">//</span>
02946         <span class="comment">// Invalid image size.</span>
02947         <span class="comment">//</span>
02948 
02949         KdPrint((<span class="stringliteral">"MMCREASECT: invalid image size - file size %lx - image size %lx\n %Z\n"</span>,
02950             EndOfFile.LowPart, ImageFileSize, &amp;<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;FileName));
02951         <span class="keywordflow">goto</span> BadPeImageSegment;
02952     }
02953 
02954     <span class="comment">//</span>
02955     <span class="comment">// The total number of PTEs was decremented as sections were built,</span>
02956     <span class="comment">// make sure that there are less than 64k's worth at this point.</span>
02957     <span class="comment">//</span>
02958 
02959     <span class="keywordflow">if</span> (NumberOfPtes &gt;= (ImageAlignment &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) {
02960 
02961         <span class="comment">//</span>
02962         <span class="comment">// Inconsistent image, size does not agree with object tables.</span>
02963         <span class="comment">//</span>
02964 
02965         KdPrint((<span class="stringliteral">"MMCREASECT: invalid image - PTE left %lx\n image name %Z\n"</span>,
02966             NumberOfPtes, &amp;<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;FileName));
02967 
02968         <span class="keywordflow">goto</span> BadPeImageSegment;
02969     }
02970 
02971     <span class="comment">//</span>
02972     <span class="comment">// Set any remaining PTEs to no access.</span>
02973     <span class="comment">//</span>
02974 
02975     <span class="keywordflow">while</span> (NumberOfPtes != 0) {
02976         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>);
02977         PointerPte += 1;
02978         NumberOfPtes -= 1;
02979     }
02980 
02981     <span class="comment">//</span>
02982     <span class="comment">// Turn the image header page into a transition page within the</span>
02983     <span class="comment">// prototype PTEs.</span>
02984     <span class="comment">//</span>
02985 
02986     <span class="keywordflow">if</span> ((ExtendedHeader == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (SizeOfHeaders &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) {
02987 
02988         <span class="comment">//</span>
02989         <span class="comment">// Zero remaining portion of header.</span>
02990         <span class="comment">//</span>
02991 
02992         RtlZeroMemory ((PVOID)((PCHAR)Base +
02993                        SizeOfHeaders),
02994                        <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - SizeOfHeaders);
02995     }
02996 
02997 
02998 <span class="preprocessor">#if defined (_ALPHA_) || defined(_IA64_)</span>
02999 <span class="preprocessor"></span>    }
03000 <span class="preprocessor">#endif</span>
03001 <span class="preprocessor"></span>
03002     <span class="keywordflow">if</span> (NewSegment-&gt;NumberOfCommittedPages != 0) {
03003 
03004         <span class="comment">//</span>
03005         <span class="comment">// Commit the pages for the image section.</span>
03006         <span class="comment">//</span>
03007 
03008         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a17">MiChargeCommitment</a> (NewSegment-&gt;NumberOfCommittedPages, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03009             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_COMMITMENT_LIMIT;
03010             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (NewSegment);
03011             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ControlArea);
03012             <span class="keywordflow">goto</span> NeImage;
03013         }
03014 
03015         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a263">MM_DBG_COMMIT_IMAGE</a>, NewSegment-&gt;NumberOfCommittedPages);
03016         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
03017 
03018         ExAcquireFastMutex (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a677">MmSectionCommitMutex</a>);
03019         <a class="code" href="../../d8/d5/kddata_8c.html#a31">MmSharedCommit</a> += NewSegment-&gt;NumberOfCommittedPages;
03020         ExReleaseFastMutex (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a677">MmSectionCommitMutex</a>);
03021     }
03022 
03023 PeReturnSuccess:
03024 
03025     <span class="comment">//</span>
03026     <span class="comment">// If this image is global per session, then allocate a large control</span>
03027     <span class="comment">// area.  Note this doesn't need to be done for systemwide global control</span>
03028     <span class="comment">// areas or non-global control areas.</span>
03029     <span class="comment">//</span>
03030 
03031     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp;
03032         (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.GlobalMemory) &amp;&amp;
03033         ((LoaderFlags &amp; IMAGE_LOADER_FLAGS_SYSTEM_GLOBAL) == 0)) {
03034 
03035         LargeControlArea = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
03036                                             (ULONG)(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">LARGE_CONTROL_AREA</a>) +
03037                                                     (<span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a465">SUBSECTION</a>) *
03038                                                     SubsectionsAllocated)),
03039                                                     'iCmM');
03040         <span class="keywordflow">if</span> (LargeControlArea == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03041 
03042             <span class="comment">//</span>
03043             <span class="comment">// The requested pool could not be allocated.</span>
03044             <span class="comment">//</span>
03045 
03046             <span class="keywordflow">if</span> (NewSegment-&gt;NumberOfCommittedPages != 0) {
03047                 <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (NewSegment-&gt;NumberOfCommittedPages);
03048                 <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a292">MM_DBG_COMMIT_RETURN_IMAGE_NO_LARGE_CA</a>, NewSegment-&gt;NumberOfCommittedPages);
03049                 ExAcquireFastMutex (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a677">MmSectionCommitMutex</a>);
03050                 <a class="code" href="../../d8/d5/kddata_8c.html#a31">MmSharedCommit</a> -= NewSegment-&gt;NumberOfCommittedPages;
03051                 ExReleaseFastMutex (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a677">MmSectionCommitMutex</a>);
03052             }
03053 
03054             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (NewSegment);
03055             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ControlArea);
03056 
03057 
03058             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
03059 
03060             <span class="keywordflow">goto</span> NeImage;
03061         }
03062 
03063         <span class="comment">//</span>
03064         <span class="comment">// Copy the normal control area into our larger one, fix the linkages,</span>
03065         <span class="comment">// Fill in the additional fields in the new one and free the old one.</span>
03066         <span class="comment">//</span>
03067 
03068         RtlMoveMemory (LargeControlArea, ControlArea, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a460">CONTROL_AREA</a>));
03069         LargeControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o16">NonPagedPoolUsage</a> = <a class="code" href="../../d4/d2/pool_8h.html#a23">EX_REAL_POOL_USAGE</a>(
03070                                                     <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a462">LARGE_CONTROL_AREA</a>) +
03071                                                     (<span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a465">SUBSECTION</a>) *
03072                                                     SubsectionsAllocated));
03073 
03074         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 0);
03075 
03076         Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(ControlArea + 1);
03077         NewSubsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(LargeControlArea + 1);
03078 
03079         <span class="keywordflow">for</span> (i = 0; i &lt; SubsectionsAllocated; i += 1) {
03080             RtlMoveMemory (NewSubsection, Subsection, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a465">SUBSECTION</a>));
03081             NewSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a> = (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>) LargeControlArea;
03082 
03083             PointerPte = NewSegment-&gt;PrototypePte;
03084 
03085             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a149">MiGetSubsectionAddressForPte</a> (NewSubsection);
03086             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype = 1;
03087 
03088             <span class="keywordflow">for</span> (j = 0; j &lt; NewSegment-&gt;TotalNumberOfPtes; j += 1) {
03089 
03090                 <span class="keywordflow">if</span> ((PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1) &amp;&amp;
03091                     (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a148">MiGetSubsectionAddress</a> (PointerPte) == Subsection)) {
03092                         OriginalProtection = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a184">MI_GET_PROTECTION_FROM_SOFT_PTE</a> (PointerPte);
03093                         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = OriginalProtection;
03094                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, TempPte);
03095                 }
03096                 PointerPte += 1;
03097             }
03098 
03099             Subsection += 1;
03100             NewSubsection += 1;
03101         }
03102 
03103         NewSegment-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a> = (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>) LargeControlArea;
03104 
03105         LargeControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession = 1;
03106 
03107         LargeControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o18">SessionId</a> = 0;
03108         InitializeListHead (&amp;LargeControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o17">UserGlobalList</a>);
03109 
03110         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ControlArea);
03111 
03112         ControlArea = (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>) LargeControlArea;
03113     }
03114 
03115     <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a2">MiUnmapImageHeaderInHyperSpace</a> ();
03116 
03117     <span class="comment">//</span>
03118     <span class="comment">// Set the PFN database entry for this page to look like a transition</span>
03119     <span class="comment">// page.</span>
03120     <span class="comment">//</span>
03121 
03122     PointerPte = NewSegment-&gt;PrototypePte;
03123 
03124     <a class="code" href="../../d4/d8/mi_8h.html#a808">MiUpdateImageHeaderPage</a> (PointerPte, PageFrameNumber, ControlArea);
03125     <span class="keywordflow">if</span> (ExtendedHeader != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03126         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ExtendedHeader);
03127     }
03128     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (InPageEvent);
03129 
03130     <span class="keywordflow">return</span> STATUS_SUCCESS;
03131 
03132 
03133     <span class="comment">//</span>
03134     <span class="comment">// Error returns from image verification.</span>
03135     <span class="comment">//</span>
03136 
03137 BadPeImageSegment:
03138 
03139     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (NewSegment);
03140     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ControlArea);
03141 
03142 <span class="comment">//BadPeImage:</span>
03143     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_IMAGE_FORMAT;
03144 
03145 NeImage:
03146     <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a2">MiUnmapImageHeaderInHyperSpace</a> ();
03147 
03148 BadSection:
03149     <a class="code" href="../../d4/d8/mi_8h.html#a810">MiRemoveImageHeaderPage</a>(PageFrameNumber);
03150     <span class="keywordflow">if</span> (ExtendedHeader != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03151         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ExtendedHeader);
03152     }
03153     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (InPageEvent);
03154     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03155 }
03156 
03157 
03158 BOOLEAN
<a name="l03159"></a><a class="code" href="../../d0/d8/creasect_8c.html#a15">03159</a> <a class="code" href="../../d0/d8/creasect_8c.html#a15">MiCheckDosCalls</a> (
03160     IN PIMAGE_OS2_HEADER Os2Header,
03161     IN ULONG HeaderSize
03162     )
03163 
03164 <span class="comment">/*++</span>
03165 <span class="comment"></span>
03166 <span class="comment">Routine Description:</span>
03167 <span class="comment"></span>
03168 <span class="comment"></span>
03169 <span class="comment">Arguments:</span>
03170 <span class="comment"></span>
03171 <span class="comment">Return Value:</span>
03172 <span class="comment"></span>
03173 <span class="comment">    Returns the status value.</span>
03174 <span class="comment"></span>
03175 <span class="comment">--*/</span>
03176 
03177 {
03178     PUCHAR ImportTable;
03179     UCHAR EntrySize;
03180     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> ModuleCount;
03181     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> ModuleSize;
03182     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> i;
03183     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a> ModuleTable;
03184 
03185     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03186 
03187     <span class="comment">//</span>
03188     <span class="comment">// If there are no modules to check return immediately.</span>
03189     <span class="comment">//</span>
03190 
03191     ModuleCount = Os2Header-&gt;ne_cmod;
03192 
03193     <span class="keywordflow">if</span> (ModuleCount == 0) {
03194         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03195     }
03196 
03197     <span class="comment">//</span>
03198     <span class="comment">// exe headers are notorious for having junk values for offsets</span>
03199     <span class="comment">// in the import table and module table.  We guard against this</span>
03200     <span class="comment">// via careful checking plus our exception handler.</span>
03201     <span class="comment">//</span>
03202 
03203     <span class="keywordflow">try</span> {
03204 
03205         <span class="comment">//</span>
03206         <span class="comment">// Find out where the Module ref table is. Mod table has two byte</span>
03207         <span class="comment">// for each entry in import table. These two bytes tell the offset</span>
03208         <span class="comment">// in the import table for that entry.</span>
03209         <span class="comment">//</span>
03210 
03211         ModuleTable = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)((PCHAR)Os2Header + (ULONG)Os2Header-&gt;ne_modtab);
03212 
03213         <span class="comment">//</span>
03214         <span class="comment">// Make sure that the module table fits within the passed-in header.</span>
03215         <span class="comment">// Note that each module table entry is 2 bytes long.</span>
03216         <span class="comment">//</span>
03217 
03218         <span class="keywordflow">if</span> (((ULONG)Os2Header-&gt;ne_modtab + (ModuleCount * 2)) &gt; HeaderSize) {
03219             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03220         }
03221 
03222         <span class="comment">//</span>
03223         <span class="comment">// Now search individual entries for DOSCALLs.</span>
03224         <span class="comment">//</span>
03225 
03226         <span class="keywordflow">for</span> (i = 0; i &lt; ModuleCount; i += 1) {
03227 
03228             ModuleSize = *((UNALIGNED <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> *)ModuleTable);
03229 
03230             <span class="comment">//</span>
03231             <span class="comment">// Import table has count byte followed by the string where count</span>
03232             <span class="comment">// is the string length.</span>
03233             <span class="comment">//</span>
03234 
03235             ImportTable = (PUCHAR)((PCHAR)Os2Header +
03236                           (ULONG)Os2Header-&gt;ne_imptab + (ULONG)ModuleSize);
03237 
03238             <span class="comment">//</span>
03239             <span class="comment">// Make sure the offset is within the valid range.</span>
03240             <span class="comment">//</span>
03241 
03242             <span class="keywordflow">if</span> (((ULONG)Os2Header-&gt;ne_imptab + (ULONG)ModuleSize)
03243                             &gt;= HeaderSize) {
03244                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03245             }
03246 
03247             EntrySize = *ImportTable++;
03248 
03249             <span class="comment">//</span>
03250             <span class="comment">// 0 is a bad size, bail out.</span>
03251             <span class="comment">//</span>
03252 
03253             <span class="keywordflow">if</span> (EntrySize == 0) {
03254                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03255             }
03256 
03257             <span class="comment">//</span>
03258             <span class="comment">// Make sure the offset is within the valid range.</span>
03259             <span class="comment">// The sizeof(UCHAR) is included in the check because ImportTable</span>
03260             <span class="comment">// was incremented above and is used in the RtlEqualMemory</span>
03261             <span class="comment">// comparison below.</span>
03262             <span class="comment">//</span>
03263 
03264             <span class="keywordflow">if</span> (((ULONG)Os2Header-&gt;ne_imptab + (ULONG)ModuleSize +
03265                             (ULONG)EntrySize + <span class="keyword">sizeof</span>(UCHAR)) &gt; HeaderSize) {
03266                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03267             }
03268 
03269             <span class="comment">//</span>
03270             <span class="comment">// If size matches compare DOSCALLS.</span>
03271             <span class="comment">//</span>
03272 
03273             <span class="keywordflow">if</span> (EntrySize == 8) {
03274                 <span class="keywordflow">if</span> (RtlEqualMemory (ImportTable, <span class="stringliteral">"DOSCALLS"</span>, 8) ) {
03275                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03276                 }
03277             }
03278 
03279             <span class="comment">//</span>
03280             <span class="comment">// Move on to the next module table entry.  Each entry is 2 bytes.</span>
03281             <span class="comment">//</span>
03282 
03283             ModuleTable = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)((PCHAR)ModuleTable + 2);
03284         }
03285     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
03286         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03287     }
03288 
03289     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03290 }
03291 
03292 
03293 
03294 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03295"></a><a class="code" href="../../d0/d8/creasect_8c.html#a14">03295</a> <a class="code" href="../../d0/d8/creasect_8c.html#a14">MiVerifyImageHeader</a> (
03296     IN PIMAGE_NT_HEADERS NtHeader,
03297     IN PIMAGE_DOS_HEADER DosHeader,
03298     IN ULONG NtHeaderSize
03299     )
03300 
03301 <span class="comment">/*++</span>
03302 <span class="comment"></span>
03303 <span class="comment">Routine Description:</span>
03304 <span class="comment"></span>
03305 <span class="comment"></span>
03306 <span class="comment">Arguments:</span>
03307 <span class="comment"></span>
03308 <span class="comment">Return Value:</span>
03309 <span class="comment"></span>
03310 <span class="comment">    Returns the status value.</span>
03311 <span class="comment"></span>
03312 <span class="comment">    TBS</span>
03313 <span class="comment"></span>
03314 <span class="comment">--*/</span>
03315 
03316 
03317 
03318 {
03319     <a class="code" href="../../d0/d8/creasect_8c.html#a12">PCONFIGPHARLAP</a> PharLapConfigured;
03320     PUCHAR         pb;
03321     LONG           pResTableAddress;
03322 
03323     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03324 
03325     <span class="keywordflow">if</span> (NtHeader-&gt;Signature != IMAGE_NT_SIGNATURE) {
03326         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)NtHeader-&gt;Signature == (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)IMAGE_OS2_SIGNATURE) {
03327 
03328             <span class="comment">//</span>
03329             <span class="comment">// Check to see if this is a win-16 image.</span>
03330             <span class="comment">//</span>
03331 
03332             <span class="keywordflow">if</span> ((!<a class="code" href="../../d0/d8/creasect_8c.html#a15">MiCheckDosCalls</a> ((PIMAGE_OS2_HEADER)NtHeader, NtHeaderSize)) &amp;&amp;
03333                 ((((PIMAGE_OS2_HEADER)NtHeader)-&gt;ne_exetyp == 2)
03334                                 ||
03335                 ((((PIMAGE_OS2_HEADER)NtHeader)-&gt;ne_exetyp == 0)  &amp;&amp;
03336                   (((((PIMAGE_OS2_HEADER)NtHeader)-&gt;ne_expver &amp; 0xff00) ==
03337                         0x200)  ||
03338                 ((((PIMAGE_OS2_HEADER)NtHeader)-&gt;ne_expver &amp; 0xff00) ==
03339                         0x300))))) {
03340 
03341                 <span class="comment">//</span>
03342                 <span class="comment">// This is a win-16 image.</span>
03343                 <span class="comment">//</span>
03344 
03345                 <span class="keywordflow">return</span> STATUS_INVALID_IMAGE_WIN_16;
03346             }
03347 
03348             <span class="comment">// The following OS/2 headers types go to NTDOS</span>
03349             <span class="comment">//</span>
03350             <span class="comment">// - exetype == 5 means binary is for Dos 4.0.</span>
03351             <span class="comment">//                e.g Borland Dos extender type</span>
03352             <span class="comment">//</span>
03353             <span class="comment">// - OS/2 apps which have no import table entries</span>
03354             <span class="comment">//   cannot be meant for the OS/2 ss.</span>
03355             <span class="comment">//                e.g. QuickC for dos binaries</span>
03356             <span class="comment">//</span>
03357             <span class="comment">//  - "old" Borland Dosx BC++ 3.x, Paradox 4.x</span>
03358             <span class="comment">//     exe type == 1</span>
03359             <span class="comment">//     DosHeader-&gt;e_cs * 16 + DosHeader-&gt;e_ip + 0x200 - 10</span>
03360             <span class="comment">//     contains the string " mode EXE$"</span>
03361             <span class="comment">//     but import table is empty, so we don't make special check</span>
03362             <span class="comment">//</span>
03363 
03364             <span class="keywordflow">if</span> (((PIMAGE_OS2_HEADER)NtHeader)-&gt;ne_exetyp == 5  ||
03365                 ((PIMAGE_OS2_HEADER)NtHeader)-&gt;ne_enttab ==
03366                   ((PIMAGE_OS2_HEADER)NtHeader)-&gt;ne_imptab  )
03367                {
03368                 <span class="keywordflow">return</span> STATUS_INVALID_IMAGE_PROTECT;
03369             }
03370 
03371 
03372             <span class="comment">//</span>
03373             <span class="comment">// Borland Dosx types: exe type 1</span>
03374             <span class="comment">//</span>
03375             <span class="comment">//  - "new" Borland Dosx BP7.0</span>
03376             <span class="comment">//     exe type == 1</span>
03377             <span class="comment">//     DosHeader + 0x200 contains the string "16STUB"</span>
03378             <span class="comment">//     0x200 happens to be e_parhdr*16</span>
03379             <span class="comment">//</span>
03380 
03381             <span class="keywordflow">if</span> (((PIMAGE_OS2_HEADER)NtHeader)-&gt;ne_exetyp == 1 &amp;&amp;
03382                 RtlEqualMemory((PUCHAR)DosHeader + 0x200, <span class="stringliteral">"16STUB"</span>, 6) )
03383                {
03384                 <span class="keywordflow">return</span> STATUS_INVALID_IMAGE_PROTECT;
03385             }
03386 
03387             <span class="comment">//</span>
03388             <span class="comment">// Check for PharLap extended header which we run as a dos app.</span>
03389             <span class="comment">// The PharLap config block is pointed to by the SizeofHeader</span>
03390             <span class="comment">// field in the DosHdr.</span>
03391             <span class="comment">// The following algorithm for detecting a pharlap exe</span>
03392             <span class="comment">// was recommended by PharLap Software Inc.</span>
03393             <span class="comment">//</span>
03394 
03395             PharLapConfigured =(<a class="code" href="../../d0/d8/creasect_8c.html#a12">PCONFIGPHARLAP</a>) ((PCHAR)DosHeader +
03396                                       ((ULONG)DosHeader-&gt;e_cparhdr &lt;&lt; 4));
03397 
03398             <span class="keywordflow">if</span> ((PCHAR)PharLapConfigured &lt;
03399                        (PCHAR)DosHeader + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__PHARLAP__CONFIG.html">CONFIGPHARLAP</a>)) {
03400                 <span class="keywordflow">if</span> (RtlEqualMemory(&amp;PharLapConfigured-&gt;<a class="code" href="../../d2/d5/struct__PHARLAP__CONFIG.html#o0">uchCopyRight</a>[0x18],
03401                                    <span class="stringliteral">"Phar Lap Software, Inc."</span>, 24) &amp;&amp;
03402                     (PharLapConfigured-&gt;<a class="code" href="../../d2/d5/struct__PHARLAP__CONFIG.html#o4">usSign</a> == 0x4b50 ||  <span class="comment">// stub loader type 2</span>
03403                      PharLapConfigured-&gt;<a class="code" href="../../d2/d5/struct__PHARLAP__CONFIG.html#o4">usSign</a> == 0x4f50 ||  <span class="comment">// bindable 286|DosExtender</span>
03404                      PharLapConfigured-&gt;<a class="code" href="../../d2/d5/struct__PHARLAP__CONFIG.html#o4">usSign</a> == 0x5650  )) <span class="comment">// bindable 286|DosExtender (Adv)</span>
03405                   {
03406                     <span class="keywordflow">return</span> STATUS_INVALID_IMAGE_PROTECT;
03407                 }
03408             }
03409 
03410 
03411 
03412             <span class="comment">//</span>
03413             <span class="comment">// Check for Rational extended header which we run as a dos app.</span>
03414             <span class="comment">// We look for the rational copyright at:</span>
03415             <span class="comment">//     wCopyRight = *(DosHeader-&gt;e_cparhdr*16 + 30h)</span>
03416             <span class="comment">//     pCopyRight = wCopyRight + DosHeader-&gt;e_cparhdr*16</span>
03417             <span class="comment">//     "Copyright (C) Rational Systems, Inc."</span>
03418             <span class="comment">//</span>
03419 
03420             pb = ((PUCHAR)DosHeader + ((ULONG)DosHeader-&gt;e_cparhdr &lt;&lt; 4));
03421 
03422             <span class="keywordflow">if</span> ((ULONG_PTR)pb &lt; (ULONG_PTR)DosHeader + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 0x30 - <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)) {
03423                 pb += *(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)(pb + 0x30);
03424                 <span class="keywordflow">if</span> ( (ULONG_PTR)pb &lt; (ULONG_PTR)DosHeader + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 36 &amp;&amp;
03425                      RtlEqualMemory(pb,
03426                                     <span class="stringliteral">"Copyright (C) Rational Systems, Inc."</span>,
03427                                     36) )
03428                    {
03429                     <span class="keywordflow">return</span> STATUS_INVALID_IMAGE_PROTECT;
03430                 }
03431             }
03432 
03433             <span class="comment">//</span>
03434             <span class="comment">// Check for lotus 123 family of applications. Starting</span>
03435             <span class="comment">// with 123 3.0 (till recently shipped 123 3.4), every</span>
03436             <span class="comment">// exe header is bound but is meant for DOS. This can</span>
03437             <span class="comment">// be checked via, a string signature in the extended</span>
03438             <span class="comment">// header. &lt;len byte&gt;"1-2-3 Preloader" is the string</span>
03439             <span class="comment">// at ne_nrestab offset.</span>
03440             <span class="comment">//</span>
03441 
03442             pResTableAddress = ((PIMAGE_OS2_HEADER)NtHeader)-&gt;ne_nrestab;
03443             <span class="keywordflow">if</span> (pResTableAddress &gt; DosHeader-&gt;e_lfanew &amp;&amp;
03444                 ((ULONG)((pResTableAddress+16) - DosHeader-&gt;e_lfanew) &lt;
03445                             NtHeaderSize) &amp;&amp;
03446                 RtlEqualMemory(
03447                     ((PUCHAR)NtHeader + 1 +
03448                              (ULONG)(pResTableAddress - DosHeader-&gt;e_lfanew)),
03449                     <span class="stringliteral">"1-2-3 Preloader"</span>,
03450                     15) ) {
03451                     <span class="keywordflow">return</span> STATUS_INVALID_IMAGE_PROTECT;
03452             }
03453 
03454             <span class="keywordflow">return</span> STATUS_INVALID_IMAGE_NE_FORMAT;
03455         }
03456 
03457         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)NtHeader-&gt;Signature == (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)IMAGE_OS2_SIGNATURE_LE) {
03458 
03459             <span class="comment">//</span>
03460             <span class="comment">// This is a LE (OS/2) image. We don't support it, so give it to</span>
03461             <span class="comment">// DOS subsystem. There are cases (Rbase.exe) which have a LE</span>
03462             <span class="comment">// header but actually it is suppose to run under DOS. When we</span>
03463             <span class="comment">// do support LE format, some work needs to be done here to</span>
03464             <span class="comment">// decide whether to give it to VDM or OS/2.</span>
03465             <span class="comment">//</span>
03466 
03467             <span class="keywordflow">return</span> STATUS_INVALID_IMAGE_PROTECT;
03468         }
03469         <span class="keywordflow">return</span> STATUS_INVALID_IMAGE_PROTECT;
03470     }
03471 
03472     <span class="keywordflow">if</span> ((NtHeader-&gt;FileHeader.Machine == 0) &amp;&amp;
03473         (NtHeader-&gt;FileHeader.SizeOfOptionalHeader == 0)) {
03474 
03475         <span class="comment">//</span>
03476         <span class="comment">// This is a bogus DOS app which has a 32-bit portion</span>
03477         <span class="comment">// masquerading as a PE image.</span>
03478         <span class="comment">//</span>
03479 
03480         <span class="keywordflow">return</span> STATUS_INVALID_IMAGE_PROTECT;
03481     }
03482 
03483     <span class="keywordflow">if</span> (!(NtHeader-&gt;FileHeader.Characteristics &amp; IMAGE_FILE_EXECUTABLE_IMAGE)) {
03484         <span class="keywordflow">return</span> STATUS_INVALID_IMAGE_FORMAT;
03485     }
03486 
03487 <span class="preprocessor">#ifdef i386</span>
03488 <span class="preprocessor"></span>
03489     <span class="comment">//</span>
03490     <span class="comment">// Make sure the image header is aligned on a Long word boundary.</span>
03491     <span class="comment">//</span>
03492 
03493     <span class="keywordflow">if</span> (((ULONG_PTR)NtHeader &amp; 3) != 0) {
03494         <span class="keywordflow">return</span> STATUS_INVALID_IMAGE_FORMAT;
03495     }
03496 <span class="preprocessor">#endif</span>
03497 <span class="preprocessor"></span>
03498 <span class="preprocessor">#define VALIDATE_NTHEADER(Hdr) {                                    \</span>
03499 <span class="preprocessor">    </span><span class="comment">/* File alignment must be multiple of 512 and power of 2. */</span>    \
03500     if (((((Hdr)-&gt;OptionalHeader).FileAlignment &amp; 511) != 0) &amp;&amp;     \
03501         (((Hdr)-&gt;OptionalHeader).FileAlignment !=                   \
03502          ((Hdr)-&gt;OptionalHeader).SectionAlignment)) {               \
03503         return STATUS_INVALID_IMAGE_FORMAT;                         \
03504     }                                                               \
03505                                                                     \
03506     if (((Hdr)-&gt;OptionalHeader).FileAlignment == 0) {               \
03507         return STATUS_INVALID_IMAGE_FORMAT;                         \
03508     }                                                               \
03509                                                                     \
03510     if (((((Hdr)-&gt;OptionalHeader).FileAlignment - 1) &amp;              \
03511           ((Hdr)-&gt;OptionalHeader).FileAlignment) != 0) {            \
03512         return STATUS_INVALID_IMAGE_FORMAT;                         \
03513     }                                                               \
03514                                                                     \
03515     if (((Hdr)-&gt;OptionalHeader).SectionAlignment &lt; ((Hdr)-&gt;OptionalHeader).FileAlignment) { \
03516         return STATUS_INVALID_IMAGE_FORMAT;                         \
03517     }                                                               \
03518                                                                     \
03519     if (((Hdr)-&gt;OptionalHeader).SizeOfImage &gt; MM_SIZE_OF_LARGEST_IMAGE) { \
03520         return STATUS_INVALID_IMAGE_FORMAT;                         \
03521     }                                                               \
03522                                                                     \
03523     if ((Hdr)-&gt;FileHeader.NumberOfSections &gt; MM_MAXIMUM_IMAGE_SECTIONS) { \
03524         return STATUS_INVALID_IMAGE_FORMAT;                         \
03525     }                                                               \
03526 }
03527 
03528     <span class="keywordflow">if</span> (NtHeader-&gt;OptionalHeader.Magic != IMAGE_NT_OPTIONAL_HDR_MAGIC) {
03529         <span class="comment">//</span>
03530         <span class="comment">// Image doesn't have the right magic value in its optional header</span>
03531         <span class="comment">//</span>
03532 <span class="preprocessor">#if defined (_WIN64)</span>
03533 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (NtHeader-&gt;OptionalHeader.Magic == IMAGE_NT_OPTIONAL_HDR32_MAGIC) {
03534             <span class="comment">//</span>
03535             <span class="comment">// PE32 image.  Validate it as such.</span>
03536             <span class="comment">//</span>
03537             PIMAGE_NT_HEADERS32 NtHeader32 = (PIMAGE_NT_HEADERS32)NtHeader;
03538 
03539             <a class="code" href="../../d0/d8/creasect_8c.html#a5">VALIDATE_NTHEADER</a>(NtHeader32);
03540             <span class="keywordflow">return</span> STATUS_SUCCESS;
03541         }
03542 <span class="preprocessor">#endif</span>
03543 <span class="preprocessor"></span>        <span class="keywordflow">return</span> STATUS_INVALID_IMAGE_FORMAT;
03544     }
03545 
03546     <a class="code" href="../../d0/d8/creasect_8c.html#a5">VALIDATE_NTHEADER</a>(NtHeader);
03547 <span class="preprocessor">    #undef VALIDATE_NTHEADER</span>
03548 <span class="preprocessor"></span>
03549     <span class="keywordflow">return</span> STATUS_SUCCESS;
03550 }
03551 
03552 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03553"></a><a class="code" href="../../d4/d8/mi_8h.html#a922">03553</a> <a class="code" href="../../d4/d8/mi_8h.html#a922">MiCreateDataFileMap</a> (
03554     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> File,
03555     OUT <a class="code" href="../../d1/d1/struct__SEGMENT.html">PSEGMENT</a> *Segment,
03556     IN PUINT64 MaximumSize,
03557     IN ULONG SectionPageProtection,
03558     IN ULONG AllocationAttributes,
03559     IN ULONG IgnoreFileSizing
03560     )
03561 
03562 <span class="comment">/*++</span>
03563 <span class="comment"></span>
03564 <span class="comment">Routine Description:</span>
03565 <span class="comment"></span>
03566 <span class="comment">    This function creates the necessary structures to allow the mapping</span>
03567 <span class="comment">    of a data file.</span>
03568 <span class="comment"></span>
03569 <span class="comment">    The data file is accessed to verify desired access, a segment</span>
03570 <span class="comment">    object is created and initialized.</span>
03571 <span class="comment"></span>
03572 <span class="comment">Arguments:</span>
03573 <span class="comment"></span>
03574 <span class="comment">    File - Supplies the file object for the image file.</span>
03575 <span class="comment"></span>
03576 <span class="comment">    Segment - Returns the segment object.</span>
03577 <span class="comment"></span>
03578 <span class="comment">    FileHandle - Supplies the handle to the image file.</span>
03579 <span class="comment"></span>
03580 <span class="comment">    MaximumSize - Supplies the maximum size for the mapping.</span>
03581 <span class="comment"></span>
03582 <span class="comment">    SectionPageProtection - Supplies the initial page protection.</span>
03583 <span class="comment"></span>
03584 <span class="comment">    AllocationAttributes - Supplies the allocation attributes for the</span>
03585 <span class="comment">                           mapping.</span>
03586 <span class="comment"></span>
03587 <span class="comment">Return Value:</span>
03588 <span class="comment"></span>
03589 <span class="comment">    Returns the status value.</span>
03590 <span class="comment"></span>
03591 <span class="comment">    TBS</span>
03592 <span class="comment"></span>
03593 <span class="comment"></span>
03594 <span class="comment">--*/</span>
03595 
03596 {
03597 
03598     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03599     ULONG NumberOfPtes;
03600     ULONG SizeOfSegment;
03601     ULONG j;
03602     ULONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
03603     ULONG PartialSize;
03604     ULONG First;
03605     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
03606     <a class="code" href="../../d1/d1/struct__SEGMENT.html">PSEGMENT</a> NewSegment;
03607     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
03608     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> ExtendedSubsection;
03609     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03610     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
03611     ULONG NumberOfPtesWithAlignment;
03612     UINT64 EndOfFile;
03613     UINT64 LastFileChunk;
03614     UINT64 FileOffset;
03615     UINT64 NumberOfPtesForEntireFile;
03616     ULONG ExtendedSubsections;
03617     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> FirstSubsection;
03618     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Last;
03619     ULONG NumberOfNewSubsections;
03620 
03621     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03622 
03623     ExtendedSubsections = 0;
03624     FirstSubsection = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03625     NumberOfNewSubsections = 0;
03626 
03627     <span class="comment">// *************************************************************</span>
03628     <span class="comment">// Create mapped file section.</span>
03629     <span class="comment">// *************************************************************</span>
03630 
03631     <span class="keywordflow">if</span> (!IgnoreFileSizing) {
03632 
03633         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d8/fsrtl_8h.html#a109">FsRtlGetFileSize</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>, (PLARGE_INTEGER)&amp;EndOfFile);
03634 
03635         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_FILE_IS_A_DIRECTORY) {
03636 
03637             <span class="comment">//</span>
03638             <span class="comment">// Can't map a directory as a section. Return error.</span>
03639             <span class="comment">//</span>
03640 
03641             <span class="keywordflow">return</span> STATUS_INVALID_FILE_FOR_SECTION;
03642         }
03643 
03644         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03645             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03646         }
03647 
03648         <span class="keywordflow">if</span> (EndOfFile == 0 &amp;&amp; *MaximumSize == 0) {
03649 
03650             <span class="comment">//</span>
03651             <span class="comment">// Can't map a zero length without specifying the maximum</span>
03652             <span class="comment">// size as non-zero.</span>
03653             <span class="comment">//</span>
03654 
03655             <span class="keywordflow">return</span> STATUS_MAPPED_FILE_SIZE_ZERO;
03656         }
03657 
03658         <span class="comment">//</span>
03659         <span class="comment">// Make sure this file is big enough for the section.</span>
03660         <span class="comment">//</span>
03661 
03662         <span class="keywordflow">if</span> (*MaximumSize &gt; EndOfFile) {
03663 
03664             <span class="comment">//</span>
03665             <span class="comment">// If the maximum size is greater than the end-of-file,</span>
03666             <span class="comment">// and the user did not request page_write or page_execute_readwrite</span>
03667             <span class="comment">// to the section, reject the request.</span>
03668             <span class="comment">//</span>
03669 
03670             <span class="keywordflow">if</span> (((SectionPageProtection &amp; PAGE_READWRITE) |
03671                 (SectionPageProtection &amp; PAGE_EXECUTE_READWRITE)) == 0) {
03672 
03673                 <span class="keywordflow">return</span> STATUS_SECTION_TOO_BIG;
03674             }
03675 
03676             <span class="comment">//</span>
03677             <span class="comment">// Check to make sure that the allocation size large enough</span>
03678             <span class="comment">// to contain all the data, if not set a new allocation size.</span>
03679             <span class="comment">//</span>
03680 
03681             EndOfFile = *MaximumSize;
03682 
03683             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d8/fsrtl_8h.html#a110">FsRtlSetFileSize</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>, (PLARGE_INTEGER)&amp;EndOfFile);
03684 
03685             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03686                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03687             }
03688         }
03689     } <span class="keywordflow">else</span> {
03690 
03691         <span class="comment">//</span>
03692         <span class="comment">// Ignore the file size, this call is from the cache manager.</span>
03693         <span class="comment">//</span>
03694 
03695         EndOfFile = *MaximumSize;
03696     }
03697 
03698     <span class="comment">//</span>
03699     <span class="comment">// Calculate the number of prototype PTEs to build for this section.</span>
03700     <span class="comment">//</span>
03701 
03702     <span class="comment">//</span>
03703     <span class="comment">// Each subsection is limited to 16TB - 64K because the NumberOfFullSectors</span>
03704     <span class="comment">// and various other fields in the subsection are ULONGs.  For NT64, the</span>
03705     <span class="comment">// allocation could be split into multiple subsections as needed to</span>
03706     <span class="comment">// conform to this limit - this is not worth doing for NT32 unless</span>
03707     <span class="comment">// sparse prototype PTE allocations are supported.</span>
03708     <span class="comment">//</span>
03709     <span class="comment">// This must be a multiple of the size of prototype pte allocation so any</span>
03710     <span class="comment">// given prototype pte allocation will have the same subsection for all</span>
03711     <span class="comment">// PTEs.</span>
03712     <span class="comment">//</span>
03713     <span class="comment">// The total section size is limited to 16PB - 4K because of the</span>
03714     <span class="comment">// StartingSector4132 field in each subsection.</span>
03715     <span class="comment">//</span>
03716 
03717     NumberOfPtesForEntireFile = (EndOfFile + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
03718 
03719     NumberOfPtes = (ULONG)NumberOfPtesForEntireFile;
03720 
03721     <span class="keywordflow">if</span> (EndOfFile &gt; <a class="code" href="../../d4/d8/mi_8h.html#a218">MI_MAXIMUM_SECTION_SIZE</a>) {
03722         <span class="keywordflow">return</span> STATUS_SECTION_TOO_BIG;
03723     }
03724 
03725     <span class="keywordflow">if</span> (NumberOfPtesForEntireFile &gt; (UINT64)((MAXULONG_PTR / <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>)) - <span class="keyword">sizeof</span> (<a class="code" href="../../d1/d1/struct__SEGMENT.html">SEGMENT</a>))) {
03726         <span class="keywordflow">return</span> STATUS_SECTION_TOO_BIG;
03727     }
03728 
03729     <span class="keywordflow">if</span> (NumberOfPtesForEntireFile &gt; EndOfFile) {
03730         <span class="keywordflow">return</span> STATUS_SECTION_TOO_BIG;
03731     }
03732 
03733     <span class="comment">//</span>
03734     <span class="comment">// Calculate the number of PTEs to allocate to maintain the</span>
03735     <span class="comment">// desired alignment.  On x86 and R3000 no additional PTEs are</span>
03736     <span class="comment">// needed; on MIPS, the desired alignment is 64k to avoid cache</span>
03737     <span class="comment">// problems.</span>
03738     <span class="comment">//</span>
03739 
03740     NumberOfPtesWithAlignment = (NumberOfPtes +
03741             ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a47">MM_PROTO_PTE_ALIGNMENT</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) - 1)) &amp;
03742             (~((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a47">MM_PROTO_PTE_ALIGNMENT</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) - 1));
03743 
03744     <span class="keywordflow">if</span> (NumberOfPtesWithAlignment &lt; NumberOfPtes) {
03745         <span class="keywordflow">return</span> STATUS_SECTION_TOO_BIG;
03746     }
03747 
03748     SizeOfSegment = <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/struct__SEGMENT.html">SEGMENT</a>) + <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>) *
03749                                         (NumberOfPtesWithAlignment - 1);
03750 
03751     NewSegment = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
03752                                         SizeOfSegment,
03753                                         <a class="code" href="../../d0/d8/creasect_8c.html#a8">MMSECT</a>);
03754     <span class="keywordflow">if</span> (NewSegment == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03755 
03756         <span class="comment">//</span>
03757         <span class="comment">// The requested pool could not be allocated.</span>
03758         <span class="comment">// Try to allocate the memory in smaller sizes.</span>
03759         <span class="comment">//</span>
03760 
03761         <span class="keywordflow">if</span> (SizeOfSegment &lt; <a class="code" href="../../d0/d8/creasect_8c.html#a2">MM_ALLOCATION_FRAGMENT</a>) {
03762             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
03763         }
03764 
03765         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d0/d8/creasect_8c.html#a2">MM_ALLOCATION_FRAGMENT</a>;
03766         PartialSize = SizeOfSegment;
03767 
03768         <span class="keywordflow">do</span> {
03769 
03770             <span class="keywordflow">if</span> (PartialSize &lt; <a class="code" href="../../d0/d8/creasect_8c.html#a2">MM_ALLOCATION_FRAGMENT</a>) {
03771                 PartialSize = (ULONG) <a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a> (PartialSize);
03772                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = PartialSize;
03773             }
03774 
03775             NewSegment = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
03776                                                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
03777                                                 <a class="code" href="../../d0/d8/creasect_8c.html#a8">MMSECT</a>);
03778             ExtendedSubsection = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
03779                                                    <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d7/struct__SUBSECTION.html">SUBSECTION</a>),
03780                                                    'bSmM');
03781 
03782             <span class="keywordflow">if</span> ((NewSegment == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (ExtendedSubsection == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
03783                 <span class="keywordflow">if</span> (NewSegment) {
03784                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (NewSegment);
03785                 }
03786                 <span class="keywordflow">if</span> (ExtendedSubsection) {
03787                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ExtendedSubsection);
03788                 }
03789 
03790                 <span class="comment">//</span>
03791                 <span class="comment">// Free all the previous allocations and return an error.</span>
03792                 <span class="comment">//</span>
03793 
03794                 <span class="keywordflow">while</span> (FirstSubsection != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03795                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (FirstSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>);
03796                     Last = FirstSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
03797                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (FirstSubsection);
03798                     FirstSubsection = Last;
03799                 }
03800                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
03801             }
03802 
03803             NumberOfNewSubsections += 1;
03804             RtlZeroMemory (ExtendedSubsection, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a465">SUBSECTION</a>));
03805 
03806             <span class="keywordflow">if</span> (FirstSubsection == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03807                 FirstSubsection = ExtendedSubsection;
03808                 Last = ExtendedSubsection;
03809                 NumberOfNewSubsections = 0;
03810             } <span class="keywordflow">else</span> {
03811                 Last-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a> = ExtendedSubsection;
03812             }
03813 
03814             ExtendedSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> / <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>);
03815             ExtendedSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a> = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)NewSegment;
03816             Last = ExtendedSubsection;
03817             PartialSize -= <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
03818         } <span class="keywordflow">while</span> (PartialSize != 0);
03819 
03820         <span class="comment">//</span>
03821         <span class="comment">// Reset new segment and free the first subsection, as</span>
03822         <span class="comment">// the subsection after the control area will become the</span>
03823         <span class="comment">// first subsection.</span>
03824         <span class="comment">//</span>
03825 
03826         NewSegment = (<a class="code" href="../../d1/d1/struct__SEGMENT.html">PSEGMENT</a>)FirstSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>;
03827     }
03828 
03829     *Segment = NewSegment;
03830     RtlZeroMemory (NewSegment, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/struct__SEGMENT.html">SEGMENT</a>));
03831 
03832     ControlArea =
03833               (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer-&gt;DataSectionObject;
03834 
03835     <span class="comment">//</span>
03836     <span class="comment">// Control area and first subsection have been zeroed when allocated.</span>
03837     <span class="comment">//</span>
03838 
03839     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a> = NewSegment;
03840     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o2">NumberOfSectionReferences</a> = 1;
03841 
03842     <span class="keywordflow">if</span> (IgnoreFileSizing == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03843 
03844         <span class="comment">//</span>
03845         <span class="comment">// This reference is not from the cache manager.</span>
03846         <span class="comment">//</span>
03847 
03848         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o7">NumberOfUserReferences</a> = 1;
03849     }
03850 
03851     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingCreated = 1;
03852     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.File = 1;
03853 
03854     <span class="keywordflow">if</span> (FILE_REMOTE_DEVICE &amp; <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;DeviceObject-&gt;Characteristics) {
03855 
03856         <span class="comment">//</span>
03857         <span class="comment">// This file resides on a redirected drive.</span>
03858         <span class="comment">//</span>
03859 
03860         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Networked = 1;
03861     }
03862 
03863     <span class="keywordflow">if</span> (AllocationAttributes &amp; SEC_NOCACHE) {
03864         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.NoCache = 1;
03865     }
03866 
03867     <span class="keywordflow">if</span> (IgnoreFileSizing) {
03868         <span class="comment">// Set the was purged flag to indicate that the</span>
03869         <span class="comment">// file size was not explicitly set.</span>
03870         <span class="comment">//</span>
03871 
03872         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.WasPurged = 1;
03873     }
03874 
03875     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o5">NumberOfSubsections</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(1 + NumberOfNewSubsections);
03876     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a> = <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>;
03877 
03878     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 0);
03879 
03880     Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(ControlArea + 1);
03881 
03882     <span class="keywordflow">if</span> (FirstSubsection) {
03883 
03884         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a> = FirstSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
03885         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> = FirstSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>;
03886         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (FirstSubsection);
03887 <span class="preprocessor">#if DBG</span>
03888 <span class="preprocessor"></span>        FirstSubsection = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03889 <span class="preprocessor">#endif //DBG</span>
03890 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
03891         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03892     }
03893 
03894     First = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03895 
03896     FileOffset = 0;
03897 
03898     <span class="keywordflow">do</span> {
03899 
03900         <span class="comment">//</span>
03901         <span class="comment">// Loop through all the subsections and fill in the PTEs.</span>
03902         <span class="comment">//</span>
03903 
03904 
03905         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a149">MiGetSubsectionAddressForPte</a> (Subsection);
03906         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype = 1;
03907 
03908         <span class="comment">//</span>
03909         <span class="comment">// Set all the PTEs to the execute-read-write protection.</span>
03910         <span class="comment">// The section will control access to these and the segment</span>
03911         <span class="comment">// must provide a method to allow other users to map the file</span>
03912         <span class="comment">// for various protections.</span>
03913         <span class="comment">//</span>
03914 
03915         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a41">MM_EXECUTE_READWRITE</a>;
03916 
03917         <span class="comment">//</span>
03918         <span class="comment">// Align the prototype PTEs on the proper boundary.</span>
03919         <span class="comment">//</span>
03920 
03921         <span class="keywordflow">if</span> (First) {
03922 
03923             PointerPte = &amp;NewSegment-&gt;ThePtes[0];
03924             j = (ULONG) (((ULONG_PTR)PointerPte &gt;&gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>) &amp;
03925                             ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a47">MM_PROTO_PTE_ALIGNMENT</a> / <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) - 1));
03926 
03927             <span class="keywordflow">if</span> (j != 0) {
03928                 j = (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a47">MM_PROTO_PTE_ALIGNMENT</a> / <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) - j;
03929             }
03930 
03931             NewSegment-&gt;PrototypePte = &amp;NewSegment-&gt;ThePtes[j];
03932             NewSegment-&gt;ControlArea = ControlArea;
03933             NewSegment-&gt;SizeOfSegment = EndOfFile;
03934             NewSegment-&gt;TotalNumberOfPtes = NumberOfPtes;
03935             NewSegment-&gt;SegmentPteTemplate = TempPte;
03936             PointerPte = NewSegment-&gt;PrototypePte;
03937             Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a> = PointerPte;
03938             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o15">PagedPoolUsage</a> = <a class="code" href="../../d4/d2/pool_8h.html#a23">EX_REAL_POOL_USAGE</a>((<span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a455">SEGMENT</a>) + (NumberOfPtes * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>))));
03939 
03940             <span class="keywordflow">if</span> (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03941 
03942                 <span class="comment">//</span>
03943                 <span class="comment">// Multiple segments and subsections.</span>
03944                 <span class="comment">// Align first so it is a multiple of 64k sizes.</span>
03945                 <span class="comment">//</span>
03946                 <span class="comment">//</span>
03947 
03948                 NewSegment-&gt;NonExtendedPtes = (ULONG)
03949                   ((((Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a213">MMPTE</a>)) -
03950                     ((PCHAR)NewSegment-&gt;PrototypePte - (PCHAR)NewSegment))
03951                         / <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a213">MMPTE</a>)) &amp;  ~((<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) - 1));
03952             } <span class="keywordflow">else</span> {
03953                 NewSegment-&gt;NonExtendedPtes = NumberOfPtesWithAlignment;
03954             }
03955             Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> = NewSegment-&gt;NonExtendedPtes;
03956 
03957             First = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03958         } <span class="keywordflow">else</span> {
03959             PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>;
03960         }
03961 
03962         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a> = ControlArea;
03963 
03964         <a class="code" href="../../d4/d8/mi_8h.html#a219">Mi4KStartForSubsection</a>(&amp;FileOffset, Subsection);
03965 
03966         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a41">MM_EXECUTE_READWRITE</a>;
03967 
03968         <span class="keywordflow">if</span> (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03969 
03970             LastFileChunk = (EndOfFile &gt;&gt; <a class="code" href="../../d4/d8/mi_8h.html#a25">MM4K_SHIFT</a>) - FileOffset;
03971 
03972             <span class="comment">//</span>
03973             <span class="comment">// Note this next line restricts the number of bytes mapped by</span>
03974             <span class="comment">// a single subsection to 16TB-4K.  multiple subsections can always</span>
03975             <span class="comment">// be chained together to support an overall file of size 16K TB.</span>
03976             <span class="comment">//</span>
03977 
03978             Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o5">NumberOfFullSectors</a> = (ULONG)LastFileChunk;
03979 
03980             Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.SectorEndOffset =
03981                                  (ULONG) EndOfFile &amp; <a class="code" href="../../d4/d8/mi_8h.html#a26">MM4K_MASK</a>;
03982 
03983             j = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>;
03984 
03985             Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> = (ULONG)(
03986                 NumberOfPtesForEntireFile -
03987                                 (FileOffset &gt;&gt; (<a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> - <a class="code" href="../../d4/d8/mi_8h.html#a25">MM4K_SHIFT</a>)));
03988 
03989 <span class="preprocessor">#if DBG</span>
03990 <span class="preprocessor"></span>            MiSubsectionConsistent(Subsection);
03991 <span class="preprocessor">#endif</span>
03992 <span class="preprocessor"></span>
03993             Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o7">UnusedPtes</a> = j - Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>;
03994         } <span class="keywordflow">else</span> {
03995 
03996             Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o5">NumberOfFullSectors</a> =
03997                 Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> &lt;&lt; (<a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> - <a class="code" href="../../d4/d8/mi_8h.html#a25">MM4K_SHIFT</a>);
03998 <span class="preprocessor">#if DBG</span>
03999 <span class="preprocessor"></span>            MiSubsectionConsistent(Subsection);
04000 <span class="preprocessor">#endif</span>
04001 <span class="preprocessor"></span>
04002         }
04003 
04004         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a189">MiFillMemoryPte</a> (PointerPte,
04005                          (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> +
04006                                 Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o7">UnusedPtes</a>) * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>),
04007                          TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
04008 
04009         FileOffset += Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> &lt;&lt;
04010                                         (<a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> - <a class="code" href="../../d4/d8/mi_8h.html#a25">MM4K_SHIFT</a>);
04011         Subsection = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
04012     } <span class="keywordflow">while</span> (Subsection != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04013 
04014     <span class="keywordflow">return</span> STATUS_SUCCESS;
04015 }
04016 
04017 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04018"></a><a class="code" href="../../d4/d8/mi_8h.html#a923">04018</a> <a class="code" href="../../d4/d8/mi_8h.html#a923">MiCreatePagingFileMap</a> (
04019     OUT <a class="code" href="../../d1/d1/struct__SEGMENT.html">PSEGMENT</a> *Segment,
04020     IN PUINT64 MaximumSize,
04021     IN ULONG ProtectionMask,
04022     IN ULONG AllocationAttributes
04023     )
04024 
04025 <span class="comment">/*++</span>
04026 <span class="comment"></span>
04027 <span class="comment">Routine Description:</span>
04028 <span class="comment"></span>
04029 <span class="comment">    This function creates the necessary structures to allow the mapping</span>
04030 <span class="comment">    of a paging file.</span>
04031 <span class="comment"></span>
04032 <span class="comment">Arguments:</span>
04033 <span class="comment"></span>
04034 <span class="comment">    Segment - Returns the segment object.</span>
04035 <span class="comment"></span>
04036 <span class="comment">    MaximumSize - Supplies the maximum size for the mapping.</span>
04037 <span class="comment"></span>
04038 <span class="comment">    ProtectionMask - Supplies the initial page protection.</span>
04039 <span class="comment"></span>
04040 <span class="comment">    AllocationAttributes - Supplies the allocation attributes for the</span>
04041 <span class="comment">                           mapping.</span>
04042 <span class="comment"></span>
04043 <span class="comment">Return Value:</span>
04044 <span class="comment"></span>
04045 <span class="comment">    Returns the status value.</span>
04046 <span class="comment"></span>
04047 <span class="comment">    TBS</span>
04048 <span class="comment"></span>
04049 <span class="comment"></span>
04050 <span class="comment">--*/</span>
04051 
04052 
04053 {
04054     PFN_NUMBER NumberOfPtes;
04055     ULONG SizeOfSegment;
04056     ULONG i;
04057     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
04058     <a class="code" href="../../d1/d1/struct__SEGMENT.html">PSEGMENT</a> NewSegment;
04059     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
04060     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
04061     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
04062     LARGE_INTEGER SpecifiedSize;
04063 
04064     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04065 
04066     <span class="comment">//*******************************************************************</span>
04067     <span class="comment">// Create a section backed by paging file.</span>
04068     <span class="comment">//*******************************************************************</span>
04069 
04070     <span class="keywordflow">if</span> (*MaximumSize == 0) {
04071         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_4;
04072     }
04073 
04074     <span class="comment">//</span>
04075     <span class="comment">// Limit page file backed sections to the pagefile maximum size.</span>
04076     <span class="comment">//</span>
04077 
04078 <span class="preprocessor">#if defined (_WIN64) || defined (_X86PAE_)</span>
04079 <span class="preprocessor"></span>    SpecifiedSize.QuadPart = (<a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a> (*MaximumSize)) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
04080 
04081     <span class="keywordflow">if</span> (SpecifiedSize.HighPart != 0)
04082 <span class="preprocessor">#else</span>
04083 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (*MaximumSize &gt; (((ULONGLONG) 4 * 1024 * 1024 * 1024)) - (1024 * 1024))
04084 <span class="preprocessor">#endif</span>
04085 <span class="preprocessor"></span>    {
04086         <span class="keywordflow">return</span> STATUS_SECTION_TOO_BIG;
04087     }
04088 
04089     <span class="comment">//</span>
04090     <span class="comment">// Create the segment object.</span>
04091     <span class="comment">//</span>
04092 
04093     <span class="comment">//</span>
04094     <span class="comment">// Calculate the number of prototype PTEs to build for this segment.</span>
04095     <span class="comment">//</span>
04096 
04097     NumberOfPtes = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (*MaximumSize);
04098 
04099     <span class="keywordflow">if</span> (AllocationAttributes &amp; SEC_COMMIT) {
04100 
04101         <span class="comment">//</span>
04102         <span class="comment">// Commit the pages for the section.</span>
04103         <span class="comment">//</span>
04104 
04105         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a17">MiChargeCommitment</a> (NumberOfPtes, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
04106             <span class="keywordflow">return</span> STATUS_COMMITMENT_LIMIT;
04107         }
04108         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a264">MM_DBG_COMMIT_PAGEFILE_BACKED_SHMEM</a>, NumberOfPtes);
04109     }
04110 
04111     SizeOfSegment = <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/struct__SEGMENT.html">SEGMENT</a>) + <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>) * ((ULONG)NumberOfPtes - 1);
04112 
04113     NewSegment = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, SizeOfSegment, <a class="code" href="../../d0/d8/creasect_8c.html#a8">MMSECT</a>);
04114 
04115     <span class="keywordflow">if</span> (NewSegment == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04116 
04117         <span class="comment">//</span>
04118         <span class="comment">// The requested pool could not be allocated.</span>
04119         <span class="comment">//</span>
04120 
04121         <span class="keywordflow">if</span> (AllocationAttributes &amp; SEC_COMMIT) {
04122             <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (NumberOfPtes);
04123             <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a293">MM_DBG_COMMIT_RETURN_PAGEFILE_BACKED_SHMEM</a>, NumberOfPtes);
04124         }
04125         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
04126     }
04127 
04128     *Segment = NewSegment;
04129 
04130     ControlArea = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
04131                                  (ULONG)<span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">CONTROL_AREA</a>) +
04132                                                 (ULONG)<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d7/struct__SUBSECTION.html">SUBSECTION</a>),
04133                                          <a class="code" href="../../d0/d8/creasect_8c.html#a6">MMCONTROL</a>);
04134 
04135     <span class="keywordflow">if</span> (ControlArea == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04136 
04137         <span class="comment">//</span>
04138         <span class="comment">// The requested pool could not be allocated.</span>
04139         <span class="comment">//</span>
04140 
04141         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (NewSegment);
04142 
04143         <span class="keywordflow">if</span> (AllocationAttributes &amp; SEC_COMMIT) {
04144             <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a293">MM_DBG_COMMIT_RETURN_PAGEFILE_BACKED_SHMEM</a>, NumberOfPtes);
04145             <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (NumberOfPtes);
04146         }
04147         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
04148     }
04149 
04150     <span class="comment">//</span>
04151     <span class="comment">// Zero control area and first subsection.</span>
04152     <span class="comment">//</span>
04153 
04154     RtlZeroMemory (ControlArea,
04155                    <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a460">CONTROL_AREA</a>) + <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a465">SUBSECTION</a>));
04156 
04157     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o16">NonPagedPoolUsage</a> = <a class="code" href="../../d4/d2/pool_8h.html#a23">EX_REAL_POOL_USAGE</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a460">CONTROL_AREA</a>) + <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a465">SUBSECTION</a>));
04158 
04159     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a> = NewSegment;
04160     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o2">NumberOfSectionReferences</a> = 1;
04161     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o7">NumberOfUserReferences</a> = 1;
04162     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o5">NumberOfSubsections</a> = 1;
04163 
04164     <span class="keywordflow">if</span> (AllocationAttributes &amp; SEC_BASED) {
04165         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Based = 1;
04166     }
04167 
04168     <span class="keywordflow">if</span> (AllocationAttributes &amp; SEC_RESERVE) {
04169         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Reserve = 1;
04170     }
04171 
04172     <span class="keywordflow">if</span> (AllocationAttributes &amp; SEC_COMMIT) {
04173         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Commit = 1;
04174     }
04175 
04176     Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(ControlArea + 1);
04177 
04178     Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a> = ControlArea;
04179     Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> = (ULONG)NumberOfPtes;
04180     Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.Protection = ProtectionMask;
04181 
04182     <span class="comment">//</span>
04183     <span class="comment">// Align the prototype PTEs on the proper boundary.</span>
04184     <span class="comment">//</span>
04185 
04186     PointerPte = &amp;NewSegment-&gt;ThePtes[0];
04187     i = (ULONG) (((ULONG_PTR)PointerPte &gt;&gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>) &amp;
04188                     ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a47">MM_PROTO_PTE_ALIGNMENT</a> / <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) - 1));
04189 
04190     <span class="keywordflow">if</span> (i != 0) {
04191         i = (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a47">MM_PROTO_PTE_ALIGNMENT</a> / <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) - i;
04192     }
04193 
04194     <span class="comment">//</span>
04195     <span class="comment">// Zero the segment header.</span>
04196     <span class="comment">//</span>
04197 
04198     RtlZeroMemory (NewSegment, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/struct__SEGMENT.html">SEGMENT</a>));
04199 
04200     NewSegment-&gt;PrototypePte = &amp;NewSegment-&gt;ThePtes[i];
04201 
04202     NewSegment-&gt;ControlArea = ControlArea;
04203 
04204     <span class="comment">//</span>
04205     <span class="comment">// As size is limited to 2gb, ignore the high part.</span>
04206     <span class="comment">//</span>
04207 
04208     NewSegment-&gt;SizeOfSegment = (ULONG_PTR)NumberOfPtes * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
04209     NewSegment-&gt;TotalNumberOfPtes = (ULONG)NumberOfPtes;
04210     NewSegment-&gt;NonExtendedPtes = (ULONG)NumberOfPtes;
04211 
04212     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o15">PagedPoolUsage</a> = <a class="code" href="../../d4/d2/pool_8h.html#a23">EX_REAL_POOL_USAGE</a>((<span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a455">SEGMENT</a>) + (NumberOfPtes * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>))));
04213 
04214     PointerPte = NewSegment-&gt;PrototypePte;
04215     Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a> = PointerPte;
04216     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>;
04217 
04218     <span class="keywordflow">if</span> (AllocationAttributes &amp; SEC_COMMIT) {
04219         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = ProtectionMask;
04220 
04221         <span class="comment">//</span>
04222         <span class="comment">// Record commitment charging.</span>
04223         <span class="comment">//</span>
04224 
04225         NewSegment-&gt;NumberOfCommittedPages = NumberOfPtes;
04226 
04227         ExAcquireFastMutex (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a677">MmSectionCommitMutex</a>);
04228         <a class="code" href="../../d8/d5/kddata_8c.html#a31">MmSharedCommit</a> += NewSegment-&gt;NumberOfCommittedPages;
04229         ExReleaseFastMutex (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a677">MmSectionCommitMutex</a>);
04230     }
04231 
04232     NewSegment-&gt;SegmentPteTemplate.u.Soft.Protection = ProtectionMask;
04233 
04234     <span class="keywordflow">for</span> (i = 0; i &lt; NumberOfPtes; i += 1) {
04235 
04236         <span class="comment">//</span>
04237         <span class="comment">// Set all the prototype PTEs to either no access or demand zero</span>
04238         <span class="comment">// depending on the commit flag.</span>
04239         <span class="comment">//</span>
04240 
04241         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, TempPte);
04242         PointerPte += 1;
04243     }
04244 
04245     <span class="keywordflow">return</span> STATUS_SUCCESS;
04246 }
04247 
04248 
04249 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04250"></a><a class="code" href="../../d0/d8/creasect_8c.html#a24">04250</a> <a class="code" href="../../d0/d8/creasect_8c.html#a24">NtOpenSection</a> (
04251     OUT PHANDLE SectionHandle,
04252     IN ACCESS_MASK DesiredAccess,
04253     IN POBJECT_ATTRIBUTES ObjectAttributes
04254     )
04255 
04256 <span class="comment">/*++</span>
04257 <span class="comment"></span>
04258 <span class="comment">Routine Description:</span>
04259 <span class="comment"></span>
04260 <span class="comment">    This function opens a handle to a section object with the specified</span>
04261 <span class="comment">    desired access.</span>
04262 <span class="comment"></span>
04263 <span class="comment">Arguments:</span>
04264 <span class="comment"></span>
04265 <span class="comment"></span>
04266 <span class="comment">    Sectionhandle - Supplies a pointer to a variable that will</span>
04267 <span class="comment">                    receive the section object handle value.</span>
04268 <span class="comment"></span>
04269 <span class="comment">    DesiredAccess - Supplies the desired types of access  for the</span>
04270 <span class="comment">                    section.</span>
04271 <span class="comment"></span>
04272 <span class="comment">    DesiredAccess Flags</span>
04273 <span class="comment"></span>
04274 <span class="comment">         EXECUTE - Execute access to the section is desired.</span>
04275 <span class="comment"></span>
04276 <span class="comment">         READ - Read access to the section is desired.</span>
04277 <span class="comment"></span>
04278 <span class="comment">         WRITE - Write access to the section is desired.</span>
04279 <span class="comment"></span>
04280 <span class="comment">    ObjectAttributes - Supplies a pointer to an object attributes structure.</span>
04281 <span class="comment"></span>
04282 <span class="comment">Return Value:</span>
04283 <span class="comment"></span>
04284 <span class="comment">    Returns the status</span>
04285 <span class="comment"></span>
04286 <span class="comment">    TBS</span>
04287 <span class="comment"></span>
04288 <span class="comment"></span>
04289 <span class="comment">--*/</span>
04290 
04291 {
04292     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
04293     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
04294     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04295 
04296     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04297     <span class="comment">//</span>
04298     <span class="comment">// Get previous processor mode and probe output arguments if necessary.</span>
04299     <span class="comment">//</span>
04300 
04301     PreviousMode = KeGetPreviousMode();
04302     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
04303         <span class="keywordflow">try</span> {
04304             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>(SectionHandle);
04305         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
04306             <span class="keywordflow">return</span> GetExceptionCode();
04307         }
04308     }
04309 
04310     <span class="comment">//</span>
04311     <span class="comment">// Open handle to the section object with the specified desired</span>
04312     <span class="comment">// access.</span>
04313     <span class="comment">//</span>
04314 
04315     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a> (<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
04316                                  <a class="code" href="../../d2/d1/mm_8h.html#a133">MmSectionObjectType</a>,
04317                                  PreviousMode,
04318                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04319                                  DesiredAccess,
04320                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04321                                  &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>
04322                                  );
04323 
04324     <span class="keywordflow">try</span> {
04325         *SectionHandle = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
04326     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
04327         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04328     }
04329 
04330     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04331 }
04332 
04333 CCHAR
<a name="l04334"></a><a class="code" href="../../d0/d8/creasect_8c.html#a13">04334</a> <a class="code" href="../../d0/d8/creasect_8c.html#a13">MiGetImageProtection</a> (
04335     IN ULONG SectionCharacteristics
04336     )
04337 
04338 <span class="comment">/*++</span>
04339 <span class="comment"></span>
04340 <span class="comment">Routine Description:</span>
04341 <span class="comment"></span>
04342 <span class="comment">    This function takes a section characteristic mask from the</span>
04343 <span class="comment">    image and converts it to an PTE protection mask.</span>
04344 <span class="comment"></span>
04345 <span class="comment">Arguments:</span>
04346 <span class="comment"></span>
04347 <span class="comment">    SectionCharacteristics - Supplies the characteristics mask from the</span>
04348 <span class="comment">                             image.</span>
04349 <span class="comment"></span>
04350 <span class="comment">Return Value:</span>
04351 <span class="comment"></span>
04352 <span class="comment">    Returns the protection mask for the PTE.</span>
04353 <span class="comment"></span>
04354 <span class="comment">--*/</span>
04355 
04356 {
04357     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
04358     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04359 
04360     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
04361     <span class="keywordflow">if</span> (SectionCharacteristics &amp; IMAGE_SCN_MEM_EXECUTE) {
04362         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> |= 1;
04363     }
04364     <span class="keywordflow">if</span> (SectionCharacteristics &amp; IMAGE_SCN_MEM_READ) {
04365         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> |= 2;
04366     }
04367     <span class="keywordflow">if</span> (SectionCharacteristics &amp; IMAGE_SCN_MEM_WRITE) {
04368         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> |= 4;
04369     }
04370     <span class="keywordflow">if</span> (SectionCharacteristics &amp; IMAGE_SCN_MEM_SHARED) {
04371         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> |= 8;
04372     }
04373 
04374     <span class="keywordflow">return</span> <a class="code" href="../../d0/d8/creasect_8c.html#a10">MmImageProtectionArray</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
04375 }
04376 
04377 PFN_NUMBER
<a name="l04378"></a><a class="code" href="../../d4/d8/mi_8h.html#a809">04378</a> <a class="code" href="../../d4/d8/mi_8h.html#a809">MiGetPageForHeader</a> (
04379     VOID
04380     )
04381 
04382 <span class="comment">/*++</span>
04383 <span class="comment"></span>
04384 <span class="comment">Routine Description:</span>
04385 <span class="comment"></span>
04386 <span class="comment">    This non-pagable function acquires the PFN lock, removes</span>
04387 <span class="comment">    a page and updates the PFN database as though the page was</span>
04388 <span class="comment">    ready to be deleted if the reference count is decremented.</span>
04389 <span class="comment"></span>
04390 <span class="comment">Arguments:</span>
04391 <span class="comment"></span>
04392 <span class="comment">    None.</span>
04393 <span class="comment"></span>
04394 <span class="comment">Return Value:</span>
04395 <span class="comment"></span>
04396 <span class="comment">    Returns the physical page frame number.</span>
04397 <span class="comment"></span>
04398 <span class="comment">--*/</span>
04399 
04400 {
04401     KIRQL OldIrql;
04402     PFN_NUMBER PageFrameNumber;
04403     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
04404     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
04405     ULONG PageColor;
04406 
04407     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
04408     PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a128">MI_PAGE_COLOR_VA_PROCESS</a> ((PVOID)<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a>,
04409                                           &amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o43">NextPageColor</a>);
04410 
04411     <span class="comment">//</span>
04412     <span class="comment">// Lock the PFN database and get a page.</span>
04413     <span class="comment">//</span>
04414 
04415     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
04416 
04417     <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04418 
04419     <span class="comment">//</span>
04420     <span class="comment">// Remove page for 64k alignment.</span>
04421     <span class="comment">//</span>
04422 
04423     PageFrameNumber = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (PageColor);
04424 
04425     <span class="comment">//</span>
04426     <span class="comment">// Increment the reference count for the page so the</span>
04427     <span class="comment">// paging I/O will work, and so this page cannot be stolen from us.</span>
04428     <span class="comment">//</span>
04429 
04430     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameNumber);
04431     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
04432 
04433 <span class="preprocessor">#ifndef PFN_CONSISTENCY</span>
04434 <span class="preprocessor"></span>    <span class="comment">//</span>
04435     <span class="comment">// Don't need the PFN lock for the fields below...</span>
04436     <span class="comment">//</span>
04437     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04438 <span class="preprocessor">#endif</span>
04439 <span class="preprocessor"></span>
04440     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a> = <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>;
04441     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = (PVOID) (ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a>;
04442     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
04443 
04444     <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
04445 
04446     <span class="keywordflow">return</span> PageFrameNumber;
04447 }
04448 
04449 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04450"></a><a class="code" href="../../d4/d8/mi_8h.html#a808">04450</a> <a class="code" href="../../d4/d8/mi_8h.html#a808">MiUpdateImageHeaderPage</a> (
04451     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
04452     IN PFN_NUMBER PageFrameNumber,
04453     IN <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea
04454     )
04455 
04456 <span class="comment">/*++</span>
04457 <span class="comment"></span>
04458 <span class="comment">Routine Description:</span>
04459 <span class="comment"></span>
04460 <span class="comment">    This non-pagable function acquires the PFN lock, and</span>
04461 <span class="comment">    turns the specified prototype PTE into a transition PTE</span>
04462 <span class="comment">    referring to the specified physical page.  It then</span>
04463 <span class="comment">    decrements the reference count causing the page to</span>
04464 <span class="comment">    be placed on the standby or modified list.</span>
04465 <span class="comment"></span>
04466 <span class="comment">Arguments:</span>
04467 <span class="comment"></span>
04468 <span class="comment">    PointerPte - Supplies the PTE to set into the transition state.</span>
04469 <span class="comment"></span>
04470 <span class="comment">    PageFrameNumber - Supplies the physical page.</span>
04471 <span class="comment"></span>
04472 <span class="comment">    ControlArea - Supplies the control area for the prototype PTEs.</span>
04473 <span class="comment"></span>
04474 <span class="comment">Return Value:</span>
04475 <span class="comment"></span>
04476 <span class="comment">    None.</span>
04477 <span class="comment"></span>
04478 <span class="comment">--*/</span>
04479 
04480 {
04481     KIRQL OldIrql;
04482 
04483     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
04484 
04485     <a class="code" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (PointerPte);
04486 
04487     <a class="code" href="../../d8/d2/pagfault_8c.html#a24">MiInitializeTransitionPfn</a> (PageFrameNumber, PointerPte, 0xFFFFFFFF);
04488     ControlArea-&gt;NumberOfPfnReferences += 1;
04489 
04490     <span class="comment">//</span>
04491     <span class="comment">// Add the page to the standby list.</span>
04492     <span class="comment">//</span>
04493 
04494     <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (PageFrameNumber);
04495 
04496     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04497     <span class="keywordflow">return</span>;
04498 }
04499 
04500 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04501"></a><a class="code" href="../../d4/d8/mi_8h.html#a810">04501</a> <a class="code" href="../../d4/d8/mi_8h.html#a810">MiRemoveImageHeaderPage</a> (
04502     IN PFN_NUMBER PageFrameNumber
04503     )
04504 
04505 <span class="comment">/*++</span>
04506 <span class="comment"></span>
04507 <span class="comment">Routine Description:</span>
04508 <span class="comment"></span>
04509 <span class="comment">    This non-pagable function acquires the PFN lock, and decrements</span>
04510 <span class="comment">    the reference count thereby causing the physical page to</span>
04511 <span class="comment">    be deleted.</span>
04512 <span class="comment"></span>
04513 <span class="comment">Arguments:</span>
04514 <span class="comment"></span>
04515 <span class="comment">    PageFrameNumber - Supplies the PFN to decrement.</span>
04516 <span class="comment"></span>
04517 <span class="comment">Return Value:</span>
04518 <span class="comment"></span>
04519 <span class="comment">    None.</span>
04520 <span class="comment"></span>
04521 <span class="comment">--*/</span>
04522 {
04523     KIRQL OldIrql;
04524 
04525     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
04526     <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (PageFrameNumber);
04527     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04528     <span class="keywordflow">return</span>;
04529 }
04530 
04531 <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>
<a name="l04532"></a><a class="code" href="../../d0/d8/creasect_8c.html#a28">04532</a> <a class="code" href="../../d0/d8/creasect_8c.html#a28">MiFindImageSectionObject</a>(
04533     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> File,
04534     OUT PBOOLEAN GlobalNeeded
04535     )
04536 
04537 <span class="comment">/*++</span>
04538 <span class="comment"></span>
04539 <span class="comment">Routine Description:</span>
04540 <span class="comment"></span>
04541 <span class="comment">    This function searches the control area chains (if any) for an existing</span>
04542 <span class="comment">    cache of the specified image file.  For non-global control areas, there is</span>
04543 <span class="comment">    no chain and the control area is shared for all callers and sessions.</span>
04544 <span class="comment">    Likewise for systemwide global control areas.</span>
04545 <span class="comment"></span>
04546 <span class="comment">    However, for global PER-SESSION control areas, we must do the walk.</span>
04547 <span class="comment"></span>
04548 <span class="comment">Arguments:</span>
04549 <span class="comment"></span>
04550 <span class="comment">    File - Supplies the file object for the image file.</span>
04551 <span class="comment"></span>
04552 <span class="comment">    GlobalNeeded - Supplies a pointer to store whether a global control area is</span>
04553 <span class="comment">                   required as a placeholder.  This can only be set when there</span>
04554 <span class="comment">                   is already some global control area in the list - ie: our</span>
04555 <span class="comment">                   caller should only rely on this when this function returns</span>
04556 <span class="comment">                   NULL so the caller knows what kind of control area to</span>
04557 <span class="comment">                   insert.</span>
04558 <span class="comment"></span>
04559 <span class="comment">Return Value:</span>
04560 <span class="comment"></span>
04561 <span class="comment">    Returns the matching control area or NULL if one does not exist.</span>
04562 <span class="comment"></span>
04563 <span class="comment">Environment:</span>
04564 <span class="comment"></span>
04565 <span class="comment">    Must be holding the PFN lock.</span>
04566 <span class="comment"></span>
04567 <span class="comment">--*/</span>
04568 
04569 {
04570     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
04571     <a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">PLARGE_CONTROL_AREA</a> LargeControlArea;
04572     PLIST_ENTRY Head, Next;
04573     ULONG SessionId;
04574 
04575     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
04576 
04577     *GlobalNeeded = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04578 
04579     <span class="comment">//</span>
04580     <span class="comment">// Get first (if any) control area pointer.</span>
04581     <span class="comment">//</span>
04582 
04583     ControlArea = (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)(<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer-&gt;ImageSectionObject);
04584 
04585     <span class="comment">//</span>
04586     <span class="comment">// If no control area, or the control area is not session global,</span>
04587     <span class="comment">// then our job is easy.  Note, however, that they each require different</span>
04588     <span class="comment">// return values as they represent different states.</span>
04589     <span class="comment">//</span>
04590 
04591     <span class="keywordflow">if</span> (ControlArea == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04592         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04593     }
04594 
04595     <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 0) {
04596         <span class="keywordflow">return</span> ControlArea;
04597     }
04598 
04599     LargeControlArea = (<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">PLARGE_CONTROL_AREA</a>) ControlArea;
04600 
04601     <span class="comment">//</span>
04602     <span class="comment">// Get the current session ID and search for a matching control area.</span>
04603     <span class="comment">//</span>
04604 
04605     SessionId = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;SessionId;
04606 
04607     <span class="keywordflow">if</span> (LargeControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o18">SessionId</a> == SessionId) {
04608         <span class="keywordflow">return</span> (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>) LargeControlArea;
04609     }
04610 
04611     <span class="comment">//</span>
04612     <span class="comment">// Must search the control area list for a matching session ID.</span>
04613     <span class="comment">//</span>
04614 
04615     Head = &amp;LargeControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o17">UserGlobalList</a>;
04616 
04617     <span class="keywordflow">for</span> (Next = Head-&gt;Flink; Next != Head; Next = Next-&gt;Flink) {
04618 
04619         LargeControlArea = CONTAINING_RECORD (Next, <a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">LARGE_CONTROL_AREA</a>, UserGlobalList);
04620 
04621         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (LargeControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 1);
04622 
04623         <span class="keywordflow">if</span> (LargeControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o18">SessionId</a> == SessionId) {
04624             <span class="keywordflow">return</span> (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>) LargeControlArea;
04625         }
04626     }
04627 
04628     <span class="comment">//</span>
04629     <span class="comment">// No match, so tell our caller to create a new global control area.</span>
04630     <span class="comment">//</span>
04631 
04632     *GlobalNeeded = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04633 
04634     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04635 }
04636 
04637 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04638"></a><a class="code" href="../../d0/d8/creasect_8c.html#a17">04638</a> <a class="code" href="../../d0/d8/creasect_8c.html#a17">MiInsertImageSectionObject</a>(
04639     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> File,
04640     IN <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> InputControlArea
04641     )
04642 
04643 <span class="comment">/*++</span>
04644 <span class="comment"></span>
04645 <span class="comment">Routine Description:</span>
04646 <span class="comment"></span>
04647 <span class="comment">    This function inserts the control area into the file's section object</span>
04648 <span class="comment">    pointers.  For non-global control areas, there is no chain and the</span>
04649 <span class="comment">    control area is shared for all callers and sessions.</span>
04650 <span class="comment">    Likewise for systemwide global control areas.</span>
04651 <span class="comment"></span>
04652 <span class="comment">    However, for global PER-SESSION control areas, we must do a list insertion.</span>
04653 <span class="comment"></span>
04654 <span class="comment">Arguments:</span>
04655 <span class="comment"></span>
04656 <span class="comment">    File - Supplies the file object for the image file.</span>
04657 <span class="comment"></span>
04658 <span class="comment">    InputControlArea - Supplies the control area to insert.</span>
04659 <span class="comment"></span>
04660 <span class="comment">Return Value:</span>
04661 <span class="comment"></span>
04662 <span class="comment">    None.</span>
04663 <span class="comment"></span>
04664 <span class="comment">Environment:</span>
04665 <span class="comment"></span>
04666 <span class="comment">    Must be holding the PFN lock.</span>
04667 <span class="comment"></span>
04668 <span class="comment">--*/</span>
04669 
04670 {
04671     PLIST_ENTRY Head;
04672     <a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">PLARGE_CONTROL_AREA</a> ControlArea;
04673     <a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">PLARGE_CONTROL_AREA</a> FirstControlArea;
04674 <span class="preprocessor">#if DBG</span>
04675 <span class="preprocessor"></span>    PLIST_ENTRY Next;
04676     <a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">PLARGE_CONTROL_AREA</a> NextControlArea;
04677 <span class="preprocessor">#endif</span>
04678 <span class="preprocessor"></span>
04679     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
04680 
04681     ControlArea = (<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">PLARGE_CONTROL_AREA</a>) InputControlArea;
04682 
04683     <span class="comment">//</span>
04684     <span class="comment">// If this is not a global-per-session control area or just a placeholder</span>
04685     <span class="comment">// control area (with no chain already in place) then just put it in.</span>
04686     <span class="comment">//</span>
04687 
04688     FirstControlArea = (<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">PLARGE_CONTROL_AREA</a>)(<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer-&gt;ImageSectionObject);
04689 
04690     <span class="keywordflow">if</span> (FirstControlArea == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04691         <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 0) {
04692             (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)(<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer-&gt;ImageSectionObject) =
04693                                                     (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>) ControlArea;
04694             <span class="keywordflow">return</span>;
04695         }
04696     }
04697 
04698     <span class="comment">//</span>
04699     <span class="comment">// A per-session control area needs to be inserted...</span>
04700     <span class="comment">//</span>
04701 
04702     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 1);
04703 
04704     ControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o18">SessionId</a> = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;SessionId;
04705 
04706     <span class="comment">//</span>
04707     <span class="comment">// If the control area list is empty, just initialize links for this entry.</span>
04708     <span class="comment">//</span>
04709 
04710     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer-&gt;ImageSectionObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04711         InitializeListHead (&amp;ControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o17">UserGlobalList</a>);
04712     }
04713     <span class="keywordflow">else</span> {
04714 
04715         <span class="comment">//</span>
04716         <span class="comment">// Insert new entry before the current first entry.  The control area</span>
04717         <span class="comment">// must be in the midst of creation/deletion or have a valid session</span>
04718         <span class="comment">// ID to be inserted.</span>
04719         <span class="comment">//</span>
04720 
04721         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o10">u</a>.Flags.BeingDeleted ||
04722                 ControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o10">u</a>.Flags.BeingCreated ||
04723                 ControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o18">SessionId</a> != (ULONG)-1);
04724 
04725         FirstControlArea = (<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">PLARGE_CONTROL_AREA</a>)(<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer-&gt;ImageSectionObject);
04726 
04727         Head = &amp;FirstControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o17">UserGlobalList</a>;
04728 
04729 <span class="preprocessor">#if DBG</span>
04730 <span class="preprocessor"></span>        <span class="comment">//</span>
04731         <span class="comment">// Ensure no duplicate session IDs exist in the list.</span>
04732         <span class="comment">//</span>
04733 
04734         <span class="keywordflow">for</span> (Next = Head-&gt;Flink; Next != Head; Next = Next-&gt;Flink) {
04735             NextControlArea = CONTAINING_RECORD (Next, <a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">LARGE_CONTROL_AREA</a>, UserGlobalList);
04736             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NextControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o18">SessionId</a> != (ULONG)-1 &amp;&amp;
04737                     NextControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o18">SessionId</a> != ControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o18">SessionId</a>);
04738         }
04739 <span class="preprocessor">#endif</span>
04740 <span class="preprocessor"></span>
04741         InsertTailList (Head, &amp;ControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o17">UserGlobalList</a>);
04742     }
04743 
04744     <span class="comment">//</span>
04745     <span class="comment">// Update first control area pointer.</span>
04746     <span class="comment">//</span>
04747 
04748     (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)(<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer-&gt;ImageSectionObject) =
04749                                                 (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>) ControlArea;
04750 }
04751 
04752 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04753"></a><a class="code" href="../../d4/d8/mi_8h.html#a914">04753</a> <a class="code" href="../../d4/d8/mi_8h.html#a914">MiRemoveImageSectionObject</a>(
04754     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> File,
04755     IN <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> InputControlArea
04756     )
04757 
04758 <span class="comment">/*++</span>
04759 <span class="comment"></span>
04760 <span class="comment">Routine Description:</span>
04761 <span class="comment"></span>
04762 <span class="comment">    This function searches the control area chains (if any) for an existing</span>
04763 <span class="comment">    cache of the specified image file.  For non-global control areas, there is</span>
04764 <span class="comment">    no chain and the control area is shared for all callers and sessions.</span>
04765 <span class="comment">    Likewise for systemwide global control areas.</span>
04766 <span class="comment"></span>
04767 <span class="comment">    However, for global PER-SESSION control areas, we must do the walk.</span>
04768 <span class="comment"></span>
04769 <span class="comment">    Upon finding the specified control area, we unlink it.</span>
04770 <span class="comment"></span>
04771 <span class="comment">Arguments:</span>
04772 <span class="comment"></span>
04773 <span class="comment">    File - Supplies the file object for the image file.</span>
04774 <span class="comment"></span>
04775 <span class="comment">    InputControlArea - Supplies the control area to remove.</span>
04776 <span class="comment"></span>
04777 <span class="comment">Return Value:</span>
04778 <span class="comment"></span>
04779 <span class="comment">    None.</span>
04780 <span class="comment"></span>
04781 <span class="comment">Environment:</span>
04782 <span class="comment"></span>
04783 <span class="comment">    Must be holding the PFN lock.</span>
04784 <span class="comment"></span>
04785 <span class="comment">--*/</span>
04786 
04787 {
04788     PLIST_ENTRY Head, Next;
04789     <a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">PLARGE_CONTROL_AREA</a> ControlArea;
04790     <a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">PLARGE_CONTROL_AREA</a> FirstControlArea;
04791     <a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">PLARGE_CONTROL_AREA</a> NextControlArea;
04792 
04793     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
04794 
04795     ControlArea = (<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">PLARGE_CONTROL_AREA</a>) InputControlArea;
04796 
04797     FirstControlArea = (<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">PLARGE_CONTROL_AREA</a>)(<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer-&gt;ImageSectionObject);
04798 
04799     <span class="comment">//</span>
04800     <span class="comment">// Get a pointer to the first control area.  If this is not a</span>
04801     <span class="comment">// global-per-session control area, then there is no list, so we're done.</span>
04802     <span class="comment">//</span>
04803 
04804     <span class="keywordflow">if</span> (FirstControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 0) {
04805         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 0);
04806 
04807         (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)(<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer-&gt;ImageSectionObject) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04808         <span class="keywordflow">return</span>;
04809     }
04810 
04811     <span class="comment">//</span>
04812     <span class="comment">// A list may exist.  Walk it as necessary and delete the requested entry.</span>
04813     <span class="comment">//</span>
04814 
04815     <span class="keywordflow">if</span> (FirstControlArea == ControlArea) {
04816 
04817         <span class="comment">//</span>
04818         <span class="comment">// The first entry is the one to remove.  If it is the only entry</span>
04819         <span class="comment">// in the list, then the new first entry pointer will be NULL.</span>
04820         <span class="comment">// Otherwise, get a pointer to the next entry and unlink the current.</span>
04821         <span class="comment">//</span>
04822 
04823         <span class="keywordflow">if</span> (IsListEmpty (&amp;FirstControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o17">UserGlobalList</a>)) {
04824             NextControlArea = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04825         } <span class="keywordflow">else</span> {
04826             Next = FirstControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o17">UserGlobalList</a>.Flink;
04827             RemoveEntryList (&amp;FirstControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o17">UserGlobalList</a>);
04828             NextControlArea = CONTAINING_RECORD (Next,
04829                                                  <a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">LARGE_CONTROL_AREA</a>,
04830                                                  UserGlobalList);
04831 
04832             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NextControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 1);
04833         }
04834 
04835         (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)(<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer-&gt;ImageSectionObject) =
04836                                             (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>) NextControlArea;
04837         <span class="keywordflow">return</span>;
04838     }
04839 
04840     <span class="comment">//</span>
04841     <span class="comment">// Remove the entry, note that the ImageSectionObject need not be updated</span>
04842     <span class="comment">// as the entry is not at the head.</span>
04843     <span class="comment">//</span>
04844 
04845 <span class="preprocessor">#if DBG</span>
04846 <span class="preprocessor"></span>    Head = &amp;FirstControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o17">UserGlobalList</a>;
04847 
04848     <span class="keywordflow">for</span> (Next = Head-&gt;Flink; Next != Head; Next = Next-&gt;Flink) {
04849 
04850         NextControlArea = CONTAINING_RECORD (Next,
04851                                              <a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">LARGE_CONTROL_AREA</a>,
04852                                              UserGlobalList);
04853 
04854         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NextControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 1);
04855 
04856         <span class="keywordflow">if</span> (NextControlArea == ControlArea) {
04857             <span class="keywordflow">break</span>;
04858         }
04859     }
04860     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Next != Head);
04861 <span class="preprocessor">#endif</span>
04862 <span class="preprocessor"></span>
04863     RemoveEntryList (&amp;ControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o17">UserGlobalList</a>);
04864 }
04865 
04866 
04867 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04868"></a><a class="code" href="../../d4/d8/mi_8h.html#a812">04868</a> <a class="code" href="../../d4/d8/mi_8h.html#a812">MiGetWritablePagesInSection</a>(
04869     IN PSECTION Section,
04870     OUT PULONG WritablePages
04871     )
04872 
04873 <span class="comment">/*++</span>
04874 <span class="comment"></span>
04875 <span class="comment">Routine Description:</span>
04876 <span class="comment"></span>
04877 <span class="comment">    This routine calculates the number of writable pages in the image.</span>
04878 <span class="comment"></span>
04879 <span class="comment">Arguments:</span>
04880 <span class="comment"></span>
04881 <span class="comment">    Section - Supplies the section for the image.</span>
04882 <span class="comment"></span>
04883 <span class="comment">    WritablePages - Supplies a pointer to fill with the</span>
04884 <span class="comment">                    number of writable pages.</span>
04885 <span class="comment"></span>
04886 <span class="comment">Return Value:</span>
04887 <span class="comment"></span>
04888 <span class="comment">    STATUS_SUCCESS if all went well, otherwise various NTSTATUS error codes.</span>
04889 <span class="comment"></span>
04890 <span class="comment">Environment:</span>
04891 <span class="comment"></span>
04892 <span class="comment">    Kernel mode, APC_LEVEL and below, MmSystemLoadLock held.</span>
04893 <span class="comment"></span>
04894 <span class="comment">--*/</span>
04895 
04896 {
04897     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04898     PVOID ViewBase;
04899     SIZE_T ViewSize;
04900     ULONG PagesInSubsection;
04901     ULONG Protection;
04902     ULONG NumberOfSubsections;
04903     ULONG OffsetToSectionTable;
04904     ULONG SectionVirtualSize;
04905     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
04906     LARGE_INTEGER SectionOffset;
04907     PIMAGE_DOS_HEADER DosHeader;
04908     PIMAGE_NT_HEADERS NtHeader;
04909     PIMAGE_SECTION_HEADER SectionTableEntry;
04910 
04911     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04912 
04913     ViewBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04914     ViewSize = 0;
04915     SectionOffset.QuadPart = 0;
04916 
04917     *WritablePages = 0;
04918 
04919     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
04920 
04921     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a21">MmMapViewOfSection</a> (Section,
04922                                  Process,
04923                                  &amp;ViewBase,
04924                                  0,
04925                                  0,
04926                                  &amp;SectionOffset,
04927                                  &amp;ViewSize,
04928                                  ViewUnmap,
04929                                  0,
04930                                  PAGE_EXECUTE);
04931 
04932     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
04933         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04934     }
04935 
04936     <span class="comment">//</span>
04937     <span class="comment">// The DLL is mapped as a data file not as an image.  Pull apart the</span>
04938     <span class="comment">// executable header.  The security checks have already been</span>
04939     <span class="comment">// done as part of creating the section in the first place.</span>
04940     <span class="comment">//</span>
04941 
04942     DosHeader = (PIMAGE_DOS_HEADER) ViewBase;
04943 
04944     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DosHeader-&gt;e_magic == IMAGE_DOS_SIGNATURE);
04945 
04946 <span class="preprocessor">#ifndef i386</span>
04947 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((ULONG)DosHeader-&gt;e_lfanew &amp; 3) == 0);
04948 <span class="preprocessor">#endif</span>
04949 <span class="preprocessor"></span>
04950     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((ULONG)DosHeader-&gt;e_lfanew &lt;= ViewSize);
04951 
04952     NtHeader = (PIMAGE_NT_HEADERS)((PCHAR)DosHeader +
04953                                       (ULONG)DosHeader-&gt;e_lfanew);
04954 
04955     OffsetToSectionTable = <span class="keyword">sizeof</span>(ULONG) +
04956                               <span class="keyword">sizeof</span>(IMAGE_FILE_HEADER) +
04957                               NtHeader-&gt;FileHeader.SizeOfOptionalHeader;
04958 
04959     SectionTableEntry = (PIMAGE_SECTION_HEADER)((PCHAR)NtHeader +
04960                                 OffsetToSectionTable);
04961 
04962     NumberOfSubsections = NtHeader-&gt;FileHeader.NumberOfSections;
04963 
04964     <span class="keywordflow">while</span> (NumberOfSubsections &gt; 0) {
04965 
04966         Protection = <a class="code" href="../../d0/d8/creasect_8c.html#a13">MiGetImageProtection</a> (SectionTableEntry-&gt;Characteristics);
04967 
04968         <span class="keywordflow">if</span> (Protection &amp; <a class="code" href="../../d4/d8/mi_8h.html#a51">MM_PROTECTION_WRITE_MASK</a>) {
04969 
04970             <span class="comment">//</span>
04971             <span class="comment">// Handle the case where the virtual size is 0.</span>
04972             <span class="comment">//</span>
04973 
04974             <span class="keywordflow">if</span> (SectionTableEntry-&gt;Misc.VirtualSize == 0) {
04975                 SectionVirtualSize = SectionTableEntry-&gt;SizeOfRawData;
04976             } <span class="keywordflow">else</span> {
04977                 SectionVirtualSize = SectionTableEntry-&gt;Misc.VirtualSize;
04978             }
04979 
04980             PagesInSubsection =
04981                 <a class="code" href="../../d4/d8/mi_8h.html#a90">MI_ROUND_TO_SIZE</a> (SectionVirtualSize, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
04982 
04983             *WritablePages += PagesInSubsection;
04984         }
04985 
04986         SectionTableEntry += 1;
04987         NumberOfSubsections -= 1;
04988     }
04989 
04990     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d9/umapview_8c.html#a1">MmUnmapViewOfSection</a> (Process, ViewBase);
04991 
04992     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
04993 
04994     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04995 }
04996 
04997 
04998 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04999"></a><a class="code" href="../../d0/d8/creasect_8c.html#a18">04999</a> <a class="code" href="../../d0/d8/creasect_8c.html#a18">MiFlushDataSection</a>(
05000     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> File
05001     )
05002 
05003 <span class="comment">/*++</span>
05004 <span class="comment"></span>
05005 <span class="comment">Routine Description:</span>
05006 <span class="comment"></span>
05007 <span class="comment">    This routine flushes the data section if there is one.</span>
05008 <span class="comment"></span>
05009 <span class="comment">Arguments:</span>
05010 <span class="comment"></span>
05011 <span class="comment">    File - Supplies the file object.</span>
05012 <span class="comment"></span>
05013 <span class="comment">Return Value:</span>
05014 <span class="comment"></span>
05015 <span class="comment">    None.</span>
05016 <span class="comment"></span>
05017 <span class="comment">Environment:</span>
05018 <span class="comment"></span>
05019 <span class="comment">    Kernel mode, APC_LEVEL and below.</span>
05020 <span class="comment"></span>
05021 <span class="comment">--*/</span>
05022 
05023 {
05024     KIRQL OldIrql;
05025     IO_STATUS_BLOCK IoStatus;
05026     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
05027 
05028     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
05029 
05030     ControlArea = (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>) <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer-&gt;DataSectionObject;
05031 
05032     <span class="keywordflow">if</span> (ControlArea) {
05033         <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o14">NumberOfSystemCacheViews</a>) {
05034             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
05035             <a class="code" href="../../d4/d2/cache_8h.html#a63">CcFlushCache</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer,
05036                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
05037                           0,
05038                           &amp;IoStatus);
05039 
05040         } <span class="keywordflow">else</span> {
05041             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
05042             <a class="code" href="../../d6/d5/flushsec_8c.html#a8">MmFlushSection</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer,
05043                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
05044                             0,
05045                             &amp;IoStatus,
05046                             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
05047         }
05048     }
05049     <span class="keywordflow">else</span> {
05050         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
05051     }
05052 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:35 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
