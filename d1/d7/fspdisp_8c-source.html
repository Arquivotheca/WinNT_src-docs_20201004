<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: fspdisp.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>fspdisp.c</h1><a href="../../d0/d8/fspdisp_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    FspDisp.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the main dispatch procedure/thread for the Udfs</span>
00012 <span class="comment">    Fsp</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Dan Lovinger    [DanLo]     23-Sep-1996</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include "UdfProcs.h"</span>
00023 
00024 <span class="comment">//</span>
00025 <span class="comment">//  The Bug check file id for this module</span>
00026 <span class="comment">//</span>
00027 
<a name="l00028"></a><a class="code" href="../../d0/d8/fspdisp_8c.html#a0">00028</a> <span class="preprocessor">#define BugCheckFileId                   (UDFS_BUG_CHECK_FSPDISP)</span>
00029 <span class="preprocessor"></span>
00030 <span class="comment">//</span>
00031 <span class="comment">//  The local debug trace level</span>
00032 <span class="comment">//</span>
00033 
<a name="l00034"></a><a class="code" href="../../d0/d8/fspdisp_8c.html#a1">00034</a> <span class="preprocessor">#define Dbg                              (UDFS_DEBUG_LEVEL_FSPDISP)</span>
00035 <span class="preprocessor"></span>
00036 
00037 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00038"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a249">00038</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a249">UdfFspDispatch</a> (
00039     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext
00040     )
00041 
00042 <span class="comment">/*++</span>
00043 <span class="comment"></span>
00044 <span class="comment">Routine Description:</span>
00045 <span class="comment"></span>
00046 <span class="comment">    This is the main FSP thread routine that is executed to receive</span>
00047 <span class="comment">    and dispatch IRP requests.  Each FSP thread begins its execution here.</span>
00048 <span class="comment">    There is one thread created at system initialization time and subsequent</span>
00049 <span class="comment">    threads created as needed.</span>
00050 <span class="comment"></span>
00051 <span class="comment">Arguments:</span>
00052 <span class="comment"></span>
00053 <span class="comment">    IrpContext - IrpContext for a request to process.</span>
00054 <span class="comment"></span>
00055 <span class="comment">Return Value:</span>
00056 <span class="comment"></span>
00057 <span class="comment">    None</span>
00058 <span class="comment"></span>
00059 <span class="comment">--*/</span>
00060 
00061 {
00062     <a class="code" href="../../d0/d1/struct__THREAD__CONTEXT.html">THREAD_CONTEXT</a> <a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>;
00063     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00064 
00065     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = IrpContext-&gt;Irp;
00066     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00067 
00068     <a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html">PVOLUME_DEVICE_OBJECT</a> VolDo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00069 
00070     <span class="comment">//</span>
00071     <span class="comment">//  If this request has an associated volume device object, remember it.</span>
00072     <span class="comment">//</span>
00073 
00074     <span class="keywordflow">if</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00075 
00076         VolDo = CONTAINING_RECORD( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o57">DeviceObject</a>,
00077                                    <a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html">VOLUME_DEVICE_OBJECT</a>,
00078                                    DeviceObject );
00079     }
00080 
00081     <span class="comment">//</span>
00082     <span class="comment">//  Now case on the function code.  For each major function code,</span>
00083     <span class="comment">//  either call the appropriate worker routine.  This routine that</span>
00084     <span class="comment">//  we call is responsible for completing the IRP, and not us.</span>
00085     <span class="comment">//  That way the routine can complete the IRP and then continue</span>
00086     <span class="comment">//  post processing as required.  For example, a read can be</span>
00087     <span class="comment">//  satisfied right away and then read can be done.</span>
00088     <span class="comment">//</span>
00089     <span class="comment">//  We'll do all of the work within an exception handler that</span>
00090     <span class="comment">//  will be invoked if ever some underlying operation gets into</span>
00091     <span class="comment">//  trouble.</span>
00092     <span class="comment">//</span>
00093 
00094     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00095 
00096         <span class="comment">//</span>
00097         <span class="comment">//  Set all the flags indicating we are in the Fsp.</span>
00098         <span class="comment">//</span>
00099 
00100         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a42">IRP_CONTEXT_FSP_FLAGS</a> );
00101 
00102         <a class="code" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>();
00103 
00104         <a class="code" href="../../d3/d8/udfprocs_8h.html#a130">UdfSetThreadContext</a>( IrpContext, &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a> );
00105 
00106         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00107 
00108             <span class="keywordflow">try</span> {
00109 
00110                 <span class="comment">//</span>
00111                 <span class="comment">//  Reinitialize for the next try at completing this</span>
00112                 <span class="comment">//  request.</span>
00113                 <span class="comment">//</span>
00114 
00115                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> =
00116                 IrpContext-&gt;ExceptionStatus = STATUS_SUCCESS;
00117 
00118                 <span class="comment">//</span>
00119                 <span class="comment">//  Initialize the Io status field in the Irp.</span>
00120                 <span class="comment">//</span>
00121 
00122                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = STATUS_SUCCESS;
00123                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = 0;
00124 
00125                 <span class="comment">//</span>
00126                 <span class="comment">//  Case on the major irp code.</span>
00127                 <span class="comment">//</span>
00128 
00129                 <span class="keywordflow">switch</span> (IrpContext-&gt;MajorFunction) {
00130 
00131                     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a31">IRP_MJ_CLEANUP</a> :
00132                         
00133                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a251">UdfCommonCleanup</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00134                         <span class="keywordflow">break</span>;
00135         
00136                     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a15">IRP_MJ_CLOSE</a> :
00137 
00138                         <span class="comment">//</span>
00139                         <span class="comment">//  Closes should never be posted.</span>
00140                         <span class="comment">//</span>
00141                         
00142                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00143                         <span class="keywordflow">break</span>;
00144 
00145                     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a13">IRP_MJ_CREATE</a> :
00146                         
00147                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a253">UdfCommonCreate</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00148                         <span class="keywordflow">break</span>;
00149         
00150                     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a27">IRP_MJ_DEVICE_CONTROL</a> :
00151     
00152                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a254">UdfCommonDevControl</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00153                         <span class="keywordflow">break</span>;
00154     
00155                     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a25">IRP_MJ_DIRECTORY_CONTROL</a> :
00156     
00157                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a255">UdfCommonDirControl</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00158                         <span class="keywordflow">break</span>;
00159     
00160                     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a26">IRP_MJ_FILE_SYSTEM_CONTROL</a> :
00161     
00162                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a256">UdfCommonFsControl</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00163                         <span class="keywordflow">break</span>;
00164     
00165                     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a30">IRP_MJ_LOCK_CONTROL</a> :
00166 
00167                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a257">UdfCommonLockControl</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00168                         <span class="keywordflow">break</span>;
00169 
00170                     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a> :
00171 
00172                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00173                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a258">UdfCommonPnp</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00174                         <span class="keywordflow">break</span>;
00175 
00176                     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a18">IRP_MJ_QUERY_INFORMATION</a> :
00177 
00178                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a259">UdfCommonQueryInfo</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00179                         <span class="keywordflow">break</span>;
00180                 
00181                     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a23">IRP_MJ_QUERY_VOLUME_INFORMATION</a> :
00182 
00183                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d6/volinfo_8c.html#a6">UdfCommonQueryVolInfo</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00184                         <span class="keywordflow">break</span>;
00185                 
00186                     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a16">IRP_MJ_READ</a> :
00187     
00188                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a261">UdfCommonRead</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00189                         <span class="keywordflow">break</span>;
00190     
00191                     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a19">IRP_MJ_SET_INFORMATION</a> :
00192                 
00193                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a262">UdfCommonSetInfo</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00194                         <span class="keywordflow">break</span>;
00195                 
00196                     <span class="keywordflow">default</span> :
00197     
00198                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_DEVICE_REQUEST;
00199                         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00200                 }
00201 
00202             } except( <a class="code" href="../../d3/d8/udfprocs_8h.html#a127">UdfExceptionFilter</a>( IrpContext, GetExceptionInformation() )) {
00203 
00204                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a128">UdfProcessException</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, GetExceptionCode() );
00205             }
00206 
00207             <span class="comment">//</span>
00208             <span class="comment">//  Break out of the loop if we didn't get CANT_WAIT.</span>
00209             <span class="comment">//</span>
00210 
00211             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_CANT_WAIT) { <span class="keywordflow">break</span>; }
00212 
00213             <span class="comment">//</span>
00214             <span class="comment">//  We are retrying this request.  Cleanup the IrpContext for the retry.</span>
00215             <span class="comment">//</span>
00216 
00217             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a29">IRP_CONTEXT_FLAG_MORE_PROCESSING</a> );
00218             <a class="code" href="../../d3/d8/udfprocs_8h.html#a208">UdfCleanupIrpContext</a>( IrpContext, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00219         }
00220 
00221         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00222 
00223         <span class="comment">//</span>
00224         <span class="comment">//  If there are any entries on this volume's overflow queue, service</span>
00225         <span class="comment">//  them.</span>
00226         <span class="comment">//</span>
00227 
00228         <span class="keywordflow">if</span> (VolDo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00229 
00230             KIRQL SavedIrql;
00231             PVOID Entry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00232 
00233             <span class="comment">//</span>
00234             <span class="comment">//  We have a volume device object so see if there is any work</span>
00235             <span class="comment">//  left to do in its overflow queue.</span>
00236             <span class="comment">//</span>
00237 
00238             <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a>( &amp;VolDo-&gt;<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html#o4">OverflowQueueSpinLock</a>, &amp;SavedIrql );
00239 
00240             <span class="keywordflow">if</span> (VolDo-&gt;<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html#o2">OverflowQueueCount</a> &gt; 0) {
00241 
00242                 <span class="comment">//</span>
00243                 <span class="comment">//  There is overflow work to do in this volume so we'll</span>
00244                 <span class="comment">//  decrement the Overflow count, dequeue the IRP, and release</span>
00245                 <span class="comment">//  the Event</span>
00246                 <span class="comment">//</span>
00247 
00248                 VolDo-&gt;<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html#o2">OverflowQueueCount</a> -= 1;
00249 
00250                 Entry = RemoveHeadList( &amp;VolDo-&gt;<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html#o3">OverflowQueue</a> );
00251             }
00252 
00253             <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a>( &amp;VolDo-&gt;<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html#o4">OverflowQueueSpinLock</a>, SavedIrql );
00254 
00255             <span class="comment">//</span>
00256             <span class="comment">//  There wasn't an entry, break out of the loop and return to</span>
00257             <span class="comment">//  the Ex Worker thread.</span>
00258             <span class="comment">//</span>
00259 
00260             <span class="keywordflow">if</span> (Entry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) { <span class="keywordflow">break</span>; }
00261 
00262             <span class="comment">//</span>
00263             <span class="comment">//  Extract the IrpContext , Irp, set wait to TRUE, and loop.</span>
00264             <span class="comment">//</span>
00265 
00266             IrpContext = CONTAINING_RECORD( Entry,
00267                                             <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">IRP_CONTEXT</a>,
00268                                             WorkQueueItem.List );
00269 
00270             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = IrpContext-&gt;Irp;
00271             IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00272 
00273             <span class="keywordflow">continue</span>;
00274         }
00275 
00276         <span class="keywordflow">break</span>;
00277     }
00278 
00279     <span class="comment">//</span>
00280     <span class="comment">//  Decrement the PostedRequestCount if there was a volume device object.</span>
00281     <span class="comment">//</span>
00282 
00283     <span class="keywordflow">if</span> (VolDo) {
00284 
00285         InterlockedDecrement( &amp;VolDo-&gt;<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html#o1">PostedRequestCount</a> );
00286     }
00287 
00288     <span class="keywordflow">return</span>;
00289 }
00290 
00291 
00292 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:04 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
