<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: profobj.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>profobj.c</h1><a href="../../d0/d8/profobj_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    profobj.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the kernel Profile Object. Functions are</span>
00012 <span class="comment">    provided to initialize, start, and stop profile objects and to set</span>
00013 <span class="comment">    and query the profile interval.</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    Bryan M. Willman (bryanwi) 19-Sep-1990</span>
00018 <span class="comment"></span>
00019 <span class="comment">Environment:</span>
00020 <span class="comment"></span>
00021 <span class="comment">    Kernel mode only.</span>
00022 <span class="comment"></span>
00023 <span class="comment">Revision History:</span>
00024 <span class="comment"></span>
00025 <span class="comment">--*/</span>
00026 
00027 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00028 
00029 <span class="comment">//</span>
00030 <span class="comment">// The following assert macro is used to check that an input profile object is</span>
00031 <span class="comment">// really a kprofile and not something else, like deallocated pool.</span>
00032 <span class="comment">//</span>
00033 
<a name="l00034"></a><a class="code" href="../../d0/d8/profobj_8c.html#a0">00034</a> <span class="preprocessor">#define ASSERT_PROFILE(E) {             \</span>
00035 <span class="preprocessor">    ASSERT((E)-&gt;Type == ProfileObject); \</span>
00036 <span class="preprocessor">}</span>
00037 <span class="preprocessor"></span>
00038 <span class="comment">//</span>
00039 <span class="comment">// Structure representing an active profile source</span>
00040 <span class="comment">//</span>
<a name="l00041"></a><a class="code" href="../../d0/d5/struct__KACTIVE__PROFILE__SOURCE.html">00041</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/d5/struct__KACTIVE__PROFILE__SOURCE.html">_KACTIVE_PROFILE_SOURCE</a> {
<a name="l00042"></a><a class="code" href="../../d0/d5/struct__KACTIVE__PROFILE__SOURCE.html#o0">00042</a>     LIST_ENTRY <a class="code" href="../../d0/d5/struct__KACTIVE__PROFILE__SOURCE.html#o0">ListEntry</a>;
<a name="l00043"></a><a class="code" href="../../d0/d5/struct__KACTIVE__PROFILE__SOURCE.html#o1">00043</a>     KPROFILE_SOURCE <a class="code" href="../../d0/d5/struct__KACTIVE__PROFILE__SOURCE.html#o1">Source</a>;
<a name="l00044"></a><a class="code" href="../../d0/d5/struct__KACTIVE__PROFILE__SOURCE.html#o2">00044</a>     KAFFINITY <a class="code" href="../../d0/d5/struct__KACTIVE__PROFILE__SOURCE.html#o2">Affinity</a>;
<a name="l00045"></a><a class="code" href="../../d0/d5/struct__KACTIVE__PROFILE__SOURCE.html#o3">00045</a>     ULONG <a class="code" href="../../d0/d5/struct__KACTIVE__PROFILE__SOURCE.html#o3">ProcessorCount</a>[1];            <span class="comment">// variable-sized, one per processor</span>
00046 } <a class="code" href="../../d0/d5/struct__KACTIVE__PROFILE__SOURCE.html">KACTIVE_PROFILE_SOURCE</a>, *<a class="code" href="../../d0/d5/struct__KACTIVE__PROFILE__SOURCE.html">PKACTIVE_PROFILE_SOURCE</a>;
00047 
00048 <span class="comment">//</span>
00049 <span class="comment">// Prototypes for IPI target functions</span>
00050 <span class="comment">//</span>
00051 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00052 <a class="code" href="../../d0/d8/profobj_8c.html#a3">KiStartProfileInterrupt</a> (
00053     IN PKIPI_CONTEXT SignalDone,
00054     IN PVOID Parameter1,
00055     IN PVOID Parameter2,
00056     IN PVOID Parameter3
00057     );
00058 
00059 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00060 <a class="code" href="../../d0/d8/profobj_8c.html#a4">KiStopProfileInterrupt</a> (
00061     IN PKIPI_CONTEXT SignalDone,
00062     IN PVOID Parameter1,
00063     IN PVOID Parameter2,
00064     IN PVOID Parameter3
00065     );
00066 
00067 
00068 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00069"></a><a class="code" href="../../d0/d8/profobj_8c.html#a5">00069</a> <a class="code" href="../../d0/d8/profobj_8c.html#a5">KeInitializeProfile</a> (
00070     IN <a class="code" href="../../d6/d7/struct__KPROFILE.html">PKPROFILE</a> Profile,
00071     IN <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process OPTIONAL,
00072     IN PVOID RangeBase,
00073     IN SIZE_T RangeSize,
00074     IN ULONG BucketSize,
00075     IN ULONG Segment,
00076     IN KPROFILE_SOURCE ProfileSource,
00077     IN KAFFINITY ProfileAffinity
00078     )
00079 
00080 <span class="comment">/*++</span>
00081 <span class="comment"></span>
00082 <span class="comment">Routine Description:</span>
00083 <span class="comment"></span>
00084 <span class="comment">    This function initializes a kernel profile object. The process,</span>
00085 <span class="comment">    address range, bucket size, and buffer are set. The profile is</span>
00086 <span class="comment">    set to the stopped state.</span>
00087 <span class="comment"></span>
00088 <span class="comment">Arguments:</span>
00089 <span class="comment"></span>
00090 <span class="comment">    Profile - Supplies a pointer to control object of type profile.</span>
00091 <span class="comment"></span>
00092 <span class="comment">    Process - Supplies an optional pointer to a process object that</span>
00093 <span class="comment">        describes the address space to profile. If not specified,</span>
00094 <span class="comment">        then all address spaces are included in the profile.</span>
00095 <span class="comment"></span>
00096 <span class="comment">    RangeBase - Supplies the address of the first byte of the address</span>
00097 <span class="comment">        range for which profiling information is to be collected.</span>
00098 <span class="comment"></span>
00099 <span class="comment">    RangeSize - Supplies the size of the address range for which profiling</span>
00100 <span class="comment">        information is to be collected.  The RangeBase and RangeSize</span>
00101 <span class="comment">        parameters are interpreted such that RangeBase &lt;= address &lt;</span>
00102 <span class="comment">        RangeBase + RangeSize generates a profile hit.</span>
00103 <span class="comment"></span>
00104 <span class="comment">    BucketSize - Supplies the log base 2 of the size of a profiling bucket.</span>
00105 <span class="comment">        Thus, BucketSize = 2 yields 4-byte buckets, BucketSize = 7 yields</span>
00106 <span class="comment">        128-byte buckets.</span>
00107 <span class="comment"></span>
00108 <span class="comment">    Segment - Supplies the non-Flat code segment to profile.  If this</span>
00109 <span class="comment">        is zero, then the flat profiling is done.  This will only</span>
00110 <span class="comment">        be non-zero on an x86 machine.</span>
00111 <span class="comment"></span>
00112 <span class="comment">    ProfileSource - Supplies the profile interrupt source.</span>
00113 <span class="comment"></span>
00114 <span class="comment">    ProfileAffinity - Supplies the set of processor to count hits for.</span>
00115 <span class="comment"></span>
00116 <span class="comment">Return Value:</span>
00117 <span class="comment"></span>
00118 <span class="comment">    None.</span>
00119 <span class="comment"></span>
00120 <span class="comment">--*/</span>
00121 
00122 {
00123 
00124 <span class="preprocessor">#if !defined(i386)</span>
00125 <span class="preprocessor"></span>
00126     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Segment == 0);
00127 
00128 <span class="preprocessor">#endif</span>
00129 <span class="preprocessor"></span>
00130     <span class="comment">//</span>
00131     <span class="comment">// Initialize the standard control object header.</span>
00132     <span class="comment">//</span>
00133 
00134     Profile-&gt;Type = <a class="code" href="../../d4/d9/ke_8h.html#a402a180">ProfileObject</a>;
00135     Profile-&gt;Size = <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__KPROFILE.html">KPROFILE</a>);
00136 
00137     <span class="comment">//</span>
00138     <span class="comment">// Initialize the process address space, range base, range limit,</span>
00139     <span class="comment">// bucket shift count, and set started FALSE.</span>
00140     <span class="comment">//</span>
00141 
00142     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Process)) {
00143         Profile-&gt;Process = Process;
00144 
00145     } <span class="keywordflow">else</span> {
00146         Profile-&gt;Process = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00147     }
00148 
00149     Profile-&gt;RangeBase = RangeBase;
00150     Profile-&gt;RangeLimit = (PUCHAR)RangeBase + RangeSize;
00151     Profile-&gt;BucketShift = BucketSize - 2;
00152     Profile-&gt;Started = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00153     Profile-&gt;Segment = Segment;
00154     Profile-&gt;Source = (CSHORT)ProfileSource;
00155     Profile-&gt;Affinity = ProfileAffinity &amp; <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a>;
00156     <span class="keywordflow">if</span> (Profile-&gt;Affinity == 0) {
00157         Profile-&gt;Affinity = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a>;
00158     }
00159     <span class="keywordflow">return</span>;
00160 }
00161 
00162 ULONG
<a name="l00163"></a><a class="code" href="../../d0/d8/profobj_8c.html#a6">00163</a> <a class="code" href="../../d0/d8/profobj_8c.html#a6">KeQueryIntervalProfile</a> (
00164     IN KPROFILE_SOURCE ProfileSource
00165     )
00166 
00167 <span class="comment">/*++</span>
00168 <span class="comment"></span>
00169 <span class="comment">Routine Description:</span>
00170 <span class="comment"></span>
00171 <span class="comment">    This function returns the profile sample interval the system is</span>
00172 <span class="comment">    currently using.</span>
00173 <span class="comment"></span>
00174 <span class="comment">Arguments:</span>
00175 <span class="comment"></span>
00176 <span class="comment">    ProfileSource - Supplies the profile source to be queried.</span>
00177 <span class="comment"></span>
00178 <span class="comment">Return Value:</span>
00179 <span class="comment"></span>
00180 <span class="comment">    Sample interval in units of 100ns.</span>
00181 <span class="comment"></span>
00182 <span class="comment">--*/</span>
00183 
00184 {
00185 
00186     <a class="code" href="../../d2/d3/struct__HAL__PROFILE__SOURCE__INFORMATION.html">HAL_PROFILE_SOURCE_INFORMATION</a> ProfileSourceInfo;
00187     ULONG ReturnedLength;
00188     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00189 
00190     <span class="keywordflow">if</span> (ProfileSource == ProfileTime) {
00191 
00192         <span class="comment">//</span>
00193         <span class="comment">// Return the current sampling interval in 100ns units.</span>
00194         <span class="comment">//</span>
00195 
00196         <span class="keywordflow">return</span> <a class="code" href="../../d5/d9/kernldat_8c.html#a55">KiProfileInterval</a>;
00197 
00198     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ProfileSource == ProfileAlignmentFixup) {
00199         <span class="keywordflow">return</span> <a class="code" href="../../d5/d9/kernldat_8c.html#a53">KiProfileAlignmentFixupInterval</a>;
00200 
00201     } <span class="keywordflow">else</span> {
00202 
00203         <span class="comment">//</span>
00204         <span class="comment">// The HAL is responsible for tracking this profile interval.</span>
00205         <span class="comment">//</span>
00206 
00207         ProfileSourceInfo.<a class="code" href="../../d2/d3/struct__HAL__PROFILE__SOURCE__INFORMATION.html#o0">Source</a> = ProfileSource;
00208         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d7/hal_8h.html#a20">HalQuerySystemInformation</a>(<a class="code" href="../../d2/d7/hal_8h.html#a237a143">HalProfileSourceInformation</a>,
00209                                            <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d3/struct__HAL__PROFILE__SOURCE__INFORMATION.html">HAL_PROFILE_SOURCE_INFORMATION</a>),
00210                                            &amp;ProfileSourceInfo,
00211                                            &amp;ReturnedLength);
00212 
00213         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp; ProfileSourceInfo.<a class="code" href="../../d2/d3/struct__HAL__PROFILE__SOURCE__INFORMATION.html#o1">Supported</a>) {
00214             <span class="keywordflow">return</span> ProfileSourceInfo.<a class="code" href="../../d2/d3/struct__HAL__PROFILE__SOURCE__INFORMATION.html#o2">Interval</a>;
00215 
00216         } <span class="keywordflow">else</span> {
00217             <span class="keywordflow">return</span> 0;
00218         }
00219     }
00220 }
00221 
00222 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00223"></a><a class="code" href="../../d0/d8/profobj_8c.html#a7">00223</a> <a class="code" href="../../d0/d8/profobj_8c.html#a7">KeSetIntervalProfile</a> (
00224     IN ULONG Interval,
00225     IN KPROFILE_SOURCE Source
00226     )
00227 
00228 <span class="comment">/*++</span>
00229 <span class="comment"></span>
00230 <span class="comment">Routine Description:</span>
00231 <span class="comment"></span>
00232 <span class="comment">    This function sets the profile sampling interval. The interval is in</span>
00233 <span class="comment">    100ns units. The interval will actually be set to some value in a set</span>
00234 <span class="comment">    of preset values (at least on pc based hardware), using the one closest</span>
00235 <span class="comment">    to what the user asked for.</span>
00236 <span class="comment"></span>
00237 <span class="comment">Arguments:</span>
00238 <span class="comment"></span>
00239 <span class="comment">    Interval - Supplies the length of the sampling interval in 100ns units.</span>
00240 <span class="comment"></span>
00241 <span class="comment">Return Value:</span>
00242 <span class="comment"></span>
00243 <span class="comment">    None.</span>
00244 <span class="comment"></span>
00245 <span class="comment">--*/</span>
00246 
00247 {
00248 
00249     <a class="code" href="../../d3/d3/struct__HAL__PROFILE__SOURCE__INTERVAL.html">HAL_PROFILE_SOURCE_INTERVAL</a> ProfileSourceInterval;
00250 
00251     <span class="keywordflow">if</span> (Source == ProfileTime) {
00252 
00253         <span class="comment">//</span>
00254         <span class="comment">// If the specified sampling interval is less than the minimum</span>
00255         <span class="comment">// sampling interval, then set the sampling interval to the minimum</span>
00256         <span class="comment">// sampling interval.</span>
00257         <span class="comment">//</span>
00258 
00259         <span class="keywordflow">if</span> (Interval &lt; MINIMUM_PROFILE_INTERVAL) {
00260             Interval = MINIMUM_PROFILE_INTERVAL;
00261         }
00262 
00263         <span class="comment">//</span>
00264         <span class="comment">// Set the sampling interval.</span>
00265         <span class="comment">//</span>
00266 
00267         <a class="code" href="../../d5/d9/kernldat_8c.html#a55">KiProfileInterval</a> = (ULONG)<a class="code" href="../../d2/d1/xipi_8c.html#a1">KiIpiGenericCall</a>(<a class="code" href="../../d2/d7/hal_8h.html#a172">HalSetProfileInterval</a>, Interval);
00268 
00269     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Source == ProfileAlignmentFixup) {
00270         <a class="code" href="../../d5/d9/kernldat_8c.html#a53">KiProfileAlignmentFixupInterval</a> = Interval;
00271 
00272     } <span class="keywordflow">else</span> {
00273 
00274         <span class="comment">//</span>
00275         <span class="comment">// The HAL is responsible for setting this profile interval.</span>
00276         <span class="comment">//</span>
00277 
00278         ProfileSourceInterval.<a class="code" href="../../d3/d3/struct__HAL__PROFILE__SOURCE__INTERVAL.html#o0">Source</a> = Source;
00279         ProfileSourceInterval.<a class="code" href="../../d3/d3/struct__HAL__PROFILE__SOURCE__INTERVAL.html#o1">Interval</a> = Interval;
00280         <a class="code" href="../../d2/d7/hal_8h.html#a21">HalSetSystemInformation</a>(<a class="code" href="../../d2/d7/hal_8h.html#a238a153">HalProfileSourceInterval</a>,
00281                                 <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d3/struct__HAL__PROFILE__SOURCE__INTERVAL.html">HAL_PROFILE_SOURCE_INTERVAL</a>),
00282                                 &amp;ProfileSourceInterval);
00283     }
00284 
00285     <span class="keywordflow">return</span>;
00286 }
00287 
00288 BOOLEAN
<a name="l00289"></a><a class="code" href="../../d0/d8/profobj_8c.html#a8">00289</a> <a class="code" href="../../d0/d8/profobj_8c.html#a8">KeStartProfile</a> (
00290     IN <a class="code" href="../../d6/d7/struct__KPROFILE.html">PKPROFILE</a> Profile,
00291     IN PULONG Buffer
00292     )
00293 
00294 <span class="comment">/*++</span>
00295 <span class="comment"></span>
00296 <span class="comment">Routine Description:</span>
00297 <span class="comment"></span>
00298 <span class="comment">    This function starts profile data gathering on the specified profile</span>
00299 <span class="comment">    object. The profile object is marked started, and is registered with</span>
00300 <span class="comment">    the profile interrupt procedure.</span>
00301 <span class="comment"></span>
00302 <span class="comment">    If the number of active profile objects was previously zero, then the</span>
00303 <span class="comment">    profile interrupt is enabled.</span>
00304 <span class="comment"></span>
00305 <span class="comment">    N.B. For the current implementation, an arbitrary number of profile</span>
00306 <span class="comment">        objects may be active at once. This can present a large system</span>
00307 <span class="comment">        overhead. It is assumed that the caller appropriately limits the</span>
00308 <span class="comment">        the number of active profiles.</span>
00309 <span class="comment"></span>
00310 <span class="comment">Arguments:</span>
00311 <span class="comment"></span>
00312 <span class="comment">    Profile - Supplies a pointer to a control object of type profile.</span>
00313 <span class="comment"></span>
00314 <span class="comment">    Buffer - Supplies a pointer to an array of counters, which record</span>
00315 <span class="comment">        the number of hits in the corresponding bucket.</span>
00316 <span class="comment"></span>
00317 <span class="comment">Return Value:</span>
00318 <span class="comment"></span>
00319 <span class="comment">    A value of TRUE is returned if profiling was previously stopped for</span>
00320 <span class="comment">    the specified profile object. Otherwise, a value of FALSE is returned.</span>
00321 <span class="comment"></span>
00322 <span class="comment">--*/</span>
00323 
00324 {
00325 
00326     KIRQL OldIrql, OldIrql2;
00327     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00328     BOOLEAN Started;
00329     KAFFINITY TargetProcessors;
00330     PKPRCB Prcb;
00331     <a class="code" href="../../d0/d8/profobj_8c.html#a2">PKACTIVE_PROFILE_SOURCE</a> ActiveSource = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00332     <a class="code" href="../../d0/d8/profobj_8c.html#a2">PKACTIVE_PROFILE_SOURCE</a> CurrentActiveSource;
00333     <a class="code" href="../../d0/d8/profobj_8c.html#a2">PKACTIVE_PROFILE_SOURCE</a> AllocatedPool;
00334     PLIST_ENTRY ListEntry;
00335     ULONG SourceSize;
00336     KAFFINITY AffinitySet;
00337     PULONG Reference;
00338 
00339     <a class="code" href="../../d0/d8/profobj_8c.html#a0">ASSERT_PROFILE</a>(Profile);
00340     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00341 
00342     <span class="comment">//</span>
00343     <span class="comment">// Allocate pool that may be required before raising to PROFILE_LEVEL.</span>
00344     <span class="comment">//</span>
00345 
00346     SourceSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/struct__KACTIVE__PROFILE__SOURCE.html">KACTIVE_PROFILE_SOURCE</a>) + <span class="keyword">sizeof</span>(ULONG) *
00347                  (<a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a> - 1);
00348     AllocatedPool = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, SourceSize, 'forP');
00349     <span class="keywordflow">if</span> (AllocatedPool == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00350         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00351     }
00352 
00353     <span class="comment">//</span>
00354     <span class="comment">// Raise to dispatch level</span>
00355     <span class="comment">//</span>
00356 
00357     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>, &amp;OldIrql);
00358     Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00359 
00360     <span class="comment">//</span>
00361     <span class="comment">// Raise IRQL to PROFILE_LEVEL and acquire the profile lock.</span>
00362     <span class="comment">//</span>
00363 
00364     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(<a class="code" href="../../d7/d3/i386init_8c.html#a0">KiProfileIrql</a>, &amp;OldIrql2);
00365     KiAcquireSpinLock(&amp;<a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a14">KiProfileLock</a>);
00366 
00367     <span class="comment">//</span>
00368     <span class="comment">// Assume object already started</span>
00369     <span class="comment">//</span>
00370 
00371     Started = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00372     AffinitySet = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00373     TargetProcessors = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00374 
00375     <span class="comment">//</span>
00376     <span class="comment">// If the specified profile object is not started, set started to TRUE,</span>
00377     <span class="comment">// set the address of the profile buffer, set the profile object to started,</span>
00378     <span class="comment">// insert the profile object in the appropriate profile list, and start</span>
00379     <span class="comment">// profile interrupts if the number of active profile objects was previously zero.</span>
00380     <span class="comment">//</span>
00381 
00382     <span class="keywordflow">if</span> (Profile-&gt;Started == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00383 
00384         Started = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00385         Profile-&gt;Buffer = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00386         Profile-&gt;Started = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00387         Process = Profile-&gt;Process;
00388         <span class="keywordflow">if</span> (Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00389             InsertTailList(&amp;Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o1">ProfileListHead</a>, &amp;Profile-&gt;ProfileListEntry);
00390 
00391         } <span class="keywordflow">else</span> {
00392             InsertTailList(&amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a56">KiProfileListHead</a>, &amp;Profile-&gt;ProfileListEntry);
00393         }
00394 
00395         <span class="comment">//</span>
00396         <span class="comment">// Check the profile source list to see if this profile source is</span>
00397         <span class="comment">// already started. If so, update the reference counts. If not,</span>
00398         <span class="comment">// allocate a profile source object, initialize the reference</span>
00399         <span class="comment">// counts, and add it to the list.</span>
00400         <span class="comment">//</span>
00401 
00402         ListEntry = <a class="code" href="../../d5/d9/kernldat_8c.html#a51">KiProfileSourceListHead</a>.Flink;
00403         <span class="keywordflow">while</span> (ListEntry != &amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a51">KiProfileSourceListHead</a>) {
00404             CurrentActiveSource = CONTAINING_RECORD(ListEntry,
00405                                                     <a class="code" href="../../d0/d5/struct__KACTIVE__PROFILE__SOURCE.html">KACTIVE_PROFILE_SOURCE</a>,
00406                                                     ListEntry);
00407 
00408             <span class="keywordflow">if</span> (CurrentActiveSource-&gt;<a class="code" href="../../d0/d5/struct__KACTIVE__PROFILE__SOURCE.html#o1">Source</a> == Profile-&gt;Source) {
00409                 ActiveSource = CurrentActiveSource;
00410                 <span class="keywordflow">break</span>;
00411             }
00412             ListEntry = ListEntry-&gt;Flink;
00413         }
00414 
00415         <span class="keywordflow">if</span> (ActiveSource == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00416 
00417             <span class="comment">//</span>
00418             <span class="comment">// This source was not found, allocate and initialize a new entry and add</span>
00419             <span class="comment">// it to the head of the list.</span>
00420             <span class="comment">//</span>
00421 
00422             ActiveSource = AllocatedPool;
00423             AllocatedPool = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00424             RtlZeroMemory(ActiveSource, SourceSize);
00425             ActiveSource-&gt;<a class="code" href="../../d0/d5/struct__KACTIVE__PROFILE__SOURCE.html#o1">Source</a> = Profile-&gt;Source;
00426             InsertHeadList(&amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a51">KiProfileSourceListHead</a>, &amp;ActiveSource-&gt;<a class="code" href="../../d0/d5/struct__KACTIVE__PROFILE__SOURCE.html#o0">ListEntry</a>);
00427             <span class="keywordflow">if</span> (Profile-&gt;Source == ProfileAlignmentFixup) {
00428                 <a class="code" href="../../d5/d9/kernldat_8c.html#a52">KiProfileAlignmentFixup</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00429             }
00430         }
00431 
00432         <span class="comment">//</span>
00433         <span class="comment">// Increment the reference counts for each processor in the</span>
00434         <span class="comment">// affinity set.</span>
00435         <span class="comment">//</span>
00436 
00437         AffinitySet = Profile-&gt;Affinity;
00438         Reference = &amp;ActiveSource-&gt;<a class="code" href="../../d0/d5/struct__KACTIVE__PROFILE__SOURCE.html#o3">ProcessorCount</a>[0];
00439         <span class="keywordflow">while</span> (AffinitySet != 0) {
00440             <span class="keywordflow">if</span> (AffinitySet &amp; 1) {
00441                 *Reference = *Reference + 1;
00442             }
00443 
00444             AffinitySet = AffinitySet &gt;&gt; 1;
00445             Reference = Reference + 1;
00446         }
00447 
00448         <span class="comment">//</span>
00449         <span class="comment">// Compute the processors which the profile interrupt is</span>
00450         <span class="comment">// required and not already started</span>
00451         <span class="comment">//</span>
00452 
00453         AffinitySet = Profile-&gt;Affinity &amp; ~ActiveSource-&gt;<a class="code" href="../../d0/d5/struct__KACTIVE__PROFILE__SOURCE.html#o2">Affinity</a>;
00454         TargetProcessors = AffinitySet &amp; ~Prcb-&gt;SetMember;
00455 
00456         <span class="comment">//</span>
00457         <span class="comment">// Update set of processors on which this source is active.</span>
00458         <span class="comment">//</span>
00459 
00460         ActiveSource-&gt;<a class="code" href="../../d0/d5/struct__KACTIVE__PROFILE__SOURCE.html#o2">Affinity</a> |= Profile-&gt;Affinity;
00461     }
00462 
00463     <span class="comment">//</span>
00464     <span class="comment">// Release the profile lock, lower IRQL to its previous value, and</span>
00465     <span class="comment">// return whether profiling was started.</span>
00466     <span class="comment">//</span>
00467 
00468     KiReleaseSpinLock(&amp;<a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a14">KiProfileLock</a>);
00469     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql2);
00470 
00471     <span class="comment">//</span>
00472     <span class="comment">// Start profile interrupt on pending processors</span>
00473     <span class="comment">//</span>
00474 
00475 <span class="preprocessor">#if !defined(NT_UP)</span>
00476 <span class="preprocessor"></span>
00477     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00478         <a class="code" href="../../d0/d0/ki_8h.html#a91">KiIpiSendPacket</a>(TargetProcessors,
00479                         <a class="code" href="../../d0/d8/profobj_8c.html#a3">KiStartProfileInterrupt</a>,
00480                         (PVOID)Profile-&gt;Source,
00481                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00482                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00483     }
00484 
00485 <span class="preprocessor">#endif</span>
00486 <span class="preprocessor"></span>
00487     <span class="keywordflow">if</span> (AffinitySet &amp; Prcb-&gt;SetMember) {
00488         <span class="keywordflow">if</span> (Profile-&gt;Source == ProfileAlignmentFixup) {
00489             <a class="code" href="../../d0/d0/ki_8h.html#a28">KiEnableAlignmentExceptions</a>();
00490         }
00491         <a class="code" href="../../d2/d7/hal_8h.html#a173">HalStartProfileInterrupt</a>(Profile-&gt;Source);
00492     }
00493 
00494 <span class="preprocessor">#if !defined(NT_UP)</span>
00495 <span class="preprocessor"></span>
00496     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00497         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>(TargetProcessors);
00498     }
00499 
00500 <span class="preprocessor">#endif</span>
00501 <span class="preprocessor"></span>
00502     <span class="comment">//</span>
00503     <span class="comment">// Lower to original IRQL</span>
00504     <span class="comment">//</span>
00505 
00506     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00507 
00508     <span class="comment">//</span>
00509     <span class="comment">// If the allocated pool was not used, free it now.</span>
00510     <span class="comment">//</span>
00511 
00512     <span class="keywordflow">if</span> (AllocatedPool != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00513         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(AllocatedPool);
00514     }
00515 
00516     <span class="keywordflow">return</span> Started;
00517 }
00518 
00519 BOOLEAN
<a name="l00520"></a><a class="code" href="../../d0/d8/profobj_8c.html#a9">00520</a> <a class="code" href="../../d0/d8/profobj_8c.html#a9">KeStopProfile</a> (
00521     IN <a class="code" href="../../d6/d7/struct__KPROFILE.html">PKPROFILE</a> Profile
00522     )
00523 
00524 <span class="comment">/*++</span>
00525 <span class="comment"></span>
00526 <span class="comment">Routine Description:</span>
00527 <span class="comment"></span>
00528 <span class="comment">    This function stops profile data gathering on the specified profile</span>
00529 <span class="comment">    object. The object is marked stopped, and is removed from the active</span>
00530 <span class="comment">    profile list.</span>
00531 <span class="comment"></span>
00532 <span class="comment">    If the number of active profile objects goes to zero, then the profile</span>
00533 <span class="comment">    interrupt is disabled.</span>
00534 <span class="comment"></span>
00535 <span class="comment">Arguments:</span>
00536 <span class="comment"></span>
00537 <span class="comment">    Profile - Supplies a pointer to a control object of type profile.</span>
00538 <span class="comment"></span>
00539 <span class="comment">Return Value:</span>
00540 <span class="comment"></span>
00541 <span class="comment">    A value of TRUE is returned if profiling was previously started for</span>
00542 <span class="comment">    the specified profile object. Otherwise, a value of FALSE is returned.</span>
00543 <span class="comment"></span>
00544 <span class="comment">--*/</span>
00545 
00546 {
00547 
00548     KIRQL OldIrql, OldIrql2;
00549     BOOLEAN Stopped;
00550     KAFFINITY TargetProcessors;
00551     PKPRCB Prcb;
00552     BOOLEAN StopInterrupt = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00553     PLIST_ENTRY ListEntry;
00554     <a class="code" href="../../d0/d8/profobj_8c.html#a2">PKACTIVE_PROFILE_SOURCE</a> ActiveSource;
00555     <a class="code" href="../../d0/d8/profobj_8c.html#a2">PKACTIVE_PROFILE_SOURCE</a> PoolToFree=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00556     KAFFINITY AffinitySet = 0;
00557     KAFFINITY CurrentProcessor;
00558     PULONG Reference;
00559 
00560     <a class="code" href="../../d0/d8/profobj_8c.html#a0">ASSERT_PROFILE</a>(Profile);
00561     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00562 
00563     <span class="comment">//</span>
00564     <span class="comment">// Raise to disaptch level</span>
00565     <span class="comment">//</span>
00566 
00567     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>, &amp;OldIrql);
00568     Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00569 
00570     <span class="comment">//</span>
00571     <span class="comment">// Raise IRQL to PROFILE_LEVEL and acquire the profile lock.</span>
00572     <span class="comment">//</span>
00573 
00574     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(<a class="code" href="../../d7/d3/i386init_8c.html#a0">KiProfileIrql</a>, &amp;OldIrql2);
00575     KiAcquireSpinLock(&amp;<a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a14">KiProfileLock</a>);
00576 
00577     <span class="comment">//</span>
00578     <span class="comment">// Assume object already stopped</span>
00579     <span class="comment">//</span>
00580 
00581     Stopped = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00582     AffinitySet = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00583     TargetProcessors = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00584 
00585     <span class="comment">//</span>
00586     <span class="comment">// If the specified profile object is not stopped, set stopped to TRUE, set</span>
00587     <span class="comment">// the profile object to stopped, remove the profile object object from the</span>
00588     <span class="comment">// appropriate profilelist, and stop profile interrupts if the number of</span>
00589     <span class="comment">// active profile objects is zero.</span>
00590     <span class="comment">//</span>
00591 
00592     <span class="keywordflow">if</span> (Profile-&gt;Started != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00593 
00594         Stopped = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00595         Profile-&gt;Started = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00596         RemoveEntryList(&amp;Profile-&gt;ProfileListEntry);
00597 
00598         <span class="comment">//</span>
00599         <span class="comment">// Search the profile source list to find the entry for this</span>
00600         <span class="comment">// profile source.</span>
00601         <span class="comment">//</span>
00602 
00603         ListEntry = <a class="code" href="../../d5/d9/kernldat_8c.html#a51">KiProfileSourceListHead</a>.Flink;
00604         <span class="keywordflow">do</span> {
00605             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ListEntry != &amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a51">KiProfileSourceListHead</a>);
00606             ActiveSource = CONTAINING_RECORD(ListEntry,
00607                                              <a class="code" href="../../d0/d5/struct__KACTIVE__PROFILE__SOURCE.html">KACTIVE_PROFILE_SOURCE</a>,
00608                                              ListEntry);
00609             ListEntry = ListEntry-&gt;Flink;
00610         } <span class="keywordflow">while</span> ( ActiveSource-&gt;<a class="code" href="../../d0/d5/struct__KACTIVE__PROFILE__SOURCE.html#o1">Source</a> != Profile-&gt;Source );
00611 
00612         <span class="comment">//</span>
00613         <span class="comment">// Decrement the reference counts for each processor in the</span>
00614         <span class="comment">// affinity set and build up a mask of the processors that</span>
00615         <span class="comment">// now have a reference count of zero.</span>
00616         <span class="comment">//</span>
00617 
00618         CurrentProcessor = 1;
00619         TargetProcessors = 0;
00620         AffinitySet = Profile-&gt;Affinity;
00621         Reference = &amp;ActiveSource-&gt;<a class="code" href="../../d0/d5/struct__KACTIVE__PROFILE__SOURCE.html#o3">ProcessorCount</a>[0];
00622         <span class="keywordflow">while</span> (AffinitySet != 0) {
00623             <span class="keywordflow">if</span> (AffinitySet &amp; 1) {
00624                 *Reference = *Reference - 1;
00625                 <span class="keywordflow">if</span> (*Reference == 0) {
00626                     TargetProcessors = TargetProcessors | CurrentProcessor;
00627                 }
00628             }
00629 
00630             AffinitySet = AffinitySet &gt;&gt; 1;
00631             Reference = Reference + 1;
00632             CurrentProcessor = CurrentProcessor &lt;&lt; 1;
00633         }
00634 
00635         <span class="comment">//</span>
00636         <span class="comment">// Compute the processors whose profile interrupt reference</span>
00637         <span class="comment">// count has dropped to zero.</span>
00638         <span class="comment">//</span>
00639 
00640         AffinitySet = TargetProcessors;
00641         TargetProcessors = AffinitySet &amp; ~Prcb-&gt;SetMember;
00642 
00643         <span class="comment">//</span>
00644         <span class="comment">// Update set of processors on which this source is active.</span>
00645         <span class="comment">//</span>
00646 
00647         ActiveSource-&gt;<a class="code" href="../../d0/d5/struct__KACTIVE__PROFILE__SOURCE.html#o2">Affinity</a> &amp;= ~AffinitySet;
00648 
00649         <span class="comment">//</span>
00650         <span class="comment">// Determine whether this profile source is stopped on all</span>
00651         <span class="comment">// processors. If so, remove it from the list and free it.</span>
00652         <span class="comment">//</span>
00653 
00654         <span class="keywordflow">if</span> (ActiveSource-&gt;<a class="code" href="../../d0/d5/struct__KACTIVE__PROFILE__SOURCE.html#o2">Affinity</a> == 0) {
00655             RemoveEntryList(&amp;ActiveSource-&gt;<a class="code" href="../../d0/d5/struct__KACTIVE__PROFILE__SOURCE.html#o0">ListEntry</a>);
00656             PoolToFree = ActiveSource;
00657             <span class="keywordflow">if</span> (Profile-&gt;Source == ProfileAlignmentFixup) {
00658                 <a class="code" href="../../d5/d9/kernldat_8c.html#a52">KiProfileAlignmentFixup</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00659             }
00660         }
00661     }
00662 
00663     <span class="comment">//</span>
00664     <span class="comment">// Release the profile lock, lower IRQL to its previous value, and</span>
00665     <span class="comment">// return whether profiling was stopped.</span>
00666     <span class="comment">//</span>
00667 
00668     KiReleaseSpinLock(&amp;<a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a14">KiProfileLock</a>);
00669     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql2);
00670 
00671     <span class="comment">//</span>
00672     <span class="comment">// Stop profile interrupt on pending processors</span>
00673     <span class="comment">//</span>
00674 
00675 <span class="preprocessor">#if !defined(NT_UP)</span>
00676 <span class="preprocessor"></span>
00677     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00678         <a class="code" href="../../d0/d0/ki_8h.html#a91">KiIpiSendPacket</a>(TargetProcessors,
00679                         <a class="code" href="../../d0/d8/profobj_8c.html#a4">KiStopProfileInterrupt</a>,
00680                         (PVOID)Profile-&gt;Source,
00681                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00682                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00683     }
00684 
00685 <span class="preprocessor">#endif</span>
00686 <span class="preprocessor"></span>
00687     <span class="keywordflow">if</span> (AffinitySet &amp; Prcb-&gt;SetMember) {
00688         <span class="keywordflow">if</span> (Profile-&gt;Source == ProfileAlignmentFixup) {
00689             <a class="code" href="../../d0/d0/ki_8h.html#a29">KiDisableAlignmentExceptions</a>();
00690         }
00691         <a class="code" href="../../d2/d7/hal_8h.html#a174">HalStopProfileInterrupt</a>(Profile-&gt;Source);
00692     }
00693 
00694 <span class="preprocessor">#if !defined(NT_UP)</span>
00695 <span class="preprocessor"></span>
00696     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00697         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>(TargetProcessors);
00698     }
00699 
00700 <span class="preprocessor">#endif</span>
00701 <span class="preprocessor"></span>
00702     <span class="comment">//</span>
00703     <span class="comment">// Lower to original IRQL</span>
00704     <span class="comment">//</span>
00705 
00706     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
00707 
00708     <span class="comment">//</span>
00709     <span class="comment">// Now that IRQL has been lowered, free the profile source if</span>
00710     <span class="comment">// necessary.</span>
00711     <span class="comment">//</span>
00712 
00713     <span class="keywordflow">if</span> (PoolToFree != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00714         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PoolToFree);
00715     }
00716 
00717     <span class="keywordflow">return</span> Stopped;
00718 }
00719 
00720 <span class="preprocessor">#if !defined(NT_UP)</span>
00721 <span class="preprocessor"></span>
00722 
00723 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00724"></a><a class="code" href="../../d0/d8/profobj_8c.html#a4">00724</a> <a class="code" href="../../d0/d8/profobj_8c.html#a4">KiStopProfileInterrupt</a> (
00725     IN PKIPI_CONTEXT SignalDone,
00726     IN PVOID Parameter1,
00727     IN PVOID Parameter2,
00728     IN PVOID Parameter3
00729     )
00730 
00731 <span class="comment">/*++</span>
00732 <span class="comment"></span>
00733 <span class="comment">Routine Description:</span>
00734 <span class="comment"></span>
00735 <span class="comment">    This is the target function for stopping the profile interrupt on target</span>
00736 <span class="comment">    processors.</span>
00737 <span class="comment"></span>
00738 <span class="comment">Arguments:</span>
00739 <span class="comment"></span>
00740 <span class="comment">    SignalDone - Supplies a pointer to a variable that is cleared when the</span>
00741 <span class="comment">        requested operation has been performed</span>
00742 <span class="comment"></span>
00743 <span class="comment">    Parameter1 - Supplies the profile source</span>
00744 <span class="comment"></span>
00745 <span class="comment">    Parameter2 - Parameter3 - not used</span>
00746 <span class="comment"></span>
00747 <span class="comment">Return Value:</span>
00748 <span class="comment"></span>
00749 <span class="comment">    None.</span>
00750 <span class="comment"></span>
00751 <span class="comment">--*/</span>
00752 
00753 {
00754 
00755     KPROFILE_SOURCE ProfileSource;
00756 
00757     <span class="comment">//</span>
00758     <span class="comment">// Stop the profile interrupt on the current processor and clear the</span>
00759     <span class="comment">// data cache packet address to signal the source to continue.</span>
00760     <span class="comment">//</span>
00761 
00762     ProfileSource = (KPROFILE_SOURCE) PtrToUlong(Parameter1);
00763     <span class="keywordflow">if</span> (ProfileSource == ProfileAlignmentFixup) {
00764         <a class="code" href="../../d0/d0/ki_8h.html#a29">KiDisableAlignmentExceptions</a>();
00765     }
00766     <a class="code" href="../../d2/d7/hal_8h.html#a174">HalStopProfileInterrupt</a>(ProfileSource);
00767     <a class="code" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone</a>(SignalDone);
00768     <span class="keywordflow">return</span>;
00769 }
00770 
00771 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00772"></a><a class="code" href="../../d0/d8/profobj_8c.html#a3">00772</a> <a class="code" href="../../d0/d8/profobj_8c.html#a3">KiStartProfileInterrupt</a> (
00773     IN PKIPI_CONTEXT SignalDone,
00774     IN PVOID Parameter1,
00775     IN PVOID Parameter2,
00776     IN PVOID Parameter3
00777     )
00778 
00779 <span class="comment">/*++</span>
00780 <span class="comment"></span>
00781 <span class="comment">Routine Description:</span>
00782 <span class="comment"></span>
00783 <span class="comment">    This is the target function for stopping the profile interrupt on target</span>
00784 <span class="comment">    processors.</span>
00785 <span class="comment"></span>
00786 <span class="comment">Arguments:</span>
00787 <span class="comment"></span>
00788 <span class="comment">    SignalDone - Supplies a pointer to a variable that is cleared when the</span>
00789 <span class="comment">        requested operation has been performed</span>
00790 <span class="comment"></span>
00791 <span class="comment">    Parameter1 - Supplies the profile source</span>
00792 <span class="comment"></span>
00793 <span class="comment">    Parameter2 - Parameter3 - not used</span>
00794 <span class="comment"></span>
00795 <span class="comment">Return Value:</span>
00796 <span class="comment"></span>
00797 <span class="comment">    None.</span>
00798 <span class="comment"></span>
00799 <span class="comment">--*/</span>
00800 
00801 {
00802 
00803     KPROFILE_SOURCE ProfileSource;
00804 
00805     <span class="comment">//</span>
00806     <span class="comment">// Start the profile interrupt on the current processor and clear the</span>
00807     <span class="comment">// data cache packet address to signal the source to continue.</span>
00808     <span class="comment">//</span>
00809 
00810     ProfileSource = (KPROFILE_SOURCE)PtrToUlong(Parameter1);
00811     <span class="keywordflow">if</span> (ProfileSource == ProfileAlignmentFixup) {
00812         <a class="code" href="../../d0/d0/ki_8h.html#a28">KiEnableAlignmentExceptions</a>();
00813     }
00814     <a class="code" href="../../d2/d7/hal_8h.html#a173">HalStartProfileInterrupt</a>(ProfileSource);
00815     <a class="code" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone</a>(SignalDone);
00816     <span class="keywordflow">return</span>;
00817 }
00818 
00819 <span class="preprocessor">#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:30 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
