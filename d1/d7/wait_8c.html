<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: wait.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>wait.c File Reference</h1><code>#include "<a class="el" href="../../d1/d9/ki_8h-source.html">ki.h</a>"</code><br>

<p>
<a href="../../d2/d6/wait_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d7/wait_8c.html#a0">TestForAlertPending</a>(Alertable)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d7/wait_8c.html#a1">KiAdjustQuantumThread</a> (IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> WaitMode, IN BOOLEAN Alertable, IN PLARGE_INTEGER Interval)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d7/wait_8c.html#a3">KeWaitForMultipleObjects</a> (IN ULONG <a class="el" href="../../d6/d0/cmdat_8c.html#a5">Count</a>, IN PVOID Object[], IN WAIT_TYPE WaitType, IN <a class="el" href="../../d4/d9/ke_8h.html#a53">KWAIT_REASON</a> WaitReason, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> WaitMode, IN BOOLEAN Alertable, IN PLARGE_INTEGER Timeout OPTIONAL, IN <a class="el" href="../../d4/d8/struct__KWAIT__BLOCK.html">PKWAIT_BLOCK</a> WaitBlockArray OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (IN PVOID Object, IN <a class="el" href="../../d4/d9/ke_8h.html#a53">KWAIT_REASON</a> WaitReason, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> WaitMode, IN BOOLEAN Alertable, IN PLARGE_INTEGER Timeout OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d7/wait_8c.html#a5">KiSetServerWaitClientEvent</a> (IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> ServerEvent, IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> ClientEvent, IN ULONG WaitMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PLARGE_INTEGER FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d7/wait_8c.html#a6">KiComputeWaitInterval</a> (IN PLARGE_INTEGER OriginalTime, IN PLARGE_INTEGER DueTime, IN OUT PLARGE_INTEGER NewTime)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="wait.c::TestForAlertPending" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define TestForAlertPending          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Alertable&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><span class="keywordflow">if</span> (Alertable) { \
        <span class="keywordflow">if</span> (Thread-&gt;Alerted[WaitMode] != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) { \
            Thread-&gt;Alerted[WaitMode] = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>; \
            WaitStatus = STATUS_ALERTED; \
            <span class="keywordflow">break</span>; \
        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((WaitMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp; \
                  (IsListEmpty(&amp;Thread-&gt;ApcState.ApcListHead[UserMode])) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) { \
            Thread-&gt;ApcState.UserApcPending = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>; \
            WaitStatus = STATUS_USER_APC; \
            <span class="keywordflow">break</span>; \
        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Thread-&gt;Alerted[<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>] != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) { \
            Thread-&gt;Alerted[<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>] = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>; \
            WaitStatus = STATUS_ALERTED; \
            <span class="keywordflow">break</span>; \
        } \
    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((WaitMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp; (Thread-&gt;ApcState.UserApcPending)) { \
        WaitStatus = STATUS_USER_APC; \
        <span class="keywordflow">break</span>; \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d6/wait_8c-source.html#l00057">57</a> of file <a class="el" href="../../d2/d6/wait_8c-source.html">wait.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00395">KeWaitForMultipleObjects()</a>, and <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a2" doxytag="wait.c::KeDelayExecutionThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS KeDelayExecutionThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WaitMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Alertable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>Interval</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">140</a> of file <a class="el" href="../../d2/d6/wait_8c-source.html">wait.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l00657">_KTHREAD::Alertable</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00575">_KTHREAD::ApcState</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00590">_KTHREAD::BasePriority</a>, <a class="el" href="../../d4/d9/ke_8h.html#a407a202">DelayExecution</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00523">_KTIMER::DueTime</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00522">_KTIMER::Header</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00246">_KAPC_STATE::KernelApcPending</a>, <a class="el" href="../../d9/d2/queueobj_8c-source.html#l00649">KiActivateWaiterQueue()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l01175">KiComputeWaitInterval()</a>, <a class="el" href="../../d1/d1/thredsup_8c-source.html#l00095">KiFindReadyThread()</a>, <a class="el" href="../../d6/d1/timersup_8c-source.html#l00042">KiInsertTreeTimer()</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00225">KiInsertWaitList</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d1/d1/thredsup_8c-source.html#l00270">KiReadyThread()</a>, <a class="el" href="../../d1/d1/thredsup_8c-source.html#l00576">KiSetPriorityThread()</a>, <a class="el" href="../../d0/d0/ki_8h.html#a138">KiSwapThread()</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00626">_KTHREAD::NextProcessor</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00283">_KWAIT_BLOCK::NextWaitBlock</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00623">_KTHREAD::Preempted</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00574">_KTHREAD::Priority</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00592">_KTHREAD::PriorityDecrement</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00244">_KAPC_STATE::Process</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00593">_KTHREAD::Quantum</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00612">_KTHREAD::Queue</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00569">_KTHREAD::State</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00057">TestForAlertPending</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00769">_KPROCESS::ThreadQuantum</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00614">_KTHREAD::Timer</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00084">TIMER_WAIT_BLOCK</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00594">_KTHREAD::WaitBlock</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00587">_KTHREAD::WaitBlockList</a>, <a class="el" href="../../d4/d9/ke_8h.html#a406a196">Waiting</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00583">_KTHREAD::WaitIrql</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00280">_KWAIT_BLOCK::WaitListEntry</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00263">_DISPATCHER_HEADER::WaitListHead</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00584">_KTHREAD::WaitMode</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00585">_KTHREAD::WaitNext</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00586">_KTHREAD::WaitReason</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00582">_KTHREAD::WaitStatus</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00589">_KTHREAD::WaitTime</a>.
<p>
Referenced by <a class="el" href="../../d6/d7/fssup_8c-source.html#l02331">CcPurgeCacheSection()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02242">IoCancelThreadIo()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00417">IopCancelAlertedRequest()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l00770">IopStartNetworkForRemoteBoot()</a>, <a class="el" href="../../d7/d8/kernlini_8c-source.html#l01691">KiInitMachineDependent()</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00492">MemPrintFlush()</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00598">MemPrintWriteThread()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l04107">MiAllocateContiguousMemory()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l02149">MiCheckControlAreaStatus()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01218">MiCheckSystemTrimEndCriteria()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01075">MiCleanSection()</a>, <a class="el" href="../../d9/d5/forksup_8c-source.html#l00100">MiCloneProcessAddressSpace()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l00068">MiDispatchFault()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l04726">MiEmptyWorkingSet()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04870">MiFlushAllPages()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l01014">MiFlushSectionInternal()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l05287">MiMakeOutswappedPageResident()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02669">MiModifiedPageWriter()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02831">MiModifiedPageWriterWorker()</a>, <a class="el" href="../../d5/d8/umapview_8c-source.html#l00541">MiPurgeImageSection()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l02748">MiRemoveUnusedSegments()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l01446">MiResolveProtoPteFault()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02234">MiWriteComplete()</a>, <a class="el" href="../../d5/d0/mmfault_8c-source.html#l00041">MmAccessFault()</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l01274">MmCopyToCachedPage()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00668">MmFlushSection()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00297">MmFlushVirtualMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07930">MmGatherMemoryForHibernate()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l06808">MmGetSystemRoutineAddress()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00437">MmRemovePhysicalMemory()</a>, <a class="el" href="../../d2/d8/shutdown_8c-source.html#l00041">MmShutdownSystem()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00397">MmWorkingSetManager()</a>, <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00049">NtCancelIoFile()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l00134">NtCreateSection()</a>, <a class="el" href="../../d8/d5/delay_8c-source.html#l00033">NtDelayExecution()</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01567">Reader()</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01646">ReaderTurnedWriter()</a>, <a class="el" href="../../d1/d0/base_8c-source.html#l00102">UserBeep()</a>, <a class="el" href="../../d1/d0/base_8c-source.html#l00083">UserSleep()</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01606">Writer()</a>, and <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l02184">xxxLW_LoadFonts()</a>.
<p>
<pre class="fragment"><div>00148                    :
00149 
00150     This function delays <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> execution of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00151     interval of time.
00152 
00153 Arguments:
00154 
00155     WaitMode  - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor mode in which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> delay <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to occur.
00156 
00157     Alertable - Supplies a <span class="keywordtype">boolean</span> value that specifies whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> delay
00158         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> alertable.
00159 
00160     Interval - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> absolute or relative time over which
00161         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> delay <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to occur.
00162 
00163 Return Value:
00164 
00165     The wait completion status. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of STATUS_SUCCESS <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span>
00166     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> delay occurred. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of STATUS_ALERTED <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait
00167     was aborted to deliver an alert to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of
00168     STATUS_USER_APC <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait was aborted to deliver a user
00169     APC to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread.
00170 
00171 --*/
00172 
00173 {
00174 
00175     LARGE_INTEGER DueTime;
00176     LARGE_INTEGER NewTime;
00177     PLARGE_INTEGER OriginalTime;
00178     PKPRCB Prcb;
00179     KPRIORITY Priority;
00180     <a class="code" href="../../d7/d7/struct__KQUEUE.html">PRKQUEUE</a> Queue;
00181     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> Thread;
00182     <a class="code" href="../../d3/d8/struct__KTIMER.html">PRKTIMER</a> Timer;
00183     <a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">PKWAIT_BLOCK</a> WaitBlock;
00184     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> WaitStatus;
00185 
00186     <span class="comment">//</span>
00187     <span class="comment">// If the dispatcher database lock is not already held, then set the wait</span>
00188     <span class="comment">// IRQL and lock the dispatcher database. Else set boolean wait variable</span>
00189     <span class="comment">// to FALSE.</span>
00190     <span class="comment">//</span>
00191 
00192     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00193     <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o19">WaitNext</a>) {
00194         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o19">WaitNext</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00195 
00196     } <span class="keywordflow">else</span> {
00197         <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a>);
00198     }
00199 
00200     <span class="comment">//</span>
00201     <span class="comment">// Start of delay loop.</span>
00202     <span class="comment">//</span>
00203     <span class="comment">// Note this loop is repeated if a kernel APC is delivered in the middle</span>
00204     <span class="comment">// of the delay or a kernel APC is pending on the first attempt through</span>
00205     <span class="comment">// the loop.</span>
00206     <span class="comment">//</span>
00207 
00208     OriginalTime = Interval;
00209     WaitBlock = &amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o28">WaitBlock</a>[<a class="code" href="../../d4/d9/ke_8h.html#a9">TIMER_WAIT_BLOCK</a>];
00210     <span class="keywordflow">do</span> {
00211 
00212         <span class="comment">//</span>
00213         <span class="comment">// Test to determine if a kernel APC is pending.</span>
00214         <span class="comment">//</span>
00215         <span class="comment">// If a kernel APC is pending and the previous IRQL was less than</span>
00216         <span class="comment">// APC_LEVEL, then a kernel APC was queued by another processor just</span>
00217         <span class="comment">// after IRQL was raised to DISPATCH_LEVEL, but before the dispatcher</span>
00218         <span class="comment">// database was locked.</span>
00219         <span class="comment">//</span>
00220         <span class="comment">// N.B. that this can only happen in a multiprocessor system.</span>
00221         <span class="comment">//</span>
00222 
00223         <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o3">KernelApcPending</a> &amp;&amp; (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a> &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>)) {
00224 
00225             <span class="comment">//</span>
00226             <span class="comment">// Unlock the dispatcher database and lower IRQL to its previous</span>
00227             <span class="comment">// value. An APC interrupt will immediately occur which will result</span>
00228             <span class="comment">// in the delivery of the kernel APC if possible.</span>
00229             <span class="comment">//</span>
00230 
00231             <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a>);
00232 
00233         } <span class="keywordflow">else</span> {
00234 
00235             <span class="comment">//</span>
00236             <span class="comment">// Test for alert pending.</span>
00237             <span class="comment">//</span>
00238 
00239             <a class="code" href="../../d1/d7/wait_8c.html#a0">TestForAlertPending</a>(Alertable);
00240 
00241             <span class="comment">//</span>
00242             <span class="comment">// Initialize wait block, insert wait block in timer wait list,</span>
00243             <span class="comment">// insert timer in timer queue, put thread in wait state, select</span>
00244             <span class="comment">// next thread to execute, and context switch to next thread.</span>
00245             <span class="comment">//</span>
00246             <span class="comment">// N.B. The timer wait block is initialized when the respective</span>
00247             <span class="comment">//      thread is initialized. Thus the constant fields are not</span>
00248             <span class="comment">//      reinitialized. These include the wait object, wait key,</span>
00249             <span class="comment">//      wait type, and the wait list entry link pointers.</span>
00250             <span class="comment">//</span>
00251 
00252             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o21">WaitBlockList</a> = WaitBlock;
00253             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o16">WaitStatus</a> = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)0;
00254             Timer = &amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o39">Timer</a>;
00255             WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o3">NextWaitBlock</a> = WaitBlock;
00256             Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o5">WaitListHead</a>.Flink = &amp;WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o0">WaitListEntry</a>;
00257             Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o5">WaitListHead</a>.Blink = &amp;WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o0">WaitListEntry</a>;
00258 
00259             <span class="comment">//</span>
00260             <span class="comment">// If the timer is inserted in the timer tree, then place the</span>
00261             <span class="comment">// current thread in a wait state. Otherwise, attempt to force</span>
00262             <span class="comment">// the current thread to yield the processor to another thread.</span>
00263             <span class="comment">//</span>
00264 
00265             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/timersup_8c.html#a1">KiInsertTreeTimer</a>(Timer, *Interval) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00266 
00267                 <span class="comment">//</span>
00268                 <span class="comment">// If the thread is not a realtime thread, then drop the</span>
00269                 <span class="comment">// thread priority to the base priority.</span>
00270                 <span class="comment">//</span>
00271 
00272                 Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00273                 Priority = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o13">Priority</a>;
00274                 <span class="keywordflow">if</span> (Priority &lt; LOW_REALTIME_PRIORITY) {
00275                     <span class="keywordflow">if</span> (Priority != Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o24">BasePriority</a>) {
00276                         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o26">PriorityDecrement</a> = 0;
00277                         <a class="code" href="../../d0/d2/thredsup_8c.html#a5">KiSetPriorityThread</a>(Thread, Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o24">BasePriority</a>);
00278                     }
00279                 }
00280 
00281                 <span class="comment">//</span>
00282                 <span class="comment">// If a new thread has not been selected, the attempt to round</span>
00283                 <span class="comment">// robin the thread with other threads at the same priority.</span>
00284                 <span class="comment">//</span>
00285 
00286                 <span class="keywordflow">if</span> (Prcb-&gt;NextThread == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00287                     Prcb-&gt;NextThread = <a class="code" href="../../d0/d2/thredsup_8c.html#a2">KiFindReadyThread</a>(Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o45">NextProcessor</a>,
00288                                                          Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o13">Priority</a>);
00289                 }
00290 
00291                 <span class="comment">//</span>
00292                 <span class="comment">// If a new thread has been selected for execution, then</span>
00293                 <span class="comment">// switch immediately to the selected thread.</span>
00294                 <span class="comment">//</span>
00295 
00296                 <span class="keywordflow">if</span> (Prcb-&gt;NextThread != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00297 
00298                     <span class="comment">//</span>
00299                     <span class="comment">// Give the current thread a new qunatum and switch</span>
00300                     <span class="comment">// context to selected thread.</span>
00301                     <span class="comment">//</span>
00302                     <span class="comment">// N.B. Control is returned at the original IRQL.</span>
00303                     <span class="comment">//</span>
00304 
00305                     Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o42">Preempted</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00306                     Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o27">Quantum</a> = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o13">ThreadQuantum</a>;
00307 
00308                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a> &lt;= DISPATCH_LEVEL);
00309 
00310                     <a class="code" href="../../d0/d2/thredsup_8c.html#a3">KiReadyThread</a>(Thread);
00311                     WaitStatus = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d0/d0/ki_8h.html#a138">KiSwapThread</a>();
00312                     <span class="keywordflow">goto</span> WaitComplete;
00313 
00314                 } <span class="keywordflow">else</span> {
00315                     WaitStatus = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)STATUS_SUCCESS;
00316                     <span class="keywordflow">break</span>;
00317                 }
00318             }
00319 
00320             DueTime.QuadPart = Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o1">DueTime</a>.QuadPart;
00321 
00322             <span class="comment">//</span>
00323             <span class="comment">// If the current thread is processing a queue entry, then attempt</span>
00324             <span class="comment">// to activate another thread that is blocked on the queue object.</span>
00325             <span class="comment">//</span>
00326 
00327             Queue = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o37">Queue</a>;
00328             <span class="keywordflow">if</span> (Queue != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00329                 <a class="code" href="../../d8/d3/queueobj_8c.html#a7">KiActivateWaiterQueue</a>(Queue);
00330             }
00331 
00332             <span class="comment">//</span>
00333             <span class="comment">// Set the thread wait parameters, set the thread dispatcher state</span>
00334             <span class="comment">// to Waiting, and insert the thread in the wait list.</span>
00335             <span class="comment">//</span>
00336 
00337             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o57">Alertable</a> = Alertable;
00338             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o18">WaitMode</a> = WaitMode;
00339             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o20">WaitReason</a> = <a class="code" href="../../d4/d9/ke_8h.html#a407a202">DelayExecution</a>;
00340             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o23">WaitTime</a>= KiQueryLowTickCount();
00341             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o8">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a406a196">Waiting</a>;
00342             <a class="code" href="../../d0/d0/ki_8h.html#a15">KiInsertWaitList</a>(WaitMode, Thread);
00343 
00344             <span class="comment">//</span>
00345             <span class="comment">// Switch context to selected thread.</span>
00346             <span class="comment">//</span>
00347             <span class="comment">// N.B. Control is returned at the original IRQL.</span>
00348             <span class="comment">//</span>
00349 
00350             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a> &lt;= DISPATCH_LEVEL);
00351 
00352             WaitStatus = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d0/d0/ki_8h.html#a138">KiSwapThread</a>();
00353 
00354             <span class="comment">//</span>
00355             <span class="comment">// If the thread was not awakened to deliver a kernel mode APC,</span>
00356             <span class="comment">// then return the wait status.</span>
00357             <span class="comment">//</span>
00358 
00359         WaitComplete:
00360             <span class="keywordflow">if</span> (WaitStatus != STATUS_KERNEL_APC) {
00361                 <span class="keywordflow">if</span> (WaitStatus == STATUS_TIMEOUT) {
00362                     WaitStatus = STATUS_SUCCESS;
00363                 }
00364 
00365                 <span class="keywordflow">return</span> WaitStatus;
00366             }
00367 
00368             <span class="comment">//</span>
00369             <span class="comment">// Reduce the time remaining before the time delay expires.</span>
00370             <span class="comment">//</span>
00371 
00372             Interval = <a class="code" href="../../d1/d7/wait_8c.html#a6">KiComputeWaitInterval</a>(OriginalTime,
00373                                              &amp;DueTime,
00374                                              &amp;NewTime);
00375         }
00376 
00377         <span class="comment">//</span>
00378         <span class="comment">// Raise IRQL to DISPATCH_LEVEL and lock the dispatcher database.</span>
00379         <span class="comment">//</span>
00380 
00381         <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a>);
00382     } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00383 
00384     <span class="comment">//</span>
00385     <span class="comment">// The thread is alerted or a user APC should be delivered. Unlock the</span>
00386     <span class="comment">// dispatcher database, lower IRQL to its previous value, and return the</span>
00387     <span class="comment">// wait status.</span>
00388     <span class="comment">//</span>
00389 
00390     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a>);
00391     <span class="keywordflow">return</span> WaitStatus;
00392 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="wait.c::KeWaitForMultipleObjects" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS KeWaitForMultipleObjects           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Count</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>[], </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN WAIT_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>WaitType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/ke_8h.html#a53">KWAIT_REASON</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WaitReason</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WaitMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Alertable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER Timeout&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d8/struct__KWAIT__BLOCK.html">PKWAIT_BLOCK</a> WaitBlockArray&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d6/wait_8c-source.html#l00395">395</a> of file <a class="el" href="../../d2/d6/wait_8c-source.html">wait.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l00657">_KTHREAD::Alertable</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00575">_KTHREAD::ApcState</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00523">_KTIMER::DueTime</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00522">_KTIMER::Header</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00485">_KMUTANT::Header</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00070">KeBugCheck()</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00246">_KAPC_STATE::KernelApcPending</a>, <a class="el" href="../../d9/d2/queueobj_8c-source.html#l00649">KiActivateWaiterQueue()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00079">KiAdjustQuantumThread()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l01175">KiComputeWaitInterval()</a>, <a class="el" href="../../d6/d1/timersup_8c-source.html#l00042">KiInsertTreeTimer()</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00225">KiInsertWaitList</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d0/d0/ki_8h.html#a138">KiSwapThread()</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d3/d6/waitsup_8c-source.html#l00228">KiWaitSatisfyAll()</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00960">KiWaitSatisfyMutant</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00997">KiWaitSatisfyOther</a>, <a class="el" href="../../d4/d9/ke_8h.html#a53">KWAIT_REASON</a>, <a class="el" href="../../d4/d9/ke_8h.html#a402a159">MutantObject</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00283">_KWAIT_BLOCK::NextWaitBlock</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00282">_KWAIT_BLOCK::Object</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00487">_KMUTANT::OwnerThread</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00612">_KTHREAD::Queue</a>, <a class="el" href="../../d4/d9/ke_8h.html#a402a161">QueueObject</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00262">_DISPATCHER_HEADER::SignalState</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00569">_KTHREAD::State</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00057">TestForAlertPending</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00281">_KWAIT_BLOCK::Thread</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00079">THREAD_WAIT_OBJECTS</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00614">_KTHREAD::Timer</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00084">TIMER_WAIT_BLOCK</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00258">_DISPATCHER_HEADER::Type</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00594">_KTHREAD::WaitBlock</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00587">_KTHREAD::WaitBlockList</a>, <a class="el" href="../../d4/d9/ke_8h.html#a406a196">Waiting</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00583">_KTHREAD::WaitIrql</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00284">_KWAIT_BLOCK::WaitKey</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00280">_KWAIT_BLOCK::WaitListEntry</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00263">_DISPATCHER_HEADER::WaitListHead</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00584">_KTHREAD::WaitMode</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00585">_KTHREAD::WaitNext</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00586">_KTHREAD::WaitReason</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00582">_KTHREAD::WaitStatus</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00589">_KTHREAD::WaitTime</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00285">_KWAIT_BLOCK::WaitType</a>.
<p>
Referenced by <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00516">CmpFileWrite()</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00431">ExpWorkerThreadBalanceManager()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l02146">InitiateWin32kCleanup()</a>, <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00142">KeBalanceSetManager()</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00598">MemPrintWriteThread()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l00603">MiDereferenceSegmentThread()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02831">MiModifiedPageWriterWorker()</a>, <a class="el" href="../../d8/d0/zeropage_8c-source.html#l00029">MmZeroPageThread()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00406">NtWaitForMultipleObjects()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l03858">RawInputThread()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02020">SmbTraceThreadEntry()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l04271">xxxMsgWaitForMultipleObjects()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l05481">xxxPollAndWaitForSingleObject()</a>, and <a class="el" href="../../d7/d8/taskman_8c-source.html#l00252">xxxSleepTask()</a>.
<p>
<pre class="fragment"><div>00408                    :
00409 
00410     This function waits until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified objects attain a state of
00411     Signaled. The wait can be specified to wait until all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> objects
00412     attain a state of Signaled or until one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> objects attains a state
00413     of Signaled. An optional timeout can also be specified. If a timeout
00414     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait will not be satisfied until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> objects
00415     attain a state of Signaled. If a timeout <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> objects
00416     have not attained a state of Signaled when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timeout expires, then
00417     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> automatically satisfied. If an <span class="keyword">explicit</span> timeout value of
00418     zero <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified, then no wait will occur <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait cannot be satisfied
00419     immediately. The wait can also be specified as alertable.
00420 
00421 Arguments:
00422 
00423     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> - Supplies a count of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of objects that are to be waited
00424         on.
00425 
00426     Object[] - Supplies an array of pointers to dispatcher objects.
00427 
00428     WaitType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of wait to perform (WaitAll, WaitAny).
00429 
00430     WaitReason - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a10">reason</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait.
00431 
00432     WaitMode  - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor mode in which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to occur.
00433 
00434     Alertable - Supplies a <span class="keywordtype">boolean</span> value that specifies whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00435         alertable.
00436 
00437     Timeout - Supplies a pointer to an optional absolute of relative time over
00438         which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to occur.
00439 
00440     WaitBlockArray - Supplies an optional pointer to an array of wait blocks
00441         that are to used to describe <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait operation.
00442 
00443 Return Value:
00444 
00445     The wait completion status. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of STATUS_TIMEOUT <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> a
00446     timeout occurred. The index of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object (zero based) in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
00447     pointer array <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> an object satisfied <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of
00448     STATUS_ALERTED <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait was aborted to deliver an alert
00449     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of STATUS_USER_APC <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00450     wait was aborted to deliver a user APC to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread.
00451 
00452 --*/
00453 
00454 {
00455 
00456     LARGE_INTEGER DueTime;
00457     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00458     LARGE_INTEGER NewTime;
00459     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> NextThread;
00460     <a class="code" href="../../d3/d7/struct__KMUTANT.html">PKMUTANT</a> Objectx;
00461     PLARGE_INTEGER OriginalTime;
00462     <a class="code" href="../../d7/d7/struct__KQUEUE.html">PRKQUEUE</a> Queue;
00463     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> Thread;
00464     <a class="code" href="../../d3/d8/struct__KTIMER.html">PRKTIMER</a> Timer;
00465     <a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">PRKWAIT_BLOCK</a> WaitBlock;
00466     BOOLEAN WaitSatisfied;
00467     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> WaitStatus;
00468     <a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">PKWAIT_BLOCK</a> WaitTimer;
00469 
00470     <span class="comment">//</span>
00471     <span class="comment">// If the dispatcher database lock is not already held, then set the wait</span>
00472     <span class="comment">// IRQL and lock the dispatcher database. Else set boolean wait variable</span>
00473     <span class="comment">// to FALSE.</span>
00474     <span class="comment">//</span>
00475 
00476     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00477     <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o19">WaitNext</a>) {
00478         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o19">WaitNext</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00479 
00480     } <span class="keywordflow">else</span> {
00481         <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a>);
00482     }
00483 
00484     <span class="comment">//</span>
00485     <span class="comment">// If a wait block array has been specified, then the maximum number of</span>
00486     <span class="comment">// objects that can be waited on is specified by MAXIMUM_WAIT_OBJECTS.</span>
00487     <span class="comment">// Otherwise the builtin wait blocks in the thread object are used and</span>
00488     <span class="comment">// the maximum number of objects that can be waited on is specified by</span>
00489     <span class="comment">// THREAD_WAIT_OBJECTS. If the specified number of objects is not within</span>
00490     <span class="comment">// limits, then bug check.</span>
00491     <span class="comment">//</span>
00492 
00493     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(WaitBlockArray)) {
00494         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> &gt; MAXIMUM_WAIT_OBJECTS) {
00495             <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(MAXIMUM_WAIT_OBJECTS_EXCEEDED);
00496         }
00497 
00498     } <span class="keywordflow">else</span> {
00499         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> &gt; <a class="code" href="../../d4/d9/ke_8h.html#a6">THREAD_WAIT_OBJECTS</a>) {
00500             <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(MAXIMUM_WAIT_OBJECTS_EXCEEDED);
00501         }
00502 
00503         WaitBlockArray = &amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o28">WaitBlock</a>[0];
00504     }
00505 
00506     <span class="comment">//</span>
00507     <span class="comment">// Start of wait loop.</span>
00508     <span class="comment">//</span>
00509     <span class="comment">// Note this loop is repeated if a kernel APC is delivered in the middle</span>
00510     <span class="comment">// of the wait or a kernel APC is pending on the first attempt through</span>
00511     <span class="comment">// the loop.</span>
00512     <span class="comment">//</span>
00513 
00514     OriginalTime = Timeout;
00515     <span class="keywordflow">do</span> {
00516 
00517         <span class="comment">//</span>
00518         <span class="comment">// Set address of wait block list in thread object.</span>
00519         <span class="comment">//</span>
00520 
00521         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o21">WaitBlockList</a> = WaitBlockArray;
00522 
00523         <span class="comment">//</span>
00524         <span class="comment">// Test to determine if a kernel APC is pending.</span>
00525         <span class="comment">//</span>
00526         <span class="comment">// If a kernel APC is pending and the previous IRQL was less than</span>
00527         <span class="comment">// APC_LEVEL, then a kernel APC was queued by another processor just</span>
00528         <span class="comment">// after IRQL was raised to DISPATCH_LEVEL, but before the dispatcher</span>
00529         <span class="comment">// database was locked.</span>
00530         <span class="comment">//</span>
00531         <span class="comment">// N.B. that this can only happen in a multiprocessor system.</span>
00532         <span class="comment">//</span>
00533 
00534         <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o3">KernelApcPending</a> &amp;&amp; (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a> &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>)) {
00535 
00536             <span class="comment">//</span>
00537             <span class="comment">// Unlock the dispatcher database and lower IRQL to its previous</span>
00538             <span class="comment">// value. An APC interrupt will immediately occur which will result</span>
00539             <span class="comment">// in the delivery of the kernel APC if possible.</span>
00540             <span class="comment">//</span>
00541 
00542             <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a>);
00543 
00544         } <span class="keywordflow">else</span> {
00545 
00546             <span class="comment">//</span>
00547             <span class="comment">// Construct wait blocks and check to determine if the wait is</span>
00548             <span class="comment">// already satisfied. If the wait is satisfied, then perform</span>
00549             <span class="comment">// wait completion and return. Else put current thread in a wait</span>
00550             <span class="comment">// state if an explicit timeout value of zero is not specified.</span>
00551             <span class="comment">//</span>
00552 
00553             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o16">WaitStatus</a> = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)0;
00554             WaitSatisfied = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00555             <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00556 
00557                 <span class="comment">//</span>
00558                 <span class="comment">// Test if wait can be satisfied immediately.</span>
00559                 <span class="comment">//</span>
00560 
00561                 Objectx = (<a class="code" href="../../d3/d7/struct__KMUTANT.html">PKMUTANT</a>)Object[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00562 
00563                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Objectx-&gt;<a class="code" href="../../d3/d7/struct__KMUTANT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o0">Type</a> != QueueObject);
00564 
00565                 <span class="keywordflow">if</span> (WaitType == WaitAny) {
00566 
00567                     <span class="comment">//</span>
00568                     <span class="comment">// If the object is a mutant object and the mutant object</span>
00569                     <span class="comment">// has been recursively acquired MINLONG times, then raise</span>
00570                     <span class="comment">// an exception. Otherwise if the signal state of the mutant</span>
00571                     <span class="comment">// object is greater than zero, or the current thread is</span>
00572                     <span class="comment">// the owner of the mutant object, then satisfy the wait.</span>
00573                     <span class="comment">//</span>
00574 
00575                     <span class="keywordflow">if</span> (Objectx-&gt;<a class="code" href="../../d3/d7/struct__KMUTANT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o0">Type</a> == <a class="code" href="../../d4/d9/ke_8h.html#a402a159">MutantObject</a>) {
00576                         <span class="keywordflow">if</span> ((Objectx-&gt;<a class="code" href="../../d3/d7/struct__KMUTANT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o4">SignalState</a> &gt; 0) ||
00577                             (Thread == Objectx-&gt;<a class="code" href="../../d3/d7/struct__KMUTANT.html#o2">OwnerThread</a>)) {
00578                             <span class="keywordflow">if</span> (Objectx-&gt;<a class="code" href="../../d3/d7/struct__KMUTANT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o4">SignalState</a> != MINLONG) {
00579                                 <a class="code" href="../../d0/d0/ki_8h.html#a26">KiWaitSatisfyMutant</a>(Objectx, Thread);
00580                                 WaitStatus = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> | Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o16">WaitStatus</a>);
00581                                 <span class="keywordflow">goto</span> NoWait;
00582 
00583                             } <span class="keywordflow">else</span> {
00584                                 <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a>);
00585                                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_MUTANT_LIMIT_EXCEEDED);
00586                             }
00587                         }
00588 
00589                     <span class="comment">//</span>
00590                     <span class="comment">// If the signal state is greater than zero, then satisfy</span>
00591                     <span class="comment">// the wait.</span>
00592                     <span class="comment">//</span>
00593 
00594                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Objectx-&gt;<a class="code" href="../../d3/d7/struct__KMUTANT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o4">SignalState</a> &gt; 0) {
00595                         <a class="code" href="../../d0/d0/ki_8h.html#a27">KiWaitSatisfyOther</a>(Objectx);
00596                         WaitStatus = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>);
00597                         <span class="keywordflow">goto</span> NoWait;
00598                     }
00599 
00600                 } <span class="keywordflow">else</span> {
00601 
00602                     <span class="comment">//</span>
00603                     <span class="comment">// If the object is a mutant object and the mutant object</span>
00604                     <span class="comment">// has been recursively acquired MAXLONG times, then raise</span>
00605                     <span class="comment">// an exception. Otherwise if the signal state of the mutant</span>
00606                     <span class="comment">// object is less than or equal to zero and the current</span>
00607                     <span class="comment">// thread is not the  owner of the mutant object, then the</span>
00608                     <span class="comment">// wait cannot be satisfied.</span>
00609                     <span class="comment">//</span>
00610 
00611                     <span class="keywordflow">if</span> (Objectx-&gt;<a class="code" href="../../d3/d7/struct__KMUTANT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o0">Type</a> == <a class="code" href="../../d4/d9/ke_8h.html#a402a159">MutantObject</a>) {
00612                         <span class="keywordflow">if</span> ((Thread == Objectx-&gt;<a class="code" href="../../d3/d7/struct__KMUTANT.html#o2">OwnerThread</a>) &amp;&amp;
00613                             (Objectx-&gt;<a class="code" href="../../d3/d7/struct__KMUTANT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o4">SignalState</a> == MINLONG)) {
00614                             <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a>);
00615                             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_MUTANT_LIMIT_EXCEEDED);
00616 
00617                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Objectx-&gt;<a class="code" href="../../d3/d7/struct__KMUTANT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o4">SignalState</a> &lt;= 0) &amp;&amp;
00618                                   (Thread != Objectx-&gt;<a class="code" href="../../d3/d7/struct__KMUTANT.html#o2">OwnerThread</a>)) {
00619                             WaitSatisfied = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00620                         }
00621 
00622                     <span class="comment">//</span>
00623                     <span class="comment">// If the signal state is less than or equal to zero, then</span>
00624                     <span class="comment">// the wait cannot be satisfied.</span>
00625                     <span class="comment">//</span>
00626 
00627                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Objectx-&gt;<a class="code" href="../../d3/d7/struct__KMUTANT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o4">SignalState</a> &lt;= 0) {
00628                         WaitSatisfied = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00629                     }
00630                 }
00631 
00632                 <span class="comment">//</span>
00633                 <span class="comment">// Construct wait block for the current object.</span>
00634                 <span class="comment">//</span>
00635 
00636                 WaitBlock = &amp;WaitBlockArray[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00637                 WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o2">Object</a> = (PVOID)Objectx;
00638                 WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o4">WaitKey</a> = (CSHORT)(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>);
00639                 WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o5">WaitType</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)WaitType;
00640                 WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o1">Thread</a> = Thread;
00641                 WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o3">NextWaitBlock</a> = &amp;WaitBlockArray[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> + 1];
00642             }
00643 
00644             <span class="comment">//</span>
00645             <span class="comment">// If the wait type is wait all, then check to determine if the</span>
00646             <span class="comment">// wait can be satisfied immediately.</span>
00647             <span class="comment">//</span>
00648 
00649             <span class="keywordflow">if</span> ((WaitType == WaitAll) &amp;&amp; (WaitSatisfied)) {
00650                 WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o3">NextWaitBlock</a> = &amp;WaitBlockArray[0];
00651                 <a class="code" href="../../d2/d7/waitsup_8c.html#a2">KiWaitSatisfyAll</a>(WaitBlock);
00652                 WaitStatus = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o16">WaitStatus</a>;
00653                 <span class="keywordflow">goto</span> NoWait;
00654             }
00655 
00656             <span class="comment">//</span>
00657             <span class="comment">// Test for alert pending.</span>
00658             <span class="comment">//</span>
00659 
00660             <a class="code" href="../../d1/d7/wait_8c.html#a0">TestForAlertPending</a>(Alertable);
00661 
00662             <span class="comment">//</span>
00663             <span class="comment">// The wait cannot be satisifed immediately. Check to determine if</span>
00664             <span class="comment">// a timeout value is specified.</span>
00665             <span class="comment">//</span>
00666 
00667             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Timeout)) {
00668 
00669                 <span class="comment">//</span>
00670                 <span class="comment">// If the timeout value is zero, then return immediately without</span>
00671                 <span class="comment">// waiting.</span>
00672                 <span class="comment">//</span>
00673 
00674                 <span class="keywordflow">if</span> (!(Timeout-&gt;LowPart | Timeout-&gt;HighPart)) {
00675                     WaitStatus = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)(STATUS_TIMEOUT);
00676                     <span class="keywordflow">goto</span> NoWait;
00677                 }
00678 
00679                 <span class="comment">//</span>
00680                 <span class="comment">// Initialize a wait block for the thread specific timer,</span>
00681                 <span class="comment">// initialize timer wait list head, insert the timer in the</span>
00682                 <span class="comment">// timer tree, and increment the number of wait objects.</span>
00683                 <span class="comment">//</span>
00684                 <span class="comment">// N.B. The timer wait block is initialized when the respective</span>
00685                 <span class="comment">//      thread is initialized. Thus the constant fields are not</span>
00686                 <span class="comment">//      reinitialized. These include the wait object, wait key,</span>
00687                 <span class="comment">//      wait type, and the wait list entry link pointers.</span>
00688                 <span class="comment">//</span>
00689 
00690                 WaitTimer = &amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o28">WaitBlock</a>[<a class="code" href="../../d4/d9/ke_8h.html#a9">TIMER_WAIT_BLOCK</a>];
00691                 WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o3">NextWaitBlock</a> = WaitTimer;
00692                 WaitBlock = WaitTimer;
00693                 Timer = &amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o39">Timer</a>;
00694                 InitializeListHead(&amp;Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o5">WaitListHead</a>);
00695                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/timersup_8c.html#a1">KiInsertTreeTimer</a>(Timer, *Timeout) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00696                     WaitStatus = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)STATUS_TIMEOUT;
00697                     <span class="keywordflow">goto</span> NoWait;
00698                 }
00699 
00700                 DueTime.QuadPart = Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o1">DueTime</a>.QuadPart;
00701             }
00702 
00703             <span class="comment">//</span>
00704             <span class="comment">// Close up the circular list of wait control blocks.</span>
00705             <span class="comment">//</span>
00706 
00707             WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o3">NextWaitBlock</a> = &amp;WaitBlockArray[0];
00708 
00709             <span class="comment">//</span>
00710             <span class="comment">// Insert wait blocks in object wait lists.</span>
00711             <span class="comment">//</span>
00712 
00713             WaitBlock = &amp;WaitBlockArray[0];
00714             <span class="keywordflow">do</span> {
00715                 Objectx = (<a class="code" href="../../d3/d7/struct__KMUTANT.html">PKMUTANT</a>)WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o2">Object</a>;
00716                 InsertTailList(&amp;Objectx-&gt;<a class="code" href="../../d3/d7/struct__KMUTANT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o5">WaitListHead</a>, &amp;WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o0">WaitListEntry</a>);
00717                 WaitBlock = WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o3">NextWaitBlock</a>;
00718             } <span class="keywordflow">while</span> (WaitBlock != &amp;WaitBlockArray[0]);
00719 
00720             <span class="comment">//</span>
00721             <span class="comment">// If the current thread is processing a queue entry, then attempt</span>
00722             <span class="comment">// to activate another thread that is blocked on the queue object.</span>
00723             <span class="comment">//</span>
00724 
00725             Queue = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o37">Queue</a>;
00726             <span class="keywordflow">if</span> (Queue != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00727                 <a class="code" href="../../d8/d3/queueobj_8c.html#a7">KiActivateWaiterQueue</a>(Queue);
00728             }
00729 
00730             <span class="comment">//</span>
00731             <span class="comment">// Set the thread wait parameters, set the thread dispatcher state</span>
00732             <span class="comment">// to Waiting, and insert the thread in the wait list.</span>
00733             <span class="comment">//</span>
00734 
00735             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o57">Alertable</a> = Alertable;
00736             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o18">WaitMode</a> = WaitMode;
00737             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o20">WaitReason</a> = (UCHAR)WaitReason;
00738             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o23">WaitTime</a>= KiQueryLowTickCount();
00739             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o8">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a406a196">Waiting</a>;
00740             <a class="code" href="../../d0/d0/ki_8h.html#a15">KiInsertWaitList</a>(WaitMode, Thread);
00741 
00742             <span class="comment">//</span>
00743             <span class="comment">// Switch context to selected thread.</span>
00744             <span class="comment">//</span>
00745             <span class="comment">// Control is returned at the original IRQL.</span>
00746             <span class="comment">//</span>
00747 
00748             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a> &lt;= DISPATCH_LEVEL);
00749 
00750             WaitStatus = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d0/d0/ki_8h.html#a138">KiSwapThread</a>();
00751 
00752             <span class="comment">//</span>
00753             <span class="comment">// If the thread was not awakened to deliver a kernel mode APC,</span>
00754             <span class="comment">// then the wait status.</span>
00755             <span class="comment">//</span>
00756 
00757             <span class="keywordflow">if</span> (WaitStatus != STATUS_KERNEL_APC) {
00758                 <span class="keywordflow">return</span> WaitStatus;
00759             }
00760 
00761             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Timeout)) {
00762 
00763                 <span class="comment">//</span>
00764                 <span class="comment">// Reduce the amount of time remaining before timeout occurs.</span>
00765                 <span class="comment">//</span>
00766 
00767                 Timeout = <a class="code" href="../../d1/d7/wait_8c.html#a6">KiComputeWaitInterval</a>(OriginalTime,
00768                                                 &amp;DueTime,
00769                                                 &amp;NewTime);
00770             }
00771         }
00772 
00773         <span class="comment">//</span>
00774         <span class="comment">// Raise IRQL to DISPATCH_LEVEL and lock the dispatcher database.</span>
00775         <span class="comment">//</span>
00776 
00777         <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a>);
00778     } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00779 
00780     <span class="comment">//</span>
00781     <span class="comment">// The thread is alerted or a user APC should be delivered. Unlock the</span>
00782     <span class="comment">// dispatcher database, lower IRQL to its previous value, and return</span>
00783     <span class="comment">// the wait status.</span>
00784     <span class="comment">//</span>
00785 
00786     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a>);
00787     <span class="keywordflow">return</span> WaitStatus;
00788 
00789     <span class="comment">//</span>
00790     <span class="comment">// The wait has been satisfied without actually waiting.</span>
00791     <span class="comment">//</span>
00792     <span class="comment">// If the thread priority that is less than time critical, then reduce</span>
00793     <span class="comment">// the thread quantum. If a quantum end occurs, then reduce the thread</span>
00794     <span class="comment">// priority.</span>
00795     <span class="comment">//</span>
00796 
00797 NoWait:
00798     <a class="code" href="../../d1/d7/wait_8c.html#a1">KiAdjustQuantumThread</a>(Thread);
00799 
00800     <span class="comment">//</span>
00801     <span class="comment">// Unlock the dispatcher database, lower IRQL to its previous value, and</span>
00802     <span class="comment">// return the wait status.</span>
00803     <span class="comment">//</span>
00804 
00805     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a>);
00806     <span class="keywordflow">return</span> WaitStatus;
00807 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="wait.c::KeWaitForSingleObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS KeWaitForSingleObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/ke_8h.html#a53">KWAIT_REASON</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WaitReason</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WaitMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Alertable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER Timeout&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">810</a> of file <a class="el" href="../../d2/d6/wait_8c-source.html">wait.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l00657">_KTHREAD::Alertable</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00575">_KTHREAD::ApcState</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00523">_KTIMER::DueTime</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00522">_KTIMER::Header</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00485">_KMUTANT::Header</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00246">_KAPC_STATE::KernelApcPending</a>, <a class="el" href="../../d9/d2/queueobj_8c-source.html#l00649">KiActivateWaiterQueue()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00079">KiAdjustQuantumThread()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l01175">KiComputeWaitInterval()</a>, <a class="el" href="../../d6/d1/timersup_8c-source.html#l00042">KiInsertTreeTimer()</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00225">KiInsertWaitList</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d0/d0/ki_8h.html#a138">KiSwapThread()</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00960">KiWaitSatisfyMutant</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00997">KiWaitSatisfyOther</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l01152">KiWaitSingleCallData</a>, <a class="el" href="../../d4/d9/ke_8h.html#a53">KWAIT_REASON</a>, <a class="el" href="../../d4/d9/ke_8h.html#a402a159">MutantObject</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00283">_KWAIT_BLOCK::NextWaitBlock</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00282">_KWAIT_BLOCK::Object</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00487">_KMUTANT::OwnerThread</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00612">_KTHREAD::Queue</a>, <a class="el" href="../../d4/d9/ke_8h.html#a402a161">QueueObject</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00054">RECORD_CALL_DATA</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00262">_DISPATCHER_HEADER::SignalState</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00569">_KTHREAD::State</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00057">TestForAlertPending</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00614">_KTHREAD::Timer</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00084">TIMER_WAIT_BLOCK</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00258">_DISPATCHER_HEADER::Type</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00594">_KTHREAD::WaitBlock</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00587">_KTHREAD::WaitBlockList</a>, <a class="el" href="../../d4/d9/ke_8h.html#a406a196">Waiting</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00583">_KTHREAD::WaitIrql</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00284">_KWAIT_BLOCK::WaitKey</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00280">_KWAIT_BLOCK::WaitListEntry</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00263">_DISPATCHER_HEADER::WaitListHead</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00584">_KTHREAD::WaitMode</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00585">_KTHREAD::WaitNext</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00586">_KTHREAD::WaitReason</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00582">_KTHREAD::WaitStatus</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00589">_KTHREAD::WaitTime</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00285">_KWAIT_BLOCK::WaitType</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/copysup_8c-source.html#l01790">CcCanIWrite()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00387">CcInitializeCacheMap()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l02717">CcSetValidData()</a>, <a class="el" href="../../d6/d0/lazyrite_8c-source.html#l00158">CcWaitForCurrentLazyWriterActivity()</a>, <a class="el" href="../../d6/d2/vacbsup_8c-source.html#l01062">CcWaitOnActiveCount()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l02952">CcZeroData()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00351">CmpFileRead()</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00046">CmpOpenHiveFiles()</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01706">DoResourceTest()</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00413">ExAllocatePool()</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00970">ExFreePool()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00240">ExLockHandleTableEntry()</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00190">ExLockPool()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l03060">ExpGetProcessInformation()</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l02506">ExpWaitForResource()</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00463">ExpWaitForResourceDdk()</a>, <a class="el" href="../../d3/d3/ex_2callback_8c-source.html#l00479">ExUnregisterCallback()</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00703">FsRecGetDeviceSectors()</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00800">FsRecGetDeviceSectorSize()</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00579">FsRecLoadFileSystem()</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00907">FsRecReadBlock()</a>, <a class="el" href="../../d8/d0/faulttol_8c-source.html#l00031">FsRtlBalanceReads()</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00418">FsRtlDeregisterUncProvider()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l02691">FsRtlGetFileSize()</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00247">FsRtlRegisterUncProvider()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l02864">FsRtlSetFileSize()</a>, <a class="el" href="../../d8/d0/faulttol_8c-source.html#l00096">FsRtlSyncVolumes()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l03025">FsRtlWaitOnIrp()</a>, <a class="el" href="../../d6/d8/w32_2ntuser_2kernel_2pnp_8c-source.html#l00162">GetDeviceChangeInfo()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l01022">HalpEnableAutomaticDriveLetterAssignment()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l03735">HalpGetFullGeometry()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l01171">HalpIsOldStyleFloppy()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l00851">HalpNextMountLetter()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l00792">HalpQueryDriveLayout()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l00706">HalpQueryPartitionType()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l01078">HalpSetMountLetter()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l02146">InitiateWin32kCleanup()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12535">IoCancelFileOpen()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01300">IoFreeDumpStack()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l11641">IoGetBootDiskInformation()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08307">IoGetDmaAdapter()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00181">IopAcquireFileObjectLock()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07141">IopAllocateBootResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00720">IopAllocateResources()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00417">IopCancelAlertedRequest()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00036">IopCloseFile()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04061">IopCompleteDumpInitialization()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00657">IopCompleteUnloadOrDelete()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01047">IopCreateArcNames()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00417">IopDeleteFile()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l03255">IopFilterResourceRequirementsCall()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00384">IopGetDumpStack()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02256">IopGetFileName()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02718">IopGetSetObjectId()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00975">IopGetSetSecurityObject()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02851">IopGetVolumeId()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02977">IopHardErrorThread()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00103">IopHardwareProfileBeginTransition()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04710">IopInvalidateVolumesForDevice()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06180">IopLegacyResourceAllocation()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04077">IopLoadFileSystemDriver()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01080">IopLockMountedDeviceForRemove()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04282">IopMountVolume()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09221">IoPnPDeliverServicePowerNotification()</a>, <a class="el" href="../../d5/d2/parse_8c-source.html#l00202">IopParseDevice()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00821">IopProcessStartDevices()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00912">IopProcessStartDevicesWorker()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07717">IopQueryConflictList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04667">IopQueryRebalanceWorker()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05397">IopQueryXxxInformation()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07470">IopReallocateResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06672">IopRequestHwProfileChangeNotification()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06127">IopSendMessageToTrackService()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06716">IopSetRemoteLink()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06926">IopSynchronousApiServiceTail()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l07030">IopSynchronousServiceTail()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01233">IopUnlockMountedDeviceForRemove()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04617">IopWaitForBootDevicesDeleted()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04508">IopWaitForBootDevicesStarted()</a>, <a class="el" href="../../d5/d0/pnppower_8c-source.html#l00422">IopWarmEjectDevice()</a>, <a class="el" href="../../d8/d6/io_2remlock_8c-source.html#l00394">IoReleaseRemoveLockAndWaitEx()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06017">IoReportTargetDeviceChange()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09835">IoSetInformation()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l10359">IoShutdownSystem()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01291">IoSynchronousInvalidateDeviceRelations()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l11389">IoVerifyVolume()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02499">IovpInternalCompleteAfterWait()</a>, <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l01531">IovpThrowBogusSynchronousIrp()</a>, <a class="el" href="../../d6/d0/i386_2thredini_8c-source.html#l00454">KeSetAutoAlignmentThread()</a>, <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00322">KeSwapProcessOrStack()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l01126">KiSetServerWaitClientEvent()</a>, <a class="el" href="../../d1/d1/thredsup_8c-source.html#l00770">KiSuspendThread()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00706">LfsCloseLogFile()</a>, <a class="el" href="../../d8/d0/lbcbsup_8c-source.html#l00037">LfsFlushLbcb()</a>, <a class="el" href="../../d8/d4/logrcsup_8c-source.html#l00055">LfsWriteLogRecordIntoLogPage()</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00397">LpcpExtendPortZone()</a>, <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l01407">LpcRequestWaitReplyPort()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l02149">MiCheckControlAreaStatus()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01095">MiCheckForCrashDump()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00166">MiCheckPageFilePath()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l02809">MiCheckPurgeAndUpMapCount()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01075">MiCleanSection()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l01424">MiCreateImageFileMap()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l01544">MiDereferenceSession()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02715">MiEmptyAllWorkingSets()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00941">MiEnsureAvailablePageOrWait()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l01014">MiFlushSectionInternal()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l03701">MiGatherPagefilePages()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04911">MiIssuePageExtendRequest()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l01273">MiLookupPsLoadedModule()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l05287">MiMakeOutswappedPageResident()</a>, <a class="el" href="../../d8/d1/alpha_2hypermap_8c-source.html#l00153">MiMapImageHeaderInHyperSpace()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04239">MiMappedPageWriter()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02831">MiModifiedPageWriterWorker()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l02335">MiWaitForInPageComplete()</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l03846">MmAddVerifierThunks()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l01695">MmCleanProcessAddressSpace()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l00390">MmCreateSection()</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l04046">MmGetVerifierInformation()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l01548">MmPurgeSection()</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l04226">MmSetVerifierInformation()</a>, <a class="el" href="../../d2/d8/shutdown_8c-source.html#l00041">MmShutdownSystem()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02896">MmUnloadSystemImage()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">NtDuplicateObject()</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00151">NtGetContextThread()</a>, <a class="el" href="../../d9/d3/loadunld_8c-source.html#l00035">NtLoadDriver()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00101">NtQueryInformationFile()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00531">NtQueryInformationProcess()</a>, <a class="el" href="../../d5/d6/lpcrecv_8c-source.html#l00029">NtReplyWaitReceivePort()</a>, <a class="el" href="../../d5/d6/lpcrecv_8c-source.html#l00635">NtReplyWaitReceivePortEx()</a>, <a class="el" href="../../d6/d6/lpcreply_8c-source.html#l00375">NtReplyWaitReplyPort()</a>, <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l00395">NtRequestWaitReplyPort()</a>, <a class="el" href="../../d6/d5/lpcconn_8c-source.html#l00084">NtSecureConnectPort()</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00352">NtSetContextThread()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">NtSetInformationFile()</a>, <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l01235">NtSetLdtEntries()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00038">NtSignalAndWaitForSingleObject()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00517">NtStartProfile()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00680">NtStopProfile()</a>, <a class="el" href="../../d9/d3/loadunld_8c-source.html#l00244">NtUnloadDriver()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00282">NtWaitForSingleObject()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l01234">ObFindHandleForObject()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00815">ObInitProcess()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l01022">ObKillProcess()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00837">ObWaitForSingleObject()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01966">PsLockProcess()</a>, <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l01061">PspQueryDescriptorThread()</a>, <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00108">PspQueryLdtInformation()</a>, <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00503">PspSetLdtInformation()</a>, <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00308">PspSetLdtSize()</a>, <a class="el" href="../../d8/d1/power_8c-source.html#l00076">QueuePowerRequest()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l03858">RawInputThread()</a>, <a class="el" href="../../d6/d8/w32_2ntuser_2kernel_2pnp_8c-source.html#l01535">RequestDeviceChange()</a>, <a class="el" href="../../d9/d6/rtl_2remlock_8c-source.html#l00328">RtlReleaseRemoveLockAndWait()</a>, <a class="el" href="../../d1/d6/dev2dos_8c-source.html#l00580">RtlVolumeDeviceToDosName()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01456">SmbTraceCompleteRdr()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01242">SmbTraceCompleteSrv()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00551">SmbTraceStart()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01050">SmbTraceStop()</a>, <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00637">UdfAddVmcbMapping()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00573">UdfPerformDevIoCtrl()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00194">UdfPnpQueryRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00350">UdfPnpRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00500">UdfPnpSurpriseRemove()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00685">UdfReadSectors()</a>, <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00867">UdfRemoveVmcbMapping()</a>, <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00553">UdfVmcbLbnToVbn()</a>, <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00461">UdfVmcbVbnToLbn()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01740">UdfWaitSync()</a>, <a class="el" href="../../d0/d3/ke_2i386_2vdm_8c-source.html#l00777">VdmDispatchStringIoToHandler()</a>, <a class="el" href="../../d4/d3/vdm_2vdm_8c-source.html#l00087">VdmQueryDirectoryFile()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l00190">xHalExamineMBR()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l00382">xHalGetPartialGeometry()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l03486">xHalIoClearPartitionTable()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l01739">xHalIoReadPartitionTable()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l02485">xHalIoSetPartitionInformation()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l02879">xHalIoWritePartitionTable()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l00114">xxxDesktopThread()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l00140">xxxInitInput()</a>, <a class="el" href="../../d9/d7/winsta_8c-source.html#l00026">xxxInitTerminal()</a>, <a class="el" href="../../d7/d9/w32_2ntuser_2kernel_2misc_8c-source.html#l00188">xxxRemoteDisconnect()</a>, and <a class="el" href="../../d7/d2/queue_8c-source.html#l04382">xxxSleepThread()</a>.
<p>
<pre class="fragment"><div>00820                    :
00821 
00822     This function waits until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified object attains a state of
00823     Signaled. An optional timeout can also be specified. If a timeout
00824     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait will not be satisfied until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
00825     attains a state of Signaled. If a timeout <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
00826     has not attained a state of Signaled when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timeout expires, then
00827     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> automatically satisfied. If an <span class="keyword">explicit</span> timeout value of
00828     zero <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified, then no wait will occur <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait cannot be satisfied
00829     immediately. The wait can also be specified as alertable.
00830 
00831 Arguments:
00832 
00833     Object - Supplies a pointer to a dispatcher object.
00834 
00835     WaitReason - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a10">reason</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait.
00836 
00837     WaitMode  - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor mode in which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to occur.
00838 
00839     Alertable - Supplies a <span class="keywordtype">boolean</span> value that specifies whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00840         alertable.
00841 
00842     Timeout - Supplies a pointer to an optional absolute of relative time over
00843         which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to occur.
00844 
00845 Return Value:
00846 
00847     The wait completion status. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of STATUS_TIMEOUT <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> a
00848     timeout occurred. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of STATUS_SUCCESS <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00849     object satisfied <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of STATUS_ALERTED <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00850     wait was aborted to deliver an alert to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of
00851     STATUS_USER_APC <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait was aborted to deliver a user
00852     APC to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread.
00853 
00854 --*/
00855 
00856 {
00857 
00858     LARGE_INTEGER DueTime;
00859     LARGE_INTEGER NewTime;
00860     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> NextThread;
00861     <a class="code" href="../../d3/d7/struct__KMUTANT.html">PKMUTANT</a> Objectx;
00862     PLARGE_INTEGER OriginalTime;
00863     <a class="code" href="../../d7/d7/struct__KQUEUE.html">PRKQUEUE</a> Queue;
00864     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> Thread;
00865     <a class="code" href="../../d3/d8/struct__KTIMER.html">PRKTIMER</a> Timer;
00866     <a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">PKWAIT_BLOCK</a> WaitBlock;
00867     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> WaitStatus;
00868     <a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">PKWAIT_BLOCK</a> WaitTimer;
00869 
00870     <span class="comment">//</span>
00871     <span class="comment">// Collect call data.</span>
00872     <span class="comment">//</span>
00873 
00874 <span class="preprocessor">#if defined(_COLLECT_WAIT_SINGLE_CALLDATA_)</span>
00875 <span class="preprocessor"></span>
00876     <a class="code" href="../../d5/d8/ex_8h.html#a1">RECORD_CALL_DATA</a>(&amp;KiWaitSingleCallData);
00877 
00878 <span class="preprocessor">#endif</span>
00879 <span class="preprocessor"></span>
00880     <span class="comment">//</span>
00881     <span class="comment">// If the dispatcher database lock is not already held, then set the wait</span>
00882     <span class="comment">// IRQL and lock the dispatcher database. Else set boolean wait variable</span>
00883     <span class="comment">// to FALSE.</span>
00884     <span class="comment">//</span>
00885 
00886     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00887     <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o19">WaitNext</a>) {
00888         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o19">WaitNext</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00889 
00890     } <span class="keywordflow">else</span> {
00891         <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a>);
00892     }
00893 
00894     <span class="comment">//</span>
00895     <span class="comment">// Start of wait loop.</span>
00896     <span class="comment">//</span>
00897     <span class="comment">// Note this loop is repeated if a kernel APC is delivered in the middle</span>
00898     <span class="comment">// of the wait or a kernel APC is pending on the first attempt through</span>
00899     <span class="comment">// the loop.</span>
00900     <span class="comment">//</span>
00901 
00902     OriginalTime = Timeout;
00903     WaitBlock = &amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o28">WaitBlock</a>[0];
00904     <span class="keywordflow">do</span> {
00905 
00906         <span class="comment">//</span>
00907         <span class="comment">// Test to determine if a kernel APC is pending.</span>
00908         <span class="comment">//</span>
00909         <span class="comment">// If a kernel APC is pending and the previous IRQL was less than</span>
00910         <span class="comment">// APC_LEVEL, then a kernel APC was queued by another processor just</span>
00911         <span class="comment">// after IRQL was raised to DISPATCH_LEVEL, but before the dispatcher</span>
00912         <span class="comment">// database was locked.</span>
00913         <span class="comment">//</span>
00914         <span class="comment">// N.B. that this can only happen in a multiprocessor system.</span>
00915         <span class="comment">//</span>
00916 
00917         <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o3">KernelApcPending</a> &amp;&amp; (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a> &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>)) {
00918 
00919             <span class="comment">//</span>
00920             <span class="comment">// Unlock the dispatcher database and lower IRQL to its previous</span>
00921             <span class="comment">// value. An APC interrupt will immediately occur which will result</span>
00922             <span class="comment">// in the delivery of the kernel APC if possible.</span>
00923             <span class="comment">//</span>
00924 
00925             <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a>);
00926 
00927         } <span class="keywordflow">else</span> {
00928 
00929             <span class="comment">//</span>
00930             <span class="comment">// Test if the wait can be immediately satisfied.</span>
00931             <span class="comment">//</span>
00932 
00933             Objectx = (<a class="code" href="../../d3/d7/struct__KMUTANT.html">PKMUTANT</a>)Object;
00934             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o16">WaitStatus</a> = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)0;
00935 
00936             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Objectx-&gt;<a class="code" href="../../d3/d7/struct__KMUTANT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o0">Type</a> != QueueObject);
00937 
00938             <span class="comment">//</span>
00939             <span class="comment">// If the object is a mutant object and the mutant object has been</span>
00940             <span class="comment">// recursively acquired MINLONG times, then raise an exception.</span>
00941             <span class="comment">// Otherwise if the signal state of the mutant object is greater</span>
00942             <span class="comment">// than zero, or the current thread is the owner of the mutant</span>
00943             <span class="comment">// object, then satisfy the wait.</span>
00944             <span class="comment">//</span>
00945 
00946             <span class="keywordflow">if</span> (Objectx-&gt;<a class="code" href="../../d3/d7/struct__KMUTANT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o0">Type</a> == <a class="code" href="../../d4/d9/ke_8h.html#a402a159">MutantObject</a>) {
00947                 <span class="keywordflow">if</span> ((Objectx-&gt;<a class="code" href="../../d3/d7/struct__KMUTANT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o4">SignalState</a> &gt; 0) ||
00948                     (Thread == Objectx-&gt;<a class="code" href="../../d3/d7/struct__KMUTANT.html#o2">OwnerThread</a>)) {
00949                     <span class="keywordflow">if</span> (Objectx-&gt;<a class="code" href="../../d3/d7/struct__KMUTANT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o4">SignalState</a> != MINLONG) {
00950                         <a class="code" href="../../d0/d0/ki_8h.html#a26">KiWaitSatisfyMutant</a>(Objectx, Thread);
00951                         WaitStatus = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)(Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o16">WaitStatus</a>);
00952                         <span class="keywordflow">goto</span> NoWait;
00953 
00954                     } <span class="keywordflow">else</span> {
00955                         <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a>);
00956                         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_MUTANT_LIMIT_EXCEEDED);
00957                     }
00958                 }
00959 
00960             <span class="comment">//</span>
00961             <span class="comment">// If the signal state is greater than zero, then satisfy the wait.</span>
00962             <span class="comment">//</span>
00963 
00964             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Objectx-&gt;<a class="code" href="../../d3/d7/struct__KMUTANT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o4">SignalState</a> &gt; 0) {
00965                 <a class="code" href="../../d0/d0/ki_8h.html#a27">KiWaitSatisfyOther</a>(Objectx);
00966                 WaitStatus = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)(0);
00967                 <span class="keywordflow">goto</span> NoWait;
00968             }
00969 
00970             <span class="comment">//</span>
00971             <span class="comment">// Construct a wait block for the object.</span>
00972             <span class="comment">//</span>
00973 
00974             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o21">WaitBlockList</a> = WaitBlock;
00975             WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o2">Object</a> = Object;
00976             WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o4">WaitKey</a> = (CSHORT)(STATUS_SUCCESS);
00977             WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o5">WaitType</a> = WaitAny;
00978 
00979             <span class="comment">//</span>
00980             <span class="comment">// Test for alert pending.</span>
00981             <span class="comment">//</span>
00982 
00983             <a class="code" href="../../d1/d7/wait_8c.html#a0">TestForAlertPending</a>(Alertable);
00984 
00985             <span class="comment">//</span>
00986             <span class="comment">// The wait cannot be satisifed immediately. Check to determine if</span>
00987             <span class="comment">// a timeout value is specified.</span>
00988             <span class="comment">//</span>
00989 
00990             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Timeout)) {
00991 
00992                 <span class="comment">//</span>
00993                 <span class="comment">// If the timeout value is zero, then return immediately without</span>
00994                 <span class="comment">// waiting.</span>
00995                 <span class="comment">//</span>
00996 
00997                 <span class="keywordflow">if</span> (!(Timeout-&gt;LowPart | Timeout-&gt;HighPart)) {
00998                     WaitStatus = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)(STATUS_TIMEOUT);
00999                     <span class="keywordflow">goto</span> NoWait;
01000                 }
01001 
01002                 <span class="comment">//</span>
01003                 <span class="comment">// Initialize a wait block for the thread specific timer, insert</span>
01004                 <span class="comment">// wait block in timer wait list, insert the timer in the timer</span>
01005                 <span class="comment">// tree.</span>
01006                 <span class="comment">//</span>
01007                 <span class="comment">// N.B. The timer wait block is initialized when the respective</span>
01008                 <span class="comment">//      thread is initialized. Thus the constant fields are not</span>
01009                 <span class="comment">//      reinitialized. These include the wait object, wait key,</span>
01010                 <span class="comment">//      wait type, and the wait list entry link pointers.</span>
01011                 <span class="comment">//</span>
01012 
01013                 Timer = &amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o39">Timer</a>;
01014                 WaitTimer = &amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o28">WaitBlock</a>[<a class="code" href="../../d4/d9/ke_8h.html#a9">TIMER_WAIT_BLOCK</a>];
01015                 WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o3">NextWaitBlock</a> = WaitTimer;
01016                 Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o5">WaitListHead</a>.Flink = &amp;WaitTimer-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o0">WaitListEntry</a>;
01017                 Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o5">WaitListHead</a>.Blink = &amp;WaitTimer-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o0">WaitListEntry</a>;
01018                 WaitTimer-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o3">NextWaitBlock</a> = WaitBlock;
01019                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/timersup_8c.html#a1">KiInsertTreeTimer</a>(Timer, *Timeout) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01020                     WaitStatus = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)STATUS_TIMEOUT;
01021                     <span class="keywordflow">goto</span> NoWait;
01022                 }
01023 
01024                 DueTime.QuadPart = Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o1">DueTime</a>.QuadPart;
01025 
01026             } <span class="keywordflow">else</span> {
01027                 WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o3">NextWaitBlock</a> = WaitBlock;
01028             }
01029 
01030             <span class="comment">//</span>
01031             <span class="comment">// Insert wait block in object wait list.</span>
01032             <span class="comment">//</span>
01033 
01034             InsertTailList(&amp;Objectx-&gt;<a class="code" href="../../d3/d7/struct__KMUTANT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o5">WaitListHead</a>, &amp;WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o0">WaitListEntry</a>);
01035 
01036             <span class="comment">//</span>
01037             <span class="comment">// If the current thread is processing a queue entry, then attempt</span>
01038             <span class="comment">// to activate another thread that is blocked on the queue object.</span>
01039             <span class="comment">//</span>
01040 
01041             Queue = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o37">Queue</a>;
01042             <span class="keywordflow">if</span> (Queue != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01043                 <a class="code" href="../../d8/d3/queueobj_8c.html#a7">KiActivateWaiterQueue</a>(Queue);
01044             }
01045 
01046             <span class="comment">//</span>
01047             <span class="comment">// Set the thread wait parameters, set the thread dispatcher state</span>
01048             <span class="comment">// to Waiting, and insert the thread in the wait list.</span>
01049             <span class="comment">//</span>
01050 
01051             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o57">Alertable</a> = Alertable;
01052             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o18">WaitMode</a> = WaitMode;
01053             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o20">WaitReason</a> = (UCHAR)WaitReason;
01054             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o23">WaitTime</a>= KiQueryLowTickCount();
01055             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o8">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a406a196">Waiting</a>;
01056             <a class="code" href="../../d0/d0/ki_8h.html#a15">KiInsertWaitList</a>(WaitMode, Thread);
01057 
01058             <span class="comment">//</span>
01059             <span class="comment">// Switch context to selected thread.</span>
01060             <span class="comment">//</span>
01061             <span class="comment">// Control is returned at the original IRQL.</span>
01062             <span class="comment">//</span>
01063 
01064             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a> &lt;= DISPATCH_LEVEL);
01065 
01066             WaitStatus = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d0/d0/ki_8h.html#a138">KiSwapThread</a>();
01067 
01068             <span class="comment">//</span>
01069             <span class="comment">// If the thread was not awakened to deliver a kernel mode APC,</span>
01070             <span class="comment">// then return wait status.</span>
01071             <span class="comment">//</span>
01072 
01073             <span class="keywordflow">if</span> (WaitStatus != STATUS_KERNEL_APC) {
01074                 <span class="keywordflow">return</span> WaitStatus;
01075             }
01076 
01077             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Timeout)) {
01078 
01079                 <span class="comment">//</span>
01080                 <span class="comment">// Reduce the amount of time remaining before timeout occurs.</span>
01081                 <span class="comment">//</span>
01082 
01083                 Timeout = <a class="code" href="../../d1/d7/wait_8c.html#a6">KiComputeWaitInterval</a>(OriginalTime,
01084                                                 &amp;DueTime,
01085                                                 &amp;NewTime);
01086             }
01087         }
01088 
01089         <span class="comment">//</span>
01090         <span class="comment">// Raise IRQL to DISPATCH_LEVEL and lock the dispatcher database.</span>
01091         <span class="comment">//</span>
01092 
01093         <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a>);
01094     } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01095 
01096     <span class="comment">//</span>
01097     <span class="comment">// The thread is alerted or a user APC should be delivered. Unlock the</span>
01098     <span class="comment">// dispatcher database, lower IRQL to its previous value, and return</span>
01099     <span class="comment">// the wait status.</span>
01100     <span class="comment">//</span>
01101 
01102     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a>);
01103     <span class="keywordflow">return</span> WaitStatus;
01104 
01105     <span class="comment">//</span>
01106     <span class="comment">// The wait has been satisfied without actually waiting.</span>
01107     <span class="comment">//</span>
01108     <span class="comment">// If the thread priority that is less than time critical, then reduce</span>
01109     <span class="comment">// the thread quantum. If a quantum end occurs, then reduce the thread</span>
01110     <span class="comment">// priority.</span>
01111     <span class="comment">//</span>
01112 
01113 NoWait:
01114     <a class="code" href="../../d1/d7/wait_8c.html#a1">KiAdjustQuantumThread</a>(Thread);
01115 
01116     <span class="comment">//</span>
01117     <span class="comment">// Unlock the dispatcher database, lower IRQL to its previous value, and</span>
01118     <span class="comment">// return the wait status.</span>
01119     <span class="comment">//</span>
01120 
01121     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a>);
01122     <span class="keywordflow">return</span> WaitStatus;
01123 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="wait.c::KiAdjustQuantumThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiAdjustQuantumThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Thread</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d6/wait_8c-source.html#l00079">79</a> of file <a class="el" href="../../d2/d6/wait_8c-source.html">wait.c</a>.
<p>
References <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>, <a class="el" href="../../d1/d1/thredsup_8c-source.html#l00095">KiFindReadyThread()</a>, <a class="el" href="../../d1/d1/thredsup_8c-source.html#l00576">KiSetPriorityThread()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d9/ke_8h.html#a406a194">Standby</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00569">_KTHREAD::State</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00769">_KPROCESS::ThreadQuantum</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00044">TIME_CRITICAL_PRIORITY_BOUND</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00029">WAIT_QUANTUM_DECREMENT</a>.
<p>
Referenced by <a class="el" href="../../d2/d6/wait_8c-source.html#l00395">KeWaitForMultipleObjects()</a>, and <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>.
<p>
<pre class="fragment"><div>00085                    :
00086 
00087     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not a time critical or realtime thread, then
00088     adjust its quantum in accordance with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> adjustment that would have
00089     occured <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread had actually waited.
00090 
00091 Arguments:
00092 
00093     Thread - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread.
00094 
00095 Return Value:
00096 
00097     None.
00098 
00099 --*/
00100 
00101 {
00102     PKPRCB Prcb;
00103     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00104     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> NewThread;
00105     SCHAR ThreadPriority;
00106 
00107     <span class="keywordflow">if</span> ((Thread-&gt;Priority &lt; LOW_REALTIME_PRIORITY) &amp;&amp;
00108         (Thread-&gt;BasePriority &lt; <a class="code" href="../../d0/d0/ki_8h.html#a4">TIME_CRITICAL_PRIORITY_BOUND</a>)) {
00109         Thread-&gt;Quantum -= <a class="code" href="../../d4/d9/ke_8h.html#a1">WAIT_QUANTUM_DECREMENT</a>;
00110         <span class="keywordflow">if</span> (Thread-&gt;Quantum &lt;= 0) {
00111             Process = Thread-&gt;ApcState.Process;
00112             Thread-&gt;Quantum = Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o13">ThreadQuantum</a>;
00113             ThreadPriority = Thread-&gt;Priority - (Thread-&gt;PriorityDecrement + 1);
00114             <span class="keywordflow">if</span> (ThreadPriority &lt; Thread-&gt;BasePriority) {
00115                 ThreadPriority = Thread-&gt;BasePriority;
00116             }
00117 
00118             Thread-&gt;PriorityDecrement = 0;
00119             <span class="keywordflow">if</span> (ThreadPriority != Thread-&gt;Priority) {
00120                 <a class="code" href="../../d0/d2/thredsup_8c.html#a5">KiSetPriorityThread</a>(Thread, ThreadPriority);
00121 
00122             } <span class="keywordflow">else</span> {
00123                 Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00124                 <span class="keywordflow">if</span> (Prcb-&gt;NextThread == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00125                     NewThread = <a class="code" href="../../d0/d2/thredsup_8c.html#a2">KiFindReadyThread</a>(Thread-&gt;NextProcessor,
00126                                                   ThreadPriority);
00127                     <span class="keywordflow">if</span> (NewThread != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00128                         Prcb-&gt;NextThread = NewThread;
00129                         NewThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o8">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a406a194">Standby</a>;
00130                     }
00131                 }
00132             }
00133         }
00134     }
00135 
00136     <span class="keywordflow">return</span>;
00137 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="wait.c::KiComputeWaitInterval" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PLARGE_INTEGER FASTCALL KiComputeWaitInterval           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>OriginalTime</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>DueTime</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>NewTime</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d6/wait_8c-source.html#l01175">1175</a> of file <a class="el" href="../../d2/d6/wait_8c-source.html">wait.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d9/d2/queueobj_8c-source.html#l00238">KeRemoveQueue()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00395">KeWaitForMultipleObjects()</a>, and <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>.
<p>
<pre class="fragment"><div>01183                    :
01184 
01185     This function recomputes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait interval after a thread has been
01186     awakened to deliver a kernel APC.
01187 
01188 Arguments:
01189 
01190     OriginalTime - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original timeout value.
01191 
01192     DueTime - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous due time.
01193 
01194     NewTime - Supplies a pointer to a variable that receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01195         recomputed wait interval.
01196 
01197 Return Value:
01198 
01199     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> time <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function value.
01200 
01201 --*/
01202 
01203 {
01204 
01205     <span class="comment">//</span>
01206     <span class="comment">// If the original wait time was absolute, then return the same</span>
01207     <span class="comment">// absolute time. Otherwise, reduce the wait time remaining before</span>
01208     <span class="comment">// the time delay expires.</span>
01209     <span class="comment">//</span>
01210 
01211     <span class="keywordflow">if</span> (OriginalTime-&gt;QuadPart &gt;= 0) {
01212         <span class="keywordflow">return</span> OriginalTime;
01213 
01214     } <span class="keywordflow">else</span> {
01215         KiQueryInterruptTime(NewTime);
01216         NewTime-&gt;QuadPart -= DueTime-&gt;QuadPart;
01217         <span class="keywordflow">return</span> NewTime;
01218     }
01219 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="wait.c::KiSetServerWaitClientEvent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS KiSetServerWaitClientEvent           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ServerEvent</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientEvent</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>WaitMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d6/wait_8c-source.html#l01126">1126</a> of file <a class="el" href="../../d2/d6/wait_8c-source.html">wait.c</a>.
<p>
References <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00034">EVENT_INCREMENT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d4/d9/ke_8h.html#a407a212">WrEventPair</a>.
<p>
<pre class="fragment"><div>01134                    :
01135 
01136     This function sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified server event and waits on specified
01137     client event. The wait <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> performed such that an optimal <span class="keywordflow">switch</span> to
01138     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> waiting thread occurs <span class="keywordflow">if</span> possible. No timeout <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> associated with
01139     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait, and thus, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> issuing thread will wait until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client event
01140     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> signaled or an APC <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> delivered.
01141 
01142 Arguments:
01143 
01144     ServerEvent - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> event.
01145 
01146     ClientEvent - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> event.
01147 
01148     WaitMode  - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor mode in which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to occur.
01149 
01150 Return Value:
01151 
01152     The wait completion status. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of STATUS_SUCCESS <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span>
01153     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified object satisfied <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of STATUS_USER_APC <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01154     returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait was aborted to deliver a user APC to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current
01155     thread.
01156 
01157 --*/
01158 
01159 {
01160 
01161     <span class="comment">//</span>
01162     <span class="comment">// Set sever event and wait on client event atomically.</span>
01163     <span class="comment">//</span>
01164 
01165     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(ServerEvent, EVENT_INCREMENT, TRUE);
01166     <span class="keywordflow">return</span> <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(ClientEvent,
01167                                  WrEventPair,
01168                                  (KPROCESSOR_MODE)WaitMode,
01169                                  FALSE,
01170                                  NULL);
01171 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:46:08 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
