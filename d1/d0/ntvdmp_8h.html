<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ntvdmp.h File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ntvdmp.h File Reference</h1>
<p>
<a href="../../d2/d9/ntvdmp_8h-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/ntvdmp_8h.html#a0">VdmQueryDirectoryFile</a> (PVDMQUERYDIRINFO VdmQueryDir)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/ntvdmp_8h.html#a1">VdmIsLegalFatName</a> (POEM_STRING pOemFileNameString)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a1" doxytag="ntvdmp.h::VdmIsLegalFatName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS VdmIsLegalFatName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">POEM_STRING&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pOemFileNameString</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="ntvdmp.h::VdmQueryDirectoryFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS VdmQueryDirectoryFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVDMQUERYDIRINFO&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>VdmQueryDir</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d3/vdm_2vdm_8c-source.html#l00087">87</a> of file <a class="el" href="../../d4/d3/vdm_2vdm_8c-source.html">vdm/vdm.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01154">DO_BUFFERED_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01156">DO_DIRECT_IO</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00265">ExAllocatePoolWithQuotaTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00047">FileName</a>, <a class="el" href="../../d4/d3/vdm_2vdm_8c-source.html#l00032">_QueryDirPoolData::FileName</a>, <a class="el" href="../../d4/d3/vdm_2vdm_8c-source.html#l00033">_QueryDirPoolData::FileNameBuf</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02030">_IO_STACK_LOCATION::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01184">_DEVICE_OBJECT::Flags</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00652">IoAllocateIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00805">IoAllocateMdl()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00044">IoFileObjectType</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06632">IoFreeIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06744">IoFreeMdl()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d2/d1/mm_8h.html#a344a169">IoWriteAccess</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00067">IRP_MJ_DIRECTORY_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00103">IRP_MN_QUERY_DIRECTORY</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01552">IRP_SYNCHRONOUS_API</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d4/d3/vdm_2vdm_8c-source.html#l00031">_QueryDirPoolData::kevent</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01596">_IRP::MdlAddress</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00238">MmProbeAndLockPages()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o24">_IRP::Overlay</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d3/d4/vdm_2vdm_8c.html#a1">PQDIR_POOLDATA</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01417">ProbeAndReadUnicodeString</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01641">_IRP::RequestorMode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01898">SL_INDEX_SPECIFIED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01189">_DEVICE_OBJECT::StackSize</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01629">_IRP::ThreadListEntry</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01711">_IRP::UserBuffer</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, and <a class="el" href="../../d4/d9/ke_8h.html#a407a204">UserRequest</a>.
<p>
Referenced by <a class="el" href="../../d4/d3/vdm_2vdm_8c-source.html#l00049">NtVdmControl()</a>.
<p>
<pre class="fragment"><div>00098          : PVDMQUERYDIRINFO pVdmQueryDir
00099 
00100     FileHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <span class="keywordflow">for</span> which information
00101         should be returned.
00102 
00103     FileInformation - Supplies a buffer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested information
00104         returned about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> contents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory.
00105 
00106     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FileInformation buffer.
00107 
00108     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> - Supplies a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> name within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified directory.
00109 
00110     FileIndex - Supplies a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> index within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified directory.
00111 
00112     The FileInformationClass <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to be FILE_BOTH_DIR_INFORMATION
00113     The Caller's mode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to be <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>
00114     Synchronous IO <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used
00115 
00116 --*/
00117 
00118 {
00119     KIRQL    irql;
00120     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00121     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>  <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00122 
00123     HANDLE FileHandle;
00124     IO_STATUS_BLOCK IoStatusBlock;
00125     PVOID FileInformation;
00126     ULONG Length;
00127     UNICODE_STRING <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>;
00128     PUNICODE_STRING pFileNameSrc;
00129     ULONG FileIndex;
00130 
00131     <a class="code" href="../../d3/d2/struct__QueryDirPoolData.html">PQDIR_POOLDATA</a> QDirPoolData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00132     FILE_FS_DEVICE_INFORMATION DeviceInfo;
00133 
00134     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> mdl;
00135     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00136     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00137     PCHAR SystemBuffer;
00138     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> fileObject;
00139     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject;
00140 
00141 
00142     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00143 
00144     <span class="comment">//</span>
00145     <span class="comment">// We assume that the caller is usermode, so verify all parameters</span>
00146     <span class="comment">// accordingly</span>
00147     <span class="comment">//</span>
00148 
00149     <span class="keywordflow">try</span> {
00150 
00151         <span class="comment">//</span>
00152         <span class="comment">// Copy out the callers service data into local variables</span>
00153         <span class="comment">//</span>
00154         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( pVdmQueryDir, <span class="keyword">sizeof</span>(VDMQUERYDIRINFO), <span class="keyword">sizeof</span>(ULONG));
00155 
00156         FileHandle      = pVdmQueryDir-&gt;FileHandle;
00157         FileInformation = pVdmQueryDir-&gt;FileInformation;
00158         Length          = pVdmQueryDir-&gt;Length;
00159         FileIndex       = pVdmQueryDir-&gt;FileIndex;
00160         pFileNameSrc    = pVdmQueryDir-&gt;FileName;
00161 
00162         <span class="comment">//</span>
00163         <span class="comment">// Ensure that we have a valid file name string</span>
00164         <span class="comment">//</span>
00165 
00166         <span class="comment">//</span>
00167         <span class="comment">// check for pVdmQueryDir-&gt;Filename validity first</span>
00168         <span class="comment">//</span>
00169         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == pFileNameSrc) {
00170            <span class="keywordflow">return</span>(STATUS_INVALID_PARAMETER);
00171         }
00172 
00173         <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(pFileNameSrc);
00174         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Length ||
00175             <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Length &gt; MAXIMUM_FILENAME_LENGTH&lt;&lt;1) {
00176             <span class="keywordflow">return</span>(STATUS_INVALID_PARAMETER);
00177         }
00178 
00179         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Buffer, <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Length, <span class="keyword">sizeof</span>( UCHAR ));
00180 
00181         <span class="comment">//</span>
00182         <span class="comment">// The FileInformation buffer must be writeable by the caller.</span>
00183         <span class="comment">//</span>
00184 
00185         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( FileInformation, Length, <span class="keyword">sizeof</span>( ULONG ) );
00186 
00187         <span class="comment">//</span>
00188         <span class="comment">// Ensure that the caller's supplied buffer is at least large enough</span>
00189         <span class="comment">// to contain the fixed part of the structure required for this</span>
00190         <span class="comment">// query.</span>
00191         <span class="comment">//</span>
00192 
00193         <span class="keywordflow">if</span> (Length &lt; <span class="keyword">sizeof</span>(FILE_BOTH_DIR_INFORMATION)) {
00194             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00195         }
00196 
00197 
00198 
00199         <span class="comment">//</span>
00200         <span class="comment">// Allocate from nonpaged pool a buffer large enough to contain</span>
00201         <span class="comment">// the file name, and the kevent used to wait for io.</span>
00202         <span class="comment">//</span>
00203 
00204         QDirPoolData = (<a class="code" href="../../d3/d2/struct__QueryDirPoolData.html">PQDIR_POOLDATA</a>) <a class="code" href="../../d5/d8/ex_8h.html#a5">ExAllocatePoolWithQuotaTag</a>(
00205                                            NonPagedPool,
00206                                            <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d2/struct__QueryDirPoolData.html">QDIR_POOLDATA</a>) + <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Length,
00207                                            ' MDV');
00208 
00209         <span class="comment">//</span>
00210         <span class="comment">// Capture the file name string into the nonpaged pool block.</span>
00211         <span class="comment">//</span>
00212 
00213         QDirPoolData-&gt;<a class="code" href="../../d3/d2/struct__QueryDirPoolData.html#o1">FileName</a>.Length = <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Length;
00214         QDirPoolData-&gt;<a class="code" href="../../d3/d2/struct__QueryDirPoolData.html#o1">FileName</a>.MaximumLength = <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Length;
00215         QDirPoolData-&gt;<a class="code" href="../../d3/d2/struct__QueryDirPoolData.html#o1">FileName</a>.Buffer = QDirPoolData-&gt;<a class="code" href="../../d3/d2/struct__QueryDirPoolData.html#o2">FileNameBuf</a>;
00216         RtlCopyMemory( QDirPoolData-&gt;<a class="code" href="../../d3/d2/struct__QueryDirPoolData.html#o2">FileNameBuf</a>,
00217                        <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Buffer,
00218                        <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Length );
00219 
00220 
00221     } except(EXCEPTION_EXECUTE_HANDLER) {
00222 
00223         <span class="keywordflow">if</span> (QDirPoolData) {
00224             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(QDirPoolData);
00225         }
00226 
00227         <span class="keywordflow">return</span> GetExceptionCode();
00228     }
00229 
00230     <span class="comment">//</span>
00231     <span class="comment">// There were no blatant errors so far, so reference the file object so</span>
00232     <span class="comment">// the target device object can be found.  Note that if the handle does</span>
00233     <span class="comment">// not refer to a file object, or if the caller does not have the required</span>
00234     <span class="comment">// access to the file, then it will fail.</span>
00235     <span class="comment">//</span>
00236 
00237     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( FileHandle,
00238                                         FILE_LIST_DIRECTORY,
00239                                         IoFileObjectType,
00240                                         UserMode,
00241                                         (PVOID *) &amp;fileObject,
00242                                         (<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">POBJECT_HANDLE_INFORMATION</a>) NULL );
00243     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00244         <span class="keywordflow">if</span> (QDirPoolData) {
00245             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(QDirPoolData);
00246         }
00247         <span class="keywordflow">return</span> status;
00248     }
00249 
00250     <span class="comment">//</span>
00251     <span class="comment">//  We don't handle FO_SYNCHRONOUS_IO, because it requires</span>
00252     <span class="comment">//  io internal finctionality. Ntvdm can get away with this</span>
00253     <span class="comment">//  because it serializes access to the dir handle.</span>
00254     <span class="comment">//</span>
00255 
00256     <span class="comment">//</span>
00257     <span class="comment">// Initialize the kernel event that will signal I/O completion</span>
00258     <span class="comment">//</span>
00259     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> = &amp;QDirPoolData-&gt;<a class="code" href="../../d3/d2/struct__QueryDirPoolData.html#o0">kevent</a>;
00260     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(Event, SynchronizationEvent, FALSE);
00261 
00262 
00263     <span class="comment">//</span>
00264     <span class="comment">// Set the file object to the Not-Signaled state.</span>
00265     <span class="comment">//</span>
00266 
00267     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>( &amp;fileObject-&gt;Event );
00268 
00269     <span class="comment">//</span>
00270     <span class="comment">// Get the address of the target device object.</span>
00271     <span class="comment">//</span>
00272 
00273     DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( fileObject );
00274 
00275     <span class="comment">//</span>
00276     <span class="comment">// Allocate and initialize the I/O Request Packet (IRP) for this operation.</span>
00277     <span class="comment">// The allocation is performed with an exception handler in case the</span>
00278     <span class="comment">// caller does not have enough quota to allocate the packet.</span>
00279 
00280     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>( DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a>, TRUE );
00281     <span class="keywordflow">if</span> (!irp) {
00282 
00283         <span class="comment">//</span>
00284         <span class="comment">// An IRP could not be allocated.  Cleanup and return an appropriate</span>
00285         <span class="comment">// error status code.</span>
00286         <span class="comment">//</span>
00287 
00288         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
00289         <span class="keywordflow">if</span> (QDirPoolData) {
00290             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(QDirPoolData);
00291         }
00292 
00293         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00294     }
00295 
00296     <span class="comment">//</span>
00297     <span class="comment">// Fill in the service independent parameters in the IRP.</span>
00298     <span class="comment">//</span>
00299 
00300     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = (ULONG)<a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>;
00301     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> = <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>;
00302 
00303     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = &amp;IoStatusBlock;
00304     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00305 
00306     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00307     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = (PVOID) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00308     SystemBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00309 
00310 
00311     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00312     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = fileObject;
00313     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.AuxiliaryBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00314     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00315 
00316     <span class="comment">//</span>
00317     <span class="comment">// Get a pointer to the stack location for the first driver.  This will be</span>
00318     <span class="comment">// used to pass the function codes and parameters.</span>
00319     <span class="comment">//</span>
00320 
00321     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
00322     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a25">IRP_MJ_DIRECTORY_CONTROL</a>;
00323     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a44">IRP_MN_QUERY_DIRECTORY</a>;
00324     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = fileObject;
00325 
00326 
00327     <span class="comment">//</span>
00328     <span class="comment">// Copy the caller's parameters to the service-specific portion of the</span>
00329     <span class="comment">// IRP.</span>
00330     <span class="comment">//</span>
00331 
00332     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDirectory.Length = Length;
00333     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDirectory.FileInformationClass = FileBothDirectoryInformation;
00334     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDirectory.FileIndex = FileIndex;
00335 
00336     <span class="keywordflow">if</span> (QDirPoolData-&gt;<a class="code" href="../../d3/d2/struct__QueryDirPoolData.html#o1">FileName</a>.Length) {
00337         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDirectory.FileName = (PSTRING)&amp;QDirPoolData-&gt;<a class="code" href="../../d3/d2/struct__QueryDirPoolData.html#o1">FileName</a>;
00338     } <span class="keywordflow">else</span> {
00339         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDirectory.FileName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00340     }
00341 
00342     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o2">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a210">SL_INDEX_SPECIFIED</a>;
00343 
00344 
00345     <span class="comment">//</span>
00346     <span class="comment">// Now determine whether this driver expects to have data buffered to it</span>
00347     <span class="comment">// or whether it performs direct I/O.  This is based on the DO_BUFFERED_IO</span>
00348     <span class="comment">// flag in the device object.  If the flag is set, then a system buffer is</span>
00349     <span class="comment">// allocated and the driver's data will be copied into it.  Otherwise, a</span>
00350     <span class="comment">// Memory Descriptor List (MDL) is allocated and the caller's buffer is</span>
00351     <span class="comment">// locked down using it.</span>
00352     <span class="comment">//</span>
00353 
00354     <span class="keywordflow">if</span> (DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a123">DO_BUFFERED_IO</a>) {
00355 
00356         <span class="comment">//</span>
00357         <span class="comment">// The file system wants buffered I/O.  Pass the address of the</span>
00358         <span class="comment">// "system buffer" in the IRP.  Note that we don't want the buffer</span>
00359         <span class="comment">// deallocated, nor do we want the I/O system to copy to a user</span>
00360         <span class="comment">// buffer, so we don't set the corresponding flags in irp-&gt;Flags.</span>
00361         <span class="comment">//</span>
00362 
00363 
00364         <span class="keywordflow">try</span> {
00365 
00366             <span class="comment">//</span>
00367             <span class="comment">// Allocate the intermediary system buffer from nonpaged pool and</span>
00368             <span class="comment">// charge quota for it.</span>
00369             <span class="comment">//</span>
00370 
00371             SystemBuffer = <a class="code" href="../../d5/d8/ex_8h.html#a5">ExAllocatePoolWithQuotaTag</a>( NonPagedPool,
00372                                                        Length,
00373                                                        ' MDV' );
00374 
00375             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = SystemBuffer;
00376 
00377 
00378         } except(EXCEPTION_EXECUTE_HANDLER) {
00379 
00380             <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a>(irp);
00381 
00382             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
00383 
00384             <span class="keywordflow">if</span> (QDirPoolData) {
00385                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(QDirPoolData);
00386             }
00387 
00388             <span class="keywordflow">return</span> GetExceptionCode();
00389         }
00390 
00391 
00392     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a125">DO_DIRECT_IO</a>) {
00393 
00394         <span class="comment">//</span>
00395         <span class="comment">// This is a direct I/O operation.  Allocate an MDL and invoke the</span>
00396         <span class="comment">// memory management routine to lock the buffer into memory.  This is</span>
00397         <span class="comment">// done using an exception handler that will perform cleanup if the</span>
00398         <span class="comment">// operation fails.</span>
00399         <span class="comment">//</span>
00400 
00401         mdl = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00402 
00403         <span class="keywordflow">try</span> {
00404 
00405             <span class="comment">//</span>
00406             <span class="comment">// Allocate an MDL, charging quota for it, and hang it off of the</span>
00407             <span class="comment">// IRP.  Probe and lock the pages associated with the caller's</span>
00408             <span class="comment">// buffer for write access and fill in the MDL with the PFNs of</span>
00409             <span class="comment">// those pages.</span>
00410             <span class="comment">//</span>
00411 
00412             mdl = <a class="code" href="../../d4/d6/iosubs_8c.html#a19">IoAllocateMdl</a>( FileInformation, Length, FALSE, TRUE, irp );
00413             <span class="keywordflow">if</span> (mdl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00414                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );
00415             }
00416             <a class="code" href="../../d5/d6/iosup_8c.html#a41">MmProbeAndLockPages</a>( mdl, UserMode, IoWriteAccess );
00417 
00418         } except(EXCEPTION_EXECUTE_HANDLER) {
00419 
00420             <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00421                  <a class="code" href="../../d4/d6/iosubs_8c.html#a65">IoFreeMdl</a>( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> );
00422             }
00423 
00424             <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a>(irp);
00425 
00426             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
00427 
00428             <span class="keywordflow">if</span> (QDirPoolData) {
00429                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(QDirPoolData);
00430             }
00431 
00432             <span class="keywordflow">return</span> GetExceptionCode();
00433         }
00434 
00435     } <span class="keywordflow">else</span> {
00436 
00437         <span class="comment">//</span>
00438         <span class="comment">// Pass the address of the user's buffer so the driver has access to</span>
00439         <span class="comment">// it.  It is now the driver's responsibility to do everything.</span>
00440         <span class="comment">//</span>
00441 
00442         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o26">UserBuffer</a> = FileInformation;
00443 
00444     }
00445 
00446 
00447     <span class="comment">//</span>
00448     <span class="comment">// Insert the packet at the head of the IRP list for the thread.</span>
00449     <span class="comment">//</span>
00450 
00451     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>( APC_LEVEL, &amp;irql );
00452     InsertHeadList( &amp;irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread-&gt;IrpList,
00453                     &amp;irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o8">ThreadListEntry</a> );
00454     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>( irql );
00455 
00456 
00457     <span class="comment">//</span>
00458     <span class="comment">// invoke the driver and wait for it to complete</span>
00459     <span class="comment">//</span>
00460 
00461     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>(DeviceObject, irp);
00462 
00463     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
00464         status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(
00465                      Event,
00466                      UserRequest,
00467                      UserMode,
00468                      FALSE,
00469                      NULL );
00470     }
00471 
00472     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00473         status = IoStatusBlock.Status;
00474         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) || status == STATUS_BUFFER_OVERFLOW) {
00475             <span class="keywordflow">if</span> (SystemBuffer) {
00476                 <span class="keywordflow">try</span> {
00477                     RtlCopyMemory( FileInformation,
00478                                    SystemBuffer,
00479                                    IoStatusBlock.Information
00480                                    );
00481 
00482                 } except(EXCEPTION_EXECUTE_HANDLER) {
00483                     status = GetExceptionCode();
00484                 }
00485             }
00486         }
00487     }
00488 
00489 
00490     <span class="comment">//</span>
00491     <span class="comment">// Cleanup any memory allocated</span>
00492     <span class="comment">//</span>
00493     <span class="keywordflow">if</span> (QDirPoolData) {
00494         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(QDirPoolData);
00495     }
00496 
00497     <span class="keywordflow">if</span> (SystemBuffer) {
00498         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SystemBuffer);
00499     }
00500 
00501 
00502     <span class="keywordflow">return</span> status;
00503 }
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:57 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
