<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: lfs/write.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>write.c File Reference</h1><code>#include "<a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>"</code><br>

<p>
<a href="../../d2/d9/lfs_2write_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/lfs_2write_8c.html#a0">Dbg</a>&nbsp;&nbsp;&nbsp;(DEBUG_TRACE_WRITE)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/lfs_2write_8c.html#a1">LfsWrite</a> (IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a> LogHandle, IN ULONG NumberOfWriteEntries, IN <a class="el" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html">PLFS_WRITE_ENTRY</a> WriteEntries, IN <a class="el" href="../../d6/d3/lfs_8h.html#a13">LFS_RECORD_TYPE</a> RecordType, IN <a class="el" href="../../d6/d3/lfs_8h.html#a17">TRANSACTION_ID</a> *TransactionId OPTIONAL, IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a> UndoNextLsn, IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a> PreviousLsn, IN LONG UndoRequirement, OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a> Lsn)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/lfs_2write_8c.html#a2">LfsForceWrite</a> (IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a> LogHandle, IN ULONG NumberOfWriteEntries, IN <a class="el" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html">PLFS_WRITE_ENTRY</a> WriteEntries, IN <a class="el" href="../../d6/d3/lfs_8h.html#a13">LFS_RECORD_TYPE</a> RecordType, IN <a class="el" href="../../d6/d3/lfs_8h.html#a17">TRANSACTION_ID</a> *TransactionId, IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a> UndoNextLsn, IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a> PreviousLsn, IN LONG UndoRequirement, OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a> Lsn)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/lfs_2write_8c.html#a3">LfsFlushToLsn</a> (IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a> LogHandle, IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a> Lsn)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/lfs_2write_8c.html#a4">LfsCheckWriteRange</a> (IN <a class="el" href="../../d5/d1/struct__LFS__WRITE__DATA.html">PLFS_WRITE_DATA</a> WriteData, IN OUT PLONGLONG FlushOffset, IN OUT PULONG FlushLength)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="lfs/write.c::Dbg" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define Dbg&nbsp;&nbsp;&nbsp;(DEBUG_TRACE_WRITE)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00028">28</a> of file <a class="el" href="../../d2/d9/lfs_2write_8c-source.html">lfs/write.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a4" doxytag="lfs/write.c::LfsCheckWriteRange" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsCheckWriteRange           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d1/struct__LFS__WRITE__DATA.html">PLFS_WRITE_DATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WriteData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PLONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FlushOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FlushLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00477">477</a> of file <a class="el" href="../../d2/d9/lfs_2write_8c-source.html">lfs/write.c</a>.
<p>
References <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00203">_LBCB::FileOffset</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00341">LFS_SIGNATURE_RECORD_PAGE_ULONG</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00228">_LBCB::PageHeader</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00591">_LFCB::PageToDirty</a>, and <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00341">_LFCB::SystemPageSize</a>.
<p>
<pre class="fragment"><div>00485                    :
00486 
00487     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called Ntfs to Lfs when a flush occurs.  This will give Lfs a chance
00488     to trim <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> amount of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flush.  Lfs can then use a 4K log record page size
00489     <span class="keywordflow">for</span> all systems (Intel and Alpha).
00490 
00491     This routine will trim <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IO request to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00492     Lfcb <span class="keywordflow">for</span> <span class="keyword">this</span> volume.  We will also redirty <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second half of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page <span class="keywordflow">if</span>
00493     we have begun writing log records into <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
00494 
00495 Arguments:
00496 
00497     WriteData - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user's data structure which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> maintained
00498         by Lfs to describe <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current writes.
00499 
00500     FlushOffset - On input <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flush passed to Ntfs from MM.
00501         On output <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual range to flush.
00502 
00503     FlushLength - On input <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flush from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given FlushOffset.
00504         On output <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flush from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> possibly modified FlushOffset.
00505 
00506 Return Value:
00507 
00508     None
00509 
00510 --*/
00511 
00512 {
00513     PLIST_ENTRY Links;
00514     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
00515     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> NextLfcb;
00516     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00517 
00518     <span class="comment">//</span>
00519     <span class="comment">//  Find the correct Lfcb for this request.</span>
00520     <span class="comment">//</span>
00521 
00522     Lfcb = WriteData-&gt;Lfcb;
00523 
00524     <span class="comment">//</span>
00525     <span class="comment">//  Trim the write if not a system page size.</span>
00526     <span class="comment">//</span>
00527 
00528     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> != Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o6">SystemPageSize</a>) {
00529 
00530         <span class="comment">//</span>
00531         <span class="comment">//  Check if we are trimming before the write.</span>
00532         <span class="comment">//</span>
00533 
00534         <span class="keywordflow">if</span> (*FlushOffset &lt; WriteData-&gt;FileOffset) {
00535 
00536             *FlushLength -= (ULONG) (WriteData-&gt;FileOffset - *FlushOffset);
00537             *FlushOffset = WriteData-&gt;FileOffset;
00538         }
00539 
00540         <span class="comment">//</span>
00541         <span class="comment">//  Check that we aren't flushing too much.</span>
00542         <span class="comment">//</span>
00543 
00544         <span class="keywordflow">if</span> (*FlushOffset + *FlushLength &gt; WriteData-&gt;FileOffset + WriteData-&gt;Length) {
00545 
00546             *FlushLength = (ULONG) (WriteData-&gt;FileOffset + WriteData-&gt;Length - *FlushOffset);
00547         }
00548 
00549         <span class="comment">//</span>
00550         <span class="comment">//  Finally check if we have to redirty a page.</span>
00551         <span class="comment">//</span>
00552 
00553         <span class="keywordflow">if</span> ((Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o63">PageToDirty</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00554             (*FlushLength + *FlushOffset == Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o63">PageToDirty</a>-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o4">FileOffset</a>)) {
00555 
00556             *((PULONG) (Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o63">PageToDirty</a>-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o8">PageHeader</a>)) = <a class="code" href="../../d9/d3/lfsdisk_8h.html#a14">LFS_SIGNATURE_RECORD_PAGE_ULONG</a>;
00557         }
00558     }
00559 
00560     <span class="keywordflow">return</span>;
00561 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="lfs/write.c::LfsFlushToLsn" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsFlushToLsn           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LogHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lsn</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00360">360</a> of file <a class="el" href="../../d2/d9/lfs_2write_8c-source.html">lfs/write.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00142">_LCH::Lfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00517">LfsAcquireLch</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00058">LfsExceptionFilter()</a>, <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00360">LfsFlushToLsn()</a>, <a class="el" href="../../d8/d0/lbcbsup_8c-source.html#l00134">LfsFlushToLsnPriv()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00520">LfsReleaseLch</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00593">LfsValidateClientId</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00584">LfsValidateLch</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00360">LfsFlushToLsn()</a>.
<p>
<pre class="fragment"><div>00367                    :
00368 
00369     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by a client to insure that all log records
00370     to a certain point have been flushed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done by
00371     checking <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired Lsn has even been written at all.  If so we
00372     check <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> has been flushed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  If not, we simply write
00373     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current restart area to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disk.
00374 
00375 Arguments:
00376 
00377     LogHandle - Pointer to <span class="keyword">private</span> Lfs structure used to identify <span class="keyword">this</span>
00378                 client.
00379 
00380     Lsn - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lsn that must be on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disk on <span class="keywordflow">return</span> from <span class="keyword">this</span>
00381           routine.
00382 
00383 Return Value:
00384 
00385     None
00386 
00387 --*/
00388 
00389 {
00390     <span class="keyword">volatile</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00391 
00392     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch;
00393 
00394     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
00395 
00396     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00397 
00398     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsFlushToLsn:  Entered\n"</span>, 0 );
00399     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log Handle        -&gt; %08lx\n"</span>, LogHandle );
00400     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lsn (Low)         -&gt; %08lx\n"</span>, Lsn.LowPart );
00401     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lsn (High)        -&gt; %08lx\n"</span>, Lsn.HighPart );
00402 
00403     Lch = (<a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a>) LogHandle;
00404 
00405     <span class="comment">//</span>
00406     <span class="comment">//  Check that the structure is a valid log handle structure.</span>
00407     <span class="comment">//</span>
00408 
00409     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a32">LfsValidateLch</a>( Lch );
00410 
00411     <span class="comment">//</span>
00412     <span class="comment">//  Use a try-except to catch errors.</span>
00413     <span class="comment">//</span>
00414 
00415     <span class="keywordflow">try</span> {
00416 
00417         <span class="comment">//</span>
00418         <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00419         <span class="comment">//</span>
00420 
00421         <span class="keywordflow">try</span> {
00422 
00423             <span class="comment">//</span>
00424             <span class="comment">//  Acquire the log file control block for this log file.</span>
00425             <span class="comment">//</span>
00426 
00427             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>( Lch );
00428             Lfcb = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a>;
00429 
00430             <span class="comment">//</span>
00431             <span class="comment">//  If the log file has been closed we will assume the Lsn has been flushed.</span>
00432             <span class="comment">//</span>
00433 
00434             <span class="keywordflow">if</span> (Lfcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00435 
00436                 <span class="comment">//</span>
00437                 <span class="comment">//  Check that the client Id is valid.</span>
00438                 <span class="comment">//</span>
00439 
00440                 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a33">LfsValidateClientId</a>( Lfcb, Lch );
00441 
00442                 <span class="comment">//</span>
00443                 <span class="comment">//  Call our common routine to perform the work.</span>
00444                 <span class="comment">//</span>
00445 
00446                 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a54">LfsFlushToLsnPriv</a>( Lfcb, Lsn );
00447             }
00448 
00449         } finally {
00450 
00451             <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsFlushToLsn );
00452 
00453             <span class="comment">//</span>
00454             <span class="comment">//  Release the log file control block if held.</span>
00455             <span class="comment">//</span>
00456 
00457             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
00458 
00459             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsFlushToLsn:  Exit\n"</span>, 0 );
00460         }
00461 
00462     } except (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a56">LfsExceptionFilter</a>( GetExceptionInformation() )) {
00463 
00464         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00465     }
00466 
00467     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00468 
00469         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( Status );
00470     }
00471 
00472     <span class="keywordflow">return</span>;
00473 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="lfs/write.c::LfsForceWrite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN LfsForceWrite           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LogHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfWriteEntries</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html">PLFS_WRITE_ENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WriteEntries</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a13">LFS_RECORD_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RecordType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a17">TRANSACTION_ID</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>TransactionId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>UndoNextLsn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousLsn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONG&nbsp;</td>
          <td class="mdname" nowrap> <em>UndoRequirement</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lsn</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00197">197</a> of file <a class="el" href="../../d2/d9/lfs_2write_8c-source.html">lfs/write.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00142">_LCH::Lfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00517">LfsAcquireLch</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00058">LfsExceptionFilter()</a>, <a class="el" href="../../d8/d0/lbcbsup_8c-source.html#l00134">LfsFlushToLsnPriv()</a>, <a class="el" href="../../d6/d3/lfs_8h.html#a55">LfsForceWrite()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00520">LfsReleaseLch</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00593">LfsValidateClientId</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00584">LfsValidateLch</a>, <a class="el" href="../../d8/d4/logrcsup_8c-source.html#l00055">LfsWriteLogRecordIntoLogPage()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00211                    :
00212 
00213     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by a client to write a log record to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00214     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> idendical to <a class="code" href="../../d6/d3/lfs_8h.html#a54">LfsWrite</a> except that on <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log record <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00215     guaranteed to be on disk.
00216 
00217 Arguments:
00218 
00219     LogHandle - Pointer to <span class="keyword">private</span> Lfs structure used to identify <span class="keyword">this</span>
00220                 client.
00221 
00222     NumberOfWriteEntries - Number of components of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log record.
00223 
00224     WriteEntries - Pointer to an array of write entries.
00225 
00226     RecordType - Lfs defined <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <span class="keywordflow">for</span> <span class="keyword">this</span> log record.
00227 
00228     TransactionId - Id value used to group log records by complete transaction.
00229 
00230     UndoNextLsn - Lsn of a previous log record which needs to be undone in
00231                   <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event of a client restart.
00232 
00233     PreviousLsn - Lsn of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> immediately previous log record <span class="keywordflow">for</span> <span class="keyword">this</span> client.
00234 
00235     Lsn - Lsn to be associated with <span class="keyword">this</span> log record.
00236 
00237 Return Value:
00238 
00239     BOOLEAN - Advisory, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates that less than 1/4 of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00240         available.
00241 
00242 --*/
00243 
00244 {
00245     <span class="keyword">volatile</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00246 
00247     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch;
00248 
00249     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
00250     BOOLEAN LogFileFull = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00251 
00252     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00253 
00254     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsForceWrite:  Entered\n"</span>, 0 );
00255     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log Handle                -&gt; %08lx\n"</span>, LogHandle );
00256     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"NumberOfWriteEntries      -&gt; %08lx\n"</span>, NumberOfWriteEntries );
00257     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"WriteEntries              -&gt; %08lx\n"</span>, WriteEntries );
00258     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Record Type               -&gt; %08lx\n"</span>, RecordType );
00259     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Transaction Id            -&gt; %08lx\n"</span>, TransactionId );
00260     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"UndoNextLsn (Low)         -&gt; %08lx\n"</span>, UndoNextLsn.LowPart );
00261     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"UndoNextLsn (High)        -&gt; %08lx\n"</span>, UndoNextLsn.HighPart );
00262     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"PreviousLsn (Low)         -&gt; %08lx\n"</span>, PreviousLsn.LowPart );
00263     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"PreviousLsn (High)        -&gt; %08lx\n"</span>, PreviousLsn.HighPart );
00264 
00265     Lch = (<a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a>) LogHandle;
00266 
00267     <span class="comment">//</span>
00268     <span class="comment">//  Check that the structure is a valid log handle structure.</span>
00269     <span class="comment">//</span>
00270 
00271     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a32">LfsValidateLch</a>( Lch );
00272 
00273     <span class="comment">//</span>
00274     <span class="comment">//  Use a try-except to catch errors.</span>
00275     <span class="comment">//</span>
00276 
00277     <span class="keywordflow">try</span> {
00278 
00279         <span class="comment">//</span>
00280         <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00281         <span class="comment">//</span>
00282 
00283         <span class="keywordflow">try</span> {
00284 
00285             <span class="comment">//</span>
00286             <span class="comment">//  Acquire the log file control block for this log file.</span>
00287             <span class="comment">//</span>
00288 
00289             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>( Lch );
00290             Lfcb = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a>;
00291 
00292             <span class="comment">//</span>
00293             <span class="comment">//  If the Log file has been closed then refuse access.</span>
00294             <span class="comment">//</span>
00295 
00296             <span class="keywordflow">if</span> (Lfcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00297 
00298                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_ACCESS_DENIED );
00299             }
00300 
00301             <span class="comment">//</span>
00302             <span class="comment">//  Check that the client Id is valid.</span>
00303             <span class="comment">//</span>
00304 
00305             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a33">LfsValidateClientId</a>( Lfcb, Lch );
00306 
00307             <span class="comment">//</span>
00308             <span class="comment">//  Write the log record.</span>
00309             <span class="comment">//</span>
00310 
00311             LogFileFull = <a class="code" href="../../d7/d5/logrcsup_8c.html#a3">LfsWriteLogRecordIntoLogPage</a>( Lfcb,
00312                                                         Lch,
00313                                                         NumberOfWriteEntries,
00314                                                         WriteEntries,
00315                                                         RecordType,
00316                                                         TransactionId,
00317                                                         UndoNextLsn,
00318                                                         PreviousLsn,
00319                                                         UndoRequirement,
00320                                                         TRUE,
00321                                                         Lsn );
00322 
00323             <span class="comment">//</span>
00324             <span class="comment">//  The call to add this lbcb to the workque is guaranteed to release</span>
00325             <span class="comment">//  the Lfcb if this thread may do the Io.</span>
00326             <span class="comment">//</span>
00327 
00328             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a54">LfsFlushToLsnPriv</a>( Lfcb, *Lsn );
00329 
00330         } finally {
00331 
00332             <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsForceWrite );
00333 
00334             <span class="comment">//</span>
00335             <span class="comment">//  Release the log file control block if held.</span>
00336             <span class="comment">//</span>
00337 
00338             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
00339 
00340             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lsn (Low)   -&gt; %08lx\n"</span>, Lsn-&gt;LowPart );
00341             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lsn (High)  -&gt; %08lx\n"</span>, Lsn-&gt;HighPart );
00342             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsForceWrite:  Exit\n"</span>, 0 );
00343         }
00344 
00345     } except (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a56">LfsExceptionFilter</a>( GetExceptionInformation() )) {
00346 
00347         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00348     }
00349 
00350     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00351 
00352         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( Status );
00353     }
00354 
00355     <span class="keywordflow">return</span> LogFileFull;
00356 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="lfs/write.c::LfsWrite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN LfsWrite           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LogHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfWriteEntries</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html">PLFS_WRITE_ENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WriteEntries</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a13">LFS_RECORD_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RecordType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a17">TRANSACTION_ID</a> *TransactionId&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>UndoNextLsn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousLsn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONG&nbsp;</td>
          <td class="mdname" nowrap> <em>UndoRequirement</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lsn</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00039">39</a> of file <a class="el" href="../../d2/d9/lfs_2write_8c-source.html">lfs/write.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00142">_LCH::Lfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00517">LfsAcquireLch</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00058">LfsExceptionFilter()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00520">LfsReleaseLch</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00593">LfsValidateClientId</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00584">LfsValidateLch</a>, <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00039">LfsWrite()</a>, <a class="el" href="../../d8/d4/logrcsup_8c-source.html#l00055">LfsWriteLogRecordIntoLogPage()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d3/lfs_8h.html#a28">PLFS_WRITE_ENTRY</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00039">LfsWrite()</a>.
<p>
<pre class="fragment"><div>00053                    :
00054 
00055     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by a client to write a log record to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00056     The log record <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> lazy written and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not guaranteed to be on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disk
00057     until a subsequent LfsForceWrie or <a class="code" href="../../d6/d3/lfs_8h.html#a51">LfsWriteRestartArea</a> or until
00058     an LfsFlushtoLsn <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> issued withan Lsn greater-than or equal to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lsn
00059     returned from <span class="keyword">this</span> service.
00060 
00061 Arguments:
00062 
00063     LogHandle - Pointer to <span class="keyword">private</span> Lfs structure used to identify <span class="keyword">this</span>
00064                 client.
00065 
00066     NumberOfWriteEntries - Number of components of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log record.
00067 
00068     WriteEntries - Pointer to an array of write entries.
00069 
00070     RecordType - Lfs defined <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <span class="keywordflow">for</span> <span class="keyword">this</span> log record.
00071 
00072     TransactionId - Id value used to group log records by complete transaction.
00073 
00074     UndoNextLsn - Lsn of a previous log record which needs to be undone in
00075                   <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event of a client restart.
00076 
00077     PreviousLsn - Lsn of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> immediately previous log record <span class="keywordflow">for</span> <span class="keyword">this</span> client.
00078 
00079     Lsn - Lsn to be associated with <span class="keyword">this</span> log record.
00080 
00081 Return Value:
00082 
00083     BOOLEAN - Advisory, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates that less than 1/4 of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00084         available.
00085 
00086 --*/
00087 
00088 {
00089     <span class="keyword">volatile</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00090 
00091     BOOLEAN LogFileFull = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00092     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch;
00093 
00094     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
00095 
00096     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00097 
00098     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsWrite:  Entered\n"</span>, 0 );
00099     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log Handle                -&gt; %08lx\n"</span>, LogHandle );
00100     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"NumberOfWriteEntries      -&gt; %08lx\n"</span>, NumberOfWriteEntries );
00101     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"WriteEntries              -&gt; %08lx\n"</span>, WriteEntries );
00102     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Record Type               -&gt; %08lx\n"</span>, RecordType );
00103     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Transaction Id            -&gt; %08lx\n"</span>, TransactionId );
00104     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"UndoNextLsn (Low)         -&gt; %08lx\n"</span>, UndoNextLsn.LowPart );
00105     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"UndoNextLsn (High)        -&gt; %08lx\n"</span>, UndoNextLsn.HighPart );
00106     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"PreviousLsn (Low)         -&gt; %08lx\n"</span>, PreviousLsn.LowPart );
00107     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"PreviousLsn (High)        -&gt; %08lx\n"</span>, PreviousLsn.HighPart );
00108 
00109     Lch = (<a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a>) LogHandle;
00110 
00111     <span class="comment">//</span>
00112     <span class="comment">//  Check that the structure is a valid log handle structure.</span>
00113     <span class="comment">//</span>
00114 
00115     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a32">LfsValidateLch</a>( Lch );
00116 
00117     <span class="comment">//</span>
00118     <span class="comment">//  Use a try-except to catch errors.</span>
00119     <span class="comment">//</span>
00120 
00121     <span class="keywordflow">try</span> {
00122 
00123         <span class="comment">//</span>
00124         <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00125         <span class="comment">//</span>
00126 
00127         <span class="keywordflow">try</span> {
00128 
00129             <span class="comment">//</span>
00130             <span class="comment">//  Acquire the log file control block for this log file.</span>
00131             <span class="comment">//</span>
00132 
00133             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>( Lch );
00134             Lfcb = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a>;
00135 
00136             <span class="comment">//</span>
00137             <span class="comment">//  If the Log file has been closed then refuse access.</span>
00138             <span class="comment">//</span>
00139 
00140             <span class="keywordflow">if</span> (Lfcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00141 
00142                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_ACCESS_DENIED );
00143             }
00144 
00145             <span class="comment">//</span>
00146             <span class="comment">//  Check that the client Id is valid.</span>
00147             <span class="comment">//</span>
00148 
00149             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a33">LfsValidateClientId</a>( Lfcb, Lch );
00150 
00151             <span class="comment">//</span>
00152             <span class="comment">//  Write the log record.</span>
00153             <span class="comment">//</span>
00154 
00155             LogFileFull = <a class="code" href="../../d7/d5/logrcsup_8c.html#a3">LfsWriteLogRecordIntoLogPage</a>( Lfcb,
00156                                                         Lch,
00157                                                         NumberOfWriteEntries,
00158                                                         WriteEntries,
00159                                                         RecordType,
00160                                                         TransactionId,
00161                                                         UndoNextLsn,
00162                                                         PreviousLsn,
00163                                                         UndoRequirement,
00164                                                         FALSE,
00165                                                         Lsn );
00166 
00167         } finally {
00168 
00169             <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsWrite );
00170 
00171             <span class="comment">//</span>
00172             <span class="comment">//  Release the log file control block if held.</span>
00173             <span class="comment">//</span>
00174 
00175             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
00176 
00177             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lsn (Low)   -&gt; %08lx\n"</span>, Lsn-&gt;LowPart );
00178             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lsn (High)  -&gt; %08lx\n"</span>, Lsn-&gt;HighPart );
00179             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsWrite:  Exit\n"</span>, 0 );
00180         }
00181 
00182     } except (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a56">LfsExceptionFilter</a>( GetExceptionInformation() )) {
00183 
00184         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00185     }
00186 
00187     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00188 
00189         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( Status );
00190     }
00191 
00192     <span class="keywordflow">return</span> LogFileFull;
00193 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:46:10 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
