<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: csrinit.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>csrinit.c File Reference</h1><code>#include "<a class="el" href="../../d0/d9/csrdll_8h-source.html">csrdll.h</a>"</code><br>
<code>#include "<a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>"</code><br>

<p>
<a href="../../d2/d9/csrinit_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/csrinit_8c.html#a0">CsrDllInitialize</a> (IN PVOID DllHandle, IN ULONG Reason, IN PCONTEXT Context OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/csrinit_8c.html#a1">CsrOneTimeInitialize</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/csrinit_8c.html#a2">CsrClientConnectToServer</a> (IN PWSTR ObjectDirectory, IN ULONG ServerDllIndex, IN PCSR_CALLBACK_INFO CallbackInformation OPTIONAL, IN PVOID ConnectionInformation, IN OUT PULONG ConnectionInformationLength OPTIONAL, OUT PBOOLEAN CalledFromServer OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/csrinit_8c.html#a3">xProtectHandle</a> (HANDLE hObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/csrinit_8c.html#a4">CsrpConnectToServer</a> (IN PWSTR ObjectDirectory)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a2" doxytag="csrinit.c::CsrClientConnectToServer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CsrClientConnectToServer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectDirectory</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ServerDllIndex</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCSR_CALLBACK_INFO CallbackInformation&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ConnectionInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG ConnectionInformationLength&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN CalledFromServer&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/csrinit_8c-source.html#l00106">106</a> of file <a class="el" href="../../d2/d9/csrinit_8c-source.html">csrinit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00459">CSR_TAG</a>, <a class="el" href="../../d9/d8/wow64csr_8c-source.html#l00088">CsrAllocateCaptureBuffer()</a>, <a class="el" href="../../d9/d8/wow64csr_8c-source.html#l00109">CsrAllocateMessagePointer()</a>, <a class="el" href="../../d9/d8/wow64csr_8c-source.html#l00075">CsrClientCallServer()</a>, <a class="el" href="../../d9/d8/wow64csr_8c-source.html#l00098">CsrFreeCaptureBuffer()</a>, <a class="el" href="../../d0/d9/csrdll_8h-source.html#l00140">CsrHeap</a>, <a class="el" href="../../d0/d9/csrdll_8h-source.html#l00101">CsrInitOnceDone</a>, <a class="el" href="../../d0/d9/csrdll_8h-source.html#l00193">CsrLoadedClientDll</a>, <a class="el" href="../../d2/d9/csrinit_8c-source.html#l00076">CsrOneTimeInitialize()</a>, <a class="el" href="../../d2/d9/csrinit_8c-source.html#l00359">CsrpConnectToServer()</a>, <a class="el" href="../../d0/d9/csrdll_8h-source.html#l00163">CsrPortBaseTag</a>, <a class="el" href="../../d0/d9/csrdll_8h-source.html#l00150">CsrPortHandle</a>, <a class="el" href="../../d0/d9/csrdll_8h-source.html#l00160">CsrPortHeap</a>, <a class="el" href="../../d0/d9/csrdll_8h-source.html#l00114">CsrServerApiRoutine</a>, <a class="el" href="../../d0/d9/csrdll_8h-source.html#l00107">CsrServerProcess</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00474">LdrDisableThreadCalloutsForDll()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00295">LdrGetDllHandle()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00838">LdrGetProcedureAddress()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00045">NtDllBase</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l01603">RtlCreateTagHeap()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00102">RtlInitAnsiString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00056">RtlInitString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00117                    :
00118 
00119     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client side DLL to connect with its
00120     server side DLL.
00121 
00122 Arguments:
00123 
00124     ObjectDirectory - Points to a null terminate string that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same
00125         as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ObjectDirectory= argument passed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CSRSS
00126         program.
00127 
00128     ServerDllIndex - <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server DLL that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being connected to.
00129         It should match one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ServerDll= arguments passed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CSRSS
00130         program.
00131 
00132     CallbackInformation - An optional pointer to a structure that contains
00133         a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client callback function dispatch table.
00134 
00135     ConnectionInformation - An optional pointer to uninterpreted data.
00136         This data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> intended <span class="keywordflow">for</span> clients to pass package, version and
00137         protocol identification information to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server to allow <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00138         server to determine <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> can satisify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client before
00139         accepting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> connection.  Upon <span class="keywordflow">return</span> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00140         ConnectionInformation data block contains any information passed
00141         back from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server DLL by its call to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00142         CsrCompleteConnection call.  The output data overwrites <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00143         input data.
00144 
00145     ConnectionInformationLength - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00146         ConnectionInformation data block.  The output value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00147         length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ConnectionInformation data
00148         block by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server's call to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/lpccompl_8c.html#a2">NtCompleteConnectPort</a>
00149         service.  This parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> OPTIONAL <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00150         ConnectionInformation parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, otherwise <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00151         required.
00152 
00153     CalledFromServer - On output, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dll has been called from
00154         a server process.
00155 
00156 Return Value:
00157 
00158     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> value.
00159 
00160 --*/
00161 
00162 {
00163     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00164     CSR_API_MSG m;
00165     PCSR_CLIENTCONNECT_MSG a = &amp;m.u.ClientConnect;
00166     PCSR_CAPTURE_HEADER CaptureBuffer;
00167     HANDLE CsrServerModuleHandle;
00168     STRING ProcedureName;
00169     ANSI_STRING DllName;
00170     UNICODE_STRING DllName_U;
00171     PIMAGE_NT_HEADERS NtHeaders;
00172 
00173     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ConnectionInformation ) &amp;&amp;
00174         (!ARGUMENT_PRESENT( ConnectionInformationLength ) ||
00175           *ConnectionInformationLength == 0
00176         )
00177        ) {
00178         <span class="keywordflow">return</span>( STATUS_INVALID_PARAMETER );
00179         }
00180 
00181     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/csrdll_8h.html#a8">CsrInitOnceDone</a>) {
00182         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d0/csrinit_8c.html#a1">CsrOneTimeInitialize</a>();
00183         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00184             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00185             }
00186         }
00187 
00188     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( CallbackInformation )) {
00189         <a class="code" href="../../d9/d9/csrdll_8h.html#a21">CsrLoadedClientDll</a>[ ServerDllIndex ] = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( CsrHeap, <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( CSR_TAG ), <span class="keyword">sizeof</span>(CSR_CALLBACK_INFO) );
00190         <span class="keywordflow">if</span> ( !<a class="code" href="../../d9/d9/csrdll_8h.html#a21">CsrLoadedClientDll</a>[ ServerDllIndex ] ) {
00191             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00192             }
00193         <a class="code" href="../../d9/d9/csrdll_8h.html#a21">CsrLoadedClientDll</a>[ ServerDllIndex ]-&gt;ApiNumberBase =
00194                 CallbackInformation-&gt;ApiNumberBase;
00195         <a class="code" href="../../d9/d9/csrdll_8h.html#a21">CsrLoadedClientDll</a>[ ServerDllIndex ]-&gt;MaxApiNumber =
00196                 CallbackInformation-&gt;MaxApiNumber;
00197         <a class="code" href="../../d9/d9/csrdll_8h.html#a21">CsrLoadedClientDll</a>[ ServerDllIndex ]-&gt;CallbackDispatchTable =
00198                 CallbackInformation-&gt;CallbackDispatchTable;
00199     }
00200 
00201     <span class="comment">//</span>
00202     <span class="comment">// if we are being called by a server process, skip lpc port initialization</span>
00203     <span class="comment">// and call to server connect routine and just initialize heap.  the</span>
00204     <span class="comment">// dll initialization routine will do any necessary initialization.  this</span>
00205     <span class="comment">// stuff only needs to be done for the first connect.</span>
00206     <span class="comment">//</span>
00207 
00208     <span class="keywordflow">if</span> ( <a class="code" href="../../d9/d9/csrdll_8h.html#a9">CsrServerProcess</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ) {
00209         *CalledFromServer = <a class="code" href="../../d9/d9/csrdll_8h.html#a9">CsrServerProcess</a>;
00210         <span class="keywordflow">return</span> STATUS_SUCCESS;
00211         }
00212 
00213     <span class="comment">//</span>
00214     <span class="comment">// If the image is an NT Native image, we are running in the</span>
00215     <span class="comment">// context of the server.</span>
00216     <span class="comment">//</span>
00217 
00218     NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(NtCurrentPeb()-&gt;ImageBaseAddress);
00219     <a class="code" href="../../d9/d9/csrdll_8h.html#a9">CsrServerProcess</a> =
00220         (NtHeaders-&gt;OptionalHeader.Subsystem == IMAGE_SUBSYSTEM_NATIVE) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00221 
00222     <span class="keywordflow">if</span> ( <a class="code" href="../../d9/d9/csrdll_8h.html#a9">CsrServerProcess</a> ) {
00223         <span class="keyword">extern</span> PVOID <a class="code" href="../../d8/d2/ldrinit_8c.html#a5">NtDllBase</a>;
00224         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;DllName, <span class="stringliteral">"csrsrv"</span> );
00225         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;DllName_U, &amp;DllName, TRUE);
00226         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
00227 
00228         <a class="code" href="../../d4/d2/ldrapi_8c.html#a5">LdrDisableThreadCalloutsForDll</a>(NtDllBase);
00229 
00230         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d2/ldrapi_8c.html#a4">LdrGetDllHandle</a>(
00231                         UNICODE_NULL,
00232                     NULL,
00233                         &amp;DllName_U,
00234                     (PVOID *)&amp;CsrServerModuleHandle
00235                     );
00236 
00237         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;DllName_U);
00238 
00239         <a class="code" href="../../d9/d9/csrdll_8h.html#a9">CsrServerProcess</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00240 
00241         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>(&amp;ProcedureName,<span class="stringliteral">"CsrCallServerFromServer"</span>);
00242         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d2/ldrapi_8c.html#a7">LdrGetProcedureAddress</a>(
00243                         CsrServerModuleHandle,
00244                         &amp;ProcedureName,
00245                         0L,
00246                         (PVOID *)&amp;CsrServerApiRoutine
00247                         );
00248         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
00249 
00250         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (CsrPortHeap==NULL);
00251         <a class="code" href="../../d9/d9/csrdll_8h.html#a16">CsrPortHeap</a> = RtlProcessHeap();
00252 
00253         <a class="code" href="../../d9/d9/csrdll_8h.html#a18">CsrPortBaseTag</a> = <a class="code" href="../../d5/d9/heapdll_8c.html#a28">RtlCreateTagHeap</a>( CsrPortHeap,
00254                                            0,
00255                                            L<span class="stringliteral">"CSRPORT!"</span>,
00256                                            L<span class="stringliteral">"CAPTURE\0"</span>
00257                                          );
00258 
00259         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CalledFromServer)) {
00260             *CalledFromServer = <a class="code" href="../../d9/d9/csrdll_8h.html#a9">CsrServerProcess</a>;
00261             }
00262         <span class="keywordflow">return</span> STATUS_SUCCESS;
00263         }
00264 
00265     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ConnectionInformation) ) {
00266         <a class="code" href="../../d9/d9/csrdll_8h.html#a9">CsrServerProcess</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00267         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/csrdll_8h.html#a15">CsrPortHandle</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00268             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d0/csrinit_8c.html#a4">CsrpConnectToServer</a>( ObjectDirectory );
00269             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00270                 <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00271                 }
00272             }
00273 
00274         a-&gt;ServerDllIndex = ServerDllIndex;
00275         a-&gt;ConnectionInformationLength = *ConnectionInformationLength;
00276         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ConnectionInformation )) {
00277             CaptureBuffer = <a class="code" href="../../d8/d9/wow64csr_8c.html#a5">CsrAllocateCaptureBuffer</a>( 1,
00278                                                       a-&gt;ConnectionInformationLength
00279                                                     );
00280             <span class="keywordflow">if</span> (CaptureBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00281                 <span class="keywordflow">return</span>( STATUS_NO_MEMORY );
00282                 }
00283 
00284             <a class="code" href="../../d8/d9/wow64csr_8c.html#a7">CsrAllocateMessagePointer</a>( CaptureBuffer,
00285                                        a-&gt;ConnectionInformationLength,
00286                                        (PVOID *)&amp;a-&gt;ConnectionInformation
00287                                      );
00288             RtlMoveMemory( a-&gt;ConnectionInformation,
00289                            ConnectionInformation,
00290                            a-&gt;ConnectionInformationLength
00291                          );
00292 
00293             *ConnectionInformationLength = a-&gt;ConnectionInformationLength;
00294             }
00295         <span class="keywordflow">else</span> {
00296             CaptureBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00297             }
00298 
00299         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d9/wow64csr_8c.html#a4">CsrClientCallServer</a>( &amp;m,
00300                                       CaptureBuffer,
00301                                       CSR_MAKE_API_NUMBER( CSRSRV_SERVERDLL_INDEX,
00302                                                            CsrpClientConnect
00303                                                          ),
00304                                       <span class="keyword">sizeof</span>( *a )
00305                                     );
00306 
00307         <span class="keywordflow">if</span> (CaptureBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00308             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ConnectionInformation )) {
00309                 RtlMoveMemory( ConnectionInformation,
00310                                a-&gt;ConnectionInformation,
00311                                *ConnectionInformationLength
00312                              );
00313                 }
00314 
00315             <a class="code" href="../../d8/d9/wow64csr_8c.html#a6">CsrFreeCaptureBuffer</a>( CaptureBuffer );
00316             }
00317         }
00318     <span class="keywordflow">else</span> {
00319         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00320         }
00321 
00322     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CalledFromServer)) {
00323         *CalledFromServer = <a class="code" href="../../d9/d9/csrdll_8h.html#a9">CsrServerProcess</a>;
00324         }
00325     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00326 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="csrinit.c::CsrDllInitialize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CsrDllInitialize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DllHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Reason</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT Context&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/csrinit_8c-source.html#l00030">30</a> of file <a class="el" href="../../d2/d9/csrinit_8c-source.html">csrinit.c</a>.
<p>
References <a class="el" href="../../d0/d9/csrdll_8h-source.html#l00174">CsrDllHandle</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00038                    :
00039 
00040     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL initialization routine <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Client DLL
00041     This function gets <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> application links to <span class="keyword">this</span> DLL
00042     are snapped.
00043 
00044 Arguments:
00045 
00046     Context - Supplies an optional context buffer that will be restore
00047               after all DLL initialization has been completed.  If <span class="keyword">this</span>
00048               parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> then <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a dynamic snap of <span class="keyword">this</span> module.
00049               Otherwise <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a <span class="keyword">static</span> snap prior to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user process
00050               gaining <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a>.
00051 
00052 Return Value:
00053 
00054     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> value.
00055 
00056 --*/
00057 
00058 {
00059     Context;
00060 
00061     <span class="keywordflow">if</span> (Reason != DLL_PROCESS_ATTACH) {
00062         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00063         }
00064 
00065     <span class="comment">//</span>
00066     <span class="comment">// Remember our DLL handle in a global variable.</span>
00067     <span class="comment">//</span>
00068 
00069     <a class="code" href="../../d9/d9/csrdll_8h.html#a19">CsrDllHandle</a> = DllHandle;
00070 
00071     <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00072 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="csrinit.c::CsrOneTimeInitialize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CsrOneTimeInitialize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/csrinit_8c-source.html#l00076">76</a> of file <a class="el" href="../../d2/d9/csrinit_8c-source.html">csrinit.c</a>.
<p>
References <a class="el" href="../../d0/d9/csrdll_8h-source.html#l00140">CsrHeap</a>, <a class="el" href="../../d0/d9/csrdll_8h-source.html#l00101">CsrInitOnceDone</a>, <a class="el" href="../../d0/d9/csrdll_8h-source.html#l00122">CsrNtSysInfo</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00941">NtQuerySystemInformation()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/csrinit_8c-source.html#l00106">CsrClientConnectToServer()</a>.
<p>
<pre class="fragment"><div>00077 {
00078     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00079 
00080     <span class="comment">//</span>
00081     <span class="comment">// Save away system information in a global variable</span>
00082     <span class="comment">//</span>
00083 
00084     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a49">NtQuerySystemInformation</a>( SystemBasicInformation,
00085                                        &amp;CsrNtSysInfo,
00086                                        <span class="keyword">sizeof</span>( CsrNtSysInfo ),
00087                                        NULL
00088                                      );
00089     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00090         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00091         }
00092 
00093     <span class="comment">//</span>
00094     <span class="comment">// Use the process heap for memory allocation.</span>
00095     <span class="comment">//</span>
00096 
00097     <a class="code" href="../../d9/d9/csrdll_8h.html#a13">CsrHeap</a> = RtlProcessHeap();
00098 
00099     <a class="code" href="../../d9/d9/csrdll_8h.html#a8">CsrInitOnceDone</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00100 
00101     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00102 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="csrinit.c::CsrpConnectToServer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CsrpConnectToServer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PWSTR&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ObjectDirectory</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/csrinit_8c-source.html#l00359">359</a> of file <a class="el" href="../../d2/d9/csrinit_8c-source.html">csrinit.c</a>.
<p>
References <a class="el" href="../../d0/d9/csrdll_8h-source.html#l00095">CSR_PORT_MEMORY_SIZE</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00459">CSR_TAG</a>, <a class="el" href="../../d0/d9/csrdll_8h-source.html#l00140">CsrHeap</a>, <a class="el" href="../../d0/d9/csrdll_8h-source.html#l00122">CsrNtSysInfo</a>, <a class="el" href="../../d0/d9/csrdll_8h-source.html#l00182">CsrObjectDirectory</a>, <a class="el" href="../../d0/d9/csrdll_8h-source.html#l00163">CsrPortBaseTag</a>, <a class="el" href="../../d0/d9/csrdll_8h-source.html#l00150">CsrPortHandle</a>, <a class="el" href="../../d0/d9/csrdll_8h-source.html#l00160">CsrPortHeap</a>, <a class="el" href="../../d0/d9/csrdll_8h-source.html#l00161">CsrPortMemoryRemoteDelta</a>, <a class="el" href="../../d0/d9/csrdll_8h-source.html#l00149">CsrPortName</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d4/d8/ulpc_8h-source.html#l00049">DynamicQos</a>, <a class="el" href="../../d0/d9/csrdll_8h-source.html#l00073">IF_CSR_DEBUG</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00144">IF_DEBUG</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d8/d9/exts_8h-source.html#l00092">n</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l00134">NtCreateSection()</a>, <a class="el" href="../../d6/d5/lpcconn_8c-source.html#l00084">NtSecureConnectPort()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01062">RtlAllocateAndInitializeSid()</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01821">RtlAppendUnicodeToString()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l00191">RtlCreateHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l01603">RtlCreateTagHeap()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01218">RtlFreeSid()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, and <a class="el" href="../../d2/d9/csrinit_8c-source.html#l00329">xProtectHandle()</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/csrinit_8c-source.html#l00106">CsrClientConnectToServer()</a>.
<p>
<pre class="fragment"><div>00362 {
00363     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00364     REMOTE_PORT_VIEW ServerView;
00365     ULONG MaxMessageLength;
00366     ULONG ConnectionInformationLength;
00367     CSR_API_CONNECTINFO ConnectionInformation;
00368     SECURITY_QUALITY_OF_SERVICE <a class="code" href="../../d3/d9/ulpc_8h.html#a4">DynamicQos</a>;
00369     HANDLE PortSection;
00370     PORT_VIEW ClientView;
00371     ULONG <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
00372     LARGE_INTEGER SectionSize;
00373     SID_IDENTIFIER_AUTHORITY NtAuthority = SECURITY_NT_AUTHORITY;
00374     PSID SystemSid;
00375 
00376     <span class="comment">//</span>
00377     <span class="comment">// Create the port name string by combining the passed in object directory</span>
00378     <span class="comment">// name with the port name.</span>
00379     <span class="comment">//</span>
00380 
00381     <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = ((wcslen( ObjectDirectory ) + 1) * <span class="keyword">sizeof</span>( WCHAR )) +
00382         <span class="keyword">sizeof</span>( CSR_API_PORT_NAME );
00383     <a class="code" href="../../d9/d9/csrdll_8h.html#a14">CsrPortName</a>.Length = 0;
00384     <a class="code" href="../../d9/d9/csrdll_8h.html#a14">CsrPortName</a>.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
00385     <a class="code" href="../../d9/d9/csrdll_8h.html#a14">CsrPortName</a>.Buffer = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( CsrHeap, <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( CSR_TAG ), n );
00386     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/csrdll_8h.html#a14">CsrPortName</a>.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00387         <span class="keywordflow">return</span>( STATUS_NO_MEMORY );
00388         }
00389     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>( &amp;CsrPortName, ObjectDirectory );
00390     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>( &amp;CsrPortName, L<span class="stringliteral">"\\"</span> );
00391     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>( &amp;CsrPortName, CSR_API_PORT_NAME );
00392 
00393     <span class="comment">//</span>
00394     <span class="comment">// Set up the security quality of service parameters to use over the</span>
00395     <span class="comment">// port.  Use the most efficient (least overhead) - which is dynamic</span>
00396     <span class="comment">// rather than static tracking.</span>
00397     <span class="comment">//</span>
00398 
00399     <a class="code" href="../../d3/d9/ulpc_8h.html#a4">DynamicQos</a>.ImpersonationLevel = SecurityImpersonation;
00400     <a class="code" href="../../d3/d9/ulpc_8h.html#a4">DynamicQos</a>.ContextTrackingMode = SECURITY_DYNAMIC_TRACKING;
00401     <a class="code" href="../../d3/d9/ulpc_8h.html#a4">DynamicQos</a>.EffectiveOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00402 
00403 
00404     <span class="comment">//</span>
00405     <span class="comment">// Create a section to contain the Port Memory.  Port Memory is private</span>
00406     <span class="comment">// memory that is shared between the client and server processes.</span>
00407     <span class="comment">// This allows data that is too large to fit into an API request message</span>
00408     <span class="comment">// to be passed to the server.</span>
00409     <span class="comment">//</span>
00410 
00411     SectionSize.LowPart = <a class="code" href="../../d9/d9/csrdll_8h.html#a2">CSR_PORT_MEMORY_SIZE</a>;
00412     SectionSize.HighPart = 0;
00413 
00414     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/creasect_8c.html#a19">NtCreateSection</a>( &amp;PortSection,
00415                               SECTION_ALL_ACCESS,
00416                               NULL,
00417                               &amp;SectionSize,
00418                               PAGE_READWRITE,
00419                               SEC_RESERVE,
00420                               NULL
00421                             );
00422     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00423         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00424         }
00425 
00426     <span class="comment">//</span>
00427     <span class="comment">// Connect to the server.  This includes a description of the Port Memory</span>
00428     <span class="comment">// section so that the LPC connection logic can make the section visible</span>
00429     <span class="comment">// to both the client and server processes.  Also pass information the</span>
00430     <span class="comment">// server needs in the connection information structure.</span>
00431     <span class="comment">//</span>
00432 
00433     ClientView.Length = <span class="keyword">sizeof</span>( ClientView );
00434     ClientView.SectionHandle = PortSection;
00435     ClientView.SectionOffset = 0;
00436     ClientView.ViewSize = SectionSize.LowPart;
00437     ClientView.ViewBase = 0;
00438     ClientView.ViewRemoteBase = 0;
00439 
00440     ServerView.Length = <span class="keyword">sizeof</span>( ServerView );
00441     ServerView.ViewSize = 0;
00442     ServerView.ViewBase = 0;
00443 
00444     ConnectionInformationLength = <span class="keyword">sizeof</span>( ConnectionInformation );
00445     ConnectionInformation.ExpectedVersion = CSR_VERSION;
00446 
00447     SystemSid = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00448     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a39">RtlAllocateAndInitializeSid</a>( &amp;NtAuthority,
00449                                           1,
00450                                           SECURITY_LOCAL_SYSTEM_RID,
00451                                           0, 0, 0, 0, 0, 0, 0,
00452                                           &amp;SystemSid
00453                                         );
00454     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d6/lpcconn_8c.html#a2">NtSecureConnectPort</a>( &amp;CsrPortHandle,
00455                           &amp;CsrPortName,
00456                           &amp;DynamicQos,
00457                           &amp;ClientView,
00458                           SystemSid,
00459                           &amp;ServerView,
00460                           (PULONG)&amp;MaxMessageLength,
00461                           (PVOID)&amp;ConnectionInformation,
00462                           (PULONG)&amp;ConnectionInformationLength
00463                         );
00464     <a class="code" href="../../d8/d6/sertl_8c.html#a41">RtlFreeSid</a>( SystemSid );
00465     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( PortSection );
00466     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00467         <a class="code" href="../../d0/d9/ntosdef_8h.html#a9">IF_DEBUG</a> {
00468             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"CSRDLL: Unable to connect to %wZ Server - Status == %X\n"</span>,
00469                       &amp;CsrPortName,
00470                       Status
00471                     );
00472             }
00473 
00474         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00475         }
00476     <a class="code" href="../../d1/d0/csrinit_8c.html#a3">xProtectHandle</a>(CsrPortHandle);
00477 
00478     NtCurrentPeb()-&gt;ReadOnlySharedMemoryBase = ConnectionInformation.SharedSectionBase;
00479     NtCurrentPeb()-&gt;ReadOnlySharedMemoryHeap = ConnectionInformation.SharedSectionHeap;
00480     NtCurrentPeb()-&gt;ReadOnlyStaticServerData = (PVOID *)ConnectionInformation.SharedStaticServerData;
00481 
00482 <span class="preprocessor">#if DBG</span>
00483 <span class="preprocessor"></span>    CsrDebug = ConnectionInformation.DebugFlags;
00484 <span class="preprocessor">#endif</span>
00485 <span class="preprocessor"></span>    <a class="code" href="../../d9/d9/csrdll_8h.html#a20">CsrObjectDirectory</a> = ConnectionInformation.ObjectDirectory;
00486 
00487     <a class="code" href="../../d9/d9/csrdll_8h.html#a17">CsrPortMemoryRemoteDelta</a> = (ULONG_PTR)ClientView.ViewRemoteBase -
00488                                (ULONG_PTR)ClientView.ViewBase;
00489 
00490     <a class="code" href="../../d9/d9/csrdll_8h.html#a0">IF_CSR_DEBUG</a>( LPC ) {
00491         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"CSRDLL: ClientView: Base=%p  RemoteBase=%p  Delta: %lX  Size=%lX\n"</span>,
00492                   ClientView.ViewBase,
00493                   ClientView.ViewRemoteBase,
00494                   CsrPortMemoryRemoteDelta,
00495                   (ULONG)ClientView.ViewSize
00496                 );
00497         }
00498 
00499     <span class="comment">//</span>
00500     <span class="comment">// Create a sparse heap in the share memory section.  Initially</span>
00501     <span class="comment">// commit just one page.</span>
00502     <span class="comment">//</span>
00503 
00504     <a class="code" href="../../d9/d9/csrdll_8h.html#a16">CsrPortHeap</a> = <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a15">RtlCreateHeap</a>( HEAP_CLASS_8,                      <span class="comment">// Flags</span>
00505                                  ClientView.ViewBase,               <span class="comment">// HeapBase</span>
00506                                  ClientView.ViewSize,               <span class="comment">// ReserveSize</span>
00507                                  <a class="code" href="../../d9/d9/csrdll_8h.html#a11">CsrNtSysInfo</a>.PageSize,             <span class="comment">// CommitSize</span>
00508                                  0,                                 <span class="comment">// Reserved</span>
00509                                  0                                  <span class="comment">// GrowthThreshold</span>
00510                                );
00511     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/csrdll_8h.html#a16">CsrPortHeap</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00512         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( CsrPortHandle );
00513         <a class="code" href="../../d9/d9/csrdll_8h.html#a15">CsrPortHandle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00514 
00515         <span class="keywordflow">return</span>( STATUS_NO_MEMORY );
00516         }
00517 
00518     <a class="code" href="../../d9/d9/csrdll_8h.html#a18">CsrPortBaseTag</a> = <a class="code" href="../../d5/d9/heapdll_8c.html#a28">RtlCreateTagHeap</a>( CsrPortHeap,
00519                                        0,
00520                                        L<span class="stringliteral">"CSRPORT!"</span>,
00521                                        L<span class="stringliteral">"!CSRPORT\0"</span>
00522                                        L<span class="stringliteral">"CAPTURE\0"</span>
00523                                      );
00524 
00525     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00526 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="csrinit.c::xProtectHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN xProtectHandle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>hObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/csrinit_8c-source.html#l00329">329</a> of file <a class="el" href="../../d2/d9/csrinit_8c-source.html">csrinit.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00058">NtQueryObject()</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00545">NtSetInformationObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/csrinit_8c-source.html#l00359">CsrpConnectToServer()</a>.
<p>
<pre class="fragment"><div>00332 {
00333     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00334     OBJECT_HANDLE_FLAG_INFORMATION HandleInfo;
00335 
00336     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/obquery_8c.html#a5">NtQueryObject</a>( hObject,
00337                             ObjectHandleFlagInformation,
00338                             &amp;HandleInfo,
00339                             <span class="keyword">sizeof</span>( HandleInfo ),
00340                             NULL
00341                           );
00342     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00343         HandleInfo.ProtectFromClose = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00344 
00345         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/obquery_8c.html#a6">NtSetInformationObject</a>( hObject,
00346                                          ObjectHandleFlagInformation,
00347                                          &amp;HandleInfo,
00348                                          <span class="keyword">sizeof</span>( HandleInfo )
00349                                        );
00350         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00351             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00352             }
00353         }
00354 
00355     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00356 }
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:20 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
