<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: kernel/exitwin.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>exitwin.c File Reference</h1><code>#include "<a class="el" href="../../d1/d3/w32_2ntuser_2kernel_2precomp_8h-source.html">precomp.h</a>"</code><br>

<p>
<a href="../../d2/d9/kernel_2exitwin_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/kernel_2exitwin_8c.html#a0">OPTIONMASK</a>&nbsp;&nbsp;&nbsp;(EWX_SHUTDOWN | EWX_REBOOT | EWX_FORCE)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/kernel_2exitwin_8c.html#a6">PrepareForLogoff</a> (UINT uFlags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/kernel_2exitwin_8c.html#a7">NotifyLogon</a> (<a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta, PLUID pluidCaller, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="el" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>, NTSTATUS StatusCode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/kernel_2exitwin_8c.html#a8">InitiateShutdown</a> (<a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread, PULONG lpdwFlags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/kernel_2exitwin_8c.html#a9">EndShutdown</a> (<a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread, NTSTATUS StatusShutdown)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/kernel_2exitwin_8c.html#a10">xxxClientShutdown2</a> (<a class="el" href="../../d4/d9/structtagBWL.html">PBWL</a> pbwl, UINT <a class="el" href="../../d2/d1/userexts_8c.html#a129">msg</a>, WPARAM wParam)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/kernel_2exitwin_8c.html#a11">xxxClientShutdown</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, WPARAM wParam)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/kernel_2exitwin_8c.html#a12">xxxRegisterUserHungAppHandlers</a> (PFNW32ET pfnW32EndTask, HANDLE hEventWowExec)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/kernel_2exitwin_8c.html#a1">gpwinstaLogoff</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/kernel_2exitwin_8c.html#a2">gdwLocks</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/kernel_2exitwin_8c.html#a3">gdwShutdownFlags</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HANDLE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/kernel_2exitwin_8c.html#a4">gpidEndSession</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PSECURITY_DESCRIPTOR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/kernel_2exitwin_8c.html#a5">gpsdInitWinSta</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="kernel/exitwin.c::OPTIONMASK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OPTIONMASK&nbsp;&nbsp;&nbsp;(EWX_SHUTDOWN | EWX_REBOOT | EWX_FORCE)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00016">16</a> of file <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html">kernel/exitwin.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00119">InitiateShutdown()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a9" doxytag="kernel/exitwin.c::EndShutdown" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS EndShutdown           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>NTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>StatusShutdown</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00324">324</a> of file <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html">kernel/exitwin.c</a>.
<p>
References <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l01123">_PostThreadMessage()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06611">CLEAR_PUDF</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02718">tagWINDOWSTATION::dwWSF_Flags</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00201">EnterCrit</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02779">ForceEmptyClipboard()</a>, <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00022">gdwLocks</a>, <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00023">gdwShutdownFlags</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00294">gdwThreadEndSession</a>, <a class="el" href="../../d5/d7/ex_8c-source.html#l00050">GetProcessLuid()</a>, <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00024">gpidEndSession</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00089">gptiShutdownNotify</a>, <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00021">gpwinstaLogoff</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00202">LeaveCrit</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02742">tagWINDOWSTATION::luidUser</a>, <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00077">NotifyLogon()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02739">tagWINDOWSTATION::pGlobalAtomTable</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02664">tagDESKTOP::pheapDesktop</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06592">PUDF_FONTSARELOADED</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02712">tagWINDOWSTATION::rpdeskList</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02647">tagDESKTOP::rpdeskNext</a>, <a class="el" href="../../d1/d9/rtl_2atom_8c-source.html#l00344">RtlEmptyAtomTable()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01824">RtlEqualLuid()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l03762">RtlZeroHeap()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06608">TEST_PUDF</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02703">WSF_OPENLOCK</a>, and <a class="el" href="../../d5/d0/userk_8h-source.html#l02705">WSF_SHUTDOWN</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/queue_8c-source.html#l06114">xxxSetInformationThread()</a>.
<p>
<pre class="fragment"><div>00327 {
00328     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta = <a class="code" href="../../d1/d0/kernel_2exitwin_8c.html#a1">gpwinstaLogoff</a>;
00329     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk;
00330     LUID luidCaller;
00331     UserAssert(gpwinstaLogoff);
00332 
00333     <a class="code" href="../../d1/d0/kernel_2exitwin_8c.html#a1">gpwinstaLogoff</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00334     <a class="code" href="../../d1/d0/kernel_2exitwin_8c.html#a4">gpidEndSession</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00335     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a128">gdwThreadEndSession</a> = 0;
00336     pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a317">WSF_SHUTDOWN</a>;
00337 
00338     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d4/d1/userk_8h.html#a961">GetProcessLuid</a>(Thread, &amp;luidCaller))) {
00339         luidCaller = RtlConvertUlongToLuid(0);     <span class="comment">// null luid</span>
00340     }
00341 
00342     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(StatusShutdown)) {
00343 
00344         <span class="comment">/*</span>
00345 <span class="comment">         * We need to notify the process that called ExitWindows that</span>
00346 <span class="comment">         * the logoff was aborted.</span>
00347 <span class="comment">         */</span>
00348         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a23">gptiShutdownNotify</a>) {
00349             <a class="code" href="../../d4/d1/userk_8h.html#a1645">_PostThreadMessage</a>(gptiShutdownNotify, WM_ENDSESSION, FALSE, 0);
00350             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a23">gptiShutdownNotify</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00351         }
00352 
00353         <span class="comment">/*</span>
00354 <span class="comment">         * Reset the windowstation lock flags so apps can start</span>
00355 <span class="comment">         * again.</span>
00356 <span class="comment">         */</span>
00357         pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> =
00358                 (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; ~<a class="code" href="../../d4/d1/userk_8h.html#a315">WSF_OPENLOCK</a>) |
00359                 <a class="code" href="../../d1/d0/kernel_2exitwin_8c.html#a2">gdwLocks</a>;
00360 
00361         <span class="comment">/*</span>
00362 <span class="comment">         * Bug 294204 - joejo</span>
00363 <span class="comment">         * Tell winlogon that we we cancelled shutdown/logoff.</span>
00364 <span class="comment">         */</span>
00365         <a class="code" href="../../d1/d0/kernel_2exitwin_8c.html#a7">NotifyLogon</a>(pwinsta, &amp;luidCaller, gdwShutdownFlags | EWX_CANCELED, StatusShutdown);
00366 
00367         <span class="keywordflow">return</span> STATUS_SUCCESS;
00368     }
00369 
00370     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a23">gptiShutdownNotify</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00371 
00372     <span class="comment">/*</span>
00373 <span class="comment">     * If logoff is occuring for the user set by winlogon, perform</span>
00374 <span class="comment">     * the normal logoff cleanup.  Otherwise, clear the open lock</span>
00375 <span class="comment">     * and continue.</span>
00376 <span class="comment">     */</span>
00377     <span class="keywordflow">if</span> (((pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o18">luidUser</a>.LowPart != 0) || (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o18">luidUser</a>.HighPart != 0)) &amp;&amp;
00378             <a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o18">luidUser</a>, &amp;luidCaller)) {
00379 
00380         <span class="comment">/*</span>
00381 <span class="comment">         * Zero out the free blocks in all desktop heaps.</span>
00382 <span class="comment">         */</span>
00383         <span class="keywordflow">for</span> (pdesk = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a>; pdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pdesk = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o2">rpdeskNext</a>) {
00384             <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a22">RtlZeroHeap</a>(Win32HeapGetHandle(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o16">pheapDesktop</a>), 0);
00385         }
00386 
00387         <span class="comment">/*</span>
00388 <span class="comment">         * Logoff/shutdown was successful. In case this is a logoff, remove</span>
00389 <span class="comment">         * everything from the clipboard so the next logged on user can't get</span>
00390 <span class="comment">         * at this stuff.</span>
00391 <span class="comment">         */</span>
00392         <a class="code" href="../../d4/d1/userk_8h.html#a1192">ForceEmptyClipboard</a>(pwinsta);
00393 
00394         <span class="comment">/*</span>
00395 <span class="comment">         * Destroy all non-pinned atoms in the global atom table.  User can't</span>
00396 <span class="comment">         * create pinned atoms.  Currently only the OLE atoms are pinned.</span>
00397 <span class="comment">         */</span>
00398         <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a15">RtlEmptyAtomTable</a>(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o16">pGlobalAtomTable</a>, FALSE);
00399 
00400         <span class="comment">// this code path is hit only on logoff and also on shutdown</span>
00401         <span class="comment">// We do not want to unload fonts twice when we attempt shutdown</span>
00402         <span class="comment">// so we mark that the fonts have been unloaded at a logoff time</span>
00403 
00404         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a657">TEST_PUDF</a>(PUDF_FONTSARELOADED)) {
00405             <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00406             GreRemoveAllButPermanentFonts();
00407             <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00408             <a class="code" href="../../d4/d1/userk_8h.html#a660">CLEAR_PUDF</a>(PUDF_FONTSARELOADED);
00409         }
00410     } <span class="keywordflow">else</span> {
00411         pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a315">WSF_OPENLOCK</a>;
00412     }
00413 
00414     <span class="comment">/*</span>
00415 <span class="comment">     * Tell winlogon that we successfully shutdown/logged off.</span>
00416 <span class="comment">     */</span>
00417     <a class="code" href="../../d1/d0/kernel_2exitwin_8c.html#a7">NotifyLogon</a>(pwinsta, &amp;luidCaller, gdwShutdownFlags, STATUS_SUCCESS);
00418 
00419     <span class="keywordflow">return</span> STATUS_SUCCESS;
00420 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="kernel/exitwin.c::InitiateShutdown" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS InitiateShutdown           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>lpdwFlags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00119">119</a> of file <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html">kernel/exitwin.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l03490">tagPROCESSINFO::amwinsta</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00388">_ETHREAD::Cid</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03390">tagTHREADINFO::cWindows</a>, <a class="el" href="../../d4/d7/propapi_8h-source.html#l00043">dwFlags</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02718">tagWINDOWSTATION::dwWSF_Flags</a>, <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00022">gdwLocks</a>, <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00023">gdwShutdownFlags</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00294">gdwThreadEndSession</a>, <a class="el" href="../../d5/d7/ex_8c-source.html#l00050">GetProcessLuid()</a>, <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00024">gpidEndSession</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00793">gpidLogon</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00089">gptiShutdownNotify</a>, <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00021">gpwinstaLogoff</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03489">tagPROCESSINFO::hwinsta</a>, <a class="el" href="../../d3/d9/server_2exitwin_8c-source.html#l02001">IsPrivileged()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02741">tagWINDOWSTATION::luidEndSession</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00656">luidSystem</a>, <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00077">NotifyLogon()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00016">OPTIONMASK</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00089">PpiFromProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00087">PtiFromThread</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03488">tagPROCESSINFO::rpwinsta</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03309">RtlAreAllAccessesGranted()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01824">RtlEqualLuid()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00638">THREAD_TO_PROCESS</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02827">TIF_16BIT</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02704">WSF_NOIO</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02703">WSF_OPENLOCK</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02708">WSF_REALSHUTDOWN</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02705">WSF_SHUTDOWN</a>, and <a class="el" href="../../d5/d0/userk_8h-source.html#l02702">WSF_SWITCHLOCK</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/queue_8c-source.html#l06114">xxxSetInformationThread()</a>.
<p>
<pre class="fragment"><div>00122 {
00123     <span class="keyword">static</span> PRIVILEGE_SET psShutdown = {
00124         1, PRIVILEGE_SET_ALL_NECESSARY, { SE_SHUTDOWN_PRIVILEGE, 0 }
00125     };
00126     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00127     LUID luidCaller;
00128     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi;
00129     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
00130     HWINSTA hwinsta;
00131     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiClient;
00132     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00133     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>;
00134 
00135     <span class="comment">/*</span>
00136 <span class="comment">     * Find out the callers sid. Only want to shutdown processes in the</span>
00137 <span class="comment">     * callers sid.</span>
00138 <span class="comment">     */</span>
00139     Process = <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>(Thread);
00140     ptiClient = <a class="code" href="../../d4/d1/userk_8h.html#a17">PtiFromThread</a>(Thread);
00141     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a961">GetProcessLuid</a>(Thread, &amp;luidCaller);
00142 
00143     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00144         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00145     }
00146 
00147     <span class="comment">/*</span>
00148 <span class="comment">     * Set the system flag if the caller is a system process.</span>
00149 <span class="comment">     * Winlogon uses this to determine in which context to perform</span>
00150 <span class="comment">     * a shutdown operation.</span>
00151 <span class="comment">     */</span>
00152     <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> = *lpdwFlags;
00153     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;luidCaller, &amp;luidSystem)) {
00154         <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> |= EWX_SYSTEM_CALLER;
00155     } <span class="keywordflow">else</span> {
00156         <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp;= ~EWX_SYSTEM_CALLER;
00157     }
00158 
00159     <span class="comment">/*</span>
00160 <span class="comment">     * Find a windowstation.  If the process does not have one</span>
00161 <span class="comment">     * assigned, use the standard one.</span>
00162 <span class="comment">     */</span>
00163     ppi = <a class="code" href="../../d4/d1/userk_8h.html#a18">PpiFromProcess</a>(Process);
00164     <span class="keywordflow">if</span> (ppi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00165         <span class="comment">/*</span>
00166 <span class="comment">         * We ran into a case where the thread was terminated and had already</span>
00167 <span class="comment">         * been cleaned up by USER.  Thus, the ppi and ptiClient was NULL.</span>
00168 <span class="comment">         */</span>
00169         <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
00170     }
00171     pwinsta = ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o14">rpwinsta</a>;
00172     hwinsta = ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o15">hwinsta</a>;
00173     <span class="comment">/*</span>
00174 <span class="comment">     * If we're not being called by Winlogon, validate the call and</span>
00175 <span class="comment">     * notify the logon process to do the actual shutdown.</span>
00176 <span class="comment">     */</span>
00177     <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueProcess != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a>) {
00178         <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp;= ~EWX_WINLOGON_CALLER;
00179         *lpdwFlags = <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>;
00180 
00181         <span class="keywordflow">if</span> (pwinsta == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00182 <span class="preprocessor">#ifndef LATER</span>
00183 <span class="preprocessor"></span>            <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
00184 <span class="preprocessor">#else</span>
00185 <span class="preprocessor"></span>            hwinsta = ppi-&gt;pOpenObjectTable[HI_WINDOWSTATION].h;
00186             <span class="keywordflow">if</span> (hwinsta == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00187                 <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
00188             }
00189             pwinsta = (<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>)ppi-&gt;pOpenObjectTable[HI_WINDOWSTATION].phead;
00190 <span class="preprocessor">#endif</span>
00191 <span class="preprocessor"></span>        }
00192 
00193         <span class="comment">/*</span>
00194 <span class="comment">         * Check security first - does this thread have access?</span>
00195 <span class="comment">         */</span>
00196         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a68">RtlAreAllAccessesGranted</a>(ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o16">amwinsta</a>, WINSTA_EXITWINDOWS)) {
00197             <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00198         }
00199 
00200         <span class="comment">/*</span>
00201 <span class="comment">         * If the client requested shutdown, reboot, or poweroff they must have</span>
00202 <span class="comment">         * the shutdown privilege.</span>
00203 <span class="comment">         */</span>
00204         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; EWX_SHUTDOWN) {
00205             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d0/server_2exitwin_8c.html#a22">IsPrivileged</a>(&amp;psShutdown) ) {
00206                 <span class="keywordflow">return</span> STATUS_PRIVILEGE_NOT_HELD;
00207             }
00208         } <span class="keywordflow">else</span> {
00209 
00210             <span class="comment">/*</span>
00211 <span class="comment">             * If this is a non-IO windowstation and we are not shutting down,</span>
00212 <span class="comment">             * fail the call.</span>
00213 <span class="comment">             */</span>
00214             <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>) {
00215                 <span class="keywordflow">return</span> STATUS_INVALID_DEVICE_REQUEST;
00216             }
00217         }
00218     }
00219 
00220     <span class="comment">/*</span>
00221 <span class="comment">     * Is there a shutdown already in progress?</span>
00222 <span class="comment">     */</span>
00223     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a128">gdwThreadEndSession</a> != 0) {
00224         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwNew;
00225 
00226         <span class="comment">/*</span>
00227 <span class="comment">         * If the current shutdown in another sid and is not being done by</span>
00228 <span class="comment">         * winlogon, override it.</span>
00229 <span class="comment">         */</span>
00230         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;luidCaller, &amp;<a class="code" href="../../d1/d0/kernel_2exitwin_8c.html#a1">gpwinstaLogoff</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o17">luidEndSession</a>) &amp;&amp;
00231                 (<a class="code" href="../../d1/d0/kernel_2exitwin_8c.html#a4">gpidEndSession</a> != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a>)) {
00232             <span class="keywordflow">return</span> STATUS_RETRY;
00233         }
00234 
00235         <span class="comment">/*</span>
00236 <span class="comment">         * Calculate new flags</span>
00237 <span class="comment">         */</span>
00238         dwNew = <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d1/d0/kernel_2exitwin_8c.html#a0">OPTIONMASK</a> &amp; (~<a class="code" href="../../d1/d0/kernel_2exitwin_8c.html#a3">gdwShutdownFlags</a>);
00239 
00240         <span class="comment">/*</span>
00241 <span class="comment">         * Should we override the other shutdown?  Make sure</span>
00242 <span class="comment">         * winlogon does not recurse.</span>
00243 <span class="comment">         */</span>
00244         <span class="keywordflow">if</span> (dwNew &amp;&amp; HandleToUlong(<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueThread) !=
00245                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a128">gdwThreadEndSession</a>) {
00246             <span class="comment">/*</span>
00247 <span class="comment">             * Only one windowstation can be logged off at a time.</span>
00248 <span class="comment">             */</span>
00249             <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; EWX_SHUTDOWN) &amp;&amp;
00250                     pwinsta != <a class="code" href="../../d1/d0/kernel_2exitwin_8c.html#a1">gpwinstaLogoff</a>) {
00251                 <span class="keywordflow">return</span> STATUS_DEVICE_BUSY;
00252             }
00253 
00254             <span class="comment">/*</span>
00255 <span class="comment">             * Set the new flags</span>
00256 <span class="comment">             */</span>
00257             <a class="code" href="../../d1/d0/kernel_2exitwin_8c.html#a3">gdwShutdownFlags</a> = <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>;
00258 
00259             <span class="keywordflow">if</span> (dwNew &amp; EWX_FORCE) {
00260                 <span class="keywordflow">return</span> STATUS_RETRY;
00261             } <span class="keywordflow">else</span> {
00262                 <span class="keywordflow">return</span> STATUS_PENDING;
00263             }
00264         } <span class="keywordflow">else</span> {
00265             <span class="comment">/*</span>
00266 <span class="comment">             * Don't override</span>
00267 <span class="comment">             */</span>
00268             <span class="keywordflow">return</span> STATUS_PENDING;
00269         }
00270     }
00271 
00272     <span class="comment">/*</span>
00273 <span class="comment">     * If the caller is not winlogon, signal winlogon to start</span>
00274 <span class="comment">     * the real shutdown.</span>
00275 <span class="comment">     */</span>
00276     <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueProcess != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a>) {
00277         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; EWX_NOTIFY) {
00278             <span class="keywordflow">if</span> (ptiClient &amp;&amp; ptiClient-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>)
00279                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a23">gptiShutdownNotify</a> = ptiClient;
00280             <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp;= ~EWX_NOTIFY;
00281             *lpdwFlags = <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>;
00282         }
00283 
00284         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/kernel_2exitwin_8c.html#a7">NotifyLogon</a>(pwinsta, &amp;luidCaller, dwFlags, STATUS_SUCCESS))
00285             <span class="keywordflow">return</span> STATUS_PENDING;
00286         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ptiClient &amp;&amp; ptiClient-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o49">cWindows</a>)
00287             <span class="keywordflow">return</span> STATUS_CANT_WAIT;
00288     }
00289 
00290     <span class="comment">/*</span>
00291 <span class="comment">     * Mark this thread as the one that is currently processing</span>
00292 <span class="comment">     * exit windows, and set the global saying someone is exiting</span>
00293 <span class="comment">     */</span>
00294     <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> |= EWX_WINLOGON_CALLER;
00295     *lpdwFlags = <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>;
00296     <a class="code" href="../../d1/d0/kernel_2exitwin_8c.html#a3">gdwShutdownFlags</a> = <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>;
00297 
00298     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a128">gdwThreadEndSession</a> = HandleToUlong(<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueThread);
00299     <a class="code" href="../../d1/d0/kernel_2exitwin_8c.html#a4">gpidEndSession</a> = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueProcess;
00300     <a class="code" href="../../d1/d0/kernel_2exitwin_8c.html#a1">gpwinstaLogoff</a> = pwinsta;
00301     pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o17">luidEndSession</a> = luidCaller;
00302 
00303     <span class="comment">/*</span>
00304 <span class="comment">     * Lock the windowstation to prevent apps from starting</span>
00305 <span class="comment">     * while we're doing shutdown processing.</span>
00306 <span class="comment">     */</span>
00307     <a class="code" href="../../d1/d0/kernel_2exitwin_8c.html#a2">gdwLocks</a> = pwinsta-&gt;dwWSF_Flags &amp; (<a class="code" href="../../d4/d1/userk_8h.html#a314">WSF_SWITCHLOCK</a> | <a class="code" href="../../d4/d1/userk_8h.html#a315">WSF_OPENLOCK</a>);
00308     pwinsta-&gt;dwWSF_Flags |= (<a class="code" href="../../d4/d1/userk_8h.html#a315">WSF_OPENLOCK</a> | <a class="code" href="../../d4/d1/userk_8h.html#a317">WSF_SHUTDOWN</a>);
00309 
00310     <span class="comment">/*</span>
00311 <span class="comment">     * Set the flag WSF_REALSHUTDOWN if we are not doing just a</span>
00312 <span class="comment">     * logoff</span>
00313 <span class="comment">     */</span>
00314     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp;
00315         (EWX_WINLOGON_OLD_SHUTDOWN | EWX_WINLOGON_OLD_REBOOT |
00316          EWX_SHUTDOWN | EWX_REBOOT)) {
00317 
00318         pwinsta-&gt;dwWSF_Flags |= <a class="code" href="../../d4/d1/userk_8h.html#a319">WSF_REALSHUTDOWN</a>;
00319     }
00320 
00321     <span class="keywordflow">return</span> STATUS_SUCCESS;
00322 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="kernel/exitwin.c::NotifyLogon" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL NotifyLogon           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwinsta</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PLUID&nbsp;</td>
          <td class="mdname" nowrap> <em>pluidCaller</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>dwFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>NTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>StatusCode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00077">77</a> of file <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html">kernel/exitwin.c</a>.
<p>
References <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l00981">_PostMessage()</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d4/d7/propapi_8h-source.html#l00043">dwFlags</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00071">gspwndLogonNotify</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00656">luidSystem</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02742">tagWINDOWSTATION::luidUser</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01824">RtlEqualLuid()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00324">EndShutdown()</a>, and <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00119">InitiateShutdown()</a>.
<p>
<pre class="fragment"><div>00082 {
00083     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fNotified = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00084     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwllParam;
00085     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwStatus;
00086 
00087     <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; EWX_NONOTIFY)) {
00088 
00089         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; EWX_CANCELED) {
00090             dwllParam = LOGON_LOGOFFCANCELED;
00091             dwStatus = StatusCode;
00092         } <span class="keywordflow">else</span> {
00093             dwllParam = LOGON_LOGOFF;
00094             dwStatus = <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>;
00095         }
00096 
00097         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; EWX_SHUTDOWN) {
00098             <span class="comment">/*</span>
00099 <span class="comment">             * Post the message to the global logon notify window</span>
00100 <span class="comment">             */</span>
00101             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00102                 <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(gspwndLogonNotify, WM_LOGONNOTIFY,
00103                              dwllParam, (LONG)dwStatus);
00104                 fNotified = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00105             }
00106         } <span class="keywordflow">else</span> {
00107             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00108                     (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o18">luidUser</a>, pluidCaller) ||
00109                      <a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;luidSystem, pluidCaller))) {
00110                 <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(gspwndLogonNotify, WM_LOGONNOTIFY, dwllParam,
00111                         (LONG)dwStatus);
00112                 fNotified = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00113             }
00114         }
00115     }
00116     <span class="keywordflow">return</span> fNotified;
00117 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="kernel/exitwin.c::PrepareForLogoff" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL PrepareForLogoff           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">UINT&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>uFlags</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00033">33</a> of file <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html">kernel/exitwin.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01833">CheckCritIn</a>, <a class="el" href="../../d2/d6/w32_2ntuser_2kernel_2profile_8c-source.html#l00151">CreateProfileUserName()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d6/w32_2ntuser_2kernel_2profile_8c-source.html#l00174">FreeProfileUserName()</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00793">gpidLogon</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03319">tagTHREADINFO::ppi</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d4/d1/userk_8h.html#a878">PW32JOB</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03501">tagPROCESSINFO::pW32Job</a>, <a class="el" href="../../d8/d8/keyboard_8c-source.html#l00223">RegisterPerUserKeyboardIndicators()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03447">tagW32JOB::restrictions</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02857">TIF_RESTRICTED</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00035 {
00036     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00037 
00038     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00039 
00040     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a821">TIF_RESTRICTED</a>) {
00041         <a class="code" href="../../d1/d9/structtagW32JOB.html">PW32JOB</a> pW32Job;
00042 
00043         pW32Job = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o25">pW32Job</a>;
00044 
00045         UserAssert(pW32Job != NULL);
00046 
00047         <span class="keywordflow">if</span> (pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o3">restrictions</a> &amp; JOB_OBJECT_UILIMIT_EXITWINDOWS) {
00048             <span class="comment">// Not permitted to ExitWindows.</span>
00049             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00050         }
00051     }
00052 
00053     <span class="comment">/*</span>
00054 <span class="comment">     * There are no restrictions, or the restriction do not deny shutdown:</span>
00055 <span class="comment">     * The caller is about to ExitWindowsEx via CSR, so save the volatile</span>
00056 <span class="comment">     * elements of the User preferences in their profile</span>
00057 <span class="comment">     */</span>
00058     <span class="keywordflow">if</span> (ptiCurrent-&gt;pEThread-&gt;Cid.UniqueProcess == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a>) {
00059         <span class="comment">/*</span>
00060 <span class="comment">         * Save the current user's NumLock state</span>
00061 <span class="comment">         */</span>
00062         <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlName;
00063         PUNICODE_STRING pProfileUserName = <a class="code" href="../../d4/d1/userk_8h.html#a2000">CreateProfileUserName</a>(&amp;tlName);
00064         <a class="code" href="../../d4/d1/userk_8h.html#a1717">RegisterPerUserKeyboardIndicators</a>(pProfileUserName);
00065         <a class="code" href="../../d4/d1/userk_8h.html#a2001">FreeProfileUserName</a>(pProfileUserName, &amp;tlName);
00066     }
00067 
00068     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00069     UNREFERENCED_PARAMETER(uFlags);
00070 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="kernel/exitwin.c::xxxClientShutdown" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONG xxxClientShutdown           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>wParam</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00521">521</a> of file <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html">kernel/exitwin.c</a>.
<p>
References <a class="el" href="../../d5/d6/enumwin_8c-source.html#l00091">BuildHwndList()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03634">BWL_ENUMLIST</a>, <a class="el" href="../../d5/d6/enumwin_8c-source.html#l00417">FreeHwndList()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02644">tagDESKTOP::pDeskInfo</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03327">tagTHREADINFO::rpdesk</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02156">tagDESKTOPINFO::spwnd</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01746">tagWND::spwndChild</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00604">WMCS_QUERYEND</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00616">WMCSR_ALLOWSHUTDOWN</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00617">WMCSR_DONE</a>, and <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00428">xxxClientShutdown2()</a>.
<p>
Referenced by <a class="el" href="../../d9/d2/dwp_8c-source.html#l01264">xxxDefWindowProc()</a>.
<p>
<pre class="fragment"><div>00524 {
00525     <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a> pbwl;
00526     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiT;
00527     LONG lRet;
00528 
00529     <span class="comment">/*</span>
00530 <span class="comment">     * Build a list of windows first.</span>
00531 <span class="comment">     */</span>
00532     ptiT = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd);
00533 
00534     <span class="keywordflow">if</span> ((pbwl = <a class="code" href="../../d4/d1/userk_8h.html#a1157">BuildHwndList</a>(ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>,
00535             BWL_ENUMLIST, ptiT)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00536         <span class="comment">/*</span>
00537 <span class="comment">         * Can't allocate memory to notify this thread's windows of shutdown.</span>
00538 <span class="comment">         * Can't do more than kill the app</span>
00539 <span class="comment">         */</span>
00540         <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a138">WMCSR_ALLOWSHUTDOWN</a>;
00541     }
00542 
00543     <span class="keywordflow">if</span> (wParam &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a130">WMCS_QUERYEND</a>) {
00544         lRet = <a class="code" href="../../d1/d0/kernel_2exitwin_8c.html#a10">xxxClientShutdown2</a>(pbwl, WM_QUERYENDSESSION, wParam);
00545     } <span class="keywordflow">else</span> {
00546         <a class="code" href="../../d1/d0/kernel_2exitwin_8c.html#a10">xxxClientShutdown2</a>(pbwl, WM_ENDSESSION, wParam);
00547         lRet = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a139">WMCSR_DONE</a>;
00548     }
00549 
00550     <a class="code" href="../../d4/d1/userk_8h.html#a1158">FreeHwndList</a>(pbwl);
00551     <span class="keywordflow">return</span> lRet;
00552 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="kernel/exitwin.c::xxxClientShutdown2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONG xxxClientShutdown2           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d9/structtagBWL.html">PBWL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pbwl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>msg</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>wParam</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00428">428</a> of file <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html">kernel/exitwin.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d5/d1/timers_8c-source.html#l00504">DestroyWindowsTimers()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00089">gptiShutdownNotify</a>, <a class="el" href="../../d3/d0/userexts_8c-source.html#l01830">msg</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00194">RevalidateHwnd</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03624">tagBWL::rghwnd</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00363">ThreadLockAlways</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00366">ThreadUnlock</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00606">WMCS_CONTEXTLOGOFF</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00603">WMCS_EXIT</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00616">WMCSR_ALLOWSHUTDOWN</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00618">WMCSR_CANCEL</a>, and <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00688">xxxSendMessage()</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00521">xxxClientShutdown()</a>.
<p>
<pre class="fragment"><div>00432 {
00433     HWND *phwnd;
00434     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00435     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
00436     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fEnd;
00437     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00438     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fDestroyTimers;
00439     LPARAM lParam;
00440 
00441     <span class="comment">/*</span>
00442 <span class="comment">     * Make sure we don't send this window any more WM_TIMER</span>
00443 <span class="comment">     * messages if the session is ending. This was causing</span>
00444 <span class="comment">     * AfterDark to fault when it freed some memory on the</span>
00445 <span class="comment">     * WM_ENDSESSION and then tried to reference it on the</span>
00446 <span class="comment">     * WM_TIMER.</span>
00447 <span class="comment">     * LATER GerardoB: Do we still need to do this??</span>
00448 <span class="comment">     * Do this horrible thing only if the process is in the</span>
00449 <span class="comment">     * context being logged off.</span>
00450 <span class="comment">     * Perhaps someday we should post a WM_CLOSE so the app</span>
00451 <span class="comment">     * gets a better chance to clean up (if this process is in</span>
00452 <span class="comment">     * the context being logged off, winsrv is going to call</span>
00453 <span class="comment">     * TerminateProcess soon after this).</span>
00454 <span class="comment">     */</span>
00455      fDestroyTimers = (wParam &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a129">WMCS_EXIT</a>) &amp;&amp; (wParam &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a132">WMCS_CONTEXTLOGOFF</a>);
00456 
00457      <span class="comment">/*</span>
00458 <span class="comment">      * fLogOff and fEndSession parameters (WM_ENDSESSION only)</span>
00459 <span class="comment">      */</span>
00460      lParam = wParam &amp; ENDSESSION_LOGOFF;
00461      wParam &amp;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a129">WMCS_EXIT</a>;
00462 
00463     <span class="comment">/*</span>
00464 <span class="comment">     * Now enumerate these windows and send the WM_QUERYENDSESSION or</span>
00465 <span class="comment">     * WM_ENDSESSION messages.</span>
00466 <span class="comment">     */</span>
00467     <span class="keywordflow">for</span> (phwnd = pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o4">rghwnd</a>; *phwnd != (HWND)1; phwnd++) {
00468         <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(*phwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00469             <span class="keywordflow">continue</span>;
00470 
00471         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwnd, &amp;tlpwnd);
00472 
00473         <span class="comment">/*</span>
00474 <span class="comment">         * Send the message.</span>
00475 <span class="comment">         */</span>
00476         <span class="keywordflow">switch</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>) {
00477         <span class="keywordflow">case</span> WM_QUERYENDSESSION:
00478 
00479             <span class="comment">/*</span>
00480 <span class="comment">             * Windows does not send the WM_QUERYENDSESSION to the app</span>
00481 <span class="comment">             * that called ExitWindows</span>
00482 <span class="comment">             */</span>
00483             <span class="keywordflow">if</span> (ptiCurrent == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a23">gptiShutdownNotify</a>) {
00484                 fEnd = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00485             } <span class="keywordflow">else</span> {
00486                 fEnd = (<a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_QUERYENDSESSION, FALSE, lParam) != 0);
00487                 <span class="keywordflow">if</span> (!fEnd) {
00488                     RIPMSG2(RIP_WARNING, <span class="stringliteral">"xxxClientShutdown2: pwnd:%p canceled shutdown. lParam:%p"</span>,
00489                             pwnd, lParam);
00490                 }
00491             }
00492             <span class="keywordflow">break</span>;
00493 
00494         <span class="keywordflow">case</span> WM_ENDSESSION:
00495             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_ENDSESSION, wParam, lParam);
00496             fEnd = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00497 
00498             <span class="keywordflow">if</span> (fDestroyTimers) {
00499                 <a class="code" href="../../d4/d1/userk_8h.html#a1479">DestroyWindowsTimers</a>(pwnd);
00500             }
00501 
00502             <span class="keywordflow">break</span>;
00503         }
00504 
00505         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
00506 
00507         <span class="keywordflow">if</span> (!fEnd)
00508             <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a140">WMCSR_CANCEL</a>;
00509     }
00510 
00511     <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a138">WMCSR_ALLOWSHUTDOWN</a>;
00512 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="kernel/exitwin.c::xxxRegisterUserHungAppHandlers" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL xxxRegisterUserHungAppHandlers           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PFNW32ET&nbsp;</td>
          <td class="mdname" nowrap> <em>pfnW32EndTask</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>hEventWowExec</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00565">565</a> of file <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html">kernel/exitwin.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00030">ExEventObjectType</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00094">gpwpiFirstWow</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03416">tagWOWPROCESSINFO::hEventWowExecClient</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03414">tagWOWPROCESSINFO::lpfnWowExitTask</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03415">tagWOWPROCESSINFO::pEventWowExec</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00084">PpiCurrent</a>, <a class="el" href="../../d4/d1/userk_8h.html#a874">PWOWPROCESSINFO</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03479">tagPROCESSINFO::pwpi</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03410">tagWOWPROCESSINFO::pwpiNext</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, and <a class="el" href="../../d4/d1/userk_8h.html#a873">WOWPROCESSINFO</a>.
<p>
<pre class="fragment"><div>00568 {
00569     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>   bRetVal;
00570     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>    ppi;
00571     <a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html">PWOWPROCESSINFO</a> pwpi;
00572 
00573     <span class="comment">//</span>
00574     <span class="comment">//  Allocate the per wow process info stuff</span>
00575     <span class="comment">//  ensuring the memory is Zero init.</span>
00576     <span class="comment">//</span>
00577     pwpi = (<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html">PWOWPROCESSINFO</a>) UserAllocPoolWithQuotaZInit(
00578             <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html">WOWPROCESSINFO</a>), TAG_WOWPROCESSINFO);
00579 
00580     <span class="keywordflow">if</span> (!pwpi)
00581         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00582 
00583     <span class="comment">//</span>
00584     <span class="comment">// Reference the WowExec event for kernel access</span>
00585     <span class="comment">//</span>
00586     bRetVal = <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00587                  hEventWowExec,
00588                  EVENT_ALL_ACCESS,
00589                  *ExEventObjectType,
00590                  UserMode,
00591                  &amp;pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o5">pEventWowExec</a>,
00592                  NULL
00593                  ));
00594 
00595     <span class="comment">//</span>
00596     <span class="comment">//  if sucess then intialize the pwpi, ppi structs</span>
00597     <span class="comment">//  else free allocated memory</span>
00598     <span class="comment">//</span>
00599     <span class="keywordflow">if</span> (bRetVal) {
00600         pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o6">hEventWowExecClient</a> = hEventWowExec;
00601         pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o4">lpfnWowExitTask</a> = pfnW32EndTask;
00602         ppi = <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>();
00603         ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o6">pwpi</a> = pwpi;
00604 
00605         <span class="comment">// add to the list, order doesn't matter</span>
00606         pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o0">pwpiNext</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a28">gpwpiFirstWow</a>;
00607         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a28">gpwpiFirstWow</a>  = pwpi;
00608 
00609         }
00610     <span class="keywordflow">else</span> {
00611         UserFreePool(pwpi);
00612         }
00613 
00614    <span class="keywordflow">return</span> bRetVal;
00615 }
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a2" doxytag="kernel/exitwin.c::gdwLocks" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="el" href="../../d1/d0/kernel_2exitwin_8c.html#a2">gdwLocks</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00022">22</a> of file <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html">kernel/exitwin.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00324">EndShutdown()</a>, and <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00119">InitiateShutdown()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="kernel/exitwin.c::gdwShutdownFlags" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="el" href="../../d1/d0/kernel_2exitwin_8c.html#a3">gdwShutdownFlags</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00023">23</a> of file <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html">kernel/exitwin.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00324">EndShutdown()</a>, and <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00119">InitiateShutdown()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="kernel/exitwin.c::gpidEndSession" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HANDLE <a class="el" href="../../d1/d0/kernel_2exitwin_8c.html#a4">gpidEndSession</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00024">24</a> of file <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html">kernel/exitwin.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00324">EndShutdown()</a>, and <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00119">InitiateShutdown()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="kernel/exitwin.c::gpsdInitWinSta" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PSECURITY_DESCRIPTOR <a class="el" href="../../d7/d5/w32_2ntuser_2kernel_2security_8c.html#a1">gpsdInitWinSta</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00026">26</a> of file <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html">kernel/exitwin.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d6/kernel_2server_8c-source.html#l01417">InitCreateObjectDirectory()</a>, <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00152">InitSecurity()</a>, and <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l00097">Win32kNtUserCleanup()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="kernel/exitwin.c::gpwinstaLogoff" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> <a class="el" href="../../d1/d0/kernel_2exitwin_8c.html#a1">gpwinstaLogoff</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00021">21</a> of file <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html">kernel/exitwin.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00324">EndShutdown()</a>, and <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00119">InitiateShutdown()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:36 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
