<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: io/misc.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>misc.c File Reference</h1><code>#include "<a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>"</code><br>

<p>
<a href="../../d2/d9/io_2misc_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/io_2misc_8c.html#a0">IopProcessWorkItem</a> (IN PVOID Parameter)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/io_2misc_8c.html#a1">NtCancelIoFile</a> (IN HANDLE FileHandle, OUT PIO_STATUS_BLOCK IoStatusBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/io_2misc_8c.html#a2">NtDeleteFile</a> (IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/io_2misc_8c.html#a3">NtFlushBuffersFile</a> (IN HANDLE FileHandle, OUT PIO_STATUS_BLOCK IoStatusBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/io_2misc_8c.html#a4">NtQueryAttributesFile</a> (IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>, OUT PFILE_BASIC_INFORMATION FileInformation)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/io_2misc_8c.html#a5">NtQueryFullAttributesFile</a> (IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>, OUT PFILE_NETWORK_OPEN_INFORMATION FileInformation)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d5/d9/struct__IO__WORKITEM.html">PIO_WORKITEM</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/io_2misc_8c.html#a6">IoAllocateWorkItem</a> (<a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/io_2misc_8c.html#a7">IoFreeWorkItem</a> (<a class="el" href="../../d5/d9/struct__IO__WORKITEM.html">PIO_WORKITEM</a> IoWorkItem)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d0/io_2misc_8c.html#a8">IoQueueWorkItem</a> (IN <a class="el" href="../../d5/d9/struct__IO__WORKITEM.html">PIO_WORKITEM</a> IoWorkItem, IN <a class="el" href="../../d0/d5/io_8h.html#a398">PIO_WORKITEM_ROUTINE</a> WorkerRoutine, IN <a class="el" href="../../d5/d8/ex_8h.html#a110">WORK_QUEUE_TYPE</a> QueueType, IN PVOID Context)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a6" doxytag="io/misc.c::IoAllocateWorkItem" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d5/d9/struct__IO__WORKITEM.html">PIO_WORKITEM</a> IoAllocateWorkItem           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00891">891</a> of file <a class="el" href="../../d2/d9/io_2misc_8c-source.html">io/misc.c</a>.
<p>
References <a class="el" href="../../d1/d5/iop_8h-source.html#l00160">_IO_WORKITEM::DeviceObject</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01961">ExInitializeWorkItem</a>, <a class="el" href="../../d0/d6/iop_8h.html#a41">IO_WORKITEM</a>, <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l01016">IopProcessWorkItem()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d5/iop_8h-source.html#l00158">_IO_WORKITEM::WorkItem</a>.
<p>
<pre class="fragment"><div>00894 {
00895     <a class="code" href="../../d5/d9/struct__IO__WORKITEM.html">PIO_WORKITEM</a> ioWorkItem;
00896     <a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">PWORK_QUEUE_ITEM</a> exWorkItem;
00897 
00898     <span class="comment">//</span>
00899     <span class="comment">// Allocate a new workitem structure.</span>
00900     <span class="comment">// </span>
00901 
00902     ioWorkItem = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPool, <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d9/struct__IO__WORKITEM.html">IO_WORKITEM</a> ));
00903     <span class="keywordflow">if</span> (ioWorkItem != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00904 
00905         <span class="comment">//</span>
00906         <span class="comment">// Initialize the invariant portions of both ioWorkItem and</span>
00907         <span class="comment">// exWorkItem.</span>
00908         <span class="comment">//</span>
00909 
00910 <span class="preprocessor">#if DBG</span>
00911 <span class="preprocessor"></span>        ioWorkItem-&gt;Size = <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d9/struct__IO__WORKITEM.html">IO_WORKITEM</a> );
00912 <span class="preprocessor">#endif</span>
00913 <span class="preprocessor"></span>
00914         ioWorkItem-&gt;<a class="code" href="../../d5/d9/struct__IO__WORKITEM.html#o2">DeviceObject</a> = DeviceObject;
00915 
00916         exWorkItem = &amp;ioWorkItem-&gt;<a class="code" href="../../d5/d9/struct__IO__WORKITEM.html#o0">WorkItem</a>;
00917         <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>( exWorkItem, IopProcessWorkItem, ioWorkItem );
00918     }
00919 
00920     <span class="keywordflow">return</span> ioWorkItem;
00921 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="io/misc.c::IoFreeWorkItem" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IoFreeWorkItem           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d9/struct__IO__WORKITEM.html">PIO_WORKITEM</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>IoWorkItem</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00924">924</a> of file <a class="el" href="../../d2/d9/io_2misc_8c-source.html">io/misc.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, and <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>.
<p>
<pre class="fragment"><div>00930                    :
00931 
00932     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="stringliteral">"wrapper"</span> routine <span class="keywordflow">for</span> <a class="code" href="../../d0/d5/io_8h.html#a571">IoQueueWorkItem</a>.  It calls
00933     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original worker function, then dereferences <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object to
00934     (possibly) allow <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver object to go away.
00935 
00936 Arguments:
00937 
00938     Parameter - Supplies a pointer to an <a class="code" href="../../d5/d9/struct__IO__WORKITEM.html">IO_WORKITEM</a> <span class="keywordflow">for</span> us to process.
00939 
00940 Return Value:
00941 
00942     None
00943 
00944 --*/
00945 
00946 {
00947     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IoWorkItem-&gt;Size == <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d9/struct__IO__WORKITEM.html">IO_WORKITEM</a> ));
00948 
00949     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( IoWorkItem );
00950 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="io/misc.c::IopProcessWorkItem" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopProcessWorkItem           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Parameter</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l01016">1016</a> of file <a class="el" href="../../d2/d9/io_2misc_8c-source.html">io/misc.c</a>.
<p>
References <a class="el" href="../../d1/d5/iop_8h-source.html#l00161">_IO_WORKITEM::Context</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00160">_IO_WORKITEM::DeviceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d1/d5/iop_8h-source.html#l00159">_IO_WORKITEM::Routine</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00891">IoAllocateWorkItem()</a>.
<p>
<pre class="fragment"><div>01022                    :
01023 
01024     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="stringliteral">"wrapper"</span> routine <span class="keywordflow">for</span> <a class="code" href="../../d0/d5/io_8h.html#a571">IoQueueWorkItem</a>.  It calls
01025     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original worker function, then dereferences <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object to
01026     (possibly) allow <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver object to go away.
01027 
01028 Arguments:
01029 
01030     Parameter - Supplies a pointer to an <a class="code" href="../../d5/d9/struct__IO__WORKITEM.html">IO_WORKITEM</a> <span class="keywordflow">for</span> us to process.
01031 
01032 Return Value:
01033 
01034     None
01035 
01036 --*/
01037 
01038 {
01039     <a class="code" href="../../d5/d9/struct__IO__WORKITEM.html">PIO_WORKITEM</a> ioWorkItem;
01040     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
01041 
01042     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01043 
01044     <span class="comment">//</span>
01045     <span class="comment">// Get a pointer to the ioWorkItem and store a copy of DeviceObject</span>
01046     <span class="comment">// locally.  This allow us to function properly if the worker routine</span>
01047     <span class="comment">// elects to free the work item.</span>
01048     <span class="comment">//</span>
01049 
01050     ioWorkItem = (<a class="code" href="../../d5/d9/struct__IO__WORKITEM.html">PIO_WORKITEM</a>)Parameter;
01051     deviceObject = ioWorkItem-&gt;<a class="code" href="../../d5/d9/struct__IO__WORKITEM.html#o2">DeviceObject</a>;
01052 
01053     <span class="comment">//</span>
01054     <span class="comment">// Call the original worker.</span>
01055     <span class="comment">//</span>
01056 
01057     ioWorkItem-&gt;<a class="code" href="../../d5/d9/struct__IO__WORKITEM.html#o1">Routine</a>( deviceObject,
01058                          ioWorkItem-&gt;<a class="code" href="../../d5/d9/struct__IO__WORKITEM.html#o3">Context</a> );
01059 
01060     <span class="comment">//</span>
01061     <span class="comment">// Now we can dereference the device object, since its code is no longer</span>
01062     <span class="comment">// being executed for this work item.</span>
01063     <span class="comment">//</span>
01064 
01065     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( deviceObject );
01066 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="io/misc.c::IoQueueWorkItem" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IoQueueWorkItem           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d9/struct__IO__WORKITEM.html">PIO_WORKITEM</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IoWorkItem</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d5/io_8h.html#a398">PIO_WORKITEM_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WorkerRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d8/ex_8h.html#a110">WORK_QUEUE_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>QueueType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00953">953</a> of file <a class="el" href="../../d2/d9/io_2misc_8c-source.html">io/misc.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00375">ExQueueWorkItem()</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>.
<p>
<pre class="fragment"><div>00961                    :
00962 
00963     This function inserts a work item into a work queue that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> processed
00964     by a worker thread of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.  It effectively
00965     <span class="stringliteral">"wraps"</span> <a class="code" href="../../d1/d9/worker_8c.html#a30">ExQueueWorkItem</a>, ensuring that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> referenced
00966     <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> duration of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call.
00967 
00968 Arguments:
00969 
00970     IoWorkItem - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> work item to add <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> queue.
00971         This structure must have been allocated via <a class="code" href="../../d1/d0/io_2misc_8c.html#a6">IoAllocateWorkItem</a>().
00972 
00973     WorkerRoutine - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be called
00974         in system thread context.
00975 
00976     QueueType - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of work queue that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> work item
00977         should be placed in.
00978 
00979     Context - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context parameter <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback routine.
00980 
00981 Return Value:
00982 
00983     None
00984 
00985 --*/
00986 
00987 {
00988     <a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">PWORK_QUEUE_ITEM</a> exWorkItem;
00989 
00990     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( KeGetCurrentIrql() &lt;= DISPATCH_LEVEL );
00991     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IoWorkItem-&gt;Size == <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d9/struct__IO__WORKITEM.html">IO_WORKITEM</a> ));
00992 
00993     <span class="comment">//</span>
00994     <span class="comment">// Keep a reference on the device object so it doesn't go away.</span>
00995     <span class="comment">//</span>
00996 
00997     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( IoWorkItem-&gt;DeviceObject );
00998 
00999     <span class="comment">//</span>
01000     <span class="comment">// Initialize the fields in IoWorkItem</span>
01001     <span class="comment">//</span>
01002 
01003     IoWorkItem-&gt;Routine = WorkerRoutine;
01004     IoWorkItem-&gt;Context = Context;
01005 
01006     <span class="comment">//</span>
01007     <span class="comment">// Get a pointer to the ExWorkItem, queue it, and return.</span>
01008     <span class="comment">// IopProcessWorkItem() will perform the dereference.</span>
01009     <span class="comment">// </span>
01010 
01011     exWorkItem = &amp;IoWorkItem-&gt;WorkItem;
01012     <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>( exWorkItem, QueueType );
01013 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="io/misc.c::NtCancelIoFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtCancelIoFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatusBlock</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00049">49</a> of file <a class="el" href="../../d2/d9/io_2misc_8c-source.html">io/misc.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02149">IoCancelIrp()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00044">IoFileObjectType</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12345">IopUpdateOtherOperationCount()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00414">_ETHREAD::IrpList</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01498">ProbeForWriteIoStatus</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
<pre class="fragment"><div>00056                    :
00057 
00058     This service causes all pending I/O operations <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to be
00059     marked as canceled.  Most types of operations can be canceled immediately,
00060     <span class="keywordflow">while</span> others may <span class="keywordflow">continue</span> toward completion before they are actually
00061     canceled and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> notified.
00062 
00063     Only those pending operations that were issued by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread <span class="keyword">using</span>
00064     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified handle are canceled.  Any operations issued <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> by
00065     any other thread or any other process continues normally.
00066 
00067 Arguments:
00068 
00069     FileHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> whose operations are to be
00070         canceled.
00071 
00072     IoStatusBlock - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's I/O status block.
00073 
00074 Return Value:
00075 
00076     The status returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> completion status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
00077 
00078 --*/
00079 
00080 {
00081     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00082     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00083     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> fileObject;
00084     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> requestorMode;
00085     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> thread;
00086     BOOLEAN found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00087     PLIST_ENTRY header;
00088     PLIST_ENTRY entry;
00089     KIRQL irql;
00090 
00091     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00092 
00093     <span class="comment">//</span>
00094     <span class="comment">// Get the previous mode;  i.e., the mode of the caller.</span>
00095     <span class="comment">//</span>
00096 
00097     requestorMode = KeGetPreviousMode();
00098 
00099     <span class="keywordflow">if</span> (requestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00100 
00101         <span class="comment">//</span>
00102         <span class="comment">// The caller's access mode is user, so probe each of the arguments</span>
00103         <span class="comment">// and capture them as necessary.  If any failures occur, the condition</span>
00104         <span class="comment">// handler will be invoked to handle them.  It will simply cleanup and</span>
00105         <span class="comment">// return an access violation status code back to the system service</span>
00106         <span class="comment">// dispatcher.</span>
00107         <span class="comment">//</span>
00108 
00109         <span class="keywordflow">try</span> {
00110 
00111             <span class="comment">//</span>
00112             <span class="comment">// The IoStatusBlock parameter must be writeable by the caller.</span>
00113             <span class="comment">//</span>
00114 
00115             <a class="code" href="../../d5/d8/ex_8h.html#a31">ProbeForWriteIoStatus</a>( IoStatusBlock );
00116 
00117         } except(EXCEPTION_EXECUTE_HANDLER) {
00118 
00119             <span class="comment">//</span>
00120             <span class="comment">// An exception was incurred attempting to probe the caller'</span>
00121             <span class="comment">// I/O status block.  Simply return an appropriate error status</span>
00122             <span class="comment">// code.</span>
00123             <span class="comment">//</span>
00124 
00125             <span class="keywordflow">return</span> GetExceptionCode();
00126         }
00127     }
00128 
00129     <span class="comment">//</span>
00130     <span class="comment">// There were no blatant errors so far, so reference the file object so</span>
00131     <span class="comment">// the target device object can be found.  Note that if the handle does</span>
00132     <span class="comment">// not refer to a file object, or if the caller does not have the required</span>
00133     <span class="comment">// access to the file, then it will fail.</span>
00134     <span class="comment">//</span>
00135 
00136     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( FileHandle,
00137                                         0,
00138                                         IoFileObjectType,
00139                                         requestorMode,
00140                                         (PVOID *) &amp;fileObject,
00141                                         NULL );
00142     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00143         <span class="keywordflow">return</span>(status);
00144     }
00145 
00146     <span class="comment">//</span>
00147     <span class="comment">// Note that here the I/O system would normally make a check to determine</span>
00148     <span class="comment">// whether or not the file was opened for synchronous I/O.  If it was, then</span>
00149     <span class="comment">// it would attempt to exclusively acquire the file object lock.  However,</span>
00150     <span class="comment">// since this service is attempting to cancel all of the I/O for the file,</span>
00151     <span class="comment">// it does not make much sense to wait until it has all completed before</span>
00152     <span class="comment">// attempting to cancel it.</span>
00153     <span class="comment">//</span>
00154 
00155     <span class="comment">//</span>
00156     <span class="comment">// Get the address of the current thread.  The thread contains a list of</span>
00157     <span class="comment">// the pending operations for this file.</span>
00158     <span class="comment">//</span>
00159 
00160     thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00161 
00162     <span class="comment">//</span>
00163     <span class="comment">// Update the operation count statistic for the current process for</span>
00164     <span class="comment">// operations other than read and write.</span>
00165     <span class="comment">//</span>
00166 
00167     <a class="code" href="../../d4/d6/iosubs_8c.html#a129">IopUpdateOtherOperationCount</a>();
00168 
00169     <span class="comment">//</span>
00170     <span class="comment">// Walk the list of IRPs on the thread's pending I/O queue looking for IRPs</span>
00171     <span class="comment">// which specify the same file as the FileHandle refers to.  For each IRP</span>
00172     <span class="comment">// found, set its cancel flag.  If no IRPs are found, simply complete the</span>
00173     <span class="comment">// I/O here.  The only synchronization needed here is to block out all APCs</span>
00174     <span class="comment">// for this thread so that no I/O can complete and remove packets from the</span>
00175     <span class="comment">// queue.  No considerations need be made for multi-processing since this</span>
00176     <span class="comment">// thread can only be running on one processor at a time and this routine</span>
00177     <span class="comment">// has control of the thread for now.</span>
00178     <span class="comment">//</span>
00179 
00180     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>( APC_LEVEL, &amp;irql );
00181 
00182     header = &amp;thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o18">IrpList</a>;
00183     entry = thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o18">IrpList</a>.Flink;
00184 
00185     <span class="keywordflow">while</span> (header != entry) {
00186 
00187         <span class="comment">//</span>
00188         <span class="comment">// An IRP has been found for this thread.  If the IRP refers to the</span>
00189         <span class="comment">// appropriate file object, set its cancel flag and remember that it</span>
00190         <span class="comment">// was found;  otherwise, simply continue the loop.</span>
00191         <span class="comment">//</span>
00192 
00193         irp = CONTAINING_RECORD( entry, <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>, ThreadListEntry );
00194         <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject == fileObject) {
00195             found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00196             <a class="code" href="../../d4/d6/iosubs_8c.html#a30">IoCancelIrp</a>( irp );
00197         }
00198 
00199         entry = entry-&gt;Flink;
00200     }
00201 
00202     <span class="comment">//</span>
00203     <span class="comment">// Lower the IRQL back down to what it was on entry to this procedure.</span>
00204     <span class="comment">//</span>
00205 
00206     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>( irql );
00207 
00208     <span class="keywordflow">if</span> (found) {
00209 
00210         LARGE_INTEGER interval;
00211 
00212         <span class="comment">//</span>
00213         <span class="comment">// Delay execution for a time and let the request</span>
00214         <span class="comment">// finish.  The delay time is 10ms.</span>
00215         <span class="comment">//</span>
00216 
00217         interval.QuadPart = -10 * 1000 * 10;
00218 
00219         <span class="comment">//</span>
00220         <span class="comment">// Wait for a while so the canceled requests can complete.</span>
00221         <span class="comment">//</span>
00222 
00223         <span class="keywordflow">while</span> (found) {
00224 
00225             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a>( KernelMode, FALSE, &amp;interval );
00226 
00227             found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00228 
00229             <span class="comment">//</span>
00230             <span class="comment">// Raise the IRQL to prevent modification to the IRP list by the</span>
00231             <span class="comment">// thread's APC routine.</span>
00232             <span class="comment">//</span>
00233 
00234             <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>( APC_LEVEL, &amp;irql );
00235 
00236             <span class="comment">//</span>
00237             <span class="comment">// Check the IRP list for requests which refer to the specified</span>
00238             <span class="comment">// file object.</span>
00239             <span class="comment">//</span>
00240 
00241             entry = thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o18">IrpList</a>.Flink;
00242 
00243             <span class="keywordflow">while</span> (header != entry) {
00244 
00245                 <span class="comment">//</span>
00246                 <span class="comment">// An IRP has been found for this thread.  If the IRP refers</span>
00247                 <span class="comment">// to the appropriate file object,  remember that it</span>
00248                 <span class="comment">// was found;  otherwise, simply continue the loop.</span>
00249                 <span class="comment">//</span>
00250 
00251                 irp = CONTAINING_RECORD( entry, <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>, ThreadListEntry );
00252                 <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject == fileObject) {
00253                     found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00254                     <span class="keywordflow">break</span>;
00255                 }
00256 
00257                 entry = entry-&gt;Flink;
00258             }
00259 
00260             <span class="comment">//</span>
00261             <span class="comment">// Lower the IRQL back down to what it was on entry to this procedure.</span>
00262             <span class="comment">//</span>
00263 
00264             <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>( irql );
00265 
00266         }
00267     }
00268 
00269     <span class="keywordflow">try</span> {
00270 
00271         <span class="comment">//</span>
00272         <span class="comment">// Write the status back to the user.</span>
00273         <span class="comment">//</span>
00274 
00275         IoStatusBlock-&gt;Status = STATUS_SUCCESS;
00276         IoStatusBlock-&gt;Information = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00277 
00278     } except(EXCEPTION_EXECUTE_HANDLER) {
00279 
00280         <span class="comment">//</span>
00281         <span class="comment">// An exception was incurred attempting to write the caller's</span>
00282         <span class="comment">// I/O status block; however, the service completed sucessfully so</span>
00283         <span class="comment">// just return sucess.</span>
00284         <span class="comment">//</span>
00285 
00286     }
00287 
00288     <span class="comment">//</span>
00289     <span class="comment">// Dereference the file object.</span>
00290     <span class="comment">//</span>
00291 
00292     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
00293 
00294     <span class="keywordflow">return</span> STATUS_SUCCESS;
00295 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="io/misc.c::NtDeleteFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtDeleteFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ObjectAttributes</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00298">298</a> of file <a class="el" href="../../d2/d9/io_2misc_8c-source.html">io/misc.c</a>.
<p>
References <a class="el" href="../../d1/d5/iop_8h-source.html#l00222">_OPEN_PACKET::CreateOptions</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00283">_OPEN_PACKET::DeleteOnly</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00228">_OPEN_PACKET::Disposition</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00209">_OPEN_PACKET::FinalStatus</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00042">IO_TYPE_OPEN_PACKET</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12345">IopUpdateOtherOperationCount()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00300">_OPEN_PACKET::LocalFileObject</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00095">ObOpenObjectByName()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a55">OPEN_PACKET</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00196">OPEN_PACKET_PATTERN</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00211">_OPEN_PACKET::ParseCheck</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00224">_OPEN_PACKET::ShareAccess</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00207">_OPEN_PACKET::Size</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00206">_OPEN_PACKET::Type</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00655">ZwDeleteFile()</a>.
<p>
<pre class="fragment"><div>00304                    :
00305 
00306     This service deletes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00307 
00308 Arguments:
00309 
00310     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> attributes to be used <span class="keywordflow">for</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object (name,
00311         SECURITY_DESCRIPTOR, etc.)
00312 
00313 Return Value:
00314 
00315     The status returned is the <span class="keyword">final</span> completion status of the operation.
00316 
00317 --*/
00318 
00319 {
00320     KPROCESSOR_MODE requestorMode;
00321     NTSTATUS status;
00322     <a class="code" href="../../d3/d7/struct__OPEN__PACKET.html">OPEN_PACKET</a> openPacket;
00323     <a class="code" href="../../d0/d1/struct__DUMMY__FILE__OBJECT.html">DUMMY_FILE_OBJECT</a> localFileObject;
00324     HANDLE handle;
00325 
00326     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00327 
00328     <span class="comment">//</span>
00329     <span class="comment">// Get the previous mode;  i.e., the mode of the caller.</span>
00330     <span class="comment">//</span>
00331 
00332     requestorMode = KeGetPreviousMode();
00333 
00334     <span class="comment">//</span>
00335     <span class="comment">// Build a parse open packet that tells the parse method to open the file</span>
00336     <span class="comment">// for open for delete access w/the delete bit set, and then close it.</span>
00337     <span class="comment">//</span>
00338 
00339     RtlZeroMemory( &amp;openPacket, <span class="keyword">sizeof</span>( <a class="code" href="../../d3/d7/struct__OPEN__PACKET.html">OPEN_PACKET</a> ) );
00340 
00341     openPacket.Type = IO_TYPE_OPEN_PACKET;
00342     openPacket.Size = <span class="keyword">sizeof</span>( OPEN_PACKET );
00343     openPacket.CreateOptions = FILE_DELETE_ON_CLOSE;
00344     openPacket.ShareAccess = (USHORT) FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE;
00345     openPacket.Disposition = FILE_OPEN;
00346     openPacket.DeleteOnly = TRUE;
00347     openPacket.LocalFileObject = &amp;localFileObject;
00348 
00349     <span class="comment">//</span>
00350     <span class="comment">// Update the open count for this process.</span>
00351     <span class="comment">//</span>
00352 
00353     <a class="code" href="../../d0/d6/iop_8h.html#a229">IopUpdateOtherOperationCount</a>();
00354 
00355     <span class="comment">//</span>
00356     <span class="comment">// Open the object by its name.  Because of the special DeleteOnly flag</span>
00357     <span class="comment">// set in the open packet, the parse routine will open the file, and</span>
00358     <span class="comment">// then realize that it is only deleting the file, and will therefore</span>
00359     <span class="comment">// immediately dereference the file.  This will cause the cleanup and</span>
00360     <span class="comment">// the close to be sent to the file system, thus causing the file to</span>
00361     <span class="comment">// be deleted.</span>
00362     <span class="comment">//</span>
00363 
00364     status = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>( ObjectAttributes,
00365                                  (<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>) NULL,
00366                                  requestorMode,
00367                                  NULL,
00368                                  DELETE,
00369                                  &amp;openPacket,
00370                                  &amp;handle );
00371 
00372     <span class="comment">//</span>
00373     <span class="comment">// The operation is successful if the parse check field of the open packet</span>
00374     <span class="comment">// indicates that the parse routine was actually invoked, and the final</span>
00375     <span class="comment">// status field of the packet is set to success.</span>
00376     <span class="comment">//</span>
00377 
00378     <span class="keywordflow">if</span> (openPacket.ParseCheck != OPEN_PACKET_PATTERN) {
00379         <span class="keywordflow">return</span> status;
00380     } <span class="keywordflow">else</span> {
00381         <span class="keywordflow">return</span> openPacket.FinalStatus;
00382     }
00383 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="io/misc.c::NtFlushBuffersFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtFlushBuffersFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatusBlock</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00386">386</a> of file <a class="el" href="../../d2/d9/io_2misc_8c-source.html">io/misc.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01492">FO_ALERTABLE_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01497">FO_NAMED_PIPE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01491">FO_SYNCHRONOUS_IO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00057">_OBJECT_HANDLE_INFORMATION::GrantedAccess</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00652">IoAllocateIrp()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00044">IoFileObjectType</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00595">IopAcquireFastLock</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00181">IopAcquireFileObjectLock()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00284">IopAllocateIrpCleanup()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06926">IopSynchronousApiServiceTail()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l07030">IopSynchronousServiceTail()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00064">IRP_MJ_FLUSH_BUFFERS</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01552">IRP_SYNCHRONOUS_API</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a240a140">OtherTransfer</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o24">_IRP::Overlay</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01498">ProbeForWriteIoStatus</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01641">_IRP::RequestorMode</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00515">SeComputeGrantedAccesses</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01189">_DEVICE_OBJECT::StackSize</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l01520">SepServerDisconnectPipe()</a>.
<p>
<pre class="fragment"><div>00393                    :
00394 
00395     This service causes all buffered data to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to be written.
00396 
00397 Arguments:
00398 
00399     FileHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> whose buffers should be flushed.
00400 
00401     IoStatusBlock - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's I/O status block.
00402 
00403 Return Value:
00404 
00405     The status returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> completion status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
00406 
00407 --*/
00408 
00409 {
00410     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00411     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00412     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> fileObject;
00413     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00414     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> event;
00415     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> requestorMode;
00416     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00417     IO_STATUS_BLOCK localIoStatus;
00418     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a> objectHandleInformation;
00419     BOOLEAN synchronousIo;
00420 
00421     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00422 
00423     <span class="comment">//</span>
00424     <span class="comment">// Get the previous mode;  i.e., the mode of the caller.</span>
00425     <span class="comment">//</span>
00426 
00427     requestorMode = KeGetPreviousMode();
00428 
00429     <span class="keywordflow">if</span> (requestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00430 
00431         <span class="comment">//</span>
00432         <span class="comment">// The caller's access mode is not kernel so probe each of the arguments</span>
00433         <span class="comment">// and capture them as necessary.  If any failures occur, the condition</span>
00434         <span class="comment">// handler will be invoked to handle them.  It will simply cleanup and</span>
00435         <span class="comment">// return an access violation status code back to the system service</span>
00436         <span class="comment">// dispatcher.</span>
00437         <span class="comment">//</span>
00438 
00439         <span class="keywordflow">try</span> {
00440 
00441             <span class="comment">//</span>
00442             <span class="comment">// The IoStatusBlock parameter must be writeable by the caller.</span>
00443             <span class="comment">//</span>
00444 
00445             <a class="code" href="../../d5/d8/ex_8h.html#a31">ProbeForWriteIoStatus</a>( IoStatusBlock );
00446 
00447         } except(EXCEPTION_EXECUTE_HANDLER) {
00448 
00449             <span class="comment">//</span>
00450             <span class="comment">// An exception was incurred attempting to probe the caller's</span>
00451             <span class="comment">// I/O status block.  Simply return an appropriate error status</span>
00452             <span class="comment">// code.</span>
00453             <span class="comment">//</span>
00454 
00455             <span class="keywordflow">return</span> GetExceptionCode();
00456 
00457         }
00458     }
00459 
00460     <span class="comment">//</span>
00461     <span class="comment">// There were no blatant errors so far, so reference the file object so</span>
00462     <span class="comment">// the target device object can be found.  Note that if the handle does</span>
00463     <span class="comment">// not refer to a file object, or if the caller does not have the required</span>
00464     <span class="comment">// access to the file, then it will fail.</span>
00465     <span class="comment">//</span>
00466 
00467     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( FileHandle,
00468                                         0,
00469                                         IoFileObjectType,
00470                                         requestorMode,
00471                                         (PVOID *) &amp;fileObject,
00472                                         &amp;objectHandleInformation );
00473     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00474         <span class="keywordflow">return</span> status;
00475     }
00476 
00477     <span class="comment">//</span>
00478     <span class="comment">// Ensure that the caller has either WRITE or APPEND access to the file</span>
00479     <span class="comment">// before allowing this call to continue.  This is especially important</span>
00480     <span class="comment">// if the caller opened a volume, where a flush operation may flush more</span>
00481     <span class="comment">// than what this opener has written to buffers.  Note however that if</span>
00482     <span class="comment">// this is a pipe, then the APPEND access cannot be made since this</span>
00483     <span class="comment">// access code is overlaid with the CREATE_PIPE_INSTANCE access.</span>
00484     <span class="comment">//</span>
00485 
00486     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/se_8h.html#a9">SeComputeGrantedAccesses</a>( objectHandleInformation.<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o1">GrantedAccess</a>,
00487                                   (!(fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; FO_NAMED_PIPE) ?
00488                                   FILE_APPEND_DATA : 0) |
00489                                   FILE_WRITE_DATA ) == 0) {
00490         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
00491         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00492     }
00493 
00494     <span class="comment">//</span>
00495     <span class="comment">// Make a special check here to determine whether this is a synchronous</span>
00496     <span class="comment">// I/O operation.  If it is, then wait here until the file is owned by</span>
00497     <span class="comment">// the current thread.  If this is not a (serialized) synchronous I/O</span>
00498     <span class="comment">// operation, then allocate and initialize the local event.</span>
00499     <span class="comment">//</span>
00500 
00501     <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) {
00502 
00503         BOOLEAN interrupted;
00504 
00505         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a13">IopAcquireFastLock</a>( fileObject )) {
00506             status = <a class="code" href="../../d0/d6/iop_8h.html#a147">IopAcquireFileObjectLock</a>( fileObject,
00507                                                requestorMode,
00508                                                (BOOLEAN) ((fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; FO_ALERTABLE_IO) != 0),
00509                                                &amp;interrupted );
00510             <span class="keywordflow">if</span> (interrupted) {
00511                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
00512                 <span class="keywordflow">return</span> status;
00513             }
00514         }
00515         synchronousIo = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00516     } <span class="keywordflow">else</span> {
00517 
00518         <span class="comment">//</span>
00519         <span class="comment">// This is a synchronous API being invoked for a file that is opened</span>
00520         <span class="comment">// for asynchronous I/O.  This means that this system service is</span>
00521         <span class="comment">// to synchronize the completion of the operation before returning</span>
00522         <span class="comment">// to the caller.  A local event is used to do this.</span>
00523         <span class="comment">//</span>
00524 
00525         event = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPool, <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> ) );
00526         <span class="keywordflow">if</span> (event == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00527             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
00528             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00529         }
00530         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( event, SynchronizationEvent, FALSE );
00531         synchronousIo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00532     }
00533 
00534     <span class="comment">//</span>
00535     <span class="comment">// Set the file object to the Not-Signaled state.</span>
00536     <span class="comment">//</span>
00537 
00538     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a> );
00539 
00540     <span class="comment">//</span>
00541     <span class="comment">// Get the address of the target device object.</span>
00542     <span class="comment">//</span>
00543 
00544     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( fileObject );
00545 
00546     <span class="comment">//</span>
00547     <span class="comment">// Allocate and initialize the I/O Request Packet (IRP) for this operation.</span>
00548     <span class="comment">// The allocation is performed with an exception handler in case the</span>
00549     <span class="comment">// caller does not have enough quota to allocate the packet.</span>
00550 
00551     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>( deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a>, TRUE );
00552     <span class="keywordflow">if</span> (!irp) {
00553 
00554         <span class="comment">//</span>
00555         <span class="comment">// An exception was incurred while attempting to allocate the IRP.</span>
00556         <span class="comment">// Cleanup and return an appropriate error status code.</span>
00557         <span class="comment">//</span>
00558 
00559         <span class="keywordflow">if</span> (!(fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>)) {
00560             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( event );
00561         }
00562 
00563         <a class="code" href="../../d0/d6/iop_8h.html#a148">IopAllocateIrpCleanup</a>( fileObject, (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) NULL );
00564 
00565         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00566     }
00567     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = fileObject;
00568     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00569     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> = requestorMode;
00570 
00571     <span class="comment">//</span>
00572     <span class="comment">// Fill in the service independent parameters in the IRP.</span>
00573     <span class="comment">//</span>
00574 
00575     <span class="keywordflow">if</span> (synchronousIo) {
00576         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00577         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = IoStatusBlock;
00578     } <span class="keywordflow">else</span> {
00579         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = event;
00580         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = &amp;localIoStatus;
00581         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>;
00582     }
00583     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine = (PIO_APC_ROUTINE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00584 
00585     <span class="comment">//</span>
00586     <span class="comment">// Get a pointer to the stack location for the first driver.  This is used</span>
00587     <span class="comment">// to pass the original function codes and parameters.</span>
00588     <span class="comment">//</span>
00589 
00590     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
00591     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a22">IRP_MJ_FLUSH_BUFFERS</a>;
00592     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = fileObject;
00593 
00594     <span class="comment">//</span>
00595     <span class="comment">// Queue the packet, call the driver, and synchronize appopriately with</span>
00596     <span class="comment">// I/O completion.</span>
00597     <span class="comment">//</span>
00598 
00599     status = <a class="code" href="../../d0/d6/iop_8h.html#a212">IopSynchronousServiceTail</a>( deviceObject,
00600                                         irp,
00601                                         fileObject,
00602                                         FALSE,
00603                                         requestorMode,
00604                                         synchronousIo,
00605                                         OtherTransfer );
00606 
00607     <span class="comment">//</span>
00608     <span class="comment">// If the file for this operation was not opened for synchronous I/O, then</span>
00609     <span class="comment">// synchronization of completion of the I/O operation has not yet occurred</span>
00610     <span class="comment">// since the allocated event must be used for synchronous APIs on files</span>
00611     <span class="comment">// opened for asynchronous I/O.  Synchronize the completion of the I/O</span>
00612     <span class="comment">// operation now.</span>
00613     <span class="comment">//</span>
00614 
00615     <span class="keywordflow">if</span> (!synchronousIo) {
00616 
00617         status = <a class="code" href="../../d0/d6/iop_8h.html#a211">IopSynchronousApiServiceTail</a>( status,
00618                                                event,
00619                                                irp,
00620                                                requestorMode,
00621                                                &amp;localIoStatus,
00622                                                IoStatusBlock );
00623     }
00624 
00625     <span class="keywordflow">return</span> status;
00626 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="io/misc.c::NtQueryAttributesFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtQueryAttributesFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectAttributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PFILE_BASIC_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>FileInformation</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00629">629</a> of file <a class="el" href="../../d2/d9/io_2misc_8c-source.html">io/misc.c</a>.
<p>
References <a class="el" href="../../d1/d5/iop_8h-source.html#l00235">_OPEN_PACKET::BasicInformation</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00222">_OPEN_PACKET::CreateOptions</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00228">_OPEN_PACKET::Disposition</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00209">_OPEN_PACKET::FinalStatus</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00042">IO_TYPE_OPEN_PACKET</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12345">IopUpdateOtherOperationCount()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00300">_OPEN_PACKET::LocalFileObject</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00242">_OPEN_PACKET::NetworkInformation</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00095">ObOpenObjectByName()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a55">OPEN_PACKET</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00196">OPEN_PACKET_PATTERN</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00211">_OPEN_PACKET::ParseCheck</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00275">_OPEN_PACKET::QueryOnly</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00224">_OPEN_PACKET::ShareAccess</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00207">_OPEN_PACKET::Size</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00206">_OPEN_PACKET::Type</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01423">FileExists()</a>, <a class="el" href="../../d6/d0/curdir_8c-source.html#l02033">RtlDoesFileExists_UEx()</a>, and <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00729">ZwQueryAttributesFile()</a>.
<p>
<pre class="fragment"><div>00636                    :
00637 
00638     This service queries <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> basic attributes information <span class="keywordflow">for</span> a specified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00639 
00640 Arguments:
00641 
00642     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> attributes to be used <span class="keywordflow">for</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object (name,
00643         SECURITY_DESCRIPTOR, etc.)
00644 
00645     FileInformation - Supplies an output buffer to receive the returned file
00646         attributes information.
00647 
00648 Return Value:
00649 
00650     The status returned is the <span class="keyword">final</span> completion status of the operation.
00651 
00652 --*/
00653 
00654 {
00655     KPROCESSOR_MODE requestorMode;
00656     NTSTATUS status;
00657     <a class="code" href="../../d3/d7/struct__OPEN__PACKET.html">OPEN_PACKET</a> openPacket;
00658     <a class="code" href="../../d0/d1/struct__DUMMY__FILE__OBJECT.html">DUMMY_FILE_OBJECT</a> localFileObject;
00659     FILE_NETWORK_OPEN_INFORMATION networkInformation;
00660     HANDLE handle;
00661 
00662     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00663 
00664     <span class="comment">//</span>
00665     <span class="comment">// Get the previous mode;  i.e., the mode of the caller.</span>
00666     <span class="comment">//</span>
00667 
00668     requestorMode = KeGetPreviousMode();
00669 
00670     <span class="keywordflow">if</span> (requestorMode != KernelMode) {
00671 
00672         <span class="keywordflow">try</span> {
00673 
00674             <span class="comment">//</span>
00675             <span class="comment">// The caller's mode is not kernel, so probe the output buffer.</span>
00676             <span class="comment">//</span>
00677 
00678             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( FileInformation,
00679                            <span class="keyword">sizeof</span>( FILE_BASIC_INFORMATION ),
00680                            <span class="keyword">sizeof</span>( ULONG ));
00681 
00682         } except(EXCEPTION_EXECUTE_HANDLER) {
00683 
00684             <span class="comment">//</span>
00685             <span class="comment">// An exception was incurred while probing the caller's parameters.</span>
00686             <span class="comment">// Simply return an appropriate error status code.</span>
00687             <span class="comment">//</span>
00688 
00689             <span class="keywordflow">return</span> GetExceptionCode();
00690         }
00691     }
00692 
00693     <span class="comment">//</span>
00694     <span class="comment">// Build a parse open packet that tells the parse method to open the file,</span>
00695     <span class="comment">// query the file's basic attributes, and close the file.</span>
00696     <span class="comment">//</span>
00697 
00698     RtlZeroMemory( &amp;openPacket, <span class="keyword">sizeof</span>( <a class="code" href="../../d3/d7/struct__OPEN__PACKET.html">OPEN_PACKET</a> ) );
00699 
00700     openPacket.Type = IO_TYPE_OPEN_PACKET;
00701     openPacket.Size = <span class="keyword">sizeof</span>( OPEN_PACKET );
00702     openPacket.ShareAccess = (USHORT) FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE;
00703     openPacket.Disposition = FILE_OPEN;
00704     openPacket.CreateOptions = FILE_OPEN_REPARSE_POINT;
00705     openPacket.BasicInformation = FileInformation;
00706     openPacket.NetworkInformation = &amp;networkInformation;
00707     openPacket.QueryOnly = TRUE;
00708     openPacket.LocalFileObject = &amp;localFileObject;
00709 
00710     <span class="comment">//</span>
00711     <span class="comment">// Update the open count for this process.</span>
00712     <span class="comment">//</span>
00713 
00714     <a class="code" href="../../d0/d6/iop_8h.html#a229">IopUpdateOtherOperationCount</a>();
00715 
00716     <span class="comment">//</span>
00717     <span class="comment">// Open the object by its name.  Because of the special QueryOnly flag set</span>
00718     <span class="comment">// in the open packet, the parse routine will open the file, and then</span>
00719     <span class="comment">// realize that it is only performing a query.  It will therefore perform</span>
00720     <span class="comment">// the query, and immediately close the file.</span>
00721     <span class="comment">//</span>
00722 
00723     status = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>( ObjectAttributes,
00724                                  (<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>) NULL,
00725                                  requestorMode,
00726                                  NULL,
00727                                  FILE_READ_ATTRIBUTES,
00728                                  &amp;openPacket,
00729                                  &amp;handle );
00730 
00731     <span class="comment">//</span>
00732     <span class="comment">// The operation is successful if the parse check field of the open packet</span>
00733     <span class="comment">// indicates that the parse routine was actually invoked, and the final</span>
00734     <span class="comment">// status field of the packet is set to success.</span>
00735     <span class="comment">//</span>
00736 
00737     <span class="keywordflow">if</span> (openPacket.ParseCheck != OPEN_PACKET_PATTERN) {
00738         <span class="keywordflow">return</span> status;
00739     } <span class="keywordflow">else</span> {
00740         <span class="keywordflow">return</span> openPacket.FinalStatus;
00741     }
00742 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="io/misc.c::NtQueryFullAttributesFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtQueryFullAttributesFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectAttributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PFILE_NETWORK_OPEN_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>FileInformation</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00745">745</a> of file <a class="el" href="../../d2/d9/io_2misc_8c-source.html">io/misc.c</a>.
<p>
References <a class="el" href="../../d4/d2/i386_8c-source.html#l00018">_X86_</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00222">_OPEN_PACKET::CreateOptions</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00228">_OPEN_PACKET::Disposition</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00209">_OPEN_PACKET::FinalStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00291">_OPEN_PACKET::FullAttributes</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00042">IO_TYPE_OPEN_PACKET</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12345">IopUpdateOtherOperationCount()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00300">_OPEN_PACKET::LocalFileObject</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00242">_OPEN_PACKET::NetworkInformation</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00095">ObOpenObjectByName()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a55">OPEN_PACKET</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00196">OPEN_PACKET_PATTERN</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00211">_OPEN_PACKET::ParseCheck</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00275">_OPEN_PACKET::QueryOnly</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00224">_OPEN_PACKET::ShareAccess</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00207">_OPEN_PACKET::Size</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00206">_OPEN_PACKET::Type</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>00752                    :
00753 
00754     This service queries <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> network attributes information <span class="keywordflow">for</span> a specified
00755     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00756 
00757 Arguments:
00758 
00759     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> attributes to be used <span class="keywordflow">for</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object (name,
00760         SECURITY_DESCRIPTOR, etc.)
00761 
00762     FileInformation - Supplies an output buffer to receive the returned file
00763         attributes information.
00764 
00765 Return Value:
00766 
00767     The status returned is the <span class="keyword">final</span> completion status of the operation.
00768 
00769 --*/
00770 
00771 {
00772     KPROCESSOR_MODE requestorMode;
00773     NTSTATUS status;
00774     <a class="code" href="../../d3/d7/struct__OPEN__PACKET.html">OPEN_PACKET</a> openPacket;
00775     <a class="code" href="../../d0/d1/struct__DUMMY__FILE__OBJECT.html">DUMMY_FILE_OBJECT</a> localFileObject;
00776     FILE_NETWORK_OPEN_INFORMATION networkInformation;
00777     HANDLE handle;
00778 
00779     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00780 
00781     <span class="comment">//</span>
00782     <span class="comment">// Get the previous mode;  i.e., the mode of the caller.</span>
00783     <span class="comment">//</span>
00784 
00785     requestorMode = KeGetPreviousMode();
00786 
00787     <span class="keywordflow">if</span> (requestorMode != KernelMode) {
00788 
00789         <span class="keywordflow">try</span> {
00790 
00791             <span class="comment">//</span>
00792             <span class="comment">// The caller's mode is not kernel, so probe the output buffer.</span>
00793             <span class="comment">//</span>
00794 
00795             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( FileInformation,
00796                            <span class="keyword">sizeof</span>( FILE_NETWORK_OPEN_INFORMATION ),
00797 #<span class="keywordflow">if</span> defined(_X86_)
00798                            <span class="keyword">sizeof</span>( LONG ));
00799 #<span class="keywordflow">else</span>
00800                            <span class="keyword">sizeof</span>( LONGLONG ));
00801 <span class="preprocessor">#endif // defined(_X86_)</span>
00802 <span class="preprocessor"></span>
00803         } except(EXCEPTION_EXECUTE_HANDLER) {
00804 
00805             <span class="comment">//</span>
00806             <span class="comment">// An exception was incurred while probing the caller's parameters.</span>
00807             <span class="comment">// Simply return an appropriate error status code.</span>
00808             <span class="comment">//</span>
00809 
00810             <span class="keywordflow">return</span> GetExceptionCode();
00811         }
00812     }
00813 
00814     <span class="comment">//</span>
00815     <span class="comment">// Build a parse open packet that tells the parse method to open the file,</span>
00816     <span class="comment">// query the file's full attributes, and close the file.</span>
00817     <span class="comment">//</span>
00818 
00819     RtlZeroMemory( &amp;openPacket, <span class="keyword">sizeof</span>( <a class="code" href="../../d3/d7/struct__OPEN__PACKET.html">OPEN_PACKET</a> ) );
00820 
00821     openPacket.Type = <a class="code" href="../../d0/d5/io_8h.html#a7">IO_TYPE_OPEN_PACKET</a>;
00822     openPacket.Size = <span class="keyword">sizeof</span>( <a class="code" href="../../d3/d7/struct__OPEN__PACKET.html">OPEN_PACKET</a> );
00823     openPacket.ShareAccess = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE;
00824     openPacket.Disposition = FILE_OPEN;
00825     openPacket.CreateOptions = FILE_OPEN_REPARSE_POINT;
00826     openPacket.QueryOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00827     openPacket.FullAttributes = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00828     openPacket.LocalFileObject = &amp;localFileObject;
00829     <span class="keywordflow">if</span> (requestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00830         openPacket.NetworkInformation = &amp;networkInformation;
00831     } <span class="keywordflow">else</span> {
00832         openPacket.NetworkInformation = FileInformation;
00833     }
00834 
00835     <span class="comment">//</span>
00836     <span class="comment">// Update the open count for this process.</span>
00837     <span class="comment">//</span>
00838 
00839     <a class="code" href="../../d4/d6/iosubs_8c.html#a129">IopUpdateOtherOperationCount</a>();
00840 
00841     <span class="comment">//</span>
00842     <span class="comment">// Open the object by its name.  Because of the special QueryOnly flag set</span>
00843     <span class="comment">// in the open packet, the parse routine will open the file, and then</span>
00844     <span class="comment">// realize that it is only performing a query.  It will therefore perform</span>
00845     <span class="comment">// the query, and immediately close the file.</span>
00846     <span class="comment">//</span>
00847 
00848     status = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>( ObjectAttributes,
00849                                  (<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>) NULL,
00850                                  requestorMode,
00851                                  NULL,
00852                                  FILE_READ_ATTRIBUTES,
00853                                  &amp;openPacket,
00854                                  &amp;handle );
00855 
00856     <span class="comment">//</span>
00857     <span class="comment">// The operation is successful if the parse check field of the open packet</span>
00858     <span class="comment">// indicates that the parse routine was actually invoked, and the final</span>
00859     <span class="comment">// status field of the packet is set to success.</span>
00860     <span class="comment">//</span>
00861 
00862     <span class="keywordflow">if</span> (openPacket.ParseCheck != <a class="code" href="../../d0/d6/iop_8h.html#a3">OPEN_PACKET_PATTERN</a>) {
00863         <span class="keywordflow">return</span> status;
00864     } <span class="keywordflow">else</span> {
00865         status = openPacket.FinalStatus;
00866     }
00867 
00868     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00869         <span class="keywordflow">if</span> (requestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00870             <span class="keywordflow">try</span> {
00871 
00872                 <span class="comment">//</span>
00873                 <span class="comment">// The query worked, so copy the returned information to the</span>
00874                 <span class="comment">// caller's output buffer.</span>
00875                 <span class="comment">//</span>
00876 
00877                 RtlMoveMemory( FileInformation,
00878                                &amp;networkInformation,
00879                                <span class="keyword">sizeof</span>( FILE_NETWORK_OPEN_INFORMATION ) );
00880 
00881             } except(EXCEPTION_EXECUTE_HANDLER) {
00882                 status = GetExceptionCode();
00883             }
00884         }
00885     }
00886 
00887     <span class="keywordflow">return</span> status;
00888 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:43 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
