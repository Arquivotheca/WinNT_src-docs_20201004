<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: psinit.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>psinit.c</h1><a href="../../d0/d1/psinit_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    psinit.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Process Structure Initialization.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Mark Lucovsky (markl) 20-Apr-1989</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d8/d1/psp_8h.html">psp.h</a>"</span>
00022 
<a name="l00023"></a><a class="code" href="../../d0/d1/psinit_8c.html#a0">00023</a> <span class="preprocessor">#define ROUND_UP(VALUE,ROUND) ((ULONG)(((ULONG)VALUE + \</span>
00024 <span class="preprocessor">                               ((ULONG)ROUND - 1L)) &amp; (~((ULONG)ROUND - 1L))))</span>
00025 <span class="preprocessor"></span>
<a name="l00026"></a><a class="code" href="../../d0/d1/psinit_8c.html#a2">00026</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d5/d0/wsmanage_8c.html#a5">PsMinimumWorkingSet</a>;
<a name="l00027"></a><a class="code" href="../../d0/d1/psinit_8c.html#a3">00027</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d2/d8/ps_2create_8c.html#a7">PsMaximumWorkingSet</a>;
<a name="l00028"></a><a class="code" href="../../d0/d1/psinit_8c.html#a4">00028</a> ULONG <a class="code" href="../../d1/d9/ps_8h.html#a47">PsPrioritySeperation</a>;
<a name="l00029"></a><a class="code" href="../../d0/d1/psinit_8c.html#a5">00029</a> ULONG <a class="code" href="../../d1/d9/ps_8h.html#a48">PsRawPrioritySeparation</a>;
00030 
00031 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00032 <a class="code" href="../../d0/d1/psinit_8c.html#a39">MmCheckSystemImage</a>(
00033     IN HANDLE ImageFileHandle
00034     );
00035 
00036 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00037 <a class="code" href="../../d0/d1/psinit_8c.html#a40">LookupEntryPoint</a> (
00038     IN PVOID DllBase,
00039     IN PSZ NameOfEntryPoint,
00040     OUT PVOID *AddressOfEntryPoint
00041     );
00042 
00043 <span class="preprocessor">#ifdef i386</span>
00044 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00045 <a class="code" href="../../d6/d9/kernlini_8c.html#a40">KeSetup80387OrEmulate</a> (
00046     IN PVOID R3EmulatorTable
00047     );
00048 <span class="preprocessor">#endif</span>
00049 <span class="preprocessor"></span>
<a name="l00050"></a><a class="code" href="../../d0/d1/psinit_8c.html#a6">00050</a> GENERIC_MAPPING <a class="code" href="../../d0/d1/psinit_8c.html#a6">PspProcessMapping</a> = {
00051     STANDARD_RIGHTS_READ |
00052         PROCESS_VM_READ | PROCESS_QUERY_INFORMATION,
00053     STANDARD_RIGHTS_WRITE |
00054         PROCESS_CREATE_PROCESS | PROCESS_CREATE_THREAD |
00055         PROCESS_VM_OPERATION | PROCESS_VM_WRITE | PROCESS_DUP_HANDLE |
00056         PROCESS_TERMINATE | PROCESS_SET_QUOTA |
00057         PROCESS_SET_INFORMATION | PROCESS_SET_PORT,
00058     STANDARD_RIGHTS_EXECUTE |
00059         SYNCHRONIZE,
00060     PROCESS_ALL_ACCESS
00061 };
00062 
<a name="l00063"></a><a class="code" href="../../d0/d1/psinit_8c.html#a7">00063</a> GENERIC_MAPPING <a class="code" href="../../d0/d1/psinit_8c.html#a7">PspThreadMapping</a> = {
00064     STANDARD_RIGHTS_READ |
00065         THREAD_GET_CONTEXT | THREAD_QUERY_INFORMATION,
00066     STANDARD_RIGHTS_WRITE |
00067         THREAD_TERMINATE | THREAD_SUSPEND_RESUME | THREAD_ALERT |
00068         THREAD_SET_INFORMATION | THREAD_SET_CONTEXT,
00069     STANDARD_RIGHTS_EXECUTE |
00070         SYNCHRONIZE,
00071     THREAD_ALL_ACCESS
00072 };
00073 
<a name="l00074"></a><a class="code" href="../../d0/d1/psinit_8c.html#a8">00074</a> GENERIC_MAPPING <a class="code" href="../../d0/d1/psinit_8c.html#a8">PspJobMapping</a> = {
00075     STANDARD_RIGHTS_READ |
00076         JOB_OBJECT_QUERY,
00077     STANDARD_RIGHTS_WRITE |
00078         JOB_OBJECT_ASSIGN_PROCESS | JOB_OBJECT_SET_ATTRIBUTES | JOB_OBJECT_TERMINATE,
00079     STANDARD_RIGHTS_EXECUTE |
00080         SYNCHRONIZE,
00081     THREAD_ALL_ACCESS
00082 };
00083 
00084 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00085 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,PsInitSystem)</span>
00086 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,PspInitPhase0)</span>
00087 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,PspInitPhase1)</span>
00088 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,PsLocateSystemDll)</span>
00089 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,PspInitializeSystemDll)</span>
00090 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,PspLookupSystemDllEntryPoint)</span>
00091 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,PspNameToOrdinal)</span>
00092 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,PspMapSystemDll)</span>
00093 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,PsChangeQuantumTable)</span>
00094 <span class="preprocessor"></span>
00095 <span class="preprocessor">#endif</span>
00096 <span class="preprocessor"></span>
00097 <span class="comment">//</span>
00098 <span class="comment">// Process Structure Global Data</span>
00099 <span class="comment">//</span>
00100 
<a name="l00101"></a><a class="code" href="../../d0/d1/psinit_8c.html#a9">00101</a> <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="code" href="../../d9/d8/ntos_8h.html#a3">PsThreadType</a>;
<a name="l00102"></a><a class="code" href="../../d0/d1/psinit_8c.html#a10">00102</a> <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>;
<a name="l00103"></a><a class="code" href="../../d0/d1/psinit_8c.html#a11">00103</a> <a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> <a class="code" href="../../d6/d8/sysinfo_8c.html#a1">PspCidTable</a>;
<a name="l00104"></a><a class="code" href="../../d0/d1/psinit_8c.html#a12">00104</a> <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> <a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>;
<a name="l00105"></a><a class="code" href="../../d0/d1/psinit_8c.html#a13">00105</a> HANDLE <a class="code" href="../../d6/d3/modwrite_8c.html#a13">PspInitialSystemProcessHandle</a>;
<a name="l00106"></a><a class="code" href="../../d0/d1/psinit_8c.html#a14">00106</a> PACCESS_TOKEN <a class="code" href="../../d0/d1/psinit_8c.html#a14">PspBootAccessToken</a>;
<a name="l00107"></a><a class="code" href="../../d0/d1/psinit_8c.html#a15">00107</a> UNICODE_STRING <a class="code" href="../../d1/d9/ps_8h.html#a50">PsNtDllPathName</a>;
<a name="l00108"></a><a class="code" href="../../d0/d1/psinit_8c.html#a16">00108</a> <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="code" href="../../d1/d9/ps_8h.html#a52">PsProcessSecurityLock</a>;
<a name="l00109"></a><a class="code" href="../../d0/d1/psinit_8c.html#a17">00109</a> PVOID <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a8">PsSystemDllDllBase</a>;
<a name="l00110"></a><a class="code" href="../../d0/d1/psinit_8c.html#a18">00110</a> ULONG <a class="code" href="../../d8/d0/cmdat3_8c.html#a41">PspDefaultPagedLimit</a>;
<a name="l00111"></a><a class="code" href="../../d0/d1/psinit_8c.html#a19">00111</a> ULONG <a class="code" href="../../d8/d0/cmdat3_8c.html#a42">PspDefaultNonPagedLimit</a>;
<a name="l00112"></a><a class="code" href="../../d0/d1/psinit_8c.html#a20">00112</a> ULONG <a class="code" href="../../d8/d0/cmdat3_8c.html#a43">PspDefaultPagefileLimit</a>;
<a name="l00113"></a><a class="code" href="../../d0/d1/psinit_8c.html#a21">00113</a> SCHAR <a class="code" href="../../d0/d1/psinit_8c.html#a21">PspForegroundQuantum</a>[3];
00114 
<a name="l00115"></a><a class="code" href="../../d0/d1/psinit_8c.html#a22">00115</a> <a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html">EPROCESS_QUOTA_BLOCK</a> <a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>;
<a name="l00116"></a><a class="code" href="../../d0/d1/psinit_8c.html#a23">00116</a> BOOLEAN <a class="code" href="../../d0/d1/psinit_8c.html#a23">PspDoingGiveBacks</a>;
<a name="l00117"></a><a class="code" href="../../d0/d1/psinit_8c.html#a24">00117</a> <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="code" href="../../d9/d8/ntos_8h.html#a4">PsJobType</a>;
<a name="l00118"></a><a class="code" href="../../d0/d1/psinit_8c.html#a25">00118</a> <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="code" href="../../d0/d1/psinit_8c.html#a25">PspJobListLock</a>;
<a name="l00119"></a><a class="code" href="../../d0/d1/psinit_8c.html#a26">00119</a> LIST_ENTRY <a class="code" href="../../d0/d1/psinit_8c.html#a26">PspJobList</a>;
00120 
<a name="l00121"></a><a class="code" href="../../d0/d1/psinit_8c.html#a27">00121</a> BOOLEAN <a class="code" href="../../d1/d9/ps_8h.html#a63">PsReaperActive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
<a name="l00122"></a><a class="code" href="../../d0/d1/psinit_8c.html#a28">00122</a> LIST_ENTRY <a class="code" href="../../d1/d9/ps_8h.html#a64">PsReaperListHead</a>;
<a name="l00123"></a><a class="code" href="../../d0/d1/psinit_8c.html#a29">00123</a> <a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">WORK_QUEUE_ITEM</a> <a class="code" href="../../d1/d9/ps_8h.html#a65">PsReaperWorkItem</a>;
<a name="l00124"></a><a class="code" href="../../d0/d1/psinit_8c.html#a30">00124</a> <a class="code" href="../../d0/d8/struct__SYSTEM__DLL.html">SYSTEM_DLL</a> <a class="code" href="../../d0/d1/psinit_8c.html#a30">PspSystemDll</a>;
<a name="l00125"></a><a class="code" href="../../d0/d1/psinit_8c.html#a31">00125</a> PVOID <a class="code" href="../../d1/d9/ps_8h.html#a51">PsSystemDllBase</a>;
<a name="l00126"></a><a class="code" href="../../d0/d1/psinit_8c.html#a1">00126</a> <span class="preprocessor">#define PSP_1MB (1024*1024)</span>
00127 <span class="preprocessor"></span>
00128 <span class="comment">//</span>
00129 <span class="comment">// List head and mutex that links all processes that have been initialized</span>
00130 <span class="comment">//</span>
00131 
<a name="l00132"></a><a class="code" href="../../d0/d1/psinit_8c.html#a32">00132</a> <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="code" href="../../d6/d8/sysinfo_8c.html#a25">PspActiveProcessMutex</a>;
<a name="l00133"></a><a class="code" href="../../d0/d1/psinit_8c.html#a33">00133</a> LIST_ENTRY <a class="code" href="../../d1/d9/ps_8h.html#a49">PsActiveProcessHead</a>;
00134 <span class="comment">//extern PIMAGE_FILE_HEADER _header;</span>
<a name="l00135"></a><a class="code" href="../../d0/d1/psinit_8c.html#a34">00135</a> <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> <a class="code" href="../../d1/d9/ps_8h.html#a62">PsIdleProcess</a>;
00136 
00137 BOOLEAN
<a name="l00138"></a><a class="code" href="../../d0/d1/psinit_8c.html#a41">00138</a> <a class="code" href="../../d0/d1/psinit_8c.html#a41">PsInitSystem</a> (
00139     IN ULONG Phase,
00140     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
00141     )
00142 
00143 <span class="comment">/*++</span>
00144 <span class="comment"></span>
00145 <span class="comment">Routine Description:</span>
00146 <span class="comment"></span>
00147 <span class="comment">    This function fermorms process structure initialization.</span>
00148 <span class="comment">    It is called during phase 0 and phase 1 initialization. Its</span>
00149 <span class="comment">    function is to dispatch to the appropriate phase initialization</span>
00150 <span class="comment">    routine.</span>
00151 <span class="comment"></span>
00152 <span class="comment">Arguments:</span>
00153 <span class="comment"></span>
00154 <span class="comment">    Phase - Supplies the initialization phase number.</span>
00155 <span class="comment"></span>
00156 <span class="comment">    LoaderBlock - Supplies a pointer to a loader parameter block.</span>
00157 <span class="comment"></span>
00158 <span class="comment">Return Value:</span>
00159 <span class="comment"></span>
00160 <span class="comment">    TRUE - Initialization succeeded.</span>
00161 <span class="comment"></span>
00162 <span class="comment">    FALSE - Initialization failed.</span>
00163 <span class="comment"></span>
00164 <span class="comment">--*/</span>
00165 
00166 {
00167 
00168     <span class="keywordflow">switch</span> ( <a class="code" href="../../d8/d1/init_8h.html#a21">InitializationPhase</a> ) {
00169 
00170     <span class="keywordflow">case</span> 0 :
00171         <span class="keywordflow">return</span> <a class="code" href="../../d8/d1/psp_8h.html#a55">PspInitPhase0</a>(LoaderBlock);
00172     <span class="keywordflow">case</span> 1 :
00173         <span class="keywordflow">return</span> <a class="code" href="../../d8/d1/psp_8h.html#a56">PspInitPhase1</a>(LoaderBlock);
00174     <span class="keywordflow">default</span>:
00175         <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(UNEXPECTED_INITIALIZATION_CALL);
00176     }
00177     <span class="keywordflow">return</span> 0; <span class="comment">// Not reachable, quiet compiler</span>
00178 }
00179 
00180 BOOLEAN
<a name="l00181"></a><a class="code" href="../../d8/d1/psp_8h.html#a55">00181</a> <a class="code" href="../../d8/d1/psp_8h.html#a55">PspInitPhase0</a> (
00182     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
00183     )
00184 
00185 <span class="comment">/*++</span>
00186 <span class="comment"></span>
00187 <span class="comment">Routine Description:</span>
00188 <span class="comment"></span>
00189 <span class="comment">    This routine performs phase 0 process structure initialization.</span>
00190 <span class="comment">    During this phase, the initial system process, phase 1 initialization</span>
00191 <span class="comment">    thread, and reaper threads are created. All object types and other</span>
00192 <span class="comment">    process structures are created and initialized.</span>
00193 <span class="comment"></span>
00194 <span class="comment">Arguments:</span>
00195 <span class="comment"></span>
00196 <span class="comment">    None.</span>
00197 <span class="comment"></span>
00198 <span class="comment">Return Value:</span>
00199 <span class="comment"></span>
00200 <span class="comment">    TRUE - Initialization was successful.</span>
00201 <span class="comment"></span>
00202 <span class="comment">    FALSE - Initialization Failed.</span>
00203 <span class="comment"></span>
00204 <span class="comment">--*/</span>
00205 
00206 {
00207 
00208     UNICODE_STRING NameString;
00209     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00210     <a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html">OBJECT_TYPE_INITIALIZER</a> ObjectTypeInitializer;
00211     HANDLE <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>;
00212     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00213     <a class="code" href="../../d2/d1/mm_8h.html#a140">MM_SYSTEMSIZE</a> SystemSize;
00214 
00215     SystemSize = <a class="code" href="../../d5/d1/mminit_8c.html#a57">MmQuerySystemSize</a>();
00216     <a class="code" href="../../d8/d0/cmdat3_8c.html#a43">PspDefaultPagefileLimit</a> = (ULONG)-1;
00217 
00218 <span class="preprocessor">#ifdef _WIN64</span>
00219 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>(TEB) &gt; 8192 || <span class="keyword">sizeof</span>(PEB) &gt; 4096 ) {
00220 <span class="preprocessor">#else</span>
00221 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>(TEB) &gt; 4096 || <span class="keyword">sizeof</span>(PEB) &gt; 4096 ) {
00222 <span class="preprocessor">#endif</span>
00223 <span class="preprocessor"></span>        <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(PROCESS_INITIALIZATION_FAILED,99,<span class="keyword">sizeof</span>(TEB),<span class="keyword">sizeof</span>(PEB),99);
00224         }
00225 
00226     <span class="keywordflow">switch</span> ( SystemSize ) {
00227 
00228         <span class="keywordflow">case</span> <a class="code" href="../../d2/d1/mm_8h.html#a343a166">MmMediumSystem</a> :
00229             <a class="code" href="../../d5/d0/wsmanage_8c.html#a5">PsMinimumWorkingSet</a> += 10;
00230             <a class="code" href="../../d2/d8/ps_2create_8c.html#a7">PsMaximumWorkingSet</a> += 100;
00231             <span class="keywordflow">break</span>;
00232 
00233         <span class="keywordflow">case</span> <a class="code" href="../../d2/d1/mm_8h.html#a343a167">MmLargeSystem</a> :
00234             <a class="code" href="../../d5/d0/wsmanage_8c.html#a5">PsMinimumWorkingSet</a> += 30;
00235             <a class="code" href="../../d2/d8/ps_2create_8c.html#a7">PsMaximumWorkingSet</a> += 300;
00236             <span class="keywordflow">break</span>;
00237 
00238         <span class="keywordflow">case</span> <a class="code" href="../../d2/d1/mm_8h.html#a343a165">MmSmallSystem</a> :
00239         <span class="keywordflow">default</span>:
00240             <span class="keywordflow">break</span>;
00241         }
00242 
00243     <a class="code" href="../../d0/d1/psinit_8c.html#a48">PsChangeQuantumTable</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,<a class="code" href="../../d1/d9/ps_8h.html#a48">PsRawPrioritySeparation</a>);
00244 
00245     <span class="comment">//</span>
00246     <span class="comment">// Quotas grow as needed automatically</span>
00247     <span class="comment">//</span>
00248 
00249     <span class="keywordflow">if</span> ( !<a class="code" href="../../d8/d0/cmdat3_8c.html#a41">PspDefaultPagedLimit</a> ) {
00250         <a class="code" href="../../d8/d0/cmdat3_8c.html#a41">PspDefaultPagedLimit</a> = 0;
00251         }
00252     <span class="keywordflow">if</span> ( !<a class="code" href="../../d8/d0/cmdat3_8c.html#a42">PspDefaultNonPagedLimit</a> ) {
00253         <a class="code" href="../../d8/d0/cmdat3_8c.html#a42">PspDefaultNonPagedLimit</a> = 0;
00254         }
00255 
00256     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d0/cmdat3_8c.html#a42">PspDefaultNonPagedLimit</a> == 0 &amp;&amp; <a class="code" href="../../d8/d0/cmdat3_8c.html#a41">PspDefaultPagedLimit</a> == 0) {
00257         <a class="code" href="../../d0/d1/psinit_8c.html#a23">PspDoingGiveBacks</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00258         }
00259     <span class="keywordflow">else</span> {
00260         <a class="code" href="../../d0/d1/psinit_8c.html#a23">PspDoingGiveBacks</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00261         }
00262 
00263 
00264     <a class="code" href="../../d8/d0/cmdat3_8c.html#a41">PspDefaultPagedLimit</a> *= <a class="code" href="../../d0/d1/psinit_8c.html#a1">PSP_1MB</a>;
00265     <a class="code" href="../../d8/d0/cmdat3_8c.html#a42">PspDefaultNonPagedLimit</a> *= <a class="code" href="../../d0/d1/psinit_8c.html#a1">PSP_1MB</a>;
00266 
00267     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a43">PspDefaultPagefileLimit</a> != -1) {
00268         <a class="code" href="../../d8/d0/cmdat3_8c.html#a43">PspDefaultPagefileLimit</a> *= <a class="code" href="../../d0/d1/psinit_8c.html#a1">PSP_1MB</a>;
00269         }
00270 
00271     <span class="comment">//</span>
00272     <span class="comment">// Initialize the process security fields lock and the process lock.</span>
00273     <span class="comment">//</span>
00274 
00275     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>( &amp;<a class="code" href="../../d2/d8/ps_2create_8c.html#a9">PspProcessLockMutex</a> );
00276     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>( &amp;<a class="code" href="../../d1/d9/ps_8h.html#a52">PsProcessSecurityLock</a> );
00277 
00278     <a class="code" href="../../d1/d9/ps_8h.html#a62">PsIdleProcess</a> = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00279     <a class="code" href="../../d1/d9/ps_8h.html#a62">PsIdleProcess</a>-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o4">KernelTime</a> = 0;
00280     <a class="code" href="../../d1/d9/ps_8h.html#a62">PsIdleProcess</a>-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o4">KernelTime</a> = 0;
00281 
00282     <span class="comment">//</span>
00283     <span class="comment">// Initialize the common fields of the Object Type Prototype record</span>
00284     <span class="comment">//</span>
00285 
00286     RtlZeroMemory( &amp;ObjectTypeInitializer, <span class="keyword">sizeof</span>( ObjectTypeInitializer ) );
00287     ObjectTypeInitializer.Length = <span class="keyword">sizeof</span>( ObjectTypeInitializer );
00288     ObjectTypeInitializer.InvalidAttributes = OBJ_OPENLINK;
00289     ObjectTypeInitializer.SecurityRequired = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00290     ObjectTypeInitializer.PoolType = <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>;
00291     ObjectTypeInitializer.InvalidAttributes = OBJ_PERMANENT |
00292                                               OBJ_EXCLUSIVE |
00293                                               OBJ_OPENIF;
00294 
00295 
00296     <span class="comment">//</span>
00297     <span class="comment">// Create Object types for Thread and Process Objects.</span>
00298     <span class="comment">//</span>
00299 
00300     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;NameString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Process"</span>);
00301     ObjectTypeInitializer.DefaultPagedPoolCharge = <a class="code" href="../../d8/d1/psp_8h.html#a1">PSP_PROCESS_PAGED_CHARGE</a>;
00302     ObjectTypeInitializer.DefaultNonPagedPoolCharge = <a class="code" href="../../d8/d1/psp_8h.html#a2">PSP_PROCESS_NONPAGED_CHARGE</a>;
00303     ObjectTypeInitializer.DeleteProcedure = <a class="code" href="../../d8/d0/psdelete_8c.html#a14">PspProcessDelete</a>;
00304     ObjectTypeInitializer.ValidAccessMask = PROCESS_ALL_ACCESS;
00305     ObjectTypeInitializer.GenericMapping = <a class="code" href="../../d0/d1/psinit_8c.html#a6">PspProcessMapping</a>;
00306 
00307     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>(&amp;NameString,
00308                                      &amp;ObjectTypeInitializer,
00309                                      (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00310                                      &amp;<a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>
00311                                      )) ){
00312         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00313     }
00314 
00315     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;NameString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Thread"</span>);
00316     ObjectTypeInitializer.DefaultPagedPoolCharge = <a class="code" href="../../d8/d1/psp_8h.html#a3">PSP_THREAD_PAGED_CHARGE</a>;
00317     ObjectTypeInitializer.DefaultNonPagedPoolCharge = <a class="code" href="../../d8/d1/psp_8h.html#a4">PSP_THREAD_NONPAGED_CHARGE</a>;
00318     ObjectTypeInitializer.DeleteProcedure = <a class="code" href="../../d8/d0/psdelete_8c.html#a15">PspThreadDelete</a>;
00319     ObjectTypeInitializer.ValidAccessMask = THREAD_ALL_ACCESS;
00320     ObjectTypeInitializer.GenericMapping = <a class="code" href="../../d0/d1/psinit_8c.html#a7">PspThreadMapping</a>;
00321 
00322     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>(&amp;NameString,
00323                                      &amp;ObjectTypeInitializer,
00324                                      (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00325                                      &amp;<a class="code" href="../../d9/d8/ntos_8h.html#a3">PsThreadType</a>
00326                                      )) ){
00327         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00328     }
00329 
00330 
00331     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;NameString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Job"</span>);
00332     ObjectTypeInitializer.DefaultPagedPoolCharge = 0;
00333     ObjectTypeInitializer.DefaultNonPagedPoolCharge = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d3/struct__EJOB.html">EJOB</a>);
00334     ObjectTypeInitializer.DeleteProcedure = <a class="code" href="../../d1/d1/psjob_8c.html#a9">PspJobDelete</a>;
00335     ObjectTypeInitializer.CloseProcedure = <a class="code" href="../../d1/d1/psjob_8c.html#a10">PspJobClose</a>;
00336     ObjectTypeInitializer.ValidAccessMask = JOB_OBJECT_ALL_ACCESS;
00337     ObjectTypeInitializer.GenericMapping = <a class="code" href="../../d0/d1/psinit_8c.html#a8">PspJobMapping</a>;
00338     ObjectTypeInitializer.InvalidAttributes = 0;
00339 
00340     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>(&amp;NameString,
00341                                      &amp;ObjectTypeInitializer,
00342                                      (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00343                                      &amp;<a class="code" href="../../d9/d8/ntos_8h.html#a4">PsJobType</a>
00344                                      )) ){
00345         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00346     }
00347 
00348 
00349 
00350 
00351 
00352 
00353     <span class="comment">//</span>
00354     <span class="comment">// Initialize active process list head and mutex</span>
00355     <span class="comment">//</span>
00356 
00357     InitializeListHead(&amp;<a class="code" href="../../d1/d9/ps_8h.html#a49">PsActiveProcessHead</a>);
00358     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a25">PspActiveProcessMutex</a>);
00359 
00360     <span class="comment">//</span>
00361     <span class="comment">// Initialize job list head and mutex</span>
00362     <span class="comment">//</span>
00363 
00364     InitializeListHead(&amp;<a class="code" href="../../d0/d1/psinit_8c.html#a26">PspJobList</a>);
00365     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;<a class="code" href="../../d0/d1/psinit_8c.html#a25">PspJobListLock</a>);
00366     InitializeListHead(&amp;<a class="code" href="../../d8/d1/psp_8h.html#a20">PspWorkingSetChangeHead</a>.<a class="code" href="../../d7/d4/struct__JOB__WORKING__SET__CHANGE__HEAD.html#o0">Links</a>);
00367     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;<a class="code" href="../../d8/d1/psp_8h.html#a20">PspWorkingSetChangeHead</a>.<a class="code" href="../../d7/d4/struct__JOB__WORKING__SET__CHANGE__HEAD.html#o1">Lock</a>);
00368 
00369     <span class="comment">//</span>
00370     <span class="comment">// Initialize CID handle table.</span>
00371     <span class="comment">//</span>
00372     <span class="comment">// N.B. The CID handle table is removed from the handle table list so</span>
00373     <span class="comment">//      it will not be enumerated for object handle queries.</span>
00374     <span class="comment">//</span>
00375 
00376     <a class="code" href="../../d6/d8/sysinfo_8c.html#a1">PspCidTable</a> = <a class="code" href="../../d5/d8/ex_8h.html#a290">ExCreateHandleTable</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00377     <span class="keywordflow">if</span> ( ! <a class="code" href="../../d6/d8/sysinfo_8c.html#a1">PspCidTable</a> ) {
00378         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00379     }
00380     <a class="code" href="../../d5/d8/ex_8h.html#a291">ExRemoveHandleTable</a>(<a class="code" href="../../d6/d8/sysinfo_8c.html#a1">PspCidTable</a>);
00381 
00382 <span class="preprocessor">#if defined(i386)</span>
00383 <span class="preprocessor"></span>
00384     <span class="comment">//</span>
00385     <span class="comment">// Ldt Initialization</span>
00386     <span class="comment">//</span>
00387 
00388     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d3/d1/i386_2psldt_8c.html#a9">PspLdtInitialize</a>()) ) {
00389         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00390     }
00391 
00392     <span class="comment">//</span>
00393     <span class="comment">// Vdm support Initialization</span>
00394     <span class="comment">//</span>
00395 
00396     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a11">PspVdmInitialize</a>()) ) {
00397         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00398     }
00399 
00400 <span class="preprocessor">#endif</span>
00401 <span class="preprocessor"></span>
00402     <span class="comment">//</span>
00403     <span class="comment">// Initialize Reaper Data Structures</span>
00404     <span class="comment">//</span>
00405 
00406     InitializeListHead(&amp;<a class="code" href="../../d1/d9/ps_8h.html#a64">PsReaperListHead</a>);
00407     <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>(&amp;<a class="code" href="../../d1/d9/ps_8h.html#a65">PsReaperWorkItem</a>, <a class="code" href="../../d8/d0/psdelete_8c.html#a2">PspReaper</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00408 
00409     <span class="comment">//</span>
00410     <span class="comment">// Get a pointer to the system access token.</span>
00411     <span class="comment">// This token is used by the boot process, so we can take the pointer</span>
00412     <span class="comment">// from there.</span>
00413     <span class="comment">//</span>
00414 
00415     <a class="code" href="../../d0/d1/psinit_8c.html#a14">PspBootAccessToken</a> = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Token;
00416 
00417     InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00418                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00419                                 0,
00420                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00421                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00422                               ); <span class="comment">// FIXFIX</span>
00423 
00424     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d1/psp_8h.html#a62">PspCreateProcess</a>(
00425                     &amp;<a class="code" href="../../d6/d3/modwrite_8c.html#a13">PspInitialSystemProcessHandle</a>,
00426                     PROCESS_ALL_ACCESS,
00427                     &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00428                     0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00429                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00430                     0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00431                     0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00432                     0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>
00433                     )) ) {
00434         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00435     }
00436 
00437     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00438                                         <a class="code" href="../../d6/d3/modwrite_8c.html#a13">PspInitialSystemProcessHandle</a>,
00439                                         0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00440                                         <a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>,
00441                                         <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00442                                         (PVOID *)&amp;<a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>,
00443                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00444                                         )) ) {
00445 
00446         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00447     }
00448 
00449     strcpy(&amp;<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ImageFileName[0],<span class="stringliteral">"Idle"</span>);
00450     strcpy(&amp;<a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o65">ImageFileName</a>[0],<span class="stringliteral">"System"</span>);
00451 
00452     <span class="comment">//</span>
00453     <span class="comment">// Phase 1 System initialization</span>
00454     <span class="comment">//</span>
00455 
00456     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d2/d8/ps_2create_8c.html#a11">PsCreateSystemThread</a>(
00457                     &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
00458                     THREAD_ALL_ACCESS,
00459                     &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00460                     0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00461                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00462                     <a class="code" href="../../d8/d1/init_8h.html#a23">Phase1Initialization</a>,
00463                     (PVOID)LoaderBlock
00464                     )) ) {
00465         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00466     }
00467 
00468 
00469     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00470                         <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
00471                         0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00472                         <a class="code" href="../../d9/d8/ntos_8h.html#a3">PsThreadType</a>,
00473                         <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00474                         (PVOID *)&amp;Thread,
00475                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00476                         )) ) {
00477 
00478         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00479     }
00480 
00481     ZwClose( <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a> );
00482 
00483     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00484 }
00485 
00486 BOOLEAN
<a name="l00487"></a><a class="code" href="../../d8/d1/psp_8h.html#a56">00487</a> <a class="code" href="../../d8/d1/psp_8h.html#a56">PspInitPhase1</a> (
00488     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
00489     )
00490 
00491 <span class="comment">/*++</span>
00492 <span class="comment"></span>
00493 <span class="comment">Routine Description:</span>
00494 <span class="comment"></span>
00495 <span class="comment">    This routine performs phase 1 process structure initialization.</span>
00496 <span class="comment">    During this phase, the system DLL is located and relevant entry</span>
00497 <span class="comment">    points are extracted.</span>
00498 <span class="comment"></span>
00499 <span class="comment">Arguments:</span>
00500 <span class="comment"></span>
00501 <span class="comment">    None.</span>
00502 <span class="comment"></span>
00503 <span class="comment">Return Value:</span>
00504 <span class="comment"></span>
00505 <span class="comment">    TRUE - Initialization was successful.</span>
00506 <span class="comment"></span>
00507 <span class="comment">    FALSE - Initialization Failed.</span>
00508 <span class="comment"></span>
00509 <span class="comment">--*/</span>
00510 
00511 {
00512 
00513     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00514 
00515     st = <a class="code" href="../../d8/d1/psp_8h.html#a57">PspInitializeSystemDll</a>();
00516 
00517     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00518         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00519     }
00520 
00521     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00522 }
00523 
00524 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00525"></a><a class="code" href="../../d0/d1/psinit_8c.html#a44">00525</a> <a class="code" href="../../d0/d1/psinit_8c.html#a44">PsLocateSystemDll</a> (
00526     VOID
00527     )
00528 
00529 <span class="comment">/*++</span>
00530 <span class="comment"></span>
00531 <span class="comment">Routine Description:</span>
00532 <span class="comment"></span>
00533 <span class="comment">    This function locates the system dll and creates a section for the</span>
00534 <span class="comment">    DLL and maps it into the system process.</span>
00535 <span class="comment"></span>
00536 <span class="comment">Arguments:</span>
00537 <span class="comment"></span>
00538 <span class="comment">    None.</span>
00539 <span class="comment"></span>
00540 <span class="comment">Return Value:</span>
00541 <span class="comment"></span>
00542 <span class="comment">    TRUE - Initialization was successful.</span>
00543 <span class="comment"></span>
00544 <span class="comment">    FALSE - Initialization Failed.</span>
00545 <span class="comment"></span>
00546 <span class="comment">--*/</span>
00547 
00548 {
00549 
00550     HANDLE <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>;
00551     HANDLE Section;
00552     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00553     UNICODE_STRING DllPathName;
00554     WCHAR PathBuffer[DOS_MAX_PATH_LENGTH];
00555     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00556     IO_STATUS_BLOCK IoStatus;
00557 
00558     <span class="comment">//</span>
00559     <span class="comment">// Initialize the system DLL</span>
00560     <span class="comment">//</span>
00561 
00562     DllPathName.Length = 0;
00563     DllPathName.Buffer = PathBuffer;
00564     DllPathName.MaximumLength = 256;
00565     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;DllPathName,<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\SystemRoot\\System32\\ntdll.dll"</span>);
00566     InitializeObjectAttributes(
00567         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00568         &amp;DllPathName,
00569         OBJ_CASE_INSENSITIVE,
00570         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00571         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00572         );
00573 
00574     st = <a class="code" href="../../d6/d9/restrfil_8c.html#a33">ZwOpenFile</a>(
00575             &amp;<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>,
00576             SYNCHRONIZE | FILE_EXECUTE,
00577             &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00578             &amp;IoStatus,
00579             FILE_SHARE_READ,
00580             0
00581             );
00582 
00583     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
00584 
00585 <span class="preprocessor">#if DBG</span>
00586 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"PS: PsLocateSystemDll - NtOpenFile( NTDLL.DLL ) failed.  Status == %lx\n"</span>,
00587             st
00588             );
00589 <span class="preprocessor">#endif</span>
00590 <span class="preprocessor"></span>        <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(PROCESS1_INITIALIZATION_FAILED,st,2,0,0);
00591         <span class="keywordflow">return</span> st;
00592     }
00593 
00594     st = <a class="code" href="../../d0/d1/psinit_8c.html#a39">MmCheckSystemImage</a>(<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>);
00595     <span class="keywordflow">if</span> ( st == STATUS_IMAGE_CHECKSUM_MISMATCH ) {
00596         ULONG_PTR ErrorParameters;
00597         ULONG ErrorResponse;
00598 
00599         <span class="comment">//</span>
00600         <span class="comment">// Hard error time. A driver is corrupt.</span>
00601         <span class="comment">//</span>
00602 
00603     ErrorParameters = (ULONG_PTR)&amp;DllPathName;
00604 
00605         <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a11">NtRaiseHardError</a>(
00606             st,
00607             1,
00608             1,
00609             &amp;ErrorParameters,
00610             OptionOk,
00611             &amp;ErrorResponse
00612             );
00613         <span class="keywordflow">return</span> st;
00614         }
00615 
00616 
00617     <a class="code" href="../../d1/d9/ps_8h.html#a50">PsNtDllPathName</a>.MaximumLength = DllPathName.Length + <span class="keyword">sizeof</span>( WCHAR );
00618     <a class="code" href="../../d1/d9/ps_8h.html#a50">PsNtDllPathName</a>.Length = 0;
00619     <a class="code" href="../../d1/d9/ps_8h.html#a50">PsNtDllPathName</a>.Buffer = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a49">RtlAllocateStringRoutine</a>( <a class="code" href="../../d1/d9/ps_8h.html#a50">PsNtDllPathName</a>.MaximumLength );
00620     <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>( &amp;<a class="code" href="../../d1/d9/ps_8h.html#a50">PsNtDllPathName</a>, &amp;DllPathName );
00621 
00622     st = ZwCreateSection(
00623             &amp;Section,
00624             SECTION_ALL_ACCESS,
00625             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00626             0,
00627             PAGE_EXECUTE,
00628             SEC_IMAGE,
00629             <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>
00630             );
00631     ZwClose( <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> );
00632 
00633     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
00634 <span class="preprocessor">#if DBG</span>
00635 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"PS: PsLocateSystemDll: NtCreateSection Status == %lx\n"</span>,st);
00636 <span class="preprocessor">#endif</span>
00637 <span class="preprocessor"></span>        <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(PROCESS1_INITIALIZATION_FAILED,st,3,0,0);
00638         <span class="keywordflow">return</span> st;
00639     }
00640 
00641     <span class="comment">//</span>
00642     <span class="comment">// Now that we have the section, reference it, store its address in the</span>
00643     <span class="comment">// PspSystemDll and then close handle to the section.</span>
00644     <span class="comment">//</span>
00645 
00646     st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00647             Section,
00648             SECTION_ALL_ACCESS,
00649             <a class="code" href="../../d2/d1/mm_8h.html#a133">MmSectionObjectType</a>,
00650             <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00651             &amp;<a class="code" href="../../d0/d1/psinit_8c.html#a30">PspSystemDll</a>.<a class="code" href="../../d0/d8/struct__SYSTEM__DLL.html#o0">Section</a>,
00652             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00653             );
00654 
00655     ZwClose(Section);
00656 
00657     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00658         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(PROCESS1_INITIALIZATION_FAILED,st,4,0,0);
00659         <span class="keywordflow">return</span> st;
00660     }
00661 
00662     <span class="comment">//</span>
00663     <span class="comment">// Map the system dll into the user part of the address space</span>
00664     <span class="comment">//</span>
00665 
00666     st = <a class="code" href="../../d8/d1/psp_8h.html#a61">PspMapSystemDll</a>(<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(),&amp;<a class="code" href="../../d0/d1/psinit_8c.html#a30">PspSystemDll</a>.<a class="code" href="../../d0/d8/struct__SYSTEM__DLL.html#o1">DllBase</a>);
00667     <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a8">PsSystemDllDllBase</a> = <a class="code" href="../../d0/d1/psinit_8c.html#a30">PspSystemDll</a>.<a class="code" href="../../d0/d8/struct__SYSTEM__DLL.html#o1">DllBase</a>;
00668 
00669     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00670         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(PROCESS1_INITIALIZATION_FAILED,st,5,0,0);
00671         <span class="keywordflow">return</span> st;
00672     }
00673     <a class="code" href="../../d1/d9/ps_8h.html#a51">PsSystemDllBase</a> = <a class="code" href="../../d0/d1/psinit_8c.html#a30">PspSystemDll</a>.<a class="code" href="../../d0/d8/struct__SYSTEM__DLL.html#o1">DllBase</a>;
00674 
00675     <span class="keywordflow">return</span> STATUS_SUCCESS;
00676 }
00677 
00678 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00679"></a><a class="code" href="../../d8/d1/psp_8h.html#a61">00679</a> <a class="code" href="../../d8/d1/psp_8h.html#a61">PspMapSystemDll</a> (
00680     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00681     OUT PVOID *DllBase OPTIONAL
00682     )
00683 
00684 <span class="comment">/*++</span>
00685 <span class="comment"></span>
00686 <span class="comment">Routine Description:</span>
00687 <span class="comment"></span>
00688 <span class="comment">    This function maps the system DLL into the specified process.</span>
00689 <span class="comment"></span>
00690 <span class="comment">Arguments:</span>
00691 <span class="comment"></span>
00692 <span class="comment">    Process - Supplies the address of the process to map the DLL into.</span>
00693 <span class="comment"></span>
00694 <span class="comment">Return Value:</span>
00695 <span class="comment"></span>
00696 <span class="comment">    TBD</span>
00697 <span class="comment"></span>
00698 <span class="comment">--*/</span>
00699 
00700 {
00701     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00702     PVOID ViewBase;
00703     LARGE_INTEGER SectionOffset;
00704     SIZE_T ViewSize;
00705 
00706     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00707 
00708     ViewBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00709     SectionOffset.LowPart = 0;
00710     SectionOffset.HighPart = 0;
00711     ViewSize = 0;
00712 
00713     <span class="comment">//</span>
00714     <span class="comment">// Map the system dll into the user part of the address space</span>
00715     <span class="comment">//</span>
00716 
00717     st = <a class="code" href="../../d3/d5/mapview_8c.html#a21">MmMapViewOfSection</a>(
00718             <a class="code" href="../../d0/d1/psinit_8c.html#a30">PspSystemDll</a>.<a class="code" href="../../d0/d8/struct__SYSTEM__DLL.html#o0">Section</a>,
00719             Process,
00720             &amp;ViewBase,
00721             0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00722             0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00723             &amp;SectionOffset,
00724             &amp;ViewSize,
00725             ViewShare,
00726             0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00727             PAGE_READWRITE
00728             );
00729 
00730     <span class="keywordflow">if</span> ( st != STATUS_SUCCESS ) {
00731 <span class="preprocessor">#if DBG</span>
00732 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"PS: Unable to map system dll at based address.\n"</span>);
00733 <span class="preprocessor">#endif</span>
00734 <span class="preprocessor"></span>        st = STATUS_CONFLICTING_ADDRESSES;
00735     }
00736 
00737     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(DllBase) ) {
00738         *DllBase = ViewBase;
00739     }
00740 
00741     <span class="keywordflow">return</span> st;
00742 }
00743 
00744 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00745"></a><a class="code" href="../../d8/d1/psp_8h.html#a57">00745</a> <a class="code" href="../../d8/d1/psp_8h.html#a57">PspInitializeSystemDll</a> (
00746     VOID
00747     )
00748 
00749 <span class="comment">/*++</span>
00750 <span class="comment"></span>
00751 <span class="comment">Routine Description:</span>
00752 <span class="comment"></span>
00753 <span class="comment">    This function initializes the system DLL and locates</span>
00754 <span class="comment">    various entrypoints within the DLL.</span>
00755 <span class="comment"></span>
00756 <span class="comment">Arguments:</span>
00757 <span class="comment"></span>
00758 <span class="comment">    None.</span>
00759 <span class="comment"></span>
00760 <span class="comment">Return Value:</span>
00761 <span class="comment"></span>
00762 <span class="comment">    TBD</span>
00763 <span class="comment"></span>
00764 <span class="comment">--*/</span>
00765 
00766 {
00767     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00768     PSZ dll_entrypoint;
00769     PVOID R3EmulatorTable;
00770 
00771     <span class="comment">//</span>
00772     <span class="comment">// Locate the important system dll entrypoints</span>
00773     <span class="comment">//</span>
00774 
00775     dll_entrypoint = <span class="stringliteral">"LdrInitializeThunk"</span>;
00776 
00777     st = <a class="code" href="../../d8/d1/psp_8h.html#a58">PspLookupSystemDllEntryPoint</a>(
00778             dll_entrypoint,
00779             (PVOID *)&amp;<a class="code" href="../../d0/d1/psinit_8c.html#a30">PspSystemDll</a>.<a class="code" href="../../d0/d8/struct__SYSTEM__DLL.html#o2">LoaderInitRoutine</a>
00780             );
00781 
00782     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00783 <span class="preprocessor">#if DBG</span>
00784 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"PS: Unable to locate LdrInitializeThunk in system dll\n"</span>);
00785 <span class="preprocessor">#endif</span>
00786 <span class="preprocessor"></span>        <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(PROCESS1_INITIALIZATION_FAILED,st,6,0,0);
00787         <span class="keywordflow">return</span> st;
00788     }
00789 
00790 <span class="preprocessor">#if i386</span>
00791 <span class="preprocessor"></span>    <span class="comment">//</span>
00792     <span class="comment">// Find 80387 emulator.</span>
00793     <span class="comment">//</span>
00794 
00795     st = <a class="code" href="../../d8/d1/psp_8h.html#a58">PspLookupSystemDllEntryPoint</a>(
00796             <span class="stringliteral">"NPXEMULATORTABLE"</span>,
00797             &amp;R3EmulatorTable
00798             );
00799 
00800     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00801 <span class="preprocessor">#if DBG</span>
00802 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"PS: Unable to locate NPXNPHandler in system dll\n"</span>);
00803 <span class="preprocessor">#endif</span>
00804 <span class="preprocessor"></span>        <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(PROCESS1_INITIALIZATION_FAILED,st,7,0,0);
00805         <span class="keywordflow">return</span> st;
00806     }
00807     <span class="comment">//</span>
00808     <span class="comment">// Pass emulator into kernel, and let it decide whether it should</span>
00809     <span class="comment">// use the emulator or set up to use the 80387 hardware.</span>
00810     <span class="comment">//</span>
00811 
00812     <a class="code" href="../../d6/d9/kernlini_8c.html#a40">KeSetup80387OrEmulate</a>(R3EmulatorTable);
00813 <span class="preprocessor">#endif //i386</span>
00814 <span class="preprocessor"></span>
00815     st = <a class="code" href="../../d8/d1/psp_8h.html#a59">PspLookupKernelUserEntryPoints</a>();
00816 
00817     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00818         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(PROCESS1_INITIALIZATION_FAILED,st,8,0,0);
00819         }
00820 
00821     <a class="code" href="../../d5/d6/4_2kdinit_8c.html#a2">KdUpdateDataBlock</a>();
00822 
00823     <span class="keywordflow">return</span> st;
00824 }
00825 
00826 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00827"></a><a class="code" href="../../d8/d1/psp_8h.html#a58">00827</a> <a class="code" href="../../d8/d1/psp_8h.html#a58">PspLookupSystemDllEntryPoint</a> (
00828     IN PSZ NameOfEntryPoint,
00829     OUT PVOID *AddressOfEntryPoint
00830     )
00831 
00832 {
00833     <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/psinit_8c.html#a40">LookupEntryPoint</a> (
00834                 <a class="code" href="../../d0/d1/psinit_8c.html#a30">PspSystemDll</a>.<a class="code" href="../../d0/d8/struct__SYSTEM__DLL.html#o1">DllBase</a>,
00835                 NameOfEntryPoint,
00836                 AddressOfEntryPoint
00837             );
00838 }
00839 
<a name="l00840"></a><a class="code" href="../../d0/d1/psinit_8c.html#a35">00840</a> SCHAR <a class="code" href="../../d0/d1/psinit_8c.html#a35">PspFixedQuantums</a>[6] = {
00841                                 3*<a class="code" href="../../d4/d9/ke_8h.html#a3">THREAD_QUANTUM</a>,
00842                                 3*<a class="code" href="../../d4/d9/ke_8h.html#a3">THREAD_QUANTUM</a>,
00843                                 3*<a class="code" href="../../d4/d9/ke_8h.html#a3">THREAD_QUANTUM</a>,
00844                                 6*<a class="code" href="../../d4/d9/ke_8h.html#a3">THREAD_QUANTUM</a>,
00845                                 6*<a class="code" href="../../d4/d9/ke_8h.html#a3">THREAD_QUANTUM</a>,
00846                                 6*<a class="code" href="../../d4/d9/ke_8h.html#a3">THREAD_QUANTUM</a>
00847                                 };
00848 
<a name="l00849"></a><a class="code" href="../../d0/d1/psinit_8c.html#a36">00849</a> SCHAR <a class="code" href="../../d0/d1/psinit_8c.html#a36">PspVariableQuantums</a>[6] = {
00850                                 1*<a class="code" href="../../d4/d9/ke_8h.html#a3">THREAD_QUANTUM</a>,
00851                                 2*<a class="code" href="../../d4/d9/ke_8h.html#a3">THREAD_QUANTUM</a>,
00852                                 3*<a class="code" href="../../d4/d9/ke_8h.html#a3">THREAD_QUANTUM</a>,
00853                                 2*<a class="code" href="../../d4/d9/ke_8h.html#a3">THREAD_QUANTUM</a>,
00854                                 4*<a class="code" href="../../d4/d9/ke_8h.html#a3">THREAD_QUANTUM</a>,
00855                                 6*<a class="code" href="../../d4/d9/ke_8h.html#a3">THREAD_QUANTUM</a>
00856                                 };
00857 
00858 <span class="comment">//</span>
00859 <span class="comment">// The table is ONLY used when fixed quantums are selected.</span>
00860 <span class="comment">//</span>
00861 
<a name="l00862"></a><a class="code" href="../../d0/d1/psinit_8c.html#a37">00862</a> BOOLEAN <a class="code" href="../../d0/d1/psinit_8c.html#a37">PspUseJobSchedulingClasses</a>;
00863 
<a name="l00864"></a><a class="code" href="../../d0/d1/psinit_8c.html#a38">00864</a> SCHAR <a class="code" href="../../d0/d1/psinit_8c.html#a38">PspJobSchedulingClasses</a>[<a class="code" href="../../d8/d1/psp_8h.html#a8">PSP_NUMBER_OF_SCHEDULING_CLASSES</a>] = {
00865                                 1*<a class="code" href="../../d4/d9/ke_8h.html#a3">THREAD_QUANTUM</a>,   <span class="comment">// long fixed 0</span>
00866                                 2*<a class="code" href="../../d4/d9/ke_8h.html#a3">THREAD_QUANTUM</a>,   <span class="comment">// long fixed 1...</span>
00867                                 3*<a class="code" href="../../d4/d9/ke_8h.html#a3">THREAD_QUANTUM</a>,
00868                                 4*<a class="code" href="../../d4/d9/ke_8h.html#a3">THREAD_QUANTUM</a>,
00869                                 5*<a class="code" href="../../d4/d9/ke_8h.html#a3">THREAD_QUANTUM</a>,
00870                                 6*<a class="code" href="../../d4/d9/ke_8h.html#a3">THREAD_QUANTUM</a>,   <span class="comment">// DEFAULT</span>
00871                                 7*<a class="code" href="../../d4/d9/ke_8h.html#a3">THREAD_QUANTUM</a>,
00872                                 8*<a class="code" href="../../d4/d9/ke_8h.html#a3">THREAD_QUANTUM</a>,
00873                                 9*<a class="code" href="../../d4/d9/ke_8h.html#a3">THREAD_QUANTUM</a>,
00874                                 10*<a class="code" href="../../d4/d9/ke_8h.html#a3">THREAD_QUANTUM</a>   <span class="comment">// long fixed 9</span>
00875                                 };
00876 
00877 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00878"></a><a class="code" href="../../d0/d1/psinit_8c.html#a48">00878</a> <a class="code" href="../../d0/d1/psinit_8c.html#a48">PsChangeQuantumTable</a>(
00879     BOOLEAN ModifyActiveProcesses,
00880     ULONG PrioritySeparation
00881     )
00882 {
00883 
00884     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00885     PLIST_ENTRY NextProcess;
00886     ULONG QuantumIndex;
00887     PSCHAR QuantumTableBase;
00888 
00889     <span class="comment">//</span>
00890     <span class="comment">// extract priority seperation value</span>
00891     <span class="comment">//</span>
00892     <span class="keywordflow">switch</span> ( PrioritySeparation &amp; PROCESS_PRIORITY_SEPARATION_MASK ) {
00893         <span class="keywordflow">case</span> 3:
00894             <a class="code" href="../../d1/d9/ps_8h.html#a47">PsPrioritySeperation</a> = PROCESS_PRIORITY_SEPARATION_MAX;
00895             <span class="keywordflow">break</span>;
00896         <span class="keywordflow">default</span>:
00897             <a class="code" href="../../d1/d9/ps_8h.html#a47">PsPrioritySeperation</a> = PrioritySeparation &amp; PROCESS_PRIORITY_SEPARATION_MASK;
00898             <span class="keywordflow">break</span>;
00899         }
00900 
00901     <span class="comment">//</span>
00902     <span class="comment">// determine if we are using fixed or variable quantums</span>
00903     <span class="comment">//</span>
00904     <span class="keywordflow">switch</span> ( PrioritySeparation &amp; PROCESS_QUANTUM_VARIABLE_MASK ) {
00905         <span class="keywordflow">case</span> PROCESS_QUANTUM_VARIABLE_VALUE:
00906             QuantumTableBase = <a class="code" href="../../d0/d1/psinit_8c.html#a36">PspVariableQuantums</a>;
00907             <span class="keywordflow">break</span>;
00908 
00909         <span class="keywordflow">case</span> PROCESS_QUANTUM_FIXED_VALUE:
00910             QuantumTableBase = <a class="code" href="../../d0/d1/psinit_8c.html#a35">PspFixedQuantums</a>;
00911             <span class="keywordflow">break</span>;
00912 
00913         <span class="keywordflow">case</span> PROCESS_QUANTUM_VARIABLE_DEF:
00914         <span class="keywordflow">default</span>:
00915             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d1/mminit_8c.html#a58">MmIsThisAnNtAsSystem</a>() ) {
00916                 QuantumTableBase = <a class="code" href="../../d0/d1/psinit_8c.html#a35">PspFixedQuantums</a>;
00917                 }
00918             <span class="keywordflow">else</span> {
00919                 QuantumTableBase = <a class="code" href="../../d0/d1/psinit_8c.html#a36">PspVariableQuantums</a>;
00920                 }
00921             <span class="keywordflow">break</span>;
00922         }
00923 
00924     <span class="comment">//</span>
00925     <span class="comment">// determine if we are using long or short</span>
00926     <span class="comment">//</span>
00927     <span class="keywordflow">switch</span> ( PrioritySeparation &amp; PROCESS_QUANTUM_LONG_MASK ) {
00928         <span class="keywordflow">case</span> PROCESS_QUANTUM_LONG_VALUE:
00929             QuantumTableBase = QuantumTableBase + 3;
00930             <span class="keywordflow">break</span>;
00931 
00932         <span class="keywordflow">case</span> PROCESS_QUANTUM_SHORT_VALUE:
00933             <span class="keywordflow">break</span>;
00934 
00935         <span class="keywordflow">case</span> PROCESS_QUANTUM_LONG_DEF:
00936         <span class="keywordflow">default</span>:
00937             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d1/mminit_8c.html#a58">MmIsThisAnNtAsSystem</a>() ) {
00938                 QuantumTableBase = QuantumTableBase + 3;
00939                 }
00940             <span class="keywordflow">break</span>;
00941         }
00942 
00943     <span class="comment">//</span>
00944     <span class="comment">// Job Scheduling classes are ONLY meaningful if long fixed quantums</span>
00945     <span class="comment">// are selected. In practice, this means stock NTS configurations</span>
00946     <span class="comment">//</span>
00947     <span class="keywordflow">if</span> ( QuantumTableBase == &amp;<a class="code" href="../../d0/d1/psinit_8c.html#a35">PspFixedQuantums</a>[3] ) {
00948         <a class="code" href="../../d0/d1/psinit_8c.html#a37">PspUseJobSchedulingClasses</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00949         }
00950     <span class="keywordflow">else</span> {
00951         <a class="code" href="../../d0/d1/psinit_8c.html#a37">PspUseJobSchedulingClasses</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00952         }
00953 
00954     RtlCopyMemory(<a class="code" href="../../d0/d1/psinit_8c.html#a21">PspForegroundQuantum</a>,QuantumTableBase,<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/psinit_8c.html#a21">PspForegroundQuantum</a>));
00955 
00956     <span class="keywordflow">if</span> (ModifyActiveProcesses) {
00957 
00958         ExAcquireFastMutex(&amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a25">PspActiveProcessMutex</a>);
00959 
00960         NextProcess = <a class="code" href="../../d1/d9/ps_8h.html#a49">PsActiveProcessHead</a>.Flink;
00961 
00962         <span class="keywordflow">while</span> (NextProcess != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a49">PsActiveProcessHead</a>) {
00963             Process = CONTAINING_RECORD(NextProcess,
00964                                         <a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>,
00965                                         ActiveProcessLinks);
00966 
00967             <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o12">MemoryPriority</a> == <a class="code" href="../../d1/d9/ps_8h.html#a1">MEMORY_PRIORITY_BACKGROUND</a> ) {
00968                 QuantumIndex = 0;
00969                 }
00970             <span class="keywordflow">else</span> {
00971                 QuantumIndex = <a class="code" href="../../d1/d9/ps_8h.html#a47">PsPrioritySeperation</a>;
00972                 }
00973             <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o68">PriorityClass</a> != PROCESS_PRIORITY_CLASS_IDLE ) {
00974 
00975                 <span class="comment">//</span>
00976                 <span class="comment">// If the process is contained within a JOB, AND we are</span>
00977                 <span class="comment">// running Fixed, Long Quantums, use the quantum associated</span>
00978                 <span class="comment">// with the Job's scheduling class</span>
00979                 <span class="comment">//</span>
00980                 <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a> &amp;&amp; <a class="code" href="../../d0/d1/psinit_8c.html#a37">PspUseJobSchedulingClasses</a> ) {
00981                     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o13">ThreadQuantum</a> = <a class="code" href="../../d0/d1/psinit_8c.html#a38">PspJobSchedulingClasses</a>[Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o28">SchedulingClass</a>];
00982                     }
00983                 <span class="keywordflow">else</span> {
00984                     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o13">ThreadQuantum</a> = <a class="code" href="../../d0/d1/psinit_8c.html#a21">PspForegroundQuantum</a>[QuantumIndex];
00985                     }
00986                 }
00987             <span class="keywordflow">else</span> {
00988                 Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o13">ThreadQuantum</a> = <a class="code" href="../../d4/d9/ke_8h.html#a3">THREAD_QUANTUM</a>;
00989                 }
00990             NextProcess = NextProcess-&gt;Flink;
00991             }
00992         ExReleaseFastMutex(&amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a25">PspActiveProcessMutex</a>);
00993         }
00994 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:32 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
