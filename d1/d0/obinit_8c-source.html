<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: obinit.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>obinit.c</h1><a href="../../d0/d1/obinit_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    obinit.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Initialization module for the OB subcomponent of NTOS</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Steve Wood (stevewo) 31-Mar-1989</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d5/d1/obp_8h.html">obp.h</a>"</span>
00022 
00023 <span class="comment">//</span>
00024 <span class="comment">//  Form some default access masks for the various object types</span>
00025 <span class="comment">//</span>
00026 
<a name="l00027"></a><a class="code" href="../../d0/d1/obinit_8c.html#a0">00027</a> GENERIC_MAPPING <a class="code" href="../../d0/d1/obinit_8c.html#a0">ObpTypeMapping</a> = {
00028     STANDARD_RIGHTS_READ,
00029     STANDARD_RIGHTS_WRITE,
00030     STANDARD_RIGHTS_EXECUTE,
00031     OBJECT_TYPE_ALL_ACCESS
00032 };
00033 
<a name="l00034"></a><a class="code" href="../../d0/d1/obinit_8c.html#a1">00034</a> GENERIC_MAPPING <a class="code" href="../../d0/d1/obinit_8c.html#a1">ObpDirectoryMapping</a> = {
00035     STANDARD_RIGHTS_READ |
00036         DIRECTORY_QUERY |
00037         DIRECTORY_TRAVERSE,
00038     STANDARD_RIGHTS_WRITE |
00039         DIRECTORY_CREATE_OBJECT |
00040         DIRECTORY_CREATE_SUBDIRECTORY,
00041     STANDARD_RIGHTS_EXECUTE |
00042         DIRECTORY_QUERY |
00043         DIRECTORY_TRAVERSE,
00044     DIRECTORY_ALL_ACCESS
00045 };
00046 
<a name="l00047"></a><a class="code" href="../../d0/d1/obinit_8c.html#a2">00047</a> GENERIC_MAPPING <a class="code" href="../../d0/d1/obinit_8c.html#a2">ObpSymbolicLinkMapping</a> = {
00048     STANDARD_RIGHTS_READ |
00049         SYMBOLIC_LINK_QUERY,
00050     STANDARD_RIGHTS_WRITE,
00051     STANDARD_RIGHTS_EXECUTE |
00052         SYMBOLIC_LINK_QUERY,
00053     SYMBOLIC_LINK_ALL_ACCESS
00054 };
00055 
00056 <span class="comment">//</span>
00057 <span class="comment">//  Local procedure prototypes</span>
00058 <span class="comment">//</span>
00059 
00060 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00061 <a class="code" href="../../d0/d1/obinit_8c.html#a14">ObpCreateDosDevicesDirectory</a> (
00062     VOID
00063     );
00064 
00065 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00066 <a class="code" href="../../d0/d1/obinit_8c.html#a15">ObpGetDosDevicesProtection</a> (
00067     PSECURITY_DESCRIPTOR SecurityDescriptor
00068     );
00069 
00070 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00071 <a class="code" href="../../d0/d1/obinit_8c.html#a16">ObpFreeDosDevicesProtection</a> (
00072     PSECURITY_DESCRIPTOR SecurityDescriptor
00073     );
00074 
00075 
00076 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00077 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,ObInitSystem)</span>
00078 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,ObpCreateDosDevicesDirectory)</span>
00079 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,ObpGetDosDevicesProtection)</span>
00080 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,ObpFreeDosDevicesProtection)</span>
00081 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObKillProcess)</span>
00082 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00083 <span class="preprocessor"></span>
00084 <span class="comment">//</span>
00085 <span class="comment">//  The default quota block is setup by obinitsystem</span>
00086 <span class="comment">//</span>
00087 
<a name="l00088"></a><a class="code" href="../../d0/d1/obinit_8c.html#a3">00088</a> <span class="keyword">extern</span> <a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html">EPROCESS_QUOTA_BLOCK</a> <a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>;
00089 
00090 <span class="comment">//</span>
00091 <span class="comment">//  This is really a global variable used to coordinate access to</span>
00092 <span class="comment">//  the process object table.</span>
00093 <span class="comment">//</span>
00094 
<a name="l00095"></a><a class="code" href="../../d0/d1/obinit_8c.html#a4">00095</a> <a class="code" href="../../d3/d7/struct__KMUTANT.html">KMUTANT</a> <a class="code" href="../../d9/d0/obhandle_8c.html#a1">ObpInitKillMutant</a>;
00096 
00097 <span class="comment">//</span>
00098 <span class="comment">//  CurrentControlSet values set by code in config\cmdat3.c at system load time</span>
00099 <span class="comment">//  These are private variables within obinit.c</span>
00100 <span class="comment">//</span>
00101 
<a name="l00102"></a><a class="code" href="../../d0/d1/obinit_8c.html#a5">00102</a> ULONG <a class="code" href="../../d8/d0/cmdat3_8c.html#a14">ObpProtectionMode</a>;
<a name="l00103"></a><a class="code" href="../../d0/d1/obinit_8c.html#a6">00103</a> ULONG <a class="code" href="../../d8/d0/cmdat3_8c.html#a15">ObpAuditBaseDirectories</a>;
<a name="l00104"></a><a class="code" href="../../d0/d1/obinit_8c.html#a7">00104</a> ULONG <a class="code" href="../../d8/d0/cmdat3_8c.html#a16">ObpAuditBaseObjects</a>;
00105 
00106 <span class="comment">//</span>
00107 <span class="comment">//  These are global variables</span>
00108 <span class="comment">//</span>
00109 
<a name="l00110"></a><a class="code" href="../../d0/d1/obinit_8c.html#a8">00110</a> UNICODE_STRING <a class="code" href="../../d0/d1/obinit_8c.html#a8">ObpDosDevicesShortName</a>;
<a name="l00111"></a><a class="code" href="../../d0/d1/obinit_8c.html#a9">00111</a> ULARGE_INTEGER <a class="code" href="../../d0/d1/obinit_8c.html#a9">ObpDosDevicesShortNamePrefix</a>;
<a name="l00112"></a><a class="code" href="../../d0/d1/obinit_8c.html#a10">00112</a> ULARGE_INTEGER <a class="code" href="../../d0/d1/obinit_8c.html#a10">ObpDosDevicesShortNameRoot</a>;
<a name="l00113"></a><a class="code" href="../../d0/d1/obinit_8c.html#a11">00113</a> <a class="code" href="../../d2/d4/struct__DEVICE__MAP.html">PDEVICE_MAP</a> <a class="code" href="../../d4/d0/ob_8h.html#a41">ObSystemDeviceMap</a>;
00114 
00115 
00116 BOOLEAN
<a name="l00117"></a><a class="code" href="../../d0/d1/obinit_8c.html#a17">00117</a> <a class="code" href="../../d0/d1/obinit_8c.html#a17">ObInitSystem</a> (
00118     VOID
00119     )
00120 
00121 <span class="comment">/*++</span>
00122 <span class="comment"></span>
00123 <span class="comment">Routine Description:</span>
00124 <span class="comment"></span>
00125 <span class="comment">    This function performs the system initialization for the object</span>
00126 <span class="comment">    manager.  The object manager data structures are self describing</span>
00127 <span class="comment">    with the exception of the root directory, the type object type and</span>
00128 <span class="comment">    the directory object type.  The initialization code then constructs</span>
00129 <span class="comment">    these objects by hand to get the ball rolling.</span>
00130 <span class="comment"></span>
00131 <span class="comment">Arguments:</span>
00132 <span class="comment"></span>
00133 <span class="comment">    None.</span>
00134 <span class="comment"></span>
00135 <span class="comment">Return Value:</span>
00136 <span class="comment"></span>
00137 <span class="comment">    TRUE if successful and FALSE if an error occurred.</span>
00138 <span class="comment"></span>
00139 <span class="comment">    The following errors can occur:</span>
00140 <span class="comment"></span>
00141 <span class="comment">    - insufficient memory</span>
00142 <span class="comment"></span>
00143 <span class="comment">--*/</span>
00144 
00145 {
00146     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> CreateInfoMaxDepth;
00147     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> NameBufferMaxDepth;
00148     ULONG RegionSegmentSize;
00149     <a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html">OBJECT_TYPE_INITIALIZER</a> ObjectTypeInitializer;
00150     UNICODE_STRING TypeTypeName;
00151     UNICODE_STRING SymbolicLinkTypeName;
00152     UNICODE_STRING DosDevicesDirectoryName;
00153     UNICODE_STRING DirectoryTypeName;
00154     UNICODE_STRING RootDirectoryName;
00155     UNICODE_STRING TypeDirectoryName;
00156     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00157     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00158     HANDLE RootDirectoryHandle;
00159     HANDLE TypeDirectoryHandle;
00160     PLIST_ENTRY Next, Head;
00161     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectTypeHeader;
00162     <a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html">POBJECT_HEADER_CREATOR_INFO</a> CreatorInfo;
00163     <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a> NameInfo;
00164     <a class="code" href="../../d2/d1/mm_8h.html#a140">MM_SYSTEMSIZE</a> SystemSize;
00165     SECURITY_DESCRIPTOR AuditSd;
00166     PSECURITY_DESCRIPTOR EffectiveSd;
00167     PACL    AuditAllAcl;
00168     UCHAR   AuditAllBuffer[250];  <span class="comment">// Ample room for the ACL</span>
00169     ULONG   AuditAllLength;
00170     PACE_HEADER Ace;
00171     <a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">PNPAGED_LOOKASIDE_LIST</a> Lookaside;
00172     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00173     PKPRCB Prcb;
00174 
00175     <span class="comment">//</span>
00176     <span class="comment">//  Determine the the size of the object creation and the name buffer</span>
00177     <span class="comment">//  lookaside lists.</span>
00178     <span class="comment">//</span>
00179 
00180     SystemSize = <a class="code" href="../../d5/d1/mminit_8c.html#a57">MmQuerySystemSize</a>();
00181 
00182     <span class="keywordflow">if</span> (SystemSize == <a class="code" href="../../d2/d1/mm_8h.html#a343a167">MmLargeSystem</a>) {
00183 
00184         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/mminit_8c.html#a58">MmIsThisAnNtAsSystem</a>()) {
00185 
00186             CreateInfoMaxDepth = 64;
00187             NameBufferMaxDepth = 32;
00188 
00189         } <span class="keywordflow">else</span> {
00190 
00191             CreateInfoMaxDepth = 32;
00192             NameBufferMaxDepth = 16;
00193         }
00194 
00195     } <span class="keywordflow">else</span> {
00196 
00197         CreateInfoMaxDepth = 3;
00198         NameBufferMaxDepth = 3;
00199     }
00200 
00201     <span class="comment">//</span>
00202     <span class="comment">//  PHASE 0 Initialization</span>
00203     <span class="comment">//</span>
00204 
00205     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/init_8h.html#a21">InitializationPhase</a> == 0) {
00206 
00207         <span class="comment">//</span>
00208         <span class="comment">//  Initialize the object creation lookaside list.</span>
00209         <span class="comment">//</span>
00210 
00211         <a class="code" href="../../d5/d8/ex_8h.html#a246">ExInitializeNPagedLookasideList</a>( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a52">ObpCreateInfoLookasideList</a>,
00212                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00213                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00214                                          0,
00215                                          <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html">OBJECT_CREATE_INFORMATION</a>),
00216                                          'iCbO',
00217                                          CreateInfoMaxDepth );
00218 
00219         <span class="comment">//</span>
00220         <span class="comment">//  Initialize the name buffer lookaside list.</span>
00221         <span class="comment">//</span>
00222 
00223         <a class="code" href="../../d5/d8/ex_8h.html#a246">ExInitializeNPagedLookasideList</a>( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a53">ObpNameBufferLookasideList</a>,
00224                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00225                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00226                                          0,
00227                                          <a class="code" href="../../d5/d1/obp_8h.html#a23">OBJECT_NAME_BUFFER_SIZE</a>,
00228                                          'mNbO',
00229                                          NameBufferMaxDepth );
00230 
00231         <span class="comment">//</span>
00232         <span class="comment">//  Initialize the system create info and name buffer lookaside lists</span>
00233         <span class="comment">//  for the current processor.</span>
00234         <span class="comment">//</span>
00235         <span class="comment">// N.B. Temporarily during the initialization of the system both</span>
00236         <span class="comment">//      lookaside list pointers in the processor block point to</span>
00237         <span class="comment">//      the same lookaside list structure. Later in initialization</span>
00238         <span class="comment">//      another lookaside list structure is allocated and filled</span>
00239         <span class="comment">//      for the per processor list.</span>
00240         <span class="comment">//</span>
00241 
00242         Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00243         Prcb-&gt;PPLookasideList[<a class="code" href="../../d5/d8/ex_8h.html#a331a200">LookasideCreateInfoList</a>].L = &amp;<a class="code" href="../../d5/d1/obp_8h.html#a52">ObpCreateInfoLookasideList</a>;
00244         Prcb-&gt;PPLookasideList[<a class="code" href="../../d5/d8/ex_8h.html#a331a200">LookasideCreateInfoList</a>].P = &amp;<a class="code" href="../../d5/d1/obp_8h.html#a52">ObpCreateInfoLookasideList</a>;
00245         Prcb-&gt;PPLookasideList[<a class="code" href="../../d5/d8/ex_8h.html#a331a201">LookasideNameBufferList</a>].<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a> = &amp;<a class="code" href="../../d5/d1/obp_8h.html#a53">ObpNameBufferLookasideList</a>;
00246         Prcb-&gt;PPLookasideList[<a class="code" href="../../d5/d8/ex_8h.html#a331a201">LookasideNameBufferList</a>].P = &amp;<a class="code" href="../../d5/d1/obp_8h.html#a53">ObpNameBufferLookasideList</a>;
00247 
00248         <span class="comment">//</span>
00249         <span class="comment">//  Initialize the object removal queue listhead.</span>
00250         <span class="comment">//</span>
00251 
00252         <a class="code" href="../../d5/d1/obp_8h.html#a36">ObpRemoveObjectQueue</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00253 
00254         <span class="comment">//</span>
00255         <span class="comment">//  Initialize security descriptor cache</span>
00256         <span class="comment">//</span>
00257 
00258         <a class="code" href="../../d8/d1/obsdata_8c.html#a13">ObpInitSecurityDescriptorCache</a>();
00259 
00260         <a class="code" href="../../d3/d5/mutntobj_8c.html#a1">KeInitializeMutant</a>( &amp;<a class="code" href="../../d9/d0/obhandle_8c.html#a1">ObpInitKillMutant</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00261         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a34">ObpDefaultObject</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00262         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a33">ObpLock</a> );
00263         <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;GrantedAccess = PROCESS_ALL_ACCESS;
00264         <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;GrantedAccess = THREAD_ALL_ACCESS;
00265 
00266         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a37">ObpDeviceMapLock</a> );
00267 
00268         <span class="comment">//</span>
00269         <span class="comment">//  Initialize the quota block and have the eprocess structure</span>
00270         <span class="comment">//  point to it.</span>
00271         <span class="comment">//</span>
00272 
00273         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;<a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>.<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>);
00274         <a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>.<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o1">ReferenceCount</a> = 1;
00275         <a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>.<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o4">QuotaPoolLimit</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>] = (ULONG)-1;
00276         <a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>.<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o4">QuotaPoolLimit</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>] = (ULONG)-1;
00277         <a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>.<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o7">PagefileLimit</a> = (ULONG)-1;
00278 
00279         <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;QuotaBlock = &amp;<a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>;
00280 
00281         <span class="comment">//</span>
00282         <span class="comment">//  Initialize the handle table for the system process and also the global</span>
00283         <span class="comment">//  kernel handle table</span>
00284         <span class="comment">//</span>
00285 
00286         <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ObjectTable = <a class="code" href="../../d5/d8/ex_8h.html#a290">ExCreateHandleTable</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00287         <a class="code" href="../../d5/d1/obp_8h.html#a54">ObpKernelHandleTable</a> = <a class="code" href="../../d5/d8/ex_8h.html#a290">ExCreateHandleTable</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00288 
00289         <span class="comment">//</span>
00290         <span class="comment">//  Create an object type for the "Type" object.  This is the start of</span>
00291         <span class="comment">//  of the object types and goes in the ObpTypeDirectoryObject.</span>
00292         <span class="comment">//</span>
00293 
00294         RtlZeroMemory( &amp;ObjectTypeInitializer, <span class="keyword">sizeof</span>( ObjectTypeInitializer ) );
00295         ObjectTypeInitializer.Length = <span class="keyword">sizeof</span>( ObjectTypeInitializer );
00296         ObjectTypeInitializer.InvalidAttributes = OBJ_OPENLINK;
00297         ObjectTypeInitializer.PoolType = <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>;
00298 
00299         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;TypeTypeName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Type"</span> );
00300         ObjectTypeInitializer.ValidAccessMask = OBJECT_TYPE_ALL_ACCESS;
00301         ObjectTypeInitializer.GenericMapping = <a class="code" href="../../d0/d1/obinit_8c.html#a0">ObpTypeMapping</a>;
00302         ObjectTypeInitializer.DefaultNonPagedPoolCharge = <span class="keyword">sizeof</span>( <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">OBJECT_TYPE</a> );
00303         ObjectTypeInitializer.MaintainTypeList = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00304         ObjectTypeInitializer.UseDefaultObject = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00305         <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>( &amp;TypeTypeName,
00306                             &amp;ObjectTypeInitializer,
00307                             (PSECURITY_DESCRIPTOR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00308                             &amp;<a class="code" href="../../d8/d5/kddata_8c.html#a10">ObpTypeObjectType</a> );
00309 
00310         <span class="comment">//</span>
00311         <span class="comment">//  Create the object type for the "Directory" object.</span>
00312         <span class="comment">//</span>
00313 
00314         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;DirectoryTypeName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Directory"</span> );
00315         ObjectTypeInitializer.DefaultNonPagedPoolCharge = <span class="keyword">sizeof</span>( <a class="code" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">OBJECT_DIRECTORY</a> );
00316         ObjectTypeInitializer.ValidAccessMask = DIRECTORY_ALL_ACCESS;
00317         ObjectTypeInitializer.GenericMapping = <a class="code" href="../../d0/d1/obinit_8c.html#a1">ObpDirectoryMapping</a>;
00318         ObjectTypeInitializer.UseDefaultObject = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00319         ObjectTypeInitializer.MaintainTypeList = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00320         <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>( &amp;DirectoryTypeName,
00321                             &amp;ObjectTypeInitializer,
00322                             (PSECURITY_DESCRIPTOR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00323                             &amp;<a class="code" href="../../d5/d1/obp_8h.html#a42">ObpDirectoryObjectType</a> );
00324 
00325         <span class="comment">//</span>
00326         <span class="comment">//  Create the object type for the "SymbolicLink" object.</span>
00327         <span class="comment">//</span>
00328 
00329         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;SymbolicLinkTypeName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SymbolicLink"</span> );
00330         ObjectTypeInitializer.DefaultNonPagedPoolCharge = <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html">OBJECT_SYMBOLIC_LINK</a> );
00331         ObjectTypeInitializer.ValidAccessMask = SYMBOLIC_LINK_ALL_ACCESS;
00332         ObjectTypeInitializer.GenericMapping = <a class="code" href="../../d0/d1/obinit_8c.html#a2">ObpSymbolicLinkMapping</a>;
00333         ObjectTypeInitializer.DeleteProcedure = <a class="code" href="../../d4/d1/oblink_8c.html#a9">ObpDeleteSymbolicLink</a>;
00334         ObjectTypeInitializer.ParseProcedure = <a class="code" href="../../d4/d1/oblink_8c.html#a8">ObpParseSymbolicLink</a>;
00335         <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>( &amp;SymbolicLinkTypeName,
00336                             &amp;ObjectTypeInitializer,
00337                             (PSECURITY_DESCRIPTOR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00338                             &amp;<a class="code" href="../../d5/d1/obp_8h.html#a43">ObpSymbolicLinkObjectType</a> );
00339 
00340         <span class="comment">//</span>
00341         <span class="comment">//  Initialize the resource that protects the object name space directory structure</span>
00342         <span class="comment">//</span>
00343 
00344         <a class="code" href="../../d5/d8/ex_8h.html#a266">ExInitializeResourceLite</a>( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a50">ObpRootDirectoryMutex</a> );
00345 
00346 <span class="preprocessor">#if i386 &amp;&amp; !FPO</span>
00347 <span class="preprocessor"></span>
00348         <span class="comment">//</span>
00349         <span class="comment">//  Initialize the cached granted access structure.  These variables are used</span>
00350         <span class="comment">//  in place of the access mask in the object table entry.</span>
00351         <span class="comment">//</span>
00352 
00353         ObpCurCachedGrantedAccessIndex = 0;
00354         ObpMaxCachedGrantedAccessIndex = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> / <span class="keyword">sizeof</span>( ACCESS_MASK );
00355         ObpCachedGrantedAccesses = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>, 'gAbO' );
00356 
00357 <span class="preprocessor">#endif // i386 &amp;&amp; !FPO</span>
00358 <span class="preprocessor"></span>
00359     } <span class="comment">// End of Phase 0 Initialization</span>
00360 
00361 
00362     <span class="comment">//</span>
00363     <span class="comment">//  PHASE 1 Initialization</span>
00364     <span class="comment">//</span>
00365 
00366     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/init_8h.html#a21">InitializationPhase</a> == 1) {
00367 
00368         <span class="comment">//</span>
00369         <span class="comment">//  Initialize the per processor nonpaged lookaside lists and descriptors.</span>
00370         <span class="comment">//</span>
00371 
00372         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; (ULONG)<a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00373             Prcb = <a class="code" href="../../d4/d9/ke_8h.html#a139">KiProcessorBlock</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00374 
00375             <span class="comment">//</span>
00376             <span class="comment">//  Initialize the create information per processor lookaside pointers.</span>
00377             <span class="comment">//</span>
00378 
00379             Prcb-&gt;PPLookasideList[<a class="code" href="../../d5/d8/ex_8h.html#a331a200">LookasideCreateInfoList</a>].L = &amp;<a class="code" href="../../d5/d1/obp_8h.html#a52">ObpCreateInfoLookasideList</a>;
00380             Lookaside = (<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">PNPAGED_LOOKASIDE_LIST</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00381                                                                        <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a>),
00382                                                                        'ICbO');
00383 
00384             <span class="keywordflow">if</span> (Lookaside != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00385                 <a class="code" href="../../d5/d8/ex_8h.html#a246">ExInitializeNPagedLookasideList</a>( Lookaside,
00386                                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00387                                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00388                                                  0,
00389                                                  <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html">OBJECT_CREATE_INFORMATION</a>),
00390                                                  'ICbO',
00391                                                  CreateInfoMaxDepth );
00392 
00393             } <span class="keywordflow">else</span> {
00394                 Lookaside = &amp;<a class="code" href="../../d5/d1/obp_8h.html#a52">ObpCreateInfoLookasideList</a>;
00395             }
00396 
00397             Prcb-&gt;PPLookasideList[<a class="code" href="../../d5/d8/ex_8h.html#a331a200">LookasideCreateInfoList</a>].P = Lookaside;
00398 
00399             <span class="comment">//</span>
00400             <span class="comment">//  Initialize the name buffer per processor lookaside pointers.</span>
00401             <span class="comment">//</span>
00402 
00403             Prcb-&gt;PPLookasideList[<a class="code" href="../../d5/d8/ex_8h.html#a331a201">LookasideNameBufferList</a>].<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a> = &amp;<a class="code" href="../../d5/d1/obp_8h.html#a53">ObpNameBufferLookasideList</a>;
00404             Lookaside = (<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">PNPAGED_LOOKASIDE_LIST</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00405                                                                        <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d8/ex_8h.html#a104">NPAGED_LOOKASIDE_LIST</a>),
00406                                                                        'MNbO');
00407 
00408             <span class="keywordflow">if</span> (Lookaside != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00409                 <a class="code" href="../../d5/d8/ex_8h.html#a246">ExInitializeNPagedLookasideList</a>( Lookaside,
00410                                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00411                                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00412                                                  0,
00413                                                  <a class="code" href="../../d5/d1/obp_8h.html#a23">OBJECT_NAME_BUFFER_SIZE</a>,
00414                                                  'MNbO',
00415                                                  NameBufferMaxDepth);
00416 
00417             } <span class="keywordflow">else</span> {
00418                 Lookaside = &amp;<a class="code" href="../../d5/d1/obp_8h.html#a53">ObpNameBufferLookasideList</a>;
00419             }
00420 
00421             Prcb-&gt;PPLookasideList[<a class="code" href="../../d5/d8/ex_8h.html#a331a201">LookasideNameBufferList</a>].P = Lookaside;
00422         }
00423 
00424         EffectiveSd = <a class="code" href="../../d0/d5/se_8h.html#a68">SePublicDefaultUnrestrictedSd</a>;
00425 
00426         <span class="comment">//</span>
00427         <span class="comment">//  This code is only executed if base auditing is turned on.</span>
00428         <span class="comment">//</span>
00429 
00430         <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d0/cmdat3_8c.html#a15">ObpAuditBaseDirectories</a> != 0) || (<a class="code" href="../../d8/d0/cmdat3_8c.html#a16">ObpAuditBaseObjects</a> != 0)) {
00431 
00432             <span class="comment">//</span>
00433             <span class="comment">//  build an SACL to audit</span>
00434             <span class="comment">//</span>
00435 
00436             AuditAllAcl = (PACL)AuditAllBuffer;
00437             AuditAllLength = (ULONG)<span class="keyword">sizeof</span>(ACL) +
00438                                ((ULONG)<span class="keyword">sizeof</span>(SYSTEM_AUDIT_ACE)) +
00439                                <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(<a class="code" href="../../d0/d5/se_8h.html#a42">SeWorldSid</a>);
00440 
00441             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <span class="keyword">sizeof</span>(AuditAllBuffer)   &gt;   AuditAllLength );
00442 
00443             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( AuditAllAcl, AuditAllLength, ACL_REVISION2);
00444 
00445             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
00446 
00447             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a20">RtlAddAuditAccessAce</a> ( AuditAllAcl,
00448                                             ACL_REVISION2,
00449                                             GENERIC_ALL,
00450                                             <a class="code" href="../../d0/d5/se_8h.html#a42">SeWorldSid</a>,
00451                                             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ); <span class="comment">//Audit success and failure</span>
00452             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
00453 
00454             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a12">RtlGetAce</a>( AuditAllAcl, 0,  (PVOID)&amp;Ace );
00455 
00456             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
00457 
00458             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a15">ObpAuditBaseDirectories</a> != 0) {
00459 
00460                 Ace-&gt;AceFlags |= (CONTAINER_INHERIT_ACE | INHERIT_ONLY_ACE);
00461             }
00462 
00463             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a16">ObpAuditBaseObjects</a> != 0) {
00464 
00465                 Ace-&gt;AceFlags |= (OBJECT_INHERIT_ACE    |
00466                                   CONTAINER_INHERIT_ACE |
00467                                   INHERIT_ONLY_ACE);
00468             }
00469 
00470             <span class="comment">//</span>
00471             <span class="comment">//  Now create a security descriptor that looks just like</span>
00472             <span class="comment">//  the public default, but has auditing in it as well.</span>
00473             <span class="comment">//</span>
00474 
00475             EffectiveSd = (PSECURITY_DESCRIPTOR)&amp;AuditSd;
00476             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>( EffectiveSd,
00477                                                   SECURITY_DESCRIPTOR_REVISION1 );
00478 
00479             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
00480 
00481             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a>( EffectiveSd,
00482                                                    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,        <span class="comment">// DaclPresent</span>
00483                                                    <a class="code" href="../../d0/d5/se_8h.html#a74">SePublicDefaultUnrestrictedDacl</a>,
00484                                                    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );     <span class="comment">// DaclDefaulted</span>
00485 
00486             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
00487 
00488             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a62">RtlSetSaclSecurityDescriptor</a>( EffectiveSd,
00489                                                    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,        <span class="comment">// DaclPresent</span>
00490                                                    AuditAllAcl,
00491                                                    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );     <span class="comment">// DaclDefaulted</span>
00492 
00493             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
00494         }
00495 
00496         <span class="comment">//</span>
00497         <span class="comment">//  We only need to use the EffectiveSd on the root.  The SACL</span>
00498         <span class="comment">//  will be inherited by all other objects.</span>
00499         <span class="comment">//</span>
00500 
00501         <span class="comment">//</span>
00502         <span class="comment">//  Create an directory object for the root directory</span>
00503         <span class="comment">//</span>
00504 
00505         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;RootDirectoryName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\"</span> );
00506 
00507         InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00508                                     &amp;RootDirectoryName,
00509                                     OBJ_CASE_INSENSITIVE |
00510                                     OBJ_PERMANENT,
00511                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00512                                     EffectiveSd );
00513 
00514         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d0/obdir_8c.html#a0">NtCreateDirectoryObject</a>( &amp;RootDirectoryHandle,
00515                                           DIRECTORY_ALL_ACCESS,
00516                                           &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a> );
00517 
00518         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00519 
00520             <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00521         }
00522 
00523         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( RootDirectoryHandle,
00524                                             0,
00525                                             <a class="code" href="../../d5/d1/obp_8h.html#a42">ObpDirectoryObjectType</a>,
00526                                             <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00527                                             (PVOID *)&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a9">ObpRootDirectoryObject</a>,
00528                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00529 
00530         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00531 
00532             <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00533         }
00534 
00535         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( RootDirectoryHandle );
00536 
00537         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00538 
00539             <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00540         }
00541 
00542         <span class="comment">//</span>
00543         <span class="comment">//  Create an directory object for the directory of object types</span>
00544         <span class="comment">//</span>
00545 
00546         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;TypeDirectoryName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\ObjectTypes"</span> );
00547 
00548         InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00549                                     &amp;TypeDirectoryName,
00550                                     OBJ_CASE_INSENSITIVE |
00551                                     OBJ_PERMANENT,
00552                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00553                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00554 
00555         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d0/obdir_8c.html#a0">NtCreateDirectoryObject</a>( &amp;TypeDirectoryHandle,
00556                                           DIRECTORY_ALL_ACCESS,
00557                                           &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a> );
00558 
00559         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00560 
00561             <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00562         }
00563 
00564         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( TypeDirectoryHandle,
00565                                             0,
00566                                             <a class="code" href="../../d5/d1/obp_8h.html#a42">ObpDirectoryObjectType</a>,
00567                                             <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00568                                             (PVOID *)&amp;<a class="code" href="../../d5/d1/obp_8h.html#a46">ObpTypeDirectoryObject</a>,
00569                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00570 
00571         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00572 
00573             <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00574         }
00575 
00576         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( TypeDirectoryHandle );
00577 
00578         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00579 
00580             <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00581         }
00582 
00583         <span class="comment">//</span>
00584         <span class="comment">//  Lock the object directory name space</span>
00585         <span class="comment">//</span>
00586 
00587         <a class="code" href="../../d5/d1/obp_8h.html#a10">ObpEnterRootDirectoryMutex</a>();
00588 
00589         <span class="comment">//</span>
00590         <span class="comment">//  For every object type that has already been created we will</span>
00591         <span class="comment">//  insert it in the type directory.  We do this looking down the</span>
00592         <span class="comment">//  linked list of type objects and for every one that has a name</span>
00593         <span class="comment">//  and isn't already in a directory we'll look the name up and</span>
00594         <span class="comment">//  then put it in the directory.  Be sure to skip the first</span>
00595         <span class="comment">//  entry in the type object types lists.</span>
00596         <span class="comment">//</span>
00597 
00598         Head = &amp;<a class="code" href="../../d8/d5/kddata_8c.html#a10">ObpTypeObjectType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o1">TypeList</a>;
00599         Next = Head-&gt;Flink;
00600 
00601         <span class="keywordflow">while</span> (Next != Head) {
00602 
00603             <span class="comment">//</span>
00604             <span class="comment">//  Right after the creator info is the object header.  Get\</span>
00605             <span class="comment">//  the object header and then see if there is a name</span>
00606             <span class="comment">//</span>
00607 
00608             CreatorInfo = CONTAINING_RECORD( Next,
00609                                              <a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html">OBJECT_HEADER_CREATOR_INFO</a>,
00610                                              TypeList );
00611 
00612             ObjectTypeHeader = (<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a>)(CreatorInfo+1);
00613 
00614             NameInfo = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>( ObjectTypeHeader );
00615 
00616             <span class="comment">//</span>
00617             <span class="comment">//  Check if we have a name and we're not in a directory</span>
00618             <span class="comment">//</span>
00619 
00620 
00621             <span class="keywordflow">if</span> ((NameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00622 
00623                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d1/obp_8h.html#a68">ObpLookupDirectoryEntry</a>( <a class="code" href="../../d5/d1/obp_8h.html#a46">ObpTypeDirectoryObject</a>,
00624                                               &amp;NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>,
00625                                               OBJ_CASE_INSENSITIVE )) {
00626 
00627                     <a class="code" href="../../d5/d1/obp_8h.html#a69">ObpInsertDirectoryEntry</a>( <a class="code" href="../../d5/d1/obp_8h.html#a46">ObpTypeDirectoryObject</a>,
00628                                              &amp;ObjectTypeHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o11">Body</a> );
00629                 }
00630             }
00631 
00632             Next = Next-&gt;Flink;
00633         }
00634 
00635         <span class="comment">//</span>
00636         <span class="comment">//  Unlock the object directory name space</span>
00637         <span class="comment">//</span>
00638 
00639         <a class="code" href="../../d5/d1/obp_8h.html#a11">ObpLeaveRootDirectoryMutex</a>();
00640 
00641         <span class="comment">//</span>
00642         <span class="comment">//  Create \DosDevices object directory for drive letters and Win32 device names</span>
00643         <span class="comment">//</span>
00644 
00645         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d1/obinit_8c.html#a14">ObpCreateDosDevicesDirectory</a>();
00646 
00647         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00648 
00649             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00650         }
00651     }
00652 
00653     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00654 }
00655 
00656 
00657 BOOLEAN
<a name="l00658"></a><a class="code" href="../../d0/d1/obinit_8c.html#a18">00658</a> <a class="code" href="../../d0/d1/obinit_8c.html#a18">ObDupHandleProcedure</a> (
00659     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00660     <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> ObjectTableEntry
00661     )
00662 
00663 <span class="comment">/*++</span>
00664 <span class="comment"></span>
00665 <span class="comment">Routine Description:</span>
00666 <span class="comment"></span>
00667 <span class="comment">    This is the worker routine for ExDupHandleTable and</span>
00668 <span class="comment">    is invoked via ObInitProcess.</span>
00669 <span class="comment"></span>
00670 <span class="comment">Arguments:</span>
00671 <span class="comment"></span>
00672 <span class="comment">    Process - Supplies a pointer to the new process</span>
00673 <span class="comment"></span>
00674 <span class="comment">    ObjectTableEntry - Supplies a pointer to the newly</span>
00675 <span class="comment">        created handle table entry</span>
00676 <span class="comment"></span>
00677 <span class="comment">Return Value:</span>
00678 <span class="comment"></span>
00679 <span class="comment">    TRUE if the item can be inserted in the new table</span>
00680 <span class="comment">        and FALSE otherwise</span>
00681 <span class="comment"></span>
00682 <span class="comment">--*/</span>
00683 
00684 {
00685     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00686     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00687     PVOID Object;
00688     <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">ACCESS_STATE</a> AccessState;
00689 
00690     <span class="comment">//</span>
00691     <span class="comment">//  If the object table should not inherited then return false</span>
00692     <span class="comment">//</span>
00693 
00694     <span class="keywordflow">if</span> (!(ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o1">ObAttributes</a> &amp; OBJ_INHERIT)) {
00695 
00696         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00697     }
00698 
00699     <span class="comment">//</span>
00700     <span class="comment">//  Get a pointer to the object header and body</span>
00701     <span class="comment">//</span>
00702 
00703     ObjectHeader = (<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a>)(((ULONG_PTR)(ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a>)) &amp; ~<a class="code" href="../../d5/d1/obp_8h.html#a17">OBJ_HANDLE_ATTRIBUTES</a>);
00704 
00705     Object = &amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o11">Body</a>;
00706 
00707     <span class="comment">//</span>
00708     <span class="comment">//  If we are tracing the call stacks for cached security indices then we do got a</span>
00709     <span class="comment">//  translation to do otherwise the table entry contains straight away the granted</span>
00710     <span class="comment">//  access mask</span>
00711     <span class="comment">//</span>
00712 
00713 <span class="preprocessor">#if i386 &amp;&amp; !FPO</span>
00714 <span class="preprocessor"></span>
00715     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_KERNEL_STACK_TRACE_DB) {
00716 
00717         AccessState.<a class="code" href="../../d2/d5/struct__ACCESS__STATE.html#o7">PreviouslyGrantedAccess</a> = ObpTranslateGrantedAccessIndex( ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o3">GrantedAccessIndex</a> );
00718 
00719     } <span class="keywordflow">else</span> {
00720 
00721         AccessState.<a class="code" href="../../d2/d5/struct__ACCESS__STATE.html#o7">PreviouslyGrantedAccess</a> = ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a>;
00722     }
00723 
00724 <span class="preprocessor">#else</span>
00725 <span class="preprocessor"></span>
00726     AccessState.<a class="code" href="../../d2/d5/struct__ACCESS__STATE.html#o7">PreviouslyGrantedAccess</a> = ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a>;
00727 
00728 <span class="preprocessor">#endif // i386 &amp;&amp; !FPO</span>
00729 <span class="preprocessor"></span>
00730     <span class="comment">//</span>
00731     <span class="comment">//  Increment the handle count on the object because we've just added</span>
00732     <span class="comment">//  another handle to it.</span>
00733     <span class="comment">//</span>
00734 
00735     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a77">ObpIncrementHandleCount</a>( <a class="code" href="../../d4/d0/ob_8h.html#a100a61">ObInheritHandle</a>,
00736                                       Process,
00737                                       Object,
00738                                       ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>,
00739                                       &amp;AccessState,
00740                                       <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,     <span class="comment">// BUGBUG this is probably wrong</span>
00741                                       0 );
00742 
00743     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00744 
00745         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00746     }
00747 
00748     <span class="comment">//</span>
00749     <span class="comment">//  Likewise we need to increment the pointer count to the object</span>
00750     <span class="comment">//</span>
00751 
00752     <a class="code" href="../../d5/d1/obp_8h.html#a3">ObpIncrPointerCount</a>( ObjectHeader );
00753 
00754     <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00755 }
00756 
00757 
00758 BOOLEAN
<a name="l00759"></a><a class="code" href="../../d0/d1/obinit_8c.html#a19">00759</a> <a class="code" href="../../d0/d1/obinit_8c.html#a19">ObAuditInheritedHandleProcedure</a> (
00760     IN <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> ObjectTableEntry,
00761     IN HANDLE HandleId,
00762     IN PVOID EnumParameter
00763     )
00764 
00765 <span class="comment">/*++</span>
00766 <span class="comment"></span>
00767 <span class="comment">Routine Description:</span>
00768 <span class="comment"></span>
00769 <span class="comment">    ExEnumHandleTable worker routine to generate audits when handles are</span>
00770 <span class="comment">    inherited.  An audit is generated if the handle attributes indicate</span>
00771 <span class="comment">    that the handle is to be audited on close.</span>
00772 <span class="comment"></span>
00773 <span class="comment">Arguments:</span>
00774 <span class="comment"></span>
00775 <span class="comment">    ObjectTableEntry - Points to the handle table entry of interest.</span>
00776 <span class="comment"></span>
00777 <span class="comment">    HandleId - Supplies the handle.</span>
00778 <span class="comment"></span>
00779 <span class="comment">    EnumParameter - Supplies information about the source and target processes.</span>
00780 <span class="comment"></span>
00781 <span class="comment">Return Value:</span>
00782 <span class="comment"></span>
00783 <span class="comment">    FALSE, which tells ExEnumHandleTable to continue iterating through the</span>
00784 <span class="comment">    handle table.</span>
00785 <span class="comment"></span>
00786 <span class="comment">--*/</span>
00787 
00788 {
00789     <a class="code" href="../../d3/d0/struct__SE__PROCESS__AUDIT__INFO.html">PSE_PROCESS_AUDIT_INFO</a> ProcessAuditInfo = EnumParameter;
00790 
00791     <span class="comment">//</span>
00792     <span class="comment">//  Check if we have to do an audit</span>
00793     <span class="comment">//</span>
00794 
00795     <span class="keywordflow">if</span> (!(ObjectTableEntry-&gt;ObAttributes &amp; <a class="code" href="../../d7/d7/ntapi_8c.html#a2">OBJ_AUDIT_OBJECT_CLOSE</a>)) {
00796 
00797         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00798     }
00799 
00800     <span class="comment">//</span>
00801     <span class="comment">//  Do the audit then return for more</span>
00802     <span class="comment">//</span>
00803 
00804     <a class="code" href="../../d7/d6/sepaudit_8c.html#a20">SeAuditHandleDuplication</a>( HandleId,
00805                               HandleId,
00806                               ProcessAuditInfo-&gt;<a class="code" href="../../d3/d0/struct__SE__PROCESS__AUDIT__INFO.html#o1">Parent</a>,
00807                               ProcessAuditInfo-&gt;<a class="code" href="../../d3/d0/struct__SE__PROCESS__AUDIT__INFO.html#o0">Process</a> );
00808 
00809     <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00810 }
00811 
00812 
00813 
00814 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00815"></a><a class="code" href="../../d0/d1/obinit_8c.html#a20">00815</a> <a class="code" href="../../d0/d1/obinit_8c.html#a20">ObInitProcess</a> (
00816     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ParentProcess OPTIONAL,
00817     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> NewProcess
00818     )
00819 
00820 <span class="comment">/*++</span>
00821 <span class="comment"></span>
00822 <span class="comment">Routine Description:</span>
00823 <span class="comment"></span>
00824 <span class="comment">    This function initializes a process object table.  If the ParentProcess</span>
00825 <span class="comment">    is specified, then all object handles with the OBJ_INHERIT attribute are</span>
00826 <span class="comment">    copied from the parent object table to the new process' object table.</span>
00827 <span class="comment">    The HandleCount field of each object copied is incremented by one.  Both</span>
00828 <span class="comment">    object table mutexes remained locked for the duration of the copy</span>
00829 <span class="comment">    operation.</span>
00830 <span class="comment"></span>
00831 <span class="comment">Arguments:</span>
00832 <span class="comment"></span>
00833 <span class="comment">    ParentProcess - optional pointer to a process object that is the</span>
00834 <span class="comment">        parent process to inherit object handles from.</span>
00835 <span class="comment"></span>
00836 <span class="comment">    NewProcess - pointer to the process object being initialized.</span>
00837 <span class="comment"></span>
00838 <span class="comment">Return Value:</span>
00839 <span class="comment"></span>
00840 <span class="comment">    Status code.</span>
00841 <span class="comment"></span>
00842 <span class="comment">    The following errors can occur:</span>
00843 <span class="comment"></span>
00844 <span class="comment">    - insufficient memory</span>
00845 <span class="comment"></span>
00846 <span class="comment">--*/</span>
00847 
00848 {
00849     <a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> OldObjectTable;
00850     <a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> NewObjectTable;
00851     ULONG PoolCharges[ <a class="code" href="../../d5/d8/ex_8h.html#a329a180">MaxPoolType</a> ];
00852     <a class="code" href="../../d3/d0/struct__SE__PROCESS__AUDIT__INFO.html">SE_PROCESS_AUDIT_INFO</a> ProcessAuditInfo;
00853 
00854     RtlZeroMemory( PoolCharges, <span class="keyword">sizeof</span>( PoolCharges ) );
00855 
00856     <span class="comment">//</span>
00857     <span class="comment">//  If we have a parent process then we need to lock it down</span>
00858     <span class="comment">//  check that it is not going away and then make a copy</span>
00859     <span class="comment">//  of its handle table.  If there isn't a parent then</span>
00860     <span class="comment">//  we'll start with an empty handle table.</span>
00861     <span class="comment">//</span>
00862 
00863     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ParentProcess )) {
00864 
00865         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00866         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;<a class="code" href="../../d9/d0/obhandle_8c.html#a1">ObpInitKillMutant</a>,
00867                                <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
00868                                <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00869                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00870                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00871 
00872         OldObjectTable = ParentProcess-&gt;ObjectTable;
00873 
00874         <span class="keywordflow">if</span> ( !OldObjectTable ) {
00875 
00876             <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a>( &amp;<a class="code" href="../../d9/d0/obhandle_8c.html#a1">ObpInitKillMutant</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00877             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00878 
00879             <span class="keywordflow">return</span> STATUS_PROCESS_IS_TERMINATING;
00880         }
00881 
00882         NewObjectTable = <a class="code" href="../../d5/d8/ex_8h.html#a294">ExDupHandleTable</a>( NewProcess,
00883                                            OldObjectTable,
00884                                            <a class="code" href="../../d0/d1/obinit_8c.html#a18">ObDupHandleProcedure</a> );
00885 
00886     } <span class="keywordflow">else</span> {
00887 
00888         OldObjectTable = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00889         NewObjectTable = <a class="code" href="../../d5/d8/ex_8h.html#a290">ExCreateHandleTable</a>( NewProcess );
00890     }
00891 
00892     <span class="comment">//</span>
00893     <span class="comment">//  Check that we really have a new handle table otherwise</span>
00894     <span class="comment">//  we must be out of resources</span>
00895     <span class="comment">//</span>
00896 
00897     <span class="keywordflow">if</span> (NewObjectTable) {
00898 
00899         <span class="comment">//</span>
00900         <span class="comment">//  Set the new processes object table and if we are</span>
00901         <span class="comment">//  auditing then enumerate the new table calling</span>
00902         <span class="comment">//  the audit procedure</span>
00903         <span class="comment">//</span>
00904 
00905         NewProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o20">ObjectTable</a> = NewObjectTable;
00906 
00907         <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d5/se_8h.html#a106">SeDetailedAuditing</a> ) {
00908 
00909             ProcessAuditInfo.<a class="code" href="../../d3/d0/struct__SE__PROCESS__AUDIT__INFO.html#o0">Process</a> = NewProcess;
00910             ProcessAuditInfo.<a class="code" href="../../d3/d0/struct__SE__PROCESS__AUDIT__INFO.html#o1">Parent</a>  = ParentProcess;
00911 
00912             <a class="code" href="../../d5/d8/ex_8h.html#a293">ExEnumHandleTable</a>( NewObjectTable,
00913                                <a class="code" href="../../d0/d1/obinit_8c.html#a19">ObAuditInheritedHandleProcedure</a>,
00914                                (PVOID)&amp;ProcessAuditInfo,
00915                                (PHANDLE)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00916         }
00917 
00918         <span class="comment">//</span>
00919         <span class="comment">//  Free the old table if it exists and then</span>
00920         <span class="comment">//  return our caller</span>
00921         <span class="comment">//</span>
00922 
00923         <span class="keywordflow">if</span> ( OldObjectTable ) {
00924 
00925             <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a>( &amp;<a class="code" href="../../d9/d0/obhandle_8c.html#a1">ObpInitKillMutant</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00926             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00927         }
00928 
00929         <span class="keywordflow">return</span>( STATUS_SUCCESS );
00930 
00931     } <span class="keywordflow">else</span> {
00932 
00933         <span class="comment">//</span>
00934         <span class="comment">//  We're out of resources to null out the new object table field,</span>
00935         <span class="comment">//  unlock the old object table, and tell our caller that this</span>
00936         <span class="comment">//  didn't work</span>
00937         <span class="comment">//</span>
00938 
00939         NewProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o20">ObjectTable</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00940 
00941         <span class="keywordflow">if</span> ( OldObjectTable ) {
00942 
00943             <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a>( &amp;<a class="code" href="../../d9/d0/obhandle_8c.html#a1">ObpInitKillMutant</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00944             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00945         }
00946 
00947         <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
00948     }
00949 }
00950 
00951 
00952 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00953"></a><a class="code" href="../../d0/d1/obinit_8c.html#a21">00953</a> <a class="code" href="../../d0/d1/obinit_8c.html#a21">ObInitProcess2</a> (
00954     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> NewProcess
00955     )
00956 
00957 <span class="comment">/*++</span>
00958 <span class="comment"></span>
00959 <span class="comment">Routine Description:</span>
00960 <span class="comment"></span>
00961 <span class="comment">    This function is called after an image file has been mapped into the address</span>
00962 <span class="comment">    space of a newly created process.  Allows the object manager to set LIFO/FIFO</span>
00963 <span class="comment">    ordering for handle allocation based on the SubSystemVersion number in the</span>
00964 <span class="comment">    image.</span>
00965 <span class="comment"></span>
00966 <span class="comment">Arguments:</span>
00967 <span class="comment"></span>
00968 <span class="comment">    NewProcess - pointer to the process object being initialized.</span>
00969 <span class="comment"></span>
00970 <span class="comment">Return Value:</span>
00971 <span class="comment"></span>
00972 <span class="comment">    None.</span>
00973 <span class="comment"></span>
00974 <span class="comment">--*/</span>
00975 
00976 {
00977     <span class="comment">//</span>
00978     <span class="comment">//  Set LIFO ordering of handles for images &lt;= SubSystemVersion 3.50</span>
00979     <span class="comment">//</span>
00980 
00981     <span class="keywordflow">if</span> (NewProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o20">ObjectTable</a>) {
00982 
00983         <a class="code" href="../../d5/d8/ex_8h.html#a78">ExSetHandleTableOrder</a>( NewProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o20">ObjectTable</a>, (BOOLEAN)(NewProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o71">SubSystemVersion</a> &lt;= 0x332) );
00984     }
00985 
00986     <span class="keywordflow">return</span>;
00987 }
00988 
00989 
00990 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00991"></a><a class="code" href="../../d0/d1/obinit_8c.html#a22">00991</a> <a class="code" href="../../d0/d1/obinit_8c.html#a22">ObDestroyHandleProcedure</a> (
00992     IN HANDLE HandleIndex
00993     )
00994 
00995 <span class="comment">/*++</span>
00996 <span class="comment"></span>
00997 <span class="comment">Routine Description:</span>
00998 <span class="comment"></span>
00999 <span class="comment">    This function is used to close a handle but takes as input a</span>
01000 <span class="comment">    handle table index that it first translates to an handle</span>
01001 <span class="comment">    before calling close.  Note that the handle index is really</span>
01002 <span class="comment">    just the offset within the handle table entries.</span>
01003 <span class="comment"></span>
01004 <span class="comment">Arguments:</span>
01005 <span class="comment"></span>
01006 <span class="comment">    HandleIndex - Supplies a handle index for the handle being closed.</span>
01007 <span class="comment"></span>
01008 <span class="comment">Return Value:</span>
01009 <span class="comment"></span>
01010 <span class="comment">    None.</span>
01011 <span class="comment"></span>
01012 <span class="comment">--*/</span>
01013 
01014 {
01015     ZwClose( HandleIndex );
01016 
01017     <span class="keywordflow">return</span>;
01018 }
01019 
01020 
01021 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01022"></a><a class="code" href="../../d0/d1/obinit_8c.html#a23">01022</a> <a class="code" href="../../d0/d1/obinit_8c.html#a23">ObKillProcess</a> (
01023     BOOLEAN AcquireLock,
01024     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
01025     )
01026 <span class="comment">/*++</span>
01027 <span class="comment"></span>
01028 <span class="comment">Routine Description:</span>
01029 <span class="comment"></span>
01030 <span class="comment">    This function is called whenever a process is destroyed.  It loops over</span>
01031 <span class="comment">    the process' object table and closes all the handles.</span>
01032 <span class="comment"></span>
01033 <span class="comment">Arguments:</span>
01034 <span class="comment"></span>
01035 <span class="comment">    AcquireLock - TRUE if there are other pointers to this process and therefore</span>
01036 <span class="comment">        this operation needs to be synchronized.  False if this is being called</span>
01037 <span class="comment">        from the Process delete routine and therefore this is the only pointer</span>
01038 <span class="comment">        to the process.</span>
01039 <span class="comment"></span>
01040 <span class="comment">    Process - Pointer to the process that is being destroyed.</span>
01041 <span class="comment"></span>
01042 <span class="comment">Return Value:</span>
01043 <span class="comment"></span>
01044 <span class="comment">    None.</span>
01045 <span class="comment"></span>
01046 <span class="comment">--*/</span>
01047 
01048 {
01049     PVOID ObjectTable;
01050     BOOLEAN PreviousIOHardError;
01051 
01052     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01053 
01054     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>( <span class="stringliteral">"ObKillProcess"</span> );
01055 
01056     <span class="comment">//</span>
01057     <span class="comment">//  Check if we need to get the lock</span>
01058     <span class="comment">//</span>
01059 
01060     <span class="keywordflow">if</span> (AcquireLock) {
01061 
01062         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01063 
01064         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;<a class="code" href="../../d9/d0/obhandle_8c.html#a1">ObpInitKillMutant</a>,
01065                                <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
01066                                <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01067                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01068                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01069     }
01070 
01071     <span class="comment">//</span>
01072     <span class="comment">//  If the process does NOT have an object table, return</span>
01073     <span class="comment">//</span>
01074 
01075     ObjectTable = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o20">ObjectTable</a>;
01076 
01077     <span class="keywordflow">if</span> (ObjectTable != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01078         
01079         PreviousIOHardError = <a class="code" href="../../d4/d6/iosubs_8c.html#a108">IoSetThreadHardErrorMode</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>); 
01080         
01081         <span class="comment">//</span>
01082         <span class="comment">//  For each valid entry in the object table, close the handle</span>
01083         <span class="comment">//  that points to that entry.</span>
01084         <span class="comment">//</span>
01085 
01086         <a class="code" href="../../d5/d8/ex_8h.html#a292">ExDestroyHandleTable</a>( ObjectTable, <a class="code" href="../../d0/d1/obinit_8c.html#a22">ObDestroyHandleProcedure</a> );
01087 
01088         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o20">ObjectTable</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01089         
01090         <a class="code" href="../../d4/d6/iosubs_8c.html#a108">IoSetThreadHardErrorMode</a>( PreviousIOHardError ); 
01091     }
01092 
01093     <span class="comment">//</span>
01094     <span class="comment">//  Release the lock</span>
01095     <span class="comment">//</span>
01096 
01097     <span class="keywordflow">if</span> (AcquireLock) {
01098 
01099         <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a>( &amp;<a class="code" href="../../d9/d0/obhandle_8c.html#a1">ObpInitKillMutant</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01100 
01101         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01102     }
01103 
01104     <span class="comment">//</span>
01105     <span class="comment">//  And return to our caller</span>
01106     <span class="comment">//</span>
01107 
01108     <span class="keywordflow">return</span>;
01109 }
01110 
01111 
01112 <span class="comment">//</span>
01113 <span class="comment">//  The following structure is only used by the enumeration routine</span>
01114 <span class="comment">//  and the callback.  It provides context for the comparison of</span>
01115 <span class="comment">//  the objects.</span>
01116 <span class="comment">//</span>
01117 
<a name="l01118"></a><a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html">01118</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html">_OBP_FIND_HANDLE_DATA</a> {
01119 
<a name="l01120"></a><a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html#o0">01120</a>     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> <a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html#o0">ObjectHeader</a>;
<a name="l01121"></a><a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html#o1">01121</a>     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html#o1">ObjectType</a>;
<a name="l01122"></a><a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html#o2">01122</a>     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">POBJECT_HANDLE_INFORMATION</a> <a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html#o2">HandleInformation</a>;
01123 
01124 } <a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html">OBP_FIND_HANDLE_DATA</a>, *<a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html">POBP_FIND_HANDLE_DATA</a>;
01125 
01126 BOOLEAN
<a name="l01127"></a><a class="code" href="../../d0/d1/obinit_8c.html#a24">01127</a> <a class="code" href="../../d0/d1/obinit_8c.html#a24">ObpEnumFindHandleProcedure</a> (
01128     <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> ObjectTableEntry,
01129     HANDLE HandleId,
01130     PVOID EnumParameter
01131     )
01132 
01133 <span class="comment">/*++</span>
01134 <span class="comment"></span>
01135 <span class="comment">Routine Description:</span>
01136 <span class="comment"></span>
01137 <span class="comment">    Call back routine when enumerating an object table to find a handle</span>
01138 <span class="comment">    for a particular object</span>
01139 <span class="comment"></span>
01140 <span class="comment">Arguments:</span>
01141 <span class="comment"></span>
01142 <span class="comment">    HandleTableEntry - Supplies a pointer to the handle table entry</span>
01143 <span class="comment">        being examined.</span>
01144 <span class="comment"></span>
01145 <span class="comment">    HandleId - Supplies the actual handle value for the preceding entry</span>
01146 <span class="comment"></span>
01147 <span class="comment">    EnumParameter - Supplies context for the matching.</span>
01148 <span class="comment"></span>
01149 <span class="comment">Return Value:</span>
01150 <span class="comment"></span>
01151 <span class="comment">    Returns TRUE if a match is found and the enumeration should stop.  Returns FALSE</span>
01152 <span class="comment">    otherwise, so the enumeration will continue.</span>
01153 <span class="comment"></span>
01154 <span class="comment">--*/</span>
01155 
01156 {
01157     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01158     ACCESS_MASK GrantedAccess;
01159     ULONG HandleAttributes;
01160     <a class="code" href="../../d0/d1/obinit_8c.html#a13">POBP_FIND_HANDLE_DATA</a> MatchCriteria = EnumParameter;
01161 
01162     <span class="comment">//</span>
01163     <span class="comment">//  Get the object header from the table entry and see if</span>
01164     <span class="comment">//  object types and headers match if specified.</span>
01165     <span class="comment">//</span>
01166 
01167     ObjectHeader = (<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a>)((ULONG_PTR)ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a> &amp; ~<a class="code" href="../../d5/d1/obp_8h.html#a17">OBJ_HANDLE_ATTRIBUTES</a>);
01168 
01169     <span class="keywordflow">if</span> ((MatchCriteria-&gt;<a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html#o0">ObjectHeader</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01170         (MatchCriteria-&gt;<a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html#o0">ObjectHeader</a> != ObjectHeader)) {
01171 
01172         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01173     }
01174 
01175     <span class="keywordflow">if</span> ((MatchCriteria-&gt;<a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html#o1">ObjectType</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01176         (MatchCriteria-&gt;<a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html#o1">ObjectType</a> != ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>)) {
01177 
01178         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01179     }
01180 
01181     <span class="comment">//</span>
01182     <span class="comment">//  Check if we have handle information that we need to compare</span>
01183     <span class="comment">//</span>
01184 
01185     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( MatchCriteria-&gt;<a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html#o2">HandleInformation</a> )) {
01186 
01187         <span class="comment">//</span>
01188         <span class="comment">//  If we are tracing the call stacks for cached security indices then we do got a</span>
01189         <span class="comment">//  translation to do otherwise the table entry contains straight away the granted</span>
01190         <span class="comment">//  access mask</span>
01191         <span class="comment">//</span>
01192 
01193 <span class="preprocessor">#if i386 &amp;&amp; !FPO</span>
01194 <span class="preprocessor"></span>
01195         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_KERNEL_STACK_TRACE_DB) {
01196 
01197             GrantedAccess = ObpTranslateGrantedAccessIndex( ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o3">GrantedAccessIndex</a> );
01198 
01199         } <span class="keywordflow">else</span> {
01200 
01201             GrantedAccess = ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a>;
01202         }
01203 <span class="preprocessor">#else</span>
01204 <span class="preprocessor"></span>
01205         GrantedAccess = ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a>;
01206 
01207 <span class="preprocessor">#endif // i386 &amp;&amp; !FPO</span>
01208 <span class="preprocessor"></span>
01209         <span class="comment">//</span>
01210         <span class="comment">//  Get the handle attributes from table entry and see if the</span>
01211         <span class="comment">//  fields match.  If they do not match we will return false to</span>
01212         <span class="comment">//  continue the search.</span>
01213         <span class="comment">//</span>
01214 
01215         HandleAttributes = (ULONG)((ULONG_PTR)ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a> &amp; <a class="code" href="../../d5/d1/obp_8h.html#a17">OBJ_HANDLE_ATTRIBUTES</a>);
01216 
01217         <span class="keywordflow">if</span> (MatchCriteria-&gt;<a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html#o2">HandleInformation</a>-&gt;<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o0">HandleAttributes</a> != HandleAttributes ||
01218             MatchCriteria-&gt;<a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html#o2">HandleInformation</a>-&gt;<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o1">GrantedAccess</a> != GrantedAccess ) {
01219 
01220             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01221         }
01222     }
01223 
01224     <span class="comment">//</span>
01225     <span class="comment">//  We found something that matches our criteria so return true to</span>
01226     <span class="comment">//  our caller to stop the enumeration</span>
01227     <span class="comment">//</span>
01228 
01229     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01230 }
01231 
01232 
01233 BOOLEAN
<a name="l01234"></a><a class="code" href="../../d0/d1/obinit_8c.html#a25">01234</a> <a class="code" href="../../d0/d1/obinit_8c.html#a25">ObFindHandleForObject</a> (
01235     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
01236     IN PVOID Object OPTIONAL,
01237     IN <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType OPTIONAL,
01238     IN <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">POBJECT_HANDLE_INFORMATION</a> HandleInformation OPTIONAL,
01239     OUT PHANDLE Handle
01240     )
01241 
01242 <span class="comment">/*++</span>
01243 <span class="comment"></span>
01244 <span class="comment">Routine Description:</span>
01245 <span class="comment"></span>
01246 <span class="comment">    This routine searches the handle table for the specified process,</span>
01247 <span class="comment">    looking for a handle table entry that matches the passed parameters.</span>
01248 <span class="comment">    If an an Object pointer is specified it must match.  If an</span>
01249 <span class="comment">    ObjectType is specified it must match.  If HandleInformation is</span>
01250 <span class="comment">    specified, then both the HandleAttributes and GrantedAccess mask</span>
01251 <span class="comment">    must match.  If all three match parameters are NULL, then will</span>
01252 <span class="comment">    match the first allocated handle for the specified process that</span>
01253 <span class="comment">    matches the specified object pointer.</span>
01254 <span class="comment"></span>
01255 <span class="comment">Arguments:</span>
01256 <span class="comment"></span>
01257 <span class="comment">    Process - Specifies the process whose object table is to be searched.</span>
01258 <span class="comment"></span>
01259 <span class="comment">    Object - Specifies the object pointer to look for.</span>
01260 <span class="comment"></span>
01261 <span class="comment">    ObjectType - Specifies the object type to look for.</span>
01262 <span class="comment"></span>
01263 <span class="comment">    HandleInformation - Specifies additional match criteria to look for.</span>
01264 <span class="comment"></span>
01265 <span class="comment">    Handle - Specifies the location to receive the handle value whose handle</span>
01266 <span class="comment">        entry matches the supplied object pointer and optional match criteria.</span>
01267 <span class="comment"></span>
01268 <span class="comment">Return Value:</span>
01269 <span class="comment"></span>
01270 <span class="comment">    TRUE if a match was found and FALSE otherwise.</span>
01271 <span class="comment"></span>
01272 <span class="comment">--*/</span>
01273 
01274 {
01275     <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">HANDLE_TABLE_ENTRY</a> ObjectTableEntry;
01276     <a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html">OBP_FIND_HANDLE_DATA</a> EnumParameter;
01277     BOOLEAN Result;
01278 
01279     Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01280 
01281     <span class="comment">//</span>
01282     <span class="comment">//  Lock the object object name space</span>
01283     <span class="comment">//</span>
01284 
01285     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01286 
01287     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;<a class="code" href="../../d9/d0/obhandle_8c.html#a1">ObpInitKillMutant</a>,
01288                            <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
01289                            <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01290                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01291                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01292 
01293     <span class="comment">//</span>
01294     <span class="comment">//  We only do the work if the process has an object table meaning</span>
01295     <span class="comment">//  it isn't going away</span>
01296     <span class="comment">//</span>
01297 
01298     <span class="keywordflow">if</span> (Process-&gt;ObjectTable != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01299 
01300         <span class="comment">//</span>
01301         <span class="comment">//  Set the match parameters that our caller supplied</span>
01302         <span class="comment">//</span>
01303 
01304         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Object )) {
01305 
01306             EnumParameter.<a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html#o0">ObjectHeader</a> = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
01307 
01308         } <span class="keywordflow">else</span> {
01309 
01310             EnumParameter.<a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html#o0">ObjectHeader</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01311         }
01312 
01313         EnumParameter.<a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html#o1">ObjectType</a> = ObjectType;
01314         EnumParameter.<a class="code" href="../../d8/d6/struct__OBP__FIND__HANDLE__DATA.html#o2">HandleInformation</a> = HandleInformation;
01315 
01316         <span class="comment">//</span>
01317         <span class="comment">//  Call the routine the enumerate the object table, this will</span>
01318         <span class="comment">//  return true if we get match.  The enumeration routine really</span>
01319         <span class="comment">//  returns a index into the object table entries we need to</span>
01320         <span class="comment">//  translate it to a real handle before returning.</span>
01321         <span class="comment">//</span>
01322 
01323         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d8/ex_8h.html#a293">ExEnumHandleTable</a>( Process-&gt;ObjectTable,
01324                                <a class="code" href="../../d0/d1/obinit_8c.html#a24">ObpEnumFindHandleProcedure</a>,
01325                                &amp;EnumParameter,
01326                                <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> )) {
01327 
01328             Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01329         }
01330     }
01331 
01332     <span class="comment">//</span>
01333     <span class="comment">//  Unlock the object name space and return to our caller</span>
01334     <span class="comment">//</span>
01335 
01336     <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a>( &amp;<a class="code" href="../../d9/d0/obhandle_8c.html#a1">ObpInitKillMutant</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01337 
01338     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01339 
01340     <span class="keywordflow">return</span> Result;
01341 }
01342 
01343 
01344 <span class="comment">//</span>
01345 <span class="comment">//  Local support routine</span>
01346 <span class="comment">//</span>
01347 
01348 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01349"></a><a class="code" href="../../d0/d1/obinit_8c.html#a14">01349</a> <a class="code" href="../../d0/d1/obinit_8c.html#a14">ObpCreateDosDevicesDirectory</a> (
01350     VOID
01351     )
01352 
01353 <span class="comment">/*++</span>
01354 <span class="comment"></span>
01355 <span class="comment">Routine Description:</span>
01356 <span class="comment"></span>
01357 <span class="comment">    This routine creates the directory object for the dos devices and sets</span>
01358 <span class="comment">    the device map for the system process.</span>
01359 <span class="comment"></span>
01360 <span class="comment">Arguments:</span>
01361 <span class="comment"></span>
01362 <span class="comment">    None.</span>
01363 <span class="comment"></span>
01364 <span class="comment">Return Value:</span>
01365 <span class="comment"></span>
01366 <span class="comment">    STATUS_SUCCESS or an appropriate error</span>
01367 <span class="comment"></span>
01368 <span class="comment">--*/</span>
01369 
01370 {
01371     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01372     UNICODE_STRING NameString;
01373     UNICODE_STRING LinkNameString;
01374     UNICODE_STRING TargetString;
01375     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
01376     HANDLE <a class="code" href="../../d3/d3/tob_8c.html#a23">DirectoryHandle</a>;
01377     HANDLE SymbolicLinkHandle;
01378     SECURITY_DESCRIPTOR DosDevicesSD;
01379 
01380     <span class="comment">//</span>
01381     <span class="comment">//  Create the security descriptor to use for the \?? directory</span>
01382     <span class="comment">//</span>
01383 
01384     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d1/obinit_8c.html#a15">ObpGetDosDevicesProtection</a>( &amp;DosDevicesSD );
01385 
01386     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01387 
01388         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01389     }
01390 
01391     <span class="comment">//</span>
01392     <span class="comment">//  Create the root directory object for the \?? directory.</span>
01393     <span class="comment">//</span>
01394 
01395     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;NameString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\??"</span> );
01396 
01397     InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01398                                 &amp;NameString,
01399                                 OBJ_PERMANENT,
01400                                 (HANDLE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01401                                 &amp;DosDevicesSD );
01402 
01403     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d0/obdir_8c.html#a0">NtCreateDirectoryObject</a>( &amp;<a class="code" href="../../d3/d3/tob_8c.html#a23">DirectoryHandle</a>,
01404                                       DIRECTORY_ALL_ACCESS,
01405                                       &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a> );
01406 
01407     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01408 
01409         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01410     }
01411 
01412     <span class="comment">//</span>
01413     <span class="comment">//  Create a device map that will control this directory.  It will be</span>
01414     <span class="comment">//  stored in the each EPROCESS for use by ObpLookupObjectName when</span>
01415     <span class="comment">//  translating names that begin with \??\</span>
01416     <span class="comment">//</span>
01417 
01418     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d0/obdevmap_8c.html#a0">ObSetDeviceMap</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d3/d3/tob_8c.html#a23">DirectoryHandle</a> );
01419 
01420 
01421     <span class="comment">//</span>
01422     <span class="comment">//  Now create a symbolic link, \??\GLOBALROOT, that points to \</span>
01423     <span class="comment">//  WorkStation service needs some mechanism to access a session specific</span>
01424     <span class="comment">//  DosDevicesDirectory. DosPathToSessionPath API will take a DosPath</span>
01425     <span class="comment">//  e.g (C:) and convert it into session specific path</span>
01426     <span class="comment">//  (e.g GLOBALROOT\Sessions\6\DosDevices\C:). The GLOBALROOT symbolic</span>
01427     <span class="comment">//  link is used to escape out of the current process's DosDevices directory</span>
01428     <span class="comment">//</span>
01429 
01430     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;LinkNameString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"GLOBALROOT"</span> );
01431     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;TargetString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span> );
01432 
01433     InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01434                                 &amp;LinkNameString,
01435                                 OBJ_PERMANENT,
01436                                 <a class="code" href="../../d3/d3/tob_8c.html#a23">DirectoryHandle</a>,
01437                                 &amp;DosDevicesSD );
01438 
01439     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/oblink_8c.html#a5">NtCreateSymbolicLinkObject</a>( &amp;SymbolicLinkHandle,
01440                                          SYMBOLIC_LINK_ALL_ACCESS,
01441                                          &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01442                                          &amp;TargetString );
01443 
01444     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01445 
01446         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( SymbolicLinkHandle );
01447     }
01448 
01449     <span class="comment">//</span>
01450     <span class="comment">//  Create a symbolic link, \??\Global, that points to \??</span>
01451     <span class="comment">//  Drivers loaded dynamically create the symbolic link in the global</span>
01452     <span class="comment">//  DosDevices directory. User mode components need some way to access this</span>
01453     <span class="comment">//  symbolic link in the global dosdevices directory. The Global symbolic</span>
01454     <span class="comment">//  link is used to escape out of the current sessions's DosDevices directory</span>
01455     <span class="comment">//  and use the global dosdevices directory. e.g CreateFile("\\\\.\\Global\\NMDev"..);</span>
01456     <span class="comment">//</span>
01457 
01458     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;LinkNameString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Global"</span> );
01459     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;TargetString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\??"</span> );
01460 
01461     InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01462                                 &amp;LinkNameString,
01463                                 OBJ_PERMANENT,
01464                                 <a class="code" href="../../d3/d3/tob_8c.html#a23">DirectoryHandle</a>,
01465                                 &amp;DosDevicesSD );
01466 
01467     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/oblink_8c.html#a5">NtCreateSymbolicLinkObject</a>( &amp;SymbolicLinkHandle,
01468                                          SYMBOLIC_LINK_ALL_ACCESS,
01469                                          &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01470                                          &amp;TargetString );
01471 
01472     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01473 
01474         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( SymbolicLinkHandle );
01475     }
01476 
01477 
01478     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( <a class="code" href="../../d3/d3/tob_8c.html#a23">DirectoryHandle</a> );
01479 
01480     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01481 
01482         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01483     }
01484 
01485     <span class="comment">//</span>
01486     <span class="comment">//  Now copy the \?? string to a ULONGLONG aligned global variable</span>
01487     <span class="comment">//  for use by ObpLookupObjectName for quick comparisons.</span>
01488     <span class="comment">//</span>
01489 
01490     <a class="code" href="../../d0/d1/obinit_8c.html#a8">ObpDosDevicesShortName</a>.Buffer = (PWSTR)&amp;<a class="code" href="../../d0/d1/obinit_8c.html#a9">ObpDosDevicesShortNamePrefix</a>.QuadPart;
01491     <a class="code" href="../../d0/d1/obinit_8c.html#a8">ObpDosDevicesShortName</a>.Length = 0;
01492     <a class="code" href="../../d0/d1/obinit_8c.html#a8">ObpDosDevicesShortName</a>.MaximumLength = <span class="keyword">sizeof</span>( <a class="code" href="../../d0/d1/obinit_8c.html#a9">ObpDosDevicesShortNamePrefix</a> );
01493 
01494     <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>( &amp;<a class="code" href="../../d0/d1/obinit_8c.html#a8">ObpDosDevicesShortName</a>, &amp;NameString );
01495 
01496     <a class="code" href="../../d0/d1/obinit_8c.html#a8">ObpDosDevicesShortName</a>.Buffer[ 3 ] = UNICODE_NULL;
01497     <a class="code" href="../../d0/d1/obinit_8c.html#a10">ObpDosDevicesShortNameRoot</a>.QuadPart = <a class="code" href="../../d0/d1/obinit_8c.html#a9">ObpDosDevicesShortNamePrefix</a>.QuadPart;
01498 
01499     <span class="comment">//</span>
01500     <span class="comment">//  Now create a symbolic link, \DosDevices, that points to \??</span>
01501     <span class="comment">//  for backwards compatibility with old drivers that use the old</span>
01502     <span class="comment">//  name.</span>
01503     <span class="comment">//</span>
01504 
01505     <a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>( &amp;NameString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\DosDevices"</span> );
01506 
01507     InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01508                                 &amp;NameString,
01509                                 OBJ_PERMANENT,
01510                                 (HANDLE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01511                                 &amp;DosDevicesSD );
01512 
01513     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/oblink_8c.html#a5">NtCreateSymbolicLinkObject</a>( &amp;SymbolicLinkHandle,
01514                                          SYMBOLIC_LINK_ALL_ACCESS,
01515                                          &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01516                                          &amp;<a class="code" href="../../d0/d1/obinit_8c.html#a8">ObpDosDevicesShortName</a> );
01517 
01518     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01519 
01520         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( SymbolicLinkHandle );
01521     }
01522 
01523     <span class="comment">//</span>
01524     <span class="comment">//  Finish setting up the global variable for ObpLookupObjectName</span>
01525     <span class="comment">//</span>
01526 
01527     <a class="code" href="../../d0/d1/obinit_8c.html#a8">ObpDosDevicesShortName</a>.Buffer[ 3 ] = OBJ_NAME_PATH_SEPARATOR;
01528     <a class="code" href="../../d0/d1/obinit_8c.html#a8">ObpDosDevicesShortName</a>.Length += <span class="keyword">sizeof</span>( OBJ_NAME_PATH_SEPARATOR );
01529 
01530     <span class="comment">//</span>
01531     <span class="comment">//  All done with the security descriptor for \??</span>
01532     <span class="comment">//</span>
01533 
01534     <a class="code" href="../../d0/d1/obinit_8c.html#a16">ObpFreeDosDevicesProtection</a>( &amp;DosDevicesSD );
01535 
01536     <span class="keywordflow">return</span> STATUS_SUCCESS;
01537 }
01538 
01539 
01540 <span class="comment">//</span>
01541 <span class="comment">//  Local support routine</span>
01542 <span class="comment">//</span>
01543 
01544 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01545"></a><a class="code" href="../../d0/d1/obinit_8c.html#a15">01545</a> <a class="code" href="../../d0/d1/obinit_8c.html#a15">ObpGetDosDevicesProtection</a> (
01546     PSECURITY_DESCRIPTOR SecurityDescriptor
01547     )
01548 
01549 <span class="comment">/*++</span>
01550 <span class="comment"></span>
01551 <span class="comment">Routine Description:</span>
01552 <span class="comment"></span>
01553 <span class="comment">    This routine builds a security descriptor for use in creating</span>
01554 <span class="comment">    the \DosDevices object directory.  The protection of \DosDevices</span>
01555 <span class="comment">    must establish inheritable protection which will dictate how</span>
01556 <span class="comment">    dos devices created via the DefineDosDevice() and</span>
01557 <span class="comment">    IoCreateUnprotectedSymbolicLink() apis can be managed.</span>
01558 <span class="comment"></span>
01559 <span class="comment">    The protection assigned is dependent upon an administrable registry</span>
01560 <span class="comment">    key:</span>
01561 <span class="comment"></span>
01562 <span class="comment">        Key: \hkey_local_machine\System\CurrentControlSet\Control\Session Manager</span>
01563 <span class="comment">        Value: [REG_DWORD] ProtectionMode</span>
01564 <span class="comment"></span>
01565 <span class="comment">    If this value is 0x1, then</span>
01566 <span class="comment"></span>
01567 <span class="comment">            Administrators may control all Dos devices,</span>
01568 <span class="comment">            Anyone may create new Dos devices (such as net drives</span>
01569 <span class="comment">                or additional printers),</span>
01570 <span class="comment">            Anyone may use any Dos device,</span>
01571 <span class="comment">            The creator of a Dos device may delete it.</span>
01572 <span class="comment">            Note that this protects system-defined LPTs and COMs so that only</span>
01573 <span class="comment">                administrators may redirect them.  However, anyone may add</span>
01574 <span class="comment">                additional printers and direct them to wherever they would</span>
01575 <span class="comment">                like.</span>
01576 <span class="comment"></span>
01577 <span class="comment">           This is achieved with the following protection for the DosDevices</span>
01578 <span class="comment">           Directory object:</span>
01579 <span class="comment"></span>
01580 <span class="comment">                    Grant:  World:   Execute | Read         (No Inherit)</span>
01581 <span class="comment">                    Grant:  System:  All Access             (No Inherit)</span>
01582 <span class="comment">                    Grant:  World:   Execute                (Inherit Only)</span>
01583 <span class="comment">                    Grant:  Admins:  All Access             (Inherit Only)</span>
01584 <span class="comment">                    Grant:  System:  All Access             (Inherit Only)</span>
01585 <span class="comment">                    Grant:  Owner:   All Access             (Inherit Only)</span>
01586 <span class="comment"></span>
01587 <span class="comment">    If this value is 0x0, or not present, then</span>
01588 <span class="comment"></span>
01589 <span class="comment">            Administrators may control all Dos devices,</span>
01590 <span class="comment">            Anyone may create new Dos devices (such as net drives</span>
01591 <span class="comment">                or additional printers),</span>
01592 <span class="comment">            Anyone may use any Dos device,</span>
01593 <span class="comment">            Anyone may delete Dos devices created with either DefineDosDevice()</span>
01594 <span class="comment">                or IoCreateUnprotectedSymbolicLink().  This is how network drives</span>
01595 <span class="comment">                and LPTs are created (but not COMs).</span>
01596 <span class="comment"></span>
01597 <span class="comment">           This is achieved with the following protection for the DosDevices</span>
01598 <span class="comment">           Directory object:</span>
01599 <span class="comment"></span>
01600 <span class="comment">                    Grant:  World:   Execute | Read | Write (No Inherit)</span>
01601 <span class="comment">                    Grant:  System:  All Access             (No Inherit)</span>
01602 <span class="comment">                    Grant:  World:   All Access             (Inherit Only)</span>
01603 <span class="comment"></span>
01604 <span class="comment"></span>
01605 <span class="comment">Arguments:</span>
01606 <span class="comment"></span>
01607 <span class="comment">    SecurityDescriptor - The address of a security descriptor to be</span>
01608 <span class="comment">        initialized and filled in.  When this security descriptor is no</span>
01609 <span class="comment">        longer needed, you should call ObpFreeDosDevicesProtection() to</span>
01610 <span class="comment">        free the protection information.</span>
01611 <span class="comment"></span>
01612 <span class="comment"></span>
01613 <span class="comment">Return Value:</span>
01614 <span class="comment"></span>
01615 <span class="comment">    Returns one of the following status codes:</span>
01616 <span class="comment"></span>
01617 <span class="comment">        STATUS_SUCCESS - normal, successful completion.</span>
01618 <span class="comment"></span>
01619 <span class="comment">        STATUS_NO_MEMORY - not enough memory</span>
01620 <span class="comment"></span>
01621 <span class="comment"></span>
01622 <span class="comment">--*/</span>
01623 
01624 {
01625     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01626     ULONG aceIndex, aclLength;
01627     PACL dacl;
01628     PACE_HEADER ace;
01629     ACCESS_MASK accessMask;
01630 
01631     UCHAR inheritOnlyFlags = (OBJECT_INHERIT_ACE    |
01632                               CONTAINER_INHERIT_ACE |
01633                               INHERIT_ONLY_ACE
01634                              );
01635 
01636     <span class="comment">//</span>
01637     <span class="comment">//  NOTE:  This routine expects the value of ObpProtectionMode to have been set</span>
01638     <span class="comment">//</span>
01639 
01640     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>( SecurityDescriptor, SECURITY_DESCRIPTOR_REVISION );
01641 
01642     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) );
01643 
01644     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a14">ObpProtectionMode</a> &amp; 0x00000001) {
01645 
01646         <span class="comment">//</span>
01647         <span class="comment">//  Dacl:</span>
01648         <span class="comment">//          Grant:  World:   Execute | Read         (No Inherit)</span>
01649         <span class="comment">//          Grant:  System:  All Access             (No Inherit)</span>
01650         <span class="comment">//          Grant:  World:   Execute                (Inherit Only)</span>
01651         <span class="comment">//          Grant:  Admins:  All Access             (Inherit Only)</span>
01652         <span class="comment">//          Grant:  System:  All Access             (Inherit Only)</span>
01653         <span class="comment">//          Grant:  Owner:   All Access             (Inherit Only)</span>
01654         <span class="comment">//</span>
01655 
01656         aclLength = <span class="keyword">sizeof</span>( ACL )                           +
01657                     6 * <span class="keyword">sizeof</span>( ACCESS_ALLOWED_ACE )        +
01658                     (2*<a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>( <a class="code" href="../../d0/d5/se_8h.html#a42">SeWorldSid</a> ))          +
01659                     (2*<a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>( <a class="code" href="../../d0/d5/se_8h.html#a54">SeLocalSystemSid</a> ))    +
01660                     <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>( <a class="code" href="../../d0/d5/se_8h.html#a56">SeAliasAdminsSid</a> )        +
01661                     <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>( <a class="code" href="../../d0/d5/se_8h.html#a44">SeCreatorOwnerSid</a> );
01662 
01663         dacl = (PACL)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, aclLength );
01664 
01665         <span class="keywordflow">if</span> (dacl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01666 
01667             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01668         }
01669 
01670         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( dacl, aclLength, ACL_REVISION2);
01671         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) );
01672 
01673         <span class="comment">//</span>
01674         <span class="comment">//  Non-inheritable ACEs first</span>
01675         <span class="comment">//      World</span>
01676         <span class="comment">//      System</span>
01677         <span class="comment">//</span>
01678 
01679         aceIndex = 0;
01680         accessMask = (GENERIC_READ | GENERIC_EXECUTE);
01681         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> ( dacl, ACL_REVISION2, accessMask, <a class="code" href="../../d0/d5/se_8h.html#a42">SeWorldSid</a> );
01682         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) );
01683         aceIndex++;
01684         accessMask = (GENERIC_ALL);
01685         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> ( dacl, ACL_REVISION2, accessMask, <a class="code" href="../../d0/d5/se_8h.html#a54">SeLocalSystemSid</a> );
01686         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) );
01687 
01688         <span class="comment">//</span>
01689         <span class="comment">//  Inheritable ACEs at the end of the ACL</span>
01690         <span class="comment">//          World</span>
01691         <span class="comment">//          Admins</span>
01692         <span class="comment">//          System</span>
01693         <span class="comment">//          Owner</span>
01694         <span class="comment">//</span>
01695 
01696         aceIndex++;
01697         accessMask = (GENERIC_EXECUTE);
01698         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> ( dacl, ACL_REVISION2, accessMask, <a class="code" href="../../d0/d5/se_8h.html#a42">SeWorldSid</a> );
01699         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) );
01700         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a12">RtlGetAce</a>( dacl, aceIndex, (PVOID)&amp;ace );
01701         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) );
01702         ace-&gt;AceFlags |= inheritOnlyFlags;
01703 
01704         aceIndex++;
01705         accessMask = (GENERIC_ALL);
01706         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> ( dacl, ACL_REVISION2, accessMask, <a class="code" href="../../d0/d5/se_8h.html#a56">SeAliasAdminsSid</a> );
01707         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) );
01708         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a12">RtlGetAce</a>( dacl, aceIndex, (PVOID)&amp;ace );
01709         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) );
01710         ace-&gt;AceFlags |= inheritOnlyFlags;
01711 
01712         aceIndex++;
01713         accessMask = (GENERIC_ALL);
01714         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> ( dacl, ACL_REVISION2, accessMask, <a class="code" href="../../d0/d5/se_8h.html#a54">SeLocalSystemSid</a> );
01715         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) );
01716         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a12">RtlGetAce</a>( dacl, aceIndex, (PVOID)&amp;ace );
01717         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) );
01718         ace-&gt;AceFlags |= inheritOnlyFlags;
01719 
01720         aceIndex++;
01721         accessMask = (GENERIC_ALL);
01722         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> ( dacl, ACL_REVISION2, accessMask, <a class="code" href="../../d0/d5/se_8h.html#a44">SeCreatorOwnerSid</a> );
01723         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) );
01724         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a12">RtlGetAce</a>( dacl, aceIndex, (PVOID)&amp;ace );
01725         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) );
01726         ace-&gt;AceFlags |= inheritOnlyFlags;
01727 
01728         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a>( SecurityDescriptor,
01729                                                <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,               <span class="comment">//DaclPresent,</span>
01730                                                dacl,               <span class="comment">//Dacl</span>
01731                                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );            
01732 
01733         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) );
01734 
01735     } <span class="keywordflow">else</span> {
01736 
01737         <span class="comment">//</span>
01738         <span class="comment">//  DACL:</span>
01739         <span class="comment">//          Grant:  World:   Execute | Read | Write (No Inherit)</span>
01740         <span class="comment">//          Grant:  System:  All Access             (No Inherit)</span>
01741         <span class="comment">//          Grant:  World:   All Access             (Inherit Only)</span>
01742         <span class="comment">//</span>
01743 
01744         aclLength = <span class="keyword">sizeof</span>( ACL )                           +
01745                     3 * <span class="keyword">sizeof</span>( ACCESS_ALLOWED_ACE )        +
01746                     (2*<a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>( <a class="code" href="../../d0/d5/se_8h.html#a42">SeWorldSid</a> ))          +
01747                     <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>( <a class="code" href="../../d0/d5/se_8h.html#a54">SeLocalSystemSid</a> );
01748 
01749         dacl = (PACL)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, aclLength );
01750 
01751         <span class="keywordflow">if</span> (dacl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01752 
01753             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01754         }
01755 
01756         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( dacl, aclLength, ACL_REVISION2);
01757         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) );
01758 
01759         <span class="comment">//</span>
01760         <span class="comment">//  Non-inheritable ACEs first</span>
01761         <span class="comment">//      World</span>
01762         <span class="comment">//      System</span>
01763         <span class="comment">//</span>
01764 
01765         aceIndex = 0;
01766         accessMask = (GENERIC_READ | GENERIC_WRITE | GENERIC_EXECUTE);
01767         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> ( dacl, ACL_REVISION2, accessMask, <a class="code" href="../../d0/d5/se_8h.html#a42">SeWorldSid</a> );
01768         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) );
01769 
01770         aceIndex++;
01771         accessMask = (GENERIC_ALL);
01772         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> ( dacl, ACL_REVISION2, accessMask, <a class="code" href="../../d0/d5/se_8h.html#a54">SeLocalSystemSid</a> );
01773         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) );
01774 
01775         <span class="comment">//</span>
01776         <span class="comment">//  Inheritable ACEs at the end of the ACL</span>
01777         <span class="comment">//          World</span>
01778         <span class="comment">//</span>
01779 
01780         aceIndex++;
01781         accessMask = (GENERIC_ALL);
01782         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> ( dacl, ACL_REVISION2, accessMask, <a class="code" href="../../d0/d5/se_8h.html#a42">SeWorldSid</a> );
01783         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) );
01784         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a12">RtlGetAce</a>( dacl, aceIndex, (PVOID)&amp;ace );
01785         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) );
01786         ace-&gt;AceFlags |= inheritOnlyFlags;
01787 
01788         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a>( SecurityDescriptor,
01789                                                <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,               <span class="comment">//DaclPresent,</span>
01790                                                dacl,               <span class="comment">//Dacl</span>
01791                                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );            
01792 
01793         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) );
01794     }
01795 
01796     <span class="keywordflow">return</span> STATUS_SUCCESS;
01797 }
01798 
01799 
01800 <span class="comment">//</span>
01801 <span class="comment">//  Local support routine</span>
01802 <span class="comment">//</span>
01803 
01804 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01805"></a><a class="code" href="../../d0/d1/obinit_8c.html#a16">01805</a> <a class="code" href="../../d0/d1/obinit_8c.html#a16">ObpFreeDosDevicesProtection</a> (
01806     PSECURITY_DESCRIPTOR SecurityDescriptor
01807     )
01808 
01809 <span class="comment">/*++</span>
01810 <span class="comment"></span>
01811 <span class="comment">Routine Description:</span>
01812 <span class="comment"></span>
01813 <span class="comment">    This routine frees memory allocated via ObpGetDosDevicesProtection().</span>
01814 <span class="comment"></span>
01815 <span class="comment">Arguments:</span>
01816 <span class="comment"></span>
01817 <span class="comment">    SecurityDescriptor - The address of a security descriptor initialized by</span>
01818 <span class="comment">        ObpGetDosDevicesProtection().</span>
01819 <span class="comment"></span>
01820 <span class="comment">Return Value:</span>
01821 <span class="comment"></span>
01822 <span class="comment">    None.</span>
01823 <span class="comment"></span>
01824 <span class="comment">--*/</span>
01825 
01826 {
01827     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01828     PACL <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>;
01829     BOOLEAN DaclPresent, Defaulted;
01830 
01831     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a61">RtlGetDaclSecurityDescriptor</a> ( SecurityDescriptor,
01832                                             &amp;DaclPresent,
01833                                             &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>,
01834                                             &amp;Defaulted );
01835 
01836     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) );
01837     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( DaclPresent );
01838     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01839 
01840     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( (PVOID)<a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> );
01841 
01842     <span class="keywordflow">return</span>;
01843 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:05 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
