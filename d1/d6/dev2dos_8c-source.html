<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: dev2dos.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>dev2dos.c</h1><a href="../../d0/d7/dev2dos_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    dev2dos.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the device object to DOS name routine.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Norbert Kusters (norbertk)  21-Oct-1998</span>
00016 <span class="comment"></span>
00017 <span class="comment">Environment:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Kernel Mode.</span>
00020 <span class="comment"></span>
00021 <span class="comment">Revision History:</span>
00022 <span class="comment"></span>
00023 <span class="comment">--*/</span>
00024 
00025 <span class="preprocessor">#include &lt;<a class="code" href="../../d5/d9/ntrtlp_8h.html">ntrtlp.h</a>&gt;</span>
00026 <span class="preprocessor">#include &lt;mountdev.h&gt;</span>
00027 
00028 <span class="preprocessor">#ifdef POOL_TAGGING</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#undef ExAllocatePool</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#undef ExAllocatePoolWithQuota</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePool(a,b) ExAllocatePoolWithTag(a,b,' d2D')</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePoolWithQuota(a,b) ExAllocatePoolWithQuotaTag(a,b,' d2D')</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00034 <span class="preprocessor"></span>
00035 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00036 <a class="code" href="../../d0/d7/dev2dos_8c.html#a2">QuerySymbolicLink</a>(
00037     IN  PUNICODE_STRING SymbolicLinkName,
00038     OUT PUNICODE_STRING LinkTarget
00039     );
00040 
00041 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00042 <a class="code" href="../../d0/d7/dev2dos_8c.html#a3">QueryDeviceNameForPath</a>(
00043     IN  PUNICODE_STRING Path,
00044     OUT PUNICODE_STRING DeviceName
00045     );
00046 
00047 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00048 <a class="code" href="../../d0/d7/dev2dos_8c.html#a4">OpenDeviceReparseIndex</a>(
00049     IN  PUNICODE_STRING DeviceName,
00050     OUT PHANDLE         Handle
00051     );
00052 
00053 BOOLEAN
00054 <a class="code" href="../../d0/d7/dev2dos_8c.html#a5">IsVolumeName</a>(
00055     IN  PUNICODE_STRING Name
00056     );
00057 
00058 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00059 <a class="code" href="../../d0/d7/dev2dos_8c.html#a6">GetNextReparseVolumePath</a>(
00060     IN  HANDLE          Handle,
00061     OUT PUNICODE_STRING Path
00062     );
00063 
00064 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00065 <a class="code" href="../../d0/d7/dev2dos_8c.html#a7">FindPathForDevice</a>(
00066     IN      PUNICODE_STRING StartingPath,
00067     IN      PUNICODE_STRING DeviceName,
00068     IN OUT  PLIST_ENTRY     DevicesInPath,
00069     OUT     PUNICODE_STRING FinalPath
00070     );
00071 
00072 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00073 <a class="code" href="../../d0/d7/dev2dos_8c.html#a8">RtlVolumeDeviceToDosName</a>(
00074     IN  PVOID           VolumeDeviceObject,
00075     OUT PUNICODE_STRING DosName
00076     );
00077 
00078 <span class="preprocessor">#if defined(ALLOC_PRAGMA) &amp;&amp; defined(NTOS_KERNEL_RUNTIME)</span>
00079 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,QuerySymbolicLink)</span>
00080 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,QueryDeviceNameForPath)</span>
00081 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,OpenDeviceReparseIndex)</span>
00082 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IsVolumeName)</span>
00083 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,GetNextReparseVolumePath)</span>
00084 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,FindPathForDevice)</span>
00085 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlVolumeDeviceToDosName)</span>
00086 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00087 <span class="preprocessor"></span>
<a name="l00088"></a><a class="code" href="../../d3/d4/struct__DEVICE__NAME__ENTRY.html">00088</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d3/d4/struct__DEVICE__NAME__ENTRY.html">_DEVICE_NAME_ENTRY</a> {
<a name="l00089"></a><a class="code" href="../../d3/d4/struct__DEVICE__NAME__ENTRY.html#o0">00089</a>     LIST_ENTRY      <a class="code" href="../../d3/d4/struct__DEVICE__NAME__ENTRY.html#o0">ListEntry</a>;
<a name="l00090"></a><a class="code" href="../../d3/d4/struct__DEVICE__NAME__ENTRY.html#o1">00090</a>     UNICODE_STRING  <a class="code" href="../../d3/d4/struct__DEVICE__NAME__ENTRY.html#o1">DeviceName</a>;
00091 } <a class="code" href="../../d3/d4/struct__DEVICE__NAME__ENTRY.html">DEVICE_NAME_ENTRY</a>, *<a class="code" href="../../d3/d4/struct__DEVICE__NAME__ENTRY.html">PDEVICE_NAME_ENTRY</a>;
00092 
00093 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00094"></a><a class="code" href="../../d0/d7/dev2dos_8c.html#a2">00094</a> <a class="code" href="../../d0/d7/dev2dos_8c.html#a2">QuerySymbolicLink</a>(
00095     IN  PUNICODE_STRING SymbolicLinkName,
00096     OUT PUNICODE_STRING LinkTarget
00097     )
00098 
00099 <span class="comment">/*++</span>
00100 <span class="comment"></span>
00101 <span class="comment">Routine Description:</span>
00102 <span class="comment"></span>
00103 <span class="comment">    This routine returns the target of the symbolic link name.</span>
00104 <span class="comment"></span>
00105 <span class="comment">Arguments:</span>
00106 <span class="comment"></span>
00107 <span class="comment">    SymbolicLinkName    - Supplies the symbolic link name.</span>
00108 <span class="comment"></span>
00109 <span class="comment">    LinkTarget          - Returns the link target.</span>
00110 <span class="comment"></span>
00111 <span class="comment">Return Value:</span>
00112 <span class="comment"></span>
00113 <span class="comment">    NTSTATUS</span>
00114 <span class="comment"></span>
00115 <span class="comment">--*/</span>
00116 
00117 {
00118     OBJECT_ATTRIBUTES   oa;
00119     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            status;
00120     HANDLE              h;
00121 
00122     InitializeObjectAttributes(&amp;oa, SymbolicLinkName, OBJ_CASE_INSENSITIVE,
00123                                0, 0);
00124 
00125     status = ZwOpenSymbolicLinkObject(&amp;h, GENERIC_READ, &amp;oa);
00126     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00127         <span class="keywordflow">return</span> status;
00128     }
00129 
00130     LinkTarget-&gt;MaximumLength = 200*<span class="keyword">sizeof</span>(WCHAR);
00131     LinkTarget-&gt;Length = 0;
00132     LinkTarget-&gt;Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, LinkTarget-&gt;MaximumLength);
00133     <span class="keywordflow">if</span> (!LinkTarget-&gt;Buffer) {
00134         ZwClose(h);
00135         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00136     }
00137 
00138     status = ZwQuerySymbolicLinkObject(h, LinkTarget, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00139     ZwClose(h);
00140 
00141     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00142         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(LinkTarget-&gt;Buffer);
00143     }
00144 
00145     <span class="keywordflow">return</span> status;
00146 }
00147 
00148 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00149"></a><a class="code" href="../../d0/d7/dev2dos_8c.html#a3">00149</a> <a class="code" href="../../d0/d7/dev2dos_8c.html#a3">QueryDeviceNameForPath</a>(
00150     IN  PUNICODE_STRING Path,
00151     OUT PUNICODE_STRING DeviceName
00152     )
00153 
00154 <span class="comment">/*++</span>
00155 <span class="comment"></span>
00156 <span class="comment">Routine Description:</span>
00157 <span class="comment"></span>
00158 <span class="comment">    This routine returns the device name for the given path.  It first checks</span>
00159 <span class="comment">    to see if the path is a symbolic link and then checks to see if it is a</span>
00160 <span class="comment">    volume reparse point.</span>
00161 <span class="comment"></span>
00162 <span class="comment">Arguments:</span>
00163 <span class="comment"></span>
00164 <span class="comment">    Path        - Supplies the path.</span>
00165 <span class="comment"></span>
00166 <span class="comment">    DeviceName  - Returns the device name.</span>
00167 <span class="comment"></span>
00168 <span class="comment">Return Value:</span>
00169 <span class="comment"></span>
00170 <span class="comment">    NTSTATUS</span>
00171 <span class="comment"></span>
00172 <span class="comment">--*/</span>
00173 
00174 {
00175     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                status;
00176     OBJECT_ATTRIBUTES       oa;
00177     HANDLE                  h;
00178     IO_STATUS_BLOCK         ioStatus;
00179     PREPARSE_DATA_BUFFER    reparse;
00180     UNICODE_STRING          volumeName;
00181 
00182     status = <a class="code" href="../../d0/d7/dev2dos_8c.html#a2">QuerySymbolicLink</a>(Path, DeviceName);
00183     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00184         <span class="keywordflow">return</span> status;
00185     }
00186 
00187     InitializeObjectAttributes(&amp;oa, Path, OBJ_CASE_INSENSITIVE, 0, 0);
00188     status = <a class="code" href="../../d6/d9/restrfil_8c.html#a33">ZwOpenFile</a>(&amp;h, SYNCHRONIZE | FILE_GENERIC_READ, &amp;oa, &amp;ioStatus,
00189                         FILE_SHARE_READ | FILE_SHARE_WRITE,
00190                         FILE_OPEN_REPARSE_POINT | FILE_SYNCHRONOUS_IO_ALERT);
00191     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00192         <span class="keywordflow">return</span> status;
00193     }
00194 
00195     reparse = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, MAXIMUM_REPARSE_DATA_BUFFER_SIZE);
00196     <span class="keywordflow">if</span> (!reparse) {
00197         ZwClose(h);
00198         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00199     }
00200 
00201     status = ZwFsControlFile(h, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;ioStatus,
00202                              FSCTL_GET_REPARSE_POINT, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, reparse,
00203                              MAXIMUM_REPARSE_DATA_BUFFER_SIZE);
00204     ZwClose(h);
00205     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00206         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(reparse);
00207         <span class="keywordflow">return</span> status;
00208     }
00209 
00210     volumeName.Length = reparse-&gt;MountPointReparseBuffer.SubstituteNameLength -
00211                         <span class="keyword">sizeof</span>(WCHAR);
00212     volumeName.MaximumLength = volumeName.Length + <span class="keyword">sizeof</span>(WCHAR);
00213     volumeName.Buffer = (PWCHAR)
00214                         ((PCHAR) reparse-&gt;MountPointReparseBuffer.PathBuffer +
00215                         reparse-&gt;MountPointReparseBuffer.SubstituteNameOffset);
00216     volumeName.Buffer[volumeName.Length/<span class="keyword">sizeof</span>(WCHAR)] = 0;
00217 
00218     status = <a class="code" href="../../d0/d7/dev2dos_8c.html#a2">QuerySymbolicLink</a>(&amp;volumeName, DeviceName);
00219     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(reparse);
00220 
00221     <span class="keywordflow">return</span> status;
00222 }
00223 
00224 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00225"></a><a class="code" href="../../d0/d7/dev2dos_8c.html#a4">00225</a> <a class="code" href="../../d0/d7/dev2dos_8c.html#a4">OpenDeviceReparseIndex</a>(
00226     IN  PUNICODE_STRING DeviceName,
00227     OUT PHANDLE         Handle
00228     )
00229 
00230 <span class="comment">/*++</span>
00231 <span class="comment"></span>
00232 <span class="comment">Routine Description:</span>
00233 <span class="comment"></span>
00234 <span class="comment">    This routine opens the reparse index on the given device.</span>
00235 <span class="comment"></span>
00236 <span class="comment">Arguments:</span>
00237 <span class="comment"></span>
00238 <span class="comment">    DeviceName  - Supplies the device name.</span>
00239 <span class="comment"></span>
00240 <span class="comment">    Handle      - Returns the handle.</span>
00241 <span class="comment"></span>
00242 <span class="comment">Return Value:</span>
00243 <span class="comment"></span>
00244 <span class="comment">    NTSTATUS</span>
00245 <span class="comment"></span>
00246 <span class="comment">--*/</span>
00247 
00248 {
00249     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            status;
00250     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>        fileObject;
00251     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>      deviceObject;
00252     UNICODE_STRING      reparseSuffix, reparseName;
00253     OBJECT_ATTRIBUTES   oa;
00254     IO_STATUS_BLOCK     ioStatus;
00255 
00256     status = <a class="code" href="../../d4/d6/iosubs_8c.html#a71">IoGetDeviceObjectPointer</a>(DeviceName, FILE_READ_ATTRIBUTES,
00257                                       &amp;fileObject, &amp;deviceObject);
00258     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00259         <span class="keywordflow">return</span> status;
00260     }
00261     deviceObject = fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o2">DeviceObject</a>;
00262 
00263     <span class="keywordflow">if</span> (!deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o10">Vpb</a> || !(deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o10">Vpb</a>-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o2">Flags</a>&amp;<a class="code" href="../../d0/d5/io_8h.html#a116">VPB_MOUNTED</a>)) {
00264         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(fileObject);
00265         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00266     }
00267 
00268     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(fileObject);
00269 
00270     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;reparseSuffix,
00271                          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\$Extend\\$Reparse:$R:$INDEX_ALLOCATION"</span>);
00272     reparseName.Length = DeviceName-&gt;Length + reparseSuffix.Length;
00273     reparseName.MaximumLength = reparseName.Length + <span class="keyword">sizeof</span>(WCHAR);
00274     reparseName.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, reparseName.MaximumLength);
00275     <span class="keywordflow">if</span> (!reparseName.Buffer) {
00276         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00277     }
00278 
00279     RtlCopyMemory(reparseName.Buffer, DeviceName-&gt;Buffer, DeviceName-&gt;Length);
00280     RtlCopyMemory((PCHAR) reparseName.Buffer + DeviceName-&gt;Length,
00281                   reparseSuffix.Buffer, reparseSuffix.Length);
00282     reparseName.Buffer[reparseName.Length/<span class="keyword">sizeof</span>(WCHAR)] = 0;
00283 
00284     InitializeObjectAttributes(&amp;oa, &amp;reparseName, OBJ_CASE_INSENSITIVE, 0, 0);
00285     status = <a class="code" href="../../d6/d9/restrfil_8c.html#a33">ZwOpenFile</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>, SYNCHRONIZE | FILE_LIST_DIRECTORY, &amp;oa,
00286                         &amp;ioStatus, FILE_SHARE_READ | FILE_SHARE_WRITE,
00287                         FILE_DIRECTORY_FILE | FILE_SYNCHRONOUS_IO_ALERT |
00288                         FILE_OPEN_FOR_BACKUP_INTENT);
00289 
00290     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(reparseName.Buffer);
00291 
00292     <span class="keywordflow">return</span> status;
00293 }
00294 
00295 BOOLEAN
<a name="l00296"></a><a class="code" href="../../d0/d7/dev2dos_8c.html#a5">00296</a> <a class="code" href="../../d0/d7/dev2dos_8c.html#a5">IsVolumeName</a>(
00297     IN  PUNICODE_STRING Name
00298     )
00299 
00300 {
00301     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length == 96 &amp;&amp;
00302         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[0] == <span class="charliteral">'\\'</span> &amp;&amp;
00303         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[1] == <span class="charliteral">'?'</span> &amp;&amp;
00304         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[2] == <span class="charliteral">'?'</span> &amp;&amp;
00305         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[3] == <span class="charliteral">'\\'</span> &amp;&amp;
00306         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[4] == <span class="charliteral">'V'</span> &amp;&amp;
00307         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[5] == <span class="charliteral">'o'</span> &amp;&amp;
00308         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[6] == <span class="charliteral">'l'</span> &amp;&amp;
00309         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[7] == <span class="charliteral">'u'</span> &amp;&amp;
00310         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[8] == <span class="charliteral">'m'</span> &amp;&amp;
00311         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[9] == <span class="charliteral">'e'</span> &amp;&amp;
00312         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[10] == <span class="charliteral">'{'</span> &amp;&amp;
00313         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[19] == <span class="charliteral">'-'</span> &amp;&amp;
00314         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[24] == <span class="charliteral">'-'</span> &amp;&amp;
00315         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[29] == <span class="charliteral">'-'</span> &amp;&amp;
00316         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[34] == <span class="charliteral">'-'</span> &amp;&amp;
00317         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[47] == <span class="charliteral">'}'</span>) {
00318 
00319         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00320     }
00321 
00322     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00323 }
00324 
00325 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00326"></a><a class="code" href="../../d0/d7/dev2dos_8c.html#a6">00326</a> <a class="code" href="../../d0/d7/dev2dos_8c.html#a6">GetNextReparseVolumePath</a>(
00327     IN  HANDLE          Handle,
00328     OUT PUNICODE_STRING Path
00329     )
00330 
00331 <span class="comment">/*++</span>
00332 <span class="comment"></span>
00333 <span class="comment">Routine Description:</span>
00334 <span class="comment"></span>
00335 <span class="comment">    This routine queries the reparse index for the next volume mount point.</span>
00336 <span class="comment"></span>
00337 <span class="comment">Arguments:</span>
00338 <span class="comment"></span>
00339 <span class="comment">    Handle  - Supplies the handle.</span>
00340 <span class="comment"></span>
00341 <span class="comment">    Path    - Returns the path.</span>
00342 <span class="comment"></span>
00343 <span class="comment"></span>
00344 <span class="comment">Return Value:</span>
00345 <span class="comment"></span>
00346 <span class="comment">    NTSTATUS</span>
00347 <span class="comment"></span>
00348 <span class="comment">--*/</span>
00349 
00350 {
00351     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                        status;
00352     IO_STATUS_BLOCK                 ioStatus;
00353     FILE_REPARSE_POINT_INFORMATION  reparseInfo;
00354     UNICODE_STRING                  fileId;
00355     OBJECT_ATTRIBUTES               oa;
00356     HANDLE                          h;
00357     PREPARSE_DATA_BUFFER            reparse;
00358     UNICODE_STRING                  volumeName;
00359     ULONG                           nameInfoSize;
00360     PFILE_NAME_INFORMATION          nameInfo;
00361 
00362     <span class="keywordflow">for</span> (;;) {
00363 
00364         status = ZwQueryDirectoryFile(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;ioStatus,
00365                                       &amp;reparseInfo, <span class="keyword">sizeof</span>(reparseInfo),
00366                                       FileReparsePointInformation, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00367                                       <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00368         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00369             <span class="keywordflow">return</span> status;
00370         }
00371 
00372         <span class="keywordflow">if</span> (reparseInfo.Tag != IO_REPARSE_TAG_MOUNT_POINT) {
00373             <span class="keywordflow">continue</span>;
00374         }
00375 
00376         fileId.Length = <span class="keyword">sizeof</span>(reparseInfo.FileReference);
00377         fileId.MaximumLength = fileId.Length;
00378         fileId.Buffer = (PWSTR) &amp;reparseInfo.FileReference;
00379 
00380         InitializeObjectAttributes(&amp;oa, &amp;fileId, 0, <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00381 
00382         status = <a class="code" href="../../d6/d9/restrfil_8c.html#a33">ZwOpenFile</a>(&amp;h, SYNCHRONIZE | FILE_GENERIC_READ, &amp;oa,
00383                             &amp;ioStatus, FILE_SHARE_READ | FILE_SHARE_WRITE,
00384                             FILE_OPEN_BY_FILE_ID | FILE_OPEN_REPARSE_POINT |
00385                             FILE_SYNCHRONOUS_IO_ALERT);
00386         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00387             <span class="keywordflow">continue</span>;
00388         }
00389 
00390         reparse = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, MAXIMUM_REPARSE_DATA_BUFFER_SIZE);
00391         <span class="keywordflow">if</span> (!reparse) {
00392             ZwClose(h);
00393             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00394         }
00395 
00396         status = ZwFsControlFile(h, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;ioStatus,
00397                                  FSCTL_GET_REPARSE_POINT, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, reparse,
00398                                  MAXIMUM_REPARSE_DATA_BUFFER_SIZE);
00399         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00400             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(reparse);
00401             ZwClose(h);
00402             <span class="keywordflow">continue</span>;
00403         }
00404 
00405         volumeName.Length = reparse-&gt;MountPointReparseBuffer.SubstituteNameLength -
00406                             <span class="keyword">sizeof</span>(WCHAR);
00407         volumeName.MaximumLength = volumeName.Length + <span class="keyword">sizeof</span>(WCHAR);
00408         volumeName.Buffer = (PWCHAR)
00409                             ((PCHAR) reparse-&gt;MountPointReparseBuffer.PathBuffer +
00410                             reparse-&gt;MountPointReparseBuffer.SubstituteNameOffset);
00411         volumeName.Buffer[volumeName.Length/<span class="keyword">sizeof</span>(WCHAR)] = 0;
00412 
00413         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d7/dev2dos_8c.html#a5">IsVolumeName</a>(&amp;volumeName)) {
00414             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(reparse);
00415             ZwClose(h);
00416             <span class="keywordflow">continue</span>;
00417         }
00418 
00419         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(reparse);
00420 
00421         nameInfoSize = 1024;
00422         nameInfo = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, nameInfoSize);
00423         <span class="keywordflow">if</span> (!nameInfo) {
00424             ZwClose(h);
00425             <span class="keywordflow">continue</span>;
00426         }
00427 
00428         status = ZwQueryInformationFile(h, &amp;ioStatus, nameInfo, nameInfoSize,
00429                                         FileNameInformation);
00430         ZwClose(h);
00431         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00432             <span class="keywordflow">continue</span>;
00433         }
00434 
00435         Path-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) nameInfo-&gt;FileNameLength;
00436         Path-&gt;MaximumLength = Path-&gt;Length + <span class="keyword">sizeof</span>(WCHAR);
00437         Path-&gt;Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, Path-&gt;MaximumLength);
00438         <span class="keywordflow">if</span> (!Path-&gt;Buffer) {
00439             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(nameInfo);
00440             <span class="keywordflow">continue</span>;
00441         }
00442 
00443         RtlCopyMemory(Path-&gt;Buffer, nameInfo-&gt;FileName, Path-&gt;Length);
00444         Path-&gt;Buffer[Path-&gt;Length/<span class="keyword">sizeof</span>(WCHAR)] = 0;
00445 
00446         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(nameInfo);
00447         <span class="keywordflow">break</span>;
00448     }
00449 
00450     <span class="keywordflow">return</span> status;
00451 }
00452 
00453 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00454"></a><a class="code" href="../../d0/d7/dev2dos_8c.html#a7">00454</a> <a class="code" href="../../d0/d7/dev2dos_8c.html#a7">FindPathForDevice</a>(
00455     IN      PUNICODE_STRING StartingPath,
00456     IN      PUNICODE_STRING DeviceName,
00457     IN OUT  PLIST_ENTRY     DevicesInPath,
00458     OUT     PUNICODE_STRING FinalPath
00459     )
00460 
00461 <span class="comment">/*++</span>
00462 <span class="comment"></span>
00463 <span class="comment">Routine Description:</span>
00464 <span class="comment"></span>
00465 <span class="comment">    This routine finds a path (if any) to the given device that begins</span>
00466 <span class="comment">    with the given starting path.  The final path returned includes the</span>
00467 <span class="comment">    starting path.</span>
00468 <span class="comment"></span>
00469 <span class="comment">Arguments:</span>
00470 <span class="comment"></span>
00471 <span class="comment">    StartingPath    - Supplies the path to begin the search on.</span>
00472 <span class="comment"></span>
00473 <span class="comment">    DeviceName      - Supplies the device name whose path we are searching for.</span>
00474 <span class="comment"></span>
00475 <span class="comment">    DevicesInPath   - Supplies a list of the devices in all proper prefixes</span>
00476 <span class="comment">                            of the path.</span>
00477 <span class="comment"></span>
00478 <span class="comment">    FinalPath       - Returns the final path to the given device.</span>
00479 <span class="comment"></span>
00480 <span class="comment">Return Value:</span>
00481 <span class="comment"></span>
00482 <span class="comment">    NTSTATUS</span>
00483 <span class="comment"></span>
00484 <span class="comment">--*/</span>
00485 
00486 {
00487     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            status;
00488     UNICODE_STRING      startingDeviceName;
00489     PLIST_ENTRY         l;
00490     <a class="code" href="../../d0/d7/dev2dos_8c.html#a1">PDEVICE_NAME_ENTRY</a>  entry;
00491     HANDLE              h;
00492     UNICODE_STRING      <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>, newStart;
00493 
00494     status = <a class="code" href="../../d0/d7/dev2dos_8c.html#a3">QueryDeviceNameForPath</a>(StartingPath, &amp;startingDeviceName);
00495     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00496         <span class="keywordflow">return</span> status;
00497     }
00498 
00499     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(DeviceName, &amp;startingDeviceName, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00500         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(startingDeviceName.Buffer);
00501         FinalPath-&gt;Length = StartingPath-&gt;Length;
00502         FinalPath-&gt;MaximumLength = FinalPath-&gt;Length + <span class="keyword">sizeof</span>(WCHAR);
00503         FinalPath-&gt;Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00504                                            FinalPath-&gt;MaximumLength);
00505         <span class="keywordflow">if</span> (!FinalPath-&gt;Buffer) {
00506             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00507         }
00508 
00509         RtlCopyMemory(FinalPath-&gt;Buffer, StartingPath-&gt;Buffer,
00510                       FinalPath-&gt;Length);
00511         FinalPath-&gt;Buffer[FinalPath-&gt;Length/<span class="keyword">sizeof</span>(WCHAR)] = 0;
00512 
00513         <span class="keywordflow">return</span> STATUS_SUCCESS;
00514     }
00515 
00516     <span class="keywordflow">for</span> (l = DevicesInPath-&gt;Flink; l != DevicesInPath; l = l-&gt;Flink) {
00517         entry = CONTAINING_RECORD(l, <a class="code" href="../../d3/d4/struct__DEVICE__NAME__ENTRY.html">DEVICE_NAME_ENTRY</a>, ListEntry);
00518         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(&amp;entry-&gt;<a class="code" href="../../d3/d4/struct__DEVICE__NAME__ENTRY.html#o1">DeviceName</a>, &amp;startingDeviceName,
00519                                   <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00520 
00521             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(startingDeviceName.Buffer);
00522             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00523         }
00524     }
00525 
00526     status = <a class="code" href="../../d0/d7/dev2dos_8c.html#a4">OpenDeviceReparseIndex</a>(&amp;startingDeviceName, &amp;h);
00527     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00528         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(startingDeviceName.Buffer);
00529         <span class="keywordflow">return</span> status;
00530     }
00531 
00532     entry = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d4/struct__DEVICE__NAME__ENTRY.html">DEVICE_NAME_ENTRY</a>));
00533     <span class="keywordflow">if</span> (!entry) {
00534         ZwClose(h);
00535         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(startingDeviceName.Buffer);
00536         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00537     }
00538     entry-&gt;<a class="code" href="../../d3/d4/struct__DEVICE__NAME__ENTRY.html#o1">DeviceName</a> = startingDeviceName;
00539     InsertTailList(DevicesInPath, &amp;entry-&gt;<a class="code" href="../../d3/d4/struct__DEVICE__NAME__ENTRY.html#o0">ListEntry</a>);
00540 
00541     <span class="keywordflow">for</span> (;;) {
00542 
00543         status = <a class="code" href="../../d0/d7/dev2dos_8c.html#a6">GetNextReparseVolumePath</a>(h, &amp;<a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>);
00544         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00545             <span class="keywordflow">break</span>;
00546         }
00547         newStart.Length = StartingPath-&gt;Length + <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.Length;
00548         newStart.MaximumLength = newStart.Length + <span class="keyword">sizeof</span>(WCHAR);
00549         newStart.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, newStart.MaximumLength);
00550         <span class="keywordflow">if</span> (!newStart.Buffer) {
00551             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.Buffer);
00552             status = STATUS_INSUFFICIENT_RESOURCES;
00553             <span class="keywordflow">break</span>;
00554         }
00555 
00556         RtlCopyMemory(newStart.Buffer, StartingPath-&gt;Buffer,
00557                       StartingPath-&gt;Length);
00558         RtlCopyMemory((PCHAR) newStart.Buffer + StartingPath-&gt;Length,
00559                       <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.Buffer, <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.Length);
00560         newStart.Buffer[newStart.Length/<span class="keyword">sizeof</span>(WCHAR)] = 0;
00561         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.Buffer);
00562 
00563         status = <a class="code" href="../../d0/d7/dev2dos_8c.html#a7">FindPathForDevice</a>(&amp;newStart, DeviceName, DevicesInPath,
00564                                    FinalPath);
00565         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(newStart.Buffer);
00566         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00567             <span class="keywordflow">break</span>;
00568         }
00569     }
00570 
00571     RemoveEntryList(&amp;entry-&gt;<a class="code" href="../../d3/d4/struct__DEVICE__NAME__ENTRY.html#o0">ListEntry</a>);
00572     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(entry);
00573     ZwClose(h);
00574     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(startingDeviceName.Buffer);
00575 
00576     <span class="keywordflow">return</span> status;
00577 }
00578 
00579 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00580"></a><a class="code" href="../../d0/d7/dev2dos_8c.html#a8">00580</a> <a class="code" href="../../d0/d7/dev2dos_8c.html#a8">RtlVolumeDeviceToDosName</a>(
00581     IN  PVOID           VolumeDeviceObject,
00582     OUT PUNICODE_STRING DosName
00583     )
00584 
00585 <span class="comment">/*++</span>
00586 <span class="comment"></span>
00587 <span class="comment">Routine Description:</span>
00588 <span class="comment"></span>
00589 <span class="comment">    This routine returns a valid DOS path for the given device object.</span>
00590 <span class="comment">    This caller of this routine must call ExFreePool on DosName-&gt;Buffer</span>
00591 <span class="comment">    when it is no longer needed.</span>
00592 <span class="comment"></span>
00593 <span class="comment">Arguments:</span>
00594 <span class="comment"></span>
00595 <span class="comment">    VolumeDeviceObject  - Supplies the volume device object.</span>
00596 <span class="comment"></span>
00597 <span class="comment">    DosName             - Returns the DOS name for the volume</span>
00598 <span class="comment"></span>
00599 <span class="comment">Return Value:</span>
00600 <span class="comment"></span>
00601 <span class="comment">    NTSTATUS</span>
00602 <span class="comment"></span>
00603 <span class="comment">--*/</span>
00604 
00605 {
00606     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>  volumeDeviceObject = VolumeDeviceObject;
00607     PMOUNTDEV_NAME  name;
00608     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>            output[512];
00609     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>          event;
00610     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>            irp;
00611     IO_STATUS_BLOCK ioStatus;
00612     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        status;
00613     UNICODE_STRING  deviceName;
00614     WCHAR           buffer[30];
00615     UNICODE_STRING  driveLetterName;
00616     WCHAR           <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
00617     UNICODE_STRING  linkTarget;
00618     LIST_ENTRY      devicesInPath;
00619 
00620     name = (PMOUNTDEV_NAME) output;
00621     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;event, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00622     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a25">IoBuildDeviceIoControlRequest</a>(IOCTL_MOUNTDEV_QUERY_DEVICE_NAME,
00623                                         volumeDeviceObject, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, name, 512,
00624                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;event, &amp;ioStatus);
00625     <span class="keywordflow">if</span> (!irp) {
00626         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00627     }
00628 
00629     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>(volumeDeviceObject, irp);
00630     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
00631         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;event, <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00632         status = ioStatus.Status;
00633     }
00634 
00635     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00636         <span class="keywordflow">return</span> status;
00637     }
00638 
00639     deviceName.MaximumLength = deviceName.Length = name-&gt;NameLength;
00640     deviceName.Buffer = name-&gt;Name;
00641 
00642     swprintf(buffer, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\??\\C:"</span>);
00643     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;driveLetterName, buffer);
00644 
00645     <span class="keywordflow">for</span> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> = <span class="charliteral">'A'</span>; <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> &lt;= <span class="charliteral">'Z'</span>; <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>++) {
00646         driveLetterName.Buffer[4] = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
00647 
00648         status = <a class="code" href="../../d0/d7/dev2dos_8c.html#a2">QuerySymbolicLink</a>(&amp;driveLetterName, &amp;linkTarget);
00649         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00650             <span class="keywordflow">continue</span>;
00651         }
00652 
00653         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(&amp;linkTarget, &amp;deviceName, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00654             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(linkTarget.Buffer);
00655             <span class="keywordflow">break</span>;
00656         }
00657 
00658         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(linkTarget.Buffer);
00659     }
00660 
00661     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> &lt;= <span class="charliteral">'Z'</span>) {
00662         DosName-&gt;Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, 3*<span class="keyword">sizeof</span>(WCHAR));
00663         <span class="keywordflow">if</span> (!DosName-&gt;Buffer) {
00664             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00665         }
00666         DosName-&gt;MaximumLength = 6;
00667         DosName-&gt;Length = 4;
00668         DosName-&gt;Buffer[0] = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
00669         DosName-&gt;Buffer[1] = <span class="charliteral">':'</span>;
00670         DosName-&gt;Buffer[2] = 0;
00671         <span class="keywordflow">return</span> STATUS_SUCCESS;
00672     }
00673 
00674     <span class="keywordflow">for</span> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> = <span class="charliteral">'A'</span>; <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> &lt;= <span class="charliteral">'Z'</span>; <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>++) {
00675         driveLetterName.Buffer[4] = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
00676         InitializeListHead(&amp;devicesInPath);
00677         status = <a class="code" href="../../d0/d7/dev2dos_8c.html#a7">FindPathForDevice</a>(&amp;driveLetterName, &amp;deviceName,
00678                                    &amp;devicesInPath, DosName);
00679 
00680         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00681             DosName-&gt;Length -= 4*<span class="keyword">sizeof</span>(WCHAR);
00682             RtlMoveMemory(DosName-&gt;Buffer, &amp;DosName-&gt;Buffer[4],
00683                           DosName-&gt;Length);
00684             DosName-&gt;Buffer[DosName-&gt;Length/<span class="keyword">sizeof</span>(WCHAR)] = 0;
00685             <span class="keywordflow">return</span> status;
00686         }
00687     }
00688 
00689     <span class="keywordflow">return</span> status;
00690 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:40 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
