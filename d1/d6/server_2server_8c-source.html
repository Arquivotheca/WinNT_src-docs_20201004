<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: server.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>server.c</h1><a href="../../d0/d7/server_2server_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************************************************************\</span>
00002 <span class="comment">* Module Name: server.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Server support routines for the CSR stuff.</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* Created: 10-Dec-90</span>
00009 <span class="comment">*</span>
00010 <span class="comment">* History:</span>
00011 <span class="comment">*   10-Dec-90 created by sMeans</span>
00012 <span class="comment">*</span>
00013 <span class="comment">\**************************************************************************/</span>
00014 
00015 
00016 <span class="preprocessor">#include "<a class="code" href="../../d2/d4/w32_2ntuser_2server_2precomp_8h.html">precomp.h</a>"</span>
00017 <span class="preprocessor">#pragma hdrstop</span>
00018 <span class="preprocessor"></span>
00019 <span class="preprocessor">#include "dbt.h"</span>
00020 <span class="preprocessor">#include "ntdddisk.h"</span>
00021 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ntuser_8h.html">ntuser.h</a>"</span>
00022 <span class="preprocessor">#include &lt;regstr.h&gt;</span>
00023 
00024 
<a name="l00025"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a6">00025</a> HANDLE <a class="code" href="../../d0/d7/server_2server_8c.html#a6">hThreadNotification</a>;
<a name="l00026"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a7">00026</a> HANDLE <a class="code" href="../../d0/d7/server_2server_8c.html#a7">hKeyPriority</a>;
<a name="l00027"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a8">00027</a> UNICODE_STRING <a class="code" href="../../d0/d7/server_2server_8c.html#a8">PriorityValueName</a>;
<a name="l00028"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a9">00028</a> IO_STATUS_BLOCK <a class="code" href="../../d0/d7/server_2server_8c.html#a9">IoStatusRegChange</a>;
<a name="l00029"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a10">00029</a> ULONG <a class="code" href="../../d0/d7/server_2server_8c.html#a10">RegChangeBuffer</a>;
<a name="l00030"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a11">00030</a> HANDLE <a class="code" href="../../d0/d7/server_2server_8c.html#a11">ghNlsEvent</a>;
<a name="l00031"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a12">00031</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a12">gfLogon</a>;
<a name="l00032"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a13">00032</a> FARPROC <a class="code" href="../../d4/d5/w32_2ntuser_2server_2debug_8c.html#a0">gpfnAttachRoutine</a>;
<a name="l00033"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a14">00033</a> HANDLE <a class="code" href="../../d0/d7/server_2server_8c.html#a14">ghPowerRequestEvent</a>;
<a name="l00034"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a15">00034</a> HANDLE <a class="code" href="../../d0/d7/server_2server_8c.html#a15">ghMediaRequestEvent</a>;
00035 
<a name="l00036"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a0">00036</a> <span class="preprocessor">#define ID_NLS              0</span>
<a name="l00037"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a1">00037</a> <span class="preprocessor"></span><span class="preprocessor">#define ID_POWER            1</span>
<a name="l00038"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a2">00038</a> <span class="preprocessor"></span><span class="preprocessor">#define ID_MEDIACHANGE      2</span>
<a name="l00039"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a3">00039</a> <span class="preprocessor"></span><span class="preprocessor">#define ID_NETDEVCHANGE     3</span>
00040 <span class="preprocessor"></span>
<a name="l00041"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a4">00041</a> <span class="preprocessor">#define ID_NUM_EVENTS       4</span>
00042 <span class="preprocessor"></span>
00043 <span class="comment">//</span>
00044 <span class="comment">// Name of event to pulse to request a device-arrival broadcast,</span>
00045 <span class="comment">//</span>
<a name="l00046"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a5">00046</a> <span class="preprocessor">#define SC_BSM_EVENT_NAME   L"ScNetDrvMsg"</span>
00047 <span class="preprocessor"></span>
00048 <span class="comment">//</span>
00049 <span class="comment">// What the net drive bitmask was when we last broadcast (initially 0)</span>
00050 <span class="comment">//</span>
<a name="l00051"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a16">00051</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a16">LastNetDrives</a>;
00052 
00053 
<a name="l00054"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a17">00054</a> HANDLE <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a243">CsrApiPort</a>;
00055 HANDLE <a class="code" href="../../d2/d8/api_8c.html#a23">CsrQueryApiPort</a>(VOID);
00056 
00057 ULONG
00058 <a class="code" href="../../d0/d7/server_2server_8c.html#a24">SrvExitWindowsEx</a>(
00059     IN OUT PCSR_API_MSG m,
00060     IN OUT PCSR_REPLY_STATUS ReplyStatus);
00061 
00062 ULONG
00063 <a class="code" href="../../d0/d7/server_2server_8c.html#a25">SrvEndTask</a>(
00064     IN OUT PCSR_API_MSG m,
00065     IN OUT PCSR_REPLY_STATUS ReplyStatus);
00066 
00067 ULONG
00068 <a class="code" href="../../d0/d7/server_2server_8c.html#a26">SrvLogon</a>(
00069     IN OUT PCSR_API_MSG m,
00070     IN OUT PCSR_REPLY_STATUS ReplyStatus);
00071 
00072 ULONG
00073 <a class="code" href="../../d0/d7/server_2server_8c.html#a27">SrvRegisterServicesProcess</a>(
00074     IN OUT PCSR_API_MSG m,
00075     IN OUT PCSR_REPLY_STATUS ReplyStatus);
00076 
00077 ULONG
00078 <a class="code" href="../../d0/d7/server_2server_8c.html#a28">SrvActivateDebugger</a>(
00079     IN OUT PCSR_API_MSG m,
00080     IN OUT PCSR_REPLY_STATUS ReplyStatus);
00081 
00082 ULONG
00083 <a class="code" href="../../d0/d7/server_2server_8c.html#a29">SrvGetThreadConsoleDesktop</a>(
00084     IN OUT PCSR_API_MSG m,
00085     IN OUT PCSR_REPLY_STATUS ReplyStatus);
00086 
00087 ULONG
00088 <a class="code" href="../../d0/d7/server_2server_8c.html#a30">SrvDeviceEvent</a>(
00089     IN OUT PCSR_API_MSG m,
00090     IN OUT PCSR_REPLY_STATUS ReplyStatus);
00091 
00092 ULONG
00093 <a class="code" href="../../d0/d7/server_2server_8c.html#a31">SrvRegisterLogonProcess</a>(
00094     IN OUT PCSR_API_MSG m,
00095     IN OUT PCSR_REPLY_STATUS ReplyStatus);
00096 
00097 ULONG
00098 <a class="code" href="../../d0/d7/server_2server_8c.html#a32">SrvWin32HeapFail</a>(
00099     IN OUT PCSR_API_MSG m,
00100     IN OUT PCSR_REPLY_STATUS ReplyStatus);
00101 
00102 ULONG
00103 <a class="code" href="../../d0/d7/server_2server_8c.html#a33">SrvWin32HeapStat</a>(
00104     IN OUT PCSR_API_MSG m,
00105     IN OUT PCSR_REPLY_STATUS ReplyStatus);
00106 
<a name="l00107"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a18">00107</a> PCSR_API_ROUTINE <a class="code" href="../../d0/d7/server_2server_8c.html#a18">UserServerApiDispatchTable</a>[ <a class="code" href="../../d2/d0/csrmsg_8h.html#a35a34">UserpMaxApiNumber</a> - <a class="code" href="../../d2/d0/csrmsg_8h.html#a35a24">UserpExitWindowsEx</a> ] = {
00108     (PCSR_API_ROUTINE)<a class="code" href="../../d2/d0/server_2exitwin_8c.html#a20">SrvExitWindowsEx</a>,
00109     (PCSR_API_ROUTINE)<a class="code" href="../../d2/d0/server_2exitwin_8c.html#a21">SrvEndTask</a>,
00110     (PCSR_API_ROUTINE)<a class="code" href="../../d0/d7/server_2server_8c.html#a26">SrvLogon</a>,
00111     (PCSR_API_ROUTINE)<a class="code" href="../../d2/d0/server_2exitwin_8c.html#a23">SrvRegisterServicesProcess</a>,
00112     (PCSR_API_ROUTINE)<a class="code" href="../../d4/d5/w32_2ntuser_2server_2debug_8c.html#a1">SrvActivateDebugger</a>,
00113     (PCSR_API_ROUTINE)<a class="code" href="../../d0/d7/server_2server_8c.html#a29">SrvGetThreadConsoleDesktop</a>,
00114     (PCSR_API_ROUTINE)<a class="code" href="../../d1/d4/instdev_8c.html#a0">SrvDeviceEvent</a>,
00115     (PCSR_API_ROUTINE)<a class="code" href="../../d0/d7/server_2server_8c.html#a31">SrvRegisterLogonProcess</a>,
00116     (PCSR_API_ROUTINE)<a class="code" href="../../d0/d7/server_2server_8c.html#a32">SrvWin32HeapFail</a>,
00117     (PCSR_API_ROUTINE)<a class="code" href="../../d0/d7/server_2server_8c.html#a33">SrvWin32HeapStat</a>,
00118 };
00119 
<a name="l00120"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a19">00120</a> BOOLEAN <a class="code" href="../../d0/d7/server_2server_8c.html#a19">UserServerApiServerValidTable</a>[ <a class="code" href="../../d2/d0/csrmsg_8h.html#a35a34">UserpMaxApiNumber</a> - <a class="code" href="../../d2/d0/csrmsg_8h.html#a35a24">UserpExitWindowsEx</a> ] = {
00121     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,      <span class="comment">// ExitWindowsEx</span>
00122     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,      <span class="comment">// EndTask</span>
00123     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,      <span class="comment">// Logon</span>
00124     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,      <span class="comment">// RegisterServicesProcess</span>
00125     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,      <span class="comment">// ActivateDebugger</span>
00126     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,       <span class="comment">// GetThreadConsoleDesktop</span>
00127     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,      <span class="comment">// DeviceEvent</span>
00128     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,      <span class="comment">// RegisterLogonProcess</span>
00129     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,      <span class="comment">// Win32HeapFail</span>
00130     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,      <span class="comment">// Win32HeapStat</span>
00131 };
00132 
00133 <span class="preprocessor">#if DBG</span>
00134 <span class="preprocessor"></span>PSZ UserServerApiNameTable[ <a class="code" href="../../d2/d0/csrmsg_8h.html#a35a34">UserpMaxApiNumber</a> - <a class="code" href="../../d2/d0/csrmsg_8h.html#a35a24">UserpExitWindowsEx</a> ] = {
00135     <span class="stringliteral">"SrvExitWindowsEx"</span>,
00136     <span class="stringliteral">"SrvEndTask"</span>,
00137     <span class="stringliteral">"SrvLogon"</span>,
00138     <span class="stringliteral">"SrvRegisterServicesProcess"</span>,
00139     <span class="stringliteral">"SrvActivateDebugger"</span>,
00140     <span class="stringliteral">"SrvGetThreadConsoleDesktop"</span>,
00141     <span class="stringliteral">"SrvDeviceEvent"</span>,
00142     <span class="stringliteral">"SrvRegisterLogonProcess"</span>,
00143     <span class="stringliteral">"SrvWin32HeapFail"</span>,
00144     <span class="stringliteral">"SrvWin32HeapStat"</span>
00145 };
00146 <span class="preprocessor">#endif // DBG</span>
00147 <span class="preprocessor"></span>
00148 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00149 <a class="code" href="../../d0/d7/server_2server_8c.html#a34">UserServerDllInitialization</a>(
00150     PCSR_SERVER_DLL psrvdll
00151     );
00152 
00153 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a35">UserClientConnect</a>(PCSR_PROCESS Process, PVOID ConnectionInformation,
00154         PULONG pulConnectionLen);
00155 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>     <a class="code" href="../../d0/d7/server_2server_8c.html#a36">UserHardError</a>(PCSR_THREAD pcsrt, PHARDERROR_MSG pmsg);
00156 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a37">UserClientShutdown</a>(PCSR_PROCESS Process, ULONG dwFlags, BOOLEAN fFirstPass);
00157 
00158 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a38">GetTimeouts</a>(VOID);
00159 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a39">StartRegReadRead</a>(VOID);
00160 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a40">RegReadApcProcedure</a>(PVOID RegReadApcContext, PIO_STATUS_BLOCK IoStatus);
00161 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a41">NotificationThread</a>(PVOID);
<a name="l00162"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a20">00162</a> <span class="keyword">typedef</span> <a class="code" href="../../d0/d5/perfuser_8c.html#a20">BOOL</a> (*<a class="code" href="../../d0/d7/server_2server_8c.html#a20">PFNPROCESSCREATE</a>)(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, ULONG_PTR, <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
00163 
00164 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a42">InitializeConsoleAttributes</a>(VOID);
00165 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a43">GetThreadConsoleDesktop</a>(DWORD dwThreadId, HDESK *phdesk);
00166 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a44">MyRegOpenKey</a>(IN HANDLE hKey, IN LPWSTR lpSubKey, OUT PHANDLE phResult);
00167 
00168 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a45">BaseSetProcessCreateNotify</a>(PFNPROCESSCREATE pfn);
00169 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a46">BaseSrvNlsUpdateRegistryCache</a>(PVOID ApcContext,
00170                                              PIO_STATUS_BLOCK pIoStatusBlock);
00171 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a47">BaseSrvNlsLogon</a>(BOOL);
00172 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a48">WinStationAPIInit</a>(VOID);
00173 
00174 <span class="comment">/***************************************************************************\</span>
00175 <span class="comment">* UserServerDllInitialization</span>
00176 <span class="comment">*</span>
00177 <span class="comment">* Called by the CSR stuff to allow a server DLL to initialize itself and</span>
00178 <span class="comment">* provide information about the APIs it provides.</span>
00179 <span class="comment">*</span>
00180 <span class="comment">* Several operations are performed during this initialization:</span>
00181 <span class="comment">*</span>
00182 <span class="comment">* - The shared heap (client read-only) handle is initialized.</span>
00183 <span class="comment">* - The Raw Input Thread (RIT) is launched.</span>
00184 <span class="comment">* - GDI is initialized.</span>
00185 <span class="comment">*</span>
00186 <span class="comment">* History:</span>
00187 <span class="comment">* 10-19-92 DarrinM      Integrated xxxUserServerDllInitialize into this rtn.</span>
00188 <span class="comment">* 11-08-91 patrickh     move GDI init here from DLL init routine.</span>
00189 <span class="comment">* 12-10-90 sMeans       Created.</span>
00190 <span class="comment">\***************************************************************************/</span>
00191 
<a name="l00192"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a34">00192</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a34">UserServerDllInitialization</a>(
00193     PCSR_SERVER_DLL psrvdll)
00194 {
00195     CLIENT_ID ClientId;
00196     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bAllocated;
00197     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00198 
00199     <span class="comment">/*</span>
00200 <span class="comment">     * Initialize the RIP flags to default</span>
00201 <span class="comment">     */</span>
00202     <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a6">gdwRIPFlags</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a393">RIPF_DEFAULT</a>;
00203 
00204 <span class="preprocessor">#if DBG</span>
00205 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a25">RtlGetNtGlobalFlags</a>() &amp; FLG_SHOW_LDR_SNAPS) {
00206         RIPMSG0(RIP_WARNING,
00207                 <span class="stringliteral">"UserServerDllInitialization: entered"</span>);
00208     }
00209 <span class="preprocessor">#endif</span>
00210 <span class="preprocessor"></span>
00211     <span class="comment">/*</span>
00212 <span class="comment">     * Initialize a critical section structure that will be used to protect</span>
00213 <span class="comment">     * all of the User Server's critical sections (except a few special</span>
00214 <span class="comment">     * cases like the RIT -- see below).</span>
00215 <span class="comment">     */</span>
00216 
00217     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a>(&amp;<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a1">gcsUserSrv</a>);
00218     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00219     {
00220         RIPMSG1(RIP_WARNING,
00221                 <span class="stringliteral">"UserServerDllInitialization: InitializeCriticalSection failed with Status %x"</span>,
00222                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00223         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00224     }
00225     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00226 
00227     <span class="comment">/*</span>
00228 <span class="comment">     * Remember WINSRV.DLL's hmodule so we can grab resources from it later.</span>
00229 <span class="comment">     */</span>
00230     <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a0">ghModuleWin</a> = psrvdll-&gt;ModuleHandle;
00231 
00232     psrvdll-&gt;ApiNumberBase = USERSRV_FIRST_API_NUMBER;
00233     psrvdll-&gt;MaxApiNumber = <a class="code" href="../../d2/d0/csrmsg_8h.html#a35a34">UserpMaxApiNumber</a>;
00234     psrvdll-&gt;ApiDispatchTable = <a class="code" href="../../d0/d7/server_2server_8c.html#a18">UserServerApiDispatchTable</a>;
00235 
00236     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
00237         <a class="code" href="../../d0/d7/server_2server_8c.html#a19">UserServerApiServerValidTable</a>[0] = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>; <span class="comment">// for ExitWindowsEx</span>
00238     }
00239 
00240     psrvdll-&gt;ApiServerValidTable = <a class="code" href="../../d0/d7/server_2server_8c.html#a19">UserServerApiServerValidTable</a>;
00241 <span class="preprocessor">#if DBG</span>
00242 <span class="preprocessor"></span>    psrvdll-&gt;ApiNameTable = UserServerApiNameTable;
00243 <span class="preprocessor">#else</span>
00244 <span class="preprocessor"></span>    psrvdll-&gt;ApiNameTable = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00245 <span class="preprocessor">#endif</span>
00246 <span class="preprocessor"></span>    psrvdll-&gt;ConnectRoutine         = <a class="code" href="../../d0/d7/server_2server_8c.html#a35">UserClientConnect</a>;
00247     psrvdll-&gt;HardErrorRoutine       = <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a28">UserHardError</a>;
00248     psrvdll-&gt;ShutdownProcessRoutine = <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a9">UserClientShutdown</a>;
00249 
00250     <span class="comment">/*</span>
00251 <span class="comment">     * Create these events used by shutdown</span>
00252 <span class="comment">     */</span>
00253     <span class="comment">//BUGBUG we should test the return code of NtCreateEvent</span>
00254     <a class="code" href="../../d0/d8/ex_2event_8c.html#a5">NtCreateEvent</a>(&amp;<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a20">gheventCancel</a>, EVENT_ALL_ACCESS, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00255                   NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00256     <a class="code" href="../../d0/d8/ex_2event_8c.html#a5">NtCreateEvent</a>(&amp;<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a21">gheventCancelled</a>, EVENT_ALL_ACCESS, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00257                   NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00258 
00259     <span class="comment">/*</span>
00260 <span class="comment">     * Create the event used by the power request code.</span>
00261 <span class="comment">     */</span>
00262     <a class="code" href="../../d0/d8/ex_2event_8c.html#a5">NtCreateEvent</a>(&amp;<a class="code" href="../../d0/d7/server_2server_8c.html#a14">ghPowerRequestEvent</a>, EVENT_ALL_ACCESS, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00263                   SynchronizationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00264 
00265     <span class="comment">/*</span>
00266 <span class="comment">     * Create the event used by the media change code.</span>
00267 <span class="comment">     */</span>
00268     <a class="code" href="../../d0/d8/ex_2event_8c.html#a5">NtCreateEvent</a>(&amp;<a class="code" href="../../d0/d7/server_2server_8c.html#a15">ghMediaRequestEvent</a>, EVENT_ALL_ACCESS, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00269                   SynchronizationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00270 
00271     <span class="comment">/*</span>
00272 <span class="comment">     * Tell the base what user address to call when it is creating a process</span>
00273 <span class="comment">     * (but before the process starts running).</span>
00274 <span class="comment">     */</span>
00275     <a class="code" href="../../d0/d7/server_2server_8c.html#a45">BaseSetProcessCreateNotify</a>(<a class="code" href="../../d0/d0/ntuser_8h.html#a185">NtUserNotifyProcessCreate</a>);
00276 
00277     <span class="comment">/*</span>
00278 <span class="comment">     * Load some strings.</span>
00279 <span class="comment">     */</span>
00280     <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a15">gpwszaSUCCESS</a>            = (PWSTR)<a class="code" href="../../d7/d1/usersrv_8h.html#a57">RtlLoadStringOrError</a>(<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a0">ghModuleWin</a>,
00281                                 STR_SUCCESS, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;bAllocated, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00282     <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a16">gpwszaSYSTEM_INFORMATION</a> = (PWSTR)<a class="code" href="../../d7/d1/usersrv_8h.html#a57">RtlLoadStringOrError</a>(<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a0">ghModuleWin</a>,
00283                                 STR_SYSTEM_INFORMATION, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;bAllocated, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00284     <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a17">gpwszaSYSTEM_WARNING</a>     = (PWSTR)<a class="code" href="../../d7/d1/usersrv_8h.html#a57">RtlLoadStringOrError</a>(<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a0">ghModuleWin</a>,
00285                                 STR_SYSTEM_WARNING, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;bAllocated, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00286     <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a18">gpwszaSYSTEM_ERROR</a>       = (PWSTR)<a class="code" href="../../d7/d1/usersrv_8h.html#a57">RtlLoadStringOrError</a>(<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a0">ghModuleWin</a>,
00287                                 STR_SYSTEM_ERROR, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;bAllocated, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00288     <span class="comment">/*</span>
00289 <span class="comment">     * Initialize USER</span>
00290 <span class="comment">     */</span>
00291 
00292     {
00293         HANDLE hModBase;
00294 
00295         hModBase = GetModuleHandle(TEXT(<span class="stringliteral">"kernel32"</span>));
00296         UserAssert(hModBase);
00297         <a class="code" href="../../d4/d5/w32_2ntuser_2server_2debug_8c.html#a0">gpfnAttachRoutine</a> = GetProcAddress(hModBase,<span class="stringliteral">"BaseAttachCompleteThunk"</span>);
00298         UserAssert(<a class="code" href="../../d4/d5/w32_2ntuser_2server_2debug_8c.html#a0">gpfnAttachRoutine</a>);
00299 
00300         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d6/kernel_2server_8c.html#a83">NtUserInitialize</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a409">USERCURRENTVERSION</a>, <a class="code" href="../../d0/d7/server_2server_8c.html#a14">ghPowerRequestEvent</a>, <a class="code" href="../../d0/d7/server_2server_8c.html#a15">ghMediaRequestEvent</a>);
00301         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00302             RIPMSG1(RIP_WARNING,
00303                     <span class="stringliteral">"UserServerDllInitialization: NtUserInitialize failed with Status %x"</span>,
00304                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00305             <span class="keywordflow">goto</span> ExitUserInit;
00306         }
00307     }
00308 
00309     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
00310 
00311         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2server_8c.html#a48">WinStationAPIInit</a>();
00312         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00313             RIPMSG1(RIP_WARNING,
00314                     <span class="stringliteral">"UserServerDllInitialization: WinStationAPIInit failed with Status %x"</span>,
00315                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00316             <span class="keywordflow">goto</span> ExitUserInit;
00317         }
00318     }
00319 
00320     <span class="comment">/*</span>
00321 <span class="comment">     * Start registry notification thread</span>
00322 <span class="comment">     */</span>
00323     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/rtlexec_8c.html#a13">RtlCreateUserThread</a>(NtCurrentProcess(), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, 0, 0, 4*0x1000,
00324             (PUSER_THREAD_START_ROUTINE)<a class="code" href="../../d0/d7/server_2server_8c.html#a41">NotificationThread</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;<a class="code" href="../../d0/d7/server_2server_8c.html#a6">hThreadNotification</a>,
00325             &amp;ClientId);
00326     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00327         RIPMSG1(RIP_WARNING,
00328                 <span class="stringliteral">"UserServerDllInitialization: RtlCreateUserThread failed with Status %x"</span>,
00329                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00330     }
00331     CsrAddStaticServerThread(<a class="code" href="../../d0/d7/server_2server_8c.html#a6">hThreadNotification</a>, &amp;ClientId, 0);
00332 
00333 ExitUserInit:
00334     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00335     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00336 }
00337 
00338 <span class="comment">/**************************************************************************\</span>
00339 <span class="comment">* UserClientConnect</span>
00340 <span class="comment">*</span>
00341 <span class="comment">* This function is called once for each client process that connects to the</span>
00342 <span class="comment">* User server.  When the client dynlinks to USER.DLL, USER.DLL's init code</span>
00343 <span class="comment">* is executed and calls CsrClientConnectToServer to establish the connection.</span>
00344 <span class="comment">* The server portion of ConnectToServer calls out this entrypoint.</span>
00345 <span class="comment">*</span>
00346 <span class="comment">* UserClientConnect first verifies version numbers to make sure the client</span>
00347 <span class="comment">* is compatible with this server and then completes all process-specific</span>
00348 <span class="comment">* initialization.</span>
00349 <span class="comment">*</span>
00350 <span class="comment">* History:</span>
00351 <span class="comment">* 02-??-91 SMeans       Created.</span>
00352 <span class="comment">* 04-02-91 DarrinM      Added User intialization code.</span>
00353 <span class="comment">\**************************************************************************/</span>
00354 
<a name="l00355"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a21">00355</a> <span class="keyword">extern</span> WORD <a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a11">gDispatchTableValues</a>;
00356 
<a name="l00357"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a35">00357</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a35">UserClientConnect</a>(
00358     PCSR_PROCESS Process,
00359     PVOID ConnectionInformation,
00360     PULONG pulConnectionLen)
00361 {
00362     <span class="comment">/*</span>
00363 <span class="comment">     * Pass the api port to the kernel.  Do this early so the kernel</span>
00364 <span class="comment">     * can send a datagram to CSR to activate a debugger.</span>
00365 <span class="comment">     */</span>
00366     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a243">CsrApiPort</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00367         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a243">CsrApiPort</a> = <a class="code" href="../../d2/d8/api_8c.html#a23">CsrQueryApiPort</a>();
00368         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(
00369                 NtCurrentThread(),
00370                 UserThreadCsrApiPort,
00371                 &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a243">CsrApiPort</a>,
00372                 <span class="keyword">sizeof</span>(HANDLE));
00373     }
00374 
00375     UserAssert(*pulConnectionLen == <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__USERCONNECT.html">USERCONNECT</a>));
00376     <span class="keywordflow">if</span> (*pulConnectionLen != <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1005">USERCONNECT</a>)) {
00377         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00378     }
00379 
00380     ((<a class="code" href="../../d6/d4/struct__USERCONNECT.html">PUSERCONNECT</a>)ConnectionInformation)-&gt;dwDispatchCount = <a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a11">gDispatchTableValues</a>;
00381     <span class="keywordflow">return</span> <a class="code" href="../../d9/d6/kernel_2server_8c.html#a84">NtUserProcessConnect</a>(Process-&gt;ProcessHandle,
00382             (<a class="code" href="../../d6/d4/struct__USERCONNECT.html">PUSERCONNECT</a>)ConnectionInformation, *pulConnectionLen);
00383 }
00384 
00385 
00386 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00387"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a40">00387</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a40">RegReadApcProcedure</a>(
00388     PVOID RegReadApcContext,
00389     PIO_STATUS_BLOCK IoStatus
00390     )
00391 {
00392     UNICODE_STRING ValueString;
00393     LONG <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00394     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> Buf[<span class="keyword">sizeof</span>(KEY_VALUE_PARTIAL_INFORMATION) + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)];
00395     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbSize;
00396     ULONG l;
00397 
00398     UNREFERENCED_PARAMETER(RegReadApcContext);
00399     UNREFERENCED_PARAMETER(IoStatus);
00400 
00401     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;ValueString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Win32PrioritySeparation"</span>);
00402     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(<a class="code" href="../../d0/d7/server_2server_8c.html#a7">hKeyPriority</a>,
00403             &amp;ValueString,
00404             KeyValuePartialInformation,
00405             (PKEY_VALUE_PARTIAL_INFORMATION)Buf,
00406             <span class="keyword">sizeof</span>(Buf),
00407             &amp;cbSize);
00408     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00409         l = *((PDWORD)((PKEY_VALUE_PARTIAL_INFORMATION)Buf)-&gt;Data);
00410     } <span class="keywordflow">else</span> {
00411         l = PROCESS_PRIORITY_SEPARATION_MAX;  <span class="comment">// last resort default</span>
00412     }
00413 
00414     <a class="code" href="../../d6/d8/sysinfo_8c.html#a50">NtSetSystemInformation</a>(SystemPrioritySeperation,&amp;l,<span class="keyword">sizeof</span>(ULONG));
00415 
00416     <a class="code" href="../../d7/d7/ntapi_8c.html#a21">NtNotifyChangeKey</a>(
00417         <a class="code" href="../../d0/d7/server_2server_8c.html#a7">hKeyPriority</a>,
00418         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00419         (PIO_APC_ROUTINE)<a class="code" href="../../d0/d7/server_2server_8c.html#a40">RegReadApcProcedure</a>,
00420         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00421         &amp;<a class="code" href="../../d0/d7/server_2server_8c.html#a9">IoStatusRegChange</a>,
00422         REG_NOTIFY_CHANGE_LAST_SET,
00423         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00424         &amp;<a class="code" href="../../d0/d7/server_2server_8c.html#a10">RegChangeBuffer</a>,
00425         <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d7/server_2server_8c.html#a10">RegChangeBuffer</a>),
00426         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00427         );
00428 }
00429 
00430 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00431"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a39">00431</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a39">StartRegReadRead</a>(VOID)
00432 {
00433     UNICODE_STRING UnicodeString;
00434     OBJECT_ATTRIBUTES OA;
00435 
00436     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString,
00437             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\PriorityControl"</span>);
00438     InitializeObjectAttributes(&amp;OA, &amp;UnicodeString, OBJ_CASE_INSENSITIVE, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00439 
00440     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;<a class="code" href="../../d0/d7/server_2server_8c.html#a7">hKeyPriority</a>, KEY_READ | KEY_NOTIFY, &amp;OA)))
00441         UserAssert(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00442 
00443     <a class="code" href="../../d0/d7/server_2server_8c.html#a40">RegReadApcProcedure</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00444 }
00445 
00446 
00447 <span class="comment">/***************************************************************************\</span>
00448 <span class="comment">* HandleMediaChangeEvent</span>
00449 <span class="comment">*</span>
00450 <span class="comment">* This routine is responsible for broadcasting the WM_DEVICECHANGE message</span>
00451 <span class="comment">* when media arrives or is removed from a CD-ROM device.</span>
00452 <span class="comment">*</span>
00453 <span class="comment">* History:</span>
00454 <span class="comment">* 23-Feb-96     BradG       Modified to handle event per CD-ROM device</span>
00455 <span class="comment">* 23-April-96   Salimc      Some CD-ROM drives notify us that media has</span>
00456 <span class="comment">*                           arrived before the drive has recognized that it had</span>
00457 <span class="comment">*                           new media. The call to DeviceIoctl() will fail in</span>
00458 <span class="comment">*                           this case. To fix this we made the following changes</span>
00459 <span class="comment">*</span>
00460 <span class="comment">*                           aDriveState is an array of tri-state global variable</span>
00461 <span class="comment">*                           for each drive.Each variable starts off in an UNKNOWN</span>
00462 <span class="comment">*                           state and on the first event with any drive we do the</span>
00463 <span class="comment">*                           full MAX_TRIES or less CHECK_VERIFY's which then gets</span>
00464 <span class="comment">*                           us into either a INSERTED or EJECTED state. From then</span>
00465 <span class="comment">*                           on we know that each new event is going to be the</span>
00466 <span class="comment">*                           opposite of what we currently have.</span>
00467 <span class="comment">*</span>
00468 <span class="comment">*                           UNKNOWN =&gt; do upto MAX_TRIES CHECK_VERIFY's with</span>
00469 <span class="comment">*                           delay to get into EJECTED or INSERTED state.</span>
00470 <span class="comment">*</span>
00471 <span class="comment">*                           INSERTED =&gt; do 1 CHECK_VERIFY to get into</span>
00472 <span class="comment">*                           EJECTED state</span>
00473 <span class="comment">*</span>
00474 <span class="comment">*                           EJECTED =&gt; do upto MAX_TRIES CHECK_VERIFY's with</span>
00475 <span class="comment">*                           delay to get into INSERTED state</span>
00476 <span class="comment">*</span>
00477 <span class="comment">\***************************************************************************/</span>
00478 
<a name="l00479"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a49">00479</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a49">HandleMediaChangeEvent</a>(VOID)
00480 {
00481     <span class="comment">/*</span>
00482 <span class="comment">     * Local variables</span>
00483 <span class="comment">     */</span>
00484 
00485     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>                   dwRecipients;
00486     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>                    bResult;
00487     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00488     DEV_BROADCAST_VOLUME    dbcvInfo;
00489     USERTHREAD_USEDESKTOPINFO utudi;
00490 
00491     ULONG cDrive;
00492 
00493     <span class="keywordflow">while</span> (cDrive = (ULONG)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a173">NtUserCallNoParam</a>(SFI_GETDEVICECHANGEINFO)) {
00494 
00495         <span class="comment">/*</span>
00496 <span class="comment">         * Determine if it's an arrival or removal</span>
00497 <span class="comment">         */</span>
00498         bResult = (cDrive &amp; 0x80000000);
00499 
00500         <span class="comment">/*</span>
00501 <span class="comment">         * Initialize the structures used for BroadcastSystemMessage</span>
00502 <span class="comment">         */</span>
00503         dbcvInfo.dbcv_size = <span class="keyword">sizeof</span>(dbcvInfo);
00504         dbcvInfo.dbcv_devicetype = DBT_DEVTYP_VOLUME;
00505         dbcvInfo.dbcv_reserved = 0;
00506         dbcvInfo.dbcv_flags = DBTF_MEDIA;
00507         dbcvInfo.dbcv_unitmask = cDrive;
00508 
00509         dwRecipients = BSM_ALLCOMPONENTS | BSM_ALLDESKTOPS;
00510 
00511         <span class="comment">/*</span>
00512 <span class="comment">         * Temporarily we must assign this thread to a desktop so we can</span>
00513 <span class="comment">         * call USER's BroascastSystemMessage() routine.  We call the</span>
00514 <span class="comment">         * private SetThreadDesktopToDefault() to assign ourselves to the</span>
00515 <span class="comment">         * desktop that is currently receiving input.</span>
00516 <span class="comment">         */</span>
00517         utudi.hThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00518         utudi.drdRestore.pdeskRestore = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00519         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(NtCurrentThread(),
00520                                             UserThreadUseActiveDesktop,
00521                                             &amp;utudi, <span class="keyword">sizeof</span>(utudi));
00522         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00523             <span class="comment">/*</span>
00524 <span class="comment">             * Broadcast the message</span>
00525 <span class="comment">             */</span>
00526             <a class="code" href="../../d5/d9/cltxt_8h.html#a35">BroadcastSystemMessage</a>(BSF_FORCEIFHUNG | ((bResult) ? BSF_ALLOWSFW : 0),
00527                                    &amp;dwRecipients,
00528                                    WM_DEVICECHANGE,
00529 <span class="comment">// HACK: need to or 0x8000 in wParam</span>
00530 <span class="comment">//       because this is a flag to let</span>
00531 <span class="comment">//       BSM know that lParam is a pointer</span>
00532 <span class="comment">//       to a data structure.</span>
00533                                    0x8000 | ((bResult) ? DBT_DEVICEARRIVAL : DBT_DEVICEREMOVECOMPLETE),
00534                                    (LPARAM)&amp;dbcvInfo);
00535 
00536             <span class="comment">/*</span>
00537 <span class="comment">             * Set our thread's desktop back to NULL.  This will decrement</span>
00538 <span class="comment">             * the desktop's reference count.</span>
00539 <span class="comment">             */</span>
00540             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(NtCurrentThread(),
00541                                        UserThreadUseDesktop,
00542                                        &amp;utudi,
00543                                        <span class="keyword">sizeof</span>(utudi));
00544         }
00545     }
00546 }
00547 
00548 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
<a name="l00549"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a50">00549</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a50">GetNetworkDrives</a>(
00550     )
00551 <span class="comment">/*++</span>
00552 <span class="comment"></span>
00553 <span class="comment">Routine Description:</span>
00554 <span class="comment"></span>
00555 <span class="comment">    Returns a drive bitmask similar to GetLogicalDrives, but including</span>
00556 <span class="comment">    only the network drives.</span>
00557 <span class="comment"></span>
00558 <span class="comment">Arguments:</span>
00559 <span class="comment"></span>
00560 <span class="comment">Return Value:</span>
00561 <span class="comment"></span>
00562 <span class="comment"></span>
00563 <span class="comment">--*/</span>
00564 {
00565     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> Mask = 0;
00566     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> DriveNumber;
00567     PROCESS_DEVICEMAP_INFORMATION ProcessDeviceMapInfo;
00568 
00569     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d9/d1/psquery_8c.html#a18">NtQueryInformationProcess</a>( NtCurrentProcess(),
00570                                         ProcessDeviceMap,
00571                                         &amp;ProcessDeviceMapInfo.Query,
00572                                         <span class="keyword">sizeof</span>( ProcessDeviceMapInfo.Query ),
00573                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00574                                       ))) {
00575         <span class="comment">// For all the drives from C to Z</span>
00576         <span class="keywordflow">for</span> (DriveNumber = 2; DriveNumber &lt; 26; DriveNumber++)
00577         {
00578             <span class="keywordflow">if</span> (ProcessDeviceMapInfo.Query.DriveType[DriveNumber] == DOSDEVICE_DRIVE_REMOTE)
00579             {
00580                 Mask |= (1 &lt;&lt; DriveNumber);
00581             }
00582         }
00583     }
00584 
00585     <span class="keywordflow">return</span> Mask;
00586 }
00587 
00588 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00589"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a51">00589</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a51">HandleRemoteNetDeviceChangeEvent</a>(
00590     )
00591 <span class="comment">/*++</span>
00592 <span class="comment"></span>
00593 <span class="comment">Routine Description:</span>
00594 <span class="comment"></span>
00595 <span class="comment"></span>
00596 <span class="comment">Arguments:</span>
00597 <span class="comment"></span>
00598 <span class="comment">Return Value:</span>
00599 <span class="comment"></span>
00600 <span class="comment">--*/</span>
00601 {
00602     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    NetDrives;
00603     DEV_BROADCAST_VOLUME dbv;
00604     LONG status;
00605     USERTHREAD_USEDESKTOPINFO utudi;
00606 
00607 
00608 
00609     <span class="comment">/*</span>
00610 <span class="comment">     * Temporarily we must assign this thread to a desktop so we can</span>
00611 <span class="comment">     * call USER's BroascastSystemMessage() routine.  We call the</span>
00612 <span class="comment">     * private SetThreadDesktopToDefault() to assign ourselves to the</span>
00613 <span class="comment">     * desktop that is currently receiving input.</span>
00614 <span class="comment">     */</span>
00615     utudi.hThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00616     utudi.drdRestore.pdeskRestore = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00617     status = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(NtCurrentThread(),
00618                                         UserThreadUseActiveDesktop,
00619                                         &amp;utudi, <span class="keyword">sizeof</span>(utudi));
00620     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00621         <span class="keywordflow">return</span>;
00622     }
00623 
00624     <span class="comment">//</span>
00625     <span class="comment">// Keep broadcasting until the set of net drives stops changing</span>
00626     <span class="comment">//</span>
00627     <span class="keywordflow">for</span> (;;)
00628     {
00629 
00630         <span class="comment">//</span>
00631         <span class="comment">// Get the current net drive bitmask and compare against the net</span>
00632         <span class="comment">// drive bitmask when we last broadcast</span>
00633         <span class="comment">//</span>
00634         NetDrives = <a class="code" href="../../d0/d7/server_2server_8c.html#a50">GetNetworkDrives</a>();
00635 
00636         <span class="keywordflow">if</span> (NetDrives == <a class="code" href="../../d0/d7/server_2server_8c.html#a16">LastNetDrives</a>)
00637         {
00638             <span class="keywordflow">break</span>;
00639         }
00640 
00641         <span class="comment">//</span>
00642         <span class="comment">// Broadcast about deleted volumes</span>
00643         <span class="comment">//</span>
00644         dbv.dbcv_size       = <span class="keyword">sizeof</span>(dbv);
00645         dbv.dbcv_devicetype = DBT_DEVTYP_VOLUME;
00646         dbv.dbcv_reserved   = 0;
00647         dbv.dbcv_unitmask   = <a class="code" href="../../d0/d7/server_2server_8c.html#a16">LastNetDrives</a> &amp; ~NetDrives;
00648         dbv.dbcv_flags      = DBTF_NET;
00649         <span class="keywordflow">if</span> (dbv.dbcv_unitmask != 0)
00650         {
00651             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwRec = BSM_APPLICATIONS | BSM_ALLDESKTOPS;
00652             status = <a class="code" href="../../d5/d9/cltxt_8h.html#a35">BroadcastSystemMessage</a>(
00653                         BSF_FORCEIFHUNG | BSF_NOHANG | BSF_NOTIMEOUTIFNOTHUNG,
00654                         &amp;dwRec,
00655                         WM_DEVICECHANGE,
00656                         (WPARAM) DBT_DEVICEREMOVECOMPLETE,
00657                         (LPARAM)(DEV_BROADCAST_HDR*)(&amp;dbv)
00658                         );
00659 
00660         }
00661 
00662         <span class="comment">//</span>
00663         <span class="comment">// Broadcast about added volumes</span>
00664         <span class="comment">//</span>
00665         dbv.dbcv_unitmask   = NetDrives &amp; ~<a class="code" href="../../d0/d7/server_2server_8c.html#a16">LastNetDrives</a>;
00666         <span class="keywordflow">if</span> (dbv.dbcv_unitmask != 0)
00667         {
00668             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwRec = BSM_APPLICATIONS | BSM_ALLDESKTOPS;
00669 
00670             status = <a class="code" href="../../d5/d9/cltxt_8h.html#a35">BroadcastSystemMessage</a>(
00671                         BSF_FORCEIFHUNG | BSF_NOHANG | BSF_NOTIMEOUTIFNOTHUNG,
00672                         &amp;dwRec,
00673                         WM_DEVICECHANGE,
00674                         (WPARAM) DBT_DEVICEARRIVAL,
00675                         (LPARAM)(DEV_BROADCAST_HDR*)(&amp;dbv)
00676                         );
00677 
00678 
00679         }
00680 
00681         <span class="comment">//</span>
00682         <span class="comment">// Remember the drive set that we last broadcast about</span>
00683         <span class="comment">//</span>
00684         <a class="code" href="../../d0/d7/server_2server_8c.html#a16">LastNetDrives</a> = NetDrives;
00685 
00686         <span class="comment">//</span>
00687         <span class="comment">// Go around the loop again to detect changes that may have occurred</span>
00688         <span class="comment">// while we were broadcasting</span>
00689         <span class="comment">//</span>
00690     }
00691 
00692     <span class="comment">/*</span>
00693 <span class="comment">     * Set our thread's desktop back to NULL.  This will decrement</span>
00694 <span class="comment">     * the desktop's reference count.</span>
00695 <span class="comment">     */</span>
00696     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(NtCurrentThread(),
00697                                UserThreadUseDesktop,
00698                                &amp;utudi,
00699                                <span class="keyword">sizeof</span>(utudi));
00700 
00701     <span class="keywordflow">return</span>;
00702 }
00703 
00704 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00705"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a52">00705</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a52">CreateBSMEventSD</a>(
00706     PSECURITY_DESCRIPTOR * SecurityDescriptor
00707     )
00708 <span class="comment">/*++</span>
00709 <span class="comment"></span>
00710 <span class="comment">Routine Description:</span>
00711 <span class="comment"></span>
00712 <span class="comment">    This function creates a security descriptor for the BSM request event.</span>
00713 <span class="comment">    It grants EVENT_ALL_ACCESS to local system and EVENT_MODIFY_STATE access</span>
00714 <span class="comment">    to the rest of the world.  This prevents principals other than local</span>
00715 <span class="comment">    system from waiting for the event.</span>
00716 <span class="comment"></span>
00717 <span class="comment">Arguments:</span>
00718 <span class="comment"></span>
00719 <span class="comment">    SecurityDescriptor - Receives a pointer to the new security descriptor.</span>
00720 <span class="comment">        Should be freed with LocalFree.</span>
00721 <span class="comment"></span>
00722 <span class="comment">Return Value:</span>
00723 <span class="comment"></span>
00724 <span class="comment">    TRUE - success</span>
00725 <span class="comment"></span>
00726 <span class="comment">    FALSE - failure, use GetLastError</span>
00727 <span class="comment"></span>
00728 <span class="comment"></span>
00729 <span class="comment">--*/</span>
00730 {
00731     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00732     ULONG       AclLength;
00733     PACL        EventDacl;
00734     PSID        <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00735     PSID        SystemSid = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00736     SID_IDENTIFIER_AUTHORITY NtSidAuthority = SECURITY_NT_AUTHORITY;
00737     SID_IDENTIFIER_AUTHORITY WorldSidAuthority = SECURITY_WORLD_SID_AUTHORITY;
00738     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        retval = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00739 
00740     *SecurityDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00741 
00742     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a39">RtlAllocateAndInitializeSid</a>( &amp;NtSidAuthority,
00743                                           1,
00744                                           SECURITY_LOCAL_SYSTEM_RID,
00745                                           0, 0, 0, 0, 0, 0, 0,
00746                                           &amp;SystemSid );
00747 
00748     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00749         retval = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00750         <span class="keywordflow">goto</span> Cleanup;
00751     }
00752 
00753     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a39">RtlAllocateAndInitializeSid</a>( &amp;WorldSidAuthority,
00754                                           1,
00755                                           SECURITY_WORLD_RID,
00756                                           0, 0, 0, 0, 0, 0, 0,
00757                                           &amp;<a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a> );
00758 
00759     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00760         retval = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00761         <span class="keywordflow">goto</span> Cleanup;
00762     }
00763 
00764 
00765     <span class="comment">//</span>
00766     <span class="comment">// Allocate a buffer to contain the SD followed by the DACL</span>
00767     <span class="comment">// Note, the well-known SIDs are expected to have been created</span>
00768     <span class="comment">// by this time</span>
00769     <span class="comment">//</span>
00770 
00771     AclLength = (ULONG)<span class="keyword">sizeof</span>(ACL) +
00772                    (2*((ULONG)<span class="keyword">sizeof</span>(ACCESS_ALLOWED_ACE))) +
00773                    <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>( SystemSid ) +
00774                    <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>( <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a> ) +
00775                    8;       <span class="comment">// 8 is for good measure</span>
00776 
00777     *SecurityDescriptor = (PSECURITY_DESCRIPTOR)
00778         LocalAlloc( 0, SECURITY_DESCRIPTOR_MIN_LENGTH + AclLength );
00779 
00780     <span class="keywordflow">if</span> (*SecurityDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00781         retval = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00782         <span class="keywordflow">goto</span> Cleanup;
00783     }
00784 
00785     EventDacl = (PACL) ((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>*)(*SecurityDescriptor) + SECURITY_DESCRIPTOR_MIN_LENGTH);
00786 
00787 
00788     <span class="comment">//</span>
00789     <span class="comment">// Set up a default ACL</span>
00790     <span class="comment">//</span>
00791     <span class="comment">//    Public: WORLD:EVENT_MODIFY_STATE, SYSTEM:all</span>
00792 
00793     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( EventDacl, AclLength, ACL_REVISION2);
00794     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00795         retval = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00796         <span class="keywordflow">goto</span> Cleanup;
00797     }
00798 
00799 
00800     <span class="comment">//</span>
00801     <span class="comment">// WORLD access</span>
00802     <span class="comment">//</span>
00803 
00804     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> (
00805                  EventDacl,
00806                  ACL_REVISION2,
00807                  EVENT_MODIFY_STATE,
00808                  <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>
00809                  );
00810     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00811         retval = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00812         <span class="keywordflow">goto</span> Cleanup;
00813     }
00814 
00815 
00816     <span class="comment">//</span>
00817     <span class="comment">// SYSTEM access</span>
00818     <span class="comment">//</span>
00819 
00820     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> (
00821                  EventDacl,
00822                  ACL_REVISION2,
00823                  EVENT_ALL_ACCESS,
00824                  SystemSid
00825                  );
00826     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00827         retval = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00828         <span class="keywordflow">goto</span> Cleanup;
00829     }
00830 
00831 
00832 
00833     <span class="comment">//</span>
00834     <span class="comment">// Now initialize security descriptors</span>
00835     <span class="comment">// that export this protection</span>
00836     <span class="comment">//</span>
00837 
00838     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>(
00839                  *SecurityDescriptor,
00840                  SECURITY_DESCRIPTOR_REVISION1
00841                  );
00842     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00843         retval = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00844         <span class="keywordflow">goto</span> Cleanup;
00845     }
00846 
00847     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a>(
00848                  *SecurityDescriptor,
00849                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,                       <span class="comment">// DaclPresent</span>
00850                  EventDacl,
00851                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>                       <span class="comment">// DaclDefaulted</span>
00852                  );
00853 
00854     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00855         retval = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00856         <span class="keywordflow">goto</span> Cleanup;
00857     }
00858 
00859 Cleanup:
00860 
00861     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>) {
00862         <a class="code" href="../../d8/d6/sertl_8c.html#a41">RtlFreeSid</a>(<a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>);
00863     }
00864 
00865     <span class="keywordflow">if</span> (SystemSid) {
00866         <a class="code" href="../../d8/d6/sertl_8c.html#a41">RtlFreeSid</a>(SystemSid);
00867     }
00868 
00869     <span class="keywordflow">if</span> ((retval == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp; (*SecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00870         LocalFree(*SecurityDescriptor);
00871         *SecurityDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00872     }
00873 
00874 
00875     <span class="keywordflow">return</span> retval;
00876 }
00877 
00878 
00879 
00880 
<a name="l00881"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a41">00881</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a41">NotificationThread</a>(
00882     PVOID pJunk)
00883 {
00884     KPRIORITY   Priority;
00885     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00886     HANDLE      hEvent[<a class="code" href="../../d0/d7/server_2server_8c.html#a4">ID_NUM_EVENTS</a>];
00887     WCHAR       szObjectStr[<a class="code" href="../../d8/d9/dllinit_8c.html#a1">MAX_SESSION_PATH</a>];
00888     OBJECT_ATTRIBUTES Attributes;
00889     UNICODE_STRING UnicodeString;
00890     PSECURITY_DESCRIPTOR pSD = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00891     ULONG       NumEvents = <a class="code" href="../../d0/d7/server_2server_8c.html#a4">ID_NUM_EVENTS</a>;
00892 
00893     UNREFERENCED_PARAMETER(pJunk);
00894 
00895     <span class="keywordflow">try</span> {
00896 
00897         <span class="comment">/*</span>
00898 <span class="comment">         * Set the priority of the RIT to 3.</span>
00899 <span class="comment">         */</span>
00900         Priority = LOW_PRIORITY + 3;
00901         <a class="code" href="../../d9/d1/psquery_8c.html#a21">NtSetInformationThread</a>(<a class="code" href="../../d0/d7/server_2server_8c.html#a6">hThreadNotification</a>, ThreadPriority, &amp;Priority,
00902                 <span class="keyword">sizeof</span>(KPRIORITY));
00903 
00904         <span class="comment">/*</span>
00905 <span class="comment">         * Setup the NLS event</span>
00906 <span class="comment">         */</span>
00907         <a class="code" href="../../d0/d8/ex_2event_8c.html#a5">NtCreateEvent</a>(&amp;<a class="code" href="../../d0/d7/server_2server_8c.html#a11">ghNlsEvent</a>, EVENT_ALL_ACCESS, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, SynchronizationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00908         UserAssert( <a class="code" href="../../d0/d7/server_2server_8c.html#a11">ghNlsEvent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00909         hEvent[<a class="code" href="../../d0/d7/server_2server_8c.html#a0">ID_NLS</a>] = <a class="code" href="../../d0/d7/server_2server_8c.html#a11">ghNlsEvent</a>;
00910 
00911         <span class="comment">/*</span>
00912 <span class="comment">         * Setup the power request event</span>
00913 <span class="comment">         */</span>
00914         hEvent[<a class="code" href="../../d0/d7/server_2server_8c.html#a1">ID_POWER</a>] = <a class="code" href="../../d0/d7/server_2server_8c.html#a14">ghPowerRequestEvent</a>;
00915 
00916         <span class="comment">/*</span>
00917 <span class="comment">         * Setup the MediaChangeEvent</span>
00918 <span class="comment">         */</span>
00919         hEvent[<a class="code" href="../../d0/d7/server_2server_8c.html#a2">ID_MEDIACHANGE</a>] = <a class="code" href="../../d0/d7/server_2server_8c.html#a15">ghMediaRequestEvent</a>;
00920 
00921 
00922         <span class="comment">/*</span>
00923 <span class="comment">         *  Setup the NetDeviceChange Event</span>
00924 <span class="comment">         */</span>
00925 
00926         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a327">gSessionId</a> != 0) {
00927            <span class="comment">//</span>
00928            <span class="comment">// Only on remote Session</span>
00929            <span class="comment">//</span>
00930 
00931 
00932             swprintf(szObjectStr,<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%ws\\%ld\\BaseNamedObjects\\%ws"</span>,
00933                                                      <a class="code" href="../../d8/d9/dllinit_8c.html#a2">SESSION_ROOT</a>,<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a327">gSessionId</a>,<a class="code" href="../../d0/d7/server_2server_8c.html#a5">SC_BSM_EVENT_NAME</a>);
00934 
00935             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, szObjectStr);
00936 
00937             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d7/server_2server_8c.html#a52">CreateBSMEventSD</a>(&amp;pSD) ) {
00938 
00939                 InitializeObjectAttributes(&amp;Attributes,
00940                                            &amp;UnicodeString,
00941                                            OBJ_CASE_INSENSITIVE | OBJ_OPENIF,
00942                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00943                                            pSD);
00944 
00945                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d8/ex_2event_8c.html#a5">NtCreateEvent</a>(&amp;hEvent[<a class="code" href="../../d0/d7/server_2server_8c.html#a3">ID_NETDEVCHANGE</a>], EVENT_ALL_ACCESS, &amp;Attributes, SynchronizationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>))) {
00946 
00947                     NumEvents--;
00948 
00949                 }
00950 
00951                 LocalFree(pSD);
00952             } <span class="keywordflow">else</span> {
00953 
00954                 NumEvents--;
00955             }
00956 
00957         } <span class="keywordflow">else</span> {
00958             <span class="comment">//</span>
00959             <span class="comment">// On Console we don't wait for NetDeviceEvent</span>
00960             <span class="comment">//</span>
00961             NumEvents--;
00962         }
00963 
00964         <span class="comment">/*</span>
00965 <span class="comment">         * Only want media change events on the console.</span>
00966 <span class="comment">         */</span>
00967         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a327">gSessionId</a> == 0) {
00968         }
00969 
00970         <a class="code" href="../../d0/d7/server_2server_8c.html#a39">StartRegReadRead</a>();
00971 
00972         <span class="comment">/*</span>
00973 <span class="comment">         * Sit and wait forever.</span>
00974 <span class="comment">         */</span>
00975         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00976             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a5">NtWaitForMultipleObjects</a>(NumEvents,
00977                                               hEvent,
00978                                               WaitAny,
00979                                               <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00980                                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00981 
00982 
00983             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d0/d7/server_2server_8c.html#a0">ID_NLS</a> + WAIT_OBJECT_0) {
00984 
00985                 <span class="comment">/*</span>
00986 <span class="comment">                 * Handle the NLS event</span>
00987 <span class="comment">                 */</span>
00988                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d7/server_2server_8c.html#a12">gfLogon</a>) {
00989                     <a class="code" href="../../d0/d7/server_2server_8c.html#a12">gfLogon</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00990                     <a class="code" href="../../d0/d7/server_2server_8c.html#a46">BaseSrvNlsUpdateRegistryCache</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00991                 }
00992 
00993             }
00994             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d0/d7/server_2server_8c.html#a1">ID_POWER</a> + WAIT_OBJECT_0) {
00995 
00996                 <span class="comment">/*</span>
00997 <span class="comment">                 * Handle the power request event</span>
00998 <span class="comment">                 */</span>
00999                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a173">NtUserCallNoParam</a>(SFI_XXXUSERPOWERCALLOUTWORKER);
01000 
01001             }
01002             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d0/d7/server_2server_8c.html#a2">ID_MEDIACHANGE</a> + WAIT_OBJECT_0) {
01003 
01004                 <span class="comment">/*</span>
01005 <span class="comment">                 * Handle the media change event</span>
01006 <span class="comment">                 */</span>
01007                 <a class="code" href="../../d0/d7/server_2server_8c.html#a49">HandleMediaChangeEvent</a>();
01008 
01009                 <a class="code" href="../../d0/d8/ex_2event_8c.html#a9">NtResetEvent</a>(hEvent[<a class="code" href="../../d0/d7/server_2server_8c.html#a2">ID_MEDIACHANGE</a>], <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01010             }
01011             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d0/d7/server_2server_8c.html#a3">ID_NETDEVCHANGE</a> + WAIT_OBJECT_0) {
01012 
01013                 <span class="comment">/*</span>
01014 <span class="comment">                 * Handle the NetDevice change event for remote sessions</span>
01015 <span class="comment">                 */</span>
01016                 <a class="code" href="../../d0/d7/server_2server_8c.html#a51">HandleRemoteNetDeviceChangeEvent</a>();
01017 
01018             }
01019 
01020 
01021         } <span class="comment">// While (TRUE)</span>
01022 
01023     } except (CsrUnhandledExceptionFilter(GetExceptionInformation())) {
01024         KdPrint((<span class="stringliteral">"Registry notification thread is dead, sorry.\n"</span>));
01025     }
01026 }
01027 
01028 
<a name="l01029"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a53">01029</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a53">GetRegIntFromID</a>(
01030     HKEY hKey,
01031     <span class="keywordtype">int</span> KeyID,
01032     UINT nDefault)
01033 {
01034     LPWSTR lpszValue;
01035     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fAllocated;
01036     UNICODE_STRING Value;
01037     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbSize;
01038     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> Buf[<span class="keyword">sizeof</span>(KEY_VALUE_PARTIAL_INFORMATION) + 20 * <span class="keyword">sizeof</span>(WCHAR)];
01039     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01040     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> ReturnValue;
01041 
01042     lpszValue = (LPWSTR)<a class="code" href="../../d7/d1/usersrv_8h.html#a57">RtlLoadStringOrError</a>(<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a0">ghModuleWin</a>,
01043             KeyID, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;fAllocated, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01044 
01045     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Value, lpszValue);
01046     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(hKey,
01047             &amp;Value,
01048             KeyValuePartialInformation,
01049             (PKEY_VALUE_PARTIAL_INFORMATION)Buf,
01050             <span class="keyword">sizeof</span>(Buf),
01051             &amp;cbSize);
01052     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01053 
01054         <span class="comment">/*</span>
01055 <span class="comment">         * Convert string to int.</span>
01056 <span class="comment">         */</span>
01057         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Value, (LPWSTR)((PKEY_VALUE_PARTIAL_INFORMATION)Buf)-&gt;Data);
01058         <a class="code" href="../../d9/d3/cnvint_8c.html#a4">RtlUnicodeStringToInteger</a>(&amp;Value, 10, &amp;ReturnValue);
01059     } <span class="keywordflow">else</span> {
01060         ReturnValue = nDefault;
01061     }
01062 
01063     LocalFree(lpszValue);
01064 
01065     <span class="keywordflow">return</span>(ReturnValue);
01066 }
01067 
<a name="l01068"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a38">01068</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a38">GetTimeouts</a>(VOID)
01069 {
01070     HANDLE hCurrentUserKey;
01071     HANDLE hKey;
01072     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01073 
01074     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a27">RtlOpenCurrentUser</a>(MAXIMUM_ALLOWED, &amp;hCurrentUserKey);
01075     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01076         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2server_8c.html#a44">MyRegOpenKey</a>(hCurrentUserKey,
01077                 <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Control Panel\\Desktop"</span>,
01078                 &amp;hKey);
01079         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01080             <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a2">gCmsHungAppTimeout</a> = <a class="code" href="../../d0/d7/server_2server_8c.html#a53">GetRegIntFromID</a>(
01081                     hKey,
01082                     STR_CMSHUNGAPPTIMEOUT,
01083                     <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a2">gCmsHungAppTimeout</a>);
01084             <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a3">gCmsWaitToKillTimeout</a> = <a class="code" href="../../d0/d7/server_2server_8c.html#a53">GetRegIntFromID</a>(
01085                     hKey,
01086                     STR_CMSWAITTOKILLTIMEOUT,
01087                     <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a3">gCmsWaitToKillTimeout</a>);
01088 
01089             <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a4">gdwHungToKillCount</a> = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a3">gCmsWaitToKillTimeout</a> / <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a2">gCmsHungAppTimeout</a>;
01090 
01091             <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a5">gfAutoEndTask</a> = <a class="code" href="../../d0/d7/server_2server_8c.html#a53">GetRegIntFromID</a>(
01092                     hKey,
01093                     STR_AUTOENDTASK,
01094                     <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a5">gfAutoEndTask</a>);
01095             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hKey);
01096         }
01097         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hCurrentUserKey);
01098     }
01099 
01100     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2server_8c.html#a44">MyRegOpenKey</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01101             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control"</span>,
01102             &amp;hKey);
01103     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01104         <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a8">gdwServicesWaitToKillTimeout</a> = <a class="code" href="../../d0/d7/server_2server_8c.html#a53">GetRegIntFromID</a>(
01105                 hKey,
01106                 STR_WAITTOKILLSERVICETIMEOUT,
01107                 <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a3">gCmsWaitToKillTimeout</a>);
01108         <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a9">gdwProcessTerminateTimeout</a> = <a class="code" href="../../d0/d7/server_2server_8c.html#a53">GetRegIntFromID</a>(
01109                 hKey,
01110                 STR_PROCESSTERMINATETIMEOUT,
01111                 <a class="code" href="../../d1/d0/inc_2user_8h.html#a893">PROCESSTERMINATETIMEOUT</a>);
01112                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a9">gdwProcessTerminateTimeout</a> &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a912">CMSHUNGAPPTIMEOUT</a>) {
01113                         <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a9">gdwProcessTerminateTimeout</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a912">CMSHUNGAPPTIMEOUT</a>;
01114                 }
01115 
01116         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hKey);
01117     }
01118 }
01119 
01120 ULONG
<a name="l01121"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a26">01121</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a26">SrvLogon</a>(
01122     IN OUT PCSR_API_MSG m,
01123     IN OUT PCSR_REPLY_STATUS ReplyStatus)
01124 {
01125     <a class="code" href="../../d4/d3/struct__LOGONMSG.html">PLOGONMSG</a> a = (<a class="code" href="../../d4/d3/struct__LOGONMSG.html">PLOGONMSG</a>)&amp;m-&gt;u.ApiMessageData;
01126     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01127 
01128     UNREFERENCED_PARAMETER(ReplyStatus);
01129 
01130     <span class="keywordflow">if</span> (!CsrImpersonateClient(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))
01131         <span class="keywordflow">return</span> (ULONG)STATUS_UNSUCCESSFUL;
01132 
01133     <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d4/d3/struct__LOGONMSG.html#o0">fLogon</a>) {
01134 
01135         <span class="comment">/*</span>
01136 <span class="comment">         * Flush the MultiLingual UI (MUI) alternate</span>
01137 <span class="comment">         * resource modules from within NTDLL, so that the </span>
01138 <span class="comment">         * new user logging-on gets his chance to </span>
01139 <span class="comment">         * load his own.</span>
01140 <span class="comment">         */</span>
01141         <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a23">LdrFlushAlternateResourceModules</a>();
01142 
01143         <span class="comment">/*</span>
01144 <span class="comment">         *  Take care of NLS cache for LogON.</span>
01145 <span class="comment">         */</span>
01146         <a class="code" href="../../d0/d7/server_2server_8c.html#a47">BaseSrvNlsLogon</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01147 
01148         <span class="comment">/*</span>
01149 <span class="comment">         *  Set the cleanup event so that the RIT can handle the NLS</span>
01150 <span class="comment">         *  registry notification.</span>
01151 <span class="comment">         */</span>
01152         <a class="code" href="../../d0/d7/server_2server_8c.html#a12">gfLogon</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01153         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>( <a class="code" href="../../d0/d7/server_2server_8c.html#a11">ghNlsEvent</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01154         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01155     } <span class="keywordflow">else</span> {
01156 
01157         <span class="comment">/*</span>
01158 <span class="comment">         *  Take care of NLS cache for LogOFF.</span>
01159 <span class="comment">         */</span>
01160         <a class="code" href="../../d0/d7/server_2server_8c.html#a47">BaseSrvNlsLogon</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01161     }
01162 
01163     <span class="comment">/*</span>
01164 <span class="comment">     * Get timeout values from registry</span>
01165 <span class="comment">     */</span>
01166     <a class="code" href="../../d0/d7/server_2server_8c.html#a38">GetTimeouts</a>();
01167 
01168     CsrRevertToSelf();
01169 
01170     <span class="comment">/*</span>
01171 <span class="comment">     * Initialize console attributes</span>
01172 <span class="comment">     */</span>
01173     <a class="code" href="../../d0/d7/server_2server_8c.html#a42">InitializeConsoleAttributes</a>();
01174 
01175     <span class="keywordflow">return</span> (ULONG)STATUS_SUCCESS;
01176 }
01177 
01178 ULONG
<a name="l01179"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a31">01179</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a31">SrvRegisterLogonProcess</a>(
01180     IN OUT PCSR_API_MSG m,
01181     IN OUT PCSR_REPLY_STATUS ReplyStatus)
01182 {
01183     <span class="comment">/*</span>
01184 <span class="comment">     * Fail if this is not the first call.</span>
01185 <span class="comment">     */</span>
01186     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a10">gIdLogon</a> != 0) {
01187         <span class="keywordflow">return</span> (ULONG)STATUS_UNSUCCESSFUL;
01188     }
01189 
01190     <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a10">gIdLogon</a> = *(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>*)m-&gt;u.ApiMessageData;
01191 
01192     UNREFERENCED_PARAMETER(ReplyStatus);
01193 
01194     <span class="keywordflow">return</span> (ULONG)STATUS_SUCCESS;
01195 }
01196 
01197 ULONG
<a name="l01198"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a32">01198</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a32">SrvWin32HeapFail</a>(
01199     IN OUT PCSR_API_MSG m,
01200     IN OUT PCSR_REPLY_STATUS ReplyStatus)
01201 {
01202 <span class="preprocessor">#if DBG</span>
01203 <span class="preprocessor"></span>    <a class="code" href="../../d7/d8/struct__WIN32HEAPFAILMSG.html">PWIN32HEAPFAILMSG</a> a = (<a class="code" href="../../d7/d8/struct__WIN32HEAPFAILMSG.html">PWIN32HEAPFAILMSG</a>)&amp;m-&gt;u.ApiMessageData;
01204 
01205     Win32HeapFailAllocations(a-&gt;<a class="code" href="../../d7/d8/struct__WIN32HEAPFAILMSG.html#o1">bFail</a>);
01206 
01207 <span class="preprocessor">#endif</span>
01208 <span class="preprocessor"></span>    <span class="keywordflow">return</span> (ULONG)STATUS_SUCCESS;
01209     UNREFERENCED_PARAMETER(m);
01210     UNREFERENCED_PARAMETER(ReplyStatus);
01211 }
01212 
01213 ULONG
<a name="l01214"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a33">01214</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a33">SrvWin32HeapStat</a>(
01215     IN OUT PCSR_API_MSG m,
01216     IN OUT PCSR_REPLY_STATUS ReplyStatus)
01217 {
01218 <span class="preprocessor">#if DBG</span>
01219 <span class="preprocessor"></span>    <span class="keyword">extern</span> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> Win32HeapStat(PDBGHEAPSTAT phs, <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwLen, <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bNeedTagShift);
01220 
01221     <a class="code" href="../../d8/d8/struct__WIN32HEAPSTATMSG.html">PWIN32HEAPSTATMSG</a> a = (<a class="code" href="../../d8/d8/struct__WIN32HEAPSTATMSG.html">PWIN32HEAPSTATMSG</a>)&amp;m-&gt;u.ApiMessageData;
01222 
01223     <span class="keywordflow">if</span> (!CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d8/d8/struct__WIN32HEAPSTATMSG.html#o0">phs</a>, a-&gt;<a class="code" href="../../d8/d8/struct__WIN32HEAPSTATMSG.html#o1">dwLen</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>))) {
01224         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01225     }
01226     a-&gt;<a class="code" href="../../d8/d8/struct__WIN32HEAPSTATMSG.html#o2">dwMaxTag</a> = Win32HeapStat(a-&gt;<a class="code" href="../../d8/d8/struct__WIN32HEAPSTATMSG.html#o0">phs</a>, a-&gt;<a class="code" href="../../d8/d8/struct__WIN32HEAPSTATMSG.html#o1">dwLen</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01227 
01228 <span class="preprocessor">#endif</span>
01229 <span class="preprocessor"></span>    <span class="keywordflow">return</span> (ULONG)STATUS_SUCCESS;
01230     UNREFERENCED_PARAMETER(m);
01231     UNREFERENCED_PARAMETER(ReplyStatus);
01232 }
01233 
01234 ULONG
<a name="l01235"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a29">01235</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a29">SrvGetThreadConsoleDesktop</a>(
01236     IN OUT PCSR_API_MSG m,
01237     IN OUT PCSR_REPLY_STATUS ReplyStatus)
01238 {
01239     <a class="code" href="../../d2/d2/struct__GETTHREADCONSOLEDESKTOPMSG.html">PGETTHREADCONSOLEDESKTOPMSG</a> a = (<a class="code" href="../../d2/d2/struct__GETTHREADCONSOLEDESKTOPMSG.html">PGETTHREADCONSOLEDESKTOPMSG</a>)&amp;m-&gt;u.ApiMessageData;
01240 
01241     UNREFERENCED_PARAMETER(ReplyStatus);
01242 
01243     <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/server_2server_8c.html#a43">GetThreadConsoleDesktop</a>(a-&gt;<a class="code" href="../../d2/d2/struct__GETTHREADCONSOLEDESKTOPMSG.html#o0">dwThreadId</a>, &amp;a-&gt;<a class="code" href="../../d2/d2/struct__GETTHREADCONSOLEDESKTOPMSG.html#o1">hdeskConsole</a>);
01244 }
01245 
01246 <span class="comment">/***************************************************************************\</span>
01247 <span class="comment">* FindWindowFromThread</span>
01248 <span class="comment">*</span>
01249 <span class="comment">* This is a callback function passed to EnumThreadWindows by</span>
01250 <span class="comment">*  to find a top level window owned by a given thread;</span>
01251 <span class="comment">*  ideally, we want to find a top level owner.</span>
01252 <span class="comment">*</span>
01253 <span class="comment">* 07/18/96  GerardoB  Created</span>
01254 <span class="comment">\***************************************************************************/</span>
<a name="l01255"></a><a class="code" href="../../d7/d1/usersrv_8h.html#a55">01255</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> CALLBACK <a class="code" href="../../d7/d1/usersrv_8h.html#a55">FindWindowFromThread</a> (HWND hwnd, LPARAM lParam)
01256 {
01257     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fTopLevelOwner;
01258 <span class="preprocessor">#ifdef FE_IME</span>
01259 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( IsImeWindow(hwnd) ) {
01260         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01261     }
01262 <span class="preprocessor">#endif</span>
01263 <span class="preprocessor"></span>
01264     fTopLevelOwner = (<a class="code" href="../../d3/d9/client_2wow_8c.html#a12">GetWindow</a>(hwnd, GW_OWNER) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01265     <span class="keywordflow">if</span> ((*((HWND *)lParam) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || fTopLevelOwner) {
01266         *((HWND *)lParam) = hwnd;
01267     }
01268     <span class="keywordflow">return</span> !fTopLevelOwner;
01269 }
01270 
<a name="l01271"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a55">01271</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a55">GetRipComponent</a>(VOID) { <span class="keywordflow">return</span> RIP_USERSRV; }
01272 
<a name="l01273"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a56">01273</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a56">GetDbgTagFlags</a>(<span class="keywordtype">int</span> tag)
01274 {
01275     <span class="keywordflow">return</span> 0;
01276     UNREFERENCED_PARAMETER(tag);
01277 }
01278 
<a name="l01279"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a57">01279</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a57">GetRipPID</a>(VOID) { <span class="keywordflow">return</span> 0; }
<a name="l01280"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a58">01280</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a58">GetRipFlags</a>(VOID) { <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a6">gdwRIPFlags</a>; }
01281 
<a name="l01282"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a59">01282</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a59">SetRipFlags</a>(DWORD dwRipFlags, DWORD dwRipPID)
01283 {
01284     <span class="keywordflow">if</span> ((dwRipFlags != (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1) &amp;&amp; !(dwRipFlags &amp; ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a398">RIPF_VALIDUSERFLAGS</a>)) {
01285         <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a6">gdwRIPFlags</a> = (WORD)((<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a6">gdwRIPFlags</a> &amp; ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a398">RIPF_VALIDUSERFLAGS</a>) | dwRipFlags);
01286     }
01287     UNREFERENCED_PARAMETER(dwRipPID);
01288 }
01289 
<a name="l01290"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a60">01290</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a60">SetDbgTag</a>(<span class="keywordtype">int</span> tag, DWORD dwBitFlags)
01291 {
01292     UNREFERENCED_PARAMETER(tag);
01293     UNREFERENCED_PARAMETER(dwBitFlags);
01294 }
01295 
<a name="l01296"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a61">01296</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a61">UserRtlRaiseStatus</a>(NTSTATUS Status)
01297 {
01298     <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01299 }
01300 
01301 <span class="comment">/*</span>
01302 <span class="comment"> * We get this warning if we don't explicitly initalize gZero:</span>
01303 <span class="comment"> *</span>
01304 <span class="comment"> * C4132: 'gZero' : const object should be initialized</span>
01305 <span class="comment"> *</span>
01306 <span class="comment"> * But we can't explicitly initialize it since it is a union. So</span>
01307 <span class="comment"> * we turn the warning off.</span>
01308 <span class="comment"> */</span>
01309 <span class="preprocessor">#pragma warning(disable:4132)</span>
<a name="l01310"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a22">01310</a> <span class="preprocessor"></span>CONST <a class="code" href="../../d3/d8/uniontagALWAYSZERO.html">ALWAYSZERO</a> <a class="code" href="../../d1/d8/clglobal_8c.html#a0">gZero</a>;
01311 <span class="preprocessor">#pragma warning(default:4132)</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:47 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
