<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: fmtexp.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>fmtexp.c File Reference</h1><code>#include "<a class="el" href="../../d4/d2/arcinst_2precomp_8h-source.html">precomp.h</a>"</code><br>

<p>
<a href="../../d2/d5/fmtexp_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/structUNALIGNED__SECTOR__ZERO.html">UNALIGNED_SECTOR_ZERO</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d6/fmtexp_8c.html#a0">READ_SIZE</a>&nbsp;&nbsp;&nbsp;65536</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d6/fmtexp_8c.html#a1">CSEC_FAT32MEG</a>&nbsp;&nbsp;&nbsp;65536</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d6/fmtexp_8c.html#a2">CSEC_FAT16BIT</a>&nbsp;&nbsp;&nbsp;32680</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d6/fmtexp_8c.html#a3">SYSID_FAT12BIT</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d6/fmtexp_8c.html#a4">SYSID_FAT16BIT</a>&nbsp;&nbsp;&nbsp;4</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d6/fmtexp_8c.html#a5">SYSID_FAT32MEG</a>&nbsp;&nbsp;&nbsp;6</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d6/fmtexp_8c.html#a6">MIN_CLUS_BIG</a>&nbsp;&nbsp;&nbsp;4085</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d6/fmtexp_8c.html#a7">MAX_CLUS_BIG</a>&nbsp;&nbsp;&nbsp;65525</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d6/fmtexp_8c.html#a8">PUNALIGNED_SECTOR_ZERO</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d6/fmtexp_8c.html#a9">FmtIsFatPartition</a> (IN ULONG PartitionId, IN ULONG SectorSize, OUT PBOOLEAN IsFatPartition)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d6/fmtexp_8c.html#a10">FmtIsFat</a> (IN PCHAR PartitionPath, OUT PBOOLEAN IsFatPartition)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d6/fmtexp_8c.html#a11">ComputeSecPerCluster</a> (IN ULONG NumSectors, IN BOOLEAN SmallFat)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d6/fmtexp_8c.html#a12">ComputeNewSerialNumber</a> (IN ULONG <a class="el" href="../../d1/d1/theap_8c.html#a17">Seed</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d6/fmtexp_8c.html#a13">EditFat</a> (IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> ClusterNumber, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> ClusterEntry, IN OUT PUCHAR Fat, IN BOOLEAN SmallFat)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d6/fmtexp_8c.html#a14">FmtFillFormatBuffer</a> (IN ULONG NumberOfSectors, IN ULONG SectorSize, IN ULONG SectorsPerTrack, IN ULONG NumberOfHeads, IN ULONG NumberOfHiddenSectors, OUT PVOID FormatBuffer, IN ULONG FormatBufferSize, OUT PULONG SuperAreaSize, IN ULONG TimeSeed, IN PULONG BadSectorsList, IN ULONG NumberOfBadSectors)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d6/fmtexp_8c.html#a15">FmtVerifySectors</a> (IN ULONG PartitionId, IN ULONG NumberOfSectors, IN ULONG SectorSize, OUT PULONG *BadSectorsList, OUT PULONG NumberOfBadSectors)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d6/fmtexp_8c.html#a16">FmtFatFormat</a> (IN PCHAR PartitionPath, IN ULONG HiddenSectorCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d6/fmtexp_8c.html#a17">FmtQueryFatPartitionList</a> (OUT PCHAR **FatPartitionList, OUT PULONG ListLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d6/fmtexp_8c.html#a18">FmtFreeFatPartitionList</a> (IN OUT PCHAR *FatPartitionList, IN ULONG ListLength)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a2" doxytag="fmtexp.c::CSEC_FAT16BIT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CSEC_FAT16BIT&nbsp;&nbsp;&nbsp;32680          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00032">32</a> of file <a class="el" href="../../d2/d5/fmtexp_8c-source.html">fmtexp.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00273">FmtFillFormatBuffer()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="fmtexp.c::CSEC_FAT32MEG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CSEC_FAT32MEG&nbsp;&nbsp;&nbsp;65536          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00031">31</a> of file <a class="el" href="../../d2/d5/fmtexp_8c-source.html">fmtexp.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00273">FmtFillFormatBuffer()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="fmtexp.c::MAX_CLUS_BIG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MAX_CLUS_BIG&nbsp;&nbsp;&nbsp;65525          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00037">37</a> of file <a class="el" href="../../d2/d5/fmtexp_8c-source.html">fmtexp.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00146">ComputeSecPerCluster()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="fmtexp.c::MIN_CLUS_BIG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MIN_CLUS_BIG&nbsp;&nbsp;&nbsp;4085          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00036">36</a> of file <a class="el" href="../../d2/d5/fmtexp_8c-source.html">fmtexp.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00146">ComputeSecPerCluster()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="fmtexp.c::READ_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define READ_SIZE&nbsp;&nbsp;&nbsp;65536          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00004">4</a> of file <a class="el" href="../../d2/d5/fmtexp_8c-source.html">fmtexp.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00495">FmtVerifySectors()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="fmtexp.c::SYSID_FAT12BIT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SYSID_FAT12BIT&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00033">33</a> of file <a class="el" href="../../d2/d5/fmtexp_8c-source.html">fmtexp.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00273">FmtFillFormatBuffer()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="fmtexp.c::SYSID_FAT16BIT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SYSID_FAT16BIT&nbsp;&nbsp;&nbsp;4          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00034">34</a> of file <a class="el" href="../../d2/d5/fmtexp_8c-source.html">fmtexp.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00273">FmtFillFormatBuffer()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="fmtexp.c::SYSID_FAT32MEG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SYSID_FAT32MEG&nbsp;&nbsp;&nbsp;6          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00035">35</a> of file <a class="el" href="../../d2/d5/fmtexp_8c-source.html">fmtexp.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00273">FmtFillFormatBuffer()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a8" doxytag="fmtexp.c::PUNALIGNED_SECTOR_ZERO" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef   * <a class="el" href="../../d1/d6/fmtexp_8c.html#a8">PUNALIGNED_SECTOR_ZERO</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00273">FmtFillFormatBuffer()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a12" doxytag="fmtexp.c::ComputeNewSerialNumber" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG ComputeNewSerialNumber           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Seed</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00190">190</a> of file <a class="el" href="../../d2/d5/fmtexp_8c-source.html">fmtexp.c</a>.
<p>
References <a class="el" href="../../d5/d3/tprefix_8c-source.html#l00032">Seed</a>.
<p>
Referenced by <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00273">FmtFillFormatBuffer()</a>.
<p>
<pre class="fragment"><div>00195                    :
00196 
00197     This routine computes a <span class="keyword">new</span> serial number <span class="keywordflow">for</span> a volume.
00198 
00199 Arguments:
00200 
00201     <a class="code" href="../../d4/d4/tprefix_8c.html#a2">Seed</a>    - Supplies a seed <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> serial number.
00202 
00203 Return Value:
00204 
00205     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keyword">new</span> volume serial number.
00206 
00207 --*/
00208 {
00209     PUCHAR  p;
00210     ULONG   i;
00211 
00212     p = (PUCHAR) &amp;<a class="code" href="../../d4/d4/tprefix_8c.html#a2">Seed</a>;
00213 
00214     <span class="keywordflow">for</span> (i = 0; i &lt; <span class="keyword">sizeof</span>(ULONG); i++) {
00215 
00216         <a class="code" href="../../d4/d4/tprefix_8c.html#a2">Seed</a> += p[i];
00217         <a class="code" href="../../d4/d4/tprefix_8c.html#a2">Seed</a> = (<a class="code" href="../../d4/d4/tprefix_8c.html#a2">Seed</a> &gt;&gt; 2) + (<a class="code" href="../../d4/d4/tprefix_8c.html#a2">Seed</a> &lt;&lt; 30);
00218     }
00219 
00220     <span class="keywordflow">return</span> <a class="code" href="../../d4/d4/tprefix_8c.html#a2">Seed</a>;
00221 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="fmtexp.c::ComputeSecPerCluster" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> ComputeSecPerCluster           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumSectors</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SmallFat</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00146">146</a> of file <a class="el" href="../../d2/d5/fmtexp_8c-source.html">fmtexp.c</a>.
<p>
References <a class="el" href="../../d9/d5/sertl_8c-source.html#l00332">max</a>, <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00037">MAX_CLUS_BIG</a>, <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00036">MIN_CLUS_BIG</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00273">FmtFillFormatBuffer()</a>.
<p>
<pre class="fragment"><div>00152                    :
00153 
00154     This routine computes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of sectors per cluster.
00155 
00156 Arguments:
00157 
00158     NumSectors  - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of sectors on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disk.
00159     SmallFat    - Supplies whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FAT should be small.
00160 
00161 Return Value:
00162 
00163     The number of sectors per cluster necessary.
00164 
00165 --*/
00166 {
00167     ULONG   threshold;
00168     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>  sec_per_clus;
00169     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>  min_sec_per_clus;
00170 
00171     threshold = SmallFat ? <a class="code" href="../../d1/d6/fmtexp_8c.html#a6">MIN_CLUS_BIG</a> : <a class="code" href="../../d1/d6/fmtexp_8c.html#a7">MAX_CLUS_BIG</a>;
00172     sec_per_clus = 1;
00173 
00174     <span class="keywordflow">while</span> (NumSectors &gt;= threshold) {
00175         sec_per_clus *= 2;
00176         threshold *= 2;
00177     }
00178 
00179     <span class="keywordflow">if</span> (SmallFat) {
00180         min_sec_per_clus = 8;
00181     } <span class="keywordflow">else</span> {
00182         min_sec_per_clus = 4;
00183     }
00184 
00185     <span class="keywordflow">return</span> <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(sec_per_clus, min_sec_per_clus);
00186 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="fmtexp.c::EditFat" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID EditFat           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ClusterNumber</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ClusterEntry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PUCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Fat</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SmallFat</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00225">225</a> of file <a class="el" href="../../d2/d5/fmtexp_8c-source.html">fmtexp.c</a>.
<p>
References <a class="el" href="../../d8/d9/exts_8h-source.html#l00092">n</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00085">PUSHORT</a>.
<p>
Referenced by <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00273">FmtFillFormatBuffer()</a>.
<p>
<pre class="fragment"><div>00233                    :
00234 
00235     This routine edits <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FAT entry 'ClusterNumber' with 'ClusterEntry'.
00236 
00237 Arguments:
00238 
00239     ClusterNumber   - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cluster to edit.
00240     ClusterEntry    - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> value <span class="keywordflow">for</span> that cluster number.
00241     Fat             - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FAT to edit.
00242     SmallFat        - Supplies whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FAT <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> small.
00243 
00244 Return Value:
00245 
00246     None.
00247 
00248 --*/
00249 {
00250     ULONG   <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
00251 
00252     <span class="keywordflow">if</span> (SmallFat) {
00253 
00254         <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = ClusterNumber*3;
00255         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>%2) {
00256                 Fat[<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>/2] = (UCHAR) ((Fat[<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>/2]&amp;0x0F) | ((ClusterEntry&amp;0x000F)&lt;&lt;4));
00257             Fat[<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>/2 + 1] = (UCHAR) ((ClusterEntry&amp;0x0FF0)&gt;&gt;4);
00258         } <span class="keywordflow">else</span> {
00259             Fat[<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>/2] = (UCHAR) (ClusterEntry&amp;0x00FF);
00260                 Fat[<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>/2 + 1] = (UCHAR) ((Fat[<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>/2 + 1]&amp;0xF0) |
00261                                     ((ClusterEntry&amp;0x0F00)&gt;&gt;8));
00262         }
00263 
00264     } <span class="keywordflow">else</span> {
00265 
00266         ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>) Fat)[ClusterNumber] = ClusterEntry;
00267 
00268     }
00269 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="fmtexp.c::FmtFatFormat" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a> FmtFatFormat           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>PartitionPath</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>HiddenSectorCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00601">601</a> of file <a class="el" href="../../d2/d5/fmtexp_8c-source.html">fmtexp.c</a>.
<p>
References <a class="el" href="../../d5/d8/arcinst_8h-source.html#l00330">AllocateMemory</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l00040">ARC_STATUS</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01514">ArcClose</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01504">ArcGetTime</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01526">ArcOpen</a>, <a class="el" href="../../d1/d9/arc_8h.html#a317a240">ArcOpenReadWrite</a>, <a class="el" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>, <a class="el" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>, <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00273">FmtFillFormatBuffer()</a>, <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00495">FmtVerifySectors()</a>, <a class="el" href="../../d5/d8/arcinst_8h-source.html#l00332">FreeMemory</a>, <a class="el" href="../../d2/d5/low_8c-source.html#l00076">LowGetPartitionGeometry()</a>, <a class="el" href="../../d2/d5/low_8c-source.html#l00281">LowWriteSectors()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d8/d2/partit_8c-source.html#l00573">DoMakePartitionSystemPartition()</a>, and <a class="el" href="../../d8/d2/partit_8c-source.html#l00542">DoSystemPartitionCreate()</a>.
<p>
<pre class="fragment"><div>00607                    :
00608 
00609     This routine does a FAT <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a> on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given partition.
00610 
00611 Arguments:
00612 
00613     PartitionPath   - Supplies a <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> partition to <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>.
00614 
00615 Return Value:
00616 
00617     <a class="code" href="../../d4/d9/arcinst_8h.html#a125">LowGetPartitionGeometry</a>, <a class="code" href="../../d1/d9/arc_8h.html#a32">ArcOpen</a>,
00618     <a class="code" href="../../d1/d6/fmtexp_8c.html#a15">FmtVerifySectors</a>, <a class="code" href="../../d1/d6/fmtexp_8c.html#a14">FmtFillFormatBuffer</a>, <a class="code" href="../../d4/d9/arcinst_8h.html#a127">LowWriteSectors</a>,
00619     <a class="code" href="../../d1/d9/arc_8h.html#a29">ArcClose</a>, <a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>
00620 
00621 --*/
00622 {
00623     ULONG           num_sectors;
00624     ULONG           sector_size;
00625     ULONG           sec_per_track;
00626     ULONG           heads;
00627     ULONG           hidden_sectors;
00628     PULONG          bad_sectors;
00629     ULONG           num_bad_sectors;
00630     PVOID           format_buffer;
00631     ULONG           max_sec_per_sa;
00632     ULONG           super_area_size;
00633     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>      r;
00634     ULONG           partition_id;
00635     ULONG           time_seed;
00636     PTIME_FIELDS    ptime_fields;
00637 
00638 
00639     r = <a class="code" href="../../d1/d6/low_8c.html#a12">LowGetPartitionGeometry</a>(PartitionPath, &amp;num_sectors,
00640                                 &amp;sector_size, &amp;sec_per_track, &amp;heads);
00641 
00642     <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00643         <span class="keywordflow">return</span> r;
00644     }
00645 
00646     hidden_sectors = HiddenSectorCount;
00647 
00648     r = <a class="code" href="../../d1/d9/arc_8h.html#a32">ArcOpen</a>(PartitionPath, ArcOpenReadWrite, &amp;partition_id);
00649 
00650     <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00651         <span class="keywordflow">return</span> r;
00652     }
00653 
00654     bad_sectors = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00655 
00656     r = <a class="code" href="../../d1/d6/fmtexp_8c.html#a15">FmtVerifySectors</a>(partition_id, num_sectors, sector_size,
00657                          &amp;bad_sectors, &amp;num_bad_sectors);
00658 
00659     <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00660         <a class="code" href="../../d1/d9/arc_8h.html#a29">ArcClose</a>(partition_id);
00661         <span class="keywordflow">return</span> r;
00662     }
00663 
00664     max_sec_per_sa = 1 +
00665                      2*((2*65536 - 1)/sector_size + 1) +
00666                      ((512*32 - 1)/sector_size + 1);
00667 
00668     ptime_fields = <a class="code" href="../../d1/d9/arc_8h.html#a27">ArcGetTime</a>();
00669 
00670     time_seed = (ptime_fields-&gt;Year - 1970)*366*24*60*60 +
00671                 (ptime_fields-&gt;Month)*31*24*60*60 +
00672                 (ptime_fields-&gt;Day)*24*60*60 +
00673                 (ptime_fields-&gt;Hour)*60*60 +
00674                 (ptime_fields-&gt;Minute)*60 +
00675                 (ptime_fields-&gt;Second);
00676 
00677     <span class="keywordflow">if</span> (!(format_buffer = <a class="code" href="../../d4/d9/arcinst_8h.html#a20">AllocateMemory</a>(max_sec_per_sa*sector_size))) {
00678 
00679         <span class="keywordflow">if</span> (bad_sectors) {
00680             <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(bad_sectors);
00681         }
00682         <a class="code" href="../../d1/d9/arc_8h.html#a29">ArcClose</a>(partition_id);
00683         <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>;
00684     }
00685 
00686     r = <a class="code" href="../../d1/d6/fmtexp_8c.html#a14">FmtFillFormatBuffer</a>(num_sectors,
00687                             sector_size,
00688                             sec_per_track,
00689                             heads,
00690                             hidden_sectors,
00691                             format_buffer,
00692                             max_sec_per_sa*sector_size,
00693                             &amp;super_area_size,
00694                             time_seed,
00695                             bad_sectors,
00696                             num_bad_sectors);
00697 
00698 
00699     <span class="keywordflow">if</span> (bad_sectors) {
00700         <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(bad_sectors);
00701     }
00702 
00703     <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00704         <a class="code" href="../../d1/d9/arc_8h.html#a29">ArcClose</a>(partition_id);
00705         <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(format_buffer);
00706         <span class="keywordflow">return</span> r;
00707     }
00708 
00709     r = <a class="code" href="../../d1/d6/low_8c.html#a14">LowWriteSectors</a>(partition_id, sector_size, 0,
00710                         super_area_size/sector_size, format_buffer);
00711 
00712     <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(format_buffer);
00713 
00714     <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00715         <a class="code" href="../../d1/d9/arc_8h.html#a29">ArcClose</a>(partition_id);
00716         <span class="keywordflow">return</span> r;
00717     }
00718 
00719     <span class="keywordflow">return</span> <a class="code" href="../../d1/d9/arc_8h.html#a29">ArcClose</a>(partition_id);
00720 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="fmtexp.c::FmtFillFormatBuffer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a> FmtFillFormatBuffer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfSectors</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SectorSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SectorsPerTrack</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfHeads</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfHiddenSectors</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>FormatBuffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FormatBufferSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SuperAreaSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>TimeSeed</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BadSectorsList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBadSectors</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00273">273</a> of file <a class="el" href="../../d2/d5/fmtexp_8c-source.html">fmtexp.c</a>.
<p>
References <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00190">ComputeNewSerialNumber()</a>, <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00146">ComputeSecPerCluster()</a>, <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00032">CSEC_FAT16BIT</a>, <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00031">CSEC_FAT32MEG</a>, <a class="el" href="../../d2/d9/arccodes_8h.html#a24a2">E2BIG</a>, <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00225">EditFat()</a>, <a class="el" href="../../d2/d9/arccodes_8h.html#a24a8">EINVAL</a>, <a class="el" href="../../d2/d9/arccodes_8h.html#a24a9">EIO</a>, <a class="el" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>, <a class="el" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>, <a class="el" href="../../d1/d6/fmtexp_8c.html#a8">PUNALIGNED_SECTOR_ZERO</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00230">SectorSize</a>, <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00033">SYSID_FAT12BIT</a>, <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00034">SYSID_FAT16BIT</a>, <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00035">SYSID_FAT32MEG</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00601">FmtFatFormat()</a>.
<p>
<pre class="fragment"><div>00288                    :
00289 
00290     This routine computes a FAT super area based on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disk size,
00291     disk geometry, and bad sectors of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume.
00292 
00293 Arguments:
00294 
00295     NumberOfSectors         - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of sectors on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume.
00296     <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>              - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes per sector.
00297     SectorsPerTrack         - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of sectors per track.
00298     NumberOfHeads           - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of heads.
00299     NumberOfHiddenSectors   - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of hidden sectors.
00300     FormatBuffer            - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> super area <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume.
00301     FormatBufferSize        - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supplied
00302                                 buffer.
00303     SuperAreaSize           - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> super area.
00304     TimeSeed                - Supplies a time seed <span class="keywordflow">for</span> serial number.
00305     BadSectorsList          - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of bad sectors on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume.
00306     NumberOfBadSectors      - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bad sectors in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list.
00307 
00308 Return Value:
00309 
00310     <a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>  - The buffer wasn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> big enough.
00311     <a class="code" href="../../d2/d9/arccodes_8h.html#a24a2">E2BIG</a>   - The disk <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> too large to be formatted.
00312     <a class="code" href="../../d2/d9/arccodes_8h.html#a24a9">EIO</a>     - There <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a bad sector in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> super area.
00313     <a class="code" href="../../d2/d9/arccodes_8h.html#a24a8">EINVAL</a>  - There <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a bad sector off <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disk.
00314     <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>
00315 
00316 --*/
00317 {
00318     <a class="code" href="../../d1/d6/fmtexp_8c.html#a8">PUNALIGNED_SECTOR_ZERO</a>  psecz;
00319     PUCHAR                  puchar;
00320     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>                  tmp_ushort;
00321     ULONG                   tmp_ulong;
00322     BOOLEAN                 small_fat;
00323     ULONG                   num_sectors;
00324     ULONG                   partition_id;
00325     ULONG                   sec_per_fat;
00326     ULONG                   sec_per_root;
00327     ULONG                   sec_per_clus;
00328     ULONG                   i;
00329     ULONG                   sec_per_sa;
00330 
00331 
00332     <span class="comment">// First memset the buffer to all zeros;</span>
00333     memset(FormatBuffer, 0, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) FormatBufferSize);
00334 
00335 
00336     <span class="comment">// Make sure that there's enough room for the BPB.</span>
00337 
00338     <span class="keywordflow">if</span> (!FormatBuffer || FormatBufferSize &lt; <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>) {
00339         <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>;
00340     }
00341 
00342     <span class="comment">// Compute the number of sectors on disk.</span>
00343     num_sectors = NumberOfSectors;
00344 
00345     <span class="comment">// Compute the partition identifier.</span>
00346     partition_id = num_sectors &lt; <a class="code" href="../../d1/d6/fmtexp_8c.html#a2">CSEC_FAT16BIT</a> ? <a class="code" href="../../d1/d6/fmtexp_8c.html#a3">SYSID_FAT12BIT</a> :
00347                    num_sectors &lt; <a class="code" href="../../d1/d6/fmtexp_8c.html#a1">CSEC_FAT32MEG</a> ? <a class="code" href="../../d1/d6/fmtexp_8c.html#a4">SYSID_FAT16BIT</a> :
00348                                                  <a class="code" href="../../d1/d6/fmtexp_8c.html#a5">SYSID_FAT32MEG</a>;
00349 
00350     <span class="comment">// Compute whether or not to have a big or small FAT.</span>
00351     small_fat = (BOOLEAN) (partition_id == <a class="code" href="../../d1/d6/fmtexp_8c.html#a3">SYSID_FAT12BIT</a>);
00352 
00353 
00354     psecz = (<a class="code" href="../../d1/d6/fmtexp_8c.html#a8">PUNALIGNED_SECTOR_ZERO</a>) FormatBuffer;
00355     puchar = (PUCHAR) FormatBuffer;
00356 
00357     <span class="comment">// Set up the jump instruction.</span>
00358     psecz-&gt;IntelNearJumpCommand[0] = 0xEB;
00359     tmp_ushort = 0x903C;
00360     memcpy(psecz-&gt;BootStrapJumpOffset, &amp;tmp_ushort, <span class="keyword">sizeof</span>(USHORT));
00361 
00362     <span class="comment">// Set up the OEM data.</span>
00363     memcpy(psecz-&gt;OemData, <span class="stringliteral">"WINNT1.0"</span>, 8); <span class="comment">// BUGBUG norbertk</span>
00364 
00365     <span class="comment">// Set up the bytes per sector.</span>
00366     tmp_ushort = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>;
00367     memcpy(psecz-&gt;BytesPerSector, &amp;tmp_ushort, <span class="keyword">sizeof</span>(USHORT));
00368 
00369     <span class="comment">// Set up the number of sectors per cluster.</span>
00370     sec_per_clus = <a class="code" href="../../d1/d6/fmtexp_8c.html#a11">ComputeSecPerCluster</a>(num_sectors, small_fat);
00371     <span class="keywordflow">if</span> (sec_per_clus &gt; 128) {
00372 
00373         <span class="comment">// The disk is too large to be formatted.</span>
00374         <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a2">E2BIG</a>;
00375     }
00376     psecz-&gt;SectorsPerCluster[0] = (UCHAR) sec_per_clus;
00377 
00378     <span class="comment">// Set up the number of reserved sectors.</span>
00379     tmp_ushort = 1;
00380     memcpy(psecz-&gt;ReservedSectors, &amp;tmp_ushort, <span class="keyword">sizeof</span>(USHORT));
00381 
00382     <span class="comment">// Set up the number of FATs.</span>
00383     psecz-&gt;Fats[0] = 2;
00384 
00385     <span class="comment">// Set up the number of root entries and number of sectors for the root.</span>
00386     tmp_ushort = 512;
00387     memcpy(psecz-&gt;RootEntries, &amp;tmp_ushort, <span class="keyword">sizeof</span>(USHORT));
00388     sec_per_root = (512*32 - 1)/<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a> + 1;
00389 
00390     <span class="comment">// Set up the number of sectors.</span>
00391     <span class="keywordflow">if</span> (num_sectors &gt;= 1&lt;&lt;16) {
00392         tmp_ushort = 0;
00393         tmp_ulong = num_sectors;
00394     } <span class="keywordflow">else</span> {
00395         tmp_ushort = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) num_sectors;
00396         tmp_ulong = 0;
00397     }
00398     memcpy(psecz-&gt;Sectors, &amp;tmp_ushort, <span class="keyword">sizeof</span>(USHORT));
00399     memcpy(psecz-&gt;LargeSectors, &amp;tmp_ulong, <span class="keyword">sizeof</span>(ULONG));
00400 
00401     <span class="comment">// Set up the media byte.</span>
00402     psecz-&gt;Media[0] = 0xF8;
00403 
00404     <span class="comment">// Set up the number of sectors per FAT.</span>
00405     <span class="keywordflow">if</span> (small_fat) {
00406         sec_per_fat = num_sectors/(2 + <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>*sec_per_clus*2/3);
00407     } <span class="keywordflow">else</span> {
00408         sec_per_fat = num_sectors/(2 + <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>*sec_per_clus/2);
00409     }
00410     sec_per_fat++;
00411     tmp_ushort = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) sec_per_fat;
00412     memcpy(psecz-&gt;SectorsPerFat, &amp;tmp_ushort, <span class="keyword">sizeof</span>(USHORT));
00413 
00414     <span class="comment">// Set up the number of sectors per track.</span>
00415     tmp_ushort = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) SectorsPerTrack;
00416     memcpy(psecz-&gt;SectorsPerTrack, &amp;tmp_ushort, <span class="keyword">sizeof</span>(USHORT));
00417 
00418     <span class="comment">// Set up the number of heads.</span>
00419     tmp_ushort = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) NumberOfHeads;
00420     memcpy(psecz-&gt;Heads, &amp;tmp_ushort, <span class="keyword">sizeof</span>(USHORT));
00421 
00422     <span class="comment">// Set up the number of hidden sectors.</span>
00423     memcpy(psecz-&gt;HiddenSectors, &amp;NumberOfHiddenSectors, <span class="keyword">sizeof</span>(ULONG));
00424 
00425     <span class="comment">// Set up the physical drive number.</span>
00426     psecz-&gt;PhysicalDrive[0] = 0x80;
00427 
00428     <span class="comment">// Set up the BPB signature.</span>
00429     psecz-&gt;Signature[0] = 0x29;
00430 
00431     <span class="comment">// Set up the serial number.</span>
00432     tmp_ulong = <a class="code" href="../../d1/d6/fmtexp_8c.html#a12">ComputeNewSerialNumber</a>(TimeSeed);
00433     memcpy(psecz-&gt;SerialNumber, &amp;tmp_ulong, <span class="keyword">sizeof</span>(ULONG));
00434 
00435     <span class="comment">// Set up the system id.</span>
00436     memcpy(psecz-&gt;SystemIdText, <span class="stringliteral">"FAT     "</span>, 8);
00437 
00438     <span class="comment">// Set up the boot signature.</span>
00439     puchar[510] = 0x55;
00440     puchar[511] = 0xAA;
00441 
00442 
00443     <span class="comment">// Now make sure that the buffer has enough room for both of the</span>
00444     <span class="comment">// FATs and the root directory.</span>
00445 
00446     sec_per_sa = 1 + 2*sec_per_fat + sec_per_root;
00447     *SuperAreaSize = <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>*sec_per_sa;
00448     <span class="keywordflow">if</span> (*SuperAreaSize &gt; FormatBufferSize) {
00449         <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>;
00450     }
00451 
00452 
00453     <span class="comment">// Set up the first FAT.</span>
00454 
00455     puchar[<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>] = 0xF8;
00456     puchar[<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a> + 1] = 0xFF;
00457     puchar[<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a> + 2] = 0xFF;
00458 
00459     <span class="keywordflow">if</span> (!small_fat) {
00460         puchar[<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a> + 3] = 0xFF;
00461     }
00462 
00463 
00464     <span class="keywordflow">for</span> (i = 0; i &lt; NumberOfBadSectors; i++) {
00465 
00466         <span class="keywordflow">if</span> (BadSectorsList[i] &lt; sec_per_sa) {
00467             <span class="comment">// There's a bad sector in the super area.</span>
00468             <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a9">EIO</a>;
00469         }
00470 
00471         <span class="keywordflow">if</span> (BadSectorsList[i] &gt;= num_sectors) {
00472             <span class="comment">// Bad sector out of range.</span>
00473             <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a8">EINVAL</a>;
00474         }
00475 
00476         <span class="comment">// Compute the bad cluster number;</span>
00477         tmp_ushort = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)
00478                      ((BadSectorsList[i] - sec_per_sa)/sec_per_clus + 2);
00479 
00480         <a class="code" href="../../d1/d6/fmtexp_8c.html#a13">EditFat</a>(tmp_ushort, (USHORT) 0xFFF7, &amp;puchar[SectorSize], small_fat);
00481     }
00482 
00483 
00484     <span class="comment">// Copy the first FAT onto the second.</span>
00485 
00486     memcpy(&amp;puchar[SectorSize*(1 + sec_per_fat)],
00487            &amp;puchar[SectorSize],
00488            (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) SectorSize*sec_per_fat);
00489 
00490     <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>;
00491 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="fmtexp.c::FmtFreeFatPartitionList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a> FmtFreeFatPartitionList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>FatPartitionList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ListLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00919">919</a> of file <a class="el" href="../../d2/d5/fmtexp_8c-source.html">fmtexp.c</a>.
<p>
References <a class="el" href="../../d2/d5/low_8c-source.html#l00721">LowFreePathList()</a>.
<p>
<pre class="fragment"><div>00925                    :
00926 
00927     This routine frees up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> heap space taken by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FAT partition
00928     list.
00929 
00930 Arguments:
00931 
00932     FatPartitionList    - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer to free.
00933     ListLength          - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer length.
00934 
00935 Return Value:
00936 
00937     <a class="code" href="../../d4/d9/arcinst_8h.html#a131">LowFreePathList</a>
00938 
00939 --*/
00940 {
00941     <span class="keywordflow">return</span> <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(FatPartitionList, ListLength);
00942 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="fmtexp.c::FmtIsFat" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a> FmtIsFat           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>PartitionPath</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IsFatPartition</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00093">93</a> of file <a class="el" href="../../d2/d5/fmtexp_8c-source.html">fmtexp.c</a>.
<p>
References <a class="el" href="../../d2/d8/arc_8h-source.html#l00040">ARC_STATUS</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01514">ArcClose</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01526">ArcOpen</a>, <a class="el" href="../../d1/d9/arc_8h.html#a317a238">ArcOpenReadOnly</a>, <a class="el" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>, <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00042">FmtIsFatPartition()</a>, and <a class="el" href="../../d2/d5/low_8c-source.html#l00076">LowGetPartitionGeometry()</a>.
<p>
Referenced by <a class="el" href="../../d8/d2/partit_8c-source.html#l00573">DoMakePartitionSystemPartition()</a>, and <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00724">FmtQueryFatPartitionList()</a>.
<p>
<pre class="fragment"><div>00099                    :
00100 
00101     This routine computes whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given partition <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a FAT
00102     partition.
00103 
00104 Arguments:
00105 
00106     PartitionPath   - Supplies a <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> partition.
00107     IsFatPartition  - Returns whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> partition <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> FAT.
00108 
00109 Return Value:
00110 
00111     <a class="code" href="../../d1/d9/arc_8h.html#a32">ArcOpen</a>, <a class="code" href="../../d1/d9/arc_8h.html#a29">ArcClose</a>, <a class="code" href="../../d4/d9/arcinst_8h.html#a125">LowGetPartitionGeometry</a>, <a class="code" href="../../d4/d9/arcinst_8h.html#a117">FmtIsFatPartition</a>
00112 
00113 --*/
00114 {
00115     ULONG       partition_id;
00116     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>  r;
00117     ULONG       total_sectors, sector_size, sec_per_track, heads;
00118 
00119     r = <a class="code" href="../../d1/d6/low_8c.html#a12">LowGetPartitionGeometry</a>(PartitionPath, &amp;total_sectors, &amp;sector_size,
00120                                 &amp;sec_per_track, &amp;heads);
00121 
00122     <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00123         <span class="keywordflow">return</span> r;
00124     }
00125 
00126     r = <a class="code" href="../../d1/d9/arc_8h.html#a32">ArcOpen</a>(PartitionPath, ArcOpenReadOnly, &amp;partition_id);
00127 
00128     <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00129         <span class="keywordflow">return</span> r;
00130     }
00131 
00132     r = <a class="code" href="../../d1/d6/fmtexp_8c.html#a9">FmtIsFatPartition</a>(partition_id, sector_size, IsFatPartition);
00133 
00134     <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00135         <a class="code" href="../../d1/d9/arc_8h.html#a29">ArcClose</a>(partition_id);
00136         <span class="keywordflow">return</span> r;
00137     }
00138 
00139     <span class="keywordflow">return</span> <a class="code" href="../../d1/d9/arc_8h.html#a29">ArcClose</a>(partition_id);
00140 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="fmtexp.c::FmtIsFatPartition" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a> FmtIsFatPartition           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PartitionId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SectorSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IsFatPartition</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00042">42</a> of file <a class="el" href="../../d2/d5/fmtexp_8c-source.html">fmtexp.c</a>.
<p>
References <a class="el" href="../../d5/d8/arcinst_8h-source.html#l00330">AllocateMemory</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l00040">ARC_STATUS</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>, <a class="el" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>, <a class="el" href="../../d5/d8/arcinst_8h-source.html#l00332">FreeMemory</a>, <a class="el" href="../../d2/d5/low_8c-source.html#l00212">LowReadSectors()</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00230">SectorSize</a>.
<p>
Referenced by <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00093">FmtIsFat()</a>.
<p>
<pre class="fragment"><div>00049                    :
00050 
00051     This routine computes whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given partition <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a FAT
00052     partition.
00053 
00054 Arguments:
00055 
00056     VolumeId        - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume to check.
00057     <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>      - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes per sector.
00058     IsFatPartition  - Returns whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> partition <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> FAT.
00059 
00060 Return Value:
00061 
00062     <a class="code" href="../../d4/d9/arcinst_8h.html#a126">LowReadSectors</a>, <a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>, <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>
00063 
00064 --*/
00065 {
00066     PUCHAR      <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00067     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>  r;
00068 
00069     <span class="keywordflow">if</span> (!(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d9/arcinst_8h.html#a20">AllocateMemory</a>(SectorSize*2))) {
00070         <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>;
00071     }
00072 
00073     r = <a class="code" href="../../d1/d6/low_8c.html#a13">LowReadSectors</a>(PartitionId, SectorSize, 0, 2, Buffer);
00074 
00075     <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00076         <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(Buffer);
00077         <span class="keywordflow">return</span> r;
00078     }
00079 
00080     *IsFatPartition = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[510] == 0x55 &amp;&amp;
00081                       <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[511] == 0xAA &amp;&amp;
00082                       <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[0x10] != 0 &amp;&amp;
00083                       <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[0x15] == <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>] &amp;&amp;
00084                       <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a> + 1] == 0xFF &amp;&amp;
00085                       <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a> + 2] == 0xFF;
00086 
00087     <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(Buffer);
00088     <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>;
00089 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="fmtexp.c::FmtQueryFatPartitionList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a> FmtQueryFatPartitionList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PCHAR **&nbsp;</td>
          <td class="mdname" nowrap> <em>FatPartitionList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ListLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00724">724</a> of file <a class="el" href="../../d2/d5/fmtexp_8c-source.html">fmtexp.c</a>.
<p>
References <a class="el" href="../../d5/d8/arcinst_8h-source.html#l00330">AllocateMemory</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l00040">ARC_STATUS</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01514">ArcClose</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01526">ArcOpen</a>, <a class="el" href="../../d1/d9/arc_8h.html#a317a238">ArcOpenReadOnly</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d1/d9/arc_8h.html#a56">CONFIGURATION_TYPE</a>, <a class="el" href="../../d1/d9/arc_8h.html#a315a212">DiskPeripheral</a>, <a class="el" href="../../d2/d9/arccodes_8h.html#a24a9">EIO</a>, <a class="el" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>, <a class="el" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>, <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00093">FmtIsFat()</a>, <a class="el" href="../../d5/d8/arcinst_8h-source.html#l00332">FreeMemory</a>, <a class="el" href="../../d2/d5/low_8c-source.html#l00721">LowFreePathList()</a>, <a class="el" href="../../d2/d5/low_8c-source.html#l00651">LowQueryPathList()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d9/heappage_8c.html#a68">sprintf()</a>, and <a class="el" href="../../d2/d7/regtest_8c.html#a2">strlen()</a>.
<p>
<pre class="fragment"><div>00730                    :
00731 
00732     This routine browses <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> component tree <span class="keywordflow">for</span> all disk peripherals
00733     and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> attempts to open partitions on all of them.  It add all
00734     FAT partitions to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list and returns <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
00735 
00736 Arguments:
00737 
00738     FatPartitionList    - Returns a list of FAT partitions.
00739     ListLength          - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list.
00740 
00741 Return Value:
00742 
00743     <a class="code" href="../../d4/d9/arcinst_8h.html#a130">LowQueryPathList</a>, <a class="code" href="../../d1/d9/arc_8h.html#a32">ArcOpen</a>, <a class="code" href="../../d1/d9/arc_8h.html#a29">ArcClose</a>, <a class="code" href="../../d4/d9/arcinst_8h.html#a118">FmtIsFat</a>, <a class="code" href="../../d2/d9/arccodes_8h.html#a24a9">EIO</a>, <a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>, <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>
00744 
00745 --*/
00746 {
00747     <a class="code" href="../../d1/d9/arc_8h.html#a56">CONFIGURATION_TYPE</a>          config_type;
00748     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>                  r;
00749     PCHAR*                      peripheral_list;
00750     ULONG                       peripheral_list_length;
00751     ULONG                       i, j;
00752     ULONG                       num_partitions;
00753     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>                        partition_buf[21];
00754     ULONG                       partition_id;
00755     PCHAR*                      fat_partition_list;
00756     ULONG                       fat_partition_list_length;
00757     BOOLEAN                     is_fat;
00758     PCHAR                       partition_name;
00759 
00760 
00761     <span class="comment">// First get a list of the all of the disk peripheral paths.</span>
00762 
00763     config_type = <a class="code" href="../../d1/d9/arc_8h.html#a315a212">DiskPeripheral</a>;
00764     r = <a class="code" href="../../d1/d6/low_8c.html#a19">LowQueryPathList</a>(NULL, &amp;config_type, &amp;peripheral_list,
00765                          &amp;peripheral_list_length);
00766 
00767     <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00768         <span class="keywordflow">return</span> r;
00769     }
00770 
00771     <span class="comment">// Now we have a list of disk peripheral paths.</span>
00772 
00773 
00774 
00775     <span class="comment">// Next, count how many partitions there are.</span>
00776 
00777     num_partitions = 0;
00778     <span class="keywordflow">for</span> (i = 0; i &lt; peripheral_list_length; i++) {
00779 
00780         partition_name = <a class="code" href="../../d4/d9/arcinst_8h.html#a20">AllocateMemory</a>(<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(peripheral_list[i]) + 21);
00781 
00782         <span class="keywordflow">if</span> (!partition_name) {
00783             <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(peripheral_list, peripheral_list_length);
00784             <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>;
00785         }
00786 
00787         <span class="keywordflow">for</span> (j = 1; ; j++) {
00788 
00789             strcpy(partition_name, peripheral_list[i]);
00790             <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(partition_buf, <span class="stringliteral">"partition(%d)"</span>, j);
00791             strcat(partition_name, partition_buf);
00792 
00793             r = <a class="code" href="../../d1/d9/arc_8h.html#a32">ArcOpen</a>(partition_name, ArcOpenReadOnly, &amp;partition_id);
00794 
00795             <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00796                 <span class="keywordflow">break</span>;
00797             }
00798 
00799             num_partitions++;
00800 
00801             r = <a class="code" href="../../d1/d9/arc_8h.html#a29">ArcClose</a>(partition_id);
00802 
00803             <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00804                 <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(peripheral_list, peripheral_list_length);
00805                 <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(partition_name);
00806                 <span class="keywordflow">return</span> r;
00807             }
00808         }
00809 
00810         <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(partition_name);
00811     }
00812 
00813     <span class="comment">// 'num_partitions' indicates the number of partitions on the disk.</span>
00814 
00815 
00816     <span class="comment">// Allocate a buffer for the FAT partitions list.  There can be</span>
00817     <span class="comment">// no more FAT partitions then there are partitions.</span>
00818 
00819     fat_partition_list = (PCHAR*) <a class="code" href="../../d4/d9/arcinst_8h.html#a20">AllocateMemory</a>(num_partitions*<span class="keyword">sizeof</span>(PCHAR));
00820 
00821     <span class="keywordflow">if</span> (!fat_partition_list) {
00822         <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(peripheral_list, peripheral_list_length);
00823         <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>;
00824     }
00825 
00826     <span class="keywordflow">for</span> (i = 0; i &lt; num_partitions; i++) {
00827         fat_partition_list[i] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00828     }
00829 
00830     fat_partition_list_length = 0;
00831 
00832     <span class="comment">// 'fat_partition_list_length' indicates the number of FAT partitions.</span>
00833 
00834 
00835 
00836     <span class="comment">// Now go through all of the peripherals trying all possible</span>
00837     <span class="comment">// partitions on each.  Test these to see if they are FAT and</span>
00838     <span class="comment">// put the FAT ones in 'fat_partitions_list'.</span>
00839 
00840     <span class="keywordflow">for</span> (i = 0; i &lt; peripheral_list_length; i++) {
00841 
00842         partition_name = <a class="code" href="../../d4/d9/arcinst_8h.html#a20">AllocateMemory</a>(<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(peripheral_list[i]) + 21);
00843 
00844         <span class="keywordflow">if</span> (!partition_name) {
00845             <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(peripheral_list, peripheral_list_length);
00846             <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(fat_partition_list, fat_partition_list_length);
00847             <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>;
00848         }
00849 
00850         <span class="keywordflow">for</span> (j = 1; ; j++) {
00851 
00852             strcpy(partition_name, peripheral_list[i]);
00853             <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(partition_buf, <span class="stringliteral">"partition(%d)"</span>, j);
00854             strcat(partition_name, partition_buf);
00855 
00856             r = <a class="code" href="../../d1/d9/arc_8h.html#a32">ArcOpen</a>(partition_name, ArcOpenReadOnly, &amp;partition_id);
00857 
00858             <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00859                 <span class="keywordflow">break</span>;
00860             }
00861 
00862             r = <a class="code" href="../../d1/d9/arc_8h.html#a29">ArcClose</a>(partition_id);
00863 
00864             <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00865                 <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(peripheral_list, peripheral_list_length);
00866                 <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(fat_partition_list, fat_partition_list_length);
00867                 <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(partition_name);
00868                 <span class="keywordflow">return</span> r;
00869             }
00870 
00871             r = <a class="code" href="../../d1/d6/fmtexp_8c.html#a10">FmtIsFat</a>(partition_name, &amp;is_fat);
00872 
00873             <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00874                 <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(peripheral_list, peripheral_list_length);
00875                 <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(fat_partition_list, fat_partition_list_length);
00876                 <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(partition_name);
00877                 <span class="keywordflow">return</span> r;
00878             }
00879 
00880             <span class="keywordflow">if</span> (is_fat) {
00881 
00882                 <span class="keywordflow">if</span> (fat_partition_list_length == num_partitions) {
00883                     <span class="comment">// This can't happen.</span>
00884                     <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(peripheral_list, peripheral_list_length);
00885                     <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(fat_partition_list, fat_partition_list_length);
00886                     <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(partition_name);
00887                     <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a9">EIO</a>;
00888                 }
00889 
00890                 fat_partition_list[fat_partition_list_length] =
00891                         <a class="code" href="../../d4/d9/arcinst_8h.html#a20">AllocateMemory</a>(<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(partition_name) + 1);
00892 
00893                 <span class="keywordflow">if</span> (!fat_partition_list[fat_partition_list_length]) {
00894                     <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(peripheral_list, peripheral_list_length);
00895                     <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(fat_partition_list, fat_partition_list_length);
00896                     <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(partition_name);
00897                     <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>;
00898                 }
00899 
00900                 strcpy(fat_partition_list[fat_partition_list_length], partition_name);
00901 
00902                 fat_partition_list_length++;
00903             }
00904         }
00905 
00906         <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(partition_name);
00907     }
00908 
00909     <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(peripheral_list, peripheral_list_length);
00910 
00911     *FatPartitionList = fat_partition_list;
00912     *ListLength = fat_partition_list_length;
00913 
00914     <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>;
00915 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="fmtexp.c::FmtVerifySectors" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a> FmtVerifySectors           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PartitionId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfSectors</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SectorSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG *&nbsp;</td>
          <td class="mdname" nowrap> <em>BadSectorsList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBadSectors</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00495">495</a> of file <a class="el" href="../../d2/d5/fmtexp_8c-source.html">fmtexp.c</a>.
<p>
References <a class="el" href="../../d5/d8/arcinst_8h-source.html#l00330">AllocateMemory</a>, <a class="el" href="../../d0/d6/almisc_8c-source.html#l01483">AlPrint()</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l00040">ARC_STATUS</a>, <a class="el" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>, <a class="el" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>, <a class="el" href="../../d5/d8/arcinst_8h-source.html#l00332">FreeMemory</a>, <a class="el" href="../../d2/d5/low_8c-source.html#l00212">LowReadSectors()</a>, <a class="el" href="../../d0/d6/almisc_8c-source.html#l00585">MSGMARGIN</a>, <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00004">READ_SIZE</a>, <a class="el" href="../../d5/d8/arcinst_8h-source.html#l00331">ReallocateMemory</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00230">SectorSize</a>.
<p>
Referenced by <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00601">FmtFatFormat()</a>.
<p>
<pre class="fragment"><div>00504                    :
00505 
00506     This routine verifies all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> sectors on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume.
00507     It returns a pointer to a list of bad sectors.  The pointer
00508     will be <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> there was an error detected.
00509 
00510 Arguments:
00511 
00512     PartitionId         - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> partition <span class="keywordflow">for</span> reading.
00513     NumberOfSectors     - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of partition sectors.
00514     <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>          - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes per sector.
00515     BadSectorsList      - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of bad sectors.
00516     NumberOfBadSectors  - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bad sectors in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list.
00517 
00518 Return Value:
00519 
00520     <a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>, <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>
00521 
00522 --*/
00523 {
00524     ULONG           num_read_sec;
00525     PVOID           read_buffer;
00526     ULONG           i, j;
00527     PULONG          bad_sec_buf;
00528     ULONG           max_num_bad;
00529     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>      r;
00530     ULONG           percent;
00531 
00532     <span class="keywordflow">if</span> (!(read_buffer = <a class="code" href="../../d4/d9/arcinst_8h.html#a20">AllocateMemory</a>(READ_SIZE))) {
00533         <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>;
00534     }
00535 
00536     max_num_bad = 100;
00537     <span class="keywordflow">if</span> (!(bad_sec_buf = (PULONG) <a class="code" href="../../d4/d9/arcinst_8h.html#a20">AllocateMemory</a>(max_num_bad*<span class="keyword">sizeof</span>(ULONG)))) {
00538         <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(read_buffer);
00539         <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>;
00540     }
00541 
00542     *NumberOfBadSectors = 0;
00543 
00544     num_read_sec = <a class="code" href="../../d1/d6/fmtexp_8c.html#a0">READ_SIZE</a>/<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>;
00545 
00546 
00547     percent = 1;
00548     <span class="keywordflow">for</span> (i = 0; i &lt; NumberOfSectors; i += num_read_sec) {
00549 
00550         <span class="keywordflow">if</span> (percent != i*100/NumberOfSectors) {
00551             percent = i*100/NumberOfSectors;
00552             <a class="code" href="../../d4/d9/arcinst_8h.html#a114">AlPrint</a>(<span class="stringliteral">"%s%d percent formatted.\r"</span>, MSGMARGIN, percent);
00553         }
00554 
00555         <span class="keywordflow">if</span> (i + num_read_sec &gt; NumberOfSectors) {
00556             num_read_sec = NumberOfSectors - i;
00557         }
00558 
00559         r = <a class="code" href="../../d1/d6/low_8c.html#a13">LowReadSectors</a>(PartitionId, SectorSize, i,
00560                            num_read_sec, read_buffer);
00561 
00562         <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00563 
00564             <span class="keywordflow">for</span> (j = 0; j &lt; num_read_sec; j++) {
00565 
00566                 r = <a class="code" href="../../d1/d6/low_8c.html#a13">LowReadSectors</a>(PartitionId, SectorSize, i+j, 1,
00567                                    read_buffer);
00568 
00569                 <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00570 
00571                     <span class="keywordflow">if</span> (*NumberOfBadSectors == max_num_bad) {
00572 
00573                         max_num_bad += 100;
00574                         <span class="keywordflow">if</span> (!(bad_sec_buf = (PULONG)
00575                               <a class="code" href="../../d4/d9/arcinst_8h.html#a21">ReallocateMemory</a>(bad_sec_buf,
00576                                                max_num_bad*<span class="keyword">sizeof</span>(ULONG)))) {
00577 
00578                             <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(read_buffer);
00579                             <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(bad_sec_buf);
00580                             <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>;
00581                         }
00582                     }
00583 
00584                     bad_sec_buf[(*NumberOfBadSectors)++] = i + j;
00585                 }
00586             }
00587         }
00588     }
00589 
00590     <a class="code" href="../../d4/d9/arcinst_8h.html#a114">AlPrint</a>(<span class="stringliteral">"%s100 percent formatted.\r\n"</span>,MSGMARGIN);
00591 
00592     *BadSectorsList = bad_sec_buf;
00593 
00594     <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(read_buffer);
00595 
00596     <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>;
00597 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:44 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
