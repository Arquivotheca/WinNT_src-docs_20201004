<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: profile.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>profile.c</h1><a href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************Module*Header******************************\</span>
00002 <span class="comment">* Module Name: PROFILE.C</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Module Descripton: Profile data manipulation functions</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Warnings:</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* Issues:</span>
00009 <span class="comment">*</span>
00010 <span class="comment">* Public Routines:</span>
00011 <span class="comment">*</span>
00012 <span class="comment">* Created:  11 January 1996</span>
00013 <span class="comment">* Author:   Srinivasan Chandrasekar    [srinivac]</span>
00014 <span class="comment">*</span>
00015 <span class="comment">* Copyright (c) 1996, 1997  Microsoft Corporation</span>
00016 <span class="comment">\***********************************************************************/</span>
00017 
00018 <span class="preprocessor">#include "<a class="code" href="../../d3/d4/mscms_8h.html">mscms.h</a>"</span>
00019 
<a name="l00020"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a0">00020</a> <span class="preprocessor">#define PROFILE_GROWTHCUSHION       16*1024</span>
00021 <span class="preprocessor"></span>
00022 <span class="comment">//</span>
00023 <span class="comment">// Local functions</span>
00024 <span class="comment">//</span>
00025 
00026 HPROFILE <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a1">InternalOpenColorProfile</a>(PPROFILE, DWORD, DWORD, DWORD);
00027 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a2">InternalCreateProfileFromLCS</a>(LPLOGCOLORSPACE, PBYTE*, BOOL);
00028 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a34">FreeProfileObject</a>(HPROFILE);
00029 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a4">AddTagTableEntry</a>(PPROFOBJ, TAGTYPE, DWORD, DWORD, BOOL);
00030 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a5">AddTaggedElement</a>(PPROFOBJ, TAGTYPE, DWORD);
00031 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a6">DeleteTaggedElement</a>(PPROFOBJ, PTAGDATA);
00032 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a7">ChangeTaggedElementSize</a>(PPROFOBJ, PTAGDATA, DWORD);
00033 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a8">GrowProfile</a>(PPROFOBJ, DWORD);
00034 <span class="keywordtype">void</span> <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a9">MoveProfileData</a>(PPROFOBJ, PBYTE, PBYTE, LONG, BOOL);
00035 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a10">IsReferenceTag</a>(PPROFOBJ, PTAGDATA);
00036 
00037 
00038 <span class="comment">/******************************************************************************</span>
00039 <span class="comment"> *</span>
00040 <span class="comment"> *                            OpenColorProfile</span>
00041 <span class="comment"> *</span>
00042 <span class="comment"> *  Function:</span>
00043 <span class="comment"> *       These are the ANSI &amp; Unicode wrappers for InternalOpenColorProfile.</span>
00044 <span class="comment"> *       Please see InternalOpenColorProfile for more details on this function.</span>
00045 <span class="comment"> *</span>
00046 <span class="comment"> *  Returns:</span>
00047 <span class="comment"> *       Handle to open profile on success, zero on failure.</span>
00048 <span class="comment"> *</span>
00049 <span class="comment"> ******************************************************************************/</span>
00050 
00051 <span class="preprocessor">#ifdef UNICODE          // Windows NT versions</span>
00052 <span class="preprocessor"></span>
00053 HPROFILE WINAPI <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a11">OpenColorProfileA</a>(
00054     PPROFILE pProfile,
00055     DWORD    dwDesiredAccess,
00056     DWORD    dwShareMode,
00057     DWORD    dwCreationMode
00058     )
00059 {
00060     PROFILE  wProfile;      <span class="comment">// Unicode version</span>
00061     HPROFILE rc = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00062 
00063     <span class="comment">//</span>
00064     <span class="comment">// Validate parameters before touching them</span>
00065     <span class="comment">//</span>
00066 
00067     <span class="keywordflow">if</span> (!pProfile ||
00068         IsBadReadPtr(pProfile, <span class="keyword">sizeof</span>(PROFILE)) ||
00069         (pProfile-&gt;pProfileData &amp;&amp;
00070          IsBadReadPtr(pProfile-&gt;pProfileData, pProfile-&gt;cbDataSize)) ||
00071         (!pProfile-&gt;pProfileData &amp;&amp;
00072          (pProfile-&gt;cbDataSize != 0)) ||
00073         (pProfile-&gt;dwType != PROFILE_FILENAME &amp;&amp;
00074          pProfile-&gt;dwType != PROFILE_MEMBUFFER
00075         )
00076        )
00077     {
00078         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to OpenColorProfile\n"</span>)));
00079         SetLastError(ERROR_INVALID_PARAMETER);
00080         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00081     }
00082 
00083     <span class="keywordflow">if</span> (pProfile-&gt;dwType == PROFILE_FILENAME)
00084     {
00085         <span class="comment">//</span>
00086         <span class="comment">// Convert the profile name to Unicode and call the Unicode version</span>
00087         <span class="comment">//</span>
00088 
00089         wProfile.dwType = pProfile-&gt;dwType;
00090 
00091         <span class="keywordflow">if</span> (!pProfile-&gt;pProfileData || pProfile-&gt;cbDataSize == 0)
00092         {
00093             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to OpenColorProfile\n"</span>)));
00094             SetLastError(ERROR_INVALID_PARAMETER);
00095             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00096         }
00097 
00098         wProfile.pProfileData = (WCHAR*)<a class="code" href="../../d2/d1/object_8c.html#a7">MemAlloc</a>(pProfile-&gt;cbDataSize * <span class="keyword">sizeof</span>(WCHAR));
00099         <span class="keywordflow">if</span> (!wProfile.pProfileData)
00100         {
00101             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error allocating memory for Unicode profile structure\n"</span>)));
00102             SetLastError(ERROR_NOT_ENOUGH_MEMORY);
00103             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00104         }
00105 
00106         <span class="keywordflow">if</span> (! MultiByteToWideChar(CP_ACP, 0, pProfile-&gt;pProfileData, pProfile-&gt;cbDataSize,
00107             wProfile.pProfileData, pProfile-&gt;cbDataSize))
00108         {
00109             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error converting profile structure to Unicode\n"</span>)));
00110             <span class="keywordflow">goto</span> EndOpenColorProfileA;
00111         }
00112 
00113         wProfile.cbDataSize = pProfile-&gt;cbDataSize * <span class="keyword">sizeof</span>(WCHAR);
00114     }
00115     <span class="keywordflow">else</span>
00116     {
00117         <span class="comment">//</span>
00118         <span class="comment">// It is a memory based profile, so no ANSI/Unicode conversion</span>
00119         <span class="comment">//</span>
00120 
00121         wProfile = *pProfile;
00122     }
00123 
00124     rc = <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a1">InternalOpenColorProfile</a>(&amp;wProfile, dwDesiredAccess,
00125             dwShareMode, dwCreationMode);
00126 
00127 EndOpenColorProfileA:
00128     <span class="keywordflow">if</span> (pProfile-&gt;dwType == PROFILE_FILENAME)
00129     {
00130         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(wProfile.pProfileData);
00131     }
00132 
00133     <span class="keywordflow">return</span> rc;
00134 }
00135 
00136 HPROFILE WINAPI <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a12">OpenColorProfileW</a>(
00137     PPROFILE pProfile,
00138     DWORD    dwDesiredAccess,
00139     DWORD    dwShareMode,
00140     DWORD    dwCreationMode
00141     )
00142 {
00143     <span class="comment">//</span>
00144     <span class="comment">// Internal function is Unicode in Windows NT, call it directly.</span>
00145     <span class="comment">//</span>
00146 
00147     <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a1">InternalOpenColorProfile</a>(pProfile, dwDesiredAccess,
00148             dwShareMode, dwCreationMode);
00149 }
00150 
00151 <span class="preprocessor">#else                           // Windows 95 versions</span>
00152 <span class="preprocessor"></span>
<a name="l00153"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a11">00153</a> HPROFILE WINAPI <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a11">OpenColorProfileA</a>(
00154     PPROFILE pProfile,
00155     DWORD    dwDesiredAccess,
00156     DWORD    dwShareMode,
00157     DWORD    dwCreationMode
00158     )
00159 {
00160     <span class="comment">//</span>
00161     <span class="comment">// Internal function is ANSI in Windows 95, call it directly.</span>
00162     <span class="comment">//</span>
00163 
00164     <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a1">InternalOpenColorProfile</a>(pProfile, dwDesiredAccess,
00165             dwShareMode, dwCreationMode);
00166 }
00167 
<a name="l00168"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a12">00168</a> HPROFILE WINAPI <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a12">OpenColorProfileW</a>(
00169     PPROFILE pProfile,
00170     DWORD    dwDesiredAccess,
00171     DWORD    dwShareMode,
00172     DWORD    dwCreationMode
00173     )
00174 {
00175     PROFILE  aProfile;      <span class="comment">// ANSI version</span>
00176     HPROFILE rc = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00177     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     bUsedDefaultChar;
00178 
00179     <span class="comment">//</span>
00180     <span class="comment">// Validate parameters before touching them</span>
00181     <span class="comment">//</span>
00182 
00183     <span class="keywordflow">if</span> (!pProfile ||
00184         IsBadReadPtr(pProfile, <span class="keyword">sizeof</span>(PROFILE)) ||
00185         (pProfile-&gt;pProfileData &amp;&amp;
00186          IsBadReadPtr(pProfile-&gt;pProfileData, pProfile-&gt;cbDataSize)) ||
00187         (!pProfile-&gt;pProfileData &amp;&amp;
00188          (pProfile-&gt;cbDataSize != 0)) ||
00189         (pProfile-&gt;dwType != PROFILE_FILENAME &amp;&amp;
00190          pProfile-&gt;dwType != PROFILE_MEMBUFFER
00191         )
00192        )
00193     {
00194         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to OpenColorProfile\n"</span>)));
00195         SetLastError(ERROR_INVALID_PARAMETER);
00196         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00197     }
00198 
00199     <span class="keywordflow">if</span> (pProfile-&gt;dwType == PROFILE_FILENAME)
00200     {
00201         <span class="comment">//</span>
00202         <span class="comment">// Convert the profile name to ANSI and call the ANSI version</span>
00203         <span class="comment">//</span>
00204 
00205         aProfile.dwType = pProfile-&gt;dwType;
00206 
00207         <span class="keywordflow">if</span> (!pProfile-&gt;pProfileData || pProfile-&gt;cbDataSize == 0)
00208         {
00209             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to OpenColorProfile\n"</span>)));
00210             SetLastError(ERROR_INVALID_PARAMETER);
00211             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00212         }
00213 
00214         aProfile.pProfileData = (<span class="keywordtype">char</span>*)<a class="code" href="../../d2/d1/object_8c.html#a7">MemAlloc</a>(pProfile-&gt;cbDataSize * <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>));
00215         <span class="keywordflow">if</span> (!aProfile.pProfileData)
00216         {
00217             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error allocating memory for ANSI profile structure\n"</span>)));
00218             SetLastError(ERROR_NOT_ENOUGH_MEMORY);
00219             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00220         }
00221 
00222         <span class="keywordflow">if</span> (! WideCharToMultiByte(CP_ACP, 0, pProfile-&gt;pProfileData, pProfile-&gt;cbDataSize/<span class="keyword">sizeof</span>(WCHAR),
00223             aProfile.pProfileData, pProfile-&gt;cbDataSize,
00224             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;bUsedDefaultChar) || bUsedDefaultChar)
00225         {
00226             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error converting profile structure to ANSI\n"</span>)));
00227             <span class="keywordflow">goto</span> EndOpenColorProfileW;
00228         }
00229 
00230         aProfile.cbDataSize = pProfile-&gt;cbDataSize * <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>);
00231     }
00232     <span class="keywordflow">else</span>
00233     {
00234         <span class="comment">//</span>
00235         <span class="comment">// It is a memory based profile, so no ANSI/Unicode conversion</span>
00236         <span class="comment">//</span>
00237 
00238         aProfile = *pProfile;
00239     }
00240 
00241     rc = <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a1">InternalOpenColorProfile</a>(&amp;aProfile, dwDesiredAccess,
00242             dwShareMode, dwCreationMode);
00243 
00244 EndOpenColorProfileW:
00245     <span class="keywordflow">if</span> (pProfile-&gt;dwType == PROFILE_FILENAME)
00246     {
00247         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(aProfile.pProfileData);
00248     }
00249 
00250     <span class="keywordflow">return</span> rc;
00251 }
00252 
00253 <span class="preprocessor">#endif                          // ! UNICODE</span>
00254 <span class="preprocessor"></span>
00255 <span class="comment">/******************************************************************************</span>
00256 <span class="comment"> *</span>
00257 <span class="comment"> *                            CloseColorProfile</span>
00258 <span class="comment"> *</span>
00259 <span class="comment"> *  Function:</span>
00260 <span class="comment"> *       This functions closes a color profile object, and frees all memory</span>
00261 <span class="comment"> *       associated with it.</span>
00262 <span class="comment"> *</span>
00263 <span class="comment"> *  Arguments:</span>
00264 <span class="comment"> *       hProfile - handle identifing the profile object</span>
00265 <span class="comment"> *</span>
00266 <span class="comment"> *  Returns:</span>
00267 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
00268 <span class="comment"> *</span>
00269 <span class="comment"> ******************************************************************************/</span>
00270 
<a name="l00271"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a13">00271</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a13">CloseColorProfile</a>(
00272     HPROFILE hProfile
00273     )
00274 {
00275     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"CloseColorProfile\n"</span>)));
00276 
00277     <span class="comment">//</span>
00278     <span class="comment">// Validate parameters</span>
00279     <span class="comment">//</span>
00280 
00281     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a5">ValidHandle</a>(hProfile, OBJ_PROFILE))
00282     {
00283         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to CloseColorProfile\n"</span>)));
00284         SetLastError(ERROR_INVALID_PARAMETER);
00285         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00286     }
00287 
00288     <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a34">FreeProfileObject</a>(hProfile);
00289 }
00290 
00291 
00292 <span class="comment">/******************************************************************************</span>
00293 <span class="comment"> *</span>
00294 <span class="comment"> *                          GetColorProfileFromHandle</span>
00295 <span class="comment"> *</span>
00296 <span class="comment"> *  Function:</span>
00297 <span class="comment"> *       This functions returns a buffer filled with the profile contents.</span>
00298 <span class="comment"> *</span>
00299 <span class="comment"> *  Arguments:</span>
00300 <span class="comment"> *       hProfile     - handle identifing the profile object</span>
00301 <span class="comment"> *       pProfileData - pointer to buffer to receive the data. Can be NULL.</span>
00302 <span class="comment"> *       pcbData      - pointer to size of buffer. On return it is size</span>
00303 <span class="comment"> *                      filled/needed.</span>
00304 <span class="comment"> *</span>
00305 <span class="comment"> *  Returns:</span>
00306 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
00307 <span class="comment"> *</span>
00308 <span class="comment"> ******************************************************************************/</span>
00309 
<a name="l00310"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a14">00310</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a14">GetColorProfileFromHandle</a>(
00311     HPROFILE  hProfile,
00312     PBYTE     pProfileData,
00313     PDWORD    pcbSize
00314     )
00315 {
00316     PPROFOBJ pProfObj;
00317     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a8">dwFileSize</a>;
00318     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00319 
00320     <span class="comment">//</span>
00321     <span class="comment">// ValidatePrameters</span>
00322     <span class="comment">//</span>
00323 
00324     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a5">ValidHandle</a>(hProfile, OBJ_PROFILE) ||
00325         !pcbSize ||
00326         IsBadWritePtr(pcbSize, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)) ||
00327         (pProfileData &amp;&amp;
00328          IsBadWritePtr(pProfileData, *pcbSize)))
00329     {
00330         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to CloseColorProfile\n"</span>)));
00331         SetLastError(ERROR_INVALID_PARAMETER);
00332         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00333     }
00334 
00335     pProfObj = (PPROFOBJ)HDLTOPTR(hProfile);
00336 
00337     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pProfObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00338 
00339     <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a8">dwFileSize</a> = FIX_ENDIAN(HEADER(pProfObj)-&gt;phSize);
00340 
00341     <span class="keywordflow">if</span> (pProfileData &amp;&amp; *pcbSize &gt;= <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a8">dwFileSize</a>)
00342     {
00343         CopyMemory(pProfileData, pProfObj-&gt;pView, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a8">dwFileSize</a>);
00344         rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00345     }
00346     <span class="keywordflow">else</span>
00347     {
00348         SetLastError(ERROR_INSUFFICIENT_BUFFER);
00349     }
00350 
00351     *pcbSize = <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a8">dwFileSize</a>;
00352 
00353     <span class="keywordflow">return</span> rc;
00354 }
00355 
00356 
00357 <span class="comment">/******************************************************************************</span>
00358 <span class="comment"> *</span>
00359 <span class="comment"> *                            IsColorProfileValid</span>
00360 <span class="comment"> *</span>
00361 <span class="comment"> *  Function:</span>
00362 <span class="comment"> *       This functions checks if a given profile is a valid ICC profile</span>
00363 <span class="comment"> *       that can be used for color matching</span>
00364 <span class="comment"> *</span>
00365 <span class="comment"> *  Arguments:</span>
00366 <span class="comment"> *       hProfile - handle identifing the profile object</span>
00367 <span class="comment"> *       pbValid  - Pointer to variable that receives TRUE if it is a</span>
00368 <span class="comment"> *                  valid profile, FALSE otherwise</span>
00369 <span class="comment"> *</span>
00370 <span class="comment"> *  Returns:</span>
00371 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
00372 <span class="comment"> *</span>
00373 <span class="comment"> ******************************************************************************/</span>
00374 
<a name="l00375"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a15">00375</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a15">IsColorProfileValid</a>(
00376     HPROFILE hProfile,
00377     PBOOL    pbValid
00378     )
00379 {
00380     PPROFOBJ pProfObj;
00381     PCMMOBJ  pCMMObj;
00382     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    cmmID;
00383     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00384 
00385     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"IsColorProfileValid\n"</span>)));
00386 
00387     <span class="comment">//</span>
00388     <span class="comment">// Validate parameters</span>
00389     <span class="comment">//</span>
00390 
00391     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a5">ValidHandle</a>(hProfile, OBJ_PROFILE) ||
00392         !pbValid ||
00393         IsBadWritePtr(pbValid, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)))
00394     {
00395         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to IsColorProfileValid\n"</span>)));
00396         SetLastError(ERROR_INVALID_PARAMETER);
00397         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00398     }
00399 
00400     pProfObj = (PPROFOBJ)HDLTOPTR(hProfile);
00401 
00402     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pProfObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00403 
00404     <span class="comment">//</span>
00405     <span class="comment">// Quick check on the integrity of the profile before calling the CMM</span>
00406     <span class="comment">//</span>
00407 
00408     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a6">ValidProfile</a>(pProfObj))
00409     {
00410         *pbValid = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00411         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00412     }
00413 
00414     <span class="comment">//</span>
00415     <span class="comment">// Get CMM associated with profile. If it does not exist or does not</span>
00416     <span class="comment">// support the CMValidate function, get default CMM.</span>
00417     <span class="comment">//</span>
00418 
00419     cmmID = HEADER(pProfObj)-&gt;phCMMType;
00420     cmmID = FIX_ENDIAN(cmmID);
00421 
00422     pCMMObj  = <a class="code" href="../../d2/d1/object_8c.html#a14">GetColorMatchingModule</a>(cmmID);
00423     <span class="keywordflow">if</span> (!pCMMObj || !pCMMObj-&gt;fns.pCMIsProfileValid)
00424     {
00425         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a3">TERSE</a>((__TEXT(<span class="stringliteral">"CMM associated with profile could not be used"</span>)));
00426 
00427         <span class="keywordflow">if</span> (pCMMObj)
00428         {
00429             <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pCMMObj);
00430         }
00431 
00432         pCMMObj = <a class="code" href="../../d2/d1/object_8c.html#a14">GetColorMatchingModule</a>(CMM_WINDOWS_DEFAULT);
00433         <span class="keywordflow">if</span> (!pCMMObj || !pCMMObj-&gt;fns.pCMIsProfileValid)
00434         {
00435             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a9">RIP</a>((__TEXT(<span class="stringliteral">"Default CMM doesn't support CMValidateProfile"</span>)));
00436             SetLastError(ERROR_INVALID_CMM);
00437             <span class="keywordflow">goto</span> EndIsColorProfileValid;
00438         }
00439     }
00440 
00441     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pProfObj-&gt;pView != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00442     rc = pCMMObj-&gt;fns.pCMIsProfileValid(hProfile, pbValid);
00443 
00444 EndIsColorProfileValid:
00445 
00446     <span class="keywordflow">if</span> (pCMMObj)
00447     {
00448         <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pCMMObj);
00449     }
00450 
00451     <span class="keywordflow">return</span> rc;
00452 }
00453 
00454 
00455 <span class="comment">/******************************************************************************</span>
00456 <span class="comment"> *</span>
00457 <span class="comment"> *                         CreateProfileFromLogColorSpace</span>
00458 <span class="comment"> *</span>
00459 <span class="comment"> *  Function:</span>
00460 <span class="comment"> *       These are the ANSI &amp; Unicode wrappers for InternalCreateProfileFromLCS.</span>
00461 <span class="comment"> *       Please see InternalCreateProfileFromLCS for more details on this</span>
00462 <span class="comment"> *       function.</span>
00463 <span class="comment"> *</span>
00464 <span class="comment"> *  Returns:</span>
00465 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
00466 <span class="comment"> *</span>
00467 <span class="comment"> ******************************************************************************/</span>
00468 
00469 <span class="preprocessor">#ifdef UNICODE          // Windows NT versions</span>
00470 <span class="preprocessor"></span>
00471 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a16">CreateProfileFromLogColorSpaceA</a>(
00472     LPLOGCOLORSPACEA pLogColorSpace,
00473     PBYTE            *pBuffer
00474     )
00475 {
00476     LOGCOLORSPACEW lcs;
00477 
00478     <span class="comment">//</span>
00479     <span class="comment">// Validate Parameters</span>
00480     <span class="comment">//</span>
00481 
00482     <span class="keywordflow">if</span> (! pLogColorSpace ||
00483         IsBadReadPtr(pLogColorSpace, <span class="keyword">sizeof</span>(LOGCOLORSPACEA)) ||
00484         pLogColorSpace-&gt;lcsFilename[0] != <span class="charliteral">'\0'</span>)
00485     {
00486         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to CreateProfileFromLogColorSpace\n"</span>)));
00487         SetLastError(ERROR_INVALID_PARAMETER);
00488         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00489     }
00490 
00491     *((LPLOGCOLORSPACEA)&amp;lcs) = *pLogColorSpace;
00492     lcs.lcsFilename[0] = <span class="charliteral">'\0'</span>;
00493 
00494     <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a2">InternalCreateProfileFromLCS</a>(&amp;lcs, pBuffer, FALSE);
00495 }
00496 
00497 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a17">CreateProfileFromLogColorSpaceW</a>(
00498     LPLOGCOLORSPACEW pLogColorSpace,
00499     PBYTE           *pBuffer
00500     )
00501 {
00502     <span class="comment">//</span>
00503     <span class="comment">// Internal function is Unicode in Windows NT, call it directly.</span>
00504     <span class="comment">//</span>
00505 
00506     <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a2">InternalCreateProfileFromLCS</a>(pLogColorSpace, pBuffer, TRUE);
00507 }
00508 
00509 <span class="preprocessor">#else                           // Windows 95 versions</span>
00510 <span class="preprocessor"></span>
<a name="l00511"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a16">00511</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a16">CreateProfileFromLogColorSpaceA</a>(
00512     LPLOGCOLORSPACEA pLogColorSpace,
00513     PBYTE            *pBuffer
00514     )
00515 {
00516     <span class="comment">//</span>
00517     <span class="comment">// Internal function is ANSI in Windows 95, call it directly.</span>
00518     <span class="comment">//</span>
00519 
00520     <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a2">InternalCreateProfileFromLCS</a>(pLogColorSpace, pBuffer, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00521 }
00522 
<a name="l00523"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a17">00523</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a17">CreateProfileFromLogColorSpaceW</a>(
00524     LPLOGCOLORSPACEW pLogColorSpace,
00525     PBYTE           *pBuffer
00526     )
00527 {
00528     LOGCOLORSPACEA lcs;
00529 
00530     <span class="comment">//</span>
00531     <span class="comment">// Validate Parameters</span>
00532     <span class="comment">//</span>
00533 
00534     <span class="keywordflow">if</span> (! pLogColorSpace ||
00535         IsBadReadPtr(pLogColorSpace, <span class="keyword">sizeof</span>(LOGCOLORSPACEW)) ||
00536         pLogColorSpace-&gt;lcsFilename[0] != <span class="charliteral">'\0'</span>)
00537     {
00538         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to CreateProfileFromLogColorSpace\n"</span>)));
00539         SetLastError(ERROR_INVALID_PARAMETER);
00540         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00541     }
00542 
00543     lcs = *((LPLOGCOLORSPACEA)pLogColorSpace);
00544     lcs.lcsFilename[0] = <span class="charliteral">'\0'</span>;
00545 
00546     <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a2">InternalCreateProfileFromLCS</a>(&amp;lcs, pBuffer, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00547 }
00548 
00549 <span class="preprocessor">#endif                          // ! UNICODE</span>
00550 <span class="preprocessor"></span>
00551 <span class="comment">/******************************************************************************</span>
00552 <span class="comment"> *</span>
00553 <span class="comment"> *                            IsColorProfileTagPresent</span>
00554 <span class="comment"> *</span>
00555 <span class="comment"> *  Function:</span>
00556 <span class="comment"> *       This functions checks if a given tag is present in the profile</span>
00557 <span class="comment"> *</span>
00558 <span class="comment"> *  Arguments:</span>
00559 <span class="comment"> *       hProfile - handle identifing the profile object</span>
00560 <span class="comment"> *       tagType  - the tag to check for</span>
00561 <span class="comment"> *       pbPrent  - pointer to variable that receives TRUE if it the tag is</span>
00562 <span class="comment"> *                  present, FALSE otherwise</span>
00563 <span class="comment"> *</span>
00564 <span class="comment"> *  Returns:</span>
00565 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
00566 <span class="comment"> *</span>
00567 <span class="comment"> ******************************************************************************/</span>
00568 
<a name="l00569"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a18">00569</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a18">IsColorProfileTagPresent</a>(
00570     HPROFILE hProfile,
00571     TAGTYPE  tagType,
00572     PBOOL    pbPresent
00573     )
00574 {
00575     PPROFOBJ pProfObj;
00576     PTAGDATA pTagData;
00577     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    nCount, i;
00578 
00579     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"IsColorProfileTagPresent\n"</span>)));
00580 
00581     <span class="comment">//</span>
00582     <span class="comment">// Validate parameters</span>
00583     <span class="comment">//</span>
00584 
00585     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a5">ValidHandle</a>(hProfile, OBJ_PROFILE) ||
00586         !pbPresent ||
00587         IsBadWritePtr(pbPresent, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)))
00588     {
00589         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to IsColorProfileTagPresent\n"</span>)));
00590         SetLastError(ERROR_INVALID_PARAMETER);
00591         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00592     }
00593 
00594     pProfObj = (PPROFOBJ)HDLTOPTR(hProfile);
00595 
00596     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pProfObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00597 
00598     <span class="comment">//</span>
00599     <span class="comment">// Check the integrity of the profile</span>
00600     <span class="comment">//</span>
00601 
00602     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a6">ValidProfile</a>(pProfObj))
00603     {
00604         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid profile passed to IsColorProfileTagPresent\n"</span>)));
00605         SetLastError(ERROR_INVALID_PROFILE);
00606         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00607     }
00608 
00609     <span class="comment">//</span>
00610     <span class="comment">// Get count of tag items - it is right after the profile header</span>
00611     <span class="comment">//</span>
00612 
00613     nCount = TAG_COUNT(pProfObj);
00614     nCount = FIX_ENDIAN(nCount);
00615 
00616     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a2">VERBOSE</a>((__TEXT(<span class="stringliteral">"Profile 0x%x has 0x%x(%d) tags\n"</span>), hProfile, nCount, nCount));
00617 
00618     <span class="comment">//</span>
00619     <span class="comment">// Tag data records follow the count.</span>
00620     <span class="comment">//</span>
00621 
00622     pTagData = TAG_DATA(pProfObj);
00623 
00624     <span class="comment">//</span>
00625     <span class="comment">// Check if any of these records match the tag passed in.</span>
00626     <span class="comment">//</span>
00627 
00628     *pbPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00629     tagType = FIX_ENDIAN(tagType);      <span class="comment">// to match tags in profile</span>
00630     <span class="keywordflow">for</span> (i=0; i&lt;nCount; i++)
00631     {
00632         <span class="keywordflow">if</span> (pTagData-&gt;tagType == tagType)
00633         {
00634             *pbPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00635             <span class="keywordflow">break</span>;
00636         }
00637         pTagData++;                     <span class="comment">// Next record</span>
00638     }
00639 
00640     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00641 }
00642 
00643 
00644 <span class="comment">/******************************************************************************</span>
00645 <span class="comment"> *</span>
00646 <span class="comment"> *                            GetCountColorProfileElements</span>
00647 <span class="comment"> *</span>
00648 <span class="comment"> *  Function:</span>
00649 <span class="comment"> *       This functions returns the number of tagged elements in the profile</span>
00650 <span class="comment"> *</span>
00651 <span class="comment"> *  Arguments:</span>
00652 <span class="comment"> *       hProfile - handle identifing the profile object</span>
00653 <span class="comment"> *       pnCount  - pointer to variable to receive number of tagged elements</span>
00654 <span class="comment"> *  Returns:</span>
00655 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
00656 <span class="comment"> *</span>
00657 <span class="comment"> ******************************************************************************/</span>
00658 
<a name="l00659"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a19">00659</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a19">GetCountColorProfileElements</a>(
00660     HPROFILE hProfile,
00661     PDWORD   pnCount
00662     )
00663 {
00664     PPROFOBJ pProfObj;
00665 
00666     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"GetCountColorProfileElements\n"</span>)));
00667 
00668     <span class="comment">//</span>
00669     <span class="comment">// Validate parameters</span>
00670     <span class="comment">//</span>
00671 
00672     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a5">ValidHandle</a>(hProfile, OBJ_PROFILE) ||
00673         !pnCount ||
00674         IsBadWritePtr(pnCount, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)))
00675     {
00676         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to GetCountColorProfileElements\n"</span>)));
00677         SetLastError(ERROR_INVALID_PARAMETER);
00678         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00679     }
00680 
00681     pProfObj = (PPROFOBJ)HDLTOPTR(hProfile);
00682 
00683     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pProfObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00684 
00685     <span class="comment">//</span>
00686     <span class="comment">// Check the integrity of the profile</span>
00687     <span class="comment">//</span>
00688 
00689     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a6">ValidProfile</a>(pProfObj))
00690     {
00691         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid profile passed to GetCountColorProfileElements\n"</span>)));
00692         SetLastError(ERROR_INVALID_PROFILE);
00693         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00694     }
00695 
00696     <span class="comment">//</span>
00697     <span class="comment">// Get count of tag items - it is right after the profile header</span>
00698     <span class="comment">//</span>
00699 
00700     *pnCount = TAG_COUNT(pProfObj);
00701     *pnCount = FIX_ENDIAN(*pnCount);
00702 
00703     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00704 }
00705 
00706 
00707 <span class="comment">/******************************************************************************</span>
00708 <span class="comment"> *</span>
00709 <span class="comment"> *                            GetColorProfileElementTag</span>
00710 <span class="comment"> *</span>
00711 <span class="comment"> *  Function:</span>
00712 <span class="comment"> *       This functions retrieves the tag name of the dwIndex'th element</span>
00713 <span class="comment"> *       in the profile</span>
00714 <span class="comment"> *</span>
00715 <span class="comment"> *  Arguments:</span>
00716 <span class="comment"> *       hProfile - handle identifing the profile object</span>
00717 <span class="comment"> *       dwIndex  - one-based index of the tag whose name is required</span>
00718 <span class="comment"> *       pTagType - gets the name of the tag on return</span>
00719 <span class="comment"> *</span>
00720 <span class="comment"> *  Returns:</span>
00721 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
00722 <span class="comment"> *</span>
00723 <span class="comment"> ******************************************************************************/</span>
00724 
<a name="l00725"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a20">00725</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a20">GetColorProfileElementTag</a>(
00726     HPROFILE  hProfile,
00727     DWORD     dwIndex,
00728     PTAGTYPE  pTagType
00729     )
00730 {
00731     PPROFOBJ pProfObj;
00732     PTAGDATA pTagData;
00733     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    nCount;
00734     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00735 
00736     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"GetColorProfileElementTag\n"</span>)));
00737 
00738     <span class="comment">//</span>
00739     <span class="comment">// Validate parameters</span>
00740     <span class="comment">//</span>
00741 
00742     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a5">ValidHandle</a>(hProfile, OBJ_PROFILE) ||
00743         IsBadWritePtr(pTagType, <span class="keyword">sizeof</span>(TAGTYPE)) ||
00744         dwIndex &lt;= 0)
00745     {
00746         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to GetColorProfileElementTag\n"</span>)));
00747         SetLastError(ERROR_INVALID_PARAMETER);
00748         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00749     }
00750 
00751     pProfObj = (PPROFOBJ)HDLTOPTR(hProfile);
00752 
00753     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pProfObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00754 
00755     <span class="comment">//</span>
00756     <span class="comment">// Check the integrity of the profile</span>
00757     <span class="comment">//</span>
00758 
00759     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a6">ValidProfile</a>(pProfObj))
00760     {
00761         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid profile passed to GetColorProfileElementTag\n"</span>)));
00762         SetLastError(ERROR_INVALID_PROFILE);
00763         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00764     }
00765 
00766     <span class="comment">//</span>
00767     <span class="comment">// Get count of tag items - it is right after the profile header</span>
00768     <span class="comment">//</span>
00769 
00770     nCount = TAG_COUNT(pProfObj);
00771     nCount = FIX_ENDIAN(nCount);
00772 
00773     <span class="keywordflow">if</span> (dwIndex &gt; nCount)
00774     {
00775         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"GetColorProfileElementTag:index (%d) invalid\n"</span>), dwIndex));
00776         SetLastError(ERROR_INVALID_PARAMETER);
00777         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00778     }
00779 
00780     <span class="comment">//</span>
00781     <span class="comment">// Tag data records follow the count.</span>
00782     <span class="comment">//</span>
00783 
00784     pTagData = TAG_DATA(pProfObj);
00785 
00786     *pTagType = FIX_ENDIAN(pTagData[dwIndex-1].tagType);    <span class="comment">// 1-based index</span>
00787 
00788     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00789 }
00790 
00791 
00792 <span class="comment">/******************************************************************************</span>
00793 <span class="comment"> *</span>
00794 <span class="comment"> *                            GetColorProfileElement</span>
00795 <span class="comment"> *</span>
00796 <span class="comment"> *  Function:</span>
00797 <span class="comment"> *       This functions retrieves the data that a tagged element refers to</span>
00798 <span class="comment"> *       starting from the given offset.</span>
00799 <span class="comment"> *</span>
00800 <span class="comment"> *  Arguments:</span>
00801 <span class="comment"> *       hProfile - handle identifing the profile object</span>
00802 <span class="comment"> *       tagType  - the tag name of the element whose data is required</span>
00803 <span class="comment"> *       dwOffset - offset within the element data from which to retrieve</span>
00804 <span class="comment"> *       pcbSize  - number of bytes to get. On return it is the number of</span>
00805 <span class="comment"> *                  bytes retrieved</span>
00806 <span class="comment"> *       pBuffer  - pointer to buffer to recieve data</span>
00807 <span class="comment"> *</span>
00808 <span class="comment"> *  Returns:</span>
00809 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
00810 <span class="comment"> *</span>
00811 <span class="comment"> *  Comments:</span>
00812 <span class="comment"> *       If pBuffer is NULL, it returns size of data in *pcbSize and ignores</span>
00813 <span class="comment"> *       dwOffset.</span>
00814 <span class="comment"> *</span>
00815 <span class="comment"> ******************************************************************************/</span>
00816 
<a name="l00817"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a21">00817</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a21">GetColorProfileElement</a>(
00818     HPROFILE hProfile,
00819     TAGTYPE  tagType,
00820     DWORD    dwOffset,
00821     PDWORD   pcbSize,
00822     PVOID    pBuffer,
00823     PBOOL    pbReference
00824     )
00825 {
00826     PPROFOBJ pProfObj;
00827     PTAGDATA pTagData;
00828     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    nCount, nBytes, i;
00829     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     found;
00830     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;            <span class="comment">// Assume failure</span>
00831 
00832     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"GetColorProfileElement\n"</span>)));
00833 
00834     <span class="comment">//</span>
00835     <span class="comment">// Validate parameters</span>
00836     <span class="comment">//</span>
00837 
00838     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a5">ValidHandle</a>(hProfile, OBJ_PROFILE) ||
00839         !pcbSize ||
00840         IsBadWritePtr(pcbSize, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)) ||
00841         !pbReference ||
00842         IsBadWritePtr(pbReference, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>))
00843        )
00844     {
00845         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to GetColorProfileElement\n"</span>)));
00846         SetLastError(ERROR_INVALID_PARAMETER);
00847         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00848     }
00849 
00850     pProfObj = (PPROFOBJ)HDLTOPTR(hProfile);
00851 
00852     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pProfObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00853 
00854     <span class="comment">//</span>
00855     <span class="comment">// Check the integrity of the profile</span>
00856     <span class="comment">//</span>
00857 
00858     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a6">ValidProfile</a>(pProfObj))
00859     {
00860         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid profile passed to GetColorProfileElement\n"</span>)));
00861         SetLastError(ERROR_INVALID_PROFILE);
00862         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00863     }
00864 
00865     <span class="comment">//</span>
00866     <span class="comment">// Get count of tag items - it is right after the profile header</span>
00867     <span class="comment">//</span>
00868 
00869     nCount = TAG_COUNT(pProfObj);
00870     nCount = FIX_ENDIAN(nCount);
00871 
00872     <span class="comment">//</span>
00873     <span class="comment">// Tag data records follow the count.</span>
00874     <span class="comment">//</span>
00875 
00876     pTagData = TAG_DATA(pProfObj);
00877 
00878     <span class="comment">//</span>
00879     <span class="comment">// Check if any of these records match the tag passed in.</span>
00880     <span class="comment">//</span>
00881 
00882     found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00883     tagType = FIX_ENDIAN(tagType);      <span class="comment">// to match tags in profile</span>
00884     <span class="keywordflow">for</span> (i=0; i&lt;nCount; i++)
00885     {
00886         <span class="keywordflow">if</span> (pTagData-&gt;tagType == tagType)
00887         {
00888             found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00889             <span class="keywordflow">break</span>;
00890         }
00891         pTagData++;                     <span class="comment">// next record</span>
00892     }
00893 
00894     <span class="keywordflow">if</span> (found)
00895     {
00896         <span class="comment">//</span>
00897         <span class="comment">// If pBuffer is NULL, copy size of data</span>
00898         <span class="comment">//</span>
00899 
00900         <span class="keywordflow">if</span> (!pBuffer)
00901         {
00902             *pcbSize = FIX_ENDIAN(pTagData-&gt;cbSize);
00903             SetLastError(ERROR_INSUFFICIENT_BUFFER);
00904         }
00905         <span class="keywordflow">else</span>
00906         {
00907             <span class="comment">//</span>
00908             <span class="comment">// pBuffer is not NULL, get number of bytes to copy</span>
00909             <span class="comment">//</span>
00910 
00911             <span class="keywordflow">if</span> (dwOffset &gt;= FIX_ENDIAN(pTagData-&gt;cbSize))
00912             {
00913                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"dwOffset too large for GetColorProfileElement\n"</span>)));
00914                 SetLastError(ERROR_INVALID_PARAMETER);
00915                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00916             }
00917             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dwOffset + *pcbSize &gt; FIX_ENDIAN(pTagData-&gt;cbSize))
00918             {
00919                 nBytes = FIX_ENDIAN(pTagData-&gt;cbSize) - dwOffset;
00920             }
00921             <span class="keywordflow">else</span>
00922             {
00923                 nBytes = *pcbSize;
00924             }
00925 
00926             <span class="comment">//</span>
00927             <span class="comment">// Check if output buffer is large enough</span>
00928             <span class="comment">//</span>
00929 
00930             <span class="keywordflow">if</span> (IsBadWritePtr(pBuffer, nBytes))
00931             {
00932                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Bad buffer passed to GetColorProfileElement\n"</span>)));
00933                 SetLastError(ERROR_INVALID_PARAMETER);
00934                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00935             }
00936 
00937             <span class="comment">//</span>
00938             <span class="comment">// Copy the data into user supplied buffer</span>
00939             <span class="comment">//</span>
00940 
00941             CopyMemory((PVOID)pBuffer,
00942                 (PVOID)(pProfObj-&gt;pView + FIX_ENDIAN(pTagData-&gt;dwOffset)
00943                 + dwOffset), nBytes);
00944             *pcbSize = nBytes;
00945             rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;                      <span class="comment">// Success!</span>
00946         }
00947 
00948         <span class="comment">//</span>
00949         <span class="comment">// Check if multiple tags reference this tag's data</span>
00950         <span class="comment">//</span>
00951 
00952         *pbReference = <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a10">IsReferenceTag</a>(pProfObj, pTagData);
00953     }
00954     <span class="keywordflow">else</span>
00955     {
00956         SetLastError(ERROR_TAG_NOT_FOUND);
00957     }
00958 
00959     <span class="keywordflow">return</span> rc;
00960 }
00961 
00962 
00963 <span class="comment">/******************************************************************************</span>
00964 <span class="comment"> *</span>
00965 <span class="comment"> *                        SetColorProfileElementSize</span>
00966 <span class="comment"> *</span>
00967 <span class="comment"> *  Function:</span>
00968 <span class="comment"> *       This functions sets the data size of a tagged element. If the element</span>
00969 <span class="comment"> *       is already present in the profile it's size is changed, and the data</span>
00970 <span class="comment"> *       is truncated or extended as the case may be. If the element is not</span>
00971 <span class="comment"> *       present, it is created and the data is filled with zeroes.</span>
00972 <span class="comment"> *</span>
00973 <span class="comment"> *  Arguments:</span>
00974 <span class="comment"> *       hProfile - handle identifing the profile object</span>
00975 <span class="comment"> *       tagType  - the tag name of the element</span>
00976 <span class="comment"> *       cbSize   - new size for the element data</span>
00977 <span class="comment"> *</span>
00978 <span class="comment"> *  Returns:</span>
00979 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
00980 <span class="comment"> *</span>
00981 <span class="comment"> *  Comments:</span>
00982 <span class="comment"> *       If cbSize is 0, and the element is present, it is deleted.</span>
00983 <span class="comment"> *</span>
00984 <span class="comment"> ******************************************************************************/</span>
00985 
<a name="l00986"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a22">00986</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a22">SetColorProfileElementSize</a>(
00987     HPROFILE  hProfile,
00988     TAGTYPE   tagType,
00989     DWORD     cbSize
00990     )
00991 {
00992     PTAGDATA pTagData;
00993     PPROFOBJ pProfObj;
00994     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    i, nCount, newSize;
00995     TAGTYPE  rawTag;
00996     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     found, rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00997 
00998     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"SetColorProfileElementSize\n"</span>)));
00999 
01000     <span class="comment">//</span>
01001     <span class="comment">// Validate parameters</span>
01002     <span class="comment">//</span>
01003 
01004     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a5">ValidHandle</a>(hProfile, OBJ_PROFILE))
01005     {
01006         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to SetColorProfileElementSize\n"</span>)));
01007         SetLastError(ERROR_INVALID_PARAMETER);
01008         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01009     }
01010 
01011     pProfObj = (PPROFOBJ)HDLTOPTR(hProfile);
01012 
01013     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pProfObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01014 
01015     <span class="comment">//</span>
01016     <span class="comment">// Check the integrity of the profile</span>
01017     <span class="comment">//</span>
01018 
01019     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a6">ValidProfile</a>(pProfObj))
01020     {
01021         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid profile passed to SetColorProfileElementSize\n"</span>)));
01022         SetLastError(ERROR_INVALID_PROFILE);
01023         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01024     }
01025 
01026     <span class="comment">//</span>
01027     <span class="comment">// Check if profile has write access</span>
01028     <span class="comment">//</span>
01029 
01030     <span class="keywordflow">if</span> (!(pProfObj-&gt;dwFlags &amp; READWRITE_ACCESS))
01031     {
01032         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Writing to a profile without read/write access\n"</span>)));
01033         SetLastError(ERROR_ACCESS_DENIED);
01034         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01035     }
01036 
01037     <span class="comment">//</span>
01038     <span class="comment">// Get count of tag items - it is right after the profile header</span>
01039     <span class="comment">//</span>
01040 
01041     nCount = TAG_COUNT(pProfObj);
01042     nCount = FIX_ENDIAN(nCount);
01043 
01044     <span class="comment">//</span>
01045     <span class="comment">// Tag data records follow the count.</span>
01046     <span class="comment">//</span>
01047 
01048     pTagData = TAG_DATA(pProfObj);
01049 
01050     <span class="comment">//</span>
01051     <span class="comment">// Check if any of these records match the tag passed in.</span>
01052     <span class="comment">//</span>
01053 
01054     found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01055     rawTag = FIX_ENDIAN(tagType);
01056     <span class="keywordflow">for</span> (i=0; i&lt;nCount; i++)
01057     {
01058         <span class="keywordflow">if</span> (pTagData-&gt;tagType == rawTag)
01059         {
01060             found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01061             <span class="keywordflow">break</span>;
01062         }
01063         pTagData++;                     <span class="comment">// Next record</span>
01064     }
01065 
01066     <span class="keywordflow">if</span> (found)
01067     {
01068         <span class="comment">//</span>
01069         <span class="comment">// If it is a reference tag, create data area for it</span>
01070         <span class="comment">//</span>
01071 
01072         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a10">IsReferenceTag</a>(pProfObj, pTagData))
01073         {
01074             <span class="keywordflow">if</span> (cbSize == 0)
01075             {
01076                 PTAGDATA pTemp;
01077 
01078                 <span class="comment">//</span>
01079                 <span class="comment">// Move everything after the tag table entry up</span>
01080                 <span class="comment">// by size of one tag table entry.</span>
01081                 <span class="comment">//</span>
01082 
01083                 <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a9">MoveProfileData</a>(pProfObj, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)(pTagData+1), (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pTagData,
01084                     PROFILE_SIZE(pProfObj) - (LONG)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)(pTagData+1) - VIEW(pProfObj)), <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01085 
01086                 <span class="comment">//</span>
01087                 <span class="comment">// Go through the tag table and update the pointers</span>
01088                 <span class="comment">//</span>
01089 
01090                 pTemp = TAG_DATA(pProfObj);
01091 
01092                 <span class="comment">//</span>
01093                 <span class="comment">// Get count of tag items - it is right after the profile header</span>
01094                 <span class="comment">//</span>
01095 
01096                 nCount = TAG_COUNT(pProfObj);
01097                 nCount = FIX_ENDIAN(nCount) - 1;
01098                 TAG_COUNT(pProfObj) = FIX_ENDIAN(nCount);
01099 
01100                 <span class="keywordflow">for</span> (i=0; i&lt;nCount; i++)
01101                 {
01102                     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwTemp = FIX_ENDIAN(pTemp-&gt;dwOffset);
01103 
01104                     dwTemp -= <span class="keyword">sizeof</span>(TAGDATA);
01105                     pTemp-&gt;dwOffset = FIX_ENDIAN(dwTemp);
01106                     pTemp++;                     <span class="comment">// Next record</span>
01107                 }
01108 
01109                 <span class="comment">//</span>
01110                 <span class="comment">// Use nCount as a placeholder to calculate file size</span>
01111                 <span class="comment">//</span>
01112 
01113                 nCount = FIX_ENDIAN(HEADER(pProfObj)-&gt;phSize) - <span class="keyword">sizeof</span>(TAGDATA);
01114                 HEADER(pProfObj)-&gt;phSize = FIX_ENDIAN(nCount);
01115             }
01116             <span class="keywordflow">else</span>
01117             {
01118                 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwOffset;
01119 
01120                 <span class="comment">//</span>
01121                 <span class="comment">// Resize the profile if needed. For memory buffers, we have to realloc,</span>
01122                 <span class="comment">// and for mapped objects, we have to close and reopen the view.</span>
01123                 <span class="comment">//</span>
01124 
01125                 newSize = FIX_ENDIAN(HEADER(pProfObj)-&gt;phSize);
01126                 newSize = <a class="code" href="../../d4/d0/immcli_8h.html#a18">DWORD_ALIGN</a>(newSize) + cbSize;
01127 
01128                 <span class="comment">//</span>
01129                 <span class="comment">// Check for overflow</span>
01130                 <span class="comment">//</span>
01131 
01132                 <span class="keywordflow">if</span> (newSize &lt; FIX_ENDIAN(HEADER(pProfObj)-&gt;phSize) ||
01133                     newSize &lt; cbSize)
01134                 {
01135                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Overflow in setting reference element size\n"</span>)));
01136                     SetLastError(ERROR_ARITHMETIC_OVERFLOW);
01137                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01138                 }
01139 
01140                 <span class="keywordflow">if</span> (newSize &gt; pProfObj-&gt;dwMapSize)
01141                 {
01142                     <span class="comment">//Sundown: dwOffset should not be over 4gb</span>
01143                     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwOffset = (ULONG)(ULONG_PTR)(pTagData - TAG_DATA(pProfObj));
01144 
01145                     <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a8">GrowProfile</a>(pProfObj, newSize))
01146                     {
01147                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01148                     }
01149                     <span class="comment">//</span>
01150                     <span class="comment">// Recalculate pointers as mapping or memory pointer</span>
01151                     <span class="comment">// could have changed when growing profile</span>
01152                     <span class="comment">//</span>
01153 
01154                     pTagData = TAG_DATA(pProfObj) + dwOffset;
01155                 }
01156 
01157                 <span class="comment">//</span>
01158                 <span class="comment">// Calculate location of new data - should be DWORD aligned</span>
01159                 <span class="comment">//</span>
01160 
01161                 dwOffset = <a class="code" href="../../d4/d0/immcli_8h.html#a18">DWORD_ALIGN</a>(FIX_ENDIAN(HEADER(pProfObj)-&gt;phSize));
01162                 pTagData-&gt;dwOffset = FIX_ENDIAN(dwOffset);
01163 
01164                 <span class="comment">//</span>
01165                 <span class="comment">// Set final file size</span>
01166                 <span class="comment">//</span>
01167 
01168                 HEADER(pProfObj)-&gt;phSize = FIX_ENDIAN(dwOffset+cbSize);
01169             }
01170 
01171             rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01172         }
01173         <span class="keywordflow">else</span>
01174         {
01175             <span class="keywordflow">if</span> (cbSize == 0)
01176             {
01177                 rc = <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a6">DeleteTaggedElement</a>(pProfObj, pTagData);
01178             }
01179             <span class="keywordflow">else</span>
01180             {
01181                 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbOldSize;
01182 
01183                 <span class="comment">//</span>
01184                 <span class="comment">// Get current size of element</span>
01185                 <span class="comment">//</span>
01186 
01187                 cbOldSize = FIX_ENDIAN(pTagData-&gt;cbSize);
01188 
01189                 <span class="comment">//</span>
01190                 <span class="comment">// Compress or expand the file as the case may be.</span>
01191                 <span class="comment">//</span>
01192 
01193                 <span class="keywordflow">if</span> (cbSize &gt; cbOldSize)
01194                 {
01195                     <span class="comment">//Sundown: dwOffset should be safe to truncate</span>
01196                     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwOffset = (ULONG)(ULONG_PTR)(pTagData - TAG_DATA(pProfObj));
01197 
01198                     <span class="comment">//</span>
01199                     <span class="comment">// Check for overflow</span>
01200                     <span class="comment">//</span>
01201 
01202                     newSize = PROFILE_SIZE(pProfObj) + <a class="code" href="../../d4/d0/immcli_8h.html#a18">DWORD_ALIGN</a>(cbSize) -
01203                         <a class="code" href="../../d4/d0/immcli_8h.html#a18">DWORD_ALIGN</a>(cbOldSize);
01204 
01205                     <span class="keywordflow">if</span> (newSize &lt; PROFILE_SIZE(pProfObj))
01206                     {
01207                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Overflow in increasing element size\n"</span>)));
01208                         SetLastError(ERROR_ARITHMETIC_OVERFLOW);
01209                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01210                     }
01211 
01212                     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a8">GrowProfile</a>(pProfObj, newSize))
01213                     {
01214                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01215                     }
01216 
01217                     <span class="comment">//</span>
01218                     <span class="comment">// Recompute pointers</span>
01219                     <span class="comment">//</span>
01220 
01221                     pTagData = TAG_DATA(pProfObj) + dwOffset;
01222                 }
01223 
01224                 rc = <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a7">ChangeTaggedElementSize</a>(pProfObj, pTagData, cbSize);
01225             }
01226         }
01227     }
01228     <span class="keywordflow">else</span>
01229     {
01230         <span class="keywordflow">if</span> (cbSize == 0)
01231         {
01232             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"SetColorProfileElementSize (deleting): Tag not found\n"</span>)));
01233             SetLastError(ERROR_TAG_NOT_FOUND);
01234         }
01235         <span class="keywordflow">else</span>
01236         {
01237             rc = <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a5">AddTaggedElement</a>(pProfObj, tagType, cbSize);
01238         }
01239     }
01240 
01241     <span class="keywordflow">return</span> rc;
01242 }
01243 
01244 
01245 <span class="comment">/******************************************************************************</span>
01246 <span class="comment"> *</span>
01247 <span class="comment"> *                          SetColorProfileElement</span>
01248 <span class="comment"> *</span>
01249 <span class="comment"> *  Function:</span>
01250 <span class="comment"> *       This functions sets the data for a tagged element. It does not</span>
01251 <span class="comment"> *       change the size of the element, and only writes as much data as</span>
01252 <span class="comment"> *       would fit within the current size, overwriting any existing data.</span>
01253 <span class="comment"> *</span>
01254 <span class="comment"> *  Arguments:</span>
01255 <span class="comment"> *       hProfile - handle identifing the profile object</span>
01256 <span class="comment"> *       tagType  - the tag name of the element</span>
01257 <span class="comment"> *       dwOffset - offset within the element data from which to write</span>
01258 <span class="comment"> *       pcbSize  - number of bytes to write. On return it is the number of</span>
01259 <span class="comment"> *                  bytes written.</span>
01260 <span class="comment"> *       pBuffer  - pointer to buffer having data to write</span>
01261 <span class="comment"> *</span>
01262 <span class="comment"> *  Returns:</span>
01263 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
01264 <span class="comment"> *</span>
01265 <span class="comment"> ******************************************************************************/</span>
01266 
<a name="l01267"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a23">01267</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a23">SetColorProfileElement</a>(
01268     HPROFILE  hProfile,
01269     TAGTYPE   tagType,
01270     DWORD     dwOffset,
01271     PDWORD    pcbSize,
01272     PVOID     pBuffer
01273     )
01274 {
01275     PPROFOBJ pProfObj;
01276     PTAGDATA pTagData;
01277     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    nCount, nBytes, i;
01278     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     found;
01279     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;            <span class="comment">// Assume failure</span>
01280 
01281     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"SetColorProfileElement\n"</span>)));
01282 
01283     <span class="comment">//</span>
01284     <span class="comment">// Validate parameters</span>
01285     <span class="comment">//</span>
01286 
01287     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a5">ValidHandle</a>(hProfile, OBJ_PROFILE) ||
01288         !pcbSize ||
01289         IsBadWritePtr(pcbSize, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)) ||
01290         !pBuffer ||
01291         IsBadReadPtr(pBuffer, *pcbSize)
01292        )
01293     {
01294         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to SetColorProfileElement\n"</span>)));
01295         SetLastError(ERROR_INVALID_PARAMETER);
01296         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01297     }
01298 
01299     pProfObj = (PPROFOBJ)HDLTOPTR(hProfile);
01300 
01301     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pProfObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01302 
01303     <span class="comment">//</span>
01304     <span class="comment">// Check the integrity of the profile</span>
01305     <span class="comment">//</span>
01306 
01307     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a6">ValidProfile</a>(pProfObj))
01308     {
01309         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid profile passed to SetColorProfileElement\n"</span>)));
01310         SetLastError(ERROR_INVALID_PROFILE);
01311         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01312     }
01313 
01314     <span class="comment">//</span>
01315     <span class="comment">// Check if profile has write access</span>
01316     <span class="comment">//</span>
01317 
01318     <span class="keywordflow">if</span> (!(pProfObj-&gt;dwFlags &amp; READWRITE_ACCESS))
01319     {
01320         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Writing to a profile without read/write access\n"</span>)));
01321         SetLastError(ERROR_ACCESS_DENIED);
01322         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01323     }
01324 
01325     <span class="comment">//</span>
01326     <span class="comment">// Get count of tag items - it is right after the profile header</span>
01327     <span class="comment">//</span>
01328 
01329     nCount = TAG_COUNT(pProfObj);
01330     nCount = FIX_ENDIAN(nCount);
01331 
01332     <span class="comment">//</span>
01333     <span class="comment">// Tag data records follow the count.</span>
01334     <span class="comment">//</span>
01335 
01336     pTagData = TAG_DATA(pProfObj);
01337 
01338     <span class="comment">//</span>
01339     <span class="comment">// Check if any of these records match the tag passed in</span>
01340     <span class="comment">//</span>
01341 
01342     found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01343     tagType = FIX_ENDIAN(tagType);
01344     <span class="keywordflow">for</span> (i=0; i&lt;nCount; i++)
01345     {
01346         <span class="keywordflow">if</span> (pTagData-&gt;tagType == tagType)
01347         {
01348             found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01349             <span class="keywordflow">break</span>;
01350         }
01351         pTagData++;                     <span class="comment">// Next record</span>
01352     }
01353 
01354     <span class="keywordflow">if</span> (found)
01355     {
01356         <span class="comment">//</span>
01357         <span class="comment">// If it is a reference tag, create new space for it</span>
01358         <span class="comment">//</span>
01359 
01360         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a10">IsReferenceTag</a>(pProfObj, pTagData))
01361         {
01362             <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a22">SetColorProfileElementSize</a>(hProfile, tagType, FIX_ENDIAN(pTagData-&gt;cbSize));
01363         }
01364 
01365         <span class="comment">//</span>
01366         <span class="comment">// Get number of bytes to set</span>
01367         <span class="comment">//</span>
01368 
01369         <span class="keywordflow">if</span> (dwOffset &gt;= FIX_ENDIAN(pTagData-&gt;cbSize))
01370         {
01371             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"dwOffset too large for SetColorProfileElement\n"</span>)));
01372             SetLastError(ERROR_INVALID_PARAMETER);
01373             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01374         }
01375         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dwOffset + *pcbSize &gt; FIX_ENDIAN(pTagData-&gt;cbSize))
01376         {
01377             nBytes = FIX_ENDIAN(pTagData-&gt;cbSize) - dwOffset;
01378         }
01379         <span class="keywordflow">else</span>
01380         {
01381             nBytes = *pcbSize;
01382         }
01383 
01384         <span class="comment">//</span>
01385         <span class="comment">// Copy the data into the profile</span>
01386         <span class="comment">//</span>
01387 
01388         CopyMemory((PVOID)(pProfObj-&gt;pView + FIX_ENDIAN(pTagData-&gt;dwOffset)
01389             + dwOffset), (PVOID)pBuffer, nBytes);
01390         *pcbSize = nBytes;
01391 
01392         rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01393     }
01394     <span class="keywordflow">else</span>
01395     {
01396         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"SetColorProfileElement: Tag not found\n"</span>)));
01397         SetLastError(ERROR_TAG_NOT_FOUND);
01398     }
01399 
01400     <span class="keywordflow">return</span> rc;
01401 }
01402 
01403 
01404 <span class="comment">/******************************************************************************</span>
01405 <span class="comment"> *</span>
01406 <span class="comment"> *                       SetColorProfileElementReference</span>
01407 <span class="comment"> *</span>
01408 <span class="comment"> *  Function:</span>
01409 <span class="comment"> *       This functions creates a new tag and makes it refer to the same</span>
01410 <span class="comment"> *       data as an existing tag.</span>
01411 <span class="comment"> *</span>
01412 <span class="comment"> *  Arguments:</span>
01413 <span class="comment"> *       hProfile - handle identifing the profile object</span>
01414 <span class="comment"> *       newTag   - new tag to create</span>
01415 <span class="comment"> *       refTag   - reference tag whose data newTag should refer to</span>
01416 <span class="comment"> *</span>
01417 <span class="comment"> *  Returns:</span>
01418 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
01419 <span class="comment"> *</span>
01420 <span class="comment"> ******************************************************************************/</span>
01421 
<a name="l01422"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a24">01422</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a24">SetColorProfileElementReference</a>(
01423     HPROFILE hProfile,
01424     TAGTYPE  newTag,
01425     TAGTYPE  refTag
01426     )
01427 {
01428     PPROFOBJ pProfObj;
01429     PTAGDATA pTagData, pOrigTag;
01430     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    nCount, i;
01431     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     found;
01432     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;            <span class="comment">// Assume failure</span>
01433 
01434     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"SetColorProfileElementReference\n"</span>)));
01435 
01436     <span class="comment">//</span>
01437     <span class="comment">// Validate parameters</span>
01438     <span class="comment">//</span>
01439 
01440     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a5">ValidHandle</a>(hProfile, OBJ_PROFILE))
01441     {
01442         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to SetColorProfileElementReference\n"</span>)));
01443         SetLastError(ERROR_INVALID_PARAMETER);
01444         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01445     }
01446 
01447     pProfObj = (PPROFOBJ)HDLTOPTR(hProfile);
01448 
01449     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pProfObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01450 
01451     <span class="comment">//</span>
01452     <span class="comment">// Check the integrity of the profile</span>
01453     <span class="comment">//</span>
01454 
01455     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a6">ValidProfile</a>(pProfObj))
01456     {
01457         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid profile passed to SetColorProfileElementReference\n"</span>)));
01458         SetLastError(ERROR_INVALID_PROFILE);
01459         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01460     }
01461 
01462     <span class="comment">//</span>
01463     <span class="comment">// Check if profile has write access</span>
01464     <span class="comment">//</span>
01465 
01466     <span class="keywordflow">if</span> (!(pProfObj-&gt;dwFlags &amp; READWRITE_ACCESS))
01467     {
01468         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Writing to a profile without read/write access\n"</span>)));
01469         SetLastError(ERROR_ACCESS_DENIED);
01470         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01471     }
01472 
01473     <span class="comment">//</span>
01474     <span class="comment">// Get count of tag items - it is right after the profile header</span>
01475     <span class="comment">//</span>
01476     nCount = TAG_COUNT(pProfObj);
01477     nCount = FIX_ENDIAN(nCount);
01478 
01479     <span class="comment">//</span>
01480     <span class="comment">// Tag data records follow the count.</span>
01481     <span class="comment">//</span>
01482 
01483     pTagData = TAG_DATA(pProfObj);
01484 
01485     <span class="comment">//</span>
01486     <span class="comment">// Check if any of these records match the tag passed in</span>
01487     <span class="comment">//</span>
01488 
01489     found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01490     refTag = FIX_ENDIAN(refTag);
01491     <span class="keywordflow">for</span> (i=0; i&lt;nCount; i++)
01492     {
01493         <span class="keywordflow">if</span> (pTagData-&gt;tagType == refTag)
01494         {
01495             pOrigTag = pTagData;
01496             found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01497         }
01498 
01499         <span class="keywordflow">if</span> (pTagData-&gt;tagType == FIX_ENDIAN(newTag))
01500         {
01501             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Duplicate tag present in SetColorProfileElementReference %x\n"</span>), newTag));
01502             SetLastError(ERROR_DUPLICATE_TAG);
01503             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01504         }
01505         pTagData++;                     <span class="comment">// Next record</span>
01506     }
01507 
01508     <span class="keywordflow">if</span> (found)
01509     {
01510         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> newSize;
01511 
01512         <span class="comment">//</span>
01513         <span class="comment">// Grow profile if needed</span>
01514         <span class="comment">//</span>
01515 
01516         newSize = FIX_ENDIAN(HEADER(pProfObj)-&gt;phSize);
01517         newSize = <a class="code" href="../../d4/d0/immcli_8h.html#a18">DWORD_ALIGN</a>(newSize) + <span class="keyword">sizeof</span>(TAGDATA);
01518 
01519         <span class="comment">//</span>
01520         <span class="comment">// Check for overflow</span>
01521         <span class="comment">//</span>
01522 
01523         <span class="keywordflow">if</span> (newSize &lt; FIX_ENDIAN(HEADER(pProfObj)-&gt;phSize))
01524         {
01525             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Overflow in adding element\n"</span>)));
01526             SetLastError(ERROR_ARITHMETIC_OVERFLOW);
01527             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01528         }
01529 
01530         <span class="keywordflow">if</span> (newSize &gt; pProfObj-&gt;dwMapSize)
01531         {
01532             <span class="comment">//Sundown: safe truncation</span>
01533             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwOffset = (ULONG)(ULONG_PTR)(pOrigTag - TAG_DATA(pProfObj));
01534 
01535             <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a8">GrowProfile</a>(pProfObj, newSize))
01536             {
01537                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01538             }
01539             <span class="comment">//</span>
01540             <span class="comment">// Recalculate pointers as mapping or memory pointer</span>
01541             <span class="comment">// could have changed when growing profile</span>
01542             <span class="comment">//</span>
01543 
01544             pOrigTag = TAG_DATA(pProfObj) + dwOffset;
01545         }
01546 
01547         rc = <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a4">AddTagTableEntry</a>(pProfObj, newTag, FIX_ENDIAN(pOrigTag-&gt;dwOffset),
01548             FIX_ENDIAN(pOrigTag-&gt;cbSize), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01549     }
01550     <span class="keywordflow">else</span>
01551     {
01552         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"SetColorProfileElementReference: Tag 0x%x not found\n"</span>),
01553             FIX_ENDIAN(refTag)));       <span class="comment">// Re-fix it to reflect data passed in</span>
01554         SetLastError(ERROR_TAG_NOT_FOUND);
01555     }
01556 
01557     <span class="keywordflow">return</span> rc;
01558 }
01559 
01560 
01561 <span class="comment">/******************************************************************************</span>
01562 <span class="comment"> *</span>
01563 <span class="comment"> *                       GetColorProfileHeader</span>
01564 <span class="comment"> *</span>
01565 <span class="comment"> *  Function:</span>
01566 <span class="comment"> *       This functions retrieves the header of a profile</span>
01567 <span class="comment"> *</span>
01568 <span class="comment"> *  Arguments:</span>
01569 <span class="comment"> *       hProfile - handle identifing the profile object</span>
01570 <span class="comment"> *       pHeader  - pointer to buffer to recieve the header</span>
01571 <span class="comment"> *</span>
01572 <span class="comment"> *  Returns:</span>
01573 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
01574 <span class="comment"> *</span>
01575 <span class="comment"> ******************************************************************************/</span>
01576 
<a name="l01577"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a25">01577</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a25">GetColorProfileHeader</a>(
01578     HPROFILE       hProfile,
01579     PPROFILEHEADER pHeader
01580     )
01581 {
01582     PPROFOBJ pProfObj;
01583     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    nCount, i, temp;
01584 
01585     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"GetColorProfileHeader\n"</span>)));
01586 
01587     <span class="comment">//</span>
01588     <span class="comment">// Validate parameters</span>
01589     <span class="comment">//</span>
01590 
01591     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a5">ValidHandle</a>(hProfile, OBJ_PROFILE) ||
01592         IsBadWritePtr(pHeader, <span class="keyword">sizeof</span>(PROFILEHEADER)))
01593     {
01594         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to GetColorProfileHeader\n"</span>)));
01595         SetLastError(ERROR_INVALID_PARAMETER);
01596         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01597     }
01598 
01599     pProfObj = (PPROFOBJ)HDLTOPTR(hProfile);
01600 
01601     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pProfObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01602 
01603     <span class="comment">//</span>
01604     <span class="comment">// Check the integrity of the profile.</span>
01605     <span class="comment">//</span>
01606 
01607     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a6">ValidProfile</a>(pProfObj))
01608     {
01609         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid profile passed to GetColorProfileHeader\n"</span>)));
01610         SetLastError(ERROR_INVALID_PROFILE);
01611         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01612     }
01613 
01614     CopyMemory((PVOID)pHeader, (PVOID)pProfObj-&gt;pView,
01615         <span class="keyword">sizeof</span>(PROFILEHEADER));
01616 
01617     <span class="comment">//</span>
01618     <span class="comment">// Fix up all fields to platform specific values.</span>
01619     <span class="comment">// The following code assumes that the profile header is a</span>
01620     <span class="comment">// multiple of DWORDs which it is!</span>
01621     <span class="comment">//</span>
01622 
01623     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<span class="keyword">sizeof</span>(PROFILEHEADER) % <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) == 0);
01624 
01625     nCount = <span class="keyword">sizeof</span>(PROFILEHEADER)/<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
01626     <span class="keywordflow">for</span> (i=0; i&lt;nCount;i++)
01627     {
01628         temp = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)((PDWORD)pHeader)[i];
01629         ((PDWORD)pHeader)[i] = FIX_ENDIAN(temp);
01630     }
01631 
01632     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01633 }
01634 
01635 
01636 <span class="comment">/******************************************************************************</span>
01637 <span class="comment"> *</span>
01638 <span class="comment"> *                       SetColorProfileHeader</span>
01639 <span class="comment"> *</span>
01640 <span class="comment"> *  Function:</span>
01641 <span class="comment"> *       This functions sets the header of a profile</span>
01642 <span class="comment"> *</span>
01643 <span class="comment"> *  Arguments:</span>
01644 <span class="comment"> *       hProfile - handle identifing the profile object</span>
01645 <span class="comment"> *       pHeader  - pointer to buffer identifing the header</span>
01646 <span class="comment"> *</span>
01647 <span class="comment"> *  Returns:</span>
01648 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
01649 <span class="comment"> *</span>
01650 <span class="comment"> ******************************************************************************/</span>
01651 
<a name="l01652"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a26">01652</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a26">SetColorProfileHeader</a>(
01653     HPROFILE       hProfile,
01654     PPROFILEHEADER pHeader
01655     )
01656 {
01657     PPROFOBJ pProfObj;
01658     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    nCount, i, temp;
01659 
01660     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"SetColorProfileHeader\n"</span>)));
01661 
01662     <span class="comment">//</span>
01663     <span class="comment">// Validate parameters</span>
01664     <span class="comment">//</span>
01665 
01666     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a5">ValidHandle</a>(hProfile, OBJ_PROFILE) ||
01667         IsBadReadPtr(pHeader, <span class="keyword">sizeof</span>(PROFILEHEADER)))
01668     {
01669         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to SetColorProfileHeader\n"</span>)));
01670         SetLastError(ERROR_INVALID_PARAMETER);
01671         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01672     }
01673 
01674     pProfObj = (PPROFOBJ)HDLTOPTR(hProfile);
01675 
01676     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pProfObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01677 
01678     <span class="comment">//</span>
01679     <span class="comment">// Check if profile has write access</span>
01680     <span class="comment">//</span>
01681 
01682     <span class="keywordflow">if</span> (!(pProfObj-&gt;dwFlags &amp; READWRITE_ACCESS))
01683     {
01684         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Writing to a profile without read/write access\n"</span>)));
01685         SetLastError(ERROR_ACCESS_DENIED);
01686         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01687     }
01688 
01689     <span class="comment">//</span>
01690     <span class="comment">// Fix up all fields to BIG-ENDIAN.</span>
01691     <span class="comment">// The following code assumes that the profile header is a</span>
01692     <span class="comment">// multiple of DWORDs which it is!</span>
01693     <span class="comment">//</span>
01694 
01695     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<span class="keyword">sizeof</span>(PROFILEHEADER) % <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) == 0);
01696 
01697     nCount = <span class="keyword">sizeof</span>(PROFILEHEADER)/<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
01698     <span class="keywordflow">for</span> (i=0; i&lt;nCount;i++)
01699     {
01700         temp = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)((PDWORD)pHeader)[i];
01701         ((PDWORD)pHeader)[i] = FIX_ENDIAN(temp);
01702     }
01703 
01704     CopyMemory((PVOID)pProfObj-&gt;pView, (PVOID)pHeader,
01705         <span class="keyword">sizeof</span>(PROFILEHEADER));
01706 
01707     <span class="comment">//</span>
01708     <span class="comment">// Put back app supplied buffer the way it came in</span>
01709     <span class="comment">//</span>
01710 
01711     <span class="keywordflow">for</span> (i=0; i&lt;nCount;i++)
01712     {
01713         temp = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)((PDWORD)pHeader)[i];
01714         ((PDWORD)pHeader)[i] = FIX_ENDIAN(temp);
01715     }
01716 
01717     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01718 }
01719 
01720 
01721 <span class="comment">/******************************************************************************</span>
01722 <span class="comment"> *</span>
01723 <span class="comment"> *                        GetPS2ColorSpaceArray</span>
01724 <span class="comment"> *</span>
01725 <span class="comment"> *  Function:</span>
01726 <span class="comment"> *       This functions retrieves the PostScript Level 2 CSA from the profile</span>
01727 <span class="comment"> *</span>
01728 <span class="comment"> *  Arguments:</span>
01729 <span class="comment"> *       hProfile  - handle identifing the profile object</span>
01730 <span class="comment"> *       dwIntent  - rendering intent of CSA</span>
01731 <span class="comment"> *       dwCSAType - type of CSA</span>
01732 <span class="comment"> *       pbuffer   - pointer to receive the CSA</span>
01733 <span class="comment"> *       pcbSize   - pointer to size of buffer. If function fails because</span>
01734 <span class="comment"> *                   buffer is not big enough, it is filled with required size.</span>
01735 <span class="comment"> *       pcbBinary - TRUE if binary data is requested. On return it is set to</span>
01736 <span class="comment"> *                   reflect the data returned</span>
01737 <span class="comment"> *</span>
01738 <span class="comment"> *  Returns:</span>
01739 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
01740 <span class="comment"> *</span>
01741 <span class="comment"> ******************************************************************************/</span>
01742 
01743 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI
<a name="l01744"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a27">01744</a> <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a27">GetPS2ColorSpaceArray</a> (
01745     HPROFILE  hProfile,
01746     DWORD     dwIntent,
01747     DWORD     dwCSAType,
01748     PBYTE     pBuffer,
01749     PDWORD    pcbSize,
01750     LPBOOL    pbBinary
01751     )
01752 {
01753     PPROFOBJ pProfObj;
01754     PCMMOBJ  pCMMObj;
01755     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    cmmID;
01756     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     rc;
01757 
01758     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"GetPS2ColorSpaceArray\n"</span>)));
01759 
01760     <span class="comment">//</span>
01761     <span class="comment">// Validate parameters</span>
01762     <span class="comment">//</span>
01763 
01764     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a5">ValidHandle</a>(hProfile, OBJ_PROFILE)   ||
01765         IsBadWritePtr(pcbSize, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)) ||
01766         (pBuffer &amp;&amp;
01767          IsBadWritePtr(pBuffer, *pcbSize)
01768         )                                     ||
01769         IsBadWritePtr(pbBinary, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>))
01770        )
01771     {
01772         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to GetPS2ColorSpaceArray\n"</span>)));
01773         SetLastError(ERROR_INVALID_PARAMETER);
01774         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01775     }
01776 
01777     pProfObj = (PPROFOBJ)HDLTOPTR(hProfile);
01778 
01779     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pProfObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01780 
01781     <span class="comment">//</span>
01782     <span class="comment">// Check the integrity of the profile</span>
01783     <span class="comment">//</span>
01784 
01785     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a6">ValidProfile</a>(pProfObj))
01786     {
01787         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid profile passed to GetPS2ColorSpaceArray\n"</span>)));
01788         SetLastError(ERROR_INVALID_PROFILE);
01789         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01790     }
01791 
01792     <span class="comment">//</span>
01793     <span class="comment">// Check if application specified CMM is present</span>
01794     <span class="comment">//</span>
01795 
01796     pCMMObj = <a class="code" href="../../d2/d1/object_8c.html#a15">GetPreferredCMM</a>();
01797     <span class="keywordflow">if</span> (!pCMMObj || (pCMMObj-&gt;dwFlags &amp; CMM_DONT_USE_PS2_FNS) ||
01798         !pCMMObj-&gt;fns.pCMGetPS2ColorSpaceArray)
01799     {
01800         <span class="keywordflow">if</span> (pCMMObj)
01801         {
01802             pCMMObj-&gt;dwFlags |= CMM_DONT_USE_PS2_FNS;
01803             <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pCMMObj);
01804         }
01805 
01806         <span class="comment">//</span>
01807         <span class="comment">// Get CMM associated with profile. If it does not exist or does not</span>
01808         <span class="comment">// support the CMGetPS2ColorSpaceArray function, get default CMM.</span>
01809         <span class="comment">//</span>
01810 
01811         cmmID = HEADER(pProfObj)-&gt;phCMMType;
01812         cmmID = FIX_ENDIAN(cmmID);
01813 
01814         pCMMObj  = <a class="code" href="../../d2/d1/object_8c.html#a14">GetColorMatchingModule</a>(cmmID);
01815 
01816         <span class="keywordflow">if</span> (!pCMMObj || (pCMMObj-&gt;dwFlags &amp; CMM_DONT_USE_PS2_FNS) ||
01817             !pCMMObj-&gt;fns.pCMGetPS2ColorSpaceArray)
01818         {
01819             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a3">TERSE</a>((__TEXT(<span class="stringliteral">"CMM associated with profile could not be used"</span>)));
01820 
01821             <span class="keywordflow">if</span> (pCMMObj)
01822             {
01823                 pCMMObj-&gt;dwFlags |= CMM_DONT_USE_PS2_FNS;
01824                 <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pCMMObj);
01825             }
01826 
01827             pCMMObj = <a class="code" href="../../d2/d1/object_8c.html#a14">GetColorMatchingModule</a>(CMM_WINDOWS_DEFAULT);
01828 
01829             <span class="keywordflow">if</span> (!pCMMObj || !pCMMObj-&gt;fns.pCMGetPS2ColorSpaceArray)
01830             {
01831                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Default CMM doesn't support CMGetPS2ColorSpaceArray\n"</span>)));
01832                 <span class="keywordflow">if</span> (pCMMObj)
01833                 {
01834                     <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pCMMObj);
01835                     pCMMObj = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01836                 }
01837             }
01838         }
01839     }
01840 
01841     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pProfObj-&gt;pView != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01842 
01843     <span class="keywordflow">if</span> (pCMMObj)
01844     {
01845         rc = pCMMObj-&gt;fns.pCMGetPS2ColorSpaceArray(hProfile, dwIntent, dwCSAType,
01846             pBuffer, pcbSize, pbBinary);
01847     }
01848     <span class="keywordflow">else</span>
01849     {
01850         rc = <a class="code" href="../../d2/d9/ps2_8c.html#a254">InternalGetPS2ColorSpaceArray</a>(pProfObj-&gt;pView, dwIntent,
01851             dwCSAType, pBuffer, pcbSize, pbBinary);
01852     }
01853 
01854     <span class="keywordflow">if</span> (pCMMObj)
01855     {
01856         <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pCMMObj);
01857     }
01858 
01859     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a2">VERBOSE</a>((__TEXT(<span class="stringliteral">"GetPS2ColorSpaceArray returning %s\n"</span>),
01860         rc ? <span class="stringliteral">"TRUE"</span> : <span class="stringliteral">"FALSE"</span>));
01861 
01862     <span class="keywordflow">return</span> rc;
01863 }
01864 
01865 
01866 <span class="comment">/******************************************************************************</span>
01867 <span class="comment"> *</span>
01868 <span class="comment"> *                       GetPS2ColorRenderingIntent</span>
01869 <span class="comment"> *</span>
01870 <span class="comment"> *  Function:</span>
01871 <span class="comment"> *       This functions retrieves the PostScript Level 2 color rendering intent</span>
01872 <span class="comment"> *       from the profile</span>
01873 <span class="comment"> *</span>
01874 <span class="comment"> *  Arguments:</span>
01875 <span class="comment"> *       hProfile  - handle identifing the profile object</span>
01876 <span class="comment"> *       pbuffer   - pointer to receive the color rendering intent</span>
01877 <span class="comment"> *       pcbSize   - pointer to size of buffer. If function fails because</span>
01878 <span class="comment"> *                   buffer is not big enough, it is filled with required size.</span>
01879 <span class="comment"> *       pcbBinary - TRUE if binary data is requested. On return it is set to</span>
01880 <span class="comment"> *                   reflect the data returned</span>
01881 <span class="comment"> *</span>
01882 <span class="comment"> *  Returns:</span>
01883 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
01884 <span class="comment"> *</span>
01885 <span class="comment"> ******************************************************************************/</span>
01886 
<a name="l01887"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a28">01887</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a28">GetPS2ColorRenderingIntent</a>(
01888     HPROFILE  hProfile,
01889     DWORD     dwIntent,
01890     PBYTE     pBuffer,
01891     PDWORD    pcbSize
01892     )
01893 {
01894     PPROFOBJ pProfObj;
01895     PCMMOBJ  pCMMObj;
01896     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    cmmID;
01897     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     rc;
01898 
01899     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"GetPS2ColorRenderingIntent\n"</span>)));
01900 
01901     <span class="comment">//</span>
01902     <span class="comment">// Validate parameters</span>
01903     <span class="comment">//</span>
01904 
01905     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a5">ValidHandle</a>(hProfile, OBJ_PROFILE) ||
01906         IsBadWritePtr(pcbSize, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)) ||
01907         (pBuffer &amp;&amp;
01908          IsBadWritePtr(pBuffer, *pcbSize)
01909         )
01910        )
01911     {
01912         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to GetPS2ColorRenderingIntent\n"</span>)));
01913         SetLastError(ERROR_INVALID_PARAMETER);
01914         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01915     }
01916 
01917     pProfObj = (PPROFOBJ)HDLTOPTR(hProfile);
01918 
01919     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pProfObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01920 
01921     <span class="comment">//</span>
01922     <span class="comment">// Check the integrity of the profile</span>
01923     <span class="comment">//</span>
01924 
01925     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a6">ValidProfile</a>(pProfObj))
01926     {
01927         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid profile passed to GetPS2ColorRenderingIntent\n"</span>)));
01928         SetLastError(ERROR_INVALID_PROFILE);
01929         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01930     }
01931 
01932     <span class="comment">//</span>
01933     <span class="comment">// Check if application specified CMM is present</span>
01934     <span class="comment">//</span>
01935 
01936     pCMMObj = <a class="code" href="../../d2/d1/object_8c.html#a15">GetPreferredCMM</a>();
01937     <span class="keywordflow">if</span> (!pCMMObj || (pCMMObj-&gt;dwFlags &amp; CMM_DONT_USE_PS2_FNS) ||
01938         !pCMMObj-&gt;fns.pCMGetPS2ColorRenderingIntent)
01939     {
01940         <span class="keywordflow">if</span> (pCMMObj)
01941         {
01942             pCMMObj-&gt;dwFlags |= CMM_DONT_USE_PS2_FNS;
01943             <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pCMMObj);
01944         }
01945 
01946         <span class="comment">//</span>
01947         <span class="comment">// Get CMM associated with profile. If it does not exist or does not</span>
01948         <span class="comment">// support the CMGetPS2ColorSpaceArray function, get default CMM.</span>
01949         <span class="comment">//</span>
01950 
01951         cmmID = HEADER(pProfObj)-&gt;phCMMType;
01952         cmmID = FIX_ENDIAN(cmmID);
01953 
01954         pCMMObj  = <a class="code" href="../../d2/d1/object_8c.html#a14">GetColorMatchingModule</a>(cmmID);
01955 
01956         <span class="keywordflow">if</span> (!pCMMObj || (pCMMObj-&gt;dwFlags &amp; CMM_DONT_USE_PS2_FNS) ||
01957             !pCMMObj-&gt;fns.pCMGetPS2ColorRenderingIntent)
01958         {
01959             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a3">TERSE</a>((__TEXT(<span class="stringliteral">"CMM associated with profile could not be used"</span>)));
01960 
01961             <span class="keywordflow">if</span> (pCMMObj)
01962             {
01963                 pCMMObj-&gt;dwFlags |= CMM_DONT_USE_PS2_FNS;
01964                 <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pCMMObj);
01965             }
01966 
01967             pCMMObj = <a class="code" href="../../d2/d1/object_8c.html#a14">GetColorMatchingModule</a>(CMM_WINDOWS_DEFAULT);
01968 
01969             <span class="keywordflow">if</span> (!pCMMObj || !pCMMObj-&gt;fns.pCMGetPS2ColorRenderingIntent)
01970             {
01971                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Default CMM doesn't support CMGetPS2ColorRenderingIntent\n"</span>)));
01972                 <span class="keywordflow">if</span> (pCMMObj)
01973                 {
01974                     <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pCMMObj);
01975                     pCMMObj = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01976                 }
01977             }
01978         }
01979     }
01980 
01981     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pProfObj-&gt;pView != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01982 
01983     <span class="keywordflow">if</span> (pCMMObj)
01984     {
01985         rc = pCMMObj-&gt;fns.pCMGetPS2ColorRenderingIntent(hProfile,
01986             dwIntent, pBuffer, pcbSize);
01987     }
01988     <span class="keywordflow">else</span>
01989     {
01990         rc = <a class="code" href="../../d2/d9/ps2_8c.html#a255">InternalGetPS2ColorRenderingIntent</a>(pProfObj-&gt;pView, dwIntent,
01991             pBuffer, pcbSize);
01992     }
01993 
01994     <span class="keywordflow">if</span> (pCMMObj)
01995     {
01996         <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pCMMObj);
01997     }
01998 
01999     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a2">VERBOSE</a>((__TEXT(<span class="stringliteral">"GetPS2ColorRenderingIntent returning %s\n"</span>),
02000         rc ? <span class="stringliteral">"TRUE"</span> : <span class="stringliteral">"FALSE"</span>));
02001 
02002     <span class="keywordflow">return</span> rc;
02003 }
02004 
02005 
02006 <span class="comment">/******************************************************************************</span>
02007 <span class="comment"> *</span>
02008 <span class="comment"> *                       GetPS2ColorRenderingDictionary</span>
02009 <span class="comment"> *</span>
02010 <span class="comment"> *  Function:</span>
02011 <span class="comment"> *       This functions retrieves the PostScript Level 2 CRD from the profile</span>
02012 <span class="comment"> *</span>
02013 <span class="comment"> *  Arguments:</span>
02014 <span class="comment"> *       hProfile  - handle identifing the profile object</span>
02015 <span class="comment"> *       dwIntent  - intent whose CRD is required</span>
02016 <span class="comment"> *       pbuffer   - pointer to receive the CSA</span>
02017 <span class="comment"> *       pcbSize   - pointer to size of buffer. If function fails because</span>
02018 <span class="comment"> *                   buffer is not big enough, it is filled with required size.</span>
02019 <span class="comment"> *       pcbBinary - TRUE if binary data is requested. On return it is set to</span>
02020 <span class="comment"> *                   reflect the data returned</span>
02021 <span class="comment"> *</span>
02022 <span class="comment"> *  Returns:</span>
02023 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
02024 <span class="comment"> *</span>
02025 <span class="comment"> ******************************************************************************/</span>
02026 
<a name="l02027"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a29">02027</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a29">GetPS2ColorRenderingDictionary</a>(
02028     HPROFILE  hProfile,
02029     DWORD     dwIntent,
02030     PBYTE     pBuffer,
02031     PDWORD    pcbSize,
02032     PBOOL     pbBinary
02033     )
02034 {
02035     PPROFOBJ pProfObj;
02036     PCMMOBJ  pCMMObj;
02037     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    cmmID;
02038     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     rc;
02039 
02040     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"GetPS2ColorRenderingDictionary\n"</span>)));
02041 
02042     <span class="comment">//</span>
02043     <span class="comment">// Validate parameters</span>
02044     <span class="comment">//</span>
02045 
02046     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a5">ValidHandle</a>(hProfile, OBJ_PROFILE)     ||
02047         IsBadWritePtr(pcbSize, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>))   ||
02048         (pBuffer &amp;&amp;
02049          IsBadWritePtr(pBuffer, *pcbSize)
02050         )                                       ||
02051         IsBadWritePtr(pbBinary, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>))
02052        )
02053     {
02054         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to GetPS2ColorRenderingDictionary\n"</span>)));
02055         SetLastError(ERROR_INVALID_PARAMETER);
02056         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02057     }
02058 
02059     pProfObj = (PPROFOBJ)HDLTOPTR(hProfile);
02060 
02061     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pProfObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02062 
02063     <span class="comment">//</span>
02064     <span class="comment">// Check the integrity of the profile</span>
02065     <span class="comment">//</span>
02066 
02067     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a6">ValidProfile</a>(pProfObj))
02068     {
02069         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid profile passed to GetPS2ColorRenderingDictionary\n"</span>)));
02070         SetLastError(ERROR_INVALID_PROFILE);
02071         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02072     }
02073 
02074     <span class="comment">//</span>
02075     <span class="comment">// Check if application specified CMM is present</span>
02076     <span class="comment">//</span>
02077 
02078     pCMMObj = <a class="code" href="../../d2/d1/object_8c.html#a15">GetPreferredCMM</a>();
02079     <span class="keywordflow">if</span> (!pCMMObj || (pCMMObj-&gt;dwFlags &amp; CMM_DONT_USE_PS2_FNS) ||
02080         !pCMMObj-&gt;fns.pCMGetPS2ColorRenderingDictionary)
02081     {
02082         <span class="keywordflow">if</span> (pCMMObj)
02083         {
02084             pCMMObj-&gt;dwFlags |= CMM_DONT_USE_PS2_FNS;
02085             <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pCMMObj);
02086         }
02087 
02088         <span class="comment">//</span>
02089         <span class="comment">// Get CMM associated with profile. If it does not exist or does not</span>
02090         <span class="comment">// support the CMGetPS2ColorSpaceArray function, get default CMM.</span>
02091         <span class="comment">//</span>
02092 
02093         cmmID = HEADER(pProfObj)-&gt;phCMMType;
02094         cmmID = FIX_ENDIAN(cmmID);
02095 
02096         pCMMObj  = <a class="code" href="../../d2/d1/object_8c.html#a14">GetColorMatchingModule</a>(cmmID);
02097 
02098         <span class="keywordflow">if</span> (!pCMMObj || (pCMMObj-&gt;dwFlags &amp; CMM_DONT_USE_PS2_FNS) ||
02099             !pCMMObj-&gt;fns.pCMGetPS2ColorRenderingDictionary)
02100         {
02101             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a3">TERSE</a>((__TEXT(<span class="stringliteral">"CMM associated with profile could not be used"</span>)));
02102 
02103             <span class="keywordflow">if</span> (pCMMObj)
02104             {
02105                 pCMMObj-&gt;dwFlags |= CMM_DONT_USE_PS2_FNS;
02106                 <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pCMMObj);
02107             }
02108 
02109             pCMMObj = <a class="code" href="../../d2/d1/object_8c.html#a14">GetColorMatchingModule</a>(CMM_WINDOWS_DEFAULT);
02110 
02111             <span class="keywordflow">if</span> (!pCMMObj || !pCMMObj-&gt;fns.pCMGetPS2ColorRenderingDictionary)
02112             {
02113                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Default CMM doesn't support CMGetPS2ColorRenderingDictionary\n"</span>)));
02114                 <span class="keywordflow">if</span> (pCMMObj)
02115                 {
02116                     <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pCMMObj);
02117                     pCMMObj = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02118                 }
02119             }
02120         }
02121     }
02122 
02123     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pProfObj-&gt;pView != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02124 
02125     <span class="keywordflow">if</span> (pCMMObj)
02126     {
02127         rc = pCMMObj-&gt;fns.pCMGetPS2ColorRenderingDictionary(hProfile, dwIntent,
02128             pBuffer, pcbSize, pbBinary);
02129     }
02130     <span class="keywordflow">else</span>
02131     {
02132         rc = <a class="code" href="../../d2/d9/ps2_8c.html#a256">InternalGetPS2ColorRenderingDictionary</a>(pProfObj-&gt;pView, dwIntent,
02133             pBuffer, pcbSize, pbBinary);
02134     }
02135 
02136     <span class="keywordflow">if</span> (pCMMObj)
02137     {
02138         <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pCMMObj);
02139     }
02140 
02141     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a2">VERBOSE</a>((__TEXT(<span class="stringliteral">"GetPS2ColorRenderingDictionary returning %s\n"</span>),
02142         rc ? <span class="stringliteral">"TRUE"</span> : <span class="stringliteral">"FALSE"</span>));
02143 
02144     <span class="keywordflow">return</span> rc;
02145 }
02146 
02147 
02148 <span class="comment">/******************************************************************************</span>
02149 <span class="comment"> *</span>
02150 <span class="comment"> *                         GetNamedProfileInfo</span>
02151 <span class="comment"> *</span>
02152 <span class="comment"> *  Function:</span>
02153 <span class="comment"> *       This functions returns information about the given named color space</span>
02154 <span class="comment"> *       profile. If fails if the given profile is not a named color space profile.</span>
02155 <span class="comment"> *</span>
02156 <span class="comment"> *  Arguments:</span>
02157 <span class="comment"> *       hProfile          - handle identifying the named color space profile object</span>
02158 <span class="comment"> *       pNamedProfileInfo - pointer to NAMED_PROFILE_INFO structure that is</span>
02159 <span class="comment"> *                           filled on retun if successful.</span>
02160 <span class="comment"> *</span>
02161 <span class="comment"> *  Returns:</span>
02162 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
02163 <span class="comment"> *</span>
02164 <span class="comment"> ******************************************************************************/</span>
02165 
<a name="l02166"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a30">02166</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a30">GetNamedProfileInfo</a>(
02167     HPROFILE              hProfile,
02168     PNAMED_PROFILE_INFO   pNamedProfileInfo
02169     )
02170 {
02171     PPROFOBJ pProfObj;
02172     PCMMOBJ  pCMMObj;
02173     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    cmmID;
02174     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     rc;
02175 
02176     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"GetNamedProfileInfo\n"</span>)));
02177 
02178     <span class="comment">//</span>
02179     <span class="comment">// Validate parameters</span>
02180     <span class="comment">//</span>
02181 
02182     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a5">ValidHandle</a>(hProfile, OBJ_PROFILE)     ||
02183         !pNamedProfileInfo                      ||
02184         IsBadWritePtr(pNamedProfileInfo, <span class="keyword">sizeof</span>(NAMED_PROFILE_INFO)))
02185     {
02186         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to GetNamedProfileInfo\n"</span>)));
02187         SetLastError(ERROR_INVALID_PARAMETER);
02188         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02189     }
02190 
02191     pProfObj = (PPROFOBJ)HDLTOPTR(hProfile);
02192 
02193     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pProfObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02194 
02195     <span class="comment">//</span>
02196     <span class="comment">// Check the integrity of the profile</span>
02197     <span class="comment">//</span>
02198 
02199     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a6">ValidProfile</a>(pProfObj))
02200     {
02201         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid profile passed to GetNamedProfileInfo\n"</span>)));
02202         SetLastError(ERROR_INVALID_PROFILE);
02203         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02204     }
02205 
02206     <span class="comment">//</span>
02207     <span class="comment">// Check if application specified CMM is present</span>
02208     <span class="comment">//</span>
02209 
02210     pCMMObj = <a class="code" href="../../d2/d1/object_8c.html#a15">GetPreferredCMM</a>();
02211     <span class="keywordflow">if</span> (!pCMMObj ||
02212         !pCMMObj-&gt;fns.pCMGetNamedProfileInfo)
02213     {
02214         <span class="keywordflow">if</span> (pCMMObj)
02215         {
02216             <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pCMMObj);
02217         }
02218 
02219         <span class="comment">//</span>
02220         <span class="comment">// Get CMM associated with profile. If it does not exist or does not</span>
02221         <span class="comment">// support the CMGetNamedProfileInfo function, get default CMM.</span>
02222         <span class="comment">//</span>
02223 
02224         cmmID = HEADER(pProfObj)-&gt;phCMMType;
02225         cmmID = FIX_ENDIAN(cmmID);
02226 
02227         pCMMObj  = <a class="code" href="../../d2/d1/object_8c.html#a14">GetColorMatchingModule</a>(cmmID);
02228 
02229         <span class="keywordflow">if</span> (!pCMMObj ||
02230             !pCMMObj-&gt;fns.pCMGetNamedProfileInfo)
02231         {
02232             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a3">TERSE</a>((__TEXT(<span class="stringliteral">"CMM associated with profile could not be used"</span>)));
02233 
02234             <span class="keywordflow">if</span> (pCMMObj)
02235             {
02236                 <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pCMMObj);
02237             }
02238 
02239             pCMMObj = <a class="code" href="../../d2/d1/object_8c.html#a14">GetColorMatchingModule</a>(CMM_WINDOWS_DEFAULT);
02240 
02241             <span class="keywordflow">if</span> (!pCMMObj || !pCMMObj-&gt;fns.pCMGetNamedProfileInfo)
02242             {
02243                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a9">RIP</a>((__TEXT(<span class="stringliteral">"Default CMM doesn't support CMValidateProfile"</span>)));
02244                 SetLastError(ERROR_INVALID_CMM);
02245                 <span class="keywordflow">if</span> (pCMMObj)
02246                 {
02247                     <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pCMMObj);
02248                 }
02249                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02250             }
02251         }
02252     }
02253 
02254     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pProfObj-&gt;pView != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02255 
02256     rc = pCMMObj-&gt;fns.pCMGetNamedProfileInfo(hProfile, pNamedProfileInfo);
02257 
02258     <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pCMMObj);
02259 
02260     <span class="keywordflow">return</span> rc;
02261 }
02262 
02263 
02264 <span class="comment">/******************************************************************************</span>
02265 <span class="comment"> *</span>
02266 <span class="comment"> *                       ConvertColorNameToIndex</span>
02267 <span class="comment"> *</span>
02268 <span class="comment"> *  Function:</span>
02269 <span class="comment"> *       This functions converts a given array of color names to color indices</span>
02270 <span class="comment"> *       using the specified named color space profile</span>
02271 <span class="comment"> *</span>
02272 <span class="comment"> *  Arguments:</span>
02273 <span class="comment"> *       hProfile     - handle identifing the named color space profile object</span>
02274 <span class="comment"> *       paColorName  - pointer to array of COLOR_NAME structures</span>
02275 <span class="comment"> *       paIndex      - pointer to array of DWORDs to receive the indices</span>
02276 <span class="comment"> *       dwCount      - number of color names to convert</span>
02277 <span class="comment"> *</span>
02278 <span class="comment"> *  Returns:</span>
02279 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
02280 <span class="comment"> *</span>
02281 <span class="comment"> ******************************************************************************/</span>
02282 
<a name="l02283"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a31">02283</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a31">ConvertColorNameToIndex</a>(
02284     HPROFILE      hProfile,
02285     PCOLOR_NAME   paColorName,
02286     PDWORD        paIndex,
02287     DWORD         dwCount
02288     )
02289 {
02290     PPROFOBJ pProfObj;
02291     PCMMOBJ  pCMMObj;
02292     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    cmmID;
02293     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     rc;
02294 
02295     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"ConvertColorNameToIndex\n"</span>)));
02296 
02297     <span class="comment">//</span>
02298     <span class="comment">// Validate parameters</span>
02299     <span class="comment">//</span>
02300 
02301     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a5">ValidHandle</a>(hProfile, OBJ_PROFILE)     ||
02302         !paColorName                            ||
02303         dwCount == 0                            ||
02304         IsBadReadPtr(paColorName, dwCount*<span class="keyword">sizeof</span>(COLOR_NAME)) ||
02305         !paIndex                                ||
02306         IsBadWritePtr(paIndex, dwCount*<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)))
02307     {
02308         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to ConvertColorNameToIndex\n"</span>)));
02309         SetLastError(ERROR_INVALID_PARAMETER);
02310         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02311     }
02312 
02313     pProfObj = (PPROFOBJ)HDLTOPTR(hProfile);
02314 
02315     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pProfObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02316 
02317     <span class="comment">//</span>
02318     <span class="comment">// Check the integrity of the profile</span>
02319     <span class="comment">//</span>
02320 
02321     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a6">ValidProfile</a>(pProfObj))
02322     {
02323         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid profile passed to ConvertColorNameToIndex\n"</span>)));
02324         SetLastError(ERROR_INVALID_PROFILE);
02325         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02326     }
02327 
02328     <span class="comment">//</span>
02329     <span class="comment">// Check if application specified CMM is present</span>
02330     <span class="comment">//</span>
02331 
02332     pCMMObj = <a class="code" href="../../d2/d1/object_8c.html#a15">GetPreferredCMM</a>();
02333     <span class="keywordflow">if</span> (!pCMMObj ||
02334         !pCMMObj-&gt;fns.pCMConvertColorNameToIndex)
02335     {
02336         <span class="keywordflow">if</span> (pCMMObj)
02337         {
02338             <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pCMMObj);
02339         }
02340 
02341         <span class="comment">//</span>
02342         <span class="comment">// Get CMM associated with profile. If it does not exist or does not</span>
02343         <span class="comment">// support the CMConvertColorNameToIndex function, get default CMM.</span>
02344         <span class="comment">//</span>
02345 
02346         cmmID = HEADER(pProfObj)-&gt;phCMMType;
02347         cmmID = FIX_ENDIAN(cmmID);
02348 
02349         pCMMObj  = <a class="code" href="../../d2/d1/object_8c.html#a14">GetColorMatchingModule</a>(cmmID);
02350 
02351         <span class="keywordflow">if</span> (!pCMMObj ||
02352             !pCMMObj-&gt;fns.pCMConvertColorNameToIndex)
02353         {
02354             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a3">TERSE</a>((__TEXT(<span class="stringliteral">"CMM associated with profile could not be used"</span>)));
02355 
02356             <span class="keywordflow">if</span> (pCMMObj)
02357             {
02358                 <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pCMMObj);
02359             }
02360 
02361             pCMMObj = <a class="code" href="../../d2/d1/object_8c.html#a14">GetColorMatchingModule</a>(CMM_WINDOWS_DEFAULT);
02362 
02363             <span class="keywordflow">if</span> (!pCMMObj || !pCMMObj-&gt;fns.pCMConvertColorNameToIndex)
02364             {
02365                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a9">RIP</a>((__TEXT(<span class="stringliteral">"Default CMM doesn't support CMConvertColorNameToIndex"</span>)));
02366                 SetLastError(ERROR_INVALID_CMM);
02367                 <span class="keywordflow">if</span> (pCMMObj)
02368                 {
02369                     <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pCMMObj);
02370                 }
02371                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02372             }
02373         }
02374     }
02375 
02376     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pProfObj-&gt;pView != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02377 
02378     rc = pCMMObj-&gt;fns.pCMConvertColorNameToIndex(
02379                             hProfile,
02380                             paColorName,
02381                             paIndex,
02382                             dwCount);
02383 
02384     <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pCMMObj);
02385 
02386     <span class="keywordflow">return</span> rc;
02387 }
02388 
02389 
02390 <span class="comment">/******************************************************************************</span>
02391 <span class="comment"> *</span>
02392 <span class="comment"> *                       ConvertIndexToColorName</span>
02393 <span class="comment"> *</span>
02394 <span class="comment"> *  Function:</span>
02395 <span class="comment"> *       This functions converts a given array of color indices to color names</span>
02396 <span class="comment"> *       using the specified named color space profile</span>
02397 <span class="comment"> *</span>
02398 <span class="comment"> *  Arguments:</span>
02399 <span class="comment"> *       hProfile     - handle identifing the named color space profile object</span>
02400 <span class="comment"> *       paIndex      - pointer to array of color indices</span>
02401 <span class="comment"> *       paColorName  - pointer to array of COLOR_NAME structures</span>
02402 <span class="comment"> *       dwCount      - number of color indices to convert</span>
02403 <span class="comment"> *</span>
02404 <span class="comment"> *  Returns:</span>
02405 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
02406 <span class="comment"> *</span>
02407 <span class="comment"> ******************************************************************************/</span>
02408 
<a name="l02409"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a32">02409</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a32">ConvertIndexToColorName</a>(
02410     HPROFILE     hProfile,
02411     PDWORD       paIndex,
02412     PCOLOR_NAME  paColorName,
02413     DWORD        dwCount
02414     )
02415 {
02416     PPROFOBJ pProfObj;
02417     PCMMOBJ  pCMMObj;
02418     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    cmmID;
02419     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     rc;
02420 
02421     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"ConvertIndexToColorName\n"</span>)));
02422 
02423     <span class="comment">//</span>
02424     <span class="comment">// Validate parameters</span>
02425     <span class="comment">//</span>
02426 
02427     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a5">ValidHandle</a>(hProfile, OBJ_PROFILE)     ||
02428         !paIndex                                ||
02429         dwCount == 0                            ||
02430         IsBadWritePtr(paIndex, dwCount*<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>))          ||
02431         !paColorName                            ||
02432         IsBadReadPtr(paColorName, dwCount*<span class="keyword">sizeof</span>(COLOR_NAME)))
02433     {
02434         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to ConvertIndexToColorName\n"</span>)));
02435         SetLastError(ERROR_INVALID_PARAMETER);
02436         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02437     }
02438 
02439     pProfObj = (PPROFOBJ)HDLTOPTR(hProfile);
02440 
02441     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pProfObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02442 
02443     <span class="comment">//</span>
02444     <span class="comment">// Check the integrity of the profile</span>
02445     <span class="comment">//</span>
02446 
02447     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a6">ValidProfile</a>(pProfObj))
02448     {
02449         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid profile passed to ConvertIndexToColorName\n"</span>)));
02450         SetLastError(ERROR_INVALID_PROFILE);
02451         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02452     }
02453 
02454     <span class="comment">//</span>
02455     <span class="comment">// Check if application specified CMM is present</span>
02456     <span class="comment">//</span>
02457 
02458     pCMMObj = <a class="code" href="../../d2/d1/object_8c.html#a15">GetPreferredCMM</a>();
02459     <span class="keywordflow">if</span> (!pCMMObj ||
02460         !pCMMObj-&gt;fns.pCMConvertIndexToColorName)
02461     {
02462         <span class="keywordflow">if</span> (pCMMObj)
02463         {
02464             <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pCMMObj);
02465         }
02466 
02467         <span class="comment">//</span>
02468         <span class="comment">// Get CMM associated with profile. If it does not exist or does not</span>
02469         <span class="comment">// support the CMConvertIndexToColorName function, get default CMM.</span>
02470         <span class="comment">//</span>
02471 
02472         cmmID = HEADER(pProfObj)-&gt;phCMMType;
02473         cmmID = FIX_ENDIAN(cmmID);
02474 
02475         pCMMObj  = <a class="code" href="../../d2/d1/object_8c.html#a14">GetColorMatchingModule</a>(cmmID);
02476 
02477         <span class="keywordflow">if</span> (!pCMMObj ||
02478             !pCMMObj-&gt;fns.pCMConvertIndexToColorName)
02479         {
02480             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a3">TERSE</a>((__TEXT(<span class="stringliteral">"CMM associated with profile could not be used"</span>)));
02481 
02482             <span class="keywordflow">if</span> (pCMMObj)
02483             {
02484                 <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pCMMObj);
02485             }
02486 
02487             pCMMObj = <a class="code" href="../../d2/d1/object_8c.html#a14">GetColorMatchingModule</a>(CMM_WINDOWS_DEFAULT);
02488 
02489             <span class="keywordflow">if</span> (!pCMMObj || !pCMMObj-&gt;fns.pCMConvertIndexToColorName)
02490             {
02491                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a9">RIP</a>((__TEXT(<span class="stringliteral">"Default CMM doesn't support CMConvertIndexToColorName"</span>)));
02492                 SetLastError(ERROR_INVALID_CMM);
02493                 <span class="keywordflow">if</span> (pCMMObj)
02494                 {
02495                     <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pCMMObj);
02496                 }
02497                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02498             }
02499         }
02500     }
02501 
02502     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pProfObj-&gt;pView != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02503 
02504     rc = pCMMObj-&gt;fns.pCMConvertIndexToColorName(
02505                             hProfile,
02506                             paIndex,
02507                             paColorName,
02508                             dwCount);
02509 
02510     <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pCMMObj);
02511 
02512     <span class="keywordflow">return</span> rc;
02513 }
02514 
02515 
02516 <span class="comment">/******************************************************************************</span>
02517 <span class="comment"> *</span>
02518 <span class="comment"> *                         CreateDeviceLinkProfile</span>
02519 <span class="comment"> *</span>
02520 <span class="comment"> *  Function:</span>
02521 <span class="comment"> *       This functions creates a device link profile from the given set</span>
02522 <span class="comment"> *       of profiles, using specified intents.</span>
02523 <span class="comment"> *</span>
02524 <span class="comment"> *  Arguments:</span>
02525 <span class="comment"> *       pahProfiles       - pointer to array of handles of profiles</span>
02526 <span class="comment"> *       nProfiles         - number of profiles in array</span>
02527 <span class="comment"> *       padwIntent        - array of intents to use</span>
02528 <span class="comment"> *       nIntents          - size of array - can be 1 or nProfiles</span>
02529 <span class="comment"> *       dwFlags           - optimization flags</span>
02530 <span class="comment"> *       pProfileData      - pointer to pointer to buffer to receive data which</span>
02531 <span class="comment"> *                           this function allocates; caller needs to free.</span>
02532 <span class="comment"> *       indexPreferredCMM - zero based index of profile which specifies</span>
02533 <span class="comment"> *                           preferred CMM to use.</span>
02534 <span class="comment"> *</span>
02535 <span class="comment"> *  Returns:</span>
02536 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
02537 <span class="comment"> *</span>
02538 <span class="comment"> ******************************************************************************/</span>
02539 
<a name="l02540"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a33">02540</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a33">CreateDeviceLinkProfile</a>(
02541     PHPROFILE   pahProfiles,
02542     DWORD       nProfiles,
02543     PDWORD      padwIntent,
02544     DWORD       nIntents,
02545     DWORD       dwFlags,
02546     PBYTE      *pProfileData,
02547     DWORD       indexPreferredCMM
02548     )
02549 {
02550     PPROFOBJ      pProfObj;
02551     PCMMOBJ       pCMMObj;
02552     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>         cmmID, i;
02553     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>          rc;
02554 
02555     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"CreateDeviceLinkProfile\n"</span>)));
02556 
02557     <span class="comment">//</span>
02558     <span class="comment">// Validate parameters</span>
02559     <span class="comment">//</span>
02560 
02561     <span class="keywordflow">if</span> (nProfiles &lt;= 1 ||
02562         indexPreferredCMM &gt;= nProfiles ||
02563         pahProfiles == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
02564         IsBadReadPtr(pahProfiles, <span class="keyword">sizeof</span>(HPROFILE) * nProfiles) ||
02565         padwIntent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
02566         ((nIntents != nProfiles) &amp;&amp; (nIntents != 1)) ||
02567         IsBadReadPtr(padwIntent, nIntents * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)))
02568     {
02569         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to CreateDeviceLinkProfile\n"</span>)));
02570         SetLastError(ERROR_INVALID_PARAMETER);
02571         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02572     }
02573 
02574     <span class="keywordflow">for</span> (i=0; i&lt;nProfiles; i++)
02575     {
02576         <span class="keywordflow">if</span> ((pahProfiles[i] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
02577             ! <a class="code" href="../../d2/d1/object_8c.html#a5">ValidHandle</a>(pahProfiles[i], OBJ_PROFILE))
02578 
02579         {
02580             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid profile passed to CreateDeviceLinkProfile\n"</span>)));
02581             SetLastError(ERROR_INVALID_PARAMETER);
02582             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02583         }
02584 
02585         pProfObj = (PPROFOBJ)HDLTOPTR(pahProfiles[i]);
02586 
02587         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pProfObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02588 
02589         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pProfObj-&gt;pView != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02590 
02591         <span class="comment">//</span>
02592         <span class="comment">// Quick check on the integrity of the profile</span>
02593         <span class="comment">//</span>
02594 
02595         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a6">ValidProfile</a>(pProfObj))
02596         {
02597             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid profile passed to CreateDeviceLinkProfile\n"</span>)));
02598             SetLastError(ERROR_INVALID_PROFILE);
02599             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02600         }
02601 
02602         <span class="keywordflow">if</span> (i == indexPreferredCMM)
02603         {
02604             <span class="comment">//</span>
02605             <span class="comment">// Get ID of preferred CMM</span>
02606             <span class="comment">//</span>
02607 
02608             cmmID = HEADER(pProfObj)-&gt;phCMMType;
02609             cmmID = FIX_ENDIAN(cmmID);
02610         }
02611     }
02612 
02613     <span class="comment">//</span>
02614     <span class="comment">// Get CMM associated with preferred profile. If it does not exist,</span>
02615     <span class="comment">// get default CMM.</span>
02616     <span class="comment">//</span>
02617 
02618     pCMMObj  = <a class="code" href="../../d2/d1/object_8c.html#a14">GetColorMatchingModule</a>(cmmID);
02619     <span class="keywordflow">if</span> (!pCMMObj || !pCMMObj-&gt;fns.pCMCreateDeviceLinkProfile)
02620     {
02621         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a3">TERSE</a>((__TEXT(<span class="stringliteral">"CMM associated with profile could not be used"</span>)));
02622 
02623         <span class="keywordflow">if</span> (pCMMObj)
02624         {
02625             <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pCMMObj);
02626         }
02627 
02628         pCMMObj = <a class="code" href="../../d2/d1/object_8c.html#a14">GetColorMatchingModule</a>(CMM_WINDOWS_DEFAULT);
02629         <span class="keywordflow">if</span> (!pCMMObj)
02630         {
02631             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a9">RIP</a>((__TEXT(<span class="stringliteral">"Default CMM not found\n"</span>)));
02632             SetLastError(ERROR_INVALID_CMM);
02633             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02634         }
02635     }
02636 
02637     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pCMMObj-&gt;fns.pCMCreateDeviceLinkProfile != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02638 
02639     rc = pCMMObj-&gt;fns.pCMCreateDeviceLinkProfile(
02640                             pahProfiles,
02641                             nProfiles,
02642                             padwIntent,
02643                             nIntents,
02644                             <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>,
02645                             pProfileData);
02646 
02647     <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pCMMObj);
02648 
02649     <span class="keywordflow">return</span> rc;
02650 }
02651 
02652 
02653 <span class="comment">/*****************************************************************************/</span>
02654 <span class="comment">/***************************** Internal Functions ****************************/</span>
02655 <span class="comment">/*****************************************************************************/</span>
02656 
02657 <span class="comment">/******************************************************************************</span>
02658 <span class="comment"> *</span>
02659 <span class="comment"> *                          InternalOpenColorProfile</span>
02660 <span class="comment"> *</span>
02661 <span class="comment"> *  Function:</span>
02662 <span class="comment"> *       This functions opens a color profile specified by the pProfile</span>
02663 <span class="comment"> *       parameter, creates an internal profile object, and returns a handle</span>
02664 <span class="comment"> *       to it.</span>
02665 <span class="comment"> *</span>
02666 <span class="comment"> *  Arguments:</span>
02667 <span class="comment"> *       pProfile - ptr to a profile structure that specifies the profile</span>
02668 <span class="comment"> *                  to open</span>
02669 <span class="comment"> *       dwDesiredAccess - specifies the mode in which to open the profile.</span>
02670 <span class="comment"> *                         Any combination of these values can be used:</span>
02671 <span class="comment"> *            PROFILE_READ: Allows the app to read the profile.</span>
02672 <span class="comment"> *            PROFILE_READWRITE: Allows the app to read and write to the profile.</span>
02673 <span class="comment"> *       dwShareMode - specifies the mode to share the profile with other</span>
02674 <span class="comment"> *                     processes if it is a file. Any combination of these</span>
02675 <span class="comment"> *                     values can be used.</span>
02676 <span class="comment"> *            0               : Prevents the file from being shared.</span>
02677 <span class="comment"> *            FILE_SHARE_READ: Allows opening for read only by other processes.</span>
02678 <span class="comment"> *            FILE_SHARE_WRITE: Allows opening for write by other processes.</span>
02679 <span class="comment"> *       dwCreationMode - specifies which actions to take on the profile while</span>
02680 <span class="comment"> *                        opening it (if it is a file). Any one of the following</span>
02681 <span class="comment"> *                        values can be used.</span>
02682 <span class="comment"> *            CREATE_NEW: Creates a new file. Fails if one exists already.</span>
02683 <span class="comment"> *            CREATE_ALWAYS: Always create a new file. Overwriting existing.</span>
02684 <span class="comment"> *            OPEN_EXISTING: Open exisiting file. Fail if not found.</span>
02685 <span class="comment"> *            OPEN_ALWAYS: Open existing. If not found, create a new one.</span>
02686 <span class="comment"> *            TRUNCATE_EXISTING: Open existing and truncate to zero bytes. Fail</span>
02687 <span class="comment"> *                               if not found.</span>
02688 <span class="comment"> *</span>
02689 <span class="comment"> *  Returns:</span>
02690 <span class="comment"> *       Handle to open profile on success, zero on failure.</span>
02691 <span class="comment"> *</span>
02692 <span class="comment"> ******************************************************************************/</span>
02693 
<a name="l02694"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a1">02694</a> HPROFILE <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a1">InternalOpenColorProfile</a>(
02695     PPROFILE pProfile,
02696     DWORD    dwDesiredAccess,
02697     DWORD    dwShareMode,
02698     DWORD    dwCreationMode
02699     )
02700 {
02701     SECURITY_ATTRIBUTES sa;
02702     PPROFOBJ  pProfObj;
02703     HPROFILE  hProfile;
02704     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>     dwMapSize;
02705     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>      bNewFile = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02706     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>      bError = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;      <span class="comment">// Assume failure</span>
02707 
02708     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"OpenColorProfile\n"</span>)));
02709 
02710     <span class="comment">//</span>
02711     <span class="comment">// Validate parameters</span>
02712     <span class="comment">//</span>
02713 
02714     <span class="keywordflow">if</span> (!pProfile ||
02715         IsBadReadPtr(pProfile, <span class="keyword">sizeof</span>(PROFILE)) ||
02716         (pProfile-&gt;pProfileData &amp;&amp;
02717          IsBadReadPtr(pProfile-&gt;pProfileData, pProfile-&gt;cbDataSize)) ||
02718         (!pProfile-&gt;pProfileData &amp;&amp;
02719          (pProfile-&gt;cbDataSize != 0)) ||
02720         (pProfile-&gt;dwType != PROFILE_FILENAME &amp;&amp;
02721          pProfile-&gt;dwType != PROFILE_MEMBUFFER
02722         ) ||
02723         (dwDesiredAccess != PROFILE_READ &amp;&amp;
02724          dwDesiredAccess != PROFILE_READWRITE
02725         )
02726        )
02727     {
02728         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to OpenColorProfile\n"</span>)));
02729         SetLastError(ERROR_INVALID_PARAMETER);
02730         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02731     }
02732 
02733     <span class="comment">//</span>
02734     <span class="comment">// Allocate an object on the heap for the profile</span>
02735     <span class="comment">//</span>
02736 
02737     hProfile = <a class="code" href="../../d2/d1/object_8c.html#a3">AllocateHeapObject</a>(OBJ_PROFILE);
02738     <span class="keywordflow">if</span> (!hProfile)
02739     {
02740         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Could not allocate profile object\n"</span>)));
02741         SetLastError(ERROR_NOT_ENOUGH_MEMORY);
02742         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02743     }
02744 
02745     pProfObj = (PPROFOBJ)HDLTOPTR(hProfile);
02746 
02747     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pProfObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02748 
02749     <span class="comment">//</span>
02750     <span class="comment">// Copy profile information to our object</span>
02751     <span class="comment">//</span>
02752 
02753     pProfObj-&gt;objHdr.dwUseCount = 1;
02754     pProfObj-&gt;dwType       = pProfile-&gt;dwType;
02755     pProfObj-&gt;cbDataSize   = pProfile-&gt;cbDataSize;
02756     pProfObj-&gt;pProfileData = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)<a class="code" href="../../d2/d1/object_8c.html#a7">MemAlloc</a>(pProfile-&gt;cbDataSize + <span class="keyword">sizeof</span>(TCHAR));
02757     <span class="keywordflow">if</span> (!pProfObj-&gt;pProfileData)
02758     {
02759         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Could not allocate memory for profile data\n"</span>)));
02760         SetLastError(ERROR_NOT_ENOUGH_MEMORY);
02761         <span class="keywordflow">goto</span> EndOpenColorProfile;
02762     }
02763 
02764     CopyMemory((PVOID)pProfObj-&gt;pProfileData,
02765         (PVOID)pProfile-&gt;pProfileData,
02766         pProfile-&gt;cbDataSize);
02767 
02768     <span class="keywordflow">if</span> (pProfObj-&gt;dwType == PROFILE_FILENAME)
02769     {
02770         LPTSTR lpFilename;
02771 
02772         <span class="keywordflow">if</span> (!pProfile-&gt;pProfileData ||
02773              pProfile-&gt;cbDataSize == 0 ||
02774              lstrlen((LPCTSTR)pProfile-&gt;pProfileData) &gt; <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a> ||
02775              pProfile-&gt;cbDataSize &gt; (<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a> * <span class="keyword">sizeof</span>(TCHAR)))
02776         {
02777             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to OpenColorProfile\n"</span>)));
02778             SetLastError(ERROR_INVALID_PARAMETER);
02779             <span class="keywordflow">goto</span> EndOpenColorProfile;
02780         }
02781 
02782         <span class="comment">//</span>
02783         <span class="comment">// If only filename is given, it is wrt color directory</span>
02784         <span class="comment">//</span>
02785 
02786         lpFilename = <a class="code" href="../../d9/d7/profman_8c.html#a96">GetFilenameFromPath</a>((LPTSTR)pProfObj-&gt;pProfileData);
02787         <span class="keywordflow">if</span> (lpFilename == pProfObj-&gt;pProfileData)
02788         {
02789             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwLen = <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>;
02790             lpFilename = <a class="code" href="../../d2/d1/object_8c.html#a7">MemAlloc</a>(dwLen);
02791             <span class="keywordflow">if</span> (!lpFilename)
02792             {
02793                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Could not allocate memory for file name\n"</span>)));
02794                 SetLastError(ERROR_NOT_ENOUGH_MEMORY);
02795                 <span class="keywordflow">goto</span> EndOpenColorProfile;
02796             }
02797             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)GetColorDirectory(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, lpFilename, &amp;dwLen);
02798             lstrcat(lpFilename, <a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a21">gszBackslash</a>);
02799             lstrcat(lpFilename, (LPTSTR)pProfObj-&gt;pProfileData);
02800             <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pProfObj-&gt;pProfileData);
02801             pProfObj-&gt;pProfileData = (PVOID)lpFilename;
02802             pProfObj-&gt;cbDataSize = <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>;
02803         }
02804 
02805         <span class="comment">//</span>
02806         <span class="comment">// File name already null terminates as we used GHND flag which</span>
02807         <span class="comment">// zero initializes the allocated memory</span>
02808         <span class="comment">//</span>
02809         <span class="comment">// Create file mapping</span>
02810         <span class="comment">//</span>
02811 
02812         pProfObj-&gt;dwFlags |= MEMORY_MAPPED;
02813 
02814         <span class="keywordflow">if</span> (dwCreationMode == OPEN_ALWAYS)
02815         {
02816             <span class="comment">//</span>
02817             <span class="comment">// If we find a zero length profile, we should error out</span>
02818             <span class="comment">// saying it is a bad profile. If we create a zero length</span>
02819             <span class="comment">// profile, it is fine. To distinguish these two cases, we</span>
02820             <span class="comment">// check for file's existence and if present, change the</span>
02821             <span class="comment">// creation mode to OPEN_EXISTING</span>
02822             <span class="comment">//</span>
02823 
02824             <span class="keywordflow">if</span> (GetFileAttributes(pProfObj-&gt;pProfileData) != (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1)
02825             {
02826                 dwCreationMode = <a class="code" href="../../d4/d8/ntfsexp_8h.html#a141a69">OPEN_EXISTING</a>;
02827             }
02828         }
02829 
02830         <span class="comment">//</span>
02831         <span class="comment">// Set security attribute structure</span>
02832         <span class="comment">//</span>
02833 
02834         sa.nLength = <span class="keyword">sizeof</span>(SECURITY_ATTRIBUTES);
02835         sa.lpSecurityDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;         <span class="comment">// default security</span>
02836         sa.bInheritHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02837 
02838         pProfObj-&gt;hFile = CreateFile(pProfObj-&gt;pProfileData,
02839             (dwDesiredAccess == PROFILE_READWRITE) ? GENERIC_READ | GENERIC_WRITE : GENERIC_READ,
02840             dwShareMode, &amp;sa, dwCreationMode, FILE_FLAG_RANDOM_ACCESS, 0);
02841 
02842         <span class="keywordflow">if</span> (pProfObj-&gt;hFile == <a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>)
02843         {
02844             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Err %ld, could not open profile %s\n"</span>),
02845                 GetLastError(), pProfObj-&gt;pProfileData));
02846             <span class="keywordflow">goto</span> EndOpenColorProfile;
02847         }
02848 
02849         <span class="comment">//</span>
02850         <span class="comment">// Get size of file mapping. Add a cushion so that profile can</span>
02851         <span class="comment">// be grown. When closing the profile, the file size is truncated</span>
02852         <span class="comment">// to the size of the actual data. If the profile size grows beyond</span>
02853         <span class="comment">// the cushion, it is continually grown in chunks.</span>
02854         <span class="comment">//</span>
02855 
02856         dwMapSize = GetFileSize(pProfObj-&gt;hFile, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02857         <span class="keywordflow">if</span> (dwMapSize == 0)
02858         {
02859             <span class="keywordflow">if</span> (dwCreationMode == <a class="code" href="../../d4/d8/ntfsexp_8h.html#a141a69">OPEN_EXISTING</a>)
02860             {
02861                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid profile  - zero length\n"</span>)));
02862                 SetLastError(ERROR_INVALID_PROFILE);
02863                 <span class="keywordflow">goto</span> EndOpenColorProfile;
02864 
02865             }
02866             <span class="keywordflow">else</span>
02867             {
02868                 dwMapSize = <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a0">PROFILE_GROWTHCUSHION</a>;
02869                 bNewFile = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02870             }
02871         }
02872 
02873         pProfObj-&gt;hMap = CreateFileMapping(pProfObj-&gt;hFile, 0,
02874             (dwDesiredAccess == PROFILE_READWRITE) ? PAGE_READWRITE : PAGE_READONLY,
02875             0, dwMapSize, 0);
02876 
02877         <span class="keywordflow">if</span> (!pProfObj-&gt;hMap)
02878         {
02879             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Err %ld, could not create map of profile %s\n"</span>),
02880                 GetLastError(), pProfObj-&gt;pProfileData));
02881             <span class="keywordflow">goto</span> EndOpenColorProfile;
02882         }
02883 
02884         pProfObj-&gt;dwMapSize = dwMapSize;
02885 
02886         pProfObj-&gt;pView = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)MapViewOfFile(pProfObj-&gt;hMap,
02887             (dwDesiredAccess == PROFILE_READWRITE) ? FILE_MAP_ALL_ACCESS : FILE_MAP_READ,
02888             0, 0, 0);
02889 
02890         <span class="keywordflow">if</span> (!pProfObj-&gt;pView)
02891         {
02892             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Err %ld, could not create view of profile %s\n"</span>),
02893                 GetLastError(), pProfObj-&gt;pProfileData));
02894             <span class="keywordflow">goto</span> EndOpenColorProfile;
02895         }
02896 
02897         <span class="comment">//</span>
02898         <span class="comment">// If a new profile has been created, initialize size</span>
02899         <span class="comment">// and tag table count</span>
02900         <span class="comment">//</span>
02901         <span class="keywordflow">if</span> (bNewFile &amp;&amp; dwDesiredAccess == PROFILE_READWRITE)
02902         {
02903             HEADER(pProfObj)-&gt;phSize = FIX_ENDIAN(<span class="keyword">sizeof</span>(PROFILEHEADER) +
02904                                                   <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
02905             HEADER(pProfObj)-&gt;phVersion = 0x02000000;
02906             HEADER(pProfObj)-&gt;phSignature = PROFILE_SIGNATURE;
02907             TAG_COUNT(pProfObj) = 0;
02908         }
02909     }
02910     <span class="keywordflow">else</span>
02911     {
02912         <span class="keywordflow">if</span> (pProfile-&gt;cbDataSize == 0)
02913         {
02914             <span class="comment">//</span>
02915             <span class="comment">// Allocate a small buffer and create a new profile in it</span>
02916             <span class="comment">//</span>
02917 
02918             pProfObj-&gt;cbDataSize = <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a0">PROFILE_GROWTHCUSHION</a>;
02919             <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pProfObj-&gt;pProfileData);
02920             pProfObj-&gt;pView = pProfObj-&gt;pProfileData = <a class="code" href="../../d2/d1/object_8c.html#a7">MemAlloc</a>(pProfObj-&gt;cbDataSize);
02921             <span class="keywordflow">if</span> (!pProfObj-&gt;pView)
02922             {
02923                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Could not allocate memory for profile data\n"</span>)));
02924                 SetLastError(ERROR_NOT_ENOUGH_MEMORY);
02925                 <span class="keywordflow">goto</span> EndOpenColorProfile;
02926             }
02927 
02928             HEADER(pProfObj)-&gt;phSize = FIX_ENDIAN(<span class="keyword">sizeof</span>(PROFILEHEADER) +
02929                                                   <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
02930             HEADER(pProfObj)-&gt;phVersion = 0x02000000;
02931             HEADER(pProfObj)-&gt;phSignature = PROFILE_SIGNATURE;
02932             TAG_COUNT(pProfObj) = 0;
02933             pProfObj-&gt;dwMapSize = pProfObj-&gt;cbDataSize;
02934         }
02935         <span class="keywordflow">else</span>
02936         {
02937             <span class="comment">//</span>
02938             <span class="comment">// Treat buffer as view of file</span>
02939             <span class="comment">//</span>
02940 
02941             pProfObj-&gt;pView = pProfObj-&gt;pProfileData;
02942             pProfObj-&gt;dwMapSize = pProfObj-&gt;cbDataSize;
02943 
02944             <span class="comment">//</span>
02945             <span class="comment">// Do a sanity check on the profile</span>
02946             <span class="comment">//</span>
02947 
02948             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a6">ValidProfile</a>(pProfObj))
02949             {
02950                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid profile passed to OpenColorProfile\n"</span>)));
02951                 SetLastError(ERROR_INVALID_PROFILE);
02952                 <span class="keywordflow">goto</span> EndOpenColorProfile;
02953             }
02954         }
02955     }
02956 
02957     <span class="keywordflow">if</span> (dwDesiredAccess == PROFILE_READWRITE)
02958         pProfObj-&gt;dwFlags |= READWRITE_ACCESS;
02959 
02960     bError = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;          <span class="comment">// Success!</span>
02961 
02962 EndOpenColorProfile:
02963 
02964     <span class="keywordflow">if</span> (bError)
02965     {
02966         <span class="keywordflow">if</span> (hProfile)
02967             <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a34">FreeProfileObject</a>(hProfile);
02968         hProfile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02969     }
02970 
02971     <span class="keywordflow">return</span> hProfile;
02972 }
02973 
02974 
02975 <span class="comment">/******************************************************************************</span>
02976 <span class="comment"> *</span>
02977 <span class="comment"> *                         InternalCreateProfileFromLCS</span>
02978 <span class="comment"> *</span>
02979 <span class="comment"> *  Function:</span>
02980 <span class="comment"> *       This functions takes a logical color space and creates an ICC profile</span>
02981 <span class="comment"> *</span>
02982 <span class="comment"> *  Arguments:</span>
02983 <span class="comment"> *       pLogColorSpace - Pointer to LogColorSpace structure</span>
02984 <span class="comment"> *       pBuffer - Pointer to pointer to buffer. This function allocates and</span>
02985 <span class="comment"> *                 fills this buffer with the profile on success.</span>
02986 <span class="comment"> *</span>
02987 <span class="comment"> *  Returns:</span>
02988 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
02989 <span class="comment"> *</span>
02990 <span class="comment"> ******************************************************************************/</span>
02991 
<a name="l02992"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a2">02992</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a2">InternalCreateProfileFromLCS</a>(
02993     LPLOGCOLORSPACE pLogColorSpace,
02994     PBYTE          *pBuffer,
02995     BOOL           bValidateParams
02996     )
02997 {
02998     PCMMOBJ  pCMMObj = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02999     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     rc;
03000 
03001     <span class="comment">//</span>
03002     <span class="comment">// Validate parameters</span>
03003     <span class="comment">//</span>
03004 
03005     <span class="keywordflow">if</span> (bValidateParams &amp;&amp;
03006         (! pLogColorSpace ||
03007          IsBadReadPtr(pLogColorSpace, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d0/structtagLOGCOLORSPACE.html">LOGCOLORSPACE</a>)) ||
03008          pLogColorSpace-&gt;lcsFilename[0] != <span class="charliteral">'\0'</span>))
03009     {
03010         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to CreateProfileFromLogColorSpace\n"</span>)));
03011         SetLastError(ERROR_INVALID_PARAMETER);
03012         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03013     }
03014 
03015     <span class="comment">//</span>
03016     <span class="comment">// We use the default CMM for this</span>
03017     <span class="comment">//</span>
03018 
03019     pCMMObj = <a class="code" href="../../d2/d1/object_8c.html#a14">GetColorMatchingModule</a>(CMM_WINDOWS_DEFAULT);
03020     <span class="keywordflow">if</span> (!pCMMObj)
03021     {
03022         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a9">RIP</a>((__TEXT(<span class="stringliteral">"Default CMM not found\n"</span>)));
03023         SetLastError(ERROR_INVALID_CMM);
03024         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03025     }
03026 
03027 
03028     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pCMMObj-&gt;fns.pCMCreateProfile != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03029 
03030     rc = pCMMObj-&gt;fns.pCMCreateProfile(pLogColorSpace, pBuffer);
03031 
03032     <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pCMMObj);
03033 
03034     <span class="keywordflow">return</span> rc;
03035 }
03036 
03037 
03038 <span class="comment">/******************************************************************************</span>
03039 <span class="comment"> *</span>
03040 <span class="comment"> *                       FreeProfileObject</span>
03041 <span class="comment"> *</span>
03042 <span class="comment"> *  Function:</span>
03043 <span class="comment"> *       This functions frees a profile object and associated memory</span>
03044 <span class="comment"> *</span>
03045 <span class="comment"> *  Arguments:</span>
03046 <span class="comment"> *       hProfile  - handle identifing the profile object to free</span>
03047 <span class="comment"> *</span>
03048 <span class="comment"> *  Returns:</span>
03049 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
03050 <span class="comment"> *</span>
03051 <span class="comment"> ******************************************************************************/</span>
03052 
<a name="l03053"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a34">03053</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a34">FreeProfileObject</a>(
03054     HANDLE   hProfile
03055     )
03056 {
03057     PPROFOBJ pProfObj;
03058     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a8">dwFileSize</a>;
03059     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    dwErr;
03060 
03061     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(hProfile != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03062 
03063     pProfObj = (PPROFOBJ)HDLTOPTR(hProfile);
03064 
03065     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pProfObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03066 
03067     dwErr = GetLastError();     <span class="comment">// remember any errors we may have set</span>
03068 
03069     <span class="comment">//</span>
03070     <span class="comment">// Free memory associated with profile data</span>
03071     <span class="comment">//</span>
03072 
03073     <span class="keywordflow">if</span> (pProfObj-&gt;pProfileData)
03074         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>((PVOID)pProfObj-&gt;pProfileData);
03075 
03076     <span class="comment">//</span>
03077     <span class="comment">// If it a memory mapped profile, unmap it</span>
03078     <span class="comment">//</span>
03079 
03080     <span class="keywordflow">if</span> (pProfObj-&gt;dwFlags &amp; MEMORY_MAPPED)
03081     {
03082         <span class="keywordflow">if</span> (pProfObj-&gt;pView)
03083         {
03084             <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a8">dwFileSize</a> = FIX_ENDIAN(HEADER(pProfObj)-&gt;phSize);
03085             UnmapViewOfFile(pProfObj-&gt;pView);
03086         }
03087         <span class="keywordflow">if</span> (pProfObj-&gt;hMap)
03088             CloseHandle(pProfObj-&gt;hMap);
03089 
03090         <span class="keywordflow">if</span> (pProfObj-&gt;hFile)
03091         {
03092 
03093             <span class="comment">//</span>
03094             <span class="comment">// Set the size of the file correctly</span>
03095             <span class="comment">//</span>
03096 
03097             SetFilePointer(pProfObj-&gt;hFile, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a8">dwFileSize</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, FILE_BEGIN);
03098             SetEndOfFile(pProfObj-&gt;hFile);
03099             CloseHandle(pProfObj-&gt;hFile);
03100         }
03101     }
03102 
03103     <span class="comment">//</span>
03104     <span class="comment">// Free heap object</span>
03105     <span class="comment">//</span>
03106 
03107     pProfObj-&gt;objHdr.dwUseCount--;      <span class="comment">// decrement before freeing</span>
03108     <a class="code" href="../../d2/d1/object_8c.html#a4">FreeHeapObject</a>(hProfile);
03109 
03110     <span class="keywordflow">if</span> (dwErr)
03111     {
03112         SetLastError(dwErr);            <span class="comment">// reset our error</span>
03113     }
03114 
03115     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03116 }
03117 
03118 
03119 <span class="comment">/******************************************************************************</span>
03120 <span class="comment"> *</span>
03121 <span class="comment"> *                       GrowProfile</span>
03122 <span class="comment"> *</span>
03123 <span class="comment"> *  Function:</span>
03124 <span class="comment"> *       This functions grows a profile to the new size</span>
03125 <span class="comment"> *</span>
03126 <span class="comment"> *  Arguments:</span>
03127 <span class="comment"> *       pProfObj  - pointer to profile object</span>
03128 <span class="comment"> *       dwNewSize - new size for the profile</span>
03129 <span class="comment"> *</span>
03130 <span class="comment"> *  Returns:</span>
03131 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
03132 <span class="comment"> *</span>
03133 <span class="comment"> ******************************************************************************/</span>
03134 
<a name="l03135"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a8">03135</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a8">GrowProfile</a>(
03136     PPROFOBJ pProfObj,
03137     DWORD dwNewSize
03138     )
03139 {
03140     <span class="keywordflow">if</span> (pProfObj-&gt;dwMapSize &gt;= dwNewSize)
03141         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03142 
03143     <span class="comment">//</span>
03144     <span class="comment">// Add cushion for future growth</span>
03145     <span class="comment">//</span>
03146 
03147     dwNewSize += <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a0">PROFILE_GROWTHCUSHION</a>;
03148 
03149     <span class="keywordflow">if</span> (pProfObj-&gt;dwFlags &amp; MEMORY_MAPPED)
03150     {
03151         <span class="comment">//</span>
03152         <span class="comment">// Profile is a memory mapped file</span>
03153         <span class="comment">//</span>
03154 
03155         <span class="comment">//</span>
03156         <span class="comment">// Close previous view and map</span>
03157         <span class="comment">//</span>
03158 
03159         UnmapViewOfFile(pProfObj-&gt;pView);
03160         CloseHandle(pProfObj-&gt;hMap);
03161 
03162         pProfObj-&gt;hMap = CreateFileMapping(pProfObj-&gt;hFile, 0,
03163             PAGE_READWRITE, 0, dwNewSize, 0);
03164 
03165         <span class="keywordflow">if</span> (!pProfObj-&gt;hMap)
03166         {
03167             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Err %ld, could not recreate map of profile %s\n"</span>),
03168                 GetLastError(), pProfObj-&gt;pProfileData));
03169             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03170         }
03171 
03172         pProfObj-&gt;pView = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>) MapViewOfFile(pProfObj-&gt;hMap, FILE_MAP_ALL_ACCESS, 0, 0, 0);
03173         <span class="keywordflow">if</span> (!pProfObj-&gt;pView)
03174         {
03175             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Err %ld, could not recreate view of profile %s\n"</span>),
03176                 GetLastError(), pProfObj-&gt;pProfileData));
03177             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03178         }
03179 
03180 
03181         <span class="comment">//</span>
03182         <span class="comment">// Set new size</span>
03183         <span class="comment">//</span>
03184 
03185         pProfObj-&gt;dwMapSize = dwNewSize;
03186     }
03187     <span class="keywordflow">else</span>
03188     {
03189         <span class="comment">//</span>
03190         <span class="comment">// Profile is an in-memory buffer</span>
03191         <span class="comment">//</span>
03192 
03193         PVOID pTemp = <a class="code" href="../../d2/d1/object_8c.html#a8">MemReAlloc</a>(pProfObj-&gt;pView, dwNewSize);
03194 
03195         <span class="keywordflow">if</span> (!pTemp)
03196         {
03197             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error reallocating memory\n"</span>)));
03198             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03199         }
03200 
03201         pProfObj-&gt;pView = pProfObj-&gt;pProfileData = pTemp;
03202         pProfObj-&gt;cbDataSize = pProfObj-&gt;dwMapSize = dwNewSize;
03203     }
03204 
03205     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03206 }
03207 
03208 
03209 <span class="comment">/******************************************************************************</span>
03210 <span class="comment"> *</span>
03211 <span class="comment"> *                       AddTagTableEntry</span>
03212 <span class="comment"> *</span>
03213 <span class="comment"> *  Function:</span>
03214 <span class="comment"> *       This functions adds a tag to the tag table</span>
03215 <span class="comment"> *</span>
03216 <span class="comment"> *  Arguments:</span>
03217 <span class="comment"> *       pProfObj  - pointer to profile object</span>
03218 <span class="comment"> *       tagType   - tag to add</span>
03219 <span class="comment"> *       dwOffset  - offset of tag data from start of file</span>
03220 <span class="comment"> *       cbSize    - size of tag data</span>
03221 <span class="comment"> *       bNewData  - TRUE if new tag is not a reference to existing data</span>
03222 <span class="comment"> *</span>
03223 <span class="comment"> *  Returns:</span>
03224 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
03225 <span class="comment"> *</span>
03226 <span class="comment"> ******************************************************************************/</span>
03227 
<a name="l03228"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a4">03228</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a4">AddTagTableEntry</a>(
03229     PPROFOBJ pProfObj,
03230     TAGTYPE  tagType,
03231     DWORD    dwOffset,
03232     DWORD    cbSize,
03233     BOOL     bNewData
03234     )
03235 {
03236     PTAGDATA pTagData;
03237     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>    src, dest;
03238     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    nCount;
03239     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    cnt, i;
03240 
03241     <span class="comment">//</span>
03242     <span class="comment">// Get count of tag items - it is right after the profile header</span>
03243     <span class="comment">//</span>
03244 
03245     nCount = TAG_COUNT(pProfObj);
03246     nCount = FIX_ENDIAN(nCount);
03247 
03248     <span class="comment">//</span>
03249     <span class="comment">// Increase count of tag elements by 1, and add new tag to end of</span>
03250     <span class="comment">// tag table. Move all data below tag table downwards by the size</span>
03251     <span class="comment">// of one tag table entry.</span>
03252     <span class="comment">//</span>
03253 
03254     nCount++;
03255 
03256     dest = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)TAG_DATA(pProfObj) + nCount * <span class="keyword">sizeof</span>(TAGDATA);
03257     src  = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)TAG_DATA(pProfObj) + (nCount - 1) * <span class="keyword">sizeof</span>(TAGDATA);
03258 
03259     <span class="comment">//</span>
03260     <span class="comment">// # bytes to move = file size - header - tag count - tag table</span>
03261     <span class="comment">//</span>
03262 
03263     cnt  = FIX_ENDIAN(HEADER(pProfObj)-&gt;phSize) - <span class="keyword">sizeof</span>(PROFILEHEADER) -
03264                  <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) - (nCount - 1) * <span class="keyword">sizeof</span>(TAGDATA);
03265 
03266     <span class="keywordflow">if</span> (cnt &gt; 0)
03267     {
03268         <span class="comment">//</span>
03269         <span class="comment">// NOTE: CopyMemory() doesn't work for overlapped memory.</span>
03270         <span class="comment">// Use internal function instead.</span>
03271         <span class="comment">//</span>
03272 
03273         <a class="code" href="../../d2/d1/object_8c.html#a10">MyCopyMemory</a>((PVOID)dest, (PVOID)src, cnt);
03274     }
03275 
03276     TAG_COUNT(pProfObj) = FIX_ENDIAN(nCount);
03277 
03278     pTagData = (PTAGDATA)src;
03279     pTagData-&gt;tagType  = FIX_ENDIAN(tagType);
03280     pTagData-&gt;cbSize   = FIX_ENDIAN(cbSize);
03281     pTagData-&gt;dwOffset =  FIX_ENDIAN(dwOffset);
03282 
03283     <span class="comment">//</span>
03284     <span class="comment">// Go through the tag table and update the offsets of all elements</span>
03285     <span class="comment">// by the size of one tag table entry that we inserted.</span>
03286     <span class="comment">//</span>
03287 
03288     pTagData = TAG_DATA(pProfObj);
03289     <span class="keywordflow">for</span> (i=0; i&lt;nCount; i++)
03290     {
03291         cnt = FIX_ENDIAN(pTagData-&gt;dwOffset);
03292         cnt += <span class="keyword">sizeof</span>(TAGDATA);
03293         pTagData-&gt;dwOffset = FIX_ENDIAN(cnt);
03294         pTagData++;     <span class="comment">// Next element</span>
03295     }
03296 
03297     <span class="comment">//</span>
03298     <span class="comment">// Set final file size</span>
03299     <span class="comment">//</span>
03300 
03301     cnt = <a class="code" href="../../d4/d0/immcli_8h.html#a18">DWORD_ALIGN</a>(FIX_ENDIAN(HEADER(pProfObj)-&gt;phSize)) + <span class="keyword">sizeof</span>(TAGDATA);
03302     <span class="keywordflow">if</span> (bNewData)
03303     {
03304         <span class="comment">//</span>
03305         <span class="comment">// The new tag is not a reference to an old tag. Increment</span>
03306         <span class="comment">// file size of size of new data also</span>
03307         <span class="comment">//</span>
03308 
03309         cnt += cbSize;
03310     }
03311     HEADER(pProfObj)-&gt;phSize = FIX_ENDIAN(cnt);
03312 
03313     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03314 }
03315 
03316 
03317 <span class="comment">/******************************************************************************</span>
03318 <span class="comment"> *</span>
03319 <span class="comment"> *                       AddTaggedElement</span>
03320 <span class="comment"> *</span>
03321 <span class="comment"> *  Function:</span>
03322 <span class="comment"> *       This functions adds a new tagged element to a profile</span>
03323 <span class="comment"> *</span>
03324 <span class="comment"> *  Arguments:</span>
03325 <span class="comment"> *       pProfObj  - pointer to profile object</span>
03326 <span class="comment"> *       tagType   - tag to add</span>
03327 <span class="comment"> *       cbSize    - size of tag data</span>
03328 <span class="comment"> *</span>
03329 <span class="comment"> *  Returns:</span>
03330 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
03331 <span class="comment"> *</span>
03332 <span class="comment"> ******************************************************************************/</span>
03333 
<a name="l03334"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a5">03334</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a5">AddTaggedElement</a>(
03335     PPROFOBJ pProfObj,
03336     TAGTYPE  tagType,
03337     DWORD    cbSize
03338     )
03339 {
03340     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    dwOffset, newSize;
03341 
03342     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pProfObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03343     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(cbSize &gt; 0);
03344 
03345     <span class="comment">//</span>
03346     <span class="comment">// Resize the profile if needed. For memory buffers, we have to realloc,</span>
03347     <span class="comment">// and for mapped objects, we have to close and reopen the view.</span>
03348     <span class="comment">//</span>
03349 
03350     newSize = FIX_ENDIAN(HEADER(pProfObj)-&gt;phSize);
03351     newSize = <a class="code" href="../../d4/d0/immcli_8h.html#a18">DWORD_ALIGN</a>(newSize) + <span class="keyword">sizeof</span>(TAGDATA) + cbSize;
03352 
03353     <span class="comment">//</span>
03354     <span class="comment">// Check for overflow</span>
03355     <span class="comment">//</span>
03356 
03357     <span class="keywordflow">if</span> (newSize &lt; FIX_ENDIAN(HEADER(pProfObj)-&gt;phSize) ||
03358         newSize &lt; cbSize)
03359     {
03360         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Overflow in adding element\n"</span>)));
03361         SetLastError(ERROR_ARITHMETIC_OVERFLOW);
03362         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03363     }
03364 
03365     <span class="keywordflow">if</span> (newSize &gt; pProfObj-&gt;dwMapSize)
03366     {
03367         <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a8">GrowProfile</a>(pProfObj, newSize))
03368         {
03369             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03370         }
03371     }
03372 
03373     <span class="comment">//</span>
03374     <span class="comment">// Calculate location of new data - should be DWORD aligned</span>
03375     <span class="comment">//</span>
03376 
03377     dwOffset = FIX_ENDIAN(HEADER(pProfObj)-&gt;phSize);
03378     dwOffset = <a class="code" href="../../d4/d0/immcli_8h.html#a18">DWORD_ALIGN</a>(dwOffset);
03379 
03380     <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a4">AddTagTableEntry</a>(pProfObj, tagType, dwOffset, cbSize, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03381 }
03382 
03383 
03384 <span class="comment">/******************************************************************************</span>
03385 <span class="comment"> *</span>
03386 <span class="comment"> *                       DeleteTaggedElement</span>
03387 <span class="comment"> *</span>
03388 <span class="comment"> *  Function:</span>
03389 <span class="comment"> *       This functions deletes a tagged element from the profile</span>
03390 <span class="comment"> *</span>
03391 <span class="comment"> *  Arguments:</span>
03392 <span class="comment"> *       pProfObj  - pointer to profile object</span>
03393 <span class="comment"> *       pTagData  - pointer to tagged element to delete</span>
03394 <span class="comment"> *</span>
03395 <span class="comment"> *  Returns:</span>
03396 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
03397 <span class="comment"> *</span>
03398 <span class="comment"> ******************************************************************************/</span>
03399 
<a name="l03400"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a6">03400</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a6">DeleteTaggedElement</a>(
03401     PPROFOBJ pProfObj,
03402     PTAGDATA pTagData
03403     )
03404 {
03405     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>    pData;
03406     PTAGDATA pTemp;
03407     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    cbSize, nCount, dwOffset, i;
03408 
03409     <span class="comment">//</span>
03410     <span class="comment">// Remember location of data and move everything upto the data upwards</span>
03411     <span class="comment">// by size of one tag table entry. Then move everything below the tag data</span>
03412     <span class="comment">// upward by size of data plus size of one tage table entry.</span>
03413     <span class="comment">//</span>
03414 
03415     pData = VIEW(pProfObj) + FIX_ENDIAN(pTagData-&gt;dwOffset);
03416     cbSize = FIX_ENDIAN(pTagData-&gt;cbSize);
03417     cbSize = <a class="code" href="../../d4/d0/immcli_8h.html#a18">DWORD_ALIGN</a>(cbSize);
03418     dwOffset = FIX_ENDIAN(pTagData-&gt;dwOffset);
03419 
03420     <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a9">MoveProfileData</a>(pProfObj, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)(pTagData+1), (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pTagData,
03421         (LONG)(pData-(<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)(pTagData+1)), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03422 
03423     <span class="comment">//</span>
03424     <span class="comment">// Do not attempt to move data past the tag if we are deleting the last tag</span>
03425     <span class="comment">//</span>
03426 
03427     <span class="keywordflow">if</span> (pData + cbSize &lt; VIEW(pProfObj) + PROFILE_SIZE(pProfObj))
03428     {
03429         <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a9">MoveProfileData</a>(pProfObj, pData+cbSize, pData-<span class="keyword">sizeof</span>(TAGDATA),
03430             PROFILE_SIZE(pProfObj)-(LONG)(pData - VIEW(pProfObj)) - cbSize, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03431     }
03432 
03433     <span class="comment">//</span>
03434     <span class="comment">// Get count of tag items - it is right after the profile header, and</span>
03435     <span class="comment">// decrement it by one.</span>
03436     <span class="comment">//</span>
03437 
03438     nCount = TAG_COUNT(pProfObj);
03439     nCount = FIX_ENDIAN(nCount) - 1;
03440     TAG_COUNT(pProfObj) = FIX_ENDIAN(nCount);
03441 
03442     <span class="comment">//</span>
03443     <span class="comment">// Go through the tag table and update the pointers</span>
03444     <span class="comment">//</span>
03445 
03446     pTemp = TAG_DATA(pProfObj);
03447 
03448     <span class="keywordflow">for</span> (i=0; i&lt;nCount; i++)
03449     {
03450         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwTemp = FIX_ENDIAN(pTemp-&gt;dwOffset);
03451 
03452         <span class="keywordflow">if</span> (dwTemp &gt; dwOffset)
03453         {
03454             dwTemp -= cbSize;        <span class="comment">// cbSize already DWORD aligned</span>
03455         }
03456         dwTemp -= <span class="keyword">sizeof</span>(TAGDATA);
03457         pTemp-&gt;dwOffset = FIX_ENDIAN(dwTemp);
03458         pTemp++;                     <span class="comment">// Next record</span>
03459     }
03460 
03461     <span class="comment">//</span>
03462     <span class="comment">// Use nCount as a placeholder to calculate file size</span>
03463     <span class="comment">//</span>
03464 
03465     nCount = <a class="code" href="../../d4/d0/immcli_8h.html#a18">DWORD_ALIGN</a>(FIX_ENDIAN(HEADER(pProfObj)-&gt;phSize));
03466     nCount -= <span class="keyword">sizeof</span>(TAGDATA) + cbSize;
03467     HEADER(pProfObj)-&gt;phSize = FIX_ENDIAN(nCount);
03468 
03469     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03470 }
03471 
03472 
03473 <span class="comment">/******************************************************************************</span>
03474 <span class="comment"> *</span>
03475 <span class="comment"> *                       ChangeTaggedElementSize</span>
03476 <span class="comment"> *</span>
03477 <span class="comment"> *  Function:</span>
03478 <span class="comment"> *       This functions changes the size of a tagged element in the profile</span>
03479 <span class="comment"> *</span>
03480 <span class="comment"> *  Arguments:</span>
03481 <span class="comment"> *       pProfObj  - pointer to profile object</span>
03482 <span class="comment"> *       pTagData  - pointer to tagged element whose size is to be changed</span>
03483 <span class="comment"> *       cbSize    - new size for the element</span>
03484 <span class="comment"> *</span>
03485 <span class="comment"> *  Returns:</span>
03486 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
03487 <span class="comment"> *</span>
03488 <span class="comment"> ******************************************************************************/</span>
03489 
<a name="l03490"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a7">03490</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a7">ChangeTaggedElementSize</a>(
03491     PPROFOBJ pProfObj,
03492     PTAGDATA pTagData,
03493     DWORD    cbSize
03494     )
03495 {
03496     PTAGDATA pTemp;
03497     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>    pData;
03498     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    nCount, cbOldSize;
03499     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    dwOffset, cnt, i;
03500 
03501     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pProfObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03502     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(cbSize &gt; 0);
03503 
03504     <span class="comment">//</span>
03505     <span class="comment">// Get current size of element</span>
03506     <span class="comment">//</span>
03507 
03508     cbOldSize = FIX_ENDIAN(pTagData-&gt;cbSize);
03509 
03510     <span class="keywordflow">if</span> (cbOldSize == cbSize)
03511     {
03512         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;        <span class="comment">// Sizes are the same - Do nothing</span>
03513     }
03514     pData = VIEW(pProfObj) + FIX_ENDIAN(pTagData-&gt;dwOffset);
03515 
03516     <span class="comment">//</span>
03517     <span class="comment">// Do not attempt to move data beyond end of file. There is no need to move</span>
03518     <span class="comment">// anything if the last data item is being resized.</span>
03519     <span class="comment">//</span>
03520 
03521     <span class="keywordflow">if</span> (pData + <a class="code" href="../../d4/d0/immcli_8h.html#a18">DWORD_ALIGN</a>(cbOldSize) &lt; VIEW(pProfObj) + PROFILE_SIZE(pProfObj))
03522     {
03523         <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a9">MoveProfileData</a>(pProfObj, pData + <a class="code" href="../../d4/d0/immcli_8h.html#a18">DWORD_ALIGN</a>(cbOldSize), pData + <a class="code" href="../../d4/d0/immcli_8h.html#a18">DWORD_ALIGN</a>(cbSize),
03524             PROFILE_SIZE(pProfObj) - (LONG)(pData - VIEW(pProfObj)) - <a class="code" href="../../d4/d0/immcli_8h.html#a18">DWORD_ALIGN</a>(cbOldSize), <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03525     }
03526 
03527     pTagData-&gt;cbSize = FIX_ENDIAN(cbSize);  <span class="comment">// Set the new size</span>
03528 
03529     <span class="comment">//</span>
03530     <span class="comment">// Get count of tag items - it is right after the profile header</span>
03531     <span class="comment">//</span>
03532 
03533     nCount = TAG_COUNT(pProfObj);
03534     nCount = FIX_ENDIAN(nCount);
03535 
03536     <span class="comment">//</span>
03537     <span class="comment">// Go through the tag table and update the pointers</span>
03538     <span class="comment">//</span>
03539 
03540     pTemp = TAG_DATA(pProfObj);
03541 
03542     dwOffset = FIX_ENDIAN(pTagData-&gt;dwOffset);
03543     <span class="keywordflow">for</span> (i=0; i&lt;nCount; i++)
03544     {
03545         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwTemp = FIX_ENDIAN(pTemp-&gt;dwOffset);
03546 
03547         <span class="keywordflow">if</span> (dwTemp &gt; dwOffset)
03548         {
03549             dwTemp += <a class="code" href="../../d4/d0/immcli_8h.html#a18">DWORD_ALIGN</a>(cbSize) - <a class="code" href="../../d4/d0/immcli_8h.html#a18">DWORD_ALIGN</a>(cbOldSize);
03550             pTemp-&gt;dwOffset = FIX_ENDIAN(dwTemp);
03551         }
03552         pTemp++;                     <span class="comment">// Next record</span>
03553     }
03554 
03555     <span class="comment">//</span>
03556     <span class="comment">// Use cnt as a placeholder to calculate file size</span>
03557     <span class="comment">//</span>
03558 
03559     cnt = FIX_ENDIAN(HEADER(pProfObj)-&gt;phSize);
03560     cnt += <a class="code" href="../../d4/d0/immcli_8h.html#a18">DWORD_ALIGN</a>(cbSize) - <a class="code" href="../../d4/d0/immcli_8h.html#a18">DWORD_ALIGN</a>(cbOldSize);
03561     HEADER(pProfObj)-&gt;phSize = FIX_ENDIAN(cnt);
03562 
03563     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03564 }
03565 
03566 
03567 <span class="comment">/******************************************************************************</span>
03568 <span class="comment"> *</span>
03569 <span class="comment"> *                       MoveProfileData</span>
03570 <span class="comment"> *</span>
03571 <span class="comment"> *  Function:</span>
03572 <span class="comment"> *       This function moves data in a profile up or down (from src to dest),</span>
03573 <span class="comment"> *       and then zeroes out the end of the file or the extra space created.</span>
03574 <span class="comment"> *</span>
03575 <span class="comment"> *  Arguments:</span>
03576 <span class="comment"> *       pProfObj  - pointer to profile object</span>
03577 <span class="comment"> *       src       - pointer to source of block to move</span>
03578 <span class="comment"> *       dest      - pointer to destination for block to move to</span>
03579 <span class="comment"> *       cnt       - number of bytes to move</span>
03580 <span class="comment"> *</span>
03581 <span class="comment"> *  Returns:</span>
03582 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
03583 <span class="comment"> *</span>
03584 <span class="comment"> ******************************************************************************/</span>
03585 
<a name="l03586"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a9">03586</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a9">MoveProfileData</a>(
03587     PPROFOBJ pProfObj,
03588     PBYTE src,
03589     PBYTE dest,
03590     LONG cnt,
03591     BOOL bZeroMemory
03592     )
03593 {
03594     <span class="comment">//</span>
03595     <span class="comment">// NOTE: CopyMemory() doesn't work for overlapped memory.</span>
03596     <span class="comment">// Use internal function instead.</span>
03597     <span class="comment">//</span>
03598 
03599     <a class="code" href="../../d2/d1/object_8c.html#a10">MyCopyMemory</a>((PVOID)dest, (PVOID)src, cnt);
03600 
03601     <span class="keywordflow">if</span> (bZeroMemory)
03602     {
03603         cnt = <a class="code" href="../../d2/d3/parentinfo_8cpp.html#a0">ABS</a>((LONG)(dest - src));
03604 
03605         <span class="keywordflow">if</span> (dest &lt; src)
03606         {
03607             <span class="comment">//</span>
03608             <span class="comment">// Size decreased, so zero out end of file</span>
03609             <span class="comment">//</span>
03610 
03611             dest = VIEW(pProfObj) + FIX_ENDIAN(HEADER(pProfObj)-&gt;phSize) -
03612                    (src - dest);
03613         }
03614         <span class="keywordflow">else</span>
03615         {
03616             <span class="comment">//</span>
03617             <span class="comment">// Size increased, so zero out the increased tagdata</span>
03618             <span class="comment">//</span>
03619 
03620             dest = src;
03621         }
03622         ZeroMemory(dest, cnt);
03623     }
03624 
03625     <span class="keywordflow">return</span>;
03626 }
03627 
03628 
03629 <span class="comment">/******************************************************************************</span>
03630 <span class="comment"> *</span>
03631 <span class="comment"> *                           IsReferenceTag</span>
03632 <span class="comment"> *</span>
03633 <span class="comment"> *  Function:</span>
03634 <span class="comment"> *       This function checks if a given tag's data is referred to by another</span>
03635 <span class="comment"> *       tag in the profile</span>
03636 <span class="comment"> *</span>
03637 <span class="comment"> *  Arguments:</span>
03638 <span class="comment"> *       pProfObj  - pointer to profile object</span>
03639 <span class="comment"> *       pTagData  - pointer to tagdata which should be checked</span>
03640 <span class="comment"> *</span>
03641 <span class="comment"> *  Returns:</span>
03642 <span class="comment"> *       TRUE if it is a referece, FALSE otherwise</span>
03643 <span class="comment"> *</span>
03644 <span class="comment"> ******************************************************************************/</span>
03645 
<a name="l03646"></a><a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a10">03646</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d7/w32_2ntgdi_2icm_2mscms_2profile_8c.html#a10">IsReferenceTag</a>(
03647     PPROFOBJ pProfObj,
03648     PTAGDATA pTagData
03649     )
03650 {
03651     PTAGDATA pTemp;
03652     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    nCount, i;
03653     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     bReference = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03654 
03655     pTemp = TAG_DATA(pProfObj);
03656     nCount = TAG_COUNT(pProfObj);
03657     nCount = FIX_ENDIAN(nCount);
03658 
03659     <span class="keywordflow">for</span> (i=0; i&lt;nCount; i++)
03660     {
03661         <span class="keywordflow">if</span> ((pTagData-&gt;dwOffset == pTemp-&gt;dwOffset) &amp;&amp;
03662             (pTagData-&gt;tagType  != pTemp-&gt;tagType))
03663         {
03664             bReference = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03665             <span class="keywordflow">break</span>;
03666         }
03667         pTemp++;                     <span class="comment">// next record</span>
03668     }
03669 
03670     <span class="keywordflow">return</span> bReference;
03671 }
03672 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:28 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
