<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: fragment.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>fragment.c</h1><a href="../../d0/d7/w98_2lh__core_2fragment_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*</span>
00002 <span class="comment">        File:           LHFragment.c</span>
00003 <span class="comment"></span>
00004 <span class="comment">        Contains:       Test fragment for Color Sync</span>
00005 <span class="comment"></span>
00006 <span class="comment">        Written by:     H.Siegeritz</span>
00007 <span class="comment"></span>
00008 <span class="comment">        Copyright:      © 1993-1997 by Heidelberger Druckmaschinen AG, all rights reserved.</span>
00009 <span class="comment"></span>
00010 <span class="comment">*/</span>
00011 
00012 <span class="preprocessor">#ifndef LHGeneralIncs_h</span>
00013 <span class="preprocessor"></span><span class="preprocessor">#include "General.h"</span>
00014 <span class="preprocessor">#endif</span>
00015 <span class="preprocessor"></span>
00016 <span class="preprocessor">#if GENERATING68K</span>
00017 <span class="preprocessor"></span><span class="comment">/*      #include &lt;ConditionalMacros.h&gt; */</span>
00018 
00019 <span class="preprocessor">        #define CM_Doub extended</span>
00020 <span class="preprocessor"></span>        <span class="keyword">extern</span> <a class="code" href="../../d9/d6/lh__core_2fragment_8c.html#a0">CM_Doub</a> pow(CM_Doub _x,CM_Doub _y);
00021 <span class="preprocessor">#else</span>
<a name="l00022"></a><a class="code" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a0">00022</a> <span class="preprocessor"></span><span class="preprocessor">        #define CM_Doub double</span>
00023 <span class="preprocessor"></span><span class="preprocessor">        #include &lt;math.h&gt;</span>
00024 <span class="preprocessor">#endif</span>
00025 <span class="preprocessor"></span>
00026 <span class="preprocessor">#ifndef LHFragment_h</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#include "Fragment.h"</span>
00028 <span class="preprocessor">#endif</span>
00029 <span class="preprocessor"></span>
00030 <span class="preprocessor">#ifndef LHStdConversionLuts_h</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#include "StdConv.h"</span>
00032 <span class="preprocessor">#endif</span>
00033 <span class="preprocessor"></span>
00034 <span class="preprocessor">#if ! realThing</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#ifdef DEBUG_OUTPUT</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#define kThisFile kLHFragmentID</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00039 <span class="preprocessor"></span>
00040 
00041 <span class="comment">/*-----prototypes for local functions-----*/</span>
00042 
00043 <span class="keywordtype">void</span>    <a class="code" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a1">InvLut1dExceptions</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *inCurve, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> inCount,
00044                                 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *outCurve, UINT8 AdressBits);
00045 <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a11">CMError</a> <a class="code" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a2">Fill_ushort_ELUT_Gamma</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *usELUT, <span class="keywordtype">char</span> addrBits, <span class="keywordtype">char</span> usedBits,
00046                                                                                         <span class="keywordtype">long</span> gridPoints, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> gamma_u8_8);
00047 <span class="keywordtype">void</span>    <a class="code" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a3">Fill_inverseGamma_byte_ALUT</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *ucALUT, <span class="keywordtype">char</span> addrBits,
00048                                                                                                         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> gamma_u8_8);
00049 
00050 <span class="comment">/* ______________________________________________________________________</span>
00051 <span class="comment"></span>
00052 <span class="comment">        icCurveType     *</span>
00053 <span class="comment">                InvertLut1d(icCurveType *LookUpTable,</span>
00054 <span class="comment">                    UINT8               AdressBits);</span>
00055 <span class="comment">        Abstract:</span>
00056 <span class="comment">                allocates memory and inverts Lut</span>
00057 <span class="comment">                NOTE: not-monotone LookUpTables are manipulated</span>
00058 <span class="comment">                areas without values in LookUpTable are set 0 resp. 0xFFFF</span>
00059 <span class="comment"></span>
00060 <span class="comment">        Params:</span>
00061 <span class="comment">                LookUpTable     (in)    LUT to be inverted</span>
00062 <span class="comment">                AdressBits      (in)    curve with 2 ^ AdressBits values</span>
00063 <span class="comment">                </span>
00064 <span class="comment">        Return:</span>
00065 <span class="comment">                Ptr to icCurveType              successful</span>
00066 <span class="comment">                nil                                             Error</span>
00067 <span class="comment"></span>
00068 <span class="comment">   _____________________________________________________________________ */</span>
00069 <a class="code" href="../../d5/d1/structicCurveType.html">icCurveType</a>     *
<a name="l00070"></a><a class="code" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a4">00070</a> <a class="code" href="../../d2/d7/w98_2lh__core_2fragment_8h.html#a0">InvertLut1d</a> ( <a class="code" href="../../d5/d1/structicCurveType.html">icCurveType</a> *LookUpTable,
00071                           UINT8 AdressBits)
00072 {
00073         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   i, inCount, outCount;
00074         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   intpFirst, intpLast, halfStep, ulAux, target;
00075         <span class="keywordtype">short</span>                   monot;
00076         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  *inCurve, *outCurve, *usPtr, *stopPtr;
00077         <a class="code" href="../../d5/d1/structicCurveType.html">icCurveType</a>             *outCMcurve = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
00078         <span class="keywordtype">double</span>                  flFactor;
00079         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a35">OSErr</a>                   err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
00080         
00081         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"InvertLut1d"</span>)
00082         
00083         <span class="keywordflow">if</span>( LookUpTable-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o0">base</a>.<a class="code" href="../../d6/d4/structicTagBase.html#o0">sig</a> != <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a87">icSigCurveType</a>     <span class="comment">/* 'curv' */</span> || AdressBits &gt; 15 )
00084                 <span class="keywordflow">goto</span> CleanupAndExit;
00085         
00086         inCount  = LookUpTable-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o1">curve</a>.<a class="code" href="../../d4/d1/structicCurve.html#o0">count</a>;
00087         inCurve  = LookUpTable-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o1">curve</a>.<a class="code" href="../../d4/d1/structicCurve.html#o1">data</a>;
00088         outCount = 0x1 &lt;&lt; AdressBits;
00089                 
00090         outCMcurve = (<a class="code" href="../../d5/d1/structicCurveType.html">icCurveType</a> *)<a class="code" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a5">SmartNewPtr</a>( <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a34">OSType</a>)
00091                                                                           + 2 * <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)
00092                                                                           + outCount * <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>), &amp;err );
00093         <span class="keywordflow">if</span>(err)
00094                 <span class="keywordflow">goto</span> CleanupAndExit;
00095         
00096         outCurve = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)outCMcurve-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o1">curve</a>.<a class="code" href="../../d4/d1/structicCurve.html#o1">data</a>;
00097         
00098         outCMcurve-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o0">base</a>.<a class="code" href="../../d6/d4/structicTagBase.html#o0">sig</a>    = <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a87">icSigCurveType</a>;       <span class="comment">/* 'curv' */</span>
00099         outCMcurve-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o0">base</a>.<a class="code" href="../../d6/d4/structicTagBase.html#o1">reserved</a>[0] = 0x00;
00100         outCMcurve-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o0">base</a>.<a class="code" href="../../d6/d4/structicTagBase.html#o1">reserved</a>[1] = 0x00;
00101         outCMcurve-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o0">base</a>.<a class="code" href="../../d6/d4/structicTagBase.html#o1">reserved</a>[2] = 0x00;
00102         outCMcurve-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o0">base</a>.<a class="code" href="../../d6/d4/structicTagBase.html#o1">reserved</a>[3] = 0x00;
00103         outCMcurve-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o1">curve</a>.<a class="code" href="../../d4/d1/structicCurve.html#o0">count</a> = outCount;
00104         
00105         <span class="keywordflow">if</span>(inCount &lt; 2)         <span class="comment">/* 0 or 1 point in LUT */</span>
00106         {
00107                 <a class="code" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a1">InvLut1dExceptions</a>(inCurve, inCount, outCurve, AdressBits);
00108                 <span class="keywordflow">goto</span> CleanupAndExit;
00109         }
00110         
00111                  <span class="comment">/* exact matching factor for special values: */</span>
00112         flFactor = (<span class="keywordtype">double</span>)(outCount - 1) / 65535.;
00113         halfStep = outCount &gt;&gt; 1;               <span class="comment">/* lessen computation incorrectness */</span>
00114         
00115                                 <span class="comment">/* ascending or descending ? */</span>
00116         <span class="keywordflow">for</span>(monot=0, i=1; i&lt;inCount; i++)
00117         {
00118                 <span class="keywordflow">if</span>(inCurve[i-1] &lt; inCurve[i])
00119                         monot++;
00120                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(inCurve[i-1] &gt; inCurve[i])
00121                         monot--;
00122         }
00123         
00124         <span class="keywordflow">if</span>(monot &gt;= 0)  <span class="comment">/* curve seems to be ascending */</span>
00125         {
00126                 <span class="keywordflow">for</span>(i=1; i&lt;inCount; i++)
00127                         <span class="keywordflow">if</span>(inCurve[i-1] &gt; inCurve[i])
00128                                 inCurve[i] = inCurve[i-1];
00129                 
00130                 intpFirst = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(inCurve[0] * flFactor + 0.9999);
00131                 intpLast  = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(inCurve[inCount-1] * flFactor);
00132                 
00133                 <span class="keywordflow">for</span>(i=0; i&lt;intpFirst; i++)                      <span class="comment">/* fill lacking area low */</span>
00134                         outCurve[i] = 0;
00135                 <span class="keywordflow">for</span>(i=intpLast+1; i&lt;outCount; i++)      <span class="comment">/* fill lacking area high */</span>
00136                         outCurve[i] = 0xFFFF;
00137 
00138                         <span class="comment">/* interpolate remaining values: */</span>
00139                 usPtr   = inCurve;
00140                 stopPtr = inCurve + inCount - 2; <span class="comment">/* stops incrementation */</span>
00141                 
00142                 <span class="keywordflow">for</span>(i=intpFirst; i&lt;=intpLast; i++)
00143                 {
00144                         target = (0x0FFFF * i + halfStep)  / (outCount - 1);
00145                         <span class="keywordflow">while</span>(*(usPtr+1) &lt; target &amp;&amp; usPtr &lt; stopPtr)
00146                                 usPtr++;                                        <span class="comment">/* find interval */</span>
00147                         
00148                         ulAux = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(usPtr - inCurve) &lt;&lt; 16) / (inCount - 1);
00149                         <span class="keywordflow">if</span>(*(usPtr+1) != *usPtr)
00150                         {
00151                                 ulAux += ((target - (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)*usPtr) &lt;&lt; 16)
00152                                           / ( (*(usPtr+1) - *usPtr) * (inCount - 1) );
00153                                 
00154                                 <span class="keywordflow">if</span>(ulAux &amp; 0x10000)   <span class="comment">/* *(usPtr+1) was required */</span>
00155                                         ulAux = 0xFFFF;
00156                         }
00157                         
00158                         outCurve[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)ulAux;
00159                 }
00160         }
00161         <span class="keywordflow">else</span>                    <span class="comment">/* curve seems to be descending */</span>
00162         {
00163                 <span class="keywordflow">for</span>(i=1; i&lt;inCount; i++)
00164                         <span class="keywordflow">if</span>(inCurve[i-1] &lt; inCurve[i])
00165                                 inCurve[i] = inCurve[i-1];
00166                 
00167                 intpFirst = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(inCurve[inCount-1] * flFactor + 0.9999);
00168                 intpLast  = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(inCurve[0] * flFactor);
00169                 
00170                 <span class="keywordflow">for</span>(i=0; i&lt;intpFirst; i++)                      <span class="comment">/* fill lacking area low */</span>
00171                         outCurve[i] = 0xFFFF;
00172                 <span class="keywordflow">for</span>(i=intpLast+1; i&lt;outCount; i++)      <span class="comment">/* fill lacking area high */</span>
00173                         outCurve[i] = 0;
00174 
00175                         <span class="comment">/* interpolate remaining values: */</span>
00176                 usPtr   = inCurve + inCount - 1;
00177                 stopPtr = inCurve + 1;          <span class="comment">/* stops decrementation */</span>
00178                 
00179                 <span class="keywordflow">for</span>(i=intpFirst; i&lt;=intpLast; i++)
00180                 {
00181                         target = (0x0FFFF * i + halfStep)  / (outCount - 1);
00182                         <span class="keywordflow">while</span>(*(usPtr-1) &lt; target &amp;&amp; usPtr &gt; stopPtr)
00183                                 usPtr--;                                        <span class="comment">/* find interval */</span>
00184                         
00185                         ulAux = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(usPtr-1 - inCurve) &lt;&lt; 16) / (inCount - 1);
00186                         <span class="keywordflow">if</span>(*(usPtr-1) != *usPtr)
00187                         {
00188                                 ulAux += (((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)*(usPtr-1) - target) &lt;&lt; 16)
00189                                           / ( (*(usPtr-1) - *usPtr) * (inCount - 1) );
00190                                 
00191                                 <span class="keywordflow">if</span>(ulAux &amp; 0x10000)
00192                                         ulAux = 0x0FFFF;
00193                         }
00194                         
00195                         outCurve[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)ulAux;
00196                 }
00197         }
00198 CleanupAndExit:
00199         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"InvertLut1d"</span>)
00200         <span class="keywordflow">return</span>(outCMcurve);
00201 }
00202 
00203 <span class="comment">/* ______________________________________________________________________</span>
00204 <span class="comment"></span>
00205 <span class="comment">        void</span>
00206 <span class="comment">                InvLut1dExceptions(     unsigned short  *inCurve,</span>
00207 <span class="comment">                                                        unsigned long   inCount,</span>
00208 <span class="comment">                                                        unsigned short  *outCurve,</span>
00209 <span class="comment">                            UINT8                       AdressBits )</span>
00210 <span class="comment">        Abstract:</span>
00211 <span class="comment">                handles identity and gamma case for LUT inversion</span>
00212 <span class="comment"></span>
00213 <span class="comment">        Params:</span>
00214 <span class="comment">                inCurve         (in)    pseudo LUT to be inverted</span>
00215 <span class="comment">                inCount         (in)    count of values, 0 (identity) or 1 (gamma)</span>
00216 <span class="comment">                outCurve        (out)   inverted LUT</span>
00217 <span class="comment">                AdressBits      (in)    2^n values are requested</span>
00218 <span class="comment">                </span>
00219 <span class="comment">        Return:</span>
00220 <span class="comment">                void</span>
00221 <span class="comment"></span>
00222 <span class="comment">   _____________________________________________________________________ */</span>
00223 <span class="keywordtype">void</span>
00224 <a class="code" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a1">InvLut1dExceptions</a>      ( <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *      inCurve,
00225                                           <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>         inCount,
00226                                           <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *      outCurve,
00227                                           UINT8                         AdressBits)
00228 {
00229         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   i, outCount, step, oldstep, stopit;
00230         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>                   shiftBits;
00231         <a class="code" href="../../d9/d6/lh__core_2fragment_8c.html#a0">CM_Doub</a>                 invGamma, x, xFactor;
00232 <span class="preprocessor">#ifdef DEBUG_OUTPUT</span>
00233 <span class="preprocessor"></span>        <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a11">CMError</a>                 err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
00234 <span class="preprocessor">#endif</span>
00235 <span class="preprocessor"></span>
00236         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"InvLut1dExceptions"</span>)
00237         outCount = 0x1 &lt;&lt; AdressBits;
00238         
00239         if(inCount == 0)        <span class="comment">/* identity */</span>
00240         {
00241                 shiftBits = 16 - AdressBits;
00242                 
00243                 <span class="keywordflow">for</span>(i=0; i&lt;outCount; i++)
00244                         outCurve[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)( (i &lt;&lt; shiftBits)
00245                                                                                   + (i &gt;&gt; AdressBits) );
00246         }
00247         <span class="keywordflow">else</span>            <span class="comment">/* inCount == 1 , gamma */</span>
00248         {
00249                 invGamma = 256. / (<a class="code" href="../../d9/d6/lh__core_2fragment_8c.html#a0">CM_Doub</a>)inCurve[0];
00250                 xFactor  = 1. / (<a class="code" href="../../d9/d6/lh__core_2fragment_8c.html#a0">CM_Doub</a>)(outCount - 1);
00251                 
00252                 <span class="keywordflow">if</span>(AdressBits &lt;= 6)             <span class="comment">/* up to 64 - 2 float.computations */</span>
00253                         step = 1;
00254                 <span class="keywordflow">else</span>
00255                         step = 0x1 &lt;&lt; (AdressBits - 6);         <span class="comment">/* would take too long */</span>
00256                 
00257                 outCurve[0]          = 0;
00258                 outCurve[outCount-1] = 0xFFFF;
00259                 
00260                 <span class="keywordflow">for</span>(i=step; i&lt;outCount-1; i+=step)
00261                 {
00262                         x = (<a class="code" href="../../d9/d6/lh__core_2fragment_8c.html#a0">CM_Doub</a>)i * xFactor;
00263                         outCurve[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)( pow(x,invGamma) * 65535.0);
00264                 }
00265                 
00266                 <span class="keywordflow">while</span>(step &gt; 1)         <span class="comment">/* fill remaining values successively */</span>
00267                 {
00268                         oldstep = step;
00269                         step  &gt;&gt;= 1;
00270                         
00271                         stopit = outCount - step;       <span class="comment">/* last value afterwards */</span>
00272                         
00273                         <span class="keywordflow">for</span>(i=step; i&lt;stopit; i+=oldstep)
00274                                 outCurve[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)( ((<span class="keywordtype">long</span>)outCurve[i - step]
00275                                                                                 + (<span class="keywordtype">long</span>)outCurve[i + step]) &gt;&gt; 1 );
00276                         
00277                         <span class="keywordflow">if</span>(step != 1)
00278                                 outCurve[stopit] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)
00279                                                         ( ((<span class="keywordtype">long</span>)outCurve[stopit - step] + 0x0FFFF) &gt;&gt; 1 );
00280                 }
00281                 
00282                         <span class="comment">/* overwrite sensitive values depending on Gamma */</span>
00283                 <span class="keywordflow">if</span>(AdressBits &gt; 6 &amp;&amp; invGamma &lt; 1.0)    <span class="comment">/* lower part is difficult */</span>
00284                 {
00285                         stopit = 0x1 &lt;&lt; (AdressBits - 6);
00286                         
00287                         <span class="keywordflow">for</span>(i=1; i&lt;stopit; i++)
00288                         {
00289                                 x = (<a class="code" href="../../d9/d6/lh__core_2fragment_8c.html#a0">CM_Doub</a>)i * xFactor;
00290                                 outCurve[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)( pow(x,invGamma) * 65535.0);
00291                         }
00292                 }
00293         }
00294         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"InvLut1dExceptions"</span>)
00295 }
00296 
00297 <span class="comment">/* ______________________________________________________________________</span>
00298 <span class="comment"></span>
00299 <span class="comment">        CMError</span>
00300 <span class="comment">                CombiMatrix(icXYZType   *srcColorantData[3],</span>
00301 <span class="comment">                                        icXYZType       *destColorantData[3],</span>
00302 <span class="comment">                                        double          resMatrix[3][3])</span>
00303 <span class="comment">        Abstract:</span>
00304 <span class="comment">                inverts the 2nd matrix, multiplies it with the 1rst and</span>
00305 <span class="comment">                puts the result in resMatrix</span>
00306 <span class="comment"></span>
00307 <span class="comment">        Params:</span>
00308 <span class="comment">                srcColorantData         (in)            RGB colorants</span>
00309 <span class="comment">                destColorantData        (in)            RGB colorants</span>
00310 <span class="comment">                resMatrix                       (in/out)</span>
00311 <span class="comment">                </span>
00312 <span class="comment">        Return:</span>
00313 <span class="comment">                noErr           successful</span>
00314 <span class="comment"></span>
00315 <span class="comment">   _____________________________________________________________________ */</span>
00316 <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a11">CMError</a>
<a name="l00317"></a><a class="code" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a5">00317</a> <a class="code" href="../../d2/d7/w98_2lh__core_2fragment_8h.html#a1">CombiMatrix</a>     ( <a class="code" href="../../d9/d6/structicXYZType.html">icXYZType</a> srcColorantData[3],
00318                           <a class="code" href="../../d9/d6/structicXYZType.html">icXYZType</a> destColorantData[3],
00319                           <span class="keywordtype">double</span> resMatrix[3][3] )
00320 {
00321         <span class="keywordtype">short</span>           i, j;
00322         <span class="keywordtype">double</span>          straightMat[3][3], invMat[3][3];
00323         <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a11">CMError</a>         err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
00324 
00325         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"CombiMatrix"</span>)
00326                 <span class="comment">/* RGB -&gt; XYZ for first profile: */</span>
00327         straightMat[0][0] = (<span class="keywordtype">double</span>)srcColorantData[0].<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o0">X</a>;
00328         straightMat[1][0] = (<span class="keywordtype">double</span>)srcColorantData[0].<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o1">Y</a>;
00329         straightMat[2][0] = (<span class="keywordtype">double</span>)srcColorantData[0].<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o2">Z</a>;
00330         
00331         straightMat[0][1] = (<span class="keywordtype">double</span>)srcColorantData[1].<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o0">X</a>;
00332         straightMat[1][1] = (<span class="keywordtype">double</span>)srcColorantData[1].<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o1">Y</a>;
00333         straightMat[2][1] = (<span class="keywordtype">double</span>)srcColorantData[1].<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o2">Z</a>;
00334         
00335         straightMat[0][2] = (<span class="keywordtype">double</span>)srcColorantData[2].<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o0">X</a>;
00336         straightMat[1][2] = (<span class="keywordtype">double</span>)srcColorantData[2].<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o1">Y</a>;
00337         straightMat[2][2] = (<span class="keywordtype">double</span>)srcColorantData[2].<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o2">Z</a>;
00338         
00339                 <span class="comment">/* RGB -&gt; XYZ for 2nd profile, store in resMatrix prelim.: */</span>
00340         resMatrix[0][0] = (<span class="keywordtype">double</span>)destColorantData[0].<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o0">X</a>;
00341         resMatrix[1][0] = (<span class="keywordtype">double</span>)destColorantData[0].<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o1">Y</a>;
00342         resMatrix[2][0] = (<span class="keywordtype">double</span>)destColorantData[0].<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o2">Z</a>;
00343         
00344         resMatrix[0][1] = (<span class="keywordtype">double</span>)destColorantData[1].<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o0">X</a>;
00345         resMatrix[1][1] = (<span class="keywordtype">double</span>)destColorantData[1].<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o1">Y</a>;
00346         resMatrix[2][1] = (<span class="keywordtype">double</span>)destColorantData[1].<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o2">Z</a>;
00347         
00348         resMatrix[0][2] = (<span class="keywordtype">double</span>)destColorantData[2].<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o0">X</a>;
00349         resMatrix[1][2] = (<span class="keywordtype">double</span>)destColorantData[2].<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o1">Y</a>;
00350         resMatrix[2][2] = (<span class="keywordtype">double</span>)destColorantData[2].<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o2">Z</a>;
00351         
00352         <span class="keywordflow">if</span>( !<a class="code" href="../../d1/d6/w98_2lh__core_2memlink_8c.html#a24">doubMatrixInvert</a>(resMatrix, invMat) )
00353         {
00354 <span class="preprocessor">#ifdef DEBUG_OUTPUT</span>
00355 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( DebugCheck(kThisFile, kDebugErrorInfo) )
00356             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(<span class="stringliteral">"¥ CombiMatrix-Error: doubMatrixInvert failed \n"</span>);
00357 <span class="preprocessor">#endif</span>
00358 <span class="preprocessor"></span>                err = <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a149a30">cmparamErr</a>;
00359                 <span class="keywordflow">goto</span> CleanupAndExit;
00360         }
00361         
00362         <span class="keywordflow">for</span>(i=0; i&lt;3; i++)
00363                 <span class="keywordflow">for</span>(j=0; j&lt;3; j++)
00364                         resMatrix[i][j] = straightMat[i][0] * invMat[0][j]
00365                                                         + straightMat[i][1] * invMat[1][j]
00366                                                         + straightMat[i][2] * invMat[2][j];
00367 CleanupAndExit:
00368         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"CombiMatrix"</span>)
00369         <span class="keywordflow">return</span> err;
00370 }
00371 
00372 <span class="comment">/* ______________________________________________________________________</span>
00373 <span class="comment"></span>
00374 <span class="comment">        Boolean</span>
00375 <span class="comment">                doubMatrixInvert(double MatHin[3][3],</span>
00376 <span class="comment">                                                 double MatRueck[3][3])</span>
00377 <span class="comment">        Abstract:</span>
00378 <span class="comment">                inverts MatHin matrix and puts the result in MatRueck</span>
00379 <span class="comment"></span>
00380 <span class="comment">        Params:</span>
00381 <span class="comment">                MatHin                  (in)                    3 * 3 double matrix</span>
00382 <span class="comment">                MatRueck                (in/out)                3 * 3 double matrix</span>
00383 <span class="comment">                </span>
00384 <span class="comment">        Return:</span>
00385 <span class="comment">        TRUE            successful</span>
00386 <span class="comment"></span>
00387 <span class="comment">   _____________________________________________________________________ */</span>
00388 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a21">Boolean</a> 
<a name="l00389"></a><a class="code" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a6">00389</a> <a class="code" href="../../d1/d6/w98_2lh__core_2memlink_8c.html#a24">doubMatrixInvert</a>(<span class="keywordtype">double</span> MatHin[3][3], <span class="keywordtype">double</span> MatRueck[3][3])
00390 {
00391         <span class="keywordtype">double</span>  detm, hilf1, hilf2, hilf3, hilf4, hilf5, hilf6;
00392         <span class="keywordtype">double</span>  *a;
00393         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a21">Boolean</a> success = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00394 <span class="preprocessor">#ifdef DEBUG_OUTPUT</span>
00395 <span class="preprocessor"></span>        <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a11">CMError</a> err=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
00396 <span class="preprocessor">#endif</span>
00397 <span class="preprocessor"></span>        <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"doubMatrixInvert"</span>)
00398         a = (<span class="keywordtype">double</span> *)MatHin;
00399         
00400         hilf1 = a[0] * a[4];
00401         hilf2 = a[1] * a[5];
00402         hilf3 = a[2] * a[3];
00403         hilf4 = a[2] * a[4];
00404         hilf5 = a[1] * a[3];
00405         hilf6 = a[0] * a[5];
00406         
00407         detm = hilf1 * a[8] + hilf2 * a[6]
00408                  + hilf3 * a[7] - hilf4 * a[6]
00409                  - hilf5 * a[8] - hilf6 * a[7];
00410         
00411         <span class="comment">/*      if(fabs(detm) &lt; 1.E-9) */</span>
00412         <span class="keywordflow">if</span> ( (detm &lt; 1.E-9) &amp;&amp; (detm &gt; -1.E-9) )
00413         success = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00414         <span class="keywordflow">else</span>
00415         {
00416                 detm = 1. / detm;
00417                 
00418                 MatRueck[0][0] = (a[4] * a[8] - a[5] * a[7]) * detm;
00419                 MatRueck[0][1] = (a[7] * a[2] - a[8] * a[1]) * detm;
00420                 MatRueck[0][2] = (hilf2       - hilf4      ) * detm;
00421         
00422                 MatRueck[1][0] = (a[5] * a[6] - a[3] * a[8]) * detm;
00423                 MatRueck[1][1] = (a[8] * a[0] - a[6] * a[2]) * detm;
00424                 MatRueck[1][2] = (hilf3       - hilf6      ) * detm;
00425         
00426                 MatRueck[2][0] = (a[3] * a[7] - a[4] * a[6]) * detm;
00427                 MatRueck[2][1] = (a[6] * a[1] - a[7] * a[0]) * detm;
00428                 MatRueck[2][2] = (hilf1       - hilf5      ) * detm;
00429         }
00430         
00431         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"doubMatrixInvert"</span>)
00432     <span class="keywordflow">return</span>(success);
00433 }
00434 
00435 <span class="comment">/* ______________________________________________________________________</span>
00436 <span class="comment">        CMError</span>
00437 <span class="comment">                Fill_ushort_ELUT_from_CurveTag( icCurveType             *pCurveTag,</span>
00438 <span class="comment">                                                                                unsigned short  *usELUT,</span>
00439 <span class="comment">                                                                                char                    addrBits,</span>
00440 <span class="comment">                                                                                char                    usedBits,</span>
00441 <span class="comment">                                                                                long                    gridPoints )</span>
00442 <span class="comment">        Abstract:</span>
00443 <span class="comment">                extracts input luts out of cmSigCurveType tag and converts it</span>
00444 <span class="comment">                to desired format: (2 ^ addrBits) values in a range from</span>
00445 <span class="comment">                0 to (2 ^ usedBits) - (gridPoints ^ 2)</span>
00446 <span class="comment">                NOTE: Memory for the LUTs has to be allocated before !</span>
00447 <span class="comment"></span>
00448 <span class="comment">        Params:</span>
00449 <span class="comment">                pCurveTag               (in)            extract input LUT from this</span>
00450 <span class="comment">                usELUT                  (in/out)        result LUT</span>
00451 <span class="comment">                addrBits                (in)            2 ^ addrBits values are requested</span>
00452 <span class="comment">                usedBits                (in)            used bits in u.short</span>
00453 <span class="comment">                gridPoints              (in)            used for interpolation</span>
00454 <span class="comment">                </span>
00455 <span class="comment">        Return:</span>
00456 <span class="comment">                noErr           successful</span>
00457 <span class="comment"></span>
00458 <span class="comment">   _____________________________________________________________________ */</span>
00459 <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a11">CMError</a>
<a name="l00460"></a><a class="code" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a7">00460</a> <a class="code" href="../../d2/d7/w98_2lh__core_2fragment_8h.html#a4">Fill_ushort_ELUT_from_CurveTag</a> ( <a class="code" href="../../d5/d1/structicCurveType.html">icCurveType</a>    *pCurveTag,
00461                                                                  <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *usELUT,
00462                                                                  <span class="keywordtype">char</span>                   addrBits,
00463                                                                  <span class="keywordtype">char</span>                   usedBits,
00464                                                                  <span class="keywordtype">long</span>                   gridPoints)
00465 {
00466         <span class="keywordtype">long</span>                    i, count, indFactor, outFactor, baseInd, maxOut;
00467         <span class="keywordtype">long</span>                    fract, lAux, diff, outRound, outShift, interpRound, interpShift;
00468         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  *usCurv;
00469         <span class="keywordtype">double</span>                  dFactor;
00470         <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a11">CMError</a>                 err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
00471         
00472         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"Fill_ushort_ELUT_from_CurveTag"</span>)
00473                 <span class="comment">/*---special cases:---*/</span>
00474 
00475         <span class="keywordflow">if</span>(pCurveTag-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o1">curve</a>.<a class="code" href="../../d4/d1/structicCurve.html#o0">count</a> == 0)         <span class="comment">/* identity curve */</span>
00476         {
00477                 err = <a class="code" href="../../d2/d7/w98_2lh__core_2fragment_8h.html#a3">Fill_ushort_ELUT_identical</a>(usELUT, addrBits, usedBits, gridPoints);
00478                 <span class="keywordflow">goto</span> CleanupAndExit;
00479         }
00480         
00481         <span class="keywordflow">if</span>(pCurveTag-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o1">curve</a>.<a class="code" href="../../d4/d1/structicCurve.html#o0">count</a> == 1)         <span class="comment">/* Gamma  curve */</span>
00482         {
00483                 err = <a class="code" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a2">Fill_ushort_ELUT_Gamma</a>(usELUT, addrBits, usedBits, gridPoints, pCurveTag-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o1">curve</a>.<a class="code" href="../../d4/d1/structicCurve.html#o1">data</a>[0]);
00484                 <span class="keywordflow">goto</span> CleanupAndExit;
00485         }
00486                 <span class="comment">/*---ordinary case:---*/</span>
00487         
00488         <span class="keywordflow">if</span>(addrBits &gt; 15)
00489         {
00490                 err = <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a149a30">cmparamErr</a>;       <span class="comment">/* would lead to overflow */</span>
00491                 <span class="keywordflow">goto</span> CleanupAndExit;
00492         }
00493         
00494         count     = 1 &lt;&lt; addrBits;
00495         indFactor = ((pCurveTag-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o1">curve</a>.<a class="code" href="../../d4/d1/structicCurve.html#o0">count</a> - 1) &lt;&lt; 18) / (count - 1); <span class="comment">/* for adjusting indices */</span>
00496         
00497         <span class="keywordflow">if</span>(usedBits &lt; 8)
00498         {
00499                 err = <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a149a30">cmparamErr</a>;
00500                 <span class="keywordflow">goto</span> CleanupAndExit;
00501         }
00502         
00503         <span class="keywordflow">if</span>(gridPoints == 0)
00504                 maxOut = 65535;
00505         <span class="keywordflow">else</span>
00506                 maxOut = ((1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a> &lt;&lt; (usedBits - 8) ) * 256 * (gridPoints - 1)) / gridPoints;
00507         
00508                 <span class="comment">/*-----find factor for the values that fits in 15 bits------*/</span>
00509                 <span class="comment">/* (product with 16 bit number must fit in 31 bit uns.long)     */</span>
00510                 <span class="comment">/* n.b: 512 &lt;= maxOut &lt;= 65535  in all possible cases           */</span>
00511         
00512         dFactor  = (<span class="keywordtype">double</span>)maxOut / 65535.;             <span class="comment">/* 65535 is max. curve value */</span>
00513         dFactor *= 4194304.;                                    <span class="comment">/* same as &lt;&lt; 22, certainly too much */</span>
00514         
00515         outFactor = (<span class="keywordtype">long</span>)dFactor;
00516         outRound  = (1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a> &lt;&lt; 21) - 1;
00517         outShift  = 22;
00518         <span class="keywordflow">while</span>(outFactor &amp; 0xFFF8000)    <span class="comment">/* stay within 15 bits to prevent product overflow */</span>
00519         {
00520                 outFactor &gt;&gt;= 1;
00521                 outRound  &gt;&gt;= 1;
00522                 outShift   -= 1;
00523         }
00524         
00525         interpRound = outRound &gt;&gt; 1;    <span class="comment">/* with interpolation we have an additional...  */</span>
00526         interpShift = outShift  - 1;    <span class="comment">/* ... &gt;&gt; 1 because we must add two nunmbers    */</span>
00527         
00528         usCurv = pCurveTag-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o1">curve</a>.<a class="code" href="../../d4/d1/structicCurve.html#o1">data</a>;
00529         
00530         <span class="keywordflow">for</span>(i=0; i&lt;count; i++)
00531         {
00532                 lAux    = (i * indFactor+4) &gt;&gt; 3;
00533                 baseInd = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)lAux &gt;&gt; 15;
00534                 fract   = lAux &amp; 0x7FFF;                <span class="comment">/* 15 bits for interpolation */</span>
00535                 
00536                 <span class="keywordflow">if</span>(fract)               <span class="comment">/* interpolation necessary ? */</span>
00537                 {
00538                         lAux = (<span class="keywordtype">long</span>)usCurv[baseInd] * outFactor &gt;&gt; 1;
00539                         
00540                         diff = (<span class="keywordtype">long</span>)usCurv[baseInd+1] - (<span class="keywordtype">long</span>)usCurv[baseInd];
00541                         diff = (diff * outFactor &gt;&gt; 15) * fract &gt;&gt; 1;
00542 
00543                         usELUT[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)( (lAux + diff + interpRound) &gt;&gt; interpShift );
00544                 }
00545                 <span class="keywordflow">else</span>
00546                         usELUT[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)( ((<span class="keywordtype">long</span>)usCurv[baseInd]
00547                                                                                                 * outFactor + outRound) &gt;&gt; outShift );
00548         }
00549 
00550 CleanupAndExit: 
00551         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"Fill_ushort_ELUT_from_CurveTag"</span>)
00552         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>);
00553 }
00554 
00555 <span class="comment">/* ______________________________________________________________________</span>
00556 <span class="comment">   _____________________________________________________________________ */</span>
00557 <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a11">CMError</a>
<a name="l00558"></a><a class="code" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a8">00558</a> <a class="code" href="../../d2/d7/w98_2lh__core_2fragment_8h.html#a3">Fill_ushort_ELUT_identical</a>      ( UINT16 *usELUT,
00559                                                           <span class="keywordtype">char</span> addrBits,
00560                                                           <span class="keywordtype">char</span> usedBits,
00561                                                           <span class="keywordtype">long</span> gridPoints )
00562 {
00563         <span class="keywordtype">long</span>            i, count, factor, maxOut;
00564         <a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>          *myWPtr;
00565 <span class="preprocessor">#ifdef DEBUG_OUTPUT</span>
00566 <span class="preprocessor"></span>        <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a11">CMError</a> err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
00567 <span class="preprocessor">#endif</span>
00568 <span class="preprocessor"></span>        <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"Fill_ushort_ELUT_identical"</span>)
00569                 
00570         count  = 1 &lt;&lt; addrBits;
00571         
00572         <span class="keywordflow">if</span>(gridPoints == 0)
00573                 maxOut = 65535;
00574         <span class="keywordflow">else</span>
00575                 maxOut = ((1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a> &lt;&lt; (usedBits - 8) ) * 256 * (gridPoints - 1)) / gridPoints;
00576         
00577         factor = (maxOut &lt;&lt; 14) / (count - 1);
00578         
00579         myWPtr = usELUT;
00580         <span class="keywordflow">for</span>(i=0; i&lt;count; i++)
00581                 *myWPtr++ = (<a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>)((i * factor + 0x2000) &gt;&gt; 14);
00582         
00583         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"Fill_ushort_ELUT_identical"</span>)
00584         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>);
00585 }
00586 
00587 <span class="comment">/* ______________________________________________________________________</span>
00588 <span class="comment">   _____________________________________________________________________ */</span>
00589 <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a11">CMError</a>
00590 <a class="code" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a2">Fill_ushort_ELUT_Gamma</a>  ( <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>*       usELUT,
00591                                                   <span class="keywordtype">char</span>                          addrBits,
00592                                                   <span class="keywordtype">char</span>                          usedBits,
00593                                                   <span class="keywordtype">long</span>                          gridPoints,
00594                                                   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>        gamma_u8_8 )
00595 {
00596         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   i, j, outCount, step, stopit;
00597         <a class="code" href="../../d9/d6/lh__core_2fragment_8c.html#a0">CM_Doub</a>                 gamma, x, xFactor;
00598         <span class="keywordtype">long</span>                    leftVal, Diff, lAux, maxOut;
00599 <span class="preprocessor">#ifdef DEBUG_OUTPUT</span>
00600 <span class="preprocessor"></span>        <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a11">CMError</a>                 err=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
00601 <span class="preprocessor">#endif</span>
00602 <span class="preprocessor"></span>
00603         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"Fill_ushort_ELUT_Gamma"</span>)
00604         outCount = 0x1 &lt;&lt; addrBits;
00605         if(gridPoints == 0)
00606                 maxOut = 65535;
00607         else
00608                 maxOut = ((1L &lt;&lt; (usedBits - 8) ) * 256 * (gridPoints - 1)) / gridPoints;
00609         
00610         gamma   = ((CM_Doub)gamma_u8_8 * 3.90625E-3);   <span class="comment">/* / 256.0 */</span>
00611         xFactor = 1. / (CM_Doub)(outCount - 1);
00612         
00613         if(addrBits &lt;= 6)               <span class="comment">/* up to 64 - 2 float.computations */</span>
00614                 step = 1;
00615         else
00616                 step = 0x1 &lt;&lt; (addrBits - 6);           <span class="comment">/* would take too long */</span>
00617         
00618         usELUT[0]          = 0;
00619     usELUT[outCount-1] = (UINT16)maxOut;
00620         
00621         for(i=step; i&lt;outCount-1; i+=step)
00622         {
00623                 x         = (<a class="code" href="../../d9/d6/lh__core_2fragment_8c.html#a0">CM_Doub</a>)i * xFactor;
00624                 usELUT[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)( pow(x,gamma) * maxOut);
00625         }
00626         
00627                 <span class="comment">/*---fill intervals - except for last, which is odd:---*/</span>
00628         <span class="keywordflow">for</span>(i=0; i&lt;outCount-step; i+=step)
00629         {
00630                 leftVal = (<span class="keywordtype">long</span>)usELUT[i];
00631                 Diff    = (<span class="keywordtype">long</span>)usELUT[i + step] - leftVal;
00632                         
00633                 <span class="keywordflow">for</span>(j=1; j&lt;step; j++)
00634                 {
00635                         lAux = ( (Diff * j &lt;&lt; 8) / step + 128 ) &gt;&gt; 8;
00636 
00637                         usELUT[i + j] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)(leftVal + lAux);
00638                 }
00639         }
00640         
00641                 <span class="comment">/*---fill last interval:---*/</span>
00642         i       = outCount - step;
00643         leftVal = (<span class="keywordtype">long</span>)usELUT[i];
00644         Diff    = maxOut - leftVal;             <span class="comment">/* maxOut for 1.0 */</span>
00645                 
00646         <span class="keywordflow">for</span>(j=1; j&lt;step-1; j++)         <span class="comment">/* stops here if step &lt;= 2 */</span>
00647         {
00648                 lAux = ( (Diff * j &lt;&lt; 8) / (step - 1) + 128 ) &gt;&gt; 8;
00649 
00650                 usELUT[i + j] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)(leftVal + lAux);
00651         }
00652         
00653                 <span class="comment">/* overwrite sensitive values depending on Gamma */</span>
00654         <span class="keywordflow">if</span>(addrBits &gt; 6 &amp;&amp; gamma &lt; 1.0) <span class="comment">/* lower part is difficult */</span>
00655         {
00656                 stopit = 0x1 &lt;&lt; (addrBits - 6);
00657                 
00658                 <span class="keywordflow">for</span>(i=1; i&lt;stopit; i++)
00659                 {
00660                         x = (<a class="code" href="../../d9/d6/lh__core_2fragment_8c.html#a0">CM_Doub</a>)i * xFactor;
00661                         usELUT[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)( pow(x,gamma) * maxOut);
00662                 }
00663         }
00664 
00665         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"Fill_ushort_ELUT_Gamma"</span>)
00666         return(noErr);
00667 }
00668 
00669 
00670 <span class="comment">/* ______________________________________________________________________</span>
00671 <span class="comment"></span>
00672 <span class="comment">        CMError</span>
00673 <span class="comment">                Fill_inverse_byte_ALUT_from_CurveTag(   icCurveType             *pCurveTag,</span>
00674 <span class="comment">                                                                                                unsigned char   *ucALUT,</span>
00675 <span class="comment">                                                                                                char                    addrBits )</span>
00676 <span class="comment">        Abstract:</span>
00677 <span class="comment">                extracts output luts out of cmSigCurveType tag and converts them</span>
00678 <span class="comment">                to desired format: (2 ^ addrBits) values in a range from 0 to 255</span>
00679 <span class="comment">                NOTE: not-monotone CurveTags are manipulated</span>
00680 <span class="comment">                NOTE: Memory for the LUT has to be allocated before !</span>
00681 <span class="comment"></span>
00682 <span class="comment">        Params:</span>
00683 <span class="comment">                pCurveTag               (in)            extract input LUT from this</span>
00684 <span class="comment">                ucALUT                  (in/out)        result LUT</span>
00685 <span class="comment">                addrBits                (in)            2 ^ addrBits values are requested</span>
00686 <span class="comment">                </span>
00687 <span class="comment">        Return:</span>
00688 <span class="comment">                noErr           successful</span>
00689 <span class="comment"></span>
00690 <span class="comment">   _____________________________________________________________________ */</span>
00691 CMError
<a name="l00692"></a><a class="code" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a9">00692</a> Fill_inverse_byte_ALUT_from_CurveTag    ( <a class="code" href="../../d5/d1/structicCurveType.html">icCurveType</a>   *pCurveTag,
00693                                                                                   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *ucALUT,
00694                                                                                   <span class="keywordtype">char</span>                  addrBits )
00695 {
00696         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   i, inCount, outCount;
00697         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   intpFirst, intpLast, halfStep, ulAux, target;
00698         <span class="keywordtype">short</span>                   monot;
00699         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  *inCurve, *usPtr, *stopPtr;
00700         <span class="keywordtype">double</span>                  flFactor;
00701         <span class="keywordtype">char</span>                    baseShift;
00702         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   clipIndex;
00703         <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a11">CMError</a>                 err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
00704 
00705         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"Fill_inverse_byte_ALUT_from_CurveTag"</span>)
00706 
00707     <span class="keywordflow">if</span>( pCurveTag-&gt;base.sig != <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a87">icSigCurveType</a>   <span class="comment">/* 'curv' */</span>
00708      || addrBits &gt; 15 )
00709     {
00710 <span class="preprocessor">#ifdef DEBUG_OUTPUT</span>
00711 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( DebugCheck(kThisFile, kDebugErrorInfo) )
00712             <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(<span class="stringliteral">"¥ Fill_inverse_byte_ALUT_from_CurveTag ERROR:  addrBits = %d\n"</span>,addrBits);
00713 <span class="preprocessor">#endif</span>
00714 <span class="preprocessor"></span>                err = <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a149a30">cmparamErr</a>;
00715                 <span class="keywordflow">goto</span> CleanupAndExit;
00716         }
00717         
00718         outCount = 0x1 &lt;&lt; addrBits;
00719 
00720                 <span class="comment">/*---special cases:---*/</span>
00721 
00722         <span class="keywordflow">if</span>(pCurveTag-&gt;curve.count == 0)         <span class="comment">/*---identity---*/</span>
00723         {
00724                 baseShift = addrBits - 8;               <span class="comment">/* &gt;= 0, we need at least 256 values */</span>
00725                 
00726                 <span class="keywordflow">for</span>(i=0; i&lt;outCount; i++)
00727                         ucALUT[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)(i &gt;&gt; baseShift);
00728         
00729                 <span class="keywordflow">goto</span> CleanupAndExit;
00730         }
00731         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(pCurveTag-&gt;curve.count == 1)    <span class="comment">/*---gamma curve---*/</span>
00732         {
00733                 <a class="code" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a3">Fill_inverseGamma_byte_ALUT</a>(ucALUT, addrBits, pCurveTag-&gt;curve.data[0]);
00734                 <span class="keywordflow">goto</span> CleanupAndExit;
00735         }
00736         
00737                 <span class="comment">/*---ordinary case:---*/</span>
00738         
00739         inCount = pCurveTag-&gt;curve.count;
00740         inCurve = pCurveTag-&gt;curve.data;
00741                 
00742                  <span class="comment">/* exact matching factor needed for special values: */</span>
00743         clipIndex = (1 &lt;&lt; addrBits) - (1 &lt;&lt; (addrBits - 8)); <span class="comment">/* max XLUT output with 10 bit is at 1020, not at1023 */</span>
00744         flFactor  = (<span class="keywordtype">double</span>)clipIndex / 65535.;
00745         
00746         halfStep = outCount &gt;&gt; 1;               <span class="comment">/* lessen computation incorrectness */</span>
00747         
00748                                 <span class="comment">/* ascending or descending ? */</span>
00749         <span class="keywordflow">for</span>(monot=0, i=1; i&lt;inCount; i++)
00750         {
00751                 <span class="keywordflow">if</span>(inCurve[i-1] &lt; inCurve[i])
00752                         monot++;
00753                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(inCurve[i-1] &gt; inCurve[i])
00754                         monot--;
00755         }
00756         
00757         <span class="keywordflow">if</span>(monot &gt;= 0)  <span class="comment">/* curve seems to be ascending */</span>
00758         {
00759                 <span class="keywordflow">for</span>(i=1; i&lt;inCount; i++)
00760                         <span class="keywordflow">if</span>(inCurve[i-1] &gt; inCurve[i])
00761                                 inCurve[i] = inCurve[i-1];
00762                 
00763                 intpFirst = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(inCurve[0] * flFactor + 0.9999);
00764                 intpLast  = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(inCurve[inCount-1] * flFactor);
00765                 
00766                 <span class="keywordflow">for</span>(i=0; i&lt;intpFirst; i++)                      <span class="comment">/* fill lacking area low */</span>
00767                         ucALUT[i] = 0;
00768                 <span class="keywordflow">for</span>(i=intpLast+1; i&lt;outCount; i++)      <span class="comment">/* fill lacking area high */</span>
00769                         ucALUT[i] = 0xFF;
00770 
00771                         <span class="comment">/* interpolate remaining values: */</span>
00772                 usPtr   = inCurve;
00773                 stopPtr = inCurve + inCount - 2; <span class="comment">/* stops incrementation */</span>
00774                 
00775                 <span class="keywordflow">for</span>(i=intpFirst; i&lt;=intpLast; i++)
00776                 {
00777                         target = (0x0FFFF * i + halfStep)  / (outCount - 1);
00778                         <span class="keywordflow">while</span>(*(usPtr+1) &lt; target &amp;&amp; usPtr &lt; stopPtr)
00779                                 usPtr++;                                        <span class="comment">/* find interval */</span>
00780                         
00781                         ulAux = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(usPtr - inCurve) &lt;&lt; 16) / (inCount - 1);
00782                         <span class="keywordflow">if</span>(*(usPtr+1) != *usPtr)
00783                         {
00784                                 ulAux += ((target - (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)*usPtr) &lt;&lt; 16)
00785                                           / ( (*(usPtr+1) - *usPtr) * (inCount - 1) );
00786                                 
00787                                 <span class="keywordflow">if</span>(ulAux &amp; 0x10000)   <span class="comment">/* *(usPtr+1) was required */</span>
00788                                         ulAux = 0x0FFFF;
00789                         }
00790                         
00791                         ucALUT[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)(ulAux &gt;&gt; 8);
00792                 }
00793         }
00794         <span class="keywordflow">else</span>                    <span class="comment">/* curve seems to be descending */</span>
00795         {
00796                 <span class="keywordflow">for</span>(i=1; i&lt;inCount; i++)
00797                         <span class="keywordflow">if</span>(inCurve[i-1] &lt; inCurve[i])
00798                                 inCurve[i] = inCurve[i-1];
00799                 
00800                 intpFirst = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(inCurve[inCount-1] * flFactor + 0.9999);
00801                 intpLast  = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(inCurve[0] * flFactor);
00802                 
00803                 <span class="keywordflow">for</span>(i=0; i&lt;intpFirst; i++)                      <span class="comment">/* fill lacking area low */</span>
00804                         ucALUT[i] = 0xFF;
00805                 <span class="keywordflow">for</span>(i=intpLast+1; i&lt;outCount; i++)      <span class="comment">/* fill lacking area high */</span>
00806                         ucALUT[i] = 0;
00807 
00808                         <span class="comment">/* interpolate remaining values: */</span>
00809                 usPtr   = inCurve + inCount - 1;
00810                 stopPtr = inCurve + 1;          <span class="comment">/* stops decrementation */</span>
00811                 
00812                 <span class="keywordflow">for</span>(i=intpFirst; i&lt;=intpLast; i++)
00813                 {
00814                         target = (0x0FFFF * i + halfStep)  / (outCount - 1);
00815                         <span class="keywordflow">while</span>(*(usPtr-1) &lt; target &amp;&amp; usPtr &gt; stopPtr)
00816                                 usPtr--;                                        <span class="comment">/* find interval */</span>
00817                         
00818                         ulAux = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(usPtr-1 - inCurve) &lt;&lt; 16) / (inCount - 1);
00819                         <span class="keywordflow">if</span>(*(usPtr-1) != *usPtr)
00820                         {
00821                                 ulAux += (((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)*(usPtr-1) - target) &lt;&lt; 16)
00822                                           / ( (*(usPtr-1) - *usPtr) * (inCount - 1) );
00823                                 
00824                                 <span class="keywordflow">if</span>(ulAux &amp; 0x10000)
00825                                         ulAux = 0x0FFFF;
00826                         }
00827                         
00828             ucALUT[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)(ulAux &gt;&gt; 8);
00829                 }
00830         }
00831 
00832 CleanupAndExit: 
00833         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"Fill_inverse_byte_ALUT_from_CurveTag"</span>)
00834         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>);
00835 }
00836 
00837 <span class="comment">/*   _____________________________________________________________________ */</span>
00838 <span class="keywordtype">void</span>
00839 <a class="code" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a3">Fill_inverseGamma_byte_ALUT</a> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>     *       ucALUT,
00840                                                           <span class="keywordtype">char</span>                          addrBits,
00841                                                           <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>        gamma_u8_8 )
00842 {
00843         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   i, j, outCount, step, stopit;
00844         <span class="keywordtype">long</span>                    leftVal, Diff, lAux;
00845         <a class="code" href="../../d9/d6/lh__core_2fragment_8c.html#a0">CM_Doub</a>                 invGamma, x, xFactor;
00846     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>       clipIndex;
00847 <span class="preprocessor">#ifdef DEBUG_OUTPUT</span>
00848 <span class="preprocessor"></span>        <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a11">CMError</a>                 err=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
00849 <span class="preprocessor">#endif</span>
00850 <span class="preprocessor"></span>
00851         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"Fill_inverseGamma_byte_ALUT"</span>)
00852 
00853         outCount = 0x1 &lt;&lt; addrBits;
00854         
00855         invGamma  = 256. / (CM_Doub)gamma_u8_8;
00856         clipIndex = (1 &lt;&lt; addrBits) - (1 &lt;&lt; (addrBits - 8)); <span class="comment">/* max XLUT output with 10 bit is at 1020, not at1023 */</span>
00857         xFactor   = 1. / (CM_Doub)clipIndex;
00858         
00859         if(addrBits &lt;= 6)               <span class="comment">/* up to 64 - 2 float.computations */</span>
00860                 step = 1;
00861         else
00862                 step = 0x1 &lt;&lt; (addrBits - 6);           <span class="comment">/* more would take too long */</span>
00863         
00864         ucALUT[0]          = 0;                 <span class="comment">/* these two... */</span>
00865         ucALUT[outCount-1] = 0xFF;              <span class="comment">/* ...are fixed */</span>
00866         
00867         for(i=step; i&lt;outCount-1; i+=step)
00868         {
00869                 x = (<a class="code" href="../../d9/d6/lh__core_2fragment_8c.html#a0">CM_Doub</a>)i * xFactor;
00870                 <span class="keywordflow">if</span>(x &gt; 1.)
00871                         x = 1.;         <span class="comment">/* clipping in the end of ALUT */</span>
00872                 
00873                 ucALUT[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)( pow(x,invGamma) * 255.0 + 0.5);
00874         }
00875         
00876                 <span class="comment">/*---fill intervals - except for last, which is odd:---*/</span>
00877         <span class="keywordflow">for</span>(i=0; i&lt;outCount-step; i+=step)
00878         {
00879                 leftVal = (<span class="keywordtype">long</span>)ucALUT[i];
00880                 Diff    = (<span class="keywordtype">long</span>)ucALUT[i + step] - leftVal;
00881                         
00882                 <span class="keywordflow">for</span>(j=1; j&lt;step; j++)
00883                 {
00884                         lAux = ( (Diff * j &lt;&lt; 8) / step + 128 ) &gt;&gt; 8;
00885 
00886                         ucALUT[i + j] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)(leftVal + lAux);
00887                 }
00888         }
00889         
00890                 <span class="comment">/*---fill last interval:---*/</span>
00891         i       = outCount - step;
00892         leftVal = (<span class="keywordtype">long</span>)ucALUT[i];
00893         Diff    = 0x0FF - leftVal;      <span class="comment">/* 0xFF for 1.0 */</span>
00894                 
00895         <span class="keywordflow">for</span>(j=1; j&lt;step-1; j++)         <span class="comment">/* stops here if step &lt;= 2 */</span>
00896         {
00897                 lAux = ( (Diff * j &lt;&lt; 8) / (step - 1) + 128 ) &gt;&gt; 8;
00898 
00899                 ucALUT[i + j] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)(leftVal + lAux);
00900         }
00901         
00902                 <span class="comment">/*--overwrite sensitive values depending on Gamma:--*/</span>
00903         <span class="keywordflow">if</span>(addrBits &gt; 6 &amp;&amp; invGamma &lt; 1.0)              <span class="comment">/* ...if lower part is difficult */</span>
00904         {
00905                 stopit = 0x1 &lt;&lt; (addrBits - 6);
00906                 
00907                 <span class="keywordflow">for</span>(i=1; i&lt;stopit; i++)
00908                 {
00909                         x         = (<a class="code" href="../../d9/d6/lh__core_2fragment_8c.html#a0">CM_Doub</a>)i * xFactor;
00910                         ucALUT[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)( pow(x,invGamma) * 255.0);
00911                 }
00912         }
00913         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"Fill_inverseGamma_byte_ALUT"</span>)
00914 }
00915 
00916 <span class="comment">/* ______________________________________________________________________</span>
00917 <span class="comment"></span>
00918 <span class="comment">        CMError</span>
00919 <span class="comment">        Fill_ushort_ELUTs_from_lut8Tag ( CMLutParamPtr  theLutData,</span>
00920 <span class="comment">                                                                         Ptr                    profileELuts,</span>
00921 <span class="comment">                                                                         char                   addrBits,</span>
00922 <span class="comment">                                                                         char                   usedBits,</span>
00923 <span class="comment">                                                                         long                   gridPoints )</span>
00924 <span class="comment">        Abstract:</span>
00925 <span class="comment">                extracts input luts out of CMlut8Type tag and converts them</span>
00926 <span class="comment">                to desired format: (2 ^ addrBits) values in a range from</span>
00927 <span class="comment">                0 to (2 ^ usedBits) - (gridPoints ^ 2)</span>
00928 <span class="comment"></span>
00929 <span class="comment">        Params:</span>
00930 <span class="comment">                theLutData                      (in/out)        Ptr to structure that holds all the luts...</span>
00931 <span class="comment">                profileELuts            (in)            Ptr to the profile's input luts</span>
00932 <span class="comment">                addrBits                        (in)            2 ^ addrBits values are requested</span>
00933 <span class="comment">                usedBits                        (in)            used bits in u.short</span>
00934 <span class="comment">                gridPoints                      (in)            used for interpolation</span>
00935 <span class="comment"></span>
00936 <span class="comment">        Return:</span>
00937 <span class="comment">                noErr           successful</span>
00938 <span class="comment"></span>
00939 <span class="comment">   _____________________________________________________________________ */</span>
00940 <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a11">CMError</a>
<a name="l00941"></a><a class="code" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a10">00941</a> <a class="code" href="../../d2/d7/w98_2lh__core_2fragment_8h.html#a7">Fill_ushort_ELUTs_from_lut8Tag</a> ( <a class="code" href="../../d0/d4/structCMLutParam.html">CMLutParamPtr</a>  theLutData,
00942                                                                  Ptr                    profileELuts,
00943                                                                  <span class="keywordtype">char</span>                   addrBits,
00944                                                                  <span class="keywordtype">char</span>                   usedBits,
00945                                                                  <span class="keywordtype">long</span>                   gridPoints )
00946 {
00947         <span class="keywordtype">long</span>                    i, j, maxOut;
00948         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>                   *curInLut;
00949         <a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>                  *curELUT;
00950         <span class="keywordtype">long</span>                    count, indFactor, outFactor, baseInd, fract, lAux, diff;
00951         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a1">LUT_DATA_TYPE</a>   localElut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
00952         <a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>                  *localElutPtr;
00953         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a35">OSErr</a>                   err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
00954         <span class="keywordtype">long</span>                    theElutSize;
00955         
00956         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"Fill_ushort_ELUTs_from_lut8Tag"</span>)
00957         
00958         count       = 1 &lt;&lt; addrBits;
00959         theElutSize = theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o6">colorLutInDim</a> * count * <span class="keyword">sizeof</span> (<a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>);
00960         localElut   = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a8">ALLOC_DATA</a>(theElutSize + 2, &amp;err);
00961         <span class="keywordflow">if</span> (err)
00962                 <span class="keywordflow">goto</span> CleanupAndExit;
00963         
00964         indFactor = (255 &lt;&lt; 12) / (count - 1);  <span class="comment">/* for adjusting indices */</span>
00965         
00966         <span class="keywordflow">if</span>(gridPoints == 0)
00967                 maxOut = 65535;
00968         <span class="keywordflow">else</span>
00969                 maxOut = ((1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a> &lt;&lt; (usedBits - 8) ) * 256 * (gridPoints - 1)) / gridPoints;
00970         outFactor = (maxOut &lt;&lt; 12) / 255;                       <span class="comment">/* 255 is max. value from mft1 output lut */</span>
00971         
00972         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a6">LOCK_DATA</a>(localElut);
00973         localElutPtr = (<a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>*)<a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a3">DATA_2_PTR</a>(localElut);
00974         <span class="keywordflow">for</span>(i=0; i&lt;theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o6">colorLutInDim</a>; i++)
00975         {
00976                 curInLut = (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>*)profileELuts + (i &lt;&lt; 8);
00977                 curELUT  = localElutPtr + i * count;
00978                 
00979                 <span class="keywordflow">for</span>(j=0; j&lt;count; j++)
00980                 {
00981                         lAux    = j * indFactor;
00982                         baseInd = lAux &gt;&gt; 12;
00983                         fract   = (lAux &amp; 0x0FFF) &gt;&gt; 4; <span class="comment">/* leaves 8 bits for interpolation as with distortion */</span>
00984 
00985                         <span class="keywordflow">if</span>(fract &amp;&amp; baseInd != 255)             <span class="comment">/* interpolation necessary ? */</span>
00986                         {
00987                                 lAux = (<span class="keywordtype">long</span>)curInLut[baseInd] * outFactor &gt;&gt; 6;
00988                                 
00989                                 diff = (<span class="keywordtype">long</span>)curInLut[baseInd+1] - (<span class="keywordtype">long</span>)curInLut[baseInd];
00990                                 diff = (diff * outFactor &gt;&gt; 6) * fract &gt;&gt; 8;
00991 
00992                                 curELUT[j] = (<a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>)( (lAux + diff + 32) &gt;&gt; 6 );
00993                         }
00994                         <span class="keywordflow">else</span>
00995                                 curELUT[j] = (<a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>)( ((<span class="keywordtype">long</span>)curInLut[baseInd]
00996                                                                                                         * outFactor + 0x0800) &gt;&gt; 12 );
00997                 }
00998         }
00999         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a7">UNLOCK_DATA</a>(localElut);
01000         theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o2">inputLut</a> = localElut;
01001         localElut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01002 CleanupAndExit:
01003         localElut = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a10">DISPOSE_IF_DATA</a>(localElut);
01004         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"Fill_ushort_ELUTs_from_lut8Tag"</span>)
01005         <span class="keywordflow">return</span> err;
01006 }
01007 
01008 <span class="comment">/* ______________________________________________________________________</span>
01009 <span class="comment"></span>
01010 <span class="comment">        CMError</span>
01011 <span class="comment">        Fill_byte_ALUTs_from_lut8Tag( CMLutParamPtr     theLutData,</span>
01012 <span class="comment">                                                                  Ptr                   profileALuts,</span>
01013 <span class="comment">                                                                  char                  addrBits )</span>
01014 <span class="comment">        Abstract:</span>
01015 <span class="comment">                extracts output luts out of CMLut8Type tag and converts them</span>
01016 <span class="comment">                to desired format: (2 ^ addrBits) values in a range from 0 to 255</span>
01017 <span class="comment"></span>
01018 <span class="comment">        Params:</span>
01019 <span class="comment">                theLutData                      (in/out)        Ptr to structure that holds all the luts...</span>
01020 <span class="comment">                profileALuts            (in)            Ptr to the profile's output luts</span>
01021 <span class="comment">                addrBits                        (in)            2 ^ addrBits values are requested</span>
01022 <span class="comment">                </span>
01023 <span class="comment">        Return:</span>
01024 <span class="comment">                noErr           successful</span>
01025 <span class="comment"></span>
01026 <span class="comment">   _____________________________________________________________________ */</span>
01027 <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a11">CMError</a>
<a name="l01028"></a><a class="code" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a11">01028</a> <a class="code" href="../../d2/d7/w98_2lh__core_2fragment_8h.html#a8">Fill_byte_ALUTs_from_lut8Tag</a>( <a class="code" href="../../d0/d4/structCMLutParam.html">CMLutParamPtr</a>     theLutData,
01029                                                           Ptr                   profileALuts,
01030                                                           <span class="keywordtype">char</span>                  addrBits )
01031 {
01032         <span class="keywordtype">long</span>                    i, j;
01033         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>                   *curOutLut;
01034         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>                   *profAluts = (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>*)profileALuts;
01035         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>                   *curALUT;
01036         <span class="keywordtype">long</span>                    count, clipIndex;
01037         <span class="keywordtype">long</span>                    factor, fract, baseInd, lAux;
01038         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a35">OSErr</a>                   err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
01039         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a1">LUT_DATA_TYPE</a>   localAlut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01040         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>                   *localAlutPtr;
01041         <span class="keywordtype">long</span>                    theAlutSize;
01042         
01043         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"Fill_byte_ALUTs_from_lut8Tag"</span>)
01044 
01045         count     = 1 &lt;&lt; addrBits;                                                              <span class="comment">/* addrBits is always &gt;= 8 */</span>
01046         clipIndex = (1 &lt;&lt; addrBits) - (1 &lt;&lt; (addrBits - 8));    <span class="comment">/* max XLUT output with 10 bit is at 1020, not at1023 */</span>
01047         
01048         theAlutSize = theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o7">colorLutOutDim</a> * count;
01049         localAlut   = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a8">ALLOC_DATA</a>(theAlutSize + 1, &amp;err);
01050         <span class="keywordflow">if</span> (err)
01051                 <span class="keywordflow">goto</span> CleanupAndExit;
01052         
01053         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a6">LOCK_DATA</a>(localAlut);
01054         localAlutPtr = (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>*)<a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a3">DATA_2_PTR</a>(localAlut);
01055         
01056         factor = (255 &lt;&lt; 12) / clipIndex;               <span class="comment">/* for adjusting the indices */</span>
01057         
01058         <span class="keywordflow">for</span>(i=0; i&lt;theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o7">colorLutOutDim</a>; i++)
01059         {
01060                 curOutLut = profAluts + (i &lt;&lt; 8);
01061                 curALUT   = localAlutPtr + i * count;
01062                 
01063                 <span class="keywordflow">for</span>(j=0; j&lt;=clipIndex; j++)
01064                 {
01065                         lAux    = j * factor;
01066                         baseInd = lAux &gt;&gt; 12;
01067                         fract   = lAux &amp; 0x0FFF;
01068                         
01069                         <span class="keywordflow">if</span>(fract)
01070                         {
01071                                 lAux = (<span class="keywordtype">long</span>)curOutLut[baseInd + 1] - (<span class="keywordtype">long</span>)curOutLut[baseInd];
01072                                 lAux = (lAux * fract + 0x0800) &gt;&gt; 12;
01073                                 
01074                                 curALUT[j] = (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>)((<span class="keywordtype">long</span>)curOutLut[baseInd] + lAux);
01075                         }
01076                         <span class="keywordflow">else</span>
01077                                 curALUT[j] = curOutLut[baseInd];
01078                 }
01079                 
01080                 <span class="keywordflow">for</span>(j=clipIndex+1; j&lt;count; j++)                <span class="comment">/* unused indices, clip these */</span>
01081                         curALUT[j] = curALUT[clipIndex];
01082         }
01083         
01084         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a7">UNLOCK_DATA</a>(localAlut);
01085         theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o5">outputLut</a> = localAlut;
01086         localAlut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01087 CleanupAndExit:
01088         localAlut = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a10">DISPOSE_IF_DATA</a>(localAlut);
01089         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"Fill_byte_ALUTs_from_lut8Tag"</span>)
01090         <span class="keywordflow">return</span> err;
01091 }
01092 
01093 <span class="comment">/* ______________________________________________________________________</span>
01094 <span class="comment"></span>
01095 <span class="comment">        CMError</span>
01096 <span class="comment">        Fill_ushort_ELUTs_from_lut16Tag( CMLutParamPtr  theLutData,</span>
01097 <span class="comment">                                                                         Ptr                    profileELuts,</span>
01098 <span class="comment">                                                                         char                   addrBits,</span>
01099 <span class="comment">                                                                         char                   usedBits,</span>
01100 <span class="comment">                                                                         long                   gridPoints,</span>
01101 <span class="comment">                                                                         long                   inputTableEntries )</span>
01102 <span class="comment"></span>
01103 <span class="comment">        Abstract:</span>
01104 <span class="comment">                extracts input luts out of CMLut16Type tag and converts them</span>
01105 <span class="comment">                to desired format: (2 ^ addrBits) values in a range from</span>
01106 <span class="comment">                0 to (2 ^ usedBits) - (gridPoints ^ 2)</span>
01107 <span class="comment"></span>
01108 <span class="comment">        Params:</span>
01109 <span class="comment">                theLutData                      (in/out)        Ptr to structure that holds all the luts...</span>
01110 <span class="comment">                profileELuts            (in)            Ptr to the profile's input luts</span>
01111 <span class="comment">                addrBits                        (in)            2 ^ addrBits values are requested</span>
01112 <span class="comment">                usedBits                        (in)            used bits in u.short</span>
01113 <span class="comment">                gridPoints                      (in)            used for interpolation</span>
01114 <span class="comment">                inputTableEntries       (in)            number of entries in the input lut (up to 4096)</span>
01115 <span class="comment"></span>
01116 <span class="comment">        Return:</span>
01117 <span class="comment">                noErr           successful</span>
01118 <span class="comment"></span>
01119 <span class="comment">   _____________________________________________________________________ */</span>
01120 <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a11">CMError</a>
<a name="l01121"></a><a class="code" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a12">01121</a> <a class="code" href="../../d2/d7/w98_2lh__core_2fragment_8h.html#a10">Fill_ushort_ELUTs_from_lut16Tag</a>( <a class="code" href="../../d0/d4/structCMLutParam.html">CMLutParamPtr</a>  theLutData,
01122                                                                  Ptr                    profileELuts,
01123                                                                  <span class="keywordtype">char</span>                   addrBits,
01124                                                                  <span class="keywordtype">char</span>                   usedBits,
01125                                                                  <span class="keywordtype">long</span>                   gridPoints,
01126                                                                  <span class="keywordtype">long</span>                   inputTableEntries )
01127 {
01128         <span class="keywordtype">long</span>                    i, j, inTabLen, maxOut;
01129         <a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>                  *curInLut;
01130         <a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>                  *curELUT;
01131         <a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>                  *profELUT = (<a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>*)profileELuts;
01132         <span class="keywordtype">long</span>                    count, outFactor, fract, lAux, diff;
01133         <span class="keywordtype">long</span>                    baseInd, indFactor;
01134         <span class="keywordtype">long</span>                    outRound, outShift, interpRound, interpShift;
01135         <span class="keywordtype">double</span>                  dFactor;
01136         <span class="keywordtype">long</span>                    theElutSize;
01137         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a1">LUT_DATA_TYPE</a>   localElut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01138         <a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>                  *localElutPtr;
01139         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a35">OSErr</a>                   err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
01140 
01141         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"Fill_ushort_ELUTs_from_lut16Tag"</span>)
01142         
01143         count     = 1 &lt;&lt; addrBits;
01144         inTabLen  = inputTableEntries;
01145 
01146         theElutSize = theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o6">colorLutInDim</a> * count * <span class="keyword">sizeof</span> (<a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>);
01147         localElut   = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a8">ALLOC_DATA</a>(theElutSize + 2, &amp;err);
01148         <span class="keywordflow">if</span>(err)
01149                 <span class="keywordflow">goto</span> CleanupAndExit;
01150         
01151         indFactor = ((inTabLen - 1) &lt;&lt; 18) / (count - 1);       <span class="comment">/* for adjusting indices */</span>
01152 
01153         <span class="keywordflow">if</span>(gridPoints == 0)
01154                 maxOut = 65535;
01155         <span class="keywordflow">else</span>
01156                 maxOut = ((1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a> &lt;&lt; (usedBits - 8) ) * 256 * (gridPoints - 1)) / gridPoints;
01157 
01158                 <span class="comment">/*-----find factor for the values that fits in 15 bits------*/</span>
01159                 <span class="comment">/* (product with 16 bit number must fit in 31 bit uns.long)     */</span>
01160                 <span class="comment">/* n.b: 512 &lt;= maxOut &lt;= 65535  in all possible cases           */</span>
01161         
01162         dFactor  = (<span class="keywordtype">double</span>)maxOut / 65535.;             <span class="comment">/* 65535 is max. curve value */</span>
01163         dFactor *= 4194304.;                                    <span class="comment">/* same as &lt;&lt; 22, certainly too much */</span>
01164         
01165         outFactor = (<span class="keywordtype">long</span>)dFactor;
01166         outRound  = (1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a> &lt;&lt; 21) - 1;
01167         outShift  = 22;
01168         <span class="keywordflow">while</span>(outFactor &amp; 0xFFF8000)    <span class="comment">/* stay within 15 bits to prevent product overflow */</span>
01169         {
01170                 outFactor &gt;&gt;= 1;
01171                 outRound  &gt;&gt;= 1;
01172                 outShift   -= 1;
01173         }
01174         
01175         interpRound = outRound &gt;&gt; 1;    <span class="comment">/* with interpolation we have an additional...  */</span>
01176         interpShift = outShift  - 1;    <span class="comment">/* ... &gt;&gt; 1 because we must add two nunmbers    */</span>
01177         
01178         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a6">LOCK_DATA</a>(localElut);
01179         localElutPtr = (<a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>*)<a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a3">DATA_2_PTR</a>(localElut);
01180 
01181         <span class="keywordflow">for</span>(i=0; i&lt;theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o6">colorLutInDim</a>; i++)
01182         {
01183                 curInLut = profELUT + (i * inTabLen);
01184                 curELUT  = localElutPtr + (i * count);
01185 
01186                 <span class="keywordflow">for</span>(j=0; j&lt;count; j++)
01187                 {
01188                         lAux    = (j * indFactor+4) &gt;&gt; 3;
01189                         baseInd = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)lAux &gt;&gt; 15;
01190                         fract   = lAux &amp; 0x7FFF;        <span class="comment">/* 15 bits for interpolation */</span>
01191 
01192                         <span class="keywordflow">if</span>(fract)               <span class="comment">/* interpolation necessary ? */</span>
01193                         {
01194                                 lAux = (<span class="keywordtype">long</span>)curInLut[baseInd] * outFactor &gt;&gt; 1;
01195                                 
01196                                 diff = (<span class="keywordtype">long</span>)curInLut[baseInd+1] - (<span class="keywordtype">long</span>)curInLut[baseInd];
01197                                 diff = ((diff * outFactor &gt;&gt; 15) * fract) &gt;&gt; 1;
01198 
01199                                 curELUT[j] = (<a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>)( (lAux + diff + interpRound) &gt;&gt; interpShift );
01200                         }
01201                         <span class="keywordflow">else</span>
01202                                 curELUT[j] = (<a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>)( ((<span class="keywordtype">long</span>)curInLut[baseInd] * outFactor
01203                                                                                                         + outRound) &gt;&gt; outShift );
01204                 }
01205         }
01206         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a7">UNLOCK_DATA</a>(localElut);
01207         theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o2">inputLut</a> = localElut;
01208         localElut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01209 CleanupAndExit: 
01210         localElut = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a10">DISPOSE_IF_DATA</a>(localElut); 
01211         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"Fill_ushort_ELUTs_from_lut16Tag"</span>)
01212         <span class="keywordflow">return</span> err;
01213 }
01214 
01215 <span class="comment">/* ______________________________________________________________________</span>
01216 <span class="comment"></span>
01217 <span class="comment">        CMError</span>
01218 <span class="comment">        Fill_byte_ALUTs_from_lut16Tag(  CMLutParamPtr   theLutData,</span>
01219 <span class="comment">                                                                        Ptr                             profileALuts,</span>
01220 <span class="comment">                                                                        char                    addrBits,</span>
01221 <span class="comment">                                                                    long                        outputTableEntries )</span>
01222 <span class="comment">        Abstract:</span>
01223 <span class="comment">                extracts output luts out of CMLut16Type tag and converts them</span>
01224 <span class="comment">                to desired format: (2 ^ addrBits) values in a range from 0 to 255</span>
01225 <span class="comment"></span>
01226 <span class="comment">        Params:</span>
01227 <span class="comment">                theLutData                      (in/out)        Ptr to structure that holds all the luts...</span>
01228 <span class="comment">                profileALuts            (in)            Ptr to the profile's output luts</span>
01229 <span class="comment">                addrBits                        (in)            2 ^ addrBits values are requested</span>
01230 <span class="comment">                outputTableEntries      (in)            number of entries in the output lut (up to 4096)</span>
01231 <span class="comment">                </span>
01232 <span class="comment">        Return:</span>
01233 <span class="comment">                noErr           successful</span>
01234 <span class="comment"></span>
01235 <span class="comment">   _____________________________________________________________________ */</span>
01236 <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a11">CMError</a>
<a name="l01237"></a><a class="code" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a13">01237</a> <a class="code" href="../../d2/d7/w98_2lh__core_2fragment_8h.html#a11">Fill_byte_ALUTs_from_lut16Tag</a>(  <a class="code" href="../../d0/d4/structCMLutParam.html">CMLutParamPtr</a>   theLutData,
01238                                                                 Ptr                             profileALuts,
01239                                                                 <span class="keywordtype">char</span>                    addrBits,
01240                                                             <span class="keywordtype">long</span>                        outputTableEntries )
01241 {
01242         <span class="keywordtype">long</span>                    i, j;
01243         <a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>                  *curOutLut;
01244         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>                   *curALUT;
01245         <span class="keywordtype">long</span>                    count, clipIndex, outTabLen;
01246         <span class="keywordtype">long</span>                    indFactor, fract, baseInd, lAux;
01247         <a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>                  *profALUTs = (<a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a>*)profileALuts;
01248         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a35">OSErr</a>                   err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
01249         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a1">LUT_DATA_TYPE</a>   localAlut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01250         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>                   *localAlutPtr;
01251         <span class="keywordtype">long</span>                    theAlutSize;
01252         
01253         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"Fill_byte_ALUTs_from_lut16Tag"</span>)
01254         
01255         count     = 1 &lt;&lt; addrBits;                                                              <span class="comment">/* addrBits is always &gt;= 8 */</span>
01256         clipIndex = (1 &lt;&lt; addrBits) - (1 &lt;&lt; (addrBits - 8));    <span class="comment">/* max XLUT output with 10 bit is at 1020, not at1023 */</span>
01257 
01258         theAlutSize = theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o7">colorLutOutDim</a> * count;
01259         localAlut   = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a8">ALLOC_DATA</a>(theAlutSize + 1, &amp;err);
01260         <span class="keywordflow">if</span> (err)
01261                 <span class="keywordflow">goto</span> CleanupAndExit;
01262         
01263         outTabLen = outputTableEntries;                                 <span class="comment">/* &lt;= 4096 */</span>
01264         indFactor = ((outTabLen - 1) &lt;&lt; 18) / clipIndex;        <span class="comment">/* for adjusting the indices */</span>
01265         
01266         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a6">LOCK_DATA</a>(localAlut);
01267         localAlutPtr = (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>*)<a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a3">DATA_2_PTR</a>(localAlut);
01268         
01269         <span class="keywordflow">for</span>(i=0; i&lt;theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o7">colorLutOutDim</a>; i++)
01270         {
01271                 curOutLut = profALUTs + i * outTabLen;
01272                 curALUT   = localAlutPtr + i * count;
01273                 
01274                 <span class="keywordflow">for</span>(j=0; j&lt;=clipIndex; j++)
01275                 {
01276                         lAux    = (j * indFactor+32) &gt;&gt; 6;
01277                         baseInd = lAux &gt;&gt; 12;
01278                         fract   = lAux &amp; 0x0FFF;
01279                         
01280                         <span class="keywordflow">if</span>(fract)
01281                         {
01282                                 lAux = (<span class="keywordtype">long</span>)curOutLut[baseInd + 1] - (<span class="keywordtype">long</span>)curOutLut[baseInd];
01283                                 lAux = (lAux * fract + 0x0800) &gt;&gt; 12;
01284                                 
01285                                 curALUT[j] = (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a6">UINT8</a>)(((<span class="keywordtype">long</span>)curOutLut[baseInd] + lAux) &gt;&gt; 8);
01286                         }
01287                         <span class="keywordflow">else</span>
01288                                 curALUT[j] = curOutLut[baseInd] &gt;&gt; 8;
01289                 }
01290                 
01291                 <span class="keywordflow">for</span>(j=clipIndex+1; j&lt;count; j++)                <span class="comment">/* unused indices, clip these */</span>
01292                         curALUT[j] = curALUT[clipIndex];
01293         }
01294         
01295         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a7">UNLOCK_DATA</a>(localAlut);
01296         theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o5">outputLut</a> = localAlut;
01297         localAlut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01298 CleanupAndExit:
01299         localAlut = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a10">DISPOSE_IF_DATA</a>(localAlut);
01300         
01301         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"Fill_byte_ALUTs_from_lut16Tag"</span>)
01302         <span class="keywordflow">return</span> err;
01303 }
01304 
01305 <span class="comment">/* ______________________________________________________________________</span>
01306 <span class="comment"></span>
01307 <span class="comment">        CMError</span>
01308 <span class="comment">                MakeGamut16or32ForMonitor(      icXYZType               *pRedXYZ,</span>
01309 <span class="comment">                                                                        icXYZType               *pGreenXYZ,</span>
01310 <span class="comment">                                                                        icXYZType               *pBlueXYZ,</span>
01311 <span class="comment">                                                                        unsigned short  **ppELUTs,</span>
01312 <span class="comment">                                   UINT8                        **ppXLUT,</span>
01313 <span class="comment">                                   UINT8                        **ppALUT,</span>
01314 <span class="comment">                                                                        Boolean                 cube32Flag )</span>
01315 <span class="comment">        Abstract:</span>
01316 <span class="comment">                Computes 3 ELUTs, XLUT and ALUT for gamut checking out of the</span>
01317 <span class="comment">                3 monitor primaries. Color space is XYZ</span>
01318 <span class="comment">                NOTE: Memory for the ELUTs, XLUt and ALUT is allocated here !</span>
01319 <span class="comment"></span>
01320 <span class="comment">        Params:</span>
01321 <span class="comment">                pRedXYZ                 (in)            -&gt; red primary of monitor</span>
01322 <span class="comment">                pGreenXYZ               (in)            -&gt; green primary of monitor</span>
01323 <span class="comment">                pBlueXYZ                (in)            -&gt; blue primary of monitor</span>
01324 <span class="comment">                ppELUTs                 (out)           3 input LUTs</span>
01325 <span class="comment">                ppXLUT                  (out)           3 dimensional byte Lut (32^3)</span>
01326 <span class="comment">                ppALUT                  (out)           Boolean output LUT (1024 bytes)</span>
01327 <span class="comment">        cube32Flag              (in)            TRUE: 32*32*32 points, FALSE: 16*16*16 points</span>
01328 <span class="comment">                </span>
01329 <span class="comment">        Return:</span>
01330 <span class="comment">                noErr           successful</span>
01331 <span class="comment"></span>
01332 <span class="comment">   _____________________________________________________________________ */</span>
01333 
<a name="l01334"></a><a class="code" href="../../d0/d7/w98_2lh__core_2fragment_8c.html#a14">01334</a> <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a11">CMError</a> <a class="code" href="../../d2/d7/w98_2lh__core_2fragment_8h.html#a13">MakeGamut16or32ForMonitor</a>       (       <a class="code" href="../../d9/d6/structicXYZType.html">icXYZType</a>               *pRedXYZ,
01335                                                                                 <a class="code" href="../../d9/d6/structicXYZType.html">icXYZType</a>               *pGreenXYZ,
01336                                                                                 <a class="code" href="../../d9/d6/structicXYZType.html">icXYZType</a>               *pBlueXYZ,
01337                                                                                 <a class="code" href="../../d0/d4/structCMLutParam.html">CMLutParamPtr</a>   theLutData,
01338                                                                                 Boolean                 cube32Flag )
01339 
01340 {
01341         <span class="keywordtype">double</span>                  XYZmatrix[3][3], RGBmatrix[3][3];
01342         <span class="keywordtype">double</span>                  sum, dFactor;
01343         <span class="keywordtype">long</span>                    i, j, k, gridPoints, planeCount, totalCount, longMat[9];
01344         <span class="keywordtype">long</span>                    longX, longY, longZ, longR, longG, longB;
01345         <span class="keywordtype">long</span>                    *lPtr, lFactor, maxOut;
01346         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  *usPtr;
01347         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>   *XPtr;
01348         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a1">LUT_DATA_TYPE</a>   tempXLutHdl     = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01349         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a1">LUT_DATA_TYPE</a>   tempELutHdl     = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01350         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a1">LUT_DATA_TYPE</a>   tempALutHdl     = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01351         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>   *tempXLut       = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01352         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>   *tempALut       = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01353         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  *tempELut       = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01354         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  Levels[32];
01355         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a35">OSErr</a>                   err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
01356         
01357         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"MakeGamut16or32ForMonitor"</span>)
01358         
01359         <span class="keywordflow">if</span>(theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o2">inputLut</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a> || theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o10">colorLut</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a> || theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o5">outputLut</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>)
01360         {
01361                 err = <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a149a30">cmparamErr</a>;
01362                 <span class="keywordflow">goto</span> CleanupAndExit;
01363         }
01364         
01365         <span class="comment">/*----------------------------------------------------------------------------------------- E */</span>
01366         tempELutHdl = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a8">ALLOC_DATA</a>(256 * 3 * <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>), &amp;err);
01367         <span class="keywordflow">if</span>(err)
01368                 <span class="keywordflow">goto</span> CleanupAndExit;
01369         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a6">LOCK_DATA</a>(tempELutHdl);
01370         tempELut = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)<a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a3">DATA_2_PTR</a>(tempELutHdl);
01371 
01372         <span class="comment">/*----------------------------------------------------------------------------------------- X */</span>
01373         <span class="keywordflow">if</span>(cube32Flag)
01374                 gridPoints = 32;                        <span class="comment">/* for cube grid */</span>
01375         <span class="keywordflow">else</span>
01376                 gridPoints = 16;
01377         totalCount = gridPoints * gridPoints * gridPoints;
01378 
01379         tempXLutHdl = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a8">ALLOC_DATA</a>(totalCount, &amp;err);
01380         <span class="keywordflow">if</span>(err)
01381                 <span class="keywordflow">goto</span> CleanupAndExit;
01382         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a6">LOCK_DATA</a>(tempXLutHdl);
01383         tempXLut = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a3">DATA_2_PTR</a>(tempXLutHdl);
01384         
01385         <span class="comment">/*----------------------------------------------------------------------------------------- A */</span>
01386         tempALutHdl = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a8">ALLOC_DATA</a>(<a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a21">adr_bereich_alut</a>, &amp;err);
01387         <span class="keywordflow">if</span>(err)
01388                 <span class="keywordflow">goto</span> CleanupAndExit;
01389         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a6">LOCK_DATA</a>(tempALutHdl);
01390         tempALut = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a3">DATA_2_PTR</a>(tempALutHdl);
01391         
01392                 <span class="comment">/*---------fill 3 ELUTs for X, Y, Z (256 u.shorts each):--------------------*/</span>
01393                 <span class="comment">/* linear curve with clipping, slope makes white value  become                          */</span>
01394                 <span class="comment">/* max * 30.5/31 or max * 14.5/15, that is half of the last XLUT interval       */</span>
01395         <span class="keywordflow">if</span>(cube32Flag)
01396                 dFactor = 30.5 / 31.;
01397         <span class="keywordflow">else</span>
01398                 dFactor = 14.5 / 15.;
01399         
01400         maxOut = ((1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a> &lt;&lt; (16 <span class="comment">/*usedBits*/</span> - 8) ) * 256 * (gridPoints - 1)) / gridPoints;
01401         
01402         <span class="keywordflow">for</span>(i=0; i&lt;3; i++)              <span class="comment">/* X, Y, Z ELUTs */</span>
01403         {
01404                 <span class="keywordflow">if</span>(i == 0)
01405                         lFactor = (<span class="keywordtype">long</span>)( dFactor * 2. * maxOut * 256. / 255. / 0.9642 );<span class="comment">/* X, adjust D50 */</span>
01406                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(i == 1)
01407                         lFactor = (<span class="keywordtype">long</span>)( dFactor * 2. * maxOut * 256. / 255.);                 <span class="comment">/* Y */</span>
01408                 <span class="keywordflow">else</span>
01409                         lFactor = (<span class="keywordtype">long</span>)( dFactor * 2. * maxOut * 256. / 255. / 0.8249);<span class="comment">/* Z, adjust D50 */</span>
01410                 
01411                 usPtr = tempELut + 256 * i;
01412                 <span class="keywordflow">for</span>(j=0; j&lt;256; j++)
01413                 {
01414                         k = (j * lFactor + 127) &gt;&gt; 8;
01415                         <span class="keywordflow">if</span>(k &gt; maxOut)
01416                                 k = maxOut;             <span class="comment">/* max. ELUT value */</span>
01417                         
01418                         *usPtr++ = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)k;
01419                 }
01420         }
01421 
01422                 <span class="comment">/*------ RGB to XYZ matrix in the range 0.0 to 1.0 -----*/</span>
01423                 <span class="comment">/* floating point for accurate inversion                                */</span>
01424         XYZmatrix[0][0] = (<span class="keywordtype">double</span>)pRedXYZ-&gt;<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o0">X</a>;
01425         XYZmatrix[1][0] = (<span class="keywordtype">double</span>)pRedXYZ-&gt;<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o1">Y</a>;
01426         XYZmatrix[2][0] = (<span class="keywordtype">double</span>)pRedXYZ-&gt;<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o2">Z</a>;
01427 
01428         XYZmatrix[0][1] = (<span class="keywordtype">double</span>)pGreenXYZ-&gt;<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o0">X</a>;
01429         XYZmatrix[1][1] = (<span class="keywordtype">double</span>)pGreenXYZ-&gt;<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o1">Y</a>;
01430         XYZmatrix[2][1] = (<span class="keywordtype">double</span>)pGreenXYZ-&gt;<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o2">Z</a>;
01431 
01432         XYZmatrix[0][2] = (<span class="keywordtype">double</span>)pBlueXYZ-&gt;<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o0">X</a>;
01433         XYZmatrix[1][2] = (<span class="keywordtype">double</span>)pBlueXYZ-&gt;<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o1">Y</a>;
01434         XYZmatrix[2][2] = (<span class="keywordtype">double</span>)pBlueXYZ-&gt;<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0].<a class="code" href="../../d8/d6/structicXYZNumber.html#o2">Z</a>;
01435         
01436                 <span class="comment">/*--- grey with R = G = B (D50 adjustment is done by the ELUTs) ----*/</span>
01437         <span class="keywordflow">for</span>(i=0; i&lt;3; i++)
01438         {
01439                 sum = XYZmatrix[i][0] + XYZmatrix[i][1] + XYZmatrix[i][2];
01440                 <span class="keywordflow">if</span>(sum &lt; 0.1)
01441                         sum = 0.1;      <span class="comment">/* prevent from div. by 0 (bad profiles) */</span>
01442                 
01443                 <span class="keywordflow">for</span>(j=0; j&lt;3; j++)
01444                         XYZmatrix[i][j] /= sum;
01445         }
01446         
01447                 <span class="comment">/*---XYZ to RGB matrix:---*/</span>
01448         <span class="keywordflow">if</span>(!<a class="code" href="../../d1/d6/w98_2lh__core_2memlink_8c.html#a24">doubMatrixInvert</a>(XYZmatrix, RGBmatrix))
01449         {
01450                 err = <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a149a30">cmparamErr</a>;
01451                 <span class="keywordflow">goto</span> CleanupAndExit;
01452         }
01453         
01454         <span class="keywordflow">for</span>(i=0; i&lt;3; i++)                              <span class="comment">/* create integer format for speed, */</span>
01455                 <span class="keywordflow">for</span>(j=0; j&lt;3; j++)                      <span class="comment">/* 1.0 becomes 2^13, works for coeff. up to 8. */</span>
01456                         longMat[3*i + j] = (<span class="keywordtype">long</span>)(RGBmatrix[i][j] * 8192.);
01457         
01458                 <span class="comment">/*-----grid levels for cube grid in XYZ (16 bit) so ----*/</span>
01459                 <span class="comment">/* that white is at half of last interval, so the last  */</span>
01460                 <span class="comment">/* value is white * 15/14.5 or white * 31/30.5                  */</span>
01461         <span class="keywordflow">if</span>(cube32Flag)
01462                 dFactor = 32768. / 30.5 * 31. / (gridPoints - 1);
01463         <span class="keywordflow">else</span>
01464                 dFactor = 32768. / 14.5 * 15. / (gridPoints - 1);
01465 
01466         <span class="keywordflow">for</span>(i=0; i&lt;gridPoints; i++)                     <span class="comment">/* n.b: 32 is max. possible gridPoints */</span>
01467                 Levels[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)(i * dFactor + 0.5);
01468         
01469                 <span class="comment">/*----special treatment of first and last plane for speed:----*/</span>
01470         planeCount = gridPoints * gridPoints;
01471         XPtr       = tempXLut;
01472         <span class="keywordflow">for</span>(i=0; i&lt;planeCount; i++)
01473                 *XPtr++ = 255;          <span class="comment">/* out of gamut */</span>
01474         
01475         XPtr = tempXLut + (gridPoints - 1) * planeCount;
01476         <span class="keywordflow">for</span>(i=0; i&lt;planeCount; i++)
01477                 *XPtr++ = 255;          <span class="comment">/* out of gamut */</span>
01478         
01479         *tempXLut = 0;  <span class="comment">/* set black (white is between last 2 planes) */</span>
01480 
01481                 <span class="comment">/*----second to second last plane must be computed:-----*/</span>
01482                 <span class="comment">/*  transform points to RGB and judge in/out                    */</span>
01483         XPtr = tempXLut + planeCount;
01484                 
01485         <span class="keywordflow">for</span>(i=1; i&lt;gridPoints-1; i++)
01486                 <span class="keywordflow">for</span>(j=0; j&lt;gridPoints; j++)
01487                         <span class="keywordflow">for</span>(k=0; k&lt;gridPoints; k++)
01488                         {
01489                                 longX = (<span class="keywordtype">long</span>)Levels[i];                <span class="comment">/* X */</span>
01490                                 longY = (<span class="keywordtype">long</span>)Levels[j];                <span class="comment">/* Y */</span>
01491                                 longZ = (<span class="keywordtype">long</span>)Levels[k];                <span class="comment">/* Z */</span>
01492                                 
01493                                         <span class="comment">/* matrix coeff: 2^13 is 1.0 , XYZ values: 1.0 or 100. is 2^15 ;        */</span>
01494                                         <span class="comment">/* -&gt; mask for products &lt; 0 and &gt;= 2^28 is used for in/out checking     */</span>
01495                                 
01496                                 longR = longX * longMat[0] + longY * longMat[1] + longZ * longMat[2];
01497                                 <span class="keywordflow">if</span>(longR &amp; 0xF0000000)
01498                                         *XPtr++ = 255;          <span class="comment">/* out of gamut */</span>
01499                                 <span class="keywordflow">else</span>
01500                                 {
01501                                         longG = longX * longMat[3] + longY * longMat[4] + longZ * longMat[5];
01502                                         <span class="keywordflow">if</span>(longG &amp; 0xF0000000)
01503                                                 *XPtr++ = 255;          <span class="comment">/* out of gamut */</span>
01504                                         <span class="keywordflow">else</span>
01505                                         {
01506                                                 longB = longX * longMat[6] + longY * longMat[7] + longZ * longMat[8];
01507                                                 <span class="keywordflow">if</span>(longB &amp; 0xF0000000)
01508                                                         *XPtr++ = 255;          <span class="comment">/* out of gamut */</span>
01509                                                 <span class="keywordflow">else</span>
01510                                                         *XPtr++ = 0;            <span class="comment">/* in gamut */</span>
01511                                         }
01512                                 }
01513                         }
01514         
01515                 <span class="comment">/*---fill Boolean output LUT, adr_bereich_alut Bytes, 4 at one time with long:---*/</span>
01516         lPtr = (<span class="keywordtype">long</span> *)(tempALut);
01517         j = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a21">adr_bereich_alut</a>/4/2 + 8;   <span class="comment">/* slightly more than 50 % */</span>
01518         <span class="keywordflow">for</span>(i=0; i&lt;j; i++)                              <span class="comment">/* slightly more than 50 % */</span>
01519                 *(lPtr + i) = 0;                        <span class="comment">/* in gamut */</span>
01520         k = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a21">adr_bereich_alut</a>/4;
01521         <span class="keywordflow">for</span>(i=j; i&lt;k; i++)
01522                 *(lPtr + i) = 0xFFFFFFFF;       <span class="comment">/* out of gamut */</span>
01523         
01524         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a7">UNLOCK_DATA</a>(tempELutHdl);
01525         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a7">UNLOCK_DATA</a>(tempXLutHdl);
01526         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a7">UNLOCK_DATA</a>(tempALutHdl);
01527         theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o10">colorLut</a>    = tempXLutHdl;  tempXLutHdl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01528         theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o2">inputLut</a>    = tempELutHdl;  tempELutHdl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01529         theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o5">outputLut</a>   = tempALutHdl;  tempALutHdl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
01530         
01531 CleanupAndExit:
01532         tempELutHdl = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a10">DISPOSE_IF_DATA</a>(tempELutHdl);
01533         tempXLutHdl = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a10">DISPOSE_IF_DATA</a>(tempXLutHdl);
01534         tempALutHdl = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a10">DISPOSE_IF_DATA</a>(tempALutHdl);
01535         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"MakeGamut16or32ForMonitor"</span>)
01536         <span class="keywordflow">return</span> (err);
01537 }
01538 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:03 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
